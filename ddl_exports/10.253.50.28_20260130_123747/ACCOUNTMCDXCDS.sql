-- DDL Export
-- Server: 10.253.50.28
-- Database: ACCOUNTMCDXCDS
-- Exported: 2026-01-30T12:37:55.684547

USE ACCOUNTMCDXCDS;
GO

-- --------------------------------------------------
-- FUNCTION dbo.CLS_PIECE
-- --------------------------------------------------
 
 
CREATE FUNCTION [dbo].[CLS_PIECE] ( @CharacterExpression VARCHAR(8000), @Delimiter CHAR(1), @Position INTEGER)
RETURNS VARCHAR(8000)
AS
BEGIN
       If @Position<1 return null
       if len(@Delimiter)<>1 return null
       declare @Start integer
       set @Start=1
       while @Position>1
              BEGIN
                     Set @Start=ISNULL(CHARINDEX(@Delimiter, @CharacterExpression, @Start),0)
                     IF @Start=0 return null
                     set @position= @position-1
                     set @Start=@Start+1
              END
       Declare @End INTEGER
       Set @End= ISNULL(CHARINDEX(@Delimiter, @CharacterExpression, @Start),0)
       If @End=0 Set @End=LEN(@CharacterExpression)+1
       RETURN SUBSTRING(@CharacterExpression, @Start, @End-@Start)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.CLS_REMOVE_SPACE
-- --------------------------------------------------

CREATE FUNCTION [dbo].[CLS_REMOVE_SPACE]
(
	@CLIENTNAME VARCHAR(100)
)
RETURNS VARCHAR(100)
AS
BEGIN

DECLARE @FIRST_NAME VARCHAR(100)
SET @FIRST_NAME =  LTRIM(RTRIM(REPLACE(REPLACE(REPLACE(@CLIENTNAME, CHAR(10), ''), CHAR(13), ''), CHAR(9), '')))

RETURN @FIRST_NAME

END

GO

-- --------------------------------------------------
-- FUNCTION dbo.CLS_Split
-- --------------------------------------------------


create FUNCTION [dbo].[CLS_Split]
(
	@RowData nvarchar(2000),
	@SplitOn nvarchar(5)
)  
RETURNS @RtnValue table 
(
	Id int identity(1,1),
	ITEMS nvarchar(100)
) 
AS  
BEGIN 
	Declare @Cnt int
	Set @Cnt = 1

	While (Charindex(@SplitOn,@RowData)>0)
	Begin
		Insert Into @RtnValue (ITEMS)
		Select 
			Data = ltrim(rtrim(Substring(@RowData,1,Charindex(@SplitOn,@RowData)-1)))

		Set @RowData = Substring(@RowData,Charindex(@SplitOn,@RowData)+1,len(@RowData))
		Set @Cnt = @Cnt + 1
	End
	
	Insert Into @RtnValue (ITEMS)
	Select ITEMS = ltrim(rtrim(@RowData))

	Return
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.F_TABLE_NUMBER_RANGE
-- --------------------------------------------------
create function dbo.F_TABLE_NUMBER_RANGE
(
	@START_NUMBER		int,
	@END_NUMBER		int
)
/*
This function returns an integer table containing all integers
in the range of@START_NUMBER through @END_NUMBER, inclusive.
The maximum number of rows that this function can return
is 16777216.
*/

returns table 
as

return
(
select	top 100 percent
	NUMBER = (a.NUMBER+b.NUMBER)+
	-- Add the starting number for the final result set
	-- The case is needed, because the start and end 
	-- numbers can be passed in any order
	case
	when @START_NUMBER <= @END_NUMBER
	then @START_NUMBER
	else @END_NUMBER
	end
from
	(
	Select	top 100 percent
		NUMBER = convert(int,N01+N02+N03)
	From
		-- Cross rows from 3 tables based on powers of 16
		-- Maximum number of rows from cross join is 4096, 0 to 4095
		( select N01 = 0 union all select  1 union all select  2 union all
		  select       3 union all select  4 union all select  5 union all
		  select       6 union all select  7 union all select  8 union all
		  select       9 union all select 10 union all select 11 union all
		  select      12 union all select 13 union all select 14 union all
		  select      15 ) n01
		cross join
		( select N02 = 0 union all select  16 union all select  32 union all
		  select      48 union all select  64 union all select  80 union all
		  select      96 union all select 112 union all select 128 union all
		  select     144 union all select 160 union all select 176 union all
		  select     192 union all select 208 union all select 224 union all
		  select     240 ) n02
		cross join
		( select N03 = 0 union all select  256 union all select  512 union all
		  select     768 union all select 1024 union all select 1280 union all
		  select    1536 union all select 1792 union all select 2048 union all
		  select    2304 union all select 2560 union all select 2816 union all
		  select    3072 union all select 3328 union all select 3584 union all
		  select    3840 ) n03
	where
		-- Minimize the number of rows crossed by selecting only rows
		-- with a value less the the square root of rows needed.
		N01+N02+N03 <
		-- Square root of total rows rounded up to next whole number
		convert(int,ceiling(sqrt(abs(@START_NUMBER-@END_NUMBER)+1)))
	order by
		1
	) a
	cross join
	(
	Select	top 100 percent
		NUMBER = 
		convert(int,
		(N01+N02+N03) *
		-- Square root of total rows rounded up to next whole number
		convert(int,ceiling(sqrt(abs(@START_NUMBER-@END_NUMBER)+1)))
		)
	From 
		-- Cross rows from 3 tables based on powers of 16
		-- Maximum number of rows from cross join is 4096, 0 to 4095
		( select N01 = 0 union all select  1 union all select  2 union all
		  select       3 union all select  4 union all select  5 union all
		  select       6 union all select  7 union all select  8 union all
		  select       9 union all select 10 union all select 11 union all
		  select      12 union all select 13 union all select 14 union all
		  select      15 ) n01
		cross join
		( select N02 = 0 union all select  16 union all select  32 union all
		  select      48 union all select  64 union all select  80 union all
		  select      96 union all select 112 union all select 128 union all
		  select     144 union all select 160 union all select 176 union all
		  select     192 union all select 208 union all select 224 union all
		  select     240 ) n02
		cross join
		( select N03 = 0 union all select  256 union all select  512 union all
		  select     768 union all select 1024 union all select 1280 union all
		  select    1536 union all select 1792 union all select 2048 union all
		  select    2304 union all select 2560 union all select 2816 union all
		  select    3072 union all select 3328 union all select 3584 union all
		  select    3840 ) n03
	where
		-- Minimize the number of rows crossed by selecting only rows
		-- with a value less the the square root of rows needed.
		N01+N02+N03 <
		-- Square root of total rows rounded up to next whole number
		convert(int,ceiling(sqrt(abs(@START_NUMBER-@END_NUMBER)+1)))
	order by
		1
	) b
where
	a.NUMBER+b.NUMBER < 
	-- Total number of rows
	abs(@START_NUMBER-@END_NUMBER)+1	and
	-- Check that the number of rows to be returned
	-- is less than or equal to the maximum of 16777216
	case
	when abs(@START_NUMBER-@END_NUMBER)+1 <= 16777216
	then 1
	else 0
	end = 1
order by
	1
)

GO

-- --------------------------------------------------
-- FUNCTION dbo.fn_diagramobjects
-- --------------------------------------------------

	CREATE FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GET_DPC_CLIENTS
-- --------------------------------------------------

CREATE FUNCTION [dbo].[GET_DPC_CLIENTS]
(
	@FR_PARTY_CODE VARCHAR(10),
	@TO_PARTY_CODE VARCHAR(10),
	@REPORTDATE VARCHAR(11)
)
RETURNS @DPC_CLIENTS TABLE
(
	PARTY_CODE VARCHAR(10), 
	LONG_NAME VARCHAR(100),
	BRANCH_CD VARCHAR(20), 
	SUB_BROKER VARCHAR(25), 
	TRADER VARCHAR(25),
	AREA VARCHAR(25),
	REGION VARCHAR(25),
	CL_TYPE VARCHAR(10),
	CREDIT_INT MONEY, 
	DEBIT_INT MONEY, 
	FROMDATE DATETIME, 
	TODATE DATETIME, 
	EXEMPT_NOOFDAYS TINYINT, 
	EXEMPT_NOOFDAYS_CR TINYINT, 
	MIN_INTEREST MONEY, 
	MIN_BALANCE MONEY
)
AS
BEGIN	

DECLARE @V2_CLIENTPROFILES_NEW table 
( 
	PARTY_CODE VARCHAR(10),
	LONG_NAME VARCHAR(100),
	ACCOUNT_LEVEL VARCHAR(15),
	ACCOUNT_CODE VARCHAR(10),
	CREDIT_INT MONEY,
	DEBIT_INT MONEY,
	FROMDATE SMALLDATETIME,
	TODATE SMALLDATETIME,
	EXEMPT_NOOFDAYS INT,
	EXEMPT_NOOFDAYS_CR INT,
	MIN_INTEREST MONEY,
	MIN_BALANCE MONEY
)


	INSERT INTO @V2_CLIENTPROFILES_NEW
	SELECT V2.PARTY_CODE, LONG_NAME, ACCOUNT_LEVEL, ACCOUNT_CODE, CREDIT_INT, DEBIT_INT, FROMDATE, TODATE, EXEMPT_NOOFDAYS, EXEMPT_NOOFDAYS_CR, MIN_INTEREST, MIN_BALANCE 
	FROM V2_CLIENTPROFILES_NEW C,
	(
		SELECT PARTY_CODE, LONG_NAME = LONG_NAME, AREA, REGION, BRANCH_CD, SUB_BROKER, TRADER, CL_TYPE, LEVEL_FLAG = MAX(LEVEL_FLAG) FROM MSAJAG.DBO.CLIENT_DETAILS C
		, V2_CLIENTPROFILES_NEW V2
		WHERE ((AREA = CASE WHEN ACCOUNT_LEVEL = 'AREA' THEN ACCOUNT_CODE ELSE '' END
		OR REGION = CASE WHEN ACCOUNT_LEVEL = 'REGION' THEN ACCOUNT_CODE ELSE '' END
		OR BRANCH_CD = CASE WHEN ACCOUNT_LEVEL = 'BRANCH' THEN ACCOUNT_CODE ELSE '' END
		OR SUB_BROKER = CASE WHEN ACCOUNT_LEVEL = 'SUBBROKER' THEN ACCOUNT_CODE ELSE '' END
		OR TRADER = CASE WHEN ACCOUNT_LEVEL = 'TRADER' THEN ACCOUNT_CODE ELSE '' END
		OR CL_TYPE = CASE WHEN ACCOUNT_LEVEL = 'CL_TYPE' THEN ACCOUNT_CODE ELSE '' END
		OR PARTY_CODE = CASE WHEN ACCOUNT_LEVEL = 'CLIENT' THEN ACCOUNT_CODE ELSE '' END) AND @REPORTDATE BETWEEN FROMDATE AND TODATE)
		GROUP BY PARTY_CODE, LONG_NAME, AREA, REGION, BRANCH_CD, SUB_BROKER, TRADER, CL_TYPE
	) V2
	WHERE 
		(AREA = CASE WHEN ACCOUNT_LEVEL = 'AREA' THEN ACCOUNT_CODE ELSE '' END
		OR REGION = CASE WHEN ACCOUNT_LEVEL = 'REGION' THEN ACCOUNT_CODE ELSE '' END
		OR BRANCH_CD = CASE WHEN ACCOUNT_LEVEL = 'BRANCH' THEN ACCOUNT_CODE ELSE '' END
		OR SUB_BROKER = CASE WHEN ACCOUNT_LEVEL = 'SUBBROKER' THEN ACCOUNT_CODE ELSE '' END
		OR TRADER = CASE WHEN ACCOUNT_LEVEL = 'TRADER' THEN ACCOUNT_CODE ELSE '' END
		OR CL_TYPE = CASE WHEN ACCOUNT_LEVEL = 'CL_TYPE' THEN ACCOUNT_CODE ELSE '' END
		OR PARTY_CODE = CASE WHEN ACCOUNT_LEVEL = 'CLIENT' THEN ACCOUNT_CODE ELSE '' END) 
		AND @REPORTDATE BETWEEN FROMDATE AND TODATE AND V2.LEVEL_FLAG = C.LEVEL_FLAG
		

	INSERT INTO @DPC_CLIENTS
	SELECT 
		C.PARTY_CODE, C.LONG_NAME, BRANCH_CD, SUB_BROKER, TRADER, AREA, REGION, CL_TYPE,
		CREDIT_INT = ISNULL(V2.CREDIT_INT, V.CREDIT_INT), 
		DEBIT_INT = ISNULL(V2.DEBIT_INT, V.DEBIT_INT), 
		FROMDATE = ISNULL(V2.FROMDATE, V.FROMDATE), 
		TODATE = ISNULL(V2.TODATE, V.TODATE), 
		EXEMPT_NOOFDAYS = ISNULL(V2.EXEMPT_NOOFDAYS, V.EXEMPT_NOOFDAYS), 
		EXEMPT_NOOFDAYS_CR = ISNULL(V2.EXEMPT_NOOFDAYS_CR, V.EXEMPT_NOOFDAYS_CR), 
		MIN_INTEREST = ISNULL(V2.MIN_INTEREST, V.MIN_INTEREST), 
		MIN_BALANCE = ISNULL(V2.MIN_BALANCE, V.MIN_BALANCE)
	FROM MSAJAG.DBO.CLIENT_DETAILS C
	LEFT OUTER JOIN @V2_CLIENTPROFILES_NEW V2
	ON C.PARTY_CODE = V2.PARTY_CODE
	,(SELECT * FROM V2_CLIENTPROFILES_NEW WHERE ACCOUNT_LEVEL = 'ALL') V
	/*ON ((BRANCH_CD = CASE WHEN ACCOUNT_LEVEL = 'BRANCH' THEN ACCOUNT_CODE ELSE '' END
	OR SUB_BROKER = CASE WHEN ACCOUNT_LEVEL = 'SUBBROKER' THEN ACCOUNT_CODE ELSE '' END
	OR PARTY_CODE = CASE WHEN ACCOUNT_LEVEL = 'CLIENT' THEN ACCOUNT_CODE ELSE '' END) AND @REPORTDATE BETWEEN FROMDATE AND TODATE)*/
	WHERE C.PARTY_CODE >= @FR_PARTY_CODE AND C.PARTY_CODE <= @TO_PARTY_CODE


	RETURN
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GET_SETT_CALENDER
-- --------------------------------------------------

/*  
SELECT * FROM .DBO.GET_SETT_CALENDER('APR  1 2011', 'APR 30 2011', 4)  
  
WHERE START_DATE >= DATEADD(DAY, -30, 'APR  1 2011') AND SETT_TYPE = 'N'    
AND START_DATE <= DATEADD(DAY, 10, 'APR 30 2011')    
*/  
CREATE FUNCTION [dbo].[GET_SETT_CALENDER] (@SDATE VARCHAR(11), @TDATE VARCHAR(11), @NODAYS INT)            
RETURNS @SETTDATE TABLE (            
[START_DATE]    [DATETIME] NOT NULL,            
[END_DATE]    [DATETIME] NOT NULL,          
[PAYIN_DATE]    [DATETIME] NOT NULL,    
[SNO] INT IDENTITY(1, 1)    
)            
AS            
            
BEGIN             
            
INSERT INTO @SETTDATE            
SELECT DISTINCT START_DATE = VDT, END_DATE = VDT, PAYIN_DATE = VDT
FROM BILLPOSTED
WHERE VDT >= DATEADD(DAY, -30, @SDATE)
AND VDT <= DATEADD(DAY, 10, @TDATE)    
ORDER BY VDT
       
        
UPDATE S SET END_DATE = S1.END_DATE FROM @SETTDATE S, (SELECT SNO, END_DATE = START_DATE FROM @SETTDATE) S1    
WHERE S.SNO + @NODAYS = S1.SNO    
    
            
RETURN            
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.Piece
-- --------------------------------------------------
CREATE FUNCTION [dbo].[Piece] ( @CHARACTEREXPRESSION VARCHAR(8000), @DELIMITER CHAR(1), @POSITION INTEGER)
RETURNS VARCHAR(8000)
AS
BEGIN
	IF @POSITION<1 RETURN NULL
	IF LEN(@DELIMITER)<>1 RETURN NULL
	DECLARE @START INTEGER
	SET @START=1
	WHILE @POSITION>1
		BEGIN
			SET @START=ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
			IF @START=0 RETURN NULL
			SET @POSITION= @POSITION-1
			SET @START=@START+1
		END
	DECLARE @END INTEGER
	SET @END= ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
	IF @END=0 SET @END=LEN(@CHARACTEREXPRESSION)+1
	RETURN SUBSTRING(@CHARACTEREXPRESSION, @START, @END-@START)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.PrepareMCDXCDSData
-- --------------------------------------------------

Create FUNCTION PrepareMCDXCDSData 
(	
	@SDTCUR DATETIME,
	@SDTNXT DATETIME
)
RETURNS @MCDXCDSDataForCMS table 
(
	cltcode varchar(50),
	Ledger money default 0,
	processdatetime datetime
)
as
begin
	Declare @vdt varchar(11)    
	set @vdt=convert(varchar(11),getdate())   
	
	insert into @MCDXCDSDataForCMS
	select cltcode, Balance=sum(Case when drcr='C' then -vamt else vamt end),getdate()
	from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)    
	where vdt >= @SDTCUR -- 'Feb 1 2011' --(select sdtcur from risk.dbo.parameter (nolock) where sdtcur <= getdate() and ldtcur >= getdate())    
	and vdt <= @vdt+' 23:59:59'    
	and exists (select cltcode from [196.1.115.182].general.dbo.client_Details b (nolock)    
	where a.cltcode=b.party_Code)and not (vtyp = 18 and vdt >= @SDTNXT) ---'2011-04-01')    
	group by cltcode---:01  

	return
end

GO

-- --------------------------------------------------
-- FUNCTION dbo.REMOVE_ZERO
-- --------------------------------------------------
create FUNCTION [dbo].[REMOVE_ZERO]        
(          
 @STRING NVARCHAR(4000),           
 @DELIMITER CHAR(1)        
)          
          
RETURNS VARCHAR(100)          
          
AS          
          
/*          
 RETURNS SPECIFIC ITEM          
 SELECT * FROM SPLIT_SP('A/BODY/CAT', '/', 0)          
*/          
          
BEGIN          
 DECLARE @INDEX INT          
 DECLARE @COUNTER TINYINT      
      
 SELECT @INDEX = 1      
 SELECT @COUNTER = LEN(@STRING)       
         
 IF @STRING IS NULL RETURN '0'          
      
 WHILE @COUNTER > 0      
 BEGIN      
  -- GET THE INDEX OF THE FIRST OCCURENCE OF THE SPLIT_SP CHARACTER          
  SELECT @INDEX = CHARINDEX(@DELIMITER,@STRING)          
  -- NOW PUSH EVERYTHING TO THE LEFT OF IT INTO THE SLICE VARIABLE          
  IF @INDEX = 1      
  BEGIN      
   SELECT @STRING = RIGHT(@STRING, LEN(@STRING) - 1)      
  END      
  ELSE      
  BEGIN      
   RETURN @STRING          
   BREAK               
  END      
  SELECT @COUNTER = @COUNTER - 1      
 END      
 RETURN '0'       
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.REMOVE_ZERO1
-- --------------------------------------------------

--SELECT .DBO.REMOVE_ZERO('00009', '0')  
CREATE FUNCTION [dbo].[REMOVE_ZERO1]            
(              
 @STRING NVARCHAR(4000),               
 @DELIMITER CHAR(1)            
)              
              
RETURNS VARCHAR(100)              
              
AS              
              
/*              
 RETURNS SPECIFIC ITEM              
 SELECT * FROM SPLIT_SP('A/BODY/CAT', '/', 0)              
*/              
              
BEGIN              
 DECLARE @INDEX INT              
 DECLARE @COUNTER TINYINT          
          
 SELECT @INDEX = 1          
 SELECT @COUNTER = LEN(@STRING)           
             
 IF @STRING IS NULL RETURN '0'              
          
 WHILE @COUNTER > 0          
 BEGIN          
  -- GET THE INDEX OF THE FIRST OCCURENCE OF THE SPLIT_SP CHARACTER              
  SELECT @INDEX = CHARINDEX(@DELIMITER,@STRING)              
  -- NOW PUSH EVERYTHING TO THE LEFT OF IT INTO THE SLICE VARIABLE              
  IF @INDEX = 1          
  BEGIN          
   SELECT @STRING = RIGHT(@STRING, LEN(@STRING) - 1)          
  END          
  ELSE          
  BEGIN          
   RETURN @STRING              
   BREAK                   
  END          
  SELECT @COUNTER = @COUNTER - 1          
 END          
 RETURN '0'           
END

GO

-- --------------------------------------------------
-- INDEX dbo.Banklocat
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxType] ON [dbo].[Banklocat] ([Type])

GO

-- --------------------------------------------------
-- INDEX dbo.Bankreco
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Bnkrco] ON [dbo].[Bankreco] ([Amount], [Drcr], [Referenceno], [Micrno])

GO

-- --------------------------------------------------
-- INDEX dbo.Bankreco
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [RecoIDx] ON [dbo].[Bankreco] ([Cltcode], [Amount], [Drcr], [Micrno], [Referenceno])

GO

-- --------------------------------------------------
-- INDEX dbo.BILLLOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxStno] ON [dbo].[BILLLOG] ([SETT_NO], [SETT_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.Billmatch
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [vnoidx] ON [dbo].[Billmatch] ([Vno], [Vtype], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.BillPosted
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSt] ON [dbo].[BillPosted] ([Sett_Type], [Sett_No])

GO

-- --------------------------------------------------
-- INDEX dbo.BILLPROCESS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxPr] ON [dbo].[BILLPROCESS] ([IN_PROCESS])

GO

-- --------------------------------------------------
-- INDEX dbo.Booktype
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxVt] ON [dbo].[Booktype] ([Vtyp], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.Branchaccounts
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Pk_branchaccounts] ON [dbo].[Branchaccounts] ([Branchname])

GO

-- --------------------------------------------------
-- INDEX dbo.branchwiseclbal
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[branchwiseclbal] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Category
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [cat] ON [dbo].[Category] ([Catcode])

GO

-- --------------------------------------------------
-- INDEX dbo.catmast
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[catmast] ([Accat])

GO

-- --------------------------------------------------
-- INDEX dbo.chequeformats
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxChq] ON [dbo].[chequeformats] ([Formatcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Class_SQLTableIndex
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTbl] ON [dbo].[Class_SQLTableIndex] ([TableName])

GO

-- --------------------------------------------------
-- INDEX dbo.Class_SQLTableListing
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTbl] ON [dbo].[Class_SQLTableListing] ([TableName])

GO

-- --------------------------------------------------
-- INDEX dbo.Costmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [cstinx] ON [dbo].[Costmast] ([Costname], [Costcode], [Catcode])

GO

-- --------------------------------------------------
-- INDEX dbo.creditors
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[creditors] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Errvouchers
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxUser] ON [dbo].[Errvouchers] ([Cdt], [Username])

GO

-- --------------------------------------------------
-- INDEX dbo.grpmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [grpcode] ON [dbo].[grpmast] ([Grpcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Lastchequeno
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxBank] ON [dbo].[Lastchequeno] ([Bankcode], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.Lastvno
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [LVNO] ON [dbo].[Lastvno] ([Vdt], [Vtyp], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.Lastvno
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Vnoidx] ON [dbo].[Lastvno] ([Vtyp], [Booktype], [Vdt])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger_1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [cltcode] ON [dbo].[ledger_1] ([CLTCODE], [VTYP], [VNO], [VDT])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger_1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [lededtind] ON [dbo].[ledger_1] ([CLTCODE], [VDT], [EDT], [VTYP])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger_1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [LEDIND] ON [dbo].[ledger_1] ([CLTCODE], [VDT], [VNO], [VTYP], [BOOKTYPE], [EDT])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger_1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [VDT] ON [dbo].[ledger_1] ([VDT]) INCLUDE ([DRCR], [VAMT], [CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger_1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [vno] ON [dbo].[ledger_1] ([VNO])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger_1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [vtypvno] ON [dbo].[ledger_1] ([VTYP], [VNO], [EDT], [DRCR], [VDT], [CLTCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger_log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVp] ON [dbo].[ledger_log] ([vtyp], [vno], [vdt])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger_org
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [LED2IND] ON [dbo].[Ledger_org] ([Vdt], [Vno], [Vtyp])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger_org
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ledger3] ON [dbo].[Ledger_org] ([Vtyp], [Vno], [Lno], [Vdt], [Cltcode], [Booktype], [Drcr], [Acname])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger_org
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ledger5] ON [dbo].[Ledger_org] ([Vdt], [Vtyp], [Edt], [Drcr], [Vamt], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger_org
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ledind] ON [dbo].[Ledger_org] ([Vno], [Vtyp], [Vdt], [Cltcode], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger_org
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Partyvdt] ON [dbo].[Ledger_org] ([Vno], [Vtyp], [Booktype], [Vdt], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger_Report
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[Ledger_Report] ([Cltcode], [Vtyp], [Vno], [Vdt])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger_Temp_New
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVtyp] ON [dbo].[Ledger_Temp_New] ([Vdt], [Vno], [VTyp], [CltCode])

GO

-- --------------------------------------------------
-- INDEX dbo.LEDGER_TEMP_NEW_PARTYLEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxClCode] ON [dbo].[LEDGER_TEMP_NEW_PARTYLEDGER] ([CLTCODE], [VDT], [EDT])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [cltcode] ON [dbo].[Ledger2] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Led2] ON [dbo].[Ledger2] ([Vno], [Vtype], [Booktype], [Lno], [Drcr])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [typeno] ON [dbo].[Ledger2] ([Vno], [Vtype], [Booktype], [Lno], [Costcode], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledger2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [vno] ON [dbo].[Ledger2] ([Vno], [Vtype], [Drcr], [Booktype], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger2_log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[ledger2_log] ([vtype], [BookType], [vno], [cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger3
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Ld3] ON [dbo].[ledger3] ([Vno], [Vtyp], [Naratno], [Booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger3
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Ledger314] ON [dbo].[ledger3] ([Vtyp])

GO

-- --------------------------------------------------
-- INDEX dbo.ledger3_log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVtyp] ON [dbo].[ledger3_log] ([vtyp], [BookType], [vno])

GO

-- --------------------------------------------------
-- INDEX dbo.Ledgerbalances
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[Ledgerbalances] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Marginledger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [KLED] ON [dbo].[Marginledger] ([Vno], [Vtyp], [Vdt], [Party_code], [Drcr])

GO

-- --------------------------------------------------
-- INDEX dbo.marginledger_log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVTyp] ON [dbo].[marginledger_log] ([vtyp], [BookType], [vno], [vdt], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.Matchdetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVTyp] ON [dbo].[Matchdetails] ([Vtype], [Booktype], [Vno], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.matchdetails_log
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[matchdetails_log] ([Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.MULTIBANKID_2307
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxCl] ON [dbo].[MULTIBANKID_2307] ([Cltcode], [Bankid], [Acctype])

GO

-- --------------------------------------------------
-- INDEX dbo.MULTIBANKID_2307
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [nc_defaultbank] ON [dbo].[MULTIBANKID_2307] ([Defaultbank]) INCLUDE ([Accno], [Acctype])

GO

-- --------------------------------------------------
-- INDEX dbo.Owner
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxcom] ON [dbo].[Owner] ([Companyname])

GO

-- --------------------------------------------------
-- INDEX dbo.Payadv
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxcl] ON [dbo].[Payadv] ([Vtyp], [Vno], [Booktype], [Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.PostBillLedger
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVTyp] ON [dbo].[PostBillLedger] ([VTYP], [VNO], [SETT_NO], [SETT_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.POSTBILLLEDGER2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[POSTBILLLEDGER2] ([CLTCODE], [BRANCHCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.sebiinsp_GlMerge
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxglcode] ON [dbo].[sebiinsp_GlMerge] ([Cltcode], [Grpcode])

GO

-- --------------------------------------------------
-- INDEX dbo.Selection_Levels_PartyLedger
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxLv] ON [dbo].[Selection_Levels_PartyLedger] ([Level_No])

GO

-- --------------------------------------------------
-- INDEX dbo.sysdiagrams
-- --------------------------------------------------
CREATE UNIQUE NONCLUSTERED INDEX [UK_principal_name] ON [dbo].[sysdiagrams] ([principal_id], [name])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_GLReport
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Partyvdt] ON [dbo].[Tbl_GLReport] ([vno], [vtyp], [booktype])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_GLReport_New
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVT] ON [dbo].[Tbl_GLReport_New] ([vtyp], [booktype], [vno], [voudt])

GO

-- --------------------------------------------------
-- INDEX dbo.TBL_MASTER_PARTYLEDGER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxSrNo] ON [dbo].[TBL_MASTER_PARTYLEDGER] ([SrNo])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_OppBalance
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [cltcode_idx] ON [dbo].[Tbl_OppBalance] ([cltCode])

GO

-- --------------------------------------------------
-- INDEX dbo.Tbl_OppBalance
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [procididx] ON [dbo].[Tbl_OppBalance] ([ProcID])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [billtypeidx] ON [dbo].[Tempbilldetails] ([Billvtype])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [drcridx] ON [dbo].[Tempbilldetails] ([Drcr])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [excidx] ON [dbo].[Tempbilldetails] ([Exchange])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [partycdidx] ON [dbo].[Tempbilldetails] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.Tempbilldetails
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [sessionidx] ON [dbo].[Tempbilldetails] ([Sessionid], [Vtype], [Booktype], [Billvno])

GO

-- --------------------------------------------------
-- INDEX dbo.Templedger2
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxVType] ON [dbo].[Templedger2] ([Vtype], [Booktype], [Vno])

GO

-- --------------------------------------------------
-- INDEX dbo.Temppartybalances1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxCl] ON [dbo].[Temppartybalances1] ([Cltcode])

GO

-- --------------------------------------------------
-- INDEX dbo.USERRIGHTS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxvTyp] ON [dbo].[USERRIGHTS] ([vtyp], [Booktype], [UserCategory], [UserStatusId])

GO

-- --------------------------------------------------
-- INDEX dbo.Userwritestable
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[Userwritestable] ([Vtyp], [Booktype], [Usercategory], [Userstatusid])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_LastVno
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [PK_V2_LastVno] ON [dbo].[V2_LastVno] ([FldAuto])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_LastVno
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [VNoIdx] ON [dbo].[V2_LastVno] ([Vtyp], [Booktype], [Vdt], [VnoFlag], [FinYear])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_UPLOADED_FILES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxSrno] ON [dbo].[V2_UPLOADED_FILES] ([U_FILENAME])

GO

-- --------------------------------------------------
-- INDEX dbo.VMAIN
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxVtyp] ON [dbo].[VMAIN] ([VTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.Vmast
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [typedesc] ON [dbo].[Vmast] ([Vtype], [Vdesc])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.FORMULA_CLIENT_MASTER
-- --------------------------------------------------
ALTER TABLE [dbo].[FORMULA_CLIENT_MASTER] ADD CONSTRAINT [PK_FORMULA_CLIENT_MASTER] PRIMARY KEY ([CLTCODE], [SESSION_ID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.RECON_BANK_DELETION_LOGS
-- --------------------------------------------------
ALTER TABLE [dbo].[RECON_BANK_DELETION_LOGS] ADD CONSTRAINT [PK__RECON_BA__54ECADF5731CA8B3] PRIMARY KEY ([SRNO], [UPLOADID], [MATCHEDFLAG])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.RECON_BANK_FILEUPLOAD_LOGS
-- --------------------------------------------------
ALTER TABLE [dbo].[RECON_BANK_FILEUPLOAD_LOGS] ADD CONSTRAINT [PK_UPLOADMASTER] PRIMARY KEY ([UPLOADID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.RECON_BANK_MASTER
-- --------------------------------------------------
ALTER TABLE [dbo].[RECON_BANK_MASTER] ADD CONSTRAINT [PK_MASTER] PRIMARY KEY ([SEGMENT], [BANKCODE], [FILETYPE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.RECON_BANK_UPLOAD_PROCESS_INFO
-- --------------------------------------------------
ALTER TABLE [dbo].[RECON_BANK_UPLOAD_PROCESS_INFO] ADD CONSTRAINT [PK_UPLOADMASTERPROCESS] PRIMARY KEY ([UPLOADID], [SEGMENT], [BANKNAME], [FILETYPE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.Recon_CMS_Data
-- --------------------------------------------------
ALTER TABLE [dbo].[Recon_CMS_Data] ADD CONSTRAINT [PK__Recon_CM__C3A4D3AC1942519B] PRIMARY KEY ([SrNo])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [PK__sysdiagrams__546180BB] PRIMARY KEY ([diagram_id])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.sysdiagrams
-- --------------------------------------------------
ALTER TABLE [dbo].[sysdiagrams] ADD CONSTRAINT [UK_principal_name] UNIQUE ([principal_id], [name])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_ACWISEREPORT
-- --------------------------------------------------


CREATE PROC ACC_ACWISEREPORT
@REPTYPE VARCHAR(7), 
@GRPLEN TINYINT, 
@GRPCODE VARCHAR(10), 
@FDATE VARCHAR(11), 
@TDATE VARCHAR(11), 
@FACCODE VARCHAR(10), 
@TACCODE VARCHAR(10), 
@COSTCODE SMALLINT
AS
DECLARE 
@@GRPCHARS AS INT
SELECT @@GRPCHARS = (SELECT LEN(RTRIM(@GRPCODE)) )
IF LEN(RTRIM(@FACCODE)) = 0
BEGIN
   SELECT @FACCODE = ( SELECT MIN(CLTCODE) FROM ACMAST )
END
IF LEN(RTRIM(@TACCODE)) = 0
BEGIN
   SELECT @TACCODE = ( SELECT MAX(CLTCODE) FROM ACMAST )
END
IF RTRIM(@REPTYPE) = 'ACCOUNT'
BEGIN
   IF @GRPLEN = 0 
      BEGIN
 SELECT L2.CLTCODE, A.ACNAME, BAL = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)
 FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE, LEDGER L
 WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO
 AND L.VDT > = @FDATE +' 00:00:00' AND L.VDT < = @TDATE + ' 23:59:59' AND ACCAT = 3
        AND L2.CLTCODE > = @FACCODE AND L2.CLTCODE < = @TACCODE
 GROUP BY L2.CLTCODE, A.ACNAME
 ORDER BY L2.CLTCODE, A.ACNAME
      END
   ELSE
   IF @GRPLEN = 2
   BEGIN
 SELECT CATEGORY, GRPCODE = LEFT(GRPCODE, @GRPLEN), BAL = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)
 FROM LEDGER2 L2, LEDGER L, COSTMAST C, CATEGORY CC
 WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO
 AND L.VDT > = @FDATE +' 00:00:00' AND L.VDT < = @TDATE + ' 23:59:59'
 AND L2.COSTCODE = C.COSTCODE AND C.CATCODE = CC.CATCODE AND L2.CLTCODE = RTRIM(@FACCODE)
 GROUP BY CATEGORY, LEFT(GRPCODE, @GRPLEN)
 ORDER BY CATEGORY, LEFT(GRPCODE, @GRPLEN)
   END
   ELSE
   IF @GRPLEN = 10
      BEGIN
 SELECT L2.COSTCODE, COSTNAME, BAL = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)
 FROM LEDGER2 L2, LEDGER L, COSTMAST C
 WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO
 AND L.VDT > = @FDATE +' 00:00:00' AND L.VDT < = @TDATE + ' 23:59:59'
 AND L2.COSTCODE = C.COSTCODE AND C.GRPCODE LIKE RTRIM(@GRPCODE)+'%'
        AND L2.CLTCODE > = @FACCODE AND L2.CLTCODE < = @TACCODE
 GROUP BY L2.COSTCODE, COSTNAME
 ORDER BY L2.COSTCODE, COSTNAME
      END
   ELSE   
      BEGIN
 SELECT CATEGORY, GRPCODE = LEFT(GRPCODE, @GRPLEN), BAL = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)
 FROM LEDGER2 L2, LEDGER L, COSTMAST C, CATEGORY CC
 WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO
 AND L.VDT > = @FDATE +' 00:00:00' AND L.VDT < = @TDATE + ' 23:59:59'
 AND L2.COSTCODE = C.COSTCODE AND C.CATCODE = CC.CATCODE AND LEFT(GRPCODE, 2) = RTRIM(@GRPCODE)
 AND L2.CLTCODE = RTRIM(@FACCODE)
 GROUP BY CATEGORY, LEFT(GRPCODE, @GRPLEN)
 ORDER BY CATEGORY, LEFT(GRPCODE, @GRPLEN)
     END
END
ELSE
BEGIN
 SELECT VDATE = CONVERT(VARCHAR, L.VDT, 103) , SHORTDESC, L2.VTYPE, L2.BOOKTYPE, L2.VNO, L2.LNO, 
 L2.CLTCODE, A.ACNAME, L2.DRCR, L2.CAMT, L.NARRATION, 
 CHQNO = ISNULL((SELECT DDNO FROM LEDGER1 L1 WHERE L1.VTYP = L2.VTYPE AND L1.BOOKTYPE = L2.BOOKTYPE AND L1.VNO = L2.VNO AND L1.LNO = L2.LNO), '')
 FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE, LEDGER L, VMAST V
 WHERE L2.CLTCODE = RTRIM(@FACCODE) AND  L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO
 AND L.VDT > = @FDATE + ' 00:00:00' AND L.VDT < = @TDATE + ' 23:59:59'
 AND L2.COSTCODE = @COSTCODE AND L2.VTYPE = V.VTYPE
 ORDER BY L2.CLTCODE, A.ACNAME
END
/*
ELSE
   BEGIN
 SELECT CATEGORY, GRPCODE = LEFT(GRPCODE, @GRPLEN), BAL = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)
 FROM LEDGER2 L2, LEDGER L, COSTMAST C, CATEGORY CC
 WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO
 AND L.VDT > = @FDATE +' 00:00:00' AND L.VDT < = @TDATE + ' 23:59:59'
 AND L2.COSTCODE = C.COSTCODE AND C.CATCODE = CC.CATCODE AND LEFT(GRPCODE, 2) = RTRIM(@GRPCODE)
 GROUP BY CATEGORY, LEFT(GRPCODE, @GRPLEN)
 ORDER BY CATEGORY, LEFT(GRPCODE, @GRPLEN)
   END
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_ADDACMAST1
-- --------------------------------------------------


CREATE PROCEDURE ACC_ADDACMAST1 AS   
SELECT GRPNAME, GRPCODE , GRPMAIN ,   
MAINGRPNAME = (CASE   
  WHEN  LEFT(GRPMAIN, 2) = 'A0' THEN (SELECT GRPNAME FROM GRPMAST WHERE GRPCODE = 'A0000000000')   
         ELSE  
          (CASE WHEN  LEFT(GRPMAIN, 2) = 'L0' THEN (SELECT GRPNAME FROM GRPMAST WHERE GRPCODE = 'L0000000000')    
   ELSE   
    (CASE WHEN  LEFT(GRPMAIN, 2) = 'N0' THEN (SELECT GRPNAME FROM GRPMAST WHERE GRPCODE = 'N0000000000')  
    ELSE   
     (CASE WHEN  LEFT(GRPMAIN, 2) = 'X0' THEN (SELECT GRPNAME FROM GRPMAST WHERE GRPCODE = 'X0000000000')  
      END)  
      END)     
    END )   
      END)  
FROM GRPMAST ORDER BY GRPCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_BANKSLIPREPRINT
-- --------------------------------------------------


/*CAHNGED BY AMIT TO DISPLAY THE ACNAME AND ACCODE */       
/****** OBJECT:  STORED PROCEDURE DBO.ACC_BANKSLIPREPRINT    SCRIPT DATE: 04/07/2003 12:28:25 PM ******/      
/****** OBJECT:  STORED PROCEDURE DBO.BANKSLIPREPRINT    SCRIPT DATE: 10/16/2002 4:40:54 PM ******/      
CREATE PROC ACC_BANKSLIPREPRINT      
@CLTCODE  VARCHAR(10),      
@BOOKTYPE VARCHAR(2),      
@STARTSLIP INT,      
@ENDSLIP INT
AS      
      
/*      
SELECT  SLIPNO, DDNO, SLIPDATE, ACNAME, BNKNAME, BRNNAME, RELAMT, CLTCODE, L1.VNO, L1.LNO      
FROM LEDGER L , LEDGER1 L1       
WHERE L.VTYP = L1.VTYP AND L.VNO = L1.VNO AND L.BOOKTYPE = L1.BOOKTYPE  AND L.VTYP IN ( '2', '19')      
AND L.BOOKTYPE = @BOOKTYPE AND SLIPNO >= @STARTSLIP AND SLIPNO <= @ENDSLIP AND L.CLTCODE = @CLTCODE      
ORDER BY SLIPNO, SLIPDATE, L1.VNO, L1.LNO      
*/      
      
SELECT  SLIPNO, DDNO, SLIPDATE, ACNAME, BNKNAME, BRNNAME, RELAMT, CLTCODE, L1.VNO, L1.LNO      
FROM LEDGER L , LEDGER1 L1       
WHERE L.VTYP = L1.VTYP AND L.VNO = L1.VNO AND L.BOOKTYPE = L1.BOOKTYPE  AND L.VTYP IN ( '2', '19')      
AND L.BOOKTYPE = @BOOKTYPE AND SLIPNO >= @STARTSLIP AND SLIPNO <= @ENDSLIP AND L.CLTCODE <> @CLTCODE      
AND L.VNO IN  (SELECT VNO FROM LEDGER L2 WHERE  CLTCODE =@CLTCODE AND L.VTYP=L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE )      
ORDER BY SLIPNO, SLIPDATE, L1.VNO, L1.LNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_COSTWISEREPORT
-- --------------------------------------------------


CREATE PROC ACC_COSTWISEREPORT
@GRPLEN TINYINT, 
@GRPCODE VARCHAR(10), 
@FDATE VARCHAR(11), 
@TDATE VARCHAR(11)
AS
DECLARE 
@@GRPCHARS AS INT
SELECT @@GRPCHARS = (SELECT LEN(RTRIM(@GRPCODE)) )
IF @GRPLEN = 2
   BEGIN
 SELECT CATEGORY, GRPCODE = LEFT(GRPCODE, @GRPLEN), BAL = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)
 FROM LEDGER2 L2, LEDGER L, COSTMAST C, CATEGORY CC
 WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO
 AND L.VDT > = @FDATE +' 00:00:00' AND L.VDT < = @TDATE + ' 23:59:59'
 AND L2.COSTCODE = C.COSTCODE AND C.CATCODE = CC.CATCODE
 GROUP BY CATEGORY, LEFT(GRPCODE, @GRPLEN)
 ORDER BY CATEGORY, LEFT(GRPCODE, @GRPLEN)
   END
ELSE
IF @GRPLEN = 10
   BEGIN
 SELECT L2.COSTCODE, COSTNAME, BAL = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)
 FROM LEDGER2 L2, LEDGER L, COSTMAST C
 WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO
 AND L.VDT > = @FDATE +' 00:00:00' AND L.VDT < = @TDATE + ' 23:59:59'
 AND L2.COSTCODE = C.COSTCODE AND LEFT(GRPCODE, @@GRPCHARS) = RTRIM(@GRPCODE)
 GROUP BY L2.COSTCODE, COSTNAME
 ORDER BY L2.COSTCODE, COSTNAME
   END
ELSE
   BEGIN
 SELECT CATEGORY, GRPCODE = LEFT(GRPCODE, @GRPLEN), BAL = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)
 FROM LEDGER2 L2, LEDGER L, COSTMAST C, CATEGORY CC
 WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO
 AND L.VDT > = @FDATE +' 00:00:00' AND L.VDT < = @TDATE + ' 23:59:59'
 AND L2.COSTCODE = C.COSTCODE AND C.CATCODE = CC.CATCODE AND LEFT(GRPCODE, 2) = RTRIM(@GRPCODE)
 GROUP BY CATEGORY, LEFT(GRPCODE, @GRPLEN)
 ORDER BY CATEGORY, LEFT(GRPCODE, @GRPLEN)
   END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_DELVOUCHER
-- --------------------------------------------------
 CREATE PROCEDURE ACC_DELVOUCHER        
@VNO VARCHAR(12),         
@VTYP  SMALLINT,         
@BOOKTYPE VARCHAR(2),         
@EMODE CHAR(1),         
@STATUS CHAR(6),         
@EDITNAME VARCHAR(15),         
@VDT VARCHAR(11)        
AS        
DECLARE        
@@VDT1 AS DATETIME        
  
SELECT @@VDT1 = CONVERT(DATETIME, @VDT+' '+CONVERT(VARCHAR, GETDATE(), 114))        
INSERT INTO LEDGER_LOG         
SELECT VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION,@EMODE,@@VDT1,@EDITNAME,@STATUS FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
INSERT INTO LEDGER1_LOG        
SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE,@EMODE FROM LEDGER1  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
INSERT INTO LEDGER2_LOG         
SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE,@EMODE FROM LEDGER2  WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
INSERT INTO LEDGER3_LOG        
SELECT NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE,@EMODE FROM LEDGER3  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
INSERT INTO MATCHDETAILS_LOG        
SELECT *, @EMODE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO         
INSERT INTO MARGINLEDGER_LOG        
SELECT *, @EMODE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE      
  
DELETE FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
DELETE FROM LEDGER1 WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
DELETE FROM LEDGER2 WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
DELETE FROM LEDGER3 WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
DELETE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE        
DELETE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO         
DELETE FROM PAYADV WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_EDITVOUCHER
-- --------------------------------------------------


CREATE PROCEDURE ACC_EDITVOUCHER  
@VNO VARCHAR(12),   
@VTYP  SMALLINT,   
@BOOKTYPE VARCHAR(2),   
@EMODE CHAR(1),   
@STATUS CHAR(6),   
@EDITNAME VARCHAR(15),   
@VDT VARCHAR(11)  
AS  
DECLARE  
@@VDT1 AS DATETIME  
    
SELECT @@VDT1 = CONVERT(DATETIME, @VDT+' '+CONVERT(VARCHAR, GETDATE(), 114))  
--SELECT * FROM LEDGER_LOG  
INSERT INTO LEDGER_LOG   
SELECT VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION,@EMODE,@@VDT1,@EDITNAME,@STATUS FROM LEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO LEDGER1_LOG  
SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE,@EMODE FROM LEDGER1  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO LEDGER2_LOG   
SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE,@EMODE FROM LEDGER2  WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO LEDGER3_LOG  
SELECT NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE,@EMODE FROM LEDGER3  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
INSERT INTO MATCHDETAILS_LOG  
SELECT *, @EMODE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO   
INSERT INTO MARGINLEDGER_LOG  
SELECT *, @EMODE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM LEDGER    WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM LEDGER1  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM LEDGER2  WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM LEDGER3  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM MARGINLEDGER WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE  
DELETE FROM MATCHDETAILS WHERE LVTYPE = @VTYP AND LBOOKTYPE = @BOOKTYPE AND LVNO = @VNO   
DELETE FROM PAYADV WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_GENVNO
-- --------------------------------------------------

CREATE PROC ACC_GENVNO
           @vdt      VARCHAR(11),  
           @vtyp     SMALLINT,
           @booktype VARCHAR(2),
           @sdtcur   VARCHAR(11),
           @ldtcur   VARCHAR(11)

AS

  DECLARE  @@voudt    AS DATETIME,
           @@maxvno   AS NUMERIC(12,0),
           @@vnoflag  AS TINYINT,
           @@vno      AS VARCHAR(12),
           @@rcnt     AS INT
                         
  SELECT @@vnoflag = (SELECT VNOFLAG
                      FROM   PARAMETER
                      WHERE  SDTCUR = @sdtcur
                             AND LDTCUR = @ldtcur + ' 23:59:59')
  
  SELECT @@voudt = (SELECT CONVERT(DATETIME,@vdt))
                   
  IF @@vnoflag = 0 -- YEARLY
    BEGIN
      SELECT @@maxvno = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0)
      FROM   LASTVNO WITH (TABLOCKX ,HOLDLOCK)
      WHERE  VTYP = @vtyp
             AND BOOKTYPE = @booktype
             AND VDT >= @sdtcur
             AND VDT <= @ldtcur + ' 23:59:59'
      
      IF @@maxvno = 0
        BEGIN
          SELECT @@vno = RIGHT(RTRIM(@sdtcur),4) + '00000001'
        END
      ELSE
        BEGIN
          SELECT @@vno = RTRIM(CONVERT(VARCHAR,@@maxvno + 1))
        END
    END
  ELSE
    IF @@vnoflag = 1  -- DAILY
      BEGIN
        SELECT @@maxvno = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0)
        FROM   LASTVNO WITH (TABLOCKX ,HOLDLOCK)
        WHERE  VTYP = @vtyp
               AND BOOKTYPE = @booktype
               AND VDT LIKE @vdt + '%'
        
        IF @@maxvno = 0
          BEGIN
            SELECT @@vno = (SELECT CONVERT(VARCHAR,YEAR(@@voudt)) + RIGHT('0' + LTRIM(CONVERT(VARCHAR,MONTH(@@voudt))),
                                                                          2) + RIGHT('00' + LTRIM(CONVERT(VARCHAR,DAY(@@voudt))),
                                                                                     2)) + '0001'
          END
        ELSE
		IF LEFT(@@maxvno,8) <> LEFT(@@maxvno + 1,8) AND LEFT(@@maxvno,4) = CONVERT(VARCHAR,YEAR(@@voudt)) 
          BEGIN
            SELECT @@vno = (SELECT LEFT(CONVERT(VARCHAR,YEAR(@@voudt)),1) + RIGHT(CONVERT(VARCHAR,YEAR(@@voudt)),2) + RIGHT('0' + LTRIM(CONVERT(VARCHAR,MONTH(@@voudt))),
                                                                          2) + RIGHT('00' + LTRIM(CONVERT(VARCHAR,DAY(@@voudt))),
                                                                                     2)) + '10000'
          END 
          ELSE 
            BEGIN
              SELECT @@vno = RTRIM(CONVERT(VARCHAR,@@maxvno + 1))
            END
      END
      
    ELSE
      IF @@vnoflag = 2 -- MONTHLY
        BEGIN
          SELECT @@maxvno = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0)
          FROM   LASTVNO WITH (TABLOCKX ,HOLDLOCK)
          WHERE  VTYP = @vtyp
                 AND BOOKTYPE = @booktype
                 AND YEAR(VDT) = YEAR(@@voudt)
                 AND MONTH(VDT) = MONTH(@@voudt)
          
          IF @@maxvno = 0
            BEGIN
              SELECT @@vno = (SELECT CONVERT(VARCHAR,YEAR(@@voudt)) + RIGHT('0' + LTRIM(CONVERT(VARCHAR,MONTH(@@voudt))),
                                                                            2)) + '000001'
            END
          ELSE
            BEGIN
              SELECT @@vno = RTRIM(CONVERT(VARCHAR,@@maxvno + 1))
            END
        END

  SELECT VNO = @@vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_GENVNO_NEW
-- --------------------------------------------------

CREATE PROC [dbo].[ACC_GENVNO_NEW]   
           @VDT      VARCHAR(11),  
           @VTYP     SMALLINT,  
           @BOOKTYPE VARCHAR(2),  
           @SDTCUR   VARCHAR(11),  
           @LDTCUR   VARCHAR(11),  
           @NOREC    INT  = 0  
                              
AS  
  DECLARE  @@VOUDT    AS DATETIME,  
           @@MAXVNO   AS NUMERIC(12,0),  
           @@VNOFLAG  AS TINYINT,  
           @@VNO      AS VARCHAR(12),  
           @@RCNT     AS INT  
                           
  SET XACT_ABORT ON  
    
  BEGIN TRANSACTION  
    
  IF @NOREC = 0  
    BEGIN  
      SELECT @NOREC = @NOREC + 1  
    END  
      
  SELECT @SDTCUR = CONVERT(VARCHAR(11),SDTCUR,109),  
         @LDTCUR = CONVERT(VARCHAR(11),LDTCUR,109),  
         @@VNOFLAG = VNOFLAG,  
         @@VOUDT = (SELECT CONVERT(DATETIME,@VDT))  
  FROM   PARAMETER  
  WHERE  @VDT BETWEEN SDTCUR AND LDTCUR  
                                   
  IF @@VNOFLAG = 0 -- YEARLY  
    BEGIN  
      SELECT @@MAXVNO = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0)  
      FROM   LASTVNO WITH (TABLOCKX ,HOLDLOCK)  
      WHERE  VTYP = @VTYP  
             AND BOOKTYPE = @BOOKTYPE  
             AND VDT >= @SDTCUR + ' 00:00:00'  
             AND VDT <= @LDTCUR + ' 23:59'  
        
      IF @@MAXVNO = 0  
        BEGIN  
          SELECT @@VNO = RIGHT(RTRIM(@SDTCUR),4) + '00000001'  
        END  
      ELSE  
        BEGIN  
          SELECT @@VNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + 1))  
        END  
        
      SELECT @@RCNT = (SELECT COUNT(* )  
                       FROM   LASTVNO  
                       WHERE  VTYP = @VTYP  
                              AND BOOKTYPE = @BOOKTYPE  
                              AND VDT >= @SDTCUR + ' 00:00:00'  
                              AND VDT <= @LDTCUR + ' 23:59')  
    END  
  ELSE  
    IF @@VNOFLAG = 1 -- DAILY  
      BEGIN  
        SELECT @@MAXVNO = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0)  
        FROM   LASTVNO WITH (TABLOCKX ,HOLDLOCK)  
        WHERE  VTYP = @VTYP  
               AND BOOKTYPE = @BOOKTYPE  
               AND VDT LIKE @VDT + '%'  
          
        IF @@MAXVNO = 0  
          BEGIN  
            SELECT @@VNO = (SELECT CONVERT(VARCHAR,YEAR(@@VOUDT)) + RIGHT('0' + LTRIM(CONVERT(VARCHAR,MONTH(@@VOUDT))),  
                                                                          2) + RIGHT('00' + LTRIM(CONVERT(VARCHAR,DAY(@@VOUDT))),  
                                                                                     2)) + '0001'  
          END  
        ELSE  
  IF LEFT(@@maxvno,8) <> LEFT(@@maxvno + 1,8) AND LEFT(@@maxvno,4) = CONVERT(VARCHAR,YEAR(@@voudt))   
          BEGIN  
            SELECT @@vno = (SELECT LEFT(CONVERT(VARCHAR,YEAR(@@voudt)),1) + RIGHT(CONVERT(VARCHAR,YEAR(@@voudt)),2) + RIGHT('0' + LTRIM(CONVERT(VARCHAR,MONTH(@@voudt))),  
                                                                          2) + RIGHT('00' + LTRIM(CONVERT(VARCHAR,DAY(@@voudt))),  
                                                                                     2)) + '10000'  
          END   
          ELSE   
          BEGIN   
   IF LEFT(@@maxvno,8) <> LEFT(@@maxvno + @NOREC,8) AND LEFT(@@maxvno,4) = CONVERT(VARCHAR,YEAR(@@voudt))   
     BEGIN  
    SELECT @@vno = (SELECT LEFT(CONVERT(VARCHAR,YEAR(@@voudt)),1) + RIGHT(CONVERT(VARCHAR,YEAR(@@voudt)),2) + RIGHT('0' + LTRIM(CONVERT(VARCHAR,MONTH(@@voudt))),  
                     2) + RIGHT('00' + LTRIM(CONVERT(VARCHAR,DAY(@@voudt))),  
                       2)) + '0' + CONVERT(VARCHAR,CONVERT(INT,RIGHT(@@maxvno,4)) + 1)  
     END   
     ELSE   
    BEGIN  
      SELECT @@vno = RTRIM(CONVERT(VARCHAR,@@maxvno + 1))  
    END  
            END   
  
        SELECT @@RCNT = (SELECT COUNT(* )  
                         FROM   LASTVNO  
                         WHERE  VTYP = @VTYP  
                                AND BOOKTYPE = @BOOKTYPE  
                  AND VDT >= @SDTCUR + ' 00:00:00'  
                                AND VDT LIKE @VDT + '%')  
      END  
    ELSE  
      IF @@VNOFLAG = 2 -- MONTHLY  
        BEGIN  
          SELECT @@MAXVNO = ISNULL(MAX(CONVERT(NUMERIC,LASTVNO)),0)  
          FROM   LASTVNO WITH (TABLOCKX ,HOLDLOCK)  
          WHERE  VTYP = @VTYP  
                 AND BOOKTYPE = @BOOKTYPE  
                 AND YEAR(VDT) = YEAR(@@VOUDT)  
                 AND MONTH(VDT) = MONTH(@@VOUDT)  
            
          IF @@MAXVNO = 0  
            BEGIN  
              SELECT @@VNO = (SELECT CONVERT(VARCHAR,YEAR(@@VOUDT)) + RIGHT('0' + LTRIM(CONVERT(VARCHAR,MONTH(@@VOUDT))),  
                                                                            2)) + '000001'  
            END  
          ELSE  
            BEGIN  
              SELECT @@VNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + 1))  
            END  
            
          SELECT @@RCNT = (SELECT COUNT(* )  
                           FROM   LASTVNO  
                           WHERE  VTYP = @VTYP  
                                  AND BOOKTYPE = @BOOKTYPE  
                                  AND YEAR(VDT) = YEAR(@@VOUDT)  
                                  AND MONTH(VDT) = MONTH(@@VOUDT))  
        END  
    
  IF @@RCNT = 0  
    BEGIN  
      INSERT INTO LASTVNO  
      VALUES     (@VTYP,  
                  @BOOKTYPE,  
                  @VDT,  
                  CONVERT(VARCHAR(12),CONVERT(NUMERIC(12),@@VNO) + @NOREC - 1))  
    END  
  ELSE  
    BEGIN  
      IF @@VNOFLAG = 0 -- YEARLY  
        BEGIN  
          UPDATE LASTVNO WITH (TABLOCKX ,HOLDLOCK)  
          SET    LASTVNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC(12),@@VNO) + @NOREC - 1)  
          WHERE  VTYP = @VTYP  
                 AND BOOKTYPE = @BOOKTYPE  
                 AND VDT >= @SDTCUR + ' 00:00:00'  
                 AND VDT <= @LDTCUR + ' 23:59'  
        END  
      ELSE  
        IF @@VNOFLAG = 1 -- DAILY  
          BEGIN  
            UPDATE LASTVNO WITH (TABLOCKX ,HOLDLOCK)  
            SET    LASTVNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC(12),@@VNO) + @NOREC - 1)  
            WHERE  VTYP = @VTYP  
                   AND BOOKTYPE = @BOOKTYPE  
                   AND VDT LIKE @VDT + '%'  
          END  
        ELSE  
          IF @@VNOFLAG = 2 -- MONTHLY   
            BEGIN  
              UPDATE LASTVNO WITH (TABLOCKX ,HOLDLOCK)  
              SET    LASTVNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC(12),@@VNO) + @NOREC - 1)  
              WHERE  VTYP = @VTYP  
                     AND BOOKTYPE = @BOOKTYPE  
                     AND YEAR(VDT) = YEAR(@VDT)  
                     AND MONTH(VDT) = MONTH(@VDT)  
            END  
    END  
      
  IF @@ERROR <> 0  
    BEGIN  
      ROLLBACK TRANSACTION  
        
      SELECT VNO = ''  
    END  
  ELSE  
    BEGIN  
      COMMIT TRANSACTION  
        
      SELECT VNO = @@VNO  
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_GETSLIPNO
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.ACC_GETSLIPNO    SCRIPT DATE: 06/24/2004 8:32:35 PM ******/    
    
/****** OBJECT:  STORED PROCEDURE DBO.ACC_GETSLIPNO    SCRIPT DATE: 05/10/2004 5:29:36 PM ******/    
    
/****** OBJECT:  STORED PROCEDURE DBO.ACC_GETSLIPNO    SCRIPT DATE: 04/07/2003 12:28:25 PM ******/    
CREATE PROCEDURE  ACC_GETSLIPNO    
@CLTCODE VARCHAR(10),    
@BOOKTYPE VARCHAR(2),    
@FLAG INTEGER    
AS    
/*    
SELECT DISTINCT CONVERT(INTEGER,SLIPNO) SLIPNO FROM SLIPRECEIPT ORDER BY SLIPNO     
*/    
    
IF @FLAG = 1    
BEGIN    
 SELECT DISTINCT SLIPNO     
 FROM LEDGER1 L1, LEDGER L    
 WHERE L1.VTYP = L.VTYP AND L1.BOOKTYPE= L.BOOKTYPE AND L1.VNO = L.VNO     
 AND L.CLTCODE = @CLTCODE AND L1.VTYP IN (2,19) AND L1.BOOKTYPE = @BOOKTYPE AND SLIPNO <> 0    
 ORDER BY SLIPNO    
END    
ELSE    
BEGIN    
 SELECT DISTINCT CONVERT(VARCHAR,SLIPDATE,103)  SLIPDATE FROM LEDGER1 L    
 WHERE L.VTYP IN (2,19) AND L.BOOKTYPE =@BOOKTYPE  AND SLIPNO <> 0    
 ORDER BY CONVERT(VARCHAR,SLIPDATE,103)    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_OPBAL
-- --------------------------------------------------



CREATE PROCEDURE ACC_OPBAL
@SDATE VARCHAR(11),            /* AS MMM DD YYYY */
@EDATE VARCHAR(11),            /* AS MMM DD YYYY */
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */
@FCODE VARCHAR(10), 
@TCODE VARCHAR(10), 
@STATUSID VARCHAR(30), 
@STATUSNAME VARCHAR(30), 
@BRANCH VARCHAR(10), 
@SELECTIONBY VARCHAR(3), 
@GROUPBY VARCHAR(10), 
@SORTBY VARCHAR(50), 
@REPORTNAME VARCHAR(30), 
@REPORTOPT VARCHAR(10), 
@FLD1 VARCHAR(10), 
@FLD2 VARCHAR(10), 
@FLD3 VARCHAR(10)
AS
DECLARE
@@OPENDATE   AS VARCHAR(11)
/* -------------------------------------------------------------------------- */
IF LEN(RTRIM(@FDATE)) = 10 
BEGIN
   SELECT @FDATE = LEFT(@FDATE, 3) + ' ' + SUBSTRING(@FDATE, 4, 7)
END
IF LEN(RTRIM(@SDATE)) = 10 
BEGIN
   SELECT @SDATE = LEFT(@SDATE, 3) + ' ' + SUBSTRING(@SDATE, 4, 7)
END
IF LEN(RTRIM(@TDATE)) = 10 
BEGIN
   SELECT @TDATE = LEFT(@TDATE, 3) + ' ' + SUBSTRING(@TDATE, 4, 7)
END
IF LEN(RTRIM(@EDATE)) = 10 
BEGIN
   SELECT @EDATE = LEFT(@EDATE, 3) + ' ' + SUBSTRING(@EDATE, 4, 7)
END
IF @FDATE = ''
BEGIN
   SELECT @FDATE = @SDATE
END
IF @TDATE = ''
BEGIN
   SELECT @TDATE = @EDATE
END
IF @REPORTNAME <> 'MARGINLEDGER'
BEGIN
/* GET OPENDATE FROM SDATE, FDATE RECEIVED AS PARAMETER */
   IF UPPER(@SELECTIONBY) = 'VDT'
      BEGIN
         SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR, ISNULL(MAX(VDT), 0), 109), 11) FROM LEDGER WHERE VTYP = 18 AND VDT < = @FDATE )
      END
   ELSE
      BEGIN
         SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11) FROM LEDGER WHERE VTYP = 18 AND EDT < = @FDATE )
   END
/* -------------------------------------------------------------------------- */     
   IF UPPER(@SELECTIONBY) = 'VDT'
      BEGIN
         IF @SDATE = @FDATE
            BEGIN
  IF @@OPENDATE = @FDATE 
  BEGIN
                SELECT CLTCODE, OPBAL = SUM( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)
                FROM LEDGER 
                WHERE CLTCODE = @FCODE AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18
                GROUP BY CLTCODE
  END
  ELSE
  BEGIN
                SELECT CLTCODE, OPBAL = SUM( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)
                FROM LEDGER 
                WHERE CLTCODE = @FCODE AND VDT > = @@OPENDATE + ' 00:00:00' AND VDT < @FDATE 
                GROUP BY CLTCODE
  END
            END
         ELSE
            BEGIN
               SELECT CLTCODE, OPBAL = SUM( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)
               FROM LEDGER 
               WHERE CLTCODE = @FCODE AND VDT > = @@OPENDATE + ' 00:00:00' AND VDT < @FDATE 
               GROUP BY CLTCODE
            END
      END
   ELSE
      BEGIN
         IF @SDATE = @FDATE AND @@OPENDATE = @FDATE
            BEGIN
               SELECT CLTCODE, OPBAL = SUM(BALAMT)
               FROM LEDGER 
               WHERE CLTCODE = @FCODE AND EDT LIKE @@OPENDATE + '%' AND VTYP = 18
               GROUP BY CLTCODE
            END
         ELSE
            BEGIN
               SELECT CLTCODE, OPBAL = SUM(OPBAL)
               FROM
               ( SELECT CLTCODE, OPBAL = SUM(BALAMT)
                 FROM LEDGER 
                 WHERE CLTCODE = @FCODE AND EDT LIKE @@OPENDATE + '%' AND VTYP = 18
                 GROUP BY CLTCODE
                 UNION ALL
                 SELECT CLTCODE, OPBAL = SUM( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)
                 FROM LEDGER 
                 WHERE CLTCODE = @FCODE AND EDT > = @@OPENDATE + ' 00:00:00' AND EDT < @FDATE AND VTYP <> 18
                 GROUP BY CLTCODE ) T
               GROUP BY CLTCODE
            END
      END
END
IF @REPORTNAME = 'MARGINLEDGER'
BEGIN
/* GET OPENDATE FROM SDATE, FDATE RECEIVED AS PARAMETER */
   IF UPPER(@SELECTIONBY) = 'VDT'
      BEGIN
         SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR, ISNULL(MAX(VDT), 0), 109), 11) FROM MARGINLEDGER WHERE VTYP = 18 AND VDT < = @FDATE )
      END
   ELSE
      BEGIN
         SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR, ISNULL(MAX(VDT), 0), 109), 11) FROM MARGINLEDGER WHERE VTYP = 18 AND VDT < = @FDATE )
   END
/* -------------------------------------------------------------------------- */     
   IF UPPER(@SELECTIONBY) = 'VDT'
      BEGIN
         IF @SDATE = @FDATE
            BEGIN
  IF @@OPENDATE = @FDATE 
  BEGIN
                SELECT CLTCODE = PARTY_CODE, OPBAL = SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)
                FROM MARGINLEDGER 
                WHERE PARTY_CODE = @FCODE AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18
                GROUP BY PARTY_CODE
  END
  ELSE
  BEGIN
      SELECT CLTCODE = PARTY_CODE, OPBAL = SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)
                FROM MARGINLEDGER 
                WHERE PARTY_CODE = @FCODE AND VDT > = @@OPENDATE + ' 00:00:00' AND VDT < @FDATE 
                GROUP BY PARTY_CODE
  END
            END
         ELSE
            BEGIN
     SELECT CLTCODE = PARTY_CODE, OPBAL = SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)
               FROM MARGINLEDGER 
               WHERE PARTY_CODE = @FCODE AND VDT > = @@OPENDATE + ' 00:00:00' AND VDT < @FDATE 
               GROUP BY PARTY_CODE
            END
      END
   ELSE
      BEGIN
         IF @SDATE = @FDATE AND @@OPENDATE = @FDATE
            BEGIN
               SELECT CLTCODE = PARTY_CODE, OPBAL = SUM(SETT_NO)
               FROM MARGINLEDGER 
               WHERE PARTY_CODE = @FCODE AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18
               GROUP BY PARTY_CODE
            END
         ELSE
            BEGIN
               SELECT CLTCODE, OPBAL = SUM(OPBAL)
               FROM
               ( SELECT CLTCODE = PARTY_CODE, OPBAL = SUM(SETT_NO)
                 FROM MARGINLEDGER 
                 WHERE PARTY_CODE = @FCODE AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18
                 GROUP BY PARTY_CODE
                 UNION ALL
                 SELECT CLTCODE = PARTY_CODE, OPBAL = SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)
                 FROM MARGINLEDGER 
                 WHERE PARTY_CODE = @FCODE AND VDT > = @@OPENDATE + ' 00:00:00' AND VDT < @FDATE AND VTYP <> 18
                 GROUP BY PARTY_CODE) T
               GROUP BY CLTCODE
            END
      END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_PRINTRECONCILE
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.ACC_PRINTRECONCILE    SCRIPT DATE: 01/18/2006 16:45:54 ******/  
--SP_HELPTEXT ACC_PRINTRECONCILE    
    
/****** OBJECT:  STORED PROCEDURE DBO.ACC_PRINTRECONCILE    SCRIPT DATE: 03/15/2003 11:24:48 AM ******/          
CREATE PROCEDURE  ACC_PRINTRECONCILE            
@CODE VARCHAR(10),          
@REPORTTYPE VARCHAR(10),          
@TDATE  DATETIME,          
@FDATE  DATETIME          
AS          
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
        
IF UPPER(@REPORTTYPE) = 'STATEMENT'          
BEGIN          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
      
SELECT DISTINCT VTYP, BOOKTYPE, VNO, LNO INTO #TBLBANKRECO FROM LEDGER WHERE CLTCODE = @CODE      
      
 SELECT L.VTYP, L.BOOKTYPE, L.VNO, VDT, TDATE=CONVERT(VARCHAR,L.VDT,103), ISNULL(DDNO,'') DDNO, ISNULL(CLTCODE ,'') CLTCODE ,           
 ISNULL( ACNAME ,'') ACNAME, L.DRCR, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN RELAMT  ELSE 0 END ),          
 CRAMT= (CASE WHEN UPPER(L.DRCR) = 'C' THEN RELAMT ELSE 0 END ),           
 TRELDT=ISNULL(CONVERT(VARCHAR, RELDT , 103),''), L1.REFNO          
 FROM LEDGER L  LEFT OUTER JOIN LEDGER1 L1 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO,          
 #TBLBANKRECO T           
 WHERE L.VTYP = T.VTYP AND L.VNO= T.VNO AND L.BOOKTYPE = T.BOOKTYPE           
 AND CLTCODE <> @CODE AND VDT <=@TDATE --AND L.VTYP NOT IN ( 16, 17) AND L1.CLEAR_MODE NOT IN ('C', 'R')          
AND RTRIM(L1.DDNO) + CONVERT(VARCHAR,RELAMT) + CONVERT(VARCHAR(11),DDDT,109)   
NOT IN(SELECT RTRIM(DDNO) + CONVERT(VARCHAR,RELAMT) + CONVERT(VARCHAR(11),DDDT,109) FROM LEDGER1 L12, LEDGER L2 WHERE L12.VNO=L2.VNO AND L12.VTYP=L2.VTYP                                     
AND L12.BOOKTYPE=L2.BOOKTYPE AND L12.VTYP='16' AND L2.VDT < @TDATE AND CLTCODE= @CODE)                                  
 AND (RELDT ='1900-01-01 00:00:00.000' OR RELDT > @TDATE )           
 ORDER BY L.DRCR, VDT, L.VTYP, L.VNO           
END          
ELSE          
BEGIN          
 SELECT L.VTYP, L.BOOKTYPE, L.VNO, VDT, TDATE=CONVERT(VARCHAR,L.VDT,103), ISNULL(DDNO,'') DDNO, ISNULL(CLTCODE ,'') CLTCODE ,           
 ISNULL( ACNAME ,'') ACNAME, L.DRCR, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END ),          
 CRAMT= (CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END ),           
 TRELDT=ISNULL(CONVERT(VARCHAR, RELDT , 103),''), L1.REFNO          
 FROM LEDGER L  LEFT OUTER JOIN LEDGER1 L1 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO,          
 (SELECT DISTINCT VTYP, BOOKTYPE, VNO, LNO FROM LEDGER WHERE CLTCODE = @CODE) T           
 WHERE L.VTYP = T.VTYP AND L.VNO= T.VNO AND L.BOOKTYPE = T.BOOKTYPE           
 AND CLTCODE <> @CODE AND VDT >= @FDATE AND VDT <= @TDATE          
 ORDER BY L.DRCR, VDT, L.VTYP, L.VNO           
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_REPORTS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[ACC_REPORTS]                          
@SDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
@EDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
@FCODE VARCHAR(10),                          
@TCODE VARCHAR(10),                          
@STATUSID VARCHAR(30),                          
@STATUSNAME VARCHAR(30),                          
@BRANCH VARCHAR(10),                          
@SELECTIONBY VARCHAR(3),                          
@GROUPBY VARCHAR(10),                          
@SORTBY VARCHAR(50),                          
@REPORTNAME VARCHAR(30),                          
@REPORTOPT VARCHAR(10),                          
@FLD1 VARCHAR(50),  /*  TO BE USED FOR SHAREDB IN CASE OF PARTY LEDGER */                          
@FLD2 VARCHAR(10),                          
@FLD3 VARCHAR(10)                          
                          
AS
DECLARE                          
@@OPENDATE   AS VARCHAR(11),                                   
@@SELECTQURY AS VARCHAR(8000),                          
@@FROMTABLES AS VARCHAR(2000),                          
@@WHEREPART  AS VARCHAR(8000),                          
@@GROUPBY    AS VARCHAR(200),                          
@@SORTBY     AS VARCHAR(200),                          
@@UALL       AS VARCHAR(20),                          
@@USELECTQURY AS VARCHAR(8000),                          
@@UFROMTABLES AS VARCHAR(2000),                          
@@UWHEREPART  AS VARCHAR(8000),                          
@@UGROUPBY    AS VARCHAR(200),                          
@@USORTBY     VARCHAR(200),                          
@@DATEFILTER AS VARCHAR(500),                          
@@DATEFILTER1 AS VARCHAR(500),                          
@@REPORTFROM AS VARCHAR(1)                          
                          
/* -------------------------------------------------------------------------- */                          
IF @FDATE = " "                           
BEGIN                          
   SELECT @FDATE = @SDATE                          
END                          
                          
IF @TDATE = " "                          
BEGIN                          
   SELECT @TDATE = @EDATE                          
END                          
                          
/* GET FILTER CONDITION ON DATES BASED ON THE VALUE OF @SELECTIONBY */                          
                          
IF @SELECTIONBY = 'VDT'                          
BEGIN                          
   SELECT @@DATEFILTER = " WHERE L.VDT >= '" + @FDATE + " 00:00:00' AND L.VDT <= '" + @TDATE +" 23:59:59'"                          
   SELECT @@DATEFILTER1 = "  VDT >= '" + @FDATE + " 00:00:00' AND VDT <= '" + @TDATE +" 23:59:59'"                          
END                          
ELSE IF @SELECTIONBY = 'EDT'                          
BEGIN                          
   SELECT @@DATEFILTER = " WHERE L.EDT >= '" + @FDATE + " 00:00:00' AND L.EDT <= '" + @TDATE +" 23:59:59'"                          
   SELECT @@DATEFILTER1 = " EDT >= '" + @FDATE + " 00:00:00' AND EDT <= '" + @TDATE +" 23:59:59'"                          
END                          
/* -------------------------------------------------------------------------- */                               
                          
IF @REPORTNAME = 'CASH BOOK'                           
BEGIN                          
                          
   IF UPPER(@SORTBY) = 'VDT'                          
         SELECT @@SORTBY = " ORDER BY VOUDT, L.VTYP, L.VNO"                          
   ELSE IF UPPER(@SORTBY) = 'EDT'                          
         SELECT @@SORTBY = " ORDER BY EFFDT, L.VTYP, L.VNO"                          
    ELSE IF UPPER(@SORTBY) = 'VTYPE'                          
          SELECT @@SORTBY = " ORDER BY L.VTYP, L.VDT, L.VNO"                          
  ELSE IF UPPER(@SORTBY) = 'ACCODE'                      
       SELECT @@SORTBY = " ORDER BY L.CLTCODE, L.VDT, L.VTYP, L.VNO"                          
   ELSE IF UPPER(@SORTBY) = 'ACNAME'                          
        SELECT @@SORTBY = " ORDER BY L.ACNAME, L.VDT, L.VTYP, L.VNO"                          
      ELSE IF UPPER(@SORTBY) = 'BOOKTYPE'                          
            SELECT @@SORTBY = " ORDER BY L.BOOKTYPE, L.VDT, L.VTYP, L.VNO"                          
       ELSE IF UPPER(@SORTBY) = 'VNO'                          
             SELECT @@SORTBY = " ORDER BY L.VNO, L.VDT, L.VTYP"                          
        ELSE IF UPPER(@SORTBY) = 'DRCR'                          
              SELECT @@SORTBY = " ORDER BY L.DRCR, L.VDT, L.VTYP, L.VNO"                          
         ELSE IF UPPER(@SORTBY) = 'AMOUNT'                          
               SELECT @@SORTBY = " ORDER BY L.VAMT, L.VDT, L.VTYP, L.VNO"                          
                          
                          
                          
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
      BEGIN 

print 'vin111'                         
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, L.VTYP, L.VNO, VDT=CONVERT(VARCHAR,VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), l.CLTCODE, ACNAME=ISNULL(ACNAME,''), VOUDT=L.VDT, EFFDT=L.EDT, DEBIT = (CASE WHEN UPPER(L.DRCR) = 'D' THEN  VAMT  ELSE  0 END),CREDIT = (CASE WHEN UPPER(L.DRCR) = 'C' THEN  VAMT   ELSE  0 END), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.DRCR"     
        SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE FROM LEDGER (NOLOCK) WHERE CLTCODE = '" + @FCODE + "' AND " + @@DATEFILTER1 + " AND VTYP <> 18) T, LEDGER L "    
        SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "'  AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE "SELECT @@GROUPBY = " " END  --ELSE                          
 ELSE IF UPPER(@STATUSID) = 'REGION'                      
      BEGIN                          
                     
PRINT UPPER(@STATUSNAME) 
print 'vin222'                     
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, L.VTYP, L.VNO, VDT=CONVERT(VARCHAR,VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), L.CLTCODE, ACNAME=ISNULL(L.ACNAME,''), VOUDT=L.VDT, EFFDT=L.EDT, DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN  CAMT  ELSE  0 END),CREDIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT   ELSE  0 END), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.DRCR"                          
        SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK), (SELECT BRANCH_CODE FROM MCDXCDS.DBO.REGION WHERE UPPER(REGIONCODE) = '" + @STATUSNAME + "') R "                          
        SELECT @@WHEREPART = @@DATEFILTER + " AND L2.VTYPE <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT <> '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO AND UPPER(COSTNAME) = UPPER(R.BRANCH_CODE) AND L2.COSTCODE = C.COSTCODE "                          
        SELECT @@GROUPBY = " "                           
        SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                            
		PRINT @@SELECTQURY+@@FROMTABLES+@@WHEREPART+@@GROUPBY                                 
      END                        
ELSE                
      BEGIN                          
               

print 'vin333'
PRINT @@SELECTQURY           
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, L.VTYP, L.VNO, VDT=CONVERT(VARCHAR,VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), CLTCODE=L2.CLTCODE, ACNAME=ISNULL(L.ACNAME,''),VOUDT=L.VDT, EFFDT=L.EDT, DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN  CAMT ELSE  0 END), CREDIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT   ELSE  0 END),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L2.DRCR"                          
  SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE, LNO FROM LEDGER (NOLOCK)  WHERE CLTCODE = '" + @FCODE + "'  AND " + @@DATEFILTER1 + " AND VTYP <> 18) T, LEDGER2 L2, COSTMAST C, LEDGER L "       
        SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = '" + @FCODE + "' AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "'  AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L.LNO = T.LNO AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.BOOKTYPE= L.BOOKTYPE AND L2.LNO = L.LNO AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "     
SELECT @@GROUPBY = " "  
PRINT @@SELECTQURY + @@FROMTABLES+ @@WHEREPART+@@GROUPBY                     
      END                          
END                          
                          
IF @REPORTNAME = 'BANK BOOK'                           
BEGIN                          
   IF UPPER(@SORTBY) = 'VDT'                          
         SELECT @@SORTBY = " ORDER BY VOUDT, L.VTYP, L.VNO"                          
   ELSE IF UPPER(@SORTBY) = 'EDT'                          
         SELECT @@SORTBY = " ORDER BY EFFDT, L.VTYP, L.VNO"                          
    ELSE IF UPPER(@SORTBY) = 'VTYPE'                          
          SELECT @@SORTBY = " ORDER BY L.VTYP, L.VDT, L.VNO"                          
  ELSE IF UPPER(@SORTBY) = 'ACCODE'                          
       SELECT @@SORTBY = " ORDER BY L.CLTCODE, L.VDT, L.VTYP, L.VNO"                          
   ELSE IF UPPER(@SORTBY) = 'ACNAME'                          
        SELECT @@SORTBY = " ORDER BY L.ACNAME, L.VDT, L.VTYP, L.VNO"                          
      ELSE IF UPPER(@SORTBY) = 'BOOKTYPE'                      
            SELECT @@SORTBY = " ORDER BY L.BOOKTYPE, L.VDT, L.VTYP, L.VNO"                          
       ELSE IF UPPER(@SORTBY) = 'VNO'                          
             SELECT @@SORTBY = " ORDER BY L.VNO, L.VDT, L.VTYP"                          
        ELSE IF UPPER(@SORTBY) = 'DRCR'                          
              SELECT @@SORTBY = " ORDER BY L.DRCR, L.VDT, L.VTYP, L.VNO"                          
         ELSE IF UPPER(@SORTBY) = 'AMOUNT'                          
               SELECT @@SORTBY = " ORDER BY L.VAMT, L.VDT, L.VTYP, L.VNO"                          
                          
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
      BEGIN                          
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EFFDT = L.EDT, EDT = CONVERT(VARCHAR,L.EDT,103), CLTCODE, ACNAME, L.VNO, L.VTYP, VOUDT=L.VDT, DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), DEBIT = (CASE WHEN UPPER(L.DRCR) = 'C' THEN  VAMT  ELSE  0 END), CREDIT = (CASE WHEN UPPER(L.DRCR) ='D' THEN  VAMT   ELSE  0 END),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','')  "    
  
    
        SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE FROM LEDGER (NOLOCK)  WHERE CLTCODE = '" + @FCODE + "'  AND " + @@DATEFILTER1 + " AND VTYP <> 18) T, LEDGER L "                          
         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE "                          
         SELECT @@GROUPBY = " "                          
      END                          
   ELSE                          
      BEGIN                          
/*         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EFFDT = L.EDT, EDT = CONVERT(VARCHAR,L.EDT,103), L2.CLTCODE, ACNAME, L.VNO, L.VTYP, VOUDT=L.VDT, DDNO= ISNULL((SELECT DDNO FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTY
                     
P=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT  ELSE  0 END), CREDIT = (CASE WHEN UPPER(L2.DRCR) ='D' THEN  CAMT   ELSE  0 END), L.NARRATION "                          
         SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE FROM LEDGER WHERE CLTCODE = '" + @FCODE + "') T, LEDGER2 L2, COSTMAST C, LEDGER L " */                          
/*         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE
   
    
                        
AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE NOT IN ( SELECT BRCONTROLAC FROM BRANCHACCOUNTS ) " */                          
/*         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE 
  
        
                          
AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE =L.CLTCODE "                           
         SELECT @@GROUPBY = " " */                          
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EFFDT = L.EDT, EDT = CONVERT(VARCHAR,L.EDT,103), L2.CLTCODE, ACNAME, L.VNO, L.VTYP, VOUDT=L.VDT, DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT  ELSE  0 END), CREDIT = (CASE WHEN UPPER(L2.DRCR) ='D' THEN  CAMT   ELSE  0 END), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','')"
  
    
    
        SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYPE, VNO, BOOKTYPE FROM LEDGER2 (NOLOCK)  WHERE CLTCODE = '" + @FCODE + "' ) T, LEDGER2 L2 (NOLOCK) , COSTMAST C (NOLOCK) , LEDGER L  (NOLOCK) "         
/*         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE 
  
    
                           
AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE NOT IN ( SELECT BRCONTROLAC FROM BRANCHACCOUNTS ) " */                          
         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE<> 'HOCTRL' AND L2.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYPE AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE " SELECT @@GROUPBY = " "  END        
END                          
                           
IF @REPORTNAME = 'GL'                           
BEGIN                          
                          
/* ASSIGN FROM AND TO ACCOUNT CODES. */                          
   IF @FCODE = ""                           
      BEGIN                          
         SELECT @FCODE = (SELECT MIN(CLTCODE) FROM ACMAST WHERE ACCAT <> 4)                          
END         
                          
   IF @TCODE = ""                           
      BEGIN                          
         SELECT @TCODE = (SELECT MAX(CLTCODE) FROM ACMAST WHERE ACCAT <> 4)                          
END        
                          
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
      BEGIN                          
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO, NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L.CLTCODE , A.LONGNAME,VDT, L.VTYP, L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), ACCAT "                          
SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE ,VMAST V  (NOLOCK) "        
SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND VTYP = VTYPE AND A.CLTCODE = L.CLTCODE AND A.ACCAT <> '4' "                          
SELECT @@GROUPBY = " "                          
SELECT @@SORTBY = " ORDER BY L.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                            
      END                        
 ELSE IF UPPER(@STATUSID) = 'REGION'                      
      BEGIN                          
PRINT 'VIN'           
PRINT UPPER(@STATUSNAME)                      
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END), L.VNO,NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L2.CLTCODE , A.LONGNAME,VDT, L.VTYP, L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), ACCAT "                          
SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK), (SELECT BRANCH_CODE FROM MCDXCDS.DBO.REGION WHERE UPPER(REGIONCODE) = '" + @STATUSNAME + "') R   "        
SELECT @@WHEREPART = @@DATEFILTER + " AND L2.VTYPE <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT <> '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO AND UPPER(COSTNAME) = UPPER(R.BRANCH_CODE) AND L2.COSTCODE = C.COSTCODE "                      

SELECT @@GROUPBY = " "    
        
        SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                            
  PRINT @@SELECTQURY+@@FROMTABLES+@@WHEREPART+@@GROUPBY                                 
      END                        
   ELSE                          
      BEGIN                          
                          
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END), L.VNO,NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L2.CLTCODE , A.LONGNAME,VDT, L.VTYP, L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EDT= CONVERT(VARCHAR,L.EDT,103), ACCAT "                          
        SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK)   "                          
        SELECT @@WHEREPART = @@DATEFILTER + " AND L2.VTYPE <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT <> '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "                      SELECT @@GROUPBY = " "                          SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"            

  
    
          PRINT @@SELECTQURY+@@FROMTABLES+@@WHEREPART+@@GROUPBY                                 
      END                          
END                          
                          
IF @REPORTNAME = 'PARTYLEDGER'                          
BEGIN                          
                          
 SELECT @@SORTBY = " VOUDT, L.VTYP DESC, L.VNO"                           
 IF UPPER(@SORTBY) = 'VDT'                          
    SELECT @@SORTBY = " VOUDT, L.VTYP DESC, L.VNO"           
   ELSE IF UPPER(@SORTBY) = 'EDT'                          
           SELECT @@SORTBY = " EFFDT, L.VTYP DESC, L.VNO"                           
                          
 IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
 SELECT @@SORTBY = " L.CLTCODE," + @@SORTBY                          
 ELSE                          
 SELECT @@SORTBY = " L2.CLTCODE," + @@SORTBY                          
                          
 IF UPPER(RTRIM(@GROUPBY)) = 'FAMILY'                          
    SELECT @@SORTBY = " ORDER BY CM.FAMILY, " + @@SORTBY                          
 ELSE IF UPPER(RTRIM(@GROUPBY)) = 'SUBBROKER'                          
       SELECT @@SORTBY = " ORDER BY C1.SUB_BROKER, " + @@SORTBY                          
                          
 IF LEFT(@@SORTBY,6) <> ' ORDER'                           
    SELECT @@SORTBY = " ORDER BY " + @@SORTBY                          
                                
   IF UPPER(RTRIM(@GROUPBY)) = 'FAMILY'                          
   BEGIN                          
      IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
         BEGIN                          
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                               SELECT @@FROMTABLES = " FROM LEDGER L (NOLOCK)  LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST, MSAJAG.DBO.CLIENTMASTER CM "  
   
    
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = A.CLTCODE AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE AND L.CLTCODE = CM.PARTY_CODE"                          
            SELECT @@GROUPBY = " "                          
         END                          
      ELSE                          
         BEGIN                          
                          
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                            SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2 (NOLOCK)  LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK) , MSAJAG.DBO.CLIENTMASTER CM   (NOLOCK)  "                            
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT = '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO  AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE = CM.PARTY_CODE "                                 
          SELECT @@GROUPBY = " "                           
                          
         END                            
   END                          
   ELSE IF UPPER(RTRIM(@GROUPBY)) = 'SUBBROKER'                          
   BEGIN                          
      IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
      BEGIN                          
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                              SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST, " + RTRIM(@FLD1) + ".DBO.CLIENT1 C1 (NOLOCK) , " + RTRIM(@FLD1) + ".DBO.CLIENT2 C2  (NOLOCK) "                          
           SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = A.CLTCODE AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE AND L.CLTCODE = C2.PARTY_CODE AND C2.CL_CODE = C1.CL_CODE " 
  
   
             SELECT @@GROUPBY = " "                          
         END                          
      ELSE                          
         BEGIN                          
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                    SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2 (NOLOCK)  LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK) ,  " + RTRIM(@FLD1) + ".DBO.CLIENT1 C1 (NOLOCK) , " + RTRIM(@FLD1) + ".DBO.CLIENT2 C2  (NOLOCK) "                    SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT = '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO  AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE = C2.PARTY_CODE AND C2.CL_CODE = C1.CL_CODE "                          
           SELECT @@GROUPBY = " "                          
         END                            
   END                          
   ELSE                          
   BEGIN                          
   IF UPPER(@STATUSID) = 'BROKER' OR UPPER(@STATUSID) = 'BRANCH'                           
   BEGIN                          
      IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
         BEGIN                          
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                            SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST  (NOLOCK) "                              
    
  SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = A.CLTCODE AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE "                          
            SELECT @@GROUPBY = " "                          
         END                          
      ELSE                          
         BEGIN                          
                          
           SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                            SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK)   "                          
    
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT = '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO  AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "                                     SELECT @@GROUPBY = " "                          
            SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                          
                          
                          
         END                          
   END                          
   ELSE                          
   IF UPPER(@STATUSID) = 'SUB_BROKER'                          
   BEGIN                          
      SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), L.NARRATION, L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                      SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST (NOLOCK) , MSAJAG.DBO.CLIENT1 C1 (NOLOCK) , MSAJAG.DBO.CLIENT2 C2  (NOLOCK) "                 
  
    
         
      SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.CLTCODE = C2.PARTY_CODE AND C2.CL_CODE = C1.CL_CODE AND UPPER(SUB_BROKER) = UPPER(@STATUSNAME) AND L.VTYP = VTYPE "              SELECT @@GROUPBY = " "                END                     ELSE                     BEGIN                        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), L.NARRATION, L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                               SELECT @@FROMTABLES = " FROM LEDGER L  (NOLOCK) LEFT OUTER JOIN ACMAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST  (NOLOCK) "                          
      SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE "                          
      SELECT @@GROUPBY = " "             
   END                          
   END                          
END                          
                          
IF @REPORTNAME = 'MARGINLEDGER'                          
BEGIN                          
   IF @SELECTIONBY = 'VDT'                          
      BEGIN                          
         SELECT @@SORTBY = " ORDER BY L.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                          
      END                          
   ELSE                          
      BEGIN                          
         SELECT @@SORTBY = " ORDER BY L.CLTCODE, EFFDT, L.VTYP DESC, L.VNO"                          
      END                    
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                           
      BEGIN                          
         SELECT @@SELECTQURY = "SELECT M.BOOKTYPE, VOUDT=M.VDT, EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, DRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'D' THEN AMOUNT ELSE 0 END ), CRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'C' THEN AMOUNT ELSE 0 END ),  M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''), L.NARRATION, M.PARTY_CODE, A.LONGNAME, M.VTYP, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT "    
         SELECT @@FROMTABLES = " FROM MARGINLEDGER M (NOLOCK)  LEFT OUTER JOIN LEDGER L  (NOLOCK) ON M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO LEFT OUTER JOIN ACMAST A  (NOLOCK) ON M.PARTY_CODE = A.CLTCODE , VMAST V  (NOLOCK) "                          SELECT @@WHEREPART = @@DATEFILTER + " AND M.PARTY_CODE >= '" + @FCODE + "' AND M.PARTY_CODE <= '" + @TCODE + "' AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE "                          
         SELECT @@GROUPBY = " "                          
         SELECT @@SORTBY = " ORDER BY M.PARTY_CODE, VOUDT, M.VTYP DESC, M.VNO"                          
      END                          
   ELSE                          
      BEGIN                          
                          
         SELECT @@SELECTQURY = "SELECT M.BOOKTYPE, VOUDT=M.VDT, EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, DRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'D' THEN AMOUNT ELSE 0 END ), CRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'C' THEN AMOUNT ELSE 0 END ), M.VNO, DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''), L.NARRATION, M.PARTY_CODE, A.LONGNAME, M.VTYP, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT "
  
    
    SELECT @@FROMTABLES = " FROM LEDGER L, COSTMAST C, MARGINLEDGER M (NOLOCK)  LEFT OUTER JOIN LEDGER2 L2  (NOLOCK) ON M.VTYP = L2.VTYPE AND M.BOOKTYPE = L2.BOOKTYPE AND M.VNO = L2.VNO AND M.LNO = L2.LNO LEFT OUTER JOIN ACMAST A  (NOLOCK) ON M.PARTY_CODE = A.CLTCODE , VMAST  V (NOLOCK)  "                        SELECT @@WHEREPART = @@DATEFILTER + " AND M.PARTY_CODE >= '" + @FCODE + "' AND M.PARTY_CODE <= '" + @TCODE + "' AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "                               
SELECT @@GROUPBY = " "                          
         SELECT @@SORTBY = " ORDER BY M.PARTY_CODE, VOUDT, L.VTYP DESC, L.VNO"                          
                          
                                    
      END                          
END                          
                          
--PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY                           
--SELECT @@WHEREPART = @@WHEREPART + " AND L.VTYP IN (15,21) "                          
                          
                          
--IF @STATUSID = 'BROKER'                           
--PRINT ('SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED ' + @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )                        
EXEC ('SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED ' + @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )   
  
  
SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_VALANSUM
-- --------------------------------------------------


CREATE PROC ACC_VALANSUM  
@BRANCHCD AS VARCHAR(10),   
@OPENDATE AS VARCHAR(11),   
@CLOSDATE AS VARCHAR(11),   
@VTYP AS VARCHAR(2),   
@BOOKTYPE VARCHAR(2),   
@VNO  VARCHAR(12),   
@REPORTOPTION CHAR(1),   
@BALOPTION CHAR(1),   
@SORTBY VARCHAR(10)  
AS  
  
DECLARE   
@@OPBALDT AS VARCHAR(11),   
@@WHEREPART AS VARCHAR(200),   
@@FROMPART  AS VARCHAR(300),   
@@SELECTPART AS VARCHAR(1000),   
@@CLBALPART  AS VARCHAR(1000),   
@@ADDWHERE   AS VARCHAR(100),   
@@ORDERBYPART AS VARCHAR(100)  
  
SELECT @@OPBALDT = (SELECT LEFT(CONVERT(VARCHAR, ISNULL(MAX(VDT), 0), 109), 11) FROM LEDGER L   
                    WHERE VTYP = 18 AND VDT <= @OPENDATE)  
  
IF @REPORTOPTION = 'P'  
   BEGIN  
      SELECT @@ADDWHERE = " AND A.ACCAT IN ('4', '104')"  
   END  
ELSE IF @REPORTOPTION = 'O'  
   BEGIN  
      SELECT @@ADDWHERE = " AND A.ACCAT NOT IN ('4', '104')"  
   END  
ELSE  
   BEGIN  
      SELECT @@ADDWHERE = " "  
   END  
  
IF RTRIM(@BRANCHCD) = '%'   
   BEGIN  
 SELECT @@SELECTPART = "SELECT L.CLTCODE, A.ACNAME, DRAMT = ISNULL((CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END ), 0), CRAMT = ISNULL((CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END ), 0), LEFT(CONVERT(VARCHAR, VDT, 103), 10) VDT, "  
 SELECT @@CLBALPART = " CLBAL = 0"  
 SELECT @@FROMPART = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE "  
 SELECT @@WHEREPART = " WHERE L.VTYP = " + @VTYP + " AND L.BOOKTYPE = '" + @BOOKTYPE + "' AND L.VNO = '" + @VNO + "'"  
        IF UPPER(RTRIM(@SORTBY)) = 'ACCODE'  
       SELECT @@ORDERBYPART = " ORDER BY L.CLTCODE "  
        ELSE IF UPPER(RTRIM(@SORTBY)) = 'ACNAME'  
        SELECT @@ORDERBYPART = " ORDER BY A.ACNAME "  
             ELSE IF UPPER(RTRIM(@SORTBY)) = 'DRCR'  
        SELECT @@ORDERBYPART = " ORDER BY L.DRCR "  
   END  
ELSE  
   BEGIN  
 SELECT @@SELECTPART = " SELECT L2.CLTCODE, A.ACNAME, DRAMT = ISNULL((CASE WHEN UPPER(DRCR) = 'D' THEN CAMT ELSE 0 END ), 0), CRAMT = ISNULL((CASE WHEN UPPER(DRCR) = 'C' THEN CAMT ELSE 0 END ), 0), "  
 SELECT @@CLBALPART = " CLBAL =  0"  
 SELECT @@FROMPART = " FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE, COSTMAST C "  
 SELECT @@WHEREPART = " WHERE L2.VTYPE = " + @VTYP + " AND L2.BOOKTYPE = '" + @BOOKTYPE + "' AND L2.VNO = '" + @VNO + "'"  
 SELECT @@ADDWHERE = @@ADDWHERE + " AND L2.COSTCODE = C.COSTCODE AND C.COSTNAME = '" + RTRIM(@BRANCHCD) + "' "  
        IF UPPER(RTRIM(@SORTBY)) = 'ACCODE'  
       SELECT @@ORDERBYPART = " ORDER BY L2.CLTCODE "  
        ELSE IF UPPER(RTRIM(@SORTBY)) = 'ACNAME'  
        SELECT @@ORDERBYPART = " ORDER BY A.ACNAME "  
             ELSE IF UPPER(RTRIM(@SORTBY)) = 'DRCR'  
        SELECT @@ORDERBYPART = " ORDER BY L2.DRCR "  
   END  
  
PRINT @@SELECTPART + @@CLBALPART + @@FROMPART + @@WHEREPART + @@ADDWHERE + @@ORDERBYPART  
  
EXEC (@@SELECTPART + @@CLBALPART + @@FROMPART + @@WHEREPART + @@ADDWHERE + @@ORDERBYPART )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACC_VALANSUMPARTYTOTAL
-- --------------------------------------------------


CREATE PROC ACC_VALANSUMPARTYTOTAL  
@BRANCHCD AS VARCHAR(10),   
@OPENDATE AS VARCHAR(11),   
@CLOSDATE AS VARCHAR(11),   
@VTYP SMALLINT,   
@BOOKTYPE VARCHAR(2),   
@VNO  VARCHAR(12),   
@REPORTOPTION CHAR(1),   
@BALOPTION CHAR(1),   
@SORTBY VARCHAR(10)  
AS  
IF RTRIM(@BRANCHCD) = '%'   
   BEGIN  
 SELECT DRAMT = ISNULL(SUM((CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END )), 0),   
 CRAMT = ISNULL(SUM((CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END )), 0)   
 FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE   
 WHERE ( A.ACCAT = '4'  OR A.ACCAT = '104' )  
 AND L.VTYP = @VTYP AND L.BOOKTYPE = @BOOKTYPE AND L.VNO = @VNO   
   END  
ELSE  
   BEGIN  
 SELECT DRAMT = ISNULL(SUM((CASE WHEN UPPER(DRCR) = 'D' THEN CAMT ELSE 0 END )), 0),   
 CRAMT = ISNULL(SUM((CASE WHEN UPPER(DRCR) = 'C' THEN CAMT ELSE 0 END )), 0)   
 FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE, COSTMAST C   
 WHERE A.ACCAT = '4'   
 AND L2.VTYPE = @VTYP AND L2.BOOKTYPE = @BOOKTYPE AND L2.VNO = @VNO   
 AND L2.COSTCODE = C.COSTCODE AND C.COSTNAME = RTRIM(@BRANCHCD)  
   END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ACNAMESELECT
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.ACNAMESELECT    SCRIPT DATE: 05/10/2004 5:10:42 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.ACNAMESELECT    SCRIPT DATE: 02/26/1980 1:57:20 AM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.ACNAMESELECT    SCRIPT DATE: 01/04/1980 1:40:35 AM ******/  
  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.ACNAMESELECT    SCRIPT DATE: 11/28/2001 12:23:39 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.ACNAMESELECT    SCRIPT DATE: 11/24/2001 10:30:11 AM ******/  
/* MODIFIED BY VAISHALI ON 05/11/2001 ADDED FLAGS FROM 4 TO 6*/  
/****** OBJECT:  STORED PROCEDURE DBO.ACNAMESELECT    SCRIPT DATE: 10/08/2001 3:11:54 AM ******/  
CREATE PROC ACNAMESELECT  
@FLAG INTEGER  
AS  
IF @FLAG = 1   
BEGIN    
 SELECT ACNAME,A.ACCAT,ACTYP,CATNAME,CLTCODE FROM ACMAST A,  
        CATMAST C WHERE C.ACCAT = A.ACCAT AND C.ACCAT NOT IN  ('1','2','14')   
        ORDER BY ACNAME   
END  
ELSE IF @FLAG = 2  
BEGIN  
 SELECT ACNAME,A.ACCAT,ACTYP,CATNAME,CLTCODE FROM ACMAST A,  
         CATMAST C WHERE C.ACCAT = A.ACCAT AND C.ACCAT NOT IN  ('14')   
         ORDER BY ACNAME   
END    
ELSE IF @FLAG = 3  
BEGIN  
        SELECT ACNAME,A.ACCAT,ACTYP,CATNAME,CLTCODE FROM ACMAST A,  
        CATMAST C WHERE C.ACCAT = A.ACCAT AND C.ACCAT  IN  ('4')   
        ORDER BY ACNAME   
END    
  
ELSE IF @FLAG = 4  /* FOR SELECTING CASH NAME AND CODE*/  
BEGIN  
 SELECT ACNAME,CLTCODE FROM ACMAST   
         WHERE  ACCAT  =  '1'            
END  
  
ELSE IF @FLAG = 5 /* FOR SELECTING BANK NAME AND CODE*/  
BEGIN  
 SELECT ACNAME,CLTCODE FROM ACMAST   
         WHERE  ACCAT  =  '2'            
END  
  
ELSE IF @FLAG = 6   /* FOR SELECTING PARTY NAME AND CODE*/  
BEGIN  
 SELECT ACNAME,CLTCODE FROM ACMAST   
         WHERE  ACCAT  =  '4'            
END  
  
ELSE IF @FLAG = 7   /* FOR SELECTING ALL ACCOUNTS OTHER THAN PARTY */  
BEGIN  
 SELECT ACNAME,CLTCODE FROM ACMAST   
         WHERE  ACCAT <> '4'            
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADD_CLIENT_ACCOUNT_PROC_INSERT
-- --------------------------------------------------



CREATE PROC ADD_CLIENT_ACCOUNT_PROC_INSERT (
@EXCHANGE VARCHAR(3), 
@SEGMENT VARCHAR(7), 
@BRANCH_CD VARCHAR(10), 
@FROMPARTY VARCHAR(10),
@TOPARTY VARCHAR(10),
@MAINDATE VARCHAR(30),
@DETDATE VARCHAR(30)
) AS

UPDATE OWNER SET COMPANYNAME = COMPANYNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADD_CLIENT_ACCOUNT_PROC_UPDATE
-- --------------------------------------------------
CREATE  Proc Add_Client_Account_Proc_Update (      
@Exchange Varchar(3),       
@Segment Varchar(7),       
@Branch_Cd Varchar(10),       
@FromParty Varchar(10),      
@ToParty Varchar(10),      
@MainDate Varchar(30),      
@DetDate Varchar(30)      
) As      
      
Delete From AcMast      
Where CltCode In ( Select Party_Code       
                   From MCDXCDS.DBO.Client_Details_Tmp C, MCDXCDS.DBO.Client_Brok_Details_Tmp D      
                   Where D.Exchange = @Exchange And D.Segment = @Segment        
     And C.Cl_Code = D.Cl_Code)      
      
Insert into AcMast      
Select ACName = Long_Name, LongName = Long_Name,   
ACTyp = (Case When Cl_Type ='SBD' Then 'LIABILITIE' Else 'ASSET' End),       
ACCat = (Case When Cl_Type ='SBD' Then '3' Else '4' End),   
FamilyCd = '', CltCode = Party_Code, AccDtls = '',   
GrpCode = (Case When Cl_Type ='SBD' Then 'L0704000000' Else 'A0307000000' End),       
BookType = '', MicrNo = Micr_No, BranchCode = Branch_Cd, BtoBPayment = Pay_B3B_Payment,       
PayMode = Pay_Payment_Mode, POBankName = Pay_Bank_Name, POBranch = Pay_Branch_Name, POBankcode = Pay_Ac_No      
From MCDXCDS.DBO.Client_Details_Tmp C, MCDXCDS.DBO.Client_Brok_Details_Tmp D      
Where D.Exchange = @Exchange And D.Segment = @Segment        
And C.Cl_Code = D.Cl_Code   
   
Insert into MultiBankId  
SELECT Party_code,BankID=P.BankID,CltDpId=AC_Num,        
Depository=IsNull((Case When Ac_Type = 'S' Then 'SAVING'         
                        When Ac_Type = 'C' Then 'CURRENT'         
                        Else 'OTHER' End), 'OTHER'),  
Long_Name, DEF=1  
From MCDXCDS.DBO.Client_Details_Tmp C, MCDXCDS.DBO.Client_Brok_Details_Tmp D, MCDXCDS.DBO.POBank P        
Where D.Exchange = @Exchange And D.Segment = @Segment          
And C.Cl_Code = D.Cl_Code        
And Ac_Type <> ''        
And C.Party_Code Not In (Select CltCode From MultiBankId )  
And P.Bank_Name = C.Bank_Name And P.Branch_Name = C.Branch_Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADD_CLIENT_ACCOUNT_PROC_UPDATE_new
-- --------------------------------------------------
CREATE PROC ADD_CLIENT_ACCOUNT_PROC_UPDATE (      
@EXCHANGE VARCHAR(3),       
@SEGMENT VARCHAR(7),       
@BRANCH_CD VARCHAR(10),       
@FROMPARTY VARCHAR(10),      
@TOPARTY VARCHAR(10),      
@MAINDATE VARCHAR(30),      
@DETDATE VARCHAR(30)      
) AS      
      
DELETE FROM ACMAST      
WHERE CLTCODE IN ( SELECT PARTY_CODE       
                   FROM MCDXCDS.DBO.CLIENT_DETAILS_TMP C, MCDXCDS.DBO.CLIENT_BROK_DETAILS_TMP D      
                   WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
     AND C.CL_CODE = D.CL_CODE)      
      
INSERT INTO ACMAST      
SELECT ACNAME = LONG_NAME, LONGNAME = LONG_NAME, ACTYP = 'ASSET',       
ACCAT = '4', FAMILYCD = '', CLTCODE = PARTY_CODE, ACCDTLS = '', GRPCODE = 'A0307000000',       
BOOKTYPE = '', MICRNO = MICR_NO, BRANCHCODE = BRANCH_CD, BTOBPAYMENT = PAY_B3B_PAYMENT,       
PAYMODE = PAY_PAYMENT_MODE, POBANKNAME = PAY_BANK_NAME, POBRANCH = PAY_BRANCH_NAME, POBANKCODE = PAY_AC_NO      
FROM MCDXCDS.DBO.CLIENT_DETAILS_TMP C, MCDXCDS.DBO.CLIENT_BROK_DETAILS_TMP D      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE  
  
INSERT INTO MULTIBANKID  
SELECT PARTY_CODE,BANKID=P.BANKID,CLTDPID=AC_NUM,        
DEPOSITORY=ISNULL((CASE WHEN AC_TYPE = 'S' THEN 'SAVING'         
                        WHEN AC_TYPE = 'C' THEN 'CURRENT'         
                        ELSE 'OTHER' END), 'OTHER'),  
LONG_NAME, DEF=1  
FROM MCDXCDS.DBO.CLIENT_DETAILS_TMP C, MCDXCDS.DBO.CLIENT_BROK_DETAILS_TMP D, MCDXCDS.DBO.POBANK P        
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT          
AND C.CL_CODE = D.CL_CODE        
AND AC_TYPE <> ''        
AND C.PARTY_CODE NOT IN (SELECT CLTCODE FROM MULTIBANKID )  
AND P.BANK_NAME = C.BANK_NAME AND P.BRANCH_NAME = C.BRANCH_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AGEINGCURSOR_NEW1_SB
-- --------------------------------------------------


--EXEC AGEINGCURSOR_NEW1_SB '10100000', '10100010', 'APR  1 2004', 'NOV 19 2004','PARTY','',0, 'A','EDT','BROKER','BROKER', 6,26,90,160,161,'101', 'VALSAD'  
CREATE PROCEDURE AGEINGCURSOR_NEW1_SB
@FROMPARTY VARCHAR(10),      
@TOPARTY VARCHAR(10),       
@OPENDATE VARCHAR(11),      
@TODATE VARCHAR(11),      
@REPORTTYPE VARCHAR(15),      
@FAMILY VARCHAR(10),      
@AMOUTGTTHAN MONEY,      
@AGEOPTION VARCHAR(1),      
@DTTYPE VARCHAR(3),  
@STATUSID VARCHAR(10),  
@STATUSNAME VARCHAR(25),  
@DAYS1 INT = 6,  
@DAYS2 INT = 29,  
@DAYS3 INT = 90,  
@DAYS4 INT = 180,  
@DAYS5 INT = 181,  
@FRSB VARCHAR(10) = '0',  
@TOSB VARCHAR(10) = 'ZZZZ'  
  
  
  
AS  
  
DECLARE  
@@BALCUR AS CURSOR,      
@@BALDATE AS VARCHAR(11),      
@@OPENBALDT AS VARCHAR(11),      
@@BALAMT AS MONEY,      
@@OCLTCODE AS VARCHAR(10),      
@@VTYP AS SMALLINT,      
@@VNO VARCHAR(12),      
@@EVDT AS DATETIME,      
@@VAMT AS MONEY,      
@@CLOSBAL AS MONEY,      
@@CLTCODE AS VARCHAR(10),      
@@BRANCHCODE AS VARCHAR(25),      
@@AREA AS VARCHAR(25),  
@@DRCR    AS VARCHAR(1),      
@@STARTDT AS DATETIME  
    
PRINT 'STRATED '     
PRINT CONVERT(DATETIME,GETDATE(),113)    
    
SET NOCOUNT ON      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
    
SELECT @@STARTDT = ( SELECT LEFT(CONVERT(VARCHAR,DATEADD(MM,-12,CONVERT(DATETIME,@TODATE)),109),11) )      
      
      
IF UPPER(@STATUSID) = 'BROKER'      
BEGIN       
 SELECT @@BRANCHCODE = '%'       
 SELECT @@AREA = '%'       
END      
ELSE IF UPPER(@STATUSID) = 'BRANCH'      
BEGIN      
 SELECT @@BRANCHCODE = RTRIM(@STATUSNAME)      
 SELECT @@AREA = '%'       
END   
ELSE IF UPPER(@STATUSID) = 'AREA'      
BEGIN      
 SELECT @@BRANCHCODE = '%'  
 SELECT @@AREA = RTRIM(@STATUSNAME)  
END   
      
SELECT CLTCODE,VDT AS BALDATE , VAMT CLOSBAL, AGEDAYS=0   INTO  #TEMPAGEING  FROM LEDGER WHERE 1=2    
SELECT CLTCODE,VDT AS BALDATE , VAMT CLOSBAL, AGEDAYS=0   INTO  #TEMPAGEING1  FROM LEDGER WHERE 1=2    
  
SELECT * INTO #LEDGER FROM LEDGER WHERE 1=2  
  
SELECT CLTCODE,VTYP,VNO,EDT AS EVDT,VAMT,VAMT CLOSBAL INTO #LEDGERCURSOR FROM LEDGER WHERE 1=2  
      
IF @DTTYPE='VDT'  
BEGIN  
 SELECT @@OPENBALDT=LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM LEDGER WHERE VTYP = '18' AND VDT < = @OPENDATE   
   
 IF UPPER(@REPORTTYPE) = 'PARTY'  
 BEGIN  
  INSERT   INTO #TEMPAGEING1       
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM LEDGER L, MCDXCDS.DBO.CLIENT1 C1, MCDXCDS.DBO.CLIENT2 C2 WHERE L.CLTCODE = C2.PARTY_CODE  
  AND C1.CL_CODE = C2.CL_CODE  
  AND VDT >= @@OPENBALDT + ' 00:00:00' AND VDT <= @TODATE + ' 23:59:59'       
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY AND C1.BRANCH_CD LIKE @@BRANCHCODE+'%' AND AREA LIKE @@AREA+'%'  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE       
    
  INSERT   INTO #TEMPAGEING    
  SELECT CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM(CLOSBAL),AGEDAYS=0      
  FROM #TEMPAGEING1      
  GROUP BY CLTCODE      
  ORDER BY CLTCODE       
 END  
  
 ELSE IF UPPER(@REPORTTYPE) = 'FAMILY'  
 BEGIN  
  INSERT   INTO #TEMPAGEING1      
  SELECT FAMILY AS CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM LEDGER L,  MCDXCDS.DBO.CLIENT1 C1, MCDXCDS.DBO.CLIENT2 C2 WHERE C1.CL_CODE = C2.CL_CODE  
  AND VDT >= @@OPENBALDT + ' 00:00:00' AND VDT <= @TODATE + ' 23:59:59'      
  AND L.CLTCODE = C2.PARTY_CODE AND C1.FAMILY >= @FROMPARTY AND C1.FAMILY <= @TOPARTY      
  AND C1.BRANCH_CD LIKE @@BRANCHCODE+'%' AND AREA LIKE @@AREA+'%'  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY FAMILY       
  ORDER BY FAMILY  
  
  INSERT   INTO #TEMPAGEING    
  SELECT CLTCODE, BALDATE=@TODATE,       
   CLOSBAL = SUM(CLOSBAL),AGEDAYS=0      
  FROM #TEMPAGEING1      
  GROUP BY CLTCODE       
  ORDER BY CLTCODE  
    
 END  
  
 ELSE IF UPPER(@REPORTTYPE) = 'FAMILYPARTY'  
 BEGIN  
  INSERT   INTO #TEMPAGEING1  
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM LEDGER L, MCDXCDS.DBO.CLIENT1 C1, MCDXCDS.DBO.CLIENT2 C2 WHERE C1.CL_CODE = C2.CL_CODE  
  AND VDT >= @@OPENBALDT + ' 00:00:00' AND VDT <= @TODATE + ' 23:59:59'       
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY   
  AND C1.BRANCH_CD LIKE @@BRANCHCODE+'%' AND AREA LIKE @@AREA+'%'  
  AND L.CLTCODE = C2.PARTY_CODE AND C1.FAMILY = @FAMILY  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE      
 
  INSERT   INTO #TEMPAGEING    
  SELECT CLTCODE, BALDATE=@TODATE,       
   CLOSBAL = SUM(CLOSBAL),AGEDAYS=0      
  FROM #TEMPAGEING1      
  GROUP BY CLTCODE      
  ORDER BY CLTCODE      
    
 END  
  
 IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'      
 BEGIN      
  INSERT INTO #LEDGER   
  SELECT * FROM LEDGER WHERE VDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT DISTINCT CLTCODE FROM #TEMPAGEING)       
 END      
  
 ELSE      
 BEGIN      
  INSERT INTO #LEDGER   
  SELECT * FROM LEDGER WHERE VDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT PARTY_CODE FROM MCDXCDS.DBO.CLIENT2 C2, MCDXCDS.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB)       
 END      
   
 IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'      
 BEGIN      
  IF UPPER(RTRIM(@AGEOPTION)) = 'D'       
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT L.CLTCODE, VTYP, VNO, VDT, VAMT, CLOSBAL      
   FROM #LEDGER L, #TEMPAGEING A      
   WHERE CLOSBAL >= 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND L.CLTCODE = A.CLTCODE     
   AND VDT <= @TODATE  + ' 23:59:59'       
   --  
   AND VTYP <> '18'      
   ORDER BY L.CLTCODE, VDT DESC, VTYP, VNO  
  END  
   
  ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT L.CLTCODE, VTYP, VNO, VDT, VAMT, CLOSBAL      
   FROM #LEDGER L, #TEMPAGEING A      
   WHERE CLOSBAL < 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND L.CLTCODE = A.CLTCODE      
   AND VDT <= @TODATE  + ' 23:59:59'      
   --  
   AND VTYP <> '18'    
   ORDER BY L.CLTCODE, VDT DESC, VTYP, VNO       
  END  
   
  ELSE  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT L.CLTCODE, VTYP, VNO, VDT, VAMT, CLOSBAL      
   FROM #LEDGER L, #TEMPAGEING A  
   WHERE DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND L.CLTCODE = A.CLTCODE      
   AND VDT <= @TODATE  + ' 23:59:59'      
   --  
   AND VTYP <> '18'   
   ORDER BY L.CLTCODE, VDT DESC, VTYP, VNO       
  END  
 END  
   
 ELSE      
 BEGIN      
  IF UPPER(RTRIM(@AGEOPTION)) = 'D'       
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT CLTCODE=FAMILY, VTYP, VNO, VDT, VAMT, CLOSBAL      
   FROM #LEDGER L, MCDXCDS.DBO.CLIENTMASTER C,  #TEMPAGEING A WHERE A.CLTCODE = FAMILY      
   AND CLOSBAL >= 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND VDT <= @TODATE  + ' 23:59:59'       
   AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY       
   --  
   AND VTYP <> '18'      
   ORDER BY CLTCODE, VDT DESC, VTYP, VNO      
  END  
   
  ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT CLTCODE=FAMILY, VTYP, VNO, VDT, VAMT, CLOSBAL   
   FROM #LEDGER L, MCDXCDS.DBO.CLIENTMASTER C, #TEMPAGEING A WHERE  A.CLTCODE = FAMILY      
   AND CLOSBAL < 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND VDT <= @TODATE  + ' 23:59:59'       
   AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY       
   --  
   AND VTYP <> '18'      
   ORDER BY CLTCODE, VDT DESC, VTYP, VNO      
  END  
   
  ELSE  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT CLTCODE=FAMILY, VTYP, VNO, VDT, VAMT, CLOSBAL      
   FROM #LEDGER L, MCDXCDS.DBO.CLIENTMASTER C, #TEMPAGEING A WHERE A.CLTCODE = FAMILY      
   AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND VDT <= @TODATE  + ' 23:59:59'       
   AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY       
   --  
   AND VTYP <> '18'      
   ORDER BY CLTCODE, VDT DESC, VTYP, VNO      
  END  
 END  
  
END  
  
ELSE  
BEGIN  
 SELECT @@OPENBALDT=LEFT(CONVERT(VARCHAR,ISNULL(MAX(EDT),0),109),11) FROM LEDGER WHERE VTYP = '18' AND EDT < = @OPENDATE  
  
 IF UPPER(@REPORTTYPE) = 'PARTY'  
 BEGIN  
  INSERT   INTO #TEMPAGEING1   
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM LEDGER L, ACMAST A, MCDXCDS.DBO.CLIENT1 C1 WHERE L.CLTCODE = A.CLTCODE AND L.CLTCODE = C1.CL_CODE  
  AND EDT >= @@OPENBALDT + ' 00:00:00' AND EDT <= @TODATE + ' 23:59:59'       
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY AND A.BRANCHCODE LIKE @@BRANCHCODE+'%'       
  AND A.ACCAT = 4  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE  
    
  INSERT   INTO #TEMPAGEING    
  SELECT CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM(CLOSBAL),AGEDAYS=0      
  FROM #TEMPAGEING1      
  GROUP BY CLTCODE      
  ORDER BY CLTCODE   
    
 END  
  
 ELSE IF UPPER(@REPORTTYPE) = 'FAMILY'  
 BEGIN  
  INSERT   INTO #TEMPAGEING1      
  SELECT FAMILY AS CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM LEDGER L,  MCDXCDS.DBO.CLIENT1 C --MCDXCDS.DBO.CLIENTMASTER C      
  WHERE EDT >= @@OPENBALDT + ' 00:00:00' AND EDT <= @TODATE + ' 23:59:59'      
  AND L.CLTCODE = C.CL_CODE AND C.FAMILY >= @FROMPARTY AND C.FAMILY <= @TOPARTY      
  AND C.BRANCH_CD LIKE @@BRANCHCODE+'%'   
  AND C.SUB_BROKER >= @FRSB AND C.SUB_BROKER <= @TOSB  
  GROUP BY FAMILY       
  ORDER BY FAMILY  

  INSERT   INTO #TEMPAGEING    
  SELECT CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM(CLOSBAL),AGEDAYS=0      
  FROM #TEMPAGEING1      
  GROUP BY CLTCODE      
  ORDER BY CLTCODE   
    
 END  
   
 ELSE IF UPPER(@REPORTTYPE) = 'FAMILYPARTY'  
 BEGIN  
  INSERT INTO #TEMPAGEING1  
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM LEDGER L, MCDXCDS.DBO.CLIENT1 C--MCDXCDS.DBO.CLIENTMASTER C    
  WHERE EDT >= @@OPENBALDT + ' 00:00:00' AND EDT <= @TODATE + ' 23:59:59'  
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY   
  AND C.BRANCH_CD LIKE @@BRANCHCODE+'%'  
  AND L.CLTCODE = C.CL_CODE AND C.FAMILY = @FAMILY       
  AND C.SUB_BROKER >= @FRSB AND C.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE      
   
  INSERT   INTO #TEMPAGEING    
  SELECT CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM(CLOSBAL),AGEDAYS=0      
  FROM #TEMPAGEING1      
  GROUP BY CLTCODE      
  ORDER BY CLTCODE   
   
 END  
   
 IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'      
 BEGIN      
  INSERT INTO #LEDGER   
  SELECT * FROM LEDGER WHERE EDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT DISTINCT CLTCODE FROM #TEMPAGEING)      
 END  
       
 ELSE      
 BEGIN      
  INSERT INTO #LEDGER   
  SELECT * FROM LEDGER WHERE EDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT PARTY_CODE FROM MCDXCDS.DBO.CLIENT2 C2, MCDXCDS.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB)  
 END      
   
 IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'      
 BEGIN      
  IF UPPER(RTRIM(@AGEOPTION)) = 'D'  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT L.CLTCODE, VTYP, VNO, EDT, VAMT, CLOSBAL      
   FROM #LEDGER L, #TEMPAGEING A      
   WHERE CLOSBAL >= 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND L.CLTCODE = A.CLTCODE     
   AND EDT <= @TODATE  + ' 23:59:59'       
   --  
   AND VTYP <> '18'      
   ORDER BY L.CLTCODE, EDT DESC, VTYP, VNO      
  END  
   
  ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'  
  BEGIN  
   INSERT INTO #LEDGERCURSOR       
   SELECT L.CLTCODE, VTYP, VNO, EDT, VAMT, CLOSBAL      
   FROM #LEDGEREDT L, #TEMPAGEING A      
   WHERE CLOSBAL < 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND L.CLTCODE = A.CLTCODE      
   AND EDT <= @TODATE  + ' 23:59:59'      
   --  
   AND VTYP <> '18'      
   ORDER BY L.CLTCODE, EDT DESC, VTYP, VNO    
  END  
   
  ELSE  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT L.CLTCODE, VTYP, VNO, EDT, VAMT, CLOSBAL      
   FROM #LEDGER L, #TEMPAGEING A      
   WHERE DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND L.CLTCODE = A.CLTCODE      
   AND EDT <= @TODATE  + ' 23:59:59'      
   --   
   AND VTYP <> '18'      
   ORDER BY L.CLTCODE, EDT DESC, VTYP, VNO   
  END  
 END  
   
 ELSE      
 BEGIN      
  IF UPPER(RTRIM(@AGEOPTION)) = 'D'       
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT CLTCODE=FAMILY, VTYP, VNO, EDT, VAMT, CLOSBAL      
   FROM #LEDGER L, MCDXCDS.DBO.CLIENTMASTER C,  #TEMPAGEING A WHERE A.CLTCODE = FAMILY      
   AND CLOSBAL >= 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND EDT <= @TODATE  + ' 23:59:59'       
   AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY       
   --  
   AND VTYP <> '18'      
   ORDER BY CLTCODE, EDT DESC, VTYP, VNO      
  END  
   
  ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT CLTCODE=FAMILY, VTYP, VNO, EDT, VAMT, CLOSBAL   
   FROM #LEDGER L, MCDXCDS.DBO.CLIENTMASTER C, #TEMPAGEING A WHERE  A.CLTCODE = FAMILY      
   AND CLOSBAL < 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND EDT <= @TODATE  + ' 23:59:59'       
   AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY       
   --  
   AND VTYP <> '18'      
   ORDER BY CLTCODE, EDT DESC, VTYP, VNO      
  END  
   
  ELSE  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT CLTCODE=FAMILY, VTYP, VNO, EDT, VAMT, CLOSBAL      
   FROM #LEDGER L, MCDXCDS.DBO.CLIENTMASTER C, #TEMPAGEING A WHERE A.CLTCODE = FAMILY      
   AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND EDT <= @TODATE  + ' 23:59:59'       
   AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY       
   --  
   AND VTYP <> '18'      
   ORDER BY CLTCODE, EDT DESC, VTYP, VNO      
  END  
 END  
END  
      
      
PRINT 'FILLED LEDGERCURSOR'     
PRINT CONVERT(DATETIME,GETDATE(),113)    
    
SET @@BALCUR = CURSOR FOR      
SELECT CLTCODE, VTYP, VNO, EVDT, VAMT, CLOSBAL  FROM #LEDGERCURSOR ORDER BY CLTCODE, EVDT DESC, VTYP, VNO    
SELECT CLTCODE,VAMT BALAMT,0 AGEDAYS,DRCR INTO #FINTEMPAGEING FROM #LEDGER WHERE 1= 2      
      
PRINT 'OPENING CURSOR'      
      
OPEN @@BALCUR  
FETCH NEXT FROM @@BALCUR INTO  @@CLTCODE, @@VTYP, @@VNO, @@EVDT, @@VAMT, @@CLOSBAL       
  
WHILE @@FETCH_STATUS = 0     
BEGIN       
 SELECT @@OCLTCODE = @@CLTCODE       
  SELECT @@BALAMT = ABS(@@CLOSBAL)      
 IF @@CLOSBAL >= 0       
 BEGIN      
  SELECT @@DRCR = 'D'      
 END   
     ELSE      
 BEGIN      
       SELECT @@DRCR = 'C'      
 END  
  
 WHILE @@FETCH_STATUS = 0 AND @@OCLTCODE = @@CLTCODE  AND @@BALAMT > 0      
 BEGIN      
  IF @@BALAMT >= @@VAMT       
  BEGIN    
   INSERT INTO #FINTEMPAGEING      
   SELECT @@CLTCODE, @@VAMT, DATEDIFF(DAY,@@EVDT,@TODATE), @@DRCR       
   SELECT @@BALAMT = @@BALAMT - @@VAMT     
  END      
  
  ELSE      
  BEGIN      
   INSERT INTO #FINTEMPAGEING      
   SELECT @@CLTCODE, @@BALAMT, DATEDIFF(DAY,@@EVDT,@TODATE), @@DRCR       
   SELECT @@BALAMT = @@BALAMT - @@VAMT       
  END      
  
  FETCH NEXT FROM @@BALCUR INTO  @@CLTCODE, @@VTYP, @@VNO, @@EVDT, @@VAMT, @@CLOSBAL       
 END      
  
 IF @@BALAMT > 0      
 BEGIN    
   INSERT INTO #FINTEMPAGEING      
   SELECT @@OCLTCODE, @@BALAMT, 181, @@DRCR       
   SELECT @@BALAMT = @@BALAMT - @@VAMT      
 END      
  
 WHILE @@FETCH_STATUS = 0 AND @@OCLTCODE = @@CLTCODE  
 BEGIN    
     FETCH NEXT FROM @@BALCUR INTO  @@CLTCODE, @@VTYP, @@VNO, @@EVDT, @@VAMT, @@CLOSBAL      
 END      
END  
      
CLOSE @@BALCUR      
DEALLOCATE @@BALCUR      
      
PRINT 'CURSOR CLOSED'      
PRINT CONVERT(DATETIME,GETDATE(),113)    
      
SELECT CLTCODE, BALANCE=SUM(BALAMT), AGEDAYS = @DAYS1, DRCR INTO #AGEINGLIST      
FROM #FINTEMPAGEING   
WHERE AGEDAYS >= 0 AND AGEDAYS <= @DAYS1  
GROUP BY CLTCODE, DRCR      
ORDER BY CLTCODE, DRCR      
      
INSERT INTO #AGEINGLIST     
SELECT CLTCODE, BALANCE=SUM(BALAMT), AGEDAYS = @DAYS2, DRCR       
FROM #FINTEMPAGEING      
WHERE AGEDAYS >= @DAYS1+1 AND AGEDAYS <= @DAYS2  
GROUP BY CLTCODE, DRCR       
ORDER BY CLTCODE, DRCR      
      
INSERT INTO #AGEINGLIST      
SELECT CLTCODE, BALANCE=SUM(BALAMT), AGEDAYS = @DAYS3, DRCR       
FROM #FINTEMPAGEING      
WHERE AGEDAYS >= @DAYS2+1 AND AGEDAYS <= @DAYS3  
GROUP BY CLTCODE, DRCR       
ORDER BY CLTCODE, DRCR       
  
INSERT INTO #AGEINGLIST      
SELECT CLTCODE, BALANCE=SUM(BALAMT), AGEDAYS = @DAYS4, DRCR       
FROM #FINTEMPAGEING      
WHERE AGEDAYS >= @DAYS3+1 AND AGEDAYS <= @DAYS4  
GROUP BY CLTCODE, DRCR       
ORDER BY CLTCODE, DRCR       
      
INSERT INTO #AGEINGLIST      
SELECT CLTCODE, BALANCE=SUM(BALAMT), AGEDAYS = @DAYS5, DRCR       
FROM #FINTEMPAGEING      
WHERE AGEDAYS >= @DAYS5  
GROUP BY CLTCODE, DRCR       
ORDER BY CLTCODE, DRCR       
  
PRINT 'DONE'      
PRINT CONVERT(DATETIME,GETDATE(),113)    
      
SELECT A1.CLTCODE, SHORT_NAME = A2.SHORT_NAME, BALANCE, AGEDAYS, DRCR, A2.BRANCH_CD, A2.SUB_BROKER, B.BRANCH, S.NAME  
FROM #AGEINGLIST A1, MCDXCDS.DBO.CLIENT1 A2, MCDXCDS.DBO.SUBBROKERS S, MCDXCDS.DBO.BRANCH B--MCDXCDS.DBO.CLIENTMASTER A2--ACCOUNT.DBO.ACMAST  A2       
WHERE BALANCE >= @AMOUTGTTHAN AND       
A1.CLTCODE = A2.CL_CODE  
AND A2.BRANCH_CD = B.BRANCH_CODE  
AND A2.SUB_BROKER = S.SUB_BROKER  
ORDER BY A2.BRANCH_CD, A2.SUB_BROKER, A1.CLTCODE, A2.SHORT_NAME  
      
DROP TABLE #TEMPAGEING      
DROP TABLE #LEDGER      
DROP TABLE #LEDGERCURSOR       
DROP TABLE #AGEINGLIST      
DROP TABLE #FINTEMPAGEING

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AGEINGCURSOR_NEW10_SB
-- --------------------------------------------------


--EXEC AGEINGCURSOR_NEW10_SB '10100000', '10100010', 'APR  1 2004', 'NOV 19 2004','PARTY','',0, 'A','EDT','BROKER','BROKER', 6,26,90,160,161,'101', 'VALSAD'  
CREATE PROCEDURE AGEINGCURSOR_NEW10_SB
@FROMPARTY VARCHAR(10),      
@TOPARTY VARCHAR(10),       
@OPENDATE VARCHAR(11),      
@TODATE VARCHAR(11),      
@REPORTTYPE VARCHAR(15),      
@FAMILY VARCHAR(10),      
@AMOUTGTTHAN MONEY,      
@AGEOPTION VARCHAR(1),      
@DTTYPE VARCHAR(3),  
@STATUSID VARCHAR(10),  
@STATUSNAME VARCHAR(25),  
@DAYS1 INT = 6,  
@DAYS2 INT = 29,  
@DAYS3 INT = 90,  
@DAYS4 INT = 180,  
@DAYS5 INT = 181,  
@FRSB VARCHAR(10) = '0',  
@TOSB VARCHAR(10) = 'ZZZZ'  
  
  
  
AS  
  
DECLARE  
@@BALCUR AS CURSOR,      
@@BALDATE AS VARCHAR(11),      
@@OPENBALDT AS VARCHAR(11),      
@@BALAMT AS MONEY,      
@@OCLTCODE AS VARCHAR(10),      
@@VTYP AS SMALLINT,      
@@VNO VARCHAR(12),      
@@EVDT AS DATETIME,      
@@VAMT AS MONEY,      
@@CLOSBAL AS MONEY,      
@@CLTCODE AS VARCHAR(10),      
@@BRANCHCODE AS VARCHAR(25),      
@@AREA AS VARCHAR(25),  
@@DRCR    AS VARCHAR(1),      
@@STARTDT AS DATETIME  
    
PRINT 'STRATED '     
PRINT CONVERT(DATETIME,GETDATE(),113)    
    
SET NOCOUNT ON      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED     
    
SELECT @@STARTDT = ( SELECT LEFT(CONVERT(VARCHAR,DATEADD(MM,-12,CONVERT(DATETIME,@TODATE)),109),11) )      
      
      
IF UPPER(@STATUSID) = 'BROKER'      
BEGIN       
 SELECT @@BRANCHCODE = '%'       
 SELECT @@AREA = '%'       
END      
ELSE IF UPPER(@STATUSID) = 'BRANCH'      
BEGIN      
 SELECT @@BRANCHCODE = RTRIM(@STATUSNAME)      
 SELECT @@AREA = '%'       
END   
ELSE IF UPPER(@STATUSID) = 'AREA'      
BEGIN      
 SELECT @@BRANCHCODE = '%'  
 SELECT @@AREA = RTRIM(@STATUSNAME)  
END   
      
SELECT CLTCODE,VDT AS BALDATE , VAMT CLOSBAL, AGEDAYS=0   INTO  #TEMPAGEING  FROM LEDGER WHERE 1=2    
SELECT CLTCODE,VDT AS BALDATE , VAMT CLOSBAL, AGEDAYS=0   INTO  #TEMPAGEING1  FROM LEDGER WHERE 1=2    
  
SELECT * INTO #LEDGER FROM LEDGER WHERE 1=2  
  
SELECT CLTCODE,VTYP,VNO,EDT AS EVDT,VAMT,VAMT CLOSBAL INTO #LEDGERCURSOR FROM LEDGER WHERE 1=2  
      
IF @DTTYPE='VDT'  
BEGIN  
 SELECT @@OPENBALDT=LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM LEDGER WHERE VTYP = '18' AND VDT < = @OPENDATE   
   
 IF UPPER(@REPORTTYPE) = 'PARTY'  
 BEGIN  
  INSERT   INTO #TEMPAGEING1       
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM LEDGER L, MCDXCDS.DBO.CLIENT1 C1, MCDXCDS.DBO.CLIENT2 C2 WHERE L.CLTCODE = C2.PARTY_CODE  
  AND C1.CL_CODE = C2.CL_CODE  
  AND VDT >= @@OPENBALDT + ' 00:00:00' AND VDT <= @TODATE + ' 23:59:59'       
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY AND C1.BRANCH_CD LIKE @@BRANCHCODE+'%' AND AREA LIKE @@AREA+'%'  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE       
    
  INSERT   INTO #TEMPAGEING1       
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM ACCOUNTBSE.DBO.LEDGER L, MCDXCDS.DBO.CLIENT1 C1, MCDXCDS.DBO.CLIENT2 C2 WHERE L.CLTCODE = C2.PARTY_CODE  
  AND C1.CL_CODE = C2.CL_CODE  
  AND VDT >= @@OPENBALDT + ' 00:00:00' AND VDT <= @TODATE + ' 23:59:59'       
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY AND C1.BRANCH_CD LIKE @@BRANCHCODE+'%' AND AREA LIKE @@AREA+'%'  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE       
    
  INSERT   INTO #TEMPAGEING1       
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM ACCOUNTFO.DBO.LEDGER L, MCDXCDS.DBO.CLIENT1 C1, MCDXCDS.DBO.CLIENT2 C2 WHERE L.CLTCODE = C2.PARTY_CODE  
  AND C1.CL_CODE = C2.CL_CODE  
  AND VDT >= @@OPENBALDT + ' 00:00:00' AND VDT <= @TODATE + ' 23:59:59'       
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY AND C1.BRANCH_CD LIKE @@BRANCHCODE+'%' AND AREA LIKE @@AREA+'%'  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE       
    
    
  INSERT   INTO #TEMPAGEING    
  SELECT CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM(CLOSBAL),AGEDAYS=0      
  FROM #TEMPAGEING1      
  GROUP BY CLTCODE      
  ORDER BY CLTCODE       
 END  
  
 ELSE IF UPPER(@REPORTTYPE) = 'FAMILY'  
 BEGIN  
  INSERT   INTO #TEMPAGEING1      
  SELECT FAMILY AS CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM LEDGER L,  MCDXCDS.DBO.CLIENT1 C1, MCDXCDS.DBO.CLIENT2 C2 WHERE C1.CL_CODE = C2.CL_CODE  
  AND VDT >= @@OPENBALDT + ' 00:00:00' AND VDT <= @TODATE + ' 23:59:59'      
  AND L.CLTCODE = C2.PARTY_CODE AND C1.FAMILY >= @FROMPARTY AND C1.FAMILY <= @TOPARTY      
  AND C1.BRANCH_CD LIKE @@BRANCHCODE+'%' AND AREA LIKE @@AREA+'%'  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY FAMILY       
  ORDER BY FAMILY  
    
  INSERT   INTO #TEMPAGEING1      
  SELECT FAMILY AS CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM ACCOUNTBSE.DBO.LEDGER L,  MCDXCDS.DBO.CLIENT1 C1, MCDXCDS.DBO.CLIENT2 C2 WHERE C1.CL_CODE = C2.CL_CODE  
  AND VDT >= @@OPENBALDT + ' 00:00:00' AND VDT <= @TODATE + ' 23:59:59'      
  AND L.CLTCODE = C2.PARTY_CODE AND C1.FAMILY >= @FROMPARTY AND C1.FAMILY <= @TOPARTY      
  AND C1.BRANCH_CD LIKE @@BRANCHCODE+'%' AND AREA LIKE @@AREA+'%'  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY FAMILY       
  ORDER BY FAMILY  
    
  INSERT   INTO #TEMPAGEING1      
  SELECT FAMILY AS CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM ACCOUNTFO.DBO.LEDGER L,  MCDXCDS.DBO.CLIENT1 C1, MCDXCDS.DBO.CLIENT2 C2 WHERE C1.CL_CODE = C2.CL_CODE  
  AND VDT >= @@OPENBALDT + ' 00:00:00' AND VDT <= @TODATE + ' 23:59:59'      
  AND L.CLTCODE = C2.PARTY_CODE AND C1.FAMILY >= @FROMPARTY AND C1.FAMILY <= @TOPARTY      
  AND C1.BRANCH_CD LIKE @@BRANCHCODE+'%' AND AREA LIKE @@AREA+'%'  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY FAMILY       
  ORDER BY FAMILY  
    
  INSERT   INTO #TEMPAGEING    
  SELECT CLTCODE, BALDATE=@TODATE,       
   CLOSBAL = SUM(CLOSBAL),AGEDAYS=0      
  FROM #TEMPAGEING1      
  GROUP BY CLTCODE       
  ORDER BY CLTCODE  
    
 END  
  
 ELSE IF UPPER(@REPORTTYPE) = 'FAMILYPARTY'  
 BEGIN  
  INSERT   INTO #TEMPAGEING1  
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM LEDGER L, MCDXCDS.DBO.CLIENT1 C1, MCDXCDS.DBO.CLIENT2 C2 WHERE C1.CL_CODE = C2.CL_CODE  
  AND VDT >= @@OPENBALDT + ' 00:00:00' AND VDT <= @TODATE + ' 23:59:59'       
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY   
  AND C1.BRANCH_CD LIKE @@BRANCHCODE+'%' AND AREA LIKE @@AREA+'%'  
  AND L.CLTCODE = C2.PARTY_CODE AND C1.FAMILY = @FAMILY  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE      
    
  INSERT   INTO #TEMPAGEING1  
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM ACCOUNTBSE.DBO.LEDGER L, MCDXCDS.DBO.CLIENT1 C1, MCDXCDS.DBO.CLIENT2 C2 WHERE C1.CL_CODE = C2.CL_CODE  
  AND VDT >= @@OPENBALDT + ' 00:00:00' AND VDT <= @TODATE + ' 23:59:59'       
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY   
  AND C1.BRANCH_CD LIKE @@BRANCHCODE+'%' AND AREA LIKE @@AREA+'%'  
  AND L.CLTCODE = C2.PARTY_CODE AND C1.FAMILY = @FAMILY  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE      
    
  INSERT   INTO #TEMPAGEING1  
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM ACCOUNTFO.DBO.LEDGER L, MCDXCDS.DBO.CLIENT1 C1, MCDXCDS.DBO.CLIENT2 C2 WHERE C1.CL_CODE = C2.CL_CODE  
  AND VDT >= @@OPENBALDT + ' 00:00:00' AND VDT <= @TODATE + ' 23:59:59'       
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY   
  AND C1.BRANCH_CD LIKE @@BRANCHCODE+'%' AND AREA LIKE @@AREA+'%'  
  AND L.CLTCODE = C2.PARTY_CODE AND C1.FAMILY = @FAMILY  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE      
    
  INSERT   INTO #TEMPAGEING    
  SELECT CLTCODE, BALDATE=@TODATE,       
   CLOSBAL = SUM(CLOSBAL),AGEDAYS=0      
  FROM #TEMPAGEING1      
  GROUP BY CLTCODE      
  ORDER BY CLTCODE      
    
 END  
  
 IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'      
 BEGIN      
  INSERT INTO #LEDGER   
  SELECT * FROM LEDGER WHERE VDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT DISTINCT CLTCODE FROM #TEMPAGEING)       
    
  INSERT INTO #LEDGER   
  SELECT * FROM ACCOUNTBSE.DBO.LEDGER WHERE VDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT DISTINCT CLTCODE FROM #TEMPAGEING)       
    
  INSERT INTO #LEDGER   
  SELECT * FROM ACCOUNTFO.DBO.LEDGER WHERE VDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT DISTINCT CLTCODE FROM #TEMPAGEING)       
 END      
  
 ELSE      
 BEGIN      
  INSERT INTO #LEDGER   
  SELECT * FROM LEDGER WHERE VDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT PARTY_CODE FROM MCDXCDS.DBO.CLIENT2 C2, MCDXCDS.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB)       
    
  INSERT INTO #LEDGER   
  SELECT * FROM ACCOUNTBSE.DBO.LEDGER WHERE VDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT PARTY_CODE FROM MCDXCDS.DBO.CLIENT2 C2, MCDXCDS.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB)  
    
  INSERT INTO #LEDGER   
  SELECT * FROM ACCOUNTFO.DBO.LEDGER WHERE VDT <= @TODATE  + ' 23:59:59'  
  AND CLTCODE IN (SELECT PARTY_CODE FROM MCDXCDS.DBO.CLIENT2 C2, MCDXCDS.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB)  
 END      
   
 IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'      
 BEGIN      
  IF UPPER(RTRIM(@AGEOPTION)) = 'D'       
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT L.CLTCODE, VTYP, VNO, VDT, VAMT, CLOSBAL      
   FROM #LEDGER L, #TEMPAGEING A      
   WHERE CLOSBAL >= 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND L.CLTCODE = A.CLTCODE     
   AND VDT <= @TODATE  + ' 23:59:59'       
   --  
   AND VTYP <> '18'      
   ORDER BY L.CLTCODE, VDT DESC, VTYP, VNO  
  END  
   
  ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT L.CLTCODE, VTYP, VNO, VDT, VAMT, CLOSBAL      
   FROM #LEDGER L, #TEMPAGEING A      
   WHERE CLOSBAL < 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND L.CLTCODE = A.CLTCODE      
   AND VDT <= @TODATE  + ' 23:59:59'      
   --  
   AND VTYP <> '18'    
   ORDER BY L.CLTCODE, VDT DESC, VTYP, VNO       
  END  
   
  ELSE  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT L.CLTCODE, VTYP, VNO, VDT, VAMT, CLOSBAL      
   FROM #LEDGER L, #TEMPAGEING A  
   WHERE DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND L.CLTCODE = A.CLTCODE      
   AND VDT <= @TODATE  + ' 23:59:59'      
   --  
   AND VTYP <> '18'   
   ORDER BY L.CLTCODE, VDT DESC, VTYP, VNO       
  END  
 END  
   
 ELSE      
 BEGIN      
  IF UPPER(RTRIM(@AGEOPTION)) = 'D'       
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT CLTCODE=FAMILY, VTYP, VNO, VDT, VAMT, CLOSBAL      
   FROM #LEDGER L, MCDXCDS.DBO.CLIENTMASTER C,  #TEMPAGEING A WHERE A.CLTCODE = FAMILY      
   AND CLOSBAL >= 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND VDT <= @TODATE  + ' 23:59:59'       
   AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY       
   --  
   AND VTYP <> '18'      
   ORDER BY CLTCODE, VDT DESC, VTYP, VNO      
  END  
   
  ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT CLTCODE=FAMILY, VTYP, VNO, VDT, VAMT, CLOSBAL   
   FROM #LEDGER L, MCDXCDS.DBO.CLIENTMASTER C, #TEMPAGEING A WHERE  A.CLTCODE = FAMILY      
   AND CLOSBAL < 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND VDT <= @TODATE  + ' 23:59:59'       
   AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY       
   --  
   AND VTYP <> '18'      
   ORDER BY CLTCODE, VDT DESC, VTYP, VNO      
  END  
   
  ELSE  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT CLTCODE=FAMILY, VTYP, VNO, VDT, VAMT, CLOSBAL      
   FROM #LEDGER L, MCDXCDS.DBO.CLIENTMASTER C, #TEMPAGEING A WHERE A.CLTCODE = FAMILY      
   AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND VDT <= @TODATE  + ' 23:59:59'       
   AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY       
   --  
   AND VTYP <> '18'      
   ORDER BY CLTCODE, VDT DESC, VTYP, VNO      
  END  
 END  
  
END  
  
ELSE  
BEGIN  
 SELECT @@OPENBALDT=LEFT(CONVERT(VARCHAR,ISNULL(MAX(EDT),0),109),11) FROM LEDGER WHERE VTYP = '18' AND EDT < = @OPENDATE  
  
 IF UPPER(@REPORTTYPE) = 'PARTY'  
 BEGIN  
  INSERT   INTO #TEMPAGEING1   
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM LEDGER L, ACMAST A, MCDXCDS.DBO.CLIENT1 C1 WHERE L.CLTCODE = A.CLTCODE AND L.CLTCODE = C1.CL_CODE  
  AND EDT >= @@OPENBALDT + ' 00:00:00' AND EDT <= @TODATE + ' 23:59:59'       
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY AND A.BRANCHCODE LIKE @@BRANCHCODE+'%'       
  AND A.ACCAT = 4  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE  
       
  INSERT   INTO #TEMPAGEING1       
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.ACMAST A, MCDXCDS.DBO.CLIENT1 C1 WHERE L.CLTCODE = A.CLTCODE AND L.CLTCODE = C1.CL_CODE  
  AND EDT >= @@OPENBALDT + ' 00:00:00' AND EDT <= @TODATE + ' 23:59:59'       
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY AND A.BRANCHCODE LIKE @@BRANCHCODE+'%'       
  AND A.ACCAT = 4  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE  
    
  INSERT   INTO #TEMPAGEING1       
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.ACMAST A, MCDXCDS.DBO.CLIENT1 C1 WHERE L.CLTCODE = A.CLTCODE AND L.CLTCODE = C1.CL_CODE  
  AND EDT >= @@OPENBALDT + ' 00:00:00' AND EDT <= @TODATE + ' 23:59:59'       
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY AND A.BRANCHCODE LIKE @@BRANCHCODE+'%'       
  AND A.ACCAT = 4  
  AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE  
    
  INSERT   INTO #TEMPAGEING    
  SELECT CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM(CLOSBAL),AGEDAYS=0      
  FROM #TEMPAGEING1      
  GROUP BY CLTCODE      
  ORDER BY CLTCODE   
    
 END  
  
 ELSE IF UPPER(@REPORTTYPE) = 'FAMILY'  
 BEGIN  
  INSERT   INTO #TEMPAGEING1      
  SELECT FAMILY AS CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM LEDGER L,  MCDXCDS.DBO.CLIENT1 C --MCDXCDS.DBO.CLIENTMASTER C      
  WHERE EDT >= @@OPENBALDT + ' 00:00:00' AND EDT <= @TODATE + ' 23:59:59'      
  AND L.CLTCODE = C.CL_CODE AND C.FAMILY >= @FROMPARTY AND C.FAMILY <= @TOPARTY      
  AND C.BRANCH_CD LIKE @@BRANCHCODE+'%'   
  AND C.SUB_BROKER >= @FRSB AND C.SUB_BROKER <= @TOSB  
  GROUP BY FAMILY       
  ORDER BY FAMILY  
    
  INSERT   INTO #TEMPAGEING1      
  SELECT FAMILY AS CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM ACCOUNTBSE.DBO.LEDGER L,  MCDXCDS.DBO.CLIENT1 C--MCDXCDS.DBO.CLIENTMASTER C      
  WHERE EDT >= @@OPENBALDT + ' 00:00:00' AND EDT <= @TODATE + ' 23:59:59'      
  AND L.CLTCODE = C.CL_CODE AND C.FAMILY >= @FROMPARTY AND C.FAMILY <= @TOPARTY      
  AND C.BRANCH_CD LIKE @@BRANCHCODE+'%'   
  AND C.SUB_BROKER >= @FRSB AND C.SUB_BROKER <= @TOSB  
  GROUP BY FAMILY       
  ORDER BY FAMILY  
    
  INSERT   INTO #TEMPAGEING1      
  SELECT FAMILY AS CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM ACCOUNTFO.DBO.LEDGER L,  MCDXCDS.DBO.CLIENT1 C--MCDXCDS.DBO.CLIENTMASTER C      
  WHERE EDT >= @@OPENBALDT + ' 00:00:00' AND EDT <= @TODATE + ' 23:59:59'      
  AND L.CLTCODE = C.CL_CODE AND C.FAMILY >= @FROMPARTY AND C.FAMILY <= @TOPARTY      
  AND C.BRANCH_CD LIKE @@BRANCHCODE+'%'   
  AND C.SUB_BROKER >= @FRSB AND C.SUB_BROKER <= @TOSB  
  GROUP BY FAMILY       
  ORDER BY FAMILY  
    
    
  INSERT   INTO #TEMPAGEING    
  SELECT CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM(CLOSBAL),AGEDAYS=0      
  FROM #TEMPAGEING1      
  GROUP BY CLTCODE      
  ORDER BY CLTCODE   
    
 END  
   
 ELSE IF UPPER(@REPORTTYPE) = 'FAMILYPARTY'  
 BEGIN  
  INSERT INTO #TEMPAGEING1  
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM LEDGER L, MCDXCDS.DBO.CLIENT1 C--MCDXCDS.DBO.CLIENTMASTER C    
  WHERE EDT >= @@OPENBALDT + ' 00:00:00' AND EDT <= @TODATE + ' 23:59:59'  
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY   
  AND C.BRANCH_CD LIKE @@BRANCHCODE+'%'  
  AND L.CLTCODE = C.CL_CODE AND C.FAMILY = @FAMILY       
  AND C.SUB_BROKER >= @FRSB AND C.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE      
    
  INSERT INTO #TEMPAGEING1  
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM ACCOUNTBSE.DBO.LEDGER L, MCDXCDS.DBO.CLIENT1 C--MCDXCDS.DBO.CLIENTMASTER C      
  WHERE EDT >= @@OPENBALDT + ' 00:00:00' AND EDT <= @TODATE + ' 23:59:59'       
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY   
  AND C.BRANCH_CD LIKE @@BRANCHCODE+'%'  
  AND L.CLTCODE = C.CL_CODE AND C.FAMILY = @FAMILY       
  AND C.SUB_BROKER >= @FRSB AND C.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE           
    
  INSERT INTO #TEMPAGEING1  
  SELECT L.CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),AGEDAYS=0      
  FROM ACCOUNTFO.DBO.LEDGER L, MCDXCDS.DBO.CLIENT1 C--MCDXCDS.DBO.CLIENTMASTER C      
  WHERE EDT >= @@OPENBALDT + ' 00:00:00' AND EDT <= @TODATE + ' 23:59:59'       
  AND L.CLTCODE >= @FROMPARTY AND L.CLTCODE <= @TOPARTY   
  AND C.BRANCH_CD LIKE @@BRANCHCODE+'%'  
  AND L.CLTCODE = C.CL_CODE AND C.FAMILY = @FAMILY       
  AND C.SUB_BROKER >= @FRSB AND C.SUB_BROKER <= @TOSB  
  GROUP BY L.CLTCODE      
  ORDER BY L.CLTCODE  
    
  INSERT   INTO #TEMPAGEING    
  SELECT CLTCODE, BALDATE=@TODATE,       
  CLOSBAL = SUM(CLOSBAL),AGEDAYS=0      
  FROM #TEMPAGEING1      
  GROUP BY CLTCODE      
  ORDER BY CLTCODE   
   
 END  
   
 IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'      
 BEGIN      
  INSERT INTO #LEDGER   
  SELECT * FROM LEDGER WHERE EDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT DISTINCT CLTCODE FROM #TEMPAGEING)      
    
  INSERT INTO #LEDGER   
  SELECT * FROM ACCOUNTBSE.DBO.LEDGER WHERE EDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT DISTINCT CLTCODE FROM #TEMPAGEING)      
    
  INSERT INTO #LEDGER   
  SELECT * FROM ACCOUNTFO.DBO.LEDGER WHERE EDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT DISTINCT CLTCODE FROM #TEMPAGEING)     
 END  
       
 ELSE      
 BEGIN      
  INSERT INTO #LEDGER   
  SELECT * FROM LEDGER WHERE EDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT PARTY_CODE FROM MCDXCDS.DBO.CLIENT2 C2, MCDXCDS.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB)  
    
  INSERT INTO #LEDGER   
  SELECT * FROM ACCOUNTBSE.DBO.LEDGER WHERE EDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT PARTY_CODE FROM MCDXCDS.DBO.CLIENT2 C2, MCDXCDS.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB)  
    
  INSERT INTO #LEDGER   
  SELECT * FROM ACCOUNTFO.DBO.LEDGER WHERE EDT <= @TODATE  + ' 23:59:59'   
  AND CLTCODE IN (SELECT PARTY_CODE FROM MCDXCDS.DBO.CLIENT2 C2, MCDXCDS.DBO.CLIENT1 C1 WHERE C1.CL_CODE=C2.CL_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY AND C1.SUB_BROKER >= @FRSB AND C1.SUB_BROKER <= @TOSB)  
 END      
   
 IF UPPER(@REPORTTYPE) = 'PARTY' OR UPPER(@REPORTTYPE) = 'FAMILYPARTY'      
 BEGIN      
  IF UPPER(RTRIM(@AGEOPTION)) = 'D'  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT L.CLTCODE, VTYP, VNO, EDT, VAMT, CLOSBAL      
   FROM #LEDGER L, #TEMPAGEING A      
   WHERE CLOSBAL >= 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND L.CLTCODE = A.CLTCODE     
   AND EDT <= @TODATE  + ' 23:59:59'       
   --  
   AND VTYP <> '18'      
   ORDER BY L.CLTCODE, EDT DESC, VTYP, VNO      
  END  
   
  ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'  
  BEGIN  
   INSERT INTO #LEDGERCURSOR       
   SELECT L.CLTCODE, VTYP, VNO, EDT, VAMT, CLOSBAL      
   FROM #LEDGEREDT L, #TEMPAGEING A      
   WHERE CLOSBAL < 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND L.CLTCODE = A.CLTCODE      
   AND EDT <= @TODATE  + ' 23:59:59'      
   --  
   AND VTYP <> '18'      
   ORDER BY L.CLTCODE, EDT DESC, VTYP, VNO    
  END  
   
  ELSE  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT L.CLTCODE, VTYP, VNO, EDT, VAMT, CLOSBAL      
   FROM #LEDGER L, #TEMPAGEING A      
   WHERE DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND L.CLTCODE = A.CLTCODE      
   AND EDT <= @TODATE  + ' 23:59:59'      
   --   
   AND VTYP <> '18'      
   ORDER BY L.CLTCODE, EDT DESC, VTYP, VNO   
  END  
 END  
   
 ELSE      
 BEGIN      
  IF UPPER(RTRIM(@AGEOPTION)) = 'D'       
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT CLTCODE=FAMILY, VTYP, VNO, EDT, VAMT, CLOSBAL      
   FROM #LEDGER L, MCDXCDS.DBO.CLIENTMASTER C,  #TEMPAGEING A WHERE A.CLTCODE = FAMILY      
   AND CLOSBAL >= 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND EDT <= @TODATE  + ' 23:59:59'       
   AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY       
   --  
   AND VTYP <> '18'      
   ORDER BY CLTCODE, EDT DESC, VTYP, VNO      
  END  
   
  ELSE IF UPPER(RTRIM(@AGEOPTION)) = 'C'  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT CLTCODE=FAMILY, VTYP, VNO, EDT, VAMT, CLOSBAL   
   FROM #LEDGER L, MCDXCDS.DBO.CLIENTMASTER C, #TEMPAGEING A WHERE  A.CLTCODE = FAMILY      
   AND CLOSBAL < 0 AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND EDT <= @TODATE  + ' 23:59:59'       
   AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY       
   --  
   AND VTYP <> '18'      
   ORDER BY CLTCODE, EDT DESC, VTYP, VNO      
  END  
   
  ELSE  
  BEGIN  
   INSERT INTO #LEDGERCURSOR     
   SELECT CLTCODE=FAMILY, VTYP, VNO, EDT, VAMT, CLOSBAL      
   FROM #LEDGER L, MCDXCDS.DBO.CLIENTMASTER C, #TEMPAGEING A WHERE A.CLTCODE = FAMILY      
   AND DRCR = ( CASE WHEN CLOSBAL >= 0 THEN 'D' ELSE 'C' END )       
   AND EDT <= @TODATE  + ' 23:59:59'       
   AND L.CLTCODE = C.PARTY_CODE AND FAMILY >= @FROMPARTY AND FAMILY <= @TOPARTY       
   --  
   AND VTYP <> '18'      
   ORDER BY CLTCODE, EDT DESC, VTYP, VNO      
  END  
 END  
END  
      
      
PRINT 'FILLED LEDGERCURSOR'     
PRINT CONVERT(DATETIME,GETDATE(),113)    
    
SET @@BALCUR = CURSOR FOR      
SELECT CLTCODE, VTYP, VNO, EVDT, VAMT, CLOSBAL  FROM #LEDGERCURSOR ORDER BY CLTCODE, EVDT DESC, VTYP, VNO    
SELECT CLTCODE,VAMT BALAMT,0 AGEDAYS,DRCR INTO #FINTEMPAGEING FROM #LEDGER WHERE 1= 2      
      
PRINT 'OPENING CURSOR'      
      
OPEN @@BALCUR  
FETCH NEXT FROM @@BALCUR INTO  @@CLTCODE, @@VTYP, @@VNO, @@EVDT, @@VAMT, @@CLOSBAL       
  
WHILE @@FETCH_STATUS = 0     
BEGIN       
 SELECT @@OCLTCODE = @@CLTCODE       
  SELECT @@BALAMT = ABS(@@CLOSBAL)      
 IF @@CLOSBAL >= 0       
 BEGIN      
  SELECT @@DRCR = 'D'      
 END   
     ELSE      
 BEGIN      
       SELECT @@DRCR = 'C'      
 END  
  
 WHILE @@FETCH_STATUS = 0 AND @@OCLTCODE = @@CLTCODE  AND @@BALAMT > 0      
 BEGIN      
  IF @@BALAMT >= @@VAMT       
  BEGIN    
   INSERT INTO #FINTEMPAGEING      
   SELECT @@CLTCODE, @@VAMT, DATEDIFF(DAY,@@EVDT,@TODATE), @@DRCR       
   SELECT @@BALAMT = @@BALAMT - @@VAMT     
  END      
  
  ELSE      
  BEGIN      
   INSERT INTO #FINTEMPAGEING      
   SELECT @@CLTCODE, @@BALAMT, DATEDIFF(DAY,@@EVDT,@TODATE), @@DRCR       
   SELECT @@BALAMT = @@BALAMT - @@VAMT       
  END      
  
  FETCH NEXT FROM @@BALCUR INTO  @@CLTCODE, @@VTYP, @@VNO, @@EVDT, @@VAMT, @@CLOSBAL       
 END      
  
 IF @@BALAMT > 0      
 BEGIN    
   INSERT INTO #FINTEMPAGEING      
   SELECT @@OCLTCODE, @@BALAMT, 181, @@DRCR       
   SELECT @@BALAMT = @@BALAMT - @@VAMT      
 END      
  
 WHILE @@FETCH_STATUS = 0 AND @@OCLTCODE = @@CLTCODE  
 BEGIN    
     FETCH NEXT FROM @@BALCUR INTO  @@CLTCODE, @@VTYP, @@VNO, @@EVDT, @@VAMT, @@CLOSBAL      
 END      
END  
      
CLOSE @@BALCUR      
DEALLOCATE @@BALCUR      
      
PRINT 'CURSOR CLOSED'      
PRINT CONVERT(DATETIME,GETDATE(),113)    
      
SELECT CLTCODE, BALANCE=SUM(BALAMT), AGEDAYS = @DAYS1, DRCR INTO #AGEINGLIST      
FROM #FINTEMPAGEING   
WHERE AGEDAYS >= 0 AND AGEDAYS <= @DAYS1  
GROUP BY CLTCODE, DRCR      
ORDER BY CLTCODE, DRCR      
      
INSERT INTO #AGEINGLIST     
SELECT CLTCODE, BALANCE=SUM(BALAMT), AGEDAYS = @DAYS2, DRCR       
FROM #FINTEMPAGEING      
WHERE AGEDAYS >= @DAYS1+1 AND AGEDAYS <= @DAYS2  
GROUP BY CLTCODE, DRCR       
ORDER BY CLTCODE, DRCR      
      
INSERT INTO #AGEINGLIST      
SELECT CLTCODE, BALANCE=SUM(BALAMT), AGEDAYS = @DAYS3, DRCR       
FROM #FINTEMPAGEING      
WHERE AGEDAYS >= @DAYS2+1 AND AGEDAYS <= @DAYS3  
GROUP BY CLTCODE, DRCR       
ORDER BY CLTCODE, DRCR       
  
INSERT INTO #AGEINGLIST      
SELECT CLTCODE, BALANCE=SUM(BALAMT), AGEDAYS = @DAYS4, DRCR       
FROM #FINTEMPAGEING      
WHERE AGEDAYS >= @DAYS3+1 AND AGEDAYS <= @DAYS4  
GROUP BY CLTCODE, DRCR       
ORDER BY CLTCODE, DRCR       
      
INSERT INTO #AGEINGLIST      
SELECT CLTCODE, BALANCE=SUM(BALAMT), AGEDAYS = @DAYS5, DRCR       
FROM #FINTEMPAGEING      
WHERE AGEDAYS >= @DAYS5  
GROUP BY CLTCODE, DRCR       
ORDER BY CLTCODE, DRCR       
  
PRINT 'DONE'      
PRINT CONVERT(DATETIME,GETDATE(),113)    
      
SELECT A1.CLTCODE, SHORT_NAME = A2.SHORT_NAME, BALANCE, AGEDAYS, DRCR, A2.BRANCH_CD, A2.SUB_BROKER, B.BRANCH, S.NAME  
FROM #AGEINGLIST A1, MCDXCDS.DBO.CLIENT1 A2, MCDXCDS.DBO.SUBBROKERS S, MCDXCDS.DBO.BRANCH B--MCDXCDS.DBO.CLIENTMASTER A2--ACCOUNT.DBO.ACMAST  A2       
WHERE BALANCE >= @AMOUTGTTHAN AND       
A1.CLTCODE = A2.CL_CODE  
AND A2.BRANCH_CD = B.BRANCH_CODE  
AND A2.SUB_BROKER = S.SUB_BROKER  
ORDER BY A2.BRANCH_CD, A2.SUB_BROKER, A1.CLTCODE, A2.SHORT_NAME  
      
DROP TABLE #TEMPAGEING      
DROP TABLE #LEDGER      
DROP TABLE #LEDGERCURSOR       
DROP TABLE #AGEINGLIST      
DROP TABLE #FINTEMPAGEING

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Angel_BrsAutoRecon
-- --------------------------------------------------
CREATE proc Angel_BrsAutoRecon(@Segment int)      
as      
      
--set @relDate = convert(datetime,@relDate,107)      
      
select Vno,vtyp,lno,bookType,Reldt,RefNo into #x from [196.1.115.235].brs.dbo.ledger1 where       
/*dddt>='apr 01 2008' and dddt<='mar 31 2009' and */      
reldt <> '1900-01-01' and B_Seg_Code = @Segment      
      
      
update ledger1 set RefNo =  #x.RefNo, RelDt = #x.Reldt from      
#x where  #x.Vno  = ledger1.vno and #x.vtyp = ledger1.vtyp and #x.bookType = ledger1.bookType      
and #x.lno = ledger1.lno and ledger1.reldt='jan 01 1900'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_Client_receipt_reco
-- --------------------------------------------------
CREATE procedure angel_Client_receipt_reco
as  
  
Set Transaction isolation level read uncommitted  
declare @tdate as datetime,@daysbefore as int,@prodate as varchar(11)  
select @tdate = getdate()+1  
--set @prodate = convert(varchar(11),getdate()-1)  
set @prodate = convert(varchar(11),getdate())  
select @daysbefore=datediff(dd,@prodate,getdate())+1  
  
select t.accno,l.vtyp, l.booktype, l.vno, l.vdt, tdate=convert(varchar,l.vdt,103), isnull(l1.ddno,'') ddno, isnull(l.cltcode ,'') cltcode ,  
isnull( l.acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then l.vamt else 0 end ),  
Cramt= (case when upper(l.drcr) = 'C' then l.vamt else 0 end ),  
treldt=isnull(convert(varchar, l1.reldt , 103),''), l1.refno,last_Date=getdate()  
into #recodet  
From ledger l (nolock) left outer join LEDGER1 L1 (nolock) on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno  
inner join  
(select vtyp, booktype, vno, lno,accno=cltcode from ledger l (nolock) where  exists  
(Select accno from angel_BANK_Accno abc (nolock) where l.cltcode=abc.accno)  
and not (l.narration like 'BEING AMT RECD TECH PROCESS%' or l.narration like 'BEING AMT RECD ING%')  
group by vtyp, booktype, vno, lno,cltcode   
) t  
on l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype  
-- and (cltcode <> @code  
where l.cltcode >='A0001' and l.cltcode <='ZZZZZ' and l.drcr='C' and l.vdt <=@tdate-@daysbefore  
/* Commented By Shweta On 05/01/2010 --Start  
and clear_mode not in ( 'R', 'C')  
--END*/  
and l.vtyp not in ( 16, 17)  
and (l1.reldt ='1900-01-01 00:00:00.000' or l1.reldt > @tdate )  
  
--declare @lastdt as datetime  
--select lastdt=max(reldt) from ledger1  
create nonclustered index ix_recodet on #recodet(accno)  
  
update #recodet set last_Date=b.updt from  
(  
SELECT l1.accno,updt=max(l.reldt) FROM ledger1 l (nolock)  
inner join   
(select vtyp, booktype, vno, lno,accno=cltcode from ledger l (nolock) where exists  
(Select accno from angel_BANK_Accno abc (nolock) where l.cltcode=abc.accno)  
group by vtyp, booktype, vno, lno,cltcode   
) L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno  
group by l1.accno  
) b where #recodet.accno=b.accno  
  

truncate table Angel_client_deposit_recno  
insert into Angel_client_deposit_recno select * from #recodet (nolock) --where ddno<>0  
delete from Angel_client_deposit_recno where cltcode like 'ING%'  

--EXEC ANGEL_KNOCKOFF_CANCEL_RECO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_Client_receipt_reco_25102012
-- --------------------------------------------------
CREATE procedure angel_Client_receipt_reco_25102012  
as    
     
Set Transaction isolation level read uncommitted    
declare @tdate as datetime,@daysbefore as int,@prodate as varchar(11)    
select @tdate = getdate()+1    
--set @prodate = convert(varchar(11),getdate()-1)    
set @prodate = convert(varchar(11),getdate())    
select @daysbefore=datediff(dd,@prodate,getdate())+1    
    
select t.accno,l.vtyp, l.booktype, l.vno, l.vdt, tdate=convert(varchar,l.vdt,103), isnull(l1.ddno,'') ddno, isnull(l.cltcode ,'') cltcode ,    
isnull( l.acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then l.vamt else 0 end ),    
Cramt= (case when upper(l.drcr) = 'C' then l.vamt else 0 end ),    
treldt=isnull(convert(varchar, l1.reldt , 103),''), l1.refno,last_Date=getdate()    
into #recodet    
From ledger l (nolock) left outer join LEDGER1 L1 (nolock) on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno    
inner join     
(select  vtyp, booktype, vno, lno,accno=cltcode from ledger l (nolock) where exists    
(Select accno from angel_BANK_Accno abc (nolock) where l.cltcode=abc.accno)    
and not (l.narration like 'BEING AMT RECD TECH PROCESS%' or l.narration like 'BEING AMT RECD ING%')    
group by vtyp, booktype, vno, lno,cltcode     
) t    
on l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype    
-- and (cltcode <> @code    
where l.cltcode >='A0001' and l.cltcode <='ZZZZZ' and l.drcr='C' and l.vdt <=@tdate-@daysbefore    
/* Commented By Shweta On 05/01/2010 --Start    
and clear_mode not in ( 'R', 'C')    
--END*/    
and l.vtyp not in ( 16, 17)    
and (l1.reldt ='1900-01-01 00:00:00.000' or l1.reldt > @tdate )    
    
--declare @lastdt as datetime    
--select lastdt=max(reldt) from ledger1    
create nonclustered index ix_recodet on #recodet(accno)    
    
update #recodet set last_Date=b.updt from    
(    
SELECT l1.accno,updt=max(l.reldt) FROM ledger1 l (nolock)    
inner join     
(select vtyp, booktype, vno, lno,accno=cltcode from ledger l (nolock) where exists    
(Select accno from angel_BANK_Accno abc (nolock) where l.cltcode=abc.accno )    
group by vtyp, booktype, vno, lno,cltcode     
) L1 on  l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno    
group by l1.accno    
) b where #recodet.accno=b.accno    
    
    
truncate table Angel_client_deposit_recno    
insert into Angel_client_deposit_recno select * from #recodet (nolock) --where ddno<>0    
delete from Angel_client_deposit_recno where cltcode like 'ING%'    
   
--EXEC ANGEL_KNOCKOFF_CANCEL_RECO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_Client_receipt_reco_optimized
-- --------------------------------------------------
CREATE procedure angel_Client_receipt_reco_optimized
as

Set Transaction isolation level read uncommitted
declare @tdate as datetime,@daysbefore as int,@prodate as varchar(11)
select @tdate = getdate()+1
--set @prodate = convert(varchar(11),getdate()-1)
set @prodate = convert(varchar(11),getdate())
select @daysbefore=datediff(dd,@prodate,getdate())+1

select t.accno,l.vtyp, l.booktype, l.vno, l.vdt, tdate=convert(varchar,l.vdt,103), isnull(l1.ddno,'') ddno, isnull(l.cltcode ,'') cltcode ,
isnull( l.acname ,'') acname, l.drcr, Dramt=(case when upper(l.drcr) = 'D' then l.vamt else 0 end ),
Cramt= (case when upper(l.drcr) = 'C' then l.vamt else 0 end ),
treldt=isnull(convert(varchar, l1.reldt , 103),''), l1.refno,last_Date=getdate()
into #recodet
From ledger l (nolock) left outer join LEDGER1 L1 (nolock) on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno
inner join
(select vtyp, booktype, vno, lno,accno=cltcode from ledger l (nolock) where  exists
(Select accno from angel_BANK_Accno abc (nolock) where l.cltcode=abc.accno)
and not (l.narration like 'BEING AMT RECD TECH PROCESS%' or l.narration like 'BEING AMT RECD ING%')
group by vtyp, booktype, vno, lno,cltcode 
) t
on l.vtyp = t.vtyp and l.vno= t.vno and l.booktype = t.booktype
-- and (cltcode <> @code
where l.cltcode >='A0001' and l.cltcode <='ZZZZZ' and l.drcr='C' and l.vdt <=@tdate-@daysbefore
/* Commented By Shweta On 05/01/2010 --Start
and clear_mode not in ( 'R', 'C')
--END*/
and l.vtyp not in ( 16, 17)
and (l1.reldt ='1900-01-01 00:00:00.000' or l1.reldt > @tdate )

--declare @lastdt as datetime
--select lastdt=max(reldt) from ledger1
create nonclustered index ix_recodet on #recodet(accno)

update #recodet set last_Date=b.updt from
(
SELECT l1.accno,updt=max(l.reldt) FROM ledger1 l (nolock)
inner join 
(select vtyp, booktype, vno, lno,accno=cltcode from ledger l (nolock) where exists
(Select accno from angel_BANK_Accno abc (nolock) where l.cltcode=abc.accno)
group by vtyp, booktype, vno, lno,cltcode 
) L1 on l.vtyp = l1.vtyp and l.booktype = l1.booktype and l.vno = l1.vno and l.lno = l1.lno
group by l1.accno
) b where #recodet.accno=b.accno

/****************************************************************************/
select top  0 * into #Angel_client_deposit_recno from Angel_client_deposit_recno
insert into #Angel_client_deposit_recno  select * from #recodet (nolock) --where ddno<>0
delete from #Angel_client_deposit_recno  where cltcode like 'ING%'
/*============================================================================*/

/*
truncate table Angel_client_deposit_recno
insert into Angel_client_deposit_recno select * from #recodet (nolock) --where ddno<>0
delete from Angel_client_deposit_recno where cltcode like 'ING%'
*/
--EXEC ANGEL_KNOCKOFF_CANCEL_RECO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost2
-- --------------------------------------------------
CREATE procedure angel_getledger_cost2(@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11))    
as    
    
set transaction isolation level read uncommitted    
    
set nocount on    
    
  
--Exec angel_getledger_cost1 'A108','Apr 01 2004','Jan 05 2006'    
/*  
drop table #abl_cost_a  
declare @cltcode as varchar(11),@fdate as varchar(11),@tdate as varchar(11)    
set @cltcode='70000014 '    
set @fdate='Apr 01 2004'    
set @tdate='Dec 30 2004'    
*/  
  
set transaction isolation level read uncommitted    
select a.*,camt=isnull(b.camt,0),costname=isnull(b.costname,' - ')    
into #abl_cost_a    
from     
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'    
) a left outer join    
(select camt=(case when drcr='D' then l2.camt else -l2.camt end),l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'')     
from ledger2 l2 (nolock)    
left outer join costmast cm (nolock)    
on l2.costcode=cm.costcode) b     
on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode    
  
set transaction isolation level read uncommitted  
select cltcode,vno,vtyp,vamt=(case when drcr='D' then vamt else -vamt end),acname  
into #file1  
from ledger (nolock)  
where vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'    
and (cltcode like '28%' or cltcode like '21%' or cltcode like '27%')   
and vno in (select vno from #abl_cost_a) and vtyp<>18  
  
  
  
set transaction isolation level read uncommitted  
select a.*,alt_cltcode=isnull(b.cltcode,''),alt_acname=isnull(b.acname,''),alt_vamt=isnull(b.vamt,0)  
into #abl_cost  
from #abl_cost_a a left outer join #file1 b on a.vno=b.vno and a.vtyp=b.vtyp   
  
set transaction isolation level read uncommitted   
select n.vdt,vtyp=isnull(v.ShortDesc,''),n.vno,n.narration as [narr],     
Debit=(case when drcr = 'D' then n.vamt else 0 end),Credit=abs(case when drcr = 'C' then -n.vamt else 0 end),     
balamt=convert(money,0.00),n.camt,n.costname,n.lno,alt_cltcode,alt_acname,alt_vamt  
from #abl_cost n left outer join     
vmast v (nolock) on vtyp=vtype    
order by n.vno,n.lno    
    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_getledger_cost3
-- --------------------------------------------------
CREATE procedure angel_getledger_cost3(@cltcode as varchar(25),@fdate as varchar(11),@tdate as varchar(11))          
as          
          
set transaction isolation level read uncommitted          
          
set nocount on          
          
        
--Exec angel_getledger_cost1 'A108','Apr 01 2004','Jan 05 2006'          
/*      
drop table #abl_cost_a        
declare @cltcode as varchar(11),@fdate as varchar(11),@tdate as varchar(11)          
set @cltcode='26100010'          
set @fdate='Jun 01 2007'          
set @tdate='Jun 30 2007'          
*/      
        
set transaction isolation level read uncommitted          
select a.*,camt=isnull(b.camt,0),costname=isnull(b.costname,' - ')          
into #abl_cost_a          
from           
(select * from ledger where cltcode=@cltcode and vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'          
) a left outer join          
(select camt=(case when drcr='D' then l2.camt else -l2.camt end),l2.cltcode,l2.vno,l2.vtype,l2.lno,costname=isnull(costname,'')           
from ledger2 l2 (nolock)          
left outer join costmast cm (nolock)          
on l2.costcode=cm.costcode) b           
on a.vno=b.vno and a.lno=b.lno and a.vtyp=b.vtype and a.cltcode=b.cltcode          
        
set transaction isolation level read uncommitted        
select cltcode,vno,vtyp,vamt=(case when drcr='D' then vamt else -vamt end),acname        
into #file1        
from ledger (nolock)        
where vdt>=@fdate+' 00:00:00' and vdt <=@tdate+' 23:59:59'          
and (cltcode like '28%' or cltcode like '21%' or cltcode like '27%' or cltcode like '35%')         
and vno in (select vno from #abl_cost_a) and vtyp<>18        
        
        
        
set transaction isolation level read uncommitted        
select a.*,alt_cltcode=isnull(b.cltcode,''),alt_acname=isnull(b.acname,''),alt_vamt=isnull(b.vamt,0)        
into #abl_cost        
from #abl_cost_a a left outer join #file1 b on a.vno=b.vno and a.vtyp=b.vtyp         
        
set transaction isolation level read uncommitted         
select n.vdt,vtyp=isnull(v.ShortDesc,''),n.vno,n.narration as [narr],           
Debit=(case when drcr = 'D' then n.vamt else 0 end),Credit=abs(case when drcr = 'C' then -n.vamt else 0 end),           
balamt=convert(money,0.00),n.camt,n.costname,n.lno,alt_cltcode,alt_acname,alt_vamt        
into #temp1      
from #abl_cost n left outer join           
vmast v (nolock) on vtyp=vtype          
      
delete from #temp1 where credit <= 0      
      
select vdt,vtyp,vno,credit,costname,alt_cltcode,alt_acname,alt_vamt,      
narration=      
CASE WHEN NARR LIKE 'TDS on remisier share of%' THEN      
SUBSTRING(replace(narr,'TDS on remisier share of ',''),1,CHARINDEX(' ',replace(narr,'TDS on remisier share of ',''),1))       
ELSE      
NARR      
END      
into #tempa      
from #temp1      
where alt_vamt < 0      
      
      
insert into #tempa      
select vdt,vtyp,vno,credit,costname,alt_cltcode,alt_acname,alt_vamt,      
narration=      
CASE WHEN NARR LIKE 'TDS on remisier share of%' THEN      
SUBSTRING(replace(narr,'TDS on remisier share of ',''),1,CHARINDEX(' ',replace(narr,'TDS on remisier share of ',''),1))       
ELSE      
NARR      
END      
from #temp1      
where vno not in (select vno from #tempa)      
      
select a.*,state=isnull(b.state,''),Pan_no=isnull(b.pan_no,'')      
from #tempa a left outer join mis.sb_comp.dbo.SB_State_pan b on a.costname=b.sub_BRoker order by vno      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ANGEL_GLAgeing
-- --------------------------------------------------
CREATE procedure ANGEL_GLAgeing    
(    
@GLcodefrom as varchar(10),@GLcodeto as varchar(10),    
@fromdate as varchar(11),@todate as varchar(11)    
)    
as    
    
set nocount on    
    
declare @fdate as datetime,@tdate as datetime    
set @fdate=convert(datetime,@fromdate+' 00:00')    
set @tdate=convert(datetime,@todate+' 23:59')    
    
    
select cltcode,value=sum(Case when drcr='D' then vamt else -vamt end),    
Bal0to30=convert(money,0),    
Bal31to60=convert(money,0),    
Bal61to90=convert(money,0),    
Bal90to180=convert(money,0),    
Bal181to360=convert(money,0),    
Bal361above=convert(money,0)    
into #ageing    
from ledger where vdt >=@fdate and vdt <=@tdate    
and cltcode >=@GLcodefrom and cltcode <=@GLcodeto    
group by cltcode    
    
    
    
select cltcode,vdt=convert(datetime,convert(varchar(11),vdt)),    
value=sum(Case when drcr='D' then vamt else -vamt end)    
into #file1    
from ledger where vdt >=@fdate and vdt <=@tdate    
and cltcode >=@GLcodefrom and cltcode <=@GLcodeto    
group by cltcode,convert(datetime,convert(varchar(11),vdt))    
    
--print @tdate-30    
update #ageing set Bal0to30=b.bal30days from    
(select cltcode,Bal30days=sum(value) from #file1 where Vdt <= @tdate and vdt >=@tdate-30    
group by cltcode) b where #ageing.cltcode=b.cltcode    
    
    
update #ageing set Bal31to60=b.bal60days from    
(select cltcode,Bal60days=sum(value) from #file1 where Vdt <= @tdate-30 and vdt >=@tdate-60    
group by cltcode) b where #ageing.cltcode=b.cltcode    
    
    
update #ageing set Bal61to90=b.bal90days from    
(select cltcode,Bal90days=sum(value) from #file1 where Vdt <= @tdate-60 and vdt >=@tdate-90    
group by cltcode) b where #ageing.cltcode=b.cltcode    
    
    
update #ageing set Bal90to180=b.bal180days from    
(select cltcode,Bal180days=sum(value) from #file1 where Vdt <= @tdate-90 and vdt >=@tdate-180    
group by cltcode) b where #ageing.cltcode=b.cltcode    
    
    
update #ageing set Bal181to360=b.bal360days from    
(select cltcode,Bal360days=sum(value) from #file1 where Vdt <= @tdate-180 and vdt >=@tdate-360    
group by cltcode) b where #ageing.cltcode=b.cltcode    
    
    
update #ageing set Bal361above=b.bal361days from    
(select cltcode,Bal361days=sum(value) from #file1 where Vdt <= @tdate-360     
group by cltcode) b where #ageing.cltcode=b.cltcode    
  
  
  
  
update #ageing set bal0to30=0 where value < 0 and bal0to30 > 0  
update #ageing set bal31to60=0 where value < 0 and bal0to30 <=0 and bal31to60 > 0  
update #ageing set bal61to90=0 where value < 0 and (bal0to30+BAL31TO60) <=0 and bal61to90 > 0  
update #ageing set bal90to180=0 where value < 0 and (bal0to30+BAL31TO60+BAL61TO90) <=0 and bal90to180 > 0  
update #ageing set bal181to360=0 where value < 0 and (bal0to30+BAL31TO60+BAL61TO90+BAL90TO180) <=0 and bal181to360 > 0  
update #ageing set bal361above=0 where value < 0 and (bal0to30+BAL31TO60+BAL61TO90+BAL90TO180+bal181to360) <=0 and bal361above > 0  
  
update #ageing set bal0to30=value,bal31to60=0,bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0  
where value < 0 and bal0to30 < value  
  
update #ageing set bal31to60=(value-bal0to30),bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0  
where value < 0 and (bal0to30+bal31to60) < value   
  
update #ageing set bal61to90=(value-bal0to30-bal31to60),bal90to180=0,bal181to360=0,bal361above=0  
where value < 0 and (bal0to30+bal31to60+bal61to90) < value   
  
update #ageing set bal90to180=(value-bal0to30-bal31to60-BAL61TO90),bal181to360=0,bal361above=0  
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180) < value   
  
update #ageing set bal181to360=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180),bal361above=0  
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) < value   
  
update #ageing set bal361above=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180-bal181to360)  
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) < value   
  
------------------- Debit Balance  
  
update #ageing set bal0to30=0 where value > 0 and bal0to30 < 0  
update #ageing set bal31to60=0 where value > 0 and bal31to60 < 0  
update #ageing set bal61to90=0 where value > 0 and bal61to90 < 0  
update #ageing set bal90to180=0 where value > 0 and bal90to180 < 0  
update #ageing set bal181to360=0 where value > 0 and bal181to360 < 0  
update #ageing set bal361above=0 where value > 0 and bal361above < 0  
  
  
  
update #ageing set bal0to30=value,bal31to60=0,bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0  
where value > 0 and bal0to30 >= value and bal0to30 > 0  
  
update #ageing set bal31to60=(value-bal0to30),bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0  
where value > 0 and bal0to30+bal31to60 >= value and bal31to60 > 0  
  
update #ageing set bal61to90=(value-bal0to30-bal31to60),bal90to180=0,bal181to360=0,bal361above=0  
where value > 0 and (bal0to30+bal31to60+bal61to90) >= value and bal61to90 > 0  
  
update #ageing set bal90to180=(value-bal0to30-bal31to60-BAL61TO90),bal181to360=0,bal361above=0  
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180) >= value and bal90to180 > 0  
  
  
update #ageing set bal181to360=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180),bal361above=0  
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) >= value   
and bal181to360 > 0  
  
update #ageing set bal361above=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180-bal181to360)  
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360+bal361above) >= value   
and bal361above > 0  
  
  
  
    
select x.*,SBcode=isnull(y.sbcode,'') from    
(select a.*,acname,branchcode from #ageing a, acmast b (nolock) where a.cltcode=b.cltcode) x    
left outer join     
(select * from mis.remisior.dbo.remi_ledcode where coname='ACPLMCX') y     
on x.cltcode=y.ledgercode    
    
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ANGEL_GLAgeing_New
-- --------------------------------------------------
create procedure ANGEL_GLAgeing_New        
(        
@GLcodefrom as varchar(10),@GLcodeto as varchar(10),        
@fromdate as varchar(11),@todate as varchar(11)        
)        
as        
 --This is the rectified query by sachin dewoolkar  & alok Jain on 12/06/2009 (cr Caluclation logic has been change to reverse of dr.)  
--before any modification contact to Sachin dewoolkar or alok jain.
set nocount on        
        
declare @fdate as datetime,@tdate as datetime        
set @fdate=convert(datetime,@fromdate+' 00:00')        
set @tdate=convert(datetime,@todate+' 23:59')        
        
        
select cltcode,value=sum(Case when drcr='D' then vamt else -vamt end),        
Bal0to30=convert(money,0),        
Bal31to60=convert(money,0),        
Bal61to90=convert(money,0),        
Bal90to180=convert(money,0),        
Bal181to360=convert(money,0),        
Bal361above=convert(money,0)        
into #ageing        
from ledger where vdt >=@fdate and vdt <=@tdate        
and cltcode >=@GLcodefrom and cltcode <=@GLcodeto        
group by cltcode        
        
        
        
select cltcode,vdt=convert(datetime,convert(varchar(11),vdt)),        
value=sum(Case when drcr='D' then vamt else -vamt end)        
into #file1        
from ledger where vdt >=@fdate and vdt <=@tdate        
and cltcode >=@GLcodefrom and cltcode <=@GLcodeto        
group by cltcode,convert(datetime,convert(varchar(11),vdt))        
        
--print @tdate-30        
update #ageing set Bal0to30=b.bal30days from        
(select cltcode,Bal30days=sum(value) from #file1 where Vdt <= @tdate and vdt >=@tdate-30        
group by cltcode) b where #ageing.cltcode=b.cltcode        
        
        
update #ageing set Bal31to60=b.bal60days from        
(select cltcode,Bal60days=sum(value) from #file1 where Vdt <= @tdate-30 and vdt >=@tdate-60        
group by cltcode) b where #ageing.cltcode=b.cltcode        
        
        
update #ageing set Bal61to90=b.bal90days from        
(select cltcode,Bal90days=sum(value) from #file1 where Vdt <= @tdate-60 and vdt >=@tdate-90        
group by cltcode) b where #ageing.cltcode=b.cltcode        
        
        
update #ageing set Bal90to180=b.bal180days from        
(select cltcode,Bal180days=sum(value) from #file1 where Vdt <= @tdate-90 and vdt >=@tdate-180        
group by cltcode) b where #ageing.cltcode=b.cltcode        
        
        
update #ageing set Bal181to360=b.bal360days from        
(select cltcode,Bal360days=sum(value) from #file1 where Vdt <= @tdate-180 and vdt >=@tdate-360        
group by cltcode) b where #ageing.cltcode=b.cltcode        
        
        
update #ageing set Bal361above=b.bal361days from        
(select cltcode,Bal361days=sum(value) from #file1 where Vdt <= @tdate-360         
group by cltcode) b where #ageing.cltcode=b.cltcode        
        
      
update #ageing set bal0to30=0 where value < 0 and bal0to30 > 0      
update #ageing set bal31to60=0 where value < 0 and bal31to60 > 0      
update #ageing set bal61to90=0 where value < 0 and bal61to90 > 0      
update #ageing set bal90to180=0 where value < 0 and bal90to180 > 0      
update #ageing set bal181to360=0 where value < 0 and bal181to360 > 0      
update #ageing set bal361above=0 where value < 0 and bal361above > 0      



update #ageing set bal0to30=value,bal31to60=0,bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0      
where value < 0 and bal0to30 <= value and bal0to30 < 0      

update #ageing set bal31to60=(value-bal0to30),bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0      
where value < 0 and bal0to30+bal31to60 <= value and bal31to60 < 0      

update #ageing set bal61to90=(value-bal0to30-bal31to60),bal90to180=0,bal181to360=0,bal361above=0      
where value < 0 and (bal0to30+bal31to60+bal61to90) <= value and bal61to90 < 0      

update #ageing set bal90to180=(value-bal0to30-bal31to60-BAL61TO90),bal181to360=0,bal361above=0      
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180) <= value and bal90to180 < 0      

update #ageing set bal181to360=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180),bal361above=0      
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) <= value       
and bal181to360 < 0      

update #ageing set bal361above=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180-bal181to360)      
where value < 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360+bal361above) <= value       
and bal361above < 0   
      
      
------------------- Debit Balance      
      
update #ageing set bal0to30=0 where value > 0 and bal0to30 < 0      
update #ageing set bal31to60=0 where value > 0 and bal31to60 < 0      
update #ageing set bal61to90=0 where value > 0 and bal61to90 < 0      
update #ageing set bal90to180=0 where value > 0 and bal90to180 < 0      
update #ageing set bal181to360=0 where value > 0 and bal181to360 < 0      
update #ageing set bal361above=0 where value > 0 and bal361above < 0      
      
      
      
update #ageing set bal0to30=value,bal31to60=0,bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0      
where value > 0 and bal0to30 >= value and bal0to30 > 0      
      
update #ageing set bal31to60=(value-bal0to30),bal61to90=0,bal90to180=0,bal181to360=0,bal361above=0      
where value > 0 and bal0to30+bal31to60 >= value and bal31to60 > 0      
      
update #ageing set bal61to90=(value-bal0to30-bal31to60),bal90to180=0,bal181to360=0,bal361above=0      
where value > 0 and (bal0to30+bal31to60+bal61to90) >= value and bal61to90 > 0      
      
update #ageing set bal90to180=(value-bal0to30-bal31to60-BAL61TO90),bal181to360=0,bal361above=0      
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180) >= value and bal90to180 > 0      
      
      
update #ageing set bal181to360=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180),bal361above=0      
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360) >= value       
and bal181to360 > 0      
      
update #ageing set bal361above=(value-bal0to30-bal31to60-BAL61TO90-BAL90TO180-bal181to360)      
where value > 0 and (bal0to30+bal31to60+bal61to90+BAL90TO180+BAL181TO360+bal361above) >= value       
and bal361above > 0      
      
      
      
select x.*,SBcode=isnull(y.sbcode,'') from        
(select a.*,acname,branchcode from #ageing a, acmast b (nolock) where a.cltcode=b.cltcode) x        
left outer join         
(select  top 1 * from mis.remisior.dbo.remi_ledcode where coname='ACPLMCD' ) y         
on x.cltcode=y.ledgercode        
          
        
      
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.angel_reco_acc2
-- --------------------------------------------------

CREATE procedure angel_reco_acc2  
as        
set nocount on        
        
set transaction isolation level read uncommitted        
select accno,longname, last_date,amount=sum(cramt) from angel_client_deposit_recno a (nolock), acmast b (nolock)      
where a.accno=b.cltcode   
and a.vdt <= convert(varchar(11),getdate()-6)+' 23:59:59'         
group by accno,last_date,longname order by amount desc        
        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTOJV_BULK
-- --------------------------------------------------
CREATE PROC [dbo].[AUTOJV_BULK]      
(      
 @PROCESS_ID VARCHAR(25),      
 @UNAME VARCHAR(25),      
 @VTYP SMALLINT,      
 @BOOKTYPE VARCHAR(2),      
 @USERCAT INT      
)      
      
AS      
 /*      
 DELETE FROM V2_UPLOADED_FILES WHERE U_FILENAME = 'D:\BACKOFFICE\DRCRNOTES\CR TAMMANA2.CSV'      
 EXEC DRCRNOTEUPLOAD_BULK 'D:\BACKOFFICE\DRCRNOTES\CR TAMMANA2.CSV', 'TEST', 6, '01'      
 EXEC DRCRNOTEUPLOAD_BULK 'D:\BACKOFFICE\DRCRNOTES\CR TAMMANA2.CSV', 'TEST', 6, '01'      
 */      
 SET NOCOUNT ON      
      
 DECLARE      
  @@ERROR_COUNT AS INT,      
  @@SQL AS VARCHAR(2000),      
  @@BACKDAYS INT,      
  @@BACKDATE DATETIME      
        
 IF  EXISTS (SELECT * FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[DBO].[TMP_RECPAY_TABLE_TMP]') AND TYPE IN (N'U'))      
  DROP TABLE [DBO].[TMP_RECPAY_TABLE_TMP]      
        
 IF  EXISTS (SELECT * FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[DBO].[TMP_RECPAY_TABLE]') AND TYPE IN (N'U'))      
  DROP TABLE [DBO].[TMP_RECPAY_TABLE]      
        
 IF  EXISTS (SELECT * FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[DBO].[TMP_RECPAY_TABLE_LNO]') AND TYPE IN (N'U'))      
  DROP TABLE [DBO].[TMP_RECPAY_TABLE_LNO]      
        
 IF  EXISTS (SELECT * FROM SYS.OBJECTS WHERE OBJECT_ID = OBJECT_ID(N'[DBO].[TMP_VNO]') AND TYPE IN (N'U'))      
  DROP TABLE [DBO].[TMP_VNO]      
        
 CREATE TABLE TMP_RECPAY_TABLE_TMP      
 (      
  SRNO INT,      
  VVDT VARCHAR(10),      
  EEDT VARCHAR(10),      
  CLTCODE VARCHAR(10),      
  GL_CODE VARCHAR(10),      
  DRCR VARCHAR(1),      
  AMOUNT MONEY,      
  NARRATION VARCHAR(500),      
  BRANCHCODE VARCHAR(10)      
 )      
      
 CREATE TABLE [TMP_RECPAY_TABLE]      
 (      
  SRNO INT,      
  VVDT VARCHAR(10),      
  EEDT VARCHAR(10),      
  CLTCODE VARCHAR(10),      
  DRCR VARCHAR(1),      
  AMOUNT MONEY,      
  NARRATION VARCHAR(500),      
  BRANCHCODE VARCHAR(10),      
  SNO INT IDENTITY (1, 1) NOT NULL ,      
  VDT DATETIME NULL ,      
  UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),      
  EDT DATETIME NULL ,      
  VNO VARCHAR (12)  NULL ,      
  ACNAME VARCHAR (100)  NULL ,      
  FYSTART DATETIME NULL,      
  FYEND DATETIME NULL,      
  COSTCODE SMALLINT NULL,      
  LNO SMALLINT NOT NULL DEFAULT(0)      
 ) ON [PRIMARY]      
      
 CREATE TABLE [TMP_RECPAY_TABLE_LNO]      
 (      
  SNO INT,      
  LNO INT IDENTITY (1, 1) NOT NULL      
 ) ON [PRIMARY]      
       
 INSERT INTO       
  TMP_RECPAY_TABLE_TMP      
 SELECT    
  FLDAUTO,       
  VVDT = CONVERT(VARCHAR(10), GETDATE(), 103),      
  EEDT = CONVERT(VARCHAR(10), GETDATE(), 103),      
  CLTCODE = PARTYCODE,      
  GL_CODE = CASE WHEN EXCHANGEFR = ACCOUNTDB THEN GLCODEFR ELSE GLCODETO END,      
  DRCR = CASE WHEN EXCHANGEFR = ACCOUNTDB THEN 'D' ELSE 'C' END ,      
  AMOUNT = JVAMT,      
  NARRATION /*= 'FUND TRNASFER'*/,      
  BRANCHCODE = 'ALL'      
 FROM       
  ACCOUNT_AB.DBO.OFFLINE_JV_ENTRIES J WITH (NOLOCK), OWNER O WITH (NOLOCK)      
 WHERE       
  (J.EXCHANGEFR = O.ACCOUNTDB OR EXCHANGETO = O.ACCOUNTDB) AND PROCESS_ID = @PROCESS_ID    
  AND (VCHNOFR IS NULL OR VCHNOTO IS NULL)    
        
 INSERT INTO       
  TMP_RECPAY_TABLE      
 (      
  SRNO,      
  VVDT,      
  EEDT,      
  CLTCODE,      
  DRCR,      
  AMOUNT,      
  NARRATION,      
  BRANCHCODE      
 )      
 SELECT      
  SRNO,      
  VVDT,      
  EEDT,      
  UPPER(CLTCODE),      
  DRCR,      
  AMOUNT,      
  LEFT(NARRATION, 234),      
  BRANCHCODE      
 FROM       
  TMP_RECPAY_TABLE_TMP      
      
 INSERT INTO       
  TMP_RECPAY_TABLE      
 (      
  SRNO,      
  VVDT,      
  EEDT,      
  CLTCODE,      
  DRCR,      
  AMOUNT,      
  NARRATION,      
  BRANCHCODE      
 )      
 SELECT      
  SRNO,      
  VVDT,      
  EEDT,      
  GL_CODE,      
  DRCR = CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END,      
  AMOUNT,      
  LEFT(NARRATION, 234),      
  BRANCHCODE      
 FROM       
  TMP_RECPAY_TABLE_TMP     
      
 UPDATE      
  TMP_RECPAY_TABLE      
 SET      
  VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),      
  EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),      
  FYSTART = P.SDTCUR,      
  FYEND = P.LDTCUR,      
  UPDFLAG = 'Y',      
  ACNAME = LONGNAME,      
  TMP_RECPAY_TABLE.COSTCODE = C.COSTCODE      
 FROM       
  ACMAST A,       
  PARAMETER P,       
  COSTMAST C      
 WHERE       
  A.CLTCODE = TMP_RECPAY_TABLE.CLTCODE      
  AND P.CURYEAR = 1      
  AND A.ACCAT IN ('3','4','104')      
  AND A.BRANCHCODE = C.COSTNAME      
  AND A.BRANCHCODE <> 'ALL'      
      
 UPDATE      
  TMP_RECPAY_TABLE      
 SET      
  VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),      
  EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),      
  FYSTART = P.SDTCUR,      
  FYEND = P.LDTCUR,      
  UPDFLAG = 'Y',      
  ACNAME = LONGNAME,      
  TMP_RECPAY_TABLE.COSTCODE = C.COSTCODE      
 FROM       
  ACMAST A,       
  PARAMETER P,       
  COSTMAST C      
 WHERE       
  A.CLTCODE = TMP_RECPAY_TABLE.CLTCODE      
  AND P.CURYEAR = 1      
  AND A.ACCAT IN ('3','4','104')      
  AND TMP_RECPAY_TABLE.BRANCHCODE = C.COSTNAME      
  AND A.BRANCHCODE = 'ALL'      
  AND TMP_RECPAY_TABLE.BRANCHCODE <> 'ALL'      
  AND TMP_RECPAY_TABLE.COSTCODE IS NULL      
      
 UPDATE      
  TMP_RECPAY_TABLE      
 SET      
  VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),      
  EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),      
  FYSTART = P.SDTCUR,      
  FYEND = P.LDTCUR,      
  UPDFLAG = 'Y',      
  ACNAME = LONGNAME,      
  TMP_RECPAY_TABLE.COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')      
 FROM       
  ACMAST A,       
  PARAMETER P      
 WHERE       
  A.CLTCODE = TMP_RECPAY_TABLE.CLTCODE      
  AND P.CURYEAR = 1      
  AND A.ACCAT IN ('3','4','104')      
  AND A.BRANCHCODE = 'ALL'      
  AND TMP_RECPAY_TABLE.BRANCHCODE = 'ALL'      
  AND TMP_RECPAY_TABLE.COSTCODE IS NULL      
      
 ---------------------------VALIDATION FOR INACTIVE CLIENTS FROM CLIENT5---------------------      
 UPDATE      
  TMP_RECPAY_TABLE      
 SET       
  UPDFLAG = 'N'      
 FROM      
 (      
 SELECT      
  PARTY_CODE,      
  INACTIVEFROM      
 FROM       
  MCDXCDS.DBO.CLIENT5 C5 WITH(NOLOCK),      
  MCDXCDS.DBO.CLIENT2 C2 WITH(NOLOCK)      
 WHERE       
  C2.CL_CODE = C5.CL_CODE      
  AND C2.PARTY_CODE IN (SELECT CLTCODE FROM TMP_RECPAY_TABLE)      
  AND INACTIVEFROM <= GETDATE()      
 ) C      
 WHERE       
  CLTCODE = C.PARTY_CODE      
      
 /* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/      
      
 DECLARE      
  @@STD_DATE VARCHAR(11),      
  @@LST_DATE VARCHAR(11),      
  @@VNOMETHOD INT,      
  @@ACNAME CHAR(100),      
  @@MICRNO VARCHAR(10),      
  @@DRCR VARCHAR(1)      
      
 /* '--------------------------UPDATE OF COST CODE ------------------------*/      
      
 UPDATE       
  TMP_RECPAY_TABLE      
 SET       
  COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')      
 WHERE       
  COSTCODE IS NULL      
      
 DECLARE      
  @@NEWVNO AS VARCHAR(12),      
  @@VDT AS VARCHAR(11),      
  @@LNOCUR AS CURSOR,      
  @@LNOVNO AS INT,      
  @@NOREC AS INT      
      
 /* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/      
 DECLARE      
  @@MAXVNO AS VARCHAR(12),      
  @@VNO AS VARCHAR(12),      
  @@RCOUNT AS INT      
        
 SELECT TOP 1      
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)      
 FROM      
  TMP_RECPAY_TABLE      
      
 SELECT TOP 1      
  @@VNOMETHOD = VNOFLAG,      
  @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),      
  @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)      
 FROM      
  PARAMETER      
 WHERE      
  @@VDT BETWEEN SDTCUR AND LDTCUR      
      
 SELECT      
  @@NOREC = COUNT(DISTINCT SRNO)      
 FROM      
  TMP_RECPAY_TABLE      
      
 CREATE TABLE TMP_VNO      
 (      
  LASTVNO VARCHAR(12)      
 )      
      
 INSERT INTO TMP_VNO      
 EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC      
      
 SELECT @@VNO = LASTVNO FROM TMP_VNO      
     
 CREATE TABLE #VNO_GEN    
 (    
 SNO INT IDENTITY(1, 1),    
 SRNO INT    
)    
    
INSERT INTO #VNO_GEN    
SELECT SRNO  FROM TMP_RECPAY_TABLE ORDER BY SRNO    
    
    
 UPDATE      
  TMP_RECPAY_TABLE      
 SET       
  VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + V.SNO - 1)      
  FROM #VNO_GEN V    
  WHERE V.SRNO  = TMP_RECPAY_TABLE.SRNO    
      
 /* '--------------------------AUTO GENERATION OF LNO ------------------------*/      
      
 SET @@LNOCUR = CURSOR FOR      
  SELECT DISTINCT SRNO FROM TMP_RECPAY_TABLE      
  OPEN @@LNOCUR      
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO      
  WHILE @@FETCH_STATUS = 0      
  BEGIN      
   INSERT INTO TMP_RECPAY_TABLE_LNO      
   (SNO)      
   SELECT SNO FROM TMP_RECPAY_TABLE WHERE SRNO = @@LNOVNO      
   UPDATE RP      
   SET LNO = RL.LNO      
   FROM TMP_RECPAY_TABLE RP, TMP_RECPAY_TABLE_LNO RL      
   WHERE RP.SNO = RL.SNO      
   TRUNCATE TABLE TMP_RECPAY_TABLE_LNO      
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO      
  END      
 CLOSE @@LNOCUR      
 DEALLOCATE @@LNOCUR      
       
 DROP TABLE TMP_RECPAY_TABLE_LNO      
 --SELECT * FROM TMP_RECPAY_TABLE      
 --RETURN      
      
 /* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/      
 /*==============================      
 LEDGER RECORD      
 ==============================*/      
      
 INSERT INTO      
  LEDGER      
 SELECT      
  VTYP = @VTYP,      
  VNO,      
  EDT,      
  LNO,      
  ACNAME,      
  DRCR,      
  VAMT = SUM(AMOUNT),      
  VDT,      
  VNO1 = VNO,      
  REFNO = 0,      
  BALAMT = SUM(AMOUNT),      
  NODAYS = 0,      
  CDT = GETDATE(),      
  CLTCODE,      
  BOOKTYPE = @BOOKTYPE,      
  ENTEREDBY = @UNAME,      
  PDT = GETDATE(),      
  CHECKEDBY = @UNAME,      
  ACTNODAYS = 0,      
  NARRATION      
 FROM      
  TMP_RECPAY_TABLE      
 GROUP BY      
  VNO,      
  EDT,      
  LNO,      
  ACNAME,      
  DRCR,      
  VDT,      
  CLTCODE,      
  NARRATION      
      
 /*==============================      
 LEDGER3 RECORD      
 ==============================*/      
 INSERT INTO      
  LEDGER3      
 SELECT      
  NARATNO = LNO,      
  NARRATION,      
  REFNO = 0,      
  VTYP = @VTYP,      
  VNO,      
  BOOKTYPE = @BOOKTYPE      
 FROM      
  TMP_RECPAY_TABLE      
      
 DELETE      
  TEMPLEDGER2      
 WHERE       
  SESSIONID = '9999999999'      
      
 INSERT INTO       
  TEMPLEDGER2      
 SELECT      
  'BRANCH',      
  C.COSTNAME,      
  AMOUNT,      
  VTYP = @VTYP,      
  VNO,      
  LNO,      
  DRCR,      
  '0',      
  BOOKTYPE = @BOOKTYPE,      
  SESSIONID = '9999999999',      
  CLIENT_CODE = CLTCODE,      
  'A',      
  '0'      
 FROM      
  TMP_RECPAY_TABLE RP,      
  COSTMAST C      
 WHERE      
  RP.COSTCODE = C.COSTCODE      
      
 DECLARE @@L2CUR AS CURSOR,      
  @@L2VNO AS VARCHAR(12)      
  SET @@L2CUR = CURSOR FOR      
  SELECT DISTINCT VNO FROM TMP_RECPAY_TABLE ORDER BY VNO      
  OPEN @@L2CUR      
  FETCH NEXT FROM @@L2CUR INTO @@L2VNO      
  WHILE @@FETCH_STATUS = 0      
  BEGIN      
   EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'      
   FETCH NEXT FROM @@L2CUR INTO @@L2VNO      
  END      
  DELETE FROM TEMPLEDGER2      
  WHERE SESSIONID = '9999999999'      
 CLOSE @@L2CUR      
 DEALLOCATE @@L2CUR      
      
 SELECT       
  RESULT = 'DATA UPLOADED SUCCESSFULLY'      
 UNION ALL      
 SELECT       
  RESULT = CLTCODE + ', ' + CONVERT(VARCHAR, AMOUNT) + ', ' + VNO       
 FROM       
  TMP_RECPAY_TABLE      
      
 UPDATE       
  J       
 SET      
  VCHNOFR = CASE WHEN O.ACCOUNTDB = J.EXCHANGEFR THEN R.VNO ELSE VCHNOFR END,      
  VCHNOTO = CASE WHEN O.ACCOUNTDB = J.EXCHANGETO THEN R.VNO ELSE VCHNOTO END      
 FROM       
  ACCOUNT_AB.DBO.OFFLINE_JV_ENTRIES J, OWNER O,      
  TMP_RECPAY_TABLE R      
 WHERE       
  SRNO = FLDAUTO       
  AND (O.ACCOUNTDB = EXCHANGEFR OR O.ACCOUNTDB = EXCHANGETO)      
      
 DROP TABLE TMP_RECPAY_TABLE_TMP      
 DROP TABLE TMP_RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AUTORECOUPDATE_HDFC_ALLBANKS
-- --------------------------------------------------


---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE PROC [dbo].[AUTORECOUPDATE_HDFC_ALLBANKS](              
           @FILENAME       VARCHAR(100),              
           @UNAME          VARCHAR(100),              
           @BANKCODE       VARCHAR(10),              
           @STATUSID       VARCHAR(10),              
           @STATUSNAME     VARCHAR(100),              
           @BANK_TYPE      VARCHAR(10),              
           @STAT_TYPE      VARCHAR(10),              
           @LOGIN          VARCHAR(10),              
           @PWD            VARCHAR(15),              
           @PROCESS_STATUS BIT  = 0)              
              
AS       

IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'              
BEGIN 
	EXEC KOTAK_RECO @BANKCODE, @FILENAME
	SELECT 'UPDATED SUCCESSFULLY.'              
	RETURN
END
              
  DECLARE  @@SQL_QUERY         AS VARCHAR(1000),              
           @@CROSSREFERENCENO INT,              
           @@TABLE_EXIST      VARCHAR(20),              
           @@RECORD_COUNT     TINYINT,              
           @@RECO_STATUS      CHAR(1),              
           @@FILE_EXIST       INT,              
           @@CLTCODE_EXIST    INT,              
           @@MICRNO           VARCHAR(20)              
                                          
  SET NOCOUNT ON              
                
  SELECT @@CLTCODE_EXIST = COUNT(1)              
  FROM   ACMAST WITH(NOLOCK)               
  WHERE  CLTCODE = @BANKCODE              
         AND ACCAT = 2              
                                   
  IF @@CLTCODE_EXIST = 0              
    BEGIN              
      SELECT 'BANK CODE DOSE NOT EXIST.'              
                    
      RETURN              
    END              
          
                 
  SELECT @@MICRNO = ISNULL(MICRNO,0)              
  FROM   ACMAST WITH(NOLOCK)               
  WHERE  CLTCODE = @BANKCODE              
         AND ACCAT = 2              
                                   
  /*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/              
  DECLARE  @@ERROR_COUNT        SMALLINT,              
           @@EXIST_COUNT_BEFORE SMALLINT,              
           @@EXIST_COUNT_AFTER  SMALLINT              
                
  SELECT @@ERROR_COUNT = COUNT(1)              
  FROM   (SELECT U_FILENAME              
          FROM   V2_UPLOADED_FILES WITH(NOLOCK)               
          WHERE  U_FILENAME = @FILENAME              
                 AND U_MODULE = 'HDFC_RECO UPLOAD') A              
                
  SELECT @@CROSSREFERENCENO = ISNULL(MAX(CONVERT(NUMERIC,CROSSREFERENCENO)),0)              
  FROM   BANKRECO WITH(NOLOCK)               
                       
  CREATE TABLE #HDFCRECO (              
    BOOKDATE VARCHAR(11))              
                
  CREATE TABLE #ICICIRECO (              
    SR_NO    INT,              
    TXN_ID   VARCHAR(25),              
    BOOKDATE VARCHAR(11))              
                
  IF @BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'CSV'           
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD REFERENCE_NO VARCHAR(30),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFNO VARCHAR(100)"              
  END              
  ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR (@BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'               
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " LEDGER_BALANCE VARCHAR(20),"                
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(30),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30)"              
  END              
  ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'              
 BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD VALUEDATE VARCHAR(11), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(1),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(30),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " TRANSACTION_BRANCH VARCHAR(30),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"              
  END  
  ELSE IF @BANK_TYPE = 'INDUSIND' AND @STAT_TYPE = 'CSV'              
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD REFERENCE_NO VARCHAR(30), "
   SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " [DESCRIPTION] VARCHAR(100)," 
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"     
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"              
  END              
  ELSE IF @BANK_TYPE = 'ICICIRECO'               
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO ADD [DESCRIPTION] VARCHAR(100), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(30),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"              
               
  END              
                
  EXEC (@@SQL_QUERY)                 
                
  IF @BANK_TYPE = 'ICICIRECO'               
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #ICICIRECO ADD [DESCRIPTION] VARCHAR(100), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(30),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR CHAR(2),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " RUNNING_BAL VARCHAR(20)"              
                
   EXEC (@@SQL_QUERY)              
  END              
                
  CREATE TABLE [#BANKRECOSAVE_TEMP]                    
   (                    
    CLTCODE VARCHAR(10),                    
    BOOKDATE DATETIME,                    
    [DESCRIPTION] VARCHAR(100),                    
    AMOUNT VARCHAR(20),                    
    DRCR VARCHAR(1),                    
    VALUEDATE DATETIME,                    
    REFERENCENO VARCHAR(30),                    
    STATUSID VARCHAR(15),                    
    STATUSNAME VARCHAR(25),                    
    LOGINNAME VARCHAR(25),                    
    STATUS VARCHAR(9),                    
    MICRNO INT,                    
    DUMMY1 VARCHAR(15) ,                    
    DUMMY2 VARCHAR(15),                    
    AMOUNTLEDGR1 VARCHAR(20),                    
    CROSSREFERENCENO [INT] IDENTITY (1, 1) NOT NULL                    
   )                    
  ON [PRIMARY]                    
                      
  CREATE TABLE [#BANKRECOSAVE]                    
   (                    
    CLTCODE VARCHAR(10),                    
    BOOKDATE DATETIME,                    
    [DESCRIPTION] VARCHAR(100),                    
    AMOUNT MONEY,                    
    DRCR VARCHAR(1),                    
    VALUEDATE DATETIME,                    
    REFERENCENO VARCHAR(30), 
    STATUSID VARCHAR(15),                    
    STATUSNAME VARCHAR(25),                    
    LOGINNAME VARCHAR(25),                    
    CROSSREFERENCENO [INT],                    
    STATUS VARCHAR(9),                    
    MICRNO INT,                    
    DUMMY1 VARCHAR(15) ,                    
    DUMMY2 VARCHAR(15),                    
    AMOUNTLEDGR1 MONEY,               
    L1_SNO INT,               
    VTYP SMALLINT,               
    BOOKTYPE CHAR(2),               
    VNO VARCHAR(12),               
    SLIPNO INT               
   )                    
  ON [PRIMARY]                   
                
  CREATE TABLE #TESTIMPORT                              
  (                  
   OneRow Varchar(2000),                            
   SNO INT IDENTITY(1,1)                            
  )      
  
                
  IF @BANK_TYPE = 'ICICIRECO'              
  BEGIN              
   SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#ICICIRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"              
                 
  END              
  ELSE IF @BANK_TYPE <> 'CANARARECO'              
  BEGIN              
   SELECT @@SQL_QUERY = "EXEC BULKCOPYRECO_ALLBANK '" + @FILENAME + "',  '#HDFCRECO','" + @BANK_TYPE + "','" + @STAT_TYPE + "','" + @LOGIN + "','" + @PWD + "'"              
  END          
                
  --PRINT @@SQL_QUERY              
  EXEC (@@SQL_QUERY)   
  
  IF @BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'CSV'             
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"              
  END              
  ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'TAB') OR (@BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'TAB') OR @BANK_TYPE = 'UTIRECO'               
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "              
  END              
  ELSE IF @BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV'              
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD CREDIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20)"              
  END   
  ELSE IF @BANK_TYPE = 'INDUSIND' AND @STAT_TYPE = 'CSV' 
  BEGIN
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD AMOUNT VARCHAR(20), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1) "             
  END
  ELSE IF @BANK_TYPE = 'ICICIRECO'              
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD VALUEDATE VARCHAR(11), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20) "              
  END              
  ELSE              
  BEGIN              
   SELECT @@SQL_QUERY = "ALTER TABLE #HDFCRECO "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " ADD [DESCRIPTION] VARCHAR(100), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " VALUEDATE VARCHAR(11), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " CREDIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DEBIT VARCHAR(20),"              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " AMOUNT VARCHAR(20), "              
   SELECT @@SQL_QUERY = @@SQL_QUERY + " DRCR VARCHAR(1), "           
   SELECT @@SQL_QUERY = @@SQL_QUERY + " REFERENCE_NO VARCHAR(30) "              
  END              
                
                
  EXEC (@@SQL_QUERY)              
                
  SELECT * INTO   HDFCRECO  FROM   #HDFCRECO              

            
  IF @BANK_TYPE = 'CITYRECO' AND @STAT_TYPE = 'CSV'            
    BEGIN              
      UPDATE HDFCRECO              
      SET    [DESCRIPTION] = 'CITY BANK RECONCILIATION FILE',              
             VALUEDATE = BOOKDATE              
    END              
  ELSE              
    IF (@BANK_TYPE = 'HDFCRECO'              
        AND @STAT_TYPE = 'TAB')              
        OR @BANK_TYPE = 'UTIRECO'              
      BEGIN              
        UPDATE HDFCRECO              
        SET    AMOUNT = CASE               
                          WHEN (DEBIT IS NULL               
                                 OR CONVERT(MONEY,DEBIT) = 0) THEN CREDIT              
                          ELSE DEBIT              
                        END,              
               DRCR = CASE               
                        WHEN (DEBIT IS NULL               
                               OR CONVERT(MONEY,DEBIT) = 0) THEN 'C'              
                        ELSE 'D'              
                      END              
      END  
      ELSE IF @BANK_TYPE = 'INDUSIND'
      BEGIN
      UPDATE HDFCRECO              
        SET    AMOUNT = CASE               
                          WHEN (DEBIT IS NULL               
                                 OR CONVERT(MONEY,DEBIT) = 0) THEN CREDIT              
                          ELSE DEBIT              
                        END,              
               DRCR = CASE               
                        WHEN (DEBIT IS NULL               
                               OR CONVERT(MONEY,DEBIT) = 0) THEN 'C'              
                        ELSE 'D'              
                      END              
      END                   
    ELSE              
      IF @BANK_TYPE = 'ICICIRECO'              
 BEGIN              
          UPDATE HDFCRECO              
          SET    VALUEDATE = BOOKDATE,              
                 DRCR = (CASE               
                           WHEN DRCR = 'DR' THEN 'D'              
                           ELSE 'C'              
                         END)              
        END     
        
        
      
                
  IF @BANK_TYPE = 'CANARARECO'              
    BEGIN              
   SELECT @@SQL_QUERY = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"              
     EXEC(@@SQL_QUERY)                              
                
      DELETE FROM #TESTIMPORT              
      WHERE       ONEROW IS NULL              
                                
      DELETE FROM #TESTIMPORT              
      WHERE       ONEROW LIKE '****%'              
                                            
      INSERT INTO #BANKRECOSAVE_TEMP              
      SELECT @BANKCODE,              
             BOOKDATE = CONVERT(DATETIME,SUBSTRING(SUBSTRING(ONEROW,1,8),7,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),5,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),1,4),              
                                103),              
             [DESCRIPTION] = SUBSTRING(ONEROW,18,23),              
             AMOUNT = SUBSTRING(ONEROW,41,14),              
             DRCR = SUBSTRING(ONEROW,17,1),              
             VALUEDATE = CONVERT(DATETIME,SUBSTRING(SUBSTRING(ONEROW,1,8),7,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),5,2) + '/' + SUBSTRING(SUBSTRING(ONEROW,1,8),1,4),              
                                 103),              
             REFERENCE_NO = SUBSTRING(ONEROW,9,8),              
             @STATUSID,              
             @STATUSNAME,              
             @UNAME,              
    'UNMATCHED',              
             @@MICRNO,              
             '',              
             '',              
             ''                           
      FROM   #TESTIMPORT              
                           
    END              
  ELSE              
    IF @BANK_TYPE = 'ICICIRECO'              
      BEGIN              
        INSERT INTO #BANKRECOSAVE_TEMP              
        SELECT @BANKCODE,              
               BOOKDATE = CONVERT(DATETIME,(LEFT(BOOKDATE,2) + '/' + SUBSTRING(BOOKDATE,4,2) + '/' + RIGHT(BOOKDATE,4)),              
                              101),              
               [DESCRIPTION],              
               AMOUNT,              
               DRCR,              
               VALUEDATE = CONVERT(DATETIME,RIGHT(VALUEDATE,4) + '-' + LEFT(VALUEDATE,2) + '-' + SUBSTRING(VALUEDATE,4,2)),              
               REFERENCE_NO,              
               @STATUSID,              
               @STATUSNAME,              
               @UNAME,              
               'UNMATCHED',              
               @@MICRNO,              
               '',              
               '',              
               ''              
        FROM   HDFCRECO              
                             
      END  
     ELSE
		IF @BANK_TYPE = 'INDUSIND'    
		BEGIN
			INSERT INTO #BANKRECOSAVE_TEMP              
			   SELECT @BANKCODE,    
               BOOKDATE = CONVERT(DATETIME,BOOKDATE, 104),              
               LEFT(.dbo.piece([DESCRIPTION], '/', 2), 100),              
               AMOUNT,              
               DRCR,              
               VALUEDATE = CONVERT(DATETIME,VALUEDATE, 104),              
               REFERENCE_NO,              
               @STATUSID,              
               @STATUSNAME,              
               @UNAME,              
               'UNMATCHED',              
               @@MICRNO,              
               '',              
               '',              
               ''              
        FROM   HDFCRECO  
		END            
    ELSE              
      BEGIN              
        INSERT INTO #BANKRECOSAVE_TEMP              
        SELECT @BANKCODE,    
               BOOKDATE = CONVERT(DATETIME,(LEFT(BOOKDATE,2) + '/' + SUBSTRING(BOOKDATE,4,2) + '/' + RIGHT(BOOKDATE,4)),              
                   103),              
               [DESCRIPTION],              
               AMOUNT,              
               DRCR,              
               VALUEDATE = CONVERT(DATETIME,RIGHT(VALUEDATE,4) + '-' + SUBSTRING(VALUEDATE,4,2) + '-' + LEFT(VALUEDATE,2)),              
               REFERENCE_NO,              
               @STATUSID,              
               @STATUSNAME,              
               @UNAME,              
               'UNMATCHED',              
               @@MICRNO,              
               '',              
               '',              
               ''              
        FROM   HDFCRECO              
      END              
                    
  DROP TABLE HDFCRECO              
  
  INSERT INTO #BANKRECOSAVE              
SELECT @BANKCODE,              
 BOOKDATE,              
 [DESCRIPTION],              
 AMOUNT = CASE               
            WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT))              
            ELSE CONVERT(MONEY,AMOUNT)              
          END,              
 DRCR,              
 VALUEDATE,              
 REFERENCENO = CONVERT(VARCHAR,CONVERT(BIGINT,REFERENCENO)),              
 @STATUSID,              
 @STATUSNAME,             
 @UNAME,              
 CROSSREFERENCNEO = CONVERT(INT,@@CROSSREFERENCENO + CROSSREFERENCENO),              
 'UNMATCHED',              
 @@MICRNO,              
 '',              
 '',              
 0,               
 0,               
 0,               
 '',               
 '',               
 0               
  FROM   #BANKRECOSAVE_TEMP              
  WHERE  REFERENCENO NOT LIKE '%[A-Z]%'              
                                            
  INSERT INTO #BANKRECOSAVE              
  SELECT @BANKCODE,              
         BOOKDATE,              
         [DESCRIPTION],              
         AMOUNT = CASE               
                    WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT))              
                    ELSE CONVERT(MONEY,AMOUNT)              
                  END,              
         DRCR,              
         VALUEDATE,              
         REFERENCENO,              
         @STATUSID,              
         @STATUSNAME,              
         @UNAME,              
         CROSSREFERENCNEO = CONVERT(INT,@@CROSSREFERENCENO + CROSSREFERENCENO),              
         'UNMATCHED',              
         @@MICRNO,              
         '',              
         '',              
         0,               
         0,               
         0,               
         '',               
         '',               
         0               
  FROM   #BANKRECOSAVE_TEMP              
  WHERE  REFERENCENO LIKE '%[A-Z]%'              
                                        
  INSERT INTO #BANKRECOSAVE              
  SELECT @BANKCODE,              
         BOOKDATE,              
         [DESCRIPTION],              
         AMOUNT = CASE               
                    WHEN DRCR = 'D' THEN ABS(CONVERT(MONEY,AMOUNT))              
                    ELSE CONVERT(MONEY,AMOUNT)              
                  END,              
         DRCR,              
         VALUEDATE,              
         REFERENCENO = '0',              
         @STATUSID,              
         @STATUSNAME,              
         @UNAME,              
         CROSSREFERENCNEO = CONVERT(INT,@@CROSSREFERENCENO + CROSSREFERENCENO),              
         'UNMATCHED',              
         @@MICRNO,              
         '',              
         '',              
         0,               
         0,               
         0,               
         '',               
         '',               
         0               
FROM   #BANKRECOSAVE_TEMP              
  WHERE  REFERENCENO IS NULL              
                       
  IF @BANK_TYPE = 'CANARARECO'              
    BEGIN              
      UPDATE #BANKRECOSAVE              
      SET    AMOUNT = CONVERT(MONEY,AMOUNT / 100)              
    END              
                  
  /*CREATE TABLE #BANKRECOSAVE_DELETE                    
  (                    
   [DESCRIPTION] VARCHAR(250),                    
   AMOUNT MONEY,                    
   DRCR CHAR(1),                    
   REFERENCENO VARCHAR(25),                    
  CROSSREFERENCENO INT                    
  ) */              
  DECLARE  @@AMOUNTDIFF   MONEY,              
           @@STAMOUNTDIFF MONEY,              
           @@BOOKDATE_MIN DATETIME,              
           @@BOOKDATE_MAX DATETIME              
       
  SELECT @@BOOKDATE_MIN = MIN(BOOKDATE)              
  FROM   #BANKRECOSAVE              
                       
  SELECT @@BOOKDATE_MAX = MAX(BOOKDATE)              
  FROM   #BANKRECOSAVE              
                       
  CREATE TABLE #RECODUPS (              
    BOOKDATE         VARCHAR(11),              
    REFERENCENO      VARCHAR(25),              
    AMOUNT           MONEY,              
    DESCRIPTION      VARCHAR(200),              
    STATUS           VARCHAR(10),              
    CROSSREFERENCENO INT)              
                
  SET @@EXIST_COUNT_BEFORE = 0              
                                           
  SET @@EXIST_COUNT_AFTER = 0              
                                          
  DECLARE  @CLTCODE VARCHAR(10),              
           @BOOKDATE    DATETIME,              
           @AMOUNT      MONEY,              
           @DRCR        CHAR(1),              
           @VALUEDATE   DATETIME,              
           @REFERENCENO VARCHAR(20),              
           @DESCRIPTION VARCHAR(200)              
                                      
  DECLARE CUR_CHECCK CURSOR  FOR              
  SELECT CLTCODE,              
         BOOKDATE,              
         AMOUNT,              
         DRCR,              
         VALUEDATE,              
         REFERENCENO,              
         [DESCRIPTION]              
  FROM   #BANKRECOSAVE              
  WHERE  AMOUNT < 0              
                                
  OPEN CUR_CHECCK              
                
  FETCH NEXT FROM CUR_CHECCK              
  INTO @CLTCODE,              
       @BOOKDATE,              
       @AMOUNT,              
       @DRCR,              
       @VALUEDATE,              
       @REFERENCENO,              
       @DESCRIPTION              
                     
  WHILE @@FETCH_STATUS = 0              
    BEGIN              
      /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */              
      IF @PROCESS_STATUS = 0              
        BEGIN              
          SELECT @@ERROR_COUNT = 0              
                                               
          SELECT @@EXIST_COUNT_BEFORE = COUNT(1)              
          FROM   BANKRECO WITH(NOLOCK)              
          WHERE  CLTCODE = @CLTCODE              
                 AND BOOKDATE = @BOOKDATE              
                 AND AMOUNT = ABS(@AMOUNT)              
                 AND DRCR = @DRCR              
                 AND VALUEDATE = @VALUEDATE              
                 AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')              
        END              
                      
      /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */              
      SELECT @@CROSSREFERENCENO = MIN(CROSSREFERENCENO)              
      FROM   #BANKRECOSAVE              
      WHERE  [DESCRIPTION] = @DESCRIPTION              
             AND AMOUNT = ABS(@AMOUNT)              
             AND DRCR = @DRCR              
             AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')              
             AND AMOUNT > 0              
                                        
      DELETE BR              
      FROM   #BANKRECOSAVE BR              
      WHERE  BR.CROSSREFERENCENO = @@CROSSREFERENCENO              
                                                 
      IF @PROCESS_STATUS = 0              
        BEGIN              
          SELECT @@EXIST_COUNT_AFTER = COUNT(1)              
          FROM   #BANKRECOSAVE              
          WHERE  [DESCRIPTION] = @DESCRIPTION              
                 AND AMOUNT = ABS(@AMOUNT)              
                 AND DRCR = @DRCR              
                 AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')              
                 AND AMOUNT > 0              
                                            
          IF @@EXIST_COUNT_BEFORE <> @@EXIST_COUNT_AFTER              
            BEGIN              
              INSERT INTO #RECODUPS              
  SELECT BOOKDATE = CONVERT(VARCHAR(11),BR.BOOKDATE,103),              
                     BR.REFERENCENO,            
                     BR.AMOUNT,              
                     BR.[DESCRIPTION],              
                     BR.STATUS,              
                     BR.CROSSREFERENCENO              
              FROM   (SELECT *              
                      FROM   BANKRECO WITH(NOLOCK)              
                      WHERE  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX + ' 23:59'              
                             AND CLTCODE = @BANKCODE) BR              
              WHERE  CLTCODE = @CLTCODE              
                     AND BOOKDATE = @BOOKDATE              
                     AND AMOUNT = ABS(@AMOUNT)              
                     AND DRCR = @DRCR              
                     AND VALUEDATE = @VALUEDATE              
                     AND ISNULL(REFERENCENO,'0') = ISNULL(@REFERENCENO,'0')              
            END              
                          
          SET @@EXIST_COUNT_BEFORE = 0              
                                                   
          SET @@EXIST_COUNT_AFTER = 0              
        END              
                      
      FETCH NEXT FROM CUR_CHECCK              
      INTO @CLTCODE,              
           @BOOKDATE,              
           @AMOUNT,              
           @DRCR,              
           @VALUEDATE,              
           @REFERENCENO,              
           @DESCRIPTION              
    END              
                  
  DELETE FROM #BANKRECOSAVE              
  WHERE       AMOUNT < 0              
                                     
  SELECT @@ERROR_COUNT = COUNT(1)              
  FROM   #RECODUPS              
                       
  IF @@ERROR_COUNT > 0              
    BEGIN              
      SELECT *              
      FROM   #RECODUPS              
                           
      RETURN              
    END              
                  
  /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */              
  DELETE BR              
  FROM   BANKRECO B WITH(ROWLOCK),              
         #BANKRECOSAVE BR              
  WHERE  LTRIM(RTRIM(B.CLTCODE)) = LTRIM(RTRIM(BR.CLTCODE))              
         AND CONVERT(VARCHAR(11),B.BOOKDATE,109) = CONVERT(VARCHAR(11),BR.BOOKDATE,109)              
         AND LEFT(LTRIM(RTRIM(B.[DESCRIPTION])), 50) = LEFT(LTRIM(RTRIM(BR.[DESCRIPTION])), 50)              
         AND B.AMOUNT = BR.AMOUNT              
         AND LTRIM(RTRIM(B.DRCR)) = LTRIM(RTRIM(BR.DRCR))              
         AND CONVERT(VARCHAR(11),B.VALUEDATE,109) = CONVERT(VARCHAR(11),BR.VALUEDATE,109)              
         AND ISNULL(LTRIM(RTRIM(B.REFERENCENO)),'') = ISNULL(LTRIM(RTRIM(BR.REFERENCENO)),'')              
                                                                    
  SELECT @@ERROR_COUNT = COUNT(1)              
  FROM   #BANKRECOSAVE              
  WHERE  VALUEDATE IS NOT NULL              
                       
  IF @@ERROR_COUNT = 0              
    BEGIN              
      SELECT 'THE FILE YOU ARE TRYING TO UPLOAD IS ALREADY UPLOADED. PLEASE CHECK THE BANK RECONCILATION REPORT.'              
                  
      RETURN              
    END              
                  
  SELECT @@AMOUNTDIFF = ABS(BR.AMOUNT - BR1.AMOUNT)              
  FROM   (SELECT AMOUNT              
          FROM   #BANKRECOSAVE              
          WHERE  [DESCRIPTION] = 'OPENING BALANCE') BR,          
        (SELECT AMOUNT              
          FROM   #BANKRECOSAVE              
          WHERE  [DESCRIPTION] = 'CLOSING BALANCE') BR1              
                       
  IF @PROCESS_STATUS = 1              
    BEGIN              
      SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))              
      FROM   (SELECT AMOUNT = (CASE DRCR               
                                    WHEN 'D' THEN SUM(AMOUNT)              
                                    ELSE -SUM(AMOUNT)              
   END)              
              FROM   BANKRECO B WITH (NOLOCK)              
              WHERE  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX              
                     AND CLTCODE = @BANKCODE              
                     AND NOT EXISTS (SELECT CROSSNO              
                                                  FROM   RECODUPS1 R WHERE R.CROSSNO = B.CROSSREFERENCENO)              
              GROUP BY DRCR               
              UNION ALL              
              SELECT AMOUNT = (CASE DRCR               
                                    WHEN 'D' THEN SUM(AMOUNT)              
                                    ELSE -SUM(AMOUNT)              
                                  END)              
              FROM   #BANKRECOSAVE              
              WHERE  VALUEDATE IS NOT NULL              
              GROUP BY DRCR) B              
 END              
  ELSE              
    BEGIN              
      SELECT @@STAMOUNTDIFF = ABS(SUM(AMOUNT))              
      FROM   (SELECT AMOUNT = (CASE DRCR               
                                    WHEN 'D' THEN SUM(AMOUNT)              
                                    ELSE -SUM(AMOUNT)              
                                  END)              
              FROM   BANKRECO B WITH (NOLOCK)              
              WHERE  BOOKDATE BETWEEN @@BOOKDATE_MIN AND @@BOOKDATE_MAX              
                     AND CLTCODE = @BANKCODE              
              GROUP BY DRCR               
              UNION ALL              
              SELECT AMOUNT = (CASE DRCR               
                                    WHEN 'D' THEN SUM(AMOUNT)              
                                    ELSE -SUM(AMOUNT)              
                                  END)              
              FROM   #BANKRECOSAVE              
              WHERE  VALUEDATE IS NOT NULL              
              GROUP BY DRCR) B              
    END              
                  
  IF @@AMOUNTDIFF <> @@STAMOUNTDIFF              
    BEGIN              
      SELECT 'THERE IS SOME AMOUNT DIFFERENCE IN THE STATEMENT WHICH YOU ARE TRYING TO UOLOAD. PLEASE CHECK.'              
                           
      RETURN              
    END              
                  
  DELETE FROM #BANKRECOSAVE              
  WHERE       VALUEDATE IS NULL              
                            
  /* NEW LOGIC TO UPLOAD THE SAME BOOKDATED BANK STATEMENT MULTIPLE TIMES */              
  SET @@TABLE_EXIST = ''              
                                  
  SELECT @@TABLE_EXIST = NAME              
  FROM   SYSOBJECTS              
  WHERE  NAME = 'RECOPROCESS'              
                              
  IF @@TABLE_EXIST = ''              
    BEGIN              
  CREATE TABLE RECOPROCESS (              
        INPROCESS VARCHAR(1))              
                    
      INSERT INTO RECOPROCESS              
                 (INPROCESS)              
      VALUES     ('N')              
    END              
                  
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED              
                
    SELECT @@RECORD_COUNT = COUNT(* )              
  FROM   RECOPROCESS              
                       
  IF @@RECORD_COUNT = 0              
    BEGIN              
      INSERT INTO RECOPROCESS              
                 (INPROCESS)              
      VALUES     ('N')              
    END              
                  
  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED              
                
  SELECT TOP 1 @@RECO_STATUS = INPROCESS              
  FROM   RECOPROCESS WITH (NOLOCK)              
                       
  IF @@RECO_STATUS = 'N'              
    BEGIN              
      BEGIN TRAN              
                    
      UPDATE RECOPROCESS              
      SET    INPROCESS = 'Y'              
    END              
  ELSE              
    BEGIN              
      SELECT 'BANK RECO UPLOAD PROCESS IS ALREADY RUNNING FROM SOME OTHER TERMINAL. PLEASE TRY AGAIN LATER.'         
                           
      RETURN              
    END              
                  
  INSERT INTO V2_UPLOADED_FILES              
  SELECT @FILENAME,              
         @FILENAME,              
         COUNT(1),              
     'B',              
         GETDATE(),              
         @UNAME,              
         'HDFC_RECO UPLOAD'              
                       
  UPDATE #BANKRECOSAVE              
  SET    STATUS = 'MATCHED',               
         L1_SNO = LEDGER1.L1_SNO,               
         VTYP = LEDGER1.VTYP,               
         BOOKTYPE = LEDGER1.BOOKTYPE,               
         VNO = LEDGER1.VNO               
  FROM   LEDGER1 WITH (NOLOCK)              
  WHERE  (LEDGER1.VTYP = 2              
           OR LEDGER1.VTYP = 3              
           OR LEDGER1.VTYP = 5              
           OR LEDGER1.VTYP = 17              
           OR LEDGER1.VTYP = 19              
           OR LEDGER1.VTYP = 20)              
         AND UPPER(#BANKRECOSAVE.DRCR) = UPPER(LEDGER1.DRCR)              
         AND RTRIM(DDNO) = RTRIM(REFERENCENO)              
         AND CLTCODE = @BANKCODE              
         AND #BANKRECOSAVE.MICRNO = @@MICRNO            
         AND LEDGER1.RELDT = ''          
   AND #BANKRECOSAVE.AMOUNT = LEDGER1.RELAMT        
         AND #BANKRECOSAVE.AMOUNT = (SELECT SUM(RELAMT)              
                                     FROM   LEDGER1 L1 WITH(NOLOCK),              
                                            LEDGER L2 WITH(NOLOCK)              
                                     WHERE  L2.VNO = L1.VNO              
                                            AND L2.VTYP = L1.VTYP              
                                            AND L2.BOOKTYPE = L1.BOOKTYPE              
                                            AND RELDT = ''              
                                            AND CLTCODE = @BANKCODE              
                                            AND #BANKRECOSAVE.REFERENCENO = DDNO              
                                            AND #BANKRECOSAVE.DRCR = L1.DRCR              
                                            AND CONVERT(DATETIME, CONVERT(VARCHAR(11),#BANKRECOSAVE.VALUEDATE,101)) >= CONVERT(DATETIME, CONVERT(VARCHAR(11),VDT,101)))              
         AND #BANKRECOSAVE.MICRNO = ISNULL(LEDGER1.MICRNO,0)              
         AND REFERENCENO <> '0'              
            
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 1'          
           
      ROLLBACK TRAN              
                    
      RETURN              
    END              
                  
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 1'              
                           
      ROLLBACK TRAN              
             
      RETURN              
    END              
              
  UPDATE LEDGER1 WITH (ROWLOCK)              
  SET    RELDT = VALUEDATE,              
         REFNO = #BANKRECOSAVE.CROSSREFERENCENO              
  FROM   #BANKRECOSAVE                
  WHERE  #BANKRECOSAVE.L1_SNO <> 0               
         AND LEDGER1.L1_SNO = #BANKRECOSAVE.L1_SNO               
              
                                                                  
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 1'              
                           
      ROLLBACK TRAN              
                    
      RETURN              
    END              
                  
  UPDATE #BANKRECOSAVE              
  SET    AMOUNTLEDGR1 = BANKRECOCOMP.AMOUNT,              
         STATUS = 'MATCHED',               
         SLIPNO = BANKRECOCOMP.SLIPNO               
  FROM   (SELECT   SUM(RELAMT)   AS AMOUNT,              
                   SLIPNO        AS SLIPNO,              
                   UPPER(DRCR)   AS DRCR,              
 MICRNO              
          FROM     LEDGER1 WITH(NOLOCK)              
          WHERE    MICRNO = @@MICRNO              
                   AND (VTYP = 2              
                         OR VTYP = 19              
                         OR VTYP = 5)              
                   AND SLIPNO <> ''              
                   AND RELDT = ''               
          GROUP BY SLIPNO,DRCR,MICRNO) BANKRECOCOMP              
  WHERE  UPPER(#BANKRECOSAVE.DRCR) = UPPER(BANKRECOCOMP.DRCR)              
         AND RTRIM(BANKRECOCOMP.SLIPNO) = RTRIM(REFERENCENO)              
         AND #BANKRECOSAVE.MICRNO = @@MICRNO              
         AND #BANKRECOSAVE.AMOUNT = BANKRECOCOMP.AMOUNT              
   AND #BANKRECOSAVE.MICRNO = BANKRECOCOMP.MICRNO              
         AND REFERENCENO <> '0'              
                                          
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN BANKRECO UPDATES 2'              
                           
      ROLLBACK TRAN              
                    
      RETURN              
    END              
              
  SELECT L1.VTYP,               
         L1.BOOKTYPE,               
         L1.VNO,               
         L1.L1_SNO,               
         #BANKRECOSAVE.VALUEDATE,               
         #BANKRECOSAVE.CROSSREFERENCENO               
  INTO   #LEDGER_UPDATES_FOR_SLIPS               
  FROM   #BANKRECOSAVE,               
         LEDGER1 L1 WITH(NOLOCK)           
  WHERE  L1.MICRNO = @@MICRNO                 
         AND L1.SLIPNO = #BANKRECOSAVE.SLIPNO               
         AND #BANKRECOSAVE.SLIPNO <> 0               
              
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES 2'              
                           
      ROLLBACK TRAN              
                    
      RETURN              
    END              
                  
  UPDATE LEDGER1 WITH (ROWLOCK)              
  SET    RELDT = VALUEDATE,              
         REFNO = #LEDGER_UPDATES_FOR_SLIPS.CROSSREFERENCENO              
  FROM   #LEDGER_UPDATES_FOR_SLIPS              
  WHERE  #LEDGER_UPDATES_FOR_SLIPS.L1_SNO <> 0               
         AND LEDGER1.L1_SNO = #LEDGER_UPDATES_FOR_SLIPS.L1_SNO               
                                           
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN LEDGER1 UPDATES 2'              
                           
      ROLLBACK TRAN              
                    
      RETURN              
    END              
                  
  UPDATE L              
  SET    EDT = (CASE               
                  WHEN CONVERT(DATETIME,(CONVERT(VARCHAR(11),VALUEDATE,109))) < CONVERT(DATETIME,(CONVERT(VARCHAR(11),VDT,109))) THEN VDT              
                  ELSE VALUEDATE              
                END)              
  FROM   LEDGER L WITH (ROWLOCK),              
         (SELECT VTYP,              
                 BOOKTYPE,              
                 VNO,              
                 VALUEDATE              
          FROM   #BANKRECOSAVE              
          WHERE  VNO <> ''              
          UNION               
          SELECT VTYP,              
                 BOOKTYPE,              
                 VNO,              
                 VALUEDATE              
          FROM   #LEDGER_UPDATES_FOR_SLIPS              
          WHERE  VNO <> '') LU              
  WHERE  LU.VNO = L.VNO              
         AND LU.VTYP = L.VTYP              
         AND LU.BOOKTYPE = L.BOOKTYPE              
         AND EDT LIKE 'DEC 31 2049%'              
                                    
  IF @@ERROR <> 0              
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT'              
                           
      ROLLBACK TRAN              
                    
      RETURN              
    END              
                  
  IF @@ERROR <> 0  
    BEGIN              
      SELECT 'THERE IS SOME PROBLEM IN LEDGER UPDATES EDT 2'              
                           
      ROLLBACK TRAN              
                    
      RETURN              
    END              
                  
  IF @PROCESS_STATUS = 1              
    BEGIN              
      DELETE FROM BANKRECO WITH (ROWLOCK)              
      WHERE       CLTCODE = @BANKCODE              
                  AND CROSSREFERENCENO IN (SELECT CROSSNO              
                                           FROM   RECODUPS1)              
    END              
                  
  INSERT INTO BANKRECO              
             (CLTCODE,              
              BOOKDATE,              
              DESCRIPTION,              
              AMOUNT,              
              DRCR,              
              VALUEDATE,              
              REFERENCENO,              
              STATUSID,              
              STATUSNAME,              
              LOGINNAME,              
              CROSSREFERENCENO,              
              STATUS,              
              MICRNO,              
              DUMMY1,              
              DUMMY2)              
  SELECT B.CLTCODE,              
         B.BOOKDATE,              
         LEFT(B.DESCRIPTION, 50),                  
         B.AMOUNT,              
         B.DRCR,              
         B.VALUEDATE,              
         B.REFERENCENO,              
         B.STATUSID,         
         B.STATUSNAME,           
         B.LOGINNAME,              
         B.CROSSREFERENCENO,              
         B.STATUS,              
         @@MICRNO,              
         '0',              
         '0'              
  FROM   #BANKRECOSAVE B              
                       
 INSERT INTO BANKRECO_LOG              
  SELECT B.CLTCODE,              
         B.BOOKDATE,              
         LEFT(B.DESCRIPTION, 50),       
         B.AMOUNT,              
         B.DRCR,              
         B.VALUEDATE,              
         B.REFERENCENO,              
         B.STATUSID,              
         B.STATUSNAME,              
         B.LOGINNAME,              
         B.CROSSREFERENCENO,              
         B.STATUS,              
         @@MICRNO,             
         '0',              
         '0',              
         0,
         0,              
         'AUTO',              
         GETDATE(),              
         'MATCHED'              
  FROM   #BANKRECOSAVE B              
  WHERE  B.STATUS = 'MATCHED'              
                                  
  INSERT INTO LEDGER1_BANKRECO_LOG              
  SELECT L1.*,              
         'AUTO',              
         GETDATE(),              
         'MATCHED'              
  FROM   LEDGER1 L1 WITH (NOLOCK),              
         (SELECT VTYP,              
                 BOOKTYPE,              
                 VNO              
          FROM   #BANKRECOSAVE              
          WHERE  VNO <> ''              
          UNION               
          SELECT VTYP,              
                 BOOKTYPE,              
                 VNO              
          FROM   #LEDGER_UPDATES_FOR_SLIPS              
          WHERE  VNO <> '') LU              
  WHERE  L1.VNO = LU.VNO              
         AND L1.VTYP = LU.VTYP              
         AND L1.BOOKTYPE = LU.BOOKTYPE              
                                         
  UPDATE RECOPROCESS              
  SET    INPROCESS = 'N'
  
  DECLARE
	@STAT1_TYPE CHAR(1),
	@STAT1_DATE VARCHAR(11)
  
  IF @BANKCODE = '300002'
	SET @STAT1_TYPE = 'H'
  ELSE IF @BANKCODE = '300006'
	SET @STAT1_TYPE = 'I'
	
	SELECT @STAT1_DATE = CONVERT(VARCHAR(11), MAX(BOOKDATE), 109) FROM #BANKRECOSAVE
  
  EXEC UPDATE_POA_RECO @STAT1_DATE, @BANKCODE, @STAT1_TYPE              
 
  COMMIT TRAN              
                
  SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BAK_RPT_ACC_PARTYLEDGER
-- --------------------------------------------------


CREATE PROCEDURE BAK_RPT_ACC_PARTYLEDGER      
(
	@FDATE VARCHAR(11),            /* AS MMM DD YYYY */      
	@TDATE VARCHAR(11),            /* AS MMM DD YYYY */      
	@FCODE VARCHAR(10),      
	@TCODE VARCHAR(10),      
	@STRORDER VARCHAR(6),      
	@SELECTBY VARCHAR(3),      
	@STATUSID VARCHAR(15),      
	@STATUSNAME VARCHAR(15),      
	@STRBRANCH VARCHAR(10)      
)

AS      
      
/*========================================================================
      EXEC RPT_ACC_PARTYLEDGER_ALL 
            'NOV  1 2005',
            'DEC 31 2005',
            'A',
            'ZZZ',
            'ACCODE',
            'VDT',
            'BROKER',
            'UNDEFINED',
            ''
========================================================================*/

DECLARE 
	@@OPENDATE   AS VARCHAR(11)      
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
      
      
/*GETTING LAST OPENING DATE */      
      IF UPPER(@SELECTBY) = 'VDT'      
      BEGIN      
            SELECT 
                  @@OPENDATE = 
                  ( 
                        SELECT 
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(VDT), 0), 109), 11) 
                        FROM LEDGER WITH(NOLOCK) 
                        WHERE VTYP = 18 
                              AND VDT < = @FDATE 
                  ) 
      END      
      ELSE      
      BEGIN      
            SELECT 
                  @@OPENDATE = 
                  ( 
                        SELECT 
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11) 
                        FROM LEDGER WITH(NOLOCK) 
                        WHERE VTYP = 18 
                              AND EDT < = @FDATE 
                  ) 
      END      
            
      
      /*CREATING BLANK TABLE FOR OPENING BALANCE*/      
            SELECT 
                  CLTCODE, 
                  OPPBAL = VAMT 
            INTO #OPPBALANCE 
            FROM LEDGER WITH(NOLOCK) 
            WHERE 1 = 2 
            
      
      /*GETTING OPENING BALANCE*/      
      IF @SELECTBY = 'VDT'      
      BEGIN      
            IF @@OPENDATE = @FDATE       
            BEGIN      
                  INSERT 
                  INTO #OPPBALANCE 
                  SELECT 
                        CLTCODE, 
                        OPPBAL = ISNULL(SUM( 
                        CASE 
                              WHEN UPPER(B.DRCR) = 'D' 
                              THEN B.VAMT 
                              ELSE -B.VAMT 
                        END
                        ), 0) 
                  FROM LEDGER B WITH(NOLOCK) 
                  WHERE B.CLTCODE > = @FCODE 
                        AND B.CLTCODE < = @TCODE 
                        AND B.VDT LIKE @FDATE + '%' 
                        AND VTYP = 18 
                  GROUP BY CLTCODE 
            END      
            ELSE      
            BEGIN      
                  INSERT 
                  INTO #OPPBALANCE 
                  SELECT 
                        CLTCODE, 
                        OPPBAL = ISNULL(SUM( 
                        CASE 
                              WHEN UPPER(B.DRCR) = 'D' 
                              THEN B.VAMT 
                              ELSE -B.VAMT 
                        END
                        ), 0) 
                  FROM LEDGER B WITH(NOLOCK) 
                  WHERE B.CLTCODE > = @FCODE 
                        AND B.CLTCODE < = @TCODE 
                        AND B.VDT > = @@OPENDATE + ' 00:00:00' 
                        AND VDT < @FDATE 
                  GROUP BY CLTCODE 
            END      
      END       
      ELSE      
      BEGIN       
            IF @@OPENDATE = @FDATE       
            BEGIN    
                  INSERT 
                  INTO #OPPBALANCE 
                  SELECT 
                        CLTCODE, 
        OPBAL = SUM(OPBAL) 
                  FROM 
                        ( 
                              SELECT 
                                    CLTCODE, 
                                    OPBAL = ISNULL(SUM( 
                                    CASE 
                                          WHEN UPPER(DRCR) = 'D' 
                                          THEN VAMT 
                                          ELSE -VAMT 
                                    END
                                    ), 0) 
                              FROM LEDGER WITH(NOLOCK) 
                              WHERE CLTCODE = @FCODE 
                                    AND EDT LIKE @@OPENDATE + '%' 
                                    AND VTYP = 18 
                              GROUP BY CLTCODE 
                              UNION ALL 
                              SELECT 
                                    CLTCODE, 
                                    OPPBAL = ISNULL(SUM( 
                                    CASE 
                                          WHEN UPPER(B.DRCR) = 'C' 
                                          THEN B.VAMT 
                                          ELSE -B.VAMT 
                                    END
                                    ), 0) 
                              FROM LEDGER B WITH(NOLOCK) 
                              WHERE B.CLTCODE > = @FCODE 
                                    AND B.CLTCODE < = @TCODE 
                                    AND B.VDT < @@OPENDATE
                                    AND EDT >= @@OPENDATE 
                              GROUP BY CLTCODE 
                        ) 
                        T 
                  GROUP BY CLTCODE 
            END    
            ELSE    
            BEGIN    
                  INSERT 
                  INTO #OPPBALANCE 
                  SELECT 
                        CLTCODE, 
                        OPBAL = SUM(OPBAL) 
                  FROM 
                        ( 
                              SELECT 
                                    CLTCODE, 
                                    OPBAL = ISNULL(SUM( 
                                    CASE 
                                          WHEN UPPER(DRCR) = 'D' 
                                          THEN VAMT 
                                          ELSE -VAMT 
                                    END
                                    ), 0) 
                              FROM LEDGER WITH(NOLOCK) 
                              WHERE CLTCODE = @FCODE 
                                    AND EDT LIKE @@OPENDATE + '%' 
                                    AND VTYP = 18 
                              GROUP BY CLTCODE 
                              UNION ALL 
                              SELECT 
                                    CLTCODE, 
                                    OPBAL = SUM( 
                                    CASE 
                                          WHEN UPPER(DRCR) = 'D' 
                                          THEN VAMT 
                                          ELSE -VAMT 
                                    END
                                    ) 
                              FROM LEDGER WITH(NOLOCK) 
                              WHERE CLTCODE = @FCODE 
                                    AND EDT > = @@OPENDATE + ' 00:00:00' 
                                    AND EDT < @FDATE 
                                    AND VTYP <> 18 
                              GROUP BY CLTCODE 
                              UNION ALL 
                              SELECT 
                                    CLTCODE, 
                                    OPPBAL = ISNULL(SUM( 
                                    CASE 
                                          WHEN UPPER(B.DRCR) = 'C' 
                                          THEN B.VAMT 
      ELSE -B.VAMT 
                                    END
                                ), 0) 
                              FROM LEDGER B WITH(NOLOCK) 
                              WHERE B.CLTCODE > = @FCODE 
                                    AND B.CLTCODE < = @TCODE 
                                    AND B.VDT < @@OPENDATE 
                                    AND EDT >= @@OPENDATE 
                              GROUP BY CLTCODE 
                        ) 
                        T 
                  GROUP BY CLTCODE 
            END    
      END      
            
      
      /*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */      
            SELECT 
                  L.*, 
                  SHORTDESC = SPACE(35) 
            INTO #LEDGERDATA 
            FROM LEDGER L WITH(NOLOCK) 
            WHERE 1 = 2 
            
      
      
      /*GETTING FIILTERED LEDGER*/      
      IF @SELECTBY = 'VDT'      
      BEGIN      
            INSERT 
            INTO #LEDGERDATA 
            SELECT 
                  L.*, 
                  ISNULL(V.SHORTDESC, '') SHORTDESC 
            FROM LEDGER L WITH(NOLOCK), 
                  VMAST V WITH(NOLOCK) 
            WHERE VDT > = @FDATE + ' 00:00:00' 
                  AND L.VTYP = V.VTYPE 
                  AND VDT < = @TDATE +' 23:59:59' 
                  AND CLTCODE > = @FCODE 
                  AND CLTCODE < = @TCODE 
      END       
      ELSE      
      BEGIN      
            INSERT 
            INTO #LEDGERDATA 
            SELECT 
                  L.*, 
                  ISNULL(V.SHORTDESC, '') SHORTDESC 
            FROM LEDGER L WITH(NOLOCK), 
                  VMAST V WITH(NOLOCK) 
            WHERE EDT > = @FDATE + ' 00:00:00' 
                  AND L.VTYP = V.VTYPE 
                  AND EDT < = @TDATE +' 23:59:59' 
                  AND CLTCODE > = @FCODE 
                  AND CLTCODE < = @TCODE 
      END      
      


/*GETTING CLIENT LIST*/      
      SELECT 
            C2.PARTY_CODE, 
            BANK_NAME = ISNULL(C4.BANKID, ''), 
            L_ADDRESS1, 
            L_ADDRESS2, 
            L_ADDRESS3, 
            L_CITY, 
            L_ZIP, 
            RES_PHONE1, 
            C1.BRANCH_CD, 
            FAMILY, 
            C1.SUB_BROKER, 
            TRADER, 
            CL_TYPE, 
            CLTDPID = ISNULL(CLTDPID, '') 
      INTO #LEDGERCLIENTS 
      FROM MCDXCDS.DBO.CLIENT1 C1 WITH(NOLOCK), 
            MCDXCDS.DBO.CLIENT2 C2 WITH(NOLOCK) 
      LEFT OUTER JOIN 
            MCDXCDS.DBO.CLIENT4 C4 WITH(NOLOCK) 
            ON 
            (
                  C2.PARTY_CODE = C4.PARTY_CODE 
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL') 
                  AND DEFDP = 1
            ) 
      WHERE C1.CL_CODE = C2.CL_CODE 
            AND C1.BRANCH_CD LIKE (
            CASE 
                  WHEN @STATUSID = 'BRANCH' 
                  THEN @STATUSNAME 
                  ELSE '%' 
            END
            ) 
            AND SUB_BROKER LIKE (
            CASE 
                  WHEN @STATUSID = 'SUB_BROKER' 
                  THEN @STATUSNAME 
                  ELSE '%' 
            END
            ) 
            AND TRADER LIKE (
            CASE 
                  WHEN @STATUSID = 'TRADER' 
                  THEN @STATUSNAME 
                  ELSE '%' 
            END
            ) 
            AND C1.FAMILY LIKE (
            CASE 
                  WHEN @STATUSID = 'FAMILY' 
                  THEN @STATUSNAME 
                  ELSE '%' 
            END
            ) 
            AND C2.PARTY_CODE LIKE (
            CASE 
                  WHEN @STATUSID = 'CLIENT' 
                  THEN @STATUSNAME 
                  ELSE '%' 
            END
            ) 
            AND C1.BRANCH_CD LIKE @STRBRANCH +'%' 
            AND C2.PARTY_CODE > = @FCODE 
            AND C2.PARTY_CODE < = @TCODE 


      CREATE TABLE [#TMPLEDGER] (
      	[BOOKTYPE] [CHAR] (2)  NULL ,
      	[VOUDT] [DATETIME] NULL ,
      	[EFFDT] [DATETIME] NULL ,
      	[SHORTDESC] [VARCHAR] (35)  NULL ,
      	[DRAMT] [MONEY] NULL ,
      	[CRAMT] [MONEY] NULL ,
      	[VNO] [VARCHAR] (12)  NULL ,
      	[DDNO] [VARCHAR] (15)  NULL ,
      	[NARRATION] [VARCHAR] (234)  NULL ,
      	[CLTCODE] [VARCHAR] (10)  NOT NULL ,
      	[VTYP] [SMALLINT] NULL ,
      	[VDT] [VARCHAR] (30)  NULL ,
      	[EDT] [VARCHAR] (30)  NULL ,
      	[ACNAME] [VARCHAR] (100)  NULL ,
      	[OPBAL] [MONEY] NULL ,
      	[L_ADDRESS1] [VARCHAR] (40)  NOT NULL ,
      	[L_ADDRESS2] [VARCHAR] (40)  NULL ,
      	[L_ADDRESS3] [VARCHAR] (40)  NULL ,
      	[L_CITY] [VARCHAR] (40)  NULL ,
      	[L_ZIP] [VARCHAR] (10)  NULL ,
      	[RES_PHONE1] [VARCHAR] (15)  NULL ,
      	[BRANCH_CD] [VARCHAR] (10)  NOT NULL ,
      	[CROSAC] [VARCHAR] (10)  NULL ,
      	[EDIFF] [INT] NULL ,
      	[FAMILY] [VARCHAR] (10)  NOT NULL ,
      	[SUB_BROKER] [VARCHAR] (10)  NOT NULL ,
      	[TRADER] [VARCHAR] (20)  NOT NULL ,
      	[CL_TYPE] [VARCHAR] (3)  NOT NULL ,
      	[BANK_NAME] [VARCHAR] (16)  NOT NULL ,
      	[CLTDPID] [VARCHAR] (16)  NOT NULL ,
      	[LNO] [DECIMAL](4, 0) NULL 
      ) ON [PRIMARY]

      
/*GETTING LDDGER ENTRIES*/      
      INSERT 
            INTO #TMPLEDGER 
      SELECT 
            L.BOOKTYPE, 
            VOUDT = L.VDT, 
            EFFDT = L.EDT, 
            L.SHORTDESC, 
            DRAMT = (
            CASE 
                  WHEN UPPER(L.DRCR) = 'D' 
                  THEN L.VAMT 
                  ELSE 0 
            END
            ), 
            CRAMT = (
            CASE 
                  WHEN UPPER(L.DRCR) = 'C' 
                  THEN L.VAMT 
                  ELSE 0 
            END
            ), 
            L.VNO, 
            DDNO = SPACE(15), 
            L.NARRATION, 
            C.PARTY_CODE CLTCODE, 
            L.VTYP, 
            CONVERT(VARCHAR, L.VDT, 103) VDT, 
            CONVERT(VARCHAR, L.EDT, 103) EDT, 
            L.ACNAME , 
            OPBAL = VAMT, 
            C.L_ADDRESS1, 
            C.L_ADDRESS2, 
            C.L_ADDRESS3, 
            C.L_CITY, 
            C.L_ZIP, 
            C.RES_PHONE1, 
            C.BRANCH_CD, 
            L.CLTCODE CROSAC , 
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()), 
            C.FAMILY, 
            C.SUB_BROKER, 
            C.TRADER, 
            C.CL_TYPE, 
            C.BANK_NAME, 
            C.CLTDPID, 
            L.LNO 
      FROM #LEDGERDATA L WITH(NOLOCK) 
      RIGHT OUTER JOIN 
            #LEDGERCLIENTS C WITH(NOLOCK) 
            ON 
            (
                  L.CLTCODE = C.PARTY_CODE
            ) 


      
/*UPDATING OPENING BLANACE*/      
      UPDATE 
            #TMPLEDGER 
            SET OPBAL = 0 

      UPDATE 
            #TMPLEDGER 
            SET OPBAL = T.OPPBAL 
      FROM #TMPLEDGER L WITH(NOLOCK), 
            #OPPBALANCE T WITH(NOLOCK) 
      WHERE L.CLTCODE = T.CLTCODE 
      


/*UPDATING CHEQUE NUMBER*/      
      UPDATE 
            #TMPLEDGER 
            SET DDNO = L1.DDNO 
      FROM LEDGER1 L1 WITH(NOLOCK) 
      WHERE L1.VNO = #TMPLEDGER.VNO 
            AND L1.VTYP = #TMPLEDGER.VTYP 
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE 
            AND L1.LNO = #TMPLEDGER.LNO 
      


/*UPDATING CROSS ACCOUNT CODE*/      
      UPDATE 
            #TMPLEDGER 
            SET #TMPLEDGER.CROSAC = B.CLTCODE 
      FROM LEDGER B WITH(NOLOCK), 
            ACMAST V WITH(NOLOCK) 
      WHERE B.CLTCODE = V.CLTCODE 
            AND V.ACCAT = 2 
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE 
            AND #TMPLEDGER.VNO = B.VNO 
            AND #TMPLEDGER.VTYP = B.VTYP 
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23') 
      


/*UPDATING BANK NAME*/                     
      UPDATE 
            #TMPLEDGER 
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME 
      FROM MCDXCDS.DBO.POBANK B WITH(NOLOCK) 
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME)) 

      
      IF @STRORDER = 'ACCODE'      
      BEGIN      
            IF @SELECTBY = 'VDT'      
            BEGIN       
                  SELECT 
                        L.* 
                  FROM #TMPLEDGER L WITH(NOLOCK), 
                        ACMAST A WITH(NOLOCK) 
                  WHERE L.CLTCODE = A.CLTCODE 
                        AND ACCAT IN ('4', '104') 
			AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)
                  ORDER BY L.CLTCODE, 
                        VOUDT 
            END      
            ELSE      
            BEGIN      
                  SELECT 
                        L.* 
                  FROM #TMPLEDGER L WITH(NOLOCK), 
                        ACMAST A WITH(NOLOCK) 
                  WHERE L.CLTCODE = A.CLTCODE 
                        AND ACCAT IN ('4', '104') 
			AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)
                  ORDER BY L.CLTCODE, 
                        EFFDT 
            END      
      END      
      ELSE      
      BEGIN      
            IF @SELECTBY = 'VDT'      
            BEGIN       
                  SELECT 
                        L.* 
                  FROM #TMPLEDGER L WITH(NOLOCK), 
                        ACMAST A WITH(NOLOCK) 
                  WHERE L.CLTCODE = A.CLTCODE 
                        AND ACCAT IN ('4', '104') 
			AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)
                  ORDER BY L.ACNAME, 
                        VOUDT 
            END      
            ELSE      
            BEGIN      
                  SELECT 
                        L.* 
                  FROM #TMPLEDGER L WITH(NOLOCK), 
                        ACMAST A WITH(NOLOCK) 
                  WHERE L.CLTCODE = A.CLTCODE 
                        AND ACCAT IN ('4', '104') 
			AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)
                  ORDER BY L.ACNAME, 
                        EFFDT 
            END      
      END      
      
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BANK_FUNDS_REPORTING
-- --------------------------------------------------



--EXEC BANK_FUNDS_REPORTING 'APR  1 2013', 'NOV 27 2013', 'BANK01'

CREATE PROCEDURE BANK_FUNDS_REPORTING
	@FR_DATE VARCHAR(11),
	@TO_DATE VARCHAR(11),
	@BANK_CODE VARCHAR(10)
AS

CREATE TABLE #LEDGER_PL
(
	VDT DATETIME,
	EDT DATETIME,
	LONG_NAME VARCHAR(100),
	BANK_ACC_NO VARCHAR(30),
	UCC_CODE VARCHAR(10),
	CLTCODE VARCHAR(10),
	CLIENT_PAN VARCHAR(30),
	NARRATION VARCHAR(500),
	VNO VARCHAR(12),
	SETT_NO VARCHAR(10),
	CHQ_NO VARCHAR(30),
	DRAMOUNT MONEY,
	CRAMOUNT MONEY,
	RUNNING_BALANCE MONEY,
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	VTYP INT,
	BOOKTYPE VARCHAR(3),
	PDT DATETIME,
	OPBAL MONEY
)

INSERT INTO #LEDGER_PL
SELECT
	VDT, EDT, LONG_NAME, ACCNO, UCC_CODE, CL_CODE, PAN_GIR_NO, NARRATION = L.NARRATION, VNO, SETT_NO = '', CHQ_NO = '',  
	DRAMOUNT = CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END,
	CRAMOUNT = CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END, 0, EXCHANGE, SEGMENT, L.VTYP, L.BOOKTYPE, PDT, OPBAL = 0
FROM
	MSAJAG..CLIENT_DETAILS C, (SELECT CLTCODE, VAMT, DRCR, NARRATION, VDT, EDT, PDT, VTYP, VNO, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59') L, VMAST V, OWNER O, MULTIBANKID M
WHERE
	C.CL_CODE = L.CLTCODE
	AND C.CL_CODE = M.CLTCODE
	AND L.VTYP = V.VTYPE
	AND EXISTS(SELECT VNO FROM LEDGER LL WHERE VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59' AND CLTCODE = @BANK_CODE AND L.VNO = LL.VNO AND L.VTYP = LL.VTYP AND L.BOOKTYPE = LL.BOOKTYPE)
	AND L.CLTCODE <> @BANK_CODE
ORDER BY L.CLTCODE, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)), PDT

UPDATE L SET L.CHQ_NO = L1.DDNO FROM #LEDGER_PL L, LEDGER1 L1
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE

UPDATE L SET L.SETT_NO = L1.SETT_NO FROM #LEDGER_PL L, BILLPOSTED L1
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE

UPDATE L SET BANK_ACC_NO = ACCNO FROM #LEDGER_PL L, MULTIBANKID L1
WHERE L.CLTCODE = L1.CLTCODE AND DEFAULTBANK = 1 


CREATE TABLE #OPBAL
(
	CLTCODE VARCHAR(10),
	OPBAL MONEY
)

INSERT INTO #OPBAL
SELECT CLTCODE, AMOUNT = SUM(AMOUNT) FROM
(
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, PARAMETER P
	WHERE L.CLTCODE = @BANK_CODE AND L.VDT >= SDTCUR AND VDT < @FR_DATE AND @FR_DATE BETWEEN SDTCUR AND LDTCUR AND VTYP <> 18
	GROUP BY L.CLTCODE
	UNION ALL
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, PARAMETER P
	WHERE L.CLTCODE = @BANK_CODE AND @FR_DATE BETWEEN SDTCUR AND LDTCUR
	AND VDT BETWEEN SDTCUR AND LDTCUR AND VTYP = 18
	GROUP BY L.CLTCODE
) L
GROUP BY CLTCODE

UPDATE L SET L.OPBAL = O.OPBAL FROM #LEDGER_PL L, #OPBAL O


SELECT VDT,
	EDT,
	LONG_NAME,
	BANK_ACC_NO,
	UCC_CODE,
	CLTCODE,
	CLIENT_PAN,
	NARRATION,
	VNO,
	SETT_NO,
	CHQ_NO,
	DRAMOUNT,
	CRAMOUNT,
	RUNNING_BALANCE,
	OPBAL,
	PDT FROM #LEDGER_PL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BILLPOSTING
-- --------------------------------------------------
   
CREATE PROCEDURE [dbo].[BILLPOSTING]          
(          
 @BILL_DATE VARCHAR(11)          
)          
AS          
          
DECLARE          
 @VNO VARCHAR(12),          
 @VDT VARCHAR(11),          
 @EDTDR VARCHAR(11),                                
    @EDTCR VARCHAR(11),                                
    @CDT VARCHAR(11),                                
    @PDT VARCHAR(11),                                
    @UNAME VARCHAR(25),                                 
    @EXCHANGE VARCHAR(10),                               
    @OVNO VARCHAR(12),                          
 @NARR VARCHAR(20),          
 @REC_COUNT INT          
        
 SET @UNAME = 'AUTOPROCESS'        
           
 SELECT @CDT = CONVERT(VARCHAR(11), GETDATE(), 109), @PDT = CONVERT(VARCHAR(11), GETDATE(), 109)          
           
 SELECT @EXCHANGE = EXCHANGE FROM OWNER          
           
 IF LEN(@BILL_DATE) = 10          
 BEGIN          
  SELECT @BILL_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @BILL_DATE, 103), 109)          
 END          
           
SET @OVNO = ''          
          
SELECT @OVNO = VNO, @VNO = VNO, @EDTDR = CONVERT(VARCHAR(11), EDTDR, 109), @EDTCR = CONVERT(VARCHAR(11), EDTCR, 109) FROM BILLPOSTED WHERE BILLDATE LIKE @BILL_DATE + '%'          
          
IF @OVNO = ''          
BEGIN          
          
 DECLARE          
  @@SDTCUR VARCHAR(11),          
  @@LDTCUR VARCHAR(11)          
            
 SELECT @@SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109), @@LDTCUR = CONVERT(VARCHAR(11), LDTCUR, 109)          
 FROM PARAMETER WHERE @BILL_DATE BETWEEN SDTCUR AND LDTCUR          
          
 CREATE TABLE #VNO          
 (          
  LASTVNO VARCHAR(12)          
 )          
          
 INSERT INTO #VNO          
 EXEC ACC_GENVNO_NEW @BILL_DATE, 15, '01', @@SDTCUR, @@LDTCUR, 1          
          
 SELECT @VNO = LASTVNO FROM #VNO          
           
 /*SELECT DISTINCT @EDTDR = CONVERT(VARCHAR(11), PAYIN_DATE, 109), @EDTCR = CONVERT(VARCHAR(11), PAYIN_DATE, 109) FROM NSEFO.DBO.FOACCBILL          
 WHERE BILLDATE LIKE @BILL_DATE + '%'  */        
 SET @EDTDR = @BILL_DATE        
 SET @EDTCR = @BILL_DATE        
    
 SELECT @EDTDR = ISNULL(MIN(SEC_PAYIN),@EDTDR), @EDTCR = ISNULL(MIN(SEC_PAYIN),@EDTCR)     
 FROM ANAND1.MSAJAG.DBO.SETT_MST     
 WHERE SEC_PAYIN > @BILL_DATE + ' 23:59:59'    
 AND Sett_Type = 'N'    
END          
          
          
EXEC [NEWPOSTBILL]             
      15,                                
      '01',                                
      @VNO,                                
      @BILL_DATE,                                
      @EDTDR,                                
      @EDTCR,                                
      @CDT,                                
      @PDT,                                
      @UNAME,                                
      @UNAME,                                
      '',                                
      '',                                
      @UNAME,                                 
      @EXCHANGE,                               
      @BILL_DATE,          
      @OVNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BR_YEAREND
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[BR_YEAREND]      
 @SDTCUR VARCHAR(11),            
 @LDTCUR VARCHAR(11),            
 @VTYP   SMALLINT,            
 @VNO VARCHAR(12),            
 @BOOKTYPE CHAR(2),            
 @VDT    DATETIME,      
 @PNLCODE VARCHAR(10)            
            
AS            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
            
            
DECLARE            
 @@MAINCTRLAC AS VARCHAR(10),            
 @@MAINACNAME AS VARCHAR(100),            
 @@MAINCOSTCODE AS INT,            
 @@LNO AS INT,            
 @@COSTCODE AS SMALLINT,            
 @@AMT AS MONEY,            
 @@RCURSOR AS CURSOR      
        
          
            
SELECT             
 @@LNO =             
 (             
 SELECT             
  LNO             
 FROM LEDGER             
 WHERE VTYP = @VTYP             
  AND BOOKTYPE = @BOOKTYPE             
  AND VNO = @VNO             
  AND CLTCODE = @PNLCODE             
 )            
            
SELECT             
 @@MAINCTRLAC =             
 (             
 SELECT             
  MAINCONTROLAC             
 FROM BRANCHACCOUNTS             
 WHERE DEFAULTAC = 1            
 )            
            
SELECT @@MAINCOSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME IN(SELECT BRANCHNAME FROM BRANCHACCOUNTS WHERE DEFAULTAC = 1)            
            
SELECT             
 @@MAINACNAME =             
 (             
 SELECT             
  ACNAME             
 FROM ACMAST             
 WHERE CLTCODE = @@MAINCTRLAC             
 )          
      
TRUNCATE TABLE LEDGER_BRANCHBREAKUP      
      
INSERT INTO LEDGER_BRANCHBREAKUP      
SELECT VNO, VTYPE, BOOKTYPE, LNO, CLTCODE, CAMT, COSTCODE, DRCR       
FROM LEDGER2 L2 WITH (NOLOCK) WHERE CLTCODE NOT IN (@@MAINCTRLAC, @PNLCODE)       
AND EXISTS(SELECT VNO FROM LEDGER L WITH (NOLOCK) WHERE VDT > = @SDTCUR + ' 00:00:00'                 
 AND VDT <= @LDTCUR + ' 23:59:59' AND L2.VTYPE = L.VTYP                 
AND L2.BOOKTYPE = L.BOOKTYPE                 
 AND L2.VNO = L.VNO                 
 AND L2.LNO = L.LNO)        
  
  
TRUNCATE TABLE BRANCHWISECLBAL       
      
INSERT INTO BRANCHWISECLBAL      
SELECT         
 L2.CLTCODE,                 
 A.ACNAME ,                 
 COSTCODE,                 
 BALANCE=SUM(                 
 CASE                 
  WHEN UPPER(L2.DRCR) = 'D'                 
  THEN CAMT                 
  ELSE -CAMT                 
 END                
 )                 
FROM LEDGER_BRANCHBREAKUP L2,                 
 ACMAST A                 
        
WHERE       
L2.CLTCODE = A.CLTCODE      
 AND                 
 (                
  A.ACTYP LIKE 'ASS%'                 
  OR A.ACTYP LIKE 'LIAB%'                
 )                 
                
GROUP BY COSTCODE,                 
 L2.CLTCODE,                 
 A.ACNAME   
  
           
/*      
INSERT             
INTO BRANCHWISECLBAL             
SELECT             
 L2.CLTCODE,             
 A.ACNAME ,             
 COSTCODE,             
 BALANCE=SUM(             
 CASE             
  WHEN UPPER(L2.DRCR) = 'D'             
  THEN CAMT             
  ELSE -CAMT             
 END            
 )             
FROM LEDGER2 L2             
LEFT OUTER JOIN             
 ACMAST A             
 ON L2.CLTCODE = A.CLTCODE,             
 LEDGER L             
WHERE L2.VTYPE = L.VTYP             
 AND L2.BOOKTYPE = L.BOOKTYPE             
 AND L2.VNO = L.VNO             
 AND L2.LNO = L.LNO             
 AND L.VDT > = @SDTCUR + ' 00:00:00'             
 AND L.VDT <= @LDTCUR + ' 23:59:59'             
 AND             
 (            
  A.ACTYP LIKE 'ASS%'             
  OR A.ACTYP LIKE 'LIAB%'            
 )             
 AND L2.CLTCODE NOT IN (@@MAINCTRLAC, @PNLCODE)             
GROUP BY COSTCODE,             
 L2.CLTCODE,             
 A.ACNAME      
*/      
INSERT             
  INTO BRANCHWISECLBAL             
 SELECT            
   @@MAINCTRLAC,             
   @@MAINACNAME,             
   COSTCODE,            
   -(SUM(BALANCE))      
  FROM            
   BRANCHWISECLBAL            
  GROUP BY            
   COSTCODE       
      
          
      
/*            
SET @@RCURSOR = CURSOR FOR            
 SELECT            
  COSTCODE,            
  SUM(BALANCE)            
 FROM            
  BRANCHWISECLBAL            
 GROUP BY            
  COSTCODE            
            
OPEN @@RCURSOR            
 FETCH NEXT FROM            
  @@RCURSOR             
 INTO            
  @@COSTCODE,            
  @@AMT            
            
WHILE @@FETCH_STATUS = 0            
 BEGIN            
  INSERT             
  INTO BRANCHWISECLBAL VALUES            
   (             
    @@MAINCTRLAC,             
    @@MAINACNAME,             
    @@COSTCODE,             
    -(@@AMT)             
   )            
            
  FETCH NEXT FROM            
   @@RCURSOR             
  INTO            
   @@COSTCODE,            
   @@AMT            
 END            
            
CLOSE @@RCURSOR            
DEALLOCATE @@RCURSOR           
*/       
            
INSERT             
INTO LEDGER2             
SELECT             
 L.VTYP,             
 L.VNO,             
 L.LNO,             
 (            
 CASE             
  WHEN (CASE WHEN COSTCODE = @@MAINCOSTCODE AND L.CLTCODE = @@MAINCTRLAC THEN 0 ELSE BALANCE END) >= 0             
  THEN 'D'             
  ELSE 'C'             
 END            
 ),             
 ABS(CASE WHEN COSTCODE = @@MAINCOSTCODE AND L.CLTCODE = @@MAINCTRLAC THEN 0 ELSE BALANCE END),             
 COSTCODE,             
 L.BOOKTYPE,             
 B.CLTCODE             
FROM LEDGER L,             
 BRANCHWISECLBAL B             
WHERE L.VTYP = @VTYP             
 AND L.BOOKTYPE = @BOOKTYPE             
 AND L.VNO = @VNO             
 AND L.CLTCODE = B.CLTCODE            
 AND L.CLTCODE NOT IN             
 (             
 SELECT             
  BRCONTROLAC             
 FROM BRANCHACCOUNTS             
 )            
            
INSERT             
INTO LEDGER2             
SELECT             
 @VTYP,             
 @VNO,             
 @@LNO,             
 (            
 CASE             
  WHEN BALANCE >= 0             
  THEN 'D'             
  ELSE 'C'             
 END            
 ),             
 ABS(BALANCE),             
 COSTCODE,             
 @BOOKTYPE,             
 CLTCODE             
FROM BRANCHWISECLBAL B             
WHERE CLTCODE IN             
 (             
 SELECT             
  BRCONTROLAC             
 FROM BRANCHACCOUNTS             
 )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BRCLOSINGBALANCE
-- --------------------------------------------------



/****** OBJECT:  STORED PROCEDURE DBO.BRCLOSINGBALANCE    SCRIPT DATE: 05/10/2004 5:10:46 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.BRCLOSINGBALANCE    SCRIPT DATE: 12/03/2002 4:11:29 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.BRCLOSINGBALANCE    SCRIPT DATE: 06/05/2002 12:03:46 PM ******/  
/****** OBJECT:  STORED PROCEDURE DBO.BRCLOSINGBALANCE    SCRIPT DATE: 05/04/2002 12:57:05 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.BRCLOSINGBALANCE    SCRIPT DATE: 05/02/2002 2:28:13 PM ******/  
/****** OBJECT:  STORED PROCEDURE DBO.BRCLOSINGBALANCE    SCRIPT DATE: 01/28/2002 3:46:43 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.BRCLOSINGBALANCE    SCRIPT DATE: 01/24/2002 12:11:47 PM ******/  
/**************************************************************************************************************************************************************************************************  
THIS SP  IS USED TO FIND THE CLOSING BALANCE OF A PARTICULAR A/C CODE   
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
COPY OF BROPENINGBALANCE WITH CHANGE IN CONDITION.  
  
ADDED TWO NEW PARAMETERS VIZ: @FLAG AND @COSTCODE.   
THESE ARE USED TO DISPLAY THE BANK TRANSACTIONS EITHER FOR ALL THE BRANCHES OR FOR A PARTICULAR BRANCH   
DEPENDING ON THE @FLAG VALUE   
IF @FLAG = 0  THEN SHOW BANK TRANSACTION FOR ALL THE BRANCHES  
IF @FLAG = 1 THEN SHOW BANK TRANSACTION FOR A SELECTED BRANCH (I.E FOR THE PASSED COSTCODE )  
  
***************************************************************************************************************************************************************************************************/  
  
CREATE  PROCEDURE BRCLOSINGBALANCE  
@CLTCODE  VARCHAR(10),  
@SDTCUR  VARCHAR(11),  
@FROMDATE VARCHAR(11),  
@VDTEDTFLAG TINYINT,  
@FLAG   SMALLINT,  
@COSTCODE  SMALLINT  
  
AS  
  
DECLARE  
@@OPENBALDT   VARCHAR(11),  
@@OPENENTRY   MONEY,  
@@OPENINGBAL   MONEY,  
@@DRAMT   MONEY,  
@@CRAMT   MONEY,  
  
@@OPENDT    CURSOR,  
@@OPENBALCURSOR CURSOR  
  
  
  
IF @VDTEDTFLAG = 0  
BEGIN  
 /*IF THE LOGIN IS NOT BRANCH AND THE USER HAS SELECTED THE OPTION 'ALL' AS BRANCHES, SO THE USER CAN VIEW THE TRANSACTIONS FOR ALL BRANCHES */  
  
 IF @FLAG = 0   
 BEGIN  
  SET @@OPENDT = CURSOR FOR  
  SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM LEDGER L  
  WHERE VTYP = 18 AND CLTCODE = @CLTCODE  
  AND VDT < = @SDTCUR    
  OPEN @@OPENDT  
   FETCH NEXT FROM @@OPENDT INTO  @@OPENBALDT  
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
     
   /*FIND THE AMOUNT OF THE OPENING ENTRY FOR THE CLIENT IF PRESENT ELSE SET TO 0 */  
   SELECT @@DRAMT = 0  
   SELECT @@CRAMT = 0  
   SELECT @@OPENENTRY =0  
  
   SET @@OPENBALCURSOR = CURSOR  FOR   
   SELECT DRAMT = ISNULL((CASE WHEN DRCR = 'D' THEN SUM(VAMT) ELSE 0 END),0),  
   CRAMT = ISNULL((CASE WHEN DRCR = 'C' THEN SUM(VAMT) ELSE 0 END),0)  
   FROM LEDGER WHERE VTYP = 18 AND VDT LIKE @@OPENBALDT + '%'  
       AND CLTCODE = @CLTCODE GROUP BY DRCR  
       OPEN @@OPENBALCURSOR  
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT  
   WHILE @@FETCH_STATUS = 0  
   BEGIN  
    IF @@DRAMT <> 0    
    BEGIN  
     SELECT @@OPENENTRY = @@DRAMT  
    END  
    IF @@CRAMT <> 0   
    BEGIN  
     SELECT @@OPENENTRY = 0 - @@CRAMT  
    END     
     
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT   
   END  
     
   CLOSE @@OPENBALCURSOR  
   DEALLOCATE @@OPENBALCURSOR  
  
   SELECT @@DRAMT = 0  
   SELECT @@CRAMT = 0  
   SELECT @@OPENINGBAL = 0  
     
     
   SET @@OPENBALCURSOR = CURSOR FOR   
   SELECT DRTOTAL=ISNULL((CASE DRCR WHEN 'D' THEN SUM(VAMT) END),0),   
   CRTOTAL=ISNULL((CASE DRCR WHEN 'C' THEN SUM(VAMT) END),0)   
   FROM LEDGER WHERE VDT > = @@OPENBALDT   
       AND VDT < @FROMDATE+' 23:59:59'  AND VTYP <> 18 AND CLTCODE = @CLTCODE  
       GROUP BY DRCR   
   OPEN @@OPENBALCURSOR  
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT  
     
   WHILE @@FETCH_STATUS = 0  
   BEGIN  
    IF @@DRAMT <> 0    
    BEGIN  
     SELECT @@OPENINGBAL = @@OPENINGBAL + @@DRAMT  
    END  
    IF @@CRAMT <> 0   
    BEGIN  
     SELECT @@OPENINGBAL = @@OPENINGBAL - @@CRAMT  
    END  
     
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT       
   END  
     
   SELECT @@OPENINGBAL = @@OPENINGBAL + @@OPENENTRY  
                                        SELECT @@OPENINGBAL   
   CLOSE @@OPENBALCURSOR  
   DEALLOCATE @@OPENBALCURSOR  
  
   FETCH NEXT FROM @@OPENDT INTO  @@OPENBALDT  
  END   
  
  CLOSE @@OPENDT  
  DEALLOCATE @@OPENDT  
 END  
 /*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/  
 ELSE IF @FLAG = 1    
 BEGIN   
  SET @@OPENDT = CURSOR FOR  
  SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM LEDGER L , LEDGER2 L2   
  WHERE L.VTYP = L2.VTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO  AND VTYP = 18  
   AND L.CLTCODE = @CLTCODE AND VDT < = @SDTCUR   AND COSTCODE = @COSTCODE  
  OPEN @@OPENDT  
   FETCH NEXT FROM @@OPENDT INTO  @@OPENBALDT  
   
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   /*FIND THE AMOUNT OF THE OPENING ENTRY FOR THE CLIENT IF PRESENT ELSE SET TO 0 */  
   SELECT @@DRAMT = 0  
   SELECT @@CRAMT = 0  
   SELECT @@OPENENTRY =0  
  
   SET @@OPENBALCURSOR = CURSOR  FOR   
   SELECT DRAMT = ISNULL((CASE WHEN L.DRCR = 'D' THEN SUM(VAMT) ELSE 0 END),0),  
   CRAMT = ISNULL((CASE WHEN L.DRCR = 'C' THEN SUM(VAMT) ELSE 0 END),0)  
   FROM LEDGER  L , LEDGER2 L2  
   WHERE L.VTYP = L2.VTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO  AND VTYP = 18   
   AND VDT LIKE @@OPENBALDT + '%'  AND L.CLTCODE = @CLTCODE  AND COSTCODE = @COSTCODE  
   GROUP BY L.DRCR  
       OPEN @@OPENBALCURSOR  
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT  
    
   WHILE @@FETCH_STATUS = 0  
   BEGIN  
    IF @@DRAMT <> 0    
    BEGIN  
     SELECT @@OPENENTRY = @@DRAMT  
    END  
    IF @@CRAMT <> 0   
    BEGIN  
     SELECT @@OPENENTRY = 0 - @@CRAMT  
    END     
     
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT   
   END  
   CLOSE @@OPENBALCURSOR  
   DEALLOCATE @@OPENBALCURSOR  
  
   SELECT @@DRAMT = 0  
   SELECT @@CRAMT = 0  
   SELECT @@OPENINGBAL = 0  
  
   SET @@OPENBALCURSOR = CURSOR FOR   
   SELECT DRTOTAL=ISNULL((CASE L.DRCR WHEN 'D' THEN SUM(VAMT) END),0),   
   CRTOTAL=ISNULL((CASE L.DRCR WHEN 'C' THEN SUM(VAMT) END),0)   
   FROM LEDGER L,LEDGER2 L2  
   WHERE L.VTYP = L2.VTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO AND VTYP <> 18   
   AND VDT > = @@OPENBALDT   AND VDT < @FROMDATE+' 23:59:59'  AND L.CLTCODE = @CLTCODE AND COSTCODE = @COSTCODE  
       GROUP BY L.DRCR   
   OPEN @@OPENBALCURSOR  
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT  
  
     WHILE @@FETCH_STATUS = 0  
   BEGIN  
    IF @@DRAMT <> 0    
    BEGIN  
     SELECT @@OPENINGBAL = @@OPENINGBAL + @@DRAMT  
    END  
    IF @@CRAMT <> 0   
    BEGIN  
     SELECT @@OPENINGBAL = @@OPENINGBAL - @@CRAMT  
    END  
     
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT       
   END  
  
   SELECT @@OPENINGBAL = @@OPENINGBAL + @@OPENENTRY  
  
   CLOSE @@OPENBALCURSOR  
   DEALLOCATE @@OPENBALCURSOR  
  
   SELECT @@OPENINGBAL  
   FETCH NEXT FROM @@OPENDT INTO  @@OPENBALDT  
  END   
  
  CLOSE @@OPENDT  
  DEALLOCATE @@OPENDT  
 END  
  
END  
ELSE IF @VDTEDTFLAG = 1  
BEGIN  
 /*IF THE LOGIN IS NOT BRANCH AND THE USER HAS SELECTED THE OPTION 'ALL' AS BRANCHES, SO THE USER CAN VIEW THE TRANSACTIONS FOR ALL BRANCHES */  
  
 IF @FLAG = 0   
 BEGIN  
  SET @@OPENDT = CURSOR FOR  
  SELECT LEFT(CONVERT(VARCHAR,ISNULL(MIN(VDT),0),109),11) FROM LEDGER  
  WHERE CLTCODE = @CLTCODE AND EDT <= @SDTCUR    
  OPEN @@OPENDT  
   FETCH NEXT FROM @@OPENDT INTO  @@OPENBALDT  
    
  WHILE @@FETCH_STATUS = 0  
  BEGIN   
  
   /*FIND THE AMOUNT OF THE OPENING ENTRY FOR THE CLIENT IF PRESENT ELSE SET TO 0 */  
   SELECT @@DRAMT = 0  
   SELECT @@CRAMT = 0  
   SELECT @@OPENENTRY =0  
     
   SET @@OPENBALCURSOR = CURSOR  FOR   
   SELECT  DRAMT = ISNULL((CASE WHEN DRCR = 'D' THEN SUM(VAMT) ELSE 0 END),0),  
   CRAMT = ISNULL((CASE WHEN DRCR = 'C' THEN SUM(VAMT) ELSE 0 END),0)  
   FROM LEDGER WHERE VTYP = 18 AND EDT LIKE @@OPENBALDT + '%'  
       AND CLTCODE = @CLTCODE GROUP BY DRCR  
       OPEN @@OPENBALCURSOR  
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT  
     
   WHILE @@FETCH_STATUS = 0  
   BEGIN  
    IF @@DRAMT <> 0    
    BEGIN  
     SELECT @@OPENENTRY = @@DRAMT  
    END  
    IF @@CRAMT <> 0   
    BEGIN  
     SELECT @@OPENENTRY = 0 - @@CRAMT  
    END  
     
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT    
   END  
    
   CLOSE @@OPENBALCURSOR  
   DEALLOCATE @@OPENBALCURSOR  
   SELECT @@DRAMT = 0  
   SELECT @@CRAMT = 0  
   SELECT @@OPENINGBAL = 0  
  
   SET @@OPENBALCURSOR = CURSOR FOR   
   SELECT DRTOTAL=ISNULL((CASE DRCR WHEN 'D' THEN SUM(VAMT) END),0),   
   CRTOTAL=ISNULL((CASE DRCR WHEN 'C' THEN SUM(VAMT) END),0)   
   FROM LEDGER WHERE VTYP <> '18' AND EDT < @FROMDATE +' 23:59:59'  
   AND CLTCODE = @CLTCODE GROUP BY DRCR   
  
   OPEN @@OPENBALCURSOR  
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT  
     WHILE @@FETCH_STATUS = 0  
   BEGIN  
    IF @@DRAMT <> 0    
    BEGIN  
     SELECT @@OPENINGBAL = @@OPENINGBAL + @@DRAMT  
    END  
    IF @@CRAMT <> 0   
    BEGIN   
     SELECT @@OPENINGBAL = @@OPENINGBAL - @@CRAMT  
    END  
      
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT       
   END  
   SELECT @@OPENINGBAL = @@OPENINGBAL + @@OPENENTRY  
  
   CLOSE @@OPENBALCURSOR  
   DEALLOCATE @@OPENBALCURSOR  
  
   SELECT @@OPENINGBAL  
   FETCH NEXT FROM @@OPENDT INTO  @@OPENBALDT  
  END   
  CLOSE @@OPENDT  
  DEALLOCATE @@OPENDT  
  
 END   
 /*IF THE LOGIN = BRANCH THE ONLY THE ENTRIES FOR THAT BRANCH ARE RETRIEVED*/  
 ELSE IF @FLAG = 1    
 BEGIN   
  SET @@OPENDT = CURSOR FOR  
  SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM LEDGER L ,LEDGER2 L2  
  WHERE L.VTYP = L2.VTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO AND VTYP = 18   
  AND L.CLTCODE = @CLTCODE AND EDT < = @SDTCUR  AND COSTCODE = @COSTCODE  
  OPEN @@OPENDT  
   FETCH NEXT FROM @@OPENDT INTO  @@OPENBALDT  
    
  WHILE @@FETCH_STATUS = 0  
  BEGIN  
   /*FIND THE AMOUNT OF THE OPENING ENTRY FOR THE CLIENT IF PRESENT ELSE SET TO 0 */  
   SELECT @@DRAMT = 0  
   SELECT @@CRAMT = 0  
   SELECT @@OPENENTRY =0  
     
   SET @@OPENBALCURSOR = CURSOR  FOR   
   SELECT DRAMT = ISNULL((CASE WHEN L.DRCR = 'D' THEN SUM(VAMT) ELSE 0 END),0),  
                CRAMT  = ISNULL((CASE WHEN L.DRCR = 'C' THEN SUM(VAMT) ELSE 0 END),0)  
   FROM LEDGER L ,LEDGER2 L2  
    WHERE L.VTYP = L2.VTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO AND VTYP = 18    
   AND EDT LIKE @@OPENBALDT + '%' AND L.CLTCODE = @CLTCODE AND COSTCODE = @COSTCODE  
   GROUP BY L.DRCR  
       OPEN @@OPENBALCURSOR  
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT  
     
   WHILE @@FETCH_STATUS = 0  
   BEGIN  
    IF @@DRAMT <> 0    
    BEGIN  
     SELECT @@OPENENTRY = @@DRAMT  
    END  
    IF @@CRAMT <> 0   
    BEGIN  
     SELECT @@OPENENTRY = 0 - @@CRAMT  
    END  
     
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT    
   END  
    
   CLOSE @@OPENBALCURSOR  
   DEALLOCATE @@OPENBALCURSOR  
   
   SELECT @@DRAMT = 0  
   SELECT @@CRAMT = 0  
   SELECT @@OPENINGBAL = 0  
  
   SET @@OPENBALCURSOR = CURSOR FOR   
   SELECT DRTOTAL=ISNULL((CASE L.DRCR WHEN 'D' THEN SUM(VAMT) END),0),   
                CRTOTAL=ISNULL((CASE L.DRCR WHEN 'C' THEN SUM(VAMT) END),0)   
   FROM LEDGER L,LEDGER2 L2  
   WHERE  L.VTYP = L2.VTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO AND VTYP <> 18  
   AND EDT > = @@OPENBALDT  AND EDT < @FROMDATE+' 23:59:59' AND L.CLTCODE = @CLTCODE AND COSTCODE = @COSTCODE  
   GROUP BY L.DRCR   
   OPEN @@OPENBALCURSOR  
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT  
     WHILE @@FETCH_STATUS = 0  
   BEGIN  
    IF @@DRAMT <> 0    
    BEGIN  
     SELECT @@OPENINGBAL = @@OPENINGBAL + @@DRAMT  
    END  
    IF @@CRAMT <> 0   
    BEGIN   
     SELECT @@OPENINGBAL = @@OPENINGBAL - @@CRAMT  
    END  
      
    FETCH NEXT FROM @@OPENBALCURSOR INTO @@DRAMT,@@CRAMT       
   END  
   SELECT @@OPENINGBAL = @@OPENINGBAL + @@OPENENTRY  
  
   CLOSE @@OPENBALCURSOR  
   DEALLOCATE @@OPENBALCURSOR  
  
   SELECT @@OPENINGBAL  
   FETCH NEXT FROM @@OPENDT INTO  @@OPENBALDT  
  END   
  CLOSE @@OPENDT  
  DEALLOCATE @@OPENDT  
 END   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BRICS_RPT_ACC_PARTYLEDGER
-- --------------------------------------------------

CREATE  PROCEDURE BRICS_RPT_ACC_PARTYLEDGER              
               
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */              
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */              
@FCODE VARCHAR(10),              
@TCODE VARCHAR(10),              
@STRORDER VARCHAR(6),              
@SELECTBY VARCHAR(3),              
@STATUSID VARCHAR(15),              
@STATUSNAME VARCHAR(15),              
@STRBRANCH VARCHAR(10)              
 AS              
              
DECLARE @@OPENDATE   AS VARCHAR(11)              
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
              
              
/*GETTING LAST OPENING DATE */              
IF UPPER(@SELECTBY) = 'VDT'              
 BEGIN              
  SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM LEDGER WHERE VTYP = 18 AND VDT <= @FDATE )              
 END              
ELSE              
 BEGIN              
  SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(EDT),0),109),11) FROM LEDGER WHERE VTYP = 18 AND EDT <= @FDATE )              
 END              
              
/*CREATING BLANK TABLE FOR OPENING BALANCE*/              
SELECT CLTCODE,OPPBAL=VAMT INTO #OPPBALANCE FROM LEDGER WHERE 1=2              
              
/*GETTING OPENING BALANCE*/              
IF @SELECTBY = 'VDT'              
 BEGIN              
  IF @@OPENDATE = @FDATE               
   BEGIN              
    INSERT INTO  #OPPBALANCE               
    SELECT CLTCODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END),0)              
    FROM LEDGER B              
    WHERE B.CLTCODE >= @FCODE AND B.CLTCODE <=@TCODE AND  B.VDT LIKE @FDATE + '%' AND VTYP = 18               
    GROUP BY CLTCODE              
   END              
  ELSE              
   BEGIN              
    INSERT INTO  #OPPBALANCE               
    SELECT CLTCODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'D' THEN B.VAMT ELSE -B.VAMT END),0)                
    FROM LEDGER B               
    WHERE B.CLTCODE >=@FCODE AND B.CLTCODE <= @TCODE  AND  B.VDT >=  @@OPENDATE + ' 00:00:00' AND VDT < @FDATE               
    GROUP BY CLTCODE              
   END              
 END               
ELSE              
 BEGIN               
         IF @@OPENDATE = @FDATE               
            BEGIN            
      INSERT INTO  #OPPBALANCE            
               SELECT CLTCODE, OPBAL=SUM(OPBAL)            
               FROM            
      (            
                 SELECT CLTCODE, OPBAL = ISNULL(SUM( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)                
                 FROM LEDGER             
                 WHERE CLTCODE = @FCODE AND EDT LIKE @@OPENDATE + '%' AND VTYP = 18            
                 GROUP BY CLTCODE            
            
                 UNION ALL            
            
       SELECT CLTCODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END),0)                
         FROM LEDGER B               
         WHERE B.CLTCODE >=@FCODE AND B.CLTCODE <= @TCODE  AND  B.VDT >=  @@OPENDATE + ' 00:00:00' AND EDT < @@OPENDATE            
         GROUP BY CLTCODE             
            
      ) T            
      GROUP BY CLTCODE             
            END            
         ELSE            
            BEGIN            
      INSERT INTO  #OPPBALANCE               
               SELECT CLTCODE, OPBAL=SUM(OPBAL)            
               FROM            
               (             
       SELECT CLTCODE, OPBAL = ISNULL(SUM( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)                
                 FROM LEDGER             
                 WHERE CLTCODE = @FCODE AND EDT LIKE @@OPENDATE + '%' AND VTYP = 18            
                 GROUP BY CLTCODE            
            
                 UNION ALL            
            
 SELECT CLTCODE, OPBAL = SUM( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)            
                 FROM LEDGER             
                 WHERE CLTCODE = @FCODE AND EDT >= @@OPENDATE + ' 00:00:00' AND EDT < @FDATE AND VTYP <> 18            
                 GROUP BY CLTCODE             
                
      UNION ALL            
            
      SELECT CLTCODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END),0)                
        FROM LEDGER B               
        WHERE B.CLTCODE >=@FCODE AND B.CLTCODE <= @TCODE  AND  B.VDT >=  @@OPENDATE + ' 00:00:00' AND EDT < @@OPENDATE            
        GROUP BY CLTCODE             
      ) T            
               GROUP BY CLTCODE            
            END            
 END              
              
/*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */              
SELECT L.*,SHORTDESC=SPACE(35) INTO #LEDGERDATA FROM LEDGER L WHERE 1 = 2              
              
/*GETTING FIILTERED LEDGER*/              
IF @SELECTBY = 'VDT'              
 BEGIN              
  INSERT INTO #LEDGERDATA SELECT L.*,  ISNULL(V.SHORTDESC,'') SHORTDESC FROM LEDGER L, VMAST V WHERE VDT >= @FDATE + ' 00:00:00'              
  AND L.VTYP = V.VTYPE  AND              
  VDT <= @TDATE +' 23:59:59' AND CLTCODE >= @FCODE AND CLTCODE <= @TCODE               
              
 END               
ELSE              
 BEGIN              
  INSERT INTO #LEDGERDATA SELECT  L.*, ISNULL(V.SHORTDESC,'') SHORTDESC FROM LEDGER L, VMAST V WHERE EDT >= @FDATE + ' 00:00:00'               
  AND L.VTYP = V.VTYPE  AND              
  EDT <= @TDATE +' 23:59:59' AND CLTCODE >= @FCODE AND CLTCODE <= @TCODE               
 END              
              
/*GETTING CLIENT LIST*/              
SELECT C2.PARTY_CODE,C1.LONG_NAME, BANK_NAME =CONVERT(VARCHAR(50), ISNULL(C4.BANKID,'')),              
L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,C1.BRANCH_CD,              
FAMILY,C1.SUB_BROKER,TRADER,C1.PAN_GIR_NO,CLTDPID =ISNULL(CLTDPID,'')              
              
INTO #LEDGERCLIENTS              
              
 FROM              
  MCDXCDS.DBO.CLIENT1 C1 ,MCDXCDS.DBO.CLIENT2 C2 LEFT OUTER JOIN MCDXCDS.DBO.CLIENT4  C4 ON              
 (C2.PARTY_CODE=C4.PARTY_CODE  AND  DEPOSITORY NOT IN ('NSDL','CDSL') )
-- AND  DEFDP=1)              
WHERE C1.CL_CODE=C2.CL_CODE              
AND C1.BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE  '%' END)              
AND SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME ELSE  '%' END)              
AND TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE  '%' END)              
AND C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE  '%' END)              
AND C2.PARTY_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE  '%' END)              
AND C1.BRANCH_CD LIKE @STRBRANCH +'%'              
AND C2.PARTY_CODE >= @FCODE AND C2.PARTY_CODE <= @TCODE               
              
/*GETTING LDDGER ENTRIES*/              
SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, L.SHORTDESC,               
 DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN L.VAMT ELSE 0 END),                
 CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE 0 END),              
 L.VNO, DDNO= SPACE(15), L.NARRATION, C.PARTY_CODE CLTCODE,L.VTYP, CONVERT(VARCHAR,L.VDT,103) VDT,               
 CONVERT(VARCHAR,L.EDT,103) EDT, C.LONG_NAME AS ACNAME , OPBAL = VAMT,               
 C.L_ADDRESS1,C.L_ADDRESS2,C.L_ADDRESS3,C.L_CITY,C.L_ZIP,C.RES_PHONE1,C.BRANCH_CD, L.CLTCODE CROSAC ,              
 EDIFF=DATEDIFF(D,L.EDT,GETDATE()), C.FAMILY,C.SUB_BROKER,C.TRADER,C.PAN_GIR_NO,              
 C.BANK_NAME,C.CLTDPID, L.LNO               
              
INTO  #TMPLEDGER               
             
FROM  #LEDGERDATA L RIGHT OUTER JOIN #LEDGERCLIENTS C ON (L.CLTCODE=C.PARTY_CODE)              
              
/*UPDATING OPENING BLANACE*/              
UPDATE #TMPLEDGER SET OPBAL = 0              
UPDATE #TMPLEDGER SET OPBAL = T.OPPBAL FROM #TMPLEDGER L,#OPPBALANCE T WHERE L.CLTCODE = T.CLTCODE              
              
/*UPDATING CHEQUE NUMBER*/              
UPDATE #TMPLEDGER SET DDNO = L1.DDNO FROM LEDGER1 L1              
WHERE L1.VNO=#TMPLEDGER.VNO AND L1.VTYP=#TMPLEDGER.VTYP AND L1.BOOKTYPE=#TMPLEDGER.BOOKTYPE AND L1.LNO = #TMPLEDGER.LNO               
              
/*UPDATING CROSS ACCOUNT CODE*/              
UPDATE #TMPLEDGER SET #TMPLEDGER.CROSAC=B.CLTCODE FROM              
LEDGER B, ACMAST V                 
WHERE B.CLTCODE = V.CLTCODE AND V.ACCAT=2 AND #TMPLEDGER.BOOKTYPE=B.BOOKTYPE               
AND #TMPLEDGER.VNO=B.VNO AND #TMPLEDGER.VTYP=B.VTYP               
AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01','1','02','2','03','3','04','4','05','5','16','17','19','20','22','23')               
              
/*UPDATING BANK NAME*/                             
UPDATE  #TMPLEDGER SET #TMPLEDGER.BANK_NAME= B.BANK_NAME  FROM              
MCDXCDS.DBO.POBANK  B WHERE LTRIM(RTRIM(CAST(B.BANKID  AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))              
              
IF @STRORDER = 'ACCODE'              
 BEGIN              
  IF @SELECTBY = 'VDT'              
   BEGIN               
    SELECT L.* FROM #TMPLEDGER L,ACMAST A  WHERE  L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104') ORDER BY L.CLTCODE,VOUDT              
   END              
  ELSE              
   BEGIN              
    SELECT L.* FROM #TMPLEDGER L,ACMAST A   WHERE  L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104') ORDER BY L.CLTCODE,EFFDT              
   END              
 END              
ELSE              
  BEGIN              
   IF @SELECTBY = 'VDT'              
    BEGIN               
     SELECT L.* FROM #TMPLEDGER L,ACMAST A   WHERE L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104') ORDER BY L.ACNAME,VOUDT              
    END              
   ELSE              
    BEGIN              
     SELECT L.* FROM #TMPLEDGER L,ACMAST A  WHERE L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104') ORDER BY L.ACNAME,EFFDT              
    END              
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BRICS_RPT_ACC_PARTYLEDGER_ALL
-- --------------------------------------------------

CREATE PROCEDURE BRICS_RPT_ACC_PARTYLEDGER_ALL                 
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */                  
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */                  
@FCODE VARCHAR(10),                  
@TCODE VARCHAR(10),                  
@STRORDER VARCHAR(6),                  
@SELECTBY VARCHAR(3),                  
@STATUSID VARCHAR(15),                  
@STATUSNAME VARCHAR(15),                  
@STRBRANCH VARCHAR(10)                
                
AS                
                
BEGIN                
                
CREATE TABLE [DBO].[#TMPLEDGERNEW] (                  
  [BOOKTYPE] [CHAR] (2) NULL ,                  
  [VOUDT] [DATETIME] NULL ,                  
  [EFFDT] [DATETIME] NULL ,                  
  [SHORTDESC] [CHAR] (6) NULL ,                  
  [DRAMT] [MONEY] NULL ,                  
  [CRAMT] [MONEY] NULL ,                  
  [VNO] [VARCHAR] (12) NULL ,                  
  [DDNO] [VARCHAR] (15) NULL ,                  
  [NARRATION] [VARCHAR] (234) NULL ,                  
  [CLTCODE] [VARCHAR] (10) NOT NULL ,                  
  [VTYP] [SMALLINT] NULL ,                  
  [VDT] [VARCHAR] (30) NULL ,                  
  [EDT] [VARCHAR] (30) NULL ,                  
  [ACNAME] [VARCHAR] (100) NULL ,                  
  [OPBAL] [MONEY] NULL ,                  
  [L_ADDRESS1] [VARCHAR] (40) NULL ,                  
  [L_ADDRESS2] [VARCHAR] (40) NULL ,                  
  [L_ADDRESS3] [VARCHAR] (40) NULL ,                  
  [L_CITY] [VARCHAR] (40) NULL ,                  
  [L_ZIP] [VARCHAR] (10) NULL ,                  
  [RES_PHONE1] [VARCHAR] (15) NULL ,                  
  [BRANCH_CD] [VARCHAR] (10) NULL ,                  
  [CROSAC] [VARCHAR] (10) NULL ,                  
  [EDIFF] [INT] NULL ,                  
  [FAMILY] [VARCHAR] (10) NULL ,                  
  [SUB_BROKER] [VARCHAR] (10) NULL ,                  
  [TRADER] [VARCHAR] (20) NULL ,                  
  [PAN_GIR_NO] [VARCHAR] (12) NULL ,                  
  [BANK_NAME] [VARCHAR] (50) NULL ,                  
  [CLTDPID] [VARCHAR] (16) NULL ,                  
  [LNO] [DECIMAL](5, 0) NULL ,                  
  [SEGMENT] [VARCHAR] (4) NULL,            
  [ENTITY] [VARCHAR] (50) NULL              
 ) ON [PRIMARY]                  
              
              
              
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,              
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,              
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,PAN_GIR_NO,BANK_NAME,CLTDPID,LNO)               
EXEC ACCOUNTMCDXCDS.DBO.BRICS_RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH              
              
UPDATE #TMPLEDGERNEW SET SEGMENT='1MCX',ENTITY='FUTURES - MCX' WHERE SEGMENT IS NULL                
              
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,              
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,              
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,PAN_GIR_NO,BANK_NAME,CLTDPID,LNO)               
EXEC ACCOUNTNCDX.DBO.BRICS_RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH              
              
UPDATE #TMPLEDGERNEW SET SEGMENT='2NCX',ENTITY='FUTURES - NCX' WHERE SEGMENT IS NULL              

          
--MARGIN          
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,              
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,              
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,PAN_GIR_NO,BANK_NAME,CLTDPID,LNO)               
EXEC ACCOUNTMCDXCDS.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH              
              
UPDATE #TMPLEDGERNEW SET SEGMENT='3MCX',ENTITY='MARGIN CAPITAL - MCX' WHERE SEGMENT IS NULL                
        
        
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,              
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,              
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,PAN_GIR_NO,BANK_NAME,CLTDPID,LNO)               
EXEC ACCOUNTNCDX.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH              
              
UPDATE #TMPLEDGERNEW SET SEGMENT='4NCX',ENTITY='MARGIN CAPITAL - NCX' WHERE SEGMENT IS NULL                
        
             
              
              
IF @STRORDER = 'ACCODE'                  
BEGIN                  
 IF @SELECTBY = 'VDT'                  
 BEGIN                   
 SELECT * FROM #TMPLEDGERNEW  --WHERE ISNULL(DRAMT,0)+ISNULL(CRAMT,0)+ISNULL(OPBAL,0) <> 0  /* COMMENTED ON OCT 16 2007   
 ORDER BY CLTCODE,SEGMENT,VOUDT                  
 END                  
 ELSE                  
 BEGIN                  
  SELECT * FROM #TMPLEDGERNEW ---WHERE ISNULL(DRAMT,0)+ISNULL(CRAMT,0)+ISNULL(OPBAL,0) <> 0   
ORDER BY CLTCODE,SEGMENT,EFFDT                  
 END                  
END                  
ELSE                  
BEGIN                    
 IF @SELECTBY = 'VDT'                  
 BEGIN                   
  SELECT * FROM #TMPLEDGERNEW  ---WHERE ISNULL(DRAMT,0)+ISNULL(CRAMT,0)+ISNULL(OPBAL,0) <> 0  
 ORDER BY ACNAME,SEGMENT,VOUDT                  
 END                  
 ELSE                  
 BEGIN                  
  SELECT * FROM #TMPLEDGERNEW  ---WHERE ISNULL(DRAMT,0)+ISNULL(CRAMT,0)+ISNULL(OPBAL,0) <> 0   
ORDER BY ACNAME,SEGMENT,EFFDT                  
 END                  
END                
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BRYEAREND
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.BRYEAREND    SCRIPT DATE: 05/10/2004 5:29:30 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.BRYEAREND    SCRIPT DATE: 03/27/2003 11:33:03 AM ******/
/****** OBJECT:  STORED PROCEDURE DBO.BRYEAREND    SCRIPT DATE: 02/18/2003 10:26:56 AM ******/
CREATE PROCEDURE BRYEAREND
@SDTCUR VARCHAR(11),
@LDTCUR VARCHAR(11),
@VTYP   SMALLINT,
@VNO VARCHAR(12),
@BOOKTYPE CHAR(2),
@VDT    DATETIME

AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


DECLARE
@@MAINCTRLAC AS VARCHAR(10),
@@MAINACNAME AS VARCHAR(100),
@@LNO        AS INT,
@@COSTCODE   AS TINYINT,
@@AMT        AS MONEY,
@@RCURSOR    AS CURSOR


SELECT @@LNO = ( SELECT LNO FROM LEDGER WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO AND CLTCODE = '999999' )
SELECT @@MAINCTRLAC = ( SELECT MAINCONTROLAC FROM BRANCHACCOUNTS WHERE DEFAULTAC = 1)
SELECT @@MAINACNAME = ( SELECT ACNAME FROM ACMAST WHERE CLTCODE = @@MAINCTRLAC )

TRUNCATE TABLE BRANCHWISECLBAL

INSERT INTO BRANCHWISECLBAL
SELECT L2.CLTCODE, A.ACNAME , COSTCODE, BALANCE=SUM( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)
FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE, LEDGER L
WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO
AND L.VDT > = @SDTCUR + ' 00:00:00' AND L.VDT <= @LDTCUR + ' 23:59:59'
AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%') AND L2.CLTCODE NOT IN (@@MAINCTRLAC, '999999')
GROUP BY COSTCODE, L2.CLTCODE, A.ACNAME

SET @@RCURSOR = CURSOR FOR
SELECT COSTCODE, SUM(BALANCE)
FROM BRANCHWISECLBAL
GROUP BY COSTCODE

OPEN @@RCURSOR
FETCH NEXT FROM @@RCURSOR 
INTO @@COSTCODE, @@AMT

WHILE @@FETCH_STATUS = 0
BEGIN
  INSERT INTO BRANCHWISECLBAL VALUES( @@MAINCTRLAC, @@MAINACNAME, @@COSTCODE, -(@@AMT) )

  FETCH NEXT FROM @@RCURSOR 
  INTO @@COSTCODE, @@AMT
END

CLOSE @@RCURSOR
DEALLOCATE @@RCURSOR

INSERT INTO LEDGER2 
SELECT L.VTYP, L.VNO, L.LNO, (CASE WHEN BALANCE >= 0 THEN 'D' ELSE 'C' END), ABS(BALANCE), COSTCODE, L.BOOKTYPE, B.CLTCODE
FROM LEDGER L, BRANCHWISECLBAL B
WHERE L.VTYP = @VTYP AND L.BOOKTYPE = @BOOKTYPE AND L.VNO = @VNO AND L.CLTCODE = B.CLTCODE 

INSERT INTO LEDGER2 
SELECT @VTYP, @VNO, @@LNO, (CASE WHEN BALANCE >= 0 THEN 'D' ELSE 'C' END), ABS(BALANCE), COSTCODE, @BOOKTYPE, CLTCODE
FROM BRANCHWISECLBAL B
WHERE CLTCODE IN ( SELECT BRCONTROLAC FROM BRANCHACCOUNTS )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BULKCOPYRECO_ALLBANK
-- --------------------------------------------------

CREATE PROC [dbo].[BULKCOPYRECO_ALLBANK]      
 @FILENAME VARCHAR(200),      
 @TABLE VARCHAR(50),      
 @BANK_TYPE VARCHAR(10),      
 @STAT_TYPE VARCHAR(10),      
 @LOGIN VARCHAR(10),      
 @PWD VARCHAR(15)      
      
AS      
 DECLARE @@SQL AS VARCHAR(4000)      
 DECLARE @@FNAME AS VARCHAR(200)      
      
 SELECT @@FNAME = 'D:\TESTIMPORT.TXT'      
 CREATE TABLE #TESTIMPORT      
 (      
 OneRow Varchar(2000),      
 SNO INT IDENTITY(1,1)      
 )      
      
SET NOCOUNT ON      
      
SELECT @@SQL = "INSERT INTO #TESTIMPORT EXEC MASTER.DBO.XP_CMDSHELL 'TYPE " + @FILENAME + "'"      
PRINT @@SQL      
EXEC(@@SQL)      
      
IF @BANK_TYPE = 'ICICIRECO'      
BEGIN      
 DELETE FROM #TESTIMPORT WHERE SNO <= (SELECT SNO FROM #TESTIMPORT WHERE LEFT(ONEROW, 3) = 'No.')      
END      
      
DELETE FROM #TESTIMPORT WHERE SNO = 1      
      
DELETE FROM #TESTIMPORT WHERE ONEROW IS NULL      
      
DELETE FROM #TESTIMPORT WHERE RTRIM(LEFT(ONEROW, 1)) = CHAR(9)      
      
SELECT ONEROW = REPLACE(REPLACE(REPLACE(ONEROW, ')', ''), '(', ''), '"', '' ) INTO #TESTIMPORT1 From #TESTIMPORT      
      
DROP TABLE #TESTIMPORT      
      
SELECT * INTO TESTIMPORT FROM #TESTIMPORT1      
      
DROP TABLE #TESTIMPORT1      
      
      
SELECT @@SQL = "MASTER.DBO.XP_CMDSHELL 'bcp " + CHAR(34) + DB_NAME() + ".DBO.TESTIMPORT" + CHAR(34) + " out " + CHAR(34) + @@FNAME + CHAR(34) + " -c -q -U " + CHAR(34) + @LOGIN + CHAR(34) + " -P " + CHAR(34) + @PWD + CHAR(34) + " -S " + + CHAR(34) + @@SERVERNAME + CHAR(34) + "', no_output"      
PRINT @@SQL      
EXEC (@@SQL)      
      
DROP TABLE TESTIMPORT      
      
IF @BANK_TYPE = 'CITIRECO'      
BEGIN      
 SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ';', KEEPNULLS)"      
END 
ELSE IF (@BANK_TYPE = 'INDUSIND' AND @STAT_TYPE = 'CSV')      
BEGIN      
 SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', KEEPNULLS)"      
END      
ELSE IF @BANK_TYPE = 'HDFCRECO' AND (@STAT_TYPE = 'TAB' OR @STAT_TYPE = 'BNK')      
BEGIN      
 SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = '\t', KEEPNULLS)"      
END      
ELSE IF (@BANK_TYPE = 'HDFCRECO' AND @STAT_TYPE = 'CSV') OR @BANK_TYPE = 'AXISRECO'      
BEGIN      
 SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', KEEPNULLS)"      
END      
ELSE IF @BANK_TYPE = 'SCRECO'      
BEGIN      
 SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 4, ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', KEEPNULLS)"      
END      
ELSE IF @BANK_TYPE = 'SBIRECO'      
BEGIN      
 SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', KEEPNULLS)"      
END      
ELSE IF @BANK_TYPE = 'ICICIRECO'      
BEGIN      
 SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 1, ROWTERMINATOR = '\n', FIELDTERMINATOR = '\t', KEEPNULLS)"      
END      
ELSE IF @BANK_TYPE = 'PNBRECO'      
BEGIN      
 SELECT @@SQL = "BULK INSERT " + @TABLE + " FROM '" + @@FNAME + "' WITH (FIRSTROW = 2, ROWTERMINATOR = '\n', FIELDTERMINATOR = ',', KEEPNULLS)"      
END      
PRINT @@SQL      
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCULATEBS
-- --------------------------------------------------



CREATE PROC [DBO].[CALCULATEBS]
@FROMDATE VARCHAR(11),    
@TODATE VARCHAR(11),    
@BRANCHCD VARCHAR(20),    
@SHOWZERO VARCHAR(1) = 'N'    
  
AS    
  
BEGIN    
  
SET NOCOUNT ON    
BEGIN TRANSACTION    
  
DELETE FROM PLGROUP_MSTR     
  
/*FOR GROUP DETAILS*/    
INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)     
SELECT GROUP_CODE=LTRIM(RTRIM(GRPCODE)),GROUP_NAME=LTRIM(RTRIM(GRPNAME)),    
MAIN_GROUP=CASE WHEN LTRIM(RTRIM(GRPCODE)) = GRPMAIN THEN '' ELSE LTRIM(RTRIM(GRPMAIN)) END,AMOUNT=0,TYPE='G'    
FROM GRPMAST WHERE (GRPMAIN LIKE 'L%' OR GRPMAIN LIKE 'A%')    
/*FOR GROUP DETAILS*/    
  
/*FOR ACCOUNT DETAILS*/    
IF LTRIM(RTRIM(@BRANCHCD)) = ''    
BEGIN    
 -- FOR HO    
 INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)     
 SELECT GROUP_CODE=LTRIM(RTRIM(L.CLTCODE)),GROUP_NAME=LTRIM(RTRIM(L.ACNAME)),MAIN_GROUP=LTRIM(RTRIM(GRPCODE)),    
 AMOUNT= SUM(CASE WHEN DRCR = 'C' THEN VAMT * -1 ELSE VAMT END),TYPE='A'    
 FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE    
 WHERE EXISTS(SELECT GROUP_CODE FROM PLGROUP_MSTR M WHERE M.GROUP_CODE = A.GRPCODE)     
 AND L.VDT >= CONVERT(DATETIME,@FROMDATE + ' 00:00:00')  AND L.VDT <= CONVERT(DATETIME,@TODATE + ' 23:59:59')    
 GROUP BY L.CLTCODE,L.ACNAME,GRPCODE    
END    
  
ELSE    
BEGIN    
 -- FOR BRANCHES    
 INSERT INTO PLGROUP_MSTR(GROUP_CODE,GROUP_NAME,MAIN_GROUP,AMOUNT,TYPE)     
 SELECT GROUP_CODE=LTRIM(RTRIM(L.CLTCODE)),GROUP_NAME=LTRIM(RTRIM(A.ACNAME)),MAIN_GROUP=LTRIM(RTRIM(A.GRPCODE)),    
 AMOUNT= SUM(CASE WHEN L.DRCR = 'C' THEN CAMT * -1 ELSE CAMT END),TYPE='A'    
 FROM LEDGER2 L     
 LEFT OUTER JOIN LEDGER L1 ON L1.VTYP = L.VTYPE AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO AND L1.LNO = L.LNO AND L1.CLTCODE = L.CLTCODE    
 LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE    
 LEFT OUTER JOIN COSTMAST M ON L.COSTCODE = M.COSTCODE    
 WHERE EXISTS(SELECT GROUP_CODE FROM PLGROUP_MSTR M WHERE M.GROUP_CODE = A.GRPCODE)     
 AND L1.VDT >= CONVERT(DATETIME,@FROMDATE + ' 00:00:00')  AND L1.VDT <= CONVERT(DATETIME,@TODATE + ' 23:59:59')    
 AND M.COSTNAME = @BRANCHCD    
 GROUP BY L.CLTCODE,A.ACNAME,A.GRPCODE    
END    
  
SELECT *,RECLEVEL = DBO.GETGROUPLEVELS(GROUP_CODE)     
INTO #TMPPL     
FROM PLGROUP_MSTR    
ORDER BY RECLEVEL,GROUP_CODE    
  
COMMIT TRANSACTION    
DECLARE @@GROUPCODE VARCHAR(20),    
@@RECLEVEL INT    
  
DECLARE RSCURSOR  CURSOR FOR    
SELECT DISTINCT GROUP_CODE,RECLEVEL    
FROM #TMPPL     
WHERE TYPE = 'G'    
ORDER BY RECLEVEL DESC    
OPEN RSCURSOR      
FETCH NEXT FROM RSCURSOR INTO @@GROUPCODE,@@RECLEVEL     
WHILE @@FETCH_STATUS = 0    
BEGIN    
 UPDATE #TMPPL SET AMOUNT = ISNULL((SELECT SUM(AMOUNT) FROM #TMPPL T1 WHERE  T1.MAIN_GROUP = @@GROUPCODE),0)    
 FROM #TMPPL T WHERE TYPE = 'G' AND GROUP_CODE = @@GROUPCODE    
 FETCH NEXT FROM RSCURSOR INTO @@GROUPCODE,@@RECLEVEL     
END    
  
CLOSE RSCURSOR    
DEALLOCATE RSCURSOR    
  
IF @SHOWZERO = 'Y'    
BEGIN    
 SELECT GROUP_CODE=GROUP_CODE,GROUP_NAME= CASE WHEN TYPE = 'A' THEN 'A/C :' + GROUP_NAME ELSE GROUP_NAME END,    
 MAIN_GROUP,AMOUNT,TYPE,RECLEVEL     
 FROM #TMPPL ORDER BY RECLEVEL ASC     
END    
  
ELSE    
BEGIN    
 SELECT GROUP_CODE=GROUP_CODE,GROUP_NAME= CASE WHEN TYPE = 'A' THEN 'A/C :' + GROUP_NAME ELSE GROUP_NAME END,    
 MAIN_GROUP,AMOUNT,TYPE,RECLEVEL     
 FROM #TMPPL WHERE AMOUNT <> 0 ORDER BY RECLEVEL ASC     
END    
  
DROP TABLE #TMPPL     
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKMARGINOPBAL
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.CHECKMARGINOPBAL    SCRIPT DATE: 05/10/2004 5:29:30 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.CHECKMARGINOPBAL    SCRIPT DATE: 03/28/2003 4:33:12 PM ******/
CREATE PROCEDURE CHECKMARGINOPBAL
@SDTCUR VARCHAR(11),
@LDTCUR VARCHAR(11),
@VTYP   SMALLINT,
@VNO VARCHAR(12),
@BOOKTYPE CHAR(2),
@VDT    DATETIME

AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


SELECT L.LNO, L.CLTCODE, AMT=(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END), T.BAL
FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE,
(SELECT MCLTCODE, BAL=SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)
FROM MARGINLEDGER WHERE VDT >= @SDTCUR + ' 00:00:00'  AND VDT <= @LDTCUR + ' 23:59:59'
GROUP BY MCLTCODE) T
WHERE L.VTYP = @VTYP AND L.BOOKTYPE = @BOOKTYPE AND L.VNO = @VNO
AND A.ACCAT = 14 AND T.MCLTCODE = L.CLTCODE AND 
(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END) <> BAL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHEQUEDETAILSSP_NEW
-- --------------------------------------------------


CREATE PROC CHEQUEDETAILSSP_NEW 
@CLTCODE VARCHAR(10),             
@OPTION VARCHAR(2),             
@VDT VARCHAR(11),             
@STATUSNAME VARCHAR(25)            
AS            
       
IF @OPTION = ''      
BEGIN      
 SELECT DISTINCT ACNAME, CLTCODE, BNKNAME, BRNNAME, VAMT, DDNO, L.VTYP, L.VNO, L.LNO, L.DRCR, L.VDT , L.BOOKTYPE, CITY = ''            
 FROM LEDGER L, LEDGER1 L1 /*, MCDXCDS.DBO.CLIENT4 C4, MCDXCDS.DBO.POBANK P*/, MCDXCDS.DBO.TBLPRADNYAUSERS U, MCDXCDS.DBO.TBLADMIN A            
 WHERE  L1.VTYP = L.VTYP AND L1.VNO = L.VNO --AND L.LNO = L1.LNO            
 AND L.VTYP IN (SELECT VTYP FROM LEDGER WHERE L.VTYP = VTYP AND L.VNO = VNO AND L.BOOKTYPE = BOOKTYPE AND VTYP IN (2, 19) AND CLTCODE = @CLTCODE)             
 AND L.VNO IN (SELECT VNO FROM LEDGER WHERE L.VTYP = VTYP AND L.VNO = VNO AND L.BOOKTYPE = BOOKTYPE AND VTYP IN (2, 19)  AND CLTCODE = @CLTCODE)             
 AND CLEAR_MODE IN ('X','O','N','S','H') AND L.VDT LIKE @VDT + '%' AND L.CLTCODE <> @CLTCODE       
 --AND ENTEREDBY = FLDUSERNAME AND A.FLDSTNAME = U.FLDSTNAME AND FLDADMINAUTO = FLDAUTO_ADMIN            
 AND U.FLDSTNAME = @STATUSNAME         
END      
      
ELSE      
BEGIN      
 SELECT DISTINCT ACNAME, CLTCODE, BNKNAME, BRNNAME, VAMT, DDNO, L.VTYP, L.VNO, L.LNO, L.DRCR, L.VDT , L.BOOKTYPE, CITY = ''            
 FROM LEDGER L, LEDGER1 L1 /*, MCDXCDS.DBO.CLIENT4 C4, MCDXCDS.DBO.POBANK P*/, MCDXCDS.DBO.TBLPRADNYAUSERS U, MCDXCDS.DBO.TBLADMIN A            
 WHERE  L1.VTYP = L.VTYP AND L1.VNO = L.VNO --AND L.LNO = L1.LNO            
 AND L.VTYP IN (SELECT VTYP FROM LEDGER WHERE L.VTYP = VTYP AND L.VNO = VNO AND L.BOOKTYPE = BOOKTYPE AND VTYP IN (2, 19) AND CLTCODE = @CLTCODE)             
 AND L.VNO IN (SELECT VNO FROM LEDGER WHERE L.VTYP = VTYP AND L.VNO = VNO AND L.BOOKTYPE = BOOKTYPE AND VTYP IN (2, 19)  AND CLTCODE = @CLTCODE)             
 AND CLEAR_MODE IN (@OPTION) AND L.VDT LIKE @VDT + '%' AND L.CLTCODE <> @CLTCODE       
 --AND ENTEREDBY = FLDUSERNAME AND A.FLDSTNAME = U.FLDSTNAME AND FLDADMINAUTO = FLDAUTO_ADMIN            
 AND U.FLDSTNAME = @STATUSNAME            
END          
        
--EXEC CHEQUEDETAILSSP_NEW '995116','','JUN  2 2005','BROKER'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLIENT_FUNDS_REPORTING
-- --------------------------------------------------


--EXEC CLIENT_FUNDS_REPORTING 'APR  1 2018', 'NOV 27 2018'

CREATE PROCEDURE [dbo].[CLIENT_FUNDS_REPORTING]
	@FR_DATE VARCHAR(11),
	@TO_DATE VARCHAR(11),
	@FR_CODE VARCHAR(10) = '0',
	@TO_CODE VARCHAR(10) = 'ZZZZZ'
AS

CREATE TABLE #CLIENT_DETAILS
(
	UCC_CODE VARCHAR(15), 
	CL_CODE VARCHAR(10), 
	LONG_NAME VARCHAR(100), 
	PAN_GIR_NO VARCHAR(20)
)

INSERT INTO #CLIENT_DETAILS
SELECT UCC_CODE, CL_CODE, LONG_NAME, PAN_GIR_NO 
FROM MSAJAG..CLIENT_DETAILS WHERE CL_CODE BETWEEN @FR_CODE AND @TO_CODE



CREATE TABLE #LEDGER_PL
(
	UCC_CODE VARCHAR(10),
	CLTCODE VARCHAR(10),
	LONG_NAME VARCHAR(100),
	CLIENT_PAN VARCHAR(30),
	VDT DATETIME,
	EDT DATETIME,
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(10),
	SETT_NO VARCHAR(10),
	CHQ_NO VARCHAR(30),
	VTYPE VARCHAR(30),
	NARRATION VARCHAR(500),
	VNO VARCHAR(12),
	DRAMOUNT MONEY,
	CRAMOUNT MONEY,
	RUNNING_BALANCE MONEY,
	VTYP INT,
	BOOKTYPE VARCHAR(3),
	OPBAL MONEY,
	PDT DATETIME,
	SNO INT IDENTITY(1, 1)
)

INSERT INTO #LEDGER_PL
SELECT
	UCC_CODE, CL_CODE, LONG_NAME, PAN_GIR_NO, VDT, EDT, EXCHANGE, SEGMENT, SETT_NO = '', CHQ_NO = '', VDESC, NARRATION = L.NARRATION, VNO, 
	DRAMOUNT = CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END,
	CRAMOUNT = CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END, 0, L.VTYP, L.BOOKTYPE, 0, PDT
FROM
	#CLIENT_DETAILS C, 
	(SELECT CLTCODE, VAMT, DRCR, NARRATION, VDT, EDT, PDT, VTYP, VNO, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FR_DATE AND @TO_DATE + ' 23:59' AND CLTCODE BETWEEN @FR_CODE AND @TO_CODE) L, 
	VMAST V, OWNER O
WHERE
	C.CL_CODE = CLTCODE
	AND L.VTYP = V.VTYPE
ORDER BY CLTCODE, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)), PDT

UPDATE L SET L.CHQ_NO = L1.DDNO FROM #LEDGER_PL L, LEDGER1 L1
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE

UPDATE L SET L.SETT_NO = L1.SETT_NO FROM #LEDGER_PL L, BILLPOSTED L1
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE


CREATE TABLE #OPBAL
(
	CLTCODE VARCHAR(10),
	OPBAL MONEY
)

INSERT INTO #OPBAL
SELECT CLTCODE, AMOUNT = SUM(AMOUNT) FROM
(
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, (SELECT DISTINCT CLTCODE FROM #LEDGER_PL) L1, PARAMETER P
	WHERE L.CLTCODE = L1.CLTCODE AND L.VDT >= SDTCUR AND VDT < @FR_DATE AND @FR_DATE BETWEEN SDTCUR AND LDTCUR AND VTYP <> 18
	GROUP BY L.CLTCODE
	UNION ALL
	SELECT CLTCODE = L.CLTCODE, AMOUNT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, (SELECT DISTINCT CLTCODE FROM #LEDGER_PL) L1, PARAMETER P
	WHERE L.CLTCODE = L1.CLTCODE AND @FR_DATE BETWEEN SDTCUR AND LDTCUR
	AND VDT BETWEEN SDTCUR AND LDTCUR AND VTYP = 18
	GROUP BY L.CLTCODE
) L
GROUP BY CLTCODE

UPDATE L SET L.OPBAL = O.OPBAL FROM #LEDGER_PL L, #OPBAL O WHERE L.CLTCODE = O.CLTCODE

--UPDATE L SET RUNNING_BALANCE = (SELECT SUM(CRAMOUNT - DRAMOUNT) FROM #LEDGER_PL L1 WHERE O.CLTCODE = L1.CLTCODE AND L.CLTCODE = L1.CLTCODE AND L1.SNO < L.SNO) FROM #LEDGER_PL L, #OPBAL O
--WHERE L.CLTCODE = O.CLTCODE

SELECT 
	UCC_CODE, 
	CLTCODE, 
	LONG_NAME, 
	CLIENT_PAN, 
	VDT,
	EDT,
	EXCHANGE,
	SEGMENT,
	SETT_NO,
	CHQ_NO,
	VTYPE,
	NARRATION,
	VNO,
	DRAMOUNT,
	CRAMOUNT,
	RUNNING_BALANCE,
	OPBAL,
	PDT 
FROM #LEDGER_PL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BANKRECO_FETCH
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_BANKRECO_FETCH]
(
	@FCLTCODE VARCHAR(10),
	@TCLTCODE VARCHAR(10)
	,@DATE_FROM VARCHAR(11)
	,@DATE_TO VARCHAR(11)
	,@BANKCODE VARCHAR(30)
	,@DRCR CHAR(1)
	,@REFNO VARCHAR(30)
	,@CHEQUE_NO VARCHAR(30)
	,@AMOUNT NUMERIC(18,2)
	,@STATUS CHAR(1) = ''
	,@FLAG CHAR(2)
	,@SortBy NVARCHAR(50)
	,@BB_DATE_FROM VARCHAR(11)
	,@BB_DATE_TO VARCHAR(11)
	,@FILETYPE NVARCHAR(20)
)
AS 
/*
EXEC CLS_BANKRECO_FETCH '','','01/03/2010','01/12/2015','BANK01','D','','0','',''
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','','0','','L'
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','5','0','','BS'
EXEC CLS_BANKRECO_FETCH '','','01/03/2007','01/03/2015','BANK01','','5','0','','BB'
exec CLS_BANKRECO_FETCH @FCLTCODE='0A143',@TCLTCODE='0A147',@DATE_FROM='01/01/2010',@DATE_TO ='01/01/2015',@BANKCODE='bank01',@DRCR='D',@REFNO='',@STATUS=' ',@FLAG=''
*/
BEGIN
--SET @AMOUNT = (CASE WHEN @AMOUNT = 0 THEN 999999999 ELSE @AMOUNT END)
	IF @FLAG ='' OR @FLAG ='L'  /****BOTH BANK STAAND BANK BOOK AS WELL AS FOR LEDGER ENTRY****/
	BEGIN
	
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
			SELECT /*TOP 15*/ 
				ROW_NUMBER() OVER (ORDER BY REFERENCENO,B.VALUEDATE,DESCRIPTION,AMOUNT,DRCR,CROSSREFERENCENO,BR_SNO,BOOKDATE) AS "RNO",	
				REFERENCENO
				,VALUEDATE = CONVERT(VARCHAR(11)
				,CONVERT(DATETIME,B.ValueDate),103)
				, LEFT (DESCRIPTION,20) AS 'DESCRIPTION'
				/*,CASE	WHEN FILETYPE = 'CMS' THEN '<FONT COLOR="RED">' +LEFT (DESCRIPTION,20) +'</FONT>'
				ELSE '<FONT COLOR="BLUE">'+LEFT (DESCRIPTION,20)+'</FONT>'
				END 	AS 'DESCRIPTION'	*/		
				, DESCRIPTION AS 'TDESCRIPTION'
				, AMOUNT = ROUND(AMOUNT,2)
				,AMOUNTWITH_SIGN = ROUND(CASE WHEN DRCR = 'C' THEN  AMOUNT ELSE -AMOUNT END,2)
				,DRCR
				,CROSSREFERENCENO
				,BR_SNO
				,BOOKDATE = CONVERT(VARCHAR(11),CONVERT(DATETIME,BOOKDATE),103)
				,MATCH_FLAG =''
				,COLOR='' 
				FROM BANKRECO B WITH (NOLOCK) 
				,RECON_BANK_FILEUPLOAD_LOGS S
			WHERE 
				--MICRNO = '123456' AND 
				--DUMMY1 = '0' AND	
				B.DUMMY2=S.UPLOADID
				AND CLTCODE = @BANKCODE 	
				AND BOOKDATE BETWEEN CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109)+ ' 00:00:00'
				AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59'
				AND STATUS = 'UNMATCHED' 
				AND LTRIM(RTRIM(DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(DRCR))ELSE @DRCR END)
				AND AMOUNT =  CASE WHEN @AMOUNT = 0 THEN AMOUNT ELSE @AMOUNT END 
				AND FILETYPE=@FILETYPE
			ORDER BY --RNO,AMOUNT,VALUEDATE 
				CASE WHEN @SortBy ='CrossReference' THEN CROSSREFERENCENO END,				
				CASE WHEN @SortBy ='AMOUNT' THEN AMOUNT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN REFERENCENO END, 
				CASE WHEN @SortBy ='Date' THEN B.VALUEDATE END, 
				CASE WHEN @SortBy ='Client Code' THEN CLTCODE END  
			
		IF @FLAG =''	
			BEGIN
			SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
				SELECT /*TOP 15*/ 	
					L.ACNAME
					,L1.DRCR
					,L.CLTCODE
					, ISNULL(L1.DDNO,'0')AS DDNO --.DBO.REMOVE_ZERO(DDNO, '0')
					,DDDT = CONVERT(VARCHAR(10),DDDT,103)
					,RELAMT
					,RELAMTWITH_SIGN  = ROUND(CASE WHEN L1.DRCR = 'C' THEN RELAMT ELSE -RELAMT END,2)
					,VDT = CONVERT(VARCHAR(10),VDT,103)
					,L1.VNO
					,L1.VTYP
					,L1.BOOKTYPE
					,L1.LNO
					,RELDT
					,SHORTDESC
					,L1_SNO
					,ACCNO=''
					,MATCH_FLAG =''
					,COLOR='' 
					,VALUEDT = ''
					,A.BRANCHCODE AS BRANCHCODE--'Test'/*A.Pobranch*/ AS BRANCHCODE
					,L.Acname
					,L.Narration
				FROM 
					LEDGER L WITH (NOLOCK),LEDGER1 L1 WITH (NOLOCK)
					--,MULTIBANKID M WITH (NOLOCK)
					, 	VMAST V 
					,ACMAST A
				WHERE 
					ISNULL(L1.DDNO,'0') = (CASE WHEN @CHEQUE_NO  = '' THEN ISNULL(L1.DDNO,'0') ELSE @CHEQUE_NO  END)
					AND L1.VTYP IN ( '2','3' ,'5', '19','17', '20' ) 
					AND L.CLTCODE >= (CASE WHEN @FCLTCODE = '' THEN L.CLTCODE ELSE @FCLTCODE END)
					AND L.CLTCODE <= (CASE WHEN @TCLTCODE = '' THEN L.CLTCODE ELSE @TCLTCODE END)
					--AND L.CLTCODE=M.CLTCODE
					--AND DEFAULTBANK = 1 
					AND L.VNO=L1.VNO AND L.VTYP=L1.VTYP AND L.LNO=L1.LNO
					AND L.BOOKTYPE=L1.BOOKTYPE 	
					AND LTRIM(RTRIM(L1.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(L1.DRCR))ELSE @DRCR END)
					AND EXISTS (SELECT VNO FROM LEDGER L2 WITH (NOLOCK) WHERE CLTCODE = @BANKCODE 
								AND L.VTYP=L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO 	
								AND L2.VDT >= ( CASE WHEN @BB_DATE_FROM='' THEN CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109)+ ' 00:00:00' ELSE CONVERT(VARCHAR(11),CONVERT(DATETIME,@BB_DATE_FROM,103),109)+ ' 00:00:00' END )
								AND L2.VDT <= (CASE WHEN @BB_DATE_TO='' THEN CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109) + ' 23:59:59' ELSE CONVERT(VARCHAR(11),CONVERT(DATETIME,@BB_DATE_TO,103),109) + ' 23:59:59' END )) 	
					AND L.CLTCODE <> @BANKCODE AND RELDT LIKE 'JAN  1 1900%' 
					AND V.VTYPE =L.VTYP AND UPPER(CLEAR_MODE) <> 'C' 
					AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END 
					AND L.CLTCODE=A.CLTCODE
				ORDER BY --RELAMT,VDT,L1.VTYP,L1.VNO
				CASE WHEN @SortBy ='AMOUNT' THEN RELAMT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN L1.DDNO END, 
				CASE WHEN @SortBy ='Date' THEN DDDT END, 
				CASE WHEN @SortBy ='Client Code' THEN L.CLTCODE END
			END
			
	END
	ELSE IF @FLAG ='BS' /****BANK STATEMENT****/
	BEGIN
		 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
            SELECT
				ROW_NUMBER() OVER (ORDER BY REFERENCENO,b.VALUEDATE,DESCRIPTION,AMOUNT,B.DRCR,CROSSREFERENCENO,BR_SNO) AS "RNO",
				REFERENCENO,
				VALUEDATE = CONVERT(VARCHAR(11),
				CONVERT(DATETIME,B.VALUEDATE),103),
				LEFT (DESCRIPTION,15)DESCRIPTION,
				DESCRIPTION AS 'TDESCRIPTION',
				AMOUNT = ROUND(AMOUNT,2),
				AMOUNTWITH_SIGN = ROUND(CASE WHEN DRCR = 'C' THEN  AMOUNT ELSE -AMOUNT END,2),
				B.DRCR,
				CROSSREFERENCENO,
				BR_SNO ,DUMMY1,MATCH_FLAG = ''
            FROM
				BANKRECO B WITH (NOLOCK) ,RECON_BANK_FILEUPLOAD_LOGS s
            WHERE 
			B.DUMMY2=S.UPLOADID
			AND FILETYPE=@FILETYPE
				AND CROSSREFERENCENO = (CASE WHEN @REFNO = '' THEN CROSSREFERENCENO ELSE @REFNO END)
				--AND DUMMY1 = '0' 
				AND CLTCODE = @BANKCODE AND [STATUS] = (CASE WHEN @STATUS = 'M' THEN 'MATCHED' ELSE [STATUS] END)
				AND LTRIM(RTRIM(B.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(B.DRCR))ELSE @DRCR END)
				AND AMOUNT =  CASE WHEN @AMOUNT = 0 THEN AMOUNT ELSE @AMOUNT END 
				AND B.VALUEDATE  BETWEEN CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109) AND CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)
            ORDER BY --RNO,VALUEDATE, 	AMOUNT, 	B.DRCR
				CASE WHEN @SortBy ='CrossReference' THEN CROSSREFERENCENO END,
				CASE WHEN @SortBy ='AMOUNT' THEN AMOUNT END, 
				CASE WHEN @SortBy ='Cheque No.' THEN REFERENCENO END, 
				CASE WHEN @SortBy ='Date' THEN B.ValueDate END, 
				CASE WHEN @SortBy ='Client Code' THEN CLTCODE END  
	END
	ELSE IF @FLAG ='BB' AND @REFNO = ''/****BANK BOOK****/
	BEGIN
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
		
        SELECT
			L1.DRCR,
			L.CLTCODE,L.VNO,
			ISNULL(L1.DDNO,'0')AS DDNO,--DBO.REMOVE_ZERO(DDNO, '0')
			DDDT = CONVERT(VARCHAR(10),DDDT,103),
			RELAMT = ROUND(RELAMT,2),
			VDT = CONVERT(VARCHAR(10),VDT,103),
			RELDT = CONVERT(VARCHAR(10),RELDT,103),
			L1.REFNO,MATCH_FLAG ='' 
        FROM 
			LEDGER L WITH (NOLOCK), 	LEDGER1 L1 WITH (NOLOCK), 	VMAST V 
        WHERE 
			L1.VTYP IN ( '2','3' ,'5', '19','17', '20' )
			AND ISNULL(L1.DDNO,'0') = (CASE WHEN @CHEQUE_NO  = '' THEN ISNULL(L1.DDNO,'0') ELSE @CHEQUE_NO  END)
			AND L1.REFNO = (CASE WHEN @REFNO = '' THEN L1.REFNO ELSE @REFNO END)
			AND L.CLTCODE >= (CASE WHEN @FCLTCODE = '' THEN L.CLTCODE ELSE @FCLTCODE END)
			AND L.CLTCODE <= (CASE WHEN @TCLTCODE = '' THEN L.CLTCODE ELSE @TCLTCODE END)
			AND L.VNO=L1.VNO 	AND L.VTYP=L1.VTYP
			AND L.LNO=L1.LNO 	AND L.BOOKTYPE=L1.BOOKTYPE
			AND EXISTS 	( SELECT VNO FROM LEDGER L2 WITH (NOLOCK) WHERE CLTCODE = @BANKCODE AND L.VTYP=L2.VTYP 
			AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L2.VDT >=CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109) + ' 00:00:00'
			AND L2.VDT <= CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59' ) AND L.CLTCODE <> @BANKCODE AND RELDT NOT LIKE 'JAN  1 1900%'
			AND LTRIM(RTRIM(L1.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(L1.DRCR))ELSE @DRCR END)
			AND V.VTYPE =L.VTYP 	AND UPPER(CLEAR_MODE) <> 'C' 
			AND L1.REFNO NOT IN ('0','')
			AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END
	END
	
	ELSE IF @FLAG ='BB' AND @REFNO <> ''/****BANK BOOK FOR CHECKEDEDIT****/
	BEGIN

		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
		
        SELECT
			L1.DRCR,
			L.CLTCODE,L.VNO,
			ISNULL(L1.DDNO,'0')AS DDNO,--DBO.REMOVE_ZERO(DDNO, '0')
			DDDT = CONVERT(VARCHAR(10),DDDT,103),
			RELAMT = ROUND(RELAMT,2),
			VDT = CONVERT(VARCHAR(10),VDT,103),
			RELDT = CONVERT(VARCHAR(10),RELDT,103),
			L1.REFNO,MATCH_FLAG ='' 
			,A.BRANCHCODE AS BRANCHCODE--'Test_BB'/*A.Pobranch*/ AS BRANCHCODE
        FROM 
			LEDGER L WITH (NOLOCK), 	LEDGER1 L1 WITH (NOLOCK), 	VMAST V ,ACMAST A
        WHERE 
			L1.VTYP IN ( '2','3' ,'5', '19','17', '20' )			
			AND L1.REFNO = @REFNO			
			AND L.VNO=L1.VNO 	AND L.VTYP=L1.VTYP
			AND L.LNO=L1.LNO 	AND L.BOOKTYPE=L1.BOOKTYPE
			AND EXISTS 	( SELECT VNO FROM LEDGER L2 WITH (NOLOCK) WHERE CLTCODE = @BANKCODE AND L.VTYP=L2.VTYP 
			AND L.BOOKTYPE = L2.BOOKTYPE 
			AND L.VNO = L2.VNO 
			--AND L2.VDT >=CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_FROM,103),109) + ' 00:00:00'
			--AND L2.VDT <= CONVERT(VARCHAR(11),CONVERT(DATETIME,@DATE_TO,103),109)+ ' 23:59:59' 
			) 
			--AND L.CLTCODE <> @BANKCODE 
			AND RELDT NOT LIKE 'JAN  1 1900%'
			--AND LTRIM(RTRIM(L1.DRCR))= (CASE WHEN @DRCR = '' THEN LTRIM(RTRIM(L1.DRCR))ELSE @DRCR END)
			AND V.VTYPE =L.VTYP 	
			--AND UPPER(CLEAR_MODE) <> 'C' 
			AND L1.REFNO NOT IN ('0','')
			AND RELAMT <=  CASE WHEN @AMOUNT = 0 THEN RELAMT ELSE @AMOUNT END
			AND L.CLTCODE=A.CLTCODE
	END
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BANKRECO_FETCH_DETAILS
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_BANKRECO_FETCH_DETAILS]
(
	@FLAG CHAR(20)
	,@BRSNO NVARCHAR(50)
	,@L1SNO NVARCHAR(50)
)
AS 

BEGIN
DECLARE @FLAGVALUE NVARCHAR(50)
SELECT @FLAGVALUE= .DBO.PIECE(@BRSNO,'|',2)

	IF(@FLAGVALUE='L')
	BEGIN
	SET @FLAG='LEDGER'
	SELECT @L1SNO=.DBO.PIECE(@BRSNO,'|',1)
	SET @BRSNO=''
	END

	IF(@FLAGVALUE='B')
	BEGIN
	SET @FLAG = 'BANKRECO'
	SELECT @BRSNO=.DBO.PIECE(@BRSNO,'|',1)
	END

	--SELECT @FLAG,@BRSNO,@L1SNO	RETURN

	IF @FLAG ='BANKRECO'   
	BEGIN	
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
		SELECT TOP 1 
		CLTCODE,BOOKDATE,DESCRIPTION,AMOUNT,DRCR,VALUEDATE,REFERENCENO,CROSSREFERENCENO AS CROSSNO,STATUS
		FROM BANKRECO B WITH (NOLOCK) 				
		WHERE B.BR_SNO=@BRSNO
	END			
			
	IF @FLAG ='LEDGER'	
	BEGIN
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
			SELECT	L.VNO,L.VTYP,L.BOOKTYPE,CLTCODE,DDNO,RELAMT,L1.DRCR,L.ACNAME AS 'CLIENTNAME' ,L.NARRATION
			FROM	LEDGER L,LEDGER1 L1
			WHERE L.VNO = L1.VNO
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND EXISTS (SELECT	VNO	FROM LEDGER L11 (NOLOCK)
			WHERE L11.VNO = L1.VNO	AND L11.VTYP = L1.VTYP	AND L11.BOOKTYPE = L1.BOOKTYPE)
			AND L1.L1_SNO = @L1SNO			
	END			
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BANKRECO_UPDATE
-- --------------------------------------------------









CREATE PROCEDURE [dbo].[CLS_BANKRECO_UPDATE]
(

	@PARAM_VAL1 VARCHAR(MAX)
	,@PARAM_VAL2 VARCHAR(MAX)
	,@PARAM_VAL3 VARCHAR(MAX)
	,@FLAG VARCHAR(3)
	,@USERID VARCHAR(30) 
	,@STATUSID VARCHAR(30) 
	,@STATUSNAME VARCHAR(25) 
	,@REFNO VARCHAR(MAX)
	)
	AS
	BEGIN
--	SET @PARAM_VAL1='26757|'
--	SET @PARAM_VAL2=''
--	SET @PARAM_VAL3=''
--SET @FLAG='E  '
--SET @USERID='broker'
--SET @STATUSID='Broker'
--SET @STATUSNAME='Broker'
--SET @REFNO=''

--SET @PARAM_VAL1='471^828^20/08/2007^10/09/2008|'
--SET @PARAM_VAL2=''
--SET @PARAM_VAL3=''
--SET @FLAG='U'
--SET @USERID='broker'
--SET @STATUSID='Broker'
--SET @STATUSNAME='Broker'
--SET @REFNO = '459,471,'

CREATE TABLE #REFNO 
( CROSSREFNO VARCHAR(12),
UPDATED_CROSSREFNO VARCHAR(12)
)
INSERT INTO #REFNO
		SELECT
		.DBO.CLS_PIECE(ITEMS, ',', 1)
		,.DBO.CLS_PIECE(ITEMS, ',', 2)

	FROM.DBO.CLS_SPLIT(@REFNO, ',')
	WHERE.DBO.CLS_PIECE(ITEMS, ',', 1) <> ''

	
CREATE TABLE #TEMP_DATA
		(
			CROSSREFNO VARCHAR(12)
			,LNO BIGINT
			,RELDT VARCHAR(11)
			,VDT VARCHAR(11)
			--,FINAL_DT  AS (CASE WHEN CONVERT(VARCHAR(11),CONVERT(DATETIME,VDT,103),109) < CONVERT(VARCHAR(11),CONVERT(DATETIME,RELDT,103),109)  THEN CONVERT(VARCHAR(11),CONVERT(DATETIME,RELDT,103),109) ELSE  CONVERT(VARCHAR(11),CONVERT(DATETIME,VDT,103),109) END)
			,FINAL_DT  AS (CASE WHEN CONVERT(DATETIME,VDT,103) < CONVERT(DATETIME,RELDT,103)  THEN CONVERT(VARCHAR(11),CONVERT(DATETIME,RELDT,103),109) ELSE  CONVERT(VARCHAR(11),CONVERT(DATETIME,VDT,103),109) END)
		)

INSERT INTO #TEMP_DATA
	SELECT
		.DBO.CLS_PIECE(ITEMS, '^', 1)
		,.DBO.CLS_PIECE(ITEMS, '^', 2)
		,.DBO.CLS_PIECE(ITEMS, '^', 3)
		,.DBO.CLS_PIECE(ITEMS, '^', 4)
	FROM.DBO.CLS_SPLIT(@PARAM_VAL1, '|')
	WHERE.DBO.CLS_PIECE(ITEMS, '^', 1) <> ''


	
ALTER TABLE #TEMP_DATA
ADD VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3)

UPDATE T
SET	T.VNO = L1.VNO
	,T.VTYP = L1.VTYP
	,T.BOOKTYPE = L1.BOOKTYPE
FROM #TEMP_DATA T, LEDGER1 L1
WHERE L1_SNO = T.LNO

UPDATE R 
SET R.UPDATED_CROSSREFNO = T.CROSSREFNO
FROM
#REFNO R, #TEMP_DATA T

IF @REFNO <> ''
BEGIN
UPDATE B 
SET B.Dummy1 = B.Crossreferenceno
, B.Crossreferenceno = R.UPDATED_CROSSREFNO
 FROM Bankreco B,  #REFNO R
 WHERE B.Crossreferenceno = R.CROSSREFNO

UPDATE RC
SET RC.CROSS_NO = R.UPDATED_CROSSREFNO
FROM RECON_CMS_DATA RC,  #REFNO R
WHERE RC.CROSS_NO = R.CROSSREFNO

UPDATE RNC
SET RNC.CROSS_NO = R.UPDATED_CROSSREFNO
FROM Recon_NONCMS_Data RNC,  #REFNO R
WHERE RNC.CROSS_NO = R.CROSSREFNO
END

IF @FLAG = 'U' 
BEGIN

SELECT
	*
FROM #TEMP_DATA

/*******LEDGER1 UPDATE************/
INSERT INTO [CLS_LEDGER1_BANKRECO_LOG] (BNKNAME, BRNNAME, DD, DDNO, DDDT, RELDT, RELAMT, REFNO, RECEIPTNO, VTYP, VNO, LNO, DRCR, BOOKTYPE, MICRNO, SLIPNO, SLIPDATE, CHEQUEINNAME, CHQPRINTED, CLEAR_MODE, L1_SNO, UPDATED_BY, UPDATE_DT, RECO_STATUS)
	SELECT
		L1.*
		,UPDATED_BY = @USERID
		,UPDATE_DT = GETDATE()
		,RECO_STATUS = 'MATCHED'
	FROM	LEDGER1 L1
			,#TEMP_DATA T
	WHERE L1_SNO = T.LNO
	SELECT * from CLS_LEDGER1_BANKRECO_LOG
--AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE		

UPDATE L1
SET	RESET_EDT =
				CASE
					WHEN L.EDT LIKE 'DEC 31 2049%' THEN 1
					ELSE 0
				END
	,L1.REFNO = T.CROSSREFNO
FROM LEDGER L, [CLS_LEDGER1_BANKRECO_LOG] L1, #TEMP_DATA T
WHERE L1_SNO = T.LNO
--AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP
AND L.VNO = L1.VNO
AND L.VTYP = L1.VTYP
AND L.BOOKTYPE = L1.BOOKTYPE

UPDATE L1
SET	L1.REFNO = T.CROSSREFNO
	,L1.RELDT = FINAL_DT --(CASE WHEN CONVERT(VARCHAR(11),CONVERT(DATETIME,T.VDT,103),109) < CONVERT(VARCHAR(11),CONVERT(DATETIME,T.RELDT,103),109)  THEN T.RELDT ELSE  T.VDT END)
FROM LEDGER1 L1, #TEMP_DATA T
WHERE L1_SNO = T.LNO

/*******LEDGER UPDATE************/
UPDATE L
SET L.EDT = FINAL_DT --(CASE WHEN CONVERT(VARCHAR(11),CONVERT(DATETIME,T.VDT,103),109) < CONVERT(VARCHAR(11),CONVERT(DATETIME,T.RELDT,103),109)  THEN T.RELDT ELSE  T.VDT END)
FROM LEDGER L/*,LEDGER1 L1*/, #TEMP_DATA T
WHERE
/*L1_SNO = T.LNO AND */ L.EDT LIKE 'DEC 31 2049%'
AND L.VNO = T.VNO
AND L.VTYP = T.VTYP
AND L.BOOKTYPE = T.BOOKTYPE --AND L.LNO = L1.LNO


--SELECT L.* FROM LEDGER L,LEDGER1 L1, #TEMP_DATA T  
--WHERE L1_SNO = T.LNO
--AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE 


/*******BANK RECO UPDATE************/

INSERT INTO [CLS_BANKRECO_LOG] (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, BR_SNO, CMS_SRNO, UPDATED_BY, UPDATE_DT, RECO_STATUS)
	SELECT
		B.*
		,UPDATED_BY = @USERID
		,UPDATE_DT = GETDATE()
		,RECO_STATUS = 'MATCHED'
	FROM	BANKRECO B
			,#TEMP_DATA T
	WHERE B.CROSSREFERENCENO = T.CROSSREFNO
	SELECT * FROM CLS_BANKRECO_LOG
UPDATE B
SET	VALUEDATE = FINAL_DT --(CASE WHEN CONVERT(VARCHAR(11),CONVERT(DATETIME,T.VDT,103),109) < CONVERT(VARCHAR(11),CONVERT(DATETIME,T.RELDT,103),109)  THEN T.RELDT ELSE  T.VDT END),
	,STATUS = 'MATCHED'
FROM BANKRECO B, #TEMP_DATA T
WHERE B.CROSSREFERENCENO = T.CROSSREFNO


IF EXISTS (SELECT
		*
	FROM	RECON_CMS_DATA RC
			,#TEMP_DATA T
	WHERE RC.CROSS_NO = T.CROSSREFNO) BEGIN

UPDATE RC
SET	MATCHEDFLAG = '1'
	,UPLOADSTATUS = 'MANUAL RECO'
	,MODIFIEDDATE = GETDATE()
	,UPLOADBY = @USERID
	,VNO = T.VNO
	,VTYP = T.VTYP
	,BOOKTYPE = T.BOOKTYPE
FROM RECON_CMS_DATA RC, #TEMP_DATA T
WHERE RC.CROSS_NO = T.CROSSREFNO

END

IF EXISTS (SELECT
		*
	FROM	RECON_NONCMS_DATA RC
			,#TEMP_DATA T
	WHERE RC.CROSS_NO = T.CROSSREFNO) BEGIN
UPDATE RC
SET	MATCHEDFLAG = '1'
	,UPLOADSTATUS = 'MANUAL RECO'
	,MODIFIEDDATE = GETDATE()
	,UPLOADBY = @USERID
	,VNO = T.VNO
	,VTYP = T.VTYP
	,BOOKTYPE = T.BOOKTYPE
FROM RECON_NONCMS_DATA RC, #TEMP_DATA T
WHERE RC.CROSS_NO = T.CROSSREFNO

END


/*******************************/
END 
ELSE IF 
@FLAG = 'E' 
BEGIN
INSERT INTO [CLS_BANKRECO_LOG] (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, BR_SNO, CMS_SRNO, UPDATED_BY, UPDATE_DT, RECO_STATUS)
	SELECT
		B.*
		,UPDATED_BY = @USERID
		,UPDATE_DT = GETDATE()
		,RECO_STATUS = 'UNMATCHED'
	FROM	BANKRECO B
			,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
	WHERE B.CROSSREFERENCENO = C.ITEMS

IF @REFNO <> ''
BEGIN
		
		
UPDATE B
SET STATUS = 'UNMATCHED'
,B.CROSSREFERENCENO = CASE WHEN B.DUMMY1 <> '0' THEN B.DUMMY1 ELSE B.CROSSREFERENCENO END 
--, B.Crossreferenceno = B.Dummy1
FROM BANKRECO B
,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
WHERE B.CROSSREFERENCENO = C.ITEMS
-------------------------------UPDATE CMSBANKRECO---------------------------
IF EXISTS (SELECT	*	FROM	RECON_CMS_DATA RC		,#TEMP_DATA T
	WHERE RC.CROSS_NO = T.CROSSREFNO) BEGIN

UPDATE RC
SET	MATCHEDFLAG = 0
	,UPLOADSTATUS = 'PENDING'
	,CROSS_NO = R.CROSSREFNO
	,MODIFIEDDATE = GETDATE()
	,UPLOADBY = @USERID
	,VNO = T.VNO
	,VTYP = T.VTYP
	,BOOKTYPE = T.BOOKTYPE
	,MATCHCODE = 0
FROM RECON_CMS_DATA RC, #TEMP_DATA T, #REFNO R
WHERE RC.CROSS_NO = T.CROSSREFNO AND T.CROSSREFNO = R.CROSSREFNO

END

-------------------------------UPDATE NONCMSBANKRECO---------------------------
IF EXISTS (SELECT		*	FROM	RECON_NONCMS_DATA RC
			,#TEMP_DATA T
	WHERE RC.CROSS_NO = T.CROSSREFNO) BEGIN
UPDATE RC
SET	MATCHEDFLAG = 0
	,UPLOADSTATUS = 'PENDING'
	,CROSS_NO = R.CROSSREFNO
	,MODIFIEDDATE = GETDATE()
	,UPLOADBY = @USERID
	,VNO = T.VNO
	,VTYP = T.VTYP
	,BOOKTYPE = T.BOOKTYPE
	,MATCHCODE = 0
FROM RECON_NONCMS_DATA RC, #TEMP_DATA T, #REFNO R
WHERE RC.CROSS_NO = T.CROSSREFNO AND T.CROSSREFNO = R.CROSSREFNO

END

/*-------------------------------------*/
END 

ELSE IF @REFNO = ''
BEGIN
		DECLARE @TEMPDATA TABLE(AMOUNT MONEY,CROSSREFERENCENO NVARCHAR(50),REFERENCENO NVARCHAR(50)
								,DUMMY1 NVARCHAR(50), REFCOUNT INT)
		INSERT INTO @TEMPDATA
		SELECT AMOUNT,CROSSREFERENCENO,REFERENCENO,DUMMY1,COUNT(CROSSREFERENCENO )REFCOUNT 
		FROM BANKRECO B,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C 
		WHERE DUMMY1<>0 AND  B.CROSSREFERENCENO = C.ITEMS
		GROUP BY AMOUNT,CROSSREFERENCENO,REFERENCENO,DUMMY1 
		
		IF EXISTS (SELECT *	FROM	RECON_CMS_DATA RC	,#TEMP_DATA T	WHERE RC.CROSS_NO = T.CROSSREFNO) 
		BEGIN
		UPDATE R
		SET 
		--R.CROSS_NO= B.DUMMY1,
		R.UPLOADSTATUS='PENDING'
		,MATCHEDFLAG=0
		,VNO=NULL
		,VTYP=NULL
		,BOOKTYPE=NULL
		--,CROSS_NO=B.Dummy1
		,MATCHCODE = 0
		FROM RECON_CMS_DATA R ,BANKRECO B,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
		WHERE B.CROSSREFERENCENO = C.ITEMS
		AND B.CROSSREFERENCENO=R.CROSS_NO
		AND B.AMOUNT=R.INST_AMT
		END
		
		IF EXISTS (SELECT	*	FROM	RECON_NONCMS_DATA RC ,#TEMP_DATA T WHERE RC.CROSS_NO = T.CROSSREFNO) 
	BEGIN
		UPDATE R
		SET 
		--R.CROSS_NO= B.DUMMY1,
		R.UPLOADSTATUS='PENDING'
		,MATCHEDFLAG=0
		,VNO=NULL
		,VTYP=NULL
		,BOOKTYPE=NULL
		--,CROSS_NO=B.Dummy1
		,MATCHCODE = 0
		FROM RECON_NONCMS_DATA R ,BANKRECO B,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
		WHERE B.CROSSREFERENCENO = C.ITEMS
		AND B.CROSSREFERENCENO=R.CROSS_NO
		AND B.AMOUNT=R.AMT
		END
		
		UPDATE B
		SET STATUS = 'UNMATCHED'
		, B.Crossreferenceno = CASE WHEN B.DUMMY1 <> '0' THEN B.DUMMY1 ELSE B.CROSSREFERENCENO END
		, B.Dummy1=0
		FROM BANKRECO B
		,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
		WHERE B.CROSSREFERENCENO = C.ITEMS

		IF EXISTS(SELECT * FROM  @TEMPDATA)
		 BEGIN
		    IF EXISTS (SELECT	*	FROM	RECON_NONCMS_DATA RC ,#TEMP_DATA T WHERE RC.CROSS_NO = T.CROSSREFNO) 
			BEGIN
			 UPDATE R SET CROSS_NO=T.DUMMY1
			 FROM RECON_NONCMS_DATA R,@TEMPDATA T
			 WHERE R.AMT=T.AMOUNT
			 AND R.REFERENCENO=T.REFERENCENO
			 AND R.CROSS_NO=T.CROSSREFERENCENO
			END 
			IF EXISTS (SELECT *	FROM	RECON_CMS_DATA RC	,#TEMP_DATA T	WHERE RC.CROSS_NO = T.CROSSREFNO) 
			BEGIN
			 UPDATE R SET CROSS_NO=T.DUMMY1
			 FROM RECON_CMS_DATA R,@TEMPDATA T
			 WHERE R.INST_AMT=T.AMOUNT
			 AND R.INST_NO_CHECK=T.REFERENCENO
			 AND R.CROSS_NO=T.CROSSREFERENCENO
			 ENd
		 
		 END

END

INSERT INTO [CLS_LEDGER1_BANKRECO_LOG] (BNKNAME, BRNNAME, DD, DDNO, DDDT, RELDT, RELAMT, REFNO, RECEIPTNO, VTYP, VNO, LNO, DRCR, BOOKTYPE, MICRNO, SLIPNO, SLIPDATE, CHEQUEINNAME, CHQPRINTED, CLEAR_MODE, L1_SNO, UPDATED_BY, UPDATE_DT, RECO_STATUS)
	SELECT
		L1.*
		,UPDATED_BY = @USERID
		,UPDATE_DT = GETDATE()
		,RECO_STATUS = 'UNMATCHED'
	FROM	LEDGER1 L1
			,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
	WHERE L1.REFNO = C.ITEMS
	AND C.ITEMS <> ''
	AND C.ITEMS IS NOT NULL

UPDATE L
SET EDT =
			CASE
				WHEN RESET_EDT = 1 THEN '2049-12-31 00:00:00'
				ELSE EDT
			END
FROM LEDGER L
, LEDGER1 L1
,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
, [CLS_LEDGER1_BANKRECO_LOG] CL
WHERE RECO_STATUS = 'MATCHED' --L1.REFNO = C.ITEMS 
AND L1.L1_SNO = CL.L1_SNO
AND L.VNO = L1.VNO
AND L.VTYP = L1.VTYP
AND L.BOOKTYPE = L1.BOOKTYPE
AND C.ITEMS = L1.REFNO
AND C.ITEMS <> ''
AND C.ITEMS IS NOT NULL


UPDATE L1
SET	RELDT = ''
	,REFNO = ''
FROM LEDGER1 L1
,.DBO.CLS_SPLIT(@PARAM_VAL1, '|') C
WHERE L1.REFNO = C.ITEMS
AND C.ITEMS <> ''
AND C.ITEMS IS NOT NULL


END 
ELSE IF @FLAG = 'L' 
BEGIN

DECLARE @BANKCODE VARCHAR(10)
, @CLTCODE VARCHAR(10)
, @VDT VARCHAR(10)
, @NARRATION VARCHAR(300)
, @DATA_STRING VARCHAR(MAX)
, @BOOKTYPE CHAR(2)
, @@SESSIONID VARCHAR(500)
, @BANK_NAME VARCHAR(100)
, @CLIENT_NAME VARCHAR(100)
, @BNK_NAME VARCHAR(100)
, @BNKBR_NAME VARCHAR(50)
, @ACCNO VARCHAR(20)
, @VTYPE INT
SET @@SESSIONID = (SELECT
		NEWID())

SELECT
	@BANKCODE =.DBO.CLS_PIECE(ITEMS, '^', 1)
	,@CLTCODE =.DBO.CLS_PIECE(ITEMS, '^', 2)
	,@VDT =.DBO.CLS_PIECE(ITEMS, '^', 3)
	,@NARRATION =.DBO.CLS_PIECE(ITEMS, '^', 4)
	,@ACCNO =.DBO.CLS_PIECE(ITEMS, '^', 5)
	,@BNK_NAME =.DBO.CLS_PIECE(ITEMS, '^', 6)
	,@BNKBR_NAME =.DBO.CLS_PIECE(ITEMS, '^', 7)
	,@VTYPE = CONVERT(INT,.DBO.CLS_PIECE(ITEMS, '^', 8))
FROM.DBO.CLS_SPLIT(@PARAM_VAL1, '~')
WHERE ID = 1




SELECT
	@BOOKTYPE = BOOKTYPE
	,@BANK_NAME = LONGNAME
FROM ACMAST
WHERE CLTCODE = @BANKCODE
SELECT
	@CLIENT_NAME = LONGNAME
FROM ACMAST
WHERE CLTCODE = @CLTCODE
IF (@ACCNO = '' AND @VTYPE <> '5') BEGIN
SELECT
	@BNK_NAME = BANK_NAME
	,@ACCNO = ACCNO
	,@BNKBR_NAME = BRANCH_NAME
FROM	MSAJAG..POBANK P
		,MULTIBANKID M
		,ACMAST A
WHERE P.BANKID = M.BANKID
AND A.CLTCODE = M.CLTCODE
AND DEFAULTBANK = 1
AND A.CLTCODE = @CLTCODE
END
IF @VTYPE = '5' SET @BNK_NAME = @CLIENT_NAME


SET @DATA_STRING = (SELECT
		.DBO.CLS_PIECE(@PARAM_VAL1, '~', 2))

SELECT
	ID
	,VDT = @VDT
	,VTYPE =
			CASE
				WHEN @VTYPE = '5' THEN '5'
				ELSE (CASE
						WHEN DRCR = 'C' THEN '2'
						ELSE '3'
					END)
			END
	,BOOKTYPE = @BOOKTYPE
	,REFNO =.DBO.CLS_PIECE(ITEMS, '^', 1)
	,AMOUNT = B.AMOUNT
	,DRCR = B.DRCR
	,VALUEDATE
	,DDNO = REFERENCENO INTO #TEMPDATA
FROM.DBO.CLS_SPLIT(@DATA_STRING, '|') A
	,BANKRECO B
WHERE.DBO.CLS_PIECE(ITEMS, '^', 1) = B.CROSSREFERENCENO




/************VNO GENERATION PART***************/
--EXEC CLS_GENMULTI_VNO @@SESSIONID	
--SELECT  * FROM CLS_TBL_VNOGENDATA WHERE SESSIONID = @@SESSIONID
/************VNO GENERATION PART***************/
DECLARE @VOUCHERNO VARCHAR(12)
SELECT
	@VOUCHERNO = CONVERT(VARCHAR, GETDATE(), 12) + RIGHT(REPLACE(CONVERT(VARCHAR, GETDATE(), 114), ':', ''), 6)


INSERT INTO CLS_OFFLINE_LEDGER_ENTRIES (VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION, OPPCODE, MARGINCODE, BANKNAME
, BRANCHNAME, BRANCHCODE, DDNO, CHEQUEMODE, CHEQUEDATE, CHEQUENAME, CLEAR_MODE, TPACCOUNTNUMBER, EXCHANGE, SEGMENT, TPFLAG, ADDDT, ADDBY, STATUSID
, STATUSNAME, ROWSTATE, APPROVALFLAG, APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT, LEDGERVNO, CLIENTNAME, OPPCODENAME, MARGINCODENAME
, SETT_NO, SETT_TYPE, PRODUCTTYPE, REVAMT, REVCODE, MICR, REL_DATE, DISPLAY_FLAG, RESERVED1, RESERVED2, RESERVED3, RESERVED4, RESERVED5
, RESERVED6, RESERVED7, RESERVED8, RESERVED9, RESERVED10)
	SELECT
		VOUCHERTYPE = T.VTYPE
		,BOOKTYPE = T.BOOKTYPE
		,SNO = ID
		,VDATE = CONVERT(DATETIME, T.VDT, 103)
		,EDATE = CONVERT(DATETIME, T.VDT, 103)
		,CLTCODE = @CLTCODE
		,CREDITAMT =
					CASE
						WHEN T.DRCR = 'C' THEN T.AMOUNT
						ELSE 0
					END
		,DEBITAMT =
					CASE
						WHEN T.DRCR = 'D' THEN T.AMOUNT
						ELSE 0
					END
		,NARRATION = @NARRATION
		,OPPCODE =
					CASE
						WHEN VTYPE = '5' THEN @CLTCODE
						ELSE @BANKCODE
					END
		,MARGINCODE = ''
		,BANKNAME = @BNK_NAME --CASE WHEN T.VTYPE = '2' THEN @BNK_NAME ELSE '' END
		,BRANCHNAME =
						CASE
							WHEN T.VTYPE = '2' THEN @BNKBR_NAME
							ELSE ''
						END/*DOUBT*/
		,BRANCHCODE = '' /*DOUBT*/
		,DDNO = DDNO
		,CHEQUEMODE = '' /*DOUBT*/
		,CHEQUEDATE = '' /*DOUBT*/
		,CHEQUENAME = '' /*DOUBT*/
		,CLEAR_MODE = 'L'
		,TPACCOUNTNUMBER = ''-- @ACCNO/*DOUBT*/
		,EXCHANGE = ''
		,SEGMENT = ''
		,TPFLAG = ''
		,ADDDT = GETDATE()
		,ADDBY = @USERID
		,STATUSID = @STATUSID
		,STATUSNAME = @STATUSNAME
		,ROWSTATE = '0'
		,APPROVALFLAG = '1'
		,APPROVALDATE = ''
		,APPROVEDBY = ''
		,VOUCHERNO = @VOUCHERNO  /* SET NO*/
		,UPLOADDT = ''
		,LEDGERVNO = ''
		,CLIENTNAME = @CLIENT_NAME
		,OPPCODENAME = @BANK_NAME
		,MARGINCODENAME = ''
		,SETT_NO = ''
		,SETT_TYPE = ''
		,PRODUCTTYPE = ''
		,REVAMT = ''
		,REVCODE = ''
		,MICR = ''
		,REL_DATE = CONVERT(DATETIME, T.VALUEDATE, 103)
		,DISPLAY_FLAG = ''
		,RESERVED1 = ''
		,RESERVED2 =
					CASE
						WHEN VTYPE = '5' THEN '1'
						ELSE ''
					END
		,RESERVED3 = @@SESSIONID /*PROG ID*/
		,RESERVED4 = T.REFNO
		,RESERVED5 = ''
		,RESERVED6 = ''
		,RESERVED7 = ''
		,RESERVED8 = ''
		,RESERVED9 = ''
		,RESERVED10 = ''
	FROM #TEMPDATA T


INSERT INTO CLS_OFFLINE_LEDGER_ENTRIES (VOUCHERTYPE, BOOKTYPE, SNO, VDATE, EDATE, CLTCODE, CREDITAMT, DEBITAMT, NARRATION, OPPCODE, MARGINCODE, BANKNAME
, BRANCHNAME, BRANCHCODE, DDNO, CHEQUEMODE, CHEQUEDATE, CHEQUENAME, CLEAR_MODE, TPACCOUNTNUMBER, EXCHANGE, SEGMENT, TPFLAG, ADDDT, ADDBY, STATUSID
, STATUSNAME, ROWSTATE, APPROVALFLAG, APPROVALDATE, APPROVEDBY, VOUCHERNO, UPLOADDT, LEDGERVNO, CLIENTNAME, OPPCODENAME, MARGINCODENAME
, SETT_NO, SETT_TYPE, PRODUCTTYPE, REVAMT, REVCODE, MICR, REL_DATE, DISPLAY_FLAG, RESERVED1, RESERVED2, RESERVED3, RESERVED4, RESERVED5
, RESERVED6, RESERVED7, RESERVED8, RESERVED9, RESERVED10)
	SELECT
		VOUCHERTYPE = T.VTYPE
		,BOOKTYPE = T.BOOKTYPE
		,SNO = ID
		,VDATE = CONVERT(DATETIME, T.VDT, 103)
		,EDATE = CONVERT(DATETIME, T.VDT, 103)
		,CLTCODE = B.CLTCODE
		,CREDITAMT =
					CASE
						WHEN T.DRCR = 'D' THEN T.AMOUNT
						ELSE 0
					END
		,DEBITAMT =
					CASE
						WHEN T.DRCR = 'C' THEN T.AMOUNT
						ELSE 0
					END
		,NARRATION = @NARRATION
		,OPPCODE =
					CASE
						WHEN VTYPE = '5' THEN B.CLTCODE
						ELSE @BANKCODE
					END
		,MARGINCODE = ''
		,BANKNAME = @BANK_NAME
		,BRANCHNAME =
						CASE
							WHEN T.VTYPE = '2' THEN @BNKBR_NAME
							ELSE ''
						END/*DOUBT*/
		,BRANCHCODE = '' /*DOUBT*/
		,DDNO = B.REFERENCENO
		,CHEQUEMODE = '' /*DOUBT*/
		,CHEQUEDATE = '' /*DOUBT*/
		,CHEQUENAME = '' /*DOUBT*/
		,CLEAR_MODE = 'L'
		,TPACCOUNTNUMBER = ''-- @ACCNO/*DOUBT*/
		,EXCHANGE = ''
		,SEGMENT = ''
		,TPFLAG = ''
		,ADDDT = GETDATE()
		,ADDBY = @USERID
		,STATUSID = @STATUSID
		,STATUSNAME = @STATUSNAME
		,ROWSTATE = '0'
		,APPROVALFLAG = '1'
		,APPROVALDATE = ''
		,APPROVEDBY = ''
		,VOUCHERNO = @VOUCHERNO  /* SET NO*/
		,UPLOADDT = ''
		,LEDGERVNO = ''
		,CLIENTNAME = @CLIENT_NAME
		,OPPCODENAME = @BANK_NAME
		,MARGINCODENAME = ''
		,SETT_NO = ''
		,SETT_TYPE = ''
		,PRODUCTTYPE = ''
		,REVAMT = ''
		,REVCODE = ''
		,MICR = ''
		,REL_DATE = CONVERT(DATETIME, T.VALUEDATE, 103)
		,DISPLAY_FLAG = ''
		,RESERVED1 = ''
		,RESERVED2 = '2'
		,RESERVED3 = @@SESSIONID /*PROG ID*/
		,RESERVED4 = T.REFNO
		,RESERVED5 = ''
		,RESERVED6 = ''
		,RESERVED7 = ''
		,RESERVED8 = ''
		,RESERVED9 = ''
		,RESERVED10 = ''
	FROM	#TEMPDATA T
			,BANKRECO B
	WHERE T.VTYPE = 5
	AND T.REFNO = B.CROSSREFERENCENO


---SELECT * FROM CLS_OFFLINE_LEDGER_ENTRIES WHERE RESERVED3 = @@SESSIONID 
EXEC CLS_COMMON_LEDGERPOSTING @@SESSIONID
--SELECT LEDGERVNO1=LEDGERVNO,* FROM CLS_OFFLINE_LEDGER_ENTRIES WHERE RESERVED3 = @@SESSIONID ORDER BY LEDGERVNO,RESERVED2
--SELECT * FROM CLS_OFFLINE_LEDGER_ENTRIES WHERE RESERVED3 = @@SESSIONID 
--SELECT * FROM LEDGER1 L, CLS_OFFLINE_LEDGER_ENTRIES  C WHERE L.REFNO = C.RESERVED4 AND RESERVED3 = @@SESSIONID 



UPDATE B
SET [STATUS] = 'MATCHED'
FROM BANKRECO B, #TEMPDATA T
WHERE B.CROSSREFERENCENO = T.REFNO
DROP TABLE #TEMPDATA
DROP TABLE #REFNO
END
	DROP TABLE #TEMP_DATA
	DROP TABLE #REFNO
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_BRANCH
-- --------------------------------------------------

CREATE PROC [dbo].[CLS_BRANCH]
AS 
SELECT 
	DISTINCT COSTNAME 
FROM 
	COSTMAST C, CATEGORY CT 
WHERE  
	C.CATCODE =CT.CATCODE 	AND CT.CATEGORY='BRANCH' 
UNION 
SELECT 
	'ALL'  
ORDER BY 
	COSTNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GET_ACC_LEDGER_FORMULA_BALANCES
-- --------------------------------------------------
CREATE PROCEDURE [DBO].[CLS_GET_ACC_LEDGER_FORMULA_BALANCES] 
	@FR_DATE VARCHAR(11),-- FROM DATE OF THE PERIOD 
	@EFFDATE VARCHAR(11),-- DATE FOR WHICH THE BALANCE IS REQUIRED  
	@PROCESS_CODE VARCHAR(10),-- PROCESS CODE FROM THE FORMULA MASTER  
	@REPORT_FORMULA VARCHAR(MAX),-- IN CASE NOT TO SET THE FORMULA AND GET THE SPECIFIEC FIELDS
	@EXCHANGE VARCHAR(10) = '',-- EXCHANGE
	@SEGMENT VARCHAR(50) = '',-- SEGMENT
	@REPORT_COLUMN VARCHAR(1000) = '', 
	@REPORT_GROUPING VARCHAR(1000) = '',
	@TABLE_NAME  VARCHAR(1000) = '' 
	
AS
SELECT @REPORT_FORMULA = FORMULANAME
FROM FORMULA_MASTER
WHERE PROCESSCODE = @PROCESS_CODE

IF @EXCHANGE = ''
BEGIN
	SELECT @EXCHANGE = EXCHANGE
		,@SEGMENT = SEGMENT
	FROM OWNER
END

DECLARE @START_DATE VARCHAR(11)

IF LEN(@FR_DATE) = 10
	SELECT @FR_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FR_DATE, 103), 109)

IF LEN(@EFFDATE) = 10
BEGIN
	SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)
END

SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)
FROM PARAMETER
WHERE @EFFDATE BETWEEN SDTCUR
		AND LDTCUR

DECLARE @MIN_BILL_DATE VARCHAR(11)
	,@MAX_BILL_DATE VARCHAR(11)

SELECT @MIN_BILL_DATE = CONVERT(VARCHAR(11), MIN(VDT), 109)
	,@MAX_BILL_DATE = CONVERT(VARCHAR(11), MAX(VDT), 109)
FROM (
	SELECT TOP 2 *
	FROM BILLPOSTED
	WHERE VDT <= @EFFDATE
	ORDER BY VDT DESC
	) A

CREATE TABLE #REPORT_DATA (
	CLTCODE VARCHAR(10)
	,VDTBAL_OPBAL MONEY
	,EDTBAL_OPBAL MONEY
	,VDTBAL_DATES MONEY
	,EDTBAL_DATES MONEY
	,VDTBAL_DATES_CREDIT MONEY
	,VDTBAL_DATES_DEBIT MONEY
	,EDTBAL_DATES_CREDIT MONEY
	,EDTBAL_DATES_DEBIT MONEY
	,VDTBAL MONEY
	,EDTBAL MONEY
	,VDTBAL_RECEIPT MONEY
	,T_DAY_BILL MONEY
	,T1_DAY_BILL MONEY
	,VDTBAL_BILL_DR MONEY
	,VDTBAL_BILL_CR MONEY
	,VDTBAL_NONBILL MONEY
	,EDTBAL_RECEIPT MONEY
	,EDTBAL_BILL_DR MONEY
	,EDTBAL_BILL_CR MONEY
	,EDTBAL_NONBILL MONEY
	,FDT_RECEIPT MONEY
	,FDT_CREDIT_BILLS MONEY
	,FDT_DEBIT_BILLS MONEY
	,FDT_CR MONEY
	,FDT_DR MONEY
	,MARGIN_BAL MONEY
	)

DECLARE @@SQL VARCHAR(MAX)
INSERT INTO #REPORT_DATA
SELECT CLTCODE
	,VDTBAL_OPBAL = SUM(VDTBAL_OPBAL)
	,EDTBAL_OPBAL = SUM(EDTBAL_OPBAL)
	,VDTBAL_DATES = SUM(VDTBAL_DATES)
	,EDTBAL_DATES = SUM(EDTBAL_DATES)
	,VDTBAL_DATES_CREDIT = SUM(VDTBAL_DATES_CREDIT)
	,VDTBAL_DATES_DEBIT = SUM(VDTBAL_DATES_DEBIT)
	,EDTBAL_DATES_CREDIT = SUM(EDTBAL_DATES_CREDIT)
	,EDTBAL_DATES_DEBIT = SUM(VDTBAL_DATES_DEBIT)
	,VDTBAL = SUM(VDTBAL)
	,EDTBAL = SUM(EDTBAL)
	,VDTBAL_RECEIPT = SUM(VDTBAL_RECEIPT)
	,T_DAY_BILL = SUM(T_DAY_BILL)
	,T1_DAY_BILL = SUM(T1_DAY_BILL)
	,VDTBAL_BILL_DR = SUM(VDTBAL_BILL_DR)
	,VDTBAL_BILL_CR = SUM(VDTBAL_BILL_CR)
	,VDTBAL_NONBILL = SUM(VDTBAL_NONBILL)
	,EDTBAL_RECEIPT = SUM(EDTBAL_RECEIPT)
	,EDTBAL_BILL_DR = SUM(EDTBAL_BILL_DR)
	,EDTBAL_BILL_CR = SUM(EDTBAL_BILL_CR)
	,EDTBAL_NONBILL = SUM(EDTBAL_NONBILL)
	,FDT_RECEIPT = SUM(FDT_RECEIPT)
	,FDT_CREDIT_BILLS = SUM(FDT_CREDIT_BILLS)
	,FDT_DEBIT_BILLS = SUM(FDT_DEBIT_BILLS)
	,FDT_CR = SUM(FDT_CR)
	,FDT_DR = SUM(FDT_DR)
	,MARGIN_BAL = 0
FROM (
	SELECT CLTCODE = L.CLTCODE
		,VDTBAL_OPBAL = CASE 
			WHEN VDT >= @START_DATE
				AND VDT < @FR_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END
		,EDTBAL_OPBAL = CASE 
			WHEN EDT >= @START_DATE
				AND EDT < @FR_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END
		,VDTBAL_DATES = CASE 
			WHEN VDT >= @FR_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END
		,EDTBAL_DATES = CASE 
			WHEN EDT >= @FR_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END
		,VDTBAL_DATES_CREDIT = CASE 
			WHEN VDT >= @FR_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE 0
							END)
			ELSE 0
			END
		,VDTBAL_DATES_DEBIT = CASE 
			WHEN VDT >= @FR_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE 0
							END)
			ELSE 0
			END
		,EDTBAL_DATES_CREDIT = CASE 
			WHEN EDT >= @FR_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE 0
							END)
			ELSE 0
			END
		,EDTBAL_DATES_DEBIT = CASE 
			WHEN EDT >= @FR_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE 0
							END)
			ELSE 0
			END
		,VDTBAL = CASE 
			WHEN VDT >= @START_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END
		,EDTBAL = CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END
		,VDTBAL_RECEIPT = CASE 
			WHEN VDT >= @START_DATE
				AND VTYP = 2
				THEN SUM(VAMT)
			ELSE 0
			END
		,T_DAY_BILL = CASE 
			WHEN VDT LIKE @MAX_BILL_DATE + '%'
				AND VTYP = 15
				THEN SUM(CASE 
							WHEN L.DRCR = 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END
		,T1_DAY_BILL = CASE 
			WHEN VDT LIKE @MIN_BILL_DATE + '%'
				AND VTYP = 15
				THEN SUM(CASE 
							WHEN L.DRCR = 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END
		,VDTBAL_BILL_DR = CASE 
			WHEN VDT >= @START_DATE
				AND VTYP = 15
				AND L.DRCR = 'D'
				THEN SUM(VAMT)
			ELSE 0
			END
		,VDTBAL_BILL_CR = CASE 
			WHEN VDT >= @START_DATE
				AND VTYP = 15
				AND L.DRCR = 'C'
				THEN SUM(VAMT)
			ELSE 0
			END
		,VDTBAL_NONBILL = CASE 
			WHEN VDT >= @START_DATE
				AND VTYP NOT IN (
					15
					,2
					)
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END
		,EDTBAL_RECEIPT = CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				AND VTYP = 2
				THEN SUM(VAMT)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				AND VTYP = 2
				THEN SUM(- VAMT)
			ELSE 0
			END
		,EDTBAL_BILL_DR = CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				AND VTYP = 15
				AND L.DRCR = 'D'
				THEN SUM(VAMT)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				AND VTYP = 15
				AND L.DRCR = 'D'
				THEN SUM(- VAMT)
			ELSE 0
			END
		,EDTBAL_BILL_CR = CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				AND VTYP = 15
				AND L.DRCR = 'C'
				THEN SUM(VAMT)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				AND VTYP = 15
				AND L.DRCR = 'C'
				THEN SUM(- VAMT)
			ELSE 0
			END
		,EDTBAL_NONBILL = CASE 
			WHEN EDT >= @START_DATE
				AND EDT <= @EFFDATE + ' 23:59'
				AND VTYP NOT IN (
					15
					,2
					)
				THEN SUM(CASE L.DRCR
							WHEN 'D'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END + CASE 
			WHEN EDT >= @START_DATE
				AND VDT < @START_DATE
				THEN SUM(CASE L.DRCR
							WHEN 'C'
								THEN VAMT
							ELSE - VAMT
							END)
			ELSE 0
			END
		,FDT_RECEIPT = CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND VTYP = 2
				THEN SUM(VAMT)
			ELSE 0
			END
		,FDT_CREDIT_BILLS = CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND VTYP = 15
				AND DRCR = 'C'
				THEN SUM(VAMT)
			ELSE 0
			END
		,FDT_DEBIT_BILLS = CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND VTYP = 15
				AND DRCR = 'D'
				THEN SUM(VAMT)
			ELSE 0
			END
		,FDT_CR = CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND L.DRCR = 'C'
				AND VTYP <> 2
				THEN SUM(VAMT)
			ELSE 0
			END
		,FDT_DR = CASE 
			WHEN EDT > @EFFDATE + ' 23:59'
				AND VDT <= @EFFDATE + ' 23:59'
				AND L.DRCR = 'D'
				AND VTYP <> 2
				THEN SUM(VAMT)
			ELSE 0
			END
	FROM LEDGER L(NOLOCK)
		,#FORMULA_CLIENT_MASTER A
	WHERE A.CLTCODE = L.CLTCODE --AND SESSION_ID = @SESSIONID
		AND (
			VDT >= @START_DATE
			OR EDT >= @START_DATE
			)
		AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY L.CLTCODE
		,VDT
		,EDT
		,VTYP
		,L.DRCR
	) A
GROUP BY CLTCODE

--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0
DECLARE @ML_BAL_REQ TINYINT

SELECT @ML_BAL_REQ = CHARINDEX('MARGIN_BAL', @REPORT_FORMULA)

IF @ML_BAL_REQ > 0
BEGIN
	UPDATE RD
	SET MARGIN_BAL = ML.AMOUNT
	FROM #REPORT_DATA RD
		,(
			SELECT PARTY_CODE
				,AMOUNT = SUM(CASE DRCR
						WHEN 'C'
							THEN AMOUNT
						ELSE - AMOUNT
						END)
			FROM MARGINLEDGER ML
			WHERE VDT >= @START_DATE
				AND VDT <= @EFFDATE + ' 23:59'
			GROUP BY PARTY_CODE
			) ML
	WHERE RD.CLTCODE = PARTY_CODE
END

/*IF @REPORT_COLUMN = ''
BEGIN
	SET @@SQL = " SELECT "  
	SET @@SQL = @@SQL + " CLTCODE, "  
	SET @@SQL = @@SQL + " PARTY_NAME, "  
	SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
	SET @@SQL = @@SQL + " ENTITY_CODE, "  
	SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
	SET @@SQL = @@SQL + " FROM "  
	SET @@SQL = @@SQL + " #REPORT_DATA"  
END
ELSE
BEGIN*/

IF @TABLE_NAME <> ''
	SET @@SQL = "INSERT INTO " + @TABLE_NAME + " SELECT "
ELSE	
	SET @@SQL = " SELECT "

IF @REPORT_COLUMN <> ''
	SET @@SQL = @@SQL + @REPORT_COLUMN + ", "
SET @@SQL = @@SQL + @REPORT_FORMULA
SET @@SQL = @@SQL + " FROM "
SET @@SQL = @@SQL + " #REPORT_DATA R, #FORMULA_CLIENT_MASTER M"
SET @@SQL = @@SQL + " WHERE M.CLTCODE = R.CLTCODE "

IF @REPORT_GROUPING <> ''
	SET @@SQL = @@SQL + " GROUP BY " + @REPORT_GROUPING
--END
--PRINT @@SQL
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GET_LEDGER_FORMULA_BALANCES
-- --------------------------------------------------


--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'  
CREATE PROCEDURE[dbo].[CLS_GET_LEDGER_FORMULA_BALANCES]    
 @EFFDATE VARCHAR(11),  
 @SESSIONID VARCHAR(500),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10),
 @SEGMENT VARCHAR(50)
AS    
  
DECLARE    
 @START_DATE VARCHAR(11)    
    
IF LEN(@EFFDATE) = 10    
BEGIN    
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    
    
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    
  
  
CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),    
 VDTBAL_OPBAL MONEY,  
 EDTBAL_OPBAL MONEY,    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 VDTBAL_RECEIPT MONEY,     
 T_DAY_BILL MONEY,     
 VDTBAL_BILL_DR MONEY,     
 VDTBAL_BILL_CR MONEY,    
 VDTBAL_NONBILL MONEY,     
 EDTBAL_RECEIPT MONEY,    
 EDTBAL_BILL_DR MONEY,    
 EDTBAL_BILL_CR MONEY,    
 EDTBAL_NONBILL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_CR MONEY,     
 FDT_DR MONEY,
 MARGIN_BAL MONEY  
)  
  
DECLARE  
 @@SQL VARCHAR(MAX)  
  
INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 PARTY_NAME,     
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL_OPBAL = SUM(VDTBAL_OPBAL),    
 EDTBAL_OPBAL = SUM(EDTBAL_OPBAL),    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 VDTBAL_RECEIPT = SUM(VDTBAL_RECEIPT),     
 T_DAY_BILL = SUM(T_DAY_BILL),     
 VDTBAL_BILL_DR = SUM(VDTBAL_BILL_DR),     
 VDTBAL_BILL_CR = SUM(VDTBAL_BILL_CR),    
 VDTBAL_NONBILL = SUM(VDTBAL_NONBILL),     
 EDTBAL_RECEIPT = SUM(EDTBAL_RECEIPT),    
 EDTBAL_BILL_DR = SUM(EDTBAL_BILL_DR),    
 EDTBAL_BILL_CR = SUM(EDTBAL_BILL_CR),    
 EDTBAL_NONBILL = SUM(EDTBAL_NONBILL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_CR = SUM(FDT_CR),     
 FDT_DR = SUM(FDT_DR),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = L.CLTCODE,  
 PARTY_NAME,  
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL_OPBAL = CASE WHEN VDT >= @START_DATE AND VDT < @EFFDATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL_OPBAL = CASE WHEN EDT >= @START_DATE AND EDT < @EFFDATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 VDTBAL_RECEIPT = CASE WHEN VDT >= @START_DATE AND VTYP = 2 THEN SUM(VAMT) ELSE 0 END,     
 T_DAY_BILL = CASE WHEN VDT LIKE @EFFDATE + '%' AND VTYP = 15 THEN SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,     
 VDTBAL_BILL_DR = CASE WHEN VDT >= @START_DATE AND VTYP = 15 AND DRCR = 'D' THEN SUM(VAMT) ELSE 0 END,     
 VDTBAL_BILL_CR = CASE WHEN VDT >= @START_DATE AND VTYP = 15 AND DRCR = 'C' THEN SUM(VAMT) ELSE 0 END ,    
 VDTBAL_NONBILL = CASE WHEN VDT >= @START_DATE AND VTYP NOT IN (15, 2) THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,     
 EDTBAL_RECEIPT = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP = 2 THEN SUM(VAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYP = 2 THEN SUM(-VAMT) ELSE 0 END,    
 EDTBAL_BILL_DR = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP = 15 AND DRCR = 'D' THEN SUM(VAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYP = 15 AND DRCR = 'D' THEN SUM(-VAMT) ELSE 0 END,    
 EDTBAL_BILL_CR = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP = 15 AND DRCR = 'C' THEN SUM(VAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYP = 15 AND DRCR = 'C' THEN SUM(-VAMT) ELSE 0 END,    
 EDTBAL_NONBILL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYP NOT IN (15, 2) THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND VTYP = 2 THEN SUM(VAMT) ELSE 0 END,    
 FDT_CR = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND DRCR = 'C' AND VTYP <> 2 THEN SUM(VAMT) ELSE 0 END,     
 FDT_DR = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND DRCR = 'D' AND VTYP <> 2 THEN SUM(VAMT) ELSE 0 END
FROM     
 LEDGER L,  
 FORMULA_CLIENT_MASTER A    
WHERE    
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID  
 AND (VDT >= @START_DATE OR EDT >= @START_DATE)    
 AND VDT <= @EFFDATE + ' 23:59'    
 GROUP BY     
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE,  VDT, EDT, VTYP, DRCR    
) A    
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    


UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, (
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE RD.CLTCODE = PARTY_CODE


/*  
DECLARE  
 @EXCHANGE VARCHAR(10),  
 @SEGMENT VARCHAR(10)  
   
SELECT @EXCHANGE = EXCHANGE, @SEGMENT = SEGMENT FROM OWNER   
*/
 
SET @@SQL = " SELECT "  
SET @@SQL = @@SQL + " CLTCODE, "  
SET @@SQL = @@SQL + " PARTY_NAME, "  
SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
SET @@SQL = @@SQL + " ENTITY_CODE, "  
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
SET @@SQL = @@SQL + " FROM "  
SET @@SQL = @@SQL + " #REPORT_DATA"  
  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GET_LEDGER2_FORMULA_BALANCES
-- --------------------------------------------------

--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  

/*
SELECT * FROM FORMULA_CLIENT_MASTER WHERE CLTCODE = '0A147'

INSERT INTO FORMULA_CLIENT_MASTER
SELECT PARTY_CODE, LONG_NAME, '', '', '9999999999', GETDATE() FROM MSAJAG.DBO.CLIENT_DETAILS
EXEC CLS_GET_LEDGER2_FORMULA_BALANCES 'MAR 31 2014', '', 'VDTBAL', 'NSE', 'CAPITAL'  
*/
CREATE PROCEDURE [dbo].[CLS_GET_LEDGER2_FORMULA_BALANCES]
 @EFFDATE VARCHAR(11),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10) = '',
 @SEGMENT VARCHAR(50) = '',
 @REPORT_COLUMN  VARCHAR(1000) = '',
 @REPORT_GROUPING VARCHAR(1000) = ''

AS

 SELECT @REPORT_FORMULA = FORMULANAME FROM FORMULA_MASTER WHERE PROCESSCODE = @PROCESS_CODE    
    

IF @EXCHANGE = ''
BEGIN
	SELECT @EXCHANGE = EXCHANGE, @SEGMENT = SEGMENT FROM OWNER
END

DECLARE    
 @START_DATE VARCHAR(11)    

IF LEN(@EFFDATE) = 10    
BEGIN    
	SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    

SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    

 

CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 /*PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),   */ 
 VDTBAL_OPBAL MONEY,  
 EDTBAL_OPBAL MONEY,    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 VDTBAL_RECEIPT MONEY,     
 T_DAY_BILL MONEY,     
 VDTBAL_BILL_DR MONEY,     
 VDTBAL_BILL_CR MONEY,    
 VDTBAL_NONBILL MONEY,     
 EDTBAL_RECEIPT MONEY,    
 EDTBAL_BILL_DR MONEY,    
 EDTBAL_BILL_CR MONEY,    
 EDTBAL_NONBILL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_CR MONEY,     
 FDT_DR MONEY,
 MARGIN_BAL MONEY  
)  

DECLARE  
 @@SQL VARCHAR(MAX)  

INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 VDTBAL_OPBAL = SUM(VDTBAL_OPBAL),    
 EDTBAL_OPBAL = SUM(EDTBAL_OPBAL),    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 VDTBAL_RECEIPT = SUM(VDTBAL_RECEIPT),     
 T_DAY_BILL = SUM(T_DAY_BILL),     
 VDTBAL_BILL_DR = SUM(VDTBAL_BILL_DR),     
 VDTBAL_BILL_CR = SUM(VDTBAL_BILL_CR),    
 VDTBAL_NONBILL = SUM(VDTBAL_NONBILL),     
 EDTBAL_RECEIPT = SUM(EDTBAL_RECEIPT),    
 EDTBAL_BILL_DR = SUM(EDTBAL_BILL_DR),    
 EDTBAL_BILL_CR = SUM(EDTBAL_BILL_CR),    
 EDTBAL_NONBILL = SUM(EDTBAL_NONBILL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_CR = SUM(FDT_CR),     
 FDT_DR = SUM(FDT_DR),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = L.CLTCODE,  
 VDTBAL_OPBAL = CASE WHEN VDT >= @START_DATE AND VDT < @EFFDATE THEN SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END,    
 EDTBAL_OPBAL = CASE WHEN EDT >= @START_DATE AND EDT < @EFFDATE THEN SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) ELSE 0 END,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) ELSE 0 END,    
 VDTBAL_RECEIPT = CASE WHEN VDT >= @START_DATE AND VTYPE = 2 THEN SUM(CAMT) ELSE 0 END,     
 T_DAY_BILL = CASE WHEN VDT LIKE @EFFDATE + '%' AND VTYPE = 15 THEN SUM(CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END,     
 VDTBAL_BILL_DR = CASE WHEN VDT >= @START_DATE AND VTYPE = 15 AND L2.DRCR = 'D' THEN SUM(CAMT) ELSE 0 END,     
 VDTBAL_BILL_CR = CASE WHEN VDT >= @START_DATE AND VTYPE = 15 AND L2.DRCR = 'C' THEN SUM(CAMT) ELSE 0 END ,    
 VDTBAL_NONBILL = CASE WHEN VDT >= @START_DATE AND VTYPE NOT IN (15, 2) THEN SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END,  
 EDTBAL_RECEIPT = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYPE = 2 THEN SUM(CAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYPE = 2 THEN SUM(-CAMT) ELSE 0 END,    
 EDTBAL_BILL_DR = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYPE = 15 AND L2.DRCR = 'D' THEN SUM(CAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYPE = 15 AND L2.DRCR = 'D' THEN SUM(-CAMT) ELSE 0 END,    
 EDTBAL_BILL_CR = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYPE = 15 AND L2.DRCR = 'C' THEN SUM(CAMT) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE AND VTYPE = 15 AND L2.DRCR = 'C' THEN SUM(-CAMT) ELSE 0 END,    
 EDTBAL_NONBILL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' AND VTYPE NOT IN (15, 2) THEN SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND VTYPE = 2 THEN SUM(CAMT) ELSE 0 END,    
 FDT_CR = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND L2.DRCR = 'C' AND VTYPE <> 2 THEN SUM(CAMT) ELSE 0 END,     
 FDT_DR = CASE WHEN EDT > @EFFDATE + ' 23:59' AND VDT <= @EFFDATE + ' 23:59' AND L2.DRCR = 'D' AND VTYPE <> 2 THEN SUM(CAMT) ELSE 0 END
FROM     
 LEDGER L,
 LEDGER2 L2,  
 #FORMULA_CLIENT_MASTER A    
WHERE    
 A.CLTCODE = L2.CLTCODE --AND SESSION_ID = @SESSIONID
 AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO  
 AND (VDT >= @START_DATE OR EDT >= @START_DATE)    
 AND VDT <= @EFFDATE + ' 23:59'
 GROUP BY     
 L.CLTCODE, VDT, EDT, VTYPE, L2.DRCR    
) A    
GROUP BY CLTCODE

--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    

UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, (
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE RD.CLTCODE = PARTY_CODE

/*IF @REPORT_COLUMN = ''
BEGIN
	SET @@SQL = " SELECT "  
	SET @@SQL = @@SQL + " CLTCODE, "  
	SET @@SQL = @@SQL + " PARTY_NAME, "  
	SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
	SET @@SQL = @@SQL + " ENTITY_CODE, "  
	SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
	SET @@SQL = @@SQL + " FROM "  
	SET @@SQL = @@SQL + " #REPORT_DATA"  
END
ELSE
BEGIN*/
	SET @@SQL = " SELECT "  
	IF @REPORT_COLUMN <> ''
		SET @@SQL = @@SQL + @REPORT_COLUMN + ", "
	SET @@SQL = @@SQL + @REPORT_FORMULA  
	SET @@SQL = @@SQL + " FROM "  
	SET @@SQL = @@SQL + " #REPORT_DATA"  
	IF @REPORT_GROUPING <> ''
		SET @@SQL = @@SQL + " GROUP BY " + @REPORT_GROUPING
--END

  
--PRINT @@SQL
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GL_REPORT
-- --------------------------------------------------
/*
EDIFF = DATEDIFF(D, L.EDT, GETDATE()),           
EXEC RPT_ACC_BANKBOOK_NEW 'DEC  1 2010', 'DEC 22 2010', '01/04/2010', 'BANK01', 'BROKER', 'BROKER', '%', 'VDT'
*/

--EXEC RPT_ACC_BANKBOOK_NEW_BR 'APR  1 2005', 'MAR 31 2006', 'APR  1 2005', 'BANK01', 'BROKER', 'BROKER', 'TR001'      
CREATE PROC [DBO].[CLS_GL_REPORT]
      @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                          
      @FCODE VARCHAR(10),                          
      @TCODE VARCHAR(10),                          
      @STATUSID VARCHAR(30),                          
      @STATUSNAME VARCHAR(30),                          
      @BRANCH VARCHAR(10),      
      @SELECTIONBY VARCHAR(3) = 'VDT',
      @REPORT_TYPE VARCHAR(5) = 'GL'                           
                          
AS                          
                          
DECLARE                          
 @@OPENDATE AS VARCHAR(11),                          
 @@REPDATE AS VARCHAR(8),                          
 @@STARTDATE AS VARCHAR(11),       
 @@COSTCODE AS SMALLINT      


CREATE TABLE #GL_OPBAL
(
	CLTCODE VARCHAR(10),
	OPBAL MONEY
)
      
    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                          
                        
CREATE TABLE [DBO].[#TBL_GLREPORT] (                        
 [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                        
 [BOOKTYPE] [CHAR] (2) NULL ,                        
 [VOUDT] [VARCHAR] (10) NULL ,                        
 [EFFDT] [VARCHAR] (10) NULL ,                        
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                        
 [DRAMT] [MONEY] NULL ,                        
 [CRAMT] [MONEY] NULL ,                        
 [VNO] [VARCHAR] (12) NULL ,                        
 [NARRATION] [VARCHAR] (500) NULL ,                        
 [DDNO] [VARCHAR] (15) NULL ,                        
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                        
 [LONGNAME] [VARCHAR] (100) NULL ,                        
 [VDT] [DATETIME] NULL ,                        
 [VTYP] [SMALLINT] NOT NULL ,                        
 [ACCAT] [CHAR] (2) NULL ,                        
 [OPBAL] [MONEY] NOT NULL ,                        
 [CROSAC] [VARCHAR] (10) NOT NULL ,                        
 [ACNAME] [VARCHAR] (100) NULL ,                        
 [BRANCHCODE] [VARCHAR] (35) NULL ,                        
 [LNO] [INT] NULL,    
 [REPDATE] [VARCHAR] (8) NULL ,                        
 [MAINCODE] [VARCHAR] (10) NULL ,                        
 [VCHDT] [DATETIME] NULL,
 [EDIFF] INT NULL
)                        
                        
                          
--DELETE #TBL_GLREPORT WHERE PROCID = @@SPID                                        
      
SELECT @@COSTCODE = -1      
  
IF @STATUSID <> 'BROKER'      
 BEGIN      
  SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME       
 END      
ELSE IF @STATUSID = 'BROKER'      
 BEGIN      
  IF @BRANCH <> '' OR @BRANCH <> '%'      
   BEGIN      
    SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH       
   END      
 END      
    
SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)            


CREATE TABLE #FORMULA_CLIENT_MASTER
(
	CLTCODE VARCHAR(10)
)

INSERT INTO #FORMULA_CLIENT_MASTER 
SELECT CLTCODE FROM ACMAST WHERE CLTCODE BETWEEN @FCODE AND @TCODE AND ACCAT = CASE WHEN @REPORT_TYPE = 'BANK' THEN 2 ELSE CASE WHEN @REPORT_TYPE = 'CASH' THEN 1 ELSE 3 END END

/* GET OPNING BALANCE */
IF @SELECTIONBY = 'VDT'
BEGIN
	IF @STATUSID = 'BROKER'      
	BEGIN
		--INSERT INTO #GL_OPBAL
		EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FDATE, @TDATE, '', 'VDTBAL_OPBAL', 'NSE', 'CAPITAL', 'M.CLTCODE', '', '#GL_OPBAL'
		
	END
	ELSE
	BEGIN
		INSERT INTO #GL_OPBAL
		EXEC CLS_GET_ACC_LEDGER2_FORMULA_BALANCES @FDATE, @TDATE, '', 'VDTBAL_OPBAL', 'NSE', 'CAPITAL', 'M.CLTCODE', ''
	END
END

ELSE
BEGIN
	IF @STATUSID = 'BROKER'      
	BEGIN
		--INSERT INTO #GL_OPBAL
		EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FDATE, @TDATE, '', 'EDTBAL_OPBAL', 'NSE', 'CAPITAL', 'M.CLTCODE', '', '#GL_OPBAL'
	END
	ELSE
	BEGIN
		INSERT INTO #GL_OPBAL
		EXEC CLS_GET_ACC_LEDGER2_FORMULA_BALANCES @FDATE, @TDATE, '', 'VDTBAL_OPBAL', 'NSE', 'CAPITAL', 'M.CLTCODE', ''
	END
END
/* GET OPNING BALANCE */
         
/* GET THE RECORDS FROM LEDGER TABLE */      
IF @REPORT_TYPE <> 'GL'
BEGIN
     INSERT INTO #TBL_GLREPORT                        
     SELECT       
      L.BOOKTYPE,                           
      VOUDT=CONVERT(VARCHAR,L.VDT,103),       
      EFFDT=CONVERT(VARCHAR,L.EDT,103),       
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                   
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                    
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                  
      L.VNO,       
      REPLACE( L.NARRATION,'"','') NARRATION,                                                     
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                         
      L.CLTCODE ,      
      A.LONGNAME,      
      VDT,       
      L.VTYP,                                                                    
      ACCAT,       
      OPBAL=0,      
      CROSAC='',      
      A.ACNAME,      
      A.BRANCHCODE,    
      L.LNO,      
      CONVERT(VARCHAR,GETDATE(),112), '',       
      L.VDT,
      EDIFF = DATEDIFF(D, L.EDT, GETDATE())                        
     FROM       
      LEDGER L         
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                          
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                        
      --(SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                        
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE @FDATE <= CASE WHEN @SELECTIONBY = 'VDT' THEN VDT ELSE EDT END AND @TDATE + ' 23:59:59' >= CASE WHEN @SELECTIONBY = 'VDT' THEN VDT ELSE EDT END AND CLTCODE BETWEEN @FCODE AND @TCODE) LL,                 
       
      VMAST V, ACMAST A                        
     WHERE       
      L.VNO = LL.VNO                        
      AND L.VTYP = LL.VTYP                        
      AND L.BOOKTYPE = LL.BOOKTYPE                        
      AND L.CLTCODE = A.CLTCODE                        
      AND L.VTYP = V.VTYPE                        
      AND NOT EXISTS(SELECT CLTCODE FROM #FORMULA_CLIENT_MASTER F WHERE L.CLTCODE = F.CLTCODE)
      AND L.VTYP <> 18         
END               
ELSE
BEGIN
	INSERT INTO #TBL_GLREPORT                        
	SELECT                    
	   L.BOOKTYPE,                    
	   VOUDT=CONVERT(VARCHAR,L.VDT,103),       
       EFFDT=CONVERT(VARCHAR,L.EDT,103),  
	   ISNULL(SHORTDESC,'') SHORTDESC,                    
	   DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                    
	   CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                    
	   L.VNO,                    
	   REPLACE( L.NARRATION,'"','') NARRATION,                    
	   DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                    
	   L.CLTCODE,                    
	   A.LONGNAME,                    
	   VDT,                    
	   L.VTYP,                    
	   ACCAT,                    
	   OPBAL=0,                    
	   CROSAC='',                    
	 A.ACNAME,              
	   A.BRANCHCODE,                    
	   L.LNO,      
	   CONVERT(VARCHAR,GETDATE(),112), '',       
	   L.VDT,
	   EDIFF = DATEDIFF(D, L.EDT, GETDATE())                                            
	  FROM                    
	   LEDGER L,                    
	   (SELECT CLTCODE, LONGNAME, ACCAT, BRANCHCODE, ACNAME FROM ACMAST WHERE CLTCODE BETWEEN @FCODE AND @TCODE AND (ACCAT LIKE '3%'  OR ACCAT LIKE '14%'  OR ACCAT LIKE '103%')) A,                    
	   VMAST V                    
	  WHERE                    
	   L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                    
	   AND VTYP = VTYPE                    
	   AND L.CLTCODE = A.CLTCODE                    
	  /*ORDER BY                    
	   L.CLTCODE,                    
	   VOUDT1,                    
	   L.VTYP DESC,                    
	   L.VNO  */
END
/* GET THE RECORDS FROM LEDGER TABLE */
--SELECT * FROM #TBL_GLREPORT
   
/* GET THE RECORDS FROM LEDGER2 TABLE */
/*     INSERT INTO #TBL_GLREPORT                        
     SELECT       
      L.BOOKTYPE,                           
      VOUDT=CONVERT(VARCHAR,L.VDT,103),       
      EFFDT=CONVERT(VARCHAR,L.EDT,103),       
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                   
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                    
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                  
      L.VNO,       
      REPLACE( L.NARRATION,'"','') NARRATION,                                                     
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                         
      L2.CLTCODE ,      
      A.LONGNAME,      
      VDT,       
      L.VTYP,                                                                    
      ACCAT,       
      OPBAL=0,      
      CROSAC='',      
      A.ACNAME,      
      A.BRANCHCODE,    
      L.LNO,      
      CONVERT(VARCHAR,GETDATE(),112), '',       
      L.VDT,
      EDIFF = DATEDIFF(D, L.EDT, GETDATE())                        
     FROM       
      LEDGER L         
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                          
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                        
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE @FDATE <= CASE WHEN @SELECTIONBY = 'VDT' THEN VDT ELSE EDT END AND @TDATE + ' 23:59:59' >= CASE WHEN @SELECTIONBY = 'VDT' THEN VDT ELSE EDT END AND CLTCODE = @FCODE) LL,
      VMAST V, ACMAST A, LEDGER2 L2                        
     WHERE       
      L.VNO = L1.VNO                        
      AND L.VTYP = L1.VTYP                        
      AND L.BOOKTYPE = L1.BOOKTYPE                        
      AND L.VNO = L2.VNO      
      AND L.VTYP = L2.VTYPE       
      AND L.BOOKTYPE = L2.BOOKTYPE      
      AND L.LNO = L2.LNO      
 --     AND L.DRCR = L2.DRCR      
      AND L.VNO = LL.VNO                        
      AND L.VTYP = LL.VTYP                        
      AND L.BOOKTYPE = LL.BOOKTYPE                        
      AND L2.CLTCODE = A.CLTCODE                        
      AND L.VTYP = V.VTYPE                        
      AND L2.CLTCODE <> @FCODE                        
      AND L2.COSTCODE = @@COSTCODE      
      AND L.VTYP <> 18        */
/* GET THE RECORDS FROM LEDGER2 TABLE */      
      
      

 
UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION)

IF @REPORT_TYPE <> 'GL'
BEGIN
	UPDATE #TBL_GLREPORT SET OPBAL = O.OPBAL,CROSAC=''  FROM #GL_OPBAL O                        
	WHERE O.CLTCODE = @FCODE 
	
	UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE 
	UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE 
END
ELSE
BEGIN
	UPDATE #TBL_GLREPORT SET OPBAL = O.OPBAL,CROSAC=''  FROM #GL_OPBAL O                        
	WHERE O.CLTCODE = #TBL_GLREPORT.CLTCODE
	
	INSERT INTO #TBL_GLREPORT 
	SELECT 
		'','','','OPBAL',CASE WHEN OPBAL > 0 THEN OPBAL ELSE 0 END, CASE WHEN OPBAL <= 0 THEN ABS(OPBAL) ELSE 0 END,'','OPENING BALANCE','',CLTCODE,'','',0,'',OPBAL,CLTCODE,'','','',CONVERT(VARCHAR,GETDATE(),112), '', '', 0                        
	FROM #GL_OPBAL 
END

UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE 
                    
INSERT INTO #TBL_GLREPORT SELECT '','','','OPBAL',0,0,'','OPENING BALANCE','',CLTCODE,'','',0,'',0,CLTCODE,'','','',CONVERT(VARCHAR,GETDATE(),112), '', '', 0                        
FROM #GL_OPBAL WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT)                            
                
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0 AND NARRATION <> 'OPENING BALANCE'             
    
UPDATE #TBL_GLREPORT SET BRANCHCODE = COSTNAME FROM LEDGER2 L2, COSTMAST C    
WHERE #TBL_GLREPORT.VNO = L2.VNO AND #TBL_GLREPORT.VTYP = L2.VTYPE AND #TBL_GLREPORT.BOOKTYPE = L2.BOOKTYPE AND #TBL_GLREPORT.LNO = L2.LNO AND #TBL_GLREPORT.CROSAC = L2.CLTCODE    
AND L2.COSTCODE = C.COSTCODE    
                        
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                        
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                        
SELECT       
      BOOKTYPE,      
      VOUDT VDT ,      
      EFFDT EDT ,      
      SHORTDESC,      
      DRAMT DEBIT,      
      CRAMT CREDIT,      
      VNO,      
      NARRATION,      
      DDNO,      
      CLTCODE,       
      LONGNAME,      
      VTYP,      
      ACCAT,      
      OPBAL,      
      CROSAC,      
      ACNAME,      
      BRANCHCODE,    
	  VCHDT,
	  EDIFF
FROM       
      #TBL_GLREPORT        
ORDER BY       
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_GLLEDGER
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CLS_GLLEDGER]
	@FR_DATE VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@VDT VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@FROM_GL_CODE VARCHAR(10),
	@TO_GL_CODE VARCHAR(10),
	@VIEWOPTION VARCHAR(10),
	@STATUSID VARCHAR(20), /* AS BROKER/BRANCH/CLIENT ETC. */
	@STATUSNAME VARCHAR(20), /* IN CASE OF BRANCH LOGIN BRANCHCODE */
	@SORTBYDATE VARCHAR(3), /* WHETHER REPORT IS BASED ON VDT OR EDT */
	@SHOWZEROBAL VARCHAR(1) = 'N', /* SHOW ZERO BAL   */
	@GRPCODE VARCHAR(20),
	@SHAREDB VARCHAR(20),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(9),
	@TABLE_NAME VARCHAR(100),
	@BRANCHCODE VARCHAR(10) = '',
	@WITHOPENING BIT = 0,
	@SORT_BY VARCHAR(10) = 'ACCODE',
	@SHOW_MARGIN CHAR(1) = 'N'
AS

CREATE TABLE #FORMULA_CLIENT_MASTER
(
	CLTCODE VARCHAR(10) NOT NULL
)

ALTER TABLE #FORMULA_CLIENT_MASTER
 ADD PRIMARY KEY (CLTCODE)

DECLARE @@COSTCODE AS INT,
	@@SQL AS VARCHAR(1000)


CREATE TABLE #COSTMAST (COSTCODE INT, COSTNAME VARCHAR(100))

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE ,COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.REGION R WHERE REGIONCODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE ,COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.AREA A WHERE AREACODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE ,COSTNAME FROM COSTMAST WHERE COSTNAME = RTRIM('" + @STATUSNAME + "') "
	
	EXEC (@@SQL)
END


--select * into sureshhh from COSTMAST

CREATE TABLE #TB
(
	CLTCODE VARCHAR(10),
	AMOUNT MONEY
)

IF @WITHOPENING = 1
BEGIN
	ALTER TABLE #TB
	ADD
		OPENING_AMOUNT MONEY,
		PERIOD_CREDIT MONEY,
		PERIOD_DEBIT MONEY
END

DECLARE
	@AMOUNT_PARAMETER VARCHAR(200),
	@NET_AMOUNT_PARAMETER VARCHAR(200),
	@DISPLAY_AMOUNT VARCHAR(300)
	
IF UPPER(@SORTBYDATE) = 'VDT'
BEGIN
	SET @NET_AMOUNT_PARAMETER = 'VDTBAL = SUM(VDTBAL)'
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL'
		SET @DISPLAY_AMOUNT = '-AMOUNT'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL,VDTBAL_OPBAL, VDTBAL_DATES_CREDIT, VDTBAL_DATES_DEBIT'
		SET @DISPLAY_AMOUNT = ' -AMOUNT,-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT'
	END
END
ELSE
BEGIN
	SET @NET_AMOUNT_PARAMETER = 'EDTBAL = SUM(EDTBAL)'
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL'
		SET @DISPLAY_AMOUNT = '-AMOUNT'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL, EDTBAL_OPBAL, EDTBAL_DATES_CREDIT, EDTBAL_DATES_DEBIT'
		SET @DISPLAY_AMOUNT = '-AMOUNT,-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT'
	END
END


SET @@SQL = "INSERT INTO #FORMULA_CLIENT_MASTER "
SET @@SQL = @@SQL + "SELECT CLTCODE "
SET @@SQL = @@SQL + "FROM ACMAST A "
SET @@SQL = @@SQL + "WHERE CLTCODE >= '" + @FROM_GL_CODE + "' AND CLTCODE <= '" + @TO_GL_CODE + "'"
IF UPPER(@VIEWOPTION) = 'GL'
	SET @@SQL = @@SQL + " AND ACCAT = 3 "
ELSE IF UPPER(@VIEWOPTION) = 'BANK'
	SET @@SQL = @@SQL + " AND ACCAT = 2 "	
ELSE IF UPPER(@VIEWOPTION) = 'CASH'
	SET @@SQL = @@SQL + " AND ACCAT = 1 "	
IF UPPER(@STATUSID) <> 'BROKER'
	SET @@SQL = @@SQL + "AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE COSTNAME = BRANCHCODE) "

print @@SQL
EXEC(@@SQL)	


IF UPPER(@STATUSID) = 'BROKER'
BEGIN

	INSERT INTO #TB
	EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE = ''''', ''
END
ELSE
BEGIN
	INSERT INTO #TB
	EXEC CLS_GET_LEDGER2_FORMULA_BALANCES @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE = ''''', ''
END

DROP TABLE #FORMULA_CLIENT_MASTER

SET @@SQL = "INSERT INTO ACCOUNT.." + @TABLE_NAME
SET @@SQL = @@SQL + " SELECT TB.CLTCODE, ACNAME, BRANCHCODE,	'" + @EXCHANGE + "','" +  @SEGMENT + "', " + @DISPLAY_AMOUNT + ", ACCAT, A.GRPCODE, GRPNAME "
SET @@SQL = @@SQL + "FROM "
SET @@SQL = @@SQL + "	#TB TB , ACMAST A, GRPMAST G "
SET @@SQL = @@SQL + "WHERE A.GRPCODE = G.GRPCODE AND TB.CLTCODE = A.CLTCODE "
/*SET @@SQL = @@SQL + "UNION "
SET @@SQL = @@SQL + "SELECT CLTCODE, ACNAME = 'PARTY TOTAL', BRANCHCODE = '', -AMOUNT, 0,	'" + @EXCHANGE + "','" +  @SEGMENT + "', '', '' "
SET @@SQL = @@SQL + "FROM #TB WHERE CLTCODE = '' AND ISNULL(AMOUNT, 0) <> 0 "*/
PRINT @@SQL
EXEC(@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_BANK_FILEUPLOAD_LOGS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_BANK_FILEUPLOAD_LOGS] (
  @UPLOADID         NVARCHAR(50)
, @SEGMENT        NVARCHAR(50)
, @BANKCODE       NVARCHAR(50)
, @BANKNAME       NVARCHAR(50)
, @FILETYPE       NVARCHAR(50)
, @BANKACCOUNT    NVARCHAR(100)
, @UPLOADFILENAME NVARCHAR(150)
, @UPLOADEDDATE   NVARCHAR(50)
, @MODIFIEDDATE   NVARCHAR(50)
, @UPLOAD_FLAG CHAR(1) = 'N'
, @FILE_PATH VARCHAR(500) = ''
, @UNAME VARCHAR(50)=''
, @REPROCESS_FLAG CHAR(1)
, @UPLOADDATE NVARCHAR(25)
)
AS
BEGIN
		DECLARE @@SQL           VARCHAR(MAX),
				@@ACCOUNTDB     VARCHAR(20),
				@@ACCOUNTSERVER VARCHAR(20),
				@COMBINEFILE NVARCHAR(2)
				
	SELECT @UPLOADEDDATE = CONVERT(DATETIME,CONVERT(VARCHAR(11),GETDATE(),101))--CONVERT(DATETIME, @UPLOADEDDATE, 103)
	SELECT @MODIFIEDDATE = CONVERT(DATETIME,CONVERT(VARCHAR(11),GETDATE(),101))--CONVERT(DATETIME, @MODIFIEDDATE, 103)
	--SELECT @UPLOADEDDATE,@MODIFIEDDATE,'P' RETURN
	
	IF(@BANKCODE='')
	SET @BANKCODE='0'
	IF(@BANKACCOUNT='')
	SET @BANKACCOUNT='0'
	
	IF(ISNULL(@BANKCODE,'0')='0' AND ISNULL(@BANKACCOUNT,'0')='0' AND @REPROCESS_FLAG='N' )
	SET @COMBINEFILE='0'
	ELSE
	SET @COMBINEFILE='1'
		
	SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER
	FROM PRADNYA.DBO.MULTICOMPANY WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
	AND PRIMARYSERVER = 1

IF (@BANKNAME = 'YES BANK' AND @FILETYPE = 'NON-CMS') AND @SEGMENT <> 'NSE-CAPITAL' 
BEGIN
SET @@SQL = "INSERT INTO " + @@ACCOUNTSERVER + ".MSAJAG.DBO.FILEDATA (PROGID,	FILE_DATA,	UPLOADDATETIME,	UPLOADBY) "
SET @@SQL = @@SQL + " SELECT  PROGID,	FILE_DATA,	UPLOADDATETIME,	UPLOADBY FROM MSAJAG.DBO.FILEDATA WHERE PROGID = '" + @UPLOADID + "'"

EXEC (@@SQL)

SET @@SQL = " EXEC " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".DBO.CLS_RECON_BANK_FILEUPLOAD_LOGS "
SET @@SQL = @@SQL + "'" + @UPLOADID + "'"
SET @@SQL = @@SQL + ",'" + @SEGMENT + "'"
SET @@SQL = @@SQL + ",'" + @BANKCODE + "'"
SET @@SQL = @@SQL + ",'" + @BANKNAME + "'"
SET @@SQL = @@SQL + ",'" + @FILETYPE + "'"
SET @@SQL = @@SQL + ",'" + @BANKACCOUNT + "'"
SET @@SQL = @@SQL + ",'" + @UPLOADFILENAME + "'"
SET @@SQL = @@SQL + ",'" + @UPLOADEDDATE + "'"
SET @@SQL = @@SQL + ",'" + @MODIFIEDDATE + "'"
SET @@SQL = @@SQL + ",'" + @UPLOAD_FLAG + "'"
SET @@SQL = @@SQL + ",'" + @FILE_PATH + "'"
SET @@SQL = @@SQL + ",'" + @UNAME + "'"
SET @@SQL = @@SQL + ",'" + @REPROCESS_FLAG + "'"
SET @@SQL = @@SQL + ",'" + @UPLOADDATE + "'"

EXEC (@@SQL)

RETURN
END


DECLARE @PROCESS NVARCHAR(1)
SET @PROCESS = 'N'

CREATE TABLE #TEMP(FILE_DATA VARCHAR(MAX))

IF NOT EXISTS(SELECT * FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE  FILETYPE=@FILETYPE
AND BANKNAME=@BANKNAME AND UPLOADFILENAME=@UPLOADFILENAME)
BEGIN
	INSERT INTO RECON_BANK_UPLOAD_PROCESS_INFO (UPLOADID, SEGMENT, BANKCODE
	, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
	, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
	VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', 
	@UNAME, GETDATE(), GETDATE(), GETDATE())

IF (@REPROCESS_FLAG <> 'R') 
BEGIN
--SELECT 'SS',@COMBINEFILE RETURN
IF(@COMBINEFILE<>'0') 
BEGIN
	IF (CHARINDEX(@BANKACCOUNT, @UPLOADFILENAME) = 1)
	BEGIN
	
	IF( @UPLOAD_FLAG <> 'B' )
			BEGIN
			
				--IF ((@BANKNAME = 'HDFC BANK') OR (@BANKNAME = 'YES BANK' AND @FILETYPE = 'NON-CMS')OR (@BANKNAME = 'KOTAK BANK') ) 
				IF(@COMBINEFILE<>'0')
				BEGIN	
									
								SET @PROCESS = 'Y'
								INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE
								, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
								, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
								 VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', @UNAME, GETDATE(), GETDATE(), GETDATE())
							
				END 
				ELSE 
				--IF ((@BANKNAME = 'YES BANK' AND @FILETYPE = 'CMS') OR @BANKNAME = 'STANDARD CHARTERED BANK') 
				IF(@COMBINEFILE='0')
					BEGIN
					
						SET @PROCESS = 'Y'
						INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
						VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', @UNAME, GETDATE(), GETDATE(), GETDATE())
					END
				END
		ELSE
			BEGIN
				
				IF(@SEGMENT='NSE-CAPITAL')
				BEGIN
				DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
				END

				DECLARE @CMD VARCHAR(MAX),@FILENAME NVARCHAR(MAX)
				SET @CMD = LOWER(' BULK INSERT #TEMP FROM ''' + @FILE_PATH + ''' WITH  (ROWTERMINATOR = ''0X0A'',FIELDTERMINATOR = ''~'') ')
				EXEC (@CMD)

				SET @@SQL = ''
				SET @@SQL = "INSERT INTO " + @@ACCOUNTSERVER + ".MSAJAG.DBO.FILEDATA (PROGID,	FILE_DATA,	UPLOADDATETIME,	UPLOADBY)
				SELECT  '" + @UPLOADID + "'
				, FILE_DATA
				, GETDATE() 
				, '" + @UNAME + "'
				FROM   #TEMP "

				EXEC (@@SQL)
				--PRINT @@SQL

				SET @@SQL = ''
				SET @@SQL = "INSERT INTO " +
				+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_BANK_FILEUPLOAD_LOGS(UPLOADID, SEGMENT, BANKCODE
				, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
				, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
				VALUES('" + @UPLOADID + "',"
				+ "'" + @SEGMENT + "',"
				+ "'" + @BANKCODE + "',"
				+ "'" + @BANKNAME + "',"
				+ "'" + @FILETYPE + "',"
				+ "'" + @BANKACCOUNT + "',"
				+ "'" + @UPLOADFILENAME + "',"
				+ "CONVERT (DATETIME,GETDATE() ,103),"
				+ "'SUCCESS'" + ","
				+ "'" + @UNAME + "',"
				+ "CONVERT (DATETIME,GETDATE() ,103),"
				+ "CONVERT (DATETIME,GETDATE() ,103),"
				+ "CONVERT (DATETIME,GETDATE() ,103))"

				EXEC (@@SQL)
				PRINT @@SQL
				SET @UPLOAD_FLAG='N'

				SET @@SQL = ''
				SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
				+ ".DBO.CLS_RECON_BANK_FILEUPLOAD_LOGS '" + @UPLOADID + "','" + @SEGMENT + "','" + @BANKCODE + "','" + @BANKNAME + "','"
				+ @FILETYPE + "','" + @BANKACCOUNT + "','" 
				+ @UPLOADFILENAME + "','" 
				+ @UploadedDate + "','" 
				+ @MODIFIEDDATE + "','" 
				+@UPLOAD_FLAG + "','" 
				+@FILE_PATH + "','" +@UNAME + "','" + @REPROCESS_FLAG + "','" + @UPLOADDATE + "'"
				
				EXEC (@@SQL)
				PRINT @@SQL	
				SET @PROCESS = 'Y'
				RETURN
			END
		END 
		ELSE
 
		BEGIN
			--DELETE FROM MSAJAG..FILEDATA	WHERE PROGID = @UPLOADID
			SELECT		'YOU HAVE SELECTED WRONG SEGMENT FILE'
			DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
			RETURN
		END
	END
	ELSE
	
		IF (@COMBINEFILE=0) 
		BEGIN
		
		SET @PROCESS = 'Y'
		INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
		VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'FAIL', @UNAME, GETDATE(), GETDATE(), GETDATE())
		

		IF ((@PROCESS = 'Y' OR @REPROCESS_FLAG = 'N' ) AND @UPLOAD_FLAG = 'B' )	
		BEGIN
				SET @CMD = LOWER(' BULK INSERT #TEMP FROM ''' + @FILE_PATH + ''' WITH  (ROWTERMINATOR = ''0X0A'',FIELDTERMINATOR = ''~'') ')
				EXEC (@CMD)

				SET @@SQL = ''
				SET @@SQL = "INSERT INTO " + @@ACCOUNTSERVER + ".MSAJAG.DBO.FILEDATA (PROGID,	FILE_DATA,	UPLOADDATETIME,	UPLOADBY)
				SELECT  '" + @UPLOADID + "'
				, FILE_DATA
				, GETDATE() 
				, '" + @UNAME + "'
				FROM   #TEMP "

				EXEC (@@SQL)
				PRINT @@SQL

				EXEC CLS_RECON_INSERT_PROCESS	@UPLOADID,@FILETYPE,@BANKNAME,@UPLOAD_FLAG,@REPROCESS_FLAG,@UPLOADDATE,@BANKCODE,@BANKACCOUNT,@SEGMENT,@UNAME,@FILE_PATH,@COMBINEFILE,@UPLOADFILENAME
		END
	END
END

IF (@PROCESS = 'Y'  AND @UPLOAD_FLAG <> 'B' )
BEGIN

EXEC CLS_RECON_INSERT_PROCESS	@UPLOADID,@FILETYPE,@BANKNAME,@UPLOAD_FLAG,@REPROCESS_FLAG,@UPLOADDATE,@BANKCODE,@BANKACCOUNT,@SEGMENT,@UNAME,@FILE_PATH,@COMBINEFILE,@UPLOADFILENAME
END
END

ELSE
	BEGIN 
	SELECT 'FILE YOU TRY TO UPLOAD IS ALREADY IN PROCESS PLEASE WAIT ...' 
	--DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	RETURN
	END
IF( @REPROCESS_FLAG = 'R' )
BEGIN

--SELECT @PROCESS,@UPLOAD_FLAG,@REPROCESS_FLAG RETURN
DECLARE @TEMPREPROCESS TABLE(Report_Name NVARCHAR(500))
DECLARE @TEMPBANKMASTER TABLE(
SEGMENT NVARCHAR(50),
BANKNAME NVARCHAR(50),
BANKCODE NVARCHAR(50),
BANKACCOUNT NVARCHAR(50),
FILETYPE NVARCHAR(50))

INSERT INTO @TEMPBANKMASTER (SEGMENT,BANKNAME,BANKCODE,BANKACCOUNT,FILETYPE)
SELECT SEGMENT,BANKNAME,BANKCODE,BANKACCOUNT,FILETYPE FROM RECON_BANK_MASTER(NOLOCK) 
WHERE BANKNAME=@BANKNAME AND FILETYPE<>'ENCRYPTION'

DECLARE @MBANKACCOUNT NVARCHAR(50)

--SELECT * FROM @TEMPBANKMASTER
	WHILE (SELECT COUNT(*)	FROM @TEMPBANKMASTER)> 0 
	BEGIN

		SET @SEGMENT = ''
		SET @BANKNAME=''		
		SET @BANKCODE = ''
		SET @MBANKACCOUNT = ''
		SET @FILETYPE=''
		SET @@ACCOUNTDB = ''
		SET @@ACCOUNTSERVER = ''

		SELECT TOP 1 @SEGMENT=SEGMENT,@BANKNAME=BANKNAME,@BANKCODE=BANKCODE,@MBANKACCOUNT=BANKACCOUNT,@FILETYPE=FILETYPE FROM @TEMPBANKMASTER


		SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER FROM PRADNYA.DBO.MULTICOMPANY
		WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT	AND PRIMARYSERVER = 1

		--EXEC CLS_RECON_INSERT_PROCESS	@UPLOADID,@FILETYPE,@BANKNAME,@UPLOAD_FLAG,@REPROCESS_FLAG,@UPLOADDATE,@BANKCODE,@SEGMENT
		
			SET @@SQL = ''
			SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
			+ ".DBO.CLS_RECON_INSERT_PROCESS '"	+ @UPLOADID + "','" + @FILETYPE + "','" + @BANKNAME + "','" + @UPLOAD_FLAG + "','"+ @REPROCESS_FLAG + "','" 
			+ @UPLOADDATE + "','" + @BANKCODE + "','"+ @BANKACCOUNT + "','" + @SEGMENT 	+ "','" + @UNAME 	+ "','" + @FILE_PATH	+ "','" + @COMBINEFILE	+ "','" 
			+ @UPLOADFILENAME + "'"
			INSERT INTO @TEMPREPROCESS (Report_Name)
			EXEC (@@SQL)
			PRINT @@SQL
			
			DECLARE @@ERRORVALUE NVARCHAR(MAX),@SPNAME NVARCHAR(50)
			
			SET @@SQL=''
			SET @@ERRORVALUE=''
			SET @@ERRORVALUE=@@SQL
			
			/*SET @SPNAME='CLS_RECON_INSERT_PROCESS'
			SET @@SQL = ''
			SET @@SQL = "INSERT INTO " +
			+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_LOGS(SERVERNAME,DATABASENAME,USERNAME,LOGDATE,ERRORLOGS,SOURCENAME)
			VALUES('" + @@ACCOUNTSERVER + "',"
			+ "'" + @@ACCOUNTDB + "',"
			+ "'" + @UNAME + "',"
			+ "'" + @UPLOADDATE + "',"
			+ "'" + @@ERRORVALUE + "',"
			+ "'" + @SPNAME + "')"
			SET @SPNAME=''
			
			--EXEC (@@SQL)			
			PRINT @@SQL*/
			
			--SELECT @SEGMENT,@BANKNAME,@BANKCODE,@MBANKACCOUNT,@FILETYPE
			
			DELETE FROM @TEMPBANKMASTER WHERE
			SEGMENT=ISNULL(@SEGMENT,'')	
			AND BANKNAME=ISNULL(@BANKNAME,'')								
			AND BANKCODE=ISNULL(@BANKCODE,'')			
			AND BANKACCOUNT=ISNULL(@MBANKACCOUNT,'')
			AND FILETYPE=ISNULL(@FILETYPE,'')
	END
	--SELECT TOP 1 * FROM @TEMPREPROCESS
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_BULKUPLOAD_ENCRYPTION_FILES
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_BULKUPLOAD_ENCRYPTION_FILES]
(
@UPLOADID NVARCHAR(50),
@SEGMENT NVARCHAR(50),
@BANKCODE NVARCHAR(50),
@BANKNAME NVARCHAR(50),
@FILETYPE NVARCHAR(50),
@BANKACCOUNT NVARCHAR(50),
@UPLOADFILENAME NVARCHAR(200),
@FILEPATH NVARCHAR(200),
@UPLOADBY NVARCHAR(50),
@UPLOAD_FLAG NVARCHAR(20)
)
AS
BEGIN
DECLARE @@ENCRYPTIONCODE NVARCHAR(50)

SELECT @@ENCRYPTIONCODE=ENCRYPTIONCODE FROM RECON_BANK_MASTER_VW WHERE SEGMENT=@SEGMENT
AND BANKCODE=@BANKCODE
AND FILETYPE=@FILETYPE
AND BANKACCOUNT=@BANKACCOUNT 

IF (CHARINDEX(@@ENCRYPTIONCODE, @UPLOADFILENAME) = 1) 
BEGIN
IF(@UPLOAD_FLAG='B')
	BEGIN
		CREATE TABLE #TEMP
		(
			FILE_DATA VARCHAR(MAX)
		)
		
		DECLARE @CMD VARCHAR(MAX),@FILENAME NVARCHAR(MAX)
		SET @CMD = LOWER(' BULK INSERT #TEMP FROM ''' + @FILEPATH + ''' WITH  (ROWTERMINATOR = ''0X0A'',FIELDTERMINATOR = ''~'') ')
		EXEC (@CMD)

			INSERT INTO MSAJAG.DBO.FILEDATA
			SELECT	@UPLOADID,FILE_DATA,GETDATE(),@UPLOADBY FROM #TEMP

			EXEC CLS_RECON_ENCRYPTFILE_PROCESS @UPLOADID,@SEGMENT,@BANKCODE,@BANKNAME,@FILETYPE,@BANKACCOUNT,@UPLOADFILENAME
			,@FILEPATH,@UPLOADBY,@UPLOAD_FLAG

			INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE
			, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
			, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
			VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'Success', @UPLOADBY, GETDATE(), GETDATE(), GETDATE())

			SELECT 'UPLOAD SUCCESSFULLY'
	END

	IF(@UPLOAD_FLAG='NORMAL')
	BEGIN
	DECLARE @SEP VARCHAR(1)
	SET @SEP = ''	

			EXEC CLS_RECON_ENCRYPTFILE_PROCESS @UPLOADID,@SEGMENT,@BANKCODE,@BANKNAME,@FILETYPE,@BANKACCOUNT,@UPLOADFILENAME
			,@FILEPATH,@UPLOADBY,@UPLOAD_FLAG

			INSERT INTO RECON_BANK_FILEUPLOAD_LOGS (UPLOADID, SEGMENT, BANKCODE
			, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS
			, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE)
			VALUES (@UPLOADID, @SEGMENT, @BANKCODE, @BANKNAME, @FILETYPE, @BANKACCOUNT, @UPLOADFILENAME, GETDATE(), 'Success', @UPLOADBY, GETDATE(), GETDATE(), GETDATE())

			SELECT 'UPLOAD SUCCESSFULLY'
	END
 END
 ELSE
 BEGIN
 SELECT 'YOU HAVE SELECTED WORNG SEGMENT FILE'

 END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_BULKUPLOD_FILES
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_RECON_BULKUPLOD_FILES]
(@UPLOADID NVARCHAR(25),
@FILENAME NVARCHAR(MAX),
@UPLOADBY NVARCHAR(100),
@SEGMENT NVARCHAR(50),
@COMBINEFILE NVARCHAR(2)
)

AS 
BEGIN

CREATE TABLE #TEMP
(
	FILE_DATA VARCHAR(MAX)
)
DECLARE @CMD VARCHAR(MAX)

SET @CMD = LOWER(' BULK INSERT #TEMP FROM ''' + @FILENAME + ''' WITH  (ROWTERMINATOR = ''0X0A'',FIELDTERMINATOR = ''~'') ')
EXEC (@CMD)
PRINT (@CMD)

IF(@COMBINEFILE='0')
BEGIN
	DECLARE @@SQL    VARCHAR(MAX),
			@@ACCOUNTDB     VARCHAR(20),
			@@ACCOUNTSERVER VARCHAR(20)

	SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER
	FROM PRADNYA.DBO.MULTICOMPANY
	WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
	AND PRIMARYSERVER = 1

	BEGIN TRY
		SET @@SQL = ''
		SET @@SQL = "INSERT INTO " +@@ACCOUNTSERVER + ".MSAJAG.DBO.FILEDATA (PROGID,	FILE_DATA,	UploadDateTime,	UploadBy)
												SELECT  '" + @UPLOADID + "'
												, FILE_DATA
												, GETDATE() 
												, '" + @UPLOADBY + "'
												FROM   #TEMP "

		EXEC (@@SQL)
		PRINT (@@SQL)
	END TRY
	BEGIN CATCH
		SELECT 'YOU HAVE NOT SELECTED COMBINE FILE CHECK BOX'
		RETURN;
	END CATCH
	
END
ELSE
BEGIN
INSERT INTO MSAJAG.DBO.FILEDATA
	SELECT
		@UPLOADID
		,FILE_DATA
		,GETDATE()
		,@UPLOADBY
	FROM #TEMP
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CHECK_TABLE
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_CHECK_TABLE] (
@SQLQUERY NVARCHAR(3000) ) 
AS
BEGIN

EXEC(@SQLQUERY)

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_HDFC_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_CMS_HDFC_PROCESS] (
@UPLOADID NVARCHAR(50),@BANKCODE NVARCHAR(20) ) 
AS
BEGIN


INSERT INTO #CMS_DATA
	SELECT
		U.UPLOADID
		, @BANKCODE BANKCODE
		,RTRIM(LTRIM(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1))) ROWTYPE
		--,RTRIM(LTRIM(CONVERT(DATETIME, RIGHT(.DBO.PIECE(F.FILE_DATA, ',', 6), 4) + SUBSTRING(.DBO.PIECE(F.FILE_DATA, ',', 6), 3, 2) + LEFT(.DBO.PIECE(F.FILE_DATA, ',', 6), 2), 112))) VALUEDATE
		,RTRIM(LTRIM(CONVERT(DATETIME, RIGHT(.DBO.PIECE(F.FILE_DATA, ',', 6), 4) --year
		+ SUBSTRING(RIGHT(.DBO.PIECE(F.FILE_DATA, ',', 6), 6), 1, 2) + --month
		CASE WHEN LEN(.DBO.PIECE(F.FILE_DATA, ',', 6))=8 THEN LEFT(.DBO.PIECE(F.FILE_DATA, ',', 6), 2) ELSE --date
		LEFT(STUFF(.DBO.PIECE(F.FILE_DATA, ',', 6),1,0,'0'), 2) END, 112))) VALUEDATE
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 4))) DRCR
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 18))) INST_NO_CHECK
		,RTRIM(LTRIM(CAST(.DBO.PIECE(F.FILE_DATA, ',', 5) AS DECIMAL(20, 2)))) AS INST_AMT
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 10))) DRAWER_NAME
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(F.FILE_DATA, ',', 26), ' ', ''))) CLTCODE
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 24))) CLTACCNO
		,''
		,''
		,''
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND FILE_DATA <> ''
	AND.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1) = 'D'

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_ICICI_PROCESS
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CLS_RECON_CMS_ICICI_PROCESS] ( @UPLOADID NVARCHAR(50),@BANKCODE NVARCHAR(50) ) 
AS
BEGIN
          

	INSERT INTO #CMS_DATA
	SELECT
	U.UPLOADID
	,@BANKCODE BANKCODE
	,RTRIM(LTRIM(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), '|', 1))) ROWTYPE
	,CONVERT(DATETIME, DBO.PIECE(FILE_DATA, '|', 6), 105) AS VALUEDATE
	,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, '|', 4))) DRCR
	,RTRIM(LTRIM(DBO.PIECE(FILE_DATA, '|', 17))) INST_NO_CHECK
	,RTRIM(LTRIM(CAST(.DBO.PIECE(F.FILE_DATA, '|', 20) AS DECIMAL(20, 2)))) AS INST_AMT
	,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, '|', 27))) DRAWER_NAME
	,RTRIM(LTRIM(REPLACE(.DBO.PIECE(F.FILE_DATA, '|', 24), ' ', ''))) CLTCODE
	,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, '|', 28))) CLTACCNO
	,''
	,''
	,''
	,0
	,U.UPLOADSTATUS
	,U.FILEUPLOAD_SDATE
	,GETDATE()
	,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND FILE_DATA <> ''	
	AND RTRIM(LTRIM(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), '|', 1)))<>'ROW_TYPE'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_IDFC_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_CMS_IDFC_PROCESS] (

@UPLOADID NVARCHAR(50) 
,@UPLOAD_FLAG NVARCHAR(1)
,@BANKCODE NVARCHAR(20))

AS

BEGIN
INSERT INTO #CMS_DATA

SELECT
			RTRIM(LTRIM(U.UPLOADID))
			,RTRIM(LTRIM(@BANKCODE)) AS BANKCODE
			,REPLACE(REPLACE(RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',1) )), CHAR(13), ''), CHAR(10), '') AS ROWTYPE
			,RTRIM(LTRIM(CONVERT(DATETIME,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',4) )),  105))) AS VALUEDATE
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',2) )) AS DRCR
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',5) )) AS INST_NO_CHECK
			,RTRIM(LTRIM(CAST(REPLACE(.DBO.Piece(FILE_DATA,'',3), '''', '') AS DECIMAL(20, 2)))) AMT
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',7))) AS DRAWER_NAME
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',8) ))  AS CLTCODE
			,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',9) )) AS CLTACC
			,'' AS VNO
			,'' AS VTYP
			,'' AS BOOKTYPE
			,0 AS MATCHEDFLAG
			,U.UPLOADSTATUS
			,U.FILEUPLOAD_SDATE
			,GETDATE()
			,F.UPLOADBY
			FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
			INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
			ON U.UPLOADID = F.PROGID
			WHERE F.PROGID = @UPLOADID
	AND RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',2) ))  <> ''


END
--SELECT REPLACE(REPLACE(RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',1) )), CHAR(13), ''), CHAR(10), '') AS 'CLIENT_CODE ' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',2) )) AS 'DEBIT_CREDIT_FLAG' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',3) )) AS 'INSTRUMENT_AMNT' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',4) )) AS 'VALUE_DATE' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',5) )) AS 'INSTRUMENT_NMBR' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',6) )) AS 'DRAWEE_BANK_DESCRIPTION' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',7) )) AS 'DRAWER_DESCRIPTION' 
----,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',8) )) AS 'CLTCODE' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',8) )) AS 'REF' 
--,RTRIM(LTRIM(.DBO.Piece(FILE_DATA,'',9) )) AS 'REM' 
--FROM  MSAJAG..FILEDATA 
--WHERE PROGID='82a91859'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_KOTAK_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_CMS_KOTAK_PROCESS] (
@UPLOADID NVARCHAR(50),@BANKCODE NVARCHAR(20) ) 
AS
BEGIN


INSERT INTO #CMS_DATA
	SELECT
		U.UPLOADID
		,@BANKCODE AS 'BANKCODE'
		,RTRIM(LTRIM(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1))) ROWTYPE
		,CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',5),105)  AS VALUEDATE
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 4))) DRCR
		,RTRIM(LTRIM(DBO.PIECE(FILE_DATA, ',', 14))) INST_NO_CHECK
		,RTRIM(LTRIM(CAST(.DBO.PIECE(F.FILE_DATA, ',', 15) AS DECIMAL(20, 2)))) AS INST_AMT
		,'' AS  'DRAWER_NAME'
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(F.FILE_DATA, ',', 32), ' ', ''))) CLTCODE
		,RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 31))) CLTACCNO
		,''
		,''
		,''
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 4))) IS NOT NULL
	AND RTRIM(LTRIM(.DBO.PIECE(F.FILE_DATA, ',', 4))) NOT IN('DEBIT_CREDIT_FLAG')

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_SBI_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_CMS_SBI_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 
AS

BEGIN

DECLARE @SRNO INT
SELECT * INTO #TEMP FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID

SELECT @SRNO=SRNO  FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID
AND FILE_DATA LIKE '%TXN DATE%'AND RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',2)))='VALUE DATE'


DELETE FROM MSAJAG..FILEDATA WHERE SRNO<=@SRNO AND PROGID=@UPLOADID

INSERT INTO #CMS_DATA
	SELECT
	U.UPLOADID
	,@BANKCODE BANKCODE
	,'' ROWTYPE
	,CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',2))) AS DATETIME ) AS 'VALUEDATE'
	,CASE WHEN RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',6)))='' THEN 'C' 
	  WHEN RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',7)))='' THEN 'D' ELSE '' END AS 'DRCR'	
	,RTRIM(LTRIM(.DBO.PIECE(.DBO.PIECE(FILE_DATA,'	',4),'/',2))) AS 'INST_NO_CHECK'
	,CASE WHEN DBO.PIECE(FILE_DATA,'	',6) ='' THEN CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',7))) AS MONEY)
	  WHEN DBO.PIECE(FILE_DATA,'	',7) ='' THEN CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',6))) AS MONEY) ELSE 0 END AS 'AMOUNT'
	,RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',3))) AS 'DRAWER_NAME'
	,'' AS 'CLTCODE'
	,'' AS 'CLTACCNO'
	,''
	,''
	,''
	,0
	,U.UPLOADSTATUS
	,U.FILEUPLOAD_SDATE
	,GETDATE()
	,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND .DBO.PIECE(FILE_DATA,'	',2) <> ''
	--SELECT * FROM #CMS_DATA RETURN
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_YES_PROCESS
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_RECON_CMS_YES_PROCESS] (
--DECLARE
@UPLOADID NVARCHAR(50) 
,@UPLOAD_FLAG NVARCHAR(1)
,@BANKCODE NVARCHAR(20))

AS
BEGIN
DECLARE @FILENAME NVARCHAR(MAX)
SELECT @FILENAME=UPLOADFILENAME FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID=@UPLOADID
IF CHARINDEX('YESCMSBUSINESS', @FILENAME)=0
BEGIN
	IF(@UPLOAD_FLAG ='B')
BEGIN
UPDATE FILEDATA_BANKRECO
SET FILE_DATA = FILE_DATA + '@'
WHERE PROGID = @UPLOADID

INSERT INTO #CMS_DATA
	SELECT
		RTRIM(LTRIM(U.UPLOADID))
		,RTRIM(LTRIM(@BANKCODE)) AS BANKCODE
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1), '''', ''))) AS ROWTYPE
		,RTRIM(LTRIM(CONVERT(DATETIME, REPLACE(.DBO.PIECE(FILE_DATA, ',', 5), '''', ''), 105))) AS VALUEDATE
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 3), '''', ''))) AS DRCR
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 15), '''', ''))) AS INST_NO_CHECK
		,RTRIM(LTRIM(CAST(REPLACE(.DBO.PIECE(FILE_DATA, ',', 4), '''', '') AS DECIMAL(20, 2)))) AMT
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 7), '''', '')))AS DRAWER_NAME
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 22), '''', ''))) AS CLIENTID
		,CASE WHEN ISNUMERIC(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))))=1 THEN RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', '')))
		ELSE SUBSTRING(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))), 0, LEN(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', '')))) - 1) END AS CLTACC
		--,SUBSTRING(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))), 0, LEN(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', '')))) - 1) AS CLTACC
		--, RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',',23),'''',''))) AS CLTACC            
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0 AS MATCHEDFLAG
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,F.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND REPLACE(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 5), '''', '') NOT IN ('VALUE_DATE', '')

END 
ELSE 
BEGIN
INSERT INTO #CMS_DATA
	SELECT
		RTRIM(LTRIM(U.UPLOADID))
		,@BANKCODE AS BANKCODE
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 1), '''', ''))) AS ROWTYPE
		,RTRIM(LTRIM(CONVERT(DATETIME, REPLACE(.DBO.PIECE(FILE_DATA, ',', 5), '''', ''), 105))) AS VALUEDATE
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 3), '''', ''))) AS DRCR
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 15), '''', ''))) AS INST_NO_CHECK
		,RTRIM(LTRIM(CAST(REPLACE(.DBO.PIECE(FILE_DATA, ',', 4), '''', '') AS DECIMAL(20, 2)))) AMT
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 7), '''', ''))) AS DRAWER_NAME
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 22), '''', ''))) AS CLIENTID
		--, SUBSTRING(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',',23),'''',''))),0,LEN(RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',',23),'''',''))))-1) AS CLTACC  
		,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))) AS CLTACC
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0 AS MATCHEDFLAG
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,F.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND REPLACE(.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), ',', 5), '''', '') NOT IN ('VALUE_DATE', '')

END

PRINT 'INSERTED TEMP TABLE'
END
ELSE
	BEGIN
	SELECT 'YOU HAVE SELECTED YESBANK_BUSINESS FILE ' 
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID			
	RETURN
	END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_CMS_YESBANK_BUSINESS_PROCESS
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[CLS_RECON_CMS_YESBANK_BUSINESS_PROCESS] (
--DECLARE
@UPLOADID NVARCHAR(50) 
,@UPLOAD_FLAG NVARCHAR(1)
,@BANKCODE NVARCHAR(20))

AS
BEGIN

DECLARE @FILENAME NVARCHAR(MAX)
SELECT @FILENAME=UPLOADFILENAME FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID=@UPLOADID
IF CHARINDEX('YESCMSBUSINESS', @FILENAME)=1
	BEGIN
	
		UPDATE MSAJAG..FILEDATA
		SET FILE_DATA =.dbo.Piece(FILE_DATA, '"', 1)
		+.dbo.Piece(FILE_DATA, '"', 2)
		+.dbo.Piece(FILE_DATA, '"', 3)
		+.dbo.Piece(FILE_DATA, '"', 4)
		+.dbo.Piece(FILE_DATA, '"', 5)
		+.dbo.Piece(FILE_DATA, '"', 6)
		+.dbo.Piece(FILE_DATA, '"', 7)
		+.dbo.Piece(FILE_DATA, '"', 8)
		+.dbo.Piece(FILE_DATA, '"', 9)
		+.dbo.Piece(FILE_DATA, '"', 10)
		+.dbo.Piece(FILE_DATA, '"', 11)
		+.dbo.Piece(FILE_DATA, '"', 12)
		+.dbo.Piece(FILE_DATA, '"', 13)
		+.dbo.Piece(FILE_DATA, '"', 14)
		+.dbo.Piece(FILE_DATA, '"', 15)
		+.dbo.Piece(FILE_DATA, '"', 16)
		+.dbo.Piece(FILE_DATA, '"', 17)
		+.dbo.Piece(FILE_DATA, '"', 18)
		+.dbo.Piece(FILE_DATA, '"', 13)
		+.dbo.Piece(FILE_DATA, '"', 20)
		+.dbo.Piece(FILE_DATA, '"', 21)
		+.dbo.Piece(FILE_DATA, '"', 22)
		+.dbo.Piece(FILE_DATA, '"', 23)
		+.dbo.Piece(FILE_DATA, '"', 24)
		+.dbo.Piece(FILE_DATA, '"', 25)
		+.dbo.Piece(FILE_DATA, '"', 26)
		+.dbo.Piece(FILE_DATA, '"', 27)
		+.dbo.Piece(FILE_DATA, '"', 28)
		+.dbo.Piece(FILE_DATA, '"', 29)
		+.dbo.Piece(FILE_DATA, '"', 30)
		+.dbo.Piece(FILE_DATA, '"', 31)
		+.dbo.Piece(FILE_DATA, '"', 32)
		+.dbo.Piece(FILE_DATA, '"', 33)
		+.dbo.Piece(FILE_DATA, '"', 34)
		+.dbo.Piece(FILE_DATA, '"', 35)
		+.dbo.Piece(FILE_DATA, '"', 36)
		+.dbo.Piece(FILE_DATA, '"', 37)
		+.dbo.Piece(FILE_DATA, '"', 38)
		+.dbo.Piece(FILE_DATA, '"', 39)
		+.dbo.Piece(FILE_DATA, '"', 40)
		+.dbo.Piece(FILE_DATA, '"', 41)
		+.dbo.Piece(FILE_DATA, '"', 42)
		+.dbo.Piece(FILE_DATA, '"', 43)
		+.dbo.Piece(FILE_DATA, '"', 44)
		+.dbo.Piece(FILE_DATA, '"', 45)
		+.dbo.Piece(FILE_DATA, '"', 46)
		WHERE PROGID = @UPLOADID
		AND .dbo.Piece(FILE_DATA,'"',1)<>''
		
			INSERT INTO #CMS_DATA
			SELECT
			RTRIM(LTRIM(U.UPLOADID))
			,RTRIM(LTRIM(@BANKCODE)) AS BANKCODE
			,RTRIM(LTRIM(REPLACE(.DBO.PIECE(REPLACE(FILE_DATA, '''', ''), ',', 2), '''', ''))) AS ROWTYPE
			,RTRIM(LTRIM(CONVERT(DATETIME, REPLACE(.DBO.PIECE(FILE_DATA, ',', 22), '''', ''), 105))) AS VALUEDATE
			,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 10), '''', ''))) AS DRCR
			,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 17), '''', ''))) AS INST_NO_CHECK
			,ABS(RTRIM(LTRIM(CAST(REPLACE(.DBO.PIECE(FILE_DATA, ',', 5), '''', '') AS DECIMAL(20, 2))))) AMT
			,RTRIM(LTRIM(REPLACE(.DBO.PIECE(FILE_DATA, ',', 23), '''', ''))) AS DRAWER_NAME
			,'' AS CLIENTID
			,'' AS CLTACC
			,'' AS VNO
			,'' AS VTYP
			,'' AS BOOKTYPE
			,0 AS MATCHEDFLAG
			,U.UPLOADSTATUS
			,U.FILEUPLOAD_SDATE
			,GETDATE()
			,F.UPLOADBY
			FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
			INNER JOIN FILEDATA_BANKRECO F (NOLOCK)
			ON U.UPLOADID = F.PROGID
			WHERE F.PROGID = @UPLOADID
			AND .dbo.Piece(FILE_DATA, ',', 1) <> ''
			AND.DBO.PIECE(FILE_DATA, ',', 22) <> 'VALUE_DATE'
			AND (.DBO.PIECE(FILE_DATA, ',', 2) LIKE '%CAP360%'
			OR.DBO.PIECE(FILE_DATA, ',', 2) LIKE '%NCDEX384%')
			

	END
	ELSE
	BEGIN
	SELECT 'FILE NAME SHOULD START WITH YESCMSBUSINESS ' 
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID			
	RETURN
	END

PRINT 'INSERTED TEMP TABLE'
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_DELETION_PROCESS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_DELETION_PROCESS]
( @UPLOADID NVARCHAR(50)
,@LOGINNAME NVARCHAR(50))
AS
BEGIN

DECLARE @BANKCODE NVARCHAR(50)
          ,@BANKACCOUNT NVARCHAR(50)
          ,@SEGMENT NVARCHAR(50)
          ,@FILETYPE NVARCHAR(50)

SELECT
	@BANKCODE = BANKCODE
	,@BANKACCOUNT = BANKACCOUNT
	,@SEGMENT = SEGMENT
	,@FILETYPE = FILETYPE
FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK)
WHERE UPLOADID = @UPLOADID





			IF(@FILETYPE='CMS')
			BEGIN

				DELETE FROM BANKRECO WHERE Dummy2=@UPLOADID

				--UPDATE L1
				--SET EDT = ''
				--FROM RECON_CMS_DATA N
				--, LEDGER L1
				--WHERE N.VNO = L1.VNO
				--AND N.VTYP = L1.VTYP
				--AND N.BOOKTYPE = L1.BOOKTYPE
				--AND N.VALUEDATE = L1.EDT
				--AND N.UPLOADID = @UPLOADID

				UPDATE L1
				SET RELDT = '' ,refno=''
				FROM RECON_CMS_DATA N
				, LEDGER1 L1
				WHERE N.VNO = L1.VNO
				AND N.VTYP = L1.VTYP
				AND N.BOOKTYPE = L1.BOOKTYPE
				AND N.VALUEDATE = L1.RELDT
				AND N.UPLOADID = @UPLOADID

				--DELETE FROM RECON_CMS_DATA	WHERE UPLOADID = @UPLOADID
				UPDATE RECON_CMS_DATA SET ROWTYPE='DR',MODIFIEDDATE=GETDATE()  
				WHERE UPLOADID = @UPLOADID

			END

			IF(@FILETYPE='NON-CMS' OR @FILETYPE='TECHPROCESS')
			BEGIN

				DELETE FROM BANKRECO WHERE Dummy2=@UPLOADID

				--UPDATE L1
				--SET EDT = ''
				--FROM RECON_NONCMS_DATA N
				--, LEDGER L1
				--WHERE N.VNO = L1.VNO
				--AND N.VTYP = L1.VTYP
				--AND N.BOOKTYPE = L1.BOOKTYPE
				--AND N.VALUEDATE = L1.EDT
				--AND N.UPLOADID = @UPLOADID

				UPDATE L1
				SET RELDT = '',refno=''
				FROM RECON_NONCMS_DATA N
				, LEDGER1 L1
				WHERE N.VNO = L1.VNO
				AND N.VTYP = L1.VTYP
				AND N.BOOKTYPE = L1.BOOKTYPE
				AND N.VALUEDATE = L1.RELDT
				AND N.UPLOADID = @UPLOADID


				UPDATE E SET MATCH_STATUS=0
				FROM RECON_ENCRYPTION_DETAILS E, Recon_NONCMS_Data RN
				WHERE E.CROSS_NO=RN.CROSS_NO
				AND RN.UPLOADID=@UPLOADID
				
				--DELETE FROM RECON_NONCMS_DATA
				--WHERE UPLOADID = @UPLOADID
				UPDATE RECON_NONCMS_DATA SET LedgerBalance='DR', ModifiedDate=GETDATE()
				WHERE UPLOADID = @UPLOADID
			END
			
			INSERT INTO RECON_BANK_DELETION_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME
			, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE ,MatchedFlag, USERNAME, PERFORMDATE)

			SELECT UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY
			, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE,0,@LOGINNAME,GETDATE()
			FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK)
			WHERE UPLOADID = @UPLOADID

			DELETE FROM RECON_BANK_FILEUPLOAD_LOGS
			WHERE UPLOADID = @UPLOADID	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_DELETION_PROCESS_WRAPPER
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_RECON_DELETION_PROCESS_WRAPPER]
( @UPLOADID NVARCHAR(50)
,@LOGINNAME NVARCHAR(50))

AS
BEGIN

		DECLARE @@ACCOUNTSERVER NVARCHAR(100),@@ACCOUNTDB NVARCHAR(100),@@SQL NVARCHAR(MAX)

		DECLARE  @TEMP_SEGMENT TABLE(SEGMENT NVARCHAR(50),FILETYPE NVARCHAR(50),ACCOUNTDB NVARCHAR(100),ACCOUNTSERVER NVARCHAR(100))

		INSERT INTO @TEMP_SEGMENT
		SELECT L.SEGMENT,L.FILETYPE,ACCOUNTDB,ACCOUNTSERVER 
		FROM RECON_BANK_FILEUPLOAD_LOGS_VW L ,ANAND1.PRADNYA.DBO.MULTICOMPANY P
		WHERE  P.EXCHANGE + '-' + P.SEGMENT=L.SEGMENT
		AND PRIMARYSERVER = 1
		AND UPLOADID=@UPLOADID


		WHILE (SELECT COUNT(*)	FROM @TEMP_SEGMENT) > 0 
		BEGIN
			SELECT TOP 1 @@ACCOUNTDB=ACCOUNTDB,@@ACCOUNTSERVER=ACCOUNTSERVER FROM @TEMP_SEGMENT

			SET @@SQL = ''
			SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".DBO.CLS_RECON_DELETION_PROCESS '" + @UPLOADID + "','" +  @LOGINNAME + "'"
			--SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".DBO.CLS_RECON_DELETION_PROCESS'"+ @UPLOADID  + "'"
			--SET @@SQL = "EXEC  " + @@ACCOUNTDB+ ".DBO.CLS_RECON_DELETION_PROCESS'"+ @UPLOADID  + "'"
			
			EXEC (@@SQL)
			print @@SQL
			DELETE FROM @TEMP_SEGMENT WHERE ACCOUNTDB=@@ACCOUNTDB
		END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_ENCRYPTFILE_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_ENCRYPTFILE_PROCESS]
(
@UPLOADID NVARCHAR(50),
@SEGMENT NVARCHAR(50),
@BANKCODE NVARCHAR(50),
@BANKNAME NVARCHAR(50),
@FILETYPE NVARCHAR(50),
@BANKACCOUNT NVARCHAR(50),
@UPLOADFILENAME NVARCHAR(200),
@FILEPATH NVARCHAR(200),
@UPLOADBY NVARCHAR(50),
@UPLOAD_FLAG NVARCHAR(20)
)
AS
BEGIN
BEGIN TRY
CREATE  TABLE #TEMP_RECON_ENCRYPTION_DETAILS(
	[ENCRY_SRNO] [INT] IDENTITY(1,1) NOT NULL,
	[ENCRY_NUMBER] [NVARCHAR](50) NULL,
	[REFERENCESNUMBER] [NVARCHAR](50) NULL,
	[INCRYPTIONDATE] [DATETIME] NULL,
	[ENCRY_DESCRIPTION] [NVARCHAR](200) NULL,
	[ENCRY_AMOUNT] [MONEY] NULL,
	[ENCRY_STATUS] [NVARCHAR](25) NULL,
	[ENCRY_CHEQUENUMBER] [NVARCHAR](25) NULL,
	[UPLOADDATE] [DATETIME] NULL,
	[UPLOADBY] [NVARCHAR](50) NULL,
	[MATCH_STATUS] [INT] NULL,
	[UPLOADTYPE] [NVARCHAR](20) NULL,
	[UPLOADID] [NVARCHAR](50))

	INSERT INTO #TEMP_RECON_ENCRYPTION_DETAILS(ENCRY_NUMBER,REFERENCESNUMBER,INCRYPTIONDATE,ENCRY_DESCRIPTION,ENCRY_AMOUNT,ENCRY_STATUS
	,ENCRY_CHEQUENUMBER,UPLOADDATE,UPLOADBY,MATCH_STATUS,UPLOADTYPE,UPLOADID)

	SELECT RTRIM(LTRIM(.DBO.PIECE(REPLACE(FILE_DATA, '''', ''), '	', 1)))ENCRY_NUMBER,
	RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',3))) REFERENCESNUMBER,
	CONVERT(DATETIME,RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',4))),105) INCRYPTIONDATE,
	RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',5))) ENCRY_DESCRIPTION,
	CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',6))) AS MONEY) ENCRY_AMOUNT,
	RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',8))) ENCRY_STATUS,
	RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',12)))ENCRY_CHEQUENUMBER,
	GETDATE(),
	@UPLOADBY,
	0,
	@UPLOAD_FLAG,
	@UPLOADID
	FROM MSAJAG..FILEDATA (NOLOCK)
	WHERE PROGID=@UPLOADID
	AND FILE_DATA !=''

	IF NOT EXISTS(SELECT TOP 1 * FROM #TEMP_RECON_ENCRYPTION_DETAILS T,RECON_ENCRYPTION_DETAILS E
					WHERE T.REFERENCESNUMBER=E.REFERENCESNUMBER
					AND T.ENCRY_NUMBER=E.ENCRY_NUMBER
					AND T.INCRYPTIONDATE=E.INCRYPTIONDATE
					AND T.ENCRY_AMOUNT=E.ENCRY_AMOUNT
					AND T.ENCRY_STATUS=E.ENCRY_STATUS
					AND T.INCRYPTIONDATE=E.INCRYPTIONDATE
					AND T.ENCRY_CHEQUENUMBER=E.ENCRY_CHEQUENUMBER)
		BEGIN
			INSERT INTO RECON_ENCRYPTION_DETAILS(ENCRY_NUMBER,REFERENCESNUMBER,INCRYPTIONDATE,ENCRY_DESCRIPTION,ENCRY_AMOUNT,ENCRY_STATUS
			,ENCRY_CHEQUENUMBER,UPLOADDATE,UPLOADBY,MATCH_STATUS,UPLOADTYPE,UPLOADID,SEGMENT,BANKNAME,BANKCODE,BANKACCOUNT,FILETYPE,CROSS_NO)
			SELECT ENCRY_NUMBER,REFERENCESNUMBER,INCRYPTIONDATE,ENCRY_DESCRIPTION,ENCRY_AMOUNT,ENCRY_STATUS
			,ENCRY_CHEQUENUMBER,UPLOADDATE,UPLOADBY,MATCH_STATUS,
			CASE WHEN UPLOADTYPE='B' THEN 'BULK' ELSE UPLOADTYPE END,
			@UPLOADID,@SEGMENT,@BANKNAME,@BANKCODE,@BANKACCOUNT,@FILETYPE,''
			FROM #TEMP_RECON_ENCRYPTION_DETAILS 
			WHERE UPLOADID=@UPLOADID
		END
	ELSE
		BEGIN
		SELECT 'File already uploaded'
		END		

	DELETE FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID
	END TRY
	BEGIN CATCH
		DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID=@UPLOADID
		SELECT 'PLEASE CHECK WRONG FILE FORMATE '
		RETURN

	END CATCH
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_GET_BANKMASTER
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_GET_BANKMASTER]
AS
BEGIN

SELECT * FROM RECON_BANK_MASTER_VW

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_INSERT_BANK_MASTER
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_INSERT_BANK_MASTER] (
--DECLARE
@SEGMENT NVARCHAR(100)
,@BANKNAME NVARCHAR(100) 
,@BANKCODE NVARCHAR(30) 
,@BANKACCOUNT NVARCHAR(30) 
,@CLIENT NVARCHAR(100) 
,@FILETYPE NVARCHAR(25) 
,@ACTION VARCHAR(10)) 

AS
BEGIN
  IF @ACTION = 'ADD'
          BEGIN
                    IF EXISTS (SELECT TOP 1
		*
	FROM RECON_BANK_MASTER_VW(NOLOCK)
	WHERE SEGMENT = @SEGMENT
	AND BANKCODE = @BANKCODE
	AND BANKACCOUNT = @BANKACCOUNT
	AND FILETYPE = @FILETYPE) BEGIN
SELECT
	'ALREADY EXIST YOU HAVE INSERTED FOR ' + @SEGMENT + '-' + @BANKNAME + '-' + @BANKCODE + '-' + @BANKACCOUNT + '-' + @FILETYPE
END ELSE BEGIN
INSERT INTO RECON_BANK_MASTER ([SEGMENT]
, [BANKNAME]
, [BANKCODE]
, [BANKACCOUNT]
, [CLIENT]
, [FILETYPE]
, [INSERTEDDATETIME]
, [LASTUPDATE])
	VALUES (@SEGMENT, @BANKNAME, @BANKCODE, @BANKACCOUNT, @CLIENT, @FILETYPE, GETDATE(), GETDATE())
SELECT
	'SUCCESSFULLY YOU HAVE INSERTED FOR ' + @SEGMENT + '-' + @BANKNAME + '-' + @BANKCODE + '-' + @BANKACCOUNT + '-' + @FILETYPE
END
END

IF @ACTION = 'FETCH' BEGIN
SELECT
	SEGMENT
	,BANKNAME
	,BANKCODE
	,BANKACCOUNT
	,CLIENT
	,FILETYPE
	,INSERTEDDATETIME
	,LASTUPDATE
FROM RECON_BANK_MASTER_VW(NOLOCK)
WHERE SEGMENT = @SEGMENT
AND BANKNAME = @BANKNAME
AND FILETYPE = @FILETYPE
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_INSERT_PROCESS
-- --------------------------------------------------



CREATE  PROCEDURE [dbo].[CLS_RECON_INSERT_PROCESS] (@UPLOADID   NVARCHAR(50)
, @FILETYPE NVARCHAR(50)
, @BANKNAME NVARCHAR(50)
, @UPLOAD_FLAG CHAR(1)
, @REPROCESS_FLAG CHAR(1)
, @UPLOADDATE NVARCHAR(25)
, @BANKCODE NVARCHAR(20)
, @BANKACCOUNT NVARCHAR(50)
, @SEGMENT NVARCHAR(20)
, @UNAME NVARCHAR(50)
, @FILE_PATH NVARCHAR(150)
, @COMBINEFILE NVARCHAR(5)
, @UPLOADFILENAME NVARCHAR(150))
AS
  BEGIN
  DECLARE @VALUEDATE DATETIME
  
  
  
		IF(@REPROCESS_FLAG<>'R')
			BEGIN

		IF(	@BANKCODE='0' AND @BANKACCOUNT='0')				
		SET @COMBINEFILE='0'		
		ELSE
		SET @COMBINEFILE='1'
				
IF(@COMBINEFILE='0')
	BEGIN
		SELECT	@BANKCODE = BANKCODE
		FROM RECON_BANK_MASTER_VW 
		WHERE SEGMENT=@SEGMENT AND BANKNAME=@BANKNAME AND FILETYPE=@FILETYPE

		UPDATE RECON_BANK_FILEUPLOAD_LOGS
		SET BANKCODE=@BANKCODE
		WHERE SEGMENT=@SEGMENT AND BANKNAME=@BANKNAME AND FILETYPE=@FILETYPE
	END
END
DECLARE @TOTALFILERECORD INT, @TOTALINSERTRECORD INT, @LOOPINSERTRECORD NVARCHAR(20)



DECLARE @TEMPBANKACCOUNTMASTER TABLE(BANKACCOUNT NVARCHAR(50))
DECLARE @TEMPBANKACCOUNT TABLE(BANKACCOUNT NVARCHAR(50))
DECLARE @@SQL VARCHAR(MAX),
@@ACCOUNTDB VARCHAR(20),
@@ACCOUNTSERVER VARCHAR(20)
DECLARE @@CROSS_NO INT



IF (@FILETYPE = 'CMS') 
BEGIN
CREATE TABLE #CMS_DATA(SNO INT IDENTITY (1, 1)
, UPLOADID NVARCHAR(50)
, BANKCODE NVARCHAR(50)
, ROWTYPE NVARCHAR(50)
, VALUEDATE DATETIME
, DRCR NVARCHAR(50)
, INST_NO_CHECK NVARCHAR(50)
, INST_AMT DECIMAL(20, 2)
, DRAWER_NAME NVARCHAR(250)
, CLTCODE NVARCHAR(50)
, CLTACCNO NVARCHAR(50)
, VNO NVARCHAR(20)
, VTYP NVARCHAR(20)
, BOOKTYPE NVARCHAR(20)
, MATCHEDFLAG BIT
, UPLOADSTATUS NVARCHAR(50)
, UPLOADEDDATE NVARCHAR(50)
, MODIFIEDDATE DATETIME
, UPLOADBY NVARCHAR(50))
CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255))



IF (@REPROCESS_FLAG <> 'R') 
BEGIN

IF (@BANKNAME = 'HDFC BANK') EXEC CLS_RECON_CMS_HDFC_PROCESS @UPLOADID,@BANKCODE

IF (@BANKNAME = 'ICICI BANK') EXEC CLS_RECON_CMS_ICICI_PROCESS @UPLOADID,@BANKCODE

IF (@BANKNAME = 'KOTAK BANK') EXEC CLS_RECON_CMS_KOTAK_PROCESS	@UPLOADID,@BANKCODE

IF (@BANKNAME = 'STANDARD CHARTERED BANK') PRINT 'EXEC CLS_RECON_CMS_SCB_PROCESS @UPLOADID'
IF (@BANKNAME = 'IDFC BANK') EXEC CLS_RECON_CMS_IDFC_PROCESS @UPLOADID,@UPLOAD_FLAG,@BANKCODE

IF (@BANKNAME = 'SBI') EXEC CLS_RECON_CMS_SBI_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME
IF (@BANKNAME = 'YES BANK') EXEC CLS_RECON_CMS_YES_PROCESS @UPLOADID,@UPLOAD_FLAG,@BANKCODE
IF (@BANKNAME = 'YESBANK BUSINESS') EXEC CLS_RECON_CMS_YESBANK_BUSINESS_PROCESS @UPLOADID,@UPLOAD_FLAG,@BANKCODE

PRINT 'PROCESS CMS DATA ' + @UPLOADID

END 
ELSE 
BEGIN
INSERT INTO #CMS_DATA
	SELECT		
		UPLOADID
		,R.BANKCODE
		,ROWTYPE
		,R.VALUEDATE
		,R.DRCR
		,R.INST_NO_CHECK
		,R.INST_AMT
		,DRAWER_NAME
		,R.CLTCODE
		,R.CLTACCNO
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CROSS_NO
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY		
	FROM RECON_CMS_DATA R (NOLOCK)
	WHERE VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103)
	AND MATCHEDFLAG = 0
	AND BANKCODE = @BANKCODE
	AND EXISTS ( SELECT CROSSREFERENCENO FROM BANKRECO B 
	WHERE B.CROSSREFERENCENO=R.CROSS_NO
	AND B.CLTCODE=@BANKCODE AND B.STATUS='UNMATCHED'
	AND B.VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103))
	AND RowType<>'DR'
END

IF(@COMBINEFILE IS NULL AND @REPROCESS_FLAG='R' )
BEGIN

IF EXISTS(SELECT TOP 1 * FROM #CMS_DATA )
	BEGIN						
		INSERT INTO #LEDGER_TO_MAP
		SELECT
			L.VNO
			,L.VTYP
			,L.BOOKTYPE
			,CLTCODE
			,DDNO
			,RELAMT
			,L1.DRCR
			,L.Edt
			,L.Vdt
			,L.NARRATION
		FROM	LEDGER L
				,LEDGER1 L1
		WHERE L.VNO = L1.VNO
		AND L.VTYP = L1.VTYP
		AND L.LNO = L1.LNO
		AND L.BOOKTYPE = L1.BOOKTYPE
		AND L1.RELDT = ''
		AND EXISTS (SELECT
				VNO
			FROM LEDGER L11 (NOLOCK)
			WHERE L11.VNO = L1.VNO
			AND L11.VTYP = L1.VTYP
			AND L11.BOOKTYPE = L1.BOOKTYPE
			AND L11.CLTCODE = @BANKCODE
			AND L11.VTYP IN (2, 3, 17)
		--AND L11.Vdt<=@VALUEDATE
		)
	END
END
IF(@COMBINEFILE<>0) 
BEGIN
IF EXISTS(SELECT TOP 1 * FROM #CMS_DATA )
	BEGIN						
INSERT INTO #LEDGER_TO_MAP
	SELECT
		L.VNO
		,L.VTYP
		,L.BOOKTYPE
		,CLTCODE
		,DDNO
		,RELAMT
		,L1.DRCR
		,L.Edt
		,L.Vdt
		,L.NARRATION
	FROM	LEDGER L
			,LEDGER1 L1
	WHERE L.VNO = L1.VNO
	AND L.VTYP = L1.VTYP
	AND L.LNO = L1.LNO
	AND L.BOOKTYPE = L1.BOOKTYPE
	AND L1.RELDT = ''
	AND EXISTS (SELECT
			VNO
		FROM LEDGER L11 (NOLOCK)
		WHERE L11.VNO = L1.VNO
		AND L11.VTYP = L1.VTYP
		AND L11.BOOKTYPE = L1.BOOKTYPE
		AND L11.CLTCODE = @BANKCODE
		AND L11.VTYP IN (2, 3, 17)
	--AND L11.Vdt<=@VALUEDATE
	)
		END
							
END
IF (@COMBINEFILE<>'0' OR @REPROCESS_FLAG = 'R') 
BEGIN

IF @REPROCESS_FLAG <> 'R'
BEGIN
				DELETE FROM T 
				FROM #CMS_DATA T,RECON_CMS_DATA R
				WHERE  ISNULL(T.ROWTYPE,'')=ISNULL(R.ROWTYPE,'')
				AND ISNULL(T.VALUEDATE,'')=ISNULL(R.VALUEDATE,'')
				AND ISNULL(T.DRCR,'')=ISNULL(R.DRCR,'')
				AND ISNULL(T.INST_AMT,0.0)=ISNULL(R.INST_AMT,0.0)
				AND ISNULL(SUBSTRING(T.INST_NO_CHECK, PATINDEX('%[^0]%',T.INST_NO_CHECK), 30),'')=ISNULL(SUBSTRING(R.INST_NO_CHECK, PATINDEX('%[^0]%',R.INST_NO_CHECK), 30),'')
				------AND ISNULL(T.CLTCODE,'')=ISNULL(R.CLTCODE,'')
				AND ISNULL(T.CLTACCNO,'')=ISNULL(R.CLTACCNO,'')
				AND ISNULL(T.BANKCODE,'')=ISNULL(R.BANKCODE,'')
				AND R.ROWTYPE<>'DR'

END				

IF EXISTS(SELECT * FROM  #CMS_DATA)
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(0,@UPLOADID)
	ELSE
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(1,@UPLOADID)

	SELECT @VALUEDATE = MAX(VALUEDATE) FROM #CMS_DATA 
	
ALTER TABLE #CMS_DATA
ADD  MATCHCODE INT

SELECT UPLOADID, BANKCODE, ROWTYPE, VALUEDATE, DRCR, INST_NO_CHECK, INST_AMT
, CLTCODE INTO #CMS_DATA_DUPLICATE FROM #CMS_DATA
GROUP BY UPLOADID, BANKCODE, ROWTYPE, VALUEDATE, DRCR, INST_NO_CHECK, INST_AMT
, CLTCODE
HAVING COUNT(*)>1

IF(@FILETYPE='CMS' AND @BANKNAME='SBI')
BEGIN
	UPDATE C
	SET	MATCHEDFLAG = 1
		,MODIFIEDDATE = GETDATE()
		,C.VNO = L.VNO
		,C.VTYP = L.VTYP
		,C.BOOKTYPE = L.BOOKTYPE
		,C.MATCHCODE=9
		,CLTCODE=L.CLTCODE
	FROM #CMS_DATA C (NOLOCK)
	, #LEDGER_TO_MAP L (NOLOCK)
	,CLS_MULTIBANKID_RECO_VW M--, [MULTIBANKID] M (NOLOCK)
	WHERE L.DDNO<>''
	AND C.DRCR = L.DRCR
	AND C.INST_AMT = L.RELAMT
	AND C.INST_NO_CHECK=RTRIM(LTRIM(.DBO.PIECE(L.NARRATION,':',2)))
	--AND M.CLTCODE = C.CLTCODE
	--AND RIGHT(M.ACCNO, 5) = RIGHT(C.CLTACCNO, 5)	
	AND M.CLTCODE = L.CLTCODE
	AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
	AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
	WHERE E.BANKCODE=C.BANKCODE
	--AND E.CLTACCNO=C.CLTACCNO
	AND E.CLTCODE=C.CLTCODE
	AND E.DRCR=C.DRCR
	AND E.INST_AMT=C.INST_AMT
	AND E.INST_NO_CHECK=C.INST_NO_CHECK)
END
IF(@FILETYPE='CMS' AND @BANKNAME<>'SBI')
BEGIN
IF @REPROCESS_FLAG = 'R' AND @BANKNAME='YESBANK BUSINESS'
BEGIN
print 'bb'
			UPDATE C
	SET	MATCHEDFLAG = 1
		,MODIFIEDDATE = GETDATE()
		,C.VNO = L.VNO
		,C.VTYP = L.VTYP
		,C.BOOKTYPE = L.BOOKTYPE
		,C.MATCHCODE=9
		,CLTCODE=L.CLTCODE
	FROM #CMS_DATA C (NOLOCK)
	, #LEDGER_TO_MAP L (NOLOCK)
	WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%',C.INST_NO_CHECK), 30)
	AND L.DDNO<>''
	AND C.DRCR = L.DRCR
	AND C.INST_AMT = L.RELAMT	
	AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
	AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
	WHERE E.BANKCODE=C.BANKCODE
	--AND E.CLTACCNO=C.CLTACCNO
	AND E.CLTCODE=C.CLTCODE
	AND E.DRCR=C.DRCR
	AND E.INST_AMT=C.INST_AMT
	AND E.INST_NO_CHECK=C.INST_NO_CHECK)
END
ELSE
BEGIN 
UPDATE C
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,C.VNO = L.VNO
	,C.VTYP = L.VTYP
	,C.BOOKTYPE = L.BOOKTYPE
	,C.MATCHCODE=1
	,CLTCODE=L.CLTCODE
FROM #CMS_DATA C (NOLOCK)
, #LEDGER_TO_MAP L (NOLOCK)
,CLS_MULTIBANKID_RECO_VW M--, [MULTIBANKID] M (NOLOCK)
WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%',C.INST_NO_CHECK), 30)
AND L.DDNO<>''
AND C.DRCR = L.DRCR
AND C.INST_AMT = L.RELAMT
--AND M.CLTCODE = C.CLTCODE
AND RIGHT(M.ACCNO, 5) = RIGHT(C.CLTACCNO, 5)
AND M.CLTCODE = L.CLTCODE
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
WHERE E.BANKCODE=C.BANKCODE
--AND E.CLTACCNO=C.CLTACCNO
AND E.CLTCODE=C.CLTCODE
AND E.DRCR=C.DRCR
AND E.INST_AMT=C.INST_AMT
AND E.INST_NO_CHECK=C.INST_NO_CHECK)
END 
END


SELECT UPLOADID ,VNO,VTYP,BOOKTYPE INTO #DUPLICATE_CMS_DATA
FROM #CMS_DATA
GROUP BY UPLOADID ,VNO,VTYP,BOOKTYPE
HAVING  COUNT(*)>1

UPDATE C
	SET	MATCHEDFLAG =0
		,MODIFIEDDATE = ''
		,C.VNO = ''
		,C.VTYP = ''
		,C.BOOKTYPE = ''
		,C.MATCHCODE=''
		,CLTCODE=''
	FROM #CMS_DATA C 
	, #DUPLICATE_CMS_DATA L 
	WHERE C.VNO = L.VNO
	AND C.VTYP = L.VTYP		
	AND C.BOOKTYPE = L.BOOKTYPE	
	AND C.UPLOADID=L.UPLOADID


IF @REPROCESS_FLAG <> 'R' 
BEGIN
SELECT	@@CROSS_NO = ISNULL(MAX(CONVERT(INT, CROSSREFERENCENO)), 0) FROM BANKRECO(NOLOCK)				
				
INSERT INTO RECON_CMS_DATA (UPLOADID
, BANKCODE
, ROWTYPE
, VALUEDATE
, DRCR
, INST_NO_CHECK
, INST_AMT
, DRAWER_NAME
, CLTCODE
, CLTACCNO
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY
, CROSS_NO
, MATCHCODE)
	SELECT
		UPLOADID
		,@BANKCODE
		,ROWTYPE
		,VALUEDATE
		,DRCR
		,INST_NO_CHECK
		,INST_AMT
		,DRAWER_NAME
		,CLTCODE
		,CLTACCNO
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CASE
			WHEN MATCHEDFLAG = 1 THEN 'AUTORECO'
			ELSE 'PENDING'
		END AS UPLOADSTATUS
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY 
		,@@CROSS_NO + SNO
		,MATCHCODE
	FROM #CMS_DATA
	
UPDATE L1
SET	RELDT = VALUEDATE
	,REFNO = @@CROSS_NO + SNO --UPLOADSTATUS
FROM #CMS_DATA N
, LEDGER1 L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1
SET EDT = VALUEDATE
FROM #CMS_DATA N
, LEDGER L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'
	
END 
ELSE 
BEGIN

UPDATE RECON_CMS_DATA
SET	VNO = C.VNO
	,VTYP = C.VTYP
	,BOOKTYPE = C.BOOKTYPE
	,MATCHEDFLAG = C.MATCHEDFLAG
	,UPLOADSTATUS = 'REPROCESS'
	,MODIFIEDDATE = C.MODIFIEDDATE
	,MATCHCODE=C.MATCHCODE
	,CLTCODE=C.CLTCODE
FROM #CMS_DATA C, RECON_CMS_DATA R
WHERE C.UPLOADSTATUS = R.CROSS_NO
AND C.MATCHEDFLAG = 1

UPDATE B SET STATUS =CASE WHEN BR.MATCHEDFLAG = 1 THEN 'MATCHED' ELSE 'UNMATCHED' END
			FROM #CMS_DATA BR, BANKRECO B
			WHERE BANKCODE = B.CLTCODE
			AND B.CROSSREFERENCENO = BR.UPLOADSTATUS

UPDATE L1 SET RELDT = VALUEDATE	,REFNO = UPLOADSTATUS
			FROM #CMS_DATA N , LEDGER1 L1
			WHERE N.VNO = L1.VNO
			AND N.VTYP = L1.VTYP
			AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1 SET EDT = VALUEDATE
			FROM #CMS_DATA N, LEDGER L1
			WHERE N.VNO = L1.VNO
			AND N.VTYP = L1.VTYP
			AND N.BOOKTYPE = L1.BOOKTYPE
			AND EDT LIKE 'DEC 31 2049%'
			
END


SELECT	@TOTALFILERECORD = COUNT(*) FROM RECON_CMS_DATA WHERE UPLOADID = @UPLOADID

IF (@TOTALFILERECORD>=1) 
UPDATE RECON_BANK_FILEUPLOAD_LOGS
SET UPLOADSTATUS = 'SUCCESS'
WHERE UPLOADID = @UPLOADID
ELSE
DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID = @UPLOADID

END


IF (@COMBINEFILE='0' AND @REPROCESS_FLAG <> 'R') 
BEGIN
INSERT INTO @TEMPBANKACCOUNTMASTER
	SELECT DISTINCT	BANKACCOUNT	FROM RECON_BANK_MASTER_VW WHERE BANKNAME=@BANKNAME AND FILEFORMATE=0 AND FILETYPE=@FILETYPE

INSERT INTO @TEMPBANKACCOUNT
SELECT  DISTINCT BANKACCOUNT  FROM @TEMPBANKACCOUNTMASTER BM,#CMS_DATA T
WHERE LTRIM(RTRIM(T.ROWTYPE))= BM.BANKACCOUNT AND UPLOADID=@UPLOADID

WHILE (SELECT		COUNT(*)	FROM @TEMPBANKACCOUNT)> 0 
BEGIN
SET @SEGMENT = ''
SET @BANKCODE = ''
SET @BANKACCOUNT = ''
SET @@ACCOUNTDB = ''
SET @@ACCOUNTSERVER = ''

SELECT TOP 1	@BANKACCOUNT = BANKACCOUNT FROM @TEMPBANKACCOUNT

SELECT	@SEGMENT = SEGMENT	,@BANKCODE = BANKCODE
FROM RECON_BANK_MASTER_VW(NOLOCK)
WHERE BANKACCOUNT = @BANKACCOUNT AND BANKNAME =@BANKNAME

SELECT	@@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER
FROM PRADNYA.DBO.MULTICOMPANY
WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
AND PRIMARYSERVER = 1

SET @@SQL = ''
SET @@SQL = "IF NOT EXISTS (SELECT * FROM " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".[DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+ @UPLOADID +"')
BEGIN
INSERT INTO " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_BANK_FILEUPLOAD_LOGS(UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE)
SELECT UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE FROM [DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+@UPLOADID+ "'
END"

EXEC(@@SQL)

IF (@@ACCOUNTSERVER <> '') 
BEGIN

SET @@SQL = ''
SET @@SQL = "INSERT INTO " +
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].TEMP_CMS_DATA (UPLOADID,
BANKCODE,
ROWTYPE,
VALUEDATE,
DRCR,
INST_NO_CHECK,
INST_AMT,
DRAWER_NAME,
CLTCODE,
CLTACCNO,
VNO,
VTYP,
BOOKTYPE,
MATCHEDFLAG,
UPLOADSTATUS,
UPLOADEDDATE,
MODIFIEDDATE,
UPLOADBY,
CROSS_NO,
MATCHCODE)
										SELECT UPLOADID
										, "+@BANKCODE+"
										, ROWTYPE
										, VALUEDATE
										, DRCR
										, INST_NO_CHECK
										, INST_AMT
										, DRAWER_NAME
										, CLTCODE
										, CLTACCNO
										, VNO
										, VTYP
										, BOOKTYPE
										, MATCHEDFLAG
										, UPLOADSTATUS
										, UPLOADEDDATE
										, MODIFIEDDATE
										, UPLOADBY
										, 0
										, 0
										FROM   #CMS_DATA WHERE ROWTYPE='" + @BANKACCOUNT + "'"

EXEC (@@SQL)

SET @@SQL = ''
SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.CLS_RECON_MULTIBANK_CMS_INNER_PROCESS '"
+ @UPLOADID + "','" + @BANKACCOUNT + "','" + @BANKCODE + "'" + ",'" + @SEGMENT + "'"

EXEC (@@SQL)
--PRINT @@SQL

SET @@SQL = ''
SET @@SQL = "SELECT " + @LOOPINSERTRECORD + "=COUNT(*) FROM " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.RECON_CMS_DATA(NOLOCK) WHERE UPLOADID= '" + @UPLOADID + "'"
EXEC (@@SQL)
END
SET @TOTALINSERTRECORD = @TOTALINSERTRECORD + CAST(@LOOPINSERTRECORD AS INT)

DELETE FROM #CMS_DATA
WHERE ROWTYPE = @BANKACCOUNT
DELETE FROM @TEMPBANKACCOUNT
WHERE BANKACCOUNT = @BANKACCOUNT
END
SELECT	@TOTALFILERECORD = COUNT(*)
FROM RECON_CMS_DATA
WHERE UPLOADID = @UPLOADID

END


IF @REPROCESS_FLAG <> 'R' 
BEGIN
IF (@COMBINEFILE<>'0')
BEGIN
/* BANKRECO INSERT STATEMENT FOR CMS DATA */
INSERT INTO BANKRECO (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, CMS_SRNO)
	SELECT
		BANKCODE
		,VALUEDATE
		,LEFT('CMS ' + BR.DRAWER_NAME + ' ' + CLTACCNO,50) AS 'DESCRIPTION'
		,INST_AMT
		,DRCR
		,VALUEDATE
		,LEFT(INST_NO_CHECK, 30)
		,'BROKER'
		,'BROKER'
		,UPLOADBY
		,CROSS_NO
		,CASE
			WHEN UPLOADSTATUS = 'AUTORECO' THEN 'MATCHED'
			ELSE 'UNMATCHED'
		END
		,MICRNO
		,0
		,@UPLOADID
		,0
	FROM	RECON_CMS_DATA BR
			,ACMAST A
	WHERE BANKCODE = A.CLTCODE
	AND ACCAT = 2
	AND BR.UPLOADID=@UPLOADID

	UPDATE RECON_BANK_FILEUPLOAD_LOGS
	SET	FILEUPLOAD_EDATE = GETDATE(),VALUEDATE = @VALUEDATE
	WHERE UPLOADID = @UPLOADID

END

END

DROP TABLE #CMS_DATA

END 
ELSE 
IF (@FILETYPE = 'NON-CMS' OR @FILETYPE = 'TECHPROCESS' OR  @FILETYPE = 'BILLDESK') 
BEGIN

CREATE TABLE #NONCMS_DATA(SRNONCMS INT IDENTITY (1, 1) NOT NULL
, UPLOADID NVARCHAR(50)
, BANKACCOUNT NVARCHAR(50)
, BANKCODE NVARCHAR(50)
, DESCRIPTION NVARCHAR(150)
, LEDGERBALANCE NVARCHAR(50)
, DRCR NVARCHAR(50)
, AMT DECIMAL(20, 2)
, VALUEDATE NVARCHAR(50)
, REFERENCENO NVARCHAR(50)
, CLTACCOUNT NVARCHAR(50)
, CUSTOMERREFERENCE NVARCHAR(300) NULL
, TRANSACTIONDETAIL NVARCHAR(800) NULL
, VNO VARCHAR(12)
, VTYP INT
, BOOKTYPE VARCHAR(3)
, MATCHEDFLAG BIT
, UPLOADSTATUS NVARCHAR(50)
, UPLOADEDDATE DATETIME
, MODIFIEDDATE DATETIME
, UPLOADBY NVARCHAR(50))

CREATE TABLE #LEDGER_TO_MAP_NON(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255)
)

CREATE TABLE #LEDGER_TO_MAP_NON_HDFC(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255)
)

CREATE TABLE #LEDGER_TO_MAP_NON_YES(ROWNO INT,
VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255)
)



CREATE TABLE #NONCMS_DATA_DUPLICATE(SRNONCMS INT
, UPLOADID NVARCHAR(50)
, VNO VARCHAR(12)
, VTYP INT
, BOOKTYPE VARCHAR(3))

IF (@REPROCESS_FLAG <> 'R') 
BEGIN

IF (@BANKNAME = 'HDFC BANK') EXEC CLS_RECON_NONCMS_HDFC_PROCESS @UPLOADID,@BANKCODE,@UPLOADFILENAME,@UNAME

IF (@BANKNAME = 'ICICI BANK' AND @FILETYPE = 'NON-CMS') EXEC CLS_RECON_NONCMS_ICICI_PROCESS @UPLOADID,@BANKCODE

IF (@BANKNAME = 'KOTAK BANK') EXEC CLS_RECON_NONCMS_KOTAK_PROCESS @UPLOADID ,@BANKCODE

IF (@BANKNAME = 'STANDARD CHARTERED BANK') EXEC CLS_RECON_NONCMS_SCB_PROCESS	@UPLOADID ,@UPLOAD_FLAG,@BANKCODE
IF (@BANKNAME = 'IDFC BANK') EXEC CLS_RECON_NONCMS_IDFC_PROCESS @UPLOADID,@BANKCODE,@UPLOADFILENAME,@UNAME	

IF (@BANKNAME = 'SBI') EXEC CLS_RECON_NONCMS_SBI_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME

IF (@BANKNAME = 'YES BANK') EXEC CLS_RECON_NONCMS_YES_PROCESS @UPLOADID,@BANKCODE
IF (@BANKNAME = 'ICICI BANK' AND @FILETYPE = 'TECHPROCESS') EXEC CLS_RECON_TECHPROCESS_ICICI_PROCESS @UPLOADID,@BANKCODE
IF (@BANKNAME = 'INDUSIND BANK') EXEC CLS_RECON_NONCMS_INDUSIND_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME
IF (@BANKNAME = 'AXIS BANK') EXEC CLS_RECON_NONCMS_AXIS_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME
IF (@FILETYPE = 'BILLDESK') EXEC CLS_RECON_NONCMS_BILLDESK_PROCESS @UPLOADID,@BANKCODE,@FILE_PATH,@UNAME



PRINT 'PROCESS NON CMS DATA ' + @UPLOADID

END 
ELSE 
BEGIN
INSERT INTO #NONCMS_DATA
	SELECT		
		UPLOADID
		,BANKACCOUNT
		,BANKCODE
		,DESCRIPTION
		,LEDGERBALANCE
		,DRCR
		,AMT
		,VALUEDATE
		,REFERENCENO
		,CLTACCOUNT
		,CUSTOMERREFERENCE
		,TRANSACTIONDETAIL
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CROSS_NO
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY
		
	FROM RECON_NONCMS_DATA(NOLOCK) C
	WHERE C.VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103)
	AND C.MATCHEDFLAG = 0
	AND C.BANKCODE = @BANKCODE
	AND EXISTS ( SELECT CROSSREFERENCENO FROM BANKRECO B 
	WHERE B.CROSSREFERENCENO=C.CROSS_NO
	AND B.CLTCODE=@BANKCODE AND B.STATUS='UNMATCHED'
	AND B.VALUEDATE = CONVERT(DATETIME, @UPLOADDATE, 103))
	AND LedgerBalance<>'DR'
END

ALTER TABLE #NONCMS_DATA
ADD  MATCHCODE INT

IF(@COMBINEFILE IS NULL AND @REPROCESS_FLAG='R' )
BEGIN
IF EXISTS(SELECT TOP 1 * FROM #NONCMS_DATA)
		BEGIN
		INSERT INTO #LEDGER_TO_MAP_NON_HDFC
			SELECT
				L.VNO
				,L.VTYP
				,L.BOOKTYPE
				,CLTCODE
				,DDNO
				,RELAMT
				,L1.DRCR
				,L.Edt
				,L.Vdt
				,L.NARRATION
			FROM	LEDGER L
					,LEDGER1 L1
			WHERE L.VNO = L1.VNO
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND L1.RELDT = ''
			AND L1.VTYP<>5
			AND EXISTS (SELECT
					VNO
				FROM LEDGER L11 (NOLOCK)
				WHERE L11.VNO = L1.VNO
				AND L11.VTYP = L1.VTYP
				AND L11.BOOKTYPE = L1.BOOKTYPE
				AND L11.DRCR <> L1.DRCR
				AND L11.CLTCODE = @BANKCODE
			--AND L11.Vdt<=@VALUEDATE
			)
		--GROUP BY	DDNO
		--			,RELAMT
		--			,L1.DRCR
		--			,Edt
		--			,Vdt
		--HAVING COUNT(1) = 1
END
END
IF(@COMBINEFILE<>0) 
BEGIN
	IF EXISTS(SELECT TOP 1 * FROM #NONCMS_DATA)
		BEGIN
		INSERT INTO #LEDGER_TO_MAP_NON_HDFC
			SELECT
				L.VNO
				,L.VTYP
				,L.BOOKTYPE
				,CLTCODE
				,DDNO
				,RELAMT
				,L1.DRCR
				,L.Edt
				,L.Vdt
				,L.NARRATION
			FROM	LEDGER L
					,LEDGER1 L1
			WHERE L.VNO = L1.VNO
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND L1.RELDT = ''
			AND L1.VTYP<>5
			AND EXISTS (SELECT
					VNO
				FROM LEDGER L11 (NOLOCK)
				WHERE L11.VNO = L1.VNO
				AND L11.VTYP = L1.VTYP
				AND L11.BOOKTYPE = L1.BOOKTYPE
				AND L11.DRCR <> L1.DRCR
				AND L11.CLTCODE = @BANKCODE
			--AND L11.Vdt<=@VALUEDATE
			)
		--GROUP BY	DDNO
		--			,RELAMT
		--			,L1.DRCR
		--			,Edt
		--			,Vdt
		--HAVING COUNT(1) = 1
END
END

INSERT INTO #LEDGER_TO_MAP_NON
	SELECT
		MAX(VNO)
		,MAX(VTYP)
		,MAX(BOOKTYPE)
		,MAX(CLTCODE)
		,DDNO
		,RELAMT
		,DRCR
		,Edt
		,Vdt
		,NARRATION
	FROM #LEDGER_TO_MAP_NON_HDFC
	GROUP BY	DDNO
				,RELAMT
				,DRCR
				,EDT
				,VDT
				,NARRATION
	HAVING COUNT(1) = 1

IF (@COMBINEFILE<>'0' OR @REPROCESS_FLAG = 'R') 
BEGIN

IF (@REPROCESS_FLAG <> 'R') 
BEGIN

	DELETE FROM T
	FROM #NONCMS_DATA T ,RECON_NONCMS_DATA R
	WHERE  ISNULL(T.DRCR,'')=ISNULL(R.DRCR,'')
	AND ISNULL(T.AMT,0.0)=ISNULL(R.AMT,0.0)
	AND ISNULL(CONVERT(DATETIME, T.VALUEDATE, 105),'')=ISNULL(R.VALUEDATE,'')
	AND ISNULL(T.REFERENCENO,'')=ISNULL(R.REFERENCENO,'')
	AND ISNULL(T.BANKACCOUNT,'')=ISNULL(R.BANKACCOUNT,'')
	AND ISNULL(SUBSTRING(T.BANKCODE, PATINDEX('%[^0]%',T.BANKCODE), 30),'')=ISNULL(SUBSTRING(R.BANKCODE, PATINDEX('%[^0]%',R.BANKCODE), 30),'')
	AND R.LEDGERBALANCE <>'DR'

END
	
	IF EXISTS(SELECT * FROM  #NONCMS_DATA)
	BEGIN	
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(0,@UPLOADID)	
	END
	ELSE
	BEGIN
	INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(1,@UPLOADID)
	END
	SELECT @VALUEDATE =MAX(CONVERT(DATETIME, VALUEDATE, 105)) FROM #NONCMS_DATA 				
	
	SELECT	@@CROSS_NO = ISNULL(MAX(CONVERT(INT, CROSSREFERENCENO)), 0)FROM BANKRECO(NOLOCK)

IF(@BANKNAME<>'INDUSIND BANK')
BEGIN

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(N.REFERENCENO, PATINDEX('%[^0]%',N.REFERENCENO), 30)
--L.DDNO = N.REFERENCENO
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND LEN(L.DDNO) <= 15

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE	
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(N.REFERENCENO, PATINDEX('%[^0]%',N.REFERENCENO), 30)
--L.DDNO = N.REFERENCENO
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND LEN(L.DDNO) > 15

--HDFC BANK FOR CLTACCOUNT
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=3
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_HDFC L (NOLOCK)
--, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE L.CLTCODE=.DBO.PIECE(REPLACE(DESCRIPTION,' ','|'),'|',2)
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)

AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND N.MATCHEDFLAG=0

--HDFC BANK FOR CLTCODE
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=3
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_HDFC L (NOLOCK)
WHERE L.CLTCODE=RTRIM(LTRIM(SUBSTRING(DESCRIPTION,CHARINDEX('Angel to',DESCRIPTION )+8,len(DESCRIPTION))))
AND Description LIKE '%Angel to%'
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND N.MATCHEDFLAG=0

IF EXISTS(SELECT * FROM #NONCMS_DATA WHERE DESCRIPTION LIKE 'BIL/%' )
	BEGIN
		UPDATE N
		SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
			,N.VNO = L.VNO
			,N.VTYP = L.VTYP
			,N.BOOKTYPE = L.BOOKTYPE
			,N.MATCHCODE=10
			,N.CUSTOMERREFERENCE=L.CLTCODE	
		FROM #NONCMS_DATA N (NOLOCK)
		, #LEDGER_TO_MAP_NON L (NOLOCK)
		WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(.DBO.PIECE(DESCRIPTION,'/',2), PATINDEX('%[^0]%',.DBO.PIECE(DESCRIPTION,'/',2)), 30)
		AND L.DDNO<>''
		AND L.RELAMT = CONVERT(MONEY, N.AMT)
		AND N.DRCR = L.DRCR
		AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
		AND N.MATCHEDFLAG=0

		UPDATE N
		SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
			,N.VNO = L.VNO
			,N.VTYP = L.VTYP
			,N.BOOKTYPE = L.BOOKTYPE
			,N.MATCHCODE=10
			,N.CUSTOMERREFERENCE=L.CLTCODE	
		FROM #NONCMS_DATA N (NOLOCK)
		, #LEDGER_TO_MAP_NON L (NOLOCK)
		WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(.DBO.PIECE(DESCRIPTION,'/',3), PATINDEX('%[^0]%',.DBO.PIECE(DESCRIPTION,'/',3)), 30)
		AND L.DDNO<>''
		AND L.RELAMT = CONVERT(MONEY, N.AMT)
		AND N.DRCR = L.DRCR
		AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
		AND N.MATCHEDFLAG=0
	END

END
IF(@FILETYPE='NON-CMS' AND @BANKNAME='YES BANK')
BEGIN

INSERT INTO #LEDGER_TO_MAP_NON_YES
SELECT COUNT(*)AS 'ROWNO' ,VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT,NARRATION FROM 
#LEDGER_TO_MAP_NON  WHERE NARRATION LIKE'%PAYOUT THROUGH NEFT/RTGS REVERSED%'
GROUP BY VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT,NARRATION 
HAVING COUNT(*)=1

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=5
	,N.CUSTOMERREFERENCE=L.CLTCODE
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_YES L (NOLOCK)
WHERE DESCRIPTION LIKE'%NEFT-RETURN-%'
AND NARRATION LIKE'%PAYOUT THROUGH NEFT/RTGS REVERSED%'
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND N.MATCHEDFLAG=0

END

IF(@FILETYPE='NON-CMS' AND @BANKNAME='AXIS BANK')
BEGIN

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE L.CLTCODE = .dbo.piece(N.DESCRIPTION,'/',5)
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE
AND N.MATCHEDFLAG=0

END

IF(@FILETYPE='NON-CMS' AND @BANKNAME='KOTAK BANK')
BEGIN


UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE DBO.PIECE(L.NARRATION, '_', 2) = N.REFERENCENO
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE
AND N.MATCHEDFLAG=0


END

IF EXISTS(SELECT * FROM #NONCMS_DATA WHERE DESCRIPTION LIKE '%ATOM %')
BEGIN
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
--, N.BANKCODE = @BANKCODE /* ADD*/
FROM #NONCMS_DATA N 
, #LEDGER_TO_MAP_NON L 
WHERE L.DDNO = SUBSTRING(REPLACE(DESCRIPTION,'ATOM ',''),0,CHARINDEX(' ',REPLACE(DESCRIPTION,'ATOM ',''))) 
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
AND MATCHEDFLAG=0
AND DESCRIPTION LIKE '%ATOM %'
AND N.MATCHEDFLAG=0


END
/*COMPARE WITH ENCRYPTION FILE */
IF(@FILETYPE='NON-CMS' AND @BANKNAME='HDFC BANK')
BEGIN

UPDATE N
SET MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = T.VNO
	,N.VTYP = T.VTYP
	,N.BOOKTYPE = T.BOOKTYPE
	,N.MATCHCODE=4
	,N.CUSTOMERREFERENCE=T.CLTCODE
FROM (SELECT * FROM RECON_ENCRYPTION_DETAILS (NOLOCK) WHERE MATCH_STATUS = 0) E,
#NONCMS_DATA N, #LEDGER_TO_MAP_NON T
WHERE RIGHT(N.REFERENCENO, 6) = RIGHT(E.REFERENCESNUMBER, 6)
AND N.AMT = E.ENCRY_AMOUNT
AND N.DRCR=T.DRCR
AND T.DDNO = E.ENCRY_CHEQUENUMBER
AND T.DDNO<>''
AND N.AMT = T.RELAMT
AND N.MATCHEDFLAG=0

UPDATE E
SET MATCH_STATUS = 1,CROSS_NO=@@CROSS_NO + SRNONCMS
FROM (SELECT * FROM RECON_ENCRYPTION_DETAILS (NOLOCK) WHERE MATCH_STATUS = 0) E,
#NONCMS_DATA N, #LEDGER_TO_MAP_NON T
WHERE RIGHT(N.REFERENCENO, 6) = RIGHT(E.REFERENCESNUMBER, 6)
AND N.AMT = E.ENCRY_AMOUNT
AND N.DRCR=T.DRCR
AND T.DDNO = E.ENCRY_CHEQUENUMBER
AND N.AMT = T.RELAMT
--AND E.MATCH_STATUS = 0

END
IF(@FILETYPE='NON-CMS' AND @BANKNAME='INDUSIND BANK')
BEGIN
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 8
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON L (NOLOCK)
WHERE DBO.PIECE(L.NARRATION, '_', 2) = N.REFERENCENO
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE = 8
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM #NONCMS_DATA N 
, #LEDGER_TO_MAP_NON L 
WHERE L.DDNO = N.REFERENCENO
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= N.VALUEDATE
AND MATCHEDFLAG=0


END

INSERT INTO #NONCMS_DATA_DUPLICATE (UPLOADID ,VNO,VTYP,BOOKTYPE)
SELECT UPLOADID ,VNO,VTYP,BOOKTYPE FROM #NONCMS_DATA
GROUP BY UPLOADID ,VNO,VTYP,BOOKTYPE
HAVING  COUNT(*)>1

UPDATE N SET MATCHEDFLAG = 0
			,MODIFIEDDATE = ''
			,N.VNO = ''
			,N.VTYP = ''
			,N.BOOKTYPE = ''
			,N.MATCHCODE = ''
			FROM #NONCMS_DATA N	,#NONCMS_DATA_DUPLICATE ND
			WHERE N.VNO=ND.VNO
			AND N.VTYP=ND.VTYP
			AND N.BOOKTYPE=ND.BOOKTYPE
			AND N.UPLOADID=ND.UPLOADID
			
IF (@REPROCESS_FLAG <> 'R') 
BEGIN
INSERT INTO [DBO].[RECON_NONCMS_DATA] ([UPLOADID]
, [BANKACCOUNT]
, [BANKCODE]
, [DESCRIPTION]
, [LEDGERBALANCE]
, [DRCR]
, [AMT]
, [VALUEDATE]
, [REFERENCENO]
, [CLTACCOUNT]
, [CUSTOMERREFERENCE]
, [TRANSACTIONDETAIL]
, [VNO]
, [VTYP]
, [BOOKTYPE]
, [MATCHEDFLAG]
, [UPLOADSTATUS]
, [UPLOADEDDATE]
, [MODIFIEDDATE]
, [UPLOADBY]
, [BOOKDATE]
, [CROSS_NO]
, [MATCHCODE])
	SELECT
		UPLOADID
		,BANKACCOUNT
		,@BANKCODE
		,DESCRIPTION
		,LEDGERBALANCE
		,DRCR
		,AMT
		,CONVERT(DATETIME, VALUEDATE, 105) VALUEDATE
		,REFERENCENO
		,CLTACCOUNT
		,CUSTOMERREFERENCE
		,TRANSACTIONDETAIL
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CASE
			WHEN MATCHEDFLAG = 1 THEN 'AUTORECO'
			ELSE 'PENDING'
		END AS UPLOADSTATUS
		,CAST(UPLOADEDDATE AS DATETIME)
		,CAST(MODIFIEDDATE AS DATETIME)
		,UPLOADBY
		,CONVERT(DATETIME, VALUEDATE, 105) VALUEDATE
		,@@CROSS_NO + SRNONCMS
		,MATCHCODE
	FROM #NONCMS_DATA

UPDATE L1
SET	RELDT = CONVERT(DATETIME, VALUEDATE, 105)
	,REFNO = @@CROSS_NO + SRNONCMS--UPLOADSTATUS
FROM #NONCMS_DATA N
, LEDGER1 L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1
SET EDT = VALUEDATE
FROM #NONCMS_DATA N
, LEDGER L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'	
	
END 

IF (@REPROCESS_FLAG = 'R') 
BEGIN
UPDATE B
SET	VNO = NR.VNO
	,VTYP = NR.VTYP
	,BOOKTYPE = NR.BOOKTYPE
	,MATCHEDFLAG = NR.MATCHEDFLAG
	,UPLOADSTATUS = 'REPROCESS'
	,MODIFIEDDATE = NR.MODIFIEDDATE
	,MATCHCODE = NR.MATCHCODE
	,CUSTOMERREFERENCE=NR.CUSTOMERREFERENCE
FROM #NONCMS_DATA NR, RECON_NONCMS_DATA B
WHERE b.BANKCODE = @BANKCODE
AND NR.UPLOADSTATUS = B.CROSS_NO
AND NR.MATCHEDFLAG = 1


UPDATE B
SET STATUS =CASE WHEN MATCHEDFLAG = 1 THEN 'MATCHED'	ELSE 'UNMATCHED' END
FROM #NONCMS_DATA NR,BANKRECO B
WHERE B.CLTCODE=@BANKCODE
AND BANKCODE = CLTCODE
AND NR.UPLOADSTATUS = B.CROSSREFERENCENO

UPDATE L1
SET	RELDT = CONVERT(DATETIME, VALUEDATE, 105)
	,REFNO = N.UPLOADSTATUS
FROM #NONCMS_DATA N, LEDGER1 L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE

UPDATE L1
SET EDT = VALUEDATE
FROM #NONCMS_DATA N, LEDGER L1
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'

END


SELECT	@TOTALFILERECORD = COUNT(*)FROM RECON_NONCMS_DATA(NOLOCK)

IF (@TOTALFILERECORD>0) 
UPDATE RECON_BANK_FILEUPLOAD_LOGS
SET UPLOADSTATUS = 'SUCCESS'
WHERE UPLOADID = @UPLOADID
ELSE

DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID = @UPLOADID


END

IF (@COMBINEFILE='0' AND @REPROCESS_FLAG <> 'R') 
BEGIN

INSERT INTO @TEMPBANKACCOUNT
	SELECT DISTINCT
		BANKACCOUNT
	FROM #NONCMS_DATA
DELETE FROM  @TEMPBANKACCOUNT WHERE BANKACCOUNT IS NULL
WHILE (SELECT COUNT(*)FROM @TEMPBANKACCOUNT)> 0 
BEGIN
SET @SEGMENT = ''
SET @BANKCODE = ''
SET @BANKACCOUNT = ''
SET @@ACCOUNTDB = ''
SET @@ACCOUNTSERVER = ''

SELECT TOP 1	@BANKACCOUNT = BANKACCOUNT FROM @TEMPBANKACCOUNT

IF(@FILETYPE<>'TECHPROCESS')
SELECT	@SEGMENT = SEGMENT	,@BANKCODE = BANKCODE FROM RECON_BANK_MASTER_VW(NOLOCK)
WHERE BANKACCOUNT = @BANKACCOUNT

IF(@FILETYPE='TECHPROCESS')

SELECT	@SEGMENT = RT.SEGMENT
,@BANKCODE = RB.BANKCODE FROM RECON_BANK_MASTER_VW RB(NOLOCK),RECON_TECH_PROCESS_MASTER_VW RT(NOLOCK)
WHERE  RB.SEGMENT=RT.SEGMENT AND  RB.FILETYPE=@FILETYPE AND RB.BANKNAME=@BANKNAME 
AND RT.ACCOUNTTYPE=@BANKACCOUNT


SELECT
	@@ACCOUNTDB = ACCOUNTDB
	,@@ACCOUNTSERVER = ACCOUNTSERVER
FROM PRADNYA.DBO.MULTICOMPANY
WHERE EXCHANGE + '-' + SEGMENT = @SEGMENT
AND PRIMARYSERVER = 1

SET @@SQL = ''
SET @@SQL = "IF NOT EXISTS (SELECT * FROM " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".[DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+ @UPLOADID +"')
BEGIN
INSERT INTO " 
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].RECON_BANK_FILEUPLOAD_LOGS(UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE)
SELECT UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,MODIFIEDDATE,UPLOADSTATUS,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE FROM [DBO].RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID='"+@UPLOADID+ "'
END"

EXEC(@@SQL)

IF (@@ACCOUNTSERVER <> '') 
BEGIN

SET @@SQL = ''
SET @@SQL = "INSERT INTO " +
+@@ACCOUNTSERVER + "." + @@ACCOUNTDB + ".[DBO].TEMP_NONCMS_DATA (UPLOADID
	,BANKACCOUNT
	,BANKCODE
	,DESCRIPTION
	,LEDGERBALANCE
	,DRCR
	,AMT
	,VALUEDATE
	,REFERENCENO
	,CLTACCOUNT
	,CUSTOMERREFERENCE
	,TRANSACTIONDETAIL
	,VNO
	,VTYP
	,BOOKTYPE
	,MATCHEDFLAG
	,UPLOADSTATUS
	,UPLOADEDDATE
	,MODIFIEDDATE
	,UPLOADBY
	,BOOKDATE
	,CROSS_NO
	,MATCHCODE) 
	SELECT UPLOADID
	 , BANKACCOUNT
	 , "+@BANKCODE+"
	 , DESCRIPTION
	 , LEDGERBALANCE
	 , DRCR
	 , AMT
	 , VALUEDATE
	 , REFERENCENO
	 , CLTACCOUNT
	 , CUSTOMERREFERENCE
	 , TRANSACTIONDETAIL
	 , VNO
	 , VTYP
	 , BOOKTYPE
	 , MATCHEDFLAG
	 , UPLOADSTATUS
	 , UPLOADEDDATE 
	 , MODIFIEDDATE
	 , UPLOADBY
	 , VALUEDATE
	 ,0
	 ,0
	FROM   #NONCMS_DATA  WHERE  BANKACCOUNT='" + @BANKACCOUNT + "'"

--PRINT @@SQL
EXEC (@@SQL)

SET @@SQL = ''
SET @@SQL = "EXEC  " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.CLS_RECON_MULTIBANK_NONCMS_INNER_PROCESS '"
+ @UPLOADID + "','" + @BANKACCOUNT + "','" + @BANKCODE + "','" + @BANKNAME + "'" + ",'" + @FILETYPE + "'" + ",'" + @SEGMENT + "'"

--PRINT @@SQL
EXEC (@@SQL)

SET @@SQL = ''
SET @@SQL = "SELECT " + @LOOPINSERTRECORD + "=COUNT(*) FROM " + @@ACCOUNTSERVER + "." + @@ACCOUNTDB
+ ".DBO.RECON_NONCMS_DATA(NOLOCK) WHERE UPLOADID= '" + @UPLOADID + "'"
EXEC (@@SQL)

END

SET @TOTALINSERTRECORD = @TOTALINSERTRECORD + CAST(@LOOPINSERTRECORD AS INT)

DELETE FROM #NONCMS_DATA
WHERE BANKACCOUNT = @BANKACCOUNT
DELETE FROM @TEMPBANKACCOUNT
WHERE BANKACCOUNT = @BANKACCOUNT
END

SELECT	@TOTALFILERECORD = COUNT(*)FROM RECON_NONCMS_DATA
WHERE UPLOADID = @UPLOADID

IF (@TOTALFILERECORD >1) 
UPDATE RECON_BANK_FILEUPLOAD_LOGS
SET UPLOADSTATUS = 'SUCCESS'
WHERE UPLOADID = @UPLOADID
END



/* BANKRECO INSERT STATEMENT FOR NONCMS DATA */
IF (@COMBINEFILE<>'0' AND @REPROCESS_FLAG <> 'R') 
BEGIN
INSERT INTO BANKRECO (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, CMS_SRNO)
	SELECT
		BANKCODE
		,BOOKDATE
		,LEFT([DESCRIPTION], 50)
		,AMT
		,DRCR
		,VALUEDATE
		,LEFT(REFERENCENO, 30)
		,'BROKER'
		,'BROKER'
		,UPLOADBY
		,CAST(CROSS_NO AS NVARCHAR(20))
		,CASE WHEN UPLOADSTATUS = 'AUTORECO' THEN 'MATCHED'	ELSE 'UNMATCHED' END
		,MICRNO
		,0
		,@UPLOADID
		,0
	FROM	RECON_NONCMS_DATA BR ,ACMAST A
	WHERE BANKCODE = CLTCODE
	AND ACCAT = 2
	AND   CHARINDEX((SELECT EXCLUDEDATA FROM RECON_EXCLUDE_MASTER_VW EM
	WHERE  FILETYPE=@FILETYPE	AND BANKNAME=@BANKNAME),BR.DESCRIPTION )<>1
	AND UPLOADID=@UPLOADID

	UPDATE RECON_BANK_FILEUPLOAD_LOGS 
	SET FILEUPLOAD_EDATE=GETDATE(),VALUEDATE=@VALUEDATE  WHERE UPLOADID=@UPLOADID

	END
	DROP TABLE #NONCMS_DATA


END 
ELSE 
BEGIN
PRINT 'PLEASE CHECK SUPPLY PARAMETERS'
DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
END


IF @REPROCESS_FLAG <> 'R'
BEGIN

	IF NOT EXISTS(SELECT * FROM EXISTS_RECORDS_VW WHERE RECORDSTATUS=0 AND UPLOADID=@UPLOADID )
	BEGIN	
	SELECT 'UPLOADED RECORDS ALREADY EXISTS'
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	END
	ELSE
	BEGIN
	SELECT 'FILE UPLOAD SUCCESSFULLY'
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	END

END
ELSE
BEGIN
		SELECT 'REPROCESS SUCCESSFULLY'
END

DELETE FROM EXISTS_RECORDS WHERE UPLOADID=@UPLOADID

DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID

DELETE FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_MATCH_UNMATCH_REPORT
-- --------------------------------------------------





CREATE  PROCEDURE [dbo].[CLS_RECON_MATCH_UNMATCH_REPORT]
		(
         @FROM_DATE NVARCHAR(50)          
        ,@TO_DATE NVARCHAR(50)          
		,@BANKCODE NVARCHAR(30)
		,@MATCHEDFLAG NVARCHAR(30)
		,@FILETYPE NVARCHAR(30)
		,@BANKNAME NVARCHAR(30)
		,@SEGMENT NVARCHAR(30)
		,@PARAM_VAL1 NVARCHAR(MAX)
		,@BULKDELETE NVARCHAR(20)
		,@LOGINNAME NVARCHAR(50)
		)

AS

BEGIN         
IF @FILETYPE='0'
SET @FILETYPE=''

DECLARE @CMS_MATCHBY NVARCHAR(100),
@NONCMS_MATCHBY NVARCHAR(35)

SET @CMS_MATCHBY='CHQNO+AMT+DRCR+CLTCODE+ACCNO'
SET @NONCMS_MATCHBY='CHQNO + AMT'

			CREATE TABLE #TEMP_DATA
			(
			CROSSREFNO VARCHAR(12)			
			,FINAL_DT  VARCHAR(25)
			,VNO VARCHAR(12)
			,VTYP INT
			,BOOKTYPE VARCHAR(3)
			,BANKCODE NVARCHAR(20)
			)

			IF(@MATCHEDFLAG='D')
			BEGIN
			INSERT INTO #TEMP_DATA
			SELECT
			.DBO.CLS_PIECE(ITEMS, '^', 1)
			,.DBO.CLS_PIECE(ITEMS, '^', 2)
			,''
			,''
			,''
			,.DBO.CLS_PIECE(ITEMS, '^', 3)
			FROM.DBO.CLS_SPLIT(@PARAM_VAL1, '|')
			WHERE.DBO.CLS_PIECE(ITEMS, '^', 1) <> ''

			UPDATE T
			SET	T.VNO = L1.VNO
			,T.VTYP = L1.VTYP
			,T.BOOKTYPE = L1.BOOKTYPE
			FROM #TEMP_DATA T, LEDGER1 L1
			WHERE L1.REFNO = T.CROSSREFNO

			END

			CREATE TABLE #TEMP_REPORT
			(
			ROWID     INT          NOT NULL  IDENTITY(1,1)
			, FILEUPLOADID        NVARCHAR(50)
			, UPLOADDATE          DATETIME							
			, VALUEDATE           DATETIME
			, SDATE				  DATETIME
			, EDATE				  DATETIME
			, MATCHEDDATE		  DATETIME
			, SEGMENT             NVARCHAR(50)
			, BANK                NVARCHAR(50)
			, ARRANGEMENTTYPE     NVARCHAR(50)
			, BANKCODE            NVARCHAR(50)
			, BANKACCOUNT         NVARCHAR(50)
			, ACCOUNTNO           NVARCHAR(70)
			, NARRATION           NVARCHAR(MAX)
			, CHEQUENO            NVARCHAR(50)
			, DRCR                NVARCHAR(5)
			, BANKSTATEMENTAMOUNT MONEY
			, VOUCHERAMOUNT       MONEY
			, BANKLOCATION        NVARCHAR(50)
			, ANGELLOCATION       NVARCHAR(50)
			, CLIENTCODE          NVARCHAR(50)
			, CLIENTNAME          NVARCHAR(50)
			, STATUS              NVARCHAR(50)
			, CROSSREFNO          NVARCHAR(50)
			, VOUCHERNO           NVARCHAR(50)
			, MATCHEDBY           NVARCHAR(100)
			, VOUCHERDATE         DATETIME
			, DEPOSITDATE         DATETIME
			, MATCHEDFLAG         BIT
			, VNO                 VARCHAR(15)
			, VTYP                INT
			, BOOKTYPE            VARCHAR(3)
			, TRAN_STATUS         VARCHAR(12)
			, REPORT_FLAG		  NVARCHAR(100)
			, USERNAME			  NVARCHAR(100)
			--,PRIMARY KEY (ROWID, FILEUPLOADID,MATCHEDFLAG)
			)
						

			CREATE TABLE #LEDGER_TO_MAP
			(
			VNO                 VARCHAR(12)
			, VTYP                INT
			, BOOKTYPE            VARCHAR(3)
			, CLTCODE             VARCHAR(10)
			, DDNO                VARCHAR(30)
			, RELAMT              MONEY
			, DRCR                CHAR(1)
			, BANKSTATEMENTAMOUNT MONEY
			, NARRATION           NVARCHAR(250)
			, CLIENTNAME          NVARCHAR(100)
			, VOUCHERNO           NVARCHAR(15)
			, VOUCHERDATE         DATETIME
			)
				
			IF(@FILETYPE ='NON-CMS' OR @FILETYPE='TECHPROCESS' OR @FILETYPE='' OR @FILETYPE='BILLDESK')
			BEGIN			
					INSERT INTO #TEMP_REPORT
					SELECT
						RC.UPLOADID AS FILEUPLOADID
						,RC.UPLOADEDDATE AS UPLOADDATE
						,RC.VALUEDATE
						,RBL.FILEUPLOAD_SDATE
						,RBL.FILEUPLOAD_EDATE
						,RC.MODIFIEDDATE 
						,SEGMENT
						,BANKNAME
						,RBL.FILETYPE AS ARRANGEMENTTYPE
						,RC.BANKCODE
						,RC.BANKACCOUNT
						,RC.CLTACCOUNT
						,DESCRIPTION AS NARRATION
						,REFERENCENO AS CHEQUENO
						,DRCR
						,'' AS BANKSTATEMENTAMOUNT
						,AMT AS VOUCHERAMOUNT
						,'' AS BANKLOCATION
						,'' AS ANGELLOCATION
						,'' AS CLIENTCODE
						,'' AS CLIENTNAME
						,'' AS STATUS
						,CROSS_NO AS CROSSREFNO
						,'' AS VOUCHERNO
						,RP.MATCHEDBY
						,'' AS VOUCHERDATE
						,'' AS DEPOSITDATE
						,MATCHEDFLAG
						,VNO
						,VTYP
						,BOOKTYPE
						,RC.UPLOADSTATUS
						,RC.LEDGERBALANCE AS REPORT_FLAG
						,RC.UPLOADBY
					FROM RECON_NONCMS_DATA(NOLOCK) RC
					INNER JOIN RECON_BANK_FILEUPLOAD_LOGS RBL
					ON RC.UPLOADID = RBL.UPLOADID
					AND BANKNAME= CASE WHEN @BANKNAME <>'' THEN @BANKNAME ELSE BANKNAME END										
					LEFT OUTER JOIN RECON_REPORT_STATUS_VW RP					
					ON RC.MATCHCODE=RP.MATCHCODE
					WHERE RC.VALUEDATE BETWEEN  CONVERT(DATETIME, @FROM_DATE, 105)
                                                AND CONVERT(DATETIME, @TO_DATE, 105)
					AND RC.LEDGERBALANCE<>'DR'
					
			END
				IF(@FILETYPE ='CMS' OR @FILETYPE='')
				BEGIN
				
					INSERT INTO #TEMP_REPORT				
					SELECT
						RC.UPLOADID AS FILEUPLOADID
						,RC.UPLOADEDDATE AS UPLOADDATE
						,RC.VALUEDATE
						,RBL.FILEUPLOAD_SDATE
						,RBL.FILEUPLOAD_EDATE
						,RC.MODIFIEDDATE
						,SEGMENT
						,BANKNAME
						,RBL.FILETYPE AS ARRANGEMENTTYPE
						,RC.BANKCODE
						,'' AS BANKACCOUNT
						,RC.CLTACCNO
						,'' AS NARRATION
						,RC.INST_NO_CHECK AS CHEQUENO
						,DRCR
						,'' AS BANKSTATEMENTAMOUNT
						,INST_AMT AS VOUCHERAMOUNT
						,'' AS BANKLOCATION
						,'' AS ANGELLOCATION
						,'' AS CLIENTCODE
						,'' AS CLIENTNAME
						,'' AS STATUS
						,CROSS_NO AS CROSSREFNO
						,'' AS VOUCHERNO
						,RP.MATCHEDBY
						,'' AS VOUCHERDATE
						,'' AS DEPOSITDATE
						,MATCHEDFLAG
						,VNO
						,VTYP
						,BOOKTYPE
						,RC.UPLOADSTATUS
						,RC.ROWTYPE  REPORT_FLAG
						,RC.UPLOADBY
					FROM RECON_CMS_DATA(NOLOCK) RC
					INNER JOIN RECON_BANK_FILEUPLOAD_LOGS RBL
						ON RC.UPLOADID = RBL.UPLOADID
						AND BANKNAME= CASE WHEN @BANKNAME <>'' THEN @BANKNAME ELSE BANKNAME END						
						LEFT OUTER JOIN RECON_REPORT_STATUS_VW RP					
							ON RC.MATCHCODE=RP.MATCHCODE
					WHERE RC.VALUEDATE BETWEEN CONVERT(DATETIME, @FROM_DATE, 105)	AND		CONVERT(DATETIME, @TO_DATE, 105)
					AND RC.ROWTYPE<>'DR'
					
					
				END
				
				SELECT @BANKCODE=F.BANKCODE 
				FROM RECON_BANK_FILEUPLOAD_LOGS F(NOLOCK),#TEMP_REPORT T
				WHERE F.UPLOADID=T.FILEUPLOADID 
				AND F.BANKNAME=@BANKNAME AND F.SEGMENT= @SEGMENT AND F.FILETYPE=@FILETYPE

IF(@MATCHEDFLAG='R' AND @PARAM_VAL1='')
BEGIN
	
		IF(@MATCHEDFLAG='R')
		BEGIN
		
			SELECT			FILEUPLOADID
							, CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
							, EDATE UPLOADENDDATE
							, CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
							--, SDATE
							, MATCHEDDATE							
							, SEGMENT
							, BANK
							, ARRANGEMENTTYPE
							, BANKCODE
							, BANKACCOUNT
							, ACCOUNTNO
							, NARRATION
							, CHEQUENO
							, DRCR  
							, BANKSTATEMENTAMOUNT
                            , VOUCHERAMOUNT     
                            , BANKLOCATION       
                            , ANGELLOCATION       
                            , CLIENTCODE         
                            , CLIENTNAME         
                            , STATUS              
                            , CROSSREFNO          
                            , VOUCHERNO           
                            , MATCHEDBY          
                            , VOUCHERDATE        
                            , DEPOSITDATE        
                            , MATCHEDFLAG        
                            , VNO                 
                            , VTYP              
                            , BOOKTYPE            
							, TRAN_STATUS
							, REPORT_FLAG
							,''
							,''
							,''
							,'' 
							,USERNAME
							 FROM #TEMP_REPORT WHERE REPORT_FLAG<>'DR'
			         
		END
		
END
IF (@MATCHEDFLAG = 'D')
BEGIN 


				IF(@BULKDELETE='BULK')
				BEGIN
				
			ALTER TABLE #TEMP_REPORT
			ADD UPLOADFILENAME VARCHAR(100) ,			
			 UPLOADSTATUS VARCHAR(50) ,			
			 FILEUPLOAD_SDATE VARCHAR(100),		
			 FILEUPLOAD_EDATE VARCHAR(100)


				UPDATE TR SET UPLOADFILENAME=RL.UPLOADFILENAME,UPLOADSTATUS=RL.UPLOADSTATUS
				,FILEUPLOAD_SDATE=RL.FILEUPLOAD_SDATE,FILEUPLOAD_EDATE=RL.FILEUPLOAD_EDATE
				FROM RECON_BANK_FILEUPLOAD_LOGS RL,#TEMP_REPORT TR
				WHERE TR.FILEUPLOADID = RL.UPLOADID
				AND RL.FILETYPE=@FILETYPE
				AND RL.BANKNAME=@BANKNAME
				AND( RL.SEGMENT=@SEGMENT OR @SEGMENT='')
				
				
				SELECT 
				ISNULL(FILEUPLOADID, '') AS UPLOADID
				,ISNULL(SEGMENT,'') AS SEGMENT
				,ISNULL(BANK,'') AS 'BANKNAME'
				,ISNULL(BANKACCOUNT,'') AS BANKACCOUNT 
				,ISNULL(ARRANGEMENTTYPE,'') AS FILETYPE
				,CONVERT(VARCHAR(10), ISNULL(VALUEDATE,''), 105) VALUEDATE --R.VALUEDATE
				,ISNULL(UPLOADFILENAME,'') AS UPLOADFILENAME
				,ISNULL(UPLOADSTATUS,'') AS UPLOADSTATUS
				,MIN(CONVERT(NVARCHAR, ISNULL(FILEUPLOAD_SDATE,''), 120)) FILEUPLOAD_SDATE
				,MAX(CONVERT(NVARCHAR, ISNULL(FILEUPLOAD_EDATE,''), 120)) FILEUPLOAD_EDATE
				FROM #TEMP_REPORT
				WHERE ARRANGEMENTTYPE=@FILETYPE
				AND BANK=@BANKNAME			
				GROUP BY ISNULL(FILEUPLOADID, ''),ISNULL(SEGMENT,''),ISNULL(BANK,''),ISNULL(BANKACCOUNT,''),ISNULL(ARRANGEMENTTYPE,''),ISNULL(VALUEDATE,'')
				,ISNULL(UPLOADFILENAME,''),ISNULL(UPLOADSTATUS,''),ISNULL(FILEUPLOAD_SDATE,''),ISNULL(FILEUPLOAD_EDATE,'')

					SELECT
					FILEUPLOADID
					,CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
					,EDATE UPLOADENDDATE
					,CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
					--, SDATE
					,MATCHEDDATE
					,SEGMENT
					,BANK
					,ARRANGEMENTTYPE
					,BANKCODE
					,ACCOUNTNO
					,NARRATION
					,CHEQUENO
					,DRCR
					,BANKSTATEMENTAMOUNT
					,VOUCHERAMOUNT
					,BANKLOCATION
					,ANGELLOCATION
					,CLIENTCODE
					,CLIENTNAME
					,STATUS
					,CROSSREFNO
					,VOUCHERNO
					,MATCHEDBY
					,VOUCHERDATE
					,DEPOSITDATE
					,MATCHEDFLAG
					,VNO
					,VTYP
					,BOOKTYPE
					,TRAN_STATUS
					,USERNAME
				FROM #TEMP_REPORT WHERE ARRANGEMENTTYPE=@FILETYPE
				AND BANK=@BANKNAME			

				END
			ELSE			
				BEGIN			
							SELECT			FILEUPLOADID
							, CONVERT(NVARCHAR, UPLOADDATE, 120) UPLOADDATE
							, EDATE UPLOADENDDATE
							, CONVERT(NVARCHAR, VALUEDATE, 120) VALUEDATE
							--, SDATE
							, MATCHEDDATE							
							, SEGMENT
							, BANK
							, ARRANGEMENTTYPE
							, BANKCODE
							, ACCOUNTNO
							, NARRATION
							, CHEQUENO
							, DRCR  
							, BANKSTATEMENTAMOUNT
                            , VOUCHERAMOUNT     
                            , BANKLOCATION       
                            , ANGELLOCATION       
                            , CLIENTCODE         
                            , CLIENTNAME         
                            , STATUS              
                            , CROSSREFNO          
                            , VOUCHERNO           
                            , MATCHEDBY          
                            , VOUCHERDATE        
                            , DEPOSITDATE        
                            , MATCHEDFLAG        
                            , VNO                 
                            , VTYP              
                            , BOOKTYPE            
							, TRAN_STATUS 
							, USERNAME
							 FROM #TEMP_REPORT WHERE REPORT_FLAG <>'DR'
							 AND MATCHEDFLAG=0
							 AND (SEGMENT=@SEGMENT OR @SEGMENT='')
							 AND (ARRANGEMENTTYPE=@FILETYPE OR @FILETYPE='')
							 AND (BANK =@BANKNAME OR @BANKNAME='')
							 

		
		IF(@PARAM_VAL1<>'')
		BEGIN
	BEGIN TRY

	BEGIN TRAN
		/*******BANK RECO DELETE************/
		DELETE B
		FROM BANKRECO B, #TEMP_DATA T	WHERE B.CROSSREFERENCENO = T.CROSSREFNO	
		AND B.VALUEDATE=T.FINAL_DT 
		AND B.CLTCODE=T.BANKCODE	
		
				

		IF(@FILETYPE='CMS')
		BEGIN
			INSERT INTO RECON_BANK_DELETION_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME
			, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE, ROWTYPE, DRCR, REFERENCENO
			, AMOUNT, DRAWER_NAME, CLTCODE, CLTACCNO, VNO, VTYP, BOOKTYPE, MATCHEDFLAG, UPLOADEDDATE, BOOKDATE, CROSS_NO
			, DESCRIPTION, LEDGERBALANCE, CUSTOMERREFERENCE, TRANSACTIONDETAIL, USERNAME, PERFORMDATE, ERROR1, ERROR2, ERROR3)

			SELECT UPLOADID,'',C.BANKCODE,'','CMS '+@BANKNAME,'','',MODIFIEDDATE,UPLOADSTATUS,UPLOADBY
			,'','',VALUEDATE,ROWTYPE,DRCR,INST_NO_CHECK,INST_AMT,DRAWER_NAME,CLTCODE,CLTACCNO,C.VNO
			,C.VTYP,C.BOOKTYPE,MATCHEDFLAG,UPLOADEDDATE,BOOKDATE,CROSS_NO,'','','',
			'',@LOGINNAME,GETDATE(),'','','' 
			FROM RECON_CMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.Valuedate=T.FINAL_DT
			
		
			UPDATE C 
			SET ROWTYPE='DR'
			FROM RECON_CMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.VALUEDATE=T.FINAL_DT
		END

		IF(@FILETYPE='NON-CMS' OR @FILETYPE='TECHPROCESS' OR  @FILETYPE='BILLDESK')
		BEGIN
		INSERT INTO RECON_BANK_DELETION_LOGS (UPLOADID, SEGMENT, BANKCODE, BANKNAME, FILETYPE, BANKACCOUNT, UPLOADFILENAME
		, MODIFIEDDATE, UPLOADSTATUS, UPLOADBY, FILEUPLOAD_SDATE, FILEUPLOAD_EDATE, VALUEDATE, ROWTYPE, DRCR, REFERENCENO
		, AMOUNT, DRAWER_NAME, CLTCODE, CLTACCNO, VNO, VTYP, BOOKTYPE, MATCHEDFLAG, UPLOADEDDATE, BOOKDATE, CROSS_NO
		, DESCRIPTION, LEDGERBALANCE, CUSTOMERREFERENCE, TRANSACTIONDETAIL, USERNAME, PERFORMDATE, ERROR1, ERROR2, ERROR3)
		SELECT UPLOADID,'',C.BANKCODE,'','NONCMS '+@BANKNAME,BANKACCOUNT,'',MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,
		'','',VALUEDATE,'',DRCR,REFERENCENO,AMT,'','',CLTACCOUNT,C.VNO,
		C.VTYP,C.BOOKTYPE,MATCHEDFLAG,UPLOADEDDATE,BOOKDATE,CROSS_NO,DESCRIPTION,LEDGERBALANCE,CUSTOMERREFERENCE,
		TRANSACTIONDETAIL,@LOGINNAME,GETDATE(),'','',''
		FROM RECON_NONCMS_DATA C,#TEMP_DATA T
		WHERE C.CROSS_NO=T.CROSSREFNO
		AND C.BANKCODE=T.BANKCODE
		AND C.ValueDate=T.FINAL_DT
			
			UPDATE C 
			SET LEDGERBALANCE='DR'
			FROM RECON_NONCMS_DATA C,#TEMP_DATA T
			WHERE C.CROSS_NO=T.CROSSREFNO
			AND C.BANKCODE=T.BANKCODE
			AND C.VALUEDATE=T.FINAL_DT
			
			UPDATE E
			SET MATCH_STATUS = 0
			FROM RECON_ENCRYPTION_DETAILS E, #TEMP_DATA T
			WHERE E.CROSS_NO = T.CROSSREFNO
			
		END

		COMMIT

END TRY

BEGIN CATCH

	ROLLBACK

END CATCH
		END
		---
		END
		
END

	DROP TABLE #TEMP_DATA
	DROP TABLE #TEMP_REPORT
	DROP TABLE #LEDGER_TO_MAP
	

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_MATCH_UNMATCH_REPORT_WRAPPER
-- --------------------------------------------------

CREATE  PROCEDURE [dbo].[CLS_RECON_MATCH_UNMATCH_REPORT_WRAPPER]
(
         @FROM_DATE NVARCHAR(50)          
        ,@TO_DATE NVARCHAR(50)          
		,@BANKCODE NVARCHAR(30)
		,@MATCHEDFLAG NVARCHAR(30)
		,@FILETYPE NVARCHAR(30)
		,@BANKNAME NVARCHAR(30)
		,@SEGMENT NVARCHAR(30)
		,@PARAM_VAL1 NVARCHAR(MAX)
		,@BULKDELETE  NVARCHAR(20)
		,@LOGINNAME NVARCHAR(50)
		)

AS

IF @SEGMENT='0'
SET @SEGMENT = ''
IF (@FILETYPE = 'ALL'  OR @FILETYPE = '0') 
SET @FILETYPE = ''

IF UPPER(@FILETYPE)='ENCRYPTION'
BEGIN 
	SELECT * FROM RECON_ENCRYPTION_DETAILS (NOLOCK)
	WHERE (SEGMENT=@SEGMENT OR @SEGMENT='')
	AND (BANKNAME=@BANKNAME OR @BANKNAME='')
	AND INCRYPTIONDATE BETWEEN  CONVERT(DATETIME, @FROM_DATE, 105) AND CONVERT(DATETIME, @TO_DATE, 105)
	 
END
ELSE
BEGIN
CREATE TABLE #TEMP_REPORT_WRAPPER(ROWID INT NOT NULL IDENTITY (1, 1)
, FILEUPLOADID NVARCHAR(50)
, UPLOADDATE DATETIME
, EDATE DATETIME
, VALUEDATE DATETIME
, MATCHEDDATE DATETIME
--, SDATE				  DATETIME	
, SEGMENT NVARCHAR(50)
, BANK NVARCHAR(50)
, ARRANGEMENTTYPE NVARCHAR(50)
, BANKCODE NVARCHAR(50)
, BANKACCOUNT NVARCHAR(75)
, ACCOUNTNO NVARCHAR(75)
, NARRATION NVARCHAR(MAX)
, CHEQUENO NVARCHAR(70)
, DRCR NVARCHAR(5)
, BANKSTATEMENTAMOUNT MONEY
, VOUCHERAMOUNT MONEY
, BANKLOCATION NVARCHAR(50)
, ANGELLOCATION NVARCHAR(150)
, CLIENTCODE NVARCHAR(50)
, CLIENTNAME NVARCHAR(150)
, STATUS NVARCHAR(50)
, CROSSREFNO NVARCHAR(50)
, VOUCHERNO NVARCHAR(50)
, MATCHEDBY NVARCHAR(250)
, VOUCHERDATE NVARCHAR(50)
, DEPOSITDATE NVARCHAR(50)
, MATCHEDFLAG BIT
, VNO VARCHAR(15)
, VTYP INT
, BOOKTYPE VARCHAR(3)
, TRAN_STATUS VARCHAR(20)
, REPORT_FLAG NVARCHAR(100)
, UPLOADFILENAME NVARCHAR(100)
, UPLOADSTATUS NVARCHAR(15)
, FILEUPLOAD_SDATE DATETIME
, FILEUPLOAD_EDATE DATETIME
, USERNAME NVARCHAR(100)
--,PRIMARY KEY (ROWID, FILEUPLOADID,MATCHEDFLAG)							
)

CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12)
, VTYP INT
, BOOKTYPE VARCHAR(3)
, CLTCODE VARCHAR(10)
, DDNO VARCHAR(30)
, RELAMT MONEY
, DRCR CHAR(1)
, BANKSTATEMENTAMOUNT MONEY
, NARRATION NVARCHAR(250)
, CLIENTNAME NVARCHAR(150)
, VOUCHERNO NVARCHAR(15)
, VOUCHERDATE DATETIME
, SEGMENT VARCHAR(20))

IF @SEGMENT <> '' 
BEGIN


INSERT INTO #TEMP_REPORT_WRAPPER
EXEC [CLS_RECON_MATCH_UNMATCH_REPORT]	@FROM_DATE
										,@TO_DATE
										,@BANKCODE
										,@MATCHEDFLAG
										,@FILETYPE
										,@BANKNAME
										,@SEGMENT
										,@PARAM_VAL1
										,@BULKDELETE
										,@LOGINNAME




UPDATE TRW
SET	UPLOADFILENAME = RL.UPLOADFILENAME
	,UPLOADSTATUS = RL.UPLOADSTATUS
	,FILEUPLOAD_SDATE = RL.FILEUPLOAD_SDATE
	,FILEUPLOAD_EDATE = RL.FILEUPLOAD_EDATE
	,TRW.BANKACCOUNT = RBM.BANKACCOUNT
FROM RECON_BANK_FILEUPLOAD_LOGS RL, #TEMP_REPORT_WRAPPER TRW, RECON_BANK_MASTER_VW RBM
WHERE TRW.FILEUPLOADID = RL.UPLOADID
AND RBM.SEGMENT = RL.SEGMENT
AND RBM.FILETYPE = RL.FILETYPE
AND RBM.BankName = RL.BANKNAME
AND RBM.BANKCODE = RL.BANKCODE
AND (RL.FILETYPE = @FILETYPE OR @FILETYPE = '')
AND (RL.BANKNAME = @BANKNAME OR @BANKNAME = '')
AND (RL.SEGMENT = @SEGMENT OR @SEGMENT = '')

SELECT
	FILEUPLOADID AS UPLOADID
	,MAX(SEGMENT) SEGMENT
	,BANK AS 'BANKNAME'
	,BANKACCOUNT
	,ARRANGEMENTTYPE AS FILETYPE
	,CONVERT(VARCHAR(10), MAX(VALUEDATE), 105) VALUEDATE --R.VALUEDATE
	,UPLOADFILENAME
	,UPLOADSTATUS
	,MIN(CONVERT(NVARCHAR, FILEUPLOAD_SDATE, 120)) FILEUPLOAD_SDATE
	,MAX(CONVERT(NVARCHAR, FILEUPLOAD_EDATE, 120)) FILEUPLOAD_EDATE
FROM #TEMP_REPORT_WRAPPER
WHERE (ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE = '')
AND (BANK = @BANKNAME OR @BANKNAME = '')
AND (SEGMENT = @SEGMENT OR @SEGMENT = '')
GROUP BY	FILEUPLOADID
			,SEGMENT
			,BANK
			,BANKACCOUNT
			,ARRANGEMENTTYPE
			,UPLOADFILENAME
			,UPLOADSTATUS

			IF(@BULKDELETE<>'BULK' OR @BULKDELETE<>'SummaryReport' OR @BULKDELETE='')
			BEGIN

					INSERT INTO #LEDGER_TO_MAP
						SELECT
							L.VNO
							,L.VTYP
							,L.BOOKTYPE
							,L.CLTCODE
							,L1.DDNO
							,L1.RELAMT
							,L1.DRCR
							,L1.RELAMT
							,L.NARRATION
							,L.ACNAME
							,L1.VNO
							,L.VDT
							,SEGMENT = @SEGMENT
						FROM	LEDGER L
								,LEDGER1 L1
								,#TEMP_REPORT_WRAPPER T
						WHERE L.VNO = L1.VNO
						AND L.VTYP = L1.VTYP
						AND L.LNO = L1.LNO
						AND L.BOOKTYPE = L1.BOOKTYPE
						AND L1.VNO = T.VNO
						AND L1.VTYP = T.VTYP
						AND L1.BOOKTYPE = T.BOOKTYPE
						AND EXISTS (SELECT VNO	FROM #TEMP_REPORT_WRAPPER L11 
							WHERE L11.VNO = L.VNO
							AND L11.VTYP = L.VTYP
							AND L11.BOOKTYPE = L.BOOKTYPE	
						)

					UPDATE T
					SET	BANKSTATEMENTAMOUNT = T.VOUCHERAMOUNT--L.BANKSTATEMENTAMOUNT
						,CLIENTCODE = L.CLTCODE
						,CLIENTNAME = L.CLIENTNAME
						,VOUCHERNO = L.VOUCHERNO
						,VOUCHERDATE = L.VOUCHERDATE
						,STATUS =CASE WHEN T.MATCHEDFLAG = 1 THEN 'RECONCILED'ELSE 'UNRECONCILED' END
						FROM #TEMP_REPORT_WRAPPER T
						, #LEDGER_TO_MAP L
						WHERE T.VNO = L.VNO
						AND T.VTYP = L.VTYP
						AND T.BOOKTYPE = L.BOOKTYPE
						AND T.DRCR = L.DRCR
						AND T.SEGMENT = L.SEGMENT
				END

	SELECT	* FROM #TEMP_REPORT_WRAPPER RL
	WHERE (RL.ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE = '')
	AND (RL.BANK = @BANKNAME OR @BANKNAME = '')
	AND (RL.SEGMENT = @SEGMENT OR @SEGMENT = '')
	ORDER BY CROSSREFNO

	SELECT
	FILEUPLOADID AS UPLOADID
	,MAX(SEGMENT) SEGMENT
	,BANK AS 'BANKNAME'
	,BANKACCOUNT
	,ARRANGEMENTTYPE AS FILETYPE
	,CONVERT(VARCHAR(10), MAX(VALUEDATE), 105) VALUEDATE --R.VALUEDATE
	,UPLOADFILENAME
	,UPLOADSTATUS
	,MIN(CONVERT(NVARCHAR, FILEUPLOAD_SDATE, 120)) FILEUPLOAD_SDATE
	,MAX(CONVERT(NVARCHAR, FILEUPLOAD_EDATE, 120)) FILEUPLOAD_EDATE
	,DRCR
	,COUNT(DRCR) AS 'TOTALENTRIES'
	,SUM(CASE WHEN MATCHEDFLAG = 1 THEN 1 ELSE 0 END) AS 'RECONCILED'
	,SUM(CASE WHEN MATCHEDFLAG = 0 THEN 1 ELSE 0 END) AS 'UNRECONCILED'
	,(SUM(CASE WHEN MATCHEDFLAG = 1 THEN 1 ELSE 0 END) * 100 / COUNT(DRCR)) 'RECONCILED %'
	FROM #TEMP_REPORT_WRAPPER
	WHERE (ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE = '')
	AND (BANK = @BANKNAME OR @BANKNAME = '')
	AND (SEGMENT = @SEGMENT OR @SEGMENT = '')
	GROUP BY	FILEUPLOADID
				,SEGMENT
				,BANK
				,BANKACCOUNT
				,ARRANGEMENTTYPE
				,UPLOADFILENAME
				,UPLOADSTATUS
				,DRCR

END 

ELSE 

BEGIN
		DECLARE @@ACCOUNTSERVER NVARCHAR(100),@@ACCOUNTDB NVARCHAR(100),@@SQL NVARCHAR(MAX),@@SEGMENT  NVARCHAR(50)
		DECLARE  @TEMP_SEGMENT TABLE(SEGMENT NVARCHAR(50), ACCOUNTDB NVARCHAR(100),ACCOUNTSERVER NVARCHAR(100))

		INSERT INTO @TEMP_SEGMENT
		SELECT DISTINCT  L.SEGMENT,ACCOUNTDB,ACCOUNTSERVER
		FROM	RECON_BANK_FILEUPLOAD_LOGS_VW L
		,PRADNYA.DBO.MULTICOMPANY P
		WHERE P.EXCHANGE + '-' + P.SEGMENT = L.SEGMENT
		AND PRIMARYSERVER = 1
		AND  L.SEGMENT    NOT IN ('MCD-FUTURES','NCX-FUTURES','MCX-FUTURES')

			INSERT INTO @TEMP_SEGMENT
			SELECT DISTINCT  P.EXCHANGE + '-' + P.SEGMENT,ACCOUNTDB,ACCOUNTSERVER
			FROM	PRADNYA.DBO.MULTICOMPANY_ALL P
			WHERE  P.SEGMENT LIKE'%MFSS%'
			AND PRIMARYSERVER = 1

		--DELETE FROM @TEMP_SEGMENT WHERE SEGMENT='MCD-FUTURES'
		--SELECT * FROM @TEMP_SEGMENT RETURN
		
WHILE (SELECT	COUNT(*)	FROM @TEMP_SEGMENT) > 0 
	BEGIN
	
		SELECT TOP 1	@@SEGMENT=SEGMENT, @@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER FROM @TEMP_SEGMENT
	
		DECLARE @@REORDCOUNT INT
		SET @@SQL = '' 
		SET @@SQL="SELECT @@REORDCOUNT=COUNT(*) FROM "+@@ACCOUNTSERVER+"."+@@ACCOUNTDB+"."+"[DBO].RECON_BANK_FILEUPLOAD_LOGS 
					WHERE VALUEDATE BETWEEN CONVERT(DATETIME,'" +@FROM_DATE +"',103) AND CONVERT(DATETIME,'"+ @TO_DATE +"',103)AND SEGMENT= '"+@@SEGMENT+"'"
		
		EXEC SP_EXECUTESQL @@SQL, N'@@REORDCOUNT INT OUT', @@REORDCOUNT OUT
		
		PRINT @@SQL
		
		IF(@@REORDCOUNT=0 )
		DELETE FROM @TEMP_SEGMENT WHERE SEGMENT=@@SEGMENT
					
        IF (@@REORDCOUNT>0 )
        BEGIN	
		IF ( (@@ACCOUNTSERVER +( CASE WHEN REPLACE(@@SERVICENAME,'MSSQLSERVER', '') ='' THEN '' ELSE '\'+@@SERVICENAME  END ))<> @@SERVERNAME  )
		BEGIN
		SET @@SQL = ''
		SET @@SQL ="INSERT INTO #TEMP_REPORT_WRAPPER EXEC " 
		+ @@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".DBO.CLS_RECON_MATCH_UNMATCH_REPORT '"+ @FROM_DATE + "','" + @TO_DATE + "','" + @BANKCODE+ "','" 
		+ @MATCHEDFLAG + "','" + @FILETYPE + "','" + @BANKNAME + "','" +@@SEGMENT + "','" + @PARAM_VAL1 + "','" +  @BULKDELETE + "','" +  @LOGINNAME + "'"				
		END
	ELSE
		BEGIN
		SET @@SQL = ''
		SET @@SQL ="INSERT INTO #TEMP_REPORT_WRAPPER EXEC " 
		+ @@ACCOUNTDB+ ".DBO.CLS_RECON_MATCH_UNMATCH_REPORT '"+ @FROM_DATE + "','" + @TO_DATE + "','" + @BANKCODE+ "','" 
		+ @MATCHEDFLAG + "','" + @FILETYPE + "','" + @BANKNAME + "','" +@@SEGMENT + "','" + @PARAM_VAL1 + "','" +  @BULKDELETE + "','" +  @LOGINNAME + "'"				
		END
		
		PRINT  @@SQL	
		EXEC (@@SQL)		
		SET @@SQL = ''
		SET @@SQL ="UPDATE TRW SET	UPLOADFILENAME = RL.UPLOADFILENAME
					,UPLOADSTATUS = RL.UPLOADSTATUS
					,FILEUPLOAD_SDATE = RL.FILEUPLOAD_SDATE
					,FILEUPLOAD_EDATE = RL.FILEUPLOAD_EDATE
					,TRW.BANKACCOUNT = RL.BANKACCOUNT FROM "
					 + @@ACCOUNTSERVER + "." + @@ACCOUNTDB	+ ".[DBO].RECON_BANK_FILEUPLOAD_LOGS RL, #TEMP_REPORT_WRAPPER TRW
					WHERE TRW.FILEUPLOADID = RL.UPLOADID
					AND TRW.SEGMENT = RL.SEGMENT
					AND TRW.ARRANGEMENTTYPE = RL.FILETYPE
					AND TRW.Bank = RL.BANKNAME
					AND TRW.BANKCODE = RL.BANKCODE"
					--AND (RL.FILETYPE = @FILETYPE OR @FILETYPE='')
					--AND (RL.BANKNAME = @BANKNAME OR @BANKNAME='')
					--AND (RL.SEGMENT = @SEGMENT OR @SEGMENT='')
					EXEC (@@SQL)
					PRINT @@SQL
	

		DELETE FROM @TEMP_SEGMENT WHERE ACCOUNTDB = @@ACCOUNTDB AND SEGMENT=@@SEGMENT
		END
	END
	
		CREATE CLUSTERED INDEX IDX_VALUEDATE ON #TEMP_REPORT_WRAPPER
		(
		ROWID,
		VALUEDATE
		)
			SELECT
			FILEUPLOADID AS UPLOADID
			,CASE WHEN BANK='STANDARD CHARTERED BANK' THEN '' -- MAX(SEGMENT)
			WHEN BANK='YES BANK' THEN '' ELSE MAX(SEGMENT) END SEGMENT
			--SELECT
			--FILEUPLOADID AS UPLOADID
			--,'' AS SEGMENT --MAX(SEGMENT)
			,BANK AS 'BANKNAME'
			,MAX(BANKACCOUNT)BANKACCOUNT
			,ARRANGEMENTTYPE AS FILETYPE
			,CONVERT(VARCHAR(10), MAX(VALUEDATE), 105) VALUEDATE --R.VALUEDATE
			,UPLOADFILENAME
			,UPLOADSTATUS
			,MIN(CONVERT(NVARCHAR, FILEUPLOAD_SDATE, 120)) FILEUPLOAD_SDATE
			,MAX(CONVERT(NVARCHAR, FILEUPLOAD_EDATE, 120)) FILEUPLOAD_EDATE
			FROM #TEMP_REPORT_WRAPPER
			WHERE (ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE='') AND (BANK = @BANKNAME OR @BANKNAME='') AND (SEGMENT = @SEGMENT OR @SEGMENT='')
			GROUP BY	FILEUPLOADID
			,BANK
			--,BANKACCOUNT
			,ARRANGEMENTTYPE
			,UPLOADFILENAME
			,UPLOADSTATUS

		IF(@BULKDELETE<>'BULK' OR @BULKDELETE<>'SummaryReport' OR @BULKDELETE='')
		BEGIN

			INSERT INTO @TEMP_SEGMENT
		SELECT DISTINCT  L.SEGMENT,ACCOUNTDB,ACCOUNTSERVER
		FROM	RECON_BANK_FILEUPLOAD_LOGS_VW L
		,PRADNYA.DBO.MULTICOMPANY P
		WHERE P.EXCHANGE + '-' + P.SEGMENT = L.SEGMENT
		AND PRIMARYSERVER = 1

			WHILE (SELECT	COUNT(*)	FROM @TEMP_SEGMENT) > 0 
			BEGIN
			SELECT TOP 1	@@SEGMENT=SEGMENT, @@ACCOUNTDB = ACCOUNTDB	,@@ACCOUNTSERVER = ACCOUNTSERVER FROM @TEMP_SEGMENT
			
			SET @@SQL = ''
			SET @@SQL ="INSERT INTO #LEDGER_TO_MAP 
			SELECT L.VNO
			,L.VTYP	,L.BOOKTYPE	,L.CLTCODE,L1.DDNO,L1.RELAMT,L1.DRCR,L1.RELAMT,L.NARRATION,L.ACNAME,L1.VNO,L.VDT,'" + @@SEGMENT + "' FROM " 
			+ @@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".DBO.LEDGER L ,"
			+ @@ACCOUNTSERVER + "." + @@ACCOUNTDB+ ".DBO.LEDGER1 L1 ,
			#TEMP_REPORT_WRAPPER T
			WHERE L.VNO = L1.VNO
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND L1.VNO = T.VNO
			AND L1.VTYP = T.VTYP
			AND L1.BOOKTYPE = T.BOOKTYPE
			AND EXISTS (SELECT
			VNO
			FROM #TEMP_REPORT_WRAPPER L11 (NOLOCK)
			WHERE L11.VNO = L.VNO
			AND L11.VTYP = L.VTYP
			AND L11.BOOKTYPE = L.BOOKTYPE			
			) "
			
			EXEC (@@SQL)
			PRINT @@SQL
			
			
			
			DELETE FROM @TEMP_SEGMENT WHERE ACCOUNTDB = @@ACCOUNTDB AND SEGMENT=@@SEGMENT
			END
             
			CREATE CLUSTERED INDEX IDX_LEDGER_TO_MAP ON #LEDGER_TO_MAP
			(
				SEGMENT
			) 
  
			
			UPDATE T
			SET	BANKSTATEMENTAMOUNT = T.VOUCHERAMOUNT--L.BANKSTATEMENTAMOUNT
			,CLIENTCODE = L.CLTCODE
			,CLIENTNAME = L.CLIENTNAME
			,VOUCHERNO = L.VOUCHERNO
			,VOUCHERDATE = L.VOUCHERDATE
			,STATUS =CASE WHEN T.MATCHEDFLAG = 1 THEN 'RECONCILED' ELSE 'UNRECONCILED' END
			FROM #TEMP_REPORT_WRAPPER T, #LEDGER_TO_MAP L
			WHERE T.VNO = L.VNO
			AND T.VTYP = L.VTYP
			AND T.BOOKTYPE = L.BOOKTYPE
			AND T.DRCR = L.DRCR
			AND T.SEGMENT = L.SEGMENT
			
			
END

	SELECT	* FROM #TEMP_REPORT_WRAPPER RL
	WHERE (RL.ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE='')
	AND (RL.BANK = @BANKNAME OR @BANKNAME='')
	AND (RL.SEGMENT = @SEGMENT OR @SEGMENT='')
	ORDER BY CROSSREFNO

SELECT
	FILEUPLOADID AS UPLOADID
	,SEGMENT SEGMENT
	,BANK AS 'BANKNAME'
	,BANKACCOUNT
	,ARRANGEMENTTYPE AS FILETYPE
	,CONVERT(VARCHAR(10), MAX(VALUEDATE), 105) VALUEDATE --R.VALUEDATE
	,UPLOADFILENAME
	,UPLOADSTATUS
	,MIN(CONVERT(NVARCHAR, FILEUPLOAD_SDATE, 120)) FILEUPLOAD_SDATE
	,MAX(CONVERT(NVARCHAR, FILEUPLOAD_EDATE, 120)) FILEUPLOAD_EDATE
	,DRCR
	,COUNT(DRCR) AS 'TOTALENTRIES'
	,SUM(CASE WHEN MATCHEDFLAG = 1 THEN 1 ELSE 0  END) AS 'RECONCILED'
	,SUM(CASE WHEN MATCHEDFLAG = 0 THEN 1 ELSE 0 END) AS 'UNRECONCILED'
	,(SUM(CASE WHEN MATCHEDFLAG = 1 THEN 1 ELSE 0 END) * 100 / COUNT(DRCR)) 'RECONCILED %'
	FROM #TEMP_REPORT_WRAPPER
	WHERE (ARRANGEMENTTYPE = @FILETYPE OR @FILETYPE='')
	AND (BANK = @BANKNAME OR @BANKNAME='')
	AND (SEGMENT = @SEGMENT OR @SEGMENT='')
	GROUP BY	FILEUPLOADID
				,SEGMENT
				,BANK
				,BANKACCOUNT
				,ARRANGEMENTTYPE
				,UPLOADFILENAME
				,UPLOADSTATUS
				,DRCR

END

DROP TABLE #LEDGER_TO_MAP
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_MULTIBANK_CMS_INNER_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_MULTIBANK_CMS_INNER_PROCESS]
(@UPLOADID NVARCHAR(50)
,@BANKACCOUNT NVARCHAR(50)
,@BANKCODE NVARCHAR(50)
,@SEGMENT NVARCHAR(50))

AS
BEGIN
	DECLARE @@CROSS_NO INT
	DECLARE @VALUEDATE DATETIME

SELECT
	@@CROSS_NO = ISNULL(MAX(CONVERT(INT, CROSSREFERENCENO)), 0)--ISNULL(MAX(CROSSREFERENCENO), 0)
FROM BANKRECO(NOLOCK)

				DELETE FROM T 
				FROM TEMP_CMS_DATA T,RECON_CMS_DATA R
				WHERE ISNULL(T.ROWTYPE,'')=ISNULL(R.ROWTYPE,'')
				AND ISNULL(T.VALUEDATE,'')=ISNULL(R.VALUEDATE,'')
				AND ISNULL(T.DRCR,'')=ISNULL(R.DRCR,'')
				AND ISNULL(T.INST_AMT,0.0)=ISNULL(R.INST_AMT,0.0)
				AND ISNULL(SUBSTRING(T.INST_NO_CHECK, PATINDEX('%[^0]%',T.INST_NO_CHECK), 10),'')=ISNULL(SUBSTRING(R.INST_NO_CHECK, PATINDEX('%[^0]%',R.INST_NO_CHECK), 10),'')
				----AND ISNULL(T.CLTCODE,'')=ISNULL(R.CLTCODE,'')
				AND ISNULL(T.CLTACCNO,'')=ISNULL(R.CLTACCNO,'')
				AND ISNULL(SUBSTRING(T.BANKCODE, PATINDEX('%[^0]%',T.BANKCODE), 10),'')=ISNULL(SUBSTRING(R.BANKCODE, PATINDEX('%[^0]%',R.BANKCODE), 10),'')
				AND R.ROWTYPE<>'DR'

				IF EXISTS(SELECT * FROM  TEMP_CMS_DATA WHERE UPLOADID=@UPLOADID)			
				INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(0,@UPLOADID)
				ELSE
				INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(1,@UPLOADID)
				
				

				SELECT @VALUEDATE=MAX(VALUEDATE) FROM TEMP_CMS_DATA WHERE UPLOADID=@UPLOADID

CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME,
NARRATION NVARCHAR(255))

CREATE TABLE #LEDGER_TO_MAP_DUPLICATE(ROWNO INT,
VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME
)

IF EXISTS(SELECT TOP 1 * FROM TEMP_CMS_DATA WHERE UPLOADID=@UPLOADID)
BEGIN
INSERT INTO #LEDGER_TO_MAP
	SELECT
		L.VNO
		,L.VTYP
		,L.BOOKTYPE
		,CLTCODE
		,DDNO
		,RELAMT
		,L1.DRCR
		,L.Edt
		,L.Vdt
		,L.NARRATION
	FROM	LEDGER L
			,LEDGER1 L1
	WHERE L.VNO = L1.VNO
	AND L.VTYP = L1.VTYP
	AND L.LNO = L1.LNO
	AND L.BOOKTYPE = L1.BOOKTYPE
	AND L1.RELDT = ''
	AND EXISTS (SELECT
			VNO
		FROM LEDGER L11 (NOLOCK)
		WHERE L11.VNO = L1.VNO
		AND L11.VTYP = L1.VTYP
		AND L11.BOOKTYPE = L1.BOOKTYPE
		AND L11.CLTCODE = @BANKCODE
		AND L11.VTYP IN (2, 3, 17)
		AND L11.Vdt<=@VALUEDATE)

END

	CREATE CLUSTERED INDEX IDXR_LEDGER_TO_MAP ON #LEDGER_TO_MAP
	(   
		--VDT,
		VNO,
		VTYP,
		BOOKTYPE	
	)
		INSERT INTO #LEDGER_TO_MAP_DUPLICATE
		SELECT COUNT(*)AS 'ROWNO' ,VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT FROM 
		#LEDGER_TO_MAP
		GROUP BY VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT 
		HAVING COUNT(*)=1
		
		
SELECT UPLOADID, BANKCODE, ROWTYPE, VALUEDATE, DRCR, INST_NO_CHECK, INST_AMT
, CLTCODE, CLTACCNO INTO #CMS_DATA_DUPLICATE FROM TEMP_CMS_DATA
GROUP BY UPLOADID, BANKCODE, ROWTYPE, VALUEDATE, DRCR, INST_NO_CHECK, INST_AMT
, CLTCODE, CLTACCNO
HAVING COUNT(*)>1

IF(@BANKACCOUNT LIKE '%CAP360%'	OR @BANKACCOUNT LIKE '%NCDEX384%')
		BEGIN
			UPDATE C
			SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
			,C.VNO = L.VNO
			,C.VTYP = L.VTYP
			,C.BOOKTYPE = L.BOOKTYPE
			,C.MATCHCODE = 7
			,C.CLTCODE=L.CLTCODE			
			FROM TEMP_CMS_DATA C (NOLOCK)
			, #LEDGER_TO_MAP_DUPLICATE L (NOLOCK)			
			WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%', L.DDNO), 10) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%', C.INST_NO_CHECK), 10)
			AND L.DDNO<>''
			AND C.DRCR = L.DRCR
			AND C.INST_AMT = L.RELAMT
			AND CONVERT(DATETIME, CONVERT(VARCHAR(11), L.VDT, 109)) <= C.VALUEDATE
			AND C.UPLOADID = @UPLOADID
			AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
			WHERE E.BANKCODE=C.BANKCODE
			AND E.CLTACCNO=C.CLTACCNO
			AND E.CLTCODE=C.CLTCODE
			AND E.DRCR=C.DRCR
			AND E.INST_AMT=C.INST_AMT
			AND E.INST_NO_CHECK=C.INST_NO_CHECK)
			

		END
		ELSE
		
		BEGIN
			UPDATE C
			SET	MATCHEDFLAG = 1
				,MODIFIEDDATE = GETDATE()
				,C.VNO = L.VNO
				,C.VTYP = L.VTYP
				,C.BOOKTYPE = L.BOOKTYPE
				,C.MATCHCODE=1
				,C.CLTCODE=L.CLTCODE
			--, C.BANKCODE = @BANKCODE
			FROM TEMP_CMS_DATA C (NOLOCK)
			, #LEDGER_TO_MAP L (NOLOCK)
			,CLS_MULTIBANKID_RECO_VW M--, [MULTIBANKID] M (NOLOCK)
			WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%', L.DDNO), 10) = SUBSTRING(C.INST_NO_CHECK, PATINDEX('%[^0]%', C.INST_NO_CHECK), 10)
			AND L.DDNO<>''
			AND C.DRCR = L.DRCR
			AND C.INST_AMT = L.RELAMT
			--AND M.CLTCODE = C.CLTCODE
			AND RIGHT(M.ACCNO, 5) = RIGHT(C.CLTACCNO, 5)
			AND M.CLTCODE = L.CLTCODE
			AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=C.VALUEDATE
			AND C.UPLOADID=@UPLOADID
			AND NOT EXISTS(SELECT BANKCODE FROM #CMS_DATA_DUPLICATE E 
			WHERE E.BANKCODE=C.BANKCODE
			AND E.CLTACCNO=C.CLTACCNO
			AND E.CLTCODE=C.CLTCODE
			AND E.DRCR=C.DRCR
			AND E.INST_AMT=C.INST_AMT
			AND E.INST_NO_CHECK=C.INST_NO_CHECK)
	 END
	 
UPDATE C SET C.MATCHEDFLAG = 0
,C.MODIFIEDDATE = ''
,C.VNO = ''
,C.VTYP = ''
,C.BOOKTYPE = ''
,C.MATCHCODE=''
,C.CLTCODE=''
FROM TEMP_CMS_DATA C
WHERE EXISTS (SELECT R.VNO FROM TEMP_CMS_DATA R 
WHERE C.VNO=R.VNO
AND C.VTYP=R.VTYP AND C.BOOKTYPE=R.BOOKTYPE
GROUP BY R.VNO HAVING COUNT(*)>1)
AND C.UPLOADID=@UPLOADID 

				 
INSERT INTO RECON_CMS_DATA (UPLOADID
, BANKCODE
, ROWTYPE
, VALUEDATE
, DRCR
, INST_NO_CHECK
, INST_AMT
, DRAWER_NAME
, CLTCODE
, CLTACCNO
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY
, CROSS_NO
,MATCHCODE)
	SELECT
		UPLOADID
		,@BANKCODE
		,ROWTYPE
		,VALUEDATE
		,DRCR
		,INST_NO_CHECK
		,INST_AMT
		,DRAWER_NAME
		,CLTCODE
		,CLTACCNO
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CASE
			WHEN MATCHEDFLAG = 1 THEN 'AUTORECO'
			ELSE 'PENDING'
		END AS UPLOADSTATUS
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY
		,@@CROSS_NO + SNO
		,MATCHCODE
	FROM TEMP_CMS_DATA(NOLOCK)
	WHERE UPLOADID=@UPLOADID

UPDATE L1
SET	RELDT = VALUEDATE
	,REFNO = @@CROSS_NO + SNO
FROM TEMP_CMS_DATA N (NOLOCK)
, LEDGER1 L1 (NOLOCK)
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND N.UPLOADID=@UPLOADID

UPDATE L1
SET EDT = VALUEDATE
FROM TEMP_CMS_DATA N (NOLOCK)
, LEDGER L1 (NOLOCK)
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'
AND UPLOADID=@UPLOADID

/* BANKRECO INSERT STATEMENT FOR CMS DATA */
INSERT INTO BANKRECO (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, CMS_SRNO)
	SELECT
		BANKCODE
		,VALUEDATE
		,LEFT('CMS ' + BR.DRAWER_NAME + ' ' + CLTACCNO,50) AS 'DESCRIPTION'
		,INST_AMT
		,DRCR
		,VALUEDATE
		,LEFT(INST_NO_CHECK, 30)
		,'BROKER'
		,'BROKER'
		,UPLOADBY
		,CROSS_NO
		,CASE
			WHEN UPLOADSTATUS = 'AUTORECO' THEN 'MATCHED'
			ELSE 'UNMATCHED'
		END
		,MICRNO
		,0
		,@UPLOADID
		,0
	FROM	RECON_CMS_DATA BR
			,ACMAST A
	WHERE BANKCODE = A.CLTCODE
	AND ACCAT = 2
	AND BR.UPLOADID = @UPLOADID

DECLARE @TOTALFILERECORD INT

SELECT 	@TOTALFILERECORD = COUNT(*) FROM RECON_CMS_DATA WHERE UPLOADID = @UPLOADID

IF (@TOTALFILERECORD > 0) 
BEGIN
				
	IF EXISTS(SELECT * FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID)
		BEGIN
				
				UPDATE L
					SET L.UPLOADSTATUS = 'SUCCESS', L.SEGMENT=@SEGMENT
					,L.UPLOADFILENAME=R.UPLOADFILENAME,L.UPLOADBY=R.UPLOADBY,L.VALUEDATE=@VALUEDATE,FILEUPLOAD_EDATE=GETDATE()
					FROM RECON_BANK_FILEUPLOAD_LOGS L,RECON_BANK_FILEUPLOAD_LOGS_VW R
					WHERE L.UPLOADID=R.UPLOADID
					AND L.UPLOADID = @UPLOADID
					
					UPDATE R
					SET BANKACCOUNT = BM.BANKACCOUNT
					FROM RECON_BANK_FILEUPLOAD_LOGS R, RECON_BANK_MASTER_VW BM
					WHERE R.SEGMENT = BM.SEGMENT
					AND R.BANKCODE = BM.BANKCODE
					AND R.FILETYPE = BM.FILETYPE
					AND R.BANKNAME = BM.BANKNAME
					AND R.UPLOADID = @UPLOADID

		END
	ELSE
		BEGIN
		
			INSERT INTO RECON_BANK_FILEUPLOAD_LOGS(UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE)
			SELECT  UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE
			FROM RECON_BANK_FILEUPLOAD_LOGS_VW
			WHERE UPLOADID=@UPLOADID

			UPDATE L
					SET L.UPLOADSTATUS = 'SUCCESS', L.SEGMENT=@SEGMENT
					,L.UPLOADFILENAME=R.UPLOADFILENAME,L.UPLOADBY=R.UPLOADBY,L.VALUEDATE=@VALUEDATE,FILEUPLOAD_EDATE=GETDATE()
					FROM RECON_BANK_FILEUPLOAD_LOGS L,RECON_BANK_FILEUPLOAD_LOGS_VW R
					WHERE L.UPLOADID=R.UPLOADID
					AND L.UPLOADID = @UPLOADID
					
					UPDATE R
					SET BANKACCOUNT = BM.BANKACCOUNT
					FROM RECON_BANK_FILEUPLOAD_LOGS R, RECON_BANK_MASTER_VW BM
					WHERE R.SEGMENT = BM.SEGMENT
					AND R.BANKCODE = BM.BANKCODE
					AND R.FILETYPE = BM.FILETYPE
					AND R.BANKNAME = BM.BANKNAME
					AND R.UPLOADID = @UPLOADID

		END

END
ELSE
BEGIN
IF EXISTS(SELECT * FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID)
			DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID = @UPLOADID

END

DELETE FROM TEMP_CMS_DATA WHERE UPLOADID=@UPLOADID

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_MULTIBANK_NONCMS_INNER_PROCESS
-- --------------------------------------------------





CREATE PROCEDURE [dbo].[CLS_RECON_MULTIBANK_NONCMS_INNER_PROCESS]
(@UPLOADID NVARCHAR(50)
,@BANKACCOUNT NVARCHAR(50)
,@BANKCODE NVARCHAR(50)
,@BANKNAME NVARCHAR(50)
,@FILETYPE NVARCHAR(50)
,@SEGMENT NVARCHAR(50))

AS

BEGIN
	DECLARE @@CROSS_NO INT
	DECLARE @VALUEDATE DATETIME

SELECT	@@CROSS_NO = ISNULL(MAX(CONVERT(INT, CROSSREFERENCENO)), 0)
FROM BANKRECO(NOLOCK)

				DELETE FROM T
				FROM TEMP_NONCMS_DATA T ,RECON_NONCMS_DATA R
				WHERE  ISNULL(T.DRCR,'')=ISNULL(R.DRCR,'')
				AND ISNULL(T.AMT,0.0)=ISNULL(R.AMT,0.0)
				AND ISNULL(CONVERT(DATETIME, T.VALUEDATE, 105),'')=ISNULL(R.VALUEDATE,'')
				AND ISNULL(T.REFERENCENO,'')=ISNULL(R.REFERENCENO,'')
				AND ISNULL(T.BANKACCOUNT,'')=ISNULL(R.BANKACCOUNT,'')
				AND ISNULL(SUBSTRING(T.BANKCODE, PATINDEX('%[^0]%',T.BANKCODE), 30),'')=ISNULL(SUBSTRING(R.BANKCODE, PATINDEX('%[^0]%',R.BANKCODE), 30),'')
				AND R.LEDGERBALANCE <>'DR'
				
				IF EXISTS(SELECT * FROM  TEMP_NONCMS_DATA)
				INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(0,@UPLOADID)--EXISTS_RECORDS(RECORDSTATUS)VALUES(0)
				ELSE
				INSERT INTO EXISTS_RECORDS(RECORDSTATUS,UPLOADID)VALUES(1,@UPLOADID)--EXISTS_RECORDS(RECORDSTATUS)VALUES(1)
				
				SELECT @VALUEDATE=MAX(CONVERT(DATETIME, VALUEDATE, 109)) FROM TEMP_NONCMS_DATA WHERE UPLOADID=@UPLOADID

CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME)

IF EXISTS(SELECT TOP 1 * FROM TEMP_NONCMS_DATA WHERE UPLOADID=@UPLOADID)
BEGIN
INSERT INTO #LEDGER_TO_MAP
	SELECT
		MAX(L.VNO)
		,MAX(L.VTYP)
		,MAX(L.BOOKTYPE)
		,MAX(CLTCODE)
		,DDNO
		,RELAMT
		,L1.DRCR
		,L.Edt
		,L.Vdt
	FROM	LEDGER L
			,LEDGER1 L1
	WHERE L.VNO = L1.VNO
	AND L.VTYP = L1.VTYP
	AND L.LNO = L1.LNO
	AND L.BOOKTYPE = L1.BOOKTYPE
	AND L1.RELDT = ''
	AND L1.VTYP<>'5'
	AND EXISTS (SELECT
			VNO
		FROM LEDGER L11 (NOLOCK)
		WHERE L11.VNO = L1.VNO
		AND L11.VTYP = L1.VTYP
		AND L11.BOOKTYPE = L1.BOOKTYPE
		AND L11.DRCR <> L1.DRCR
		AND L11.CLTCODE = @BANKCODE
		AND L11.Vdt<=@VALUEDATE)
	GROUP BY	DDNO
				,RELAMT
				,L1.DRCR
				,Edt
				,Vdt
	HAVING COUNT(1) = 1
END

CREATE CLUSTERED INDEX IDXR_LEDGER_TO_MAP ON #LEDGER_TO_MAP
(   
    --VDT,
	VNO,
	VTYP,
	BOOKTYPE	
)
CREATE TABLE #LEDGER_TO_MAP_NON_YES(ROWNO INT,
VNO VARCHAR(12),
VTYP INT,
BOOKTYPE VARCHAR(3),
CLTCODE VARCHAR(10),
DDNO VARCHAR(30),
RELAMT MONEY,
DRCR CHAR(1),
EDT DATETIME,
VDT DATETIME
)

IF(@BANKNAME = 'ICICI BANK' AND @FILETYPE = 'TECHPROCESS')
BEGIN 
 
	INSERT INTO #LEDGER_TO_MAP_NON_YES
	SELECT COUNT(*)AS 'ROWNO' ,VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT FROM 
	#LEDGER_TO_MAP
	GROUP BY VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT 
	HAVING COUNT(*)=1
	 
	 
	UPDATE N
	SET	MATCHEDFLAG = 1
		,MODIFIEDDATE = GETDATE()
		,N.VNO = L.VNO
		,N.VTYP = L.VTYP
		,N.BOOKTYPE = L.BOOKTYPE
		,N.MATCHCODE=6
		,N.CUSTOMERREFERENCE=L.CLTCODE
	--, N.BANKCODE = @BANKCODE /* ADD*/
	FROM TEMP_NONCMS_DATA N (NOLOCK)
	, #LEDGER_TO_MAP_NON_YES L (NOLOCK)	
	WHERE L.DDNO = N.REFERENCENO
	AND L.DDNO<>''
	--L.CLTCODE = N.REFERENCENO
	AND L.RELAMT = CONVERT(MONEY, N.AMT)
	AND N.DRCR = L.DRCR
	AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
	AND MATCHEDFLAG = 0
END
IF(@BANKNAME = 'ICICI BANK' AND @FILETYPE = 'NON-CMS')
BEGIN

	INSERT INTO #LEDGER_TO_MAP_NON_YES
	SELECT COUNT(*)AS 'ROWNO' ,VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT 
	FROM #LEDGER_TO_MAP
	GROUP BY VNO,VTYP,BOOKTYPE,CLTCODE,DDNO,RELAMT,DRCR,EDT,VDT 
	HAVING COUNT(*)=1

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM TEMP_NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP_NON_YES L (NOLOCK)
WHERE LEFT(L.DDNO ,15)= LEFT(N.REFERENCENO,15)
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=N.VALUEDATE
AND LEFT(N.REFERENCENO,15)<>''
AND N.UPLOADID=@UPLOADID
IF EXISTS(SELECT * FROM TEMP_NONCMS_DATA WHERE DESCRIPTION LIKE 'BIL/%' )
	BEGIN
		UPDATE N
		SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
			,N.VNO = L.VNO
			,N.VTYP = L.VTYP
			,N.BOOKTYPE = L.BOOKTYPE
			,N.MATCHCODE=10
			,N.CUSTOMERREFERENCE=L.CLTCODE	
		FROM TEMP_NONCMS_DATA N (NOLOCK)
		, #LEDGER_TO_MAP_NON_YES L (NOLOCK)
		WHERE SUBSTRING(L.DDNO, PATINDEX('%[^0]%',L.DDNO), 30) = SUBSTRING(.DBO.PIECE(DESCRIPTION,'/',2), PATINDEX('%[^0]%',.DBO.PIECE(DESCRIPTION,'/',2)), 30)
		AND L.DDNO<>''
		AND L.RELAMT = CONVERT(MONEY, N.AMT)
		AND N.DRCR = L.DRCR
		AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=CONVERT (DATETIME ,N.VALUEDATE,103)
	END
END


IF(@BANKNAME <> 'ICICI BANK' )
BEGIN
UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM TEMP_NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP L (NOLOCK)
WHERE LEFT(L.DDNO ,15)= LEFT(N.REFERENCENO,15)
AND L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=N.VALUEDATE
AND LEN(L.DDNO)<=15
AND N.UPLOADID=@UPLOADID

UPDATE N
SET	MATCHEDFLAG = 1
	,MODIFIEDDATE = GETDATE()
	,N.VNO = L.VNO
	,N.VTYP = L.VTYP
	,N.BOOKTYPE = L.BOOKTYPE
	,N.MATCHCODE=2
	,N.CUSTOMERREFERENCE=L.CLTCODE
FROM TEMP_NONCMS_DATA N (NOLOCK)
, #LEDGER_TO_MAP L (NOLOCK)
WHERE L.DDNO = N.REFERENCENO
AND  L.DDNO<>''
AND L.RELAMT = CONVERT(MONEY, N.AMT)
AND N.DRCR = L.DRCR
AND CONVERT (DATETIME,CONVERT (VARCHAR(11) ,L.VDT,109))<=N.VALUEDATE
AND LEN(L.DDNO)>15
AND N.UPLOADID=@UPLOADID
END

UPDATE C SET C.MATCHEDFLAG = 0
,C.MODIFIEDDATE = ''
,C.VNO = ''
,C.VTYP = ''
,C.BOOKTYPE = ''
,C.MATCHCODE=''
,CUSTOMERREFERENCE=''
FROM TEMP_NONCMS_DATA C
WHERE EXISTS (SELECT R.VNO FROM TEMP_NONCMS_DATA R 
WHERE C.VNO=R.VNO
AND C.VTYP=R.VTYP AND C.BOOKTYPE=R.BOOKTYPE
GROUP BY R.VNO HAVING COUNT(*)>1)
AND C.UPLOADID=@UPLOADID 

INSERT INTO [DBO].[RECON_NONCMS_DATA] ([UPLOADID]
, [BANKACCOUNT]
, [BANKCODE]
, [DESCRIPTION]
, [LEDGERBALANCE]
, [DRCR]
, [AMT]
, [VALUEDATE]
, [REFERENCENO]
, [CLTACCOUNT]
, [CUSTOMERREFERENCE]
, [TRANSACTIONDETAIL]
, [VNO]
, [VTYP]
, [BOOKTYPE]
, [MATCHEDFLAG]
, [UPLOADSTATUS]
, [UPLOADEDDATE]
, [MODIFIEDDATE]
, [UPLOADBY]
, [BOOKDATE]
, [CROSS_NO]
, [MATCHCODE])
	SELECT
		UPLOADID
		,BANKACCOUNT
		,@BANKCODE
		,DESCRIPTION
		,LEDGERBALANCE
		,DRCR
		,AMT
		,CONVERT(DATETIME, VALUEDATE, 105) VALUEDATE
		,REFERENCENO
		,CLTACCOUNT
		,CUSTOMERREFERENCE
		,TRANSACTIONDETAIL
		,VNO
		,VTYP
		,BOOKTYPE
		,MATCHEDFLAG
		,CASE
			WHEN MATCHEDFLAG = 1 THEN 'AUTORECO'
			ELSE 'PENDING'
		END AS UPLOADSTATUS
		,CAST(UPLOADEDDATE AS DATETIME)
		,CAST(MODIFIEDDATE AS DATETIME)
		,UPLOADBY
		,CONVERT(DATETIME, VALUEDATE, 105) VALUEDATE
		,CONVERT(INT, @@CROSS_NO) + SRNONCMS
		,MATCHCODE
	FROM TEMP_NONCMS_DATA(NOLOCK)
	WHERE UPLOADID=@UPLOADID

UPDATE L1
SET	RELDT = CONVERT(DATETIME, VALUEDATE, 105)
	,REFNO = @@CROSS_NO + SRNONCMS
FROM TEMP_NONCMS_DATA N (NOLOCK)
, LEDGER1 L1 (NOLOCK)
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND N.UPLOADID=@UPLOADID

UPDATE L1
SET EDT = VALUEDATE
FROM TEMP_NONCMS_DATA N (NOLOCK)
, LEDGER L1 (NOLOCK)
WHERE N.VNO = L1.VNO
AND N.VTYP = L1.VTYP
AND N.BOOKTYPE = L1.BOOKTYPE
AND EDT LIKE 'DEC 31 2049%'
AND N.UPLOADID=@UPLOADID


/* BANKRECO INSERT STATEMENT FOR NONCMS DATA */

INSERT INTO BANKRECO (CLTCODE, BOOKDATE, DESCRIPTION, AMOUNT, DRCR, VALUEDATE, REFERENCENO, STATUSID, STATUSNAME, LOGINNAME, CROSSREFERENCENO, STATUS, MICRNO, DUMMY1, DUMMY2, CMS_SRNO)
	SELECT
		BANKCODE
		,BOOKDATE
		,LEFT([DESCRIPTION], 50)
		,AMT
		,DRCR
		,VALUEDATE
		,LEFT(REFERENCENO, 30)
		,'BROKER'
		,'BROKER'
		,UPLOADBY
		,CROSS_NO
		,CASE
			WHEN UPLOADSTATUS = 'AUTORECO' THEN 'MATCHED'
			ELSE 'UNMATCHED'
		END
		,MICRNO
		,0
		,@UPLOADID
		,0
	FROM	RECON_NONCMS_DATA BR 
			,ACMAST A
	WHERE BANKCODE = CLTCODE
	AND ACCAT = 2	
	AND UPLOADID = @UPLOADID
	AND BANKACCOUNT=@BANKACCOUNT
	AND CHARINDEX((SELECT EXCLUDEDATA FROM RECON_EXCLUDE_MASTER_VW EM
	WHERE  FILETYPE=@FILETYPE AND BANKNAME=@BANKNAME),BR.DESCRIPTION )<>1


		DECLARE @TOTALFILERECORD INT

		SELECT	@TOTALFILERECORD = COUNT(*)FROM RECON_NONCMS_DATA
		WHERE UPLOADID = @UPLOADID

		IF (@TOTALFILERECORD > 0) 
		BEGIN
			IF EXISTS(SELECT * FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID)
				BEGIN

					UPDATE L
					SET L.UPLOADSTATUS = 'SUCCESS', L.SEGMENT=@SEGMENT,BANKCODE=@BANKCODE
					,L.UPLOADFILENAME=R.UPLOADFILENAME,L.UPLOADBY=R.UPLOADBY,L.VALUEDATE=@VALUEDATE,FILEUPLOAD_EDATE=GETDATE()
					FROM RECON_BANK_FILEUPLOAD_LOGS L,RECON_BANK_FILEUPLOAD_LOGS_VIEW R
					WHERE L.UPLOADID=R.UPLOADID
					AND L.UPLOADID = @UPLOADID
					UPDATE R
					SET BANKACCOUNT = BM.BANKACCOUNT
					FROM RECON_BANK_FILEUPLOAD_LOGS R, RECON_BANK_MASTER_VW BM
					WHERE R.SEGMENT = BM.SEGMENT
					AND R.BANKCODE = BM.BANKCODE
					AND R.FILETYPE = BM.FILETYPE
					AND R.BANKNAME = BM.BANKNAME
					AND R.UPLOADID = @UPLOADID

				END
			ELSE
				BEGIN

					INSERT INTO RECON_BANK_FILEUPLOAD_LOGS(UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE)
					SELECT  UPLOADID,SEGMENT,BANKCODE,BANKNAME,FILETYPE,BANKACCOUNT,UPLOADFILENAME,MODIFIEDDATE,UPLOADSTATUS,UPLOADBY,FILEUPLOAD_SDATE,FILEUPLOAD_EDATE,VALUEDATE
					FROM RECON_BANK_FILEUPLOAD_LOGS_VIEW
					WHERE UPLOADID=@UPLOADID

					UPDATE L
					SET L.UPLOADSTATUS = 'SUCCESS', L.SEGMENT=@SEGMENT
					,L.UPLOADFILENAME=R.UPLOADFILENAME,L.UPLOADBY=R.UPLOADBY,L.VALUEDATE=@VALUEDATE,FILEUPLOAD_EDATE=GETDATE()
					FROM RECON_BANK_FILEUPLOAD_LOGS L,RECON_BANK_FILEUPLOAD_LOGS_VIEW R
					WHERE L.UPLOADID=R.UPLOADID
					AND L.UPLOADID = @UPLOADID
					
					UPDATE R
					SET BANKACCOUNT = BM.BANKACCOUNT
					FROM RECON_BANK_FILEUPLOAD_LOGS R, RECON_BANK_MASTER_VW BM
					WHERE R.SEGMENT = BM.SEGMENT
					AND R.BANKCODE = BM.BANKCODE
					AND R.FILETYPE = BM.FILETYPE
					AND R.BANKNAME = BM.BANKNAME
					AND R.UPLOADID = @UPLOADID

				END

		END
		ELSE
		BEGIN
		IF EXISTS(SELECT * FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID)
					--DELETE FROM RECON_BANK_FILEUPLOAD_LOGS WHERE UPLOADID = @UPLOADID
					print 'nodata'

		END

		DELETE FROM TEMP_NONCMS_DATA WHERE UPLOADID=@UPLOADID

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_AXIS_PROCESS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_AXIS_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 

AS
BEGIN

INSERT INTO #NONCMS_DATA (
		UPLOADID
		, BANKACCOUNT
		, BANKCODE
		, DESCRIPTION
		, LEDGERBALANCE
		, DRCR
		, AMT
		, VALUEDATE
		, REFERENCENO
		, CLTACCOUNT
		, CUSTOMERREFERENCE
		, TRANSACTIONDETAIL
		, VNO
		, VTYP
		, BOOKTYPE
		, MATCHEDFLAG
		, UPLOADSTATUS
		, UPLOADEDDATE
		, MODIFIEDDATE
		, UPLOADBY)
	SELECT
	U.UPLOADID
	,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
	,@BANKCODE AS 'BANKCODE'
	,RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',4) , ''))) AS 'DESCRIPTION'
	,'' AS 'LEDGERBALANCE'	
	,CASE WHEN RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',6) , '')))='CR' THEN 'C'
		WHEN RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',6) , '')))='DR' THEN 'D' ELSE '' END AS 'DRCR'
	
	,CAST (RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'',5))) AS DECIMAL(20,2)) AS 'AMT'
	--,CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'',2))) AS DATETIME) AS 'VALUEDATE'
	,CONVERT(DATETIME, RTRIM(LTRIM(.DBO.PIECE(FILE_DATA,'',2))), 103) AS 'VALUEDATE'
	,CASE WHEN  DBO.PIECE(FILE_DATA,'',4) LIKE '%ICONN/%' THEN .DBO.PIECE(DBO.PIECE(FILE_DATA,'',4),'/',2)
		  WHEN ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='' OR ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='-'  THEN '' 	        
		  ELSE ISNULL(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'',3))) , '')  END AS 'REFERENCENO'
	,'' AS 'CLTACCOUNT'
	,'' AS 'CUSTOMERREFERENCE'
	,'' AS 'TRANSACTIONDETAIL'
	,'' AS 'VNO'
	,'' AS 'VTYP'
	,0  AS 'BOOKTYPE'
	,0
	,'PENDING' AS 'UPLOADSTATUS'
	,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
	,GETDATE()
	,@UNAME	
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND ISNULL(DBO.PIECE(FILE_DATA,'',5) , '')<>''
	AND ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>'VALUE DATE'

	--SELECT * FROM #NONCMS_DATA RETURN
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_BILLDESK_PROCESS
-- --------------------------------------------------






CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_BILLDESK_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@UPLOADFILENAME NVARCHAR(200)
,@UNAME NVARCHAR(50)) 
AS

BEGIN
INSERT INTO #NONCMS_DATA (UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CUSTOMERREFERENCE
, TRANSACTIONDETAIL
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY)
	SELECT
	UPLOADID
	,BANKACCOUNT
	, BANKCODE
	,LTRIM(RTRIM(.DBO.PIECE(FILE_DATA,'',6)))+'_'+LTRIM(RTRIM(.DBO.PIECE(FILE_DATA,'',8)))  AS 'DESCRIPTION'
	,'' AS 'LEDGERBALANCE'
	,'C' AS 'DRCR'
	,CAST(DBO.PIECE(FILE_DATA,'',13) AS DECIMAL(18,2)) AS 'AMT'
	,CONVERT( DATETIME,.DBO.PIECE(FILE_DATA,'',12),103) AS 'VALUEDATE'
	,LTRIM(RTRIM(.DBO.PIECE(FILE_DATA,'',11))) AS 'REFERENCENO'
	,' '
	,' '
	,' '
	,' '
	,' '
	,' '
	,0 AS 'MATCHEDFLAG'
	,UPLOADSTATUS
	,GETDATE()
	,MODIFIEDDATE
	,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND ISNULL(DBO.PIECE(FILE_DATA,'',15) , '')<>''
AND ISNULL(DBO.PIECE(FILE_DATA,'',11) , '')<>'Ref 4'


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_HDFC_PROCESS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_HDFC_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@UPLOADFILENAME NVARCHAR(200)
,@UNAME NVARCHAR(50)) 
AS

BEGIN

DECLARE @D VARCHAR(50),@VALUEDATE VARCHAR(11)
SELECT  @D=.DBO.PIECE(@UPLOADFILENAME,'_',2)
 
SELECT @VALUEDATE= STUFF(STUFF( @D, 5, 0, '/'), 3, 0, '/')-- DD/MM/YYYY

IF(@VALUEDATE='' OR @VALUEDATE IS NULL)
BEGIN
	DELETE FROM MSAJAG..FILEDATA	WHERE PROGID = @UPLOADID
	SELECT		'PLEASE ADD DATE IN THE FILE NAME'
	DELETE FROM RECON_BANK_UPLOAD_PROCESS_INFO WHERE UPLOADID=@UPLOADID
	RETURN
END
--select @VALUEDATE
CREATE TABLE #NONCMS_HDFC (
	UPLOADID NVARCHAR(50),
	BANKACCOUNT NVARCHAR(50),
	BANKCODE NVARCHAR(50),	
	BOOKDATE NVARCHAR(50),
	DESCRIPTION NVARCHAR(500),
	LEDGERBALANCE NVARCHAR (500) ,
	CREDITAMT NVARCHAR (50),
	DEBITAMT NVARCHAR(50),
	VALUEDATE NVARCHAR(50),
	REFERENCENO NVARCHAR (50),
	TRANSACTIONBRANCH NVARCHAR(500),
	MATCHEDFLAG BIT,
	UPLOADSTATUS NVARCHAR(50),
	UPLOADEDDATE DATETIME,
	MODIFIEDDATE DATETIME,
	UPLOADBY NVARCHAR(50))

INSERT INTO #NONCMS_HDFC (UPLOADID,
BANKACCOUNT,
BANKCODE,
BOOKDATE,
DESCRIPTION,
LEDGERBALANCE,
CREDITAMT,
DEBITAMT,
VALUEDATE,
REFERENCENO,
TRANSACTIONBRANCH,
MATCHEDFLAG,
UPLOADSTATUS,
UPLOADEDDATE,
MODIFIEDDATE,
UPLOADBY)
	SELECT
		U.UPLOADID
		,U.BANKACCOUNT
		--,'' AS BANKACCOUNT
		, @BANKCODE 
		,.DBO.PIECE(REPLACE(F.FILE_DATA, '''', ''), '	', 1) BookType
		,.DBO.PIECE(FILE_DATA, '	', 2) Description
		,.DBO.PIECE(FILE_DATA, '	', 3) LedgerBalance
		,.DBO.PIECE(FILE_DATA, '	', 4) Credit
		,.DBO.PIECE(FILE_DATA, '	', 5) Debit
		--,.DBO.PIECE(FILE_DATA, '	', 6) ValueDate
		,@VALUEDATE AS VALUEDATE
		,.DBO.PIECE(FILE_DATA, '	', 7) ReferenceNo
		,.DBO.PIECE(FILE_DATA, '	', 8) TransactionBranch
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND.DBO.PIECE(FILE_DATA, '	', 2) <> ''



INSERT INTO #NONCMS_DATA (UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CustomerReference
, TransaCtionDetail
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY)
	SELECT
		UPLOADID
		,BANKACCOUNT
		, BANKCODE
		,DESCRIPTION
		,LEDGERBALANCE
		,CASE
			WHEN CREDITAMT <> '' THEN 'C'
			WHEN DEBITAMT <> '' THEN 'D'
			ELSE ' '
		END AS DRCR
		,CASE
			WHEN CREDITAMT <> '' THEN REPLACE(REPLACE(REPLACE(CREDITAMT, '(', ''), ')', ''), ',', '')
			WHEN DEBITAMT <> '' THEN REPLACE(REPLACE(REPLACE(DEBITAMT, '(', ''), ')', ''), ',', '')
			ELSE '0'
		END AS AMT
		,REPLACE(VALUEDATE, '/', '-')
		,REFERENCENO
		,' '
		,' '
		,' '
		,' '
		,' '
		,' '
		,MATCHEDFLAG
		,UPLOADSTATUS
		,UPLOADEDDATE
		,MODIFIEDDATE
		,UPLOADBY
	FROM #NONCMS_HDFC
	WHERE LEDGERBALANCE = ''
PRINT 'INSERTED INTO TEMP TABLE'
DROP TABLE #NONCMS_HDFC

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_ICICI_PROCESS
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_ICICI_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
) 
AS

BEGIN

UPDATE MSAJAG.DBO.FILEDATA
SET FILE_DATA = REPLACE (.DBO.PIECE(FILE_DATA,'"',1),'''','') +
.DBO.PIECE(FILE_DATA,'"',2)+
.DBO.PIECE(FILE_DATA,'"',3)+
.DBO.PIECE(FILE_DATA,'"',4)+
.DBO.PIECE(FILE_DATA,'"',5)+
REPLACE (.DBO.PIECE(FILE_DATA,'"',6),',','')+
.DBO.PIECE(FILE_DATA,'"',7)+
.DBO.PIECE(FILE_DATA,'"',8)+
.DBO.PIECE(FILE_DATA,'"',9)+
.DBO.PIECE(FILE_DATA,'"',10)+
.DBO.PIECE(FILE_DATA,'"',11)+
.DBO.PIECE(FILE_DATA,'"',12)+
.DBO.PIECE(FILE_DATA,'"',13)+
.DBO.PIECE(FILE_DATA,'"',14)+
.DBO.PIECE(FILE_DATA,'"',15)+
.DBO.PIECE(FILE_DATA,'"',16)+
.DBO.PIECE(FILE_DATA,'"',17)+
.DBO.PIECE(FILE_DATA,'"',18)+
.DBO.PIECE(FILE_DATA,'"',19)+
.DBO.PIECE(FILE_DATA,'"',21)+
.DBO.PIECE(FILE_DATA,'"',22)+
.DBO.PIECE(FILE_DATA,'"',23)
FROM MSAJAG.DBO.FILEDATA
WHERE DBO.PIECE(FILE_DATA,'"',2) IS NOT NULL

CREATE TABLE #TEMP_ICICI(UPLOADID NVARCHAR(50),ACCOUNTNUMBER NVARCHAR(50),BANKCODE NVARCHAR(50),TRANDATE DATETIME,InstNum NVARCHAR(100),TRANPARTICULAR NVARCHAR(150),TRANREMARKS NVARCHAR(150)
,DRTRANAMT  MONEY,CRTRANAMT MONEY,DEPOSITBRANCH NVARCHAR(150),MATCHEDFLAG BIT,
	UPLOADSTATUS NVARCHAR(50),
	UPLOADEDDATE DATETIME,
	MODIFIEDDATE DATETIME,
	UPLOADBY NVARCHAR(50))

INSERT INTO #TEMP_ICICI
SELECT
	U.UPLOADID
	,.DBO.PIECE(DBO.PIECE(FILE_DATA, ',', 1),':',2)
	, @BANKCODE 
	,CONVERT(DATETIME, DBO.PIECE(FILE_DATA, ',', 2), 105) 'VALUEDATE' 
	,DBO.PIECE(FILE_DATA, ',', 5) 'INSTNUM'
	,DBO.PIECE(FILE_DATA, ',', 3) 'DESCRIPTION'
	,DBO.PIECE(FILE_DATA, ',', 4) 'DESCRIPTION2'
	,CAST(DBO.PIECE(FILE_DATA, ',', 8) AS DECIMAL(20, 2)) 'DRTRANAMT'
	,CAST(DBO.PIECE(FILE_DATA, ',', 9) AS DECIMAL(20, 2)) 'CRTRANAMT'
	,DBO.PIECE(FILE_DATA, ',', 11) 'DEPOSITBRANCH'
	,0
	,U.UPLOADSTATUS
	,U.FILEUPLOAD_SDATE
	,GETDATE()
	,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
		WHERE F.PROGID = @UPLOADID
		AND DBO.PIECE(FILE_DATA, ',', 2) IS NOT NULL
		AND REPLACE(.DBO.PIECE(FILE_DATA, ',', 1), '''', '') NOT IN ('ACCOUNT NUMBER', '','--------------')
		AND DBO.PIECE(FILE_DATA, ',', 3) NOT IN ('B/F')

INSERT INTO #NONCMS_DATA (UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CUSTOMERREFERENCE
, TRANSACTIONDETAIL
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY)

SELECT 
UPLOADID
,ACCOUNTNUMBER
,BANKCODE
,TRANPARTICULAR
,''
,CASE WHEN CRTRANAMT <>'' THEN 'C' WHEN DRTRANAMT <> '' THEN 'D'		ELSE ' 'END AS DRCR
,CASE WHEN DRTRANAMT <> '' THEN REPLACE(DRTRANAMT,',','') WHEN CRTRANAMT <> '' THEN REPLACE(CRTRANAMT,',','') ELSE '0' END AS AMT
,TRANDATE
,INSTNUM AS 'REFERENCENO'
,'' AS 'CLTACCOUNT'
, '' AS 'CUSTOMERREFERENCE'
, TRANPARTICULAR+ '|'+DEPOSITBRANCH AS 'TRANSACTIONDETAIL'
,'' AS  VNO
,'' AS  VTYP
,'' AS  BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY
 FROM #TEMP_ICICI

 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_IDBI_PROCESS
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_IDBI_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 

AS
BEGIN

INSERT INTO #NONCMS_DATA (
		UPLOADID
		, BANKACCOUNT
		, BANKCODE
		, DESCRIPTION
		, LEDGERBALANCE
		, DRCR
		, AMT
		, VALUEDATE
		, REFERENCENO
		, CLTACCOUNT
		, CUSTOMERREFERENCE
		, TRANSACTIONDETAIL
		, VNO
		, VTYP
		, BOOKTYPE
		, MATCHEDFLAG
		, UPLOADSTATUS
		, UPLOADEDDATE
		, MODIFIEDDATE
		, UPLOADBY)
	SELECT
	U.UPLOADID
	,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
	,@BANKCODE AS 'BANKCODE'
	,RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',3) , ''))) AS 'DESCRIPTION'
	,'' AS 'LEDGERBALANCE'	
	,CASE WHEN RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',5) , '')))='CR' THEN 'C'
		WHEN RTRIM(LTRIM(ISNULL(DBO.PIECE(FILE_DATA,'',5) , '')))='DR' THEN 'D' ELSE '' END AS 'DRCR'
	
	,CAST (RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'',7))) AS DECIMAL(20,2)) AS 'AMT'	
	,CONVERT(DATETIME, RTRIM(LTRIM(.DBO.PIECE(FILE_DATA,'',2))), 103) AS 'VALUEDATE'
	,CASE WHEN  DBO.PIECE(FILE_DATA,'',3) LIKE '%IPAY/%' THEN .DBO.PIECE(DBO.PIECE(FILE_DATA,'',3),'/',4)
		  --WHEN ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='' OR ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='-'  THEN '' 	        
		  ELSE ''  END AS 'REFERENCENO'
	,'' AS 'CLTACCOUNT'
	,'' AS 'CUSTOMERREFERENCE'
	,'' AS 'TRANSACTIONDETAIL'
	,'' AS 'VNO'
	,'' AS 'VTYP'
	,0  AS 'BOOKTYPE'
	,0
	,'PENDING' AS 'UPLOADSTATUS'
	,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
	,GETDATE()
	,@UNAME	
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND ISNULL(DBO.PIECE(FILE_DATA,'',7) , '')<>''
	AND ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>'VALUE DATE'

	--SELECT * FROM #NONCMS_DATA RETURN
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_IDFC_PROCESS
-- --------------------------------------------------





CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_IDFC_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@UPLOADFILENAME NVARCHAR(200)
,@UNAME NVARCHAR(50)) 
AS

BEGIN
INSERT INTO #NONCMS_DATA (UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CUSTOMERREFERENCE
, TRANSACTIONDETAIL
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY)
	SELECT
		UPLOADID
		,BANKACCOUNT
		, BANKCODE
		,CASE WHEN .DBO.PIECE(FILE_DATA,'',3) LIKE '%MUMBAI|IDLCC|%' THEN .DBO.PIECE(.DBO.PIECE(FILE_DATA,'',3),'|',4) ELSE .DBO.PIECE(FILE_DATA,'',3)END  AS 'DESCRIPTION'
		,'' AS 'LEDGERBALANCE'
		, CASE WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5)) <> 0.00 THEN 'D'
			   WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6))<> 0.00 THEN 'C' ELSE '' END AS 'DRCR'
		,CASE  WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5)) <> 0.00 THEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5))
			   WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6))<> 0.00 THEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6)) ELSE '0.00' END AS 'AMT'
		, CONVERT( DATETIME,.DBO.PIECE(FILE_DATA,'',2),103) AS 'VALUEDATE'
		,.DBO.PIECE(FILE_DATA,'',4) AS 'REFERENCENO'
		,' '
		,' '
		,' '
		,' '
		,' '
		,' '
		,0 AS 'MATCHEDFLAG'
		,UPLOADSTATUS
		,GETDATE()
		,MODIFIEDDATE
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>''
AND ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>'Value Date'

--SELECT * FROM #NONCMS_DATA RETURN

END

--SELECT DRCR= CASE WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5)) <> 0.00 THEN 'D'
--WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6))<> 0.00 THEN 'C' ELSE '' END ,
--AMOUNT=CASE WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5)) <> 0.00 THEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',5))
--WHEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6))<> 0.00 THEN CONVERT(NUMERIC, .DBO.PIECE(REPLACE(FILE_DATA, ',', ''),'',6)) ELSE '0.00' END 

--FROM MSAJAG..FILEDATA
--WHERE ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>''
--AND ISNULL(DBO.PIECE(FILE_DATA,'',2) , '')<>'Value Date'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_INDUSIND_PROCESS
-- --------------------------------------------------




CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_INDUSIND_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 
AS

BEGIN

IF(@FILE_PATH<>'')
	BEGIN
--SELECT @FILE_PATH RETURN
DECLARE @SQL NVARCHAR(MAX)
SET @SQL="SELECT * INTO XLImport FROM OPENDATASOURCE('Microsoft.Ace.OLEDB.12.0',
'Data Source="+@FILE_PATH +";Extended Properties=Excel 8.0')...[Sheet1$]"
EXEC (@SQL)
PRINT @SQL


			INSERT INTO #NONCMS_DATA 
			SELECT
			@UPLOADID
			,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
			,@BANKCODE AS BANKCODE
			,F5 AS DESCRIPTION
			,'' AS LEDGERBALANCE
			,CASE WHEN ISNULL(F4 , '')='Credit' THEN 'C' ELSE 'D' END AS DRCR
			,CASE WHEN F6<>'' THEN CAST (F6 AS DECIMAL(20,2))  ELSE CAST (F7 AS DECIMAL(20,2)) END  --CAST (DBO.PIECE(FILE_DATA,',',5) AS DECIMAL(20,2)) AS AMT
			,CONVERT(DATETIME,F2,105)  AS VALUEDATE
			,CASE WHEN F5 LIKE '%/TRF TO %' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (F5,CHARINDEX('/TRF TO',F5)+8,LEN(F5)),'/',1)))
			WHEN F5 LIKE '%/TRF FRM%' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (F5,CHARINDEX('/TRF FRM',F5)+8,LEN(F5)),'///',1)))
			WHEN F5 LIKE '%PURCHASE DT%' THEN RTRIM(LTRIM(REPLACE(REPLACE(DBO.PIECE(F5,', ',3),'C/NO ',''),'///','')))
			--REPLACE(REPLACE(DBO.PIECE('PURCHASE DT 200117, ZR1130R, C/NO 1391762///',', ',3),'C/NO ',''),'///','')
			ELSE '' END	 AS REFERENCENO
			,'' AS CLTACCOUNT
			,'' AS CUSTOMERREFERENCE
			,'' AS TRANSACTIONDETAIL
			,'' AS VNO
			,'' AS VTYP
			,'' AS BOOKTYPE
			,0
			,'PENDING' AS 'UPLOADSTATUS'
			,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
			,GETDATE()
			,@UNAME	
			FROM XLImport 
			WHERE F2<>''
			AND F1 NOT IN ('CustomerName','Bank Reference')
			AND F4 NOT IN('ToDate')
				
		DROP TABLE XLImport
		
	END
	IF(@FILE_PATH='')
	BEGIN
	--SELECT .dbo.piece(DBO.PIECE(FILE_DATA,'',4),':',2) FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID  and DBO.PIECE(FILE_DATA,'',4) like '%Account No :%'

				INSERT INTO #NONCMS_DATA 
				SELECT
				@UPLOADID
				,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
				,@BANKCODE AS BANKCODE
				,ISNULL(DBO.PIECE(FILE_DATA,'',4) , '') AS DESCRIPTION
				,'' AS LEDGERBALANCE
				,CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,'',3) , '')='CREDIT' THEN 'C' ELSE 'D' END AS DRCR
				,CAST (DBO.PIECE(FILE_DATA,'',5) AS DECIMAL(20,2))  AS AMT
				,CONVERT(DATETIME,CONVERT(VARCHAR(11),CONVERT(DATETIME,.DBO.CLS_REMOVE_SPACE(DBO.PIECE(FILE_DATA,'',1)),103),101))
				,CASE WHEN DBO.PIECE(FILE_DATA,'',4) LIKE '%/TRF TO %' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (DBO.PIECE(FILE_DATA,'',4),CHARINDEX('/TRF TO',DBO.PIECE(FILE_DATA,'',4))+8,LEN(DBO.PIECE(FILE_DATA,'',4))),'/',1)))
				WHEN DBO.PIECE(FILE_DATA,'',4) LIKE '%/TRF FRM%' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (DBO.PIECE(FILE_DATA,'',4),CHARINDEX('/TRF FRM',DBO.PIECE(FILE_DATA,'',4))+8,LEN(DBO.PIECE(FILE_DATA,'',4))),'///',1)))
				WHEN DBO.PIECE(FILE_DATA,'',4) LIKE '%PURCHASE DT%' THEN RTRIM(LTRIM(REPLACE(REPLACE(DBO.PIECE(DBO.PIECE(FILE_DATA,'',4),', ',3),'C/NO ',''),'///','')))
				ELSE '' END  AS REFERENCENO
				,'' AS CLTACCOUNT
				,'' AS CUSTOMERREFERENCE
				,'' AS TRANSACTIONDETAIL
				,'' AS VNO
				,'' AS VTYP
				,'' AS BOOKTYPE
				,0
				,'PENDING' AS 'UPLOADSTATUS'
				,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
				,GETDATE()
				,@UNAME	
				FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
				INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
					ON U.UPLOADID = F.PROGID
					WHERE F.PROGID = @UPLOADID
					AND DBO.PIECE(FILE_DATA,'',3) IN('DEBIT','CREDIT')
					AND DBO.PIECE(FILE_DATA,'',3)<>''
					
			
	END
	/* OLD FORMAT
	BEGIN

				INSERT INTO #NONCMS_DATA 
				SELECT
				@UPLOADID
				,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
				,@BANKCODE AS BANKCODE
				,ISNULL(DBO.PIECE(FILE_DATA,'',5) , '') AS DESCRIPTION
				,'' AS LEDGERBALANCE
				,CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,'',4) , '')='CREDIT' THEN 'C' ELSE 'D' END AS DRCR
				,CASE WHEN DBO.PIECE(FILE_DATA,'',6)<>'' THEN CAST (DBO.PIECE(FILE_DATA,'',6) AS DECIMAL(20,2))  ELSE CAST (DBO.PIECE(FILE_DATA,'',7) AS DECIMAL(20,2)) END   AS AMT
				,CONVERT(DATETIME,DBO.PIECE(FILE_DATA,'',2),105)  AS VALUEDATE
				,CASE WHEN DBO.PIECE(FILE_DATA,'',5) LIKE '%/TRF TO %' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (DBO.PIECE(FILE_DATA,'',5),CHARINDEX('/TRF TO',DBO.PIECE(FILE_DATA,'',5))+8,LEN(DBO.PIECE(FILE_DATA,'',5))),'/',1)))
			WHEN DBO.PIECE(FILE_DATA,'',5) LIKE '%/TRF FRM%' THEN RTRIM(LTRIM(.DBO.PIECE(SUBSTRING (DBO.PIECE(FILE_DATA,'',5),CHARINDEX('/TRF FRM',DBO.PIECE(FILE_DATA,'',5))+8,LEN(DBO.PIECE(FILE_DATA,'',5))),'///',1)))
			WHEN DBO.PIECE(FILE_DATA,'',5) LIKE '%PURCHASE DT%' THEN RTRIM(LTRIM(REPLACE(REPLACE(DBO.PIECE(DBO.PIECE(FILE_DATA,'',5),', ',3),'C/NO ',''),'///','')))
			--REPLACE(REPLACE(DBO.PIECE('PURCHASE DT 200117, ZR1130R, C/NO 1391762///',', ',3),'C/NO ',''),'///','')
			ELSE '' END AS REFERENCE
				,'' AS CLTACCOUNT
				,'' AS CUSTOMERREFERENCE
				,'' AS TRANSACTIONDETAIL
				,'' AS VNO
				,'' AS VTYP
				,'' AS BOOKTYPE
				,0
				,'PENDING' AS 'UPLOADSTATUS'
				,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
				,GETDATE()
				,@UNAME	
				FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
				INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
					ON U.UPLOADID = F.PROGID
					WHERE F.PROGID = @UPLOADID
					AND DBO.PIECE(FILE_DATA,'',4) in('Debit','Credit')
	END
	*/
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_KOTAK_PROCESS
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_KOTAK_PROCESS]
(@UPLOADID NVARCHAR(50), @BANKCODE NVARCHAR(50) ) 
AS
BEGIN

UPDATE MSAJAG.DBO.FILEDATA
SET FILE_DATA =.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 1)
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 2)
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 3)	
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 4)
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 5)
	+REPLACE(.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 6), ',', '')
	+.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 7)
	+ISNULL(REPLACE(.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 8), ',', ''), '')
	+isnull(.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 9), '')
	+isnull(.DBO.PIECE(REPLACE(FILE_DATA, '""', ''), '"', 10), '')
WHERE PROGID = @UPLOADID
----AND .DBO.PIECE(FILE_DATA, '"=""', 4) LIKE '%FF %'

		INSERT INTO #NONCMS_DATA 
		SELECT
		U.UPLOADID
		,U.BANKACCOUNT
		,@BANKCODE AS BANKCODE
		,LEFT (RIGHT(DBO.PIECE(FILE_DATA,',',3),LEN(DBO.PIECE(FILE_DATA,',',3)) - 1) ,50)AS DESCRIPTION
		,'' AS LEDGERBALANCE
		,CASE WHEN ISNULL(DBO.PIECE(FILE_DATA,',',6) , '')='CR' THEN 'C' ELSE 'D' END AS DRCR
		,CAST (DBO.PIECE(FILE_DATA,',',5) AS DECIMAL(20,2)) AS AMT
		,CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',2),105)  AS VALUEDATE
		--,DBO.PIECE(REPLACE(.DBO.PIECE(FILE_DATA, ',', 3), ' ', '_'), '_', 2) AS REFERENCENO
		,CASE WHEN .DBO.PIECE(FILE_DATA, ',', 4) LIKE '=GBM%' THEN .DBO.PIECE (.DBO.PIECE(FILE_DATA, ',', 4),'-',2) 
			  ELSE .DBO.PIECE(REPLACE(.DBO.PIECE(FILE_DATA, ',', 3), ' ', '_'), '_', 2)  END AS REFERENCENO
		,'' AS CLTACCOUNT
		,'' AS CUSTOMERREFERENCE
		,'' AS TRANSACTIONDETAIL
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY		
		FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
		INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
		WHERE F.PROGID = @UPLOADID
		AND DBO.PIECE(FILE_DATA,',',6) IN ('DR','CR')
		AND DBO.PIECE(FILE_DATA,',',6) IS NOT NULL

		
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_RAZORPAY_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_RAZORPAY_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 

AS
BEGIN
DECLARE @SQL NVARCHAR(800)
SET @SQL = ''
SET @SQL = @SQL + ' SELECT * INTO ##CLSRECONTABLE FROM CLSRECONTABLE_'+@UPLOADID
SET @SQL = @SQL + ' DROP TABLE CLSRECONTABLE_'+@UPLOADID

PRINT @SQL
EXEC(@SQL)

INSERT INTO #NONCMS_DATA (
		UPLOADID
		, BANKACCOUNT
		, BANKCODE
		, DESCRIPTION
		, LEDGERBALANCE
		, DRCR
		, AMT
		, VALUEDATE
		, REFERENCENO
		, CLTACCOUNT
		, CUSTOMERREFERENCE
		, TRANSACTIONDETAIL
		, VNO
		, VTYP
		, BOOKTYPE
		, MATCHEDFLAG
		, UPLOADSTATUS
		, UPLOADEDDATE
		, MODIFIEDDATE
		, UPLOADBY)

	SELECT
	(SELECT UPLOADID FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'UPLOADID'
	,SEGMENT_NAME AS 'BANKACCOUNT'
	,@BANKCODE AS 'BANKCODE'
	,REF_NO+'_'+CLIENT_CODE +'_'+ SETTLEMENT_UTR+'_'+SEGMENT_NAME AS 'DESCRIPTION'
	,'' AS 'LEDGERBALANCE'	
	,'C' AS 'DRCR'	
	,CAST (RTRIM(LTRIM(AMOUNT)) AS DECIMAL(20,2)) AS 'AMOUNT'
	,CONVERT(DATETIME, RTRIM(LTRIM(SETTLEMENT_INITIATED_ON)), 103) AS 'VALUEDATE'
	, REF_NO AS 'REFERENCENO'
	,'' AS 'CLTACCOUNT'
	,'' AS 'CUSTOMERREFERENCE'
	,'' AS 'TRANSACTIONDETAIL'
	,'' AS 'VNO'
	,'' AS 'VTYP'
	,0  AS 'BOOKTYPE'
	,0
	,'PENDING' AS 'UPLOADSTATUS'
	,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
	,GETDATE()
	,@UNAME	
	FROM ##CLSRECONTABLE
	WHERE ISNULL(AMOUNT , '')<>''
	
	DROP TABLE ##CLSRECONTABLE
	--DELETE FROM #NONCMS_DATA WHERE BANKACCOUNT<>'NSE'
	--SELECT * FROM #NONCMS_DATA WHERE BANKACCOUNT='NSE'
	--return
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_SBI_PROCESS
-- --------------------------------------------------







CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_SBI_PROCESS]
( @UPLOADID NVARCHAR(50) 
,@BANKCODE NVARCHAR(50)
,@FILE_PATH NVARCHAR(150)
,@UNAME NVARCHAR(50)) 
AS

BEGIN

DECLARE @SRNO INT
SELECT * INTO #TEMP FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID

SELECT @SRNO=SRNO  FROM MSAJAG..FILEDATA WHERE PROGID=@UPLOADID
AND FILE_DATA LIKE '%TXN DATE%'AND RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',2)))='VALUE DATE'


DELETE FROM MSAJAG..FILEDATA WHERE SRNO<=@SRNO AND PROGID=@UPLOADID

--SELECT * INTO #TEMP2 FROM  #TEMP  WHERE DBO.PIECE(FILE_DATA,'	',2) <> ''
DECLARE @CLOSINGBALANCE NVARCHAR(50)
SELECT TOP 1 @CLOSINGBALANCE= CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',8))) AS MONEY) FROM MSAJAG..FILEDATA 
WHERE .DBO.PIECE(FILE_DATA,'	',2) <> ''
AND PROGID=@UPLOADID 
ORDER BY SRNO DESC

INSERT INTO #NONCMS_DATA (
	UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CUSTOMERREFERENCE
, TRANSACTIONDETAIL
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG

, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY
)
	SELECT
	U.UPLOADID
	,(SELECT BANKACCOUNT FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'BANKACCOUNT'
	,@BANKCODE BANKCODE
	,RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',3))) 
	,'' AS 'LEDGERBALANCE'	
	,CASE WHEN RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',6)))='' THEN 'C' 
	  WHEN RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',7)))='' THEN 'D' ELSE '' END AS 'DRCR'	
	,CASE WHEN DBO.PIECE(FILE_DATA,'	',6) ='' THEN CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',7))) AS MONEY)
	  WHEN DBO.PIECE(FILE_DATA,'	',7) ='' THEN CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',6))) AS MONEY) ELSE 0 END AS 'AMT'
	,CAST(RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',2))) AS DATETIME ) AS 'VALUEDATE'
	--,RTRIM(LTRIM(.DBO.PIECE(.DBO.PIECE(FILE_DATA,'	',4),'/',2))) AS 'REFERENCENO'
	--, SUBSTRING (SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4))),CHARINDEX('IGACV',SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4)))),LEN(SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4))))) AS 'REFERENCENO'
	--, CASE WHEN .DBO.PIECE(FILE_DATA,'	',4) like '%IGA%' THEN
	 --SUBSTRING (SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4))),CHARINDEX('IGA',SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4)))),LEN(SUBSTRING (.DBO.PIECE(FILE_DATA,'	',4),0,CHARINDEX('TRANSFER',.DBO.PIECE(FILE_DATA,'	',4))))) 
	--WHEN .DBO.PIECE(FILE_DATA,'	',3)  LIKE '%TRANSFER FROM%' THEN SUBSTRING(SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1),CHARINDEX('IGAD',SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1)),LEN(SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1))) 
	---	ELSE '' END AS 'REFERENCENO'
	,CASE WHEN .DBO.PIECE(FILE_DATA,'	',3)  LIKE '%TRANSFER FROM%'  THEN
	  SUBSTRING(SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1),CHARINDEX('IGA',SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1)),LEN(SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1))) 
	WHEN .DBO.PIECE(FILE_DATA,'	',3)  LIKE '%TRANSFER FROM%' THEN SUBSTRING(SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1),CHARINDEX('IGAD',SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1)),LEN(SUBSTRING(.DBO.PIECE(FILE_DATA,'	',3),0,CHARINDEX('TRANSFER FROM',.DBO.PIECE(FILE_DATA,'	',3))-1))) 
		ELSE '' END   AS 'REFERENCENO'
	,'' AS 'CLTACCOUNT'
	,'' AS 'CUSTOMERREFERENCE'
	,RTRIM(LTRIM(DBO.PIECE(FILE_DATA,'	',4))) AS 'TRANSACTIONDETAIL'
	,'' AS 'VNO'
	,'' AS 'VTYP'
	,0  AS 'BOOKTYPE'
	,0
	,'PENDING' AS 'UPLOADSTATUS'
	,(SELECT FILEUPLOAD_SDATE FROM RECON_BANK_FILEUPLOAD_LOGS(NOLOCK) WHERE UPLOADID=@UPLOADID) AS 'FILEUPLOAD_SDATE'
	,GETDATE()
	,@UNAME
	--,@CLOSINGBALANCE	
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG..FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND .DBO.PIECE(FILE_DATA,'	',2) <> ''
	--SELECT * FROM #NONCMS_DATA RETURN
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_Recon_NONCMS_SCB_Process
-- --------------------------------------------------




 CREATE PROCEDURE [dbo].[CLS_Recon_NONCMS_SCB_Process] (@UPLOADID nvarchar(50), @UPLOAD_FLAG CHAR(1),@BANKCODE NVARCHAR(50) ) 
AS
BEGIN
       

--DECLARE @UPLOADID NVARCHAR(50) 
--SET @UPLOADID='35CBA453'


IF @UPLOAD_FLAG = 'B'
BEGIN
UPDATE MSAJAG.DBO.FILEDATA
SET FILE_DATA = ISNULL(.DBO.PIECE(FILE_DATA, '"', 1), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 2), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 3), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 4), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 5), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 6), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 7), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 8), ',', ''), '') +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 9), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 10), ',', ''), '') +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 11), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 12), ',', ''), '') +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 13), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 14), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 15), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 16), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 17), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 18), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 19), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 20), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 21), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 22), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 23), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 24), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 25), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 26), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 27), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 28), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 29), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 30), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 31), '') + '' +
ISNULL(REPLACE(.DBO.PIECE(FILE_DATA, '"', 32), ',', ''), '') + '' +
ISNULL(.DBO.PIECE(FILE_DATA, '"', 33), '')
WHERE PROGID = @UPLOADID
END

INSERT INTO #NONCMS_DATA
	SELECT
		U.UPLOADID
		,.dbo.piece(FILE_DATA, ',', 2) AS BANKACCOUNT
		, @BANKCODE AS BANKCODE
		,LEFT(.DBO.PIECE(FILE_DATA, ',', 38),50) AS DESCRIPTION
		,'' AS LEDGERBALANCE
		,CASE
			WHEN.dbo.piece(FILE_DATA, ',', 16) = 'Credit' THEN 'C'
			ELSE 'D'
		END AS DRCR
		,CAST(.dbo.piece(FILE_DATA, ',', 32) AS DECIMAL(20, 2)) AS AMT
		,CONVERT(DATETIME,.DBO.PIECE(FILE_DATA, ',', 60), 105) AS VALUEDATE
		--,.dbo.piece(FILE_DATA, ',', 30) AS REFERENCENO
		, CASE WHEN LEFT(.DBO.PIECE(FILE_DATA, ',', 38),5)='IMPS/' THEN .DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 38), '/', 3)
		WHEN LEFT(.DBO.PIECE(FILE_DATA, ',', 38),5)='IMPS|' THEN   .DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 38), '|', 3)
		ELSE .DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 38), '|', 1)END AS 'REFERENCENO'
		,'' AS CLTACCOUNT
		,'' AS CUSTOMERREFERENCE
		,'' AS TRANSACTIONDETAIL
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0
		,U.UploadStatus
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM Recon_bank_FileUpload_logs U (NOLOCK)
	INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND.dbo.piece(FILE_DATA, ',', 32) NOT IN (''
	, 'Transaction Amount')
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_NONCMS_YES_PROCESS
-- --------------------------------------------------





CREATE PROCEDURE [dbo].[CLS_RECON_NONCMS_YES_PROCESS]
( @UPLOADID NVARCHAR(50),@BANKCODE NVARCHAR(50) ) 

AS 
BEGIN

--UPDATE MSAJAG.DBO.FILEDATA
--SET FILE_DATA = ISNULL(.DBO.PIECE(FILE_DATA, ',', 1), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 2), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 3), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 4), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 5), '') + ',' +
----REPLACE(.DBO.PIECE(FILE_DATA, ',', 5), 'NET TXN: ', '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 6), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 7), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 8), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 9), '') + ',' +
--ISNULL(.DBO.PIECE(FILE_DATA, ',', 10), '')
--WHERE PROGID = @UPLOADID
--AND .DBO.PIECE(FILE_DATA, ',', 5) LIKE '%NET TXN:%'
--AND  .DBO.PIECE(FILE_DATA, ',', 5) NOT LIKE '% to %'


INSERT INTO #NONCMS_DATA (UPLOADID
, BANKACCOUNT
, BANKCODE
, DESCRIPTION
, LEDGERBALANCE
, DRCR
, AMT
, VALUEDATE
, REFERENCENO
, CLTACCOUNT
, CUSTOMERREFERENCE
, TRANSACTIONDETAIL
, VNO
, VTYP
, BOOKTYPE
, MATCHEDFLAG
, UPLOADSTATUS
, UPLOADEDDATE
, MODIFIEDDATE
, UPLOADBY)
	SELECT
		U.UPLOADID
		,U.BANKACCOUNT AS BANKACCOUNT
		, @BANKCODE AS BANKCODE
		,LEFT(.DBO.PIECE(FILE_DATA, ',', 5), 149) AS DESCRIPTION
		,'' AS LEDGERBALANCE
		,.DBO.PIECE(FILE_DATA, ',', 4) AS DRCR
		,CAST(.DBO.PIECE(FILE_DATA, ',', 3) AS DECIMAL(20, 2)) AS AMT
		, CONVERT (DATETIME ,REPLACE(.DBO.PIECE(FILE_DATA, ',', 2),'/','-'),105) AS VALUEDATE
		,CASE WHEN  .DBO.PIECE(FILE_DATA, ',', 5) LIKE '%RTGS-%' THEN DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 5), '-', 3)
		WHEN  .DBO.PIECE(FILE_DATA, ',', 5) LIKE '%NEFT-%' THEN DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 5), '-', 3)
		WHEN  (.DBO.PIECE(FILE_DATA, ',', 5) LIKE '%NET TXN:%' AND .DBO.PIECE(FILE_DATA, ',', 4)='D') THEN LEFT(.DBO.CLS_REMOVE_SPACE(.DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 5),':',2)), CHARINDEX(' ', .DBO.CLS_REMOVE_SPACE(.DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 5),':',2))))
		ELSE .DBO.PIECE(FILE_DATA, ',', 6)
		END AS REFERENCENO
		,.DBO.PIECE(FILE_DATA, ',', 7) AS CLTACCOUNT
		,'' AS CUSTOMERREFERENCE
		,'' AS TRANSACTIONDETAIL
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0 AS MATCHEDFLAG
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY
	FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
	INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
	WHERE F.PROGID = @UPLOADID
	AND.DBO.PIECE(FILE_DATA, ',', 2) <> ''
	AND.DBO.PIECE(FILE_DATA, ',', 6) IS NOT NULL
	AND.DBO.PIECE(FILE_DATA, ',', 6) <> 'REFERENCE NO.'

--DROP TABLE #NONCMS_DATA
PRINT 'INSERTED INTO TEMP TABLE'


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_Recon_Reprocess_Data
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLS_Recon_Reprocess_Data]
( 
 @Segment NVARCHAR(30), 
 @BankName NVARCHAR(50), 
 @FileType NVARCHAR(50),
 @BankCode NVARCHAR(50),
 @UploadDate NVARCHAR(50)
)
 AS
BEGIN
		IF (@FILETYPE = 'CMS') 

			BEGIN
				CREATE TABLE #LEDGER_TO_MAP(VNO VARCHAR(12),
				VTYP INT,
				BOOKTYPE VARCHAR(3),
				CLTCODE VARCHAR(10),
				DDNO VARCHAR(30),
				RELAMT MONEY,
				DRCR CHAR(1))

		INSERT INTO #LEDGER_TO_MAP
			SELECT
				L.VNO
				,L.VTYP
				,L.BOOKTYPE
				,CLTCODE
				,DDNO
				,RELAMT
				,L1.DRCR
			FROM	LEDGER L
					,LEDGER1 L1
			WHERE L.VNO = L1.vno
			AND L.VTYP = L1.VTYP
			AND L.LNO = L1.LNO
			AND L.BOOKTYPE = L1.BOOKTYPE
			AND L1.reldt = ''
			AND EXISTS (SELECT
					VNO
				FROM LEDGER L11 (NOLOCK)
				WHERE L11.VNO = L1.VNO
				AND L11.VTYP = L1.VTYP
				AND L11.BOOKTYPE = L1.BOOKTYPE
				AND L11.CLTCODE = @BANKCODE
				AND L11.VTYP IN (2, 3, 17))

		UPDATE RECON_CMS_DATA
		SET	MATCHEDFLAG = 1
			,MODIFIEDDATE = GETDATE()
		FROM RECON_CMS_DATA(NOLOCK) C
		, #LEDGER_TO_MAP L (NOLOCK)
		, [MULTIBANKID] M (NOLOCK)
		WHERE L.DDNO = C.INST_NO_CHECK
		AND C.DRCR = L.DRCR
		AND C.INST_AMT = L.RELAMT
		AND M.CLTCODE = C.CLTCODE
		AND RIGHT(M.ACCNO, 5) = RIGHT(C.CLTACCNO, 5)
		AND M.Cltcode = L.CLTCODE
		--AND CONVERT(DATETIME, STUFF(STUFF(C.VALUEDATE, 3, 0, '-'), 6, 0, '-'), 105) = CONVERT(DATETIME, @UPLOADDATE, 103)
		AND C.Valuedate = CONVERT(DATETIME, @UPLOADDATE, 103)
		AND MATCHEDFLAG = 0
		AND C.BANKCODE=@BankCode


		SELECT
			'TOTAL RECORD UPDATE :' + CAST(@@ROWCOUNT AS CHAR(20))

		UPDATE L1
		SET	RELDT = VALUEDATE
			,REFNO = CROSS_NO
		FROM RECON_CMS_DATA N
		, LEDGER1 L1
		WHERE N.VNO = L1.VNO
		AND N.VTYP = L1.VTYP
		AND N.BOOKTYPE = L1.BOOKTYPE
		AND MATCHEDFLAG = 1
		AND N.BANKCODE=@BankCode

		UPDATE L1
		SET EDT = VALUEDATE
		FROM RECON_CMS_DATA N
		, LEDGER L1
		WHERE N.VNO = L1.VNO
		AND N.VTYP = L1.VTYP
		AND N.BOOKTYPE = L1.BOOKTYPE
		AND EDT LIKE 'DEC 31 2049%'
		AND MATCHEDFLAG = 1
		AND N.BANKCODE=@BankCode
		END
ELSE
	BEGIN
			 CREATE TABLE #LEDGER_TO_MAP_NON
			 (
				VNO VARCHAR(12),
				VTYP INT,
				BOOKTYPE VARCHAR(3),
				CLTCODE VARCHAR(10),
				DDNO VARCHAR(30),
				RELAMT MONEY,
				DRCR CHAR(1)
			  )

			 INSERT INTO #LEDGER_TO_MAP_NON
				SELECT
				MAX(L.VNO)
				,MAX(L.VTYP)
				,MAX(L.BOOKTYPE)
				,MAX(CLTCODE)
				,DDNO
				,RELAMT
				,L1.DRCR
				FROM	LEDGER L
					,LEDGER1 L1
				WHERE L.VNO = L1.VNO
				AND L.VTYP = L1.VTYP
				AND L.LNO = L1.LNO
				AND L.BOOKTYPE = L1.BOOKTYPE
				AND L1.RELDT = ''
				AND EXISTS (SELECT
						VNO
					FROM LEDGER L11 (NOLOCK)
					WHERE L11.VNO = L1.VNO
					AND L11.VTYP = L1.VTYP
					AND L11.BOOKTYPE = L1.BOOKTYPE
					AND L11.DRCR <> L1.DRCR
					AND L11.CLTCODE = @BANKCODE)
				GROUP BY	DDNO
							,RELAMT
							,L1.DRCR
				HAVING COUNT(1) = 1

				UPDATE RECON_NONCMS_DATA
				SET	MATCHEDFLAG = 1
					,MODIFIEDDATE = GETDATE()
				FROM RECON_NONCMS_DATA(NOLOCK) C
				, #LEDGER_TO_MAP_NON L (NOLOCK)
				WHERE L.DDNO = C.REFERENCENO
				AND L.RELAMT = CONVERT(MONEY, C.AMT)
				AND C.DRCR = L.DRCR
				AND C.ValueDate=CONVERT(DATETIME, @UPLOADDATE, 103)
				AND C.MATCHEDFLAG = 0
				AND C.BANKCODE=@BankCode
				SELECT 'TOTAL RECORD UPDATE :' + CAST(@@ROWCOUNT AS CHAR(20))

				UPDATE L1
                  SET    RELDT = CONVERT(DATETIME, VALUEDATE, 105)
                         , REFNO = CROSS_NO
                  FROM   RECON_NONCMS_DATA N
                         , LEDGER1 L1
                  WHERE  N.VNO = L1.VNO
                         AND N.VTYP = L1.VTYP
                         AND N.BOOKTYPE = L1.BOOKTYPE
						 AND N.MATCHEDFLAG=1
						 AND N.BANKCODE=@BankCode

                  UPDATE L1
                  SET    EDT = VALUEDATE
                  FROM   RECON_NONCMS_DATA N
                         , LEDGER L1
                  WHERE  N.VNO = L1.VNO
                         AND N.VTYP = L1.VTYP
                         AND N.BOOKTYPE = L1.BOOKTYPE
                         AND EDT LIKE 'DEC 31 2049%'
						 AND N.MATCHEDFLAG=1
						 AND N.BANKCODE=@BankCode

		END

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RECON_TECHPROCESS_ICICI_PROCESS
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLS_RECON_TECHPROCESS_ICICI_PROCESS]
(@UPLOADID NVARCHAR(50), @BANKCODE NVARCHAR(50) ) 
AS
BEGIN


DECLARE @VALUEDATE VARCHAR(10)
SELECT TOP 1 @VALUEDATE=.DBO.PIECE(.DBO.PIECE(FILE_DATA, ':', 2),',',1) FROM MSAJAG..FILEDATA 
WHERE PROGID=@UPLOADID
ORDER BY SRNO ASC



UPDATE MSAJAG.DBO.FILEDATA SET FILE_DATA=ISNULL(.DBO.PIECE(FILE_DATA, ',', 1), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 2), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 3), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 4), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 5), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 6), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 7), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 8), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 9), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 10), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 11), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 12), '') + ',' +
ISNULL(.DBO.PIECE(FILE_DATA, ',', 13), '') + ',' +
ISNULL(REPLACE(.DBO.PIECE(.DBO.PIECE(FILE_DATA, ',', 14),':',3),'}',''), '') 
WHERE .DBO.PIECE(FILE_DATA, ',', 14) LIKE '%ITC:ABC_123%'

INSERT INTO #NONCMS_DATA 
		SELECT
		U.UPLOADID
		--,CASE WHEN  .DBO.PIECE(FILE_DATA,',',14) NOT LIKE '%EQ_%' THEN .DBO.PIECE(DBO.PIECE(FILE_DATA,',',14),'_',2)+'_'+.DBO.PIECE(DBO.PIECE(FILE_DATA,',',14),'_',3) 
		--WHEN .DBO.PIECE(FILE_DATA,',',14)  LIKE '%EQ_%' THEN .DBO.PIECE(DBO.PIECE(FILE_DATA,',',14),'_',3)+'_'+.DBO.PIECE(DBO.PIECE(FILE_DATA,',',14),'_',4) ELSE '' END
		--AS 'BANKACCOUNT'
		, CASE WHEN FILE_DATA LIKE '%B_EQ_B%' THEN RIGHT(.DBO.PIECE(FILE_DATA,',',14) ,4) ELSE .DBO.PIECE(.DBO.PIECE(FILE_DATA,',',14),'_',2) END AS 'BANKACCOUNT'
		,@BANKCODE AS BANKCODE
		,.DBO.PIECE(FILE_DATA, ',', 14) AS DESCRIPTION
		,'' AS LEDGERBALANCE
		,'C'  AS DRCR
		,CAST(.DBO.PIECE(FILE_DATA, ',', 7) AS DECIMAL(20,2)) AS AMT
		,CONVERT(DATETIME,RTRIM(LTRIM(@VALUEDATE)),126)  AS VALUEDATE
		,.DBO.PIECE(FILE_DATA, ',', 4) AS REFERENCENO		
		,'' AS CLTACCOUNT
		,'' AS CUSTOMERREFERENCE
		,'' AS TRANSACTIONDETAIL
		,'' AS VNO
		,'' AS VTYP
		,'' AS BOOKTYPE
		,0
		,U.UPLOADSTATUS
		,U.FILEUPLOAD_SDATE
		,GETDATE()
		,U.UPLOADBY		
		FROM RECON_BANK_FILEUPLOAD_LOGS U (NOLOCK)
		INNER JOIN MSAJAG.DBO.FILEDATA F (NOLOCK)
		ON U.UPLOADID = F.PROGID
		WHERE F.PROGID=@UPLOADID
		AND ISNULL(.DBO.PIECE(FILE_DATA, ',', 2), '') <>''
		AND ISNULL(.DBO.PIECE(FILE_DATA, ',', 2), '') <>'Bank_ID'		
	
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_ACC_MARGINLEDGER
-- --------------------------------------------------




/*USE ACCOUNT        
EXEC RPT_ACC_PARTYLEDGER_ALL 'JAN  1 2007','FEB 12 2007','0Z','ZZZ','ACCODE','VDT','BROKER','BROKER','', 'N'        
EXEC V2_RPT_ACC_MARGINLEDGER 'JAN  1 2007','FEB 12 2007','0Z','ZZZ','ACCODE','VDT','BROKER','BROKER','', 'N'*/        
 --EXEC V2_RPT_ACC_MARGINLEDGER 'AUG  1 2006','AUG 26 2006','012019','012019','ACCODE','VDT','BROKER','BROKER',''              
              
--EXEC V2_RPT_ACC_MARGINLEDGER 'AUG  1 2006','AUG 26 2006','012019','012019','ACCODE','VDT','BROKER','BROKER',''                
 /*                              
 PROC NAME RPT_ACC_PARTYLEDGER                              
 PARAMETERS FDATE - FROM DATE                              
            TDATE - DATE TO                              
            FCODE - AC CODE FROM                              
            TCODE - AC CODE TO                              
            STRORDER - PRINTING ORDER, POSSIBLE VAUES  ACCODE , ACNAME                              
            SELECTBY - REPORT SELECTION BY , POSSIBLE VALUES VDT, EDT                              
            STATUSID - POSSIBLEVALUES 'BROKER','CLIENT','FAMILY','SUBBORKER','FAMILY','BRANCH'                              
*/                              
                   
CREATE PROCEDURE[dbo].[CLS_RPT_ACC_MARGINLEDGER]                              
                               
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */                              
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */                              
@FCODE VARCHAR(10),                              
@TCODE VARCHAR(10),                              
@STRORDER VARCHAR(6),                              
@SELECTBY VARCHAR(3),                              
@STATUSID VARCHAR(15),                              
@STATUSNAME VARCHAR(15),                              
@STRBRANCH VARCHAR(10),
@ENTITY VARCHAR(20),
@ENTITY_LIST VARCHAR(MAX)                              
AS                              
                              
DECLARE @@OPENDATE   AS VARCHAR(11) 

CREATE TABLE #LEDGERCLIENTS
(
	PARTY_CODE VARCHAR(10),          
	LONG_NAME VARCHAR(100),          
    BANK_NAME VARCHAR(50),           
    L_ADDRESS1 VARCHAR(40),           
	L_ADDRESS2  VARCHAR(40),           
	L_ADDRESS3 VARCHAR(40),           
    L_CITY VARCHAR(50),           
    L_ZIP VARCHAR(20),           
    RES_PHONE1 VARCHAR(20),           
    BRANCH_CD VARCHAR(20),           
    FAMILY VARCHAR(10),           
    SUB_BROKER VARCHAR(30),           
    TRADER VARCHAR(50),           
    CL_TYPE VARCHAR(20),           
    CLTDPID VARCHAR(30)
)

CREATE TABLE #CL_LIST
(
	CLTCODE VARCHAR(10) NOT NULL
)

ALTER TABLE #CL_LIST
 ADD PRIMARY KEY (CLTCODE)

DECLARE
	@@SQL VARCHAR(MAX),
	@ENTITY_FIELD VARCHAR(20)
	

 SELECT @ENTITY_FIELD =    
  CASE WHEN @ENTITY = 'BRANCH' THEN  'BRANCH_CD' ELSE    
  CASE WHEN @ENTITY = 'SUB_BROKER' THEN 'SUB_BROKER' ELSE     
  CASE WHEN @ENTITY = 'TRADER' THEN 'TRADER' ELSE    
  CASE WHEN @ENTITY = 'AREA' THEN 'AREA' ELSE    
  CASE WHEN @ENTITY = 'REGION' THEN 'REGION' ELSE   
  CASE WHEN @STATUSID = 'CLIENT' THEN 'CL_CODE' ELSE 	 
  CASE WHEN @ENTITY = 'FAMILY' THEN 'FAMILY' ELSE 'BROKER'    
 END END END END END END  END   

SET @@SQL = "INSERT INTO #CL_LIST "
SET @@SQL = @@SQL + "SELECT CL_CODE FROM BSEDB.DBO.CLIENT1 "
SET @@SQL = @@SQL + "WHERE CL_CODE >= '" + @FCODE + "' AND CL_CODE <= '" + @TCODE + "'"
IF @ENTITY_FIELD <> 'BROKER' AND  @ENTITY_LIST <> '' AND @ENTITY_LIST <> 'ALL|'
BEGIN 
 SET @@SQL = @@SQL + "AND " + @ENTITY_FIELD + " IN('" + REPLACE(@ENTITY_LIST, '|', ''',''') + "')" 
 --SET @@SQL = @@SQL + " AND " + @ENTITY_FIELD + " <= '" + @ENTITY_TO + "'"    
END  
PRINT @@SQL
EXEC (@@SQL)


/*GETTING CLIENT LIST*/                
INSERT INTO #LEDGERCLIENTS
      SELECT           
            C2.PARTY_CODE,          
			C1.LONG_NAME,          
            BANK_NAME = ISNULL(C4.BANKID, ''),           
            L_ADDRESS1,           
            L_ADDRESS2,           
            L_ADDRESS3,           
            L_CITY,           
            L_ZIP,           
            RES_PHONE1,           
            C1.BRANCH_CD,           
            FAMILY,           
            C1.SUB_BROKER,           
            TRADER,           
            CL_TYPE,           
            CLTDPID = ISNULL(CLTDPID, '')           
      FROM BSEDB.DBO.CLIENT1 C1 WITH(NOLOCK),           
            BSEDB.DBO.CLIENT2 C2 WITH(NOLOCK)           
      LEFT OUTER JOIN           
            BSEDB.DBO.CLIENT4 C4 WITH(NOLOCK)           
            ON           
            (          
                  C2.PARTY_CODE = C4.PARTY_CODE           
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')           
				  AND DEFDP = 1          
--                  AND DEFDP = 0      
            )           
      WHERE C1.CL_CODE = C2.CL_CODE 
			AND C1.AREA LIKE (          
            CASE           
                  WHEN @STATUSID = 'AREA'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            ) 
			AND C1.REGION LIKE (          
            CASE           
                  WHEN @STATUSID = 'REGION'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )            
            AND C1.BRANCH_CD LIKE (          
            CASE           
                  WHEN @STATUSID = 'BRANCH'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
            AND SUB_BROKER LIKE (          
            CASE           
                  WHEN @STATUSID = 'SUB_BROKER'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
     AND SUB_BROKER LIKE (          
            CASE           
                  WHEN @STATUSID = 'SUBBROKER'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
            AND TRADER LIKE (          
            CASE           
                  WHEN @STATUSID = 'TRADER'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
            AND C1.FAMILY LIKE (          
            CASE           
                  WHEN @STATUSID = 'FAMILY'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
            AND C2.PARTY_CODE LIKE (          
            CASE           
                  WHEN @STATUSID = 'CLIENT'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
         )           
        AND C1.BRANCH_CD LIKE @STRBRANCH +'%'           
        AND EXISTS(SELECT CLTCODE FROM #CL_LIST C WHERE C2.PARTY_CODE = C.CLTCODE) 


CREATE TABLE [DBO].[#MARGINLEDGERDATA] (                                
  [BOOKTYPE] [CHAR] (2) NULL ,                                
  [VOUDT] [DATETIME] NULL ,                                
  [EFFDT] [DATETIME] NULL ,                                
  [ACNAME] [VARCHAR] (100) NULL ,                      
  [SHORTDESC] [CHAR] (6) NULL ,                                  
  [DRCR] [CHAR] (1) NULL ,                                
  [AMOUNT] [MONEY] NULL ,                                
  [VNO] [VARCHAR] (12) NULL ,                                
  [DDNO] [VARCHAR] (12) NULL ,                                
  [NARRATION] [VARCHAR] (234) NULL ,                                
  [PARTY_CODE] [VARCHAR] (10) NOT NULL ,                                
  [VTYP] [SMALLINT] NULL ,                                
  [VDT] [VARCHAR] (30) NULL ,                                
  [EDT] [VARCHAR] (30) NULL ,                                            
  [LNO] [DECIMAL](5, 0) NULL,            
  [PDT] [DATETIME] NULL            
 ) ON [PRIMARY]                                
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
                      
            
                      
                      
                      
SELECT @@OPENDATE = SDTCUR FROM PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR              
                              
/*GETTING LAST OPENING DATE */                              
/*IF UPPER(@SELECTBY) = 'VDT'                              
 BEGIN                              
  SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM MARGINLEDGER WHERE VTYP = 18 AND VDT <= @FDATE )                              
 END                              
ELSE                              
 BEGIN                              
  SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM MARGINLEDGER WHERE VTYP = 18 AND VDT <= @FDATE )                              
 END                */              
                              
/*CREATING BLANK TABLE FOR OPENING BALANCE*/                              
SELECT CLTCODE=PARTY_CODE,OPPBAL=AMOUNT INTO #OPPBALANCE FROM MARGINLEDGER WHERE 1=2                              
                              
/*GETTING OPENING BALANCE*/                              
IF @SELECTBY = 'VDT'                              
BEGIN                              
 IF @@OPENDATE = @FDATE          
 BEGIN                              
  INSERT INTO  #OPPBALANCE                               
  SELECT CLTCODE=PARTY_CODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0)                              
  FROM MARGINLEDGER  M                            
  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS C WHERE M.PARTY_CODE = C.PARTY_CODE) AND  VDT LIKE @FDATE + '%' AND VTYP = 18
  GROUP BY PARTY_CODE                              
 END                              
 ELSE                              
 BEGIN                              
  INSERT INTO  #OPPBALANCE                               
  SELECT CLTCODE=PARTY_CODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0)                                
  FROM MARGINLEDGER M                              
  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS C WHERE M.PARTY_CODE = C.PARTY_CODE)  AND  VDT >=  @@OPENDATE + ' 00:00:00' AND VDT < @FDATE                               
  GROUP BY PARTY_CODE                              
 END                              
END                               
ELSE                              
BEGIN                               
 IF @@OPENDATE = @FDATE                               
 BEGIN        INSERT INTO  #OPPBALANCE                            
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM(SETT_NO)                          
  FROM MARGINLEDGER M                          
  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS C WHERE M.PARTY_CODE = C.PARTY_CODE) AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                          
  GROUP BY PARTY_CODE                          
 END                            
 ELSE                            
 BEGIN                            
  INSERT INTO  #OPPBALANCE                               
  SELECT CLTCODE, OPBAL=SUM(OPBAL)                          
  FROM                          
  (                         
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM(SETT_NO)                          
  FROM MARGINLEDGER M                          
  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS C WHERE M.PARTY_CODE = C.PARTY_CODE) AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                          
  GROUP BY PARTY_CODE                          
  UNION ALL                          
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)                          
  FROM MARGINLEDGER M                          
  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS C WHERE M.PARTY_CODE = C.PARTY_CODE) AND VDT >= @@OPENDATE + ' 00:00:00' AND VDT < @FDATE AND VTYP <> 18                          
  GROUP BY PARTY_CODE) T                          
  GROUP BY CLTCODE                          
 END                            
END                              
                        
              
                        
IF @SELECTBY = 'VDT'                        
BEGIN                        
 INSERT INTO #MARGINLEDGERDATA                        
/*  SELECT M.BOOKTYPE, VOUDT=M.VDT , EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                         
  M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                         
  L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT                         
  FROM MARGINLEDGER M LEFT OUTER JOIN LEDGER L ON M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO                       
 AND M.LNO = L.LNO LEFT OUTER JOIN ACMAST A ON M.PARTY_CODE = A.CLTCODE , VMAST V                         
  WHERE L.VDT >= @FDATE + ' 00:00:00' AND L.VDT <= @TDATE + ' 23:59:59'                        
  AND M.PARTY_CODE >= @FCODE AND M.PARTY_CODE <= @TCODE AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE*/
  
  SELECT M.BOOKTYPE, VOUDT=M.VDT , EFFDT=L.EDT, A.LONGNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                         
  M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                         
  L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT                         
  FROM (SELECT CLTCODE, LONGNAME, ACCAT FROM ACMAST AC WHERE CLTCODE  >= @FCODE AND CLTCODE <= @TCODE AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS C WHERE AC.CLTCODE = C.PARTY_CODE)) A, MARGINLEDGER M 
  ,(SELECT VNO, VTYP, BOOKTYPE, LNO, VDT, EDT, NARRATION FROM LEDGER LL WHERE VDT >= @FDATE + ' 00:00:00' AND VDT <= @TDATE + ' 23:59:59' AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS C WHERE LL.CLTCODE = C.PARTY_CODE)) L, VMAST V
  WHERE 
  M.PARTY_CODE = A.CLTCODE
  AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO
  AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE
END                        
ELSE                        
BEGIN                        
  INSERT INTO #MARGINLEDGERDATA                        
  /*SELECT M.BOOKTYPE, VOUDT=M.VDT, EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                         
  M.VNO,DDNO= ISNULL((SELECT DDNO FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                       
 L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT            
  FROM MARGINLEDGER M LEFT OUTER JOIN LEDGER L ON M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO                       
 AND M.LNO = L.LNO LEFT OUTER JOIN ACMAST A ON M.PARTY_CODE = A.CLTCODE , VMAST V                         
  WHERE L.EDT >= @FDATE + ' 00:00:00' AND L.EDT <= @TDATE + ' 23:59:59'                        
  AND M.PARTY_CODE >= @FCODE AND M.PARTY_CODE <= @TCODE AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE  */
  SELECT M.BOOKTYPE, VOUDT=M.VDT , EFFDT=L.EDT, A.LONGNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                         
  M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                         
  L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT                         
  FROM (SELECT CLTCODE, LONGNAME, ACCAT FROM ACMAST AC WHERE CLTCODE  >= @FCODE AND CLTCODE <= @TCODE AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS C WHERE AC.CLTCODE = C.PARTY_CODE)) A, MARGINLEDGER M 
  ,(SELECT VNO, VTYP, BOOKTYPE, LNO, VDT, EDT, NARRATION FROM LEDGER LL WHERE EDT >= @FDATE + ' 00:00:00' AND EDT <= @TDATE + ' 23:59:59' AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS C WHERE LL.CLTCODE = C.PARTY_CODE)) L, VMAST V
  WHERE 
  M.PARTY_CODE = A.CLTCODE
  AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO
  AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE 
  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS C WHERE M.PARTY_CODE = C.PARTY_CODE)                        
END                        
                        
                              
                              
/*GETTING LDDGER ENTRIES*/                              
SELECT M.BOOKTYPE, M.VOUDT, M.EFFDT, M.SHORTDESC,                               
DRAMT=(CASE WHEN UPPER(M.DRCR) = 'D' THEN M.AMOUNT ELSE 0 END),                                
CRAMT=(CASE WHEN UPPER(M.DRCR) = 'C' THEN M.AMOUNT ELSE 0 END),                              
M.VNO, M.DDNO, M.NARRATION, C.PARTY_CODE CLTCODE,VTYP = ISNULL(M.VTYP, 18), M.VDT,                               
M.EDT, M.ACNAME , OPBAL = AMOUNT,                               
C.L_ADDRESS1,C.L_ADDRESS2,C.L_ADDRESS3,C.L_CITY,C.L_ZIP,C.RES_PHONE1,C.BRANCH_CD, M.PARTY_CODE CROSAC ,                           
EDIFF=DATEDIFF(D,M.EFFDT,GETDATE()), C.FAMILY,C.SUB_BROKER,C.TRADER,C.CL_TYPE,                              
C.BANK_NAME,C.CLTDPID, M.LNO, M.PDT                                     
INTO  #TMPMLEDGER                                     
FROM  #MARGINLEDGERDATA M RIGHT OUTER JOIN #LEDGERCLIENTS C ON (M.PARTY_CODE=C.PARTY_CODE)                              
                
/*UPDATING OPENING BLANACE*/                              
UPDATE #TMPMLEDGER SET OPBAL = 0                              
UPDATE #TMPMLEDGER SET OPBAL = T.OPPBAL FROM #TMPMLEDGER M,#OPPBALANCE T WHERE M.CLTCODE = T.CLTCODE                              
                        
                              
/*UPDATING BANK NAME*/                             
/*UPDATE  #TMPMLEDGER SET #TMPMLEDGER.BANK_NAME= B.BANK_NAME  FROM                              
BSEDB.DBO.POBANK  B WHERE LTRIM(RTRIM(CAST(B.BANKID  AS CHAR))) = LTRIM(RTRIM(#TMPMLEDGER.BANK_NAME))                              */
                          
UPDATE  #TMPMLEDGER SET #TMPMLEDGER.ACNAME= A.ACNAME  FROM                              
ACMAST A WHERE LTRIM(RTRIM(A.CLTCODE)) = LTRIM(RTRIM(#TMPMLEDGER.CLTCODE))                              
                
              
                          
IF @STRORDER = 'ACCODE'                              
 BEGIN                              
  IF @SELECTBY = 'VDT'                              
   BEGIN                               
    SELECT L.* FROM #TMPMLEDGER L,ACMAST A  WHERE    
    L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104')   
 AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)  
    ORDER BY L.CLTCODE,VOUDT                              
   END                              
  ELSE                              
   BEGIN                              
    SELECT L.* FROM #TMPMLEDGER L,ACMAST A     
    WHERE  L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104')   
 AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)  
 ORDER BY L.CLTCODE,EFFDT                              
   END                              
 END         
ELSE                              
  BEGIN                              
   IF @SELECTBY = 'VDT'                              
    BEGIN                               
     SELECT L.* FROM #TMPMLEDGER L,ACMAST A     
 WHERE L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104')   
 AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)  
 ORDER BY L.ACNAME,VOUDT                              
    END                              
   ELSE                              
    BEGIN                              
     SELECT L.* FROM #TMPMLEDGER L,ACMAST A    
 WHERE L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104')   
 AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)  
 ORDER BY L.ACNAME,EFFDT                              
    END                              
  END                              
                              
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_ACC_PARTYLEDGER
-- --------------------------------------------------







--EXEC RPT_ACC_PARTYLEDGER_ALL 'AUG  1 2007','AUG  8 2007','0000','ZZZZ','ACCODE','VDT','BROKER','BROKER','', 'N','N'  
  
  
--EXEC RPT_ACC_PARTYLEDGER 'JAN  1 2010','JAN 25 2012','0','ZZZ','ACCODE','VDT','BROKER','BROKER',''        
        
CREATE PROCEDURE[dbo].[CLS_RPT_ACC_PARTYLEDGER]
(          
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @FCODE VARCHAR(10),                
 @TCODE VARCHAR(10),                
 @STRORDER VARCHAR(8),                
 @SELECTBY VARCHAR(3),                
 @STATUSID VARCHAR(15),                
 @STATUSNAME VARCHAR(15),                
 @STRBRANCH VARCHAR(10),
 @ENTITY VARCHAR(20),
 @ENTITY_LIST VARCHAR(MAX),
 @FORPDF VARCHAR(1) = 'N'
)          
          
AS         
  
DECLARE                
 @@REPTYPE VARCHAR(1),  
 @@STRORDER VARCHAR(6)  
  
  
SELECT @@REPTYPE = .dbo.CLS_Piece(@STRORDER, '~', 2)  
SELECT @@STRORDER = .dbo.CLS_Piece(@STRORDER, '~', 1)  
  /*
IF @@REPTYPE = 'P'  
BEGIN  
 EXEC RPT_ACC_PARTYLEDGER_PARENT @FDATE, @TDATE, @FCODE, @TCODE, @@STRORDER, @SELECTBY, @STATUSID, @STATUSNAME, @STRBRANCH  
 RETURN  
END */ 
  
  
                
/*========================================================================          
      EXEC RPT_ACC_PARTYLEDGER_ALL           
            'NOV  1 2005',          
            'DEC 31 2005',          
            'A',          
            'ZZZ',          
            'ACCODE',          
            'VDT',          
            'BROKER',          
            'UNDEFINED',          
            ''          
========================================================================*/
CREATE TABLE #LEDGERCLIENTS
(
	PARTY_CODE VARCHAR(10),          
	LONG_NAME VARCHAR(100),          
    BANK_NAME VARCHAR(50),           
    L_ADDRESS1 VARCHAR(40),           
	L_ADDRESS2  VARCHAR(40),           
	L_ADDRESS3 VARCHAR(40),           
    L_CITY VARCHAR(50),           
    L_ZIP VARCHAR(20),           
    RES_PHONE1 VARCHAR(20),           
    BRANCH_CD VARCHAR(20),           
    FAMILY VARCHAR(10),           
    SUB_BROKER VARCHAR(30),           
    TRADER VARCHAR(50),           
    CL_TYPE VARCHAR(20),           
    CLTDPID VARCHAR(30),
    EMAIL VARCHAR(500),
    MOBILE_PAGER VARCHAR(50)
)



CREATE TABLE #CL_LIST
(
	CLTCODE VARCHAR(10) NOT NULL
)

ALTER TABLE #CL_LIST
 ADD PRIMARY KEY (CLTCODE)

DECLARE
	@@SQL VARCHAR(MAX),
	@ENTITY_FIELD VARCHAR(20)
	

 SELECT @ENTITY_FIELD =    
  CASE WHEN @ENTITY = 'BRANCH' THEN  'BRANCH_CD' ELSE    
  CASE WHEN @ENTITY = 'SUB_BROKER' THEN 'SUB_BROKER' ELSE     
  CASE WHEN @ENTITY = 'TRADER' THEN 'TRADER' ELSE    
  CASE WHEN @ENTITY = 'AREA' THEN 'AREA' ELSE    
  CASE WHEN @ENTITY = 'REGION' THEN 'REGION' ELSE   
  CASE WHEN @STATUSID = 'CLIENT' THEN 'CL_CODE' ELSE 	 
  CASE WHEN @ENTITY = 'FAMILY' THEN 'FAMILY' ELSE 'BROKER'    
 END END END END END END  END  
 
 
 DECLARE
	@SHAREDB VARCHAR(25) 
	
SELECT @SHAREDB = SHAREDB FROM OWNER	

SET @@SQL = "INSERT INTO #CL_LIST "
SET @@SQL = @@SQL + "SELECT CL_CODE FROM " + @SHAREDB + ".DBO.CLIENT1 "
SET @@SQL = @@SQL + "WHERE CL_CODE >= '" + @FCODE + "' AND CL_CODE <= '" + @TCODE + "'"
IF @ENTITY_FIELD <> 'BROKER' AND  @ENTITY_LIST <> '' AND @ENTITY_LIST <> 'ALL|'
BEGIN 
 SET @@SQL = @@SQL + "AND " + @ENTITY_FIELD + " IN('" + REPLACE(@ENTITY_LIST, '|', ''',''') + "')" 
 --SET @@SQL = @@SQL + " AND " + @ENTITY_FIELD + " <= '" + @ENTITY_TO + "'"    
END  
PRINT @@SQL
EXEC (@@SQL)


/*GETTING CLIENT LIST*/                
INSERT INTO #LEDGERCLIENTS
      SELECT           
            C2.PARTY_CODE,          
			C1.LONG_NAME,          
            BANK_NAME = ISNULL(C4.BANKID, ''),           
            L_ADDRESS1,           
            L_ADDRESS2,           
            L_ADDRESS3,           
            L_CITY,           
            L_ZIP,           
            RES_PHONE1,           
            C1.BRANCH_CD,           
            FAMILY,           
            C1.SUB_BROKER,           
            TRADER,           
            CL_TYPE,           
            CLTDPID = ISNULL(CLTDPID, '') ,
            EMAIL,
            MOBILE_PAGER          
      FROM MCDXCDS.DBO.CLIENT1 C1 WITH(NOLOCK),           
            MCDXCDS.DBO.CLIENT2 C2 WITH(NOLOCK)           
      LEFT OUTER JOIN           
            MCDXCDS.DBO.CLIENT4 C4 WITH(NOLOCK)           
            ON           
            (          
                  C2.PARTY_CODE = C4.PARTY_CODE           
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')           
				 -- AND DEFDP = 1          
--                  AND DEFDP = 0      
            )           
      WHERE C1.CL_CODE = C2.CL_CODE 
			AND C1.AREA LIKE (          
            CASE           
                  WHEN @STATUSID = 'AREA'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            ) 
			AND C1.REGION LIKE (          
            CASE           
                  WHEN @STATUSID = 'REGION'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )            
            AND C1.BRANCH_CD LIKE (          
            CASE           
                  WHEN @STATUSID = 'BRANCH'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
            AND SUB_BROKER LIKE (          
            CASE           
                  WHEN @STATUSID = 'SUB_BROKER'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
     AND SUB_BROKER LIKE (          
            CASE           
                  WHEN @STATUSID = 'SUBBROKER'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
            AND TRADER LIKE (          
            CASE           
                  WHEN @STATUSID = 'TRADER'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
            AND C1.FAMILY LIKE (          
            CASE           
                  WHEN @STATUSID = 'FAMILY'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
            AND C2.PARTY_CODE LIKE (          
            CASE           
                  WHEN @STATUSID = 'CLIENT'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
         )           
        AND C1.BRANCH_CD LIKE @STRBRANCH +'%'           
        AND EXISTS(SELECT CLTCODE FROM #CL_LIST C WHERE C2.PARTY_CODE = C.CLTCODE)            

DECLARE           
 @@OPENDATE   AS VARCHAR(11)                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
                
                
/*GETTING LAST OPENING DATE 
      IF UPPER(@SELECTBY) = 'VDT'                
      BEGIN                */
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              CONVERT(VARCHAR(11), SDTCUR, 109)
                        FROM PARAMETER WITH(NOLOCK)           
                        WHERE @FDATE BETWEEN SDTCUR AND LDTCUR
                  )           
      /*END                
      ELSE                
      BEGIN                
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)           
                        FROM LEDGER WITH(NOLOCK)           
                        WHERE VTYP = 18  
							  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)         
                              AND EDT < = @FDATE           
                  )           
      END                */
                      
                
      /*CREATING BLANK TABLE FOR OPENING BALANCE*/                
            SELECT           
                  CLTCODE,           
                  OPPBAL = VAMT           
            INTO #OPPBALANCE           
            FROM LEDGER WITH(NOLOCK)           
            WHERE 1 = 2           
                      
                
      /*GETTING OPENING BALANCE*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            IF @@OPENDATE = @FDATE                 
            BEGIN 
				  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                              THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM LEDGER B WITH(NOLOCK)           
				  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                        AND B.VDT LIKE @FDATE + '%'           
                        AND VTYP = 18           
                  GROUP BY CLTCODE           

            END                
            ELSE                
            BEGIN                
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT      
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                       THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM LEDGER B WITH(NOLOCK)                         
				  WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                        AND B.VDT > = @@OPENDATE + ' 00:00:00'           
                        AND VDT < @FDATE           
               GROUP BY CLTCODE           
            END                
      END                 
      ELSE                
      BEGIN                 
            IF @@OPENDATE = @FDATE                 
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
						OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
                                    CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
                              FROM LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
                                          ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM LEDGER B WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND B.VDT < @@OPENDATE          
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
            ELSE              
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
									CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
               FROM LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                   SELECT           
                                    CLTCODE,           
                                    OPBAL = SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT         
                                    END          
                                    )           
                              FROM LEDGER WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND EDT > = @@OPENDATE + ' 00:00:00'           
                                    AND EDT < @FDATE           
                                    AND VTYP <> 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
											ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM LEDGER B WITH(NOLOCK)           
                              WHERE EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
                                    AND B.VDT < @@OPENDATE           
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
      END                
                      
      /*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */                
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  SHORTDESC = SPACE(35)           
            INTO #LEDGERDATA           
            FROM LEDGER L WITH(NOLOCK)           
            WHERE 1 = 2           
  
                     
                
                
      /*GETTING FIILTERED LEDGER*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM LEDGER L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE VDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND VDT < = @TDATE +' 23:59:59'           
                  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)           
      END                 
      ELSE                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM LEDGER L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE EDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND EDT < = @TDATE +' 23:59:59'           
                  AND EXISTS(SELECT PARTY_CODE FROM #LEDGERCLIENTS L WHERE PARTY_CODE = CLTCODE)          
      END
                
          
          
          
      CREATE TABLE [#TMPLEDGER] (          
       [BOOKTYPE] [CHAR] (2)  NULL ,          
       [VOUDT] [DATETIME] NULL ,          
       [EFFDT] [DATETIME] NULL ,          
       [SHORTDESC] [VARCHAR] (35)  NULL ,          
       [DRAMT] [MONEY] NULL ,          
       [CRAMT] [MONEY] NULL ,          
       [VNO] [VARCHAR] (12)  NULL ,          
       [DDNO] [VARCHAR] (20)  NULL ,          
       [NARRATION] [VARCHAR] (234)  NULL ,          
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,          
       [VTYP] [SMALLINT] NULL ,          
       [VDT] [VARCHAR] (30)  NULL ,          
       [EDT] [VARCHAR] (30)  NULL ,          
       [ACNAME] [VARCHAR] (100)  NULL ,          
       [OPBAL] [MONEY] NULL ,          
       [L_ADDRESS1] [VARCHAR] (40)  NOT NULL ,          
       [L_ADDRESS2] [VARCHAR] (40)  NULL ,          
       [L_ADDRESS3] [VARCHAR] (40)  NULL ,          
       [L_CITY] [VARCHAR] (40)  NULL ,          
       [L_ZIP] [VARCHAR] (10)  NULL ,          
       [RES_PHONE1] [VARCHAR] (15)  NULL ,          
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,          
       [CROSAC] [VARCHAR] (10)  NULL ,          
       [EDIFF] [INT] NULL ,          
       [FAMILY] [VARCHAR] (10)  NOT NULL ,          
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,          
       [TRADER] [VARCHAR] (20)  NOT NULL ,          
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,          
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,          
       [CLTDPID] [VARCHAR] (20)  NOT NULL ,          
       [LNO] [INT] NULL,        
       [PDT] [DATETIME] NULL,
       [EMAIL] VARCHAR(500),
       [MOBILE_PAGER] VARCHAR(50)
      ) ON [PRIMARY]          
   
           
/*GETTING LDDGER ENTRIES*/                
      INSERT           
            INTO #TMPLEDGER           
      SELECT           
            L.BOOKTYPE,           
 VOUDT = L.VDT,           
            EFFDT = L.EDT,           
            L.SHORTDESC,           
            DRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'D'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            CRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'C'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            L.VNO,           
            DDNO = SPACE(15),           
            L.NARRATION,           
            C.PARTY_CODE CLTCODE,           
            VTYP = ISNULL(L.VTYP, 18),           
            CONVERT(VARCHAR, L.VDT, 103) VDT,           
            CONVERT(VARCHAR, L.EDT, 103) EDT,           
--            L.ACNAME ,           
            C.LONG_NAME,          
            OPBAL = VAMT,           
            C.L_ADDRESS1,           
            C.L_ADDRESS2,           
            C.L_ADDRESS3,           
            C.L_CITY,           
            C.L_ZIP,           
            C.RES_PHONE1,           
            C.BRANCH_CD,           
            L.CLTCODE CROSAC ,           
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),           
            C.FAMILY,           
            C.SUB_BROKER,           
            C.TRADER,           
            C.CL_TYPE,           
            C.BANK_NAME,           
            C.CLTDPID,           
            L.LNO,        
			L.PDT,
			EMAIL,
			MOBILE_PAGER
      FROM #LEDGERDATA L WITH(NOLOCK)           
      RIGHT OUTER JOIN           
            #LEDGERCLIENTS C WITH(NOLOCK)           
            ON           
            (          
                  L.CLTCODE = C.PARTY_CODE          
            )           
          
          
                
/*UPDATING OPENING BLANACE*/                
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = 0           
          
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = T.OPPBAL           
      FROM #TMPLEDGER L WITH(NOLOCK),           
            #OPPBALANCE T WITH(NOLOCK)           
      WHERE L.CLTCODE = T.CLTCODE           
                
          
          
/*UPDATING CHEQUE NUMBER*/                
      UPDATE           
            #TMPLEDGER           
            SET DDNO = L1.DDNO           
      FROM LEDGER1 L1 WITH(NOLOCK)           
      WHERE L1.VNO = #TMPLEDGER.VNO           
            AND L1.VTYP = #TMPLEDGER.VTYP           
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE           
            AND L1.LNO = #TMPLEDGER.LNO           
                
          
          
/*UPDATING CROSS ACCOUNT CODE*/                
      UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.CROSAC = B.CLTCODE           
      FROM LEDGER B WITH(NOLOCK),           
            ACMAST V WITH(NOLOCK)           
      WHERE B.CLTCODE = V.CLTCODE           
            AND V.ACCAT = 2           
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE           
            AND #TMPLEDGER.VNO = B.VNO           
            AND #TMPLEDGER.VTYP = B.VTYP           
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')           
                
          
          
/*UPDATING BANK NAME*/                               
      /*UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME           
      FROM MCDXCDS.DBO.POBANK B WITH(NOLOCK)           
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))           */
      
      IF @FORPDF = 'Y'
		BEGIN
			ALTER TABLE #TMPLEDGER ADD PARTYCOUNT INT
			UPDATE #TMPLEDGER SET PARTYCOUNT = C.PCOUNTER
			FROM (SELECT CLTCODE, PCOUNTER = COUNT(1) FROM #TMPLEDGER GROUP BY CLTCODE) C
			WHERE #TMPLEDGER.CLTCODE = C.CLTCODE
		END
                
      IF @@STRORDER = 'ACCODE'                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
    AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)          
                  ORDER BY L.CLTCODE,        
                        VOUDT, PDT        
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
                  ORDER BY L.CLTCODE,          
                        EFFDT, PDT        
            END                
      END                
      ELSE                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')       
                  ORDER BY L.ACNAME,         
                        VOUDT, PDT           
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
                  ORDER BY L.ACNAME,          
                        EFFDT, PDT        
            END                
      END                
                
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_ACCALLPARTYLEDVOUCHERDISP
-- --------------------------------------------------





CREATE PROCEDURE [dbo].[CLS_RPT_ACCALLPARTYLEDVOUCHERDISP]            
 @VTYP SMALLINT ,            
 @VNO VARCHAR (12),            
 @VDT VARCHAR(12) ,            
 @BOOKTYPE VARCHAR(2),            
 @BRANCH VARCHAR(10),            
 @CLTCODE VARCHAR(10)            
            
AS   

 IF LEN(@VDT) = 10 AND CHARINDEX('/', @VDT) > 0  
  BEGIN  
   SET @VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @VDT, 103), 109)  
  END  
 
      
IF @BRANCH = 'FULL' OR @BRANCH = '' OR @BRANCH = '%'            
BEGIN            
 SELECT    
  VAMT, L.VTYP, L.VNO, L.VDT, L.DRCR, CLTCODE, ACNAME,  L.LNO,   
  DRCRFLAG = (CASE WHEN UPPER(L.DRCR) = 'D' THEN 'DR' ELSE 'CR' END) ,             
  NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,             
  DDDT  =  CONVERT(VARCHAR, DDDT, 103), PARTY_CODE
 FROM   
  LEDGER L LEFT OUTER JOIN LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO         
  AND L.LNO = L1.LNO LEFT OUTER JOIN MARGINLEDGER ML ON ML.VTYP = L.VTYP AND ML.BOOKTYPE = L.BOOKTYPE AND ML.VNO = L.VNO         
  AND L.LNO = ML.LNO 
 WHERE   
  L.VTYP = @VTYP            
  AND L.VNO = @VNO              
  AND L.VDT LIKE  LTRIM(L.VDT) + '%'            
  AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE            
 ORDER BY   
  L.DRCR DESC , L.LNO             
END            
ELSE            
BEGIN            
  SELECT    
  VAMT = L2.CAMT , L.VTYP , L2.VNO , VDT , L2.DRCR , L2.CLTCODE, A.ACNAME, L2.LNO ,             
  DRCRFLAG = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN 'DR' ELSE 'CR' END),             
  NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,             
  DDDT  =  CONVERT(VARCHAR, DDDT, 103)              
  FROM   
  LEDGER L LEFT OUTER JOIN LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO         
  AND L.LNO = L1.LNO,            
  LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE            
  WHERE   
  L.VTYP = @VTYP            
  AND L.VNO = @VNO              
  AND L.VDT LIKE  LTRIM(VDT) + '%'            
  AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE            
  AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO            
  AND COSTCODE = (SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM(@BRANCH))            
  ORDER BY   
  L2.DRCR DESC , L2.LNO             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_TRIALBALANCE
-- --------------------------------------------------


CREATE PROCEDURE[dbo].[CLS_TRIALBALANCE]
	@FR_DATE VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@VDT VARCHAR(11), /* AS ON DATE ENTERED BY USER */
	@VIEWOPTION VARCHAR(10), /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */
	@STATUSID VARCHAR(20), /* AS BROKER/BRANCH/CLIENT ETC. */
	@STATUSNAME VARCHAR(20), /* IN CASE OF BRANCH LOGIN BRANCHCODE */
	@SORTBYDATE VARCHAR(3), /* WHETHER REPORT IS BASED ON VDT OR EDT */
	@SHOWZEROBAL VARCHAR(1) = 'N', /* SHOW ZERO BAL   */
	@GRPCODE VARCHAR(20),
	@SHAREDB VARCHAR(20),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(9),
	@TABLE_NAME VARCHAR(100),
	@BRANCHCODE VARCHAR(10) = '',
	@WITHOPENING BIT = 0,
	@SORT_BY VARCHAR(10) = 'ACCODE',
	@SHOW_MARGIN CHAR(1) = 'N'
AS

CREATE TABLE #FORMULA_CLIENT_MASTER
(
	CLTCODE VARCHAR(10) NOT NULL
)

ALTER TABLE #FORMULA_CLIENT_MASTER
 ADD PRIMARY KEY (CLTCODE)

DECLARE @@COSTCODE AS INT,
	@@SQL AS VARCHAR(1000)

CREATE TABLE #COSTMAST (COSTCODE INT, COSTNAME VARCHAR(100))

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.REGION R WHERE REGIONCODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST C, " + @SHAREDB + ".DBO.AREA A WHERE AREACODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "
	
	EXEC (@@SQL)
END

IF @STATUSID = 'BROKER' AND @BRANCHCODE <> ''
BEGIN
	SET @STATUSID = 'BRANCH'
	SET @STATUSNAME = @BRANCHCODE
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTCODE, COSTNAME FROM COSTMAST WHERE COSTNAME = RTRIM('" + @STATUSNAME + "') "
	
	EXEC (@@SQL)
END


CREATE TABLE #TB
(
	CLTCODE VARCHAR(10),
	AMOUNT MONEY
)

IF @WITHOPENING = 1
BEGIN
	ALTER TABLE #TB
	ADD
		OPENING_AMOUNT MONEY,
		PERIOD_CREDIT MONEY,
		PERIOD_DEBIT MONEY
END

DECLARE
	@AMOUNT_PARAMETER VARCHAR(200),
	@NET_AMOUNT_PARAMETER VARCHAR(200),
	@DISPLAY_AMOUNT VARCHAR(300)
	
IF UPPER(@SORTBYDATE) = 'VDT'
BEGIN
	SET @NET_AMOUNT_PARAMETER = 'VDTBAL = SUM(VDTBAL)'
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL'
		SET @DISPLAY_AMOUNT = '-AMOUNT'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'VDTBAL_OPBAL, VDTBAL_DATES_CREDIT, VDTBAL_DATES_DEBIT,VDTBAL'
		SET @DISPLAY_AMOUNT = '-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT, -AMOUNT'
	END
END
ELSE
BEGIN
	SET @NET_AMOUNT_PARAMETER = 'EDTBAL = SUM(EDTBAL)'
	IF @WITHOPENING = 0
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL'
		SET @DISPLAY_AMOUNT = '-AMOUNT'
	END
	ELSE
	BEGIN
		SET @AMOUNT_PARAMETER = 'EDTBAL_OPBAL, EDTBAL_DATES_CREDIT, EDTBAL_DATES_DEBIT, EDTBAL'
		SET @DISPLAY_AMOUNT = '-OPENING_AMOUNT, PERIOD_CREDIT, PERIOD_DEBIT, -AMOUNT'
	END
END


IF UPPER(@VIEWOPTION) = 'GL'
BEGIN
	IF UPPER(@STATUSID) = 'BROKER'
	BEGIN
		INSERT INTO #FORMULA_CLIENT_MASTER
		SELECT CLTCODE
		FROM ACMAST A
		WHERE ACCAT = 4
	
		INSERT INTO #TB
		EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @NET_AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE = ''''', ''
		
		TRUNCATE TABLE #FORMULA_CLIENT_MASTER
	END
	ELSE
	BEGIN
		INSERT INTO #FORMULA_CLIENT_MASTER
		SELECT CLTCODE
		FROM ACMAST A
		WHERE ACCAT = 4
		AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE COSTNAME = BRANCHCODE)
		
		INSERT INTO #TB
		EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @NET_AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE = ''''', ''
		
		TRUNCATE TABLE #FORMULA_CLIENT_MASTER
	END
END	


SET @@SQL = "INSERT INTO #FORMULA_CLIENT_MASTER "
SET @@SQL = @@SQL + "SELECT CLTCODE "
SET @@SQL = @@SQL + "FROM ACMAST A "
IF UPPER(@VIEWOPTION) = 'GL'
	SET @@SQL = @@SQL + "WHERE ACCAT <> 4 "
ELSE IF UPPER(@VIEWOPTION) = 'PARTY'
	SET @@SQL = @@SQL + "WHERE ACCAT = 4 "	
ELSE IF UPPER(@VIEWOPTION) = 'ALL'
	SET @@SQL = @@SQL + "WHERE ACCAT = ACCAT "	
IF UPPER(@STATUSID) <> 'BROKER'
	SET @@SQL = @@SQL + "AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE COSTNAME = BRANCHCODE) "
	
EXEC(@@SQL)	




IF UPPER(@STATUSID) = 'BROKER'
BEGIN
	INSERT INTO #TB
	EXEC CLS_GET_ACC_LEDGER_FORMULA_BALANCES @FR_DATE, @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'M.CLTCODE', ''
END
ELSE
BEGIN
	INSERT INTO #TB
	EXEC CLS_GET_LEDGER2_FORMULA_BALANCES @VDT, 0, @AMOUNT_PARAMETER, @EXCHANGE, @SEGMENT , 'CLTCODE', ''
END

DROP TABLE #FORMULA_CLIENT_MASTER

SET @@SQL = "INSERT INTO ACCOUNT.." + @TABLE_NAME
SET @@SQL = @@SQL + " SELECT TB.CLTCODE, ACNAME, BRANCHCODE,	'" + @EXCHANGE + "','" +  @SEGMENT + "', " + @DISPLAY_AMOUNT + ", ACCAT, A.GRPCODE, GRPNAME "
SET @@SQL = @@SQL + "FROM "
SET @@SQL = @@SQL + "	#TB TB , ACMAST A, GRPMAST G "
SET @@SQL = @@SQL + "WHERE A.GRPCODE = G.GRPCODE AND TB.CLTCODE = A.CLTCODE "
/*SET @@SQL = @@SQL + "UNION "
SET @@SQL = @@SQL + "SELECT CLTCODE, ACNAME = 'PARTY TOTAL', BRANCHCODE = '', -AMOUNT, 0,	'" + @EXCHANGE + "','" +  @SEGMENT + "', '', '' "
SET @@SQL = @@SQL + "FROM #TB WHERE CLTCODE = '' AND ISNULL(AMOUNT, 0) <> 0 "*/
PRINT @@SQL
EXEC(@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CMSPAYMENT_BULK
-- --------------------------------------------------
CREATE PROC [dbo].[CMSPAYMENT_BULK]        
  
 @FNAME VARCHAR(100),        
 @UNAME VARCHAR(25),        
 @BANK_CODE VARCHAR(10),        
 @USERCAT SMALLINT        
        
AS        
/*        
 CMSPAYMENT_BULK 'D:\BACKOFFICE\CMSPAYMENT\TEST_SAMPLE.CSV', 'SAMPLE', '03036', 1        
*/        
SET NOCOUNT ON        
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/        
DECLARE        
 @@STD_DATE VARCHAR(11),        
 @@LST_DATE VARCHAR(11),        
 @@BRANCHFLAG AS TINYINT,        
 @@VNOFLAG AS TINYINT,        
 @@VNOMETHOD INT,        
 @@ACNAME CHAR(100),        
 @@BOOKTYPE CHAR(2),        
 @@MICRNO VARCHAR(10),        
 @@DRCR VARCHAR(1),        
 @@VTYP SMALLINT,        
 @@BANK_CODE VARCHAR(100),        
 @@BACKDAYS INT,        
 @@BACKDATE VARCHAR(11),        
 @@BRNCOUNT   TINYINT,        
 @@MonthlyVdt VARCHAR(11),        
 @@SERIAL_NO INT,        
 @@COSTCODECOUNT TINYINT,        
 @@COSTCODEUPDATES CURSOR,        
 @@NEWVNO AS VARCHAR(12),        
 @@MAXCOUNT AS INT,        
 @@VDT AS VARCHAR(11),        
 @@COUNTER AS INT,        
 @@BANKBRANCH AS VARCHAR(10),        
 @@BANKCOST AS NUMERIC,        
 @@LNOCUR AS CURSOR,        
 @@VNOCUR AS CURSOR,        
 @@LNOVNO AS VARCHAR(12),        
 @@MAXVNO AS INT,        
 @@L2CUR AS CURSOR,        
 @@L2VNO AS VARCHAR(12),        
 @@ERROR_COUNT AS INT,        
 @@FILEEXISTS AS INT,        
 @@SQL AS VARCHAR(2000)        
        
/*--------------------------VALIDATION BASED ON VALID BANK CODE ------------------------*/        
SELECT        
 @@ERROR_COUNT = ISNULL(COUNT(1), 0)        
FROM        
 ACMAST        
WHERE        
 CLTCODE = @BANK_CODE        
 AND ACCAT = 2        
        
IF @@ERROR_COUNT = 0        
 BEGIN        
  SELECT        
   'FILE CANNOT BE UPLOADED AS SUPPLIED BANK CODE DOES NOT EXIST AS BANK', 'NA','NA'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
        
IF LEFT(@FNAME, 25) <> 'D:\BackOffice\CMSPayment\'        
 BEGIN        
  SELECT 'THE FILE YOU ARE UPLOADING MUST BE LOCATED IN D:\BackOffice\CMSPayment OF DATA SERVER', 'NA', 'NA'        
  RETURN        
 END        
        
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT        
   U_FILENAME        
  FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
 ) A        
IF @@ERROR_COUNT > 0        
 BEGIN        
  SELECT        
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'        
  RETURN        
 END        
CREATE TABLE #FEXIST        
(        
 F1 SMALLINT,        
 F2 SMALLINT,        
 F3 SMALLINT        
)        
SELECT @@SQL = "INSERT INTO "        
SELECT @@SQL = @@SQL + " #FEXIST "        
SELECT @@SQL = @@SQL + " (F1, F2, F3) "        
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "        
        
EXEC(@@SQL)        
        
SELECT        
 @@FILEEXISTS = F1        
FROM        
 #FEXIST        
        
IF @@FILEEXISTS = 0        
 BEGIN        
  DROP TABLE #FEXIST        
  SELECT        
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'        
  RETURN        
 END        
DROP TABLE #FEXIST        
        
BEGIN TRAN        
        
INSERT INTO        
 V2_UPLOADED_FILES        
SELECT        
 @FNAME,        
 @FNAME,        
 CNT = COUNT(1),        
 'B',        
 GETDATE(),        
 @UNAME,        
 'RECEIPT/PAYMENT UPLOAD'        
        
        
CREATE TABLE #CMSFILE        
(        
 PRODUCT_CO VARCHAR(20),        
 DDNO VARCHAR(15),        
 DDDT VARCHAR(10),        
 BENEF_DESCRIPTION VARCHAR(100),        
 AMOUNT MONEY,        
 LOC_DESCRIPTION VARCHAR(50),        
 STATUS VARCHAR(20),        
 CLTCODE VARCHAR(10),        
 NARRATION VARCHAR(234)        
)        
CREATE TABLE #RECPAY_TABLE_TMP        
(        
 SERIAL_NO INT IDENTITY(1,1),        
 EDATE VARCHAR(20),        
 VOUCHER_DATE VARCHAR(20),        
 CLIENT_CODE VARCHAR(50),        
 AMOUNT MONEY,        
 DRCR VARCHAR(1),        
 NARRATION VARCHAR(234),        
 BANK_CODE VARCHAR(10),        
 BANK_NAME VARCHAR(100),        
 REF_NO VARCHAR(15),        
 BRANCHCODE VARCHAR(20),        
 BRANCH_NAME VARCHAR(50),        
 CHQ_MODE VARCHAR(1),        
 CHQ_DATE VARCHAR(20),        
 CHQ_NAME VARCHAR(100),        
 CL_MODE VARCHAR(1)        
)        
CREATE TABLE [#RECPAY_TABLE]        
(        
 SERIAL_NO INT,        
 EDATE VARCHAR(20),        
 VOUCHER_DATE VARCHAR(20),        
 CLIENT_CODE VARCHAR(50),        
 AMOUNT MONEY,        
 DRCR VARCHAR(1),        
 NARRATION VARCHAR(234),        
 BANK_CODE VARCHAR(10),        
 BANK_NAME VARCHAR(100),        
 REF_NO VARCHAR(15),        
 BRANCHCODE VARCHAR(20),        
 BRANCH_NAME VARCHAR(50),        
 CHQ_MODE VARCHAR(1),        
 CHQ_DATE VARCHAR(20),        
 CHQ_NAME VARCHAR(100),        
 CL_MODE VARCHAR(1),        
 SNO INT IDENTITY (1, 1) NOT NULL ,        
 VDT DATETIME NULL ,        
 FYSTART DATETIME NULL ,        
 FYEND DATETIME NULL ,        
 UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),        
 EDT DATETIME NULL ,        
 DDDT DATETIME NULL ,        
 VNO VARCHAR (12) NULL ,        
 VTYP SMALLINT NULL ,        
 ACNAME VARCHAR (100) NULL ,        
 COSTCODE SMALLINT NULL,        
 BANKCOST SMALLINT NULL,        
 LNO SMALLINT NOT NULL DEFAULT(0),        
 BANKNAME VARCHAR(100) NULL,        
 MICRNO INT NULL,        
 BOOKTYPE VARCHAR(2) NULL,        
) ON [PRIMARY]        
        
SELECT @@SQL = "BULK INSERT #CMSFILE FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "        
EXEC (@@SQL)        
        
IF @@ERROR <> 0        
 BEGIN        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRANSACTION        
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'        
  RETURN        
 END        
INSERT INTO        
 V2_UPLOADED_FILES        
SELECT        
 @FNAME,        
 @FNAME,        
 CNT = COUNT(1),        
 'B',        
 GETDATE(),        
 @UNAME,        
 'RECEIPT/PAYMENT UPLOAD'        
INSERT INTO        
 #RECPAY_TABLE        
 (        
  EDATE,        
  VOUCHER_DATE,        
  CLIENT_CODE,        
  AMOUNT,        
  DRCR,        
  NARRATION,        
  BANK_CODE,        
  REF_NO,        
  CHQ_MODE,        
  CHQ_DATE,        
  CL_MODE        
 )        
SELECT        
 DDDT,        
 DDDT,        
 UPPER(LTRIM(RTRIM(CLTCODE))),        
 AMOUNT,        
 DRCR = 'D',        
 NARRATION,        
 BANK_CODE = @BANK_CODE,        
 REF_NO = DDNO,        
 CHQ_MODE = 'C',        
 CHQ_DATE = DDDT,        
 CL_MODE = 'O'        
FROM        
 #CMSFILE        
        
UPDATE #RECPAY_TABLE SET SERIAL_NO = SNO        
        
UPDATE        
 #RECPAY_TABLE        
SET        
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),        
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),        
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))        
        
SELECT TOP 1        
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)        
FROM        
 #RECPAY_TABLE        
        
SELECT        
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),        
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),        
 @@BRANCHFLAG = BRANCHFLAG,        
 @@VNOFLAG = VNOFLAG        
FROM        
 PARAMETER        
WHERE        
 @@VDT BETWEEN SDTCUR AND LDTCUR        
        
        
IF @@BRANCHFLAG = 1        
 BEGIN        
  UPDATE        
   #RECPAY_TABLE        
  SET        
   BRANCHCODE = A.BRANCHCODE,        
   FYSTART = P.SDTCUR,        
   FYEND = P.LDTCUR,        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   CHQ_NAME = A.LONGNAME,        
   COSTCODE = C.COSTCODE,        
   BANK_NAME = B.LONGNAME,        
   BANKNAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0),        
   VTYP = 3        
  FROM        
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND P.CURYEAR = 1        
   AND A.ACCAT IN ('4', '3')        
   AND B.ACCAT = '2'        
   AND A.BRANCHCODE = COSTNAME        
          
  UPDATE        
   #RECPAY_TABLE        
  SET        
   BRANCHCODE = 'HO',        
   FYSTART = P.SDTCUR,        
   FYEND = P.LDTCUR,        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   CHQ_NAME = A.LONGNAME,        
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO'),        
   BANK_NAME = B.LONGNAME,        
   BANKNAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0),        
   VTYP = 3        
  FROM        
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND P.CURYEAR = 1        
   AND A.ACCAT IN ('4', '3')        
   AND B.ACCAT = '2'        
   AND A.BRANCHCODE = 'ALL'        
        
  UPDATE        
   #RECPAY_TABLE        
  SET        
   BRANCHCODE = 'HO',        
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),        
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),        
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),        
   FYSTART = P.SDTCUR,        
   FYEND = P.LDTCUR,        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   CHQ_NAME = A.LONGNAME,        
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,        
   BANKNAME = B.LONGNAME,        
   BANK_NAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0),        
   VTYP = 3        
  FROM        
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND P.CURYEAR = 1        
   AND A.ACCAT IN ('4', '3')        
   AND B.ACCAT = '2'        
   AND #RECPAY_TABLE.UPDFLAG = 'N'        
 END        
ELSE        
 BEGIN        
  UPDATE        
   #RECPAY_TABLE        
  SET        
   FYSTART = @@STD_DATE,        
   FYEND = @@LST_DATE + ' 23:59:59',        
   UPDFLAG = 'Y',        
   ACNAME = A.LONGNAME,        
   CHQ_NAME = A.LONGNAME,        
   BANKNAME = B.LONGNAME,        
   BANK_NAME = B.LONGNAME,        
   BOOKTYPE = B.BOOKTYPE,        
   MICRNO = ISNULL(B.MICRNO, 0),        
   VTYP = 3        
  FROM        
   ACMAST A, ACMAST B        
  WHERE        
   A.CLTCODE = CLIENT_CODE        
   AND B.CLTCODE = BANK_CODE        
   AND A.ACCAT IN ('4', '3')        
   AND B.ACCAT = '2'        
 END        
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */        
        
 SELECT        
  @@ERROR_COUNT = COUNT(DISTINCT VDT)        
 FROM        
  #RECPAY_TABLE        
 IF @@ERROR_COUNT > 1        
  BEGIN        
   SELECT        
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'        
   DROP TABLE #RECPAY_TABLE_TMP        
   DROP TABLE #RECPAY_TABLE        
   ROLLBACK TRAN        
   DELETE        
   FROM        
    V2_UPLOADED_FILES        
   WHERE        
    U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
   RETURN        
  END        
 SELECT @@ERROR_COUNT = 0        
        
/* -------------- VALIDATION FOR DEFAULT FINANCIAL YEAR-------------------------- */        
        
 SELECT        
  @@ERROR_COUNT = COUNT(1)        
 FROM        
  #RECPAY_TABLE R, PARAMETER P        
 WHERE R.VDT NOT BETWEEN SDTCUR AND LDTCUR AND CURYEAR = 1        
        
 IF @@ERROR_COUNT > 1        
  BEGIN        
   SELECT        
    'SOME OF THE VOUCHERS ARE NOT FALLING IN DEFAULT FINANCIAL YEAR.', 'NA', 'NA'        
   DROP TABLE #RECPAY_TABLE_TMP        
   DROP TABLE #RECPAY_TABLE        
   ROLLBACK TRAN        
   DELETE        
   FROM        
    V2_UPLOADED_FILES        
   WHERE        
    U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
   RETURN        
  END        
 SELECT @@ERROR_COUNT = 0        
        
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */        
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT DISTINCT        
   DDNO  = RP.REF_NO        
  FROM        
   #RECPAY_TABLE RP,        
   LEDGER1 L1        
    WITH(NOLOCK)        
  WHERE        
   L1.DDNO = RP.REF_NO        
   AND L1.DD = RP.CHQ_MODE        
   AND L1.DRCR = @@DRCR        
   AND L1.VTYP = @@VTYP        
   AND RP.REF_NO <> '0'        
 ) A        
IF @@ERROR_COUNT > 0        
 BEGIN        
  SELECT        
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'        
  UNION ALL        
  SELECT DISTINCT        
   RP.REF_NO, 'NA','NA'        
  FROM        
   #RECPAY_TABLE RP,        
   LEDGER1 L1        
    WITH(NOLOCK)        
  WHERE        
   L1.DDNO = RP.REF_NO        
   AND L1.DD = RP.CHQ_MODE        
   AND L1.DRCR = @@DRCR        
   AND L1.VTYP = @@VTYP        
   AND RP.CHQ_MODE <> 'N'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
        
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/        
SELECT        
 @@ERROR_COUNT = COUNT(1)        
FROM        
 (        
  SELECT DISTINCT        
   CLIENT_CODE        
  FROM        
   #RECPAY_TABLE        
  WHERE        
   UPDFLAG = 'N'        
 ) A        
IF @@ERROR_COUNT > 0        
 BEGIN        
  SELECT        
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'        
  UNION ALL        
  SELECT DISTINCT        
   CLIENT_CODE, 'NA','NA'        
  FROM        
   #RECPAY_TABLE        
  WHERE        
   UPDFLAG = 'N'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
        
/*--------------------------VALIDATION BASED ON VDTs OUTSIDE FINANCIAL YEAR ------------------------*/        
SELECT        
 @@ERROR_COUNT = ISNULL(COUNT(1), 0)        
FROM        
 #RECPAY_TABLE        
WHERE        
 VDT NOT BETWEEN FYSTART AND FYEND        
        
IF @@ERROR_COUNT > 0        
 BEGIN        
  SELECT        
   'FILE CANNOT BE UPLOADED AS SOME OF THE DATES ARE NOT FALLING IN CURRENT FINANCIAL YEAR.', 'NA','NA'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM        
   V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
        
        
/*----------------VNO GENERATION--------------------------*/        
CREATE TABLE #VNO (VNO VARCHAR(12))        
SELECT @@BOOKTYPE = BOOKTYPE, @@VDT = CONVERT(VARCHAR(11), VDT, 109), @@COUNTER = COUNT(1) FROM #RECPAY_TABLE GROUP BY BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109)        
INSERT INTO #VNO EXEC ACC_GENVNO_NEW @@VDT, 3, @@BOOKTYPE, @@STD_DATE, @@LST_DATE, @@COUNTER        
SELECT @@NEWVNO = VNO FROM #VNO        
UPDATE #RECPAY_TABLE SET VNO = CONVERT(VARCHAR(12), (CONVERT(NUMERIC, @@NEWVNO) + SERIAL_NO) - 1)        
DROP TABLE #VNO        
        
IF @@BRANCHFLAG = 1        
 BEGIN        
  UPDATE #RECPAY_TABLE        
  SET BANKCOST = C.COSTCODE        
  FROM ACMAST A, COSTMAST C        
  WHERE         
   #RECPAY_TABLE.BANK_CODE = A.CLTCODE        
   AND A.ACCAT = 2        
   AND A.BRANCHCODE = C.COSTNAME        
   AND A.BRANCHCODE <> 'ALL'        
        
  UPDATE #RECPAY_TABLE      
  SET BANKCOST = COSTCODE        
  FROM ACMAST A        
  WHERE         
   #RECPAY_TABLE.BANK_CODE = A.CLTCODE        
   AND A.ACCAT = 2        
   AND A.BRANCHCODE = 'ALL'        
 END        
        
        
        
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */        
INSERT INTO        
 LEDGER1        
  (        
   BNKNAME,        
   BRNNAME,        
   DD,        
   DDNO,        
   DDDT,        
   RELDT,        
   RELAMT,        
   REFNO,        
   RECEIPTNO,        
   VTYP,        
   VNO,        
   LNO,        
   DRCR,        
   BOOKTYPE,        
   MICRNO,        
   SLIPNO,        
   SLIPDATE,        
   CHEQUEINNAME,        
   CHQPRINTED,        
   CLEAR_MODE        
  )        
SELECT        
 BNKNAME = MAX(BANK_NAME),        
 BRNNAME = MAX(BRANCH_NAME),        
 DD = MAX(CHQ_MODE),        
 DDNO = MAX(REF_NO),        
 DDDT = MAX(DDDT),        
 RELDT = '',        
 RELAMT = SUM(AMOUNT),        
 REFNO = 0,        
 RECEIPTNO = 0,        
 VTYP,        
 VNO,        
 LNO = 2,        
 DRCR,        
 BOOKTYPE = BOOKTYPE,        
 MICRNO = MICRNO,        
 SLIPNO = 0,        
 SLIPDATE = '',        
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),        
 CHQPRINTED = 0,      
 CLEAR_MODE = MAX(CL_MODE)        
FROM        
 #RECPAY_TABLE        
GROUP BY        
 VTYP,        
 VNO,        
 DRCR,        
 BOOKTYPE,        
 MICRNO        
        
IF @@ERROR <> 0        
 BEGIN        
  SELECT        
   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  ROLLBACK TRAN        
  DELETE FROM V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
        
        
/*================================        
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK        
=================================*/        
CREATE TABLE #LEDGER        
(        
 VTYP SMALLINT,        
 VNO VARCHAR(12),        
 EDT DATETIME,        
 LNO SMALLINT,        
 ACNAME VARCHAR(100),        
 DRCR VARCHAR(1),        
 VAMT MONEY,        
 VDT DATETIME,        
 VNO1 VARCHAR(12),        
 REFNO CHAR(12),        
 BALAMT MONEY,        
 NODAYS INT,        
 CDT DATETIME,        
 CLTCODE VARCHAR(10),        
 BOOKTYPE VARCHAR(2),        
 ENTEREDBY VARCHAR(25),        
 PDT DATETIME,        
 CHECKEDBY VARCHAR(25),        
 ACTNODAYS INT,        
 NARRATION VARCHAR(234)        
)        
CREATE TABLE #LEDGER3        
(        
 NARATNO INT,        
 NARR VARCHAR(234),        
 REFNO CHAR(12),        
 VTYP SMALLINT,        
 VNO VARCHAR(12),        
 BOOKTYPE VARCHAR(2)        
)            
/*==============================        
CLIENT SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER        
 (        
  VTYP,        
  VNO,        
  EDT,        
  LNO,        
  ACNAME,        
  DRCR,        
  VAMT,        
  VDT,        
  VNO1,        
  REFNO,        
  BALAMT,        
  NODAYS,        
  CDT,        
  CLTCODE,        
  BOOKTYPE,        
  ENTEREDBY,        
  PDT,        
  CHECKEDBY,        
  ACTNODAYS,        
  NARRATION        
 )        
SELECT        
 VTYP,        
 VNO,        
 EDT,        
 LNO = 2,        
 ACNAME,        
 DRCR,        
 VAMT = AMOUNT,        
 VDT,        
 VNO1 = VNO,        
 REFNO = 0,        
 BALAMT = AMOUNT,        
 NODAYS = 0,        
 CDT = GETDATE(),        
 CLTCODE = CLIENT_CODE,        
 BOOKTYPE = BOOKTYPE,        
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),        
 PDT = GETDATE(),        
 CHECKEDBY = @UNAME,        
 ACTNODAYS = 0,        
 NARRATION        
FROM        
 #RECPAY_TABLE        
        
        
/*==============================        
BANK SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER        
SELECT        
 VTYP,        
 VNO,        
 EDT,        
 LNO = 1,        
 BANKNAME,        
 DRCR =        
  (        
   CASE        
    WHEN DRCR = 'D'        
    THEN 'C'        
    ELSE 'D'   
   END        
  ),        
 VAMT = SUM(AMOUNT),        
 VDT,        
 VNO1 = VNO,        
 REFNO = 0,        
 BALAMT = SUM(AMOUNT),        
 NODAYS = 0,        
 CDT = GETDATE(),        
 CLTCODE = BANK_CODE,        
 BOOKTYPE = BOOKTYPE,        
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),        
 PDT = GETDATE(),        
 CHECKEDBY = @UNAME,        
 ACTNODAYS = 0,        
 NARRATION = MAX(NARRATION)        
FROM        
 #RECPAY_TABLE        
GROUP BY        
 VTYP,        
 VNO,        
 EDT,        
 DRCR,        
 VDT,        
 BANK_CODE,        
 BOOKTYPE,        
 BANKNAME        
        
/*==============================        
INSERTING ALL LEDGER RECORDS AT ONE TIME        
==============================*/        
INSERT INTO LEDGER        
SELECT        
 *        
FROM        
 #LEDGER        
ORDER BY        
 BOOKTYPE,        
 VTYP,        
 VNO,        
 LNO        
        
IF @@ERROR <> 0        
 BEGIN        
  SELECT        
   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  DROP TABLE #LEDGER        
  DROP TABLE #LEDGER3        
  ROLLBACK TRAN        
  DELETE FROM V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
DROP TABLE #LEDGER        
        
/*==============================        
BANK SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER3        
SELECT        
 NARATNO = 1,        
 NARRATION = MAX(NARRATION),        
 REFNO = 0,        
 VTYP,        
 VNO,        
 BOOKTYPE        
FROM       
 #RECPAY_TABLE        
GROUP BY        
 VTYP,        
 VNO,        
 BOOKTYPE        
/*==============================        
CLIENT SIDE RECORD        
==============================*/        
INSERT INTO        
 #LEDGER3        
SELECT        
 NARATNO = 2,        
 NARR = NARRATION,        
 REFNO = 0,        
 VTYP,        
 VNO,        
 BOOKTYPE        
FROM        
 #RECPAY_TABLE        
        
        
        
        
/*==============================        
INSERTING ALL LEDGER3 RECORDS AT ONE TIME        
==============================*/        
INSERT INTO LEDGER3        
SELECT        
 *        
FROM        
 #LEDGER3        
ORDER BY        
 BOOKTYPE,        
 VTYP,        
 VNO,        
 NARATNO        
        
IF @@ERROR <> 0        
 BEGIN        
  SELECT        
   'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'        
  DROP TABLE #RECPAY_TABLE_TMP        
  DROP TABLE #RECPAY_TABLE        
  DROP TABLE #LEDGER3        
  ROLLBACK TRAN        
  DELETE FROM V2_UPLOADED_FILES        
  WHERE        
   U_FILENAME = @FNAME        
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'        
  RETURN        
 END        
DROP TABLE #LEDGER3        
        
IF @@BRANCHFLAG = 1    
    
       
 BEGIN        
  INSERT INTO LEDGER2        
   (VTYPE, VNO, LNO, DRCR, CAMT, COSTCODE, BOOKTYPE, CLTCODE)        
  SELECT        
   VTYPE = 3,        
   VNO,        
   LNO = 1,        
   DRCR = 'C',        
   CAMT = AMOUNT,        
   COSTCODE,        
   BOOKTYPE,        
   BANK_CODE        
  FROM        
   #RECPAY_TABLE        
  WHERE        
   COSTCODE = BANKCOST        
        
      
  INSERT INTO LEDGER2        
   (VTYPE, VNO, LNO, DRCR, CAMT, COSTCODE, BOOKTYPE, CLTCODE)        
  SELECT        
   VTYPE = 3,        
   VNO,        
   LNO = 2,        
   DRCR = 'D',        
   CAMT = AMOUNT,        
   COSTCODE,        
   BOOKTYPE,        
   CLIENT_CODE        
  FROM        
   #RECPAY_TABLE        
  WHERE        
   COSTCODE = BANKCOST        
        
        
        
  SET @@L2CUR = CURSOR FOR        
   SELECT DISTINCT VNO FROM #RECPAY_TABLE WHERE COSTCODE <> BANKCOST        
  OPEN @@L2CUR        
  FETCH NEXT FROM @@L2CUR INTO @@L2VNO        
  WHILE @@FETCH_STATUS = 0        
   BEGIN        
    DELETE FROM        
     TEMPLEDGER2        
    WHERE        
     SESSIONID = '9999999999'        
/*==============================        
CLIENT SIDE RECORD        
==============================*/        
    INSERT INTO        
     TEMPLEDGER2        
    SELECT        
     'BRANCH',        
     C.COSTNAME,        
     AMOUNT,        
     VTYP = 3,        
     VNO,        
     LNO = 2,        
     DRCR = 'D',        
     '0',        
     BOOKTYPE,        
     '9999999999',        
     CLIENT_CODE,        
     'A',        
     '0'        
    FROM        
     #RECPAY_TABLE RP,        
     COSTMAST C        
    WHERE        
     RP.COSTCODE = C.COSTCODE        
     AND VNO = @@L2VNO        
        
/*==============================        
BANK SIDE RECORD        
==============================*/        
    INSERT INTO        
     TEMPLEDGER2        
    SELECT        
     'BRANCH',        
     C.COSTNAME,        
     SUM(AMOUNT),        
     VTYP = 3,        
     VNO,        
     LNO = 1,        
     DRCR = 'C',        
     '0',        
     BOOKTYPE,        
     '9999999999',        
     BANK_CODE,        
     'A',        
     '0'        
    FROM        
     #RECPAY_TABLE RP,        
     COSTMAST C        
    WHERE        
     RP.BANKCOST = C.COSTCODE        
     AND VNO = @@L2VNO        
    GROUP BY        
     C.COSTNAME,        
     VNO,        
     BANK_CODE,        
     BOOKTYPE     
    
        
        
    EXEC INSERTTOLEDGER2        
     '9999999999',        
     @@L2VNO,        
     '1',        
     '1',        
     '1',        
     'BROKER',        
     'BROKER'        
    FETCH NEXT FROM @@L2CUR INTO @@L2VNO        
   END        
  DELETE FROM        
   TEMPLEDGER2        
  WHERE        
   SESSIONID = '9999999999'        
 END        
COMMIT TRAN     
    
      
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL        
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE        
DROP TABLE #RECPAY_TABLE_TMP        
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CMSRECO_BULK_YES
-- --------------------------------------------------







CREATE PROC [dbo].[CMSRECO_BULK_YES]
 @BANKCODE VARCHAR(10),      
 @FNAME VARCHAR(500),      
 @UNAME VARCHAR(100)      
      
AS      
      
SET NOCOUNT ON       
/*--------------------------VALIDATION FOR SINVOUCHER TYPE BASED ON DRCR ------------------------*/      
      
DECLARE        
 @@ERROR_COUNT INT,       
 @@CMSRECOCOUNT AS INT,       
 @@MICRNO AS VARCHAR(10),      
 @@FROMDATE AS DATETIME,      
 @@SQL VARCHAR(8000)      
      
      
/*        SELECT @@ERROR_COUNT = COUNT(1) FROM (SELECT U_FILENAME FROM V2_UPLOADED_FILES        
WHERE U_FILENAME = '" & UCASE(FNAME) &' AND U_MODULE = 'CMS AUTO-RECONCILIATION') A       
      
IF @@ERROR_COUNT > 0       
BEGIN       
SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + '" & UCASE(FNAME) &'       
RETURN       
END */      
      
/*--        DROP TABLE #CMS_TABLE        
--        DROP TABLE #CMS_TABLE_TMP  */      
CREATE TABLE #CMS_TABLE_TMP       
(       
 STRLINETEXT VARCHAR(8000)       
)       
      
CREATE TABLE [DBO].[#CMS_TABLE_TEST] (       
	CORPORATION_CODE VARCHAR(15),
	CLIENT_CODE VARCHAR(20),
	PICKUP_LOC_CODE VARCHAR(50),
	PICKUP_POINT_CODE VARCHAR(50),
	ACCT_ENTRY_AMNT VARCHAR(25),
	DEPOSIT_SLIP_AMT VARCHAR(25),
	DRAWEE_BANK_DESCRIPTION VARCHAR(50),
	ACT_CLIENT_VALUE_DATE VARCHAR(30),
	CLEARING_LOC_DESC VARCHAR(50),
	DEBIT_CREDIT_FLAG VARCHAR(50),
	DEPOSIT_DATE VARCHAR(20),
	DEPOSIT_ENTRY_DATE VARCHAR(20),
	DEPOSIT_NMBR VARCHAR(25),
	DRAWER_DESCRIPTION VARCHAR(100),
	INPUT_DEPOSIT_NMBR VARCHAR(25),
	INSTRUMENT_DATE VARCHAR(25),
	INSTRUMENT_NMBR VARCHAR(30),
	PRODUCT_CODE VARCHAR(25),
	PRODUCT_DESCRIPTION VARCHAR(50),
	REMARKS VARCHAR(50),
	RETURN_REASON VARCHAR(100),
	VALUE_DATE VARCHAR(25),
	ENRICHMENT VARCHAR(500),
	ENRICHMENT1 VARCHAR(500),
	ENRICHMENT2 VARCHAR(500),
	ENRICHMENT3 VARCHAR(500),
	ENRICHMENT4 VARCHAR(500),
	ENRICHMENT5 VARCHAR(500),
	ENRICHMENT6 VARCHAR(500),
	ENRICHMENT7 VARCHAR(500),
	ENRICHMENT8 VARCHAR(500),      
	ENRICHMENT9 VARCHAR(500)
) ON [PRIMARY]       
      
CREATE TABLE [DBO].[#CMS_TABLE] (       
	[SNO] [INT] NOT NULL IDENTITY(1,1),       
	CORPORATION_CODE VARCHAR(15),
	CLIENT_CODE VARCHAR(20),
	PICKUP_LOC_CODE VARCHAR(50),
	PICKUP_POINT_CODE VARCHAR(50),
	ACCT_ENTRY_AMNT VARCHAR(25),
	DEPOSIT_SLIP_AMT VARCHAR(25),
	DRAWEE_BANK_DESCRIPTION VARCHAR(50),
	ACT_CLIENT_VALUE_DATE VARCHAR(20),
	CLEARING_LOC_DESC VARCHAR(50),
	DEBIT_CREDIT_FLAG VARCHAR(5),
	DEPOSIT_DATE VARCHAR(20),
	DEPOSIT_ENTRY_DATE VARCHAR(20),
	DEPOSIT_NMBR VARCHAR(25),
	DRAWER_DESCRIPTION VARCHAR(100),
	INPUT_DEPOSIT_NMBR VARCHAR(25),
	INSTRUMENT_DATE VARCHAR(25),
	INSTRUMENT_NMBR VARCHAR(25),
	PRODUCT_CODE VARCHAR(25),
	PRODUCT_DESCRIPTION VARCHAR(50),
	REMARKS VARCHAR(50),
	RETURN_REASON VARCHAR(50),
	VALUE_DATE VARCHAR(25),
	ENRICHMENT VARCHAR(500),
	ENRICHMENT1 VARCHAR(25),
	ENRICHMENT2 VARCHAR(25),
	ENRICHMENT3 VARCHAR(25),
	ENRICHMENT4 VARCHAR(25),
	ENRICHMENT5 VARCHAR(25),
	ENRICHMENT6 VARCHAR(25),
	ENRICHMENT7 VARCHAR(25),
	ENRICHMENT8 VARCHAR(25),      
	ENRICHMENT9 VARCHAR(25),  
	[STRBANKCODE] [VARCHAR] (10) NOT NULL,       
	[STRSTATUS] [VARCHAR] (8) NOT NULL,
	[E3] [VARCHAR] (20) NULL,
	[CROSSREFERENCENO] INT NULL, 
) ON [PRIMARY]       
      
      
      
SELECT @@SQL = "BULK INSERT #CMS_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', ROWTERMINATOR = '\n', FIRSTROW = 2, LASTROW = 2, KEEPNULLS)"      
EXEC (@@SQL)   
     
SELECT @@SQL = "BULK INSERT #CMS_TABLE_TEST FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', ROWTERMINATOR = '\n', FIRSTROW = 2, KEEPNULLS)"                  
EXEC (@@SQL)        

CREATE TABLE #CMS_PROCESS
(
	[SNO] [INT] NOT NULL IDENTITY(1,1),       
	BANKCODE VARCHAR(10), 
	CLTCODE VARCHAR(10),
	ACCNO VARCHAR(30), 
	DEPOSIT_DATE DATETIME, 
	ENTRY_AMNT MONEY,
	INST_NO VARCHAR(30),
	DRCR CHAR(1),
	VALUE_DATE DATETIME,
	[CROSSREFERENCENO] INT NULL,
	STRSTATUS VARCHAR(10)
)

DECLARE
	@CMS_CODE VARCHAR(20)
	
SELECT @CMS_CODE = CMS_CODE FROM ACCOUNT..COMPANY_MASTER_SETTING M, Owner O
WHERE M.EXCHANGE = O.Exchange AND M.SEGMENT = O.segment	



INSERT INTO #CMS_PROCESS
SELECT 
	@BANKCODE, 
	LEFT(LTRIM(RTRIM(.DBO.PIECE((REPLACE(REPLACE(ENRICHMENT, 'CLIENT ID :- ', ''), 'CLIENT ACCOUNT NO :- ', '')), '.' , 1))), 10),
	LEFT(LTRIM(RTRIM(.DBO.PIECE((REPLACE(REPLACE(ENRICHMENT, 'CLIENT ID :- ', ''), 'CLIENT ACCOUNT NO :- ', '')), '.' , 2))), 30),
	CONVERT(DATETIME, DEPOSIT_DATE, 101),
	ACCT_ENTRY_AMNT,
	.DBO.REMOVE_ZERO1(INSTRUMENT_NMBR,'0'),
	DEBIT_CREDIT_FLAG,
	CONVERT(DATETIME, VALUE_DATE, 101),
	0,
	'MISMATCH'
FROM #CMS_TABLE_TEST
WHERE CLIENT_CODE = @CMS_CODE



/*      
INSERT INTO V2_UPLOADED_FILES       
SELECT       
 @FNAME,       
 @FNAME,       
 COUNT(1),       
 'B',       
 GETDATE(),       
 @UNAME,       
 'CMS AUTO-RECONCILIATION'       
*/      
      

 
 
      
SELECT @@FROMDATE = DATEADD ( DD , -90, getdate())       

CREATE TABLE #FIRST_HASH_LEDGER
(
	VNO VARCHAR(12),
	VTYP INT,
	BOOKTYPE VARCHAR(3),
	LNO INT,
	CLTCODE VARCHAR(10)
)


INSERT INTO       
 #FIRST_HASH_LEDGER             
SELECT       
 VNO,       
 VTYP,      
 BOOKTYPE,       
 LNO,
 CLTCODE
FROM       
 LEDGER L WITH (NOLOCK)
WHERE       
 VTYP IN (2, 3, 5, 19, 20, 17)       
 AND EXISTS(SELECT VNO FROM LEDGER L1 WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND CLTCODE = @BANKCODE AND VDT >= @@FROMDATE)
 
      
      
SELECT       
 L1.VNO,       
 L1.VTYP,       
 L1.BOOKTYPE,       
 L1.RELAMT,       
 .dbo.REMOVE_ZERO1(L1.ddno, '0')as ddno,
 L1.DRCR,       
 STATUS = 'MISMATCH',       
 SNO = 0,
 REFNO = L1.REFNO,
 CLTCODE,
 RELDT
INTO       
 #FIRST_HASH_LEDGER1       
FROM       
 LEDGER1 L1 WITH (NOLOCK),       
 #FIRST_HASH_LEDGER F WITH (NOLOCK)       
WHERE       
 F.VNO = L1.VNO       
 AND F.VTYP = L1.VTYP       
 AND F.BOOKTYPE = L1.BOOKTYPE       
 AND F.LNO = L1.LNO       
 AND L1.RELDT = ''       
 AND L1.DDNO <> ''       
 AND L1.DDNO <> '0'       
      
DROP TABLE #FIRST_HASH_LEDGER 

DECLARE
	@@CROSS_NO INT
	
SELECT @@CROSS_NO = MAX(CROSSREFERENCENO) FROM BANKRECO

UPDATE #CMS_PROCESS SET CROSSREFERENCENO = @@CROSS_NO + SNO
      
UPDATE       
 L1       
SET       
 STATUS = 'CORRECT',       
 SNO = C.SNO,
 L1.REFNO = CROSSREFERENCENO,
 RELDT = VALUE_DATE      
FROM    
 #FIRST_HASH_LEDGER1 L1,       
 #CMS_PROCESS C WITH (NOLOCK),
 MULTIBANKID M       
WHERE       
 L1.RELAMT = C.ENTRY_AMNT       
 AND L1.DDNO = C.INST_NO
 AND L1.DRCR = C.DRCR
 AND L1.CLTCODE = C.CLTCODE
 AND L1.CLTCODE = M.CLTCODE
 AND M.ACCNO = C.ACCNO
 AND L1.VNO IN      
 (SELECT MIN(VNO) FROM #FIRST_HASH_LEDGER1 L2      
   WHERE L2.RELAMT = C.ENTRY_AMNT       
   AND L2.DDNO = C.INST_NO       
   AND L2.DRCR = C.DRCR)       
      
UPDATE       
 C      
SET       
 STRSTATUS = 'CORRECT'       
FROM       
 #CMS_PROCESS C,       
 #FIRST_HASH_LEDGER1 L1 WITH (NOLOCK)       
WHERE       
 C.SNO = L1.SNO
 
 
 
DELETE       
FROM       
 #FIRST_HASH_LEDGER1       
WHERE       
 STATUS <> 'CORRECT'       
      
SELECT       
 @@ERROR_COUNT = COUNT(1)       
FROM       
 #CMS_PROCESS      
WHERE       
 STRSTATUS <> 'CORRECT'
 AND DRCR = 'C'       
      
SELECT       
 @@MICRNO = MICRNO       
FROM       
 ACMAST       
WHERE       
 CLTCODE = @BANKCODE 
 
 
BEGIN TRAN             
      
/*DELETE FROM CMSRECO WHERE BANK_CODE = @BANKCODEAND FILEHEADER_DATE = @@FILEHEADERDATE       
DELETE FROM CMSRECODETAILS WHERE BANK_CODE = @BANKCODEAND FILEHEADER_DATE = @@FILEHEADERDATE  */      
      
      
/*-----------------------INSERTING INTO CMSRECO, CMSRECODETAILS AND UPDATING LEDGER1 WHEN ALL ARE MATCHED---------*/       
/*
 INSERT        
 INTO CMSRECO        
 (       
  FILEHEADER_DATE,        
  BANK_CODE,        
  MICR_NO,        
  ENTRY_AMOUNT,        
  DEPOSIT_AMOUNT,        
  INST_AMOUNT,        
  STATUS_ID,        
  STATUS_NAME,        
  UPLOAD_BY,        
  UPLOAD_DATE,        
  AMOUNTMISMATCH,        
  MANUALUPDATE,        
  LEDGERAMOUNT       
 )        
 SELECT        
  @@FILEHEADERDATE,        
  BANK_CODE = @BANKCODE,        
  @@MICRNO,        
  ENTRY_AMOUNT =  CASE  WHEN STRDC = 'D'  THEN -SUM(STRENTRYAMOUNT)  ELSE SUM(STRENTRYAMOUNT)  END,        
  DEPOSIT_AMOUNT =  CASE  WHEN STRDC = 'D'  THEN -SUM(STRDEPOSITAMOUNT)  ELSE SUM(STRDEPOSITAMOUNT)  END,        
  INST_AMOUNT =  CASE  WHEN STRDC = 'D'  THEN -SUM(STRINSTAMOUNT)  ELSE SUM(STRINSTAMOUNT)  END,        
  STATUS_ID = @UNAME,        
  STATUS_NAME = @UNAME,        
  UPLOAD_BY = @UNAME,        
  UPLOAD_DATE = GETDATE(),        
  AMOUNTMISMATCH = 'NO',        
  MANUALUPDATE = 'NO',        
  LEDGERAMOUNT =  CASE  WHEN STRDC = 'D'  THEN -SUM(STRENTRYAMOUNT)  ELSE SUM(STRENTRYAMOUNT)  END        
 FROM       
  #CMS_TABLE WITH(NOLOCK)  
  WHERE STRDC = 'C'    
 GROUP BY       
  STRDC        
       
*/       
       
 UPDATE        
  LEDGER1        
 SET       
  RELDT = L1.RELDT,    
  REFNO = L1.REFNO        
 FROM       
  #FIRST_HASH_LEDGER1 L1        
 WHERE       
  LEDGER1.VNO = L1.VNO        
  AND LEDGER1.VTYP = L1.VTYP        
  AND LEDGER1.BOOKTYPE = L1.BOOKTYPE        
  AND LEDGER1.RELAMT = L1.RELAMT        
  AND LEDGER1.DRCR = L1.DRCR        
  AND LEDGER1.RELDT = ''        
  AND STATUS = 'CORRECT'      
       
/*        
      
INSERT        
INTO CMSRECODETAILS        
(        
 FILEHEADER_DATE,        
 ROW_TYPE,        
 ENTRY_ID,        
 ENTRY_TYPE,        
 DEBIT_CREDIT,        
 ENTRY_AMOUNT,        
 VALUE_DATE,        
 POST_DATE,        
 PROD_CODE,        
 PICKUP_LOCATION,        
 PICKUP_DISC,        
 PICKUP_DATE,        
 DEPOSIT_SLIP,      
 DEPOSIT_DATE,        
 DEPOSIT_AMOUNT,        
 NO_OF_INST,        
 DEPOSIT_REMARK,        
 INST_NO,        
 DRAWEE_BANK,        
 CLEAR_LOC,        
 INST_AMOUNT,        
 INST_DATE,        
 DRAWER_NAME,        
 ENRICHMENT_NO,        
 ENRICHMENT_DATE,        
 ENRICHMENT_REMARKS,        
 FILLER,        
 BANK_CODE,        
 MICR_NO,        
 STATUS_ID,        
 STATUS_NAME,        
 UPLOAD_BY,        
 UPLOAD_DATE,        
 STATUS,        
LEDGERAMOUNT        
)        
SELECT        
 @@FILEHEADERDATE,        
 STRROWTYPE,        
 STRENTRYID,        
 STRENTRYTYPE,        
 STRDC,        
 STRENTRYAMOUNT,        
 STRVALUEDATE,        
 STRPOSTDATE,        
 STRPRDCODE,        
 STRPKLOCATION,        
 STRPKDESCRIPTION,        
 STRPKDATE,        
 STRDEPOSITSLIP,        
 STRDEPOSITDATE,        
 STRDEPOSITAMOUNT,        
 STRNOOFINST,        
 STRDEPOSITREMARK,        
 STRINSTNO,        
 STRDRAWEEBANK,        
 STRCLEARLOCATION,        
 STRINSTAMOUNT,        
 STRINSTDATE,        
 STRDRAWERNAME,        
 STRENRICHMENTNO,        
 STRENRICHMENTDATE,        
 STRENRICHMENTREMARK,        
 STRFILLER,        
 STRBANKCODE,        
 @@MICRNO,        
 STATUS_ID = @UNAME,        
 STATUS_NAME = @UNAME,        
 UPLOAD_BY = @UNAME,        
 UPLOAD_DATE = GETDATE(),        
 STRSTATUS,        
 LEDGERAMOUNT = 0       
FROM       
 #CMS_TABLE WITH(NOLOCK) 
 WHERE STRDC = 'C'   
 
 UPDATE BANKRECO SET STATUS = 'MATCHED' WHERE CLTCODE = @BANKCODE AND DESCRIPTION LIKE '%CMS%' AND DRCR = 'C' AND BOOKDATE = @@FILEHEADERDATE        
*/
/*
DECLARE
	@@CROSS_NO INT
	
SELECT @@CROSS_NO = MAX(@@CROSS_NO) FROM BANKRECO*/

--DELETE FROM BANKRECO WHERE CLTCODE = @BANKCODE AND BOOKDATE = @@FILEHEADERDATE AND DESCRIPTION LIKE '%CMS%'

INSERT INTO BANKRECO(Cltcode,BookDate,Description,Amount,DrCr,ValueDate,ReferenceNo,StatusId,StatusName,LoginName,CrossReferenceNo,Status,MicrNo,Dummy1,Dummy2,CMS_SrNo)
SELECT @BANKCODE, VALUE_DATE, CLTCODE + ' ' + ACCNO + 'CMS ', ENTRY_AMNT, DRCR, VALUE_DATE, INST_NO, 'broker', 'broker', @UNAME, CROSSREFERENCENO, CASE WHEN STRSTATUS = 'CORRECT' THEN 'MATCHED' ELSE 'UNMATCHED' END, '999999999', '0', '0', ''
FROM #CMS_PROCESS
--WHERE STRENTRYTYPE = 'T'

/*SELECT @@CROSS_NO = MAX(CROSSREFERENCENO) FROM BANKRECO


INSERT INTO BANKRECO(Cltcode,BookDate,Description,Amount,DrCr,ValueDate,ReferenceNo,StatusId,StatusName,LoginName,CrossReferenceNo,Status,MicrNo,Dummy1,Dummy2,CMS_SrNo)
SELECT @BANKCODE, @@FILEHEADERDATE, 'CMS CHARGES', SUM(STRENTRYAMOUNT), STRDC, STRVALUEDATE, '0', 'broker', 'broker', @UNAME, @@CROSS_NO + 1, 'UNMATCHED', '999999999', '0', '0', ''
FROM #CMS_PROCESS
--WHERE STRENTRYTYPE = 'C'
GROUP BY STRDC, STRVALUEDATE
*/

IF @@ERROR_COUNT = 0       
BEGIN       
    
 SELECT 'DATA UPLOADED SUCCESSFULLY' AS RESULT  
    
END       
ELSE       
BEGIN       
 SELECT 'FILE UPLOADED SUCCESSFULLY WITH FOLLOWING MISMATCHES'       
 UNION ALL       
 select 'INST_NO, INST_AMT, INST_DATE, VALUE_DATE, STATUS '
 UNION ALL       
 SELECT       
  INST_NO + ', ' + CONVERT(VARCHAR, ENTRY_AMNT) + ', ' + CONVERT(VARCHAR(10), VALUE_DATE, 103) + ', AMOUNTMISMATCH' AS RESULT       
 FROM       
  #CMS_PROCESS       
 WHERE       
  STRSTATUS <> 'CORRECT'      
END        
DROP TABLE #CMS_TABLE        
DROP TABLE #CMS_TABLE_TMP       
DROP TABLE #FIRST_HASH_LEDGER1       

COMMIT TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.COMPUTE_DPC_CHARGES
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[COMPUTE_DPC_CHARGES]        
(        
 @FROM_DATE VARCHAR(11),        
 @TO_DATE VARCHAR(11),        
 @FROM_PARTY VARCHAR(10),        
 @TO_PARTY VARCHAR(10)        
)        
AS

/*
EXEC COMPUTE_DPC_CHARGES 'SEP  1 2012', 'SEP 15 2012', 'k26447', 'k26447'
EXEC COMPUTE_DPC_CHARGES 'SEP  1 2012', 'SEP 15 2012', 's5643', 's5643'

SELECT * FROM LEDGER WHERE CLTCODE = 's5643' AND VDT < 'APR  1 2012' AND EDT >= 'APR  1 2012'

SELECT * FROM DPC_CHARGES_VERIFIED_CASH WHERE ENTITY = 'NSE - CAPITAL'
select * from ledger where vno = '201200000134' and vtyp = 15 and cltcode = 'k26447'
*/

CREATE TABLE #DPC_CHARGES        
(        
 DPC_DATE DATETIME,        
 CLTCODE VARCHAR(10),        
 LONG_NAME VARCHAR(100),        
 BRANCH_CD VARCHAR(10),        
 SUB_BROKER VARCHAR(25),        
 TRADER VARCHAR(25),        
 REGION VARCHAR(20),        
 AREA VARCHAR(20),        
 CL_TYPE VARCHAR(10),        
 DPC_BALANCE MONEY,        
 LEDGER_BALANCE MONEY,        
 CASH_COLLATREAL MONEY,        
 NONCASH_COLLATREAL MONEY,        
 MARGIN_REQ MONEY,        
 AMOUNT_REV MONEY,        
 DPC_PERCENTE MONEY        
)  

CREATE TABLE #GET_DPC_CLIENTS
(
	PARTY_CODE VARCHAR(10), 
	LONG_NAME VARCHAR(100),
	BRANCH_CD VARCHAR(20), 
	SUB_BROKER VARCHAR(25), 
	TRADER VARCHAR(25),
	AREA VARCHAR(25),
	REGION VARCHAR(25),
	CL_TYPE VARCHAR(10),
	CREDIT_INT MONEY, 
	DEBIT_INT MONEY, 
	FROMDATE DATETIME, 
	TODATE DATETIME, 
	EXEMPT_NOOFDAYS TINYINT, 
	EXEMPT_NOOFDAYS_CR TINYINT, 
	MIN_INTEREST MONEY, 
	MIN_BALANCE MONEY
)      

INSERT INTO #GET_DPC_CLIENTS
SELECT * FROM .DBO.GET_DPC_CLIENTS(@FROM_PARTY, @TO_PARTY, @FROM_DATE)
        
/*        
CREATE TABLE #DPC_CHARGES_FINAL        
(        
 DPC_DATE DATETIME,        
 CLTCODE VARCHAR(10),        
 LONG_NAME VARCHAR(100),        
 BRANCH_CD VARCHAR(10),        
 SUB_BROKER VARCHAR(25),        
 TRADER VARCHAR(25),        
 REGION VARCHAR(20),        
 AREA VARCHAR(20),        
 CL_TYPE VARCHAR(10),        
 DPC_BALANCE MONEY,        
 LEDGER_BALANCE MONEY,        
 CASH_COLLATREAL MONEY,        
 NONCASH_COLLATREAL MONEY,        
 MARGIN_REQ MONEY,        
 DPC_CHARGE MONEY,        
 DPC_PERCENTE MONEY,        
 AMOUNT_REV MONEY        
)        
*/        
DECLARE        
 @@OPEN_DATE VARCHAR(11)        
         
SELECT         
 @@OPEN_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)        
FROM         
 PARAMETER        
WHERE        
 @FROM_DATE BETWEEN SDTCUR AND LDTCUR        
        
/* TABLE TO MAINTAIN THE T + 2 AND T + 4 LBALANCES TO APPLY THE T + 4 DEBIT BALANCE LOGIC */        
CREATE TABLE #DEBIT_DEPC_BILLS        
(        
 CLTCODE VARCHAR(10),     
 T_DATE DATETIME,     
 T_2_DATE DATETIME,        
 T_4_DATE DATETIME,        
 BILL_AMOUNT MONEY,        
 VDT DATETIME        
)        
        
--, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE,         
        
        
INSERT INTO #DPC_CHARGES(DPC_DATE, CLTCODE, LONG_NAME, DPC_BALANCE, LEDGER_BALANCE, CASH_COLLATREAL, NONCASH_COLLATREAL, MARGIN_REQ, DPC_PERCENTE, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE, AMOUNT_REV)        
SELECT         
 BALDATE,         
 CLTCODE,         
 LONG_NAME,        
 SUM(DPC_BALANCE),         
 LEDGER_BALANCE = SUM(DPC_BALANCE),        
 SUM(CASH_COLLATREAL),         
 SUM(NONCASH_COLLATREAL),        
 SUM(MARGIN_REQ),        
 MAX(DPC_PERCENTE),        
 BRANCH_CD,         
 SUB_BROKER,         
 TRADER,         
 REGION,         
 AREA,         
 CL_TYPE,        
 AMOUNT_REV = 0        
FROM        
(        
 SELECT         
  BALDATE = @FROM_DATE,        
  CLTCODE,        
  LONG_NAME,        
  DPC_BALANCE = SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END),        
  CASH_COLLATREAL = 0,        
  NONCASH_COLLATREAL = 0,        
  MARGIN_REQ = 0,        
  DPC_PERCENTE = MAX(DEBIT_INT),        
  BRANCH_CD,         
  SUB_BROKER,         
  TRADER,         
  REGION,         
  AREA,         
  CL_TYPE        
 FROM        
  LEDGER L, #GET_DPC_CLIENTS C        
 WHERE        
  L.CLTCODE = PARTY_CODE        
  AND VDT >= @@OPEN_DATE        
  AND VDT < @FROM_DATE        
 GROUP BY        
  CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),        
  CLTCODE,        
  LONG_NAME,        
  BRANCH_CD,         
  SUB_BROKER,         
  TRADER,  
  REGION,         
  AREA,         
  CL_TYPE        
 HAVING        
  SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END) <> 0        
          
 UNION ALL        
        
 SELECT         
  BALDATE = @FROM_DATE,        
  CLTCODE,        
  LONG_NAME,        
  DPC_BALANCE = SUM(VAMT),        
  CASH_COLLATREAL = 0,        
  NONCASH_COLLATREAL = 0,        
  MARGIN_REQ = 0,        
  DPC_PERCENTE = MAX(DEBIT_INT),        
  BRANCH_CD,         
  SUB_BROKER,         
  TRADER,         
  REGION,         
  AREA,         
  CL_TYPE        
 FROM        
  LEDGER L, #GET_DPC_CLIENTS C,
  MSAJAG.DBO.GET_SETT_CALENDER(@@OPEN_DATE, @FROM_DATE, 3) S        
 WHERE        
  L.CLTCODE = PARTY_CODE        
  AND S.END_DATE >= @@OPEN_DATE        
  AND S.END_DATE < @FROM_DATE        
  AND VDT = START_DATE
  AND VTYP = 15 AND DRCR = 'D'        
 GROUP BY        
  CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),        
  CLTCODE,        
  LONG_NAME,        
  BRANCH_CD,         
  SUB_BROKER,         
  TRADER,         
  REGION,         
  AREA,         
  CL_TYPE        
 /*HAVING        
  SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END) <> 0      */  
          
 UNION ALL        
         
 SELECT         
  BALDATE = @FROM_DATE,        
  CLTCODE,        
  LONG_NAME,        
  DPC_BALANCE = SUM(-VAMT),        
  CASH_COLLATREAL = 0,        
  NONCASH_COLLATREAL = 0,        
  MARGIN_REQ = 0,        
  DPC_PERCENTE = MAX(DEBIT_INT),        
  BRANCH_CD,         
  SUB_BROKER,         
  TRADER,         
  REGION,         
  AREA,         
  CL_TYPE        
 FROM        
  LEDGER L, #GET_DPC_CLIENTS C,
  MSAJAG.DBO.GET_SETT_CALENDER(@@OPEN_DATE, @FROM_DATE, 3) S                
 WHERE        
  L.CLTCODE = PARTY_CODE        
  AND S.END_DATE >= @@OPEN_DATE        
  AND VDT < @@OPEN_DATE        
  AND VTYP = 15 AND DRCR = 'D'        
  AND VDT = START_DATE
 GROUP BY        
  CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),        
  CLTCODE,        
  LONG_NAME,        
  BRANCH_CD,         
  SUB_BROKER,         
  TRADER,         
  REGION,         
  AREA,         
  CL_TYPE        
 /*HAVING        
  SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END) <> 0      */  
          
 UNION ALL          
          
 SELECT         
  BALDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),        
  CLTCODE,        
  LONG_NAME,        
  DPC_BALANCE = SUM(CASE DRCR WHEN 'D' THEN CASE WHEN VTYP <> 15 THEN VAMT ELSE 0 END ELSE -VAMT END),        
  CASH_COLLATREAL = 0,        
  NONCASH_COLLATREAL = 0,        
  MARGIN_REQ = 0,        
  DPC_PERCENTE = MAX(DEBIT_INT),        
  BRANCH_CD,         
  SUB_BROKER,         
  TRADER,         
  REGION,         
  AREA,         
  CL_TYPE        
 FROM        
  LEDGER L, #GET_DPC_CLIENTS C        
 WHERE        
  L.CLTCODE = PARTY_CODE        
  AND VDT >= @FROM_DATE        
  AND VDT <= @TO_DATE + ' 23:59'        
 GROUP BY        
  CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)),        
  CLTCODE,        
  LONG_NAME,        
  BRANCH_CD,         
  SUB_BROKER,         
  TRADER,         
  REGION,         
  AREA,         
  CL_TYPE        
) A        
GROUP BY        
 BALDATE,         
 CLTCODE,        
 LONG_NAME,        
 BRANCH_CD,         
 SUB_BROKER,         
 TRADER,         
 REGION,         
 AREA,         
 CL_TYPE  
 
 
 DECLARE        
 @EXCHANGE VARCHAR(10),        
 @SEGMENT VARCHAR(10),        
 @SHAREDB VARCHAR(10),        
 @GROUPID VARCHAR(10),        
 @@SQL VARCHAR(1000)        
         
SELECT @EXCHANGE = EXCHANGE, @SEGMENT = SEGMENT, @SHAREDB = SHAREDB, @GROUPID = GROUPID         
FROM dpc_MASTER_SETTING D         
WHERE EXISTS(SELECT EXCHANGE FROM OWNER O WHERE D.EXCHANGE = O.EXCHANGE AND D.SEGMENT = O.SEGMENT)
   
       
         
INSERT INTO #DEBIT_DEPC_BILLS(CLTCODE, T_DATE, T_2_DATE, T_4_DATE, BILL_AMOUNT)        
SELECT         
 CLTCODE, [START_DATE], PAYIN_DATE, END_DATE , SUM(VAMT)        
FROM        
 LEDGER L, #GET_DPC_CLIENTS C, MSAJAG.DBO.GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 3)        
WHERE         
 L.CLTCODE = PARTY_CODE        
 AND CONVERT(VARCHAR(11), VDT, 109) = CONVERT(VARCHAR(11), START_DATE, 109)        
 AND END_DATE >= @FROM_DATE        
 AND END_DATE <= @TO_DATE + ' 23:59'  
 AND VTYP = 15 AND DRCR = 'D'        
GROUP BY        
 CLTCODE, [START_DATE], PAYIN_DATE, END_DATE   
  

        
DECLARE        
      @DAYS INT        
      SELECT @DAYS = DATEDIFF(DD,@FROM_DATE,@TO_DATE) +1        
        
SELECT         
 DPC_DATE = DT.DPC_DATE, CLTCODE, LONG_NAME, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE, DPC_PERCENTE        
INTO #ALL_DATES         
FROM         
 #DPC_CHARGES D,         
 (SELECT        
           DPC_DATE = DATEADD(DD,NUMBER-1,@FROM_DATE)         
      FROM        
            DBO.F_TABLE_NUMBER_RANGE( 1, @DAYS )        
  ) DT        
  
INSERT INTO #DPC_CHARGES         
SELECT DISTINCT        
 DPC_DATE,        
 CLTCODE,        
 LONG_NAME,        
 BRANCH_CD,        
 SUB_BROKER,        
 TRADER,        
 REGION,        
 AREA,        
 CL_TYPE,        
 DPC_BALANCE = 0,        
 LEDGER_BALANCE = 0,        
 CASH_COLLATREAL = 0,        
 NONCASH_COLLATREAL = 0,        
 MARGIN_REQ = 0,        
 AMOUNT_REV = 0,        
 DPC_PERCENTE        
FROM #ALL_DATES A WHERE NOT EXISTS (SELECT DPC_DATE FROM #DPC_CHARGES TEMP WHERE A.CLTCODE = TEMP.CLTCODE AND A.DPC_DATE = TEMP.DPC_DATE)         


--IF @FROM_DATE = @TO_DATE AND @SEGMENT = 'FUTURES'        
IF @SEGMENT = 'FUTURES'        
BEGIN        
	CREATE TABLE #GET_T_4_MIN_MARGIN
	(
		SNO INT IDENTITY(1, 1),
		PARTY_CODE VARCHAR(10),
		VDT DATETIME,
		AMOUNT MONEY,
		MIN_AMT MONEY
	)
	
	CREATE TABLE #GET_T_4_MIN_MARGIN_F
	(
		SNO INT IDENTITY(1, 1),
		PARTY_CODE VARCHAR(10),
		VDT DATETIME,
		AMOUNT MONEY,
		MIN_AMT MONEY
	)

	SET @@SQL = " INSERT INTO #GET_T_4_MIN_MARGIN(PARTY_CODE, VDT, AMOUNT) "
	SET @@SQL = @@SQL + "SELECT "      
	SET @@SQL = @@SQL + "M.PARTY_CODE, "
	SET @@SQL = @@SQL + "VDT = CONVERT(DATETIME, CONVERT(VARCHAR(11), MDATE, 109)), "
	SET @@SQL = @@SQL + "AMOUNT = PSPANMARGIN + MTOM + ADDMARGIN "
	SET @@SQL = @@SQL + "FROM "      
	SET @@SQL = @@SQL + @SHAREDB + ".DBO.FOMARGINNEW M "      
	SET @@SQL = @@SQL + "WHERE MDATE >= DATEADD(D, -10, '" + @FROM_DATE + "') AND MDATE <= '" + @TO_DATE + "'"
	SET @@SQL = @@SQL + " AND M.PARTY_CODE >= '" + @FROM_PARTY + "' AND M.PARTY_CODE <= '" + @TO_PARTY + "'"      
	SET @@SQL = @@SQL + " ORDER BY M.PARTY_CODE, MDATE"
	
	EXEC (@@SQL)
	
	CREATE TABLE #ALL_DATES1
	(
		DPC_DATE DATETIME,
		DPC_CONSIDER DATETIME,
		ISMARGIN CHAR(1),
		NUMBER INT,
		SNO INT IDENTITY(1, 1)
	)
	
	 INSERT INTO #ALL_DATES1(DPC_DATE, ISMARGIN, NUMBER) 
	 SELECT DPC_DATE, ISMARGIN, NUMBER FROM
	 (
	 SELECT        
           DPC_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE), ISMARGIN = 'Y', NUMBER         
     FROM        
            DBO.F_TABLE_NUMBER_RANGE( 1, 30 )  
     WHERE EXISTS(SELECT START_DATE FROM MSAJAG.DBO.GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 3) S WHERE S.START_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE))
     UNION ALL
     SELECT        
           DPC_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE), ISMARGIN = 'N', NUMBER         
     FROM        
            DBO.F_TABLE_NUMBER_RANGE( 1, 30 )  
     WHERE NOT EXISTS(SELECT START_DATE FROM MSAJAG.DBO.GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 3) S WHERE S.START_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE))
     
     )A
     ORDER BY NUMBER
     
     UPDATE A SET DPC_CONSIDER = (SELECT MAX(DPC_DATE) FROM #ALL_DATES1 A1 WHERE A1.SNO <= A.SNO AND A1.ISMARGIN = 'Y')
	 FROM #ALL_DATES1 A 
	 
	 INSERT INTO #GET_T_4_MIN_MARGIN(PARTY_CODE, VDT, AMOUNT)
	 SELECT G.PARTY_CODE, DPC_DATE, AMOUNT FROM #GET_T_4_MIN_MARGIN G, #ALL_DATES1 A
	 WHERE VDT = DPC_CONSIDER
	 AND NOT EXISTS(SELECT VDT FROM #GET_T_4_MIN_MARGIN G1 WHERE A.DPC_DATE = G1.VDT AND G.PARTY_CODE = G1.PARTY_CODE)
	 
	 INSERT INTO #GET_T_4_MIN_MARGIN_F(PARTY_CODE, VDT, AMOUNT)
	 SELECT PARTY_CODE, VDT, AMOUNT
	 FROM #GET_T_4_MIN_MARGIN
	 ORDER BY PARTY_CODE, VDT
   
	 
	 UPDATE G SET MIN_AMT = (SELECT MIN(AMOUNT) FROM #GET_T_4_MIN_MARGIN_F G1 WHERE  G1.SNO + 4 > G.SNO AND G1.SNO <= G.SNO)
	 FROM #GET_T_4_MIN_MARGIN_F G
	 
	 
	INSERT INTO #DPC_CHARGES(DPC_DATE, CLTCODE, LONG_NAME, DPC_BALANCE, LEDGER_BALANCE, CASH_COLLATREAL, NONCASH_COLLATREAL, MARGIN_REQ, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE) 
	SELECT   
		BALDATE = VDT, 
		M.PARTY_CODE, 
		LONG_NAME,     
		DPC_BALANCE = 0, 
		LEDGER_BALANCE = 0, 
		CASH_COLLATREAL = 0, 
		NONCASH_COLLATREAL = 0, 
		MARGIN_REQ = MIN_AMT,   
		BRANCH_CD, 
		SUB_BROKER, 
		TRADER,    
		REGION, 
		AREA,      
		C.CL_TYPE 
	FROM 
	#GET_T_4_MIN_MARGIN_F M, 
	#GET_DPC_CLIENTS C 
	WHERE M.PARTY_CODE = C.PARTY_CODE
	AND VDT >= @FROM_DATE AND VDT <= @TO_DATE
 
	/*TRUNCATE TABLE #ALL_DATES1
	INSERT INTO #ALL_DATES1(DPC_DATE, ISMARGIN, NUMBER) 
	 SELECT DPC_DATE, ISMARGIN, NUMBER FROM
	 (
	 SELECT        
           DPC_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE), ISMARGIN = 'Y', NUMBER         
     FROM        
            DBO.F_TABLE_NUMBER_RANGE( 1, 30 )  
     WHERE EXISTS(SELECT START_DATE FROM MSAJAG.DBO.GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 3) S WHERE S.START_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE))
     UNION ALL
     SELECT        
           DPC_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE), ISMARGIN = 'N', NUMBER         
     FROM        
            DBO.F_TABLE_NUMBER_RANGE( 1, 30 )  
     WHERE NOT EXISTS(SELECT START_DATE FROM MSAJAG.DBO.GET_SETT_CALENDER(@FROM_DATE, @TO_DATE, 3) S WHERE S.START_DATE = DATEADD(DD,NUMBER-4,@FROM_DATE))
     
     )A
     ORDER BY NUMBER
     
     UPDATE A SET DPC_CONSIDER = (SELECT MAX(DPC_DATE) FROM #ALL_DATES1 A1 WHERE A1.SNO <= A.SNO AND A1.ISMARGIN = 'Y')
	 FROM #ALL_DATES1 A 
	 
	 INSERT INTO #GET_T_4_MIN_MARGIN(PARTY_CODE, VDT, AMOUNT)
	 SELECT G.PARTY_CODE, DPC_DATE, AMOUNT FROM #GET_T_4_MIN_MARGIN G, #ALL_DATES1 A
	 WHERE VDT = DPC_CONSIDER
	 AND NOT EXISTS(SELECT VDT FROM #GET_T_4_MIN_MARGIN G1 WHERE A.DPC_DATE = G1.VDT AND G.PARTY_CODE = G1.PARTY_CODE)*/
	 

 CREATE TABLE #COLL_DETAILS
 (
	BALDATE DATETIME,
	PARTY_CODE VARCHAR(10),
	LONG_NAME VARCHAR(100),
	CASH_COLL MONEY,
	NONCASH_COLL MONEY,
	BRANCH_CD VARCHAR(10),        
	SUB_BROKER VARCHAR(25),        
	TRADER VARCHAR(25),        
	REGION VARCHAR(20),        
	AREA VARCHAR(20),        
	CL_TYPE VARCHAR(10)
 )
 
 INSERT INTO #COLL_DETAILS(BALDATE, PARTY_CODE, LONG_NAME, CASH_COLL, NONCASH_COLL, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE)        
 SELECT        
  BALDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), TRANS_DATE, 109)),        
  CO.PARTY_CODE,        
  LONG_NAME,        
  CASH_COLL = CASH,        
  NONCASH_COLL = NONCASH,        
  BRANCH_CD,         
  SUB_BROKER,         
  TRADER,         
  REGION,         
  AREA,         
  CL_TYPE        
 FROM        
  MSAJAG.DBO.COLLATERAL CO, #GET_DPC_CLIENTS C        
 WHERE         
  CO.PARTY_CODE = C.PARTY_CODE        
  AND TRANS_DATE >= @FROM_DATE AND TRANS_DATE <= @TO_DATE        
  AND EXCHANGE = @EXCHANGE        
  AND SEGMENT = @SEGMENT        
  AND CO.PARTY_CODE >= @FROM_PARTY AND CO.PARTY_CODE <= @TO_PARTY
  
  
 INSERT INTO #DPC_CHARGES(DPC_DATE, CLTCODE, LONG_NAME, DPC_BALANCE, LEDGER_BALANCE, CASH_COLLATREAL, NONCASH_COLLATREAL, MARGIN_REQ, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE)        
 SELECT        
  BALDATE = A.DPC_DATE,        
  PARTY_CODE,        
  LONG_NAME,        
  DPC_BALANCE = 0,        
  LEDGER_BALANCE = 0,        
  CASH_COLL,        
  NONCASH_COLL,        
  MARGIN_REQ = 0,        
  BRANCH_CD,         
  SUB_BROKER,         
  TRADER,         
  REGION,         
  AREA,         
  CL_TYPE        
 FROM        
  #COLL_DETAILS CO, #ALL_DATES1 A        
 WHERE CO.BALDATE = DPC_CONSIDER
-- AND NOT EXISTS(SELECT VDT FROM #COLL_DETAILS G1 WHERE A.DPC_DATE = G1.VDT AND G.PARTY_CODE = G1.PARTY_CODE)
  
  
	 
END

UPDATE D SET DPC_BALANCE = (SELECT SUM(DPC_BALANCE) FROM #DPC_CHARGES D1 WHERE D.CLTCODE = D1.CLTCODE AND D1.DPC_DATE <= D.DPC_DATE)        
FROM #DPC_CHARGES D  
WHERE ISNULL(DPC_PERCENTE, 0) <> 0

UPDATE D SET VDT = CASE WHEN DPC_BALANCE + BILL_AMOUNT > 0 THEN T_4_DATE ELSE T_4_DATE END        
FROM        
 #DEBIT_DEPC_BILLS D, #DPC_CHARGES C        
WHERE         
 CONVERT(DATETIME, CONVERT(VARCHAR(11), DPC_DATE, 109)) = CONVERT(DATETIME, CONVERT(VARCHAR(11), T_4_DATE, 109))        
 AND D.CLTCODE = C.CLTCODE  
 
   
INSERT INTO #DEBIT_DEPC_BILLS(CLTCODE, BILL_AMOUNT, VDT)  
SELECT DISTINCT CLTCODE, 0, DPC_DATE  
FROM #ALL_DATES A WHERE NOT EXISTS (SELECT VDT FROM #DEBIT_DEPC_BILLS TEMP WHERE A.CLTCODE = TEMP.CLTCODE AND A.DPC_DATE = TEMP.VDT)  
  
UPDATE D SET BILL_AMOUNT = (SELECT SUM(BILL_AMOUNT) FROM #DEBIT_DEPC_BILLS D1 WHERE D.CLTCODE = D1.CLTCODE AND D1.VDT <= D.VDT AND D1.VDT >= @FROM_DATE)        
FROM #DEBIT_DEPC_BILLS D 

  


       
SELECT        
 C.DPC_DATE,        
 C.CLTCODE,        
 C.LONG_NAME,        
 C.BRANCH_CD,        
 C.SUB_BROKER,        
 C.TRADER,        
 C.REGION,        
 C.AREA,        
 C.CL_TYPE,        
 DPC_BALANCE = C.DPC_BALANCE + ISNULL(BILL_AMOUNT, 0) + CASE WHEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL > 0 THEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL ELSE 0 END,     
 C.LEDGER_BALANCE,        
 CASH_COLLATREAL,        
 NONCASH_COLLATREAL,        
 MARGIN_REQ,        
 DPC_CHARGE = ((CASE WHEN (C.DPC_BALANCE + ISNULL(BILL_AMOUNT, 0) + CASE WHEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL > 0 THEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL ELSE 0 END) > 0 THEN C.DPC_BALANCE + ISNULL(BILL_AMOUNT, 0) + CASE 
WHEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL > 0 THEN MARGIN_REQ - CASH_COLLATREAL - NONCASH_COLLATREAL ELSE 0 END ELSE 0 END) * DEBIT_INT)/ 100/ 365,        
 DPC_PERCENTE = DEBIT_INT,        
 AMOUNT_REV        
FROM        
 (SELECT         
  DPC_DATE, CLTCODE, LONG_NAME, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE,        
  DPC_BALANCE = SUM(DPC_BALANCE),        
  LEDGER_BALANCE = SUM(LEDGER_BALANCE),        
  CASH_COLLATREAL = SUM(CASH_COLLATREAL), NONCASH_COLLATREAL = SUM(NONCASH_COLLATREAL),        
  MARGIN_REQ = SUM(MARGIN_REQ), AMOUNT_REV = SUM(AMOUNT_REV)        
 FROM        
  #DPC_CHARGES         
 GROUP BY DPC_DATE, CLTCODE, LONG_NAME, BRANCH_CD, SUB_BROKER, TRADER, REGION, AREA, CL_TYPE        
 ) C LEFT OUTER JOIN (SELECT CLTCODE, VDT, BILL_AMOUNT = SUM(BILL_AMOUNT) FROM #DEBIT_DEPC_BILLS GROUP BY CLTCODE, VDT) D        
 ON        
  CONVERT(DATETIME, CONVERT(VARCHAR(11), DPC_DATE, 109)) = CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109))        
  AND D.CLTCODE = C.CLTCODE        
 , #GET_DPC_CLIENTS C1        
WHERE         
 C.CLTCODE = C1.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATEPARTYLEDGER
-- --------------------------------------------------




CREATE  PROC CREATEPARTYLEDGER
AS
CREATE TABLE NEWPARTYLEDGER
	(
		BRANCH_CODE VARCHAR(11),
		BRANCH VARCHAR(40),
		CLTCODE VARCHAR(11),
		ACNAME VARCHAR(50),
		VDT DATETIME,
		EDT DATETIME,
		BRANCH_CD VARCHAR(10),
		SUB_BROKER VARCHAR(10),
		TRADER VARCHAR(20),
		FAMILY VARCHAR(10),
		AREA VARCHAR(10),
		REGION VARCHAR(50),
		PARTY VARCHAR(10),
		VAMT MONEY DEFAULT(0) NOT NULL,
		MAMT MONEY DEFAULT(0) NOT NULL,
		UNREALISED MONEY DEFAULT(0) NOT NULL,
		SPID SMALLINT
	)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DATA4BILLPOSTED
-- --------------------------------------------------




CREATE PROC DATA4BILLPOSTED

AS

DECLARE @@COUNTER AS NUMERIC
SELECT @@COUNTER = COUNT(*) FROM BILLPOSTED

IF @@COUNTER = 0
	BEGIN
		BEGIN TRAN
			INSERT 
			INTO BILLPOSTED 
				(
					VNO, 
					VTYP, 
					BOOKTYPE, 
					VDT, 
					BILLDATE, 
					SETT_NO, 
					SETT_TYPE, 
					NARRATION, 
					USERNAME, 
					POSTDATE, 
					EDTDR, 
					EDTCR
				) 
			SELECT 
				VNO, 
				VTYP, 
				BOOKTYPE, 
				CONVERT(VARCHAR(11), VDT, 109), 
				CONVERT(VARCHAR(11), VDT, 109), 
				SUBSTRING(NARRATION, 8, 7), 
				SUBSTRING(NARRATION, 20, 1), 
				--CASE WHEN SUBSTRING(NARRATION, 20, 1) = 'A' THEN SUBSTRING(NARRATION, 20, 2) ELSE SUBSTRING(NARRATION, 20, 1) END, 
				NARRATION, 
				'FROM SYSTEM', 
				GETDATE(), 
				CONVERT(VARCHAR(11), MIN(EDT), 109), 
				CONVERT(VARCHAR(11), MAX(EDT), 109) 
			FROM LEDGER 
			WHERE VDT >= 'APR  1 2005' 
				AND VTYP IN (15, 21) 
			GROUP BY VNO, 
				VTYP, 
				BOOKTYPE, 
				CONVERT(VARCHAR(11), VDT, 109), 
				SUBSTRING(NARRATION, 8, 7), 
				CASE 
					WHEN SUBSTRING(NARRATION, 20, 1) = 'A' 
					THEN SUBSTRING(NARRATION, 20, 2) 
					ELSE SUBSTRING(NARRATION, 20, 1) 
				END
				, 
				NARRATION 
			ORDER BY VNO, 
				VTYP, 
				BOOKTYPE, 
				CONVERT(VARCHAR(11), VDT, 109) 
		COMMIT
	END
ELSE
	BEGIN
		PRINT 'DATA ALREADY FOUND IN TABLE BILLPOSTED. CANNOT CONTINUE...'
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EDITRECONCILE
-- --------------------------------------------------
CREATE PROCEDURE EDITRECONCILE    
                @code    VARCHAR(10),    
                @frmdate VARCHAR(11),    
                @gdate   VARCHAR(11),    
                @gdrcr   VARCHAR(1),    
                @flag    VARCHAR(1),    
                @tVamt   NUMERIC(17,2)    
AS    
  IF @flag = 1    
    BEGIN    
      SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED    
          
      SELECT   ISNULL(SUM(VAMT),0),    
               DRCR    
      FROM     LEDGER WITH (nolock)    
      WHERE    CLTCODE = @code    
               AND VDT <= @gdate    
      GROUP BY DRCR    
      ORDER BY DRCR    
    END    
        
  IF @flag = 2    
    BEGIN    
      IF @tvamt = 0    
        BEGIN    
          SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED    
              
          SELECT   TDATE = CONVERT(VARCHAR,L.VDT,103),    
                   CLTCODE = ISNULL(CLTCODE,''),    
                   ACNAME = ISNULL(ACNAME,''),    
                   VNO = L.VNO,    
                   DRCR = L.DRCR,    
                   LNO = L.LNO,    
                   VTYP = L.VTYP,    
                   CHEQUENO = ISNULL(DDNO,''), /*refno= l.refno ,*/    
                   AMT = L.VAMT,    
                   RELDT = CONVERT(VARCHAR,LL1.RELDT,103),    
                   BOOKTYPE = L.BOOKTYPE    
          FROM     LEDGER L WITH (nolock),    
                   LEDGER1 LL1 WITH (nolock)    
          WHERE    L.VTYP IN ('2','3','5','16',    
                              '17','19','20')    
                   AND CLTCODE <> @code    
                   /*AND SUBSTRING(LL1.REFNO,1,12)=SUBSTRING(L.REFNO,1,12)  and */    
                   AND LL1.VNO = L.VNO    
                   AND LL1.VTYP = L.VTYP    
                   AND LL1.BOOKTYPE = L.BOOKTYPE    
                   AND LL1.LNO = L.LNO    
                   AND LL1.DRCR = L.DRCR    
                   AND L.VNO IN (SELECT VNO    
                                 FROM   LEDGER L1 WITH (nolock)    
                                 WHERE  CLTCODE = @code    
                                        AND L.VTYP = L1.VTYP    
                                        AND BOOKTYPE = L1.BOOKTYPE)    
                   AND LL1.RELDT <> '1900-01-01 00:00:00.000'    
                   AND VDT >= @frmdate    
                   AND VDT < = @gdate    
                   AND L.DRCR LIKE @gdrcr    
          ORDER BY CONVERT(VARCHAR,L.VDT,101),    
                   L.VTYP,    
                   L.VNO,    
                   L.DRCR    
        END    
            
      IF @tvamt <> 0    
        BEGIN    
          SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED    
              
          SELECT   TDATE = CONVERT(VARCHAR,L.VDT,103),    
                   CLTCODE = ISNULL(CLTCODE,''),    
                   ACNAME = ISNULL(ACNAME,''),    
                   VNO = L.VNO,    
                   DRCR = L.DRCR,    
                   LNO = L.LNO,    
                   VTYP = L.VTYP,    
                   CHEQUENO = ISNULL(DDNO,''),/* refno= l.refno ,*/    
                   AMT = L.VAMT,    
                   RELDT = CONVERT(VARCHAR,LL1.RELDT,103)    
          FROM     LEDGER L WITH (nolock),    
                   LEDGER1 LL1 WITH (nolock)    
          WHERE    L.VTYP IN ('2','3','5','16',    
                              '17','19','20')    
                   AND CLTCODE <> @code    
                   AND LL1.VNO = L.VNO    
                   AND LL1.VTYP = L.VTYP    
                   AND LL1.LNO = L.LNO    
                   AND LL1.DRCR = L.DRCR    
                   AND /*AND SUBSTRING(LL1.REFNO,1,12)=SUBSTRING(L.REFNO,1,12)  and */    
                       L.VNO IN (SELECT VNO    
                                 FROM   LEDGER L1 WITH (nolock)    
                                 WHERE  CLTCODE = @code    
                                        AND L.VTYP = L1.VTYP)    
                   AND LL1.RELDT <> '1900-01-01 00:00:00.000'    
                   AND VDT >= @frmdate    
                   AND VDT < = @gdate    
                   AND L.DRCR LIKE @gdrcr    
                   AND VAMT = @tVamt    
          ORDER BY CONVERT(VARCHAR,L.VDT,101),    
                   L.VTYP,    
                   L.VNO,    
                   L.DRCR    
        END    
    END    
      
  IF @flag = 3    
    BEGIN    
      SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED    
          
      SELECT   L.DRCR,    
               SUM(VAMT)    
      FROM     LEDGER L WITH(nolock),    
               LEDGER1 L1 WITH(nolock)    
      WHERE    L.VTYP = L1.VTYP    
               AND L.BOOKTYPE = L1.BOOKTYPE    
               AND L.VNO = L1.VNO    
               AND VDT <= @gdate + ' 23:59:59'    
               AND (L1.RELDT = '1900-01-01 00:00:00.000'    
                     OR L1.RELDT > @gdate + ' 23:59:59')    
               AND CLTCODE = @CODE    
      GROUP BY L.DRCR    
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EDTYEAREND
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.EDTYEAREND    SCRIPT DATE: 05/10/2004 5:29:33 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.EDTYEAREND    SCRIPT DATE: 02/18/2003 10:26:56 AM ******/
CREATE PROCEDURE  EDTYEAREND
@SDTCUR VARCHAR(11),
@LDTCUR VARCHAR(11),
@VTYP   SMALLINT,
@VNO VARCHAR(12),
@BOOKTYPE CHAR(2),
@VDT    DATETIME,
@MSG1   VARCHAR(234)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE
@@NETDIFF AS MONEY


TRUNCATE TABLE EDTCLBAL

INSERT INTO EDTCLBAL
SELECT L.CLTCODE,L.ACNAME , BALANCE=ISNULL(SUM( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)
FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE
WHERE L.EDT > = @SDTCUR + ' 00:00:00' AND L.EDT <= @LDTCUR + ' 23:59:59'
AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%') AND L.CLTCODE <> '999999'
GROUP BY L.CLTCODE,L.ACNAME
ORDER BY L.CLTCODE,L.ACNAME

UPDATE LEDGER SET BALAMT = E.BALANCE FROM EDTCLBAL E
WHERE LEDGER.VTYP = @VTYP AND LEDGER.BOOKTYPE = @BOOKTYPE AND LEDGER.VNO = @VNO AND LEDGER.CLTCODE = E.CLTCODE

SELECT @@NETDIFF = ( SELECT SUM(BALANCE) FROM EDTCLBAL )

UPDATE LEDGER SET BALAMT = ISNULL( CASE WHEN @@NETDIFF > = 0 THEN -(@@NETDIFF) ELSE ABS(@@NETDIFF) END,0)
WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO AND CLTCODE = '999999'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FETCH_GST_INVOICE_ACCOUNT
-- --------------------------------------------------


CREATE PROC [dbo].[FETCH_GST_INVOICE_ACCOUNT]
(
	@FORTHEDAY	VARCHAR(11),
	@EXCHANGE	VARCHAR(3),
	@SEGMENT	VARCHAR(7)
)
AS


SELECT DISTINCT VNO, VTYP, BOOKTYPE, VDT=CONVERT(DATETIME,LEFT(VDT,11)), FLAG = (CASE WHEN DRCR = 'C' THEN 'DEBIT' ELSE 'CREDIT' END)
INTO #GSTLED FROM LEDGER L 
WHERE VDT BETWEEN @FORTHEDAY AND @FORTHEDAY + ' 23:59:59'
AND CLTCODE IN (SELECT ACCODE FROM MSAJAG..VALANACCOUNT WHERE ACNAME LIKE '%GST%')
AND VNO IN (SELECT VNO FROM LEDGER G
			WHERE VDT BETWEEN @FORTHEDAY AND @FORTHEDAY + ' 23:59:59'
			AND L.VNO = G.VNO 
			AND L.Vtyp = G.Vtyp
			AND L.Booktype = G.Booktype
			AND EXISTS (SELECT CLTCODE FROM ACMAST A WHERE A.CLTCODE = G.CLTCODE AND ACCAT = 4) )
AND VTYP NOT IN ('15', '21')

SELECT G.VNO, G.VTYP, G.BOOKTYPE, G.VDT, G.FLAG, L.CLTCODE, VAMT, L.NARRATION, ACTYPE=0
INTO #GSTLED_TEMP
FROM LEDGER L, #GSTLED G
WHERE L.VDT BETWEEN @FORTHEDAY AND @FORTHEDAY + ' 23:59:59'
		AND L.VNO = G.VNO 
		AND L.Vtyp = G.Vtyp
		AND L.Booktype = G.Booktype

UPDATE #GSTLED_TEMP SET ACTYPE = 2
WHERE EXISTS  (SELECT CLTCODE FROM ACMAST A WHERE A.CLTCODE = #GSTLED_TEMP.CLTCODE AND ACCAT = 4)

UPDATE #GSTLED_TEMP SET ACTYPE = 1
WHERE EXISTS  (SELECT ACCODE FROM MSAJAG..VALANACCOUNT WHERE ACCODE = CLTCODE AND ACNAME LIKE '%GST%')

SELECT G.VNO, G.VTYP, G.BOOKTYPE, G.VDT, G.FLAG, 
CLTCODE = MAX(CASE WHEN ACTYPE = 2 THEN CLTCODE ELSE '' END),
GLCODE = MAX(CASE WHEN ACTYPE = 0 THEN CLTCODE ELSE '' END),
TAXABLE_AMT = SUM(CASE WHEN ACTYPE = 0 THEN VAMT ELSE 0 END),
TAX_AMT = SUM(CASE WHEN ACTYPE = 1 THEN VAMT ELSE 0 END),
Narration = CONVERT(VARCHAR(500),'')
INTO #GSTACCFINAL
FROM #GSTLED_TEMP G
GROUP BY G.VNO, G.VTYP, G.BOOKTYPE, G.VDT, G.FLAG

SELECT      DISTINCT
         G.VNO, G.VTYP, G.BOOKTYPE, G.VDT,

         STUFF(
               (SELECT      ',' + G1.Narration
               FROM      #GSTLED_TEMP AS G1
               WHERE      G1.VNO = G.VNO
			   AND        G1.VTYP = G.VTYP
			   AND        G1.BOOKTYPE = G.BOOKTYPE
			   AND ACTYPE = 2
               FOR XML PATH('')), 1, 1, '') AS Narration
INTO #NARR
FROM      #GSTLED_TEMP G WHERE ACTYPE = 2
ORDER BY   G.VNO, G.VTYP, G.BOOKTYPE, G.VDT 

UPDATE #GSTACCFINAL SET Narration = G.Narration
FROM #NARR G
WHERE #GSTACCFINAL.VNO = G.VNO
AND        #GSTACCFINAL.VTYP = G.VTYP
AND        #GSTACCFINAL.BOOKTYPE = G.BOOKTYPE

SELECT INVOICE_DATE = VDT, EXCHANGE = @EXCHANGE, SEGMENT = @SEGMENT, RECORDFOR = 'LEDGER',
SUBRECORDFOR=GLCODE, INV_DESC=NARRATION, SETT_NO = '', SETT_TYPE = '',
PARTY_CODE = CLTCODE, CONTRACTNO = '', INT_REF_NO = @EXCHANGE + '_' + @SEGMENT + '_' + VNO + '_' + CONVERT(VARCHAR,VTYP) + '_' + CONVERT(VARCHAR,BOOKTYPE), 
TAXABLE_AMT, TAX_AMT, INVOICE_TYPE = FLAG, INVOICE_SUBTYPE = '', INVOICE_CATEGORY = '', REV_INT_REF_NO = '',
LOCATION_CODE = '', SOURCESTATE = '', TARGETSTATE = '', STATE_CODE = '', INV_NO = '', SACCODE = '', SAC_DESC = '',
BRANCH_CODE = CONVERT(VARCHAR(10),''),
IGST_RATE = CONVERT(NUMERIC(18,4),0),
IGST_AMOUNT = CONVERT(NUMERIC(18,4),0),
CGST_RATE = CONVERT(NUMERIC(18,4),0),
CGST_AMOUNT = CONVERT(NUMERIC(18,4),0),
SGST_RATE = CONVERT(NUMERIC(18,4),0),
SGST_AMOUNT = CONVERT(NUMERIC(18,4),0)
FROM #GSTACCFINAL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FODAILYACCREALISED
-- --------------------------------------------------


CREATE  PROC FODAILYACCREALISED
@SDATE VARCHAR(11),
@PARTY VARCHAR(10)
AS
SELECT LEFT(CONVERT(VARCHAR,VDT,109),11)AS VDT,CONVERT(VARCHAR,EDT,105)AS CDT,CLTCODE,VNO,
NARR=ISNULL(L.NARRATION,''),
/*ISNULL((CASE WHEN (SELECT NARR FROM LEDGER3 L3
     WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = L.LNO AND L3.BOOKTYPE = L.BOOKTYPE) IS NOT NULL 
     THEN (SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = L.LNO AND L3.BOOKTYPE = L.BOOKTYPE)
     ELSE (SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.BOOKTYPE = L.BOOKTYPE) END ),''),*/
VTYPE=SHORTDESC,CHQNO=0,VAMT,DRCR
FROM LEDGER L, VMAST V   WHERE CLTCODE = @PARTY AND L.VTYP NOT IN (15 )
AND VDT >= @SDATE  AND VDT < @SDATE + ' 23:59:59'  AND L.VTYP = V.VTYPE 
AND EDT >=   @SDATE  AND EDT  < = @SDATE + ' 23:59:59'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FODAILYACCUNREALISED
-- --------------------------------------------------


CREATE PROC FODAILYACCUNREALISED
@SDATE VARCHAR(11),
@PARTY VARCHAR(10)

AS

SELECT LEFT(CONVERT(VARCHAR,VDT,109),11)AS VDT,LEFT(CONVERT(VARCHAR,EDT,109),11)AS CDT,CLTCODE,VNO,
NARR=ISNULL((CASE WHEN (SELECT NARR FROM LEDGER3 L3
     WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = L.LNO AND L3.BOOKTYPE = L.BOOKTYPE) IS NOT NULL 
     THEN (SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = L.LNO AND L3.BOOKTYPE = L.BOOKTYPE)
     ELSE (SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.BOOKTYPE = L.BOOKTYPE) END ),''),
VTYPE=SHORTDESC,CHQNO=0,VAMT,DRCR
FROM LEDGER L, VMAST V   WHERE CLTCODE = @PARTY  AND L.VTYP NOT IN (15)
AND VDT >= @SDATE  AND VDT < @SDATE + ' 23:59:00'  AND L.VTYP = V.VTYPE 
AND EDT  > @SDATE + ' 23:59:00'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOMARGIN_PENALTY_POST
-- --------------------------------------------------



CREATE PROC [dbo].[FOMARGIN_PENALTY_POST]    
(              
  @UNAME VARCHAR(25),                
  @VTYP SMALLINT,                
  @BOOKTYPE VARCHAR(2),              
  @TRADEDATE VARCHAR(11),              
  @GLCODE VARCHAR(10),              
   @LEDGERVNO VARCHAR(12),  
  @LEDGERDATE VARCHAR(11)  
)  
AS                
            

 SET NOCOUNT ON                

 DECLARE                
  @@ERROR_COUNT AS INT,          
  @SERTAX_GLCODE AS VARCHAR(20),        
  @CESSTAX_GLCODE AS VARCHAR(20),        
  @EDUCESSTAX_GLCODE AS VARCHAR(20),        
  @SBCCHARG_GLCODE AS VARCHAR(20),
  @SERTAXPER AS NUMERIC(18,4),        
  @CESSTAXPER AS NUMERIC(18,4),        
  @EDUCESSTAXPER AS NUMERIC(18,4),
  @SBCCHRGPER AS NUMERIC(18,4)             

      
 CREATE TABLE [#RECPAY_TABLE]                
 (                
   SRNO INT,                
   VVDT VARCHAR(10),                
   EEDT VARCHAR(10),                
   CLTCODE VARCHAR(10),                
   DRCR VARCHAR(1),                
   AMOUNT MONEY,                
   NARRATION VARCHAR(500),                
   SNO INT IDENTITY (1, 1) NOT NULL ,                
   VDT DATETIME NULL ,                
   UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),                
   EDT DATETIME NULL ,                
   VNO VARCHAR (12)  NULL ,                
   ACNAME VARCHAR (100)  NULL ,                
   FYSTART DATETIME NULL,                
   FYEND DATETIME NULL,                
   COSTCODE SMALLINT NULL,                
   LNO SMALLINT NOT NULL DEFAULT(0)                
 ) ON [PRIMARY]                

                
 CREATE TABLE [#RECPAY_TABLE_LNO]                
 (                
  SNO INT ,                
  LNO INT IDENTITY (1, 1) NOT NULL                
 ) ON [PRIMARY]                

                

      

 DECLARE            

  @TRDATE  VARCHAR(10),          

  @EDATE VARCHAR(10)   

    

SELECT @TRDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@LEDGERDATE),103)          
SELECT @EDATE =  CONVERT(VARCHAR,CONVERT(DATETIME,@LEDGERDATE),103)  

  

SELECT @SERTAX_GLCODE = ISNULL(ACCODE,'')        
FROM MCDXCDS.DBO.VALANACCOUNT (NOLOCK) WHERE ACNAME = 'SERVICE TAX F&O MARGIN'          

        

SELECT @CESSTAX_GLCODE = ISNULL(ACCODE,'')        
FROM MCDXCDS.DBO.VALANACCOUNT (NOLOCK) WHERE ACNAME = 'EDUCATION CESS F&O MARGIN'          

        

SELECT @EDUCESSTAX_GLCODE = ISNULL(ACCODE,'')        
FROM MCDXCDS.DBO.VALANACCOUNT (NOLOCK) WHERE ACNAME = 'SHE F&O MARGIN'    


SELECT @SBCCHARG_GLCODE = ISNULL(ACCODE,'')        
FROM MCDXCDS.DBO.VALANACCOUNT (NOLOCK) WHERE ACNAME = 'SBC F&O MARGIN'    

SELECT         
 @SERTAXPER = SERVICE_TAX * 100 / (100 + EDUCESS_TAX + CESS_TAX + SBCCHARGE),        
 @CESSTAXPER = CESS_TAX,        
 @EDUCESSTAXPER = EDUCESS_TAX,
 @SBCCHRGPER = SBCCHARGE
FROM         

 MCDXCDS..FOGLOBALS (NOLOCK)        

WHERE         

 getdate() BETWEEN YEAR_START_DT AND YEAR_END_DT  





/*======================== MARGIN PENALTY PLUG IN  ============================================*/  

     

    

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)          

SELECT       

 1,PARTY_CODE ,      

 @TRDATE, @EDATE,'D',      

 AMT = (
 CASE 
	WHEN (@EDUCESSTAXPER+@CESSTAXPER+@SBCCHRGPER) > 0 
	THEN ROUND(PENALTY_AMT,2) + ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@CESSTAXPER),2)),2)+ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@EDUCESSTAXPER),2)),2)+ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@SBCCHRGPER),2)),2)),2)+ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@CESSTAXPER),2)),2)+ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@EDUCESSTAXPER),2)),2)+ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@SBCCHRGPER),2)),2)
 END),
 NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE     

FROM       

 MCDXCDS.DBO.FOMARGIN_PENALTY(NOLOCK)     

WHERE   

 MARGIN_DATE =  @TRADEDATE     

 AND LEDGER_POST_FLAG = 99  

          

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)          

SELECT       

 1,@GLCODE ,      

 @TRDATE, @EDATE,'C',      

 AMT = SUM(ISNULL(PENALTY_AMT, 0)),      

 NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE  

FROM       

 MCDXCDS.DBO.FOMARGIN_PENALTY(NOLOCK)  

WHERE   

 MARGIN_DATE =  @TRADEDATE     

 AND LEDGER_POST_FLAG = 99  

  

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)          

SELECT       

 1,@SERTAX_GLCODE ,      

 @TRDATE, @EDATE,'C',      

 AMT = (case when (@EDUCESSTAXPER+@CESSTAXPER+@SBCCHRGPER) > 0 Then SUM(ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@CESSTAXPER),2)),2)+ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@EDUCESSTAXPER),2)),2)+ROUND(ROUND((ISNULL(PENALTY_AMT,0)), 2) - (ROUND((ISNULL(PENALTY_AMT,0))*100/(100+@SBCCHRGPER),2)),2)),2))
 else sum(ISNULL(SERVICE_TAX,0)) end),        

 NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE  

FROM       

 MCDXCDS.DBO.FOMARGIN_PENALTY(NOLOCK)     

WHERE   

 MARGIN_DATE =  @TRADEDATE     

 AND LEDGER_POST_FLAG = 99  

 

 INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)                

SELECT             

 1,@CESSTAX_GLCODE ,            

 @TRDATE, @EDATE,'C',            

 AMT = sum(ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@CESSTAXPER),2)),2)) ,            

 NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE        

FROM             

 MCDXCDS.DBO.FOMARGIN_PENALTY(NOLOCK)           

WHERE         

 MARGIN_DATE =  @TRADEDATE           

 AND LEDGER_POST_FLAG = 99        
 and (@EDUCESSTAXPER+@CESSTAXPER) > 0
        

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)                

SELECT             

 1,@EDUCESSTAX_GLCODE ,            

 @TRDATE, @EDATE,'C',            

 AMT = sum(ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@EDUCESSTAXPER),2)),2)) ,            

 NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE        

FROM             

 MCDXCDS.DBO.FOMARGIN_PENALTY(NOLOCK)           

WHERE         

 MARGIN_DATE =  @TRADEDATE           

 AND LEDGER_POST_FLAG = 99   
 and (@EDUCESSTAXPER+@CESSTAXPER) > 0
 

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)                
SELECT             
 1,@SBCCHARG_GLCODE ,            
 @TRDATE, @EDATE,'C',            
 AMT = sum(ROUND((ISNULL(PENALTY_AMT,0))-(ROUND((ISNULL(PENALTY_AMT,0))*100/(100+@SBCCHRGPER),2)),2)) ,            
 NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE        
FROM             
 MCDXCDS.DBO.FOMARGIN_PENALTY(NOLOCK)           
WHERE         
 MARGIN_DATE =  @TRADEDATE           
 AND LEDGER_POST_FLAG = 99   
 and (@SBCCHRGPER) <> 0
 

            

DELETE FROM #RECPAY_TABLE WHERE ISNULL(AMOUNT, 0) = 0  

/*=============================================================================================*/ 



DECLARE                

  @@NEWVNO AS VARCHAR(12),                

  @@VDT AS VARCHAR(11),                

  @@LNOCUR AS CURSOR,                

  @@LNOVNO AS INT,         

  @@NOREC AS INT                



SELECT TOP 1                

  @@VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)), 109)

 FROM                

  #RECPAY_TABLE  -------ADDED BY YOGESH         

  

  UPDATE                

   #RECPAY_TABLE                

 SET   

    VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),                

    EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),                

    FYSTART = P.SDTCUR,                

    FYEND = P.LDTCUR,                

    UPDFLAG = 'Y',                

    ACNAME = LONGNAME,                

    COSTCODE = 0  

    FROM ACMAST A, PARAMETER P  , COSTMAST C                

    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE                

    --AND P.CURYEAR = 1     

    AND @@VDT BETWEEN  P.SDTCUR AND P.LDTCUR ---- ADDED BY YOGESH          

    AND A.ACCAT IN ('3','4','104')                

    AND A.BRANCHCODE = C.COSTNAME                

    AND A.BRANCHCODE <> 'ALL'   

                

   UPDATE              

   #RECPAY_TABLE                

   SET                

    VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),                

    EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),                

    FYSTART = P.SDTCUR,                

    FYEND = P.LDTCUR,                

    UPDFLAG = 'Y',                

    ACNAME = LONGNAME,                

    COSTCODE = (SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  

    FROM ACMAST A, PARAMETER P                

    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE                

    --AND P.CURYEAR = 1 

    AND @@VDT BETWEEN  P.SDTCUR AND P.LDTCUR ---- ADDED BY YOGESH                

    AND A.ACCAT IN ('3','4','104')       

    AND A.BRANCHCODE = 'ALL'                

               

/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/                

                

 DECLARE                

  @@STD_DATE VARCHAR(11),                

  @@LST_DATE VARCHAR(11),                

  @@VNOMETHOD INT,                

  @@ACNAME CHAR(100),                

  @@MICRNO VARCHAR(10),                

  @@DRCR VARCHAR(1)                

                

                

/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/                

  

 SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND                

 IF @@ERROR_COUNT > 0                

  BEGIN  

   RAISERROR('DATE MISMATCH', 16, 1)      

   DROP TABLE #RECPAY_TABLE                

                   

   RETURN                

  END                

                

             

/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/                

                

 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)                

 GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1                

 IF @@ERROR_COUNT > 0                

  BEGIN       

     RAISERROR('SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 16, 1)      

   DROP TABLE #RECPAY_TABLE                

                   

   RETURN                

  END                

                

          

          

/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/               

    /*            

 SELECT @@ERROR_COUNT = COUNT(1) FROM                

  (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)                

  FROM #RECPAY_TABLE                

  GROUP BY SRNO                

  HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A                

 IF @@ERROR_COUNT > 0                

  BEGIN          

    RAISERROR('DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS', 16, 1)            

   DROP TABLE #RECPAY_TABLE                

             

   RETURN                

  END                

   */             

/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/                

                

 SELECT @@ERROR_COUNT = COUNT(1) FROM                

 (   

  SELECT DISTINCT                

   CLTCODE                

  FROM #RECPAY_TABLE             

  WHERE UPDFLAG = 'N'                

 ) A                

         

 IF @@ERROR_COUNT > 0                

  BEGIN                

   SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL                

   SELECT DISTINCT                

    CLTCODE                

   FROM #RECPAY_TABLE                

   WHERE UPDFLAG = 'N'                

   DROP TABLE #RECPAY_TABLE                

                   

   RETURN                

  END                

                

                

IF @LEDGERVNO = ''  

BEGIN  

/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/                

 DECLARE                

  @@MAXVNO AS VARCHAR(12),                

  @@VNO AS VARCHAR(12),                

  @@RCOUNT AS INT                

 SELECT TOP 1                

  @@VDT = CONVERT(VARCHAR(11), VDT, 109)                

 FROM                

  #RECPAY_TABLE                

                

 SELECT TOP 1                

  @@VNOMETHOD = VNOFLAG,                

  @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                

  @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)                

 FROM                

  PARAMETER             

 WHERE                

  @@VDT BETWEEN SDTCUR AND LDTCUR                

                

                 

SELECT                

  @@NOREC = COUNT(DISTINCT SRNO)                

 FROM                

  #RECPAY_TABLE                

                

 CREATE TABLE #VNO  

 (  

 LASTVNO VARCHAR(12)  

 )             

  

 INSERT INTO #VNO  

 EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC  

  

 SELECT @@VNO = LASTVNO FROM #VNO  

       

 UPDATE                

  #RECPAY_TABLE                

 SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)    

END  

ELSE  

BEGIN    

 SELECT @@VNO = @LEDGERVNO    

  

 SELECT TOP 1                  

  @@VDT = CONVERT(VARCHAR(11), VDT, 109)                  

 FROM                  

  #RECPAY_TABLE                  

  

 UPDATE                  

 #RECPAY_TABLE                  

 SET VNO = @LEDGERVNO    

END                      

                

/* '--------------------------AUTO GENERATION OF LNO ------------------------*/                

                

 SET @@LNOCUR = CURSOR FOR                

  SELECT DISTINCT SRNO FROM #RECPAY_TABLE                

 OPEN @@LNOCUR                

  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO                

 WHILE @@FETCH_STATUS = 0                

  BEGIN                

   INSERT INTO #RECPAY_TABLE_LNO                

    (SNO)                

   SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO                

   UPDATE RP                

    SET LNO = RL.LNO                

   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL                

   WHERE RP.SNO = RL.SNO                

   TRUNCATE TABLE #RECPAY_TABLE_LNO   

   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO                

  END               

 CLOSE @@LNOCUR                

 DEALLOCATE @@LNOCUR                

 DROP TABLE #RECPAY_TABLE_LNO                

                

/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/                

/*==============================          LEDGER RECORD                

==============================*/                

 INSERT                

 INTO LEDGER                

 SELECT        

  VTYP = @VTYP,                

  VNO,                

  EDT,                

  LNO,                

  ACNAME,                

  DRCR,                

  VAMT = AMOUNT,                

  VDT,                

  VNO1 = VNO,                

  REFNO = 0,                

  BALAMT = AMOUNT,                

  NODAYS = 0,                

  CDT = GETDATE(),                

  CLTCODE,                

  BOOKTYPE = @BOOKTYPE,                

  ENTEREDBY = @UNAME,                

  PDT = GETDATE(),                

  CHECKEDBY = @UNAME,                

  ACTNODAYS = 0,                

  NARRATION                

 FROM                

  #RECPAY_TABLE      

    

                

/*==============================                

 LEDGER3 RECORD                

==============================*/                

 INSERT                

 INTO LEDGER3                

 SELECT                

  NARATNO = LNO,                

  NARRATION,                

  REFNO = 0,                

  VTYP = @VTYP,                

  VNO,                

  BOOKTYPE = @BOOKTYPE                

  FROM    

  #RECPAY_TABLE     

    

 DELETE FROM TEMPLEDGER2 WHERE SESSIONID = '9999999999'  

   

 INSERT INTO TEMPLEDGER2  

 SELECT  

  'BRANCH',  

  C.COSTNAME,  

  AMOUNT,  

  VTYP = @VTYP,  

  VNO,  

  LNO,  

  DRCR,  

  '0',  

  BOOKTYPE = @BOOKTYPE,  

  SESSIONID = '9999999999',  

  CLIENT_CODE = CLTCODE,  

  'A',  

  '0'  

 FROM  

  #RECPAY_TABLE RP,  

  COSTMAST C  

 WHERE  

  RP.COSTCODE = C.COSTCODE  

  

 DECLARE @@L2CUR AS CURSOR,  

  @@L2VNO AS VARCHAR(12)  

    

 SET @@L2CUR = CURSOR FOR  

 SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO  

 OPEN @@L2CUR  

 FETCH NEXT FROM @@L2CUR INTO @@L2VNO  

 WHILE @@FETCH_STATUS = 0  

 BEGIN  

  EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'  

  FETCH NEXT FROM @@L2CUR INTO @@L2VNO  

 END  

 DELETE FROM TEMPLEDGER2 WHERE SESSIONID = '9999999999'  

   

 CLOSE @@L2CUR  

 DEALLOCATE @@L2CUR  

          

/*=========================  MARGIN SHORTAGE PENALTY PLUG IN ==========================*/          

UPDATE MCDXCDS.DBO.FOMARGIN_PENALTY  

SET LEDGER_POST_FLAG = 1  

WHERE   

 MARGIN_DATE =  @TRADEDATE     

 AND LEDGER_POST_FLAG = 99  

   

UPDATE MCDXCDS.DBO.FOMARGIN_PENALTY_POST_STAT  

SET POST_FLAG = 1,LEDGER_VNO=@@VNO, LEDGER_VDT = @@VDT  

WHERE   

 MARGIN_DATE =  @TRADEDATE     

/*============================== MARGIN SHORTAGE PENALTY PLUG IN  =====================*/              

           

 DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOMARGIN_PENALTY_POST_BAKDEC212015
-- --------------------------------------------------
CREATE PROC [dbo].[FOMARGIN_PENALTY_POST]        
(                  
  @UNAME VARCHAR(25),                    
  @VTYP SMALLINT,                    
  @BOOKTYPE VARCHAR(2),                  
  @TRADEDATE VARCHAR(11),                  
  @GLCODE VARCHAR(10),                  
       @LEDGERVNO VARCHAR(12),      
  @LEDGERDATE VARCHAR(11)      
)      
AS                    
                   
 SET NOCOUNT ON                    
              
              
 DECLARE                    
  @@ERROR_COUNT AS INT                  
          
           
 CREATE TABLE [#RECPAY_TABLE]                    
 (                    
   SRNO INT,                    
   VVDT VARCHAR(10),                    
   EEDT VARCHAR(10),                    
   CLTCODE VARCHAR(10),                    
   DRCR VARCHAR(1),                    
   AMOUNT MONEY,                    
   NARRATION VARCHAR(500),                    
   SNO INT IDENTITY (1, 1) NOT NULL ,                    
   VDT DATETIME NULL ,                    
   UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),                    
   EDT DATETIME NULL ,                    
   VNO VARCHAR (12)  NULL ,                    
   ACNAME VARCHAR (100)  NULL ,                    
   FYSTART DATETIME NULL,                    
   FYEND DATETIME NULL,                    
   COSTCODE SMALLINT NULL,                    
   LNO SMALLINT NOT NULL DEFAULT(0)                    
 ) ON [PRIMARY]                    
                    
 CREATE TABLE [#RECPAY_TABLE_LNO]                    
 (                    
  SNO INT ,                    
  LNO INT IDENTITY (1, 1) NOT NULL                    
 ) ON [PRIMARY]                    
                    
          
 DECLARE                
  @TRDATE  VARCHAR(10),              
  @EDATE VARCHAR(10)       
        
SELECT @TRDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@LEDGERDATE),103)              
SELECT @EDATE =  CONVERT(VARCHAR,CONVERT(DATETIME,@LEDGERDATE),103)              
                 
/*======================== MARGIN PENALTY PLUG IN  ============================================*/      
         
        
INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)              
SELECT           
 1,PARTY_CODE ,          
 @TRDATE, @EDATE,'D',          
 AMT = PENALTY_AMT,          
 NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE         
FROM           
 MCDXCDS.DBO.FOMARGIN_PENALTY(NOLOCK)         
WHERE       
 MARGIN_DATE =  @TRADEDATE         
 AND LEDGER_POST_FLAG = 99      
              
INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)              
SELECT           
 1,@GLCODE ,          
 @TRDATE, @EDATE,'C',          
 AMT = SUM(PENALTY_AMT),          
 NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE      
FROM           
 MCDXCDS.DBO.FOMARGIN_PENALTY(NOLOCK)         
WHERE       
 MARGIN_DATE =  @TRADEDATE         
 AND LEDGER_POST_FLAG = 99      
                
/*=============================================================================================*/              
                
  UPDATE                    
   #RECPAY_TABLE                    
 SET       
    VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),                    
    EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),                    
    FYSTART = P.SDTCUR,                    
    FYEND = P.LDTCUR,                    
    UPDFLAG = 'Y',                    
    ACNAME = LONGNAME,                    
    COSTCODE=C.COSTCODE      
    FROM ACMAST A, PARAMETER P              
 , COSTMAST C                    
    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE                    
    AND P.CURYEAR = 1                    
    AND A.ACCAT IN ('3','4','104')                    
    AND A.BRANCHCODE = C.COSTNAME                    
    AND A.BRANCHCODE <> 'ALL'              
                    
   UPDATE                    
   #RECPAY_TABLE                    
   SET                    
    VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),                    
    EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),                    
    FYSTART = P.SDTCUR,                    
    FYEND = P.LDTCUR,                    
    UPDFLAG = 'Y',                    
    ACNAME = LONGNAME,                    
    COSTCODE = (SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')      
    FROM ACMAST A, PARAMETER P                    
    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE                    
    AND P.CURYEAR = 1                    
    AND A.ACCAT IN ('3','4','104')           
    AND A.BRANCHCODE = 'ALL'                    
                   
/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/                    
                    
 DECLARE                    
  @@STD_DATE VARCHAR(11),                    
  @@LST_DATE VARCHAR(11),                    
  @@VNOMETHOD INT,                    
  @@ACNAME CHAR(100),                    
  @@MICRNO VARCHAR(10),                    
  @@DRCR VARCHAR(1)                    
                    
                    
/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/                    
                    
 SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND                    
                    
 IF @@ERROR_COUNT > 0                    
  BEGIN      
   RAISERROR('DATE MISMATCH', 16, 1)          
   DROP TABLE #RECPAY_TABLE                    
                       
   RETURN                    
  END                    
                    
                 
/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/                    
                    
 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)                    
 GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1                    
 IF @@ERROR_COUNT > 0                    
  BEGIN           
     RAISERROR('SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 16, 1)          
   DROP TABLE #RECPAY_TABLE                    
                       
   RETURN                    
  END                    
                    
              
              
/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/                   
                    
 SELECT @@ERROR_COUNT = COUNT(1) FROM                    
  (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)                    
  FROM #RECPAY_TABLE                    
  GROUP BY SRNO                    
  HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A                    
 IF @@ERROR_COUNT > 0                    
  BEGIN              
    RAISERROR('DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS', 16, 1)                
   DROP TABLE #RECPAY_TABLE                    
                 
   RETURN                    
  END                    
                    
/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/                    
                    
 SELECT @@ERROR_COUNT = COUNT(1) FROM                    
 (       
  SELECT DISTINCT                    
   CLTCODE                    
  FROM #RECPAY_TABLE                 
  WHERE UPDFLAG = 'N'                    
 ) A                    
             
 IF @@ERROR_COUNT > 0                    
  BEGIN                    
   SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL                    
   SELECT DISTINCT                    
    CLTCODE                    
   FROM #RECPAY_TABLE                    
   WHERE UPDFLAG = 'N'                    
   DROP TABLE #RECPAY_TABLE                    
                       
   RETURN                    
  END                    
                    
 DECLARE                    
  @@NEWVNO AS VARCHAR(12),                    
  @@VDT AS VARCHAR(11),                    
  @@LNOCUR AS CURSOR,                    
  @@LNOVNO AS INT,             
  @@NOREC AS INT                    
                    
IF @LEDGERVNO = ''      
BEGIN      
/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/                    
 DECLARE                    
  @@MAXVNO AS VARCHAR(12),                    
  @@VNO AS VARCHAR(12),       
  @@RCOUNT AS INT                    
 SELECT TOP 1                    
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)                    
 FROM                    
  #RECPAY_TABLE                    
                    
 SELECT TOP 1                    
  @@VNOMETHOD = VNOFLAG,                    
  @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                    
  @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)                    
 FROM                    
  PARAMETER                    
 WHERE                    
  @@VDT BETWEEN SDTCUR AND LDTCUR                    
                    
                     
SELECT                    
  @@NOREC = COUNT(DISTINCT SRNO)                    
 FROM                    
  #RECPAY_TABLE                    
                    
 CREATE TABLE #VNO      
 (      
 LASTVNO VARCHAR(12)      
 )                 
      
 INSERT INTO #VNO      
 EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC      
      
 SELECT @@VNO = LASTVNO FROM #VNO      
           
 UPDATE                    
  #RECPAY_TABLE                    
 SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)        
END      
ELSE      
BEGIN        
 SELECT @@VNO = @LEDGERVNO        
      
 SELECT TOP 1                      
  @@VDT = CONVERT(VARCHAR(11), VDT, 109)                      
 FROM                      
  #RECPAY_TABLE                      
      
 UPDATE                      
 #RECPAY_TABLE                      
 SET VNO = @LEDGERVNO        
END                          
                    
/* '--------------------------AUTO GENERATION OF LNO ------------------------*/                    
                    
 SET @@LNOCUR = CURSOR FOR                    
  SELECT DISTINCT SRNO FROM #RECPAY_TABLE                    
 OPEN @@LNOCUR                    
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO                    
 WHILE @@FETCH_STATUS = 0                    
  BEGIN                    
   INSERT INTO #RECPAY_TABLE_LNO                    
    (SNO)                    
   SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO                    
   UPDATE RP                    
    SET LNO = RL.LNO                    
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL                    
   WHERE RP.SNO = RL.SNO                    
   TRUNCATE TABLE #RECPAY_TABLE_LNO       
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO                    
  END                   
 CLOSE @@LNOCUR                    
 DEALLOCATE @@LNOCUR                    
 DROP TABLE #RECPAY_TABLE_LNO                    
                
  
  
      
/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/                    
/*==============================          LEDGER RECORD                    
==============================*/                    
 INSERT                    
 INTO LEDGER                    
 SELECT            
  VTYP = @VTYP,                    
  VNO,                    
  EDT,                    
  LNO,                    
  ACNAME,                    
  DRCR,                    
  VAMT = AMOUNT,                    
  VDT,                    
  VNO1 = VNO,                    
  REFNO = 0,                    
  BALAMT = AMOUNT,                    
  NODAYS = 0,                    
  CDT = GETDATE(),                    
  CLTCODE,                    
  BOOKTYPE = @BOOKTYPE,                    
  ENTEREDBY = @UNAME,                    
  PDT = GETDATE(),                    
  CHECKEDBY = @UNAME,                    
  ACTNODAYS = 0,                    
  NARRATION                    
 FROM                    
  #RECPAY_TABLE                      
                 
/*==============================                    
 LEDGER3 RECORD                    
==============================*/                    
 INSERT                    
 INTO LEDGER3                    
 SELECT                    
  NARATNO = LNO,                    
  NARRATION,                    
  REFNO = 0,                    
  VTYP = @VTYP,                    
  VNO,                    
  BOOKTYPE = @BOOKTYPE                    
  FROM        
  #RECPAY_TABLE         
        
 DELETE FROM TEMPLEDGER2 WHERE SESSIONID = '9999999999'      
       
 INSERT INTO TEMPLEDGER2      
 SELECT      
  'BRANCH',      
  C.COSTNAME,      
  AMOUNT,      
  VTYP = @VTYP,      
 VNO,      
  LNO,      
  DRCR,      
  '0',      
  BOOKTYPE = @BOOKTYPE,      
  SESSIONID = '9999999999',      
  CLIENT_CODE = CLTCODE,      
  'A',      
  '0'      
 FROM      
  #RECPAY_TABLE RP,      
  COSTMAST C      
 WHERE      
  RP.COSTCODE = C.COSTCODE      
      
 DECLARE @@L2CUR AS CURSOR,      
  @@L2VNO AS VARCHAR(12)      
        
 SET @@L2CUR = CURSOR FOR      
 SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO      
 OPEN @@L2CUR      
 FETCH NEXT FROM @@L2CUR INTO @@L2VNO      
 WHILE @@FETCH_STATUS = 0      
 BEGIN      
  EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'      
  FETCH NEXT FROM @@L2CUR INTO @@L2VNO      
 END      
 DELETE FROM TEMPLEDGER2 WHERE SESSIONID = '9999999999'      
       
 CLOSE @@L2CUR      
 DEALLOCATE @@L2CUR      
              
/*=========================  MARGIN SHORTAGE PENALTY PLUG IN ==========================*/              
UPDATE MCDXCDS.DBO.FOMARGIN_PENALTY      
SET LEDGER_POST_FLAG = 1      
WHERE       
 MARGIN_DATE =  @TRADEDATE         
 AND LEDGER_POST_FLAG = 99      
       
UPDATE MCDXCDS.DBO.FOMARGIN_PENALTY_POST_STAT      
SET POST_FLAG = 1,LEDGER_VNO=@@VNO, LEDGER_VDT = @@VDT      
WHERE       
 MARGIN_DATE =  @TRADEDATE         
/*============================== MARGIN SHORTAGE PENALTY PLUG IN  =====================*/                  
               
 DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOMARGIN_PENALTY_POSTdec222015
-- --------------------------------------------------




CREATE PROC [dbo].[FOMARGIN_PENALTY_POST]    
(              
  @UNAME VARCHAR(25),                
  @VTYP SMALLINT,                
  @BOOKTYPE VARCHAR(2),              
  @TRADEDATE VARCHAR(11),              
  @GLCODE VARCHAR(10),              
   @LEDGERVNO VARCHAR(12),  
  @LEDGERDATE VARCHAR(11)  
)  
AS                
            

 SET NOCOUNT ON                

 DECLARE                
  @@ERROR_COUNT AS INT,          
  @SERTAX_GLCODE AS VARCHAR(20),        
  @CESSTAX_GLCODE AS VARCHAR(20),        
  @EDUCESSTAX_GLCODE AS VARCHAR(20),        
  @SBCCHARG_GLCODE AS VARCHAR(20),
  @SERTAXPER AS NUMERIC(18,4),        
  @CESSTAXPER AS NUMERIC(18,4),        
  @EDUCESSTAXPER AS NUMERIC(18,4),
  @SBCCHRGPER AS NUMERIC(18,4)             

      
 CREATE TABLE [#RECPAY_TABLE]                
 (                
   SRNO INT,                
   VVDT VARCHAR(10),                
   EEDT VARCHAR(10),                
   CLTCODE VARCHAR(10),                
   DRCR VARCHAR(1),                
   AMOUNT MONEY,                
   NARRATION VARCHAR(500),                
   SNO INT IDENTITY (1, 1) NOT NULL ,                
   VDT DATETIME NULL ,                
   UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),                
   EDT DATETIME NULL ,                
   VNO VARCHAR (12)  NULL ,                
   ACNAME VARCHAR (100)  NULL ,                
   FYSTART DATETIME NULL,                
   FYEND DATETIME NULL,                
   COSTCODE SMALLINT NULL,                
   LNO SMALLINT NOT NULL DEFAULT(0)                
 ) ON [PRIMARY]                

                
 CREATE TABLE [#RECPAY_TABLE_LNO]                
 (                
  SNO INT ,                
  LNO INT IDENTITY (1, 1) NOT NULL                
 ) ON [PRIMARY]                

                

      

 DECLARE            

  @TRDATE  VARCHAR(10),          

  @EDATE VARCHAR(10)   

    

SELECT @TRDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@LEDGERDATE),103)          
SELECT @EDATE =  CONVERT(VARCHAR,CONVERT(DATETIME,@LEDGERDATE),103)  

  

SELECT @SERTAX_GLCODE = ISNULL(ACCODE,'')        
FROM MCDXCDS.DBO.VALANACCOUNT (NOLOCK) WHERE ACNAME = 'SERVICE TAX F&O MARGIN'          

        

SELECT @CESSTAX_GLCODE = ISNULL(ACCODE,'')        
FROM MCDXCDS.DBO.VALANACCOUNT (NOLOCK) WHERE ACNAME = 'EDUCATION CESS F&O MARGIN'          

        

SELECT @EDUCESSTAX_GLCODE = ISNULL(ACCODE,'')        
FROM MCDXCDS.DBO.VALANACCOUNT (NOLOCK) WHERE ACNAME = 'SHE F&O MARGIN'    


SELECT @SBCCHARG_GLCODE = ISNULL(ACCODE,'')        
FROM MCDXCDS.DBO.VALANACCOUNT (NOLOCK) WHERE ACNAME = 'SBC F&O MARGIN'    

SELECT         
 @SERTAXPER = SERVICE_TAX * 100 / (100 + EDUCESS_TAX + CESS_TAX + SBCCHARGE),        
 @CESSTAXPER = CESS_TAX,        
 @EDUCESSTAXPER = EDUCESS_TAX,
 @SBCCHRGPER = SBCCHARGE
FROM         

 MCDXCDS..FOGLOBALS (NOLOCK)        

WHERE         

 getdate() BETWEEN YEAR_START_DT AND YEAR_END_DT  





/*======================== MARGIN PENALTY PLUG IN  ============================================*/  

     

    

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)          

SELECT       

 1,PARTY_CODE ,      

 @TRDATE, @EDATE,'D',      

 AMT = (
 CASE 
	WHEN (@EDUCESSTAXPER+@CESSTAXPER+@SBCCHRGPER) > 0 
	THEN ROUND(PENALTY_AMT,2) + ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@CESSTAXPER),2)),2)+ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@EDUCESSTAXPER),2)),2)+ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@SBCCHRGPER),2)),2)),2)+ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@CESSTAXPER),2)),2)+ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@EDUCESSTAXPER),2)),2)+ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@SBCCHRGPER),2)),2)
 END),
 NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE     

FROM       

 MCDXCDS.DBO.FOMARGIN_PENALTY(NOLOCK)     

WHERE   

 MARGIN_DATE =  @TRADEDATE     

 AND LEDGER_POST_FLAG = 99  

          

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)          

SELECT       

 1,@GLCODE ,      

 @TRDATE, @EDATE,'C',      

 AMT = SUM(ISNULL(PENALTY_AMT, 0)),      

 NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE  

FROM       

 MCDXCDS.DBO.FOMARGIN_PENALTY(NOLOCK)  

WHERE   

 MARGIN_DATE =  @TRADEDATE     

 AND LEDGER_POST_FLAG = 99  

  

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)          

SELECT       

 1,@SERTAX_GLCODE ,      

 @TRDATE, @EDATE,'C',      

 AMT = (case when (@EDUCESSTAXPER+@CESSTAXPER+@SBCCHRGPER) > 0 Then SUM(ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@CESSTAXPER),2)),2)+ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@EDUCESSTAXPER),2)),2)+ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@SBCCHRGPER),2)),2)),2))
 else sum(ISNULL(SERVICE_TAX,0)) end),        

 NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE  

FROM       

 MCDXCDS.DBO.FOMARGIN_PENALTY(NOLOCK)     

WHERE   

 MARGIN_DATE =  @TRADEDATE     

 AND LEDGER_POST_FLAG = 99  

 

 INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)                

SELECT             

 1,@CESSTAX_GLCODE ,            

 @TRDATE, @EDATE,'C',            

 AMT = sum(ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@CESSTAXPER),2)),2)) ,            

 NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE        

FROM             

 MCDXCDS.DBO.FOMARGIN_PENALTY(NOLOCK)           

WHERE         

 MARGIN_DATE =  @TRADEDATE           

 AND LEDGER_POST_FLAG = 99        
 and (@EDUCESSTAXPER+@CESSTAXPER) > 0
        

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)                

SELECT             

 1,@EDUCESSTAX_GLCODE ,            

 @TRDATE, @EDATE,'C',            

 AMT = sum(ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@EDUCESSTAXPER),2)),2)) ,            

 NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE        

FROM             

 MCDXCDS.DBO.FOMARGIN_PENALTY(NOLOCK)           

WHERE         

 MARGIN_DATE =  @TRADEDATE           

 AND LEDGER_POST_FLAG = 99   
 and (@EDUCESSTAXPER+@CESSTAXPER) > 0
 
 

INSERT INTO #RECPAY_TABLE (SRNO,CLTCODE,VVDT,EEDT,DRCR,AMOUNT,NARRATION)                
SELECT             
 1,@SBCCHARG_GLCODE ,            
 @TRDATE, @EDATE,'C',            
 AMT = sum(ROUND((ISNULL(SERVICE_TAX,0))-(ROUND((ISNULL(SERVICE_TAX,0))*100/(100+@SBCCHRGPER),2)),2)) ,            
 NARRATION = 'MARGIN SHORTAGE PENALTY - ' + @TRADEDATE        
FROM             
 MCDXCDS.DBO.FOMARGIN_PENALTY(NOLOCK)           
WHERE         
 MARGIN_DATE =  @TRADEDATE           
 AND LEDGER_POST_FLAG = 99   
 and (@SBCCHRGPER) <> 0
 

         

DELETE FROM #RECPAY_TABLE WHERE ISNULL(AMOUNT, 0) = 0  


/*=============================================================================================*/ 



DECLARE                

  @@NEWVNO AS VARCHAR(12),                

  @@VDT AS VARCHAR(11),                

  @@LNOCUR AS CURSOR,                

  @@LNOVNO AS INT,         

  @@NOREC AS INT                



SELECT TOP 1                

  @@VDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)), 109)

 FROM                

  #RECPAY_TABLE  -------ADDED BY YOGESH         

  

  UPDATE                

   #RECPAY_TABLE                

 SET   

    VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),                

    EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),                

    FYSTART = P.SDTCUR,                

    FYEND = P.LDTCUR,                

    UPDFLAG = 'Y',                

    ACNAME = LONGNAME,                

    COSTCODE = 0  

    FROM ACMAST A, PARAMETER P  , COSTMAST C                

    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE                

    --AND P.CURYEAR = 1     

    AND @@VDT BETWEEN  P.SDTCUR AND P.LDTCUR ---- ADDED BY YOGESH          

    AND A.ACCAT IN ('3','4','104')                

    AND A.BRANCHCODE = C.COSTNAME                

    AND A.BRANCHCODE <> 'ALL'   

                

   UPDATE              

   #RECPAY_TABLE                

   SET                

    VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),                

    EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2)),                

    FYSTART = P.SDTCUR,                

    FYEND = P.LDTCUR,                

    UPDFLAG = 'Y',                

    ACNAME = LONGNAME,                

    COSTCODE = (SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  

    FROM ACMAST A, PARAMETER P                

    WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE                

    --AND P.CURYEAR = 1 

    AND @@VDT BETWEEN  P.SDTCUR AND P.LDTCUR ---- ADDED BY YOGESH                

    AND A.ACCAT IN ('3','4','104')       

    AND A.BRANCHCODE = 'ALL'                

               

/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/                

                

 DECLARE                

  @@STD_DATE VARCHAR(11),                

  @@LST_DATE VARCHAR(11),                

  @@VNOMETHOD INT,                

  @@ACNAME CHAR(100),                

  @@MICRNO VARCHAR(10),                

  @@DRCR VARCHAR(1)                

                

                

/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/                

  

 SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND                

 IF @@ERROR_COUNT > 0                

  BEGIN  

   RAISERROR('DATE MISMATCH', 16, 1)      

   DROP TABLE #RECPAY_TABLE                

                   

   RETURN                

  END                

                

             

/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/                

                

 SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)                

 GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1                

 IF @@ERROR_COUNT > 0                

  BEGIN       

     RAISERROR('SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 16, 1)      

   DROP TABLE #RECPAY_TABLE                

                   

   RETURN                

  END                

                

          

          

/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/               

                

 SELECT @@ERROR_COUNT = COUNT(1) FROM                

  (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)                

  FROM #RECPAY_TABLE                

  GROUP BY SRNO                

  HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A                

 IF @@ERROR_COUNT > 0                

  BEGIN          

    RAISERROR('DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS', 16, 1)            

   DROP TABLE #RECPAY_TABLE                

             

   RETURN                

  END                

                

/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/                

                

 SELECT @@ERROR_COUNT = COUNT(1) FROM                

 (   

  SELECT DISTINCT                

   CLTCODE                

  FROM #RECPAY_TABLE             

  WHERE UPDFLAG = 'N'                

 ) A                

         

 IF @@ERROR_COUNT > 0                

  BEGIN                

   SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL                

   SELECT DISTINCT                

    CLTCODE                

   FROM #RECPAY_TABLE                

   WHERE UPDFLAG = 'N'                

   DROP TABLE #RECPAY_TABLE                

                   

   RETURN                

  END                

                

                

IF @LEDGERVNO = ''  

BEGIN  

/* '--------------------------AUTO GENERATION OF VNO (FULL LOGIC)------------------------*/                

 DECLARE                

  @@MAXVNO AS VARCHAR(12),                

  @@VNO AS VARCHAR(12),                

  @@RCOUNT AS INT                

 SELECT TOP 1                

  @@VDT = CONVERT(VARCHAR(11), VDT, 109)                

 FROM                

  #RECPAY_TABLE                

                

 SELECT TOP 1                

  @@VNOMETHOD = VNOFLAG,                

  @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                

  @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109)                

 FROM                

  PARAMETER             

 WHERE                

  @@VDT BETWEEN SDTCUR AND LDTCUR                

                

                 

SELECT                

  @@NOREC = COUNT(DISTINCT SRNO)                

 FROM                

  #RECPAY_TABLE                

                

 CREATE TABLE #VNO  

 (  

 LASTVNO VARCHAR(12)  

 )             

  

 INSERT INTO #VNO  

 EXEC ACC_GENVNO_NEW @@VDT, @VTYP, @BOOKTYPE, @@STD_DATE, @@LST_DATE, @@NOREC  

  

 SELECT @@VNO = LASTVNO FROM #VNO  

       

 UPDATE                

  #RECPAY_TABLE                

 SET VNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC,@@VNO) + SRNO - 1)    

END  

ELSE  

BEGIN    

 SELECT @@VNO = @LEDGERVNO    

  

 SELECT TOP 1                  

  @@VDT = CONVERT(VARCHAR(11), VDT, 109)                  

 FROM                  

  #RECPAY_TABLE                  

  

 UPDATE                  

 #RECPAY_TABLE                  

 SET VNO = @LEDGERVNO    

END                      

                

/* '--------------------------AUTO GENERATION OF LNO ------------------------*/                

                

 SET @@LNOCUR = CURSOR FOR                

  SELECT DISTINCT SRNO FROM #RECPAY_TABLE                

 OPEN @@LNOCUR                

  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO                

 WHILE @@FETCH_STATUS = 0                

  BEGIN                

   INSERT INTO #RECPAY_TABLE_LNO                

    (SNO)                

   SELECT SNO FROM #RECPAY_TABLE WHERE SRNO = @@LNOVNO                

   UPDATE RP                

    SET LNO = RL.LNO                

   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL                

   WHERE RP.SNO = RL.SNO                

   TRUNCATE TABLE #RECPAY_TABLE_LNO   

   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO                

  END               

 CLOSE @@LNOCUR                

 DEALLOCATE @@LNOCUR                

 DROP TABLE #RECPAY_TABLE_LNO                

                

/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/                

/*==============================          LEDGER RECORD                

==============================*/                

 INSERT                

 INTO LEDGER                

 SELECT        

  VTYP = @VTYP,                

  VNO,                

  EDT,                

  LNO,                

  ACNAME,                

  DRCR,                

  VAMT = AMOUNT,                

  VDT,                

  VNO1 = VNO,                

  REFNO = 0,                

  BALAMT = AMOUNT,                

  NODAYS = 0,                

  CDT = GETDATE(),                

  CLTCODE,                

  BOOKTYPE = @BOOKTYPE,                

  ENTEREDBY = @UNAME,                

  PDT = GETDATE(),                

  CHECKEDBY = @UNAME,                

  ACTNODAYS = 0,                

  NARRATION                

 FROM                

  #RECPAY_TABLE      

    

                

/*==============================                

 LEDGER3 RECORD                

==============================*/                

 INSERT                

 INTO LEDGER3                

 SELECT                

  NARATNO = LNO,                

  NARRATION,                

  REFNO = 0,                

  VTYP = @VTYP,                

  VNO,                

  BOOKTYPE = @BOOKTYPE                

  FROM    

  #RECPAY_TABLE     

    

 DELETE FROM TEMPLEDGER2 WHERE SESSIONID = '9999999999'  

   

 INSERT INTO TEMPLEDGER2  

 SELECT  

  'BRANCH',  

  C.COSTNAME,  

  AMOUNT,  

  VTYP = @VTYP,  

  VNO,  

  LNO,  

  DRCR,  

  '0',  

  BOOKTYPE = @BOOKTYPE,  

  SESSIONID = '9999999999',  

  CLIENT_CODE = CLTCODE,  

  'A',  

  '0'  

 FROM  

  #RECPAY_TABLE RP,  

  COSTMAST C  

 WHERE  

  RP.COSTCODE = C.COSTCODE  

  

 DECLARE @@L2CUR AS CURSOR,  

  @@L2VNO AS VARCHAR(12)  

    

 SET @@L2CUR = CURSOR FOR  

 SELECT DISTINCT VNO FROM #RECPAY_TABLE ORDER BY VNO  

 OPEN @@L2CUR  

 FETCH NEXT FROM @@L2CUR INTO @@L2VNO  

 WHILE @@FETCH_STATUS = 0  

 BEGIN  

  EXEC INSERTTOLEDGER2 '9999999999', @@L2VNO, '1', '1', '1', 'BROKER', 'BROKER'  

  FETCH NEXT FROM @@L2CUR INTO @@L2VNO  

 END  

 DELETE FROM TEMPLEDGER2 WHERE SESSIONID = '9999999999'  

   

 CLOSE @@L2CUR  

 DEALLOCATE @@L2CUR  

          

/*=========================  MARGIN SHORTAGE PENALTY PLUG IN ==========================*/          

UPDATE MCDXCDS.DBO.FOMARGIN_PENALTY  

SET LEDGER_POST_FLAG = 1  

WHERE   

 MARGIN_DATE =  @TRADEDATE     

 AND LEDGER_POST_FLAG = 99  

   

UPDATE MCDXCDS.DBO.FOMARGIN_PENALTY_POST_STAT  

SET POST_FLAG = 1,LEDGER_VNO=@@VNO, LEDGER_VDT = @@VDT  

WHERE   

 MARGIN_DATE =  @TRADEDATE     

/*============================== MARGIN SHORTAGE PENALTY PLUG IN  =====================*/              

           

 DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_FT_GL_DETAILS
-- --------------------------------------------------

        
CREATE PROCEDURE [dbo].[GET_FT_GL_DETAILS]        
 @EXCH VARCHAR(10),        
 @FROM_DATE VARCHAR(11),        
 @TO_DATE VARCHAR(11),
 @CTRLCODE_FROM VARCHAR(10) = '00',
 @CTRLCODE_TO VARCHAR(10) = '99'
AS        
        
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
 IF LEN(@FROM_DATE) = 10        
 BEGIN        
  SELECT @FROM_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROM_DATE, 103), 109)        
  SELECT @TO_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TO_DATE, 103), 109)        
 END        
        
 CREATE TABLE #FT_GL_DETAILS        
 (        
  JV_CODE VARCHAR(10)        
  --JV_NAME VARCHAR(100) 
 )
        
 INSERT INTO #FT_GL_DETAILS        
 SELECT         
  JV_CODE         
  --JV_NAME         
 FROM         
  FT_GL         
 WHERE         
  EXCH_FR = @EXCH
  AND JV_CODE BETWEEN @CTRLCODE_FROM AND @CTRLCODE_TO
         
 UNION       
         
 SELECT         
  JV_CODE         
  --JV_NAME         
 FROM         
  FT_GL         
 WHERE         
  EXCH_TO = @EXCH
  AND JV_CODE BETWEEN @CTRLCODE_FROM AND @CTRLCODE_TO       
        
-- SELECT * FROM #FT_GL_DETAILS      
        
 SELECT         
  CTRL_CODE = JV_CODE,         
  --CTRL_NAME = JV_NAME,        
  EXCHANGE = @EXCH,        
  AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)        
 FROM        
  LEDGER L WITH (NOLOCK),         
  #FT_GL_DETAILS F        
 WHERE         
  CLTCODE = JV_CODE        
  AND VDT BETWEEN @FROM_DATE AND @TO_DATE        
  AND VTYP = 88        
 GROUP BY        
  JV_CODE        
  --JV_NAME        
 ORDER BY        
  1        
        
           
 DROP TABLE #FT_GL_DETAILS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA
-- --------------------------------------------------





--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'  
CREATE PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA]    
 @EFFDATE VARCHAR(11),  
 @SESSIONID VARCHAR(500),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10),
 @SEGMENT VARCHAR(50)
AS    
  
DECLARE    
 @START_DATE VARCHAR(11)    
    
IF LEN(@EFFDATE) = 10    
BEGIN    
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    
    
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    
  
  
CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_PAYMENTS MONEY,
 MARGIN_BAL MONEY  
)  
  
DECLARE  
 @@SQL VARCHAR(MAX)  
  
INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 PARTY_NAME,     
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = L.CLTCODE,  
 PARTY_NAME,  
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN (RELDT = '' OR RELDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN SUM(VAMT) ELSE 0 END,    
 FDT_PAYMENTS = CASE WHEN (RELDT = '' OR RELDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN SUM(VAMT) ELSE 0 END
FROM     
 (SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE OR VDT >= DATEADD(M, -6, @EFFDATE))    
 AND VDT <= @EFFDATE + ' 23:59')    L  
 LEFT OUTER JOIN (SELECT RELDT, VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR (RELDT = '' AND CLEAR_MODE <> 'C'))) L1
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO,
 FORMULA_CLIENT_MASTER A    
WHERE    
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID  
 
 GROUP BY     
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE,  L.VDT, EDT, L.VTYP, DRCR, L1.RELDT    
) A    
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    

/*
UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, (
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE RD.CLTCODE = PARTY_CODE
*/

SET @@SQL = " SELECT "  
SET @@SQL = @@SQL + " CLTCODE, "  
SET @@SQL = @@SQL + " PARTY_NAME, "  
SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
SET @@SQL = @@SQL + " ENTITY_CODE, "  
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
SET @@SQL = @@SQL + " FROM "  
SET @@SQL = @@SQL + " #REPORT_DATA"  
  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_LEDGER_AUDIT_DATA_BKUP_14FEB2019
-- --------------------------------------------------






--EXEC V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013', '9999999999', 0, ''  
--EXEC [MTSRVR06\DEV].ACCOUNT..V2_GET_LEDGER_FORMULA_BALANCES 'MAR 31 2013','9999999999','', 'VDTBAL_OPBAL, T_DAY_BILL, FDT_RECEIPT'  
CREATE PROCEDURE [dbo].[GET_LEDGER_AUDIT_DATA_BKUP_14FEB2019]    
 @EFFDATE VARCHAR(11),  
 @SESSIONID VARCHAR(500),  
 @PROCESS_CODE VARCHAR(10),  
 @REPORT_FORMULA VARCHAR(MAX),
 @EXCHANGE VARCHAR(10),
 @SEGMENT VARCHAR(50)
AS    
  
DECLARE    
 @START_DATE VARCHAR(11)    
    
IF LEN(@EFFDATE) = 10    
BEGIN    
 SELECT @EFFDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EFFDATE, 103), 109)    
END    
    
SELECT @START_DATE = CONVERT(VARCHAR(11), SDTCUR, 109)    
FROM PARAMETER    
WHERE @EFFDATE BETWEEN SDTCUR AND LDTCUR    
  
  
CREATE TABLE #REPORT_DATA  
(  
 CLTCODE VARCHAR(10),  
 PARTY_NAME VARCHAR(100),     
 ENTITY_LEVEL VARCHAR(20),  
 ENTITY_CODE VARCHAR(25),    
 VDTBAL MONEY,    
 EDTBAL MONEY,    
 FDT_RECEIPT MONEY,    
 FDT_PAYMENTS MONEY,
 MARGIN_BAL MONEY  
)  
  
DECLARE  
 @@SQL VARCHAR(MAX)  
  
INSERT INTO #REPORT_DATA    
SELECT     
 CLTCODE,  
 PARTY_NAME,     
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = SUM(VDTBAL),    
 EDTBAL = SUM(EDTBAL),    
 FDT_RECEIPT = SUM(FDT_RECEIPT),    
 FDT_PAYMENTS = SUM(FDT_PAYMENTS),
 MARGIN_BAL = 0
FROM    
(SELECT     
 CLTCODE = L.CLTCODE,  
 PARTY_NAME,  
 ENTITY_LEVEL,  
 ENTITY_CODE,    
 VDTBAL = CASE WHEN VDT >= @START_DATE THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 EDTBAL = CASE WHEN EDT >= @START_DATE AND EDT <= @EFFDATE + ' 23:59' THEN SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END     
   + CASE WHEN EDT >= @START_DATE AND VDT < @START_DATE THEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) ELSE 0 END,    
 FDT_RECEIPT = CASE WHEN (/*RELDT = '' OR */RELDT > @EFFDATE + ' 23:59') AND L.VTYP = 2 THEN SUM(VAMT) ELSE 0 END,    
 FDT_PAYMENTS = CASE WHEN (/*RELDT = '' OR */RELDT > @EFFDATE + ' 23:59') AND L.VTYP = 3 THEN SUM(VAMT) ELSE 0 END
FROM     
 (SELECT VNO,LNO,VTYP,EDT,DRCR,VAMT,VDT,CLTCODE,BOOKTYPE,NARRATION FROM LEDGER WHERE (VDT >= @START_DATE OR EDT >= @START_DATE OR VDT >= DATEADD(M, -6, @EFFDATE))    
 AND VDT <= @EFFDATE + ' 23:59')    L  
 LEFT OUTER JOIN (SELECT RELDT, VTYP,VNO,LNO,BOOKTYPE FROM LEDGER1 WHERE (RELDT > @EFFDATE + ' 23:59' OR RELDT = '')) L1
 ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO,
 FORMULA_CLIENT_MASTER A    
WHERE    
 A.CLTCODE = L.CLTCODE AND SESSION_ID = @SESSIONID  
 
 GROUP BY     
 L.CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE,  L.VDT, EDT, L.VTYP, DRCR, L1.RELDT    
) A    
GROUP BY CLTCODE, PARTY_NAME, ENTITY_LEVEL, ENTITY_CODE      
--HAVING SUM(VDTBAL) <> 0 AND SUM(EDTBAL) <> 0    

/*
UPDATE RD SET MARGIN_BAL = ML.AMOUNT
FROM #REPORT_DATA RD, (
	SELECT PARTY_CODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END)
	FROM MARGINLEDGER ML
	WHERE VDT >= @START_DATE AND VDT <= @EFFDATE + ' 23:59'
	GROUP BY PARTY_CODE
)ML
WHERE RD.CLTCODE = PARTY_CODE
*/

SET @@SQL = " SELECT "  
SET @@SQL = @@SQL + " CLTCODE, "  
SET @@SQL = @@SQL + " PARTY_NAME, "  
SET @@SQL = @@SQL + " ENTITY_LEVEL,"  
SET @@SQL = @@SQL + " ENTITY_CODE, "  
SET @@SQL = @@SQL + @REPORT_FORMULA + ", EXCHANGE = '" + @EXCHANGE + "', SEGMENT = '" + @SEGMENT + "', SESSIONID = '" + @SESSIONID + "', POPULATE_DATE = GETDATE() "  
SET @@SQL = @@SQL + " FROM "  
SET @@SQL = @@SQL + " #REPORT_DATA"  
  
EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETBILLDATASUM
-- --------------------------------------------------



CREATE  PROC GETBILLDATASUM
	@BILLDATE AS VARCHAR(11), 
	@SHAREDB AS VARCHAR(15), 
	@DISPOPT AS VARCHAR(7) = 'SUMMARY',
	@REMBILL AS VARCHAR(1) = 'N'

AS

DECLARE
@@SQLQRY AS VARCHAR(2000)

SET @@SQLQRY = "SELECT PARTY_CODE, M.ACNAME, ROUND(AMOUNT,2) AS AMOUNT, SELL_BUY, BILL_NO=0 FROM " + @SHAREDB
IF @REMBILL = 'Y'
	BEGIN
		SET @@SQLQRY = @@SQLQRY + ".DBO.REM_FOACCBILL A, ACMAST M  WITH(NOLOCK)"
	END
ELSE
	BEGIN
		SET @@SQLQRY = @@SQLQRY + ".DBO.FOACCBILL A, ACMAST M  WITH(NOLOCK)"
	END
SET @@SQLQRY = @@SQLQRY + " WHERE BILLDATE LIKE '" + @BILLDATE + "%' "
SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND BRANCHCD = 'ZZZ' "
--SET @@SQLQRY = @@SQLQRY + " AND ROUND(AMOUNT,2) <> 0 "
SET @@SQLQRY = @@SQLQRY + " UNION ALL "

IF @DISPOPT = 'SUMMARY'
	BEGIN
		SET @@SQLQRY = @@SQLQRY + " SELECT 'PARTY DR', 'PARTY AMOUNT RECEIVABLES', ROUND(SUM(AMOUNT),2) AS AMOUNT, SELL_BUY, BILL_NO=0 "
		IF @REMBILL = 'Y'
			BEGIN
				SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.REM_FOACCBILL A, "
			END
		ELSE
			BEGIN
				SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.FOACCBILL A, "
			END
		SET @@SQLQRY = @@SQLQRY + " ACMAST M  WHERE BILLDATE LIKE '" + @BILLDATE + "%' "
		SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4  AND SELL_BUY = '1' "
		SET @@SQLQRY = @@SQLQRY + " GROUP BY  SELL_BUY "
		SET @@SQLQRY = @@SQLQRY + " UNION ALL "
	END
ELSE
	BEGIN
		SET @@SQLQRY = @@SQLQRY + " SELECT PARTY_CODE ,M.ACNAME, ROUND(SUM(AMOUNT),2) AS AMOUNT, SELL_BUY, BILL_NO=0 "
		IF @REMBILL = 'Y'
			BEGIN
				SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.REM_FOACCBILL A, "
			END
		ELSE
			BEGIN
				SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.FOACCBILL A, "
			END
		SET @@SQLQRY = @@SQLQRY + " ACMAST M  WHERE BILLDATE LIKE '" + @BILLDATE + "%' "
		SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4  AND SELL_BUY = '1' "
		SET @@SQLQRY = @@SQLQRY + " GROUP BY PARTY_CODE ,M.ACNAME,  SELL_BUY "
		SET @@SQLQRY = @@SQLQRY + " UNION ALL "
	END
IF @DISPOPT = 'SUMMARY'
	BEGIN
		SET @@SQLQRY = @@SQLQRY + " SELECT 'PARTY CR', 'PARTY AMOUNT PAYABLES', ROUND(SUM(AMOUNT),2) AS AMOUNT,SELL_BUY, BILL_NO=0 "
		IF @REMBILL = 'Y'
			BEGIN
				SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.REM_FOACCBILL A, ACMAST M "
			END
		ELSE
			BEGIN
				SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.FOACCBILL A, ACMAST M "
			END
		SET @@SQLQRY = @@SQLQRY + " WHERE BILLDATE LIKE '" + @BILLDATE + "%' "
		SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4   AND SELL_BUY = '2' "
		SET @@SQLQRY = @@SQLQRY + " GROUP BY  SELL_BUY "
	END
ELSE
	BEGIN
		SET @@SQLQRY = @@SQLQRY + " SELECT PARTY_CODE, M.ACNAME, ROUND(SUM(AMOUNT),2) AS AMOUNT,SELL_BUY, BILL_NO=0 "
		IF @REMBILL = 'Y'
			BEGIN
				SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.REM_FOACCBILL A, ACMAST M "
			END
		ELSE
			BEGIN
				SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.FOACCBILL A, ACMAST M "
			END
		SET @@SQLQRY = @@SQLQRY + " WHERE BILLDATE LIKE '" + @BILLDATE + "%' "
		SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4   AND SELL_BUY = '2' "
		SET @@SQLQRY = @@SQLQRY + " GROUP BY PARTY_CODE, M.ACNAME, SELL_BUY "
	END

PRINT @@SQLQRY
EXEC(@@SQLQRY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETDATA_EDIT_All
-- --------------------------------------------------



CREATE PROC [dbo].[GETDATA_EDIT_All]            
@Fdate Varchar(11),            /* As Mmm Dd Yyyy */                    
@Tdate Varchar(11),            /* As Mmm Dd Yyyy */                
@VTYP INT,            
@BANKCODE VARCHAR(10),        
@VNO_FR VARCHAR(12),            
@VNO_TO VARCHAR(12),            
@VDT VARCHAR(11) = '',            
@VAMT MONEY = 0,              
@BOOKTYPE VARCHAR(3),            
@CLTCODE VARCHAR(10) = '',            
@PageSize varchar(3) = '25'            
AS            
            
CREATE TABLE #GETDATA_EDIT            
(            
 VNO VARCHAR(12),             
 CLTCODE VARCHAR(10),             
 ACNAME VARCHAR(100),             
 VAMT MONEY,             
 NARRATION VARCHAR(250),             
 DDNO VARCHAR(20),             
 RELDT VARCHAR(10),            
 BNKNAME VARCHAR(50),        
 VDT VARCHAR(10),    
 LNO INT            
)            
            
DECLARE            
@@SQL VARCHAR(1000)            
            
SET @@SQL = " INSERT INTO #GETDATA_EDIT "            
SET @@SQL = @@SQL + " SELECT TOP " + @PageSize          
SET @@SQL = @@SQL + " L.VNO, CLTCODE, ACNAME, VAMT = CASE L.DRCR WHEN 'D' THEN -VAMT ELSE VAMT END, NARRATION, DDNO, RELDT = CONVERT(VARCHAR(10), RELDT, 103), BNKNAME, CONVERT(VARCHAR(10), VDT, 103), L.LNO "            
SET @@SQL = @@SQL + " FROM "            
SET @@SQL = @@SQL + " LEDGER L, LEDGER1 L1 "            
SET @@SQL = @@SQL + " WHERE "            
SET @@SQL = @@SQL + " L.VNO = L1.VNO "            
SET @@SQL = @@SQL + " AND L.VTYP = L1.VTYP "            
SET @@SQL = @@SQL + " AND L.BOOKTYPE = L1.BOOKTYPE "            
IF @VTYP = 5     
BEGIN    
SET @@SQL = @@SQL + " AND L.LNO = L1.LNO "            
END    
IF @VTYP <> 5     
BEGIN    
 SET @@SQL = @@SQL + " AND L.LNO =1 "            
END    
--SET @@SQL = @@SQL + " AND L.VNO = L2.VNO "            
--SET @@SQL = @@SQL + " AND L.VTYP = L2.VTYP "            
--SET @@SQL = @@SQL + " AND L.BOOKTYPE = L2.BOOKTYPE "            
SET @@SQL = @@SQL + " AND L.CLTCODE = '" + @BANKCODE + "'"         
IF @VDT = ''             
 BEGIN             
 SET @@SQL = @@SQL + " AND VDT BETWEEN '" + @Fdate + "' And '" + @Tdate + " 23:59:59' "        
END        
ELSE        
BEGIN        
 SET @@SQL = @@SQL + " AND VDT LIKE '" + @VDT + "%' "        
END        
SET @@SQL = @@SQL + " AND L.VTYP = " + CONVERT(VARCHAR, @VTYP)            
SET @@SQL = @@SQL + " AND L.VNO BETWEEN '" + @VNO_FR + "' AND '" + @VNO_TO +"' "            
SET @@SQL = @@SQL + " AND L.BOOKTYPE = '" + @BOOKTYPE + "' "          
          
IF @VAMT <> 0            
 BEGIN            
 SET @@SQL = @@SQL + " AND L.VAMT = " + CONVERT(VARCHAR,@VAMT) + " "            
 END            
            
IF @CLTCODE <> ''            
 BEGIN            
 SET @@SQL = @@SQL + " AND L.CLTCODE = '" + @CLTCODE + "' "            
 END            
            
/*IF @VDT = ''             
 BEGIN             
  SET @@SQL = @@SQL + " AND L.VDT BETWEEN '" + @Fdate + "' And '" + @Tdate + " 23:59:59' "            
 END             
ELSE             
 BEGIN             
  SET @@SQL = @@SQL + " AND L.VDT LIKE '" + @VDT + "%' "            
 END     */        
  SET @@SQL = @@SQL + " ORDER BY L.VNO "            
          
print @@SQL        
EXEC (@@SQL)            
            
/*DELETE FROM #GETDATA_EDIT            
WHERE             
EXISTS             
 (        
  SELECT VNO FROM LEDGER L WHERE L.VNO = #GETDATA_EDIT.VNO AND L.VTYP = @VTYP AND L.BOOKTYPE = @BOOKTYPE            
  GROUP BY VNO, VTYP, BOOKTYPE HAVING COUNT(1) > 2           
 )*/            
    
IF @VTYP = 5    
BEGIN    
 UPDATE G SET RELDT = L1.RELDT FROM #GETDATA_EDIT G, LEDGER1 L1    
 WHERE L1.VNO = G.VNO AND L1.VTYP = @VTYP AND L1.RELDT <> ''    
END    
            
SELECT * FROM #GETDATA_EDIT            
SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETIBILLDATASUM
-- --------------------------------------------------





CREATE  PROC GETIBILLDATASUM
@SETT_NO AS VARCHAR(7),
@SETT_TYPE AS VARCHAR(1),
@SHAREDB AS VARCHAR(15),
@DISPOPT AS VARCHAR(7) = 'SUMMARY'

--EXEC GETBILLDATASUM '2004042', 'N', 'MSAJAG'
--EXEC GETBILLDATASUM '2004059', 'A ', 'MSAJAG'

AS

DECLARE
@@SQLQRY AS VARCHAR(2000)

SET @@SQLQRY = "SELECT PARTY_CODE, M.ACNAME, ROUND(AMOUNT,2) AS AMOUNT, SELL_BUY, BILL_NO FROM " + @SHAREDB + " "
SET @@SQLQRY = @@SQLQRY + ".DBO.IACCBILL A, ACMAST M  WITH(NOLOCK)"
SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"
SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND BRANCHCD = 'ZZZ' "
SET @@SQLQRY = @@SQLQRY + " UNION ALL "

IF @DISPOPT = 'SUMMARY'
	BEGIN
		SET @@SQLQRY = @@SQLQRY + " SELECT 'PARTY DR', 'PARTY AMOUNT RECEIVABLES', ROUND(SUM(AMOUNT),2) AS AMOUNT, SELL_BUY, BILL_NO "
		SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.IACCBILL A, "
		SET @@SQLQRY = @@SQLQRY + " ACMAST M  WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"
		SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4  AND SELL_BUY = '1' "
		SET @@SQLQRY = @@SQLQRY + " GROUP BY BILL_NO, SELL_BUY "
		SET @@SQLQRY = @@SQLQRY + " UNION ALL "
	END
ELSE
	BEGIN
		SET @@SQLQRY = @@SQLQRY + " SELECT PARTY_CODE, M.ACNAME, ROUND(SUM(AMOUNT),2) AS AMOUNT, SELL_BUY, BILL_NO "
		SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.IACCBILL A, "
		SET @@SQLQRY = @@SQLQRY + " ACMAST M  WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"
		SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4  AND SELL_BUY = '1' "
		SET @@SQLQRY = @@SQLQRY + " GROUP BY PARTY_CODE, M.ACNAME, BILL_NO, SELL_BUY "
		SET @@SQLQRY = @@SQLQRY + " UNION ALL "
	END
	
IF @DISPOPT = 'SUMMARY'
	BEGIN
		SET @@SQLQRY = @@SQLQRY + " SELECT 'PARTY CR', 'PARTY AMOUNT PAYABLES', ROUND(SUM(AMOUNT),2) AS AMOUNT,SELL_BUY, BILL_NO "
		SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.IACCBILL A, ACMAST M "
		SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"
		SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4   AND SELL_BUY = '2' "
		SET @@SQLQRY = @@SQLQRY + " GROUP BY BILL_NO, SELL_BUY "
	END
ELSE
	BEGIN
		SET @@SQLQRY = @@SQLQRY + " SELECT PARTY_CODE, M.ACNAME, ROUND(SUM(AMOUNT),2) AS AMOUNT,SELL_BUY, BILL_NO "
		SET @@SQLQRY = @@SQLQRY + " FROM "+ @SHAREDB + ".DBO.IACCBILL A, ACMAST M "
		SET @@SQLQRY = @@SQLQRY + " WHERE SETT_NO ='" + @SETT_NO + "' AND SETT_TYPE='" + @SETT_TYPE + "'"
		SET @@SQLQRY = @@SQLQRY + " AND A.PARTY_CODE = M.CLTCODE AND M.ACCAT = 4   AND SELL_BUY = '2' "
		SET @@SQLQRY = @@SQLQRY + " GROUP BY PARTY_CODE, M.ACNAME, BILL_NO, SELL_BUY "
	END

PRINT @@SQLQRY
EXEC(@@SQLQRY)

SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETMANUALBANKRECO
-- --------------------------------------------------



CREATE  PROC GETMANUALBANKRECO
	@BANKCODE VARCHAR(10),
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@EDIT SMALLINT,
	@SVTYP VARCHAR(5),
	@ORDERBY VARCHAR(15),
      @DDNO VARCHAR(15),
	@SELECTRL VARCHAR(20) = ''
AS
DECLARE @@SELECTQURY AS VARCHAR(2000)
	SELECT @@SELECTQURY = "SELECT L.ACNAME, L1.DRCR, L.CLTCODE, L1.DDNO, CONVERT(VARCHAR(10), DDDT, 103) AS DDDT, CONVERT(VARCHAR(10),RELDT,103) AS  RELDT1, "
	SELECT @@SELECTQURY = @@SELECTQURY + "L.VAMT AS RELAMT, CONVERT(VARCHAR(10), L.VDT, 103) AS VDT, "
	SELECT @@SELECTQURY = @@SELECTQURY + "CONVERT(VARCHAR(10),VDT,101) AS   VDT1,L1.VNO,L1.VTYP,L1.BOOKTYPE,L1.LNO,RELDT ,SHORTDESC "
	SELECT @@SELECTQURY = @@SELECTQURY + "FROM LEDGER L, LEDGER1 L1, VMAST V, (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = '" + @BANKCODE + "' "
	IF @SVTYP = 'ALL'
		BEGIN
			SELECT @@SELECTQURY = @@SELECTQURY + "AND VTYP IN (2,3,5,19,20,17) "
		END
	ELSE
		BEGIN
			IF @SVTYP = '2'
				BEGIN
					SELECT @@SELECTQURY = @@SELECTQURY + "AND VTYP = 2 "
				END
			ELSE
				BEGIN
					IF @SVTYP = '3'
						BEGIN
							SELECT @@SELECTQURY = @@SELECTQURY + "AND VTYP = 3 "
						END
				END
		END
      IF @FDATE <> ''
        BEGIN
	    SELECT @@SELECTQURY = @@SELECTQURY + "AND VDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59:59') L2 "
        END
      ELSE
        BEGIN
            SELECT @@SELECTQURY = @@SELECTQURY + ") L2 "
        END
	SELECT @@SELECTQURY = @@SELECTQURY + "WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE AND L.CLTCODE <> '" + @BANKCODE + "' "
	SELECT @@SELECTQURY = @@SELECTQURY + "AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO "
      IF @DDNO <> ''
        BEGIN
	     SELECT @@SELECTQURY = @@SELECTQURY + "AND L1.DDNO = '" + @DDNO + "'"
        END
/*
	IF @SELECTRL = 'CHKRELDT'
		BEGIN
			SELECT @@SELECTQURY = @@SELECTQURY + "AND L1.RELDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59:59' "
		END
	ELSE
		BEGIN
			SELECT @@SELECTQURY = @@SELECTQURY + "AND L.VDT BETWEEN '" + @FDATE + "' AND '" + @TDATE + " 23:59:59' "
		END
*/
	IF @EDIT = 1
		BEGIN
			SELECT @@SELECTQURY = @@SELECTQURY + "AND RELDT NOT LIKE 'JAN  1 1900%' "
		END
	ELSE
		BEGIN
			SELECT @@SELECTQURY = @@SELECTQURY + "AND RELDT LIKE 'JAN  1 1900%' "
		END
	SELECT @@SELECTQURY = @@SELECTQURY + "AND V.VTYPE = L.VTYP AND (UPPER(CLEAR_MODE) <> 'C') "
	IF @ORDERBY = 'RELAMT'
		BEGIN
			SELECT @@SELECTQURY = @@SELECTQURY + "ORDER BY RELAMT ,VDT1 ,L1.VTYP,L1.VNO "
		END
	ELSE
		BEGIN
			IF @ORDERBY = 'VDT'
				BEGIN
					SELECT @@SELECTQURY = @@SELECTQURY + "ORDER BY VDT1, RELAMT, L1.VTYP, L1.VNO "
				END
			ELSE
				BEGIN
					IF @ORDERBY = 'DDNO'
						BEGIN
							SELECT @@SELECTQURY = @@SELECTQURY + "ORDER BY DDNO, RELAMT, L1.VTYP, L1.VNO "
						END
					ELSE
						BEGIN
							IF @ORDERBY = 'RELDT'
								BEGIN
									SELECT @@SELECTQURY = @@SELECTQURY + "ORDER BY RELDT, RELAMT, L1.VTYP, L1.VNO "
								END
						END
				END
		END
PRINT @@SELECTQURY
EXEC (@@SELECTQURY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETPARADATE
-- --------------------------------------------------


CREATE PROC GETPARADATE
/*
	EXEC GETPARADATE 'DEC  1 2006', 'DEC 15 2006'
	EXEC GETPARADATE '01/12/2006', '15/12/2006'
EXEC GETPARADATE '01/04/2006', '09/05/2006' 
*/
	@@FROMDT AS VARCHAR(11),
	@@TODT AS VARCHAR(11)
AS
DECLARE
	@@DIFF AS INT,
	@@ISBRIT AS TINYINT

SELECT @@ISBRIT = 0
IF LEN(LTRIM(RTRIM(@@FROMDT))) = 10
	BEGIN
		SELECT @@FROMDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @@FROMDT, 103),109)
		SELECT @@ISBRIT = 1
	END
IF LEN(LTRIM(RTRIM(@@TODT))) = 10
	BEGIN
		SELECT @@TODT = CONVERT(VARCHAR(11), CONVERT(DATETIME, @@TODT, 103),109)
	END


SELECT @@DIFF = 0
SELECT @@DIFF = ISNULL(REPORTDAYS, 0) FROM PARAMETER WHERE @@TODT BETWEEN SDTCUR AND LDTCUR
IF @@DIFF = 0
	BEGIN
		IF @@ISBRIT = 0
			BEGIN
				SELECT @@FROMDT
			END
		ELSE
			BEGIN
				SELECT CONVERT(VARCHAR(10), CONVERT(DATETIME, @@FROMDT), 103)
			END
	END
ELSE
	BEGIN
		IF @@ISBRIT = 0
			BEGIN
				SELECT  ( 
				CASE 
					WHEN CONVERT(DATETIME, @@TODT, 109) - @@DIFF > CONVERT(DATETIME, @@FROMDT, 109) 
					THEN CONVERT(VARCHAR(11), CONVERT(DATETIME, @@TODT, 109) - @@DIFF, 109) 
					ELSE CONVERT(VARCHAR(11), @@FROMDT, 109) 
				END 
				)
			END
		ELSE
			BEGIN
				SELECT  ( 
				CASE 
					WHEN CONVERT(DATETIME, @@TODT, 109) - @@DIFF > CONVERT(DATETIME, @@FROMDT, 109) 
					THEN CONVERT(VARCHAR(10), CONVERT(DATETIME, @@TODT, 109) - @@DIFF, 103) 
					ELSE CONVERT(VARCHAR(10), CONVERT(DATETIME, @@FROMDT), 103) 
				END 
				)
			END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GST_SERVICE_TAX_SPLIT
-- --------------------------------------------------
CREATE PROC [dbo].[GST_SERVICE_TAX_SPLIT]
AS

DECLARE @SPLITCODE VARCHAR(10)

DECLARE @GSTDATE DATETIME

SET  @GSTDATE = 'JUl  1 2017'

SELECT @SPLITCODE = ACCODE FROM NSEFO.DBO.VALANACCOUNT
WHERE ACNAME = 'SPLIT TAX'

SELECT VNO, VTYP, BOOKTYPE, VDT, LNO=MAX(LNO) 
INTO #STAXVNO FROM LEDGER
WHERE VDT >= @GSTDATE
AND CLTCODE = @SPLITCODE
GROUP BY VNO, VTYP, BOOKTYPE, VDT

SELECT L.Vtyp, L.Vno, L.Edt, L.Lno, L.Acname, L.Drcr, L.Vamt, L.Vdt, L.Vno1, L.Refno, L.Balamt, 
	   L.Nodays, L.Cdt, L.Cltcode, L.Booktype, L.Enteredby, L.Pdt, L.Checkedby, L.Actnodays, L.Narration 
INTO #LEDGER 
FROM LEDGER L, #STAXVNO V
WHERE L.VDT >= @GSTDATE 
AND L.VDT = V.VDT
AND L.VNO = V.VNO
AND L.VTYP = V.VTYP
AND L.BOOKTYPE = V.BOOKTYPE

SELECT VNO,VTYP,BOOKTYPE,RECCNT = COUNT(1) INTO #WRONGDATA FROM (
SELECT CLTCODE, VNO,VTYP,BOOKTYPE 
FROM #LEDGER
WHERE CLTCODE IN (SELECT CLTCODE FROM ACMAST WHERE ACCAT = 4)
GROUP BY CLTCODE,VNO,VTYP,BOOKTYPE ) A
GROUP BY VNO,VTYP,BOOKTYPEOWNER
HAVING COUNT(1) > 1

DELETE FROM #LEDGER
WHERE EXISTS (SELECT VNO FROM #WRONGDATA
			  WHERE #WRONGDATA.VNO = #LEDGER.VNO
			  AND	#WRONGDATA.VTYP = #LEDGER.VTYP
			  AND   #WRONGDATA.BOOKTYPE = #LEDGER.BOOKTYPE) 

 
SELECT DISTINCT PARTY_CODE, SOURCESTATE = G.STATE, 
				TARGETSTATE = L_STATE, VDT, VNO, VTYP, BOOKTYPE,
GST_PER = CONVERT(NUMERIC(18,2),0),
CGST_PER = CONVERT(NUMERIC(18,2),0),
SGST_PER = CONVERT(NUMERIC(18,2),0),
IGST_PER = CONVERT(NUMERIC(18,2),0),
UGST_PER = CONVERT(NUMERIC(18,2),0),
STATE_CODE = CONVERT(VARCHAR(2),'')
INTO #FINDATA
FROM #LEDGER L, NSEFO.DBO.TBL_CLIENT_GST_DATA C, NSEFO.DBO.TBL_GST_LOCATION G
WHERE L.CLTCODE = C.PARTY_CODE
AND C.GST_LOCATION = G.LOC_CODE
AND VDT BETWEEN EFF_FROM_DATE AND EFF_TO_DATE

INSERT INTO #FINDATA
SELECT DISTINCT CL_CODE,SOURCESTATE=OWNER.STATE, 
TARGETSTATE=L_STATE,  VDT, VNO, VTYP, BOOKTYPE,
GST_PER = CONVERT(NUMERIC(18,2),0),
CGST_PER = CONVERT(NUMERIC(18,2),0),
SGST_PER = CONVERT(NUMERIC(18,2),0),
IGST_PER = CONVERT(NUMERIC(18,2),0),
UGST_PER = CONVERT(NUMERIC(18,2),0),
STATE_CODE = CONVERT(VARCHAR(2),'')
FROM #LEDGER N, NSEFO.DBO.FOOWNER OWNER,
NSEFO.DBO.TBL_STATE_GST_DATA T, NSEFO.DBO.CLIENT1 G
WHERE  OWNER.State = STATE_NAME
AND VDT BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE   
AND G.CL_CODE NOT IN (SELECT PARTY_CODE FROM #FINDATA WHERE G.CL_CODE = #FINDATA.Party_Code)
AND G.CL_CODE = N.CLTCODE 

-- ADDED NEW --
DELETE FROM #LEDGER
WHERE EXISTS (SELECT VNO FROM #FINDATA
			  WHERE #FINDATA.VNO = #LEDGER.VNO
			  AND	#FINDATA.VTYP = #LEDGER.VTYP
			  AND   #FINDATA.BOOKTYPE = #LEDGER.BOOKTYPE) 
-- ADDED NEW --

UPDATE #FINDATA SET TARGETSTATE = SOURCESTATE
WHERE TARGETSTATE NOT IN (SELECT STATE FROM NSEFO.DBO.STATE_MASTER WHERE STATE <> 'OTHER')

UPDATE #FINDATA SET
	GST_PER  = (CASE WHEN TARGETSTATE = SOURCESTATE THEN S.GST_PER ELSE 0 END),
	CGST_PER = (CASE WHEN TARGETSTATE = SOURCESTATE THEN S.CGST_PER ELSE 0 END),
	SGST_PER = (CASE WHEN TARGETSTATE = SOURCESTATE AND UTI_FLAG = 0 THEN S.SGST_PER ELSE 0 END),
	IGST_PER = (CASE WHEN TARGETSTATE <> SOURCESTATE THEN S.IGST_PER ELSE 0 END),
	UGST_PER = (CASE WHEN TARGETSTATE = SOURCESTATE AND UTI_FLAG = 1 THEN S.UGST_PER ELSE 0 END),
	STATE_CODE = S.STATE_CODE 
FROM NSEFO.DBO.TBL_STATE_GST_DATA S
WHERE STATE_NAME = SOURCESTATE
AND VDT BETWEEN EFF_FROM_DATE AND EFF_TO_DATE

SELECT L.* INTO #SGSTLED FROM #LEDGER L, #FINDATA F 
WHERE L.VDT = F.VDT 
  AND L.VNO = F.VNO
  AND L.VTYP = F.VTYP
  AND L.BOOKTYPE = L.BOOKTYPE
  AND L.CLTCODE = @SPLITCODE
  AND (SGST_PER + UGST_PER) > 0 

UPDATE #SGSTLED SET CLTCODE = ACCODE, VAMT = ROUND(VAMT * SGST_PER / GST_PER,4), 
LNO = #SGSTLED.LNO + 1
FROM NSEFO.DBO.VALANACCOUNT V, #FINDATA F
WHERE #SGSTLED.VDT = F.VDT 
  AND #SGSTLED.VNO = F.VNO
  AND #SGSTLED.VTYP = F.VTYP
  AND #SGSTLED.BOOKTYPE = F.BOOKTYPE
  AND V.ACNAME = STATE_CODE + '_SGST'
  AND SGST_PER > 0 

UPDATE #SGSTLED SET CLTCODE = ACCODE, VAMT = ROUND(VAMT * UGST_PER / GST_PER,4), 
LNO = #SGSTLED.LNO + 1
FROM NSEFO.DBO.VALANACCOUNT V, #FINDATA F
WHERE #SGSTLED.VDT = F.VDT 
  AND #SGSTLED.VNO = F.VNO
  AND #SGSTLED.VTYP = F.VTYP
  AND #SGSTLED.BOOKTYPE = F.BOOKTYPE
  AND V.ACNAME = STATE_CODE + '_UGST'
  AND UGST_PER > 0
  
UPDATE #LEDGER SET VAMT = #LEDGER.VAMT - F.VAMT
FROM #SGSTLED F
WHERE #LEDGER.VDT = F.VDT 
  AND #LEDGER.VNO = F.VNO
  AND #LEDGER.VTYP = F.VTYP
  AND #LEDGER.BOOKTYPE = F.BOOKTYPE
  AND #LEDGER.CLTCODE = @SPLITCODE

UPDATE #LEDGER SET CLTCODE = ACCODE
FROM NSEFO.DBO.VALANACCOUNT V, #FINDATA F
WHERE #LEDGER.VDT = F.VDT 
  AND #LEDGER.VNO = F.VNO
  AND #LEDGER.VTYP = F.VTYP
  AND #LEDGER.BOOKTYPE = F.BOOKTYPE
  AND V.ACNAME = STATE_CODE + '_CGST'
  AND CGST_PER > 0 
  AND #LEDGER.CLTCODE = @SPLITCODE

UPDATE #LEDGER SET CLTCODE = ACCODE
FROM NSEFO.DBO.VALANACCOUNT V, #FINDATA F
WHERE #LEDGER.VDT = F.VDT 
  AND #LEDGER.VNO = F.VNO
  AND #LEDGER.VTYP = F.VTYP
  AND #LEDGER.BOOKTYPE = F.BOOKTYPE
  AND V.ACNAME = STATE_CODE + '_IGST'
  AND IGST_PER > 0 
  AND #LEDGER.CLTCODE = @SPLITCODE

INSERT INTO #LEDGER 
SELECT * FROM #SGSTLED

UPDATE #LEDGER SET ACNAME = A.ACNAME
FROM ACMAST A 
WHERE A.CLTCODE = #LEDGER.CLTCODE

DECLARE @CRVAMT MONEY
DECLARE @DRVAMT MONEY
DECLARE @CRVAMT_NEW MONEY
DECLARE @DRVAMT_NEW MONEY

SET @CRVAMT = 0 
SET @DRVAMT = 0 
SET @CRVAMT_NEW = 0 
SET @DRVAMT_NEW = 0 

SELECT @CRVAMT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),
	   @DRVAMT = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END)
FROM LEDGER
WHERE VDT >= @GSTDATE
AND EXISTS (SELECT VNO FROM #LEDGER
			  WHERE LEDGER.VNO = #LEDGER.VNO
			  AND	LEDGER.VTYP = #LEDGER.VTYP
			  AND   LEDGER.BOOKTYPE = #LEDGER.BOOKTYPE)

SELECT @CRVAMT_NEW = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),
	   @DRVAMT_NEW = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END)
FROM #LEDGER 

IF @CRVAMT = @CRVAMT_NEW AND @DRVAMT = @DRVAMT_NEW
BEGIN
	DELETE FROM LEDGER
	WHERE VDT >= @GSTDATE
	AND EXISTS (SELECT VNO FROM #LEDGER
				  WHERE LEDGER.VNO = #LEDGER.VNO
				  AND	LEDGER.VTYP = #LEDGER.VTYP
				  AND   LEDGER.BOOKTYPE = #LEDGER.BOOKTYPE)

	INSERT INTO LEDGER
	SELECT Vtyp,Vno,Edt,Lno,Acname,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration 
	FROM #LEDGER 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.IMPORTOPENINGBAL
-- --------------------------------------------------


--EXEC IMPORTOPENINGBAL 'D:\BACKOFFICE\OPENINGBALANE\OPENING.CSV', 'ASHOKS'
CREATE PROC IMPORTOPENINGBAL
(  
      @FILENAME VARCHAR(500),  
      @UPLOADBY VARCHAR(100)  
)  
AS  
  
DECLARE     
      @@ERROR_COUNT INT  
  
BEGIN TRAN  
  
CREATE TABLE [#OPENING_BALANCE_LNO]    
(    
SNO INT ,    
LNO INT IDENTITY (1, 1) NOT NULL    
) ON [PRIMARY]    
  
UPDATE     
 V2_OPENING_BALANCE     
 SET    
                  BRANCHCODE = A.BRANCHCODE,  
  FYSTART = P.SDTCUR,      
  FYEND = P.LDTCUR,    
  UPDFLAG = 'Y',    
  ACNAME = LONGNAME,     
  COSTCODE = C.COSTCODE    
      FROM ACMAST A, PARAMETER P, COSTMAST C        
      WHERE A.CLTCODE = V2_OPENING_BALANCE.CLTCODE     
      AND P.CURYEAR = 1     
      AND A.BRANCHCODE = C.COSTNAME    
  
UPDATE     
 V2_OPENING_BALANCE     
 SET    
                  BRANCHCODE = 'HO',  
  FYSTART = P.SDTCUR,      
  FYEND = P.LDTCUR,    
  UPDFLAG = 'Y',    
  ACNAME = LONGNAME,     
  COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  
      FROM ACMAST A, PARAMETER P  
      WHERE A.CLTCODE = V2_OPENING_BALANCE.CLTCODE     
      AND P.CURYEAR = 1     
      AND A.BRANCHCODE = 'ALL'  
  
  
/* '--------------------------DECLARATION OF VARIABLES FOR VALIDATIONS ------------------------*/   
  
      DECLARE     
            @@STD_DATE VARCHAR(11),    
            @@LST_DATE VARCHAR(11),    
            @@VNOMETHOD INT,     
            @@ACNAME CHAR(100),     
            @@BOOKTYPE CHAR(2),     
            @@MICRNO VARCHAR(10),    
            @@DRCR VARCHAR(1),    
            @@VTYP SMALLINT,  
            @@MONTHLYVDT  VARCHAR(11),  
            @@BACKDAYS SMALLINT,  
            @@BACKDATE VARCHAR(11)  
  
  
/* '--------------------------UPDATE OF COST CODE ------------------------*/   
  
UPDATE V2_OPENING_BALANCE   
 SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')   
WHERE COSTCODE IS NULL   
  
/*--------------------------VALIDATION FOR AMOUNT SHOLD NOT BE ZERO OR NEGATIVE------------------------*/    
  
SELECT @@ERROR_COUNT = COUNT(1) FROM  
         (SELECT AMOUNT   
 FROM V2_OPENING_BALANCE    
         WHERE AMOUNT <= 0) A  
  
IF @@ERROR_COUNT > 0      
 BEGIN      
  SELECT 'VOUCHER AMOUNT CANNOT BE ZERO OR NEGATIVE.', 'NA', 'NA'     
  ROLLBACK TRAN     
  DELETE FROM V2_UPLOADED_FILES     
  WHERE U_FILENAME = @FILENAME AND U_MODULE = 'OPENING UPLOAD'     
  RETURN     
 END     
  
  
/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/    
  
SELECT @@ERROR_COUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)    
 FROM V2_OPENING_BALANCE    
  
IF @@ERROR_COUNT <> 0      
 BEGIN      
  SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.', 'NA', 'NA'     
  ROLLBACK TRAN     
  DELETE FROM V2_UPLOADED_FILES     
  WHERE U_FILENAME = @FILENAME AND U_MODULE = 'OPENING UPLOAD'     
  RETURN     
 END     
  
/*-------------------------- VALIDATION FOR DUPLICATE CLIENT_CODES EXISTS IN FILE ---------------------*/  
SELECT @@ERROR_COUNT = COUNT(1) FROM  
(  
      SELECT CLTCODE   
      FROM V2_OPENING_BALANCE    
      GROUP BY CLTCODE  
      HAVING COUNT(CLTCODE) > 1  
) A  
  
IF @@ERROR_COUNT > 0     
 BEGIN     
  SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS ARE DULICATED IN EXISTING FILE', 'NA', 'NA'    UNION ALL    
                  SELECT CLTCODE, 'NA', 'NA'      
                  FROM V2_OPENING_BALANCE    
                  GROUP BY CLTCODE  
                  HAVING COUNT(CLTCODE) > 1  
  ROLLBACK TRAN    
  DELETE FROM V2_UPLOADED_FILES    
   WHERE U_FILENAME = @FILENAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'    
  RETURN    
 END    
  
  
  
/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/   
  
SELECT @@ERROR_COUNT = COUNT(1) FROM    
(    
 SELECT DISTINCT    
  CLTCODE    
 FROM V2_OPENING_BALANCE    
 WHERE UPDFLAG = 'N'    
) A    
  
  
        
IF @@ERROR_COUNT > 0     
 BEGIN     
  SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA', 'NA'    UNION ALL    
  SELECT DISTINCT   
   CLTCODE, 'NA', 'NA'       
  FROM V2_OPENING_BALANCE    
  WHERE UPDFLAG = 'N'    
  ROLLBACK TRAN    
  DELETE FROM V2_UPLOADED_FILES    
   WHERE U_FILENAME = @FILENAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'    
  RETURN    
 END    
  
DECLARE     
 @@NEWVNO AS VARCHAR(12),  
 @@VDT AS VARCHAR(11),     
 @@LNOCUR AS CURSOR,     
 @@LNOVNO AS INT     
  
  
/* '--------------------------AUTO GENERATION OF VNO ------------------------*/   
  
SELECT     
 @@STD_DATE = LEFT(SDTCUR, 11),     
 @@LST_DATE = LEFT(LDTCUR, 11),     
 @@VNOMETHOD = VNOFLAG     
FROM PARAMETER     
WHERE CURYEAR = 1     
  
SET @@NEWVNO = (SELECT CONVERT(VARCHAR,YEAR(@@STD_DATE)) + RIGHT('0'+LTRIM(CONVERT(VARCHAR,MONTH(@@STD_DATE))),2) + RIGHT('00'+LTRIM(CONVERT(VARCHAR,DAY(@@STD_DATE))),2))+'0001'  
  
UPDATE    
 V2_OPENING_BALANCE     
 SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO))     
  
  
/* '--------------------------AUTO GENERATION OF LNO ------------------------*/   
  
  INSERT INTO #OPENING_BALANCE_LNO    
   (SNO)    
  SELECT SNO FROM V2_OPENING_BALANCE   
  UPDATE RP    
   SET LNO = RL.LNO    
  FROM V2_OPENING_BALANCE RP, #OPENING_BALANCE_LNO RL    
  WHERE RP.SNO = RL.SNO    
DROP TABLE #OPENING_BALANCE_LNO    
  
/*---------------- DELETE EXISTING OPENING BALANCE ENTRY ---------------------------*/  
  
      DELETE FROM LEDGER WHERE VNO = @@NEWVNO AND VTYP = '18' AND BOOKTYPE = '01'  
      DELETE FROM LEDGER2 WHERE VNO = @@NEWVNO AND VTYPE = '18' AND BOOKTYPE = '01'  
  
  
/* '--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------*/    
/*==============================    
      LEDGER RECORD    
==============================*/    
INSERT     
INTO LEDGER     
SELECT     
 VTYP = '18',     
 VNO,     
 EDT,     
 LNO,    
 ACNAME,     
 DRCR,    
 VAMT = AMOUNT,     
 VDT,     
 VNO1 = VNO,     
 REFNO = 0,     
 BALAMT = (CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END),     
 NODAYS = 0,     
 CDT = GETDATE(),     
 CLTCODE,     
 BOOKTYPE = '01',     
 ENTEREDBY = @UPLOADBY,     
 PDT = GETDATE(),     
 CHECKEDBY = @UPLOADBY,     
 ACTNODAYS = 0,     
 NARRATION    
FROM     
 V2_OPENING_BALANCE     
  
INSERT INTO LEDGER2  
      SELECT   
            VTYP = '18',  
            VNO,  
            LNO,  
            DRCR,  
            AMOUNT,  
            COSTCODE,  
            BOOKTYPE = '01',  
            CLTCODE  
      FROM  
            V2_OPENING_BALANCE  
  
COMMIT TRAN   
SELECT 'DATA UPLOADED SUCCESSFULLY', 'NA','NA' AS RESULT UNION ALL   
SELECT CLTCODE, CONVERT(VARCHAR, AMOUNT) , VNO AS RESULT FROM V2_OPENING_BALANCE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.INDEX_GETINDEXNAME
-- --------------------------------------------------

CREATE PROC INDEX_GETINDEXNAME AS  
DECLARE @TABLENAME VARCHAR(100),  
@CURTBL CURSOR,  
@SQL VARCHAR(150)  
  
CREATE TABLE #TBL_INDEX  
(SNO INT IDENTITY (1, 1) NOT NULL,  
 INDEXNAME VARCHAR(100) NOT NULL,  
 TABLENAME VARCHAR(100) NOT NULL)  
  
SET @CURTBL = CURSOR FOR  
SELECT NAME FROM SYSOBJECTS   
WHERE XTYPE = 'U'  
ORDER BY NAME   
OPEN @CURTBL  
FETCH NEXT FROM  @CURTBL INTO @TABLENAME  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 INSERT INTO #TBL_INDEX  

      SELECT I.NAME, TABLENAME=@TABLENAME
      FROM (DBO.SYSINDEXES I INNER JOIN
         DBO.SYSFILEGROUPS S ON
         I.GROUPID = S.GROUPID )
      WHERE ID = OBJECT_ID(@TABLENAME) AND I.INDID > 0 AND I.INDID < 255 AND
      (INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISSTATISTICS') <> 1) AND
      (INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISAUTOSTATISTICS') <> 1) AND
      (INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISHYPOTHETICAL') <> 1) 

   
 FETCH NEXT FROM  @CURTBL INTO @TABLENAME  
END  
CLOSE @CURTBL  
DEALLOCATE @CURTBL  
  
SELECT * FROM #TBL_INDEX  
ORDER BY TABLENAME, INDEXNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.INSERTTOLEDGER2
-- --------------------------------------------------
CREATE PROC [dbo].[InsertToLedger2]       
(    
      @sessionid varchar(15),      
      @vno varchar(12),      
      @branchflag tinyint,      
      @costcenterflag tinyint,      
      @costenable char(1),      
      @statusid as varchar(30),      
      @statusname as varchar(30)      
)     
    
As      
    
set nocount on    
    
declare      
      @@onlyall tinyint,      
      @@onebranch tinyint,      
      @@multibranch tinyint,      
      @@oneBranchAll tinyint,      
      @@MultiBranchall tinyint,      
      @@Allcount smallint,      
      @@Branchcount smallint,      
      @@OldBranch varchar(10),      
      @@vtype varchar(2),      
      @@party2 varchar(10),      
      @@costbreakup tinyint,      
      @@costcode1 int,      
      
/*=======================================================================================    
      Fields retrived from templedger2     
=======================================================================================*/    
      @@category varchar(20),      
      @@branch varchar(25),      
      @@amt    money,      
      @@vtyp varchar(2),      
      @@vno  varchar(12),      
      @@lno  int,      
      @@drcr char(1),      
      @@costcode smallint,      
      @@booktype varchar(2),      
      @@sessionid varchar(25),      
      @@party_code varchar(10),      
      @@mainbr as varchar(10),         
      @@rcursor as cursor      
      
if @branchflag = 1 and @costcenterflag  = 1      
begin      
/*=======================================================================================    
      0 = True   1 = False        
=======================================================================================*/    
      select @@onlyall = 0               /* True */      
      select @@onebranch = 1             /* True */      
      select @@multibranch = 1           /* False */      
      select @@onebranchall = 1          /* False */      
      select @@Multibranchall = 1        /* False */      
            
      select @@allcount = 0      
      select @@Branchcount = 0      
      select @@OldBranch = ''      
      
      SELECT @@mainbr =     
                  (    
                        SELECT     
                              BranchName     
                        FROM branchaccounts     
                        WHERE DefaultAc = 1    
                  )     
      
      SELECT @@vtype =     
                  (    
                        SELECT DISTINCT     
                              vtype     
                        FROM templedger2     
                        WHERE rtrim(sessionid) = rtrim(@sessionid)     
                              AND vno = @vno    
                  )     
         
      SELECT @@costbreakup =     
                  (    
                        SELECT     
                              count(*)     
                        FROM templedger2     
                        WHERE rtrim(sessionid) = rtrim(@sessionid)     
                              AND category = 'BRANCH'     
                              AND vno = @vno     
                              AND costflag = 'C'    
                  )     
      
      /*=======================================================================================    
            if @@vtype = 8 and @@costbreakup > 0      
      =======================================================================================*/    
      if @@costbreakup > 0      
      begin      
            DELETE t2    
            FROM templedger2 t2    
            WHERE rtrim(sessionid) = rtrim(@sessionid)     
                  AND upper(rtrim(branch)) = 'ALL'     
                  AND vno = @vno     
                  AND costflag = 'A'     
                  AND exists     
                        (     
                              SELECT     
                                    party_code     
                              FROM templedger2 t1    
                              WHERE t1.party_code = t2.party_code and t1.lno = t2.lno and t1.costflag = 'C'    
        )     
    
            DELETE t2    
            FROM templedger2 t2    
            WHERE rtrim(sessionid) = rtrim(@sessionid)     
                  AND vno = @vno     
                  AND costflag = 'C'     
       AND exists     
                        (     
                              SELECT     
                                    party_code     
                              FROM templedger2 t1    
                              WHERE t1.party_code = t2.party_code and t1.lno = t2.lno and t1.costflag = 'A' and upper(rtrim(t1.branch)) <> 'ALL'    
                        )     
    
  end  
    
            UPDATE     
                  templedger2     
                  SET costflag = 'A'     
          
            if @@vtype = 5 or @@vtype = 6 or @@vtype = 7 or @@vtype = 8 or @@vtype = 24      
            begin      
                  UPDATE     
                    templedger2     
                        SET branch = 'HO'     
                  WHERE upper(rtrim(branch)) = 'ALL'     
                        AND costflag = 'A'     
                  
      end      
      
      set @@rcursor = cursor for      
            SELECT     
                  category,    
                  branch,    
                  paidamt,    
                  vtype,    
                  vno,    
                  lno,    
                  drcr,    
                  costcode,    
                  booktype,    
                  sessionid,    
                  party_code     
            FROM templedger2     
            WHERE category = 'BRANCH'     
                  AND rtrim(sessionid) = rtrim(@sessionid)     
                  AND vno =@vno     
                  AND costflag = 'A'     
      open @@rcursor      
      fetch next from @@rcursor       
      into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code       
      
      while @@fetch_status = 0      
      begin      
            if rtrim(@@branch) = 'ALL'      
            begin      
                  select @@Allcount = @@Allcount + 1      
            end      
            else       
            if rtrim(@@branch) = @@OldBranch      
            begin      
                  select @@OnlyAll = 1      
            end      
            else      
            if @@OldBranch = ''      
            begin      
                  select @@OnlyAll = 1      
                  select @@OldBranch = rtrim(@@branch)      
                  select @@Branchcount = @@Branchcount + 1      
            end      
            else       
            begin      
                  select @@OnlyAll = 1      
                  select @@Branchcount = @@Branchcount + 1      
                  select @@Multibranch = 0      
                  select @@OneBranch = 1                 
            end      
                
            fetch next from @@rcursor       
            into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code       
      end      
      close @@rcursor      
      deallocate @@rcursor      
      
/*      select "AllCount = " + convert(varchar,@@Allcount)      
      select "BranchCount = " + convert(varchar,@@BranchCount)  */    
      
      if @@onlyall = 1      
      begin      
            if @@Allcount = 0      
            begin      
                  if @@branchcount = 1      
                  begin      
                        select @@onebranch = 0      
                        select @@multibranch = 1      
                        select @@oneBranchAll = 1      
                        select @@MultiBranchall = 1      
                  end      
                  else      
                  begin      
                        select @@Multibranch = 0      
                        select @@onebranch = 1      
                        select @@oneBranchAll = 1      
                        select @@MultiBranchall = 1      
                  end      
            end      
            else      
            begin      
           if @@branchcount = 1      
                  begin      
                        select @@onebranchAll = 0      
                        select @@onebranch = 1      
                        select @@multibranch = 1      
                        select @@MultiBranchall = 1      
                  end      
                  else      
                  begin      
                        select @@MultibranchAll = 0      
          select @@onebranch = 1      
                        select @@multibranch = 1      
                        select @@onebranchAll = 1      
                  end      
            end      
      end      
      
      if @@Onlyall = 0       
      begin      
            SELECT     
                  @@vtype =     
                        (    
                              SELECT DISTINCT     
                                    vtype     
                              FROM templedger2     
                              WHERE rtrim(sessionid) = rtrim(@sessionid)     
                                    AND vno = @vno    
        )     
                  SELECT     
                  @@party2 =     
                        (    
                              SELECT DISTINCT     
                                    party_code     
                              FROM templedger2     
                              WHERE rtrim(sessionid) = rtrim(@sessionid)     
                                    AND upper(rtrim(branch)) = 'ALL'     
                                    AND vno = @vno     
                                    AND costflag = 'A'     
                                    AND lno = 1    
                        )     
            SELECT     
                  @@costbreakup =     
                        (    
                              SELECT     
                                    count(*)     
                              FROM templedger2     
                              WHERE rtrim(sessionid) = rtrim(@sessionid)     
                                    AND category = 'BRANCH'     
                                    AND vno = @vno     
                                    AND costflag = 'C'    
                        )     
          
            if @@costbreakup > 0 and (@@vtype = '3' or @@vtype = '4')       
            begin      
                  DELETE     
                  FROM templedger2     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND category = 'BRANCH'     
                        AND upper(branch) = 'ALL'     
                        AND vno = @vno     
                        AND costflag = 'A'     
          
                  DELETE     
                  FROM templedger2     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND category = 'BRANCH'     
                        AND upper(drcr) = 'C'     
                        AND vno = @vno     
                        AND costflag = 'C'     
          
                  INSERT     
                  INTO templedger2     
                  SELECT     
                        category,     
                        branch,     
                        paidamt,     
                        vtype,     
                        vno,     
                        1,     
                        (     
                              CASE     
                                    WHEN drcr = 'D'     
                                    THEN 'C'     
                                    ELSE 'D'     
                              END    
                        ),     
                        costcode,     
                        booktype,     
                        sessionid,     
                        @@party2,     
                        costflag,     
                        1     
                  FROM templedger2     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND category = 'BRANCH'     
                        AND vno = @vno     
            end      
if @@costbreakup > 0 and (@@vtype = '1' or @@vtype = '2' )      
            begin      
                  DELETE     
                  FROM templedger2     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND category = 'BRANCH'     
                        AND upper(branch) = 'ALL'     
                        AND vno = @vno     
                        AND costflag = 'A'     
          
                  DELETE     
                  FROM templedger2     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND category = 'BRANCH'     
        AND upper(drcr) = 'D'     
                        AND vno = @vno     
                        AND costflag = 'C'     
          
                  INSERT     
                  INTO templedger2     
                  SELECT     
                        category,     
                        branch,     
                        paidamt,     
                        vtype,     
                        vno,     
                        1,     
                        (     
                              CASE     
                                    WHEN drcr = 'D'     
                                    THEN 'C'     
                           ELSE 'D'     
                              END    
                        ),     
                        costcode,     
                        booktype,     
                        sessionid,     
                        @@party2,     
                        costflag,     
                        1     
                  FROM templedger2     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND category = 'BRANCH'     
                        AND vno = @vno     
            end      
      end      
      
      
      if @@Onlyall = 0       
      begin       
            if @statusid = 'BRANCH'       
            begin      
                  INSERT     
                  INTO ledger2     
                  SELECT     
                        vtype,     
                        vno,     
                        lno,     
                        drcr,     
                        paidamt,     
                        c.costcode,     
                        BookType,    
                        upper(party_code)     
                  FROM templedger2 t,     
                        costmast c     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND rtrim(costname) = rtrim(@statusname)     
                        AND category = 'BRANCH'     
                        AND vno =@vno     
                        AND costflag = 'A'     
            end      
            else      
            begin      
                  INSERT     
                  INTO ledger2     
                  SELECT     
                        vtype,     
                        vno,     
                        lno,     
                        drcr,     
                        paidamt,     
                        c.costcode,     
                        BookType,    
                        upper(party_code)     
                  FROM templedger2 t,     
                        Branchaccounts b,     
                        costmast c     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND DefaultAc = 1     
                        AND rtrim(BranchName) = rtrim(costname)     
                        AND category = 'BRANCH'     
                        AND vno =@vno     
                        AND costflag = 'A'     
            end      
      end      
      else      
      if @@OneBranch = 0      
      begin      
            INSERT     
            INTO ledger2     
            SELECT     
                  vtype,     
                  vno,     
                  lno,     
                  drcr,     
                  paidamt,     
                  c.costcode,     
                  BookType,     
                  upper(party_code )     
            FROM templedger2 t,     
                  costmast c     
            WHERE rtrim(sessionid) = rtrim(@sessionid)     
                  AND rtrim(branch) = rtrim(costname)     
                  AND category = 'BRANCH'     
                  AND vno =@vno     
                  AND costflag = 'A'     
      end      
      else      
      if @@MultiBranch = 0      
      Begin      
            INSERT     
            INTO ledger2     
            SELECT     
                  vtype,     
                  vno,     
                  lno,     
                  drcr,     
                  paidamt,     
                  c.costcode,     
                  BookType,     
                  upper(party_code)     
            FROM templedger2 t,     
                  costmast c     
            WHERE rtrim(sessionid) = rtrim(@sessionid)     
                  AND rtrim(branch) = rtrim(costname)     
                  AND category = 'BRANCH'     
                  AND vno =@vno     
                  AND costflag = 'A'     
          
            INSERT     
            INTO ledger2     
            SELECT     
                  vtype,     
                  vno,     
                  lno,     
                  drcr,     
                  paidamt,     
                  costcode=     
                        (     
                              SELECT     
                                    costcode     
                              FROM costmast c,     
 branchaccounts b     
                              WHERE DefaultAc = 1     
                                    AND rtrim(branchname) = rtrim(costname)    
                        ),     
                  BookType,     
                  upper(BrControlAc)     
            FROM templedger2 t,     
                  branchaccounts b     
            WHERE rtrim(sessionid) = rtrim(@sessionid)     
                  AND rtrim(branch) = rtrim(branchname)     
                  AND category = 'BRANCH'     
                  AND vno =@vno     
                  AND costflag = 'A'     
                  AND rtrim(branch) <> rtrim(@@mainbr)     
          
            INSERT     
            INTO ledger2     
            SELECT     
                  vtype,     
                  vno,     
                  lno,     
                  (     
                        CASE     
                              WHEN drcr= 'd'     
                              OR drcr = 'D'     
                              THEN 'C'     
                              ELSE 'D'     
                        END    
                  ),     
                  paidamt,     
                  c.costcode,     
                  BookType,     
                  upper(MainControlAc)     
            FROM templedger2 t,     
                  costmast c,     
                  branchaccounts b     
            WHERE rtrim(sessionid) = rtrim(@sessionid)     
                  AND rtrim(branch) = rtrim(costname)     
                  AND rtrim(BranchName) = rtrim(branch)     
                  AND category = 'BRANCH'     
                  AND vno =@vno     
                  AND costflag = 'A'     
                  AND rtrim(branch) <> rtrim(@@mainbr)     
      end      
      else      
      if @@OneBranchAll = 0       
      begin      
      set @@rcursor = cursor for      
            SELECT     
                  branch     
            FROM templedger2     
            WHERE category = 'BRANCH'     
                  AND rtrim(sessionid) = rtrim(@sessionid)     
                  AND vno = @vno     
                  AND branch <> 'ALL'     
                  AND costflag = 'A'     
            ORDER BY branch     
            open @@rcursor      
            fetch next from @@rcursor into @@branch       
            while @@fetch_status = 0      
            begin      
            SELECT @@costcode1 =     
                        (     
                              SELECT     
                                    costcode     
                              FROM costmast     
                              WHERE rtrim(@@branch) = rtrim(costname)    
                        )     
                  fetch next from @@rcursor into @@branch       
                  end      
                  close @@rcursor      
                  deallocate @@rcursor      
                
                  INSERT     
                  INTO ledger2     
                  SELECT     
                        vtype,     
                        vno,     
                        lno,     
                        drcr,     
                        paidamt,     
                        c.costcode,     
                        BookType,     
                        upper(party_code)     
                  FROM templedger2 t,     
                        costmast c     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND rtrim(branch) = rtrim(costname)     
                        AND category = 'BRANCH'     
                        AND vno =@vno     
                        AND costflag = 'A'     
                
                  INSERT     
                  INTO ledger2     
                  SELECT     
                        vtype,     
                        vno,     
                        lno,     
                        drcr,     
                        paidamt,     
                        @@costcode1,     
                        BookType,     
                        upper(party_code)     
                  FROM templedger2 t     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND rtrim(branch) = 'ALL'     
                        AND category = 'BRANCH'     
                        AND vno =@vno     
                        AND costflag = 'A'     
            end      
      end      
      
      if @costcenterflag  = 1      
      begin      
            INSERT     
            INTO ledger2     
            SELECT     
                  vtype,     
                  @vno,     
                  lno,     
                  drcr,     
                  paidamt,     
                  costcode,     
                  BookType,    
                  upper(party_code )     
            FROM templedger2 t     
            WHERE rtrim(sessionid) = rtrim(@sessionid)     
                  AND vno = @vno     
                  AND costflag = 'C'     
      end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.InsertToLedger2_19122011
-- --------------------------------------------------
CREATE PROC [dbo].[InsertToLedger2_19122011]       
(    
      @sessionid varchar(15),      
      @vno varchar(12),      
      @branchflag tinyint,      
      @costcenterflag tinyint,      
      @costenable char(1),      
      @statusid as varchar(30),      
      @statusname as varchar(30)      
)     
    
As      
    
set nocount on    
    
declare      
      @@onlyall tinyint,      
      @@onebranch tinyint,      
      @@multibranch tinyint,      
      @@oneBranchAll tinyint,      
      @@MultiBranchall tinyint,      
      @@Allcount smallint,      
      @@Branchcount smallint,      
      @@OldBranch varchar(10),      
      @@vtype varchar(2),      
      @@party2 varchar(10),      
      @@costbreakup tinyint,      
      @@costcode1 int,      
      
/*=======================================================================================    
      Fields retrived from templedger2     
=======================================================================================*/    
      @@category varchar(20),      
      @@branch varchar(25),      
      @@amt    money,      
      @@vtyp varchar(2),      
      @@vno  varchar(12),      
      @@lno  int,      
      @@drcr char(1),      
      @@costcode smallint,      
      @@booktype varchar(2),      
      @@sessionid varchar(25),      
      @@party_code varchar(10),      
      @@mainbr as varchar(10),         
      @@rcursor as cursor      
      
if @branchflag = 1 and @costcenterflag  = 1      
begin      
/*=======================================================================================    
      0 = True   1 = False        
=======================================================================================*/    
      select @@onlyall = 0               /* True */      
      select @@onebranch = 1             /* True */      
      select @@multibranch = 1           /* False */      
      select @@onebranchall = 1          /* False */      
      select @@Multibranchall = 1        /* False */      
            
      select @@allcount = 0      
      select @@Branchcount = 0      
      select @@OldBranch = ''      
      
      SELECT @@mainbr =     
                  (    
                        SELECT     
                              BranchName     
                        FROM branchaccounts     
                        WHERE DefaultAc = 1    
                  )     
      
      SELECT @@vtype =     
                  (    
                        SELECT DISTINCT     
                              vtype     
                        FROM templedger2     
                        WHERE rtrim(sessionid) = rtrim(@sessionid)     
                              AND vno = @vno    
                  )     
         
      SELECT @@costbreakup =     
                  (    
                        SELECT     
                              count(*)     
                        FROM templedger2     
                        WHERE rtrim(sessionid) = rtrim(@sessionid)     
                              AND category = 'BRANCH'     
                              AND vno = @vno     
                              AND costflag = 'C'    
                  )     
      
      /*=======================================================================================    
            if @@vtype = 8 and @@costbreakup > 0      
      =======================================================================================*/    
      if @@costbreakup > 0      
      begin      
            DELETE t2    
            FROM templedger2 t2    
            WHERE rtrim(sessionid) = rtrim(@sessionid)     
                  AND upper(rtrim(branch)) = 'ALL'     
                  AND vno = @vno     
                  AND costflag = 'A'     
                  AND exists     
                        (     
                              SELECT     
                                    party_code     
                              FROM templedger2 t1    
                              WHERE t1.party_code = t2.party_code and t1.lno = t2.lno and t1.costflag = 'C'    
        )     
    
            DELETE t2    
            FROM templedger2 t2    
            WHERE rtrim(sessionid) = rtrim(@sessionid)     
                  AND vno = @vno     
                  AND costflag = 'C'     
       AND exists     
                        (     
                              SELECT     
                                    party_code     
                              FROM templedger2 t1    
                              WHERE t1.party_code = t2.party_code and t1.lno = t2.lno and t1.costflag = 'A' and upper(rtrim(t1.branch)) <> 'ALL'    
                        )     
    
  end  
    
            UPDATE     
                  templedger2     
                  SET costflag = 'A'     
          
            if @@vtype = 5 or @@vtype = 6 or @@vtype = 7 or @@vtype = 8 or @@vtype = 24      
            begin      
                  UPDATE     
                    templedger2     
                        SET branch = 'HO'     
                  WHERE upper(rtrim(branch)) = 'ALL'     
                        AND costflag = 'A'     
                  
      end      
      
      set @@rcursor = cursor for      
            SELECT     
                  category,    
                  branch,    
                  paidamt,    
                  vtype,    
                  vno,    
                  lno,    
                  drcr,    
                  costcode,    
                  booktype,    
                  sessionid,    
                  party_code     
            FROM templedger2     
            WHERE category = 'BRANCH'     
                  AND rtrim(sessionid) = rtrim(@sessionid)     
                  AND vno =@vno     
                  AND costflag = 'A'     
      open @@rcursor      
      fetch next from @@rcursor       
      into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code       
      
      while @@fetch_status = 0      
      begin      
            if rtrim(@@branch) = 'ALL'      
            begin      
                  select @@Allcount = @@Allcount + 1      
            end      
            else       
            if rtrim(@@branch) = @@OldBranch      
            begin      
                  select @@OnlyAll = 1      
            end      
            else      
            if @@OldBranch = ''      
            begin      
                  select @@OnlyAll = 1      
                  select @@OldBranch = rtrim(@@branch)      
                  select @@Branchcount = @@Branchcount + 1      
            end      
            else       
            begin      
                  select @@OnlyAll = 1      
                  select @@Branchcount = @@Branchcount + 1      
                  select @@Multibranch = 0      
                  select @@OneBranch = 1                 
            end      
                
            fetch next from @@rcursor       
            into @@category, @@branch, @@amt, @@vtyp, @@vno, @@lno, @@drcr, @@costcode, @@booktype, @@sessionid , @@party_code       
      end      
      close @@rcursor      
      deallocate @@rcursor      
      
/*      select "AllCount = " + convert(varchar,@@Allcount)      
      select "BranchCount = " + convert(varchar,@@BranchCount)  */    
      
      if @@onlyall = 1      
      begin      
            if @@Allcount = 0      
            begin      
                  if @@branchcount = 1      
                  begin      
                        select @@onebranch = 0      
                        select @@multibranch = 1      
                        select @@oneBranchAll = 1      
                        select @@MultiBranchall = 1      
                  end      
                  else      
                  begin      
                        select @@Multibranch = 0      
                        select @@onebranch = 1      
                        select @@oneBranchAll = 1      
                        select @@MultiBranchall = 1      
                  end      
            end      
            else      
            begin      
           if @@branchcount = 1      
                  begin      
                        select @@onebranchAll = 0      
                        select @@onebranch = 1      
                        select @@multibranch = 1      
                        select @@MultiBranchall = 1      
                  end      
                  else      
                  begin      
                        select @@MultibranchAll = 0      
          select @@onebranch = 1      
                        select @@multibranch = 1      
                        select @@onebranchAll = 1      
                  end      
            end      
      end      
      
      if @@Onlyall = 0       
      begin      
            SELECT     
                  @@vtype =     
                        (    
                              SELECT DISTINCT     
                                    vtype     
                              FROM templedger2     
                              WHERE rtrim(sessionid) = rtrim(@sessionid)     
                                    AND vno = @vno    
        )     
                  SELECT     
                  @@party2 =     
                        (    
                              SELECT DISTINCT     
                                    party_code     
                              FROM templedger2     
                              WHERE rtrim(sessionid) = rtrim(@sessionid)     
                                    AND upper(rtrim(branch)) = 'ALL'     
                                    AND vno = @vno     
                                    AND costflag = 'A'     
                                    AND lno = 1    
                        )     
            SELECT     
                  @@costbreakup =     
                        (    
                              SELECT     
                                    count(*)     
                              FROM templedger2     
                              WHERE rtrim(sessionid) = rtrim(@sessionid)     
                                    AND category = 'BRANCH'     
                                    AND vno = @vno     
                                    AND costflag = 'C'    
                        )     
          
            if @@costbreakup > 0 and (@@vtype = '3' or @@vtype = '4')       
            begin      
                  DELETE     
                  FROM templedger2     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND category = 'BRANCH'     
                        AND upper(branch) = 'ALL'     
                        AND vno = @vno     
                        AND costflag = 'A'     
          
                  DELETE     
                  FROM templedger2     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND category = 'BRANCH'     
                        AND upper(drcr) = 'C'     
                        AND vno = @vno     
                        AND costflag = 'C'     
          
                  INSERT     
                  INTO templedger2     
                  SELECT     
                        category,     
                        branch,     
                        paidamt,     
                        vtype,     
                        vno,     
                        1,     
                        (     
                              CASE     
                                    WHEN drcr = 'D'     
                                    THEN 'C'     
                                    ELSE 'D'     
                              END    
                        ),     
                        costcode,     
                        booktype,     
                        sessionid,     
                        @@party2,     
                        costflag,     
                        1     
                  FROM templedger2     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND category = 'BRANCH'     
                        AND vno = @vno     
            end      
if @@costbreakup > 0 and (@@vtype = '1' or @@vtype = '2' )      
            begin      
                  DELETE     
                  FROM templedger2     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND category = 'BRANCH'     
                        AND upper(branch) = 'ALL'     
                        AND vno = @vno     
                        AND costflag = 'A'     
          
                  DELETE     
                  FROM templedger2     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND category = 'BRANCH'     
        AND upper(drcr) = 'D'     
                        AND vno = @vno     
                        AND costflag = 'C'     
          
                  INSERT     
                  INTO templedger2     
                  SELECT     
                        category,     
                        branch,     
                        paidamt,     
                        vtype,     
                        vno,     
                        1,     
                        (     
                              CASE     
                                    WHEN drcr = 'D'     
                                    THEN 'C'     
                           ELSE 'D'     
                              END    
                        ),     
                        costcode,     
                        booktype,     
                        sessionid,     
                        @@party2,     
                        costflag,     
                        1     
                  FROM templedger2     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND category = 'BRANCH'     
                        AND vno = @vno     
            end      
      end      
      
      
      if @@Onlyall = 0       
      begin       
            if @statusid = 'BRANCH'       
            begin      
                  INSERT     
                  INTO ledger2     
                  SELECT     
                        vtype,     
                        vno,     
                        lno,     
                        drcr,     
                        paidamt,     
                        c.costcode,     
                        BookType,    
                        upper(party_code)     
                  FROM templedger2 t,     
                        costmast c     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND rtrim(costname) = rtrim(@statusname)     
                        AND category = 'BRANCH'     
                        AND vno =@vno     
                        AND costflag = 'A'     
            end      
            else      
            begin      
                  INSERT     
                  INTO ledger2     
                  SELECT     
                        vtype,     
                        vno,     
                        lno,     
                        drcr,     
                        paidamt,     
                        c.costcode,     
                        BookType,    
                        upper(party_code)     
                  FROM templedger2 t,     
                        Branchaccounts b,     
                        costmast c     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND DefaultAc = 1     
                        AND rtrim(BranchName) = rtrim(costname)     
                        AND category = 'BRANCH'     
                        AND vno =@vno     
                        AND costflag = 'A'     
            end      
      end      
      else      
      if @@OneBranch = 0      
      begin      
            INSERT     
            INTO ledger2     
            SELECT     
                  vtype,     
                  vno,     
                  lno,     
                  drcr,     
                  paidamt,     
                  c.costcode,     
                  BookType,     
                  upper(party_code )     
            FROM templedger2 t,     
                  costmast c     
            WHERE rtrim(sessionid) = rtrim(@sessionid)     
                  AND rtrim(branch) = rtrim(costname)     
                  AND category = 'BRANCH'     
                  AND vno =@vno     
                  AND costflag = 'A'     
      end      
      else      
      if @@MultiBranch = 0      
      Begin      
            INSERT     
            INTO ledger2     
            SELECT     
                  vtype,     
                  vno,     
                  lno,     
                  drcr,     
                  paidamt,     
                  c.costcode,     
                  BookType,     
                  upper(party_code)     
            FROM templedger2 t,     
                  costmast c     
            WHERE rtrim(sessionid) = rtrim(@sessionid)     
                  AND rtrim(branch) = rtrim(costname)     
                  AND category = 'BRANCH'     
                  AND vno =@vno     
                  AND costflag = 'A'     
          
            INSERT     
            INTO ledger2     
            SELECT     
                  vtype,     
                  vno,     
                  lno,     
                  drcr,     
                  paidamt,     
                  costcode=     
                        (     
                              SELECT     
                                    costcode     
                              FROM costmast c,     
 branchaccounts b     
                              WHERE DefaultAc = 1     
                                    AND rtrim(branchname) = rtrim(costname)    
                        ),     
                  BookType,     
                  upper(BrControlAc)     
            FROM templedger2 t,     
                  branchaccounts b     
            WHERE rtrim(sessionid) = rtrim(@sessionid)     
                  AND rtrim(branch) = rtrim(branchname)     
                  AND category = 'BRANCH'     
                  AND vno =@vno     
                  AND costflag = 'A'     
                  AND rtrim(branch) <> rtrim(@@mainbr)     
          
            INSERT     
            INTO ledger2     
            SELECT     
                  vtype,     
                  vno,     
                  lno,     
                  (     
                        CASE     
                              WHEN drcr= 'd'     
                              OR drcr = 'D'     
                              THEN 'C'     
                              ELSE 'D'     
                        END    
                  ),     
                  paidamt,     
                  c.costcode,     
                  BookType,     
                  upper(MainControlAc)     
            FROM templedger2 t,     
                  costmast c,     
                  branchaccounts b     
            WHERE rtrim(sessionid) = rtrim(@sessionid)     
                  AND rtrim(branch) = rtrim(costname)     
                  AND rtrim(BranchName) = rtrim(branch)     
                  AND category = 'BRANCH'     
                  AND vno =@vno     
                  AND costflag = 'A'     
                  AND rtrim(branch) <> rtrim(@@mainbr)     
      end      
      else      
      if @@OneBranchAll = 0       
      begin      
      set @@rcursor = cursor for      
            SELECT     
                  branch     
            FROM templedger2     
            WHERE category = 'BRANCH'     
                  AND rtrim(sessionid) = rtrim(@sessionid)     
                  AND vno = @vno     
                  AND branch <> 'ALL'     
                  AND costflag = 'A'     
            ORDER BY branch     
            open @@rcursor      
            fetch next from @@rcursor into @@branch       
            while @@fetch_status = 0      
            begin      
            SELECT @@costcode1 =     
                        (     
                              SELECT     
                                    costcode     
                              FROM costmast     
                              WHERE rtrim(@@branch) = rtrim(costname)    
                        )     
                  fetch next from @@rcursor into @@branch       
                  end      
                  close @@rcursor      
                  deallocate @@rcursor      
                
                  INSERT     
                  INTO ledger2     
                  SELECT     
                        vtype,     
                        vno,     
                        lno,     
                        drcr,     
                        paidamt,     
                        c.costcode,     
                        BookType,     
                        upper(party_code)     
                  FROM templedger2 t,     
                        costmast c     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND rtrim(branch) = rtrim(costname)     
                        AND category = 'BRANCH'     
                        AND vno =@vno     
                        AND costflag = 'A'     
                
                  INSERT     
                  INTO ledger2     
                  SELECT     
                        vtype,     
                        vno,     
                        lno,     
                        drcr,     
                        paidamt,     
                        @@costcode1,     
                        BookType,     
                        upper(party_code)     
                  FROM templedger2 t     
                  WHERE rtrim(sessionid) = rtrim(@sessionid)     
                        AND rtrim(branch) = 'ALL'     
                        AND category = 'BRANCH'     
                        AND vno =@vno     
                        AND costflag = 'A'     
            end      
      end      
      
      if @costcenterflag  = 1      
      begin      
            INSERT     
            INTO ledger2     
            SELECT     
                  vtype,     
                  @vno,     
                  lno,     
                  drcr,     
                  paidamt,     
                  costcode,     
                  BookType,    
                  upper(party_code )     
            FROM templedger2 t     
            WHERE rtrim(sessionid) = rtrim(@sessionid)     
                  AND vno = @vno     
                  AND costflag = 'C'     
      end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.KOTAK_RECO
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[KOTAK_RECO]
	@BANKCODE VARCHAR(10),
	@FILE_NAME VARCHAR(1000),
	@BOOKDATE VARCHAR(11) = ''
AS
	

CREATE TABLE #KOTAK_FILE
(
	FILE_DATA VARCHAR(MAX)
)

DECLARE
	@@SQL VARCHAR(MAX)

SET @@SQL = "INSERT INTO #KOTAK_FILE(FILE_DATA) "
SET @@SQL = @@SQL + "exec master.dbo.xp_cmdshell 'type " + @FILE_NAME + "'"

EXEC (@@SQL)

DELETE FROM #KOTAK_FILE WHERE FILE_DATA IS NULL

ALTER TABLE #KOTAK_FILE
ADD SRNO INT IDENTITY(1, 1)

DELETE FROM #KOTAK_FILE WHERE SRNO <= 13

DELETE FROM #KOTAK_FILE WHERE RTRIM(LEFT(FILE_DATA, 3)) = ''

ALTER TABLE #KOTAK_FILE
ADD 
	CROSSREFERENCENO INT,
	STATUS VARCHAR(50)


DECLARE
	@@CROSSREFERENCENO INT,
	@@VDT VARCHAR(11),
	@@PAYINT_DATE VARCHAR(11)
	
SELECT TOP 1 @@VDT = 	CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), 109) FROM #KOTAK_FILE

DECLARE
	@@ROW_C INT

SELECT @@ROW_C = COUNT(1) FROM BANKRECO WHERE CLTCODE = @BANKCODE AND BOOKDATE LIKE @@VDT + '%'

IF @@ROW_C > 0
BEGIN
	SELECT 'STATEMENT ALREADY UPLOADED.'
	RETURN
END

SELECT @@CROSSREFERENCENO = MAX(CROSSREFERENCENO) FROM BANKRECO

UPDATE #KOTAK_FILE SET CROSSREFERENCENO = @@CROSSREFERENCENO + CONVERT(INT, .DBO.PIECE(FILE_DATA, ',', 1))

SELECT TOP 1 @@PAYINT_DATE = CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), 109) FROM #KOTAK_FILE

SELECT @@VDT = CONVERT(VARCHAR(11), START_DATE, 109) FROM NBFC.DBO.SETT_MST WHERE FUNDS_PAYIN LIKE @@PAYINT_DATE + '%' AND EXCHANGE = 'NSE' AND SETT_TYPE = 'N'

CREATE TABLE #RECO_MATCHING
(
	CLTCODE VARCHAR(10),
	AMOUNT MONEY,
	VDT DATETIME,
	VALUEDATE DATETIME,
	CROSSREFERENCENO INT,
	L1_SNO INT
)

BEGIN TRAN
/* AUTO1 UPDATE */
INSERT INTO #RECO_MATCHING
SELECT '', 0, '', CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), CROSSREFERENCENO, L1_SNO
FROM LEDGER L, LEDGER1 L1, 
(SELECT * FROM #KOTAK_FILE WHERE .DBO.PIECE(FILE_DATA, ',', 3) NOT LIKE '%CMS%') BR, 
 MULTIBANKID M
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO
AND EXISTS(SELECT VNO FROM LEDGER L11 
WHERE CLTCODE = @BANKCODE AND L11.VNO = L.VNO AND L11.VTYP = L.VTYP AND L11.BOOKTYPE = L.BOOKTYPE AND VDT >= @@VDT AND VDT <= @@PAYINT_DATE + ' 23:59')
AND VAMT = .DBO.PIECE(FILE_DATA, ',', 5)
AND L.DRCR = LEFT(.DBO.PIECE(FILE_DATA, ',', 6), 1)
AND VDT >= @@VDT AND VDT <= @@PAYINT_DATE + ' 23:59'
AND L.VDT >= @@VDT AND L.VDT <= @@PAYINT_DATE + ' 23:59'
AND M.CLTCODE = L.CLTCODE
AND .DBO.PIECE(REPLACE(RIGHT(.DBO.PIECE(FILE_DATA, ',', 3), LEN(.DBO.PIECE(FILE_DATA, ',', 3)) - 3), ' ', ','), ',', 1) = ACCNO
AND L1.RELDT = ''

INSERT INTO BANKRECO_LOG
SELECT @BANKCODE, CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), 109), .DBO.PIECE(FILE_DATA, ',', 3), .DBO.PIECE(FILE_DATA, ',', 5), LEFT(.DBO.PIECE(FILE_DATA, ',', 6), 1), CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), 109), .DBO.PIECE(FILE_DATA, ',', 4), 'BROKER', 'BROKER', 'AUTO', BR.CROSSREFERENCENO, 'UNMATCHED', '999999999', 0, 0, 0, 0, 'AUTO_1', GETDATE(), 'MATCHED' 
FROM
(SELECT * FROM #KOTAK_FILE) BR, 
 (SELECT DISTINCT CROSSREFERENCENO FROM #RECO_MATCHING) M
WHERE BR.CROSSREFERENCENO = M.CROSSREFERENCENO

UPDATE BR SET STATUS = 'MATCHED'
FROM
(SELECT * FROM #KOTAK_FILE) BR, 
 (SELECT DISTINCT CROSSREFERENCENO FROM #RECO_MATCHING) M
WHERE BR.CROSSREFERENCENO = M.CROSSREFERENCENO

INSERT INTO LEDGER1_BANKRECO_LOG
SELECT L1.*, 'AUTO_1', GETDATE(), 'MATCHED'
FROM LEDGER1 L1, 
(SELECT * FROM #RECO_MATCHING) M
WHERE L1.L1_SNO = M.L1_SNO


UPDATE L1 SET RELDT = VALUEDATE, REFNO = CROSSREFERENCENO
FROM LEDGER1 L1, 
(SELECT * FROM #RECO_MATCHING) M
WHERE L1.L1_SNO = M.L1_SNO
AND L1.RELDT = ''

/* END AUTO_1 UPDATE */


/* AUTO_2 UPDATE */
TRUNCATE TABLE #RECO_MATCHING

INSERT INTO #RECO_MATCHING
SELECT '', 0, '', CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), CROSSREFERENCENO, L1_SNO
FROM LEDGER L, LEDGER1 L1, 
(SELECT * FROM #KOTAK_FILE WHERE .DBO.PIECE(FILE_DATA, ',', 3) NOT LIKE '%CMS%') BR, 
(SELECT CLTCODE, ACTNODAYS, VDT, NET_AMT = ABS(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)), NET_DRCR = CASE WHEN SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) > 0 THEN 'C' ELSE 'D' END
FROM LEDGER GROUP BY CLTCODE, ACTNODAYS, VDT) L2, MULTIBANKID M
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO
AND EXISTS(SELECT VNO FROM LEDGER L11 
WHERE CLTCODE = @BANKCODE AND L11.VNO = L.VNO AND L11.VTYP = L.VTYP AND L11.BOOKTYPE = L.BOOKTYPE AND VDT >= @@VDT AND VDT <= @@PAYINT_DATE + ' 23:59')
AND NET_AMT = .DBO.PIECE(FILE_DATA, ',', 5)
AND NET_DRCR = LEFT(.DBO.PIECE(FILE_DATA, ',', 6), 1)
AND L.ACTNODAYS = L2.ACTNODAYS
AND L2.VDT >= @@VDT AND L2.VDT <= @@PAYINT_DATE + ' 23:59'
AND L.VDT >= @@VDT AND L.VDT <= @@PAYINT_DATE + ' 23:59'
AND L.VDT = L2.VDT
AND M.CLTCODE = L.CLTCODE
AND .DBO.PIECE(REPLACE(RIGHT(.DBO.PIECE(FILE_DATA, ',', 3), LEN(.DBO.PIECE(FILE_DATA, ',', 3)) - 3), ' ', ','), ',', 1) = ACCNO
AND L1.RELDT = ''
AND L.CLTCODE = L2.CLTCODE

INSERT INTO BANKRECO_LOG
SELECT @BANKCODE, CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), 109), .DBO.PIECE(FILE_DATA, ',', 3), .DBO.PIECE(FILE_DATA, ',', 5), LEFT(.DBO.PIECE(FILE_DATA, ',', 6), 1), CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), 109), .DBO.PIECE(FILE_DATA, ',', 4), 'BROKER', 'BROKER', 'AUTO', BR.CROSSREFERENCENO, 'UNMATCHED', '999999999', 0, 0, 0, 0, 'AUTO_2', GETDATE(), 'MATCHED'  
FROM
(SELECT * FROM #KOTAK_FILE) BR, 
 (SELECT DISTINCT CROSSREFERENCENO FROM #RECO_MATCHING) M
WHERE BR.CROSSREFERENCENO = M.CROSSREFERENCENO

UPDATE BR SET STATUS = 'MATCHED'
FROM
(SELECT * FROM #KOTAK_FILE) BR, 
 (SELECT DISTINCT CROSSREFERENCENO FROM #RECO_MATCHING) M
WHERE BR.CROSSREFERENCENO = M.CROSSREFERENCENO

INSERT INTO LEDGER1_BANKRECO_LOG
SELECT L1.*, 'AUTO_2', GETDATE(), 'MATCHED'
FROM LEDGER1 L1, 
(SELECT * FROM #RECO_MATCHING) M
WHERE L1.L1_SNO = M.L1_SNO


UPDATE L1 SET RELDT = VALUEDATE, REFNO = CROSSREFERENCENO
FROM LEDGER1 L1, 
(SELECT * FROM #RECO_MATCHING) M
WHERE L1.L1_SNO = M.L1_SNO
AND L1.RELDT = ''

/* END AUTO_2 UPDATE */


/* AUTO_3 UPDATE */
TRUNCATE TABLE #RECO_MATCHING

INSERT INTO #RECO_MATCHING
SELECT L2.CLTCODE, NET_AMT, L2.VDT, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), CROSSREFERENCENO, L1_SNO
FROM LEDGER L, LEDGER1 L1, 
(SELECT * FROM #KOTAK_FILE WHERE .DBO.PIECE(FILE_DATA, ',', 3) LIKE '%CMS%') BR, 
(SELECT CLTCODE, ACTNODAYS, VDT, NET_AMT = ABS(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)), NET_DRCR = CASE WHEN SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) > 0 THEN 'C' ELSE 'D' END 
FROM LEDGER GROUP BY CLTCODE, ACTNODAYS, VDT) L2
WHERE L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO
AND EXISTS(SELECT VNO FROM LEDGER L11 
WHERE CLTCODE = @BANKCODE AND L11.VNO = L.VNO AND L11.VTYP = L.VTYP AND L11.BOOKTYPE = L.BOOKTYPE AND VDT >= @@VDT AND VDT <= @@PAYINT_DATE + ' 23:59')
AND NET_AMT = .DBO.PIECE(FILE_DATA, ',', 5)
AND NET_DRCR = LEFT(.DBO.PIECE(FILE_DATA, ',', 6), 1)
AND L.ACTNODAYS = L2.ACTNODAYS
AND L2.VDT >= @@VDT AND L2.VDT <= @@PAYINT_DATE + ' 23:59'
AND L.VDT >= @@VDT AND L.VDT <= @@PAYINT_DATE + ' 23:59'
AND L.VDT = L2.VDT
AND L1.RELDT = ''
AND L.CLTCODE = L2.CLTCODE

DELETE D FROM #RECO_MATCHING D,
(
	SELECT CLTCODE, AMOUNT FROM
	(SELECT CLTCODE, AMOUNT, VDT FROM #RECO_MATCHING GROUP BY CLTCODE, AMOUNT, VDT) D1
	GROUP BY CLTCODE, AMOUNT
	HAVING COUNT(1) > 1
) D2
WHERE D.CLTCODE = D2.CLTCODE AND D.AMOUNT = D2.AMOUNT


INSERT INTO BANKRECO_LOG
SELECT @BANKCODE, CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), 109), .DBO.PIECE(FILE_DATA, ',', 3), .DBO.PIECE(FILE_DATA, ',', 5), LEFT(.DBO.PIECE(FILE_DATA, ',', 6), 1), CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), 109), .DBO.PIECE(FILE_DATA, ',', 4), 'BROKER', 'BROKER', 'AUTO', BR.CROSSREFERENCENO, 'UNMATCHED', '999999999', 0, 0, 0, 0, 'AUTO_3', GETDATE(), 'MATCHED' 
FROM
(SELECT * FROM #KOTAK_FILE) BR, 
 (SELECT DISTINCT CROSSREFERENCENO FROM #RECO_MATCHING) M
WHERE BR.CROSSREFERENCENO = M.CROSSREFERENCENO

UPDATE BR SET STATUS = 'MATCHED'
FROM
(SELECT * FROM #KOTAK_FILE) BR, 
 (SELECT DISTINCT CROSSREFERENCENO FROM #RECO_MATCHING) M
WHERE BR.CROSSREFERENCENO = M.CROSSREFERENCENO

INSERT INTO LEDGER1_BANKRECO_LOG
SELECT L1.*, 'AUTO_3', GETDATE(), 'MATCHED'
FROM LEDGER1 L1, 
(SELECT * FROM #RECO_MATCHING) M
WHERE L1.L1_SNO = M.L1_SNO


UPDATE L1 SET RELDT = VALUEDATE, REFNO = CROSSREFERENCENO
FROM LEDGER1 L1, 
(SELECT * FROM #RECO_MATCHING) M
WHERE L1.L1_SNO = M.L1_SNO
AND L1.RELDT = ''

/* END AUTO_3 UPDATE */


/* AUTO_4 UPDATE */
TRUNCATE TABLE #RECO_MATCHING

INSERT INTO #RECO_MATCHING
SELECT '', 0, '', CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), CROSSREFERENCENO, L1_SNO
FROM LEDGER L, LEDGER1 L1, 
(SELECT * FROM #KOTAK_FILE WHERE .DBO.PIECE(FILE_DATA, ',', 3) NOT LIKE '%CMS%') BR,
(SELECT CLTCODE, ACTNODAYS, NET_AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END), 
DRCR = CASE WHEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) > 0 THEN 'C' ELSE 'D' END
FROM LEDGER WHERE VDT >= @@PAYINT_DATE AND VDT <= @@PAYINT_DATE + ' 23:59'
GROUP BY CLTCODE, ACTNODAYS) L2, MULTIBANKID M
WHERE
	EXISTS(SELECT VNO FROM LEDGER L11 WHERE L.VNO = L11.VNO AND L.VTYP = L11.VTYP AND L.BOOKTYPE = L11.BOOKTYPE AND CLTCODE = @BANKCODE AND VDT >= @@PAYINT_DATE AND VDT <= @@PAYINT_DATE + ' 23:59')
	AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO
	AND L2.CLTCODE = M.CLTCODE
	AND L.CLTCODE = L2.CLTCODE
	AND .DBO.PIECE(FILE_DATA, ',', 5) = NET_AMOUNT
	AND L2.DRCR = LEFT(.DBO.PIECE(FILE_DATA, ',', 5), 1)
	AND ACCNO = .DBO.PIECE(REPLACE(.DBO.PIECE(FILE_DATA, ',', 3), ' ', ','), ',', 2)
	AND L1.RELDT = ''



INSERT INTO BANKRECO_LOG
SELECT @BANKCODE, CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), 109), .DBO.PIECE(FILE_DATA, ',', 3), .DBO.PIECE(FILE_DATA, ',', 5), LEFT(.DBO.PIECE(FILE_DATA, ',', 6), 1), CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), 109), .DBO.PIECE(FILE_DATA, ',', 4), 'BROKER', 'BROKER', 'AUTO', BR.CROSSREFERENCENO, 'UNMATCHED', '999999999', 0, 0, 0, 0, 'AUTO_4', GETDATE(), 'MATCHED' 
FROM
(SELECT * FROM #KOTAK_FILE) BR, 
 (SELECT DISTINCT CROSSREFERENCENO FROM #RECO_MATCHING) M
WHERE BR.CROSSREFERENCENO = M.CROSSREFERENCENO

UPDATE BR SET STATUS = 'MATCHED'
FROM
(SELECT * FROM #KOTAK_FILE) BR, 
 (SELECT DISTINCT CROSSREFERENCENO FROM #RECO_MATCHING) M
WHERE BR.CROSSREFERENCENO = M.CROSSREFERENCENO

INSERT INTO LEDGER1_BANKRECO_LOG
SELECT L1.*, 'AUTO_4', GETDATE(), 'MATCHED'
FROM LEDGER1 L1, 
(SELECT * FROM #RECO_MATCHING) M
WHERE L1.L1_SNO = M.L1_SNO


UPDATE L1 SET RELDT = VALUEDATE, REFNO = CROSSREFERENCENO
FROM LEDGER1 L1, 
(SELECT * FROM #RECO_MATCHING) M
WHERE L1.L1_SNO = M.L1_SNO
AND L1.RELDT = ''

/* END AUTO_4 UPDATE */


/* AUTO_5 UPDATE */
TRUNCATE TABLE #RECO_MATCHING

INSERT INTO #RECO_MATCHING
SELECT '', 0, '', CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), CROSSREFERENCENO, L1_SNO
FROM LEDGER L, LEDGER1 L1, 
(SELECT * FROM #KOTAK_FILE WHERE .DBO.PIECE(FILE_DATA, ',', 3) NOT LIKE '%CMS%') BR,
(SELECT CLTCODE, ACTNODAYS, VDT, NET_AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END), 
DRCR = CASE WHEN SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) > 0 THEN 'C' ELSE 'D' END
FROM LEDGER WHERE VDT >= @@VDT AND VDT <= @@PAYINT_DATE + ' 23:59'
GROUP BY CLTCODE, ACTNODAYS, VDT) L2, MULTIBANKID M
WHERE
	EXISTS(SELECT VNO FROM LEDGER L11 WHERE L.VNO = L11.VNO AND L.VTYP = L11.VTYP AND L.BOOKTYPE = L11.BOOKTYPE AND CLTCODE = @BANKCODE AND VDT >= @@VDT AND VDT <= @@PAYINT_DATE + ' 23:59')
	AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO
	AND L2.CLTCODE = M.CLTCODE
	AND L.CLTCODE = L2.CLTCODE
	AND L.VDT = L2.VDT
	AND L.ACTNODAYS = L2.ACTNODAYS
	AND .DBO.PIECE(FILE_DATA, ',', 5) = NET_AMOUNT
	AND L2.DRCR = LEFT(.DBO.PIECE(FILE_DATA, ',', 5), 1)
	AND ACCNO = .DBO.PIECE(REPLACE(.DBO.PIECE(FILE_DATA, ',', 3), ' ', ','), ',', 2)
	AND L1.RELDT = ''
	

INSERT INTO BANKRECO_LOG
SELECT @BANKCODE, CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), 109), .DBO.PIECE(FILE_DATA, ',', 3), .DBO.PIECE(FILE_DATA, ',', 5), LEFT(.DBO.PIECE(FILE_DATA, ',', 6), 1), CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), 109), .DBO.PIECE(FILE_DATA, ',', 4), 'BROKER', 'BROKER', 'AUTO', BR.CROSSREFERENCENO, 'UNMATCHED', '999999999', 0, 0, 0, 0, 'AUTO_5', GETDATE(), 'MATCHED' 
FROM
(SELECT * FROM #KOTAK_FILE) BR, 
 (SELECT DISTINCT CROSSREFERENCENO FROM #RECO_MATCHING) M
WHERE BR.CROSSREFERENCENO = M.CROSSREFERENCENO

UPDATE BR SET STATUS = 'MATCHED'
FROM
(SELECT * FROM #KOTAK_FILE) BR, 
 (SELECT DISTINCT CROSSREFERENCENO FROM #RECO_MATCHING) M
WHERE BR.CROSSREFERENCENO = M.CROSSREFERENCENO

INSERT INTO LEDGER1_BANKRECO_LOG
SELECT L1.*, 'AUTO_5', GETDATE(), 'MATCHED'
FROM LEDGER1 L1, 
(SELECT * FROM #RECO_MATCHING) M
WHERE L1.L1_SNO = M.L1_SNO


UPDATE L1 SET RELDT = VALUEDATE, REFNO = CROSSREFERENCENO
FROM LEDGER1 L1, 
(SELECT * FROM #RECO_MATCHING) M
WHERE L1.L1_SNO = M.L1_SNO
AND L1.RELDT = ''

/* END AUTO_5 UPDATE */


CREATE TABLE #RECO_MATCH
(
	enteredby VARCHAR(20),
	actnodays VARCHAR(3),
	VDT DATETIME, 
	VAMT MONEY,
	VALUEDATE DATETIME, 
	CROSSREFERENCENO INT,
	STATUS VARCHAR(1)
)

INSERT INTO #RECO_MATCH
SELECT enteredby,actnodays,VDT, VAMT, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), CROSSREFERENCENO, '' FROM #KOTAK_FILE BR, 
(select enteredby,actnodays,VDT,VAMT = sum(vamt) from (
	select b.enteredby,b.vdt,b.cltcode,b.actnodays,vamt =(sum(case when drcr ='d' then b.vamt else b.vamt*-1 end)) -- into #a 
	from ledger b, acmast as m, (select actnodays,vno,vtyp,booktype,vamt from ledger where  cltcode =@BANKCODE
	and vdt>=@@VDT AND VDT <=@@PAYINT_DATE + ' 23:59') a
	where b.vno =a.vno and b.vtyp=a.vtyp and b.booktype =a.booktype and a.actnodays=b.actnodays
	and m.cltcode=b.cltcode and m.accat =4
	and b.cltcode <> @BANKCODE
	AND B.ACTNODAYS >0
	group by b.cltcode,b.actnodays,b.vdt,b.enteredby
	having sum(case when drcr ='d' then b.vamt else b.vamt*-1 end) > 0
	)a  group by enteredby,actnodays,VDT
	) X
	WHERE VAMT = .DBO.PIECE(FILE_DATA, ',', 5)
	AND .DBO.PIECE(FILE_DATA, ',', 3) LIKE '%CMS%'
	AND LEFT(.DBO.PIECE(FILE_DATA, ',', 6), 1) ='D'
	

UPDATE R SET STATUS = 'Y' FROM #RECO_MATCH R,
(
	SELECT  L.enteredby,L.actnodays,L.VDT, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END)  FROM LEDGER L,
	(select b.enteredby,b.vdt,b.cltcode,b.actnodays,vamt =(sum(case when drcr ='d' then b.vamt else b.vamt*-1 end)) -- into #a 
		from ledger b, acmast as m, (select actnodays,vno,vtyp,booktype,vamt from ledger where  cltcode =@BANKCODE
		and vdt>=@@VDT AND VDT <= @@PAYINT_DATE + ' 23:59') a
		where b.vno =a.vno and b.vtyp=a.vtyp and b.booktype =a.booktype and a.actnodays=b.actnodays
		and m.cltcode=b.cltcode and m.accat =4
		and b.cltcode <> @BANKCODE
		AND B.ACTNODAYS >0
		group by b.cltcode,b.actnodays,b.vdt,b.enteredby
		having sum(case when drcr ='d' then b.vamt else b.vamt*-1 end) > 0
	) X
	WHERE L.CLTCODE = X.CLTCODE AND L.enteredby = X.enteredby AND X.actnodays = L.actnodays AND L.vdt = X.vdt
	GROUP BY L.enteredby,L.actnodays,L.VDT
) Z
WHERE Z.enteredby=R.enteredby AND R.actnodays = Z.actnodays AND R.VDT = Z.VDT AND R.VAMT = Z.VAMT

/* AUTO_6 UPDATE */
TRUNCATE TABLE #RECO_MATCHING

INSERT INTO #RECO_MATCHING
SELECT '', 0, '', VALUEDATE, CROSSREFERENCENO, L1_SNO
FROM LEDGER L, LEDGER1 L1,
(select b.enteredby,b.vdt,b.cltcode,b.actnodays,vamt =(sum(case when drcr ='d' then b.vamt else b.vamt*-1 end)) -- into #a 
	from ledger b, acmast as m, (select actnodays,vno,vtyp,booktype,vamt from ledger where  cltcode =@BANKCODE
	and vdt>=@@VDT AND VDT <= @@PAYINT_DATE + ' 23:59') a
	where b.vno =a.vno and b.vtyp=a.vtyp and b.booktype =a.booktype and a.actnodays=b.actnodays
	and m.cltcode=b.cltcode and m.accat =4
	and b.cltcode <> @BANKCODE
	AND B.ACTNODAYS >0
	group by b.cltcode,b.actnodays,b.vdt,b.enteredby
	having sum(case when drcr ='d' then b.vamt else b.vamt*-1 end) > 0
) X, #RECO_MATCH R
WHERE L.CLTCODE = X.CLTCODE AND L.enteredby = X.enteredby AND X.actnodays = L.actnodays AND L.vdt = X.vdt
AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO
AND R.enteredby = X.enteredby AND R.actnodays = L.actnodays AND R.vdt = X.vdt AND STATUS = 'Y'	

 
INSERT INTO BANKRECO_LOG
SELECT @BANKCODE, CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), 109), .DBO.PIECE(FILE_DATA, ',', 3), .DBO.PIECE(FILE_DATA, ',', 5), LEFT(.DBO.PIECE(FILE_DATA, ',', 6), 1), CONVERT(VARCHAR, CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103), 109), .DBO.PIECE(FILE_DATA, ',', 4), 'BROKER', 'BROKER', 'AUTO', BR.CROSSREFERENCENO, 'UNMATCHED', '999999999', 0, 0, 0, 0, 'AUTO_6', GETDATE(), 'MATCHED' 
FROM
(SELECT * FROM #KOTAK_FILE) BR, 
 (SELECT DISTINCT CROSSREFERENCENO FROM #RECO_MATCHING) M
WHERE BR.CROSSREFERENCENO = M.CROSSREFERENCENO

UPDATE BR SET STATUS = 'MATCHED'
FROM
(SELECT * FROM #KOTAK_FILE) BR, 
 (SELECT DISTINCT CROSSREFERENCENO FROM #RECO_MATCHING) M
WHERE BR.CROSSREFERENCENO = M.CROSSREFERENCENO

INSERT INTO LEDGER1_BANKRECO_LOG
SELECT L1.*, 'AUTO_6', GETDATE(), 'MATCHED'
FROM LEDGER1 L1, 
(SELECT * FROM #RECO_MATCHING) M
WHERE L1.L1_SNO = M.L1_SNO


UPDATE L1 SET RELDT = VALUEDATE, REFNO = CROSSREFERENCENO
FROM LEDGER1 L1, 
(SELECT * FROM #RECO_MATCHING) M
WHERE L1.L1_SNO = M.L1_SNO
AND L1.RELDT = ''

/* END AUTO_6 UPDATE */

INSERT INTO BANKRECO (Cltcode,Bookdate,Description,Amount,Drcr,Valuedate,Referenceno,Statusid,Statusname,Loginname,Crossreferenceno,[Status],Micrno,Dummy1,Dummy2)
SELECT
	@BANKCODE, 
	BOOKDATE = CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103),
	DESCRIPTION = .DBO.PIECE(FILE_DATA, ',', 3),
	AMOUNT = .DBO.PIECE(FILE_DATA, ',', 5),
	DRCR = LEFT(.DBO.PIECE(FILE_DATA, ',', 6), 1),
	VALUEDATE = CONVERT(DATETIME, .DBO.PIECE(FILE_DATA, ',', 2), 103),
	REFERENCENO = .DBO.PIECE(FILE_DATA, ',', 4),
	'BROKER', 'BROKER', 'SYSTEM', 
	CROSSREFERENCENO,
	ISNULL(STATUS, 'UNMATCHED'), '', 0, 0
FROM #KOTAK_FILE
--WHERE ISNULL(STATUS, 'UNMATCHED') = 'MATCHED'

COMMIT TRAN

DROP TABLE #KOTAK_FILE

SELECT 'UPDATED SUCCESSFULLY.'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.LEDGER_REPORT_FOUT_NEW1
-- --------------------------------------------------



CREATE PROCEDURE LEDGER_REPORT_FOUT_NEW1              
(@FROMDATE AS VARCHAR(11),              
@FROMCLTCODE AS VARCHAR(10),              
@TOCLTCODE AS VARCHAR(10),              
@OPT                 AS VARCHAR(10),              
@STATUSID AS VARCHAR(25),              
@STATUSNAME AS VARCHAR(50),              
@SESSION AS VARCHAR(25),        
@REPORTOPT AS VARCHAR(1))              
AS              
              
DECLARE @FAACTUAL1 MONEY              
DECLARE @FAACTUAL2 MONEY              
DECLARE @FAACTUAL3 MONEY              
DECLARE @FAACTUAL4 MONEY              
DECLARE @FAACTUAL5 MONEY              
DECLARE @FAACTUAL6 MONEY              
         
            
CREATE TABLE #LEDGERBALANCES            
(            
FAMILYCODE  VARCHAR(50),            
CLTCODE     VARCHAR(50),            
ACNAME       VARCHAR(100),            
NSEBALANCE MONEY,            
BSEBALANCE MONEY,            
NSEFOBALANCE MONEY,            
NSEESTIMATED1 MONEY,            
NSEESTIMATED2 MONEY,            
BSEESTIMATED1 MONEY,            
BSEESTIMATED2 MONEY,            
FAACTUAL MONEY,            
NONCASH  MONEY,            
CASH  MONEY,            
IMMARGIN MONEY,            
VARMARGIN MONEY,            
SESSIONID VARCHAR(25)            
)            
              
IF UPPER(@STATUSID) = 'BRANCH'              
BEGIN              
 IF @OPT = 'BRANCH'               
 BEGIN              
  INSERT INTO #LEDGERBALANCES              
  SELECT BRANCH_CD,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE BRANCH_CD >= @FROMCLTCODE               
  AND BRANCH_CD <= @TOCLTCODE AND BRANCH_CD = @STATUSNAME              
 END              
 ELSE IF @OPT = 'FAMILY'               
 BEGIN              
  INSERT INTO #LEDGERBALANCES              
  SELECT FAMILY,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE FAMILY >= @FROMCLTCODE               
  AND FAMILY <= @TOCLTCODE AND BRANCH_CD = @STATUSNAME              
 END               
 ELSE IF @OPT = 'SUBBROKER'               
 BEGIN              
  INSERT INTO #LEDGERBALANCES              
  SELECT SUB_BROKER,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE SUB_BROKER >= @FROMCLTCODE               
  AND SUB_BROKER <= @TOCLTCODE AND BRANCH_CD = @STATUSNAME              
 END               
 ELSE IF @OPT = 'TRADER'               
 BEGIN              
  INSERT INTO #LEDGERBALANCES              
  SELECT TRADER,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE TRADER >= @FROMCLTCODE               
  AND TRADER <= @TOCLTCODE AND BRANCH_CD = @STATUSNAME              
 END              
 ELSE IF @OPT = 'AREA'               
 BEGIN              
  INSERT INTO #LEDGERBALANCES              
  SELECT AREA,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE AREA >= @FROMCLTCODE               
  AND AREA <= @TOCLTCODE AND BRANCH_CD = @STATUSNAME              
 END              
 ELSE              
 BEGIN              
  INSERT INTO #LEDGERBALANCES              
  SELECT FAMILY,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE CL_CODE >= @FROMCLTCODE               
  AND CL_CODE <= @TOCLTCODE AND BRANCH_CD = @STATUSNAME              
 END              
END              
ELSE IF UPPER(@STATUSID) = 'BROKER'            
BEGIN              
 IF @OPT = 'BRANCH'               
 BEGIN              
  INSERT INTO #LEDGERBALANCES              
  SELECT BRANCH_CD,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE BRANCH_CD >= @FROMCLTCODE               
  AND BRANCH_CD <= @TOCLTCODE               
 END              
 ELSE IF @OPT = 'FAMILY'               
 BEGIN              
  INSERT INTO #LEDGERBALANCES              
  SELECT FAMILY,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE FAMILY >= @FROMCLTCODE               
  AND FAMILY <= @TOCLTCODE               
 END              
 ELSE IF @OPT = 'SUBBROKER'               
 BEGIN              
  INSERT INTO #LEDGERBALANCES              
  SELECT SUB_BROKER,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE SUB_BROKER >= @FROMCLTCODE               
  AND SUB_BROKER <= @TOCLTCODE              
 END               
 ELSE IF @OPT = 'TRADER'               
 BEGIN              
  INSERT INTO #LEDGERBALANCES              
  SELECT TRADER,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE TRADER >= @FROMCLTCODE               
  AND TRADER <= @TOCLTCODE              
 END              
 ELSE IF @OPT = 'AREA'               
 BEGIN              
  INSERT INTO #LEDGERBALANCES              
  SELECT AREA,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE AREA >= @FROMCLTCODE               
  AND AREA <= @TOCLTCODE              
 END      
 ELSE              
 BEGIN              
  INSERT INTO #LEDGERBALANCES              
  SELECT FAMILY,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE CL_CODE >= @FROMCLTCODE               
  AND CL_CODE <= @TOCLTCODE    
 END              
END            
 ELSE              
BEGIN              
 IF @OPT = 'FAMILY'               
 BEGIN              
  INSERT INTO #LEDGERBALANCES              
  SELECT FAMILY,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE FAMILY >= @FROMCLTCODE               
  AND FAMILY <= @TOCLTCODE AND SUB_BROKER = @STATUSNAME    
 END              
 ELSE IF @OPT = 'SUBBROKER'           
 BEGIN              
  INSERT INTO #LEDGERBALANCES              
  SELECT SUB_BROKER,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE SUB_BROKER >= @FROMCLTCODE               
  AND SUB_BROKER <= @TOCLTCODE AND SUB_BROKER = @STATUSNAME    
 END               
 ELSE              
 BEGIN              
  INSERT INTO #LEDGERBALANCES      
  SELECT FAMILY,CL_CODE, LONG_NAME, 0,0,0,0,0,0,0,0,0,0,0,0,@SESSION              
  FROM MCDXCDS.DBO.CLIENT1 WHERE CL_CODE >= @FROMCLTCODE               
  AND CL_CODE <= @TOCLTCODE AND SUB_BROKER = @STATUSNAME    
 END              
END     
          
          
SELECT * INTO #EDTNSELEDGER FROM ACCOUNT.DBO.LEDGER WHERE 1=2          
SELECT * INTO #VDTNSELEDGER FROM ACCOUNT.DBO.LEDGER WHERE 1=2          
SELECT * INTO #EDTBSELEDGER FROM ACCOUNTBSE.DBO.LEDGER WHERE 1=2          
SELECT * INTO #VDTBSELEDGER FROM ACCOUNTBSE.DBO.LEDGER WHERE 1=2          
/*SELECT * INTO #EDTFOLEDGER FROM ACCOUNTFO.DBO.LEDGER WHERE 1=2          
SELECT * INTO #VDTFOLEDGER FROM ACCOUNTFO.DBO.LEDGER WHERE 1=2          */
      
      
          
IF @OPT = 'BRANCH'          
BEGIN          
--NSE LEDGER          
 INSERT INTO #EDTNSELEDGER SELECT ACCOUNT.DBO.LEDGER.* FROM ACCOUNT.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND BRANCH_CD >= @FROMCLTCODE               
 AND BRANCH_CD <= @TOCLTCODE           
          
 INSERT INTO #VDTNSELEDGER SELECT ACCOUNT.DBO.LEDGER.* FROM ACCOUNT.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND BRANCH_CD >= @FROMCLTCODE               
 AND BRANCH_CD <= @TOCLTCODE           
--BSE LEDGER          
 INSERT INTO #EDTBSELEDGER SELECT ACCOUNTBSE.DBO.LEDGER.* FROM ACCOUNTBSE.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND BRANCH_CD >= @FROMCLTCODE               
 AND BRANCH_CD <= @TOCLTCODE           
          
 INSERT INTO #VDTBSELEDGER SELECT ACCOUNTBSE.DBO.LEDGER.* FROM ACCOUNTBSE.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND BRANCH_CD >= @FROMCLTCODE               
 AND BRANCH_CD <= @TOCLTCODE           
          
--FO LEDGER          
/* INSERT INTO #EDTFOLEDGER SELECT ACCOUNTFO.DBO.LEDGER.* FROM ACCOUNTFO.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND BRANCH_CD >= @FROMCLTCODE               
 AND BRANCH_CD <= @TOCLTCODE           
          
 INSERT INTO #VDTFOLEDGER SELECT ACCOUNTFO.DBO.LEDGER.* FROM ACCOUNTFO.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND BRANCH_CD >= @FROMCLTCODE               
 AND BRANCH_CD <= @TOCLTCODE           */
          
END          
ELSE IF @OPT = 'FAMILY'          
BEGIN          
--NSE LEDGER          
 INSERT INTO #EDTNSELEDGER SELECT ACCOUNT.DBO.LEDGER.* FROM ACCOUNT.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND FAMILY >= @FROMCLTCODE               
 AND FAMILY <= @TOCLTCODE           
          
 INSERT INTO #VDTNSELEDGER SELECT ACCOUNT.DBO.LEDGER.* FROM ACCOUNT.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND FAMILY >= @FROMCLTCODE               
 AND FAMILY <= @TOCLTCODE           
          
--BSE LEDGER          
 INSERT INTO #EDTBSELEDGER SELECT ACCOUNTBSE.DBO.LEDGER.* FROM ACCOUNTBSE.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND FAMILY >= @FROMCLTCODE               
 AND FAMILY <= @TOCLTCODE           
          
 INSERT INTO #VDTBSELEDGER SELECT ACCOUNTBSE.DBO.LEDGER.* FROM ACCOUNTBSE.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE    
 AND FAMILY >= @FROMCLTCODE               
 AND FAMILY <= @TOCLTCODE           
          
--FO LEDGER          
/* INSERT INTO #EDTFOLEDGER SELECT ACCOUNTFO.DBO.LEDGER.* FROM ACCOUNTFO.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND FAMILY >= @FROMCLTCODE               
 AND FAMILY <= @TOCLTCODE           
          
 INSERT INTO #VDTFOLEDGER SELECT ACCOUNTFO.DBO.LEDGER.* FROM ACCOUNTFO.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
AND FAMILY >= @FROMCLTCODE               
 AND FAMILY <= @TOCLTCODE          */
END          
ELSE IF @OPT = 'SUBBROKER'          
BEGIN           
--NSE LEDGER          
 INSERT INTO #EDTNSELEDGER SELECT ACCOUNT.DBO.LEDGER.* FROM ACCOUNT.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND SUB_BROKER >= @FROMCLTCODE               
 AND SUB_BROKER <= @TOCLTCODE           
          
 INSERT INTO #VDTNSELEDGER SELECT ACCOUNT.DBO.LEDGER.* FROM ACCOUNT.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND SUB_BROKER >= @FROMCLTCODE               
 AND SUB_BROKER <= @TOCLTCODE           
--BSE LEDGER          
 INSERT INTO #EDTBSELEDGER SELECT ACCOUNTBSE.DBO.LEDGER.* FROM ACCOUNTBSE.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND SUB_BROKER >= @FROMCLTCODE               
 AND SUB_BROKER <= @TOCLTCODE           
          
 INSERT INTO #VDTBSELEDGER SELECT ACCOUNTBSE.DBO.LEDGER.* FROM ACCOUNTBSE.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND SUB_BROKER >= @FROMCLTCODE               
 AND SUB_BROKER <= @TOCLTCODE           
          
--FO LEDGER          
/* INSERT INTO #EDTFOLEDGER SELECT ACCOUNTFO.DBO.LEDGER.* FROM ACCOUNTFO.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND SUB_BROKER >= @FROMCLTCODE               
 AND SUB_BROKER <= @TOCLTCODE           
          
 INSERT INTO #VDTFOLEDGER SELECT ACCOUNTFO.DBO.LEDGER.* FROM ACCOUNTFO.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
AND SUB_BROKER >= @FROMCLTCODE               
 AND SUB_BROKER <= @TOCLTCODE           */
END          
ELSE IF @OPT = 'TRADER'               
BEGIN           
--NSE LEDGER          
 INSERT INTO #EDTNSELEDGER SELECT ACCOUNT.DBO.LEDGER.* FROM ACCOUNT.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND TRADER >= @FROMCLTCODE               
 AND TRADER <= @TOCLTCODE               
          
 INSERT INTO #VDTNSELEDGER SELECT ACCOUNT.DBO.LEDGER.* FROM ACCOUNT.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND TRADER >= @FROMCLTCODE               
 AND TRADER <= @TOCLTCODE         
          
--BSE LEDGER          
 INSERT INTO #EDTBSELEDGER SELECT ACCOUNTBSE.DBO.LEDGER.* FROM ACCOUNTBSE.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND TRADER >= @FROMCLTCODE               
 AND TRADER <= @TOCLTCODE               
          
 INSERT INTO #VDTBSELEDGER SELECT ACCOUNTBSE.DBO.LEDGER.* FROM ACCOUNTBSE.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND TRADER >= @FROMCLTCODE               
 AND TRADER <= @TOCLTCODE               
          
--FO LEDGER          
/* INSERT INTO #EDTFOLEDGER SELECT ACCOUNTFO.DBO.LEDGER.* FROM ACCOUNTFO.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND TRADER >= @FROMCLTCODE               
 AND TRADER <= @TOCLTCODE               
          
 INSERT INTO #VDTFOLEDGER SELECT ACCOUNTFO.DBO.LEDGER.* FROM ACCOUNTFO.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND TRADER >= @FROMCLTCODE               
 AND TRADER <= @TOCLTCODE               */
          
END          
ELSE IF @OPT = 'AREA'               
BEGIN           
--NSE LEDGER          
 INSERT INTO #EDTNSELEDGER SELECT ACCOUNT.DBO.LEDGER.* FROM ACCOUNT.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND AREA >= @FROMCLTCODE               
 AND AREA <= @TOCLTCODE               
          
 INSERT INTO #VDTNSELEDGER SELECT ACCOUNT.DBO.LEDGER.* FROM ACCOUNT.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'       
 AND CLTCODE=CL_CODE          
 AND AREA >= @FROMCLTCODE               
 AND AREA <= @TOCLTCODE               
          
--BSE LEDGER          
 INSERT INTO #EDTBSELEDGER SELECT ACCOUNTBSE.DBO.LEDGER.* FROM ACCOUNTBSE.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND AREA >= @FROMCLTCODE               
 AND AREA <= @TOCLTCODE               
          
 INSERT INTO #VDTBSELEDGER SELECT ACCOUNTBSE.DBO.LEDGER.* FROM ACCOUNTBSE.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND AREA >= @FROMCLTCODE               
 AND AREA <= @TOCLTCODE               
          
--FO LEDGER          
/* INSERT INTO #EDTFOLEDGER SELECT ACCOUNTFO.DBO.LEDGER.* FROM ACCOUNTFO.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND AREA >= @FROMCLTCODE               
 AND AREA <= @TOCLTCODE               
          
 INSERT INTO #VDTFOLEDGER SELECT ACCOUNTFO.DBO.LEDGER.* FROM ACCOUNTFO.DBO.LEDGER,MCDXCDS.DBO.CLIENT1          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE=CL_CODE          
 AND AREA >= @FROMCLTCODE               
 AND AREA <= @TOCLTCODE               */
          
END          
ELSE          
BEGIN           
--NSE LEDGER          
 INSERT INTO #EDTNSELEDGER SELECT * FROM ACCOUNT.DBO.LEDGER          
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE >= @FROMCLTCODE          
 AND CLTCODE <= @TOCLTCODE          
          
 INSERT INTO #VDTNSELEDGER SELECT * FROM ACCOUNT.DBO.LEDGER          
 WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE >= @FROMCLTCODE          
 AND CLTCODE <= @TOCLTCODE          
          
--BSE LEDGER          
 INSERT INTO #EDTBSELEDGER SELECT * FROM ACCOUNTBSE.DBO.LEDGER           
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE >= @FROMCLTCODE          
 AND CLTCODE <= @TOCLTCODE          
          
 INSERT INTO #VDTBSELEDGER SELECT * FROM ACCOUNTBSE.DBO.LEDGER        WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE >= @FROMCLTCODE          
 AND CLTCODE <= @TOCLTCODE          
          
--FO LEDGER          
/* INSERT INTO #EDTFOLEDGER SELECT * FROM ACCOUNTFO.DBO.LEDGER           
 WHERE EDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE >= @FROMCLTCODE          
 AND CLTCODE <= @TOCLTCODE          
          
 INSERT INTO #VDTFOLEDGER SELECT * FROM ACCOUNTFO.DBO.LEDGER          
 WHERE VDT <= @FROMDATE + ' 23:59:59'          
 AND CLTCODE >= @FROMCLTCODE          
 AND CLTCODE <= @TOCLTCODE          */
          
END          
      
      
          
/*          
UPDATE #LEDGERBALANCES SET NSEBALANCE = AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP NOT IN (2,15,21)  GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
*/          
          
UPDATE #LEDGERBALANCES SET NSEBALANCE = AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #EDTNSELEDGER L, ACCOUNT.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP NOT IN (2,15,21)  GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
          
          
/*            
UPDATE #LEDGERBALANCES SET NSEBALANCE = NSEBALANCE + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P              
WHERE VDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP = 2 GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
*/          
          
UPDATE #LEDGERBALANCES SET NSEBALANCE = NSEBALANCE + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #VDTNSELEDGER L, ACCOUNT.DBO.PARAMETER P              
WHERE VDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP = 2 GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
          
/*             
UPDATE #LEDGERBALANCES SET NSEBALANCE = NSEBALANCE + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP IN (15,21) GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
*/          
          
UPDATE #LEDGERBALANCES SET NSEBALANCE = NSEBALANCE + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #EDTNSELEDGER L, ACCOUNT.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP IN (15,21) GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
          
/*           
UPDATE #LEDGERBALANCES SET BSEBALANCE = AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP NOT IN (2,15,21) GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
*/          
          
UPDATE #LEDGERBALANCES SET BSEBALANCE = AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #EDTBSELEDGER L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP NOT IN (2,15,21) GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
          
/*              
UPDATE #LEDGERBALANCES SET BSEBALANCE = BSEBALANCE + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE VDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP = 2 GROUP BY CLTCODE) A       
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
*/          
          
UPDATE #LEDGERBALANCES SET BSEBALANCE = BSEBALANCE + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #VDTBSELEDGER L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE VDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP = 2 GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
          
/*              
UPDATE #LEDGERBALANCES SET BSEBALANCE = BSEBALANCE + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP IN (15,21) GROUP BY CLTCODE) A           
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
*/          
          
UPDATE #LEDGERBALANCES SET BSEBALANCE = BSEBALANCE + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #EDTBSELEDGER L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP IN (15,21) GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
          
/*              
UPDATE #LEDGERBALANCES SET NSEFOBALANCE = AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP NOT IN (2,15,21) GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION         
*/          
          
/*UPDATE #LEDGERBALANCES SET NSEFOBALANCE = AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #EDTFOLEDGER L, ACCOUNTFO.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP NOT IN (2,15,21) GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               */
          
/*              
UPDATE #LEDGERBALANCES SET NSEFOBALANCE = NSEFOBALANCE + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P              
WHERE VDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP = 2 GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
*/          
          
/*UPDATE #LEDGERBALANCES SET NSEFOBALANCE = NSEFOBALANCE + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #VDTFOLEDGER L, ACCOUNTFO.DBO.PARAMETER P              
WHERE VDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP = 2 GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               */
          
/*              
UPDATE #LEDGERBALANCES SET NSEFOBALANCE = NSEFOBALANCE + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP IN (15,21) GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
*/          
          
/*UPDATE #LEDGERBALANCES SET NSEFOBALANCE = NSEFOBALANCE + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM #EDTFOLEDGER L, ACCOUNTFO.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP IN (15,21) GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               */
          
DROP TABLE #EDTNSELEDGER          
DROP TABLE #VDTNSELEDGER          
DROP TABLE #EDTBSELEDGER          
DROP TABLE #VDTBSELEDGER          
--DROP TABLE #EDTFOLEDGER          
--DROP TABLE #VDTFOLEDGER          
          
              
SELECT EXC='NSE', VDT, CLTCODE,AMOUNT=CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0) )              
INTO #LDEGERESTIMATE FROM ACCOUNT.DBO.LEDGER L, MCDXCDS.DBO.SETT_MST S               
WHERE L.NARRATION LIKE '%' + RTRIM(SETT_NO) + 'NSECM' + RTRIM(SETT_TYPE) + '%'               
AND VDT >= S.START_DATE AND VDT <= S.SEC_PAYIN AND VDT <= @FROMDATE + ' 23:59:59'              
AND VTYP IN (15,21) AND EDT >= @FROMDATE + ' 23:59:59' AND L.CLTCODE >= @FROMCLTCODE AND L.CLTCODE <= @TOCLTCODE               
GROUP BY VDT,CLTCODE              
              
INSERT INTO #LDEGERESTIMATE               
SELECT EXC='BSE', VDT,CLTCODE,AMOUNT=CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0) )              
FROM ACCOUNTBSE.DBO.LEDGER L, MCDXCDS.DBO.SETT_MST S               
WHERE L.NARRATION LIKE '%' + RTRIM(SETT_NO) + 'BSECM' + RTRIM(SETT_TYPE) + '%'               
AND VDT >= S.START_DATE AND VDT <= S.SEC_PAYIN AND VDT <= @FROMDATE + ' 23:59:59'              
AND VTYP IN (15,21) AND EDT >= @FROMDATE + ' 23:59:59' AND L.CLTCODE >= @FROMCLTCODE AND L.CLTCODE <= @TOCLTCODE               
GROUP BY VDT,CLTCODE               
              
UPDATE #LEDGERBALANCES SET NSEESTIMATED1 = AMOUNT FROM (SELECT CLTCODE, AMOUNT=ISNULL(SUM(AMOUNT),0) FROM #LDEGERESTIMATE L              
WHERE VDT LIKE (SELECT LEFT(CONVERT(VARCHAR,MIN(VDT),109),11) + '%' FROM #LDEGERESTIMATE WHERE L.EXC = EXC AND EXC = 'NSE' ) GROUP BY CLTCODE ) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
              
UPDATE #LEDGERBALANCES SET NSEESTIMATED2 = AMOUNT FROM (SELECT CLTCODE, AMOUNT=ISNULL(SUM(AMOUNT),0) FROM #LDEGERESTIMATE L              
WHERE VDT NOT LIKE (SELECT LEFT(CONVERT(VARCHAR,MIN(VDT),109),11) + '%' FROM #LDEGERESTIMATE WHERE L.EXC = EXC AND EXC = 'NSE' ) GROUP BY CLTCODE ) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
              
UPDATE #LEDGERBALANCES SET BSEESTIMATED1 = AMOUNT FROM (SELECT CLTCODE, AMOUNT=ISNULL(SUM(AMOUNT),0) FROM #LDEGERESTIMATE L              
WHERE VDT LIKE (SELECT LEFT(CONVERT(VARCHAR,MIN(VDT),109),11) + '%' FROM #LDEGERESTIMATE WHERE L.EXC = EXC AND EXC = 'BSE' ) GROUP BY CLTCODE ) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
              
UPDATE #LEDGERBALANCES SET BSEESTIMATED2 = AMOUNT FROM (SELECT CLTCODE, AMOUNT=ISNULL(SUM(AMOUNT),0) FROM #LDEGERESTIMATE L              
WHERE VDT NOT LIKE (SELECT LEFT(CONVERT(VARCHAR,MIN(VDT),109),11) + '%' FROM #LDEGERESTIMATE WHERE L.EXC = EXC AND EXC = 'BSE') GROUP BY CLTCODE ) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
              
UPDATE #LEDGERBALANCES SET FAACTUAL = AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P              
WHERE VDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP <> 2 GROUP BY CLTCODE) A               
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
              
UPDATE #LEDGERBALANCES SET FAACTUAL = FAACTUAL + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNT.DBO.LEDGER L, ACCOUNT.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP = 2 GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
              
UPDATE #LEDGERBALANCES SET FAACTUAL = FAACTUAL + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE VDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP <> 2 GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
              
UPDATE #LEDGERBALANCES SET FAACTUAL =  FAACTUAL + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP = 2 GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               
              
/*UPDATE #LEDGERBALANCES SET FAACTUAL = FAACTUAL + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P              
WHERE VDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP <> 2 GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               */
              
/*UPDATE #LEDGERBALANCES SET FAACTUAL = FAACTUAL + AMT FROM (SELECT CLTCODE, AMT = CONVERT(NUMERIC(18,4),ISNULL(SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END),0))              
FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.PARAMETER P              
WHERE EDT <= @FROMDATE + ' 23:59:59' AND VDT >= SDTCUR AND VDT<= LDTCUR              
AND @FROMDATE BETWEEN SDTCUR AND LDTCUR AND VTYP = 2 GROUP BY CLTCODE) A              
WHERE #LEDGERBALANCES.CLTCODE=A.CLTCODE AND SESSIONID = @SESSION               */
              
UPDATE #LEDGERBALANCES SET NONCASH = C.NONCASH, CASH = C.CASH              
FROM MCDXCDS.DBO.COLLATERAL C               
WHERE TRANS_DATE LIKE @FROMDATE +'%'               
AND #LEDGERBALANCES.CLTCODE=C.PARTY_CODE AND SESSIONID = @SESSION               
              
/*UPDATE #LEDGERBALANCES SET IMMARGIN = ISNULL(MARGIN,0) FROM (SELECT PARTY_CODE, MARGIN = SUM(PSPANMARGIN)                
FROM MCDXCDS.DBO.FOMARGINNEW F WHERE MDATE = (SELECT MAX(MDATE) FROM MCDXCDS.DBO.FOMARGINNEW WHERE MDATE <= @FROMDATE +' 23:59:59' )         
GROUP BY PARTY_CODE ) A              
WHERE #LEDGERBALANCES.CLTCODE=A.PARTY_CODE AND SESSIONID = @SESSION               */
              
/*UPDATE #LEDGERBALANCES SET VARMARGIN = ISNULL(VMARGIN,0) FROM (SELECT PARTY_CODE, VMARGIN = SUM(MTOM)                
FROM MCDXCDS.DBO.FOMARGINNEW F WHERE MDATE = (SELECT MAX(MDATE) FROM MCDXCDS.DBO.FOMARGINNEW WHERE MDATE <= @FROMDATE +' 23:59:59' )         
GROUP BY PARTY_CODE ) A              
WHERE #LEDGERBALANCES.CLTCODE=A.PARTY_CODE AND SESSIONID = @SESSION        */
              
UPDATE #LEDGERBALANCES SET NONCASH = (CASE WHEN (IMMARGIN + VARMARGIN) / 2 < NONCASH THEN  (IMMARGIN + VARMARGIN) / 2 ELSE NONCASH END)         
WHERE SESSIONID = @SESSION               
              
DELETE FROM #LEDGERBALANCES               
WHERE NSEBALANCE   = 0               
AND BSEBALANCE      = 0               
AND NSEFOBALANCE  = 0               
AND NSEESTIMATED1 = 0               
AND NSEESTIMATED2 = 0               
AND BSEESTIMATED1 = 0               
AND BSEESTIMATED2 = 0               
AND FAACTUAL           = 0               
AND NONCASH           = 0               
AND CASH                = 0               
AND IMMARGIN           = 0               
AND VARMARGIN         = 0              
AND SESSIONID = @SESSION               
          
--INSERT INTO LEDGERBALANCES SELECT * FROM #LEDGERBALANCES              
--SELECT * FROM #LEDGERBALANCES  ORDER BY FAMILYCODE,CLTCODE          
/*          
IF @OPT <> 'CLIENT'          
BEGIN          
 IF @OPT = 'BRANCH'          
 SELECT FAMILYCODE,CLTCODE,ACNAME=C.LONG_NAME,          
 NSEBALANCE=SUM(NSEBALANCE),BSEBALANCE=SUM(BSEBALANCE),          
 NSEFOBALANCE=SUM(NSEFOBALANCE),NSEESTIMATED1=SUM(NSEESTIMATED1),           
 NSEESTIMATED2=SUM(NSEESTIMATED2),          
 BSEESTIMATED1=SUM(BSEESTIMATED1),BSEESTIMATED2=SUM(BSEESTIMATED2),          
 FAACTUAL=SUM(FAACTUAL),RES_PHONE1,CASH=SUM(CASH),NONCASH=SUM(NONCASH),          
 IMMARGIN=SUM(IMMARGIN),VARMARGIN=SUM(VARMARGIN)           
 FROM LEDGERBALANCES L, MCDXCDS.DBO.CLIENT1 C           
 WHERE C.CL_CODE = L.CLTCODE AND SESSIONID=@SESSION          
 GROUP BY FAMILYCODE,C.BRANCH_CD,C.LONG_NAME,RES_PHONE1           
 ORDER BY FAMILYCODE,CLTCODE,C.LONG_NAME,RES_PHONE1          
          
END          
ELSE          
BEGIN          
 SELECT FAMILYCODE,CLTCODE,ACNAME,NSEBALANCE,BSEBALANCE,NSEFOBALANCE,NSEESTIMATED1,NSEESTIMATED2,           
 BSEESTIMATED1,BSEESTIMATED2,FAACTUAL,RES_PHONE1,CASH,NONCASH,IMMARGIN,VARMARGIN           
 FROM LEDGERBALANCES L,MCDXCDS.DBO.CLIENTMASTER C           
 WHERE C.PARTY_CODE = L.CLTCODE AND SESSIONID=@SESSION          
 ORDER BY FAMILYCODE,CLTCODE,C.LONG_NAME,RES_PHONE1           
END          
*/            
IF @REPORTOPT='D'        
BEGIN        
 SELECT FAMILYCODE,CLTCODE,ACNAME,NSEBALANCE,BSEBALANCE,NSEFOBALANCE,NSEESTIMATED1,NSEESTIMATED2,           
 BSEESTIMATED1,BSEESTIMATED2,FAACTUAL,RES_PHONE1,CASH,NONCASH,IMMARGIN,VARMARGIN           
 FROM #LEDGERBALANCES L,MCDXCDS.DBO.CLIENTMASTER C           
 WHERE C.PARTY_CODE = L.CLTCODE AND SESSIONID=@SESSION          
 ORDER BY FAMILYCODE,CLTCODE,C.LONG_NAME,RES_PHONE1           
END        
ELSE        
BEGIN        
-- SELECT FAMILYCODE,SUM(NSEBALANCE) AS TOTNSEBALANCE,SUM(BSEBALANCE) AS TOTBSEBALANCE,SUM(NSEFOBALANCE) AS TOTNSEFOBALANCE,        
-- SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) AS TOTTOTALPARTY,        
-- SUM(NSEESTIMATED1) AS TOTNSEESTIMATED1,SUM(NSEESTIMATED2) AS TOTNSEESTIMATED2,           
-- SUM(BSEESTIMATED1) AS TOTBSEESTIMATED1,SUM(BSEESTIMATED2) AS TOTBSEESTIMATED2,        
-- SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) AS TOTESTIMATETOTALPARTY,        
-- SUM(FAACTUAL) AS TOTFAACTUAL,        
-- SUM(FAACTUAL - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) AS TOTFANETPARTY,        
-- SUM(CASH) AS TOTCASH,SUM(NONCASH) AS TOTNONCASH, SUM(IMMARGIN) AS TOTIMMARGIN,SUM(VARMARGIN) AS TOTVARMARGIN,        
-- SUM(FAACTUAL -         
-- (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)         
-- + IMMARGIN + VARMARGIN - NONCASH - CASH) AS TOTFINTOTALPARTY           
-- FROM #LEDGERBALANCES L,MCDXCDS.DBO.CLIENTMASTER C           
-- WHERE C.PARTY_CODE = L.CLTCODE AND SESSIONID=@SESSION          
-- GROUP BY FAMILYCODE        
-- ORDER BY FAMILYCODE        
      
 IF @OPT = 'BRANCH'      
 BEGIN      
/*    
   SELECT C.BRANCH_CD AS FAMILYCODE,B.BRANCH AS ACNAME,SUM(NSEBALANCE) AS TOTNSEBALANCE,SUM(BSEBALANCE) AS TOTBSEBALANCE,SUM(NSEFOBALANCE) AS TOTNSEFOBALANCE,        
   SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) AS TOTTOTALPARTY,        
   SUM(NSEESTIMATED1) AS TOTNSEESTIMATED1,SUM(NSEESTIMATED2) AS TOTNSEESTIMATED2,           
   SUM(BSEESTIMATED1) AS TOTBSEESTIMATED1,SUM(BSEESTIMATED2) AS TOTBSEESTIMATED2,        
   SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) AS TOTESTIMATETOTALPARTY,        
   SUM(FAACTUAL) AS TOTFAACTUAL,        
   SUM(FAACTUAL - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) AS TOTFANETPARTY,        
   SUM(CASH) AS TOTCASH,SUM(NONCASH) AS TOTNONCASH, SUM(IMMARGIN) AS TOTIMMARGIN,SUM(VARMARGIN) AS TOTVARMARGIN,        
   SUM(FAACTUAL -         
   (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)         
   + IMMARGIN + VARMARGIN - NONCASH - CASH) AS TOTFINTOTALPARTY           
   FROM #LEDGERBALANCES L,MCDXCDS.DBO.CLIENT1 C , MCDXCDS.DBO.BRANCH B          
   WHERE C.CL_CODE = L.CLTCODE AND C.BRANCH_CD=B.BRANCH_CODE AND SESSIONID=@SESSION          
   GROUP BY C.BRANCH_CD,B.BRANCH      
   ORDER BY C.BRANCH_CD      
*/    
   SELECT C.BRANCH_CD AS FAMILYCODE,B.BRANCH AS ACNAME,SUM(NSEBALANCE) AS TOTNSEBALANCE,SUM(BSEBALANCE) AS TOTBSEBALANCE,SUM(NSEFOBALANCE) AS TOTNSEFOBALANCE,        
   SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) AS TOTTOTALPARTY,        
   SUM(NSEESTIMATED1) AS TOTNSEESTIMATED1,SUM(NSEESTIMATED2) AS TOTNSEESTIMATED2,           
   SUM(BSEESTIMATED1) AS TOTBSEESTIMATED1,SUM(BSEESTIMATED2) AS TOTBSEESTIMATED2,        
   SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) AS TOTESTIMATETOTALPARTY,        
   SUM(FAACTUAL) AS TOTFAACTUAL,        
   SUM(FAACTUAL - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) AS TOTFANETPARTY,        
   SUM(CASH) AS TOTCASH,SUM(NONCASH) AS TOTNONCASH, SUM(IMMARGIN) AS TOTIMMARGIN,SUM(VARMARGIN) AS TOTVARMARGIN,        
   SUM(FAACTUAL + IMMARGIN + VARMARGIN + NONCASH + CASH) AS TOTFINTOTALPARTY              
   FROM #LEDGERBALANCES L,MCDXCDS.DBO.CLIENT1 C , MCDXCDS.DBO.BRANCH B          
   WHERE C.CL_CODE = L.CLTCODE AND C.BRANCH_CD=B.BRANCH_CODE AND SESSIONID=@SESSION          
   GROUP BY C.BRANCH_CD,B.BRANCH      
   ORDER BY C.BRANCH_CD      
    
 END      
 ELSE IF @OPT = 'FAMILY'      
 BEGIN      
   SELECT FAMILYCODE,FAMILYCODE AS ACNAME,SUM(NSEBALANCE) AS TOTNSEBALANCE,SUM(BSEBALANCE) AS TOTBSEBALANCE,SUM(NSEFOBALANCE) AS TOTNSEFOBALANCE,        
  SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) AS TOTTOTALPARTY,        
  SUM(NSEESTIMATED1) AS TOTNSEESTIMATED1,SUM(NSEESTIMATED2) AS TOTNSEESTIMATED2,           
  SUM(BSEESTIMATED1) AS TOTBSEESTIMATED1,SUM(BSEESTIMATED2) AS TOTBSEESTIMATED2,        
  SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) AS TOTESTIMATETOTALPARTY,        
  SUM(FAACTUAL) AS TOTFAACTUAL,        
  SUM(FAACTUAL - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) AS TOTFANETPARTY,        
  SUM(CASH) AS TOTCASH,SUM(NONCASH) AS TOTNONCASH, SUM(IMMARGIN) AS TOTIMMARGIN,SUM(VARMARGIN) AS TOTVARMARGIN,        
  SUM(FAACTUAL + IMMARGIN + VARMARGIN + NONCASH + CASH) AS TOTFINTOTALPARTY             
  FROM #LEDGERBALANCES L,MCDXCDS.DBO.CLIENTMASTER C           
  WHERE C.PARTY_CODE = L.CLTCODE AND SESSIONID=@SESSION          
  GROUP BY FAMILYCODE        
  ORDER BY FAMILYCODE        
 END      
 ELSE IF @OPT = 'SUBBROKER'      
 BEGIN      
   SELECT C.SUB_BROKER AS FAMILYCODE,B.NAME AS ACNAME,SUM(NSEBALANCE) AS TOTNSEBALANCE,SUM(BSEBALANCE) AS TOTBSEBALANCE,SUM(NSEFOBALANCE) AS TOTNSEFOBALANCE,        
   SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) AS TOTTOTALPARTY,        
   SUM(NSEESTIMATED1) AS TOTNSEESTIMATED1,SUM(NSEESTIMATED2) AS TOTNSEESTIMATED2,           
   SUM(BSEESTIMATED1) AS TOTBSEESTIMATED1,SUM(BSEESTIMATED2) AS TOTBSEESTIMATED2,        
   SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) AS TOTESTIMATETOTALPARTY,        
   SUM(FAACTUAL) AS TOTFAACTUAL,        
   SUM(FAACTUAL - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) AS TOTFANETPARTY,        
   SUM(CASH) AS TOTCASH,SUM(NONCASH) AS TOTNONCASH, SUM(IMMARGIN) AS TOTIMMARGIN,SUM(VARMARGIN) AS TOTVARMARGIN,        
   SUM(FAACTUAL + IMMARGIN + VARMARGIN + NONCASH + CASH) AS TOTFINTOTALPARTY              
   FROM #LEDGERBALANCES L,MCDXCDS.DBO.CLIENT1 C,MCDXCDS.DBO.SUBBROKERS B           
   WHERE C.CL_CODE = L.CLTCODE AND C.SUB_BROKER=B.SUB_BROKER AND SESSIONID=@SESSION          
   GROUP BY C.SUB_BROKER,B.NAME      
   ORDER BY C.SUB_BROKER      
 END      
 ELSE IF @OPT = 'TRADER'      
 BEGIN      
   SELECT C.TRADER AS FAMILYCODE,B.SHORT_NAME AS ACNAME,SUM(NSEBALANCE) AS TOTNSEBALANCE,SUM(BSEBALANCE) AS TOTBSEBALANCE,SUM(NSEFOBALANCE) AS TOTNSEFOBALANCE,        
   SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) AS TOTTOTALPARTY,        
   SUM(NSEESTIMATED1) AS TOTNSEESTIMATED1,SUM(NSEESTIMATED2) AS TOTNSEESTIMATED2,           
   SUM(BSEESTIMATED1) AS TOTBSEESTIMATED1,SUM(BSEESTIMATED2) AS TOTBSEESTIMATED2,        
   SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) AS TOTESTIMATETOTALPARTY,        
   SUM(FAACTUAL) AS TOTFAACTUAL,        
   SUM(FAACTUAL - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) AS TOTFANETPARTY,        
   SUM(CASH) AS TOTCASH,SUM(NONCASH) AS TOTNONCASH, SUM(IMMARGIN) AS TOTIMMARGIN,SUM(VARMARGIN) AS TOTVARMARGIN,        
   SUM(FAACTUAL + IMMARGIN + VARMARGIN + NONCASH + CASH) AS TOTFINTOTALPARTY              
   FROM #LEDGERBALANCES L,MCDXCDS.DBO.CLIENT1 C , MCDXCDS.DBO.BRANCHES B          
   WHERE C.CL_CODE = L.CLTCODE AND C.BRANCH_CD=B.BRANCH_CD AND SESSIONID=@SESSION          
   GROUP BY C.TRADER,B.SHORT_NAME      
   ORDER BY C.TRADER      
 END      
 ELSE IF @OPT = 'AREA'      
 BEGIN      
   SELECT C.AREA AS FAMILYCODE,B.DESCRIPTION AS ACNAME,SUM(NSEBALANCE) AS TOTNSEBALANCE,SUM(BSEBALANCE) AS TOTBSEBALANCE,SUM(NSEFOBALANCE) AS TOTNSEFOBALANCE,        
   SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) AS TOTTOTALPARTY,        
   SUM(NSEESTIMATED1) AS TOTNSEESTIMATED1,SUM(NSEESTIMATED2) AS TOTNSEESTIMATED2,           
   SUM(BSEESTIMATED1) AS TOTBSEESTIMATED1,SUM(BSEESTIMATED2) AS TOTBSEESTIMATED2,        
   SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) AS TOTESTIMATETOTALPARTY,        
   SUM(FAACTUAL) AS TOTFAACTUAL,        
   SUM(FAACTUAL - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) AS TOTFANETPARTY,        
   SUM(CASH) AS TOTCASH,SUM(NONCASH) AS TOTNONCASH, SUM(IMMARGIN) AS TOTIMMARGIN,SUM(VARMARGIN) AS TOTVARMARGIN,        
   SUM(FAACTUAL + IMMARGIN + VARMARGIN + NONCASH + CASH) AS TOTFINTOTALPARTY              
   FROM #LEDGERBALANCES L,MCDXCDS.DBO.CLIENT1 C,MCDXCDS.DBO.AREA B           
   WHERE C.CL_CODE = L.CLTCODE AND C.AREA=B.AREACODE AND SESSIONID=@SESSION          
   GROUP BY C.AREA,B.DESCRIPTION      
   ORDER BY C.AREA       
 END      
 ELSE      
 BEGIN      
   SELECT C.CL_CODE AS FAMILYCODE,C.SHORT_NAME AS ACNAME,SUM(NSEBALANCE) AS TOTNSEBALANCE,SUM(BSEBALANCE) AS TOTBSEBALANCE,SUM(NSEFOBALANCE) AS TOTNSEFOBALANCE,        
   SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE ) AS TOTTOTALPARTY,        
   SUM(NSEESTIMATED1) AS TOTNSEESTIMATED1,SUM(NSEESTIMATED2) AS TOTNSEESTIMATED2,           
   SUM(BSEESTIMATED1) AS TOTBSEESTIMATED1,SUM(BSEESTIMATED2) AS TOTBSEESTIMATED2,        
   SUM(NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2) AS TOTESTIMATETOTALPARTY,        
   SUM(FAACTUAL) AS TOTFAACTUAL,        
   SUM(FAACTUAL - (NSEBALANCE + BSEBALANCE + NSEFOBALANCE + NSEESTIMATED1 + NSEESTIMATED2 + BSEESTIMATED1 + BSEESTIMATED2)) AS TOTFANETPARTY,        
   SUM(CASH) AS TOTCASH,SUM(NONCASH) AS TOTNONCASH, SUM(IMMARGIN) AS TOTIMMARGIN,SUM(VARMARGIN) AS TOTVARMARGIN,        
   SUM(FAACTUAL + IMMARGIN + VARMARGIN + NONCASH + CASH) AS TOTFINTOTALPARTY           
   FROM #LEDGERBALANCES L,MCDXCDS.DBO.CLIENT1 C           
   WHERE C.CL_CODE = L.CLTCODE AND SESSIONID=@SESSION          
   GROUP BY C.CL_CODE,C.SHORT_NAME      
   ORDER BY CL_CODE        
 END      
END           
          
DROP TABLE #LEDGERBALANCES

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MARGINYEAREND
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.MARGINYEAREND    SCRIPT DATE: 05/10/2004 5:29:33 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.MARGINYEAREND    SCRIPT DATE: 03/28/2003 4:34:58 PM ******/
CREATE PROCEDURE MARGINYEAREND
@SDTCUR VARCHAR(11),
@LDTCUR VARCHAR(11),
@VTYP   SMALLINT,
@VNO VARCHAR(12),
@BOOKTYPE CHAR(2),
@VDT    DATETIME

AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE
@@CLTCODE  AS VARCHAR(10),
@@LNO      AS INT,
@@RCURSOR  AS CURSOR

INSERT INTO MARGINLEDGER
SELECT @VTYP, @VNO, 0, (CASE WHEN T.BAL >= 0 THEN 'D' ELSE 'C' END), @VDT, ABS(T.BAL), T.PARTY_CODE,
T.EXCHANGE, RTRIM(T.SEGMENT), 0, '', @BOOKTYPE, T.MCLTCODE
FROM
(SELECT MCLTCODE, EXCHANGE, SEGMENT, PARTY_CODE, BAL=SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)
FROM MARGINLEDGER WHERE VDT >= @SDTCUR + ' 00:00:00' AND VDT <= @LDTCUR + ' 23:59:59'
GROUP BY MCLTCODE, EXCHANGE, SEGMENT, PARTY_CODE) T


SET @@RCURSOR = CURSOR FOR
SELECT CLTCODE, LNO FROM LEDGER WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO
ORDER BY CLTCODE

OPEN @@RCURSOR
FETCH NEXT FROM @@RCURSOR 
INTO @@CLTCODE, @@LNO

WHILE @@FETCH_STATUS = 0
BEGIN
   UPDATE MARGINLEDGER SET LNO = @@LNO WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO AND MCLTCODE = @@CLTCODE

   FETCH NEXT FROM @@RCURSOR 
   INTO @@CLTCODE, @@LNO
END

CLOSE @@RCURSOR
DEALLOCATE @@RCURSOR

/* FOR EFFECTIVE DATEWISE MARGIN O/P BALANCES */

UPDATE MARGINLEDGER SET SETT_NO = T.BAL
FROM
(
SELECT MCLTCODE, EXCHANGE, SEGMENT, PARTY_CODE, BAL=SUM( CASE WHEN UPPER(M.DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)
FROM MARGINLEDGER M, LEDGER L
WHERE M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO
AND L.EDT >= @SDTCUR + ' 00:00:00' AND L.EDT <= @LDTCUR +' 23:59:59'
GROUP BY MCLTCODE, EXCHANGE, SEGMENT, PARTY_CODE) T
WHERE MARGINLEDGER.MCLTCODE = T.MCLTCODE AND MARGINLEDGER.EXCHANGE = T.EXCHANGE AND MARGINLEDGER.SEGMENT=T.SEGMENT
AND MARGINLEDGER.PARTY_CODE = T.PARTY_CODE AND MARGINLEDGER.VTYP = 18

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MULTIBANKDETAILS
-- --------------------------------------------------


CREATE PROC MULTIBANKDETAILS ( @PARTY_CODE VARCHAR(15))
AS 

 --SET @PARTY_CODE ='RP61'

SELECT BANK_NAME,BRANCH_NAME,ACCNO,ID_STATUS,CONVERT(VARCHAR(11),MODIFY_DATE,120) AS MODIFY_DATE,EXCHANGE  FROM 
(
SELECT BANKID,ACCNO,DEFAULTBANK,'' AS ID_STATUS,'' MODIFY_DATE,'NSE' AS EXCHANGE FROM MULTIBANKID WHERE CLTCODE = @PARTY_CODE
UNION ALL
SELECT BANKID,ACCNO,DEFAULTBANK,Action,Action_ModifiedDate,'NSE' AS EXCHANGE FROM MULTIBANKID_AUDIT WHERE CLTCODE = @PARTY_CODE
)A
LEFT OUTER JOIN 
MSAJAG.DBO.POBANK AS B
ON A.BANKID =B.BANKID
ORDER BY ID_STATUS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWACC_TRIALBALANCE
-- --------------------------------------------------



CREATE PROCEDURE  NEWACC_TRIALBALANCE

/* REPORT : TRIAL BALANCE        
PRINTS TRIAL BALANCE */

@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */
@CURRYRSTDATE VARCHAR(11), 	/* START DATE OF FINANCIAL YEAR */
@OPENENTRYFLAG INT, 
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */
@SORTBYDATE VARCHAR(3),         /* WHETHER REPORT IS BASED ON VDT OR EDT */
@FROMAMT    MONEY,              /* FROM AMOUNT ENTERED BY USER */
@TOAMT      MONEY,              /* TO AMOUNT ENTERED BY USER */
@FROMAC     VARCHAR(35),        /* FROM ACCOUNT/NAME ENTERED BY USER */
@TOAC       VARCHAR(35)         /* TO ACCOUNT/NAME ENTERED BY USER */
AS

DECLARE
@@SELECTQURY  AS VARCHAR(8000), 
@@FROMTABLES  AS VARCHAR(2000), 
@@WHEREPART   AS VARCHAR(1000), 
@@WHEREPART1  AS VARCHAR(500), 
@@WHEREPART2  AS VARCHAR(500), 
@@WHEREPART3  AS VARCHAR(500), 
@@ADDWHERE    AS VARCHAR(200), 
@@GROUPBY     AS VARCHAR(200), 
@@SORTBY      AS VARCHAR(200), 
@@COSTCODE    AS VARCHAR(3), 
@@WHEREAC     AS VARCHAR(500)

IF @STATUSID = 'BROKER'
BEGIN
	SELECT @@GROUPBY    = " GROUP BY L.CLTCODE , A.ACNAME, BRANCHCODE"
END
ELSE
BEGIN
	SELECT @@GROUPBY    = " GROUP BY L2.CLTCODE , A.ACNAME, BRANCHCODE"
END

IF @STATUSID = 'BROKER'
BEGIN
   IF @FLAG = 'CODEWISE'
      BEGIN
	   SELECT @@SORTBY = " ORDER BY  L.CLTCODE , A.ACNAME, BRANCHCODE"
      END
   ELSE
      BEGIN
	   SELECT @@SORTBY = " ORDER BY  A.ACNAME, L.CLTCODE, BRANCHCODE"
   END
END
ELSE
BEGIN
   IF @FLAG = 'CODEWISE'
      BEGIN
	   SELECT @@SORTBY = " ORDER BY  L2.CLTCODE , A.ACNAME, BRANCHCODE"
      END
   ELSE
      BEGIN
	   SELECT @@SORTBY = " ORDER BY  A.ACNAME, L2.CLTCODE, BRANCHCODE"
   END

END



IF @VIEWOPTION = 'PARTYWISE'  /* ONLY PARTY ACCOUNTS TO BE DISPLAYED */
BEGIN
   SELECT @@ADDWHERE  = " AND A.ACCAT = 4 " 
END
ELSE IF @VIEWOPTION = 'GL'  /* ONLY PARTY ACCOUNTS TO BE DISPLAYED */
     BEGIN
        SELECT @@ADDWHERE  = " AND A.ACCAT <> 4 " 
     END
     ELSE
     BEGIN
        SELECT @@ADDWHERE  = " " 
     END

IF @STATUSID = 'BROKER'
BEGIN
   IF @SORTBYDATE = 'VDT'
   BEGIN
      SELECT @@WHEREPART1 = " WHERE VDT <= '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'" 
      SELECT @@WHEREPART3 = " WHERE VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'" 
   END
   ELSE
   BEGIN
      SELECT @@WHEREPART1 = " WHERE EDT <= '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE EDT >= '" + @CURRYRSTDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59'" 
      SELECT @@WHEREPART3 = " WHERE EDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59'" 
   END
END
ELSE IF @STATUSID = 'BRANCH'
BEGIN
   SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )
   IF @SORTBYDATE = 'VDT'
   BEGIN
      SELECT @@WHEREPART1 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND VDT <= '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'" 
      SELECT @@WHEREPART3 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'" 
   END
   ELSE
   BEGIN
      SELECT @@WHEREPART1 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND EDT <= '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND EDT >= '" + @CURRYRSTDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59'" 
    SELECT @@WHEREPART3 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND EDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59'" 
   END
END

IF LEN(RTRIM(@FROMAC)) <> 0 
BEGIN
   IF LEN(RTRIM(@TOAC)) <> 0  
       BEGIN
          IF @FLAG = 'CODEWISE' 
             SELECT @@ADDWHERE = @@ADDWHERE + " AND L.CLTCODE >= '" + @FROMAC + "' AND L.CLTCODE <= '" + @TOAC + "' "
          ELSE
             SELECT @@ADDWHERE = @@ADDWHERE + " AND A.ACNAME >= '" + @FROMAC + "' AND A.ACNAME <= '" + @TOAC + "' "
       END
    ELSE
       BEGIN
          IF @FLAG = 'CODEWISE' 
             SELECT @@ADDWHERE = @@ADDWHERE + " AND L.CLTCODE >= '" + @FROMAC + "' "
          ELSE
             SELECT @@ADDWHERE = @@ADDWHERE + " AND A.ACNAME >= '" + @FROMAC + "' "
       END
END
ELSE
BEGIN
   IF LEN(RTRIM(@TOAC)) <> 0  
       BEGIN
          IF @FLAG = 'CODEWISE' 
             SELECT @@ADDWHERE = @@ADDWHERE + " AND L.CLTCODE <= '" + @TOAC + "' "
          ELSE
             SELECT @@ADDWHERE = @@ADDWHERE + " AND A.ACNAME <= '" + @TOAC + "' "
       END
END


/*  -- FOR BROKER --  */
/* ------------------ */

IF @STATUSID = 'BROKER'
BEGIN
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/
IF @BALANCE='NORMAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END), 0)"
      SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END), 0)"
      SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
      SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, AMOUNT = INSULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END), 0)"
      SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
/*--- IF USER WANTS TO SEE TRIAL BALANCE WITH OPENING BALANCES ---*/
ELSE IF @BALANCE='WITHOPBAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, DRTOT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END), 0), CRTOT = SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END), OPBAL = 0 "
            SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
       SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END) "
           SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN VTYP = 18 THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)"
            SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END) "
           SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END) "
      SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
END    /* END OG STATUSID = 'BROKER'  */


/*  -- FOR BRANCH SELECTION --  */
/* ---------------------------- */

IF @STATUSID = 'BRANCH'
BEGIN
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/
IF @BALANCE='NORMAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      SELECT @@SELECTQURY = " SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)"
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      SELECT @@SELECTQURY = " SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)"
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = " SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)"
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
ELSE IF @BALANCE='WITHOPBAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, DRTOT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END), CRTOT = SUM(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END), OPBAL = 0 "
            SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, DRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END) "
           SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, DRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN L.VTYP = 18 THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END)"
            SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
            SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, DRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END) "
           SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = "SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME, ''), BRANCHCODE, DRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END) "
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
END /* END OF BRANCH LOGIN OR BRANCH SELECTION FROM BROKER LOGIN */

PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY  

EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWACC_TRIALBALANCEPARTYTOTAL
-- --------------------------------------------------



CREATE PROCEDURE  NEWACC_TRIALBALANCEPARTYTOTAL
/* REPORT : TRIAL BALANCE        
PRINTS TRIAL BALANCE */
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */
@OPENENTRYFLAG INT, 
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT < = LAST DATE ENTERED BY USER */
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */
@SORTBYDATE VARCHAR(3),         /* WHETHER REPORT IS BASED ON VDT OR EDT */
@FROMAMT    MONEY,              /* FROM AMOUNT ENTERED BY USER */
@TOAMT      MONEY,              /* TO AMOUNT ENTERED BY USER */
@FROMAC     VARCHAR(35),        /* FROM ACCOUNT/NAME ENTERED BY USER */
@TOAC       VARCHAR(35)         /* TO ACCOUNT/NAME ENTERED BY USER */
AS
DECLARE
@@SELECTQURY  AS VARCHAR(8000), 
@@FROMTABLES  AS VARCHAR(2000), 
@@WHEREPART   AS VARCHAR(1000), 
@@WHEREPART1  AS VARCHAR(500), 
@@WHEREPART2  AS VARCHAR(500), 
@@WHEREPART3  AS VARCHAR(500), 
@@ADDWHERE    AS VARCHAR(200), 
@@GROUPBY     AS VARCHAR(200), 
@@SORTBY      AS VARCHAR(200), 
@@COSTCODE    AS VARCHAR(3), 
@@WHEREAC     AS VARCHAR(500)
SELECT @@GROUPBY = " "
SELECT @@SORTBY  = " "
SELECT @@ADDWHERE  = " AND A.ACCAT = 4 " 
IF @STATUSID = 'BROKER'
BEGIN
   IF @SORTBYDATE = 'VDT'
   BEGIN
      SELECT @@WHEREPART1 = " WHERE VDT < = '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE VDT > = '" + @CURRYRSTDATE + " 00:00:00' AND VDT < = '" + @VDT + " 23:59:59'" 
      SELECT @@WHEREPART3 = " WHERE VDT > = '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT < = '" + @VDT + " 23:59:59'" 
   END
   ELSE
   BEGIN
      SELECT @@WHEREPART1 = " WHERE EDT < = '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE EDT > = '" + @CURRYRSTDATE + " 00:00:00' AND EDT < = '" + @VDT + " 23:59:59'" 
      SELECT @@WHEREPART3 = " WHERE EDT > = '" + @OPENINGENTRYDATE + " 00:00:00' AND EDT < = '" + @VDT + " 23:59:59'" 
   END
END
ELSE IF @STATUSID = 'BRANCH'
BEGIN
   SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )
   IF @SORTBYDATE = 'VDT'
   BEGIN
      SELECT @@WHEREPART1 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND VDT < = '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND VDT > = '" + @CURRYRSTDATE + " 00:00:00' AND VDT < = '" + @VDT + " 23:59:59'" 
      SELECT @@WHEREPART3 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND VDT > = '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT < = '" + @VDT + " 23:59:59'" 
   END
   ELSE
   BEGIN
      SELECT @@WHEREPART1 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND EDT < = '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND EDT > = '" + @CURRYRSTDATE + " 00:00:00' AND EDT < = '" + @VDT + " 23:59:59'" 
    SELECT @@WHEREPART3 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND EDT > = '" + @OPENINGENTRYDATE + " 00:00:00' AND EDT < = '" + @VDT + " 23:59:59'" 
   END
END
IF LEN(RTRIM(@FROMAC)) <> 0 
BEGIN
   IF LEN(RTRIM(@TOAC)) <> 0  
       BEGIN
          IF @FLAG = 'CODEWISE' 
             SELECT @@ADDWHERE = @@ADDWHERE + " AND L.CLTCODE > = '" + @FROMAC + "' AND L.CLTCODE < = '" + @TOAC + "' "
          ELSE
             SELECT @@ADDWHERE = @@ADDWHERE + " AND L.ACNAME > = '" + @FROMAC + "' AND L.ACNAME < = '" + @TOAC + "' "
       END
    ELSE
       BEGIN
          IF @FLAG = 'CODEWISE' 
             SELECT @@ADDWHERE = @@ADDWHERE + " AND L.CLTCODE > = '" + @FROMAC + "' "
          ELSE
             SELECT @@ADDWHERE = @@ADDWHERE + " AND L.ACNAME > = '" + @FROMAC + "' "
       END
END
ELSE
BEGIN
   IF LEN(RTRIM(@TOAC)) <> 0  
       BEGIN
          IF @FLAG = 'CODEWISE' 
             SELECT @@ADDWHERE = @@ADDWHERE + " AND L.CLTCODE < = '" + @TOAC + "' "
          ELSE
             SELECT @@ADDWHERE = @@ADDWHERE + " AND L.ACNAME < = '" + @TOAC + "' "
       END
END
/*  -- FOR BROKER --  */
/* ------------------ */
IF @STATUSID = 'BROKER'
BEGIN
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/
IF @BALANCE = 'NORMAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      SELECT @@SELECTQURY = "SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END)"
      SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE " 
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      SELECT @@SELECTQURY = "SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END)"
      SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE " 
      SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = "SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END)"
      SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
/*--- IF USER WANTS TO SEE TRIAL BALANCE WITH OPENING BALANCES ---*/
ELSE IF @BALANCE = 'WITHOPBAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT DRTOT = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END), CRTOT = SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END), OPBAL = 0 "
            SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE " 
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT > = '" + @STDATE + "' THEN ( CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN VTYP <> 18 AND
 
 VDT > = '" + @STDATE + "' THEN ( CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END) "
           SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE " 
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT > = '" + @STDATE + "' THEN ( CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN VTYP <> 18 AND
 VDT > = '" + @STDATE + "' THEN ( CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN VTYP = 18 THEN ( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)"
            SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE " 
            SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT > = '" + @STDATE + "' THEN ( CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN VTYP <> 18 AND 
VDT > = '" + @STDATE + "' THEN ( CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END) "
           SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE " 
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = "SELECT DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT > = '" + @STDATE + "' THEN ( CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >
 = '" + @STDATE + "' THEN ( CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END) "
      SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
END    /* END OG STATUSID = 'BROKER'  */
/*  -- FOR BRANCH SELECTION --  */
/* ---------------------------- */
IF @STATUSID = 'BRANCH'
BEGIN
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/
IF @BALANCE = 'NORMAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      SELECT @@SELECTQURY = " SELECT AMOUNT = SUM(CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE -CAMT END)"
      SELECT @@FROMTABLES = " FROM LEDGER2 L2, LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      SELECT @@SELECTQURY = " SELECT AMOUNT = SUM(CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE -CAMT END)"
      SELECT @@FROMTABLES = " FROM LEDGER2 L2, LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = " SELECT AMOUNT = SUM(CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE -CAMT END)"
      SELECT @@FROMTABLES = " FROM LEDGER2 L2, LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
ELSE IF @BALANCE = 'WITHOPBAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT DRTOT = SUM(CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE 0 END), CRTOT = SUM(CASE WHEN L2.DRCR = 'C' THEN CAMT ELSE 0 END), OPBAL = 0 "
            SELECT @@FROMTABLES = " FROM LEDGER2 L2, LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE  " 
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT DRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT > = '" + @STDATE + "' THEN ( CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN L.VTYP <
> 18 AND L.VDT > = '" + @STDATE + "' THEN ( CASE WHEN L2.DRCR = 'C' THEN CAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END) "
           SELECT @@FROMTABLES = " FROM LEDGER2 L2, LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE  " 
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT DRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT > = '" + @STDATE + "' THEN ( CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN L.VTYP 
 <> 18 AND L.VDT > = '" + @STDATE + "' THEN ( CASE WHEN L2.DRCR = 'C' THEN CAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN L.VTYP = 18 THEN ( CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END)"
            SELECT @@FROMTABLES = " FROM LEDGER2 L2, LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE  " 
            SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT DRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT > = '" + @STDATE + "' THEN ( CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN L.VTYP <
> 18 AND L.VDT > = '" + @STDATE + "' THEN ( CASE WHEN L2.DRCR = 'C' THEN CAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END) "
           SELECT @@FROMTABLES = " FROM LEDGER2 L2, LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE  " 
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = "SELECT DRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT > = '" + @STDATE + "' THEN ( CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN L.VTYP <> 18 
AND L.VDT > = '" + @STDATE + "' THEN ( CASE WHEN DRCR = 'C' THEN CAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END) "
      SELECT @@FROMTABLES = " FROM LEDGER2 L2, LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE =  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
END /* END OF BRANCH LOGIN OR BRANCH SELECTION FROM BROKER LOGIN */
PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY  
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWACMULTIINSERT
-- --------------------------------------------------
CREATE Procedure [dbo].[Newacmultiinsert]            
@Vtyp Smallint,                 
@Booktype Char(2),                 
@Vno Varchar(12),                 
@Lno Int,                 
@Vdt Varchar(11),                 
@Edt Varchar(11),                 
@Cltcode Varchar(10),                 
@Drcr Char(1),                  
@Vamt Money,                 
@Enteredby Varchar(25),                 
@Cdt Datetime, /*varchar(30), */                
@Checkedby Varchar(25),                 
@Pdt Datetime, /*varchar(30), */                
@Acname Varchar(50),                 
@Narration Varchar(234),                 
@Chequeinname Varchar(50),                 
@Chqprinted Tinyint,                 
@Accat Int,                 
@Bnkname Varchar(50),                 
@Brnname Varchar(30),                 
@Dd Char(1),                 
@Ddno Varchar(15),                 
@Dddt Datetime,                 
@Reldt Datetime,                 
@Relamt Money,                 
@Micrno Int,                 
@Sessionid Int,                 
@Branchname Char(10),                 
@Costflag Varchar(1),                 
@Costrowid Int,                 
@Clearingmode Char(1),                 
@Emode Char(1)                
/*slipno, , Chequeinname, Chqprinted*/                
As                
Declare                
@@Vno1 As Varchar(12),                 
@@Refno Char(12),                 
@@Nodays Int,                 
@@Actnodays Int,                 
@@Balamt Money,                 
@@Slipno Smallint,                 
@@Slipdate Datetime,                 
@@Clearingmode Char(2),                 
@@Receiptno Int,                 
@@Branch As Char(15),                 
@@Exchange As Varchar(3),                 
@@Segment As Varchar(10),                 
@@Sett_no As Varchar(7),                 
@@Sett_type As Varchar(3),                 
@@Party_code As Varchar(10),                 
@@Vdt1 As Datetime,                 
@@Edt1 As Datetime,                 
@@Dddt1 As Datetime,                 
@@Reldt1 As Datetime,                 
@@Recordcount As Int                
Select @@Vdt1 = Convert(Datetime, @Vdt+' '+convert(Varchar, Getdate(), 114))                
Select @@Edt1 = Convert(Datetime, @Edt+' '+convert(Varchar, Getdate(), 114))                
Select @@Dddt1 = Convert(Datetime, Substring(Convert(Varchar, @Dddt, 109), 1, 11)+' '+convert(Varchar, Getdate(), 114))                
/* Select @@Reldt1 = Convert(Datetime, Substring(Convert(Varchar, @Reldt, 109), 1, 11)+' 00:00:00' */                
Select @@Reldt1 = @Reldt                
Select @@Vno1 = @Vno                
Select @@Refno = ''                
Select @@Nodays = 0                
Select @@Actnodays  = 0                
Select @@Balamt = 0                
Select @@Slipno = 0                
Select @@Slipdate = ''                
/*select @@Clearingmode = ' ' */                
Select @@Receiptno = 0                
Select @@Branch =  'Branch'                
/* Inserting Record In Ledger */                
Insert Into Ledger(Vtyp, Vno, Drcr, Vamt, Vdt, Refno, Cltcode, Enteredby, Lno, Balamt,                 
Vno1, Booktype, Edt, Cdt, Pdt, Nodays, Actnodays, Checkedby, Acname, Narration)                 
Values (@Vtyp, @Vno, @Drcr, @Vamt, @@Vdt1, @@Refno, Upper(@Cltcode), @Enteredby, @Lno, @@Balamt,                 
@@Vno1, @Booktype, @@Edt1, @Cdt, @Pdt, @@Nodays, @@Actnodays, @Checkedby, @Acname, @Narration)                
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */                
/* Inserting Record In Ledger3 */                
Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values                
(@Lno, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)                
/* Inserting Common Narration In Ledger3 */                
If @Lno = 2                 
Begin                
       Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values                
       (0, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)                
End                 
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */                
/* Inserting Record In Ledger1 In Case Of Bank Related Vouchers*/                
If @Vtyp = 2 Or @Vtyp = 3 Or @Vtyp = 5 Or @Vtyp = 16 Or @Vtyp = 17  Or @Vtyp = 19 Or @Vtyp = 20                 
Begin              
    
   If (@Vtyp = 2 Or @Vtyp = 19 Or @Vtyp = 16)                
      Begin                
 If   ( @Drcr = 'C' Or @Drcr = 'C' ) And @Lno = 2                
      Begin      
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)                
     Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)                
     End                 
      End                 
    Else If (@Vtyp = 3 Or @Vtyp = 20 Or @Vtyp = 17)                
        Begin                
   If  ( @Drcr = 'D' Or @Drcr = 'D' ) And @Lno = 2                
                 
   Begin                
        Insert Into Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)                
            Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)                
      Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)                
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)                
                  End                 
     End                
    Else If @Vtyp = 5                
        Begin                
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)                
         Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @@Reldt1, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)                
   If @Accat = 2 And @Drcr = 'C'                
   Begin                
           Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)                
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)                
   End                
        End                
End                
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */                
/* Inserting Records In Matchdetails And Updating Billmatch */                
If @Lno = 2                 
Begin                
      Delete  From Tempbilldetails Where Payamount = 0 And Rtrim(Sessionid) = Rtrim(@Sessionid)                
       Update Billmatch Set Billmatch.Balamt = Billmatch.Balamt - Payamount From Tempbilldetails T                
        Where  Rtrim(T.Sessionid) = Rtrim(@Sessionid)                 
        And T.Party_code = Billmatch.Party_code And T.Billvtype = Billmatch.Vtype And T.Billbooktype = Billmatch.Booktype                 
        And T.Billvno = Billmatch.Vno And T.Billlno = Billmatch.Lno   
        Insert Into Matchdetails                
        Select Description, Upper(Party_code), Billvtype, Billvno, Billlno, Billbooktype, Drcr, Payamount, Vtype, @Vno, @Lno, Booktype                
        From Tempbilldetails Where  Rtrim(Sessionid) = Rtrim(@Sessionid)                 
End                
/* Insertting Records In Margin Ledger */                
If @Accat = 14 And (@Vtyp = 19 Or @Vtyp = 20 Or @Vtyp = 22 Or @Vtyp = 23 Or @Vtyp = 24)                
Begin                
   Insert Into Marginledger(Vtyp, Vno, Lno, Drcr, Vdt, Amount, Party_code, Exchange, Segment, Sett_no, Sett_type, Booktype, Mcltcode)                
   Values (@Vtyp, @Vno, @Lno, @Drcr, @@Vdt1, @Vamt, Upper(@@Party_code), @@Exchange, @@Segment, 0, @@Sett_type, @Booktype, Upper(@Cltcode))                
End                
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */                
If (@Vtyp = '8' or @Vtyp = '19' or @Vtyp = '20' or @Vtyp = '24') And Upper(@Emode) = 'M'                  
Begin                
Declare @Recordcounter Smallint           Declare @Partycode Varchar(50)                   
 Declare Cur_ledger_insert Cursor For                   
        Select Count(Party_code), Party_code From Templedger2 Where                   
        Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And                 
 Booktype = @Booktype And Sessionid = @Sessionid And Party_code = @Cltcode and costflag = 'A'  Group By Party_code                
                  
        Open Cur_ledger_insert                  
                  
        Fetch Next From Cur_ledger_insert                 
        Into @Recordcounter, @Partycode                
While @@Fetch_status = 0                  
Begin                 
--if  @Partycode <> @Cltcode                
If @Recordcounter = 1                
 Begin                
        Delete From Templedger2 Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid                 
 --       Insert Into Templedger2 Values (@@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )                  
End                
/* Else                
 Begin                
  Update Templedger2 Set Paidamt = @Vamt Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid                 
 End*/                
Fetch Next From Cur_ledger_insert                   
                   
End                  
                  
Close Cur_ledger_insert                  
Deallocate Cur_ledger_insert                  
End                 
/* Inserting Record In Templedger2 For Branch Wise Breakup When Brnachflag = 1 And Match_ctoc = 1 In Parameter For Selected Year*/                
If Upper(@Emode) = 'A' Or Upper(@Emode) = 'M'                
/*select @@Recordcount = Count(Party_code) From Templedger2 Where                 
Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid And Party_code = Upper(@Cltcode) And Paidamt = @Vamt                
If @@Recordcount = 0                
Begin*/                
Begin                
 Insert Into Templedger2 Values ( @@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )                
End                
--end                
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWACMULTIINSERT_01112011
-- --------------------------------------------------
 CREATE PROCEDURE NEWACMULTIINSERT_01112011          
@VTYP SMALLINT,                     
@BOOKTYPE CHAR(2),                     
@VNO VARCHAR(12),                     
@LNO INT,                     
@VDT VARCHAR(11),                     
@EDT VARCHAR(11),                     
@CLTCODE VARCHAR(10),                     
@DRCR CHAR(1),                      
@VAMT MONEY,                     
@ENTEREDBY VARCHAR(25),                     
@CDT DATETIME, /*VARCHAR(30), */                    
@CHECKEDBY VARCHAR(25),                     
@PDT DATETIME, /*VARCHAR(30), */                    
@ACNAME VARCHAR(50),                     
@NARRATION VARCHAR(234),                     
@CHEQUEINNAME VARCHAR(50),                     
@CHQPRINTED TINYINT,                     
@ACCAT INT,                     
@BNKNAME VARCHAR(50),                     
@BRNNAME VARCHAR(30),                     
@DD CHAR(1),                     
@DDNO VARCHAR(15),                     
@DDDT DATETIME,                     
@RELDT DATETIME,                     
@RELAMT MONEY,                     
@MICRNO INT,                     
@SESSIONID INT,                     
@BRANCHNAME CHAR(10),                     
@COSTFLAG VARCHAR(1),                     
@COSTROWID INT,                     
@CLEARINGMODE CHAR(1),                     
@EMODE CHAR(1)                    
/*SLIPNO, , CHEQUEINNAME, CHQPRINTED*/                    
AS                    
DECLARE                    
@@VNO1 AS VARCHAR(12),                     
@@REFNO CHAR(12),                     
@@NODAYS INT,                     
@@ACTNODAYS INT,                     
@@BALAMT MONEY,                     
@@SLIPNO SMALLINT,                     
@@SLIPDATE DATETIME,                     
@@CLEARINGMODE CHAR(2),                     
@@RECEIPTNO INT,                     
@@BRANCH AS CHAR(15),                     
@@EXCHANGE AS VARCHAR(3),                     
@@SEGMENT AS VARCHAR(10),                     
@@SETT_NO AS VARCHAR(7),                     
@@SETT_TYPE AS VARCHAR(3),                     
@@PARTY_CODE AS VARCHAR(10),                     
@@VDT1 AS DATETIME,                     
@@EDT1 AS DATETIME,                     
@@DDDT1 AS DATETIME,                     
@@RELDT1 AS DATETIME,                     
@@RECORDCOUNT AS INT                    
SELECT @@VDT1 = CONVERT(DATETIME, @VDT+' '+CONVERT(VARCHAR, GETDATE(), 114))                    
SELECT @@EDT1 = CONVERT(DATETIME, @EDT+' '+CONVERT(VARCHAR, GETDATE(), 114))                    
SELECT @@DDDT1 = CONVERT(DATETIME, SUBSTRING(CONVERT(VARCHAR, @DDDT, 109), 1, 11)+' '+CONVERT(VARCHAR, GETDATE(), 114))                   
 /* SELECT @@RELDT1 = CONVERT(DATETIME, SUBSTRING(CONVERT(VARCHAR, @RELDT, 109), 1, 11)+' 00:00:00' */                    
SELECT @@RELDT1 = @RELDT                    
SELECT @@VNO1 = @VNO                    
SELECT @@REFNO = ''                    
SELECT @@NODAYS = 0                    
SELECT @@ACTNODAYS  = 0                    
SELECT @@BALAMT = 0                    
SELECT @@SLIPNO = 0                    
SELECT @@SLIPDATE = ''                    
/*SELECT @@CLEARINGMODE = ' ' */                    
SELECT @@RECEIPTNO = 0                    
SELECT @@BRANCH =  'BRANCH'                    
/* INSERTING RECORD IN LEDGER */                    
INSERT INTO LEDGER(VTYP, VNO, DRCR, VAMT, VDT, REFNO, CLTCODE, ENTEREDBY, LNO, BALAMT,                     
VNO1, BOOKTYPE, EDT, CDT, PDT, NODAYS, ACTNODAYS, CHECKEDBY, ACNAME, NARRATION)                     
VALUES (@VTYP, @VNO, @DRCR, @VAMT, @@VDT1, @@REFNO, UPPER(@CLTCODE), @ENTEREDBY, @LNO, @@BALAMT,                     
@@VNO1, @BOOKTYPE, @@EDT1, @CDT, @PDT, @@NODAYS, @@ACTNODAYS, @CHECKEDBY, @ACNAME, @NARRATION)                    
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */                    
/* INSERTING RECORD IN LEDGER3 */                    
INSERT INTO LEDGER3(NARATNO, NARR, REFNO, VTYP, VNO, BOOKTYPE) VALUES                    
(@LNO, @NARRATION, @@REFNO, @VTYP, @VNO, @BOOKTYPE)                    
/* INSERTING COMMON NARRATION IN LEDGER3 */                    
IF @LNO = 2                     
BEGIN                    
       INSERT INTO LEDGER3(NARATNO, NARR, REFNO, VTYP, VNO, BOOKTYPE) VALUES                    
       (0, @NARRATION, @@REFNO, @VTYP, @VNO, @BOOKTYPE)                    
END                     
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */                    
/* INSERTING RECORD IN LEDGER1 IN CASE OF BANK RELATED VOUCHERS*/                    
IF @VTYP = 2 OR @VTYP = 3 OR @VTYP = 5 OR @VTYP = 16 OR @VTYP = 17  OR @VTYP = 19 OR @VTYP = 20                     
BEGIN                    
   IF (@VTYP = 2 OR @VTYP = 19 OR @VTYP = 16)                    
      BEGIN                    
 IF   ( @DRCR = 'C' OR @DRCR = 'C' ) AND @LNO = 2                    
      BEGIN                       
             INSERT INTO  LEDGER1(LNO, BNKNAME, BRNNAME, DD, DDNO, DDDT, RELAMT, VTYP, VNO, BOOKTYPE, REFNO, RELDT, MICRNO, SLIPNO, SLIPDATE, CLEAR_MODE, CHEQUEINNAME, CHQPRINTED, RECEIPTNO, DRCR)                    
     VALUES (@LNO, @BNKNAME, SUBSTRING(@BRNNAME, 1, 20), @DD, RTRIM(@DDNO), @@DDDT1, @RELAMT, @VTYP, @VNO, @BOOKTYPE, @@REFNO, @RELDT, @MICRNO, @@SLIPNO, @@SLIPDATE, @CLEARINGMODE, @CHEQUEINNAME, @CHQPRINTED, @@RECEIPTNO, @DRCR)                    
     END                     
      END                     
    ELSE IF (@VTYP = 3 OR @VTYP = 20 OR @VTYP = 17)                    
        BEGIN                    
   IF  ( @DRCR = 'D' OR @DRCR = 'D' ) AND @LNO = 2                    
                     
   BEGIN                    
        INSERT INTO LEDGER1(LNO, BNKNAME, BRNNAME, DD, DDNO, DDDT, RELAMT, VTYP, VNO, BOOKTYPE, REFNO, RELDT, MICRNO, SLIPNO, SLIPDATE, CLEAR_MODE, CHEQUEINNAME, CHQPRINTED, RECEIPTNO, DRCR)                    
            VALUES (@LNO, @BNKNAME, SUBSTRING(@BRNNAME, 1, 20), @DD, RTRIM(@DDNO), @@DDDT1, @RELAMT, @VTYP, @VNO, @BOOKTYPE, @@REFNO, @RELDT, @MICRNO, @@SLIPNO, @@SLIPDATE, @CLEARINGMODE, @CHEQUEINNAME, @CHQPRINTED, @@RECEIPTNO, @DRCR)                    
      INSERT INTO PAYADV(CLTCODE, ACNAME, VDT, AMT, CHEQUENO, CHEQUEINNAME, NARRATION, PRINTEDFLAG, ACTAMT, SHORTAGE, VTYP, VNO, BOOKTYPE)                    
            VALUES (UPPER(@CLTCODE), @ACNAME, @@VDT1, @RELAMT, RTRIM(@DDNO), @CHEQUEINNAME, @NARRATION, 0, @VAMT, 0, @VTYP, @VNO, @BOOKTYPE)                    
                  END                     
     END                    
    ELSE IF @VTYP = 5                    
        BEGIN                    
             INSERT INTO  LEDGER1(LNO, BNKNAME, BRNNAME, DD, DDNO, DDDT, RELAMT, VTYP, VNO, BOOKTYPE, REFNO, RELDT, MICRNO, SLIPNO, SLIPDATE, CLEAR_MODE, CHEQUEINNAME, CHQPRINTED, RECEIPTNO, DRCR)                    
         VALUES (@LNO, @BNKNAME, SUBSTRING(@BRNNAME, 1, 20), @DD, RTRIM(@DDNO), @@DDDT1, @RELAMT, @VTYP, @VNO, @BOOKTYPE, @@REFNO, @@RELDT1, @MICRNO, @@SLIPNO, @@SLIPDATE, @CLEARINGMODE, @CHEQUEINNAME, @CHQPRINTED, @@RECEIPTNO, @DRCR)                    
   IF @ACCAT = 2 AND @DRCR = 'C'                    
   BEGIN                    
           INSERT INTO PAYADV(CLTCODE, ACNAME, VDT, AMT, CHEQUENO, CHEQUEINNAME, NARRATION, PRINTEDFLAG, ACTAMT, SHORTAGE, VTYP, VNO, BOOKTYPE)                    
            VALUES (UPPER(@CLTCODE), @ACNAME, @@VDT1, @RELAMT, RTRIM(@DDNO), @CHEQUEINNAME, @NARRATION, 0, @VAMT, 0, @VTYP, @VNO, @BOOKTYPE)                    
   END                    
        END                    
END                    
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */                    
/* INSERTING RECORDS IN MATCHDETAILS AND UPDATING BILLMATCH */                    
IF @LNO = 2                     
BEGIN                    
      DELETE  FROM TEMPBILLDETAILS WHERE PAYAMOUNT = 0 AND RTRIM(SESSIONID) = RTRIM(@SESSIONID)                    
       UPDATE BILLMATCH SET BILLMATCH.BALAMT = BILLMATCH.BALAMT - PAYAMOUNT FROM TEMPBILLDETAILS T                    
        WHERE  RTRIM(T.SESSIONID) = RTRIM(@SESSIONID)                     
        AND T.PARTY_CODE = BILLMATCH.PARTY_CODE AND T.BILLVTYPE = BILLMATCH.VTYPE AND T.BILLBOOKTYPE = BILLMATCH.BOOKTYPE                     
        AND T.BILLVNO = BILLMATCH.VNO AND T.BILLLNO = BILLMATCH.LNO                   
        INSERT INTO MATCHDETAILS                    
        SELECT DESCRIPTION, UPPER(PARTY_CODE), BILLVTYPE, BILLVNO, BILLLNO, BILLBOOKTYPE, DRCR, PAYAMOUNT, VTYPE, @VNO, @LNO, BOOKTYPE                    
        FROM TEMPBILLDETAILS WHERE  RTRIM(SESSIONID) = RTRIM(@SESSIONID)                     
END                    
/* INSERTTING RECORDS IN MARGIN LEDGER */                    
IF @ACCAT = 14 AND (@VTYP = 19 OR @VTYP = 20 OR @VTYP = 22 OR @VTYP = 23 OR @VTYP = 24)                    
BEGIN                    
   INSERT INTO MARGINLEDGER(VTYP, VNO, LNO, DRCR, VDT, AMOUNT, PARTY_CODE, EXCHANGE, SEGMENT, SETT_NO, SETT_TYPE, BOOKTYPE, MCLTCODE)                    
   VALUES (@VTYP, @VNO, @LNO, @DRCR, @@VDT1, @VAMT, UPPER(@@PARTY_CODE), @@EXCHANGE, @@SEGMENT, 0, @@SETT_TYPE, @BOOKTYPE, UPPER(@CLTCODE))                    
END                    
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */                    
IF (@VTYP = '8' OR @VTYP = '19' OR @VTYP = '20' OR @VTYP = '24') AND UPPER(@EMODE) = 'M'                      
BEGIN                    
DECLARE @RECORDCOUNTER SMALLINT           DECLARE @PARTYCODE VARCHAR(50)                       
 DECLARE CUR_LEDGER_INSERT CURSOR FOR                       
        SELECT COUNT(PARTY_CODE), PARTY_CODE FROM TEMPLEDGER2 WHERE                       
        VTYPE = @VTYP AND VNO = @VNO AND LNO = @LNO AND DRCR = @DRCR AND                     
 BOOKTYPE = @BOOKTYPE AND SESSIONID = @SESSIONID AND PARTY_CODE = @CLTCODE AND COSTFLAG = 'A'  GROUP BY PARTY_CODE                    
                      
        OPEN CUR_LEDGER_INSERT                      
                      
        FETCH NEXT FROM CUR_LEDGER_INSERT                     
        INTO @RECORDCOUNTER, @PARTYCODE                    
WHILE @@FETCH_STATUS = 0                      
BEGIN                     
--IF  @PARTYCODE <> @CLTCODE                    
IF @RECORDCOUNTER = 1                    
 BEGIN                    
        DELETE FROM TEMPLEDGER2 WHERE VTYPE = @VTYP AND VNO = @VNO AND LNO = @LNO AND DRCR = @DRCR AND BOOKTYPE = @BOOKTYPE AND SESSIONID = @SESSIONID                     
 --       INSERT INTO TEMPLEDGER2 VALUES (@@BRANCH, @BRANCHNAME, @VAMT, @VTYP, @VNO, @LNO, @DRCR, '0', @BOOKTYPE, @SESSIONID, UPPER(@CLTCODE), 'A', 0 )                      
END                    
/* ELSE                    
 BEGIN                    
  UPDATE TEMPLEDGER2 SET PAIDAMT = @VAMT WHERE VTYPE = @VTYP AND VNO = @VNO AND LNO = @LNO AND DRCR = @DRCR AND BOOKTYPE = @BOOKTYPE AND SESSIONID = @SESSIONID                     
 END*/                    
FETCH NEXT FROM CUR_LEDGER_INSERT                       
                       
END                      
                      
CLOSE CUR_LEDGER_INSERT                      
DEALLOCATE CUR_LEDGER_INSERT                      
END                     
/* INSERTING RECORD IN TEMPLEDGER2 FOR BRANCH WISE BREAKUP WHEN BRNACHFLAG = 1 AND MATCH_CTOC = 1 IN PARAMETER FOR SELECTED YEAR*/                    
IF UPPER(@EMODE) = 'A' OR UPPER(@EMODE) = 'M'                    
/*SELECT @@RECORDCOUNT = COUNT(PARTY_CODE) FROM TEMPLEDGER2 WHERE                     
VTYPE = @VTYP AND VNO = @VNO AND LNO = @LNO AND DRCR = @DRCR AND BOOKTYPE = @BOOKTYPE AND SESSIONID = @SESSIONID AND PARTY_CODE = UPPER(@CLTCODE) AND PAIDAMT = @VAMT                    
IF @@RECORDCOUNT = 0                    
BEGIN*/       
BEGIN                    
 INSERT INTO TEMPLEDGER2 VALUES ( @@BRANCH, @BRANCHNAME, @VAMT, @VTYP, @VNO, @LNO, @DRCR, '0', @BOOKTYPE, @SESSIONID, UPPER(@CLTCODE), 'A', 0 )                    
END                    
--END                    
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Newacmultiinsert_19122011
-- --------------------------------------------------
CREATE Procedure [dbo].[Newacmultiinsert_19122011]            
@Vtyp Smallint,                 
@Booktype Char(2),                 
@Vno Varchar(12),                 
@Lno Int,                 
@Vdt Varchar(11),                 
@Edt Varchar(11),                 
@Cltcode Varchar(10),                 
@Drcr Char(1),                  
@Vamt Money,                 
@Enteredby Varchar(25),                 
@Cdt Datetime, /*varchar(30), */                
@Checkedby Varchar(25),                 
@Pdt Datetime, /*varchar(30), */                
@Acname Varchar(50),                 
@Narration Varchar(234),                 
@Chequeinname Varchar(50),                 
@Chqprinted Tinyint,                 
@Accat Int,                 
@Bnkname Varchar(50),                 
@Brnname Varchar(30),                 
@Dd Char(1),                 
@Ddno Varchar(15),                 
@Dddt Datetime,                 
@Reldt Datetime,                 
@Relamt Money,                 
@Micrno Int,                 
@Sessionid Int,                 
@Branchname Char(10),                 
@Costflag Varchar(1),                 
@Costrowid Int,                 
@Clearingmode Char(1),                 
@Emode Char(1)                
/*slipno, , Chequeinname, Chqprinted*/                
As                
Declare                
@@Vno1 As Varchar(12),                 
@@Refno Char(12),                 
@@Nodays Int,                 
@@Actnodays Int,                 
@@Balamt Money,                 
@@Slipno Smallint,                 
@@Slipdate Datetime,                 
@@Clearingmode Char(2),                 
@@Receiptno Int,                 
@@Branch As Char(15),                 
@@Exchange As Varchar(3),                 
@@Segment As Varchar(10),                 
@@Sett_no As Varchar(7),                 
@@Sett_type As Varchar(3),                 
@@Party_code As Varchar(10),                 
@@Vdt1 As Datetime,                 
@@Edt1 As Datetime,                 
@@Dddt1 As Datetime,                 
@@Reldt1 As Datetime,                 
@@Recordcount As Int                
Select @@Vdt1 = Convert(Datetime, @Vdt+' '+convert(Varchar, Getdate(), 114))                
Select @@Edt1 = Convert(Datetime, @Edt+' '+convert(Varchar, Getdate(), 114))                
Select @@Dddt1 = Convert(Datetime, Substring(Convert(Varchar, @Dddt, 109), 1, 11)+' '+convert(Varchar, Getdate(), 114))                
/* Select @@Reldt1 = Convert(Datetime, Substring(Convert(Varchar, @Reldt, 109), 1, 11)+' 00:00:00' */                
Select @@Reldt1 = @Reldt                
Select @@Vno1 = @Vno                
Select @@Refno = ''                
Select @@Nodays = 0                
Select @@Actnodays  = 0                
Select @@Balamt = 0                
Select @@Slipno = 0                
Select @@Slipdate = ''                
/*select @@Clearingmode = ' ' */                
Select @@Receiptno = 0                
Select @@Branch =  'Branch'                
/* Inserting Record In Ledger */                
Insert Into Ledger(Vtyp, Vno, Drcr, Vamt, Vdt, Refno, Cltcode, Enteredby, Lno, Balamt,                 
Vno1, Booktype, Edt, Cdt, Pdt, Nodays, Actnodays, Checkedby, Acname, Narration)                 
Values (@Vtyp, @Vno, @Drcr, @Vamt, @@Vdt1, @@Refno, Upper(@Cltcode), @Enteredby, @Lno, @@Balamt,                 
@@Vno1, @Booktype, @@Edt1, @Cdt, @Pdt, @@Nodays, @@Actnodays, @Checkedby, @Acname, @Narration)                
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */                
/* Inserting Record In Ledger3 */                
Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values                
(@Lno, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)                
/* Inserting Common Narration In Ledger3 */                
If @Lno = 2                 
Begin                
       Insert Into Ledger3(Naratno, Narr, Refno, Vtyp, Vno, Booktype) Values                
       (0, @Narration, @@Refno, @Vtyp, @Vno, @Booktype)                
End                 
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */                
/* Inserting Record In Ledger1 In Case Of Bank Related Vouchers*/                
If @Vtyp = 2 Or @Vtyp = 3 Or @Vtyp = 5 Or @Vtyp = 16 Or @Vtyp = 17  Or @Vtyp = 19 Or @Vtyp = 20                 
Begin              
    
   If (@Vtyp = 2 Or @Vtyp = 19 Or @Vtyp = 16)                
      Begin                
 If   ( @Drcr = 'C' Or @Drcr = 'C' ) And @Lno = 2                
      Begin      
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)                
     Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)                
     End                 
      End                 
    Else If (@Vtyp = 3 Or @Vtyp = 20 Or @Vtyp = 17)                
        Begin                
   If  ( @Drcr = 'D' Or @Drcr = 'D' ) And @Lno = 2                
                 
   Begin                
        Insert Into Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)                
            Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @Reldt, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)                
      Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)                
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)                
                  End                 
     End                
    Else If @Vtyp = 5                
        Begin                
             Insert Into  Ledger1(Lno, Bnkname, Brnname, Dd, Ddno, Dddt, Relamt, Vtyp, Vno, Booktype, Refno, Reldt, Micrno, Slipno, Slipdate, Clear_mode, Chequeinname, Chqprinted, Receiptno, Drcr)                
         Values (@Lno, @Bnkname, Substring(@Brnname, 1, 20), @Dd, Rtrim(@Ddno), @@Dddt1, @Relamt, @Vtyp, @Vno, @Booktype, @@Refno, @@Reldt1, @Micrno, @@Slipno, @@Slipdate, @Clearingmode, @Chequeinname, @Chqprinted, @@Receiptno, @Drcr)                
   If @Accat = 2 And @Drcr = 'C'                
   Begin                
           Insert Into Payadv(Cltcode, Acname, Vdt, Amt, Chequeno, Chequeinname, Narration, Printedflag, Actamt, Shortage, Vtyp, Vno, Booktype)                
            Values (Upper(@Cltcode), @Acname, @@Vdt1, @Relamt, Rtrim(@Ddno), @Chequeinname, @Narration, 0, @Vamt, 0, @Vtyp, @Vno, @Booktype)                
   End                
        End                
End                
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */                
/* Inserting Records In Matchdetails And Updating Billmatch */                
If @Lno = 2                 
Begin                
      Delete  From Tempbilldetails Where Payamount = 0 And Rtrim(Sessionid) = Rtrim(@Sessionid)                
       Update Billmatch Set Billmatch.Balamt = Billmatch.Balamt - Payamount From Tempbilldetails T                
        Where  Rtrim(T.Sessionid) = Rtrim(@Sessionid)                 
        And T.Party_code = Billmatch.Party_code And T.Billvtype = Billmatch.Vtype And T.Billbooktype = Billmatch.Booktype                 
        And T.Billvno = Billmatch.Vno And T.Billlno = Billmatch.Lno   
        Insert Into Matchdetails                
        Select Description, Upper(Party_code), Billvtype, Billvno, Billlno, Billbooktype, Drcr, Payamount, Vtype, @Vno, @Lno, Booktype                
        From Tempbilldetails Where  Rtrim(Sessionid) = Rtrim(@Sessionid)                 
End                
/* Insertting Records In Margin Ledger */                
If @Accat = 14 And (@Vtyp = 19 Or @Vtyp = 20 Or @Vtyp = 22 Or @Vtyp = 23 Or @Vtyp = 24)                
Begin                
   Insert Into Marginledger(Vtyp, Vno, Lno, Drcr, Vdt, Amount, Party_code, Exchange, Segment, Sett_no, Sett_type, Booktype, Mcltcode)                
   Values (@Vtyp, @Vno, @Lno, @Drcr, @@Vdt1, @Vamt, Upper(@@Party_code), @@Exchange, @@Segment, 0, @@Sett_type, @Booktype, Upper(@Cltcode))                
End                
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */                
If (@Vtyp = '8' or @Vtyp = '19' or @Vtyp = '20' or @Vtyp = '24') And Upper(@Emode) = 'M'                  
Begin                
Declare @Recordcounter Smallint           Declare @Partycode Varchar(50)                   
 Declare Cur_ledger_insert Cursor For                   
        Select Count(Party_code), Party_code From Templedger2 Where                   
        Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And                 
 Booktype = @Booktype And Sessionid = @Sessionid And Party_code = @Cltcode and costflag = 'A'  Group By Party_code                
                  
        Open Cur_ledger_insert                  
                  
        Fetch Next From Cur_ledger_insert                 
        Into @Recordcounter, @Partycode                
While @@Fetch_status = 0                  
Begin                 
--if  @Partycode <> @Cltcode                
If @Recordcounter = 1                
 Begin                
        Delete From Templedger2 Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid                 
 --       Insert Into Templedger2 Values (@@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )                  
End                
/* Else                
 Begin                
  Update Templedger2 Set Paidamt = @Vamt Where Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid                 
 End*/                
Fetch Next From Cur_ledger_insert                   
                   
End                  
                  
Close Cur_ledger_insert                  
Deallocate Cur_ledger_insert                  
End                 
/* Inserting Record In Templedger2 For Branch Wise Breakup When Brnachflag = 1 And Match_ctoc = 1 In Parameter For Selected Year*/                
If Upper(@Emode) = 'A' Or Upper(@Emode) = 'M'                
/*select @@Recordcount = Count(Party_code) From Templedger2 Where                 
Vtype = @Vtyp And Vno = @Vno And Lno = @Lno And Drcr = @Drcr And Booktype = @Booktype And Sessionid = @Sessionid And Party_code = Upper(@Cltcode) And Paidamt = @Vamt                
If @@Recordcount = 0                
Begin*/                
Begin                
 Insert Into Templedger2 Values ( @@Branch, @Branchname, @Vamt, @Vtyp, @Vno, @Lno, @Drcr, '0', @Booktype, @Sessionid, Upper(@Cltcode), 'A', 0 )                
End                
--end                
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWASP_MARGINTRIALBALANCE
-- --------------------------------------------------





CREATE PROCEDURE  NEWASP_MARGINTRIALBALANCE  
  
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */  
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */  
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */  
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */  
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */  
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */  
@OPENENTRYFLAG INT,  
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */  
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */  
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */  
@SORTBYDATE VARCHAR(3)          /* WHETHER REPORT IS BASED ON VDT OR EDT */  
  
AS  
  
DECLARE  
@@SELECTQURY  AS VARCHAR(2000),  
@@FROMTABLES  AS VARCHAR(2000),  
@@WHEREPART   AS VARCHAR(1000),  
@@WHEREPART1  AS VARCHAR(500),  
@@WHEREPART2  AS VARCHAR(500),  
@@WHEREPART3  AS VARCHAR(500),  
@@ADDWHERE    AS VARCHAR(200),  
@@GROUPBY     AS VARCHAR(200),  
@@SORTBY      AS VARCHAR(200),  
@@COSTCODE    AS VARCHAR(3)  
  
IF UPPER(@STATUSID) = 'BROKER'  
BEGIN  
 SELECT @@GROUPBY    = " GROUP BY L.PARTY_CODE , A.ACNAME, BRANCHCODE"  
END  
ELSE  
BEGIN  
 SELECT @@GROUPBY    = " GROUP BY ML.PARTY_CODE , A.ACNAME, BRANCHCODE"
END  
  
IF UPPER(@STATUSID) = 'BROKER'  
BEGIN  
 IF @FLAG = 'CODEWISE'  
 BEGIN  
    SELECT @@SORTBY = " ORDER BY  L.PARTY_CODE, A.ACNAME, BRANCHCODE"  
 END  
 ELSE   
 BEGIN   
    SELECT @@SORTBY = " ORDER BY  A.ACNAME, L.PARTY_CODE, BRANCHCODE"  
 END  
END  
ELSE  
BEGIN  
 IF @FLAG = 'CODEWISE'  
 BEGIN  
    SELECT @@SORTBY = " ORDER BY  ML.PARTY_CODE, A.ACNAME"  
 END  
 ELSE   
 BEGIN   
    SELECT @@SORTBY = " ORDER BY  A.ACNAME, ML.PARTY_CODE"  
 END  
END  
  
IF @VIEWOPTION = 'PARTYWISE'  /* ONLY PARTY ACCOUNTS TO BE DISPLAYED */  
BEGIN  
   SELECT @@ADDWHERE  = " AND A.ACCAT = 4 "   
END  
ELSE IF @VIEWOPTION = 'GL'  /* ONLY PARTY ACCOUNTS TO BE DISPLAYED */  
BEGIN  
	SELECT @@ADDWHERE  = " AND A.ACCAT <> 4 "   
END  
ELSE  
BEGIN  
	SELECT @@ADDWHERE  = " "   
END  
  
IF @STATUSID = 'BROKER'  
BEGIN  
      	SELECT @@WHEREPART1 = " WHERE VDT <= '" + @VDT + " 23:59:59' "   
      	SELECT @@WHEREPART2 = " WHERE VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'"   
      	SELECT @@WHEREPART3 = " WHERE VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'"   
END  
ELSE IF @STATUSID = 'BRANCH'  
BEGIN  
   	SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )  
      	SELECT @@WHEREPART1 = " WHERE COSTCODE = '" + @@COSTCODE + "' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE"   
      	SELECT @@WHEREPART2 = " WHERE COSTCODE = '" + @@COSTCODE + "' AND VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE"   
      	SELECT @@WHEREPART3 = " WHERE COSTCODE = '" + @@COSTCODE + "' AND VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE"   
END  
  
/*  -- FOR BROKER --  */  
/* ------------------ */  
  
IF @STATUSID = 'BROKER'  
BEGIN  
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/  
IF @BALANCE='NORMAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */  
   BEGIN  
      SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)"  
      SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */  
   BEGIN  
        SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)"  
        SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
        SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */  
   BEGIN  
        SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)"  
        SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
        SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
/*--- IF USER WANTS TO SEE TRIAL BALANCE WITH OPENING BALANCES ---*/  
ELSE IF @BALANCE='WITHOPBAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */  
   BEGIN  
      IF @CURRYRSTDATE = @STDATE   
         BEGIN  
            SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END), CRTOT = SUM(CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END),OPBAL = 0 "  
            SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
         END  
      ELSE  
         BEGIN  
           SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'    THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END) "  
           SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
         END  
   END  
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */  
   BEGIN  
      IF @CURRYRSTDATE = @STDATE   
         BEGIN  
                SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VTYP = 18 THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END)"  
                SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
                SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
         END  
      ELSE  
         BEGIN  
           SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'    THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END) "  
           SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
         END  
   END  
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */  
   BEGIN  
      	SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'     THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END) "  
      	SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
      	SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
END    /* END OG STATUSID = 'BROKER'  */  
  
  
/*  -- FOR BRANCH SELECTION --  */  
/* ---------------------------- */  
  
IF @STATUSID = 'BRANCH'  
BEGIN  
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/  
IF @BALANCE='NORMAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */  
   BEGIN  
      	SELECT @@SELECTQURY = " SELECT ML.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,AMOUNT = SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN ML.AMOUNT ELSE -ML.AMOUNT END)"  
      	SELECT @@FROMTABLES = " FROM LEDGER2 L LEFT OUTER JOIN (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ON L.VNO=ML.VNO AND L.VTYPE=ML.VTYP AND L.BOOKTYPE=ML.BOOKTYPE AND L.LNO=ML.LNO , ACMAST A"   
      	SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */  
   BEGIN  
      	SELECT @@SELECTQURY = " SELECT ML.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,AMOUNT = SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN ML.AMOUNT ELSE -ML.AMOUNT END)"  
      	SELECT @@FROMTABLES = " FROM LEDGER2 L LEFT OUTER JOIN (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ON L.VNO=ML.VNO AND L.VTYPE=ML.VTYP AND L.BOOKTYPE=ML.BOOKTYPE AND L.LNO=ML.LNO , ACMAST A"   
      	SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */  
   BEGIN  
      	SELECT @@SELECTQURY = " SELECT ML.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,AMOUNT = SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN ML.AMOUNT ELSE -ML.AMOUNT END)"  
      	SELECT @@FROMTABLES = " FROM LEDGER2 L LEFT OUTER JOIN (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ON L.VNO=ML.VNO AND L.VTYPE=ML.VTYP AND L.BOOKTYPE=ML.BOOKTYPE AND L.LNO=ML.LNO , ACMAST A"   
      	SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
END /* END OF BRANCH LOGIN OR BRANCH SELECTION FROM BROKER LOGIN */  
  
PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY   
  
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWASP_MARGINTRIALBALANCEPARTYTOTAL
-- --------------------------------------------------






/****** OBJECT:  STORED PROCEDURE DBO.NEWASP_TRIALBALANCEPARTYTOTAL    SCRIPT DATE: 04/15/2004 11:47:30 AM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.NEWASP_TRIALBALANCEPARTYTOTAL    SCRIPT DATE: 05/10/2004 5:29:40 PM ******/  
/****** OBJECT:  STORED PROCEDURE DBO.NEWASP_TRIALBALANCEPARTYTOTAL    SCRIPT DATE: 04/07/2003 7:10:42 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.NEWASP_TRIALBALANCEPARTYTOTAL    SCRIPT DATE: 04/07/2003 6:37:53 PM ******/  
/****** OBJECT:  STORED PROCEDURE DBO.NEWASP_TRIALBALANCEPARTYTOTAL    SCRIPT DATE: 02/18/2003 10:24:12 AM ******/  
/****** OBJECT:  STORED PROCEDURE DBO.NEWASP_TRIALBALANCEPARTYTOTAL    SCRIPT DATE: 12/04/2002 2:04:37 PM ******/  
CREATE  PROCEDURE  NEWASP_MARGINTRIALBALANCEPARTYTOTAL   
  
/* REPORT : CONSOLIDATED TRIAL BALANCE          
FILE : TRIALBAL.ASP  
DISPLAYS CONSOLIDATED TRIAL BALANCE */  
  
  
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */  
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */  
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */  
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */  
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */  
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */  
@OPENENTRYFLAG INT,  
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */  
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */  
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */  
@SORTBYDATE VARCHAR(3)          /* WHETHER REPORT IS BASED ON VDT OR EDT */  
  
AS  
  
DECLARE  
@@SELECTQURY  AS VARCHAR(8000),  
@@FROMTABLES  AS VARCHAR(2000),  
@@WHEREPART   AS VARCHAR(1000),  
@@WHEREPART1  AS VARCHAR(500),  
@@WHEREPART2  AS VARCHAR(500),  
@@WHEREPART3  AS VARCHAR(500),  
@@ADDWHERE    AS VARCHAR(200),  
@@GROUPBY     AS VARCHAR(200),  
@@SORTBY      AS VARCHAR(200),  
@@COSTCODE    AS VARCHAR(3)  
/*  
SELECT @@GROUPBY = " GROUP BY L.DRCR "  
SELECT @@SORTBY  = " ORDER BY  L.DRCR "  
*/  
  
SELECT @@GROUPBY = " "  
SELECT @@SORTBY  = " "  
  
SELECT @@ADDWHERE  = " AND A.ACCAT = 4 "   
  
IF @STATUSID = 'BROKER'  
BEGIN  
      SELECT @@WHEREPART1 = " WHERE VDT <= '" + @VDT + " 23:59:59' "   
      SELECT @@WHEREPART2 = " WHERE VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'"   
      SELECT @@WHEREPART3 = " WHERE VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'"   
END  
ELSE IF UPPER(@STATUSID) = 'BRANCH'  
BEGIN        
      SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )
      SELECT @@WHEREPART1 = " WHERE COSTCODE = '" + @@COSTCODE + "' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE"   
      SELECT @@WHEREPART2 = " WHERE COSTCODE = '" + @@COSTCODE + "' AND VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE"   
      SELECT @@WHEREPART3 = " WHERE COSTCODE = '" + @@COSTCODE + "' AND VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE"         
END  
  
/*  -- FOR BROKER --  */  
/* ------------------ */  
  
IF @STATUSID = 'BROKER'  
BEGIN  
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/  
IF @BALANCE='NORMAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */  
   BEGIN  
      SELECT @@SELECTQURY = "SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0)"  
      SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */  
   BEGIN  
            SELECT @@SELECTQURY = "SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0)"  
            SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
            SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */  
   BEGIN  
            SELECT @@SELECTQURY = "SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0)"  
            SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
            SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
/*--- IF USER WANTS TO SEE TRIAL BALANCE WITH OPENING BALANCES ---*/  
ELSE IF @BALANCE='WITHOPBAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */  
   BEGIN  
      IF @CURRYRSTDATE = @STDATE   
         BEGIN  
            SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END),0),CRTOT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END),0),OPBAL = 0 "
            SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
         END  
      ELSE  
         BEGIN  
           SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND  VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END),0) "  
           SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
         END  
   END  
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */  
   BEGIN  
      IF @CURRYRSTDATE = @STDATE   
         BEGIN  
                  SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VTYP = 18 THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END),0)"  
                  SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
                  SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
         END  
      ELSE  
         BEGIN  
           SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END),0) "  
           SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
         END  
   END  
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */  
   BEGIN  
            SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END),0) "  
            SELECT @@FROMTABLES = " FROM MARGINLEDGER L LEFT OUTER JOIN ACMAST A ON L.PARTY_CODE=  A.CLTCODE "   
            SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
END    /* END OG STATUSID = 'BROKER'  */  
  
  
/*  -- FOR BRANCH SELECTION --  */  
/* ---------------------------- */  
  
IF UPPER(@STATUSID) = 'BRANCH'  
BEGIN  
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/  
IF @BALANCE='NORMAL'  
BEGIN     
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */  
   BEGIN
      SELECT @@SELECTQURY = " SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN ML.AMOUNT ELSE -ML.AMOUNT END),0)"  
      SELECT @@FROMTABLES = " FROM LEDGER2 L LEFT OUTER JOIN (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ON L.VNO=ML.VNO AND L.VTYPE=ML.VTYP AND L.BOOKTYPE=ML.BOOKTYPE AND L.LNO=ML.LNO , ACMAST A "   
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */  
   BEGIN  
      SELECT @@SELECTQURY = " SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN ML.AMOUNT ELSE -ML.AMOUNT END),0)"  
      SELECT @@FROMTABLES = " FROM LEDGER2 L LEFT OUTER JOIN (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ON L.VNO=ML.VNO AND L.VTYPE=ML.VTYP AND L.BOOKTYPE=ML.BOOKTYPE AND L.LNO=ML.LNO , ACMAST A "   
      SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */  
   BEGIN  
      SELECT @@SELECTQURY = " SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN ML.AMOUNT ELSE -ML.AMOUNT END),0)"  
      SELECT @@FROMTABLES = " FROM LEDGER2 L LEFT OUTER JOIN (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ON L.VNO=ML.VNO AND L.VTYPE=ML.VTYP AND L.BOOKTYPE=ML.BOOKTYPE AND L.LNO=ML.LNO , ACMAST A "   
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END

END  
END /* END OF BRANCH LOGIN OR BRANCH SELECTION FROM BROKER LOGIN */  


PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY    
  
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWASP_TRIALBALANCE
-- --------------------------------------------------




--NEWASP_TRIALBALANCE_NEW 'NOV 23 2005', 'CODEWISE','PARTYWISE','NORMAL','APR  1 2005', 'APR  1 2005', 1,'APR  1 2005', 'BROKER', '%', 'EDT'

/****** OBJECT:  STORED PROCEDURE DBO.NEWASP_TRIALBALANCE    SCRIPT DATE: 04/07/2003 7:10:42 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.NEWASP_TRIALBALANCE    SCRIPT DATE: 02/18/2003 10:24:12 AM ******/
/****** OBJECT:  STORED PROCEDURE DBO.NEWASP_TRIALBALANCE    SCRIPT DATE: 12/04/2002 2:04:36 PM ******/
CREATE   PROCEDURE  NEWASP_TRIALBALANCE

@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */
@CURRYRSTDATE VARCHAR(11),	/* START DATE OF FINANCIAL YEAR */
@OPENENTRYFLAG INT,
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */
@SORTBYDATE VARCHAR(3)          /* WHETHER REPORT IS BASED ON VDT OR EDT */

AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

DECLARE
@@SELECTQURY  AS VARCHAR(2000),
@@FROMTABLES  AS VARCHAR(2000),
@@WHEREPART   AS VARCHAR(1000),
@@WHEREPART1  AS VARCHAR(500),
@@WHEREPART2  AS VARCHAR(500),
@@WHEREPART3  AS VARCHAR(500),
@@ADDWHERE    AS VARCHAR(200),
@@GROUPBY     AS VARCHAR(200),
@@SORTBY      AS VARCHAR(200),
@@COSTCODE    AS VARCHAR(3)

IF UPPER(@STATUSID) = 'BROKER'
BEGIN
	SELECT @@GROUPBY    = " GROUP BY L.CLTCODE , L.ACNAME, BRANCHCODE"
END
ELSE
BEGIN
	SELECT @@GROUPBY    = " GROUP BY L2.CLTCODE , A.ACNAME, BRANCHCODE"
END

IF UPPER(@STATUSID) = 'BROKER'
BEGIN
	IF @FLAG = 'CODEWISE'
	BEGIN
	   SELECT @@SORTBY = " ORDER BY  L.CLTCODE, L.ACNAME, BRANCHCODE"
	END
	ELSE	
	BEGIN	
	   SELECT @@SORTBY = " ORDER BY  L.ACNAME, L.CLTCODE, BRANCHCODE"
	END
END
ELSE
BEGIN
	IF @FLAG = 'CODEWISE'
	BEGIN
	   SELECT @@SORTBY = " ORDER BY  L2.CLTCODE, A.ACNAME, BRANCHCODE"
	END
	ELSE	
	BEGIN	
	   SELECT @@SORTBY = " ORDER BY  A.ACNAME, L2.CLTCODE, BRANCHCODE"
	END
END


IF @VIEWOPTION = 'PARTYWISE'  /* ONLY PARTY ACCOUNTS TO BE DISPLAYED */
BEGIN
   SELECT @@ADDWHERE  = " AND A.ACCAT = 4 " 
END
ELSE IF @VIEWOPTION = 'GL'  /* ONLY PARTY ACCOUNTS TO BE DISPLAYED */
     BEGIN
        SELECT @@ADDWHERE  = " AND A.ACCAT <> 4 " 
     END
     ELSE
     BEGIN
        SELECT @@ADDWHERE  = " " 
     END

IF @STATUSID = 'BROKER'
BEGIN
   IF @SORTBYDATE = 'VDT'
   BEGIN
      SELECT @@WHEREPART1 = " WHERE VDT <= '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'" 
      SELECT @@WHEREPART3 = " WHERE VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'" 
   END
   ELSE
   BEGIN
      SELECT @@WHEREPART1 = " WHERE EDT <= '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE EDT >= '" + @CURRYRSTDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59'" 
      SELECT @@WHEREPART3 = " WHERE EDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59'" 
   END
END
ELSE IF @STATUSID = 'BRANCH'
BEGIN
   SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )
   IF @SORTBYDATE = 'VDT'
   BEGIN
      SELECT @@WHEREPART1 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND VDT <= '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'" 
      SELECT @@WHEREPART3 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'" 
   END
   ELSE
   BEGIN
      SELECT @@WHEREPART1 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND EDT <= '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND EDT >= '" + @CURRYRSTDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59'" 
      SELECT @@WHEREPART3 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND EDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59'" 
   END
END

/*  -- FOR BROKER --  */
/* ------------------ */

IF @STATUSID = 'BROKER'
BEGIN
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/
IF @BALANCE='NORMAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)"
      SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      IF @SORTBYDATE = 'VDT'
         BEGIN
            SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)"
            SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
      ELSE
         BEGIN

            SELECT @@SELECTQURY = " SELECT CLTCODE, ACNAME, BRANCHCODE, AMOUNT=SUM(AMOUNT) FROM "
            SELECT @@SELECTQURY = @@SELECTQURY + "(SELECT L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(BALAMT)"
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART2 + @@ADDWHERE + " AND L.VTYP = 18 " + @@GROUPBY
            SELECT @@SELECTQURY = @@SELECTQURY + " UNION ALL "
            SELECT @@SELECTQURY = @@SELECTQURY + "SELECT L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)"
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART2  + @@ADDWHERE + " AND L.VTYP <> 18" + @@GROUPBY  +") L"
            SELECT @@FROMTABLES = " "  
            SELECT @@WHEREPART  = " "

         END
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      IF @SORTBYDATE = 'VDT'
         BEGIN
            SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)"
            SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
         END
      ELSE
         BEGIN
            SELECT @@SELECTQURY = " SELECT CLTCODE, ACNAME, BRANCHCODE, AMOUNT=SUM(AMOUNT) FROM "
            SELECT @@SELECTQURY = @@SELECTQURY + " (SELECT L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)"            
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART3 + @@ADDWHERE + " AND L.VTYP <> 18 " + @@GROUPBY 
            SELECT @@SELECTQURY = @@SELECTQURY + " UNION ALL "
            SELECT @@SELECTQURY = @@SELECTQURY + "SELECT L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, AMOUNT = SUM(BALAMT)"
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART2 + @@ADDWHERE + @@GROUPBY + ") L"
            SELECT @@FROMTABLES = " "
            SELECT @@WHEREPART  = " "
         END
   END
END
/*--- IF USER WANTS TO SEE TRIAL BALANCE WITH OPENING BALANCES ---*/
ELSE IF @BALANCE='WITHOPBAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END), CRTOT = SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END),OPBAL = 0 "
            SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'    THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END) "
           SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
          IF @SORTBYDATE = 'VDT'
             BEGIN
                SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN VTYP = 18 THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)"
                SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
                SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
             END
          ELSE
             BEGIN
                SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'    THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN VTYP = 18 THEN BALAMT ELSE 0 END)"
                SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
                SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
             END
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'    THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END) "
           SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = "SELECT L.CLTCODE , ACNAME=ISNULL(L.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'     THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END) "
      SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
END    /* END OG STATUSID = 'BROKER'  */


/*  -- FOR BRANCH SELECTION --  */
/* ---------------------------- */

IF @STATUSID = 'BRANCH'
BEGIN
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/
IF @BALANCE='NORMAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      SELECT @@SELECTQURY = " SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)"
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      SELECT @@SELECTQURY = " SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)"
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = " SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)"
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
ELSE IF @BALANCE='WITHOPBAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END), CRTOT = SUM(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),OPBAL = 0 "
            SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE " 
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END) "
           SELECT @@FROMTABLES = " FROM LEDGER2 L2, LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE  " 
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN L.VTYP = 18 THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END)"
            SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
            SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END) "
           SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = "SELECT L2.CLTCODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END) ELSE 0 END), CRTOT = SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END), OPBAL = SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END) "
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
END /* END OF BRANCH LOGIN OR BRANCH SELECTION FROM BROKER LOGIN */

PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY 

EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWASP_TRIALBALANCEPARTYTOTAL
-- --------------------------------------------------







/****** OBJECT:  STORED PROCEDURE DBO.NEWASP_TRIALBALANCEPARTYTOTAL    SCRIPT DATE: 12/16/2003 12:59:36 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.NEWASP_TRIALBALANCEPARTYTOTAL    SCRIPT DATE: 04/07/2003 7:10:42 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.NEWASP_TRIALBALANCEPARTYTOTAL    SCRIPT DATE: 04/07/2003 6:37:53 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.NEWASP_TRIALBALANCEPARTYTOTAL    SCRIPT DATE: 02/18/2003 10:24:12 AM ******/
/****** OBJECT:  STORED PROCEDURE DBO.NEWASP_TRIALBALANCEPARTYTOTAL    SCRIPT DATE: 12/04/2002 2:04:37 PM ******/
CREATE  PROCEDURE  NEWASP_TRIALBALANCEPARTYTOTAL 

/* REPORT : CONSOLIDATED TRIAL BALANCE        
FILE : TRIALBAL.ASP
DISPLAYS CONSOLIDATED TRIAL BALANCE */


@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */
@CURRYRSTDATE VARCHAR(11),	/* START DATE OF FINANCIAL YEAR */
@OPENENTRYFLAG INT,
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */
@SORTBYDATE VARCHAR(3)          /* WHETHER REPORT IS BASED ON VDT OR EDT */

AS

DECLARE
@@SELECTQURY  AS VARCHAR(8000),
@@FROMTABLES  AS VARCHAR(2000),
@@WHEREPART   AS VARCHAR(1000),
@@WHEREPART1  AS VARCHAR(500),
@@WHEREPART2  AS VARCHAR(500),
@@WHEREPART3  AS VARCHAR(500),
@@ADDWHERE    AS VARCHAR(200),
@@GROUPBY     AS VARCHAR(200),
@@SORTBY      AS VARCHAR(200),
@@COSTCODE    AS VARCHAR(3)
/*
SELECT @@GROUPBY = " GROUP BY L.DRCR "
SELECT @@SORTBY  = " ORDER BY  L.DRCR "
*/

SELECT @@GROUPBY = " "
SELECT @@SORTBY  = " "

SELECT @@ADDWHERE  = " AND A.ACCAT = 4 " 

IF @STATUSID = 'BROKER'
BEGIN
   IF @SORTBYDATE = 'VDT'
   BEGIN
      SELECT @@WHEREPART1 = " WHERE VDT <= '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'" 
      SELECT @@WHEREPART3 = " WHERE VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'" 
   END
   ELSE
   BEGIN
      SELECT @@WHEREPART1 = " WHERE EDT <= '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE EDT >= '" + @CURRYRSTDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59'" 
      SELECT @@WHEREPART3 = " WHERE EDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59'" 
   END
END
ELSE IF @STATUSID = 'BRANCH'
BEGIN
   SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )
   IF @SORTBYDATE = 'VDT'
   BEGIN
      SELECT @@WHEREPART1 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND VDT <= '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'" 
      SELECT @@WHEREPART3 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59'" 
   END
   ELSE
   BEGIN
      SELECT @@WHEREPART1 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND EDT <= '" + @VDT + " 23:59:59' " 
      SELECT @@WHEREPART2 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND EDT >= '" + @CURRYRSTDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59'" 
    SELECT @@WHEREPART3 = " WHERE L2.VTYPE = L.VTYP AND L2.BOOKTYPE = L.BOOKTYPE AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND COSTCODE = '" + @@COSTCODE + "' AND EDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND EDT <= '" + @VDT + " 23:59:59'" 
   END
END

/*  -- FOR BROKER --  */
/* ------------------ */

IF @STATUSID = 'BROKER'
BEGIN
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/
IF @BALANCE='NORMAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      SELECT @@SELECTQURY = "SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)"
      SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      IF @SORTBYDATE = 'VDT'
         BEGIN
            SELECT @@SELECTQURY = "SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)"
            SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
	 END
      ELSE
         BEGIN
            SELECT @@SELECTQURY = " SELECT AMOUNT=SUM(AMOUNT) FROM "
            SELECT @@SELECTQURY = @@SELECTQURY + " (SELECT AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)"            
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART2 + @@ADDWHERE + " AND L.VTYP <> 18 "
            SELECT @@SELECTQURY = @@SELECTQURY + " UNION ALL "
            SELECT @@SELECTQURY = @@SELECTQURY + "SELECT AMOUNT = SUM(BALAMT)"
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART2 + @@ADDWHERE + " AND L.VTYP = 18 ) T"
            SELECT @@FROMTABLES = " "
            SELECT @@WHEREPART  = " "
	 END
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      IF @SORTBYDATE = 'VDT'
         BEGIN
            SELECT @@SELECTQURY = "SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)"
            SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
	 END
      ELSE
         BEGIN
            SELECT @@SELECTQURY = " SELECT AMOUNT=SUM(AMOUNT) FROM "
            SELECT @@SELECTQURY = @@SELECTQURY + " (SELECT AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)"            
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART3 + @@ADDWHERE + " AND L.VTYP <> 18 "
            SELECT @@SELECTQURY = @@SELECTQURY + " UNION ALL "
            SELECT @@SELECTQURY = @@SELECTQURY + "SELECT AMOUNT = SUM(BALAMT)"
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART2 + @@ADDWHERE + ") T"
            SELECT @@FROMTABLES = " "
            SELECT @@WHEREPART  = " "
	 END
   END
END
/*--- IF USER WANTS TO SEE TRIAL BALANCE WITH OPENING BALANCES ---*/
ELSE IF @BALANCE='WITHOPBAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END),0),OPBAL = 0 "
            SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND  VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END),0) "
           SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            IF @SORTBYDATE = 'VDT'
               BEGIN
                  SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VTYP = 18 THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END),0)"
                  SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
                  SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
               END
	    ELSE
	       BEGIN
                  SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VTYP = 18 THEN BALAMT ELSE 0 END),0)"
                  SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
                  SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
	       END
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END),0) "
           SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      IF @SORTBYDATE = 'VDT'
         BEGIN
            SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END),0) "
            SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
	 END
      ELSE
	 BEGIN
            SELECT @@SELECTQURY = " SELECT AMOUNT=SUM(AMOUNT) FROM "
            SELECT @@SELECTQURY = @@SELECTQURY + " (SELECT AMOUNT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END)"            
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART3 + @@ADDWHERE + " AND L.VTYP <> 18 "
            SELECT @@SELECTQURY = @@SELECTQURY + " UNION ALL "
            SELECT @@SELECTQURY = @@SELECTQURY + "SELECT AMOUNT = SUM(BALAMT)"
            SELECT @@SELECTQURY = @@SELECTQURY + " FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE=  A.CLTCODE " 
            SELECT @@SELECTQURY = @@SELECTQURY + @@WHEREPART2 + @@ADDWHERE + ") T"
            SELECT @@FROMTABLES = " "
    SELECT @@WHEREPART  = " "
	 END
   END
END
END    /* END OG STATUSID = 'BROKER'  */


/*  -- FOR BRANCH SELECTION --  */
/* ---------------------------- */

IF @STATUSID = 'BRANCH'
BEGIN
/*---- IF USER WANTS TO SEE NORMAL TRIAL BALANCE ---*/
IF @BALANCE='NORMAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      SELECT @@SELECTQURY = " SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END),0)"
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      SELECT @@SELECTQURY = " SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END),0)"
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = " SELECT AMOUNT = ISNULL(SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END),0)"
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
ELSE IF @BALANCE='WITHOPBAL'
BEGIN
   IF @OPENENTRYFLAG = 0   /* OPENING ENTRY ( VTYP = 18 ) NOT FOUND IN LEDGER */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),0),OPBAL = 0 "
            SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT DRTOT = ISUNLL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END),0) "
           SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 1  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR SELECTED YEAR */
   BEGIN
      IF @CURRYRSTDATE = @STDATE 
         BEGIN
            SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN L.VTYP = 18 THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END),0)"
            SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
            SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
      ELSE
         BEGIN
           SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END),0) "
           SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE
         END
   END
   ELSE IF @OPENENTRYFLAG = 2  /* OPENING ENTRY ( VTYP = 18 ) FOUND IN LEDGER FOR EARLIER YEAR */
   BEGIN
      SELECT @@SELECTQURY = "SELECT DRTOT = ISNULL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END) ELSE 0 END),0), CRTOT = ISNULL(SUM(CASE WHEN L.VTYP <> 18 AND L.VDT >= '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END),0), OPBAL = ISNULL(SUM(CASE WHEN L.VDT < '" + @STDATE + "' THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END),0) "
      SELECT @@FROMTABLES = " FROM LEDGER L, LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE=  A.CLTCODE  " 
      SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE
   END
END
END /* END OF BRANCH LOGIN OR BRANCH SELECTION FROM BROKER LOGIN */

PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY  

EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWPARTYBALANCES1
-- --------------------------------------------------


--EXEC NEWPARTYBALANCES1 '0A141', '0A141', 'APR 1 2005','APR 1 2005', 'FEB 28 2006','PARTY', '346969512', '%'
CREATE PROCEDURE NEWPARTYBALANCES1  
@FROMPARTY VARCHAR(10),   
@TOPARTY VARCHAR(10),   
@OPENDATE VARCHAR(11),   
@FROMDT VARCHAR(11),   
@TODATE VARCHAR(11),   
@REPORTTYPE VARCHAR(30),   
@SESSIONID VARCHAR(30),   
@BRANCHCODE VARCHAR(10)  
AS  
DECLARE   
@@BALCUR AS CURSOR,   
@@BALDATE AS DATETIME,   
@@ENDDATENEW AS DATETIME,   
@@ENDDATE AS DATETIME  
SET NOCOUNT ON  
DELETE FROM TEMPPARTYBALANCES1 WHERE RTRIM(SESSIONID) = RTRIM(@SESSIONID)  
SELECT @@BALDATE = @FROMDT + ' 23:59'  
/*SELECT @@BALDATENEW = @FROMDT + ' 00:00:00'*/  
SELECT @@ENDDATE = @TODATE + ' 23:59'  
SELECT @@ENDDATENEW = DATEADD(DAY, 1, @@BALDATE)   
IF UPPER(RTRIM(@REPORTTYPE)) = 'PARTY'
BEGIN  
PRINT 'I AM IN PARTY'  
   WHILE @@BALDATE < = @@ENDDATE  
   BEGIN  
-- SELECT @@BALDATE  
 INSERT INTO TEMPPARTYBALANCES1  
 SELECT L.CLTCODE, @@BALDATE, SUM( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END), @SESSIONID  
 FROM LEDGER L, ACMAST A WHERE EDT > = 'APR  1 2003' + ' 00:00' AND EDT < = @@BALDATE   
 AND L.CLTCODE = A.CLTCODE AND A.ACCAT = 4 AND A.CLTCODE > = @FROMPARTY AND A.CLTCODE < = @TOPARTY  
 AND A.BRANCHCODE LIKE RTRIM(@BRANCHCODE) + '%'  
 GROUP BY L.CLTCODE  
 ORDER BY L.CLTCODE  
        SELECT @@BALDATE = DATEADD(DAY, 1, @@BALDATE)  
   END  
/*  
WHILE @@BALDATENEW < = @@ENDDATE  
   BEGIN  
 SELECT @@BALDATENEW  
 INSERT INTO TEMPPARTYBALANCES1  
 SELECT L.CLTCODE, @@BALDATENEW, SUM( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END), @SESSIONID  
 FROM LEDGER L, ACMAST A WHERE EDT > = @OPENDATE + ' 00:00:00' AND EDT < = @@BALDATE   
 AND L.CLTCODE = A.CLTCODE AND A.ACCAT = 4 AND A.CLTCODE > = @FROMPARTY AND A.CLTCODE < = @TOPARTY  
 AND A.BRANCHCODE LIKE RTRIM(@BRANCHCODE) + '%'  
 GROUP BY L.CLTCODE  
 ORDER BY L.CLTCODE  
        SELECT @@BALDATE = DATEADD(DAY, 1, @@BALDATE)  
        SELECT @@BALDATENEW = DATEADD(DAY, 1, @@BALDATENEW)  
   END  
*/  
END  
ELSE IF UPPER(RTRIM(@REPORTTYPE)) = 'FAMILY'  
BEGIN  
PRINT 'I AM IN FAMILY'  
   WHILE @@BALDATE < = @@ENDDATE  
   BEGIN  
 SELECT @@BALDATE  
 INSERT INTO TEMPPARTYBALANCES1  
 SELECT C.FAMILY, @@BALDATE, SUM( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END), @SESSIONID  
 FROM LEDGER L, MCDXCDS.DBO.CLIENTMASTER C WHERE EDT > = @OPENDATE + ' 00:00:00' AND EDT < = @@BALDATE   
 AND L.CLTCODE = C.PARTY_CODE AND C.FAMILY > = @FROMPARTY AND C.FAMILY < = @TOPARTY  
 AND C.BRANCH_CD LIKE RTRIM(@BRANCHCODE) + '%'  
 GROUP BY C.FAMILY  
 ORDER BY C.FAMILY  
        SELECT @@BALDATE = DATEADD(DAY, 1, @@BALDATE)  
   END  
END  
ELSE IF UPPER(RTRIM(@REPORTTYPE)) = 'FAMILYPARTY'  
BEGIN  
PRINT 'I AM IN FAMILYPARTY'  
   WHILE @@BALDATE < = @@ENDDATE  
   BEGIN  
 SELECT @@BALDATE  
 INSERT INTO TEMPPARTYBALANCES1  
 SELECT L.CLTCODE, @@BALDATE, SUM( CASE WHEN UPPER(DRCR)  = 'D' THEN VAMT ELSE -VAMT END), @SESSIONID  
 FROM LEDGER L, MCDXCDS.DBO.CLIENTMASTER C  WHERE EDT > = @OPENDATE + ' 00:00' AND EDT < = @@BALDATE   
 AND L.CLTCODE = C.PARTY_CODE AND C.FAMILY > = 'S06786' AND C.FAMILY < = @TOPARTY  
 AND C.BRANCH_CD LIKE RTRIM(@BRANCHCODE) + '%'  
 GROUP BY L.CLTCODE  
 ORDER BY L.CLTCODE  
        SELECT @@BALDATE = DATEADD(DAY, 1, @@BALDATE)  
   END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWPOSTBILL
-- --------------------------------------------------
     CREATE   PROCEDURE NEWPOSTBILL    
(  
 @VTYP SMALLINT,    
 @BOOKTYPE VARCHAR(2),    
 @VNO VARCHAR(12),    
 @VDT VARCHAR(11),    
 @EDTDR VARCHAR(11),    
 @EDTCR VARCHAR(11),    
 @CDT VARCHAR(11),    
 @PDT VARCHAR(11),    
 @ENTEREDBY VARCHAR(25),    
 @CHECKEDBY VARCHAR(25),    
 @SETT_NO VARCHAR(7),    
 @SETT_TYPE VARCHAR(3),    
 @UNAME VARCHAR(25),     
 @EXCHANGE VARCHAR(10),   
 @BILLDATE VARCHAR(11),   
 @OVNO VARCHAR(12) = ''   
)  
  
AS    
    
/*=================================================================================================  
--EXEC NEWPOSTBILL 15, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'    
--EXEC NEWPOSTBILL 21, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'    
=================================================================================================*/  
  
SET NOCOUNT ON    
  
DECLARE    
 @@OBJID AS INT,    
 @@EDTDR AS VARCHAR(11),    
 @@EDTCR AS VARCHAR(11),    
 @@LEDCNT AS INT  
    
BEGIN TRANSACTION  
  
 SELECT @@OBJID = ISNULL(OBJECT_ID('BFBILLMATCH'), 0)  
  
/*=================================================================================================  
      CHECK FOR DELETE IF RE-POSTING IS BEING DONE  
=================================================================================================*/  
 IF @OVNO <> ''  
  BEGIN  
   SELECT @@LEDCNT = COUNT(1) FROM BILLPOSTED WITH(NOLOCK) WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
   IF @@LEDCNT > 0   
    BEGIN   
     DELETE FROM LEDGER WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE    
     DELETE FROM LEDGER1 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE    
     DELETE FROM LEDGER2 WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE    
     DELETE FROM LEDGER3 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE    
     DELETE FROM BILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE    
     DELETE FROM BILLPOSTED WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE    
     IF @@OBJID <> 0    
      BEGIN    
       DELETE FROM BFBILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE    
      END    
    END  
  END  
  
 TRUNCATE TABLE POSTBILLLEDGER    
 TRUNCATE TABLE POSTBILLLEDGER2  
  
  
/*=========================================================================================================  
      POPULATE DATA FROM ACCBILL (NORMAL CLIENTS) / IACCBILL (INST CLIENTS), ACMAST TO BE USED FOR POSTING  
=========================================================================================================*/  
 IF @VTYP = 15  
 BEGIN  
 INSERT   
 INTO POSTBILLLEDGER   
  (   
   VTYP,   
   VNO,   
   EDT,   
   ACNAME,   
   DRCR,   
   VAMT,   
   VDT,   
   VNO1,   
   REFNO,   
   BALAMT,   
   NODAYS,   
   CDT,   
   CLTCODE,   
   BOOKTYPE,   
   ENTEREDBY,   
   PDT,   
   CHECKEDBY,   
   ACTNODAYS,   
   NARRATION,   
   SETT_NO,   
   SETT_TYPE,   
   BILL_NO,   
   ACCAT,   
   BRANCHCODE  
  )   
  SELECT   
   @VTYP,   
   @VNO,   
   (  
    CASE   
    WHEN SELL_BUY = 1   
    THEN @EDTDR   
    ELSE @EDTCR   
    END  
   ),   
   ACNAME,   
   (  
    CASE   
    WHEN SELL_BUY = 1   
    THEN 'D'   
    ELSE 'C'   
    END  
   ),   
   AMOUNT,   
   @VDT,   
   @VNO,   
   '',   
   0,   
   0,   
   CONVERT(VARCHAR(11), GETDATE(), 109),   
   PARTY_CODE,   
   @BOOKTYPE,   
   @ENTEREDBY,   
   CONVERT(VARCHAR(11), GETDATE(), 109),   
   @CHECKEDBY,   
   0,   
   'MCD' + RTRIM(LTRIM(@BILLDATE)) + '  BILL POSTED',   
   @SETT_NO,   
   @SETT_TYPE,   
   BILL_NO,   
   A.ACCAT,   
   A.BRANCHCODE    
  FROM MCDXCDS.DBO.FOACCBILL B WITH(NOLOCK),   
   ACMAST A WITH(NOLOCK)   
  WHERE B.PARTY_CODE = A.CLTCODE   
   AND B.BILLDATE LIKE @BILLDATE + '%'  
   AND B.AMOUNT <> 0  
   AND   
   (  
    A.ACCAT = 4   
    OR B.BRANCHCD = 'ZZZ'  
   )   
         
  
 INSERT   
 INTO POSTBILLLEDGER2   
  SELECT   
   (CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END),   
   AMOUNT,   
   BRANCHCD,   
   PARTY_CODE  
  FROM   
   MCDXCDS.DBO.FOACCBILL  
  WHERE  
   BILLDATE LIKE @BILLDATE + '%'  
   AND BRANCHCD <> 'ZZZ'  
   AND AMOUNT <> 0  
 END  
 ELSE  
 BEGIN  
 IF @VTYP = 30  
 BEGIN  
 INSERT   
 INTO POSTBILLLEDGER   
  (   
   VTYP,   
   VNO,   
   EDT,   
   ACNAME,   
   DRCR,   
   VAMT,   
   VDT,   
   VNO1,   
   REFNO,   
   BALAMT,   
   NODAYS,   
   CDT,   
   CLTCODE,   
   BOOKTYPE,   
   ENTEREDBY,   
   PDT,   
   CHECKEDBY,   
   ACTNODAYS,   
   NARRATION,   
   SETT_NO,   
   SETT_TYPE,   
   BILL_NO,   
   ACCAT,   
   BRANCHCODE  
  )   
  SELECT   
   @VTYP,   
   @VNO,   
   (  
    CASE   
    WHEN SELL_BUY = 1   
    THEN @EDTDR   
    ELSE @EDTCR   
    END  
   ),   
   ACNAME,   
   (  
    CASE   
    WHEN SELL_BUY = 1   
    THEN 'D'   
    ELSE 'C'   
    END  
   ),   
   AMOUNT,   
   @VDT,   
   @VNO,   
   '',   
   0,   
   0,   
   CONVERT(VARCHAR(11), GETDATE(), 109),   
   PARTY_CODE,   
   @BOOKTYPE,   
   @ENTEREDBY,   
   CONVERT(VARCHAR(11), GETDATE(), 109),   
   @CHECKEDBY,   
   0,   
   'MCD' + RTRIM(LTRIM(@BILLDATE)) + '  BILL POSTED',   
   @SETT_NO,   
   @SETT_TYPE,   
   BILL_NO,   
   A.ACCAT,   
   A.BRANCHCODE    
  FROM MCDXCDS.DBO.REM_FOACCBILL B WITH(NOLOCK),   
   ACMAST A WITH(NOLOCK)   
  WHERE B.PARTY_CODE = A.CLTCODE   
   AND B.BILLDATE LIKE @BILLDATE + '%'  
   AND B.AMOUNT <> 0  
   AND   
   (  
    A.ACCAT = 4   
    OR B.BRANCHCD = 'ZZZ'  
   )   
         
  
 INSERT   
 INTO POSTBILLLEDGER2   
  SELECT   
   (CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END),   
   AMOUNT,   
   BRANCHCD,   
   PARTY_CODE  
  FROM   
   MCDXCDS.DBO.REM_FOACCBILL  
  WHERE  
   BILLDATE LIKE @BILLDATE + '%'  
   AND BRANCHCD <> 'ZZZ'  
   AND AMOUNT <> 0  
 END  
 END  
    
  
/*=================================================================================================  
      POST DATA INTO LEDGER  
=================================================================================================*/  
 INSERT   
 INTO LEDGER   
 (  
  VTYP,   
  VNO,   
  EDT,   
  LNO,   
  ACNAME,   
  DRCR,   
  VAMT,   
  VDT,   
  VNO1,   
  REFNO,   
  BALAMT,   
  NODAYS,   
  CDT,   
  CLTCODE,   
  BOOKTYPE,   
  ENTEREDBY,   
  PDT,   
  CHECKEDBY,   
  ACTNODAYS,   
  NARRATION  
 )   
  SELECT   
   VTYP,   
   VNO,   
   EDT,   
   LNO,   
   ACNAME,   
   DRCR,   
   VAMT,   
   VDT,   
   VNO1,   
   REFNO,   
   BALAMT,   
   NODAYS,   
   CDT,   
   CLTCODE,   
   BOOKTYPE,   
   ENTEREDBY,   
   PDT,   
   CHECKEDBY,   
   ACTNODAYS,   
   NARRATION   
  FROM POSTBILLLEDGER WITH(NOLOCK)   
  
     
/*=================================================================================================  
      POST DATA INTO LEDGER1  
=================================================================================================*/  
 INSERT   
 INTO LEDGER1   
 (  
  BNKNAME,   
  BRNNAME,   
  DD,   
  DDNO,   
  DDDT,   
  RELDT,   
  RELAMT,   
  REFNO,   
  RECEIPTNO,   
  VTYP,   
  VNO,   
  LNO,   
  DRCR,   
  BOOKTYPE,   
  MICRNO,   
  SLIPNO,   
  SLIPDATE,   
  CHEQUEINNAME,   
  CHQPRINTED,   
  CLEAR_MODE  
 )   
  SELECT   
   @EXCHANGE + @BILLDATE,  
   '',   
   'B',   
   '0',   
   '',   
   '',   
   VAMT,   
   '0',   
   '',   
   VTYP,   
   VNO,   
   LNO,   
   DRCR,   
   BOOKTYPE,   
   '0',   
   '',   
   '',   
   '',   
   1,   
   'C'   
  FROM POSTBILLLEDGER WITH(NOLOCK)  
  
    
/*=================================================================================================  
      POST DATA INTO LEDGER2  
=================================================================================================*/  
 INSERT   
 INTO LEDGER2   
 (  
  VTYPE,   
  VNO,   
  LNO,   
  DRCR,   
  CAMT,   
  COSTCODE,   
  BOOKTYPE,   
  CLTCODE  
 )   
  SELECT   
   B.VTYP,   
   B.VNO,   
   B.LNO,   
   B2.DRCR,   
   B2.AMOUNT,   
   C.COSTCODE,   
   B.BOOKTYPE,   
   B.CLTCODE   
  FROM POSTBILLLEDGER B WITH(NOLOCK),   
   COSTMAST C WITH(NOLOCK),  
   POSTBILLLEDGER2 B2   
  WHERE   
   B.CLTCODE = B2.CLTCODE  
   AND B2.BRANCHCODE = C.COSTNAME   
    
  
/*=================================================================================================  
      POST DATA INTO LEDGER3  
=================================================================================================*/  
 INSERT   
 INTO LEDGER3   
 (  
  NARATNO,  
  NARR,  
  REFNO,  
  VTYP,  
  VNO,  
  BOOKTYPE  
 )   
  SELECT   
   LNO,   
   NARRATION,   
   '',   
   VTYP,   
   VNO,   
   BOOKTYPE   
  FROM POSTBILLLEDGER   
    
  
/*=================================================================================================  
      POST DATA INTO BILLMATCH  
=================================================================================================*/  
 INSERT   
 INTO BILLMATCH   
 (  
  EXCHANGE,   
  SEGMENT,   
  SETT_TYPE,   
  SETT_NO,   
  BILLNO,   
  DATE,   
  PARTY_CODE,   
  AMOUNT,   
  DRCR,   
  BALAMT,   
  VTYPE,   
  VNO,   
  LNO,   
  BRANCH,   
  BOOKTYPE  
 )   
  SELECT   
   LEFT(@EXCHANGE, 3),   
   'FUTURES',   
   SETT_TYPE,   
   SETT_NO,   
   BILL_NO,   
   VDT,   
   CLTCODE,   
   VAMT,   
   DRCR,   
   0,   
   VTYP,   
   VNO,   
   LNO,   
   BRANCHCODE,   
   BOOKTYPE   
  FROM POSTBILLLEDGER WITH(NOLOCK)    
  WHERE ACCAT = '4'   
    
/*=================================================================================================  
      POST DATA INTO BFBILLMATCH  
=================================================================================================*/  
 IF @@OBJID <> 0    
  BEGIN    
   INSERT   
   INTO BFBILLMATCH   
   (  
    EXCHANGE,   
    SEGMENT,   
    SETT_TYPE,   
    SETT_NO,   
    BILLNO,   
    DATE,   
    PARTY_CODE,   
    AMOUNT,   
    DRCR,   
    BALAMT,   
    VTYPE,   
    VNO,   
    LNO,   
    BRANCH,   
    BOOKTYPE,   
    BANKPOSTDATE,   
    BANKPOSTAMOUNT,   
    BANKSTATUS,   
    BANKREASON  
   )   
    SELECT   
     LEFT(@EXCHANGE, 3),   
     'FUTURES',   
     SETT_TYPE,   
     SETT_NO,   
     BILL_NO,   
     VDT,   
     CLTCODE,   
     VAMT,   
     DRCR,   
     0,   
     VTYP,   
     VNO,   
     LNO,   
     BRANCHCODE,   
     BOOKTYPE,   
     '',   
     0,   
     '',   
     ''   
    FROM POSTBILLLEDGER WITH(NOLOCK)   
    WHERE ACCAT = '4'   
  END    
     
/*=================================================================================================  
      POST DATA INTO BILLPOSTED  
=================================================================================================*/  
 SELECT   
  @@EDTDR = MIN(EDT),   
  @@EDTCR = MAX(EDT)   
 FROM POSTBILLLEDGER   
  
 INSERT   
 INTO BILLPOSTED   
 (  
  VNO,   
  VTYP,   
  BOOKTYPE,   
  VDT,   
  BILLDATE,   
  SETT_NO,   
  SETT_TYPE,   
  NARRATION,   
  USERNAME,   
  POSTDATE,   
  EDTDR,   
  EDTCR  
 )   
  SELECT   
   TOP 1 VNO,   
   VTYP,   
   BOOKTYPE,   
   CONVERT(VARCHAR(11), VDT, 109),   
   CONVERT(VARCHAR(11), VDT, 109),   
   SETT_NO,   
   SETT_TYPE,   
   NARRATION,   
   @UNAME,   
   CONVERT(VARCHAR(11), GETDATE(), 109),   
   @@EDTDR,   
   @@EDTCR   
  FROM POSTBILLLEDGER WITH(NOLOCK)   
  
COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.NEWPOSTBILL_27052014
-- --------------------------------------------------





CREATE   PROCEDURE NEWPOSTBILL  
(
	@VTYP SMALLINT,  
	@BOOKTYPE VARCHAR(2),  
	@VNO VARCHAR(12),  
	@VDT VARCHAR(11),  
	@EDTDR VARCHAR(11),  
	@EDTCR VARCHAR(11),  
	@CDT VARCHAR(11),  
	@PDT VARCHAR(11),  
	@ENTEREDBY VARCHAR(25),  
	@CHECKEDBY VARCHAR(25),  
	@SETT_NO VARCHAR(7),  
	@SETT_TYPE VARCHAR(3),  
	@UNAME VARCHAR(25),   
	@EXCHANGE VARCHAR(10), 
	@BILLDATE VARCHAR(11), 
	@OVNO VARCHAR(12) = '' 
)

AS  
  
/*=================================================================================================
--EXEC NEWPOSTBILL 15, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'  
--EXEC NEWPOSTBILL 21, '01', '200500001530', 'DEC  5 2005', 'DEC  5 2005', 'DEC  7 2005', 'DEC  6 2005', 'DEC  6 2005', 'SYSTEM', 'SYSTEM', '2005230', 'N', 'YATIN'  
=================================================================================================*/

SET NOCOUNT ON  

DECLARE  
	@@OBJID AS INT,  
	@@EDTDR AS VARCHAR(11),  
	@@EDTCR AS VARCHAR(11),  
	@@LEDCNT AS INT
  
BEGIN TRANSACTION

	SELECT @@OBJID = ISNULL(OBJECT_ID('BFBILLMATCH'), 0)

/*=================================================================================================
      CHECK FOR DELETE IF RE-POSTING IS BEING DONE
=================================================================================================*/
	IF @OVNO <> ''
		BEGIN
			SELECT @@LEDCNT = COUNT(1) FROM BILLPOSTED WITH(NOLOCK) WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE
			IF @@LEDCNT > 0 
				BEGIN 
					DELETE FROM LEDGER WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
					DELETE FROM LEDGER1 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
					DELETE FROM LEDGER2 WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE  
					DELETE FROM LEDGER3 WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
					DELETE FROM BILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE  
					DELETE FROM BILLPOSTED WHERE VNO = @OVNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE  
					IF @@OBJID <> 0  
						BEGIN  
							DELETE FROM BFBILLMATCH WHERE VNO = @OVNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE  
						END  
				END
		END

	TRUNCATE TABLE POSTBILLLEDGER  
	TRUNCATE TABLE POSTBILLLEDGER2


/*=========================================================================================================
      POPULATE DATA FROM ACCBILL (NORMAL CLIENTS) / IACCBILL (INST CLIENTS), ACMAST TO BE USED FOR POSTING
=========================================================================================================*/
	IF @VTYP = 15
	BEGIN
	INSERT 
	INTO POSTBILLLEDGER 
		( 
			VTYP, 
			VNO, 
			EDT, 
			ACNAME, 
			DRCR, 
			VAMT, 
			VDT, 
			VNO1, 
			REFNO, 
			BALAMT, 
			NODAYS, 
			CDT, 
			CLTCODE, 
			BOOKTYPE, 
			ENTEREDBY, 
			PDT, 
			CHECKEDBY, 
			ACTNODAYS, 
			NARRATION, 
			SETT_NO, 
			SETT_TYPE, 
			BILL_NO, 
			ACCAT, 
			BRANCHCODE
		) 
		SELECT 
			@VTYP, 
			@VNO, 
			(
				CASE 
				WHEN SELL_BUY = 1 
				THEN @EDTDR 
				ELSE @EDTCR 
				END
			), 
			ACNAME, 
			(
				CASE 
				WHEN SELL_BUY = 1 
				THEN 'D' 
				ELSE 'C' 
				END
			), 
			AMOUNT, 
			@VDT, 
			@VNO, 
			'', 
			0, 
			0, 
			CONVERT(VARCHAR(11), GETDATE(), 109), 
			PARTY_CODE, 
			@BOOKTYPE, 
			@ENTEREDBY, 
			CONVERT(VARCHAR(11), GETDATE(), 109), 
			@CHECKEDBY, 
			0, 
			'MCD' + RTRIM(LTRIM(@BILLDATE)) + '  BILL POSTED', 
			@SETT_NO, 
			@SETT_TYPE, 
			BILL_NO, 
			A.ACCAT, 
			A.BRANCHCODE  
		FROM MCDXCDS.DBO.FOACCBILL B WITH(NOLOCK), 
			ACMAST A WITH(NOLOCK) 
		WHERE B.PARTY_CODE = A.CLTCODE 
			AND B.BILLDATE LIKE @BILLDATE + '%'
			AND B.AMOUNT <> 0
			AND 
			(
				A.ACCAT = 4 
				OR B.BRANCHCD = 'ZZZ'
			) 
       

	INSERT 
	INTO POSTBILLLEDGER2 
		SELECT 
			(CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END), 
			AMOUNT, 
			BRANCHCD, 
			PARTY_CODE
		FROM 
			MCDXCDS.DBO.FOACCBILL
		WHERE
			BILLDATE LIKE @BILLDATE + '%'
			AND BRANCHCD <> 'ZZZ'
			AND AMOUNT <> 0
	END
	ELSE
	BEGIN
	IF @VTYP = 30
	BEGIN
	INSERT 
	INTO POSTBILLLEDGER 
		( 
			VTYP, 
			VNO, 
			EDT, 
			ACNAME, 
			DRCR, 
			VAMT, 
			VDT, 
			VNO1, 
			REFNO, 
			BALAMT, 
			NODAYS, 
			CDT, 
			CLTCODE, 
			BOOKTYPE, 
			ENTEREDBY, 
			PDT, 
			CHECKEDBY, 
			ACTNODAYS, 
			NARRATION, 
			SETT_NO, 
			SETT_TYPE, 
			BILL_NO, 
			ACCAT, 
			BRANCHCODE
		) 
		SELECT 
			@VTYP, 
			@VNO, 
			(
				CASE 
				WHEN SELL_BUY = 1 
				THEN @EDTDR 
				ELSE @EDTCR 
				END
			), 
			ACNAME, 
			(
				CASE 
				WHEN SELL_BUY = 1 
				THEN 'D' 
				ELSE 'C' 
				END
			), 
			AMOUNT, 
			@VDT, 
			@VNO, 
			'', 
			0, 
			0, 
			CONVERT(VARCHAR(11), GETDATE(), 109), 
			PARTY_CODE, 
			@BOOKTYPE, 
			@ENTEREDBY, 
			CONVERT(VARCHAR(11), GETDATE(), 109), 
			@CHECKEDBY, 
			0, 
			'MCD' + RTRIM(LTRIM(@BILLDATE)) + '  BILL POSTED', 
			@SETT_NO, 
			@SETT_TYPE, 
			BILL_NO, 
			A.ACCAT, 
			A.BRANCHCODE  
		FROM MCDXCDS.DBO.REM_FOACCBILL B WITH(NOLOCK), 
			ACMAST A WITH(NOLOCK) 
		WHERE B.PARTY_CODE = A.CLTCODE 
			AND B.BILLDATE LIKE @BILLDATE + '%'
			AND B.AMOUNT <> 0
			AND 
			(
				A.ACCAT = 4 
				OR B.BRANCHCD = 'ZZZ'
			) 
       

	INSERT 
	INTO POSTBILLLEDGER2 
		SELECT 
			(CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END), 
			AMOUNT, 
			BRANCHCD, 
			PARTY_CODE
		FROM 
			MCDXCDS.DBO.REM_FOACCBILL
		WHERE
			BILLDATE LIKE @BILLDATE + '%'
			AND BRANCHCD <> 'ZZZ'
			AND AMOUNT <> 0
	END
	END
  

/*=================================================================================================
      POST DATA INTO LEDGER
=================================================================================================*/
	INSERT 
	INTO LEDGER 
	(
		VTYP, 
		VNO, 
		EDT, 
		LNO, 
		ACNAME, 
		DRCR, 
		VAMT, 
		VDT, 
		VNO1, 
		REFNO, 
		BALAMT, 
		NODAYS, 
		CDT, 
		CLTCODE, 
		BOOKTYPE, 
		ENTEREDBY, 
		PDT, 
		CHECKEDBY, 
		ACTNODAYS, 
		NARRATION
	) 
		SELECT 
			VTYP, 
			VNO, 
			EDT, 
			LNO, 
			ACNAME, 
			DRCR, 
			VAMT, 
			VDT, 
			VNO1, 
			REFNO, 
			BALAMT, 
			NODAYS, 
			CDT, 
			CLTCODE, 
			BOOKTYPE, 
			ENTEREDBY, 
			PDT, 
			CHECKEDBY, 
			ACTNODAYS, 
			NARRATION 
		FROM POSTBILLLEDGER WITH(NOLOCK) 

   
/*=================================================================================================
      POST DATA INTO LEDGER1
=================================================================================================*/
	INSERT 
	INTO LEDGER1 
	(
		BNKNAME, 
		BRNNAME, 
		DD, 
		DDNO, 
		DDDT, 
		RELDT, 
		RELAMT, 
		REFNO, 
		RECEIPTNO, 
		VTYP, 
		VNO, 
		LNO, 
		DRCR, 
		BOOKTYPE, 
		MICRNO, 
		SLIPNO, 
		SLIPDATE, 
		CHEQUEINNAME, 
		CHQPRINTED, 
		CLEAR_MODE
	) 
		SELECT 
			@EXCHANGE + @BILLDATE,
			'', 
			'B', 
			'0', 
			'', 
			'', 
			VAMT, 
			'0', 
			'', 
			VTYP, 
			VNO, 
			LNO, 
			DRCR, 
			BOOKTYPE, 
			'0', 
			'', 
			'', 
			'', 
			1, 
			'C' 
		FROM POSTBILLLEDGER WITH(NOLOCK)

  
/*=================================================================================================
      POST DATA INTO LEDGER2
=================================================================================================*/
	INSERT 
	INTO LEDGER2 
	(
		VTYPE, 
		VNO, 
		LNO, 
		DRCR, 
		CAMT, 
		COSTCODE, 
		BOOKTYPE, 
		CLTCODE
	) 
		SELECT 
			B.VTYP, 
			B.VNO, 
			B.LNO, 
			B2.DRCR, 
			B2.AMOUNT, 
			C.COSTCODE, 
			B.BOOKTYPE, 
			B.CLTCODE 
		FROM POSTBILLLEDGER B WITH(NOLOCK), 
			COSTMAST C WITH(NOLOCK),
			POSTBILLLEDGER2 B2 
		WHERE 
			B.CLTCODE = B2.CLTCODE
			AND B2.BRANCHCODE = C.COSTNAME 
  

/*=================================================================================================
      POST DATA INTO LEDGER3
=================================================================================================*/
	INSERT 
	INTO LEDGER3 
	(
		NARATNO,
		NARR,
		REFNO,
		VTYP,
		VNO,
		BOOKTYPE
	) 
		SELECT 
			LNO, 
			NARRATION, 
			'', 
			VTYP, 
			VNO, 
			BOOKTYPE 
		FROM POSTBILLLEDGER 
  

/*=================================================================================================
      POST DATA INTO BILLMATCH
=================================================================================================*/
	INSERT 
	INTO BILLMATCH 
	(
		EXCHANGE, 
		SEGMENT, 
		SETT_TYPE, 
		SETT_NO, 
		BILLNO, 
		DATE, 
		PARTY_CODE, 
		AMOUNT, 
		DRCR, 
		BALAMT, 
		VTYPE, 
		VNO, 
		LNO, 
		BRANCH, 
		BOOKTYPE
	) 
		SELECT 
			LEFT(@EXCHANGE, 3), 
			'FUTURES', 
			SETT_TYPE, 
			SETT_NO, 
			BILL_NO, 
			VDT, 
			CLTCODE, 
			VAMT, 
			DRCR, 
			0, 
			VTYP, 
			VNO, 
			LNO, 
			BRANCHCODE, 
			BOOKTYPE 
		FROM POSTBILLLEDGER WITH(NOLOCK)  
		WHERE ACCAT = '4' 
  
/*=================================================================================================
      POST DATA INTO BFBILLMATCH
=================================================================================================*/
	IF @@OBJID <> 0  
		BEGIN  
			INSERT 
			INTO BFBILLMATCH 
			(
				EXCHANGE, 
				SEGMENT, 
				SETT_TYPE, 
				SETT_NO, 
				BILLNO, 
				DATE, 
				PARTY_CODE, 
				AMOUNT, 
				DRCR, 
				BALAMT, 
				VTYPE, 
				VNO, 
				LNO, 
				BRANCH, 
				BOOKTYPE, 
				BANKPOSTDATE, 
				BANKPOSTAMOUNT, 
				BANKSTATUS, 
				BANKREASON
			) 
				SELECT 
					LEFT(@EXCHANGE, 3), 
					'FUTURES', 
					SETT_TYPE, 
					SETT_NO, 
					BILL_NO, 
					VDT, 
					CLTCODE, 
					VAMT, 
					DRCR, 
					0, 
					VTYP, 
					VNO, 
					LNO, 
					BRANCHCODE, 
					BOOKTYPE, 
					'', 
					0, 
					'', 
					'' 
				FROM POSTBILLLEDGER WITH(NOLOCK) 
				WHERE ACCAT = '4' 
		END  
   
/*=================================================================================================
      POST DATA INTO BILLPOSTED
=================================================================================================*/
	SELECT 
		@@EDTDR = MIN(EDT), 
		@@EDTCR = MAX(EDT) 
	FROM POSTBILLLEDGER 

	INSERT 
	INTO BILLPOSTED 
	(
		VNO, 
		VTYP, 
		BOOKTYPE, 
		VDT, 
		BILLDATE, 
		SETT_NO, 
		SETT_TYPE, 
		NARRATION, 
		USERNAME, 
		POSTDATE, 
		EDTDR, 
		EDTCR
	) 
		SELECT 
			TOP 1 VNO, 
			VTYP, 
			BOOKTYPE, 
			CONVERT(VARCHAR(11), VDT, 109), 
			CONVERT(VARCHAR(11), VDT, 109), 
			SETT_NO, 
			SETT_TYPE, 
			NARRATION, 
			@UNAME, 
			CONVERT(VARCHAR(11), GETDATE(), 109), 
			@@EDTDR, 
			@@EDTCR 
		FROM POSTBILLLEDGER WITH(NOLOCK) 

COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFFLINE_POST_LEDGER
-- --------------------------------------------------


CREATE PROC [dbo].[OFFLINE_POST_LEDGER]          
(          
           @UNAME     VARCHAR(25),                              
           @USERCAT   INT,                              
           @EXCHANGE  VARCHAR(3),                              
           @SEGMENT   VARCHAR(10),                              
           @RECOFLAG  CHAR(1) = 'N'                             
)          
          
AS          
          
          
          
DECLARE @@LEDVDT VARCHAR(11)          
DECLARE @@VTYP SMALLINT      
      
DECLARE LEDPOST CURSOR FOR          
 --SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED          
 SELECT DISTINCT LEFT(VDATE,11) AS VDT, VOUCHERTYPE       
 FROM ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES          
 WHERE EXCHANGE = @EXCHANGE          
 AND SEGMENT = @SEGMENT          
 AND ROWSTATE = 0          
 AND VDATE NOT LIKE 'JAN  1 1900%'          
          
OPEN LEDPOST          
          
-- Perform the first fetch.          
FETCH NEXT FROM LEDPOST INTO @@LEDVDT, @@VTYP           
          
-- Check @@FETCH_STATUS to see if there are any more rows to fetch.          
WHILE @@FETCH_STATUS = 0          
BEGIN 
IF @@VTYP = 8             
 BEGIN            
   EXEC V2_OFFLINE_JVDRCRUPLOAD_RND @UNAME,@USERCAT,@EXCHANGE, @SEGMENT,@@LEDVDT, @RECOFLAG,@@VTYP                
 END 
          
 IF @@VTYP = 3       
 BEGIN      
   EXEC V2_OFFLINE_PAYMENTUPLOAD @UNAME,@USERCAT,@EXCHANGE, @SEGMENT,@@LEDVDT, @RECOFLAG          
 END  
 IF @@VTYP = 2       
 BEGIN      
   EXEC V2_OFFLINE_RECPAYUPLOAD @UNAME,@USERCAT,@EXCHANGE, @SEGMENT,@@LEDVDT, @RECOFLAG          
 END      
          
-- This is executed as long as the previous fetch succeeds.          
   FETCH NEXT FROM LEDPOST INTO @@LEDVDT, @@VTYP           
END          
          
CLOSE LEDPOST          
DEALLOCATE LEDPOST

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFFLINELEDGER_ACC_GENVNO
-- --------------------------------------------------

/****** OBJECT:  STORED PROCEDURE DBO.V2_ACC_GENVNO    SCRIPT DATE: 09/30/2005 12:23:51 ******/              
              
/*            
-------------------------------------            
NEW PROCEDURE TO GENERATE VNO            
-------------------------------------            
            
AUTHOR            : UPPILI KRISHNAN            
DATE               : SEP 30 2005            
REVIEWED BY   :            
REVIEW DATE   :            
TESTED BY       :               
TESTED DATE    :            
            
-------------------------------------            
            
                    
      FLAGS:            
            VNOFLAG = 0 YEARLY            
            VNOFLAG = 1 DAILY            
            VNOFLAG = 2 MONTHLY            
            
LOGIC:            
 GENERATES 1 RECORD PER DAY FOR THE COMBINATION OF VNOFLAG, VOUCHERDATE, FINANCIAL YEAR COMBINATION            
 IF FOR THE ABOVE COMBINATION RECORD IS NOT PRESENT IN V2_LASTVNO TABLE THEN A NEW RECORD IS INSERTED            
 ELSE EXISTING RECORD IS UPDATED            
            
            
                                     
*/              
              
CREATE PROC OFFLINELEDGER_ACC_GENVNO    
@VDT      VARCHAR(11),  /* DD/MM/YYYY */                    
@VTYP     SMALLINT,                    
@BOOKTYPE VARCHAR(2),                    
@SDTCUR   VARCHAR(11),                    
@LDTCUR   VARCHAR(11),          
@NOOFRECORDS INT = 1          
/* @VNOFLAG  INT */                    
AS                    
                    
                    
                    
DECLARE @@VOUDT  AS DATETIME                    
DECLARE @@MAXVNO AS NUMERIC(12,0)                    
DECLARE @@VNOFLAG AS TINYINT                    
DECLARE @@VNO AS VARCHAR(12)                    
DECLARE @@RCNT AS INT                    
DECLARE @@FLDAUTO BIGINT                    
DECLARE @@YEARLYVDT VARCHAR(11)                  
DECLARE @@DAILYVDT VARCHAR(11)                    
DECLARE @@MONTHLYVDT VARCHAR(11)                    
DECLARE @@UPDTVDT VARCHAR(11)                    
DECLARE @@FINYEAR SMALLINT                  
          
DECLARE @@RETURNVNO AS VARCHAR(12)          
                    
--SET NOCOUNT ON                    
SET XACT_ABORT ON                    
                    
BEGIN TRANSACTION                    
            
SELECT             
      @SDTCUR = LEFT(SDTCUR,11),             
      @LDTCUR = LEFT(LDTCUR,11),             
      @@VNOFLAG = ISNULL(VNOFLAG,0),                   
      @@FINYEAR = ISNULL(FLDAUTO,0)                    
FROM             
      PARAMETER             
WHERE              
      CONVERT(DATETIME,@VDT) BETWEEN SDTCUR AND LDTCUR             

IF ISNULL(@SDTCUR,'') = ''
BEGIN                    
 ROLLBACK TRANSACTION                    
 SELECT VNO = ''                    
 RETURN                    
END                     

            
/*            
SELECT                   
FROM                   
      PARAMETER                   
WHERE                    
      SDTCUR LIKE @SDTCUR + '%'                   
      AND LDTCUR LIKE @LDTCUR + '%'                  
*/                  
                  
/*                   
REINITIALISING THE DATES TO BE POSTED IN THE TABLE.                    
      FOR DAILY, THE VOUCHER DATE IS TAKEN                  
      FOR MONTHLY, THE 1ST DAY OF THE MONTH  IS TAKEN                  
      FOR YEARLY, THE FIRST DAY OF THE YEAR IS TAKEN                  
*/                  
                  
SELECT                   
      @@VOUDT = (SELECT CONVERT(DATETIME,@VDT)),                   
      @@MONTHLYVDT = LEFT(@VDT,4)+' 1 '+RIGHT(@VDT,4),                   
      @@DAILYVDT = @VDT,                   
      @@YEARLYVDT = LEFT(@SDTCUR,4) + ' 1 '+ RIGHT(@SDTCUR,4)                  
              
-- DOING YEARLY VOUCHER GEN                    
IF @@VNOFLAG = 0                    
   BEGIN                    
      SELECT                   
            @@FLDAUTO = ISNULL(FLDAUTO,0) ,                   
            @@MAXVNO = CONVERT(NUMERIC,ISNULL(LASTVNO,0))                   
      FROM                   
            V2_LASTVNO WITH (INDEX(VNOIDX),TABLOCKX,HOLDLOCK)                   
      WHERE                   
            VTYP = @VTYP                   
            AND BOOKTYPE = @BOOKTYPE                   
            AND VDT = @@YEARLYVDT + ' 00:00:00'                   
            AND VNOFLAG = @@VNOFLAG                   
            AND FINYEAR = @@FINYEAR                  
                  
                  
      IF @@ROWCOUNT=0                  
         BEGIN                    
            -- IF NO RECORD PRESENT, THEN INSERT                  
           SELECT                   
                  @@FLDAUTO=0,                   
          @@UPDTVDT = @@YEARLYVDT,                   
                  @@RETURNVNO = RIGHT(@@YEARLYVDT,4) + '00000001',                    
  @@VNO = RIGHT(@@YEARLYVDT,4) + REPLICATE('0', 8-LEN(@NOOFRECORDS)) + CAST(@NOOFRECORDS AS VARCHAR)                      
 END                    
         ELSE                    
         BEGIN                    
           SELECT                   
            -- IF RECORD IS PRESENT, THEN UPDATE                  
                  @@UPDTVDT = @@YEARLYVDT,                   
                  @@RETURNVNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + 1))  ,                  
  @@VNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + @NOOFRECORDS))                    
         END                    
   END                    
                  
-- DOING DAILY VOUCHER GEN                    
ELSE IF @@VNOFLAG = 1                    
        BEGIN                    
                  
          SELECT                   
                  @@FLDAUTO = ISNULL(FLDAUTO,0) ,                    
                  @@MAXVNO =CONVERT(NUMERIC,ISNULL(LASTVNO,0))                   
            FROM               
                  V2_LASTVNO WITH (INDEX(VNOIDX), TABLOCKX,HOLDLOCK)                   
            WHERE                   
                  VTYP = @VTYP                   
                  AND BOOKTYPE = @BOOKTYPE                   
                  AND VDT = @@DAILYVDT + ' 00:00:00'                    
                  AND VNOFLAG = @@VNOFLAG AND FINYEAR = @@FINYEAR                  
                  
                  
          IF  @@ROWCOUNT=0                  
             BEGIN                    
            -- IF NO RECORD PRESENT, THEN INSERT                  
                SELECT                   
                  @@FLDAUTO=0,                   
                  @@UPDTVDT = @@DAILYVDT,                   
                  @@RETURNVNO = (SELECT CONVERT(VARCHAR,YEAR(@@VOUDT)) + RIGHT('0'+LTRIM(CONVERT(VARCHAR,MONTH(@@VOUDT))),2) + RIGHT('00'+LTRIM(CONVERT(VARCHAR,DAY(@@VOUDT))),2))+'0001'          ,          
  @@VNO = (SELECT CONVERT(VARCHAR,YEAR(@@VOUDT)) + RIGHT('0'+LTRIM(CONVERT(VARCHAR,MONTH(@@VOUDT))),2) + RIGHT('00'+LTRIM(CONVERT(VARCHAR,DAY(@@VOUDT))),2))+ REPLICATE('0', 4-LEN(@NOOFRECORDS)) + CAST(@NOOFRECORDS AS VARCHAR)          
          
             END                    
          ELSE                    
             BEGIN                    
            -- IF RECORD IS PRESENT, THEN UPDATE                  
               SELECT                   
                  @@UPDTVDT = @@DAILYVDT,                   
                  @@RETURNVNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + 1)),                    
  @@VNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + @NOOFRECORDS))                    
          
             END                    
        END                    
                  
-- DOING MONTHLY VOUCHER GEN                    
ELSE IF @@VNOFLAG = 2                    
        BEGIN                    
          SELECT                   
                  @@FLDAUTO = ISNULL(FLDAUTO,0) ,                   
                  @@MAXVNO =CONVERT(NUMERIC,ISNULL(LASTVNO,0))                   
            FROM                   
                  V2_LASTVNO WITH (INDEX(VNOIDX), TABLOCKX,HOLDLOCK)                   
            WHERE                   
                  VTYP = @VTYP                   
                  AND BOOKTYPE = @BOOKTYPE                   
                  AND VDT = @@MONTHLYVDT + ' 00:00:00'                    
                  AND VNOFLAG = @@VNOFLAG AND FINYEAR = @@FINYEAR         
                  
                  
          IF  @@ROWCOUNT=0                  
             BEGIN                    
            -- IF NO RECORD PRESENT, THEN INSERT                  
                SELECT                   
                  @@FLDAUTO=0,                   
                  @@UPDTVDT = @@MONTHLYVDT,                   
                  @@RETURNVNO = (SELECT CONVERT(VARCHAR,YEAR(@@VOUDT)) + RIGHT('0'+LTRIM(CONVERT(VARCHAR,MONTH(@@VOUDT))),2))+'000001',                    
  @@VNO = (SELECT CONVERT(VARCHAR,YEAR(@@VOUDT)) + RIGHT('0'+LTRIM(CONVERT(VARCHAR,MONTH(@@VOUDT))),2))+ REPLICATE('0', 6-LEN(@NOOFRECORDS)) + CAST(@NOOFRECORDS AS VARCHAR)          
          
             END                    
         ELSE                    
       BEGIN                    
            -- IF RECORD IS PRESENT, THEN UPDATE                  
               SELECT                   
                  @@UPDTVDT = @@MONTHLYVDT,                   
                  @@RETURNVNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + 1)),                    
  @@VNO = RTRIM(CONVERT(VARCHAR,@@MAXVNO + @NOOFRECORDS))                    
          
             END                    
        END            
                  
                    
IF @@ERROR <> 0                     
BEGIN                    
 ROLLBACK TRANSACTION                    
 SELECT VNO = ''                    
 RETURN                    
END                     
ELSE                    
BEGIN                    
       IF ISNULL(@@VNO,'') <> ''                     
       BEGIN                    
                  IF ISNULL(@@FLDAUTO,0) = 0                    
                  BEGIN                    
                    -- IF NO RECORD PRESENT, THEN INSERT                  
                        INSERT INTO V2_LASTVNO                   
                        (VTYP, BOOKTYPE, VDT, LASTVNO, VNOFLAG, FINYEAR)                  
                        VALUES                   
                        (@VTYP,@BOOKTYPE,@@UPDTVDT,@@VNO, @@VNOFLAG, @@FINYEAR)                    
                  END                    
                  ELSE                    
                  BEGIN                    
                        -- IF RECORD IS PRESENT, THEN UPDATE                  
                        UPDATE                   
                              V2_LASTVNO                   
                        SET                   
                              LASTVNO = @@VNO                   
                        WHERE                   
                              FLDAUTO = @@FLDAUTO                    
                  END                   
           
                        COMMIT TRANSACTION                    
          
                        SELECT VNO = @@RETURNVNO                    
                        RETURN                    
       END                     
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.OFFLINELEDGER_NEWACMULTIINSERT
-- --------------------------------------------------

CREATE PROCEDURE OFFLINELEDGER_NEWACMULTIINSERT          
@VTYP SMALLINT,               
@BOOKTYPE CHAR(2),               
@VNO VARCHAR(12),               
@LNO INT,               
@VDT VARCHAR(11),               
@EDT VARCHAR(11),               
@CLTCODE VARCHAR(10),               
@DRCR CHAR(1),                
@VAMT MONEY,               
@ENTEREDBY VARCHAR(25),               
@CDT VARCHAR(30),              
@CHECKEDBY VARCHAR(25),               
@PDT VARCHAR(30),             
@ACNAME VARCHAR(50),               
@NARRATION VARCHAR(234),               
@CHEQUEINNAME VARCHAR(50),               
@CHQPRINTED TINYINT,               
@ACCAT INT,               
@BNKNAME VARCHAR(50),               
@BRNNAME VARCHAR(30),               
@DD CHAR(1),               
@DDNO VARCHAR(15),               
@DDDT VARCHAR(11),                
@RELDT VARCHAR(11),            
@RELAMT MONEY,               
@MICRNO INT,               
@SESSIONID INT,               
@BRANCHNAME CHAR(10),               
@COSTFLAG VARCHAR(1),               
@COSTROWID INT,               
@CLEARINGMODE CHAR(1),               
@EMODE CHAR(1),
@REFLEDGERNO VARCHAR(12)
/*SLIPNO, , CHEQUEINNAME, CHQPRINTED*/              
AS              
DECLARE              
@@VNO1 AS VARCHAR(12),               
@@REFNO CHAR(12),               
@@NODAYS INT,               
@@ACTNODAYS INT,               
@@BALAMT MONEY,               
@@SLIPNO SMALLINT,               
@@SLIPDATE DATETIME,               
@@CLEARINGMODE CHAR(2),               
@@RECEIPTNO INT,               
@@BRANCH AS CHAR(15),               
@@EXCHANGE AS VARCHAR(3),               
@@SEGMENT AS VARCHAR(10),               
@@SETT_NO AS VARCHAR(7),               
@@SETT_TYPE AS VARCHAR(3),               
@@PARTY_CODE AS VARCHAR(10),               
@@VDT1 AS DATETIME,               
@@EDT1 AS DATETIME,               
@@DDDT1 AS DATETIME,               
@@RELDT1 AS DATETIME,               
@@RECORDCOUNT AS INT              
SELECT @@VDT1 = CONVERT(DATETIME, @VDT)              
SELECT @@EDT1 = CONVERT(DATETIME, @EDT)              
--SELECT @@DDDT1 = CONVERT(DATETIME, SUBSTRING(CONVERT(VARCHAR, @DDDT, 109), 1, 11)+' '+CONVERT(VARCHAR, GETDATE(), 114))       
SELECT @@DDDT1 = CONVERT(DATETIME,@DDDT)                     
/* SELECT @@RELDT1 = CONVERT(DATETIME, SUBSTRING(CONVERT(VARCHAR, @RELDT, 109), 1, 11)+' 00:00:00' */              
SELECT @@RELDT1 = CONVERT(DATETIME,@RELDT,109)              
SELECT @@VNO1 = @VNO              
SELECT @@REFNO = ''              
SELECT @@NODAYS = 0              
SELECT @@ACTNODAYS  = 0              
SELECT @@BALAMT = 0              
SELECT @@SLIPNO = 0              
SELECT @@SLIPDATE = ''              
/*SELECT @@CLEARINGMODE = ' ' */              
SELECT @@RECEIPTNO = 0              
SELECT @@BRANCH =  'BRANCH'              
/* INSERTING RECORD IN LEDGER */              
INSERT INTO LEDGER(VTYP, VNO, DRCR, VAMT, VDT, REFNO, CLTCODE, ENTEREDBY, LNO, BALAMT,               
VNO1, BOOKTYPE, EDT, CDT, PDT, NODAYS, ACTNODAYS, CHECKEDBY, ACNAME, NARRATION)               
VALUES (@VTYP, @VNO, @DRCR, @VAMT, @@VDT1, /*@@REFNO*/ @REFLEDGERNO, UPPER(@CLTCODE), @ENTEREDBY, @LNO, @@BALAMT,               
@@VNO1, @BOOKTYPE, @@EDT1, @CDT, @PDT, @@NODAYS, @@ACTNODAYS, @CHECKEDBY, @ACNAME, @NARRATION)              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* INSERTING RECORD IN LEDGER3 */              
INSERT INTO LEDGER3(NARATNO, NARR, REFNO, VTYP, VNO, BOOKTYPE) VALUES              
(@LNO, @NARRATION, @@REFNO, @VTYP, @VNO, @BOOKTYPE)              
/* INSERTING COMMON NARRATION IN LEDGER3 */              
IF @LNO = 2               
BEGIN              
       INSERT INTO LEDGER3(NARATNO, NARR, REFNO, VTYP, VNO, BOOKTYPE) VALUES              
       (0, @NARRATION, @@REFNO, @VTYP, @VNO, @BOOKTYPE)              
END               
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* INSERTING RECORD IN LEDGER1 IN CASE OF BANK RELATED VOUCHERS*/              
IF @VTYP = 2 OR @VTYP = 3 OR @VTYP = 5 OR @VTYP = 16 OR @VTYP = 17  OR @VTYP = 19 OR @VTYP = 20               
BEGIN              
   IF (@VTYP = 2 OR @VTYP = 19 OR @VTYP = 16)              
      BEGIN              
 IF   ( @DRCR = 'C' OR @DRCR = 'C' ) AND @LNO = 2              
      BEGIN                 
             INSERT INTO  LEDGER1(LNO, BNKNAME, BRNNAME, DD, DDNO, DDDT, RELAMT, VTYP, VNO, BOOKTYPE, REFNO, RELDT, MICRNO, SLIPNO, SLIPDATE, CLEAR_MODE, CHEQUEINNAME, CHQPRINTED, RECEIPTNO, DRCR)              
     VALUES (@LNO, @BNKNAME, SUBSTRING(@BRNNAME, 1, 20), @DD, RTRIM(@DDNO), @@DDDT1, @RELAMT, @VTYP, @VNO, @BOOKTYPE, @@REFNO, @RELDT, @MICRNO, @@SLIPNO, @@SLIPDATE, @CLEARINGMODE, @CHEQUEINNAME, @CHQPRINTED, @@RECEIPTNO, @DRCR)              
     END               
      END               
    ELSE IF (@VTYP = 3 OR @VTYP = 20 OR @VTYP = 17)              
        BEGIN              
   IF  ( @DRCR = 'D' OR @DRCR = 'D' ) AND @LNO = 2              
               
   BEGIN              
        INSERT INTO LEDGER1(LNO, BNKNAME, BRNNAME, DD, DDNO, DDDT, RELAMT, VTYP, VNO, BOOKTYPE, REFNO, RELDT, MICRNO, SLIPNO, SLIPDATE, CLEAR_MODE, CHEQUEINNAME, CHQPRINTED, RECEIPTNO, DRCR)              
            VALUES (@LNO, @BNKNAME, SUBSTRING(@BRNNAME, 1, 20), @DD, RTRIM(@DDNO), @@DDDT1, @RELAMT, @VTYP, @VNO, @BOOKTYPE, @@REFNO, @RELDT, @MICRNO, @@SLIPNO, @@SLIPDATE, @CLEARINGMODE, @CHEQUEINNAME, @CHQPRINTED, @@RECEIPTNO, @DRCR)              
      INSERT INTO PAYADV(CLTCODE, ACNAME, VDT, AMT, CHEQUENO, CHEQUEINNAME, NARRATION, PRINTEDFLAG, ACTAMT, SHORTAGE, VTYP, VNO, BOOKTYPE)              
            VALUES (UPPER(@CLTCODE), @ACNAME, @@VDT1, @RELAMT, RTRIM(@DDNO), @CHEQUEINNAME, @NARRATION, 0, @VAMT, 0, @VTYP, @VNO, @BOOKTYPE)              
                  END               
     END              
    ELSE IF @VTYP = 5              
        BEGIN              
             INSERT INTO  LEDGER1(LNO, BNKNAME, BRNNAME, DD, DDNO, DDDT, RELAMT, VTYP, VNO, BOOKTYPE, REFNO, RELDT, MICRNO, SLIPNO, SLIPDATE, CLEAR_MODE, CHEQUEINNAME, CHQPRINTED, RECEIPTNO, DRCR)              
         VALUES (@LNO, @BNKNAME, SUBSTRING(@BRNNAME, 1, 20), @DD, RTRIM(@DDNO), @@DDDT1, @RELAMT, @VTYP, @VNO, @BOOKTYPE, @@REFNO, @@RELDT1, @MICRNO, @@SLIPNO, @@SLIPDATE, @CLEARINGMODE, @CHEQUEINNAME, @CHQPRINTED, @@RECEIPTNO, @DRCR)              
   IF @ACCAT = 2 AND @DRCR = 'C'              
   BEGIN              
           INSERT INTO PAYADV(CLTCODE, ACNAME, VDT, AMT, CHEQUENO, CHEQUEINNAME, NARRATION, PRINTEDFLAG, ACTAMT, SHORTAGE, VTYP, VNO, BOOKTYPE)              
            VALUES (UPPER(@CLTCODE), @ACNAME, @@VDT1, @RELAMT, RTRIM(@DDNO), @CHEQUEINNAME, @NARRATION, 0, @VAMT, 0, @VTYP, @VNO, @BOOKTYPE)              
   END              
        END              
END              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
/* INSERTING RECORDS IN MATCHDETAILS AND UPDATING BILLMATCH */              
IF @LNO = 2               
BEGIN              
      DELETE  FROM TEMPBILLDETAILS WHERE PAYAMOUNT = 0 AND RTRIM(SESSIONID) = RTRIM(@SESSIONID)              
       UPDATE BILLMATCH SET BILLMATCH.BALAMT = BILLMATCH.BALAMT - PAYAMOUNT FROM TEMPBILLDETAILS T              
        WHERE  RTRIM(T.SESSIONID) = RTRIM(@SESSIONID)               
        AND T.PARTY_CODE = BILLMATCH.PARTY_CODE AND T.BILLVTYPE = BILLMATCH.VTYPE AND T.BILLBOOKTYPE = BILLMATCH.BOOKTYPE               
        AND T.BILLVNO = BILLMATCH.VNO AND T.BILLLNO = BILLMATCH.LNO              
        INSERT INTO MATCHDETAILS              
        SELECT DESCRIPTION, UPPER(PARTY_CODE), BILLVTYPE, BILLVNO, BILLLNO, BILLBOOKTYPE, DRCR, PAYAMOUNT, VTYPE, @VNO, @LNO, BOOKTYPE              
        FROM TEMPBILLDETAILS WHERE  RTRIM(SESSIONID) = RTRIM(@SESSIONID)               
END              
/* INSERTTING RECORDS IN MARGIN LEDGER */              
IF @ACCAT = 14 AND (@VTYP = 19 OR @VTYP = 20 OR @VTYP = 22 OR @VTYP = 23 OR @VTYP = 24)              
BEGIN              
   INSERT INTO MARGINLEDGER(VTYP, VNO, LNO, DRCR, VDT, AMOUNT, PARTY_CODE, EXCHANGE, SEGMENT, SETT_NO, SETT_TYPE, BOOKTYPE, MCLTCODE)              
   VALUES (@VTYP, @VNO, @LNO, @DRCR, @@VDT1, @VAMT, UPPER(@@PARTY_CODE), @@EXCHANGE, @@SEGMENT, 0, @@SETT_TYPE, @BOOKTYPE, UPPER(@CLTCODE))              
END              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */              
IF (@VTYP = '8' OR @VTYP = '19' OR @VTYP = '20' OR @VTYP = '24') AND UPPER(@EMODE) = 'M'                
BEGIN              
DECLARE @RECORDCOUNTER SMALLINT           DECLARE @PARTYCODE VARCHAR(50)                 
 DECLARE CUR_LEDGER_INSERT CURSOR FOR                 
        SELECT COUNT(PARTY_CODE), PARTY_CODE FROM TEMPLEDGER2 WHERE                 
        VTYPE = @VTYP AND VNO = @VNO AND LNO = @LNO AND DRCR = @DRCR AND               
 BOOKTYPE = @BOOKTYPE AND SESSIONID = @SESSIONID AND PARTY_CODE = @CLTCODE AND COSTFLAG = 'A'  GROUP BY PARTY_CODE              
                
        OPEN CUR_LEDGER_INSERT                
                
        FETCH NEXT FROM CUR_LEDGER_INSERT               
        INTO @RECORDCOUNTER, @PARTYCODE              
WHILE @@FETCH_STATUS = 0                
BEGIN               
--IF  @PARTYCODE <> @CLTCODE              
IF @RECORDCOUNTER = 1              
 BEGIN              
        DELETE FROM TEMPLEDGER2 WHERE VTYPE = @VTYP AND VNO = @VNO AND LNO = @LNO AND DRCR = @DRCR AND BOOKTYPE = @BOOKTYPE AND SESSIONID = @SESSIONID               
 --       INSERT INTO TEMPLEDGER2 VALUES (@@BRANCH, @BRANCHNAME, @VAMT, @VTYP, @VNO, @LNO, @DRCR, '0', @BOOKTYPE, @SESSIONID, UPPER(@CLTCODE), 'A', 0 )                
END              
/* ELSE              
 BEGIN              
  UPDATE TEMPLEDGER2 SET PAIDAMT = @VAMT WHERE VTYPE = @VTYP AND VNO = @VNO AND LNO = @LNO AND DRCR = @DRCR AND BOOKTYPE = @BOOKTYPE AND SESSIONID = @SESSIONID               
 END*/              
FETCH NEXT FROM CUR_LEDGER_INSERT                 
                 
END                
                
CLOSE CUR_LEDGER_INSERT                
DEALLOCATE CUR_LEDGER_INSERT                
END               
/* INSERTING RECORD IN TEMPLEDGER2 FOR BRANCH WISE BREAKUP WHEN BRNACHFLAG = 1 AND MATCH_CTOC = 1 IN PARAMETER FOR SELECTED YEAR*/              
IF UPPER(@EMODE) = 'A' OR UPPER(@EMODE) = 'M'              
/*SELECT @@RECORDCOUNT = COUNT(PARTY_CODE) FROM TEMPLEDGER2 WHERE               
VTYPE = @VTYP AND VNO = @VNO AND LNO = @LNO AND DRCR = @DRCR AND BOOKTYPE = @BOOKTYPE AND SESSIONID = @SESSIONID AND PARTY_CODE = UPPER(@CLTCODE) AND PAIDAMT = @VAMT              
IF @@RECORDCOUNT = 0              
BEGIN*/              
BEGIN              
 INSERT INTO TEMPLEDGER2 VALUES ( @@BRANCH, @BRANCHNAME, @VAMT, @VTYP, @VNO, @LNO, @DRCR, '0', @BOOKTYPE, @SESSIONID, UPPER(@CLTCODE), 'A', 0 )              
END              
--END              
/* ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.POPULATELASTVNO
-- --------------------------------------------------



CREATE PROC POPULATELASTVNO

AS

DECLARE
	@@PARA AS SMALLINT,
	@@STD_DATE AS VARCHAR(11),
	@@LST_DATE AS VARCHAR(11)

BEGIN TRAN

SELECT @@PARA = VNOFLAG, @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109), @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109) FROM PARAMETER WHERE CURYEAR = 1
IF @@PARA = 0		--FOR YEARLY SERIES
	BEGIN
		INSERT INTO LASTVNO
			SELECT VTYP, BOOKTYPE, @@STD_DATE, MAX(VNO)
			FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
			GROUP BY VTYP, BOOKTYPE
		INSERT INTO LASTVNO
			SELECT VTYP, BOOKTYPE, @@STD_DATE, MAX(VNO)
			FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01'
			AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
			GROUP BY VTYP, BOOKTYPE
	END
ELSE
	IF @@PARA = 2
		BEGIN
			INSERT INTO LASTVNO
				SELECT VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT))), MAX(VNO)
				FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01'
				AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
				GROUP BY VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT)))--MONTH(VDT), YEAR(VDT)
			INSERT INTO LASTVNO
				SELECT VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT))), MAX(VNO)
				FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01'
				AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
				GROUP BY VTYP, BOOKTYPE, CONVERT(DATETIME, CONVERT(VARCHAR, MONTH(VDT)) + '/01/' + CONVERT(VARCHAR, YEAR(VDT)))--MONTH(VDT), YEAR(VDT)
		END
	ELSE
		IF @@PARA = 1
			BEGIN
				INSERT INTO LASTVNO
					SELECT VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), MAX(VNO)
					FROM LEDGER WHERE VTYP = 15 AND BOOKTYPE = '01'
					AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
					GROUP BY VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109)
				INSERT INTO LASTVNO
					SELECT VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109), MAX(VNO)
					FROM LEDGER WHERE VTYP = 21 AND BOOKTYPE = '01'
					AND VDT BETWEEN @@STD_DATE AND @@LST_DATE + ' 23:59:59'
					GROUP BY VTYP, BOOKTYPE, CONVERT(VARCHAR(11), VDT, 109)
			END
COMMIT TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.POSTMCDXFUTVALAN
-- --------------------------------------------------

CREATE PROCEDURE POSTMCDXFUTVALAN  
@VTYP SMALLINT,  
@BOOKTYPE CHAR(2),  
@VNO VARCHAR(12),  
@VDT VARCHAR(11),  
@EDTDR VARCHAR(11),  
@EDTCR VARCHAR(11),  
@CDT DATETIME,  
@PDT DATETIME,  
@ENTEREDBY VARCHAR(25),   
@CHECKEDBY VARCHAR(25),  
@SETT_NO  VARCHAR(7),  
@SETT_TYPE VARCHAR(3),  
@SESSIONID INT  
  
/*SLIPNO,,CHEQUEINNAME,CHQPRINTED*/  
AS  
  
DECLARE  
@@LNO  AS INT,  
@@VNO1 AS VARCHAR(12),  
@@REFNO CHAR(12),  
@@NODAYS INT,  
@@ACTNODAYS INT,  
@@BALAMT MONEY,  
@@SLIPNO SMALLINT,  
@@SLIPDATE DATETIME,  
@@CLEARINGMODE CHAR(2),  
@@RECEIPTNO INT,  
@@DDNO       AS INT,  
@@VDT1 AS DATETIME,  
@@EDT1 AS DATETIME,  
@@EDT2 AS DATETIME,  
@@DDDT1 AS DATETIME,  
@@RELDT1     AS DATETIME,  
@@PARTY_CODE AS VARCHAR(10),   
@@BILL_NO    AS INT,   
@@SELL_BUY    AS CHAR(1),   
@@SETT_NO    AS VARCHAR(7),   
@@SETT_TYPE  AS VARCHAR(3),   
@@AMOUNT     AS MONEY,    
@@BRANCHCD   AS VARCHAR(10),   
@@VNARR      AS VARCHAR(234),  
@@VNARR1     AS VARCHAR(234),  
@@ACCAT      AS TINYINT,  
@@ACNAME     AS VARCHAR(100),  
@@BNKNAME    AS VARCHAR(20),  
@@BRNNAME    AS VARCHAR(20),  
@@RCURSOR    AS CURSOR  
  
SELECT @@VDT1 = CONVERT(DATETIME,@VDT+' '+CONVERT(VARCHAR,GETDATE(),114))  
SELECT @@EDT1 = CONVERT(DATETIME,@EDTDR+' '+CONVERT(VARCHAR,GETDATE(),114))  
SELECT @@EDT2 = CONVERT(DATETIME,@EDTCR+' '+CONVERT(VARCHAR,GETDATE(),114))  
  
SELECT @@VNO1 = @VNO  
SELECT @@RELDT1 = ''  
SELECT @@DDDT1 = @VDT  
SELECT @@REFNO = ''  
SELECT @@NODAYS = 0  
SELECT @@ACTNODAYS  = 0  
SELECT @@BALAMT = 0  
SELECT @@SLIPNO = 0  
SELECT @@SLIPDATE =''  
SELECT @@DDNO = 0  
/*SELECT @@CLEARINGMODE =' ' */  
SELECT @@RECEIPTNO = 0  
  
SELECT * INTO #LEDGER FROM LEDGER WHERE 1=2  
  
SELECT * INTO #LEDGER1 FROM LEDGER1 WHERE 1=2  
  
SET @@RCURSOR = CURSOR FOR  
SELECT PARTY_CODE, BILL_NO, SELL_BUY, SETT_NO, SETT_TYPE, AMOUNT, BRANCHCD, NARRATION, ACCAT, ACNAME=LONGNAME  
FROM MCDXCDS.DBO.ACCBILL B LEFT OUTER JOIN ACMAST A ON B.PARTY_CODE = A.CLTCODE  
WHERE SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE  
OPEN @@RCURSOR  
FETCH NEXT FROM @@RCURSOR   
INTO @@PARTY_CODE, @@BILL_NO, @@SELL_BUY, @@SETT_NO, @@SETT_TYPE, @@AMOUNT, @@BRANCHCD, @@VNARR, @@ACCAT, @@ACNAME  
  
SELECT @@LNO = 0  
SELECT @@VNARR1 = 'SETTNO=' + RTRIM(@SETT_NO) + 'MCD' + RTRIM(@SETT_TYPE) + RTRIM(@@VNARR)  
  
WHILE @@FETCH_STATUS = 0  
BEGIN  
  
   IF @@ACCAT = 4 OR @@BRANCHCD = 'ZZZ'  
   BEGIN  
      SELECT @@BNKNAME = RTRIM(@SETT_NO) + 'MCD' + RTRIM(@SETT_TYPE) + CONVERT(VARCHAR,@@BILL_NO,10)  
      SELECT @@BRNNAME = ''  
      SELECT @@LNO = @@LNO + 1  
     
      INSERT INTO #LEDGER(VTYP,VNO,DRCR,VAMT,VDT,REFNO,CLTCODE,ENTEREDBY,LNO,BALAMT,  
                           VNO1,BOOKTYPE,EDT,CDT,PDT,NODAYS,ACTNODAYS,CHECKEDBY,ACNAME,NARRATION)   
              VALUES (@VTYP,@VNO,(CASE WHEN @@SELL_BUY = 1 THEN 'D' ELSE 'C' END),@@AMOUNT,@@VDT1,@@REFNO,UPPER(@@PARTY_CODE),@ENTEREDBY,@@LNO,@@BALAMT,  
                           @@VNO1,@BOOKTYPE,(CASE WHEN @@SELL_BUY = 1 THEN @@EDT1 ELSE @@EDT2 END),@CDT,@PDT,@@NODAYS,@@ACTNODAYS,@CHECKEDBY,@@ACNAME,@@VNARR1)  
  
      INSERT INTO  #LEDGER1(LNO,BNKNAME,BRNNAME,DD,DDNO,DDDT,RELAMT,VTYP,VNO,BOOKTYPE,REFNO,RELDT,MICRNO,SLIPNO,SLIPDATE,CLEAR_MODE,CHEQUEINNAME,CHQPRINTED,RECEIPTNO,DRCR)  
                VALUES (@@LNO,@@BNKNAME,SUBSTRING(@@BRNNAME,1,20),'B',RTRIM(@@DDNO),@@DDDT1,@@AMOUNT,@VTYP,@VNO,@BOOKTYPE,@@REFNO,@@RELDT1,0,@@SLIPNO,@@SLIPDATE,'','',1,@@RECEIPTNO,(CASE WHEN @@SELL_BUY = 1 THEN 'D' ELSE 'C' END))  
  
   END  
  
   IF @@ACCAT = 4  
   BEGIN  
 INSERT INTO BILLMATCH(EXCHANGE,SEGMENT,SETT_TYPE,SETT_NO,BILLNO,DATE,PARTY_CODE,AMOUNT,DRCR,BALAMT,VTYPE,VNO,LNO,BRANCH,BOOKTYPE)  
                       VALUES('MCD','FUTURES',@@SETT_TYPE,@@SETT_NO,@@BILL_NO,@VDT,@@PARTY_CODE,@@AMOUNT,(CASE WHEN @@SELL_BUY = 1 THEN 'D' ELSE 'C' END),@@AMOUNT,@VTYP,@VNO,@@LNO,@@BRANCHCD,@BOOKTYPE)  
   END  
  
   FETCH NEXT FROM @@RCURSOR   
   INTO @@PARTY_CODE, @@BILL_NO, @@SELL_BUY, @@SETT_NO, @@SETT_TYPE, @@AMOUNT, @@BRANCHCD, @@VNARR, @@ACCAT, @@ACNAME  
  
END  
  
  
  
INSERT INTO LEDGER SELECT * FROM #LEDGER  
  
INSERT INTO LEDGER1 SELECT * FROM #LEDGER1  
  
  
INSERT INTO LEDGER3  
SELECT LNO,NARRATION,REFNO,VTYP,VNO,BOOKTYPE   
FROM #LEDGER   
WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO  
  
INSERT INTO LEDGER3  
SELECT 0,NARRATION,REFNO,VTYP,VNO,BOOKTYPE   
FROM #LEDGER   
WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO AND LNO = 1  
  
INSERT INTO LEDGER2  
SELECT VTYP, VNO, LNO, (CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END), AMOUNT, COSTCODE, BOOKTYPE, CLTCODE   
FROM #LEDGER L, MCDXCDS.DBO.ACCBILL B, COSTMAST C  
WHERE L.VTYP = @VTYP AND L.BOOKTYPE = @BOOKTYPE AND L.VNO = @VNO AND B.SETT_NO = @SETT_NO AND B.SETT_TYPE = @SETT_TYPE  
AND L.CLTCODE = B.PARTY_CODE AND B.BRANCHCD = C.COSTNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.POSTMCXVALAN
-- --------------------------------------------------

CREATE PROCEDURE POSTMCXVALAN  
@VTYP SMALLINT,  
@BOOKTYPE CHAR(2),  
@VNO VARCHAR(12),  
@VDT VARCHAR(11),  
@EDTDR VARCHAR(11),  
@EDTCR VARCHAR(11),  
@CDT DATETIME,  
@PDT DATETIME,  
@ENTEREDBY VARCHAR(25),   
@CHECKEDBY VARCHAR(25),  
@BILLDATE  VARCHAR(11),  
@SETT_TYPE VARCHAR(3),  
@SESSIONID INT  
  
/*SLIPNO,,CHEQUEINNAME,CHQPRINTED*/  
AS  
  
DECLARE  
@@LNO  AS INT,  
@@VNO1 AS VARCHAR(12),  
@@REFNO CHAR(12),  
@@NODAYS INT,  
@@ACTNODAYS INT,  
@@BALAMT MONEY,  
@@SLIPNO SMALLINT,  
@@SLIPDATE DATETIME,  
@@CLEARINGMODE CHAR(2),  
@@RECEIPTNO INT,  
@@DDNO       AS INT,  
@@VDT1 AS DATETIME,  
@@EDT1 AS DATETIME,  
@@EDT2 AS DATETIME,  
@@DDDT1 AS DATETIME,  
@@RELDT1     AS DATETIME,  
@@PARTY_CODE AS VARCHAR(10),   
@@BILL_NO    AS INT,   
@@SELL_BUY    AS CHAR(1),   
@@BILLDATE    AS VARCHAR(11),   
@@SETT_TYPE  AS VARCHAR(3),   
@@AMOUNT     AS MONEY,    
@@BRANCHCD   AS VARCHAR(10),   
@@VNARR      AS VARCHAR(234),  
@@VNARR1     AS VARCHAR(234),  
@@ACCAT      AS TINYINT,  
@@ACNAME     AS VARCHAR(35),  
@@BNKNAME    AS VARCHAR(20),  
@@BRNNAME    AS VARCHAR(20),  
@@RCURSOR    AS CURSOR  
  
SELECT @@VDT1 = CONVERT(DATETIME,@VDT+' '+CONVERT(VARCHAR,GETDATE(),114))  
SELECT @@EDT1 = CONVERT(DATETIME,@EDTDR+' '+CONVERT(VARCHAR,GETDATE(),114))  
SELECT @@EDT2 = CONVERT(DATETIME,@EDTCR+' '+CONVERT(VARCHAR,GETDATE(),114))  
  
SELECT @@VNO1 = @VNO  
SELECT @@RELDT1 = ''  
SELECT @@DDDT1 = @VDT  
SELECT @@REFNO = ''  
SELECT @@NODAYS = 0  
SELECT @@ACTNODAYS  = 0  
SELECT @@BALAMT = 0  
SELECT @@SLIPNO = 0  
SELECT @@SLIPDATE =''  
SELECT @@DDNO = 0  
/*SELECT @@CLEARINGMODE =' ' */  
SELECT @@RECEIPTNO = 0  
  
  
/* --------------- POSTING OF NORMAL VALAN ------------------ */  
SET @@RCURSOR = CURSOR FOR  
SELECT PARTY_CODE, BILL_NO, SELL_BUY, BILLDATE, SETT_TYPE, AMOUNT, BRANCHCD, NARRATION, ACCAT, ACNAME  
FROM MCDXCDS.DBO.FOACCBILL B LEFT OUTER JOIN ACMAST A ON B.PARTY_CODE = A.CLTCODE  
WHERE BILLDATE LIKE @BILLDATE + '%'  
OPEN @@RCURSOR  
FETCH NEXT FROM @@RCURSOR   
INTO @@PARTY_CODE, @@BILL_NO, @@SELL_BUY, @@BILLDATE, @@SETT_TYPE, @@AMOUNT, @@BRANCHCD, @@VNARR, @@ACCAT, @@ACNAME  
  
SELECT @@LNO = 0  
SELECT @@VNARR1 = 'MCD' + RTRIM(@BILLDATE) + '  ' + RTRIM(@@VNARR)  
  
WHILE @@FETCH_STATUS = 0  
BEGIN  
  
   IF @@ACCAT = 4 OR @@BRANCHCD = 'ZZZ'  
   BEGIN  
      SELECT @@BNKNAME = 'MCD' + RTRIM(@BILLDATE) + CONVERT(VARCHAR,@@BILL_NO,10)  
      SELECT @@BRNNAME = ''  
      SELECT @@LNO = @@LNO + 1  
     
      INSERT INTO LEDGER(VTYP,VNO,DRCR,VAMT,VDT,REFNO,CLTCODE,ENTEREDBY,LNO,BALAMT,  
                           VNO1,BOOKTYPE,EDT,CDT,PDT,NODAYS,ACTNODAYS,CHECKEDBY,ACNAME,NARRATION)   
              VALUES (@VTYP,@VNO,(CASE WHEN @@SELL_BUY = 1 THEN 'D' ELSE 'C' END),@@AMOUNT,@@VDT1,@@REFNO,UPPER(@@PARTY_CODE),@ENTEREDBY,@@LNO,@@BALAMT,  
                           @@VNO1,@BOOKTYPE,(CASE WHEN @@SELL_BUY = 1 THEN @@EDT1 ELSE @@EDT2 END),@CDT,@PDT,@@NODAYS,@@ACTNODAYS,@CHECKEDBY,@@ACNAME,@@VNARR1)  
  
      INSERT INTO  LEDGER1(LNO,BNKNAME,BRNNAME,DD,DDNO,DDDT,RELAMT,VTYP,VNO,BOOKTYPE,REFNO,RELDT,MICRNO,SLIPNO,SLIPDATE,CLEAR_MODE,CHEQUEINNAME,CHQPRINTED,RECEIPTNO,DRCR)  
                VALUES (@@LNO,@@BNKNAME,SUBSTRING(@@BRNNAME,1,20),'B',RTRIM(@@DDNO),@@DDDT1,@@AMOUNT,@VTYP,@VNO,@BOOKTYPE,@@REFNO,@@RELDT1,0,@@SLIPNO,@@SLIPDATE,'','',1,@@RECEIPTNO,(CASE WHEN @@SELL_BUY = 1 THEN 'D' ELSE 'C' END))  
  
   END  
  
   IF @@ACCAT = 4  
   BEGIN  
 INSERT INTO BILLMATCH(EXCHANGE,SEGMENT,SETT_TYPE,SETT_NO,BILLNO,DATE,PARTY_CODE,AMOUNT,DRCR,BALAMT,VTYPE,VNO,LNO,BRANCH,BOOKTYPE)  
                       VALUES('NSE','MCD',@@SETT_TYPE,0,@@BILL_NO,@VDT,@@PARTY_CODE,@@AMOUNT,(CASE WHEN @@SELL_BUY = 1 THEN 'D' ELSE 'C' END),@@AMOUNT,@VTYP,@VNO,@@LNO,@@BRANCHCD,@BOOKTYPE)  
   END  
  
   FETCH NEXT FROM @@RCURSOR   
   INTO @@PARTY_CODE, @@BILL_NO, @@SELL_BUY, @@BILLDATE, @@SETT_TYPE, @@AMOUNT, @@BRANCHCD, @@VNARR, @@ACCAT, @@ACNAME  
  
END  
  
INSERT INTO LEDGER3  
SELECT LNO,NARRATION,REFNO,VTYP,VNO,BOOKTYPE   
FROM LEDGER   
WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO  
  
INSERT INTO LEDGER3  
SELECT 0,NARRATION,REFNO,VTYP,VNO,BOOKTYPE   
FROM LEDGER   
WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO AND LNO = 1  
  
INSERT INTO LEDGER2  
SELECT VTYP, VNO, LNO, (CASE WHEN SELL_BUY = 1 THEN 'D' ELSE 'C' END), AMOUNT, COSTCODE, BOOKTYPE, CLTCODE   
FROM LEDGER L, MCDXCDS.DBO.FOACCBILL B, COSTMAST C  
WHERE L.VTYP = @VTYP AND L.BOOKTYPE = @BOOKTYPE AND L.VNO = @VNO AND B.BILLDATE LIKE @BILLDATE + '%'  
AND L.CLTCODE = B.PARTY_CODE AND B.BRANCHCD = C.COSTNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_GET_LEDBAL_COMBINE
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[PR_GET_LEDBAL_COMBINE]     
(    
 @MARGINDATE VARCHAR(11) 
) 

AS

-- EXEC PR_GET_LEDBAL_COMBINE 'DEC 12 2019'
DECLARE 
		@SDTCUR			DATETIME,
		@LDTCUR			DATETIME 

DECLARE @T5DAY VARCHAR(11)

SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM ACCOUNT.DBO.PARAMETER    
WHERE CONVERT(DATETIME,@MARGINDATE) BETWEEN SDTCUR AND LDTCUR
 
SELECT @T5DAY = LEFT(ISNULL(MAX(SEC_PAYIN),@MARGINDATE),11) FROM    
(SELECT DISTINCT TOP 5 SEC_PAYIN = CONVERT(DATETIME,LEFT(SEC_PAYIN,11)) FROM MSAJAG.DBO.SETT_MST (NOLOCK)     
WHERE SEC_PAYIN >= @MARGINDATE     
AND SETT_TYPE = 'N') S    

SELECT CLTCODE, VAMT=SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END) 
INTO #CASH_LED_BAL FROM LEDGER L (NOLOCK)
WHERE VDT <= @MARGINDATE + ' 23:59:59'
AND VDT >= @SDTCUR AND VDT<= @LDTCUR
AND CONVERT(DATETIME,@MARGINDATE) BETWEEN @SDTCUR AND @LDTCUR 
GROUP BY CLTCODE

INSERT INTO #CASH_LED_BAL 
SELECT CLTCODE, VAMT=SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END) 
FROM ACCOUNT.DBO.LEDGER L (NOLOCK)
WHERE VDT <= @MARGINDATE + ' 23:59:59' and EDT > @MARGINDATE + ' 23:59:59'
AND VDT >=CONVERT(DATETIME,@MARGINDATE,120)-7
AND VTYP IN (15,35) 
GROUP BY CLTCODE

/* NEW LOGIC ADDED TO REVERSE THE T DAY PAYMENT AND DEBIT JV */
INSERT INTO #CASH_LED_BAL 
SELECT CLTCODE, VAMT=SUM(VAMT) 
FROM ACCOUNT.DBO.LEDGER L (NOLOCK)
WHERE VDT BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59:59'
AND VDT >=CONVERT(DATETIME,@MARGINDATE,120)-7
AND VTYP IN (3, 8) AND DRCR = 'D'
GROUP BY CLTCODE
/* NEW LOGIC ADDED TO REVERSE THE T DAY PAYMENT AND DEBIT JV */

INSERT INTO #CASH_LED_BAL
SELECT       
CLTCODE, /*CHEQUE CANCELED TILL T+5 OF VDT TILL T+1*/      
SUM( CASE WHEN A.DRCR ='C' THEN VAMT ELSE - VAMT END) VAMT    
FROM LEDGER A (NOLOCK), LEDGER1 B (NOLOCK)       
WHERE       
A.VTYP = '17'      
AND A.VTYP = B.VTYP AND A.VNO = B.VNO       
AND A.BOOKTYPE = B.BOOKTYPE AND A.LNO = B.LNO                    
AND A.VDT BETWEEN DATEADD(D, 1, @MARGINDATE) AND @T5DAY + ' 23:59:58'      
AND EXISTS (SELECT L1.CLTCODE,L1.VAMT,L2.DDNO       
    FROM LEDGER L1 (NOLOCK), LEDGER1 L2 (NOLOCK)        
    WHERE L1.VTYP = '2' /*RECEIPTS VDT TILL T+1*/      
    AND L1.VTYP = L2.VTYP AND L1.VNO = L2.VNO       
    AND L1.BOOKTYPE = L2.BOOKTYPE      
    AND L1.LNO = L2.LNO       
    AND L1.VDT >= @SDTCUR AND L1.VDT <= @MARGINDATE + ' 23:59:58'      
    AND A.CLTCODE = L1.CLTCODE      
    AND A.VAMT = L1.VAMT      
    AND B.DDNO = L2.DDNO      
    AND L2.CLEAR_MODE = 'R')      
GROUP BY CLTCODE      
           		    
DELETE FOMARGINNEW_LEDGERBAL WHERE MARGINDATE < DATEADD(M,-1,@MARGINDATE)    
DELETE FOMARGINNEW_LEDGERBAL WHERE MARGINDATE = @MARGINDATE  

INSERT INTO FOMARGINNEW_LEDGERBAL    
 SELECT     
  @MARGINDATE,    
  CLTCODE,    
  SUM(VAMT) VAMT,    
  GETDATE()    
  FROM #CASH_LED_BAL
  GROUP BY CLTCODE

DROP TABLE #CASH_LED_BAL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_SQLTABLEREINDEX
-- --------------------------------------------------


CREATE  PROC PR_SQLTABLEREINDEX (@TABLE_NAME AS VARCHAR(254) = '') AS
/*--------------------------------------------------------------------------------------------------------------------
PROGRAM NAME 	: PR_SQLTABLEREINDEX
DESC 		: SQL SCRIPTS TO 
				1. RE INDEX ALL THE TRANSACTION ORIENTED TABLES
				2. CHECKING INDEX KEY DUPLICATION 
TABLES USING 	: 1. SQLTABLEINDEX  - KEEPING THE FOLLOWING DETAILS
			A. TABLENAME
			B. INDEXNAME
			C. INDEXCOLUMN
		  2.  SQLTABLEREINDEX_LOG - KEEPING RE INDEX LOG 
					    AND INDEX DUPLICATION RECORD
LOGIC 		: 
			CHECKING THE AVAILABILITY OF THE REQUIRED INDEX 
				IF FOUND  --  RE INDEX & LOG TO SQLTABLEREINDEX_LOG WITH A REMARK AS 'REINDEX'
				ELSE   - CREATE & LOG TO SQLTABLEREINDEX_LOG WITH A REMARK AS 'NEWINDEX'
				
			CHECKING THE INDEX KEY DUPLICATION
				IF FOUND  -- LOG TO SQLTABLEREINDEX_LOG WITH A REMARK AS 'DUPLICATE'
PROGRAM BENEFIT : 
			1. STANDARD TABLE INDEX TO MAINTAIN
			2. RE CREATION OF INDEX FOR PERFORMANCE

----------------------------------------------------------------------------------------------------------------------*/



DECLARE 
	@TABLECUR CURSOR,
	@TABLENAME VARCHAR(20),
	@INDEXNAME VARCHAR(10),
	@INDEXCOLUMN VARCHAR(100),
	@INDEXCOLUMNCHK VARCHAR(100)
DECLARE 
	@TINDEXNAME VARCHAR(20),
	@TINDEXCOLUM VARCHAR(100),
	@STRSQL VARCHAR(200),
	@INDEXCURSOR CURSOR,
	@INDEXFLAG INT,
	@INDEXPRV VARCHAR(20),
	@INDEXCOLUMNPRV VARCHAR(100),
 	@INDEXTYPE VARCHAR(20)

SET NOCOUNT ON

SET @TABLECUR = CURSOR FOR
SELECT
	TABLENAME,
	INDEXNAME,
	INDEXCOLUMN,
	INDEXCOLUMNCHK = LTRIM(RTRIM(UPPER(REPLACE(INDEXCOLUMN,',',''))))
FROM
	SQLTABLEINDEX
WHERE
	1 = 1
	AND TABLENAME = (CASE WHEN ISNULL(@TABLE_NAME,'') <> '' THEN @TABLE_NAME ELSE TABLENAME END) 


OPEN @TABLECUR
FETCH NEXT FROM @TABLECUR INTO 	@TABLENAME,@INDEXNAME,@INDEXCOLUMN,@INDEXCOLUMNCHK
WHILE @@FETCH_STATUS = 0       
BEGIN      
	SET @INDEXFLAG  = 0
	SET @INDEXCOLUMNPRV = ''
	SET @INDEXPRV = ''
	SET @INDEXCURSOR = CURSOR FOR SELECT * FROM 
	(
		SELECT 
			I.NAME AS INDEXNAME,
			CASE WHEN (I.STATUS & 16)<> 0 THEN 'CLUSTERED' 
			ELSE 'NONCLUSTERED' END AS INDEXTYPE,
			UPPER(ISNULL(INDEX_COL(@TABLENAME, I.INDID,1 ),'')+ISNULL(INDEX_COL(@TABLENAME, I.INDID,2 ),'')
			+ISNULL(INDEX_COL(@TABLENAME, I.INDID,3 ),'')+ISNULL(INDEX_COL(@TABLENAME, I.INDID,4 ),'')
			+ISNULL(INDEX_COL(@TABLENAME, I.INDID,5 ),'')+ISNULL(INDEX_COL(@TABLENAME, I.INDID,6),'')
			+ISNULL(INDEX_COL(@TABLENAME, I.INDID,7 ),'')+ISNULL(INDEX_COL(@TABLENAME, I.INDID,8),'') ) AS INDEXCOLUMNS
		FROM 
			(DBO.SYSINDEXES I INNER JOIN DBO.SYSFILEGROUPS S ON I.GROUPID = S.GROUPID )
		WHERE 
			ID = OBJECT_ID(@TABLENAME) AND I.INDID > 0 AND I.INDID < 255 AND
			(INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISSTATISTICS') <> 1) AND
			(INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISAUTOSTATISTICS') <> 1) AND
			(INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISHYPOTHETICAL') <> 1)
		 
	)TBLIDX  ORDER BY INDEXCOLUMNS
	OPEN @INDEXCURSOR
	FETCH NEXT FROM @INDEXCURSOR INTO @TINDEXNAME,@INDEXTYPE,@TINDEXCOLUM
	WHILE @@FETCH_STATUS = 0       
	BEGIN     
		IF @INDEXCOLUMNPRV = @TINDEXCOLUM
			BEGIN
				INSERT INTO SQLTABLEREINDEX_LOG VALUES 
				(@TABLENAME,@INDEXPRV,@TINDEXCOLUM,'DUPLICATE',@@SPID,GETDATE())	
			END 
		IF (@TINDEXCOLUM = @INDEXCOLUMNCHK OR @INDEXNAME = @TINDEXNAME) AND @INDEXFLAG =0
			BEGIN
				SET @INDEXFLAG  = 1
				SET @STRSQL = 'CREATE ' + @INDEXTYPE + ' INDEX ['+ @TINDEXNAME +'] ON [DBO].['+@TABLENAME+']('
				SET @STRSQL = @STRSQL + @INDEXCOLUMN + ')'
				SET @STRSQL = @STRSQL + ' WITH  DROP_EXISTING ON [PRIMARY]'
				EXEC (@STRSQL)
				INSERT INTO SQLTABLEREINDEX_LOG VALUES 
				(@TABLENAME,@TINDEXNAME,@INDEXCOLUMN,'REINDEX',@@SPID,GETDATE())
			END
		SET @INDEXPRV = @TINDEXNAME
		SET @INDEXCOLUMNPRV = @TINDEXCOLUM
		FETCH NEXT FROM @INDEXCURSOR INTO @TINDEXNAME,@INDEXTYPE,@TINDEXCOLUM
	END      
	CLOSE @INDEXCURSOR      
	DEALLOCATE @INDEXCURSOR
	IF @INDEXFLAG =0
		BEGIN
			SET @STRSQL = 'CREATE INDEX ['+ @INDEXNAME +'] ON [DBO].['+@TABLENAME+']('
			SET @STRSQL = @STRSQL + @INDEXCOLUMN + ')'
			EXEC (@STRSQL)
			INSERT INTO SQLTABLEREINDEX_LOG VALUES 
			(@TABLENAME,@INDEXNAME,@INDEXCOLUMN,'NEWINDEX',@@SPID,GETDATE())
		END
	FETCH NEXT FROM @TABLECUR INTO 	@TABLENAME,@INDEXNAME,@INDEXCOLUMN,@INDEXCOLUMNCHK
END
CLOSE @TABLECUR      
DEALLOCATE @TABLECUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_ACC_GETCOMPANYNAME
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.PROC_ACC_GETCOMPANYNAME    SCRIPT DATE: 5/18/04 1:04:54 PM ******/  
  
CREATE  PROCEDURE PROC_ACC_GETCOMPANYNAME  
 @ACCOUNDDBNAME VARCHAR (50)  
AS  
  
SELECT * FROM  
 PRADNYA.DBO.MULTICOMPANY  
  
WHERE  
 ACCOUNTDB = @ACCOUNDDBNAME AND  
 PRIMARYSERVER = 1  
  
ORDER BY  
 COMPANYNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MARGIN_FNO_JV
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_MARGIN_FNO_JV]        
(        
 @TRANSDATE VARCHAR(11),        
 @EXCHANGE VARCHAR(3),        
 @SEGMENT VARCHAR(7),        
 @BATCHNO INT        
)        
AS        
        
DECLARE               
--  @PREVDATE_1 VARCHAR(11),              
  @PREVDATE VARCHAR(11),              
  @SDTCUR VARCHAR(11),              
  @LDTCUR VARCHAR(11),              
  @CUTOFFDATE DATETIME,        
  @RefNo Varchar(4),        
  @filebrokercode varchar(1)        
          
DECLARE @STARTDATE VARCHAR(11)          
      
SELECT @SDTCUR = SDTCUR, @LDTCUR = LDTCUR FROM PARAMETER              
WHERE @TRANSDATE BETWEEN SDTCUR AND LDTCUR          
      
SELECT CLTCODE=PARTY_CODE, AMOUNT, FROM_EXCHANGE=FROM_EXCHANGE, FROM_SEGMENT = FROM_SEGMENT,        
TO_EXCHANGE, TO_SEGMENT,          
BANKNAME = CONVERT(VARCHAR(4),''),        
BANK_GL = CONVERT(VARCHAR(10),''),        
JV_GL = CONVERT(VARCHAR(10),''),        
NARR = CONVERT(VARCHAR(100),''),        
INTNO = CONVERT(VARCHAR(15),'')        
INTO #FINALLEDGER_CR          
FROM NSEFO.DBO.Tbl_ALL_MarginProcess_Fund              
WHERE TRANSDATE = @TRANSDATE         
AND POSTEDFLAG = 0        
AND AMOUNT > 0         
AND FROM_EXCHANGE = @EXCHANGE        
AND FROM_SEGMENT = @SEGMENT         
        
SELECT CLTCODE=PARTY_CODE, AMOUNT, FROM_EXCHANGE=TO_EXCHANGE, FROM_SEGMENT = TO_SEGMENT,         
TO_EXCHANGE=FROM_EXCHANGE, TO_SEGMENT=FROM_SEGMENT,         
BANKNAME = CONVERT(VARCHAR(4),''),        
BANK_GL = CONVERT(VARCHAR(10),''),        
JV_GL = CONVERT(VARCHAR(10),''),        
NARR = CONVERT(VARCHAR(100),''),        
INTNO = CONVERT(VARCHAR(15),'')        
INTO #FINALLEDGER_DR          
FROM NSEFO.DBO.Tbl_ALL_MarginProcess_Fund              
WHERE TRANSDATE = @TRANSDATE         
AND POSTEDFLAG = 0        
AND AMOUNT > 0         
AND TO_EXCHANGE = @EXCHANGE        
AND TO_SEGMENT = @SEGMENT         
        
UPDATE #FINALLEDGER_DR SET JV_GL = JV_GLCODE        
FROM NSEFO.DBO.Tbl_OTHERGLCODE N        
WHERE #FINALLEDGER_DR.FROM_EXCHANGE = N.FROM_EXCHANGE        
AND #FINALLEDGER_DR.FROM_SEGMENT = N.FROM_SEGMENT        
AND #FINALLEDGER_DR.TO_EXCHANGE = N.TO_EXCHANGE        
AND #FINALLEDGER_DR.TO_SEGMENT = N.TO_SEGMENT        
        
UPDATE #FINALLEDGER_CR SET JV_GL = JV_GLCODE        
FROM NSEFO.DBO.Tbl_OTHERGLCODE N        
WHERE #FINALLEDGER_CR.FROM_EXCHANGE = N.FROM_EXCHANGE        
AND #FINALLEDGER_CR.FROM_SEGMENT = N.FROM_SEGMENT        
AND #FINALLEDGER_CR.TO_EXCHANGE = N.TO_EXCHANGE        
AND #FINALLEDGER_CR.TO_SEGMENT = N.TO_SEGMENT        
        
SELECT *,        
BANK_GL = CONVERT(VARCHAR(10),''),        
JV_GL = CONVERT(VARCHAR(10),''),        
INTNO = CONVERT(VARCHAR(15),'')         
INTO #LEDGER_CR FROM LEDGER              
WHERE VTYP = 2 AND 1 =2              
              
SELECT *,        
BANK_GL = CONVERT(VARCHAR(10),''),        
JV_GL = CONVERT(VARCHAR(10),''),        
INTNO = CONVERT(VARCHAR(15),'')         
INTO #LEDGER_DR FROM LEDGER              
WHERE VTYP = 3 AND 1 =2              
              
ALTER TABLE #LEDGER_CR              
ADD SNO INT IDENTITY(1,1)              
              
ALTER TABLE #LEDGER_DR              
ADD SNO INT IDENTITY(1,1)              
              
DECLARE @VNO BIGINT              
              
ALTER TABLE #FINALLEDGER_CR              
ADD SNO INT IDENTITY(1,1)              
              
ALTER TABLE #FINALLEDGER_DR              
ADD SNO INT IDENTITY(1,1)              
        
TRUNCATE TABLE #LEDGER_CR        
TRUNCATE TABLE #LEDGER_DR        
        
SET @VNO = 0               
        
TRUNCATE TABLE #LEDGER_CR        
TRUNCATE TABLE #LEDGER_DR        
        
SET @VNO = 0               
INSERT INTO #LEDGER_CR              
SELECT VTYP = 8, VNO = SNO, EDT = @TRANSDATE, LNO=1, ACNAME = CLTCODE, DRCR='C', VAMT=ABS(AMOUNT), VDT=@TRANSDATE,VNO1=SNO,            
REFNO=0,BALAMT=0,NODAYS=0,CDT=@TRANSDATE,CLTCODE,BOOKTYPE='01', ENTEREDBY='BACKEND-ANI', PDT = GETDATE(),             
CHECKEDBY =FROM_EXCHANGE+FROM_SEGMENT, '0', NARRATION = 'INTER SEGMENT JV FROM ' + TO_EXCHANGE+TO_SEGMENT,        
BANK_GL,        
JV_GL,        
INTNO=''                 
FROM #FINALLEDGER_DR          
WHERE BANK_GL = ''            
ORDER BY SNO              
            
INSERT INTO #LEDGER_DR              
SELECT VTYP = 8, VNO = SNO, EDT = @TRANSDATE, LNO=1, ACNAME = CLTCODE, DRCR='D', VAMT=ABS(AMOUNT), VDT=@TRANSDATE,VNO1=SNO,            
REFNO=0,BALAMT=0,NODAYS=0,CDT=@TRANSDATE,CLTCODE,BOOKTYPE='01', ENTEREDBY='BACKEND-ANI', PDT = GETDATE(),             
CHECKEDBY =FROM_EXCHANGE+FROM_SEGMENT, '0', NARRATION = 'INTER SEGMENT JV TO ' + TO_EXCHANGE+TO_SEGMENT,        
BANK_GL,        
JV_GL,        
INTNO=''               
FROM #FINALLEDGER_CR              
WHERE BANK_GL = ''        
ORDER BY SNO              
    
DECLARE @REC INT    
SELECT @REC = 0    
SELECT @REC = COUNT(1) FROM #LEDGER_CR    
    
CREATE TABLE #VNO    
(    
 LASTVNO BIGINT    
)    
    
IF @REC > 0     
BEGIN    
 INSERT INTO #VNO    
 EXEC ACC_GENVNO_NEW    
   @TRANSDATE,    
   '8',    
   '01',    
   @SDTCUR ,    
   @LDTCUR,    
   @REC    
       
   SELECT @VNO = LASTVNO - 1     
   FROM   #VNO    
  
 INSERT INTO LEDGER              
 SELECT VTYP,VNO=@VNO+SNO,EDT,LNO+1,ACNAME,DRCR,VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE='01',ENTEREDBY='ANIMESH',              
    PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION             
 FROM #LEDGER_CR               
             
 INSERT INTO LEDGER              
 SELECT VTYP,VNO=@VNO+SNO,EDT,LNO,ACNAME,DRCR='D',VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE=JV_GL,BOOKTYPE='01',ENTEREDBY='ANIMESH',              
    PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION             
 FROM #LEDGER_CR               
END  
              
TRUNCATE TABLE #LEDGER_CR            
        
SET @VNO = 0          
    
SELECT @REC = 0    
SELECT @REC = COUNT(1) FROM #LEDGER_DR    
    
TRUNCATE TABLE #VNO    
    
IF @REC > 0     
BEGIN    
 INSERT INTO #VNO    
 EXEC ACC_GENVNO_NEW    
   @TRANSDATE,    
   '8',    
   '01',    
   @SDTCUR ,    
   @LDTCUR,    
   @REC    
       
   SELECT @VNO = LASTVNO - 1  
   FROM   #VNO    
     
 INSERT INTO LEDGER              
 SELECT VTYP,VNO=@VNO+SNO,EDT,LNO+1,ACNAME,DRCR,VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,CLTCODE,            
 BOOKTYPE='01',ENTEREDBY='ANIMESH',              
    PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION FROM #LEDGER_DR               
               
 INSERT INTO LEDGER              
 SELECT VTYP,VNO=@VNO+SNO,EDT,LNO,ACNAME,DRCR='C',VAMT,VDT=VDT,VNO1=@VNO+SNO,REFNO,BALAMT,NODAYS,CDT,            
 CLTCODE=JV_GL,BOOKTYPE='01',ENTEREDBY='ANIMESH',              
    PDT,CHECKEDBY,ACTNODAYS=@BATCHNO,NARRATION FROM #LEDGER_DR               
END  
               
TRUNCATE TABLE #LEDGER_DR            
        
UPDATE LEDGER SET ACNAME = LONGNAME         
FROM ACMAST A              
WHERE VDT = @TRANSDATE AND A.CLTCODE = LEDGER.CLTCODE              
AND LEDGER.ACNAME <> LONGNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECEIPT_DATA
-- --------------------------------------------------
CREATE PROC [DBO].[RECEIPT_DATA]                  
(                  
  @FROMDATE VARCHAR(11),                  
  @TODATE VARCHAR(11)               
 )                           
 AS                  
 BEGIN                  
 SELECT DISTINCT                  
 [CLTCODE] = A.CLTCODE,                  
 [SHORT_NAME]= B.SHORT_NAME,                  
 [REGION] = B.REGION,                  
 [BRANCH] = B.BRANCH_CD,                  
 [SUBBROKER] = B.SUB_BROKER,                  
 [VDATE] = A.VDT,                  
 [V_NO] = A.VNO,                  
 [NARRATION] = A.NARRATION,                  
 [VAMT] = A.VAMT,                  
 [DDNO] = C.DDNO,                  
 [VTYP] = A.VTYP,                  
 [BANKNAME] = B.BANK_NAME,                  
 [ACNUM] = B.AC_NUM,                  
 [RELDT] = C.RELDT,            
 [BOOKTYPE] = A.BOOKTYPE                   
INTO  #TEMP2                    
 FROM                  
 [196.1.115.204].ACCOUNTMCDXCDS.DBO.LEDGER A,                  
 [196.1.115.196].MSAJAG.DBO.CLIENT_DETAILS B,                  
 [196.1.115.204].ACCOUNTMCDXCDS.DBO.LEDGER1 C                  
 WHERE A.VTYP='2' AND A.VDT >= @FROMDATE AND A.VDT < =@TODATE + ' 23:59:59'                    
 AND ISNUMERIC(A.CLTCODE)  ='0' AND A.CLTCODE = B.CL_CODE AND  A.VTYP = C.VTYP AND A.VNO = C.VNO                  
 AND A.CLTCODE IN (SELECT CLTCODE FROM [196.1.115.204].ACCOUNTMCDXCDS.DBO.ACMAST WHERE ACCAT=4) AND A.BOOKTYPE=C.BOOKTYPE             
 ORDER BY A.CLTCODE                  
                  
 SELECT                  
 [CLTCODE] = CLTCODE,                  
 [ACNAME]= ACNAME,                  
 [VNO] = VNO,                  
 [DRCR] = DRCR,BOOKTYPE                    
 INTO #TEMP3                  
 FROM LEDGER(NOLOCK) D                  
 WHERE                   
 D.VTYP='2' AND D.VDT >= @FROMDATE AND D.VDT <=@TODATE + ' 23:59:59'                  
 AND D.VNO IN (SELECT V_NO FROM #TEMP2(NOLOCK))                  
                  
 SELECT B.CLTCODE,B.ACNAME,A.REGION,A.BRANCH,A.SUBBROKER,A.VDATE,A.V_NO,A.VAMT,B.DRCR,A.DDNO,A.NARRATION,A.RELDT,A.BANKNAME,A.ACNUM,A.BOOKTYPE,                  
 'MCDXCDS' AS EXCHANGE                  
 FROM #TEMP2(NOLOCK) A INNER JOIN #TEMP3(NOLOCK) B ON A.V_NO=B.VNO   AND A.BOOKTYPE=B.BOOKTYPE  AND A.VTYP =2           
 ORDER BY A.V_NO                 
                   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECEIPT_DATA_REVISED
-- --------------------------------------------------
CREATE PROC RECEIPT_DATA_REVISED             
(            
@FROMDATE datetime ,            
@TODATE   datetime       
          
)            
AS             
BEGIN             
SELECT  * INTO #TEMP FROM (            
SELECT            
           
[CLTCODE]=CLTCODE,            
[VDT]    =L.VDT,            
[VNO]    =L.VNO,  
[NARRATION]=L.NARRATION,            
[VAMT]   =L.VAMT,            
[DRCR]   =L.DRCR,            
[DDNO]   =L1.DDNO,            
[VTYP]   =L.VTYP,            
[RELDT]  =L1.RELDT,            
[BOOKTYPE]=L.BOOKTYPE            
    
FROM LEDGER L (NOLOCK) , LEDGER1 L1 (NOLOCK)            
WHERE L.VNO=L1.VNO AND L.VTYP=L1.VTYP AND L.BOOKTYPE=L1.BOOKTYPE     
AND L.DRCR ='D' AND L.VTYP =2 AND L.VDT >= @FROMDATE AND L.VDT < =@TODATE + ' 23:59:59.999'     
    
UNION ALL            
            
SELECT CLTCODE,L.VDT,L.VNO,L.NARRATION,L.VAMT,L.DRCR,L1.DDNO,            
 L.VTYP,L1.RELDT,L.BOOKTYPE            
 FROM LEDGER L(NOLOCK), LEDGER1 L1 (NOLOCK)            
WHERE L.VNO=L1.VNO AND L.VTYP=L1.VTYP AND L.BOOKTYPE=L1.BOOKTYPE            
AND L.DRCR ='C' AND L.VTYP =2  AND L.VDT >=@FROMDATE AND L.VDT < =@TODATE + ' 23:59:59.999'       
  )A            
            
SELECT            
A.*,            
[SHORT_NAME]=B.SHORT_NAME,            
[REGION]=B.REGION,            
[BRANCH_CD]=B.BRANCH_CD,            
[SUB_BROKER]=B.SUB_BROKER,            
[BANK_NAME]=B.BANK_NAME,            
[AC_NUM]=B.AC_NUM ,  
[EXCHANGE]='MCDXCDS'           
            
            
FROM   #TEMP A LEFT OUTER JOIN            
MSAJAG.DBO.CLIENT_DETAILS B ON A.CLTCODE = B.CL_CODE             
 END            
             
             
 ---EXEC RECEIPT_DATA_REVISED 'MAY 10 2015','MAY 21 2015'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECPAYUPLOAD_BULK
-- --------------------------------------------------
CREATE PROC [dbo].[RECPAYUPLOAD_BULK]      
 @FNAME VARCHAR(100),      
 @UNAME VARCHAR(25),      
 @USERCAT SMALLINT      
      
AS      
/*      
begin tran      
SP_HELPTRIGGER LEDGER      
LEDGER_TRG_BILL      
LEDGER_TRG      
Exec RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\SAMPLE1.csv', 'JAYDEEP', 388      
SELECT TOP 1 * FROM LEDGER3      
SELECT TOP 1 * FROM LEDGER_TRG      
ROLLBACK      
*/      
SET NOCOUNT ON      
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/      
DECLARE      
 @@STD_DATE VARCHAR(11),      
 @@LST_DATE VARCHAR(11),      
 @@BRANCHFLAG AS TINYINT,      
 @@VNOFLAG AS TINYINT,      
 @@VNOMETHOD INT,      
 @@ACNAME CHAR(100),      
 @@BOOKTYPE CHAR(2),      
 @@MICRNO VARCHAR(10),      
 @@DRCR VARCHAR(1),      
 @@VTYP SMALLINT,      
 @@BANK_CODE VARCHAR(100),      
 @@BACKDAYS INT,      
 @@BACKDATE VARCHAR(11),      
 @@BRNCOUNT   TINYINT,      
 @@MonthlyVdt VARCHAR(11),      
 @@SERIAL_NO INT,      
 @@COSTCODECOUNT TINYINT,      
 @@COSTCODEUPDATES CURSOR,      
 @@NEWVNO AS VARCHAR(12),      
 @@MAXCOUNT AS INT,      
 @@VDT AS VARCHAR(11),      
 @@BANKBRANCH AS VARCHAR(10),      
 @@BANKCOST AS NUMERIC,      
 @@LNOCUR AS CURSOR,      
 @@VNOCUR AS CURSOR,      
 @@LNOVNO AS VARCHAR(12),      
 @@MAXVNO AS INT,      
 @@L2CUR AS CURSOR,      
 @@L2VNO AS VARCHAR(12),      
 @@ERROR_COUNT AS INT,      
 @@FILEEXISTS AS INT,      
 @@SQL AS VARCHAR(2000)      
      
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT      
   U_FILENAME      
  FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
 ) A      
IF @@ERROR_COUNT > 0      
 BEGIN      
  SELECT      
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'      
  RETURN      
 END      
CREATE TABLE #FEXIST      
(      
 F1 SMALLINT,      
 F2 SMALLINT,      
 F3 SMALLINT      
)      
SELECT @@SQL = "INSERT INTO "      
SELECT @@SQL = @@SQL + " #FEXIST "      
SELECT @@SQL = @@SQL + " (F1, F2, F3) "      
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "      
      
EXEC(@@SQL)      
      
SELECT      
 @@FILEEXISTS = F1      
FROM      
 #FEXIST      
      
IF @@FILEEXISTS = 0      
 BEGIN      
  DROP TABLE #FEXIST      
  SELECT      
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'      
  RETURN      
 END      
DROP TABLE #FEXIST      
      
BEGIN TRAN      
CREATE TABLE #RECPAY_TABLE_TMP      
(      
 SERIAL_NO INT,      
 EDATE VARCHAR(20),      
 VOUCHER_DATE VARCHAR(20),      
 CLIENT_CODE VARCHAR(50),      
 AMOUNT MONEY,      
 DRCR VARCHAR(1),      
 NARRATION VARCHAR(234),      
 BANK_CODE VARCHAR(10),      
 BANK_NAME VARCHAR(100),      
 REF_NO VARCHAR(15),      
 BRANCHCODE VARCHAR(20),      
 BRANCH_NAME VARCHAR(50),      
 CHQ_MODE VARCHAR(1),      
 CHQ_DATE VARCHAR(20),      
 CHQ_NAME VARCHAR(100),      
 CL_MODE VARCHAR(1)      
)      
CREATE TABLE [#RECPAY_TABLE]      
 (      
  SERIAL_NO INT,      
  EDATE VARCHAR(20),      
  VOUCHER_DATE VARCHAR(20),      
  CLIENT_CODE VARCHAR(50),      
  AMOUNT MONEY,      
  DRCR VARCHAR(1),      
  NARRATION VARCHAR(234),      
  BANK_CODE VARCHAR(10),      
  BANK_NAME VARCHAR(100),      
  REF_NO VARCHAR(15),      
  BRANCHCODE VARCHAR(20),      
  BRANCH_NAME VARCHAR(50),      
  CHQ_MODE VARCHAR(1),      
  CHQ_DATE VARCHAR(20),      
  CHQ_NAME VARCHAR(100),      
  CL_MODE VARCHAR(1),      
  SNO INT IDENTITY (1, 1) NOT NULL ,      
  VDT DATETIME NULL ,      
  FYSTART DATETIME NULL ,      
  FYEND DATETIME NULL ,      
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),      
  EDT DATETIME NULL ,      
  DDDT DATETIME NULL ,      
  VNO VARCHAR (12) NULL ,      
  VTYP SMALLINT NULL ,      
  ACNAME VARCHAR (100) NULL ,      
  COSTCODE SMALLINT NULL,      
  BANKCOST SMALLINT NULL,      
  LNO SMALLINT NOT NULL DEFAULT(0),      
  BANKNAME VARCHAR(100) NULL,      
  MICRNO INT NULL,      
  BOOKTYPE VARCHAR(2) NULL,      
 ) ON [PRIMARY]      
  
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "      
EXEC (@@SQL)      
      
IF @@ERROR <> 0      
 BEGIN      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRANSACTION      
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'      
  RETURN      
 END      
INSERT INTO      
 V2_UPLOADED_FILES      
SELECT      
 @FNAME,      
 @FNAME,      
 CNT = COUNT(1),      
 'B',      
 GETDATE(),      
 @UNAME,      
 'RECEIPT/PAYMENT UPLOAD'      
      
INSERT INTO      
 #RECPAY_TABLE      
 (      
  SERIAL_NO,      
  EDATE,      
  VOUCHER_DATE,      
  CLIENT_CODE,      
  AMOUNT,      
  DRCR,      
  NARRATION,      
  BANK_CODE,      
  BANK_NAME,      
  REF_NO,      
  BRANCHCODE,      
  BRANCH_NAME,      
  CHQ_MODE,      
  CHQ_DATE,      
  CHQ_NAME,      
  CL_MODE      
 )      
SELECT      
 SERIAL_NO,      
 EDATE,      
 VOUCHER_DATE,      
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),      
 AMOUNT,      
 UPPER(LTRIM(RTRIM(DRCR))),      
 NARRATION,      
 UPPER(LTRIM(RTRIM(BANK_CODE))),      
 UPPER(LTRIM(RTRIM(BANK_NAME))),      
 REF_NO,      
 UPPER(LTRIM(RTRIM(BRANCHCODE))),      
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),      
 UPPER(LTRIM(RTRIM(CHQ_MODE))),      
 CHQ_DATE,      
 CHQ_NAME,      
 CL_MODE      
FROM      
 #RECPAY_TABLE_TMP      
      
UPDATE      
 #RECPAY_TABLE      
SET      
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),      
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),      
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))      
      
      
SELECT      
 @@ERROR_COUNT = COUNT(DISTINCT VDT)      
FROM      
 #RECPAY_TABLE      
      
IF @@ERROR_COUNT > 1      
 BEGIN      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRANSACTION      
  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'      
  RETURN      
 END      
      
SELECT TOP 1      
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)      
FROM      
 #RECPAY_TABLE      
      
SELECT      
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),      
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),      
 @@BRANCHFLAG = BRANCHFLAG,      
 @@VNOFLAG = VNOFLAG      
FROM      
 PARAMETER      
WHERE      
 @@VDT BETWEEN SDTCUR AND LDTCUR      
      
IF @@BRANCHFLAG = 1      
 BEGIN      
  UPDATE      
   #RECPAY_TABLE      
  SET      
   BRANCHCODE = A.BRANCHCODE,      
   FYSTART = P.SDTCUR,      
   FYEND = P.LDTCUR,      
   UPDFLAG = 'Y',      
   ACNAME = A.LONGNAME,      
   COSTCODE = C.COSTCODE,      
   BANKNAME = B.LONGNAME,      
   BOOKTYPE = B.BOOKTYPE,      
   MICRNO = ISNULL(B.MICRNO, 0)      
  FROM      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B      
  WHERE      
   A.CLTCODE = CLIENT_CODE      
   AND B.CLTCODE = BANK_CODE      
   AND P.CURYEAR = 1      
   AND A.ACCAT IN ('3','4')      
   AND B.ACCAT = '2'      
   AND A.BRANCHCODE = COSTNAME      
        
  UPDATE      
   #RECPAY_TABLE      
  SET      
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),      
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),      
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),      
   FYSTART = P.SDTCUR,      
   FYEND = P.LDTCUR,      
   UPDFLAG = 'Y',      
   ACNAME = A.LONGNAME,      
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,      
   BANKNAME = B.LONGNAME,      
   BOOKTYPE = B.BOOKTYPE,      
   MICRNO = ISNULL(B.MICRNO, 0)      
  FROM      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B      
  WHERE      
   A.CLTCODE = CLIENT_CODE      
   AND B.CLTCODE = BANK_CODE      
   AND P.CURYEAR = 1      
   AND A.ACCAT IN ('3','4')      
   AND B.ACCAT = '2'      
   AND A.BRANCHCODE = 'ALL'      
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'      
      
  UPDATE      
   #RECPAY_TABLE      
  SET      
   BRANCHCODE = 'HO',      
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),      
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),      
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),      
   FYSTART = P.SDTCUR,      
   FYEND = P.LDTCUR,      
   UPDFLAG = 'Y',      
   ACNAME = A.LONGNAME,      
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,     
   BANKNAME = B.LONGNAME,      
   BOOKTYPE = B.BOOKTYPE,      
   MICRNO = ISNULL(B.MICRNO, 0)      
  FROM      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B      
  WHERE      
   A.CLTCODE = CLIENT_CODE      
   AND B.CLTCODE = BANK_CODE      
   AND P.CURYEAR = 1      
   AND A.ACCAT IN ('3','4')      
   AND B.ACCAT = '2'      
   AND A.BRANCHCODE = 'ALL'      
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'      
 END      
ELSE      
 BEGIN      
  UPDATE      
   #RECPAY_TABLE      
  SET      
   FYSTART = @@STD_DATE,      
   FYEND = @@LST_DATE + ' 23:59:59',      
   UPDFLAG = 'Y',      
   ACNAME = A.LONGNAME,      
   BANKNAME = B.LONGNAME,      
   BOOKTYPE = B.BOOKTYPE,      
   MICRNO = ISNULL(B.MICRNO, 0)      
  FROM      
   ACMAST A, ACMAST B      
  WHERE      
   A.CLTCODE = CLIENT_CODE      
   AND B.CLTCODE = BANK_CODE      
   AND A.ACCAT IN ('3','4')      
   AND B.ACCAT = '2'      
 END      
     

  /*---------------------------------------change by suresh to stop future dated upload --------  */     
    
    
 SELECT            
  @@ERROR_COUNT = COUNT(DISTINCT VDT)            
 FROM    
     
  #RECPAY_TABLE where vdt > getdate()+2 
IF @@ERROR_COUNT >= 1            
  BEGIN            
   SELECT            
    'VOUCHER DATE SHOULD BE CURRENT DATE', 'NA', 'NA'            
   DROP TABLE #RECPAY_TABLE_TMP            
   DROP TABLE #RECPAY_TABLE            
   ROLLBACK TRAN            
   DELETE            
   FROM            
    V2_UPLOADED_FILES            
   WHERE            
    U_FILENAME = @FNAME            
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
   RETURN            
  END            
    
    
          
           
   /* ---------------------------------------change by suresh to stop future dated upload -------- */        
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */      
      
 SELECT      
  @@ERROR_COUNT = COUNT(DISTINCT VDT)      
 FROM      
  #RECPAY_TABLE      
 IF @@ERROR_COUNT > 1      
  BEGIN      
   SELECT      
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'      
   DROP TABLE #RECPAY_TABLE_TMP      
   DROP TABLE #RECPAY_TABLE      
   ROLLBACK TRAN      
   DELETE      
   FROM      
    V2_UPLOADED_FILES      
   WHERE      
    U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
   RETURN      
  END      
 SELECT @@ERROR_COUNT = 0      
/*--------------------------VALIDATION FOR DIFFERENT VDTs IN SAME VOUCHER ------------------------*/      
/*      
SELECT @@ERROR_COUNT = COUNT(VDT) FROM  #RECPAY_TABLE WHERE SERIAL_NO IN (SELECT DISTINCT SERIAL_NO FROM #RECPAY_TABLE)      
GROUP BY SERIAL_NO, VDT HAVING COUNT(VDT) > 1      
 IF @@ERROR_COUNT > 0      
  BEGIN      
   SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES ', 'NA', 'NA'      
   DROP TABLE #RecPay_Table_Tmp      
   DROP TABLE #RecPay_Table      
   ROLLBACK TRAN      
   DELETE FROM V2_Uploaded_Files      
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
   RETURN      
  END*/      
      
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */      
 SELECT      
  @@ERROR_COUNT = COUNT(1)      
 FROM      
  (      
   SELECT      
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),      
    SERIAL_NO      
   FROM      
    #RECPAY_TABLE      
   GROUP BY      
    SERIAL_NO      
   HAVING      
    COUNT(DISTINCT BANK_CODE) > 1      
  ) A      
 IF @@ERROR_COUNT > 0      
  BEGIN      
   SELECT      
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'      
   UNION ALL      
   SELECT      
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))      
   FROM      
    #RECPAY_TABLE      
   GROUP BY      
    SERIAL_NO      
   HAVING      
    COUNT(DISTINCT BANK_CODE) > 1      
      
   DROP TABLE #RECPAY_TABLE_TMP      
   DROP TABLE #RECPAY_TABLE      
   ROLLBACK TRAN      
   DELETE      
   FROM      
    V2_UPLOADED_FILES      
   WHERE      
    U_FILENAME = @FNAME      
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
   RETURN      
  END      
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */      
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
 SELECT DISTINCT      
  DRCR      
 FROM      
  #RECPAY_TABLE      
 ) A      
IF @@ERROR_COUNT > 1      
 BEGIN      
  SELECT      
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRAN      
  DELETE      
  FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
ELSE      
 BEGIN      
  SELECT TOP 1      
   @@DRCR = DRCR,      
   @@VTYP =      
    (      
    CASE      
     WHEN DRCR = 'D'      
     THEN 3      
     ELSE 2      
    END      
    )      
  FROM      
   #RECPAY_TABLE      
  UPDATE      
   #RECPAY_TABLE      
  SET VTYP =      
 (      
    CASE      
     WHEN DRCR = 'D'      
     THEN 3      
     ELSE 2      
    END      
   )      
 END      
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/      
 SELECT @@ERROR_COUNT = COUNT(1)      
 FROM #RECPAY_TABLE      
 WHERE VDT > EDT      
            IF @@ERROR_COUNT > 0      
             BEGIN      
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'      
     DROP TABLE #RECPAY_TABLE_TMP      
     DROP TABLE #RECPAY_TABLE      
     ROLLBACK TRAN      
     DELETE FROM      
      V2_UPLOADED_FILES      
     WHERE      
      U_FILENAME = @FNAME      
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
     RETURN      
             END      
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/      
 SELECT @@ERROR_COUNT = COUNT(1)      
 FROM #RECPAY_TABLE      
 WHERE AMOUNT <= 0      
 IF @@ERROR_COUNT > 0      
  BEGIN      
              SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'      
     DROP TABLE #RECPAY_TABLE_TMP      
     DROP TABLE #RECPAY_TABLE      
     ROLLBACK TRAN      
     DELETE FROM      
      V2_UPLOADED_FILES      
     WHERE      
      U_FILENAME = @FNAME      
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
     RETURN      
  END      
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */      
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT DISTINCT      
   DDNO  = RP.REF_NO      
  FROM      
   #RECPAY_TABLE RP,      
   LEDGER1 L1      
    WITH(NOLOCK)      
  WHERE      
   L1.DDNO = RP.REF_NO      
   AND L1.BNKNAME = RP.BANK_NAME    
   AND L1.DD = RP.CHQ_MODE      
   AND L1.DRCR = @@DRCR      
   AND L1.VTYP = @@VTYP      
   AND RP.REF_NO <> '0'  
 ) A      
IF @@ERROR_COUNT > 0      
 BEGIN      
  SELECT      
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'      
  UNION ALL      
  SELECT DISTINCT      
   RP.REF_NO, 'NA','NA'      
  FROM      
   #RECPAY_TABLE RP,      
   LEDGER1 L1      
    WITH(NOLOCK)      
  WHERE      
   L1.DDNO = RP.REF_NO      
   AND L1.BNKNAME = RP.BANK_NAME    
   AND L1.DD = RP.CHQ_MODE      
   AND L1.DRCR = @@DRCR      
   AND L1.VTYP = @@VTYP      
   AND RP.CHQ_MODE <> 'N'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRAN      
  DELETE FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/      
SELECT      
 @@ERROR_COUNT = COUNT(1)      
FROM      
 (      
  SELECT DISTINCT      
   CLIENT_CODE      
  FROM      
   #RECPAY_TABLE      
  WHERE      
   UPDFLAG = 'N'      
 ) A      
IF @@ERROR_COUNT > 0      
 BEGIN      
  SELECT      
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'      
  UNION ALL      
  SELECT DISTINCT      
   CLIENT_CODE, 'NA','NA'      
  FROM      
   #RECPAY_TABLE      
  WHERE      
   UPDFLAG = 'N'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRAN      
  DELETE FROM      
   V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
  /*    --------------------------AUTO GENERATION OF VNO ------------------------ */      
  SET @@VNOCUR = CURSOR FOR      
   SELECT DISTINCT      
    BANK_CODE,      
    BOOKTYPE      
   FROM      
    #RECPAY_TABLE WITH(NOLOCK)      
  OPEN @@VNOCUR      
  FETCH NEXT      
   FROM      
    @@VNOCUR      
   INTO      
    @@BANK_CODE,      
    @@BOOKTYPE      
  WHILE @@FETCH_STATUS = 0      
   BEGIN      
  /*--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------*/      
    SELECT      
     @@BACKDAYS = ISNULL(MAX(NODAYS), 0)      
    FROM      
     USERWRITESTABLE      
    WHERE      
     USERCATEGORY = @USERCAT      
     AND VTYP = @@VTYP      
     AND BOOKTYPE = @@BOOKTYPE      
    SELECT      
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS      
    SELECT      
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)      
    FROM      
     #RECPAY_TABLE      
    WHERE      
     VDT < @@BACKDATE      
    
    IF @@ERROR_COUNT > 0      
     BEGIN      
      SELECT      
       'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET', 'NA','NA'      
      DROP TABLE #RECPAY_TABLE_TMP      
      DROP TABLE #RECPAY_TABLE      
      ROLLBACK TRAN      
      DELETE FROM V2_UPLOADED_FILES      
      WHERE      
       U_FILENAME = @FNAME      
       AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
      RETURN      
     END    
      
    IF @@BRANCHFLAG = 1      
     BEGIN      
      SELECT      
       @@BANKBRANCH = BRANCHCODE,      
       @@BANKCOST = ISNULL(C.COSTCODE, -1)      
      FROM      
       ACMAST A      
        LEFT OUTER JOIN      
        COSTMAST C      
        ON      
         (      
          A.BRANCHCODE = C.COSTNAME      
         )      
      WHERE      
       A.CLTCODE = @@BANK_CODE      
      IF @@BANKBRANCH <> 'ALL'      
       BEGIN      
        UPDATE      
         RP      
          SET COSTCODE = @@BANKCOST      
        FROM      
         #RECPAY_TABLE RP,      
         ACMAST A      
        WHERE      
         A.CLTCODE = RP.CLIENT_CODE      
         AND A.BRANCHCODE = 'ALL'      
        UPDATE      
         #RECPAY_TABLE      
          SET BANKCOST = @@BANKCOST      
        WHERE      
         BANK_CODE = @@BANK_CODE      
       END      
      ELSE      
       BEGIN      
        UPDATE      
         #RECPAY_TABLE      
          SET COSTCODE =      
           (      
            SELECT TOP 1      
             COSTCODE      
            FROM      
             COSTMAST      
            WHERE      
             COSTNAME = 'HO'      
           )      
        WHERE      
         COSTCODE = ''      
         AND BANK_CODE = @@BANK_CODE      
                            SET @@COSTCODEUPDATES = CURSOR FOR      
                                       SELECT      
                                             SERIAL_NO, COUNT(DISTINCT COSTCODE)      
                                       FROM      
                                             #RECPAY_TABLE WITH(NOLOCK)      
                                       WHERE      
          BANK_CODE = @@BANK_CODE      
                                       GROUP BY      
                                             SERIAL_NO      
                                       HAVING COUNT(DISTINCT COSTCODE)  > 1      
                            OPEN @@COSTCODEUPDATES      
                            FETCH NEXT      
                             FROM      
                              @@COSTCODEUPDATES      
                             INTO      
                              @@SERIAL_NO,      
                              @@COSTCODECOUNT      
                            WHILE @@FETCH_STATUS = 0      
                             BEGIN      
          UPDATE      
           #RECPAY_TABLE      
            SET BANKCOST =      
             (      
              SELECT TOP 1      
               COSTCODE      
              FROM      
               COSTMAST      
              WHERE      
               COSTNAME = 'HO'      
             )      
          WHERE      
           (BANKCOST = ''   OR BANKCOST IS NULL)      
           AND BANK_CODE = @@BANK_CODE      
                                           AND SERIAL_NO = @@SERIAL_NO      
                              FETCH NEXT      
                               FROM      
                                @@COSTCODEUPDATES      
                               INTO      
                                @@SERIAL_NO,      
                                @@COSTCODECOUNT      
                             END      
                            CLOSE @@COSTCODEUPDATES      
                            DEALLOCATE @@COSTCODEUPDATES      
                  UPDATE      
                   #RECPAY_TABLE      
                    SET BANKCOST = COSTCODE      
                  WHERE      
                   BANK_CODE = @@BANK_CODE      
                                        AND (BANKCOST = ''   OR BANKCOST IS NULL)      
       END      
     END      
    CREATE TABLE      
     #BANK_VNO      
     (      
      SRNO INT,      
      NEWSRNO INT IDENTITY (1, 1)      
     )      
    INSERT INTO      
     #BANK_VNO      
    SELECT      
     DISTINCT SERIAL_NO      
    FROM      
     #RECPAY_TABLE      
    WHERE      
     BANK_CODE = @@BANK_CODE      
     AND BOOKTYPE = @@BOOKTYPE      
      
    SELECT      
     @@MAXCOUNT = COUNT(DISTINCT SNO)      
    FROM      
     #RECPAY_TABLE      
      
    SELECT TOP 1      
     @@VDT = VDT      
    FROM      
     #RECPAY_TABLE      
    SELECT      
     LASTVNO      
    INTO #VNO      
    FROM      
     LASTVNO      
    WHERE      
     1 = 2      
    SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO      
    INSERT      
    INTO #VNO      
     EXEC ACC_GENVNO_NEW      
      @@VDT,      
      @@VTYP,      
      @@BOOKTYPE,      
      @@STD_DATE,      
      @@LST_DATE,      
      @@MAXVNO      
    SELECT      
     @@NEWVNO = LASTVNO      
    FROM      
     #VNO      
    UPDATE      
     RP      
      SET VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))      
    FROM      
     #RECPAY_TABLE RP,      
     #BANK_VNO BV      
    WHERE      
     RP.SERIAL_NO = BV.SRNO      
   DROP TABLE #VNO      
   DROP TABLE #BANK_VNO      
  FETCH NEXT      
   FROM @@VNOCUR      
   INTO      
    @@BANK_CODE,      
    @@BOOKTYPE      
 END      
/*   --------------------------AUTO GENERATION OF LNO ------------------------ */      
UPDATE      
 #RECPAY_TABLE      
  SET LNO = 2      
WHERE      
 VNO IN      
  (      
   SELECT      
    VNO      
   FROM      
    #RECPAY_TABLE      
     WITH(NOLOCK)      
   GROUP BY      
    VNO      
   HAVING      
    COUNT(*) = 1      
  )      
SET @@LNOCUR = CURSOR FOR      
 SELECT      
  VNO      
 FROM      
  #RECPAY_TABLE      
   WITH(NOLOCK)      
 GROUP BY      
  VNO      
 HAVING      
  COUNT(*) > 1      
OPEN @@LNOCUR      
FETCH NEXT      
 FROM      
  @@LNOCUR      
 INTO      
  @@LNOVNO      
WHILE @@FETCH_STATUS = 0      
 BEGIN      
  CREATE TABLE      
   [#LNOGEN]      
    (      
     VNO VARCHAR(12),      
     SNO INT,      
     LNO INT IDENTITY(1,1)      
    )      
  INSERT INTO      
   #LNOGEN      
    SELECT      
     VNO,      
     SNO      
    FROM      
     #RECPAY_TABLE      
      WITH(NOLOCK)      
    WHERE      
     VNO = @@LNOVNO      
    ORDER BY      
     SNO      
  UPDATE      
   #RECPAY_TABLE      
    SET LNO = L.LNO + 1      
  FROM      
   #LNOGEN L      
  WHERE      
   #RECPAY_TABLE.VNO = L.VNO      
   AND #RECPAY_TABLE.SNO = L.SNO      
   AND #RECPAY_TABLE.LNO = 0      
  DROP TABLE #LNOGEN      
  FETCH NEXT      
   FROM      
    @@LNOCUR      
   INTO      
    @@LNOVNO      
 END      
CLOSE @@LNOCUR      
DEALLOCATE @@LNOCUR      
/* --------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------ */      
INSERT INTO      
 LEDGER1      
  (      
   BNKNAME,      
   BRNNAME,      
   DD,      
   DDNO,      
   DDDT,      
   RELDT,      
   RELAMT,      
   REFNO,      
   RECEIPTNO,      
   VTYP,      
   VNO,      
   LNO,      
   DRCR,      
   BOOKTYPE,      
   MICRNO,      
   SLIPNO,      
   SLIPDATE,      
   CHEQUEINNAME,      
   CHQPRINTED,      
   CLEAR_MODE      
  )      
SELECT      
 BNKNAME = MAX(BANK_NAME),      
 BRNNAME = MAX(BRANCH_NAME),      
 DD = MAX(CHQ_MODE),      
 DDNO = MAX(REF_NO),      
 DDDT = MAX(DDDT),      
 RELDT = '',      
 RELAMT = SUM(AMOUNT),      
 REFNO = 0,      
 RECEIPTNO = 0,      
 VTYP,      
 VNO,      
 LNO = 2,      
 DRCR,      
 BOOKTYPE = BOOKTYPE,      
 MICRNO = MAX(MICRNO),      
 SLIPNO = 0,      
 SLIPDATE = '',      
 CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),      
 CHQPRINTED = 0,      
 CLEAR_MODE = MAX(CL_MODE)      
FROM      
 #RECPAY_TABLE      
GROUP BY      
 VTYP,      
 VNO,      
 DRCR,      
 BOOKTYPE      
      
IF @@ERROR <> 0      
 BEGIN      
  SELECT      
   'DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  ROLLBACK TRAN      
  DELETE FROM V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
      
/*================================      
CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK      
=================================*/      
CREATE TABLE #LEDGER      
(      
 VTYP SMALLINT,      
 VNO VARCHAR(12),      
 EDT DATETIME,      
 LNO SMALLINT,      
 ACNAME VARCHAR(100),      
 DRCR VARCHAR(1),      
 VAMT MONEY,      
 VDT DATETIME,      
 VNO1 VARCHAR(12),      
 REFNO CHAR(12),      
 BALAMT MONEY,      
 NODAYS INT,      
 CDT DATETIME,      
 CLTCODE VARCHAR(10),      
 BOOKTYPE VARCHAR(2),      
 ENTEREDBY VARCHAR(25),      
 PDT DATETIME,      
 CHECKEDBY VARCHAR(25),      
 ACTNODAYS INT,      
 NARRATION VARCHAR(234)      
)      
--SELECT VTYP, VNO,  EDT, LNO, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION INTO #LEDGER FROM LEDGER WHERE 1 = 0      
CREATE TABLE #LEDGER3      
(      
 NARATNO INT,      
 NARR VARCHAR(234),      
 REFNO CHAR(12),      
 VTYP SMALLINT,      
 VNO VARCHAR(12),      
 BOOKTYPE VARCHAR(2)      
)      
--SELECT * INTO #LEDGER3 FROM LEDGER3 WHERE 1 = 0      
/*==============================      
CLIENT SIDE RECORD      
==============================*/      
INSERT INTO      
 #LEDGER      
 (      
  VTYP,      
  VNO,      
  EDT,      
  LNO,      
  ACNAME,      
  DRCR,      
  VAMT,      
  VDT,      
  VNO1,      
  REFNO,      
  BALAMT,      
  NODAYS,      
  CDT,      
  CLTCODE,      
  BOOKTYPE,      
  ENTEREDBY,      
  PDT,      
  CHECKEDBY,      
  ACTNODAYS,      
  NARRATION      
 )      
SELECT      
 VTYP,      
 VNO,      
 EDT = EDT,      
 LNO,      
 ACNAME,      
 DRCR,      
 VAMT = AMOUNT,      
 VDT,      
 VNO1 = VNO,      
 REFNO = 0,      
 BALAMT = AMOUNT,      
 NODAYS = 0,      
 CDT = GETDATE(),      
 CLTCODE = CLIENT_CODE,      
 BOOKTYPE = BOOKTYPE,      
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),      
 PDT = GETDATE(),      
 CHECKEDBY = @UNAME,      
 ACTNODAYS = 0,      
 NARRATION      
FROM      
 #RECPAY_TABLE      
/*==============================      
BANK SIDE RECORD      
==============================*/      
INSERT INTO      
 #LEDGER      
SELECT      
 VTYP,      
 VNO,      
 EDT = EDT,      
 LNO = 1,      
 BANKNAME,      
 DRCR =      
  (      
   CASE      
    WHEN DRCR = 'D'      
    THEN 'C'      
    ELSE 'D'      
   END      
  ),      
 VAMT = SUM(AMOUNT),      
 VDT,      
 VNO1 = VNO,      
 REFNO = 0,      
 BALAMT = SUM(AMOUNT),      
 NODAYS = 0,      
 CDT = GETDATE(),      
 CLTCODE = BANK_CODE,      
 BOOKTYPE = BOOKTYPE,      
 ENTEREDBY = 'B_' + LEFT(@UNAME, 23),      
 PDT = GETDATE(),      
 CHECKEDBY = @UNAME,      
 ACTNODAYS = 0,      
 NARRATION = MAX(NARRATION)      
FROM      
 #RECPAY_TABLE      
GROUP BY      
 VTYP,      
 VNO,      
 EDT,      
 DRCR,      
 VDT,      
 BANK_CODE,      
 BOOKTYPE,      
 BANKNAME      
/*==============================      
INSERTING ALL LEDGER RECORDS AT ONE TIME      
==============================*/      
INSERT INTO LEDGER      
SELECT      
 *      
FROM      
 #LEDGER      
ORDER BY      
 BOOKTYPE,      
 VTYP,      
 VNO,      
 LNO      
      
IF @@ERROR <> 0      
 BEGIN      
  SELECT      
   'DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  DROP TABLE #LEDGER      
  DROP TABLE #LEDGER3      
  ROLLBACK TRAN      
  DELETE FROM V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
DROP TABLE #LEDGER      
/*==============================      
BANK SIDE RECORD      
==============================*/      
INSERT INTO      
 #LEDGER3      
SELECT      
 NARATNO = 1,      
 NARRATION = MAX(NARRATION),      
 REFNO = 0,      
 VTYP,      
 VNO,      
 BOOKTYPE      
FROM      
 #RECPAY_TABLE      
GROUP BY      
 VTYP,      
 VNO,      
 BOOKTYPE      
/*==============================      
CLIENT SIDE RECORD      
==============================*/      
INSERT INTO      
 #LEDGER3      
SELECT      
 NARATNO = LNO,      
 NARR = NARRATION,      
 REFNO = 0,      
 VTYP,      
 VNO,      
 BOOKTYPE      
FROM      
 #RECPAY_TABLE      
      
      
/*==============================      
INSERTING ALL LEDGER3 RECORDS AT ONE TIME      
==============================*/      
INSERT INTO LEDGER3      
SELECT      
 *      
FROM      
 #LEDGER3      
ORDER BY      
 BOOKTYPE,      
 VTYP,      
 VNO,      
 NARATNO      
      
IF @@ERROR <> 0      
 BEGIN      
  SELECT      
   'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'      
  DROP TABLE #RECPAY_TABLE_TMP      
  DROP TABLE #RECPAY_TABLE      
  DROP TABLE #LEDGER3      
  ROLLBACK TRAN      
  DELETE FROM V2_UPLOADED_FILES      
  WHERE      
   U_FILENAME = @FNAME      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'      
  RETURN      
 END      
DROP TABLE #LEDGER3      
      
      
IF @@BRANCHFLAG = 1      
 BEGIN      
  SET @@L2CUR = CURSOR FOR      
   SELECT DISTINCT      
    VNO      
   FROM      
    #RECPAY_TABLE      
   ORDER BY      
    VNO      
  OPEN @@L2CUR      
   FETCH NEXT      
   FROM      
  @@L2CUR      
   INTO      
    @@L2VNO      
  WHILE @@FETCH_STATUS = 0      
   BEGIN      
    DELETE FROM      
     TEMPLEDGER2      
    WHERE      
     SESSIONID = '9999999999'      
/*==============================      
CLIENT SIDE RECORD      
==============================*/      
    INSERT INTO      
     TEMPLEDGER2      
    SELECT      
     'BRANCH',      
     C.COSTNAME,      
     AMOUNT,      
     VTYP,      
     VNO,      
     LNO,      
     DRCR,      
     '0',      
     BOOKTYPE,      
     '9999999999',      
     CLIENT_CODE,      
     'A',      
     '0'      
    FROM      
     #RECPAY_TABLE RP,      
     COSTMAST C      
    WHERE      
     RP.COSTCODE = C.COSTCODE      
     AND VNO = @@L2VNO      
/*==============================      
BANK SIDE RECORD      
==============================*/      
    INSERT INTO      
     TEMPLEDGER2      
    SELECT      
     'BRANCH',      
     C.COSTNAME,      
     SUM(AMOUNT),      
     VTYP,      
     VNO,      
     LNO = 1,      
     DRCR =      
      (      
       CASE      
       WHEN DRCR = 'D'      
       THEN 'C'      
       ELSE 'D'      
       END      
      ),      
     '0',      
     BOOKTYPE,      
     '9999999999',      
     BANK_CODE,      
     'A',      
     '0'      
    FROM      
     #RECPAY_TABLE RP,      
     COSTMAST C      
    WHERE      
     RP.BANKCOST = C.COSTCODE      
     AND VNO = @@L2VNO      
    GROUP BY      
     C.COSTNAME,      
     VTYP,      
     VNO,      
      (      
       CASE      
       WHEN DRCR = 'D'      
       THEN 'C'      
       ELSE 'D'      
       END      
      ),      
     BANK_CODE,      
     BOOKTYPE      
    EXEC INSERTTOLEDGER2   
     '9999999999',      
     @@L2VNO,      
     '1',      
     '1',      
     '1',      
     'BROKER',      
     'BROKER'      
    FETCH NEXT      
     FROM      
      @@L2CUR      
     INTO      
      @@L2VNO      
   END      
  DELETE FROM      
   TEMPLEDGER2      
  WHERE      
   SESSIONID = '9999999999'      
  COMMIT TRAN      
 END      
SELECT 'CLTCODE, AMOUNT, VNO' Union ALL      
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + VNO As RESULT FROM #RECPAY_TABLE      
DROP TABLE #RECPAY_TABLE_TMP      
DROP TABLE #RECPAY_TABLE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RENUMVCH_DAILY
-- --------------------------------------------------
CREATE PROC RENUMVCH_DAILY      
--BEGIN TRAN      
--RENUMVCH_DAILY 2, '01'      
--COMMIT TRAN      
--ROLLBACK TRAN      
@VTYP SMALLINT,      
@BOOKTYPE VARCHAR(2)      
AS      
DECLARE      
@@OVNO AS VARCHAR(12),      
@@EXIST AS NUMERIC(10),      
@@LEXIST AS VARCHAR(12),      
@@VNO AS VARCHAR(12),      
@@VTYPE AS SMALLINT,      
@@BTYPE AS VARCHAR(2),    
@@VAMT AS MONEY,      
@@VDT AS VARCHAR(11),      
@@VDT1 AS DATETIME,      
@@LASTVNOEXIST VARCHAR(12),      
@@MAINREC AS CURSOR      
SET NOCOUNT ON      
     
      
SET @@MAINREC = CURSOR FOR      
SELECT DISTINCT VNO,VTYP,BOOKTYPE,CONVERT(VARCHAR(11),VDT,109)     
FROM   LEDGER L WITH(NOLOCK)        
WHERE    
VTYP = @VTYP        
AND BOOKTYPE = @BOOKTYPE  
AND EXISTS (SELECT   VNO        
FROM     LEDGER L1 WITH(NOLOCK)         
WHERE    L.VNO=L1.VNO    
     AND L.VTYP=L1.VTYP AND L.BOOKTYPE=L1.BOOKTYPE AND     
  L1.LNO = 2        
     AND L1.VTYP = @VTYP  
  AND L1.BOOKTYPE = @BOOKTYPE  
GROUP BY L1.VNO,L1.VTYP,L1.BOOKTYPE        
HAVING   COUNT(1) > 1)   
ORDER BY VNO    
    
    
OPEN @@MAINREC      
 FETCH NEXT FROM @@MAINREC INTO @@VNO, @@VTYPE, @@BTYPE, @@VDT    
WHILE @@FETCH_STATUS = 0      
 BEGIN  
      SELECT @@VAMT = VAMT FROM LEDGER WHERE VNO = @@VNO AND VTYP = @@VTYPE AND BOOKTYPE = @@BTYPE AND VDT = @@VDT      
                  SELECT @@LASTVNOEXIST = ISNULL(COUNT(LASTVNO), 0) FROM LASTVNO WHERE VDT LIKE @@VDT + '%' AND VTYP = @@VTYPE AND BOOKTYPE = @@BTYPE      
                  IF @@LASTVNOEXIST = 0       
                  BEGIN      
                        SELECT @@OVNO = (SELECT CONVERT(VARCHAR(4),YEAR(@@VDT)) + RIGHT('0'+LTRIM(CONVERT(VARCHAR,MONTH(@@VDT))),2) + RIGHT('00'+LTRIM(CONVERT(VARCHAR,DAY(@@VDT))),2)+'0001')      
                        INSERT INTO LASTVNO VALUES(@@VTYPE, @@BTYPE, @@VDT, @@OVNO)      
                  END       
                  ELSE      
                  BEGIN      
                        SELECT @@OVNO = CONVERT(VARCHAR(12), CONVERT(NUMERIC, MAX(LASTVNO)) + 1) FROM LASTVNO WHERE VDT LIKE @@VDT + '%' AND VTYP = @@VTYPE AND BOOKTYPE = @@BTYPE      
                        UPDATE LASTVNO SET LASTVNO = @@OVNO WHERE VDT LIKE @@VDT + '%' AND VTYP = @@VTYPE AND BOOKTYPE = @@BTYPE      
                  END      
                  INSERT INTO LEDGERRENUM_LOG VALUES(@@VNO, @@VTYPE, @@BTYPE, @@OVNO)      
  PRINT 'UPDATING ' + @@VNO + ', VTYPE ' + CONVERT(VARCHAR, @@VTYPE) + ', BOOKTYPE ' + @@BTYPE + ' TO ' + @@OVNO + ' DAITED ' +@@VDT      
  UPDATE LEDGER SET VNO = @@OVNO WHERE VNO = @@VNO AND VTYP = @@VTYPE AND BOOKTYPE = @@BTYPE and vamt=@@VAMT      
  UPDATE LEDGER1 SET VNO = @@OVNO WHERE VNO = @@VNO AND VTYP = @@VTYPE AND BOOKTYPE = @@BTYPE and relamt=@@VAMT      
  UPDATE LEDGER2 SET VNO = @@OVNO WHERE VNO = @@VNO AND VTYPE = @@VTYPE AND BOOKTYPE = @@BTYPE and camt=@@VAMT     
  FETCH NEXT FROM @@MAINREC INTO @@VNO, @@VTYPE, @@BTYPE, @@VDT      
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.REPORT_ACCESS_CODELIST1
-- --------------------------------------------------


---------------------------------------------------------------------------------------------------------
--  PROC TO LIST CLIENTS ACC TO LOGIN FOR THE DB - ACCOUNT
---------------------------------------------------------------------------------------------------------
CREATE PROCEDURE REPORT_ACCESS_CODELIST1
 @STATUSID VARCHAR(15), 
 @STATUSNAME VARCHAR(25), 
 @WHATTOLOOKFOR VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
 @WHICHWAY VARCHAR(1),  -- > OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.
 @COMPARETOWHAT VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.
 @ACCAT VARCHAR(3),  -- ACCOUNT CATEGORY
 @LOOKFORNAME VARCHAR(25) -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
AS
DECLARE
@STRSQL VARCHAR(2500), 
@@INACCAT VARCHAR(3)
SELECT @@INACCAT = RTRIM(CONVERT(VARCHAR, CONVERT(INT, @ACCAT)+100, 3))
--SET DEFAULT VALUES
SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"
/* SET @BOOKTYPE = @BOOKTYPE + "%" */
--BROKER LOGIN
IF  LOWER(@STATUSID) = "BROKER"
BEGIN
 SET @STRSQL = "SELECT "
 --SET @STRSQL = @STRSQL + "DISTINCT CLTCODE, ACNAME, BRANCHCODE "
 SET @STRSQL = @STRSQL + "DISTINCT CLTCODE=CLTCODE+' - '+ACNAME, BRANCHCODE "
 SET @STRSQL = @STRSQL + "FROM ACMAST "
 SET @STRSQL = @STRSQL + "WHERE "
        IF LEN(RTRIM(@WHATTOLOOKFOR)) <> 0 AND LEN(RTRIM(@LOOKFORNAME)) <> 0 
           BEGIN
    SET @STRSQL = @STRSQL + " ( CLTCODE LIKE '" + @WHATTOLOOKFOR + "' AND ACNAME LIKE '" + @LOOKFORNAME + "%') AND (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%' " 
    END
        ELSE
           IF LEN(RTRIM(@LOOKFORNAME)) <> 0 
               BEGIN
                  SET @STRSQL = @STRSQL + " ( CLTCODE LIKE '" + @WHATTOLOOKFOR + "' OR ACNAME LIKE '" + @LOOKFORNAME + "%') AND (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%' " 
               END
           ELSE
               BEGIN
                  SET @STRSQL = @STRSQL + " ( CLTCODE LIKE '" + @WHATTOLOOKFOR + "' OR ACNAME LIKE '" + @WHATTOLOOKFOR + "') AND (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%' " 
               END
        IF RTRIM(@ACCAT) = '3'
           BEGIN
  SELECT @STRSQL = @STRSQL + " OR ACCAT IN ( '14', '18', '114', '118'))" 
           END
        ELSE
           BEGIN
  SELECT @STRSQL = @STRSQL + " )" 
           END
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS 
 IF @WHICHWAY = ">"
 BEGIN
  SET @STRSQL = @STRSQL + " AND "
  SET @STRSQL = @STRSQL + " CLTCODE > = '" + @COMPARETOWHAT + "' "
 END
 ELSE
 BEGIN
  IF @WHICHWAY = "<"
  BEGIN
   SET @STRSQL = @STRSQL + " AND "
   SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
  END
 END
 SET @STRSQL = @STRSQL + "ORDER BY CLTCODE, BRANCHCODE "
END
--BRANCH LOGIN
IF LOWER(@STATUSID) = "BRANCH"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " CLTCODE = CLTCODE+' - '+ACNAME, "
-- SET @STRSQL = @STRSQL + " ACNAME, "
 SET @STRSQL = @STRSQL + " BRANCHCODE "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " (BRANCHCODE LIKE '" + @STATUSNAME + "' OR BRANCHCODE = 'ALL') AND (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%' " 
        IF RTRIM(@ACCAT) = '3'
           BEGIN
  SELECT @STRSQL = @STRSQL + " OR ACCAT IN ( '14', '18', '114', '118'))" 
           END
        ELSE
           BEGIN
  SELECT @STRSQL = @STRSQL + " )" 
           END
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
 IF @WHICHWAY = ">"
 BEGIN
  SET @STRSQL = @STRSQL + " AND "
  SET @STRSQL = @STRSQL + " CLTCODE > = '" + @COMPARETOWHAT + "' "
 END
 ELSE
 BEGIN
  IF @WHICHWAY = "<"
  BEGIN
   SET @STRSQL = @STRSQL + " AND "
   SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
  END
 END
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " CLTCODE, "
 SET @STRSQL = @STRSQL + " BRANCHCODE "
END
--SUB-BROKER LOGIN
IF LOWER(@STATUSID) = "SUBBROKER"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " CLTCODE = A.CLTCODE+' - '+A.ACNAME, "
-- SET @STRSQL = @STRSQL + " A.ACNAME, "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.SUBBROKERS S "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER = S.SUB_BROKER AND "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @WHATTOLOOKFOR + "' "
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
 IF @WHICHWAY = ">"
 BEGIN
  SET @STRSQL = @STRSQL + " AND "
  SET @STRSQL = @STRSQL + " CLTCODE > = '" + @COMPARETOWHAT + "' "
 END
 ELSE
 BEGIN
  IF @WHICHWAY = "<"
  BEGIN
   SET @STRSQL = @STRSQL + " AND "
   SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
  END
 END
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER "
END
--TRADER LOGIN
IF LOWER(@STATUSID) = "TRADER"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " CLTCODE = A.CLTCODE+' - '+A.ACNAME, "
-- SET @STRSQL = @STRSQL + " A.ACNAME, "
 SET @STRSQL = @STRSQL + " C1.TRADER "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.BRANCHES S "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 /*SET @STRSQL = @STRSQL + " C1.TRADER = S.BRANCH_CD AND "*/
             SET @STRSQL = @STRSQL + " C1.BRANCH_CD = S.BRANCH_CD AND "
 SET @STRSQL = @STRSQL + " C1.TRADER LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @WHATTOLOOKFOR + "' "
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
 IF @WHICHWAY = ">"
 BEGIN
  SET @STRSQL = @STRSQL + " AND "
  SET @STRSQL = @STRSQL + " CLTCODE > = '" + @COMPARETOWHAT + "' "
 END
 ELSE
 BEGIN
  IF @WHICHWAY = "<"
  BEGIN
   SET @STRSQL = @STRSQL + " AND "
   SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
  END
 END
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " C1.TRADER "
END
--FAMILY LOGIN
IF LOWER(@STATUSID) = "FAMILY"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " CLTCODE = A.CLTCODE+' - '+A.ACNAME, "
-- SET @STRSQL = @STRSQL + " A.ACNAME, "
 SET @STRSQL = @STRSQL + " C1.FAMILY "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " C1.FAMILY LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @WHATTOLOOKFOR + "' "
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
 IF @WHICHWAY = ">"
 BEGIN
  SET @STRSQL = @STRSQL + " AND "
  SET @STRSQL = @STRSQL + " CLTCODE > = '" + @COMPARETOWHAT + "' "
 END
 ELSE
 BEGIN
  IF @WHICHWAY = "<"
  BEGIN
   SET @STRSQL = @STRSQL + " AND "
   SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
  END
 END
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " C1.FAMILY "
END
IF LOWER(@STATUSID) = "CLIENT"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " CLTCODE = A.CLTCODE+' - '+A.ACNAME, "
-- SET @STRSQL = @STRSQL + " A.ACNAME "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @STATUSNAME + "' "
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE "
END
IF LOWER(@STATUSID) = "REGION"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " CLTCODE = A.CLTCODE+' - '+A.ACNAME, "
-- SET @STRSQL = @STRSQL + " A.ACNAME "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " C1.REGION LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @WHATTOLOOKFOR + "' "
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
 IF @WHICHWAY = ">"
 BEGIN
  SET @STRSQL = @STRSQL + " AND "
  SET @STRSQL = @STRSQL + " CLTCODE > = '" + @COMPARETOWHAT + "' "
 END
 ELSE
 BEGIN
  IF @WHICHWAY = "<"
  BEGIN
   SET @STRSQL = @STRSQL + " AND "
   SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
  END
 END
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE "
END
IF LOWER(@STATUSID) = "AREA"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " CLTCODE = A.CLTCODE+' - '+A.ACNAME, "
-- SET @STRSQL = @STRSQL + " A.ACNAME "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " C1.AREA LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @WHATTOLOOKFOR + "' "
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
 IF @WHICHWAY = ">"
 BEGIN
  SET @STRSQL = @STRSQL + " AND "
  SET @STRSQL = @STRSQL + " CLTCODE > = '" + @COMPARETOWHAT + "' "
 END
 ELSE
 BEGIN
  IF @WHICHWAY = "<"
  BEGIN
   SET @STRSQL = @STRSQL + " AND "
   SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
  END
 END
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE "
END
 SET @STRSQL = @STRSQL + " OPTION  (FAST 10)"
PRINT @STRSQL
EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RepostLedger2
-- --------------------------------------------------
  
CREATE Proc RepostLedger2            
@vtyp smallint            
            
As            
Declare            
 @@Vno As Varchar(12),            
 @@Data As Cursor            
            
Set @@Data = Cursor For            
select distinct vno from ledger where vno not in(select vno from ledger2 where vtype = @vtyp)          
and vtyp = @vtyp          
          
Open @@Data            
Fetch Next From @@Data Into @@VNO            
Set NoCount ON            
While @@Fetch_Status = 0            
 Begin            
  Delete From TempLedger2 Where SessionId = '9999999999'            
  Insert Into TempLedger2            
  Select 'BRANCH', a.BRANCHCODE ,            
    L.VAmt, L.Vtyp, L.Vno, L.Lno, L.DrCr, '0', L.BookType, '9999999999',            
    L.CltCode, 'A', 0            
   From            
    Ledger L, AcMast A            
   Where            
    L.Cltcode = A.CltCode            
    And L.Vno = @@Vno And L.Vtyp = @vtyp And L.BookType = '01'            
          
  Exec InsertToLedger2 '9999999999', @@VNO, 1, 1, '', 'BROKER', 'BROKER'            
          
  Print 'Updated Voucher No. ' + @@VNO            
  Fetch Next From @@Data Into @@VNO            
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RepostLedger2_vin
-- --------------------------------------------------
/*BEGIN TRAN      
exec RepostLedger2_vin 16,'Apr  1 2010'    
COMMIT      
ROLLBACK      
*/      
          
/*set transaction isolation level read uncommitted              
select distinct vno from ledger where vno not in(select vno from ledger2 where vtype = 8)                     
and vtyp = 8 and vdt like 'aug 16 2008%' and vno between '208081613153' and '208081617117'*/              
CREATE Proc [dbo].[RepostLedger2_vin]          
@vtyp smallint,    
@vdt varchar(11)                        
                        
As          
Declare                        
 @@Vno As Varchar(12),                        
 @@Data As Cursor                        
                        
Set @@Data = Cursor For                        
SELECT DISTINCT VNO        
        
FROM LEDGER L WHERE VTYP NOT IN(15, 21, 18) AND NOT EXISTS(        
        
SELECT VNO FROM LEDGER2 L2 WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE)        
AND VTYP = @vtyp       
and vdt >= @vdt 
                      
Open @@Data                        
Fetch Next From @@Data Into @@VNO                        
Set NoCount ON                        
While @@Fetch_Status = 0                        
 Begin                        
  Delete From TempLedger2 Where SessionId = '9999999999'                        
  Insert Into TempLedger2                        
  Select 'BRANCH', Case When A.BranchCode <> 'ALL' Then A.BranchCode Else 'HO' End,                        
    L.VAmt, L.Vtyp, L.Vno, L.Lno, L.DrCr, '0', L.BookType, '9999999999',                        
    L.CltCode, 'A', 0                        
   From                        
    Ledger L, AcMast A                        
   Where                        
    L.Cltcode = A.CltCode                        
    And L.Vno = @@Vno And L.Vtyp = @vtyp And L.BookType = '01'                        
                      
  Exec InsertToLedger2 '9999999999', @@VNO, 1, 1, '', 'BROKER', 'BROKER'                        
                      
  Print 'Updated Voucher No. ' + @@VNO                        
  Fetch Next From @@Data Into @@VNO                        
 End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RETURNCANCEL_BULK
-- --------------------------------------------------


CREATE PROC [dbo].[RETURNCANCEL_BULK] @VTYPE   SMALLINT, 
                                     @FNAME   VARCHAR(100), 
                                     @UNAME   VARCHAR(25), 
                                     @USERCAT SMALLINT 
AS 
    /*                                               
    BEGIN TRAN                                               
    SP_HELPTRIGGER LEDGER                                               
    LEDGER_TRG_BILL                                               
    LEDGER_TRG                                               
    EXEC RECPAYUPLOAD_BULK 'D:\BACKOFFICE\RECPAYFILES\SAMPLE1.CSV', 'JAYDEEP', 388                                               
    SELECT TOP 1 * FROM LEDGER3                                               
    SELECT TOP 1 * FROM LEDGER_TRG                                               
    ROLLBACK                                               
    */ 
    SET NOCOUNT ON 

    /*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE B ASED ON DRCR ------------------------*/ 
    DECLARE @@STD_DATE        VARCHAR(11), 
            @@LST_DATE        VARCHAR(11), 
            @@BRANCHFLAG      AS TINYINT, 
            @@VNOFLAG         AS TINYINT, 
            @@VNOMETHOD       INT, 
            @@ACNAME          CHAR(100), 
            @@BOOKTYPE        CHAR(2), 
            @@MICRNO          VARCHAR(10), 
            @@DRCR            VARCHAR(1), 
            @@VTYP            SMALLINT, 
            @@BANK_CODE       VARCHAR(100), 
            @@BACKDAYS        INT, 
            @@BACKDATE        VARCHAR(11), 
            @@BRNCOUNT        TINYINT, 
            @@MONTHLYVDT      VARCHAR(11), 
            @@SERIAL_NO       INT, 
            @@COSTCODECOUNT   TINYINT, 
            @@COSTCODEUPDATES CURSOR, 
            @@NEWVNO          AS VARCHAR(12), 
            @@MAXCOUNT        AS INT, 
            @@VDT             AS VARCHAR(11), 
            @@BANKBRANCH      AS VARCHAR(10), 
            @@BANKCOST        AS NUMERIC, 
            @@LNOCUR          AS CURSOR, 
            @@VNOCUR          AS CURSOR, 
            @@LNOVNO          AS VARCHAR(12), 
            @@MAXVNO          AS INT, 
            @@L2CUR           AS CURSOR, 
            @@L2VNO           AS VARCHAR(12), 
            @@ERROR_COUNT     AS INT, 
            @@FILEEXISTS      AS INT, 
            @@SQL             AS VARCHAR(2000) 

    CREATE TABLE #FEXIST 
      ( 
         F1 SMALLINT, 
         F2 SMALLINT, 
         F3 SMALLINT 
      ) 

    SELECT @@SQL = "INSERT INTO" 

    SELECT @@SQL = @@SQL + " #FEXIST " 

    SELECT @@SQL = @@SQL + " (F1, F2, F3) " 

    SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" 
                   + @FNAME + "'" 

    EXEC(@@SQL) 

    SELECT @@FILEEXISTS = F1 
    FROM   #FEXIST 

    IF @@FILEEXISTS = 0 
      BEGIN 
          DROP TABLE #FEXIST 

          SELECT 
'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.' 

    RETURN 
END 

    DROP TABLE #FEXIST 

    BEGIN TRAN 

    CREATE TABLE #RECPAY_TABLE_TMP 
      ( 
         PRODUCT_CO        VARCHAR(10), 
         INST_NMBR         VARCHAR(15), 
         INST_DATE         VARCHAR(10), 
         BENEF_DESCRIPTION VARCHAR(200), 
         INSTRUMENT_AMNT   VARCHAR(50), 
         LOC_DESCRIPTION   VARCHAR(100), 
         I_STAT            VARCHAR(10), 
         ENRICH_VALUE      VARCHAR(10), 
         NARRATION         VARCHAR(250),
	 DEPOSIT_FLG CHAR(1)
      ) 

    CREATE TABLE [#RECPAY_TABLE] 
      ( 
         SRNO              INT IDENTITY(1, 1), 
         PRODUCT_CO        VARCHAR(10), 
         INST_NMBR         VARCHAR(15), 
         INST_DATE         DATETIME, 
         BENEF_DESCRIPTION VARCHAR(200), 
         INSTRUMENT_AMNT   MONEY, 
         LOC_DESCRIPTION   VARCHAR(100), 
         I_STAT            VARCHAR(10), 
         ENRICH_VALUE      VARCHAR(10), 
         NARRATION         VARCHAR(250), 
	 DEPOSIT_FLG CHAR(1),
         VNO               VARCHAR(12), 
         VTYP              INT, 
         BOOKTYPE          VARCHAR(2), 
         VNO_REV           VARCHAR(12), 
         VTYP_REV          VARCHAR(12) 
      ) 
    ON [PRIMARY] 

    SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" 
                   + @FNAME 
                   + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS)" 

    EXEC (@@SQL) 
	print (@@SQL) 

    IF @@ERROR <> 0 
      BEGIN 
          DROP TABLE #RECPAY_TABLE_TMP 

          DROP TABLE #RECPAY_TABLE 

          ROLLBACK TRANSACTION 

          SELECT 
      'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...' 

          RETURN 
      END 

    CREATE TABLE #BANK 
      ( 
         CLTCODE VARCHAR(10) 
      ) 

    INSERT INTO #BANK 
    SELECT DISTINCT LOC_DESCRIPTION 
    FROM   #RECPAY_TABLE_TMP 

    IF @VTYPE = 2 
      BEGIN 
          INSERT INTO #RECPAY_TABLE 
                      (PRODUCT_CO, 
                       INST_NMBR, 
                       INST_DATE, 
                       BENEF_DESCRIPTION, 
                       INSTRUMENT_AMNT, 
                       LOC_DESCRIPTION, 
                       I_STAT, 
                       ENRICH_VALUE, 
                       NARRATION,
		       DEPOSIT_FLG, 
                       VNO, 
                       VTYP, 
                       BOOKTYPE) 
          SELECT DISTINCT PRODUCT_CO, 
                          INST_NMBR, 
                          CONVERT(DATETIME, INST_DATE, 103), 
                          BENEF_DESCRIPTION, 
                          CONVERT(MONEY, INSTRUMENT_AMNT), 
                          LOC_DESCRIPTION, 
                          I_STAT, 
                          ENRICH_VALUE, 
                          NARRATION, 
			  DEPOSIT_FLG,
                          VNO, 
                          VTYP, 
                          BOOKTYPE 
          FROM   #RECPAY_TABLE_TMP R 
                 LEFT OUTER JOIN (SELECT CLTCODE = L.CLTCODE, 
                                         BANK_CODE = L11.CLTCODE, 
                                         DDNO, 
                                         RELAMT, 
                                         VNO = MAX(L.VNO), 
                                         VTYP = MAX(L.VTYP), 
                                         BOOKTYPE = MAX(L.BOOKTYPE) 
                                  FROM   LEDGER L, 
                                         LEDGER1 L1, 
                                         (SELECT VNO, 
                                                 VTYP, 
                                                 BOOKTYPE, 
                                                 CLTCODE 
                                          FROM   LEDGER L12 
                                          WHERE  VTYP = 2 
                                                 AND LNO = 1 
                                                 AND EXISTS(SELECT CLTCODE 
                                                            FROM   #BANK B 
                                                            WHERE  L12.CLTCODE = 
                                                           B.CLTCODE)) L11 
                                  WHERE  L.VNO = L1.VNO 
                                         AND L.VTYP = L1.VTYP 
                                         AND L.BOOKTYPE = L1.BOOKTYPE 
                                         AND L.LNO = L1.LNO 
                                         AND L.VNO = L11.VNO 
                                         AND L.VTYP = L11.VTYP 
                                         AND L.BOOKTYPE = L11.BOOKTYPE 
                                         AND L1.CLEAR_MODE <> 'R' 
                                         AND L.VTYP = 2 
                                  GROUP  BY L.CLTCODE, 
                                            L11.CLTCODE, 
                                            DDNO, 
                                            RELAMT 
                                  HAVING COUNT(1) = 1) R1 
                              ON CLTCODE = ENRICH_VALUE 
                                 AND INST_NMBR = DDNO 
                                 AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT 
                                 AND BANK_CODE = LOC_DESCRIPTION 

          UPDATE #RECPAY_TABLE 
          SET    VTYP_REV = 17 
      END 
    ELSE 
      BEGIN 
          INSERT INTO #RECPAY_TABLE 
                      (PRODUCT_CO, 
                       INST_NMBR, 
                       INST_DATE, 
                       BENEF_DESCRIPTION, 
                       INSTRUMENT_AMNT, 
                       LOC_DESCRIPTION, 
                       I_STAT, 
                       ENRICH_VALUE, 
                       NARRATION, 
		       DEPOSIT_FLG,
                       VNO, 
                       VTYP, 
                       BOOKTYPE) 
          SELECT DISTINCT PRODUCT_CO, 
                          INST_NMBR, 
                          CONVERT(DATETIME, INST_DATE, 103), 
                          BENEF_DESCRIPTION, 
                          CONVERT(MONEY, INSTRUMENT_AMNT), 
                          LOC_DESCRIPTION, 
                          I_STAT, 
                          ENRICH_VALUE, 
                          NARRATION, 
			  DEPOSIT_FLG,
                          VNO, 
                          VTYP, 
                          BOOKTYPE 
          FROM   #RECPAY_TABLE_TMP R 
                 LEFT OUTER JOIN (SELECT CLTCODE, 
                                         DDNO, 
                                         RELAMT, 
                                         VNO = MAX(L.VNO), 
                                         VTYP = MAX(L.VTYP), 
                                         BOOKTYPE = MAX(L.BOOKTYPE) 
                                  FROM   LEDGER L, 
                                         LEDGER1 L1 
                                  WHERE  L.VNO = L1.VNO 
                                         AND L.VTYP = L1.VTYP 
                                         AND L.BOOKTYPE = L1.BOOKTYPE 
                                         AND L.LNO = L1.LNO 
                                         AND L1.CLEAR_MODE <> 'C' 
                                         AND L.VTYP = 3 
                                         AND L1.RELDT = '' 
                                  GROUP  BY CLTCODE, 
                                            DDNO, 
                                            RELAMT 
                                  HAVING COUNT(1) = 1) R1 
                              ON CLTCODE = ENRICH_VALUE 
                                 AND INST_NMBR = DDNO 
                                 AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT 

          UPDATE #RECPAY_TABLE 
          SET    VTYP_REV = 16 
      END 
--select * from #RECPAY_TABLE
---return
    /* SELECT                                               
      @@ERROR_COUNT = COUNT(1)                                               
     FROM                                               
      #RECPAY_TABLE           
     WHERE INST_DATE < CONVERT(VARCHAR(11), GETDATE()- 2, 109)         
                                                    
     IF @@ERROR_COUNT > 1                                               
      BEGIN                                               
       DROP TABLE #RECPAY_TABLE_TMP                                               
       DROP TABLE #RECPAY_TABLE                                               
       ROLLBACK TRANSACTION                                               
       SELECT 'FILE CANNOT BE UPLOADED WITH BACKDATED VDTS.'                            
       RETURN                                               
      END  */ 
    SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11), INST_DATE, 109), 
                 @@VTYP = VTYP_REV, 
                 @@BOOKTYPE = BOOKTYPE 
    FROM   #RECPAY_TABLE 

    /*--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------*/ 
    SELECT @@BACKDAYS = MAX(NODAYS) 
    FROM   USERWRITESTABLE 
    WHERE  USERCATEGORY = @USERCAT 
           AND VTYP = @@VTYP 
           AND BOOKTYPE = @@BOOKTYPE 

    SELECT @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) 
                               - @@BACKDAYS 

    SELECT @@ERROR_COUNT = ISNULL(COUNT(INST_DATE), 0) 
    FROM   #RECPAY_TABLE 
    WHERE  INST_DATE < @@BACKDATE 

    IF @@ERROR_COUNT > 0 
      BEGIN 
          SELECT 
'SOME OF THE VOUCHERS ARE HAVING BACK DATED VOUCHER DATES FOR WHICH RIGHTS HAVE NOT BEEN SET' 
, 
'NA', 
'NA' 

    DROP TABLE #RECPAY_TABLE_TMP 

    DROP TABLE #RECPAY_TABLE 

    ROLLBACK TRAN 

    DELETE FROM V2_UPLOADED_FILES 
    WHERE  U_FILENAME = @FNAME 
           AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD' 

    RETURN 
END 

    SELECT @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109), 
           @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109), 
           @@BRANCHFLAG = BRANCHFLAG, 
           @@VNOFLAG = VNOFLAG 
    FROM   PARAMETER 
    WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR 

    IF @@VNOFLAG <> 0 
      BEGIN 
          SELECT @@ERROR_COUNT = COUNT(DISTINCT INST_DATE) 
          FROM   #RECPAY_TABLE 

          IF @@ERROR_COUNT > 1 
            BEGIN 
                DROP TABLE #RECPAY_TABLE_TMP 

                DROP TABLE #RECPAY_TABLE 

                ROLLBACK TRANSACTION 

                SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTS.' 

                RETURN 
            END 
      END 

    SELECT @@ERROR_COUNT = COUNT(1) 
    FROM   #RECPAY_TABLE 
    WHERE  VNO IS NULL 

    IF @@ERROR_COUNT > 0 
      BEGIN 
          SELECT 
      'FILE CANNOT BE UPLOADED AS FOLLOWING ENTRIES ARE NOT FOUND IN LEDGER.' 
          UNION ALL 
          SELECT 'CLTCODE , DDNO , AMOUNT, BANK_CODE ' 
          UNION ALL 
          SELECT ENRICH_VALUE + ' , ' + INST_NMBR + ' , ' 
                 + CONVERT(VARCHAR, INSTRUMENT_AMNT) + ' , ' 
                 + LOC_DESCRIPTION AS RESULT 
          FROM   #RECPAY_TABLE 
          WHERE  VNO IS NULL 

          DROP TABLE #RECPAY_TABLE_TMP 

          DROP TABLE #RECPAY_TABLE 

          ROLLBACK TRANSACTION 

          RETURN 
      END 

    CREATE TABLE #VNO 
      ( 
         LASTVNO VARCHAR(12), 
      ) 

    SELECT @@MAXVNO = MAX(SRNO) 
    FROM   #RECPAY_TABLE 

    INSERT INTO #VNO 
    EXEC ACC_GENVNO_NEW 
      @@VDT, 
      @@VTYP, 
      @@BOOKTYPE, 
      @@STD_DATE, 
      @@LST_DATE, 
      @@MAXVNO 

    SELECT @@NEWVNO = LASTVNO 
    FROM   #VNO 

    UPDATE #RECPAY_TABLE 
    SET    VNO_REV = CONVERT(NUMERIC(12), @@NEWVNO) + SRNO - 1 

	--SELECT * INTO INDRAJIT FROM #RECPAY_TABLE
    INSERT INTO LEDGER 
                (VTYP, 
                 VNO, 
                 EDT, 
                 LNO, 
                 ACNAME, 
                 DRCR, 
                 VAMT, 
                 VDT, 
                 VNO1, 
                 REFNO, 
                 BALAMT, 
                 NODAYS, 
                 CDT, 
                 CLTCODE, 
                 BOOKTYPE, 
                 ENTEREDBY, 
                 PDT, 
                 CHECKEDBY, 
                 ACTNODAYS, 
                 NARRATION) 
    SELECT VTYP_REV, 
           VNO_REV, 
           INST_DATE, 
           LNO, 
           ACNAME, 
           CASE 
             WHEN DRCR = 'D' THEN 'C' 
             ELSE 'D' 
           END, 
           VAMT, 
           INST_DATE, 
           VNO1, 
           REFNO, 
           BALAMT, 
           NODAYS, 
           GETDATE(), 
           CLTCODE, 
           L.BOOKTYPE, 
           @UNAME, 
           GETDATE(), 
           @UNAME, 
           ACTNODAYS, 
           CASE WHEN DEPOSIT_FLG = 'N' THEN 'CHEQUE REVERSE ' END + R.NARRATION 
    FROM   LEDGER L, 
           #RECPAY_TABLE R 
    WHERE  L.VNO = R.VNO 
           AND L.VTYP = R.VTYP 
           AND L.BOOKTYPE = R.BOOKTYPE 

    INSERT INTO LEDGER1 
                (BNKNAME, 
                 BRNNAME, 
                 DD, 
                 DDNO, 
                 DDDT, 
                 RELDT, 
                 RELAMT, 
                 REFNO, 
                 RECEIPTNO, 
                 VTYP, 
                 VNO, 
                 LNO, 
                 DRCR, 
                 BOOKTYPE, 
                 MICRNO, 
                 SLIPNO, 
                 SLIPDATE, 
                 CHEQUEINNAME, 
                 CHQPRINTED, 
                 CLEAR_MODE) 
    SELECT BNKNAME, 
           BRNNAME, 
           DD, 
           DDNO, 
           DDDT, 
           RELDT = CASE WHEN DEPOSIT_FLG = 'N' AND @VTYPE = 2 THEN INST_DATE ELSE '' END,
           RELAMT, 
           '',
           RECEIPTNO, 
           VTYP_REV, 
           VNO_REV, 
           LNO, 
           CASE 
             WHEN DRCR = 'D' THEN 'C' 
             ELSE 'D' 
           END, 
           L.BOOKTYPE, 
           MICRNO, 
           SLIPNO, 
           SLIPDATE, 
           CHEQUEINNAME, 
           CHQPRINTED, 
           CLEAR_MODE 
    FROM   LEDGER1 L, 
           #RECPAY_TABLE R 
    WHERE  L.VNO = R.VNO 
           AND L.VTYP = R.VTYP 
           AND L.BOOKTYPE = R.BOOKTYPE 

    INSERT INTO LEDGER2 
                (VTYPE, 
                 VNO, 
                 LNO, 
                 DRCR, 
                 CAMT, 
                 COSTCODE, 
                 BOOKTYPE, 
                 CLTCODE) 
    SELECT VTYP_REV, 
           VNO_REV, 
           LNO, 
           CASE 
             WHEN DRCR = 'D' THEN 'C' 
             ELSE 'D' 
           END, 
           CAMT, 
           COSTCODE, 
           L.BOOKTYPE, 
           CLTCODE 
    FROM   LEDGER2 L, 
           #RECPAY_TABLE R 
    WHERE  L.VNO = R.VNO 
           AND L.VTYPE = R.VTYP 
           AND L.BOOKTYPE = R.BOOKTYPE 

    INSERT INTO LEDGER3 
                (NARATNO, 
                 NARR, 
                 REFNO, 
                 VTYP, 
                 VNO, 
                 BOOKTYPE) 
    SELECT NARATNO, 
           R.NARRATION, 
           REFNO, 
           VTYP_REV, 
           VNO_REV, 
           L.BOOKTYPE 
    FROM   LEDGER3 L, 
           #RECPAY_TABLE R 
    WHERE  L.VNO = R.VNO 
           AND L.VTYP = R.VTYP 
           AND L.BOOKTYPE = R.BOOKTYPE 

    UPDATE L 
    SET    CLEAR_MODE = CASE 
                          WHEN @VTYPE = 2 THEN 'R' 
                          ELSE 'C' 
                        END, 
RELDT = CASE WHEN DEPOSIT_FLG = 'N' AND @VTYPE = 2 THEN INST_DATE ELSE '' END 
 
    FROM   LEDGER1 L, 
           #RECPAY_TABLE R 
    WHERE  L.VNO = R.VNO 
           AND L.VTYP = R.VTYP 
           AND L.BOOKTYPE = R.BOOKTYPE 

    SELECT 'FILE UPLOADED SUCCESSFULLY' 
    UNION ALL 
    SELECT 'VNO, VTYP, RECEIPT_VNO' 
    UNION ALL 
    SELECT VNO_REV + ' , ' + VTYP_REV + ' , ' + VNO AS RESULT 
    FROM   #RECPAY_TABLE 

    COMMIT 
--ROLLBACK TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RETURNCANCEL_BULK_08122010_1
-- --------------------------------------------------

CREATE PROC [dbo].[RETURNCANCEL_BULK_08122010_1]              
 @VTYPE TINYINT,  
 @FNAME VARCHAR(100),            
 @UNAME VARCHAR(25),            
 @USERCAT SMALLINT            
                                
AS                                
/*                                
begin tran                                
SP_HELPTRIGGER LEDGER                                
LEDGER_TRG_BILL                                
LEDGER_TRG                                
Exec RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\SAMPLE1.csv', 'JAYDEEP', 388                                
SELECT TOP 1 * FROM LEDGER3                                
SELECT TOP 1 * FROM LEDGER_TRG                                
ROLLBACK                                
*/                                
SET NOCOUNT ON                                
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/                                
DECLARE                                
 @@STD_DATE VARCHAR(11),                                
 @@LST_DATE VARCHAR(11),                                
 @@BRANCHFLAG AS TINYINT,                                
 @@VNOFLAG AS TINYINT,                                
 @@VNOMETHOD INT,                                
 @@ACNAME CHAR(100),                                
 @@BOOKTYPE CHAR(2),                                
 @@MICRNO VARCHAR(10),                                
 @@DRCR VARCHAR(1),                                
 @@VTYP SMALLINT,                                
 @@BANK_CODE VARCHAR(100),                                
 @@BACKDAYS INT,                                
 @@BACKDATE VARCHAR(11),                                
 @@BRNCOUNT   TINYINT,                                
 @@MonthlyVdt VARCHAR(11),                                
 @@SERIAL_NO INT,                                
 @@COSTCODECOUNT TINYINT,                                
 @@COSTCODEUPDATES CURSOR,                                
 @@NEWVNO AS VARCHAR(12),                                
 @@MAXCOUNT AS INT,                                
 @@VDT AS VARCHAR(11),                                
 @@BANKBRANCH AS VARCHAR(10),                                
 @@BANKCOST AS NUMERIC,                                
 @@LNOCUR AS CURSOR,                                
 @@VNOCUR AS CURSOR,                                
 @@LNOVNO AS VARCHAR(12),                                
 @@MAXVNO AS INT,                                
 @@L2CUR AS CURSOR,                                
 @@L2VNO AS VARCHAR(12),                                
 @@ERROR_COUNT AS INT,                                
 @@FILEEXISTS AS INT,                                
 @@SQL AS VARCHAR(2000)                                
                                
                      
CREATE TABLE #FEXIST                                
(                                
 F1 SMALLINT,                                
 F2 SMALLINT,                                
 F3 SMALLINT                                
)                                
SELECT @@SQL = "INSERT INTO "                                
SELECT @@SQL = @@SQL + " #FEXIST "                                
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                                
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                                
                                
EXEC(@@SQL)                                
                                
SELECT                                
 @@FILEEXISTS = F1                                
FROM                                
 #FEXIST                                
                                
IF @@FILEEXISTS = 0                                
 BEGIN                                
  DROP TABLE #FEXIST                                
  SELECT                                
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                                
  RETURN                                
 END                                
DROP TABLE #FEXIST                               
                                
BEGIN TRAN                                
CREATE TABLE #RECPAY_TABLE_TMP                                
(                  
 PRODUCT_CO VARCHAR(10),            
 INST_NMBR VARCHAR(10),            
 INST_DATE VARCHAR(10),            
 BENEF_DESCRIPTION  VARCHAR(200),            
 INSTRUMENT_AMNT  VARCHAR(50),            
 LOC_DESCRIPTION VARCHAR(100),            
 I_STAT VARCHAR(10),            
 ENRICH_VALUE VARCHAR(10),            
 NARRATION VARCHAR(250)            
)                   
        
CREATE TABLE [#RECPAY_TABLE]                                
(            
 SRNO INT IDENTITY(1,1),            
 PRODUCT_CO VARCHAR(10),            
 INST_NMBR VARCHAR(10),            
 INST_DATE DATETIME,            
 BENEF_DESCRIPTION  VARCHAR(200),            
 INSTRUMENT_AMNT  MONEY,            
 LOC_DESCRIPTION VARCHAR(100),            
 I_STAT VARCHAR(10),            
 ENRICH_VALUE VARCHAR(10),            
 NARRATION VARCHAR(250),            
 VNO VARCHAR(12),            
 VTYP INT,            
 BOOKTYPE VARCHAR(2),   VNO_REV VARCHAR(12),            
 VTYP_REV VARCHAR(12)            
) ON [PRIMARY]            
                                
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                                
EXEC (@@SQL)                                
                                
IF @@ERROR <> 0                                
 BEGIN                                
  DROP TABLE #RECPAY_TABLE_TMP                                
  DROP TABLE #RECPAY_TABLE                                
  ROLLBACK TRANSACTION                                
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                                
  RETURN                                
 END                                
            
IF @VTYPE = 2  
BEGIN            
INSERT INTO #RECPAY_TABLE            
(            
 PRODUCT_CO,            
 INST_NMBR,            
 INST_DATE,            
 BENEF_DESCRIPTION,            
 INSTRUMENT_AMNT,            
 LOC_DESCRIPTION,            
 I_STAT,            
 ENRICH_VALUE,            
 NARRATION,            
 VNO,            
 VTYP,            
 BOOKTYPE            
)            
SELECT            
 PRODUCT_CO,            
 INST_NMBR,            
 CONVERT(DATETIME, INST_DATE, 103),            
 BENEF_DESCRIPTION,            
 CONVERT(MONEY, INSTRUMENT_AMNT),            
 LOC_DESCRIPTION,            
 I_STAT,            
 ENRICH_VALUE,            
 NARRATION,            
 VNO,            
 VTYP,            
 BOOKTYPE            
FROM            
 #RECPAY_TABLE_TMP R LEFT OUTER JOIN            
 (            
  SELECT             
   CLTCODE, DDNO, RELAMT, VNO = MAX(L.VNO), VTYP = MAX(L.VTYP), BOOKTYPE = MAX(L.BOOKTYPE)            
  FROM             
   LEDGER L,             
   LEDGER1 L1            
  WHERE             
   L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO            
   AND L1.CLEAR_MODE <> 'R' AND L.VTYP = 2            
  GROUP BY CLTCODE, DDNO, RELAMT            
  HAVING COUNT(1) = 1            
 ) R1            
 ON CLTCODE = ENRICH_VALUE AND INST_NMBR = DDNO AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT            
  
 UPDATE #RECPAY_TABLE SET VTYP_REV = 17   
END  
ELSE  
BEGIN  
INSERT INTO #RECPAY_TABLE            
(            
 PRODUCT_CO,            
 INST_NMBR,            
 INST_DATE,            
 BENEF_DESCRIPTION,            
 INSTRUMENT_AMNT,            
 LOC_DESCRIPTION,            
 I_STAT,            
 ENRICH_VALUE,            
 NARRATION,            
 VNO,            
 VTYP,            
 BOOKTYPE            
)            
SELECT            
 PRODUCT_CO,            
 INST_NMBR,            
 CONVERT(DATETIME, INST_DATE, 103),            
 BENEF_DESCRIPTION,            
 CONVERT(MONEY, INSTRUMENT_AMNT),            
 LOC_DESCRIPTION,            
 I_STAT,            
 ENRICH_VALUE,            
 NARRATION,            
 VNO,            
 VTYP,            
 BOOKTYPE            
FROM         
 #RECPAY_TABLE_TMP R LEFT OUTER JOIN            
 (            
  SELECT             
   CLTCODE, DDNO, RELAMT, VNO = MAX(L.VNO), VTYP = MAX(L.VTYP), BOOKTYPE = MAX(L.BOOKTYPE)            
  FROM             
   LEDGER L,             
   LEDGER1 L1            
  WHERE             
   L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO            
   AND L1.CLEAR_MODE <> 'C' AND L.VTYP = 3  
  GROUP BY CLTCODE, DDNO, RELAMT            
  HAVING COUNT(1) = 1            
 ) R1            
 ON CLTCODE = ENRICH_VALUE AND INST_NMBR = DDNO AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT   
  
 UPDATE #RECPAY_TABLE SET VTYP_REV = 16  
END  
            
            
SELECT TOP 1                                
 @@VDT = CONVERT(VARCHAR(11), INST_DATE, 109),            
 @@VTYP = VTYP_REV,            
 @@BOOKTYPE = BOOKTYPE                            
FROM                                
 #RECPAY_TABLE                                
                          
                          
SELECT                                
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                                
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                                
 @@BRANCHFLAG = BRANCHFLAG,                                
 @@VNOFLAG = VNOFLAG                                
FROM                                
 PARAMETER                                
WHERE                                
 @@VDT BETWEEN SDTCUR AND LDTCUR                             
                                
IF @@VNOFLAG <> 0                           
BEGIN                               
 SELECT                                
  @@ERROR_COUNT = COUNT(DISTINCT INST_DATE)                                
 FROM                                
  #RECPAY_TABLE                          
                                 
 IF @@ERROR_COUNT > 1                                
  BEGIN                                
   DROP TABLE #RECPAY_TABLE_TMP                                
   DROP TABLE #RECPAY_TABLE                                
   ROLLBACK TRANSACTION                                
   SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                                
   RETURN                                
  END                              
END               
            
            
            
SELECT                                
  @@ERROR_COUNT = COUNT(1)                                
 FROM                                
  #RECPAY_TABLE               
WHERE             
 VNO IS NULL            
            
IF @@ERROR_COUNT > 0                           
BEGIN             
 SELECT 'FILE CANNOT BE UPLOADED AS FOLLOWING ENTRIES ARE NOT FOUND IN LEDGER.'            
 UNION ALL            
 SELECT 'CLTCODE , DDNO , AMOUNT '            
 UNION ALL            
 SELECT ENRICH_VALUE + ' , ' +  INST_NMBR + ' , ' + CONVERT(VARCHAR, INSTRUMENT_AMNT) AS RESULT            
 FROM                   
  #RECPAY_TABLE            
 WHERE             
  VNO IS NULL            
            
 DROP TABLE #RECPAY_TABLE_TMP            
 DROP TABLE #RECPAY_TABLE            
 ROLLBACK TRANSACTION            
             
   RETURN            
END            
            
CREATE TABLE #VNO            
(            
 LASTVNO VARCHAR(12),            
)            
                
SELECT @@MAXVNO = MAX(SRNO) FROM #RECPAY_TABLE                                
            
INSERT                                
INTO #VNO                                
 EXEC ACC_GENVNO_NEW                                
  @@VDT,                                
  @@VTYP,                                
  @@BOOKTYPE,                                
  @@STD_DATE,                                
  @@LST_DATE,                                
  @@MAXVNO                    
                        
SELECT                                
 @@NEWVNO = LASTVNO            
FROM                                
 #VNO                
         
UPDATE #RECPAY_TABLE SET VNO_REV = CONVERT(NUMERIC(12), @@NEWVNO) + SRNO - 1            
            
INSERT INTO LEDGER(VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION)            
SELECT VTYP_REV,VNO_REV,INST_DATE,LNO,ACNAME,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,VAMT,INST_DATE,VNO1,REFNO,BALAMT,NODAYS,GETDATE(),CLTCODE,L.BOOKTYPE,@UNAME,GETDATE(),@UNAME,ACTNODAYS,R.NARRATION             
FROM LEDGER L, #RECPAY_TABLE R            
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE      
            
INSERT INTO LEDGER1(BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE)            
SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,CASE WHEN @VTYPE = 2 THEN 'JAN 01 1900' ELSE INST_DATE END,RELAMT,'',RECEIPTNO,VTYP_REV,VNO_REV,LNO,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,L.BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE       
     
FROM LEDGER1 L, #RECPAY_TABLE R            
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE            
            
INSERT INTO LEDGER2(VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE)            
SELECT VTYP_REV,VNO_REV,LNO,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,CAMT,COSTCODE,L.BOOKTYPE,CLTCODE            
FROM LEDGER2 L, #RECPAY_TABLE R            
WHERE L.VNO = R.VNO AND L.VTYPE = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE            
            
            
INSERT INTO LEDGER3(NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE)            
SELECT NARATNO,R.NARRATION,REFNO,VTYP_REV,VNO_REV,L.BOOKTYPE            
FROM LEDGER3 L, #RECPAY_TABLE R            
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE            
            
UPDATE L SET CLEAR_MODE = CASE WHEN @VTYPE = 2 THEN 'R' ELSE 'C' END  
FROM LEDGER1 L, #RECPAY_TABLE R            
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE             
            
SELECT 'FILE UPLOADED SUCCESSFULLY'            
UNION ALL            
SELECT 'VNO, VTYP, RECEIPT_VNO'            
UNION ALL            
SELECT VNO_REV + ' , ' + VTYP_REV + ' , ' + VNO AS RESULT            
FROM                   
 #RECPAY_TABLE            
            
COMMIT          
--ROLLBACK TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RETURNCANCEL_BULK_27032012
-- --------------------------------------------------
CREATE PROC [dbo].[RETURNCANCEL_BULK_27032012]                      
 @VTYPE SMALLINT,        
 @FNAME VARCHAR(100),                    
 @UNAME VARCHAR(25),                    
 @USERCAT SMALLINT                    
                                        
AS                                        
/*                                        
BEGIN TRAN                                        
SP_HELPTRIGGER LEDGER                                        
LEDGER_TRG_BILL                                        
LEDGER_TRG                                        
EXEC RECPAYUPLOAD_BULK 'D:\BACKOFFICE\RECPAYFILES\SAMPLE1.CSV', 'JAYDEEP', 388                                        
SELECT TOP 1 * FROM LEDGER3                                        
SELECT TOP 1 * FROM LEDGER_TRG                                        
ROLLBACK                                        
*/                                        
SET NOCOUNT ON                                        
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE B ASED ON DRCR ------------------------*/                                        
DECLARE                                        
 @@STD_DATE VARCHAR(11),                                        
 @@LST_DATE VARCHAR(11),                                        
 @@BRANCHFLAG AS TINYINT,                                        
 @@VNOFLAG AS TINYINT,                                        
 @@VNOMETHOD INT,                                        
 @@ACNAME CHAR(100),                                        
 @@BOOKTYPE CHAR(2),                                        
 @@MICRNO VARCHAR(10),                                        
 @@DRCR VARCHAR(1),                                        
 @@VTYP SMALLINT,                                        
 @@BANK_CODE VARCHAR(100),                                        
 @@BACKDAYS INT,                                        
 @@BACKDATE VARCHAR(11),                                        
 @@BRNCOUNT   TINYINT,                                        
 @@MONTHLYVDT VARCHAR(11),                                        
 @@SERIAL_NO INT,                                        
 @@COSTCODECOUNT TINYINT,                                        
 @@COSTCODEUPDATES CURSOR,                                        
 @@NEWVNO AS VARCHAR(12),                                        
 @@MAXCOUNT AS INT,                                        
 @@VDT AS VARCHAR(11),                                        
 @@BANKBRANCH AS VARCHAR(10),                                        
 @@BANKCOST AS NUMERIC,                                        
 @@LNOCUR AS CURSOR,                                        
 @@VNOCUR AS CURSOR,                                        
 @@LNOVNO AS VARCHAR(12),                                        
 @@MAXVNO AS INT,                                        
 @@L2CUR AS CURSOR,                                        
 @@L2VNO AS VARCHAR(12),                                        
 @@ERROR_COUNT AS INT,                                        
 @@FILEEXISTS AS INT,                                        
 @@SQL AS VARCHAR(2000)                                        
                                        
                              
CREATE TABLE #FEXIST                                        
(                                        
 F1 SMALLINT,                                        
 F2 SMALLINT,                                        
 F3 SMALLINT                                        
)                                        
SELECT @@SQL = "INSERT INTO "                                        
SELECT @@SQL = @@SQL + " #FEXIST "                                        
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                                        
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                                        
                                        
EXEC(@@SQL)                                        
                                        
SELECT                                        
 @@FILEEXISTS = F1                                        
FROM                                        
 #FEXIST        
                                        
IF @@FILEEXISTS = 0                                        
 BEGIN                                        
  DROP TABLE #FEXIST                                        
  SELECT                                        
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                                        
  RETURN                                        
 END                                        
DROP TABLE #FEXIST                                       
                                        
BEGIN TRAN                                        
CREATE TABLE #RECPAY_TABLE_TMP                                        
(                          
 PRODUCT_CO VARCHAR(10),                    
 INST_NMBR VARCHAR(15),                    
 INST_DATE VARCHAR(10),                    
 BENEF_DESCRIPTION  VARCHAR(200),                    
 INSTRUMENT_AMNT  VARCHAR(50),                    
 LOC_DESCRIPTION VARCHAR(100),                    
 I_STAT VARCHAR(10),                    
 ENRICH_VALUE VARCHAR(10),                    
 NARRATION VARCHAR(250)                    
)                           
                
CREATE TABLE [#RECPAY_TABLE]                                        
(                    
 SRNO INT IDENTITY(1,1),                    
 PRODUCT_CO VARCHAR(10),                    
 INST_NMBR VARCHAR(15),                    
 INST_DATE DATETIME,                    
 BENEF_DESCRIPTION  VARCHAR(200),                    
 INSTRUMENT_AMNT  MONEY,                    
 LOC_DESCRIPTION VARCHAR(100),                    
 I_STAT VARCHAR(10),                    
 ENRICH_VALUE VARCHAR(10),                    
 NARRATION VARCHAR(250),                    
 VNO VARCHAR(12),                    
 VTYP INT,                    
 BOOKTYPE VARCHAR(2),   VNO_REV VARCHAR(12),                    
 VTYP_REV VARCHAR(12)                    
) ON [PRIMARY]                    
                                        
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                                        
EXEC (@@SQL)                                        
                                        
IF @@ERROR <> 0                                        
 BEGIN                                        
  DROP TABLE #RECPAY_TABLE_TMP                                        
  DROP TABLE #RECPAY_TABLE                                        
  ROLLBACK TRANSACTION                                        
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                                        
  RETURN                                        
 END                                        
                    
IF @VTYPE = 2          
BEGIN                    
INSERT INTO #RECPAY_TABLE                    
(                    
 PRODUCT_CO,                    
 INST_NMBR,                    
 INST_DATE,                    
 BENEF_DESCRIPTION,                    
 INSTRUMENT_AMNT,                    
 LOC_DESCRIPTION,                    
 I_STAT,                    
 ENRICH_VALUE,                    
 NARRATION,                    
 VNO,                    
 VTYP,                    
 BOOKTYPE                    
)                    
SELECT    
 DISTINCT PRODUCT_CO,                    
 INST_NMBR,                    
 CONVERT(DATETIME, INST_DATE, 103),                    
 BENEF_DESCRIPTION,                    
 CONVERT(MONEY, INSTRUMENT_AMNT),                    
 LOC_DESCRIPTION,                    
 I_STAT,                    
 ENRICH_VALUE,                    
 NARRATION,                    
 VNO,                    
 VTYP,                    
 BOOKTYPE                    
FROM                    
 #RECPAY_TABLE_TMP R LEFT OUTER JOIN                    
 (                    
  SELECT                     
   CLTCODE, DDNO, RELAMT, VNO = MAX(L.VNO), VTYP = MAX(L.VTYP), BOOKTYPE = MAX(L.BOOKTYPE)                    
  FROM                     
   LEDGER L,                     
   LEDGER1 L1                    
  WHERE                     
   L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO                    
   AND L1.CLEAR_MODE <> 'R' AND L.VTYP = 2    
  GROUP BY CLTCODE, DDNO, RELAMT                    
  HAVING COUNT(1) = 1                    
 ) R1                    
 ON CLTCODE = ENRICH_VALUE AND INST_NMBR = DDNO AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT                    
          
 UPDATE #RECPAY_TABLE SET VTYP_REV = 17           
END          
ELSE          
BEGIN         
INSERT INTO #RECPAY_TABLE    
(                    
 PRODUCT_CO,                    
 INST_NMBR,                    
 INST_DATE,                    
 BENEF_DESCRIPTION,                    
 INSTRUMENT_AMNT,                    
 LOC_DESCRIPTION,                    
 I_STAT,                    
 ENRICH_VALUE,                    
 NARRATION,                    
 VNO,                    
 VTYP,                    
 BOOKTYPE                    
)                    
SELECT                    
 DISTINCT PRODUCT_CO,                    
 INST_NMBR,                    
 CONVERT(DATETIME, INST_DATE, 103),                    
 BENEF_DESCRIPTION,                    
 CONVERT(MONEY, INSTRUMENT_AMNT),                    
 LOC_DESCRIPTION,                    
 I_STAT,                    
 ENRICH_VALUE,                    
 NARRATION,                    
 VNO,                    
 VTYP,                    
 BOOKTYPE                    
FROM                 
 #RECPAY_TABLE_TMP R LEFT OUTER JOIN                    
 (                    
  SELECT                     
   CLTCODE, DDNO, RELAMT, VNO = MAX(L.VNO), VTYP = MAX(L.VTYP), BOOKTYPE = MAX(L.BOOKTYPE)                    
  FROM                     
   LEDGER L,                     
   LEDGER1 L1                    
  WHERE                     
   L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO                    
   AND L1.CLEAR_MODE <> 'C' AND L.VTYP = 3 AND L1.RELDT = ''         
  GROUP BY CLTCODE, DDNO, RELAMT                    
  HAVING COUNT(1) = 1                    
 ) R1                    
 ON CLTCODE = ENRICH_VALUE AND INST_NMBR = DDNO AND CONVERT(MONEY, INSTRUMENT_AMNT) = RELAMT           
          
 UPDATE #RECPAY_TABLE SET VTYP_REV = 16          
END    
    
 SELECT                                        
  @@ERROR_COUNT = COUNT(1)                                        
 FROM                                        
  #RECPAY_TABLE    
 WHERE INST_DATE < CONVERT(VARCHAR(11), GETDATE()- 2, 109)  
                                         
 IF @@ERROR_COUNT > 1                                        
  BEGIN                                        
   DROP TABLE #RECPAY_TABLE_TMP                                        
   DROP TABLE #RECPAY_TABLE                                        
   ROLLBACK TRANSACTION                                        
   SELECT 'FILE CANNOT BE UPLOADED WITH BACKDATED VDTS.'                                        
   RETURN                                        
  END           
                    
                    
SELECT TOP 1                                        
 @@VDT = CONVERT(VARCHAR(11), INST_DATE, 109),                    
 @@VTYP = VTYP_REV,                    
 @@BOOKTYPE = BOOKTYPE                                    
FROM                                        
 #RECPAY_TABLE                                        
                                  
                                  
SELECT                                        
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                                        
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                                        
 @@BRANCHFLAG = BRANCHFLAG,                                        
 @@VNOFLAG = VNOFLAG                                        
FROM                                        
 PARAMETER                                        
WHERE                                   
 @@VDT BETWEEN SDTCUR AND LDTCUR                                     
                                        
IF @@VNOFLAG <> 0                                   
BEGIN                                       
 SELECT                                        
  @@ERROR_COUNT = COUNT(DISTINCT INST_DATE)                                        
 FROM                                        
  #RECPAY_TABLE                                  
               
 IF @@ERROR_COUNT > 1                                        
  BEGIN                                        
   DROP TABLE #RECPAY_TABLE_TMP                                        
   DROP TABLE #RECPAY_TABLE                                        
   ROLLBACK TRANSACTION                                        
   SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTS.'                                        
   RETURN                                        
  END                                      
END                       
                    
                    
                    
SELECT                                        
  @@ERROR_COUNT = COUNT(1)                                        
 FROM                                        
  #RECPAY_TABLE                       
WHERE                     
 VNO IS NULL                    
                    
IF @@ERROR_COUNT > 0                                   
BEGIN                     
 SELECT 'FILE CANNOT BE UPLOADED AS FOLLOWING ENTRIES ARE NOT FOUND IN LEDGER.'                    
 UNION ALL                    
 SELECT 'CLTCODE , DDNO , AMOUNT '                    
 UNION ALL                    
 SELECT ENRICH_VALUE + ' , ' +  INST_NMBR + ' , ' + CONVERT(VARCHAR, INSTRUMENT_AMNT) AS RESULT                    
 FROM       
  #RECPAY_TABLE                    
 WHERE                     
  VNO IS NULL                    
                    
 DROP TABLE #RECPAY_TABLE_TMP                    
 DROP TABLE #RECPAY_TABLE                    
 ROLLBACK TRANSACTION                    
                     
   RETURN                    
END                    
                    
CREATE TABLE #VNO                    
(                    
 LASTVNO VARCHAR(12),                    
)                    
                        
SELECT @@MAXVNO = MAX(SRNO) FROM #RECPAY_TABLE                                        
                    
INSERT                                        
INTO #VNO                           
 EXEC ACC_GENVNO_NEW                                        
  @@VDT,                                        
  @@VTYP,                                        
  @@BOOKTYPE,                                        
  @@STD_DATE,                                        
  @@LST_DATE,                                        
  @@MAXVNO                            
                                
SELECT                                        
 @@NEWVNO = LASTVNO                    
FROM                                        
 #VNO                        
                 
UPDATE #RECPAY_TABLE SET VNO_REV = CONVERT(NUMERIC(12), @@NEWVNO) + SRNO - 1                    
                    
INSERT INTO LEDGER(VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,NARRATION)                    
SELECT VTYP_REV,VNO_REV,INST_DATE,LNO,ACNAME,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,VAMT,INST_DATE,VNO1,REFNO,BALAMT,NODAYS,GETDATE(),CLTCODE,L.BOOKTYPE,@UNAME,GETDATE(),@UNAME,ACTNODAYS,R.NARRATION                     
FROM LEDGER L, #RECPAY_TABLE R                    
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE              
                    
INSERT INTO LEDGER1(BNKNAME,BRNNAME,DD,DDNO,DDDT,RELDT,RELAMT,REFNO,RECEIPTNO,VTYP,VNO,LNO,DRCR,BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE)                    
SELECT BNKNAME,BRNNAME,DD,DDNO,DDDT,CASE WHEN @VTYPE = 2 THEN 'JAN 01 1900' ELSE INST_DATE END,RELAMT,'',RECEIPTNO,VTYP_REV,VNO_REV,LNO,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,L.BOOKTYPE,MICRNO,SLIPNO,SLIPDATE,CHEQUEINNAME,CHQPRINTED,CLEAR_MODE       
  
    
      
        
             
FROM LEDGER1 L, #RECPAY_TABLE R                    
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE                    
                    
INSERT INTO LEDGER2(VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE)                    
SELECT VTYP_REV,VNO_REV,LNO,CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END,CAMT,COSTCODE,L.BOOKTYPE,CLTCODE                    
FROM LEDGER2 L, #RECPAY_TABLE R                    
WHERE L.VNO = R.VNO AND L.VTYPE = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE     
                    
                    
INSERT INTO LEDGER3(NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE)                    
SELECT NARATNO,R.NARRATION,REFNO,VTYP_REV,VNO_REV,L.BOOKTYPE                    
FROM LEDGER3 L, #RECPAY_TABLE R                    
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE                    
                    
UPDATE L SET CLEAR_MODE = CASE WHEN @VTYPE = 2 THEN 'R' ELSE 'C' END, RELDT = CASE WHEN @VTYPE = 2 THEN RELDT ELSE INST_DATE END      
FROM LEDGER1 L, #RECPAY_TABLE R                    
WHERE L.VNO = R.VNO AND L.VTYP = R.VTYP AND L.BOOKTYPE = R.BOOKTYPE                     
                    
SELECT 'FILE UPLOADED SUCCESSFULLY'                    
UNION ALL                    
SELECT 'VNO, VTYP, RECEIPT_VNO'                    
UNION ALL                    
SELECT VNO_REV + ' , ' + VTYP_REV + ' , ' + VNO AS RESULT                    
FROM                           
 #RECPAY_TABLE                    
                    
COMMIT                  
--ROLLBACK TRAN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_BANKBOOK_NEW
-- --------------------------------------------------
  
/*  
EDIFF = DATEDIFF(D, L.EDT, GETDATE()),             
EXEC RPT_ACC_BANKBOOK_NEW 'DEC  1 2010', 'DEC 22 2010', '01/04/2010', 'BANK01', 'BROKER', 'BROKER', '%', 'VDT'  
*/  
  
--EXEC RPT_ACC_BANKBOOK_NEW_BR 'APR  1 2005', 'MAR 31 2006', 'APR  1 2005', 'BANK01', 'BROKER', 'BROKER', 'TR001'        
CREATE PROC [dbo].[RPT_ACC_BANKBOOK_NEW]        
      @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                            
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                            
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                            
      @FCODE VARCHAR(10),                            
      @STATUSID VARCHAR(30),                            
      @STATUSNAME VARCHAR(30),                            
      @BRANCH VARCHAR(10),        
      @SELECTIONBY VARCHAR(3) = 'VDT'                             
                            
AS                            
                            
DECLARE                            
 @@OPENDATE AS VARCHAR(11),                            
 @@REPDATE AS VARCHAR(8),                            
 @@STARTDATE AS VARCHAR(11),         
 @@COSTCODE AS SMALLINT        
        
        
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
                          
CREATE TABLE [DBO].[#TBL_GLREPORT] (                          
 [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                          
 [BOOKTYPE] [CHAR] (2) NULL ,                          
 [VOUDT] [VARCHAR] (10) NULL ,                          
 [EFFDT] [VARCHAR] (10) NULL ,                          
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                          
 [DRAMT] [MONEY] NULL ,                          
 [CRAMT] [MONEY] NULL ,                          
 [VNO] [VARCHAR] (12) NULL ,                          
 [NARRATION] [VARCHAR] (500) NULL ,                          
 [DDNO] [VARCHAR] (15) NULL ,                          
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                          
 [LONGNAME] [VARCHAR] (100) NULL ,                          
 [VDT] [DATETIME] NULL ,                          
 [VTYP] [SMALLINT] NOT NULL ,                          
 [ACCAT] [CHAR] (2) NULL ,                          
 [OPBAL] [MONEY] NOT NULL ,                          
 [CROSAC] [VARCHAR] (10) NOT NULL ,                          
 [ACNAME] [VARCHAR] (100) NULL ,                          
 [BRANCHCODE] [VARCHAR] (35) NULL ,                          
 [LNO] [INT] NULL,      
 [PROCID] [BIGINT] NULL ,                          
 [REPDATE] [VARCHAR] (8) NULL ,                          
 [MAINCODE] [VARCHAR] (10) NULL ,                          
 [VCHDT] [DATETIME] NULL,  
 [EDIFF] INT NULL  
)                          
                          
                            
--DELETE #TBL_GLREPORT WHERE PROCID = @@SPID                                          
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID        
        
SELECT @@COSTCODE = -1        
        
IF @STATUSID <> 'BROKER'        
 BEGIN        
  SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME         
 END        
ELSE IF @STATUSID = 'BROKER'        
 BEGIN        
  IF @BRANCH <> '' OR @BRANCH <> '%'        
   BEGIN        
    SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH         
   END        
 END        
      
SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)                            
        
IF @SELECTIONBY = 'VDT'         
BEGIN        
 IF @STATUSID = 'BROKER'        
  BEGIN                            
   IF @BRANCH = '' OR @BRANCH = '%'        
    BEGIN        
     PRINT 'CAME HERE - I'        
     INSERT INTO TBL_OPPBALANCE         
     SELECT         
      CLTCODE,         
      SUM(OPBAL) AS OPBAL,        
      SPID ,         
      CURDATE         
     FROM                            
      (SELECT         
       CLTCODE,        
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                                 
      FROM         
       LEDGER                                
      WHERE         
       CLTCODE = @FCODE         
       AND VTYP = 18         
       AND VDT LIKE @@STARTDATE + '%'        
      GROUP BY         
       CLTCODE        
      UNION ALL                            
      SELECT         
  CLTCODE,        
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
      FROM         
       LEDGER                                  
      WHERE         
       CLTCODE = @FCODE         
       AND VDT >= @@STARTDATE         
       AND VDT <  @FDATE                            
       AND VTYP <> 18                            
      GROUP BY         
       CLTCODE) A        
     GROUP BY         
      CLTCODE,         
      SPID,         
      CURDATE        
         
                             
     INSERT INTO #TBL_GLREPORT                          
     SELECT         
      L.BOOKTYPE,                             
      VOUDT=CONVERT(VARCHAR,L.VDT,103),         
      EFFDT=CONVERT(VARCHAR,L.EDT,103),         
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                      
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                    
      L.VNO,         
      REPLACE( L.NARRATION,'"','') NARRATION,                                                       
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
      L.CLTCODE ,        
      A.LONGNAME,        
      VDT,         
      L.VTYP,                                                                      
      ACCAT,         
      OPBAL=0,        
      CROSAC='',        
      A.ACNAME,        
      A.BRANCHCODE,      
      L.LNO,        
      @@SPID,         
      CONVERT(VARCHAR,GETDATE(),112), '',         
      L.VDT,  
      EDIFF = DATEDIFF(D, L.EDT, GETDATE())                          
     FROM         
      LEDGER L           
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
      VMAST V, ACMAST A                          
     WHERE         
      L.VNO = L1.VNO                          
      AND L.VTYP = L1.VTYP                          
      AND L.BOOKTYPE = L1.BOOKTYPE                          
      AND L.VNO = LL.VNO                          
      AND L.VTYP = LL.VTYP                          
      AND L.BOOKTYPE = LL.BOOKTYPE                          
      AND L.CLTCODE = A.CLTCODE                          
      AND L.VTYP = V.VTYPE                          
      AND L.CLTCODE <> @FCODE                          
      AND L.VTYP <> 18                          
    END        
   ELSE        
    BEGIN        
     PRINT 'CAME HERE - II'        
     INSERT INTO TBL_OPPBALANCE                                  
     SELECT         
      CLTCODE,         
      SUM(OPBAL) AS OPBAL,        
      SPID ,         
      CURDATE         
     FROM                            
      (SELECT         
       L2.CLTCODE,        
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE        
      FROM         
       LEDGER L, LEDGER2 L2        
      WHERE         
       L.VNO = L2.VNO        
       AND L.VTYP = L2.VTYPE        
       AND L.BOOKTYPE = L2.BOOKTYPE        
       AND L.LNO = L2.LNO        
     AND L.CLTCODE = L2.CLTCODE        
       AND L2.CLTCODE = @FCODE         
       AND L2.COSTCODE = @@COSTCODE        
       AND L.VTYP = 18         
       AND L.VDT LIKE @@STARTDATE + '%'        
      GROUP BY         
       L2.CLTCODE         
           
      UNION ALL        
           
      SELECT         
       L2.CLTCODE,        
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
      FROM         
       LEDGER L, LEDGER2 L2        
      WHERE         
       L.VNO = L2.VNO        
       AND L.VTYP = L2.VTYPE        
       AND L.BOOKTYPE = L2.BOOKTYPE        
       AND L.LNO = L2.LNO        
       AND L.CLTCODE = L2.CLTCODE        
       AND L2.CLTCODE = @FCODE         
       AND L2.COSTCODE = @@COSTCODE        
       AND L.VDT >= @@STARTDATE         
       AND L.VDT <  @FDATE         
       AND L2.VTYPE <> 18                            
      GROUP BY         
       L2.CLTCODE) A        
     GROUP BY         
      CLTCODE,         
      SPID,         
      CURDATE        
         
     INSERT INTO #TBL_GLREPORT                          
     SELECT         
      L.BOOKTYPE,                             
      VOUDT=CONVERT(VARCHAR,L.VDT,103),         
      EFFDT=CONVERT(VARCHAR,L.EDT,103),         
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                      
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                    
      L.VNO,         
      REPLACE( L.NARRATION,'"','') NARRATION,                                                       
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
      L2.CLTCODE ,        
      A.LONGNAME,        
      VDT,         
      L.VTYP,                                                                      
      ACCAT,         
      OPBAL=0,        
      CROSAC='',        
      A.ACNAME,        
      A.BRANCHCODE,      
      L.LNO,        
      @@SPID,         
      CONVERT(VARCHAR,GETDATE(),112), '',         
      L.VDT,  
      EDIFF = DATEDIFF(D, L.EDT, GETDATE())                          
     FROM         
      LEDGER L           
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
      VMAST V, ACMAST A, LEDGER2 L2                          
     WHERE         
      L.VNO = L1.VNO                          
      AND L.VTYP = L1.VTYP                          
      AND L.BOOKTYPE = L1.BOOKTYPE                          
      AND L.VNO = L2.VNO        
      AND L.VTYP = L2.VTYPE         
      AND L.BOOKTYPE = L2.BOOKTYPE        
      AND L.LNO = L2.LNO        
 --     AND L.DRCR = L2.DRCR        
      AND L.VNO = LL.VNO                          
      AND L.VTYP = LL.VTYP                          
      AND L.BOOKTYPE = LL.BOOKTYPE                          
      AND L2.CLTCODE = A.CLTCODE                          
      AND L.VTYP = V.VTYPE                          
      AND L.CLTCODE <> @FCODE                          
      AND L2.COSTCODE = @@COSTCODE        
      AND L.VTYP <> 18          
         
    END        
  END        
 ELSE        
  BEGIN        
   INSERT INTO TBL_OPPBALANCE                                  
   SELECT         
    CLTCODE,         
    SUM(OPBAL) AS OPBAL,        
    SPID ,         
    CURDATE         
   FROM                            
    (SELECT         
     L2.CLTCODE,        
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
     @@SPID AS SPID,         
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE        
    FROM         
     LEDGER L, LEDGER2 L2        
    WHERE         
     L.VNO = L2.VNO        
    AND L.VTYP = L2.VTYPE        
     AND L.BOOKTYPE = L2.BOOKTYPE        
     AND L.LNO = L2.LNO        
     AND L.CLTCODE = L2.CLTCODE        
     AND L2.CLTCODE = @FCODE         
     AND L2.COSTCODE = @@COSTCODE        
     AND L.VTYP = 18         
     AND L.VDT LIKE @@STARTDATE + '%'        
    GROUP BY         
     L2.CLTCODE         
         
    UNION ALL        
         
    SELECT         
     L2.CLTCODE,        
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
     @@SPID AS SPID,         
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
    FROM         
     LEDGER L, LEDGER2 L2        
   WHERE         
     L.VNO = L2.VNO        
     AND L.VTYP = L2.VTYPE        
     AND L.BOOKTYPE = L2.BOOKTYPE        
     AND L.LNO = L2.LNO        
     AND L.CLTCODE = L2.CLTCODE        
     AND L2.CLTCODE = @FCODE         
     AND L2.COSTCODE = @@COSTCODE        
     AND L.VDT >= @@STARTDATE         
     AND L.VDT <  @FDATE         
     AND L2.VTYPE <> 18                            
    GROUP BY         
     L2.CLTCODE) A        
   GROUP BY         
    CLTCODE,         
    SPID,         
    CURDATE        
         
     INSERT INTO #TBL_GLREPORT                          
     SELECT         
      L.BOOKTYPE,                             
      VOUDT=CONVERT(VARCHAR,L.VDT,103),         
      EFFDT=CONVERT(VARCHAR,L.EDT,103),           
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                      
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                    
      L.VNO,         
      REPLACE( L.NARRATION,'"','') NARRATION,                                                       
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
      L.CLTCODE ,        
      A.LONGNAME,        
      VDT,         
      L.VTYP,                                                                      
      ACCAT,         
      OPBAL=0,        
      CROSAC='',        
      A.ACNAME,        
      A.BRANCHCODE,      
      L.LNO,        
      @@SPID,         
      CONVERT(VARCHAR,GETDATE(),112), '',         
      L.VDT,  
   EDIFF = DATEDIFF(D, L.EDT, GETDATE())                         
     FROM         
      LEDGER L           
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
      VMAST V, ACMAST A, LEDGER2 L2                          
     WHERE         
      L.VNO = L1.VNO                          
      AND L.VTYP = L1.VTYP                          
      AND L.BOOKTYPE = L1.BOOKTYPE                          
      AND L.VNO = L2.VNO        
      AND L.VTYP = L2.VTYPE         
      AND L.BOOKTYPE = L2.BOOKTYPE        
      AND L.LNO = L2.LNO        
 --     AND L.DRCR = L2.DRCR        
      AND L.VNO = LL.VNO                          
      AND L.VTYP = LL.VTYP                          
      AND L.BOOKTYPE = LL.BOOKTYPE                          
      AND L.CLTCODE = A.CLTCODE                          
      AND L.VTYP = V.VTYPE                          
      AND L.CLTCODE <> @FCODE                          
      AND L2.COSTCODE = @@COSTCODE        
      AND L.VTYP <> 18          
  END        
END        
ELSE        
BEGIN        
 IF @STATUSID = 'BROKER'        
  BEGIN                            
   IF @BRANCH = '' OR @BRANCH = '%'        
    BEGIN        
     PRINT 'CAME HERE - I'        
     INSERT INTO TBL_OPPBALANCE                                  
     SELECT         
      CLTCODE,         
      SUM(OPBAL) AS OPBAL,        
      SPID ,         
      CURDATE         
     FROM                            
      (SELECT         
       CLTCODE,        
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                                 
      FROM         
       LEDGER                                
      WHERE         
       CLTCODE = @FCODE         
       AND VTYP = 18         
       AND EDT LIKE @@STARTDATE + '%'        
      GROUP BY         
       CLTCODE        
      UNION ALL                            
      SELECT         
       CLTCODE,        
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
      FROM         
       LEDGER                                  
   WHERE         
       CLTCODE = @FCODE         
       AND EDT >= @@STARTDATE         
       AND EDT <  @FDATE                            
       AND VTYP <> 18                            
      GROUP BY         
       CLTCODE        
      UNION ALL                            
      SELECT         
       CLTCODE,        
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
      FROM         
       LEDGER                                  
      WHERE         
       CLTCODE = @FCODE         
       AND VDT < @@STARTDATE         
       AND EDT >= @@STARTDATE         
       AND VTYP <> 18                            
      GROUP BY         
       CLTCODE) A        
     GROUP BY         
      CLTCODE,         
      SPID,         
      CURDATE         
         
                             
     INSERT INTO #TBL_GLREPORT                          
     SELECT         
      L.BOOKTYPE,                             
      VOUDT=CONVERT(VARCHAR,L.VDT,103),         
      EFFDT=CONVERT(VARCHAR,L.EDT,103),         
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                      
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                    
      L.VNO,         
      REPLACE( L.NARRATION,'"','') NARRATION,                                                       
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
      L.CLTCODE ,        
      A.LONGNAME,        
      VDT,         
      L.VTYP,                                                                      
      ACCAT,         
      OPBAL=0,        
      CROSAC='',        
      A.ACNAME,        
      A.BRANCHCODE,       
      L.LNO,       
      @@SPID,         
      CONVERT(VARCHAR,GETDATE(),112), '',         
      L.VDT,  
   EDIFF = DATEDIFF(D, L.EDT, GETDATE())                            
     FROM         
      LEDGER L           
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
      VMAST V, ACMAST A                          
     WHERE         
      L.VNO = LL.VNO                          
      AND L.VTYP = LL.VTYP                          
      AND L.BOOKTYPE = LL.BOOKTYPE                          
      AND L.CLTCODE = A.CLTCODE                          
      AND L.VTYP = V.VTYPE                          
      AND L.CLTCODE <> @FCODE                          
      AND L.VTYP <> 18                          
    END        
   ELSE        
    BEGIN        
     PRINT 'CAME HERE - II'        
     INSERT INTO TBL_OPPBALANCE                                  
     SELECT         
      CLTCODE,         
      SUM(OPBAL) AS OPBAL,        
      SPID ,         
      CURDATE         
     FROM                            
      (SELECT         
       L2.CLTCODE,        
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE        
      FROM         
       LEDGER L, LEDGER2 L2        
      WHERE         
       L.VNO = L2.VNO        
       AND L.VTYP = L2.VTYPE        
       AND L.BOOKTYPE = L2.BOOKTYPE        
       AND L.LNO = L2.LNO        
       AND L.CLTCODE = L2.CLTCODE        
       AND L2.CLTCODE = @FCODE         
       AND L2.COSTCODE = @@COSTCODE        
       AND L.VTYP = 18         
       AND L.EDT LIKE @@STARTDATE + '%'        
      GROUP BY         
       L2.CLTCODE         
           
      UNION ALL        
            
      SELECT         
       L2.CLTCODE,        
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
      FROM         
       LEDGER L, LEDGER2 L2        
      WHERE         
       L.VNO = L2.VNO        
       AND L.VTYP = L2.VTYPE        
       AND L.BOOKTYPE = L2.BOOKTYPE        
       AND L.LNO = L2.LNO        
       AND L.CLTCODE = L2.CLTCODE        
       AND L2.CLTCODE = @FCODE         
       AND L2.COSTCODE = @@COSTCODE        
       AND L.EDT >= @@STARTDATE         
       AND L.EDT <  @FDATE         
       AND L2.VTYPE <> 18                            
      GROUP BY         
       L2.CLTCODE        
        
      UNION ALL        
           
      SELECT         
       L2.CLTCODE,        
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
       @@SPID AS SPID,         
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
      FROM         
       LEDGER L, LEDGER2 L2        
      WHERE         
       L.VNO = L2.VNO        
       AND L.VTYP = L2.VTYPE        
       AND L.BOOKTYPE = L2.BOOKTYPE        
       AND L.LNO = L2.LNO        
       AND L.CLTCODE = L2.CLTCODE        
       AND L2.CLTCODE = @FCODE         
       AND L2.COSTCODE = @@COSTCODE        
       AND L.EDT >= @@STARTDATE         
       AND L.VDT <  @@STARTDATE         
       AND L2.VTYPE <> 18                            
      GROUP BY         
       L2.CLTCODE) A        
     GROUP BY         
      CLTCODE,         
      SPID,         
      CURDATE        
         
     INSERT INTO #TBL_GLREPORT                          
     SELECT         
      L.BOOKTYPE,                             
      VOUDT=CONVERT(VARCHAR,L.VDT,103),         
      EFFDT=CONVERT(VARCHAR,L.EDT,103),         
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                      
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                    
      L.VNO,         
      REPLACE( L.NARRATION,'"','') NARRATION,                                                       
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
      L.CLTCODE ,        
      A.LONGNAME,        
      VDT,         
      L.VTYP,                                                                      
      ACCAT,         
      OPBAL=0,        
      CROSAC='',        
      A.ACNAME,        
      A.BRANCHCODE,       
      L.LNO,       
      @@SPID,         
      CONVERT(VARCHAR,GETDATE(),112), '',         
      L.VDT,  
   EDIFF = DATEDIFF(D, L.EDT, GETDATE())                            
     FROM         
      LEDGER L           
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
      VMAST V, ACMAST A, LEDGER2 L2                          
     WHERE         
      L.VNO = L2.VNO        
      AND L.VTYP = L2.VTYPE         
      AND L.BOOKTYPE = L2.BOOKTYPE        
      AND L.LNO = L2.LNO        
      AND L.VNO = LL.VNO                          
      AND L.VTYP = LL.VTYP                          
      AND L.BOOKTYPE = LL.BOOKTYPE                          
      AND L.CLTCODE = A.CLTCODE                          
      AND L.VTYP = V.VTYPE                          
      AND L.CLTCODE <> @FCODE                          
      AND L2.COSTCODE = @@COSTCODE        
      AND L.VTYP <> 18          
         
    END        
  END        
 ELSE        
  BEGIN        
   INSERT INTO TBL_OPPBALANCE                                  
   SELECT         
    CLTCODE,         
    SUM(OPBAL) AS OPBAL,        
    SPID ,         
    CURDATE         
   FROM                            
    (SELECT         
     L2.CLTCODE,        
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
     @@SPID AS SPID,         
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE        
    FROM         
     LEDGER L, LEDGER2 L2        
    WHERE         
     L.VNO = L2.VNO        
     AND L.VTYP = L2.VTYPE        
     AND L.BOOKTYPE = L2.BOOKTYPE        
     AND L.LNO = L2.LNO        
     AND L.CLTCODE = L2.CLTCODE        
     AND L2.CLTCODE = @FCODE         
     AND L2.COSTCODE = @@COSTCODE        
     AND L.VTYP = 18         
     AND L.EDT LIKE @@STARTDATE + '%'        
    GROUP BY         
     L2.CLTCODE         
         
    UNION ALL        
         
    SELECT         
     L2.CLTCODE,        
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
     @@SPID AS SPID,         
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
    FROM         
     LEDGER L, LEDGER2 L2        
    WHERE         
     L.VNO = L2.VNO        
     AND L.VTYP = L2.VTYPE        
     AND L.BOOKTYPE = L2.BOOKTYPE        
     AND L.LNO = L2.LNO        
     AND L.CLTCODE = L2.CLTCODE        
     AND L2.CLTCODE = @FCODE         
     AND L2.COSTCODE = @@COSTCODE        
     AND L.EDT >= @@STARTDATE         
     AND L.EDT <  @FDATE                            
     AND L2.VTYPE <> 18                            
    GROUP BY         
     L2.CLTCODE        
         
    UNION ALL        
         
    SELECT         
     L2.CLTCODE,        
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,        
     @@SPID AS SPID,         
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                            
    FROM         
     LEDGER L, LEDGER2 L2        
    WHERE         
     L.VNO = L2.VNO        
     AND L.VTYP = L2.VTYPE        
     AND L.BOOKTYPE = L2.BOOKTYPE        
     AND L.LNO = L2.LNO        
     AND L.CLTCODE = L2.CLTCODE        
     AND L2.CLTCODE = @FCODE         
     AND L2.COSTCODE = @@COSTCODE        
     AND L.EDT >= @@STARTDATE         
     AND L.VDT <  @@STARTDATE                 
     AND L2.VTYPE <> 18                            
    GROUP BY         
     L2.CLTCODE) A        
   GROUP BY         
    CLTCODE,         
    SPID,         
    CURDATE        
         
     INSERT INTO #TBL_GLREPORT                          
     SELECT         
      L.BOOKTYPE,                             
      VOUDT=CONVERT(VARCHAR,L.VDT,103),         
      EFFDT=CONVERT(VARCHAR,L.EDT,103),           
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                     
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                      
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                    
      L.VNO,         
      REPLACE( L.NARRATION,'"','') NARRATION,                                                       
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                           
      L.CLTCODE ,        
      A.LONGNAME,        
      VDT,         
      L.VTYP,                                                                      
      ACCAT,         
      OPBAL=0,        
      CROSAC='',        
      A.ACNAME,        
      A.BRANCHCODE,        
      L.LNO,      
      @@SPID,         
      CONVERT(VARCHAR,GETDATE(),112), '',         
      L.VDT,  
   EDIFF = DATEDIFF(D, L.EDT, GETDATE())                            
     FROM         
      LEDGER L           
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                            
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                          
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                          
      VMAST V, ACMAST A, LEDGER2 L2                          
     WHERE         
      L.VNO = L2.VNO        
      AND L.VTYP = L2.VTYPE         
      AND L.BOOKTYPE = L2.BOOKTYPE        
      AND L.LNO = L2.LNO        
      AND L.VNO = LL.VNO                          
      AND L.VTYP = LL.VTYP                          
      AND L.BOOKTYPE = LL.BOOKTYPE                          
      AND L.CLTCODE = A.CLTCODE                          
      AND L.VTYP = V.VTYPE                          
      AND L.CLTCODE <> @FCODE                          
      AND L2.COSTCODE = @@COSTCODE        
      AND L.VTYP <> 18          
  END        
END        
        
UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID                          
UPDATE #TBL_GLREPORT SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE                          
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID = #TBL_GLREPORT.PROCID                          
UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE WHERE PROCID = @@SPID                          
UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE WHERE PROCID = @@SPID                          
UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE AND #TBL_GLREPORT.PROCID = @@SPID                          
                      
INSERT INTO #TBL_GLREPORT SELECT '','','','',0,0,'','','',CLTCODE,'','',0,'',OPPBAL,CLTCODE,'','','',PROCID,REPDATE, '', '', 0                          
FROM TBL_OPPBALANCE WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT WHERE PROCID = @@SPID)                              
                  
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0                  
      
UPDATE #TBL_GLREPORT SET BRANCHCODE = COSTNAME FROM LEDGER2 L2, COSTMAST C      
WHERE #TBL_GLREPORT.VNO = L2.VNO AND #TBL_GLREPORT.VTYP = L2.VTYPE AND #TBL_GLREPORT.BOOKTYPE = L2.BOOKTYPE AND #TBL_GLREPORT.LNO = L2.LNO AND #TBL_GLREPORT.CROSAC = L2.CLTCODE      
AND L2.COSTCODE = C.COSTCODE      
                          
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                          
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                          
SELECT         
      BOOKTYPE,        
      VOUDT VDT ,        
      EFFDT EDT ,        
      SHORTDESC,        
      DRAMT DEBIT,        
      CRAMT CREDIT,        
      VNO,        
      NARRATION,        
      DDNO,        
      CLTCODE,         
      LONGNAME,        
      VTYP,        
      ACCAT,        
      OPBAL,        
      CROSAC,        
      ACNAME,        
      BRANCHCODE,      
   VCHDT,  
   EDIFF  
FROM        
      #TBL_GLREPORT          
WHERE         
      PROCID = @@SPID                          
ORDER BY         
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_BANKBOOK_NEW_01102011
-- --------------------------------------------------
   /*  
SELECT * FROM LEDGER WHERE VNO = '200600000021' AND VTYP = 3  
SELECT * FROM LEDGER2 WHERE VNO = '200600000021' AND VTYPE = 3  
EXEC RPT_ACC_BANKBOOK_NEW 'JAN 1 2007', 'FEB 1 2007', '01/04/2006', 'BANK01', 'BROKER', 'GOG', '%', 'VDT'   
*/  
  
 --SELECT DISTINCT L.CLTCODE, A.BRANCHCODE FROM LEDGER L, ACMAST A WHERE L.CLTCODE = A.CLTCODE AND L.VDT >= 'APR  1 2005' AND A.ACCAT = 2    
    
--EXEC RPT_ACC_BANKBOOK_NEW 'APR  1 2005', 'MAR 11 2006', '01/04/2005', 'BANK01', 'BROKER', 'GOG', '%'    
    
 /****** OBJECT:  STORED PROCEDURE DBO.RPT_ACC_BANKBOOK_NEW    SCRIPT DATE: 07/08/2005 3:55:36 PM ******/            
--EXEC RPT_ACC_BANKBOOK_NEW 'APR  1 2005', 'JUL  5 2005', '01/04/2005', '33117', 'BROKER', 'BROKER', '%'               
--EXEC RPT_ACC_BANKBOOK_NEW '01/04/2005', '31/03/2006', 'JUN  1 2005', 'JUN 29 2005', '33117', '33117', 'BROKER', 'BROKER', '%','VOUCHERDATE', 'ACCOUNT', 'VDT', 'BANK BOOK',''                    
--EXEC RPT_ACC_BANKBOOK_NEW 'JUN  1 2005', 'JUN  1 2005', '01/04/2005', '711129', 'BROKER', 'BROKER', '%'                      
--EXEC RPT_ACC_BANKBOOK_NEW_BR 'APR  1 2005', 'MAR 31 2006', 'APR  1 2005', 'BANK01', 'BROKER', 'BROKER', 'TR001'    
CREATE   PROC [DBO].[RPT_ACC_BANKBOOK_NEW_01102011]    
--EXEC RPT_ACC_BANKBOOK_NEW 'MAY  2 2005', 'MAY  2 2005', 'APR  1 2005', '711129', 'BROKER', 'BROKER', '%'                      
      @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                        
      @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                        
      @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                        
      @FCODE VARCHAR(10),                        
      @STATUSID VARCHAR(30),                        
      @STATUSNAME VARCHAR(30),                        
      @BRANCH VARCHAR(10),    
      @SELECTIONBY VARCHAR(3) = 'VDT'                         
                        
AS                        
                        
DECLARE                        
 @@OPENDATE AS VARCHAR(11),                        
 @@REPDATE AS VARCHAR(8),                        
 @@STARTDATE AS VARCHAR(11),     
 @@COSTCODE AS SMALLINT    
    
    
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
                      
CREATE TABLE [DBO].[#TBL_GLREPORT] (                      
 [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                      
 [BOOKTYPE] [CHAR] (2) NULL ,                      
 [VOUDT] [VARCHAR] (10) NULL ,                      
 [EFFDT] [VARCHAR] (10) NULL ,                      
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                      
 [DRAMT] [MONEY] NULL ,                      
 [CRAMT] [MONEY] NULL ,                      
 [VNO] [VARCHAR] (12) NULL ,                      
 [NARRATION] [VARCHAR] (500) NULL ,                      
 [DDNO] [VARCHAR] (15) NULL ,                      
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                      
 [LONGNAME] [VARCHAR] (100) NULL ,                      
 [VDT] [DATETIME] NULL ,                      
 [VTYP] [SMALLINT] NOT NULL ,                      
 [ACCAT] [CHAR] (2) NULL ,                      
 [OPBAL] [MONEY] NOT NULL ,                      
 [CROSAC] [VARCHAR] (10) NOT NULL ,                      
 [ACNAME] [VARCHAR] (100) NULL ,                      
 [BRANCHCODE] [VARCHAR] (35) NULL ,                      
 [LNO] [INT] NULL,  
 [PROCID] [BIGINT] NULL ,                      
 [REPDATE] [VARCHAR] (8) NULL ,                      
 [MAINCODE] [VARCHAR] (10) NULL ,                      
 [VCHDT] [DATETIME] NULL                      
)                      
                      
                        
--DELETE #TBL_GLREPORT WHERE PROCID = @@SPID                                      
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID    
    
SELECT @@COSTCODE = -1    
    
IF @STATUSID <> 'BROKER'    
 BEGIN    
  SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME     
 END    
ELSE IF @STATUSID = 'BROKER'    
 BEGIN    
  IF @BRANCH <> '' OR @BRANCH <> '%'    
   BEGIN    
    SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH     
   END    
 END    
  
SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)                        
    
IF @SELECTIONBY = 'VDT'     
BEGIN    
 IF @STATUSID = 'BROKER'    
  BEGIN                        
   IF @BRANCH = '' OR @BRANCH = '%'    
    BEGIN    
     PRINT 'CAME HERE - I'    
     INSERT INTO TBL_OPPBALANCE     
     SELECT     
      CLTCODE,     
      SUM(OPBAL) AS OPBAL,    
      SPID ,     
      CURDATE     
     FROM                        
      (SELECT     
       CLTCODE,    
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                             
      FROM     
       LEDGER                            
      WHERE     
       CLTCODE = @FCODE     
       AND VTYP = 18     
       AND VDT LIKE @@STARTDATE + '%'    
      GROUP BY     
       CLTCODE    
      UNION ALL                        
      SELECT     
       CLTCODE,    
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
      FROM     
       LEDGER                              
      WHERE     
       CLTCODE = @FCODE     
       AND VDT >= @@STARTDATE     
       AND VDT <  @FDATE                        
       AND VTYP <> 18                        
      GROUP BY     
       CLTCODE) A    
     GROUP BY     
      CLTCODE,     
      SPID,     
      CURDATE    
     
                         
     INSERT INTO #TBL_GLREPORT                      
     SELECT     
      L.BOOKTYPE,                         
      VOUDT=CONVERT(VARCHAR,L.VDT,103),     
      EFFDT=CONVERT(VARCHAR,L.EDT,103),     
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                 
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                  
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                
      L.VNO,     
      REPLACE( L.NARRATION,'"','') NARRATION,                                                   
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                       
      L.CLTCODE ,    
      A.LONGNAME,    
      VDT,     
      L.VTYP,                                                                  
      ACCAT,     
      OPBAL=0,    
      CROSAC='',    
      A.ACNAME,    
      A.BRANCHCODE,  
      L.LNO,    
      @@SPID,     
      CONVERT(VARCHAR,GETDATE(),112), '',     
      L.VDT                      
     FROM     
      LEDGER L       
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                        
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                      
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                      
      VMAST V, ACMAST A                      
     WHERE     
      L.VNO = L1.VNO                      
      AND L.VTYP = L1.VTYP                      
      AND L.BOOKTYPE = L1.BOOKTYPE                      
      AND L.VNO = LL.VNO                      
      AND L.VTYP = LL.VTYP                      
      AND L.BOOKTYPE = LL.BOOKTYPE                      
      AND L.CLTCODE = A.CLTCODE                      
      AND L.VTYP = V.VTYPE                      
      AND L.CLTCODE <> @FCODE                      
      AND L.VTYP <> 18                      
    END    
   ELSE    
    BEGIN    
     PRINT 'CAME HERE - II'    
     INSERT INTO TBL_OPPBALANCE                              
     SELECT     
      CLTCODE,     
      SUM(OPBAL) AS OPBAL,    
      SPID ,     
      CURDATE     
     FROM                        
      (SELECT     
       L2.CLTCODE,    
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE    
      FROM     
       LEDGER L, LEDGER2 L2    
      WHERE     
       L.VNO = L2.VNO    
       AND L.VTYP = L2.VTYPE    
       AND L.BOOKTYPE = L2.BOOKTYPE    
       AND L.LNO = L2.LNO    
       AND L.CLTCODE = L2.CLTCODE    
       AND L2.CLTCODE = @FCODE     
       AND L2.COSTCODE = @@COSTCODE    
       AND L.VTYP = 18     
       AND L.VDT LIKE @@STARTDATE + '%'    
      GROUP BY     
       L2.CLTCODE     
       
      UNION ALL    
       
      SELECT     
       L2.CLTCODE,    
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
      FROM     
       LEDGER L, LEDGER2 L2    
      WHERE     
       L.VNO = L2.VNO    
       AND L.VTYP = L2.VTYPE    
       AND L.BOOKTYPE = L2.BOOKTYPE    
       AND L.LNO = L2.LNO    
       AND L.CLTCODE = L2.CLTCODE    
       AND L2.CLTCODE = @FCODE     
       AND L2.COSTCODE = @@COSTCODE    
       AND L.VDT >= @@STARTDATE     
       AND L.VDT <  @FDATE     
       AND L2.VTYPE <> 18                        
      GROUP BY     
       L2.CLTCODE) A    
     GROUP BY     
      CLTCODE,     
      SPID,     
      CURDATE    
     
     INSERT INTO #TBL_GLREPORT                      
     SELECT     
      L.BOOKTYPE,                         
      VOUDT=CONVERT(VARCHAR,L.VDT,103),     
      EFFDT=CONVERT(VARCHAR,L.EDT,103),     
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                 
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                  
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                
      L.VNO,     
      REPLACE( L.NARRATION,'"','') NARRATION,                                                   
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                       
      L2.CLTCODE ,    
      A.LONGNAME,    
      VDT,     
      L.VTYP,                                                                  
      ACCAT,     
      OPBAL=0,    
      CROSAC='',    
      A.ACNAME,    
      A.BRANCHCODE,  
      L.LNO,    
      @@SPID,     
      CONVERT(VARCHAR,GETDATE(),112), '',     
      L.VDT                      
     FROM     
      LEDGER L       
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                        
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                      
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                      
      VMAST V, ACMAST A, LEDGER2 L2                      
     WHERE     
      L.VNO = L1.VNO                      
      AND L.VTYP = L1.VTYP                      
      AND L.BOOKTYPE = L1.BOOKTYPE                      
      AND L.VNO = L2.VNO    
      AND L.VTYP = L2.VTYPE     
      AND L.BOOKTYPE = L2.BOOKTYPE    
      AND L.LNO = L2.LNO    
 --     AND L.DRCR = L2.DRCR    
      AND L.VNO = LL.VNO                      
      AND L.VTYP = LL.VTYP                      
      AND L.BOOKTYPE = LL.BOOKTYPE                      
      AND L2.CLTCODE = A.CLTCODE                      
      AND L.VTYP = V.VTYPE                      
      AND L.CLTCODE <> @FCODE                      
      AND L2.COSTCODE = @@COSTCODE    
      AND L.VTYP <> 18      
     
    END    
  END    
 ELSE    
  BEGIN    
   INSERT INTO TBL_OPPBALANCE                              
   SELECT     
    CLTCODE,     
    SUM(OPBAL) AS OPBAL,    
    SPID ,     
    CURDATE     
   FROM                        
    (SELECT     
     L2.CLTCODE,    
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
     @@SPID AS SPID,     
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE    
    FROM     
     LEDGER L, LEDGER2 L2    
    WHERE     
     L.VNO = L2.VNO   
     AND L.VTYP = L2.VTYPE    
     AND L.BOOKTYPE = L2.BOOKTYPE    
     AND L.LNO = L2.LNO    
     AND L.CLTCODE = L2.CLTCODE    
     AND L2.CLTCODE = @FCODE     
     AND L2.COSTCODE = @@COSTCODE    
     AND L.VTYP = 18     
     AND L.VDT LIKE @@STARTDATE + '%'    
    GROUP BY     
     L2.CLTCODE     
     
    UNION ALL    
     
    SELECT     
     L2.CLTCODE,    
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
     @@SPID AS SPID,     
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
    FROM     
     LEDGER L, LEDGER2 L2    
    WHERE     
     L.VNO = L2.VNO    
     AND L.VTYP = L2.VTYPE    
     AND L.BOOKTYPE = L2.BOOKTYPE    
     AND L.LNO = L2.LNO    
     AND L.CLTCODE = L2.CLTCODE    
     AND L2.CLTCODE = @FCODE     
     AND L2.COSTCODE = @@COSTCODE    
     AND L.VDT >= @@STARTDATE     
     AND L.VDT <  @FDATE     
     AND L2.VTYPE <> 18                        
    GROUP BY     
     L2.CLTCODE) A    
   GROUP BY     
    CLTCODE,     
    SPID,     
    CURDATE    
     
     INSERT INTO #TBL_GLREPORT                      
     SELECT     
      L.BOOKTYPE,                         
      VOUDT=CONVERT(VARCHAR,L.VDT,103),     
      EFFDT=CONVERT(VARCHAR,L.EDT,103),       
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                 
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                  
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                
      L.VNO,     
      REPLACE( L.NARRATION,'"','') NARRATION,                                                   
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                       
      L.CLTCODE ,    
      A.LONGNAME,    
      VDT,     
      L.VTYP,                                                                  
      ACCAT,     
      OPBAL=0,    
      CROSAC='',    
      A.ACNAME,    
      A.BRANCHCODE,  
      L.LNO,    
      @@SPID,     
      CONVERT(VARCHAR,GETDATE(),112), '',     
      L.VDT                      
     FROM     
      LEDGER L       
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                        
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                      
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                      
      VMAST V, ACMAST A, LEDGER2 L2                      
     WHERE     
      L.VNO = L1.VNO                      
      AND L.VTYP = L1.VTYP                      
      AND L.BOOKTYPE = L1.BOOKTYPE                      
      AND L.VNO = L2.VNO    
      AND L.VTYP = L2.VTYPE     
      AND L.BOOKTYPE = L2.BOOKTYPE    
      AND L.LNO = L2.LNO    
 --     AND L.DRCR = L2.DRCR    
      AND L.VNO = LL.VNO                      
      AND L.VTYP = LL.VTYP                      
      AND L.BOOKTYPE = LL.BOOKTYPE                      
      AND L.CLTCODE = A.CLTCODE                      
      AND L.VTYP = V.VTYPE                      
      AND L.CLTCODE <> @FCODE                      
      AND L2.COSTCODE = @@COSTCODE    
      AND L.VTYP <> 18      
  END    
END    
ELSE    
BEGIN    
 IF @STATUSID = 'BROKER'    
  BEGIN                        
   IF @BRANCH = '' OR @BRANCH = '%'    
    BEGIN    
     PRINT 'CAME HERE - I'    
     INSERT INTO TBL_OPPBALANCE                              
     SELECT     
      CLTCODE,     
      SUM(OPBAL) AS OPBAL,    
      SPID ,     
      CURDATE     
     FROM                        
      (SELECT     
       CLTCODE,    
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                             
      FROM     
       LEDGER                            
      WHERE     
       CLTCODE = @FCODE     
       AND VTYP = 18     
 AND EDT LIKE @@STARTDATE + '%'    
      GROUP BY     
       CLTCODE    
      UNION ALL                        
      SELECT     
       CLTCODE,    
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
      FROM     
       LEDGER                              
      WHERE     
       CLTCODE = @FCODE     
       AND EDT >= @@STARTDATE     
       AND EDT <  @FDATE                        
       AND VTYP <> 18                        
      GROUP BY     
       CLTCODE    
      UNION ALL                        
      SELECT     
       CLTCODE,    
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
      FROM     
       LEDGER                              
      WHERE     
       CLTCODE = @FCODE     
       AND VDT < @@STARTDATE     
       AND EDT >= @@STARTDATE     
       AND VTYP <> 18                        
      GROUP BY     
       CLTCODE) A    
     GROUP BY     
      CLTCODE,     
      SPID,     
      CURDATE     
     
                         
     INSERT INTO #TBL_GLREPORT                      
     SELECT     
      L.BOOKTYPE,                         
      VOUDT=CONVERT(VARCHAR,L.VDT,103),     
      EFFDT=CONVERT(VARCHAR,L.EDT,103),     
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                 
      DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                  
      CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                
      L.VNO,     
      REPLACE( L.NARRATION,'"','') NARRATION,                                                   
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                       
      L.CLTCODE ,    
      A.LONGNAME,    
      VDT,     
      L.VTYP,                                                                  
      ACCAT,     
      OPBAL=0,    
      CROSAC='',    
      A.ACNAME,    
      A.BRANCHCODE,   
      L.LNO,   
      @@SPID,     
      CONVERT(VARCHAR,GETDATE(),112), '',     
      L.VDT                      
     FROM     
      LEDGER L       
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                        
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                      
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                      
      VMAST V, ACMAST A                      
     WHERE     
      L.VNO = LL.VNO                      
      AND L.VTYP = LL.VTYP                      
      AND L.BOOKTYPE = LL.BOOKTYPE                      
      AND L.CLTCODE = A.CLTCODE                      
      AND L.VTYP = V.VTYPE                      
      AND L.CLTCODE <> @FCODE                      
      AND L.VTYP <> 18                      
    END    
   ELSE    
    BEGIN    
     PRINT 'CAME HERE - II'    
     INSERT INTO TBL_OPPBALANCE                              
     SELECT     
      CLTCODE,     
      SUM(OPBAL) AS OPBAL,    
      SPID ,     
      CURDATE     
     FROM                        
      (SELECT     
       L2.CLTCODE,    
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE    
      FROM     
       LEDGER L, LEDGER2 L2    
      WHERE     
       L.VNO = L2.VNO    
       AND L.VTYP = L2.VTYPE    
       AND L.BOOKTYPE = L2.BOOKTYPE    
       AND L.LNO = L2.LNO    
       AND L.CLTCODE = L2.CLTCODE    
       AND L2.CLTCODE = @FCODE     
       AND L2.COSTCODE = @@COSTCODE    
       AND L.VTYP = 18     
       AND L.EDT LIKE @@STARTDATE + '%'    
      GROUP BY     
       L2.CLTCODE     
       
      UNION ALL    
       
      SELECT     
       L2.CLTCODE,    
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
      FROM     
       LEDGER L, LEDGER2 L2    
      WHERE     
       L.VNO = L2.VNO    
       AND L.VTYP = L2.VTYPE    
       AND L.BOOKTYPE = L2.BOOKTYPE    
       AND L.LNO = L2.LNO    
       AND L.CLTCODE = L2.CLTCODE    
       AND L2.CLTCODE = @FCODE     
       AND L2.COSTCODE = @@COSTCODE    
       AND L.EDT >= @@STARTDATE     
       AND L.EDT <  @FDATE     
       AND L2.VTYPE <> 18                        
      GROUP BY     
       L2.CLTCODE    
    
      UNION ALL    
       
      SELECT     
       L2.CLTCODE,    
       SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
       @@SPID AS SPID,     
       CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
      FROM     
       LEDGER L, LEDGER2 L2    
      WHERE     
       L.VNO = L2.VNO    
       AND L.VTYP = L2.VTYPE    
       AND L.BOOKTYPE = L2.BOOKTYPE    
       AND L.LNO = L2.LNO    
       AND L.CLTCODE = L2.CLTCODE    
       AND L2.CLTCODE = @FCODE     
       AND L2.COSTCODE = @@COSTCODE    
       AND L.EDT >= @@STARTDATE     
       AND L.VDT <  @@STARTDATE     
       AND L2.VTYPE <> 18                        
      GROUP BY     
       L2.CLTCODE) A    
     GROUP BY     
      CLTCODE,     
      SPID,     
      CURDATE    
     
     INSERT INTO #TBL_GLREPORT                      
     SELECT     
      L.BOOKTYPE,                         
      VOUDT=CONVERT(VARCHAR,L.VDT,103),     
      EFFDT=CONVERT(VARCHAR,L.EDT,103),     
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                 
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                  
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                
      L.VNO,     
      REPLACE( L.NARRATION,'"','') NARRATION,                                                   
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                       
      L.CLTCODE ,    
      A.LONGNAME,    
      VDT,     
      L.VTYP,                                                                  
      ACCAT,     
      OPBAL=0,    
      CROSAC='',    
      A.ACNAME,    
      A.BRANCHCODE,   
      L.LNO,   
      @@SPID,     
      CONVERT(VARCHAR,GETDATE(),112), '',     
      L.VDT                      
     FROM     
      LEDGER L       
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                        
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                      
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                      
      VMAST V, ACMAST A, LEDGER2 L2                      
     WHERE     
      L.VNO = L2.VNO    
      AND L.VTYP = L2.VTYPE     
      AND L.BOOKTYPE = L2.BOOKTYPE    
      AND L.LNO = L2.LNO    
      AND L.VNO = LL.VNO                      
      AND L.VTYP = LL.VTYP                      
      AND L.BOOKTYPE = LL.BOOKTYPE                      
      AND L.CLTCODE = A.CLTCODE                      
      AND L.VTYP = V.VTYPE                      
      AND L.CLTCODE <> @FCODE                      
      AND L2.COSTCODE = @@COSTCODE    
      AND L.VTYP <> 18      
     
    END    
  END    
 ELSE    
  BEGIN    
   INSERT INTO TBL_OPPBALANCE                              
   SELECT     
    CLTCODE,     
    SUM(OPBAL) AS OPBAL,    
    SPID ,     
    CURDATE     
   FROM                        
    (SELECT     
     L2.CLTCODE,    
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
     @@SPID AS SPID,     
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE    
    FROM     
     LEDGER L, LEDGER2 L2    
    WHERE     
     L.VNO = L2.VNO    
     AND L.VTYP = L2.VTYPE    
     AND L.BOOKTYPE = L2.BOOKTYPE    
     AND L.LNO = L2.LNO    
     AND L.CLTCODE = L2.CLTCODE    
     AND L2.CLTCODE = @FCODE     
     AND L2.COSTCODE = @@COSTCODE    
     AND L.VTYP = 18     
     AND L.EDT LIKE @@STARTDATE + '%'    
    GROUP BY     
     L2.CLTCODE     
     
    UNION ALL    
     
    SELECT     
     L2.CLTCODE,    
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
     @@SPID AS SPID,     
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
    FROM     
     LEDGER L, LEDGER2 L2    
    WHERE     
     L.VNO = L2.VNO    
     AND L.VTYP = L2.VTYPE    
     AND L.BOOKTYPE = L2.BOOKTYPE    
     AND L.LNO = L2.LNO    
     AND L.CLTCODE = L2.CLTCODE    
     AND L2.CLTCODE = @FCODE     
     AND L2.COSTCODE = @@COSTCODE    
     AND L.EDT >= @@STARTDATE     
     AND L.EDT <  @FDATE                        
     AND L2.VTYPE <> 18                        
    GROUP BY     
     L2.CLTCODE    
     
    UNION ALL    
     
    SELECT     
     L2.CLTCODE,    
     SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,    
     @@SPID AS SPID,     
     CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                        
    FROM     
     LEDGER L, LEDGER2 L2    
    WHERE     
     L.VNO = L2.VNO    
     AND L.VTYP = L2.VTYPE    
     AND L.BOOKTYPE = L2.BOOKTYPE    
     AND L.LNO = L2.LNO    
     AND L.CLTCODE = L2.CLTCODE    
     AND L2.CLTCODE = @FCODE     
     AND L2.COSTCODE = @@COSTCODE    
     AND L.EDT >= @@STARTDATE     
     AND L.VDT <  @@STARTDATE             
     AND L2.VTYPE <> 18                        
    GROUP BY     
     L2.CLTCODE) A    
   GROUP BY     
    CLTCODE,     
    SPID,     
    CURDATE    
     
     INSERT INTO #TBL_GLREPORT                      
     SELECT     
      L.BOOKTYPE,                         
      VOUDT=CONVERT(VARCHAR,L.VDT,103),     
      EFFDT=CONVERT(VARCHAR,L.EDT,103),       
      ISNULL(SHORTDESC,'') SHORTDESC,                                                                 
      DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                  
      CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                
      L.VNO,     
      REPLACE( L.NARRATION,'"','') NARRATION,                                                   
      DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                       
      L.CLTCODE ,    
      A.LONGNAME,    
      VDT,     
      L.VTYP,                                                                  
      ACCAT,     
      OPBAL=0,    
      CROSAC='',    
      A.ACNAME,    
      A.BRANCHCODE,    
      L.LNO,  
      @@SPID,     
      CONVERT(VARCHAR,GETDATE(),112), '',     
      L.VDT                      
     FROM     
      LEDGER L       
      LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                        
      ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                      
      (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                      
      VMAST V, ACMAST A, LEDGER2 L2                      
     WHERE     
      L.VNO = L2.VNO    
      AND L.VTYP = L2.VTYPE     
      AND L.BOOKTYPE = L2.BOOKTYPE    
      AND L.LNO = L2.LNO    
      AND L.VNO = LL.VNO                      
      AND L.VTYP = LL.VTYP                      
      AND L.BOOKTYPE = LL.BOOKTYPE                      
      AND L.CLTCODE = A.CLTCODE                      
      AND L.VTYP = V.VTYPE                      
      AND L.CLTCODE <> @FCODE                      
      AND L2.COSTCODE = @@COSTCODE    
      AND L.VTYP <> 18      
  END    
END    
    
UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID                      
UPDATE #TBL_GLREPORT SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE                      
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID = #TBL_GLREPORT.PROCID                      
UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE WHERE PROCID = @@SPID                      
UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE WHERE PROCID = @@SPID                      
UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE AND #TBL_GLREPORT.PROCID = @@SPID                      
                  
INSERT INTO #TBL_GLREPORT SELECT '','','','',0,0,'','','',CLTCODE,'','',0,'',OPPBAL,CLTCODE,'','','',PROCID,REPDATE, '', ''                      
FROM TBL_OPPBALANCE WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT WHERE PROCID = @@SPID)                          
              
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0              
  
UPDATE #TBL_GLREPORT SET BRANCHCODE = COSTNAME FROM LEDGER2 L2, COSTMAST C  
WHERE #TBL_GLREPORT.VNO = L2.VNO AND #TBL_GLREPORT.VTYP = L2.VTYPE AND #TBL_GLREPORT.BOOKTYPE = L2.BOOKTYPE AND #TBL_GLREPORT.LNO = L2.LNO AND #TBL_GLREPORT.CROSAC = L2.CLTCODE  
AND L2.COSTCODE = C.COSTCODE  
                      
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                      
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                      
SELECT     
      BOOKTYPE,    
      VOUDT VDT ,    
      EFFDT EDT ,    
      SHORTDESC,    
      DRAMT DEBIT,    
      CRAMT CREDIT,    
      VNO,    
      NARRATION,    
      DDNO,    
      CLTCODE,     
      LONGNAME,    
      VTYP,    
      ACCAT,    
      OPBAL,    
      CROSAC,    
      ACNAME,    
      BRANCHCODE,  
   VCHDT                      
FROM     
      #TBL_GLREPORT      
WHERE     
      PROCID = @@SPID                      
ORDER BY     
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_CASHBOOK_NEW
-- --------------------------------------------------
  
  
CREATE PROC [dbo].[RPT_ACC_CASHBOOK_NEW]          
  @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                              
  @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                              
  @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                              
  @FCODE VARCHAR(10),                              
  @STATUSID VARCHAR(30),                              
  @STATUSNAME VARCHAR(30),                              
  @BRANCH VARCHAR(10)                              
                              
AS                              
                              
DECLARE                              
 @@OPENDATE AS VARCHAR(11),                              
 @@REPDATE AS VARCHAR(8),                              
 @@STARTDATE AS VARCHAR(11),           
 @@COSTCODE AS SMALLINT          
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
                            
CREATE TABLE [DBO].[#TBL_GLREPORT] (                            
 [SRNO] [INT] IDENTITY (1, 1) NOT NULL ,                            
 [BOOKTYPE] [CHAR] (2) NULL ,                            
 [VOUDT] [VARCHAR] (10) NULL ,                            
 [EFFDT] [VARCHAR] (10) NULL ,                            
 [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' ') ,                            
 [DRAMT] [MONEY] NULL ,                            
 [CRAMT] [MONEY] NULL ,                            
 [VNO] [VARCHAR] (12) NULL ,                            
 [NARRATION] [VARCHAR] (500) NULL ,                            
 [DDNO] [VARCHAR] (15) NULL ,                            
 [CLTCODE] [VARCHAR] (10) NOT NULL ,                            
 [LONGNAME] [VARCHAR] (100) NULL ,                            
 [VDT] [DATETIME] NULL ,                            
 [VTYP] [SMALLINT] NOT NULL ,                            
 [ACCAT] [CHAR] (2) NULL ,                            
 [OPBAL] [MONEY] NOT NULL ,                            
 [CROSAC] [VARCHAR] (10) NOT NULL ,                            
 [ACNAME] [VARCHAR] (100) NULL ,                            
 [BRANCHCODE] [VARCHAR] (10) NULL ,                            
 [PROCID] [BIGINT] NULL ,                            
 [REPDATE] [VARCHAR] (8) NULL ,                            
 [MAINCODE] [VARCHAR] (10) NULL ,                            
 [VCHDT] [DATETIME] NULL                            
)                            
                            
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID          
          
SELECT @@COSTCODE = -1          
          
IF @STATUSID <> 'BROKER'          
 BEGIN          
  SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @STATUSNAME           
 END          
ELSE IF @STATUSID = 'BROKER'          
 BEGIN          
  IF @BRANCH <> '' OR @BRANCH <> '%'          
   BEGIN          
    SELECT TOP 1 @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = @BRANCH           
   END          
 END          
          
SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, @SDATE,103), 109), 11)                              
          
IF @STATUSID = 'BROKER'          
 BEGIN                              
  IF @BRANCH = '' OR @BRANCH = '%'          
   BEGIN          
    INSERT INTO TBL_OPPBALANCE                                    
    SELECT           
     CLTCODE,           
     SUM(OPBAL) AS OPBAL,          
     SPID ,           
     CURDATE           
    FROM                           
     (SELECT           
      CLTCODE,          
      SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,          
      @@SPID AS SPID,           
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                                   
     FROM           
      LEDGER                                  
     WHERE           
      CLTCODE = @FCODE           
      AND VTYP = 18           
      AND VDT LIKE @@STARTDATE + '%'          
     GROUP BY           
      CLTCODE          
     UNION ALL                              
     SELECT           
      CLTCODE,          
      SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL,          
  @@SPID AS SPID,           
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                              
     FROM           
      LEDGER                                    
     WHERE           
      CLTCODE = @FCODE           
      AND VDT >= @@STARTDATE           
      AND VDT <  @FDATE                              
      AND VTYP <> 18                              
     GROUP BY           
      CLTCODE) A          
    GROUP BY           
     CLTCODE,           
     SPID,           
     CURDATE          
          
                              
    INSERT INTO #TBL_GLREPORT                            
    SELECT           
     L.BOOKTYPE,                               
     VOUDT=CONVERT(VARCHAR,L.VDT,103),           
     EFFDT=CONVERT(VARCHAR,L.EDT,103),           
     ISNULL(SHORTDESC,'') SHORTDESC,                                                                       
     DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                                        
     CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                                      
     L.VNO,           
     REPLACE( L.NARRATION,'"','') NARRATION,                                                         
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                             
     L.CLTCODE ,          
     A.LONGNAME,          
     VDT,           
     L.VTYP,                                                                        
     ACCAT,           
     OPBAL=0,          
     CROSAC='',          
     A.ACNAME,          
     A.BRANCHCODE,          
     @@SPID,           
     CONVERT(VARCHAR,GETDATE(),112), '',           
     L.VDT                            
    FROM           
     LEDGER L             
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                              
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                            
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                            
     VMAST V, ACMAST A                            
    WHERE           
     L.VNO = LL.VNO                            
     AND L.VTYP = LL.VTYP                            
     AND L.BOOKTYPE = LL.BOOKTYPE                            
     AND L.CLTCODE = A.CLTCODE                            
     AND L.VTYP = V.VTYPE                            
     AND L.CLTCODE <> @FCODE                            
     AND L.VTYP <> 18                            
   END          
  ELSE          
   BEGIN          
    INSERT INTO TBL_OPPBALANCE                                    
    SELECT           
     CLTCODE,           
     SUM(OPBAL) AS OPBAL,          
     SPID ,           
     CURDATE           
    FROM                              
     (SELECT           
      L2.CLTCODE,          
      SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,          
      @@SPID AS SPID,           
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE          
     FROM           
      LEDGER L, LEDGER2 L2          
     WHERE           
      L.VNO = L2.VNO          
      AND L.VTYP = L2.VTYPE          
      AND L.BOOKTYPE = L2.BOOKTYPE          
      AND L.DRCR = L2.DRCR          
      AND L.CLTCODE = L2.CLTCODE          
      AND L2.CLTCODE = @FCODE           
      AND L2.COSTCODE = @@COSTCODE          
      AND L.VTYP = 18           
      AND L.VDT LIKE @@STARTDATE + '%'          
     GROUP BY           
      L2.CLTCODE           
            
     UNION ALL          
      
     SELECT           
      L2.CLTCODE,          
      SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,          
      @@SPID AS SPID,           
      CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                              
     FROM           
      LEDGER L, LEDGER2 L2          
 WHERE           
      L.VNO = L2.VNO          
      AND L.VTYP = L2.VTYPE          
      AND L.BOOKTYPE = L2.BOOKTYPE          
      AND L.DRCR = L2.DRCR          
      AND L.CLTCODE = L2.CLTCODE          
      AND L2.CLTCODE = @FCODE           
      AND L2.COSTCODE = @@COSTCODE          
      AND L.VDT >= @@STARTDATE           
      AND L.VDT <  @FDATE           
      AND L2.VTYPE <> 18                              
 GROUP BY           
      L2.CLTCODE) A          
    GROUP BY           
     CLTCODE,           
     SPID,           
     CURDATE          
      
    INSERT INTO #TBL_GLREPORT                            
    SELECT           
     L.BOOKTYPE,                               
     VOUDT=CONVERT(VARCHAR,L.VDT,103),           
     EFFDT=CONVERT(VARCHAR,L.EDT,103),           
     ISNULL(SHORTDESC,'') SHORTDESC,                                                                       
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                        
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                      
     L.VNO,           
     REPLACE( L.NARRATION,'"','') NARRATION,                                                         
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                             
     L.CLTCODE ,          
     A.LONGNAME,          
     VDT,           
     L.VTYP,                                                                        
     ACCAT,           
     OPBAL=0,          
     CROSAC='',          
     A.ACNAME,          
     A.BRANCHCODE,          
     @@SPID,           
     CONVERT(VARCHAR,GETDATE(),112), '',           
     L.VDT                            
    FROM           
     LEDGER L             
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                              
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                            
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                            
     VMAST V, ACMAST A, LEDGER2 L2                            
    WHERE           
      L.VNO = L2.VNO          
     AND L.VTYP = L2.VTYPE           
     AND L.BOOKTYPE = L2.BOOKTYPE          
     AND L.LNO = L2.LNO          
     AND L.DRCR = L2.DRCR          
     AND L.VNO = LL.VNO                            
     AND L.VTYP = LL.VTYP                            
     AND L.BOOKTYPE = LL.BOOKTYPE                            
     AND L.CLTCODE = A.CLTCODE                            
     AND L.VTYP = V.VTYPE                            
     AND L.CLTCODE <> @FCODE                            
     AND L2.COSTCODE = @@COSTCODE          
     AND L.VTYP <> 18          
          
   END          
 END          
ELSE          
 BEGIN          
  INSERT INTO TBL_OPPBALANCE                                    
  SELECT           
   CLTCODE,           
   SUM(OPBAL) AS OPBAL,          
   SPID ,           
   CURDATE           
  FROM                              
   (SELECT           
    L2.CLTCODE,          
    SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,          
    @@SPID AS SPID,           
    CONVERT(VARCHAR,GETDATE(),112) AS CURDATE          
   FROM           
    LEDGER L, LEDGER2 L2          
   WHERE           
    L.VNO = L2.VNO          
    AND L.VTYP = L2.VTYPE          
    AND L.BOOKTYPE = L2.BOOKTYPE          
    AND L.DRCR = L2.DRCR          
    AND L.CLTCODE = L2.CLTCODE          
    AND L2.CLTCODE = @FCODE           
    AND L2.COSTCODE = @@COSTCODE          
    AND L.VTYP = 18           
    AND L.VDT LIKE @@STARTDATE + '%'          
   GROUP BY           
    L2.CLTCODE           
          
   UNION ALL          
          
   SELECT           
    L2.CLTCODE,          
    SUM(CASE L2.DRCR WHEN 'D' THEN L2.CAMT ELSE -L2.CAMT END) AS OPBAL,          
    @@SPID AS SPID,           
    CONVERT(VARCHAR,GETDATE(),112) AS CURDATE                              
   FROM           
    LEDGER L, LEDGER2 L2          
   WHERE           
    L.VNO = L2.VNO          
    AND L.VTYP = L2.VTYPE          
    AND L.BOOKTYPE = L2.BOOKTYPE          
    AND L.DRCR = L2.DRCR          
    AND L.CLTCODE = L2.CLTCODE          
    AND L2.CLTCODE = @FCODE           
    AND L2.COSTCODE = @@COSTCODE          
    AND L.VDT >= @@STARTDATE           
    AND L.VDT <  @FDATE                              
    AND L2.VTYPE <> 18                              
   GROUP BY           
    L2.CLTCODE) A          
  GROUP BY           
   CLTCODE,           
   SPID,           
   CURDATE          
          
    INSERT INTO #TBL_GLREPORT                            
    SELECT           
     L.BOOKTYPE,                               
     VOUDT=CONVERT(VARCHAR,L.VDT,103),           
     EFFDT=CONVERT(VARCHAR,L.EDT,103),        ISNULL(SHORTDESC,'') SHORTDESC,                                                                       
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                                                                        
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                                      
     L.VNO,           
     REPLACE( L.NARRATION,'"','') NARRATION,                                                         
     DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                                             
     L.CLTCODE ,          
     A.LONGNAME,          
     VDT,           
     L.VTYP,                                                                        
     ACCAT,           
     OPBAL=0,          
     CROSAC='',          
     A.ACNAME,          
     A.BRANCHCODE,          
     @@SPID,           
     CONVERT(VARCHAR,GETDATE(),112), '',           
     L.VDT                            
    FROM           
     LEDGER L             
     LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1                              
     ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),                            
     (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE = @FCODE) LL,                            
     VMAST V, ACMAST A, LEDGER2 L2                            
    WHERE           
     L.VNO = L2.VNO          
     AND L.VTYP = L2.VTYPE           
     AND L.BOOKTYPE = L2.BOOKTYPE          
     AND L.LNO = L2.LNO          
     AND L.DRCR = L2.DRCR          
     AND L.VNO = LL.VNO                            
     AND L.VTYP = LL.VTYP                            
     AND L.BOOKTYPE = LL.BOOKTYPE                            
     AND L.CLTCODE = A.CLTCODE                            
     AND L.VTYP = V.VTYPE                            
     AND L.CLTCODE <> @FCODE                            
     AND L2.COSTCODE = @@COSTCODE          
     AND L.VTYP <> 18            
 END          
          
UPDATE #TBL_GLREPORT SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID                            
UPDATE #TBL_GLREPORT SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE                            
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID = #TBL_GLREPORT.PROCID                            
UPDATE #TBL_GLREPORT SET CROSAC = CLTCODE WHERE PROCID = @@SPID                            
UPDATE #TBL_GLREPORT SET CLTCODE = @FCODE WHERE PROCID = @@SPID                            
UPDATE #TBL_GLREPORT SET ACNAME = A.ACNAME FROM ACMAST A WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE AND #TBL_GLREPORT.PROCID = @@SPID                            
                        
INSERT INTO #TBL_GLREPORT SELECT '','','','',0,0,'','','',CLTCODE,'','',0,'',OPPBAL,CLTCODE,'','',PROCID,REPDATE, '', ''                            
FROM TBL_OPPBALANCE WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TBL_GLREPORT WHERE PROCID = @@SPID)                                
                    
DELETE FROM #TBL_GLREPORT WHERE DRAMT = 0 AND CRAMT = 0 AND OPBAL = 0                    
                            
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID                            
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID                            
SELECT           
      BOOKTYPE,          
      VOUDT VDT ,          
      EFFDT EDT ,          
      SHORTDESC,          
      DRAMT DEBIT,          
      CRAMT CREDIT,          
      VNO,          
      NARRATION,          
      DDNO,          
      CLTCODE,           
      LONGNAME,          
      VTYP,          
      ACCAT,          
      OPBAL,          
    CROSAC,          
      ACNAME,          
      BRANCHCODE  
FROM           
      #TBL_GLREPORT            
WHERE           
      PROCID = @@SPID                            
ORDER BY           
      CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)), CONVERT(NUMERIC, VTYP), VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_CASHBOOK_NEW_01102011
-- --------------------------------------------------
   CREATE  PROC RPT_ACC_CASHBOOK_NEW_01102011  
--EXEC RPT_ACC_CASHBOOK_NEW 'MAY  2 2005', 'MAY  2 2005', '01/04/2005', '711129', 'BROKER', 'BROKER', '%'  
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */  
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */  
 @SDATE VARCHAR(10),            /* AS MMM DD YYYY */  
 @FCODE VARCHAR(10),  
 @STATUSID VARCHAR(30),  
 @STATUSNAME VARCHAR(30),  
 @BRANCH VARCHAR(10)  
  
AS  
  
DECLARE  
 @@OPENDATE AS VARCHAR(11),  
 @@REPDATE AS VARCHAR(8),  
 @@STARTDATE AS VARCHAR(11)  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
CREATE TABLE [DBO].[#TBL_GLREPORT]  
 (  
  [SRNO] [INT] IDENTITY (1, 1) NOT NULL,  
  [BOOKTYPE] [CHAR] (2) NULL,  
  [VOUDT] [VARCHAR] (10) NULL,  
  [EFFDT] [VARCHAR] (10) NULL,  
  [SHORTDESC] [CHAR] (6) NOT NULL DEFAULT(' '),  
  [DRAMT] [MONEY] NULL,  
  [CRAMT] [MONEY] NULL,  
  [VNO] [VARCHAR] (12) NULL,  
  [NARRATION] [VARCHAR] (234) NULL,  
  [DDNO] [VARCHAR] (15) NULL,  
  [CLTCODE] [VARCHAR] (10) NOT NULL,  
  [LONGNAME] [VARCHAR] (100) NULL,  
  [VDT] [DATETIME] NULL,  
  [VTYP] [SMALLINT] NOT NULL,  
  [ACCAT] [CHAR] (2) NULL,  
  [OPBAL] [MONEY] NOT NULL,  
  [CROSAC] [VARCHAR] (10) NOT NULL,  
  [ACNAME] [VARCHAR] (100) NULL,  
  [BRANCHCODE] [VARCHAR] (10) NULL,  
  [PROCID] [BIGINT] NULL,  
  [REPDATE] [VARCHAR] (8) NULL,  
  [MAINCODE] [VARCHAR] (10) NULL,  
  [VCHDT] [DATETIME] NULL  
 )  
        
DELETE   
 TBL_OPPBALANCE   
WHERE PROCID = @@SPID  
          
SELECT   
 @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, '01/04/2005',103), 109), 11)  
          
INSERT   
INTO TBL_OPPBALANCE   
SELECT   
 CLTCODE,  
 SUM(  
 CASE DRCR   
  WHEN 'C'   
  THEN VAMT   
  ELSE -VAMT   
 END  
 ) AS OPBAL,  
 @@SPID,   
 CONVERT(VARCHAR,GETDATE(),112)   
FROM LEDGER   
WHERE CLTCODE = @FCODE   
 AND VDT >= @@STARTDATE   
 AND VDT < @FDATE   
GROUP BY CLTCODE   
          
          
INSERT   
INTO #TBL_GLREPORT   
SELECT   
 L.BOOKTYPE,   
 VOUDT=CONVERT(VARCHAR,L.VDT,103),   
 EFFDT=CONVERT(VARCHAR,L.EDT,103),   
 ISNULL(SHORTDESC,'') SHORTDESC,   
 DRAMT=(  
 CASE   
  WHEN UPPER(L.DRCR) = 'C'   
  THEN VAMT   
  ELSE 0   
 END  
 ),   
 CRAMT=(  
 CASE   
  WHEN UPPER(L.DRCR) = 'D'   
  THEN VAMT   
  ELSE 0   
 END  
 ),   
 L.VNO,   
 REPLACE( L.NARRATION,'"','') NARRATION,   
 DDNO = (  
 CASE   
  WHEN ISNULL(L1.DDNO,'')='0'   
  THEN ''   
  ELSE ISNULL(L1.DDNO,'')   
 END  
 ),   
 L.CLTCODE ,   
 A.LONGNAME,  
 VDT,   
 L.VTYP,   
 ACCAT,   
 OPBAL=0,  
 CROSAC='',  
 A.ACNAME,  
 A.BRANCHCODE,  
 @@SPID,   
 CONVERT(VARCHAR,GETDATE(),112),   
 '',   
 VDT   
FROM LEDGER L   
LEFT JOIN   
 (  
 SELECT   
  VTYP,   
  BOOKTYPE,   
  VNO,   
  DDNO= MAX(DDNO)   
 FROM LEDGER1   
 GROUP BY VTYP,   
  BOOKTYPE,   
  VNO  
 )   
 L1   
 ON   
 (  
  L1.VTYP=L.VTYP   
  AND L1.BOOKTYPE = L.BOOKTYPE   
  AND L1.VNO = L.VNO  
 )  
 ,   
 (  
 SELECT   
  VNO,   
  VTYP,   
  BOOKTYPE   
 FROM LEDGER   
 WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'   
  AND CLTCODE = @FCODE  
 )   
 LL,   
 VMAST V,   
 ACMAST A   
WHERE L.VNO = LL.VNO   
 AND L.VTYP = LL.VTYP   
 AND L.BOOKTYPE = LL.BOOKTYPE   
 AND L.CLTCODE = A.CLTCODE   
 AND L.VTYP = V.VTYPE   
 AND L.CLTCODE <> @FCODE   
 AND L.VTYP <> 18   
  
UPDATE   
 #TBL_GLREPORT   
 SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION)   
WHERE PROCID = @@SPID   
  
UPDATE   
 #TBL_GLREPORT   
 SET OPBAL = TBL_OPPBALANCE.OPPBAL,  
 CROSAC=''   
FROM TBL_OPPBALANCE   
WHERE TBL_OPPBALANCE.CLTCODE = @FCODE   
 AND TBL_OPPBALANCE.PROCID = @@SPID   
 AND TBL_OPPBALANCE.PROCID =#TBL_GLREPORT.PROCID   
  
UPDATE   
 #TBL_GLREPORT   
 SET CROSAC = CLTCODE   
WHERE PROCID = @@SPID   
  
UPDATE   
 #TBL_GLREPORT   
 SET CLTCODE = @FCODE   
WHERE PROCID = @@SPID   
  
UPDATE   
 #TBL_GLREPORT   
 SET ACNAME = A.ACNAME   
FROM ACMAST A   
WHERE #TBL_GLREPORT.CLTCODE = A.CLTCODE   
 AND #TBL_GLREPORT.PROCID = @@SPID   
  
SELECT   
 BOOKTYPE,  
 VOUDT VDT ,  
 EFFDT EDT ,  
 SHORTDESC,  
 DRAMT DEBIT,  
 CRAMT CREDIT,  
 VNO,  
 NARRATION,  
 DDNO,  
 CLTCODE,  
 LONGNAME,  
 VTYP,  
 ACCAT,  
 OPBAL,  
 CROSAC,  
 ACNAME,  
 BRANCHCODE   
FROM #TBL_GLREPORT   
WHERE PROCID = @@SPID   
ORDER BY CONVERT(DATETIME, LEFT(CONVERT(VARCHAR, VCHDT, 109),11)),   
 CONVERT(NUMERIC, VTYP),   
 VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_GLBOOK_NEW
-- --------------------------------------------------




/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACC_GLBOOK_NEW    SCRIPT DATE: 01/12/2006 16:12:07 ******/
CREATE PROC RPT_ACC_GLBOOK_NEW        
--EXEC RPT_ACC_GLBOOK_NEW 'APR 26 2005', 'APR 26 2005', '01/04/2005', '771630', '771630', 'BROKER', 'BROKER', '%'      
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */        
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */        
@SDATE VARCHAR(10),            /* AS MMM DD YYYY */        
@FCODE VARCHAR(10),        
@TCODE VARCHAR(10),      
@STATUSID VARCHAR(30),        
@STATUSNAME VARCHAR(30),        
@BRANCH VARCHAR(10)        
        
AS        
        
DECLARE        
@@OPENDATE AS VARCHAR(11),        
@@REPDATE AS VARCHAR(8),        
@@STARTDATE AS VARCHAR(11)        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
DELETE TBL_GLREPORT_NEW WHERE PROCID = @@SPID                      
DELETE TBL_OPPBALANCE WHERE PROCID = @@SPID                       
        
SELECT @@STARTDATE = LEFT(CONVERT(VARCHAR, CONVERT(DATETIME, '01/04/2005',103), 109), 11)        
        
INSERT INTO TBL_OPPBALANCE        
SELECT CLTCODE,SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) AS OPBAL,@@SPID, CONVERT(VARCHAR,GETDATE(),112)        
 FROM LEDGER 
 WHERE CLTCODE BETWEEN @FCODE AND @TCODE AND VDT >= @@STARTDATE AND VDT <  @FDATE        
 GROUP BY CLTCODE        
        
        
INSERT INTO TBL_GLREPORT_NEW      
SELECT L.BOOKTYPE,         
  VOUDT=CONVERT(VARCHAR,L.VDT,103), EFFDT=CONVERT(VARCHAR,L.EDT,103), ISNULL(SHORTDESC,'') SHORTDESC,                                                 
  DRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                                                  
  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                
  L.VNO, REPLACE( L.NARRATION,'"','') NARRATION,                                   
  DDNO = (CASE WHEN ISNULL(L1.DDNO,'')='0' THEN '' ELSE ISNULL(L1.DDNO,'') END),                       
  L.CLTCODE, A.LONGNAME,VDT, L.VTYP,                                                  
  ACCAT, OPBAL=0,CROSAC='',A.ACNAME,A.BRANCHCODE,@@SPID, CONVERT(VARCHAR,GETDATE(),112), LL.CLTCODE AS MAINCODE      
 FROM LEDGER L 
  LEFT JOIN (SELECT VTYP, BOOKTYPE, VNO, DDNO= MAX(DDNO) FROM LEDGER1 GROUP BY VTYP, BOOKTYPE, VNO) L1        
  ON (L1.VTYP=L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO),      
  (SELECT VNO, VTYP, BOOKTYPE, CLTCODE,DRCR FROM LEDGER WHERE VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59' AND CLTCODE BETWEEN @FCODE AND @TCODE) LL,      
VMAST V, ACMAST A        
WHERE       
L.VNO = LL.VNO        
AND L.VTYP = LL.VTYP        
AND L.BOOKTYPE = LL.BOOKTYPE       
AND L.CLTCODE = A.CLTCODE        
AND L.DRCR=LL.DRCR      
AND L.VTYP = V.VTYPE        
AND L.VTYP <> 18      
UPDATE TBL_GLREPORT_NEW SET NARRATION = RTRIM(LONGNAME) + ' - ' + RTRIM(NARRATION) WHERE PROCID = @@SPID        
UPDATE TBL_GLREPORT_NEW SET OPBAL = TBL_OPPBALANCE.OPPBAL,CROSAC=''  FROM TBL_OPPBALANCE        
WHERE TBL_OPPBALANCE.CLTCODE = TBL_GLREPORT_NEW.MAINCODE AND TBL_OPPBALANCE.PROCID = @@SPID AND TBL_OPPBALANCE.PROCID =TBL_GLREPORT_NEW.PROCID        
DELETE FROM TBL_GLREPORT_NEW WHERE CLTCODE BETWEEN @FCODE AND @TCODE AND PROCID = @@SPID      
UPDATE TBL_GLREPORT_NEW SET CROSAC = CLTCODE WHERE PROCID = @@SPID      
UPDATE TBL_GLREPORT_NEW SET CLTCODE = MAINCODE WHERE PROCID = @@SPID        
UPDATE TBL_GLREPORT_NEW SET ACNAME = A.ACNAME FROM ACMAST A WHERE TBL_GLREPORT_NEW.CLTCODE = A.CLTCODE AND TBL_GLREPORT_NEW.PROCID = @@SPID        
UPDATE TBL_GLREPORT_NEW SET DRAMT = CRAMT, CRAMT = DRAMT      
      
--SELECT * FROM TBL_OPPBALANCE WHERE PROCID = @@SPID        
--SELECT * FROM TBL_GLREPORT WHERE PROCID = @@SPID        
SELECT BOOKTYPE,VOUDT ,EFFDT ,SHORTDESC,DRAMT ,CRAMT ,VNO,NARRATION,DDNO,CLTCODE,LONGNAME,VTYP,ACCAT,OPBAL,CROSAC,ACNAME,BRANCHCODE                    
FROM TBL_GLREPORT_NEW  WHERE PROCID = @@SPID                      
ORDER BY CLTCODE , VDT, VTYP DESC, VNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_GLLEDGER_ALL
-- --------------------------------------------------


--  EXEC RPT_ACC_GLLEDGER_ALL'01/04/2007', '31/03/2008', 'MAR 1 2008', 'MAR 28 2008', '00', 'ZZ', 'BROKER', 'BROKER', '%','VDT', 'ACCOUNT', 'VDT', 'GL',''   
      
CREATE     PROCEDURE [DBO].[RPT_ACC_GLLEDGER_ALL]        
    
    
 @SDATE VARCHAR(11),            /* AS MMM DD YYYY */    
 @EDATE VARCHAR(11),            /* AS MMM DD YYYY */    
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */    
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */    
 @FCODE VARCHAR(10),    
 @TCODE VARCHAR(10),    
 @STATUSID VARCHAR(30),    
 @STATUSNAME VARCHAR(30),    
 @BRANCH VARCHAR(10),    
 @SELECTIONBY VARCHAR(3),    
 @GROUPBY VARCHAR(10),    
 @SORTBY VARCHAR(50),    
 @REPORTNAME VARCHAR(30),    
 @REPORTOPT VARCHAR(10)     
AS    
BEGIN     
      
CREATE TABLE [DBO].[#TMPLEDGERNEW] (        
  [BOOKTYPE] [CHAR] (2)  NULL ,        
  [VOUDT] [VARCHAR] (20) NULL ,        
  [EFFDT] [VARCHAR] (20) NULL ,        
  [SHORTDESC] [CHAR] (6) NULL ,        
  [DRAMT] [MONEY] NULL ,        
  [CRAMT] [MONEY] NULL ,        
  [VNO] [VARCHAR] (12) NULL ,        
  [NARRATION] [VARCHAR] (234) NULL ,    
  [DDNO] [VARCHAR] (15) NULL ,        
  [CLTCODE] [VARCHAR] (10) NOT NULL ,    
  [LONGNAME] [VARCHAR] (100) NULL ,    
  [VDT] [DATETIME] NULL ,          
  [VTYP] [SMALLINT] NULL ,        
  [ACCAT] [VARCHAR] (30) NULL ,        
  [OPBAL] [MONEY] NULL ,        
  [CROSAC] [VARCHAR] (10) NULL ,        
  [ACNAME] [VARCHAR] (100) NULL ,     
  [BRANCHCODE] [VARCHAR] (10) NULL ,    
  [LNO][SMALLINT] NULL,    
  [SEGMENT] [VARCHAR] (4) NULL,        
  [ENTITY] [VARCHAR] (50) NULL,        
  [ORDERSEG][BIGINT] NULL      
) ON [PRIMARY]        
        
--NCDX START  
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,NARRATION,DDNO,CLTCODE,        
LONGNAME,VDT,VTYP,ACCAT,OPBAL,CROSAC,ACNAME,BRANCHCODE,LNO)        
EXEC ACCOUNTNCDX.DBO.RPT_ACC_GLREPORT @SDATE,@EDATE,@FDATE,@TDATE,@FCODE,@TCODE,@STATUSID,@STATUSNAME,@BRANCH,@SELECTIONBY,@GROUPBY,@SORTBY,@REPORTNAME,@REPORTOPT    
  
UPDATE #TMPLEDGERNEW SET SEGMENT='1NCX',ENTITY='FUTURE - NCDX', ORDERSEG = 1 WHERE SEGMENT IS NULL   
  
--MCX START  
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,NARRATION,DDNO,CLTCODE,        
LONGNAME,VDT,VTYP,ACCAT,OPBAL,CROSAC,ACNAME,BRANCHCODE,LNO)        
EXEC ACCOUNTMCDXCDS.DBO.RPT_ACC_GLREPORT @SDATE,@EDATE,@FDATE,@TDATE,@FCODE,@TCODE,@STATUSID,@STATUSNAME,@BRANCH,@SELECTIONBY,@GROUPBY,@SORTBY,@REPORTNAME,@REPORTOPT    
        
UPDATE #TMPLEDGERNEW SET SEGMENT='2MCX',ENTITY='FUTURE - MCX', ORDERSEG = 2 WHERE SEGMENT IS NULL   
      
        
/*IF @STRORDER = 'ACCODE'        
BEGIN        
 IF @SELECTBY = 'VDT'        
   BEGIN        
    IF @SINGLE = 'Y'        
     BEGIN        
      SELECT * FROM #TMPLEDGERNEW ORDER BY ORDERSEG,CLTCODE,VOUDT        
     END        
    ELSE        
   BEGIN        
      SELECT * FROM #TMPLEDGERNEW ORDER BY CLTCODE,ORDERSEG,VOUDT        
      END        
   END        
 ELSE        
   BEGIN        
    IF @SINGLE = 'Y'        
     BEGIN        
      SELECT * FROM #TMPLEDGERNEW ORDER BY ORDERSEG,CLTCODE,EFFDT        
     END        
    ELSE        
      BEGIN        
       SELECT * FROM #TMPLEDGERNEW ORDER BY CLTCODE,ORDERSEG,EFFDT        
      END        
    END        
   END        
 ELSE        
  BEGIN        
   IF @SELECTBY = 'VDT'        
    BEGIN        
     IF @SINGLE = 'Y'        
      BEGIN        
       SELECT * FROM #TMPLEDGERNEW ORDER BY ORDERSEG,ACNAME,VOUDT        
      END        
     ELSE        
      BEGIN        
       SELECT * FROM #TMPLEDGERNEW ORDER BY ACNAME,ORDERSEG,VOUDT        
      END        
     END        
   ELSE        
    BEGIN        
     IF @SINGLE = 'Y'        
      BEGIN        
       SELECT * FROM #TMPLEDGERNEW ORDER BY ORDERSEG,ACNAME,EFFDT        
      END        
     ELSE        
      BEGIN        
       SELECT * FROM #TMPLEDGERNEW ORDER BY ACNAME,ORDERSEG,EFFDT        
      END        
     END        
   END */  
        
SELECT    
 BOOKTYPE,    
 VOUDT,    
 EFFDT,     
 SHORTDESC,    
 DRAMT,    
 CRAMT,    
 VNO,    
 NARRATION,    
 DDNO,    
 CLTCODE,    
 LONGNAME,    
 VDT,    
 VTYP,    
 ACCAT,    
 OPBAL,    
 CROSAC,    
 ACNAME,    
 BRANCHCODE,    
 LNO,    
 SEGMENT,        
 ENTITY,        
 ORDERSEG    
FROM    
#TMPLEDGERNEW ORDER BY CLTCODE,ORDERSEG,VDT    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GlReport
-- --------------------------------------------------
/*              
RPT_ACC_GLREPORT '01/04/2011', '31/03/2012', 'Apr  1 2011', 'May 10 2011', '99988', '99988', 'region', 'ahmedabad', 'ahmedabad','vdt', 'Segment', 'codewise', 'GL',''              
              
*/              
CREATE PROC [dbo].[rpt_Acc_GlReport]                              
 @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                              
 @EDATE VARCHAR(11),            /* AS MMM DD YYYY */                              
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                              
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                              
 @FCODE VARCHAR(10),                              
 @TCODE VARCHAR(10),                              
 @STATUSID VARCHAR(30),                              
 @STATUSNAME VARCHAR(30),                              
 @BRANCH VARCHAR(10),                              
 @SELECTIONBY VARCHAR(3),                              
 @GROUPBY VARCHAR(10),                              
 @SORTBY VARCHAR(50),                              
 @REPORTNAME VARCHAR(30),                              
 @REPORTOPT VARCHAR(10) = ''                             
                              
AS                
        
/* Comment in Case of rollback 99890 -- 590002 MCX inspection*/        
--- Start      
/*      
if @REPORTNAME ='GL'        
BEGIN        
      
 exec rpt_Acc_GlReport_SEBI @SDATE, @EDATE, @FDATE, @TDATE, @FCODE, @TCODE, @STATUSID, @STATUSNAME, @BRANCH, @SELECTIONBY, @GROUPBY, @SORTBY,@REPORTNAME,@REPORTOPT              
 RETURN        
      
END        
*/      
--- End        
        
        
DECLARE                              
 @@OPENDATE AS VARCHAR(11),                
 @@COSTCODE AS SMALLINT,                
 @SHAREDB AS VARCHAR(25),                
 @@SQL AS VARCHAR(1000)                
              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
                              
SELECT @@OPENDATE = CONVERT(VARCHAR(11),SDTCUR,109) FROM PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR                           
                              
SELECT CLTCODE,VAMT AS OPBAL INTO #OPBAL FROM LEDGER  WHERE 1 =2                              
                        
CREATE TABLE [DBO].[#TEMPTABLE_GL] (                            
  [BOOKTYPE] [CHAR] (2)  NULL ,                            
  [VOUDT1] [VARCHAR] (20) NULL ,                            
  [EFFDT1] [VARCHAR] (20) NULL ,                            
  [SHORTDESC] [CHAR] (6) NULL ,                            
  [DRAMT] [MONEY] NULL ,                            
  [CRAMT] [MONEY] NULL ,                            
  [VNO] [VARCHAR] (12) NULL ,                            
  [NARRATION] [VARCHAR] (234) NULL ,                        
  [DDNO] [VARCHAR] (15) NULL ,                            
  [CLTCODE] [VARCHAR] (10) NOT NULL ,                        
  [LONGNAME] [VARCHAR] (100) NULL ,                        
  [VDT] [DATETIME] NULL ,                              
  [VTYP] [SMALLINT] NULL ,                            
  [ACCAT] [VARCHAR] (30) NULL ,                            
  [OPBAL] [MONEY] NULL ,                            
  [CROSAC] [VARCHAR] (10) NULL ,                            
  [ACNAME] [VARCHAR] (150) NULL ,                         
  [BRANCHCODE] [VARCHAR] (20) NULL ,                        
  [LNO][SMALLINT] NULL,                        
 )                    
 SET @SHAREDB = 'MSAJAG'              
 CREATE TABLE #COSTMAST              
 (              
  COSTCODE INT,              
  COSTNAME VARCHAR(50)              
 )              
              
 IF @STATUSID = 'REGION'              
 BEGIN              
  SET @@SQL = 'INSERT INTO #COSTMAST'              
  SET @@SQL = @@SQL + ' SELECT COSTCODE, COSTNAME FROM COSTMAST C,'+ @SHAREDB +'.DBO.REGION R WHERE REGIONCODE = RTRIM('+@STATUSNAME+') AND COSTNAME = BRANCH_CODE'              
 END              
              
 IF @STATUSID = 'AREA'              
 BEGIN              
  SET @@SQL = 'INSERT INTO #COSTMAST'              
  SET @@SQL = @@SQL + ' SELECT COSTCODE ,COSTNAME FROM COSTMAST C,'+ @SHAREDB +'.DBO.AREA A WHERE AREACODE = RTRIM('+@STATUSNAME+') AND COSTNAME = BRANCH_CODE'              
 END              
              
IF @STATUSID = 'BRANCH'              
 BEGIN                
  SET @@SQL = 'INSERT INTO #COSTMAST'                
  --SET @@SQL = @@SQL + ' SELECT COSTCODE,COSTNAME FROM COSTMAST WHERE COSTNAME = RTRIM(''+@STATUSNAME+'')'           
  SET @@SQL = @@SQL + ' SELECT COSTCODE,COSTNAME FROM COSTMAST '                
               
 END               
 PRINT(@@SQL)                
 EXEC(@@SQL)              
              
              
--select @@costcode=costcode from costmast where costname=@BRANCH                
                
IF @SELECTIONBY = 'VDT'                              
 BEGIN                              
  IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                              
   BEGIN                       
  INSERT INTO #OPBAL                  
  SELECT CLTCODE, SUM(OPBAL) FROM                             
  (                  
   SELECT                              
   CLTCODE,                              
   OPBAL = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)                              
   FROM                              
   LEDGER                              
   WHERE                              
    CLTCODE BETWEEN @FCODE AND @TCODE                              
    AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                          
   GROUP BY                   
    CLTCODE             
                   
   UNION ALL                  
   SELECT                              
    CLTCODE,                              
    OPBAL = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)                   
   FROM                              
    LEDGER                              
   WHERE                              
    CLTCODE BETWEEN @FCODE AND @TCODE                              
    AND VDT >= @@OPENDATE AND VDT < @FDATE AND VTYP <> 18                          
   GROUP BY CLTCODE                   
   ) A                  
   GROUP BY                  
    CLTCODE                  
   ORDER BY                   
    CLTCODE                      
                           
                              
  INSERT INTO #TEMPTABLE_GL                              
  SELECT                              
   L.BOOKTYPE,                              
   VOUDT1=L.VDT,                              
   EFFDT1=L.EDT,                              
   ISNULL(SHORTDESC,'') SHORTDESC,                              
   DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                              
   CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                              
   L.VNO,                              
   REPLACE( L.NARRATION,'"','') NARRATION,                              
   DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                              
   L.CLTCODE,                              
   A.LONGNAME,                              
   VDT,                              
   L.VTYP,                              
   ACCAT,                              
   OPBAL=0,                              
   CROSAC='',                              
   A.ACNAME,                        
   A.BRANCHCODE,                              
   L.LNO                              
  FROM                              
   LEDGER L,                              
   ACMAST A,                              
   VMAST V                              
  WHERE                              
   L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                              
   AND VTYP = VTYPE                              
   AND L.CLTCODE = A.CLTCODE                              
   AND L.CLTCODE BETWEEN @FCODE AND @TCODE                              
   AND (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')                              
  ORDER BY                              
   L.CLTCODE,           
   VOUDT1,                              
   L.VTYP DESC,                              
   L.VNO                              
    END                              
   ELSE                              
    BEGIN                     
     INSERT INTO #OPBAL                              
  SELECT                              
   CLTCODE,             
   SUM(OPBAL) FROM                 
   (                
   SELECT L2.CLTCODE ,SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                              
  FROM                              
   LEDGER2 L2,                              
   LEDGER L              
  WHERE                              
   L2.CLTCODE BETWEEN @FCODE AND @TCODE         
   AND L.VTYP=L2.VTYPE                              
   AND L.BOOKTYPE=L2.BOOKTYPE                              
   AND L.VNO=L2.VNO                              
   AND L.LNO=L2.LNO                     
   --AND L2.COSTCODE = @@costcode                               
   --AND C.COSTNAME = @BRANCH                           
   AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)              
   AND VDT LIKE @@OPENDATE + '%' AND L2.VTYPE = 18                      
  GROUP BY L2.CLTCODE                              
                
    UNION ALL                
                     
    SELECT                              
     L2.CLTCODE,                              
     SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                              
    FROM                              
     LEDGER2 L2,                              
     LEDGER L              
    WHERE                              
     L2.CLTCODE BETWEEN @FCODE AND @TCODE                              
     AND L.VTYP=L2.VTYPE                              
     AND L.BOOKTYPE=L2.BOOKTYPE                              
     AND L.VNO=L2.VNO                              
     AND L.LNO=L2.LNO                   
 --AND L2.COSTCODE = @@costcode                              
 --AND C.COSTNAME = @BRANCH                 
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)                         
     AND VDT >= @@OPENDATE AND VDT < @FDATE AND VTYPE <> 18                              
    GROUP BY L2.CLTCODE                              
    ) T1                   
    GROUP BY CLTCODE                              
 ORDER BY CLTCODE                       
                
                              
    INSERT INTO #TEMPTABLE_GL               
    SELECT                          
     L.BOOKTYPE,                              
     VOUDT1=L.VDT,                              
     EFFDT1=L.EDT,                              
     ISNULL(SHORTDESC,'') SHORTDESC,                              
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                              
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                              
     L.VNO,                              
     REPLACE( L.NARRATION,'"','') NARRATION,                              
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                              
     L2.CLTCODE,                              
     A.LONGNAME,                              
     VDT,                              
     L.VTYP,                              
     ACCAT,                              
     OPBAL=0,                              
     CROSAC='',                              
     A.ACNAME,                              
     A.BRANCHCODE,                              
     L.LNO                              
    FROM                              
     LEDGER L,                              
     VMAST V,                              
     LEDGER2 L2,                              
     ACMAST A/*,                              
     COSTMAST C*/               
    WHERE                              
     L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                              
     AND L.VTYP = L2.VTYPE                              
     AND  L.VNO = L2.VNO                              
     AND L.LNO = L2.LNO                              
     AND L.BOOKTYPE = L2.BOOKTYPE                              
     AND L2.CLTCODE=A.CLTCODE                              
     AND L.VTYP = V.VTYPE                              
     AND L2.CLTCODE BETWEEN @FCODE AND  @TCODE                              
     AND A.ACCAT <> '4'                              
     --AND COSTNAME = RTRIM(@BRANCH)                       
     --AND L2.COSTCODE = C.COSTCODE                 
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)              
     AND  L2.VTYPE <> 18                              
    ORDER BY                              
     L2.CLTCODE,                              
     VOUDT1,                      
     L.VTYP DESC,                              
     L.VNO                              
   END                              
 END                              
ELSE                              
 BEGIN                              
  IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                              
   BEGIN                              
    INSERT INTO #OPBAL                              
    SELECT                              
     CLTCODE,                              
     SUM(OPBAL) OPBAL                              
    FROM                              
     (                              
      SELECT                              
       CLTCODE,                              
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL                              
      FROM                              
       LEDGER                              
      WHERE                              
       CLTCODE BETWEEN @FCODE AND @TCODE                              
       AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                   
                          
      GROUP BY                              
       CLTCODE                              
  UNION ALL                      
  SELECT                              
       CLTCODE,                              
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL                              
      FROM                              
       LEDGER                              
      WHERE                              
       CLTCODE BETWEEN @FCODE AND @TCODE                              
       AND EDT >= @@OPENDATE AND EDT < @FDATE AND VTYP <> 18                              
      GROUP BY                              
       CLTCODE                         
     UNION ALL                              
      SELECT                              
       CLTCODE,                              
       SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) AS OPBAL                              
      FROM                              
       LEDGER                              
      WHERE                              
       CLTCODE BETWEEN  @FCODE AND  @TCODE                              
       AND VDT < @@OPENDATE                              
       AND EDT >= @@OPENDATE                              
       GROUP BY CLTCODE                              
     ) T                              
    GROUP BY CLTCODE                              
    ORDER BY CLTCODE                              
                              
    INSERT INTO #TEMPTABLE_GL                              
    SELECT                    
     L.BOOKTYPE,                           
     VOUDT1=L.VDT,                              
     EFFDT1=L.EDT,                              
     ISNULL(SHORTDESC,'') SHORTDESC,                              
     DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                              
     CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                              
     L.VNO,                              
     REPLACE( L.NARRATION,'"','') NARRATION,                              
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                           
     L.CLTCODE,                              
     A.LONGNAME,                              
     VDT,                              
     L.VTYP,                              
     ACCAT,                              
     OPBAL=0,                              
     CROSAC='',                              
     A.ACNAME,                              
     A.BRANCHCODE,                              
     L.LNO                              
    FROM                              
     LEDGER L,                              
     ACMAST A,                              
     VMAST V                              
    WHERE                              
     VTYP = VTYPE                              
     AND A.CLTCODE = L.CLTCODE                              
     AND L.CLTCODE BETWEEN @FCODE AND @TCODE                              
     AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                              
     AND L.VTYP <> 18                              
     AND (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')                              
    ORDER BY                              
     L.CLTCODE,                              
     VOUDT1,                              
     L.VTYP DESC,                              
     L.VNO                             END                              
  ELSE                              
   BEGIN                     
print 'nse'                         
    INSERT INTO #OPBAL                              
    SELECT                              
     CLTCODE,                              
     SUM(OPBAL) OPBAL                              
    FROM                              
     (                              
      SELECT                              
       L2.CLTCODE,                              
       SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                              
      FROM                              
       LEDGER2 L2,                              
       LEDGER L --, COSTMAST C                            
      WHERE                              
       VDT LIKE @@OPENDATE + '%' AND VTYPE = 18                      
       AND L.VNO=L2.VNO                              
       AND L.VTYP=L2.VTYPE                              
       AND L.BOOKTYPE=L2.BOOKTYPE                              
       AND L.LNO=L2.LNO                   
  --AND L2.COSTCODE = @@costcode                              
        --AND C.COSTNAME = @BRANCH                            
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)              
        AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                              
      GROUP BY                              
       L2.CLTCODE                              
      UNION ALL                              
   SELECT                              
       L2.CLTCODE,                              
       SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                              
      FROM                              
       LEDGER2 L2,                              
       LEDGER L    --, COSTMAST C                                       
      WHERE                              
       EDT >= @@OPENDATE AND EDT < @FDATE AND VTYPE <> 18                      
       AND L.VNO=L2.VNO                              
       AND L.VTYP=L2.VTYPE                              
       AND L.BOOKTYPE=L2.BOOKTYPE                              
       AND L.LNO=L2.LNO                        
       --AND L2.COSTCODE = @@costcode                            
       --AND C.COSTNAME = @BRANCH                            
       AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)              
       AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                              
      GROUP BY                              
       L2.CLTCODE                              
      UNION ALL                      
       SELECT                              
   L2.CLTCODE,                              
        SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) AS OPBAL                              
       FROM                              
        LEDGER2 L2,                              
        LEDGER L , COSTMAST C                
       WHERE                              
        L.VNO=L2.VNO                              
        AND L.VTYP=L2.VTYPE                              
        AND L.BOOKTYPE=L2.BOOKTYPE                              
        AND L.LNO=L2.LNO                              
        AND VDT < @@OPENDATE                              
        AND EDT >= @@OPENDATE                   
  AND L2.COSTCODE = @@costcode                               
  AND C.COSTNAME = @BRANCH                            
        AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                              
       GROUP BY                              
        L2.CLTCODE                              
     ) T                              
    GROUP BY                              
     CLTCODE                              
    ORDER BY                              
    CLTCODE                              
    INSERT INTO #TEMPTABLE_GL                              
    SELECT                              
     L.BOOKTYPE,                      
     VOUDT1=L.VDT,                              
     EFFDT1=L.EDT,                              
     ISNULL(SHORTDESC,'') SHORTDESC,                              
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                              
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                              
     L.VNO,                              
     REPLACE(L.NARRATION,'"','') NARRATION,                              
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                              
     L2.CLTCODE,                              
     A.LONGNAME,                              
     VDT,                              
     L.VTYP,                              
     ACCAT,                           
     OPBAL=0,                              
     CROSAC='',                              
     A.ACNAME,                              
     A.BRANCHCODE,                              
     L.LNO                              
    FROM                              
     LEDGER L,                              
     VMAST V,                              
     LEDGER2 L2,                              
     ACMAST A/*,                              
     COSTMAST C */                             
    WHERE                              
 L.VNO = L2.VNO                              
     AND L.VTYP = L2.VTYPE                              
     AND L.BOOKTYPE = L2.BOOKTYPE                              
     AND L.LNO = L2.LNO                              
     AND A.CLTCODE = L2.CLTCODE                              
     AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                              
     AND L.VTYP = V.VTYPE                              
     AND A.ACCAT <> '4'                              
     AND L2.CLTCODE=A.CLTCODE                              
     --AND COSTNAME = RTRIM(@BRANCH)                              
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)                 
     AND L2.VTYPE <> 18                              
     AND L2.COSTCODE = C.COSTCODE                              
     AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                              
    ORDER BY                              
     L2.CLTCODE,                              
     VOUDT1,                              
     L.VTYP DESC,                              
     L.VNO                              
   END                              
 END                              
                              
UPDATE                              
 #TEMPTABLE_GL                              
SET                              
 OPBAL = L.OPBAL                              
FROM                              
 #OPBAL L                        
WHERE                              
 #TEMPTABLE_GL.CLTCODE = L.CLTCODE                              
                              
UPDATE                              
 #TEMPTABLE_GL                              
SET                              
 CROSAC = L.CLTCODE                              
FROM                              
 LEDGER L                              
WHERE                              
 L.VTYP IN('2','3')                              
 AND #TEMPTABLE_GL.VTYP = L.VTYP                              
 AND #TEMPTABLE_GL.BOOKTYPE = L.BOOKTYPE                              
 AND #TEMPTABLE_GL.VNO = L.VNO                              
 AND #TEMPTABLE_GL.CLTCODE <> L.CLTCODE                              
                              
UPDATE                              
 #TEMPTABLE_GL                              
SET                              
 BRANCHCODE = COSTNAME                              
FROM                            
 LEDGER2 L2,                              
 #COSTMAST C                              
WHERE                              
 #TEMPTABLE_GL.VNO = L2.VNO                              
 AND #TEMPTABLE_GL.VTYP = L2.VTYPE                              
 AND #TEMPTABLE_GL.BOOKTYPE = L2.BOOKTYPE                           
 AND #TEMPTABLE_GL.LNO = L2.LNO                              
 AND #TEMPTABLE_GL.CLTCODE = L2.CLTCODE                              
 AND L2.COSTCODE = C.COSTCODE                          
                    
DELETE #TEMPTABLE_GL WHERE  VTYP=18                    
                    
INSERT INTO #TEMPTABLE_GL                    
SELECT '','','','',0,0,'','','',CLTCODE,'','',18,'',OPBAL,CLTCODE,'','',''                                
FROM #OPBAL WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TEMPTABLE_GL WHERE VTYP<>18)                         
                           
SELECT                              
 BOOKTYPE,                              
 VOUDT = CONVERT(VARCHAR(11),CONVERT(DATETIME, CONVERT(VARCHAR(11), VOUDT1, 109)), 103),                    
 EFFDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, CONVERT(VARCHAR(11), EFFDT1, 109)), 103),                    
 SHORTDESC,                              
 DRAMT,                              
 CRAMT,                              
 VNO,                              
 NARRATION,                              
 DDNO,                              
 CLTCODE,                              
 LONGNAME,                              
 VDT,                      
 VTYP,                              
 ACCAT,                              
 OPBAL,                              
 CROSAC,                              
 ACNAME,                              
 BRANCHCODE,                              
 LNO                              
FROM                              
 #TEMPTABLE_GL                              
ORDER BY                              
 CLTCODE,            
VDT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GlReport_03102011
-- --------------------------------------------------
--Exec rpt_Acc_GlReport '01/04/2009', '31/03/2010', 'Apr  2 2009', 'Nov 12 2009', '99890', '99890', 'broker', 'broker', 'VD','vdt', 'Account', 'VDT', 'GL',''  
  
CREATE Proc rpt_Acc_GlReport_03102011                                     
@sdate varchar(11),            /* As mmm dd yyyy */                                    
@edate varchar(11),            /* As mmm dd yyyy */                                    
@fdate varchar(11),            /* As mmm dd yyyy */                                    
@tdate varchar(11),            /* As mmm dd yyyy */                                    
@fcode varchar(10),                                    
@tcode varchar(10),                                    
@statusId varchar(30),                                    
@statusname varchar(30),                                    
@branch varchar(10),                                    
@selectionby varchar(3),                                    
@GroupBy varchar(10),                                    
@Sortby varchar(50),                                    
@reportname varchar(30),                                    
@reportopt varchar(10)                                    
                                    
AS                                    
                                    
declare                                     
@@opendate as varchar(11)                                    
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                    
                                    
--Select @@opendate = convert(varchar(11),max(vdt),109) from ledger where vtyp='18'                 
                  
select @@OpenDate = left(convert(varchar,sdtcur,109),11) from parameter where @fdate between sdtcur and ldtcur                  
                
                            
--SELECT @@OPENDATE = CONVERT(VARCHAR(11),convert(datetime,@SDATE, 103),109)                                
                                    
Select cltcode,vamt as opbal into #opbal from ledger  where 1 =2                                    
                                    
 Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                                    
  dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                                      
  cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,                                     
  Replace( l.narration,'"','') narration,                                    
  ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and                                    
  booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,                                    
  accat,Vamt as opbal,crosac=l.cltcode,                                    
  isnull(a.acname,'') acname,isnull(a.branchcode,'') branchcode, lno                                
 into #temptable_gl                                    
From Ledger l , Acmast a ,Vmast v  where 1 = 2                                
                                    
                                  
if @selectionby = 'vdt'                                    
BEGIN                                    
if rtrim(@branch) = '' or rtrim(@branch) = '%'                                     
 BEGIN                          
if @@opendate=@fdate          
 begin            
  Insert into #opbal                                
  Select cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger                                     
  where cltcode between @fcode and @tcode and vdt like  @@opendate + '%' and vtyp=18                                 
  Group by cltcode                                     
  Order by cltcode                                     
 end                             
else           
  begin           
 Insert into #opbal                                
    Select cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger                                     
   where cltcode between @fcode and @tcode and vdt >= @@opendate and vdt <@fdate          
    Group by cltcode                                     
    Order by cltcode                                     
   end          
                                     
  Insert into #temptable_gl                               
   Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,              
   dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                                      
   cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno, Replace( l.narration,'"','') narration,                                    
   ddno=isnull((select max(ddno) from ledger1 where vtyp = l.vtyp and vno = l.vno and                                    
   booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,                                    
   accat,opbal=0,crosac='',   a.acname,a.branchcode, l.lno                                    
   from Ledger l,  Acmast a ,Vmast v                                  
                                  
   Where  l.vdt between @fdate and @tdate + ' 23:59:59'  And vtyp = vtype and                                
   l.cltcode = a.cltcode  and l.cltcode between @fcode and @tcode and                                     
   (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')                                 
                                
   Order by l.cltcode, voudt1, l.vtyp desc, l.vno                                        
 END                       
ELSE                                 
 BEGIN                                    
  insert into #opbal                                
  Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal from ledger2 l2, ledger l, COSTMAST C  
   where l2.cltcode between @fcode and @tcode and l.vtyp=l2.vtype and l.booktype=l2.booktype and l.vno=l2.vno and l.lno=l2.lno                                    
   AND C.COSTCODE = L2.COSTCODE AND COSTNAME = rtrim(@branch)  
   and vdt LIKE @@opendate + '%' AND VTYPE = 18  
   Group by l2.cltcode                                    
   UNION ALL  
   Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal from ledger2 l2, ledger l, COSTMAST C  
   where l2.cltcode between @fcode and @tcode and l.vtyp=l2.vtype and l.booktype=l2.booktype and l.vno=l2.vno and l.lno=l2.lno                                    
   AND C.COSTCODE = L2.COSTCODE AND COSTNAME = rtrim(@branch)  
   and vdt >= @@opendate AND VDT < @FDATE AND VTYPE <> 18  
   Group by l2.cltcode                                  
       Order by l2.cltcode                                
                                    
 insert into #temptable_gl                                    
   Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                                     
   dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),                                      
   cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),                                  
   l.vno, Replace( l.narration,'"','') narration, ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp              and vno = l.vno and booktype = l.booktype                                     
   and lno = l.lno),''), l2.cltcode , a.longname,vdt, l.vtyp,                                    
   accat,  opbal=0,crosac='',a.acname,a.branchcode, l.lno                                     
   from ledger l ,vmast v, ledger2 l2, acmast a,  costmast c                                       
                                
           Where  l.vdt between @fdate and @tdate + ' 23:59:59' and l.vtyp = l2.vtype and  l.vno = l2.vno and                                
   l.lno = l2.lno and  l.booktype = l2.booktype and l2.cltcode=a.cltcode  and l.vtyp = v.vtype and                                 
   l2.cltcode between @fcode and  @tcode  and a.accat <> '4'                                     
   and costname = rtrim(@branch)                                     
   and l2.costcode = c.costcode  and  l2.vtype <> 18                                
   order by l2.cltcode, voudt1, l.vtyp desc, l.vno                                    
 END                                    
END                                    
ELSE                                    
BEGIN                                    
if rtrim(@branch) = '' or rtrim(@branch) = '%'                                     
 BEGIN                                        
  insert into #opbal                                 
  Select cltcode, sum(opbal) opbal  from                                    
   (                                
    Select Cltcode,sum(case drcr when 'D' then vamt else -vamt end) as opbal from ledger                                     
    where Cltcode between @fcode and @tcode and vdt between @@opendate and @fdate                                    
    Group by Cltcode                                    
                                 
    union                                    
                                 
   Select cltcode,sum(case drcr when 'C' then vamt else -vamt end) as opbal from ledger                                     
   Where cltcode between  @fcode and  @tcode and vdt < @@opendate and edt >= @@opendate                                    
   Group by cltcode) t                                  
   Group by cltcode                                    
     Order by cltcode                                              
                                    
 insert into #temptable_gl                                    
   Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                                    
   dramt=(case when upper(l.drcr) = 'D' then vamt else 0 end),                                      
   cramt=(case when upper(l.drcr) = 'C' then vamt else 0 end), l.vno,                                     
   Replace( l.narration,'"','') narration,                                    
   ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and                                    
   booktype = l.booktype and lno = l.lno),''), l.cltcode , a.longname,vdt, l.vtyp,                                    
   accat,opbal=0,crosac='',  a.acname,a.branchcode, l.lno                                   
   from Ledger l , acmast a ,vmast v                                  
   Where vtyp = vtype  and a.cltcode = l.cltcode and l.cltcode between @fcode and @tcode                                 
    and  l.edt between @fdate and @tdate + ' 23:59:59' and    l.vtyp <> 18 and                                 
   (a.accat LIKE '3%'  or a.accat like '14%'  or a.accat LIKE '103%')                                    
   order by l.cltcode, voudt1, l.vtyp desc, l.vno                                    
 END                                    
ELSE                           
 BEGIN                                        
  insert into #opbal                                 
  Select cltcode, sum(opbal) opbal  from                                    
   (                                
  Select l2.cltcode,sum(case l2.drcr when 'D' then camt else -camt end) as opbal from ledger2 l2, ledger l                                    
   where vdt  between @@opendate and @fdate  and   l.vno=l2.vno and l.vtyp=l2.vtype and l.booktype=l2.booktype                                
   and l.lno=l2.lno   and  l2.cltcode between @fcode   and @tcode                                
   Group by l2.cltcode                                    
                                
   union                                    
                                
   Select l2.cltcode,sum(case l2.drcr when 'C' then camt else -camt end) as opbal from ledger2 l2, ledger l                                    
   where  l.vno=l2.vno and l.vtyp=l2.vtype and l.booktype=l2.booktype and l.lno=l2.lno                                    
   and  vdt < @@opendate and edt >= @@opendate and   l2.cltcode between @fcode and @tcode                                 
   Group by l2.cltcode) t                                    
 Group by cltcode                                
     Order by cltcode                                
                                    
 insert into #temptable_gl                                    
 Select l.booktype, voudt1=l.vdt, effdt1=l.edt, isnull(shortdesc,'') shortdesc,                                     
  dramt=(case when upper(l2.drcr) = 'D' then camt else 0 end),                                      
  cramt=(case when upper(l2.drcr) = 'C' then camt else 0 end),                                     
  l.vno, Replace( l.narration,'"','') narration, ddno=isnull((select ddno from ledger1 where vtyp = l.vtyp and vno = l.vno and booktype = l.booktype                                     
  and lno = l.lno),''), l2.cltcode , a.longname,vdt, l.vtyp,                                      
  accat,   opbal=0,crosac='',a.acname,a.branchcode, l.lno                    
  from ledger l ,vmast v, ledger2 l2 ,acmast a, costmast c                                  
  Where l.vno = l2.vno and l.vtyp = l2.vtype and                                
  l.booktype = l2.booktype  and l.lno = l2.lno and a.cltcode = l2.cltcode                                 
  and l2.cltcode between @fcode and  @tcode And l.vtyp = v.vtype and a.accat <> '4' and l2.cltcode=a.cltcode                                     
  and costname = rtrim(@branch)  and l2.vtype <> 18                                
  and l2.costcode = c.costcode                                       
  and  l.edt between @fdate and @tdate + ' 23:59:59'                                  
order by l2.cltcode, voudt1, l.vtyp desc, l.vno                                    
 END                                    
END                                    
                                
Update #temptable_gl set opbal = l.opbal  from #opbal l   where #temptable_gl.cltcode = l.cltcode                                    
                                    
Update #temptable_gl set crosac = l.cltcode  from ledger l                                     
where l.vtyp not in('15','21') and #temptable_gl.vtyp = l.vtyp and #temptable_gl.booktype = l.booktype and #temptable_gl.vno = l.vno                                    
and #temptable_gl.cltcode <> l.cltcode                                       
                              
                            
 update #temptable_gl set branchcode = costname from ledger2 l2, costmast c                              
 where #temptable_gl.vno = l2.vno and #temptable_gl.vtyp = l2.vtype and #temptable_gl.booktype = l2.booktype and #temptable_gl.lno = l2.lno and #temptable_gl.cltcode = l2.cltcode                              
 and l2.costcode = c.costcode                              
                            
                          
                insert into #temptable_gl select '01', '', '', '', 0, 0, '', '', '', cltcode, '', '', 0, '', opbal, '', '', '', 0 from #opbal                          
                                  
Select booktype,voudt = convert(varchar(11), voudt1, 103),effdt = convert(varchar(11), effdt1, 103),shortdesc,dramt,cramt,vno,narration,ddno,cltcode,longname,vdt,vtyp,accat,opbal,crosac,acname,branchcode,lno                            
from #temptable_gl                            
where vtyp <> 18                    
Order By CltCode,Vdt

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GlReport_26062012
-- --------------------------------------------------

  
/*  
RPT_ACC_GLREPORT '01/04/2011', '31/03/2012', 'Apr  1 2011', 'May 10 2011', '99988', '99988', 'region', 'ahmedabad', 'ahmedabad','vdt', 'Segment', 'codewise', 'GL',''  
  
*/  
CREATE PROC [dbo].[rpt_Acc_GlReport_26062012]                  
 @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                  
 @EDATE VARCHAR(11),            /* AS MMM DD YYYY */                  
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                  
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                  
 @FCODE VARCHAR(10),                  
 @TCODE VARCHAR(10),                  
 @STATUSID VARCHAR(30),                  
 @STATUSNAME VARCHAR(30),                  
 @BRANCH VARCHAR(10),                  
 @SELECTIONBY VARCHAR(3),                  
 @GROUPBY VARCHAR(10),                  
 @SORTBY VARCHAR(50),                  
 @REPORTNAME VARCHAR(30),                  
 @REPORTOPT VARCHAR(10) = ''                 
                  
AS    
DECLARE                  
 @@OPENDATE AS VARCHAR(11),    
 @@COSTCODE AS SMALLINT,    
 @SHAREDB AS VARCHAR(25),    
 @@SQL AS VARCHAR(1000)    
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
                  
SELECT @@OPENDATE = CONVERT(VARCHAR(11),SDTCUR,109) FROM PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR               
                  
SELECT CLTCODE,VAMT AS OPBAL INTO #OPBAL FROM LEDGER  WHERE 1 =2                  
            
CREATE TABLE [DBO].[#TEMPTABLE_GL] (                
  [BOOKTYPE] [CHAR] (2)  NULL ,                
  [VOUDT1] [VARCHAR] (20) NULL ,                
  [EFFDT1] [VARCHAR] (20) NULL ,                
  [SHORTDESC] [CHAR] (6) NULL ,                
  [DRAMT] [MONEY] NULL ,                
  [CRAMT] [MONEY] NULL ,                
  [VNO] [VARCHAR] (12) NULL ,                
  [NARRATION] [VARCHAR] (234) NULL ,            
  [DDNO] [VARCHAR] (15) NULL ,                
  [CLTCODE] [VARCHAR] (10) NOT NULL ,            
  [LONGNAME] [VARCHAR] (100) NULL ,            
  [VDT] [DATETIME] NULL ,                  
  [VTYP] [SMALLINT] NULL ,                
  [ACCAT] [VARCHAR] (30) NULL ,                
  [OPBAL] [MONEY] NULL ,                
  [CROSAC] [VARCHAR] (10) NULL ,                
  [ACNAME] [VARCHAR] (150) NULL ,             
  [BRANCHCODE] [VARCHAR] (20) NULL ,            
  [LNO][SMALLINT] NULL,            
 )        
 SET @SHAREDB = 'MSAJAG'  
 CREATE TABLE #COSTMAST  
 (  
  COSTCODE INT,  
  COSTNAME VARCHAR(50)  
 )  
  
 IF @STATUSID = 'REGION'  
 BEGIN  
  SET @@SQL = 'INSERT INTO #COSTMAST'  
  SET @@SQL = @@SQL + ' SELECT COSTCODE, COSTNAME FROM COSTMAST C,'+ @SHAREDB +'.DBO.REGION R WHERE REGIONCODE = RTRIM('+@STATUSNAME+') AND COSTNAME = BRANCH_CODE'  
 END  
  
 IF @STATUSID = 'AREA'  
 BEGIN  
  SET @@SQL = 'INSERT INTO #COSTMAST'  
  SET @@SQL = @@SQL + ' SELECT COSTCODE ,COSTNAME FROM COSTMAST C,'+ @SHAREDB +'.DBO.AREA A WHERE AREACODE = RTRIM('+@STATUSNAME+') AND COSTNAME = BRANCH_CODE'  
 END  
  
 IF @STATUSID = 'BRANCH'  
 BEGIN  
  SET @@SQL = 'INSERT INTO #COSTMAST'  
  SET @@SQL = @@SQL + ' SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM('+@STATUSNAME+')'  
 END  
 PRINT(@@SQL)    
 EXEC(@@SQL)  
  
  
--select @@costcode=costcode from costmast where costname=@BRANCH    
    
IF @SELECTIONBY = 'VDT'                  
 BEGIN                  
  IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                  
   BEGIN           
  INSERT INTO #OPBAL      
  SELECT CLTCODE, SUM(OPBAL) FROM                 
  (      
   SELECT                  
   CLTCODE,                  
   OPBAL = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)                  
   FROM                  
   LEDGER                  
   WHERE                  
    CLTCODE BETWEEN @FCODE AND @TCODE                  
    AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18              
   GROUP BY       
    CLTCODE     
       
   UNION ALL      
   SELECT                  
    CLTCODE,                  
    OPBAL = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)       
   FROM                  
    LEDGER                  
   WHERE                  
    CLTCODE BETWEEN @FCODE AND @TCODE                  
    AND VDT >= @@OPENDATE AND VDT < @FDATE AND VTYP <> 18              
   GROUP BY CLTCODE       
   ) A      
   GROUP BY      
    CLTCODE      
   ORDER BY       
    CLTCODE          
               
                  
  INSERT INTO #TEMPTABLE_GL                  
  SELECT                  
   L.BOOKTYPE,                  
   VOUDT1=L.VDT,                  
   EFFDT1=L.EDT,                  
   ISNULL(SHORTDESC,'') SHORTDESC,                  
   DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                  
   CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                  
   L.VNO,                  
   REPLACE( L.NARRATION,'"','') NARRATION,                  
   DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                  
   L.CLTCODE,                  
   A.LONGNAME,                  
   VDT,                  
   L.VTYP,                  
   ACCAT,                  
   OPBAL=0,                  
   CROSAC='',                  
   A.ACNAME,            
   A.BRANCHCODE,                  
   L.LNO                  
  FROM                  
   LEDGER L,                  
   ACMAST A,                  
   VMAST V                  
  WHERE                  
   L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                  
   AND VTYP = VTYPE                  
   AND L.CLTCODE = A.CLTCODE                  
   AND L.CLTCODE BETWEEN @FCODE AND @TCODE                  
   AND (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')                  
  ORDER BY                  
   L.CLTCODE,                  
   VOUDT1,                  
   L.VTYP DESC,                  
   L.VNO                  
    END                  
   ELSE                  
    BEGIN         
     INSERT INTO #OPBAL                  
  SELECT                  
   CLTCODE,                  
   SUM(OPBAL) FROM     
   (    
   SELECT L2.CLTCODE ,SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                  
  FROM                  
   LEDGER2 L2,                  
   LEDGER L  
  WHERE                  
   L2.CLTCODE BETWEEN @FCODE AND @TCODE                  
   AND L.VTYP=L2.VTYPE                  
   AND L.BOOKTYPE=L2.BOOKTYPE                  
   AND L.VNO=L2.VNO                  
   AND L.LNO=L2.LNO         
   --AND L2.COSTCODE = @@costcode                   
   --AND C.COSTNAME = @BRANCH               
   AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)  
   AND VDT LIKE @@OPENDATE + '%' AND L2.VTYPE = 18          
  GROUP BY L2.CLTCODE                  
    
    UNION ALL    
         
    SELECT                  
     L2.CLTCODE,                  
     SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                  
    FROM                  
     LEDGER2 L2,                  
     LEDGER L  
    WHERE                  
     L2.CLTCODE BETWEEN @FCODE AND @TCODE                  
     AND L.VTYP=L2.VTYPE                  
     AND L.BOOKTYPE=L2.BOOKTYPE                  
     AND L.VNO=L2.VNO                  
     AND L.LNO=L2.LNO       
 --AND L2.COSTCODE = @@costcode                  
 --AND C.COSTNAME = @BRANCH     
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)             
     AND VDT >= @@OPENDATE AND VDT < @FDATE AND VTYPE <> 18                  
    GROUP BY L2.CLTCODE                  
    ) T1       
    GROUP BY CLTCODE                  
 ORDER BY CLTCODE           
    
                  
    INSERT INTO #TEMPTABLE_GL   
    SELECT                  
     L.BOOKTYPE,                  
     VOUDT1=L.VDT,                  
     EFFDT1=L.EDT,                  
     ISNULL(SHORTDESC,'') SHORTDESC,                  
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                  
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                  
     L.VNO,                  
     REPLACE( L.NARRATION,'"','') NARRATION,                  
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                  
     L2.CLTCODE,                  
     A.LONGNAME,                  
     VDT,                  
     L.VTYP,                  
     ACCAT,                  
     OPBAL=0,                  
     CROSAC='',                  
     A.ACNAME,                  
     A.BRANCHCODE,                  
     L.LNO                  
    FROM                  
     LEDGER L,                  
     VMAST V,                  
     LEDGER2 L2,                  
     ACMAST A/*,                  
     COSTMAST C*/   
    WHERE                  
     L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                  
     AND L.VTYP = L2.VTYPE                  
     AND  L.VNO = L2.VNO                  
     AND L.LNO = L2.LNO                  
     AND L.BOOKTYPE = L2.BOOKTYPE                  
     AND L2.CLTCODE=A.CLTCODE                  
     AND L.VTYP = V.VTYPE                  
     AND L2.CLTCODE BETWEEN @FCODE AND  @TCODE                  
     AND A.ACCAT <> '4'                  
     --AND COSTNAME = RTRIM(@BRANCH)                  
     --AND L2.COSTCODE = C.COSTCODE     
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)  
     AND  L2.VTYPE <> 18                  
    ORDER BY                  
     L2.CLTCODE,                  
     VOUDT1,          
     L.VTYP DESC,                  
     L.VNO                  
   END                  
 END                  
ELSE                  
 BEGIN                  
  IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                  
   BEGIN                  
    INSERT INTO #OPBAL                  
    SELECT                  
     CLTCODE,                  
     SUM(OPBAL) OPBAL                  
    FROM                  
     (                  
      SELECT                  
       CLTCODE,                  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL                  
      FROM                  
       LEDGER                  
      WHERE                  
       CLTCODE BETWEEN @FCODE AND @TCODE                  
       AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18       
              
      GROUP BY                  
       CLTCODE                  
  UNION ALL          
  SELECT                  
       CLTCODE,                  
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL                  
      FROM                  
       LEDGER                  
      WHERE                  
       CLTCODE BETWEEN @FCODE AND @TCODE                  
       AND EDT >= @@OPENDATE AND EDT < @FDATE AND VTYP <> 18                  
      GROUP BY                  
       CLTCODE             
     UNION ALL                  
      SELECT                  
       CLTCODE,                  
       SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) AS OPBAL                  
      FROM                  
       LEDGER                  
      WHERE                  
       CLTCODE BETWEEN  @FCODE AND  @TCODE                  
       AND VDT < @@OPENDATE                  
       AND EDT >= @@OPENDATE                  
       GROUP BY CLTCODE                  
     ) T                  
    GROUP BY CLTCODE                  
    ORDER BY CLTCODE                  
                  
    INSERT INTO #TEMPTABLE_GL                  
    SELECT        
     L.BOOKTYPE,                  
     VOUDT1=L.VDT,                  
     EFFDT1=L.EDT,                  
     ISNULL(SHORTDESC,'') SHORTDESC,                  
     DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                  
     CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                  
     L.VNO,                  
     REPLACE( L.NARRATION,'"','') NARRATION,                  
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),               
     L.CLTCODE,                  
     A.LONGNAME,                  
     VDT,                  
     L.VTYP,                  
     ACCAT,                  
     OPBAL=0,                  
     CROSAC='',                  
     A.ACNAME,                  
     A.BRANCHCODE,                  
     L.LNO                  
    FROM                  
     LEDGER L,                  
     ACMAST A,                  
     VMAST V                  
    WHERE                  
     VTYP = VTYPE                  
     AND A.CLTCODE = L.CLTCODE                  
     AND L.CLTCODE BETWEEN @FCODE AND @TCODE                  
     AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                  
     AND L.VTYP <> 18                  
     AND (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')                  
    ORDER BY                  
     L.CLTCODE,                  
     VOUDT1,                  
     L.VTYP DESC,                  
     L.VNO                  
   END                  
  ELSE                  
   BEGIN         
print 'nse'             
    INSERT INTO #OPBAL                  
    SELECT                  
     CLTCODE,                  
     SUM(OPBAL) OPBAL                  
    FROM                  
     (                  
      SELECT                  
       L2.CLTCODE,                  
       SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                  
      FROM                  
       LEDGER2 L2,                  
       LEDGER L --, COSTMAST C                
      WHERE                  
       VDT LIKE @@OPENDATE + '%' AND VTYPE = 18          
       AND L.VNO=L2.VNO                  
       AND L.VTYP=L2.VTYPE                  
       AND L.BOOKTYPE=L2.BOOKTYPE                  
       AND L.LNO=L2.LNO       
  --AND L2.COSTCODE = @@costcode                  
        --AND C.COSTNAME = @BRANCH                
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)  
        AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                  
      GROUP BY                  
       L2.CLTCODE                  
      UNION ALL                  
   SELECT                  
       L2.CLTCODE,                  
       SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                  
      FROM                  
       LEDGER2 L2,                  
       LEDGER L    --, COSTMAST C                           
      WHERE                  
       EDT >= @@OPENDATE AND EDT < @FDATE AND VTYPE <> 18          
       AND L.VNO=L2.VNO                  
       AND L.VTYP=L2.VTYPE                  
       AND L.BOOKTYPE=L2.BOOKTYPE                  
       AND L.LNO=L2.LNO            
       --AND L2.COSTCODE = @@costcode                
       --AND C.COSTNAME = @BRANCH                
       AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)  
       AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                  
      GROUP BY                  
       L2.CLTCODE                  
      UNION ALL          
       SELECT                  
        L2.CLTCODE,                  
        SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) AS OPBAL                  
       FROM                  
        LEDGER2 L2,                  
        LEDGER L , COSTMAST C    
       WHERE                  
        L.VNO=L2.VNO                  
        AND L.VTYP=L2.VTYPE                  
        AND L.BOOKTYPE=L2.BOOKTYPE                  
        AND L.LNO=L2.LNO                  
        AND VDT < @@OPENDATE                  
        AND EDT >= @@OPENDATE       
  AND L2.COSTCODE = @@costcode                   
  AND C.COSTNAME = @BRANCH                
        AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                  
       GROUP BY                  
        L2.CLTCODE                  
     ) T                  
    GROUP BY                  
     CLTCODE                  
    ORDER BY                  
    CLTCODE                  
    INSERT INTO #TEMPTABLE_GL                  
    SELECT                  
     L.BOOKTYPE,          
     VOUDT1=L.VDT,                  
     EFFDT1=L.EDT,                  
     ISNULL(SHORTDESC,'') SHORTDESC,                  
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                  
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                  
     L.VNO,                  
     REPLACE(L.NARRATION,'"','') NARRATION,                  
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                  
     L2.CLTCODE,                  
     A.LONGNAME,                  
     VDT,                  
     L.VTYP,                  
     ACCAT,               
     OPBAL=0,                  
     CROSAC='',                  
     A.ACNAME,                  
     A.BRANCHCODE,                  
     L.LNO                  
    FROM                  
     LEDGER L,                  
     VMAST V,                  
     LEDGER2 L2,                  
     ACMAST A/*,                  
     COSTMAST C */                 
    WHERE                  
     L.VNO = L2.VNO                  
     AND L.VTYP = L2.VTYPE                  
     AND L.BOOKTYPE = L2.BOOKTYPE                  
     AND L.LNO = L2.LNO                  
     AND A.CLTCODE = L2.CLTCODE                  
     AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                  
     AND L.VTYP = V.VTYPE                  
     AND A.ACCAT <> '4'                  
     AND L2.CLTCODE=A.CLTCODE                  
     --AND COSTNAME = RTRIM(@BRANCH)                  
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)     
     AND L2.VTYPE <> 18                  
     AND L2.COSTCODE = C.COSTCODE                  
     AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                  
    ORDER BY                  
     L2.CLTCODE,                  
     VOUDT1,                  
     L.VTYP DESC,                  
     L.VNO                  
   END                  
 END                  
                  
UPDATE                  
 #TEMPTABLE_GL                  
SET                  
 OPBAL = L.OPBAL                  
FROM                  
 #OPBAL L            
WHERE                  
 #TEMPTABLE_GL.CLTCODE = L.CLTCODE                  
                  
UPDATE                  
 #TEMPTABLE_GL                  
SET                  
 CROSAC = L.CLTCODE                  
FROM                  
 LEDGER L                  
WHERE                  
 L.VTYP IN('2','3')                  
 AND #TEMPTABLE_GL.VTYP = L.VTYP                  
 AND #TEMPTABLE_GL.BOOKTYPE = L.BOOKTYPE                  
 AND #TEMPTABLE_GL.VNO = L.VNO                  
 AND #TEMPTABLE_GL.CLTCODE <> L.CLTCODE                  
                  
UPDATE                  
 #TEMPTABLE_GL                  
SET                  
 BRANCHCODE = COSTNAME                  
FROM                  
 LEDGER2 L2,                  
 #COSTMAST C                  
WHERE                  
 #TEMPTABLE_GL.VNO = L2.VNO                  
 AND #TEMPTABLE_GL.VTYP = L2.VTYPE                  
 AND #TEMPTABLE_GL.BOOKTYPE = L2.BOOKTYPE               
 AND #TEMPTABLE_GL.LNO = L2.LNO                  
 AND #TEMPTABLE_GL.CLTCODE = L2.CLTCODE                  
 AND L2.COSTCODE = C.COSTCODE              
        
DELETE #TEMPTABLE_GL WHERE  VTYP=18        
        
INSERT INTO #TEMPTABLE_GL        
SELECT '','','','',0,0,'','','',CLTCODE,'','',18,'',OPBAL,CLTCODE,'','',''                    
FROM #OPBAL WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TEMPTABLE_GL WHERE VTYP<>18)             
               
SELECT                  
 BOOKTYPE,                  
 VOUDT = CONVERT(VARCHAR(11),CONVERT(DATETIME, CONVERT(VARCHAR(11), VOUDT1, 109)), 103),        
 EFFDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, CONVERT(VARCHAR(11), EFFDT1, 109)), 103),        
 SHORTDESC,                  
 DRAMT,                  
 CRAMT,                  
 VNO,                  
 NARRATION,                  
 DDNO,                  
 CLTCODE,                  
 LONGNAME,                  
 VDT,          
 VTYP,                  
 ACCAT,                  
 OPBAL,                  
 CROSAC,                  
 ACNAME,                  
 BRANCHCODE,                  
 LNO                  
FROM                  
 #TEMPTABLE_GL                  
ORDER BY                  
 CLTCODE,
VDT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GlReport_dd
-- --------------------------------------------------
    
    
      
/*      
RPT_ACC_GLREPORT '01/04/2011', '31/03/2012', 'Apr  1 2011', 'May 10 2011', '99988', '99988', 'region', 'ahmedabad', 'ahmedabad','vdt', 'Segment', 'codewise', 'GL',''      
      
*/      
CREATE PROC [dbo].[rpt_Acc_GlReport_dd]                      
 @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
 @EDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
 @FCODE VARCHAR(10),                      
 @TCODE VARCHAR(10),                      
 @STATUSID VARCHAR(30),                      
 @STATUSNAME VARCHAR(30),                      
 @BRANCH VARCHAR(10),                      
 @SELECTIONBY VARCHAR(3),                      
 @GROUPBY VARCHAR(10),                      
 @SORTBY VARCHAR(50),                      
 @REPORTNAME VARCHAR(30),                      
 @REPORTOPT VARCHAR(10) = ''                     
                      
AS        
DECLARE                      
 @@OPENDATE AS VARCHAR(11),        
 @@COSTCODE AS SMALLINT,        
 @SHAREDB AS VARCHAR(25),        
 @@SQL AS VARCHAR(1000)        
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                      
                      
SELECT @@OPENDATE = CONVERT(VARCHAR(11),SDTCUR,109) FROM PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR                   
                      
SELECT CLTCODE,VAMT AS OPBAL INTO #OPBAL FROM LEDGER  WHERE 1 =2                      
                
CREATE TABLE [DBO].[#TEMPTABLE_GL] (                    
  [BOOKTYPE] [CHAR] (2)  NULL ,                    
  [VOUDT1] [VARCHAR] (20) NULL ,                    
  [EFFDT1] [VARCHAR] (20) NULL ,                    
  [SHORTDESC] [CHAR] (6) NULL ,                    
  [DRAMT] [MONEY] NULL ,                    
  [CRAMT] [MONEY] NULL ,                    
  [VNO] [VARCHAR] (12) NULL ,                    
  [NARRATION] [VARCHAR] (234) NULL ,                
  [DDNO] [VARCHAR] (15) NULL ,                    
  [CLTCODE] [VARCHAR] (10) NOT NULL ,                
  [LONGNAME] [VARCHAR] (100) NULL ,                
  [VDT] [DATETIME] NULL ,                      
  [VTYP] [SMALLINT] NULL ,                    
  [ACCAT] [VARCHAR] (30) NULL ,                    
  [OPBAL] [MONEY] NULL ,                    
  [CROSAC] [VARCHAR] (10) NULL ,                    
  [ACNAME] [VARCHAR] (150) NULL ,                 
  [BRANCHCODE] [VARCHAR] (20) NULL ,                
  [LNO][SMALLINT] NULL,                
 )            
 SET @SHAREDB = 'MSAJAG'      
 CREATE TABLE #COSTMAST      
 (      
  COSTCODE INT,      
  COSTNAME VARCHAR(50)      
 )      
      
 IF @STATUSID = 'REGION'      
 BEGIN      
  SET @@SQL = 'INSERT INTO #COSTMAST'      
  SET @@SQL = @@SQL + ' SELECT COSTCODE, COSTNAME FROM COSTMAST C,'+ @SHAREDB +'.DBO.REGION R WHERE REGIONCODE = RTRIM('+@STATUSNAME+') AND COSTNAME = BRANCH_CODE'      
 END      
      
 IF @STATUSID = 'AREA'      
 BEGIN      
  SET @@SQL = 'INSERT INTO #COSTMAST'      
  SET @@SQL = @@SQL + ' SELECT COSTCODE ,COSTNAME FROM COSTMAST C,'+ @SHAREDB +'.DBO.AREA A WHERE AREACODE = RTRIM('+@STATUSNAME+') AND COSTNAME = BRANCH_CODE'      
 END      
      
 IF @STATUSID = 'BRANCH'      
 BEGIN        
  SET @@SQL = 'INSERT INTO #COSTMAST'        
  --SET @@SQL = @@SQL + ' SELECT COSTCODE,COSTNAME FROM COSTMAST WHERE COSTNAME = RTRIM(''+@STATUSNAME+'')'  
  SET @@SQL = @@SQL + ' SELECT COSTCODE,COSTNAME FROM COSTMAST '       
 END       
 PRINT(@@SQL)        
 EXEC(@@SQL)      
      
      
--select @@costcode=costcode from costmast where costname=@BRANCH        
        
IF @SELECTIONBY = 'VDT'                      
 BEGIN                      
  IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                      
   BEGIN               
  INSERT INTO #OPBAL          
  SELECT CLTCODE, SUM(OPBAL) FROM                     
  (          
   SELECT                      
   CLTCODE,                      
   OPBAL = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)                      
   FROM                      
LEDGER                      
   WHERE                      
    CLTCODE BETWEEN @FCODE AND @TCODE                      
    AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                  
   GROUP BY           
    CLTCODE     
           
   UNION ALL          
   SELECT                      
    CLTCODE,                      
    OPBAL = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)           
   FROM                      
    LEDGER                      
   WHERE                      
    CLTCODE BETWEEN @FCODE AND @TCODE                      
    AND VDT >= @@OPENDATE AND VDT < @FDATE AND VTYP <> 18                  
   GROUP BY CLTCODE           
   ) A          
   GROUP BY          
    CLTCODE          
   ORDER BY           
    CLTCODE              
                   
                      
  INSERT INTO #TEMPTABLE_GL                      
  SELECT                      
   L.BOOKTYPE,                      
   VOUDT1=L.VDT,                      
   EFFDT1=L.EDT,                      
   ISNULL(SHORTDESC,'') SHORTDESC,                      
   DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                      
   CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                      
   L.VNO,                      
   REPLACE( L.NARRATION,'"','') NARRATION,                      
   DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                      
   L.CLTCODE,                      
   A.LONGNAME,                      
   VDT,                      
   L.VTYP,                      
   ACCAT,                      
   OPBAL=0,                      
   CROSAC='',                      
   A.ACNAME,                
   A.BRANCHCODE,                      
   L.LNO                      
  FROM                      
   LEDGER L,                      
   ACMAST A,                      
   VMAST V                      
  WHERE                      
   L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                      
   AND VTYP = VTYPE                      
   AND L.CLTCODE = A.CLTCODE                      
   AND L.CLTCODE BETWEEN @FCODE AND @TCODE                      
   AND (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')                      
  ORDER BY                      
   L.CLTCODE,                      
   VOUDT1,                      
   L.VTYP DESC,                      
   L.VNO                      
    END                      
   ELSE                      
    BEGIN             
     INSERT INTO #OPBAL                      
  SELECT                      
   CLTCODE,                      
   SUM(OPBAL) FROM         
   (        
   SELECT L2.CLTCODE ,SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                      
  FROM                      
   LEDGER2 L2,                      
   LEDGER L  ,  
costmast c      
  WHERE                      
   L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
   AND L.VTYP=L2.VTYPE                      
   AND L.BOOKTYPE=L2.BOOKTYPE                      
   AND L.VNO=L2.VNO                      
   AND L.LNO=L2.LNO             
   AND L2.COSTCODE = @@costcode                       
   AND C.COSTNAME = @BRANCH                   
   AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)      
   AND VDT LIKE @@OPENDATE + '%' AND L2.VTYPE = 18              
  GROUP BY L2.CLTCODE                      
        
    UNION ALL        
             
    SELECT                      
     L2.CLTCODE,                      
     SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                      
    FROM                      
     LEDGER2 L2,                      
     LEDGER L  ,  
costmast c    
    WHERE                      
     L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
     AND L.VTYP=L2.VTYPE                      
     AND L.BOOKTYPE=L2.BOOKTYPE                      
     AND L.VNO=L2.VNO                      
     AND L.LNO=L2.LNO           
 AND L2.COSTCODE = @@costcode                 
 AND C.COSTNAME = @BRANCH         
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)                 
     AND VDT >= @@OPENDATE AND VDT < @FDATE AND VTYPE <> 18                      
    GROUP BY L2.CLTCODE                      
    ) T1           
    GROUP BY CLTCODE                      
 ORDER BY CLTCODE               
        
                      
    INSERT INTO #TEMPTABLE_GL       
    SELECT                  
     L.BOOKTYPE,                      
     VOUDT1=L.VDT,                      
     EFFDT1=L.EDT,                      
     ISNULL(SHORTDESC,'') SHORTDESC,                      
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                      
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                      
     L.VNO,                      
     REPLACE( L.NARRATION,'"','') NARRATION,                      
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                      
     L2.CLTCODE,                      
     A.LONGNAME,                      
     VDT,                      
     L.VTYP,                      
     ACCAT,                      
     OPBAL=0,                      
     CROSAC='',                      
     A.ACNAME,                      
     A.BRANCHCODE,                      
     L.LNO                      
    FROM                      
     LEDGER L,                      
     VMAST V,                      
     LEDGER2 L2,                      
     ACMAST A,                      
     COSTMAST C       
    WHERE                      
     L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                      
     AND L.VTYP = L2.VTYPE                      
     AND  L.VNO = L2.VNO                      
     AND L.LNO = L2.LNO                      
     AND L.BOOKTYPE = L2.BOOKTYPE                      
     AND L2.CLTCODE=A.CLTCODE                      
     AND L.VTYP = V.VTYPE                      
     AND L2.CLTCODE BETWEEN @FCODE AND  @TCODE                      
     AND A.ACCAT <> '4'                      
     AND COSTNAME = RTRIM(@BRANCH)                      
     AND L2.COSTCODE = C.COSTCODE         
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)      
     AND  L2.VTYPE <> 18                      
    ORDER BY                      
     L2.CLTCODE,                      
     VOUDT1,              
     L.VTYP DESC,                      
     L.VNO                      
   END                      
 END                      
ELSE                      
 BEGIN                      
  IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                      
   BEGIN                      
    INSERT INTO #OPBAL                      
    SELECT                      
     CLTCODE,                      
     SUM(OPBAL) OPBAL                      
    FROM                      
     (                      
      SELECT                      
       CLTCODE,                      
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL                      
      FROM                      
       LEDGER                      
      WHERE                      
       CLTCODE BETWEEN @FCODE AND @TCODE                      
       AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18           
                  
      GROUP BY                      
       CLTCODE                      
  UNION ALL              
  SELECT                      
       CLTCODE,                      
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL                      
      FROM                      
       LEDGER                      
      WHERE                      
       CLTCODE BETWEEN @FCODE AND @TCODE                      
       AND EDT >= @@OPENDATE AND EDT < @FDATE AND VTYP <> 18                      
      GROUP BY                      
       CLTCODE                 
     UNION ALL                      
      SELECT                      
       CLTCODE,                             SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) AS OPBAL                      
      FROM                      
       LEDGER                      
      WHERE                      
       CLTCODE BETWEEN  @FCODE AND  @TCODE                      
       AND VDT < @@OPENDATE                      
       AND EDT >= @@OPENDATE                      
       GROUP BY CLTCODE                      
     ) T                      
    GROUP BY CLTCODE                      
    ORDER BY CLTCODE                      
                      
    INSERT INTO #TEMPTABLE_GL                      
    SELECT            
     L.BOOKTYPE,                   
     VOUDT1=L.VDT,                      
     EFFDT1=L.EDT,                      
     ISNULL(SHORTDESC,'') SHORTDESC,                      
     DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                      
     CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                      
     L.VNO,                      
     REPLACE( L.NARRATION,'"','') NARRATION,                      
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                   
     L.CLTCODE,                      
     A.LONGNAME,                      
     VDT,                      
     L.VTYP,                      
     ACCAT,                      
     OPBAL=0,                      
     CROSAC='',                      
     A.ACNAME,                      
     A.BRANCHCODE,                      
     L.LNO                      
    FROM                      
     LEDGER L,                      
     ACMAST A,                      
     VMAST V                      
    WHERE                      
     VTYP = VTYPE                      
     AND A.CLTCODE = L.CLTCODE                      
     AND L.CLTCODE BETWEEN @FCODE AND @TCODE                      
     AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                      
     AND L.VTYP <> 18                      
     AND (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')                      
    ORDER BY                      
     L.CLTCODE,                      
     VOUDT1,                      
     L.VTYP DESC,                      
     L.VNO                      
   END                      
  ELSE                      
   BEGIN             
print 'nse'                 
    INSERT INTO #OPBAL                      
    SELECT                      
     CLTCODE,                      
     SUM(OPBAL) OPBAL                      
    FROM                      
     (                      
      SELECT                      
       L2.CLTCODE,                      
       SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                      
      FROM                      
       LEDGER2 L2,                      
       LEDGER L , COSTMAST C                    
      WHERE                      
       VDT LIKE @@OPENDATE + '%' AND VTYPE = 18              
       AND L.VNO=L2.VNO                      
       AND L.VTYP=L2.VTYPE                      
       AND L.BOOKTYPE=L2.BOOKTYPE                      
       AND L.LNO=L2.LNO           
  AND L2.COSTCODE = @@costcode                      
        AND C.COSTNAME = @BRANCH                    
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)      
        AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
      GROUP BY                      
       L2.CLTCODE                      
      UNION ALL                      
   SELECT                      
       L2.CLTCODE,                      
       SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                      
      FROM                      
       LEDGER2 L2,                      
       LEDGER L   , COSTMAST C                               
      WHERE                      
       EDT >= @@OPENDATE AND EDT < @FDATE AND VTYPE <> 18              
       AND L.VNO=L2.VNO                      
       AND L.VTYP=L2.VTYPE     
       AND L.BOOKTYPE=L2.BOOKTYPE                      
       AND L.LNO=L2.LNO                
       AND L2.COSTCODE = @@costcode                    
       AND C.COSTNAME = @BRANCH                    
       AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)      
       AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
      GROUP BY                      
       L2.CLTCODE                      
      UNION ALL              
       SELECT                      
        L2.CLTCODE,                      
        SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) AS OPBAL                      
       FROM                      
        LEDGER2 L2,                      
        LEDGER L , COSTMAST C        
       WHERE                      
        L.VNO=L2.VNO                      
        AND L.VTYP=L2.VTYPE                      
        AND L.BOOKTYPE=L2.BOOKTYPE                      
        AND L.LNO=L2.LNO                      
        AND VDT < @@OPENDATE                      
        AND EDT >= @@OPENDATE           
  AND L2.COSTCODE = @@costcode                       
  AND C.COSTNAME = @BRANCH                    
        AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
       GROUP BY                      
        L2.CLTCODE                      
     ) T                      
    GROUP BY                      
     CLTCODE                      
    ORDER BY                      
    CLTCODE                      
    INSERT INTO #TEMPTABLE_GL                      
    SELECT                      
     L.BOOKTYPE,              
     VOUDT1=L.VDT,                      
     EFFDT1=L.EDT,                      
     ISNULL(SHORTDESC,'') SHORTDESC,                      
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                      
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                      
     L.VNO,                      
     REPLACE(L.NARRATION,'"','') NARRATION,                      
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                      
     L2.CLTCODE,                      
     A.LONGNAME,                      
     VDT,                      
     L.VTYP,                      
     ACCAT,                   
     OPBAL=0,                      
     CROSAC='',                      
     A.ACNAME,                      
     A.BRANCHCODE,                      
     L.LNO                      
    FROM                      
     LEDGER L,                      
     VMAST V,                      
     LEDGER2 L2,                      
     ACMAST A,                      
     COSTMAST C                      
    WHERE                      
     L.VNO = L2.VNO                      
     AND L.VTYP = L2.VTYPE                      
     AND L.BOOKTYPE = L2.BOOKTYPE                      
     AND L.LNO = L2.LNO                      
     AND A.CLTCODE = L2.CLTCODE                      
     AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
     AND L.VTYP = V.VTYPE                      
     AND A.ACCAT <> '4'                      
     AND L2.CLTCODE=A.CLTCODE                      
     AND COSTNAME = RTRIM(@BRANCH)                      
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)         
     AND L2.VTYPE <> 18                      
     AND L2.COSTCODE = C.COSTCODE                      
     AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                      
    ORDER BY                      
     L2.CLTCODE,                      
     VOUDT1,                      
     L.VTYP DESC,                      
     L.VNO                      
   END                      
 END                      
                      
UPDATE                      
 #TEMPTABLE_GL                      
SET                      
 OPBAL = L.OPBAL                      
FROM                      
 #OPBAL L                
WHERE                      
 #TEMPTABLE_GL.CLTCODE = L.CLTCODE                      
                      
UPDATE                      
 #TEMPTABLE_GL                      
SET                      
 CROSAC = L.CLTCODE                      
FROM                      
 LEDGER L                      
WHERE                      
 L.VTYP IN('2','3')                      
 AND #TEMPTABLE_GL.VTYP = L.VTYP                      
 AND #TEMPTABLE_GL.BOOKTYPE = L.BOOKTYPE                      
 AND #TEMPTABLE_GL.VNO = L.VNO                      
 AND #TEMPTABLE_GL.CLTCODE <> L.CLTCODE                      
                      
UPDATE                      
 #TEMPTABLE_GL                      
SET                      
 BRANCHCODE = COSTNAME                      
FROM                      
 LEDGER2 L2,                      
 #COSTMAST C                      
WHERE                      
 #TEMPTABLE_GL.VNO = L2.VNO                      
 AND #TEMPTABLE_GL.VTYP = L2.VTYPE                      
 AND #TEMPTABLE_GL.BOOKTYPE = L2.BOOKTYPE                   
 AND #TEMPTABLE_GL.LNO = L2.LNO                      
 AND #TEMPTABLE_GL.CLTCODE = L2.CLTCODE                      
 AND L2.COSTCODE = C.COSTCODE                  
            
DELETE #TEMPTABLE_GL WHERE  VTYP=18            
            
INSERT INTO #TEMPTABLE_GL            
SELECT '','','','',0,0,'','','',CLTCODE,'','',18,'',OPBAL,CLTCODE,'','',''                        
FROM #OPBAL WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TEMPTABLE_GL WHERE VTYP<>18)                 
                   
SELECT                      
 BOOKTYPE,                      
 VOUDT = CONVERT(VARCHAR(11),CONVERT(DATETIME, CONVERT(VARCHAR(11), VOUDT1, 109)), 103),            
 EFFDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, CONVERT(VARCHAR(11), EFFDT1, 109)), 103),            
 SHORTDESC,                      
 DRAMT,                      
 CRAMT,                      
 VNO,                      
 NARRATION,                      
 DDNO,                      
 CLTCODE,                      
 LONGNAME,                      
 VDT,              
 VTYP,                      
 ACCAT,                      
 OPBAL,                      
 CROSAC,                      
 ACNAME,                      
 BRANCHCODE,                      
 LNO                      
FROM                      
 #TEMPTABLE_GL                      
ORDER BY                      
 CLTCODE,    
VDT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rpt_Acc_GlReport_SEBI
-- --------------------------------------------------
    
      
/*      
RPT_ACC_GLREPORT '01/04/2012', '31/03/2013', 'Apr  1 2012', 'Aug 10 2012', '99890', '99890', 'BROKER', 'BROKER', '%','vdt', 'Segment', 'codewise', 'GL',''      
      
*/      
CREATE PROC [dbo].[rpt_Acc_GlReport_SEBI]                      
 @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
 @EDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                      
 @FCODE VARCHAR(10),                      
 @TCODE VARCHAR(10),                      
 @STATUSID VARCHAR(30),                      
 @STATUSNAME VARCHAR(30),                      
 @BRANCH VARCHAR(10),                      
 @SELECTIONBY VARCHAR(3),                      
 @GROUPBY VARCHAR(10),                      
 @SORTBY VARCHAR(50),                      
 @REPORTNAME VARCHAR(30),                      
 @REPORTOPT VARCHAR(10) = ''                     
                      
AS        


DECLARE                      
 @@OPENDATE AS VARCHAR(11),        
 @@COSTCODE AS SMALLINT,        
 @SHAREDB AS VARCHAR(25),        
 @@SQL AS VARCHAR(1000)        
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                      
                      
SELECT @@OPENDATE = CONVERT(VARCHAR(11),SDTCUR,109) FROM PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR                   
                      
SELECT CLTCODE,VAMT AS OPBAL INTO #OPBAL FROM ledger_SEBI  WHERE 1 =2                      
                
CREATE TABLE [DBO].[#TEMPTABLE_GL] (                    
  [BOOKTYPE] [CHAR] (2)  NULL ,                    
  [VOUDT1] [VARCHAR] (20) NULL ,                    
  [EFFDT1] [VARCHAR] (20) NULL ,                    
  [SHORTDESC] [CHAR] (6) NULL ,                    
  [DRAMT] [MONEY] NULL ,                    
  [CRAMT] [MONEY] NULL ,                    
  [VNO] [VARCHAR] (12) NULL ,                    
  [NARRATION] [VARCHAR] (234) NULL ,                
  [DDNO] [VARCHAR] (15) NULL ,                    
  [CLTCODE] [VARCHAR] (10) NOT NULL ,                
  [LONGNAME] [VARCHAR] (100) NULL ,                
  [VDT] [DATETIME] NULL ,                      
  [VTYP] [SMALLINT] NULL ,                    
  [ACCAT] [VARCHAR] (30) NULL ,                    
  [OPBAL] [MONEY] NULL ,                    
  [CROSAC] [VARCHAR] (10) NULL ,                    
  [ACNAME] [VARCHAR] (150) NULL ,                 
  [BRANCHCODE] [VARCHAR] (20) NULL ,                
  [LNO][SMALLINT] NULL,                
 )            
 SET @SHAREDB = 'MSAJAG'      
 CREATE TABLE #COSTMAST      
 (      
  COSTCODE INT,      
  COSTNAME VARCHAR(50)      
 )      
      
 IF @STATUSID = 'REGION'      
 BEGIN      
  SET @@SQL = 'INSERT INTO #COSTMAST'      
  SET @@SQL = @@SQL + ' SELECT COSTCODE, COSTNAME FROM COSTMAST C,'+ @SHAREDB +'.DBO.REGION R WHERE REGIONCODE = RTRIM('+@STATUSNAME+') AND COSTNAME = BRANCH_CODE'      
 END      
      
 IF @STATUSID = 'AREA'      
 BEGIN      
  SET @@SQL = 'INSERT INTO #COSTMAST'      
  SET @@SQL = @@SQL + ' SELECT COSTCODE ,COSTNAME FROM COSTMAST C,'+ @SHAREDB +'.DBO.AREA A WHERE AREACODE = RTRIM('+@STATUSNAME+') AND COSTNAME = BRANCH_CODE'      
 END      
      
 IF @STATUSID = 'BRANCH'      
 BEGIN        
  SET @@SQL = 'INSERT INTO #COSTMAST'        
  --SET @@SQL = @@SQL + ' SELECT COSTCODE,COSTNAME FROM COSTMAST WHERE COSTNAME = RTRIM(''+@STATUSNAME+'')'   
  SET @@SQL = @@SQL + ' SELECT COSTCODE,COSTNAME FROM COSTMAST '        
       
 END       
 PRINT(@@SQL)        
 EXEC(@@SQL)      
      
      
--select @@costcode=costcode from costmast where costname=@BRANCH        
        
IF @SELECTIONBY = 'VDT'                      
 BEGIN                      
  IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                      
   BEGIN               
  INSERT INTO #OPBAL          
  SELECT CLTCODE, SUM(OPBAL) FROM                     
  (          
   SELECT                      
   CLTCODE,                      
   OPBAL = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)                      
   FROM                      
   ledger_SEBI                      
   WHERE                      
    CLTCODE BETWEEN @FCODE AND @TCODE                      
    AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                  
   GROUP BY           
    CLTCODE     
           
   UNION ALL          
   SELECT                      
    CLTCODE,                      
    OPBAL = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)           
   FROM                      
    ledger_SEBI                      
   WHERE                      
    CLTCODE BETWEEN @FCODE AND @TCODE                      
    AND VDT >= @@OPENDATE AND VDT < @FDATE AND VTYP <> 18                  
   GROUP BY CLTCODE           
   ) A          
   GROUP BY          
    CLTCODE          
   ORDER BY           
    CLTCODE              
                   
                      
  INSERT INTO #TEMPTABLE_GL                      
  SELECT                      
   L.BOOKTYPE,                      
   VOUDT1=L.VDT,                      
   EFFDT1=L.EDT,                      
   ISNULL(SHORTDESC,'') SHORTDESC,                      
   DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                      
   CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                      
   L.VNO,                      
   REPLACE( L.NARRATION,'"','') NARRATION,                      
   DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                      
   L.CLTCODE,                      
   A.LONGNAME,                      
   VDT,                      
   L.VTYP,                      
   ACCAT,                      
   OPBAL=0,                      
   CROSAC='',                      
   A.ACNAME,                
   A.BRANCHCODE,                      
   L.LNO                      
  FROM                      
   ledger_SEBI L,                      
   ACMAST A,                      
   VMAST V                      
  WHERE                      
   L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                      
   AND VTYP = VTYPE                      
   AND L.CLTCODE = A.CLTCODE                      
   AND L.CLTCODE BETWEEN @FCODE AND @TCODE                      
   AND (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')                      
  ORDER BY                      
   L.CLTCODE,                      
   VOUDT1,                      
   L.VTYP DESC,                      
   L.VNO                      
    END                      
   ELSE                      
    BEGIN             
     INSERT INTO #OPBAL                      
  SELECT                      
   CLTCODE,                      
   SUM(OPBAL) FROM         
   (        
   SELECT L2.CLTCODE ,SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                      
  FROM                      
   LEDGER2 L2,                      
   ledger_SEBI L      
  WHERE                      
   L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
   AND L.VTYP=L2.VTYPE                      
   AND L.BOOKTYPE=L2.BOOKTYPE                      
   AND L.VNO=L2.VNO                      
   AND L.LNO=L2.LNO             
   --AND L2.COSTCODE = @@costcode                       
   --AND C.COSTNAME = @BRANCH                   
   AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)      
   AND VDT LIKE @@OPENDATE + '%' AND L2.VTYPE = 18              
  GROUP BY L2.CLTCODE                      
        
    UNION ALL        
             
    SELECT                      
     L2.CLTCODE,                      
     SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                      
    FROM                      
     LEDGER2 L2,                      
     ledger_SEBI L      
    WHERE                      
     L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
     AND L.VTYP=L2.VTYPE                      
     AND L.BOOKTYPE=L2.BOOKTYPE                      
     AND L.VNO=L2.VNO                      
     AND L.LNO=L2.LNO           
 --AND L2.COSTCODE = @@costcode                      
 --AND C.COSTNAME = @BRANCH         
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)                 
     AND VDT >= @@OPENDATE AND VDT < @FDATE AND VTYPE <> 18                      
    GROUP BY L2.CLTCODE                      
    ) T1           
    GROUP BY CLTCODE                      
 ORDER BY CLTCODE               
        
                      
    INSERT INTO #TEMPTABLE_GL       
    SELECT                  
     L.BOOKTYPE,                      
     VOUDT1=L.VDT,                      
     EFFDT1=L.EDT,                      
     ISNULL(SHORTDESC,'') SHORTDESC,                      
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                      
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                      
     L.VNO,                      
     REPLACE( L.NARRATION,'"','') NARRATION,                      
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                      
     L2.CLTCODE,                      
     A.LONGNAME,                      
     VDT,                      
     L.VTYP,                      
     ACCAT,                      
     OPBAL=0,                      
     CROSAC='',                      
     A.ACNAME,                      
     A.BRANCHCODE,                      
     L.LNO                      
    FROM                      
     ledger_SEBI L,                      
     VMAST V,                      
     LEDGER2 L2,                      
     ACMAST A/*,                      
     COSTMAST C*/       
    WHERE                      
     L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                      
     AND L.VTYP = L2.VTYPE                      
     AND  L.VNO = L2.VNO                      
     AND L.LNO = L2.LNO                      
     AND L.BOOKTYPE = L2.BOOKTYPE                      
     AND L2.CLTCODE=A.CLTCODE                      
     AND L.VTYP = V.VTYPE                      
     AND L2.CLTCODE BETWEEN @FCODE AND  @TCODE                      
     AND A.ACCAT <> '4'                      
     --AND COSTNAME = RTRIM(@BRANCH)                      
     --AND L2.COSTCODE = C.COSTCODE         
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)      
     AND  L2.VTYPE <> 18                      
    ORDER BY                      
     L2.CLTCODE,                      
     VOUDT1,              
     L.VTYP DESC,                      
     L.VNO                      
   END                      
 END                      
ELSE                      
 BEGIN                      
  IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                      
   BEGIN                      
    INSERT INTO #OPBAL                      
    SELECT                      
     CLTCODE,                      
     SUM(OPBAL) OPBAL                      
    FROM                      
     (                      
      SELECT                      
       CLTCODE,                      
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL                      
      FROM                      
       ledger_SEBI                      
      WHERE                      
       CLTCODE BETWEEN @FCODE AND @TCODE                      
       AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18           
                  
      GROUP BY                      
       CLTCODE                      
  UNION ALL              
  SELECT                      
       CLTCODE,                      
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL                      
      FROM                      
       ledger_SEBI                      
      WHERE                      
       CLTCODE BETWEEN @FCODE AND @TCODE                      
       AND EDT >= @@OPENDATE AND EDT < @FDATE AND VTYP <> 18                      
      GROUP BY                      
       CLTCODE                 
     UNION ALL                      
      SELECT                      
       CLTCODE,                      
       SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) AS OPBAL                      
      FROM                      
       ledger_SEBI                      
      WHERE                      
       CLTCODE BETWEEN  @FCODE AND  @TCODE                      
       AND VDT < @@OPENDATE                      
       AND EDT >= @@OPENDATE                      
       GROUP BY CLTCODE                      
     ) T                      
    GROUP BY CLTCODE                      
    ORDER BY CLTCODE                      
                      
    INSERT INTO #TEMPTABLE_GL                      
    SELECT            
     L.BOOKTYPE,                   
     VOUDT1=L.VDT,                      
     EFFDT1=L.EDT,                      
     ISNULL(SHORTDESC,'') SHORTDESC,                      
     DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                      
     CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                      
     L.VNO,                      
     REPLACE( L.NARRATION,'"','') NARRATION,                      
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                   
     L.CLTCODE,                      
     A.LONGNAME,                      
     VDT,                      
     L.VTYP,                      
     ACCAT,                      
     OPBAL=0,                      
     CROSAC='',                      
     A.ACNAME,                      
     A.BRANCHCODE,                      
     L.LNO                      
    FROM                      
     ledger_SEBI L,                      
     ACMAST A,                      
     VMAST V                      
    WHERE                      
     VTYP = VTYPE                      
     AND A.CLTCODE = L.CLTCODE                      
     AND L.CLTCODE BETWEEN @FCODE AND @TCODE                      
     AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                      
     AND L.VTYP <> 18                      
     AND (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')                      
    ORDER BY                      
     L.CLTCODE,                      
     VOUDT1,                      
     L.VTYP DESC,                      
     L.VNO                      
   END                      
  ELSE                      
   BEGIN             
print 'nse'                 
    INSERT INTO #OPBAL                      
    SELECT                      
     CLTCODE,                      
     SUM(OPBAL) OPBAL                      
    FROM                      
     (                      
      SELECT                      
       L2.CLTCODE,                      
       SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                      
      FROM                      
       LEDGER2 L2,                      
       ledger_SEBI L --, COSTMAST C                    
      WHERE                      
       VDT LIKE @@OPENDATE + '%' AND VTYPE = 18              
       AND L.VNO=L2.VNO                      
       AND L.VTYP=L2.VTYPE                      
       AND L.BOOKTYPE=L2.BOOKTYPE                      
       AND L.LNO=L2.LNO           
  --AND L2.COSTCODE = @@costcode                      
        --AND C.COSTNAME = @BRANCH                    
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)      
        AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
      GROUP BY                      
       L2.CLTCODE                      
      UNION ALL                      
   SELECT                      
       L2.CLTCODE,                      
       SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                      
      FROM                      
       LEDGER2 L2,                      
       ledger_SEBI L    --, COSTMAST C                               
      WHERE                      
       EDT >= @@OPENDATE AND EDT < @FDATE AND VTYPE <> 18              
       AND L.VNO=L2.VNO                      
       AND L.VTYP=L2.VTYPE                      
       AND L.BOOKTYPE=L2.BOOKTYPE                      
       AND L.LNO=L2.LNO                
       --AND L2.COSTCODE = @@costcode                    
       --AND C.COSTNAME = @BRANCH                    
       AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)      
       AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
      GROUP BY                      
       L2.CLTCODE                      
      UNION ALL              
       SELECT                      
        L2.CLTCODE,                      
        SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) AS OPBAL                      
       FROM                      
        LEDGER2 L2,                      
        ledger_SEBI L , COSTMAST C        
       WHERE                      
        L.VNO=L2.VNO                      
        AND L.VTYP=L2.VTYPE                      
        AND L.BOOKTYPE=L2.BOOKTYPE                      
        AND L.LNO=L2.LNO                      
        AND VDT < @@OPENDATE                      
        AND EDT >= @@OPENDATE           
  AND L2.COSTCODE = @@costcode                       
  AND C.COSTNAME = @BRANCH                    
        AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
       GROUP BY                      
        L2.CLTCODE                      
     ) T                      
    GROUP BY                      
     CLTCODE                      
    ORDER BY                      
    CLTCODE                      
    INSERT INTO #TEMPTABLE_GL                      
    SELECT                      
     L.BOOKTYPE,              
     VOUDT1=L.VDT,                      
     EFFDT1=L.EDT,                      
     ISNULL(SHORTDESC,'') SHORTDESC,                      
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                      
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                      
     L.VNO,                      
     REPLACE(L.NARRATION,'"','') NARRATION,                      
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                      
     L2.CLTCODE,                      
     A.LONGNAME,                      
     VDT,                      
     L.VTYP,                      
     ACCAT,                   
     OPBAL=0,                      
     CROSAC='',                      
     A.ACNAME,                      
     A.BRANCHCODE,                      
     L.LNO                      
    FROM                      
     ledger_SEBI L,                      
     VMAST V,                      
     LEDGER2 L2,                      
     ACMAST A/*,                      
     COSTMAST C */                     
    WHERE                      
     L.VNO = L2.VNO                      
     AND L.VTYP = L2.VTYPE                      
     AND L.BOOKTYPE = L2.BOOKTYPE                      
     AND L.LNO = L2.LNO                      
     AND A.CLTCODE = L2.CLTCODE                      
     AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                      
     AND L.VTYP = V.VTYPE                      
     AND A.ACCAT <> '4'                      
     AND L2.CLTCODE=A.CLTCODE                      
     --AND COSTNAME = RTRIM(@BRANCH)                      
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)         
     AND L2.VTYPE <> 18                      
     AND L2.COSTCODE = C.COSTCODE                      
     AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                      
    ORDER BY                      
     L2.CLTCODE,                      
     VOUDT1,                      
     L.VTYP DESC,                      
     L.VNO                      
   END                      
 END                      
                      
UPDATE                      
 #TEMPTABLE_GL                      
SET                      
 OPBAL = L.OPBAL                      
FROM                      
 #OPBAL L                
WHERE                      
 #TEMPTABLE_GL.CLTCODE = L.CLTCODE                      
                      
UPDATE                      
 #TEMPTABLE_GL                      
SET                      
 CROSAC = L.CLTCODE                      
FROM                      
 ledger_SEBI L                      
WHERE                      
 L.VTYP IN('2','3')                      
 AND #TEMPTABLE_GL.VTYP = L.VTYP                      
 AND #TEMPTABLE_GL.BOOKTYPE = L.BOOKTYPE                      
 AND #TEMPTABLE_GL.VNO = L.VNO                      
 AND #TEMPTABLE_GL.CLTCODE <> L.CLTCODE                      
                      
UPDATE                      
 #TEMPTABLE_GL                      
SET                      
 BRANCHCODE = COSTNAME                      
FROM                      
 LEDGER2 L2,                      
 #COSTMAST C                      
WHERE                      
 #TEMPTABLE_GL.VNO = L2.VNO                      
 AND #TEMPTABLE_GL.VTYP = L2.VTYPE                      
 AND #TEMPTABLE_GL.BOOKTYPE = L2.BOOKTYPE                   
 AND #TEMPTABLE_GL.LNO = L2.LNO                      
 AND #TEMPTABLE_GL.CLTCODE = L2.CLTCODE                      
 AND L2.COSTCODE = C.COSTCODE                  
            
DELETE #TEMPTABLE_GL WHERE  VTYP=18            
            
INSERT INTO #TEMPTABLE_GL            
SELECT '','','','',0,0,'','','',CLTCODE,'','',18,'',OPBAL,CLTCODE,'','',''                        
FROM #OPBAL WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TEMPTABLE_GL WHERE VTYP<>18)                 
                   
SELECT                      
 BOOKTYPE,                      
 VOUDT = CONVERT(VARCHAR(11),CONVERT(DATETIME, CONVERT(VARCHAR(11), VOUDT1, 109)), 103),            
 EFFDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, CONVERT(VARCHAR(11), EFFDT1, 109)), 103),            
 SHORTDESC,                      
 DRAMT,                      
 CRAMT,                      
 VNO,                      
 NARRATION,                      
 DDNO,                      
 CLTCODE,                      
 LONGNAME,                      
 VDT,              
 VTYP,                      
 ACCAT,                      
 OPBAL,                      
 CROSAC,                      
 ACNAME,                      
 BRANCHCODE,                      
 LNO                      
FROM                      
 #TEMPTABLE_GL                      
ORDER BY                      
 CLTCODE,    
VDT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_LISTCLIENT
-- --------------------------------------------------


CREATE PROCEDURE RPT_ACC_LISTCLIENT
 @STATUSID VARCHAR(15), 
 @STATUSNAME VARCHAR(25), 
 @WHATTOLOOKFOR VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
 @WHICHWAY VARCHAR(1),  -- > OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.
 @COMPARETOWHAT VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.
 @ACCAT VARCHAR(3)  -- ACCOUNT CATEGORY
AS
DECLARE
@STRSQL VARCHAR(2500), 
@@INACCAT VARCHAR(3)
SELECT @@INACCAT = RTRIM(CONVERT(VARCHAR, CONVERT(INT, @ACCAT)+100, 3))
--SET DEFAULT VALUES
SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"
/* SET @BOOKTYPE = @BOOKTYPE + "%" */
--BROKER LOGIN
IF  @STATUSID = "BROKER"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " CLTCODE, "
 SET @STRSQL = @STRSQL + " ACNAME, "
 SET @STRSQL = @STRSQL + " BRANCHCODE "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @WHATTOLOOKFOR + "' AND (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%')" 
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS 
 IF @WHICHWAY = ">"
 BEGIN
  SET @STRSQL = @STRSQL + " AND "
  SET @STRSQL = @STRSQL + " CLTCODE > = '" + @COMPARETOWHAT + "' "
 END
 ELSE
 BEGIN
  IF @WHICHWAY = "<"
  BEGIN
   SET @STRSQL = @STRSQL + " AND "
   SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
  END
 END
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " CLTCODE, "
 SET @STRSQL = @STRSQL + " BRANCHCODE "
END
--BRANCH LOGIN
IF @STATUSID = "BRANCH"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " CLTCODE, "
 SET @STRSQL = @STRSQL + " ACNAME, "
 SET @STRSQL = @STRSQL + " BRANCHCODE "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " (BRANCHCODE LIKE '" + @STATUSNAME + "' OR BRANCHCODE = 'ALL') AND (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%')" 
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
 IF @WHICHWAY = ">"
 BEGIN
  SET @STRSQL = @STRSQL + " AND "
  SET @STRSQL = @STRSQL + " CLTCODE > = '" + @COMPARETOWHAT + "' "
 END
 ELSE
 BEGIN
  IF @WHICHWAY = "<"
  BEGIN
   SET @STRSQL = @STRSQL + " AND "
   SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
  END
 END
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " CLTCODE, "
 SET @STRSQL = @STRSQL + " BRANCHCODE "
END
--SUB-BROKER LOGIN
IF @STATUSID = "SUBBROKER"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME, "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.SUBBROKERS S "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER = S.SUB_BROKER AND "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @WHATTOLOOKFOR + "' "
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
 IF @WHICHWAY = ">"
 BEGIN
  SET @STRSQL = @STRSQL + " AND "
  SET @STRSQL = @STRSQL + " CLTCODE > = '" + @COMPARETOWHAT + "' "
 END
 ELSE
 BEGIN
  IF @WHICHWAY = "<"
  BEGIN
   SET @STRSQL = @STRSQL + " AND "
   SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
  END
 END
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER "
END
--TRADER LOGIN
IF @STATUSID = "TRADER"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME, "
 SET @STRSQL = @STRSQL + " C1.TRADER "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.BRANCHES S "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " C1.TRADER = S.SHORT_NAME  AND "
 SET @STRSQL = @STRSQL + " C1.TRADER LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @WHATTOLOOKFOR + "' "
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
 IF @WHICHWAY = ">"
 BEGIN
  SET @STRSQL = @STRSQL + " AND "
  SET @STRSQL = @STRSQL + " CLTCODE > = '" + @COMPARETOWHAT + "' "
 END
 ELSE
 BEGIN
  IF @WHICHWAY = "<"
  BEGIN
   SET @STRSQL = @STRSQL + " AND "
   SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
  END
 END
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " C1.TRADER "
END
--FAMILY LOGIN
IF @STATUSID = "FAMILY"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME, "
 SET @STRSQL = @STRSQL + " C1.FAMILY "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " C1.FAMILY LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @WHATTOLOOKFOR + "' "
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
 IF @WHICHWAY = ">"
 BEGIN
  SET @STRSQL = @STRSQL + " AND "
  SET @STRSQL = @STRSQL + " CLTCODE > = '" + @COMPARETOWHAT + "' "
 END
 ELSE
 BEGIN
  IF @WHICHWAY = "<"
  BEGIN
   SET @STRSQL = @STRSQL + " AND "
   SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
  END
 END
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " C1.FAMILY "
END
IF @STATUSID = "CLIENT"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @STATUSNAME + "' "
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE "
END
IF @STATUSID = "REGION"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " REGION LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @WHATTOLOOKFOR + "' "
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
 IF @WHICHWAY = ">"
 BEGIN
  SET @STRSQL = @STRSQL + " AND "
  SET @STRSQL = @STRSQL + " CLTCODE > = '" + @COMPARETOWHAT + "' "
 END
 ELSE
 BEGIN
  IF @WHICHWAY = "<"
  BEGIN
   SET @STRSQL = @STRSQL + " AND "
   SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
  END
 END
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE "
END
IF @STATUSID = "AREA"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " REGION LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @WHATTOLOOKFOR + "' "
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
 IF @WHICHWAY = ">"
 BEGIN
  SET @STRSQL = @STRSQL + " AND "
  SET @STRSQL = @STRSQL + " CLTCODE > = '" + @COMPARETOWHAT + "' "
 END
 ELSE
 BEGIN
  IF @WHICHWAY = "<"
  BEGIN
   SET @STRSQL = @STRSQL + " AND "
   SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
  END
 END
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE "
END
 SET @STRSQL = @STRSQL + " OPTION  (FAST 10)"
PRINT @STRSQL
EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_LISTCLIENT_REPORT
-- --------------------------------------------------


CREATE PROCEDURE RPT_ACC_LISTCLIENT_REPORT
 @STATUSID VARCHAR(15), 
 @STATUSNAME VARCHAR(25), 
 @WHATTOLOOKFOR VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
 @WHICHWAY VARCHAR(1),  -- > OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.
 @COMPARETOWHAT VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.
 @ACCAT VARCHAR(3)   -- ACCOUNT CATEGORY
AS
DECLARE
@STRSQL VARCHAR(2500), 
@@INACCAT VARCHAR(3)
SELECT @@INACCAT = RTRIM(CONVERT(VARCHAR, CONVERT(INT, @ACCAT)+100, 3))
--SET DEFAULT VALUES
--SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"
/* SET @BOOKTYPE = @BOOKTYPE + "%" */
--BROKER LOGIN
IF  @STATUSID = "BROKER"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " CLTCODE, "
 SET @STRSQL = @STRSQL + " ACNAME, "
 SET @STRSQL = @STRSQL + " BRANCHCODE "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " CLTCODE > = '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' AND "
 IF @ACCAT = 3  
  SET @STRSQL = @STRSQL + " (ACCAT IN (3, 14, 18) )"  
 ELSE
  SET @STRSQL = @STRSQL + " (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%')"  
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " CLTCODE, "
 SET @STRSQL = @STRSQL + " BRANCHCODE "
END
--BRANCH LOGIN
IF @STATUSID = "BRANCH"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " CLTCODE, "
 SET @STRSQL = @STRSQL + " ACNAME, "
 SET @STRSQL = @STRSQL + " BRANCHCODE "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " CLTCODE > = '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " (BRANCHCODE = '" + @STATUSNAME + "' OR BRANCHCODE = 'ALL') AND "
 SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' AND "
 IF @ACCAT = 3  
  SET @STRSQL = @STRSQL + " (ACCAT IN (3, 14) )"  
 ELSE
  SET @STRSQL = @STRSQL + " (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%')"  
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " CLTCODE, "
 SET @STRSQL = @STRSQL + " BRANCHCODE "
END
--SUB-BROKER LOGIN
IF @STATUSID = "SUBBROKER"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME, "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.SUBBROKERS S "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER = S.SUB_BROKER AND "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE > = '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER "
END
--TRADER LOGIN
IF @STATUSID = "TRADER"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME, "
 SET @STRSQL = @STRSQL + " C1.TRADER "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.BRANCHES S "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " C1.TRADER = S.BRANCH_CD AND "
 SET @STRSQL = @STRSQL + " C1.TRADER LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE > = '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " C1.TRADER "
END
--FAMILY LOGIN
IF @STATUSID = "FAMILY"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME, "
 SET @STRSQL = @STRSQL + " C1.FAMILY "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " C1.FAMILY LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE > = '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " C1.FAMILY "
END
IF @STATUSID = "CLIENT"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @STATUSNAME + "' "
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE "
END
IF @STATUSID = "REGION"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " REGION LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE > = '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE "
END
IF @STATUSID = "AREA"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " REGION LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE > = '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE "
END
 SET @STRSQL = @STRSQL + " OPTION  (FAST 10)"
PRINT @STRSQL
EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_LISTCLIENT_REPORT_ACTYPE_NEW
-- --------------------------------------------------



CREATE PROCEDURE RPT_ACC_LISTCLIENT_REPORT_ACTYPE_NEW  
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),  
 @WHATTOLOOKFOR VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH  
 @WHICHWAY VARCHAR(1),  -- > OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.  
 @COMPARETOWHAT VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.  
 @ACCAT VARCHAR(3),   -- ACCOUNT CATEGORY  
 @ACTYPE VARCHAR(8)  
AS  
  
DECLARE  
@STRSQL VARCHAR(2500),  
@@INACCAT VARCHAR(3)  
  
SELECT @@INACCAT = RTRIM(CONVERT(VARCHAR,CONVERT(INT,@ACCAT)+100,3))  
--SELECT DISTINCT CLTCODE INTO #LEDGERTEMP FROM LEDGER  
  
--SET DEFAULT VALUES  
--SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"  
/* SET @BOOKTYPE = @BOOKTYPE + "%" */  


SET @STRSQL = "SELECT "  
SET @STRSQL = @STRSQL + "DISTINCT "  
SET @STRSQL = @STRSQL + " A.CLTCODE, "  
SET @STRSQL = @STRSQL + " ACNAME, "  
SET @STRSQL = @STRSQL + " BRANCHCODE,C1.FAMILY,C1.SUB_BROKER,C1.TRADER ,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,PHONE=ISNULL(RES_PHONE1,0), PAN=ISNULL(PAN_GIR_NO,'')"  
SET @STRSQL = @STRSQL + "FROM "  
SET @STRSQL = @STRSQL + " ACMAST A"
SET @STRSQL = @STRSQL + ",MCDXCDS.DBO.CLIENT1 C1"
SET @STRSQL = @STRSQL + " WHERE " 
SET @STRSQL = @STRSQL + " A.CLTCODE=C1.CL_CODE AND "  
SET @STRSQL = @STRSQL + " A.CLTCODE IN (SELECT DISTINCT CLTCODE FROM LEDGER) AND "  
IF UPPER(@ACTYPE)='FAMILY'  
 BEGIN    
  SET @STRSQL = @STRSQL + " FAMILY >= '" + @WHATTOLOOKFOR + "' AND "  
  SET @STRSQL = @STRSQL + " FAMILY <= '" + @COMPARETOWHAT + "' AND "  
END  
ELSE  
BEGIN  
  SET @STRSQL = @STRSQL + " A.CLTCODE >= '" + @WHATTOLOOKFOR + "' AND "  
  SET @STRSQL = @STRSQL + " A.CLTCODE <= '" + @COMPARETOWHAT + "' AND "  
END  
IF UPPER(@STATUSID)='BRANCH'
BEGIN
	SET @STRSQL = @STRSQL + " (BRANCHCODE = '" + @STATUSNAME + "' OR BRANCHCODE = 'ALL') AND "
END
ELSE
IF UPPER(@STATUSID)='SUBBROKER'
BEGIN
	SET @STRSQL = @STRSQL + " C1.SUB_BROKER LIKE '" + @STATUSNAME + "' AND "
END
ELSE
IF UPPER(@STATUSID)='TRADER'
BEGIN
	SET @STRSQL = @STRSQL + " C1.TRADER LIKE '" + @STATUSNAME + "' AND "
END
ELSE
IF UPPER(@STATUSID)='FAMILY'
BEGIN
	SET @STRSQL = @STRSQL + " C1.FAMILY LIKE '" + @STATUSNAME + "' AND "
END
ELSE
IF UPPER(@STATUSID)='CLIENT'
BEGIN
	SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @STATUSNAME + "' "
END 
SET @STRSQL = @STRSQL + " (ACCAT LIKE '" + @ACCAT  + "%' "  
IF @ACCAT = '3'  
BEGIN  
  SET @STRSQL = @STRSQL + " OR ACCAT LIKE '14%' "  
END  
SET @STRSQL = @STRSQL + " OR ACCAT LIKE '" + @@INACCAT + "%')  "    
SET @STRSQL = @STRSQL + "ORDER BY "  
SET @STRSQL = @STRSQL + " A.CLTCODE, "  
IF  UPPER(@STATUSID)='BROKER'
BEGIN
	SET @STRSQL = @STRSQL + " BRANCHCODE "  
END
ELSE
IF UPPER(@STATUSID)='BRANCH'
BEGIN
	SET @STRSQL = @STRSQL + " BRANCHCODE "
END
ELSE
IF UPPER(@STATUSID)='SUBBROKER'
BEGIN
	SET @STRSQL = @STRSQL + " C1.SUB_BROKER "
END
ELSE
IF UPPER(@STATUSID)='TRADER'
BEGIN
	SET @STRSQL = @STRSQL + " C1.TRADER "
END
ELSE
IF UPPER(@STATUSID)='FAMILY'
BEGIN
	SET @STRSQL = @STRSQL + " C1.FAMILY "
END
SET @STRSQL = @STRSQL + " OPTION  (FAST 10)"  
  
PRINT @STRSQL  
EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_LISTCLIENT_REPORT_MARGINLEDGER
-- --------------------------------------------------






CREATE PROCEDURE RPT_ACC_LISTCLIENT_REPORT_MARGINLEDGER
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@WHATTOLOOKFOR VARCHAR(25),	--	PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
	@WHICHWAY VARCHAR(1),		--	> OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.
	@COMPARETOWHAT VARCHAR(25),	--	PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.
	@ACCAT VARCHAR(3)			--	ACCOUNT CATEGORY
AS

DECLARE
@STRSQL VARCHAR(2500),
@@INACCAT VARCHAR(3)

SELECT @@INACCAT = RTRIM(CONVERT(VARCHAR,CONVERT(INT,@ACCAT)+100,3))

--SET DEFAULT VALUES
--SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"
/* SET @BOOKTYPE = @BOOKTYPE + "%" */

--BROKER LOGIN
IF  @STATUSID="BROKER"
BEGIN
	SET @STRSQL = "SELECT "
	SET @STRSQL = @STRSQL + "DISTINCT "
	SET @STRSQL = @STRSQL + "	CLTCODE, "
	SET @STRSQL = @STRSQL + "	ACNAME, "
	SET @STRSQL = @STRSQL + "	BRANCHCODE "
	SET @STRSQL = @STRSQL + "FROM "
	SET @STRSQL = @STRSQL + "	ACMAST A, MARGINLEDGER M "
	SET @STRSQL = @STRSQL + "WHERE "
	SET @STRSQL = @STRSQL + "	CLTCODE >= '" + @WHATTOLOOKFOR + "' AND "
	SET @STRSQL = @STRSQL + "	CLTCODE <= '" + @COMPARETOWHAT + "' AND "
	SET @STRSQL = @STRSQL + "	(ACCAT LIKE '" + @ACCAT  + "%' "
	IF @ACCAT = '3'
	BEGIN
		SET @STRSQL = @STRSQL + " OR ACCAT LIKE '14%' "
	END
	SET @STRSQL = @STRSQL + " OR ACCAT LIKE '" + @@INACCAT + "%') AND A.CLTCODE=M.PARTY_CODE "  
	SET @STRSQL = @STRSQL + "ORDER BY "
	SET @STRSQL = @STRSQL + "	CLTCODE, "
	SET @STRSQL = @STRSQL + "	BRANCHCODE "
END

--BRANCH LOGIN
IF @STATUSID="BRANCH"
BEGIN
	SET @STRSQL = "SELECT "
	SET @STRSQL = @STRSQL + "DISTINCT "
	SET @STRSQL = @STRSQL + "	CLTCODE, "
	SET @STRSQL = @STRSQL + "	ACNAME, "
	SET @STRSQL = @STRSQL + "	BRANCHCODE "
	SET @STRSQL = @STRSQL + "FROM "
	SET @STRSQL = @STRSQL + "	ACMAST A, MARGINLEDGER M "
	SET @STRSQL = @STRSQL + "WHERE "
	SET @STRSQL = @STRSQL + "	CLTCODE >= '" + @WHATTOLOOKFOR + "' AND "
	SET @STRSQL = @STRSQL + "	CLTCODE <= '" + @COMPARETOWHAT + "' AND "
	SET @STRSQL = @STRSQL + "	CLTCODE >= '" + @WHATTOLOOKFOR + "' AND "
	SET @STRSQL = @STRSQL + "	(BRANCHCODE = '" + @STATUSNAME + "' OR BRANCHCODE = 'ALL') AND "
	SET @STRSQL = @STRSQL + "	CLTCODE <= '" + @COMPARETOWHAT + "' AND "
	SET @STRSQL = @STRSQL + "	(ACCAT LIKE '" + @ACCAT  + "%' "
	IF @ACCAT = '3'
	BEGIN
		SET @STRSQL = @STRSQL + " OR ACCAT LIKE '14%' "
	END
	SET @STRSQL = @STRSQL + " OR ACCAT LIKE '" + @@INACCAT + "%') AND A.CLTCODE=M.PARTY_CODE "


	SET @STRSQL = @STRSQL + "ORDER BY "
	SET @STRSQL = @STRSQL + "	CLTCODE, "
	SET @STRSQL = @STRSQL + "	BRANCHCODE "
END

--SUB-BROKER LOGIN
IF @STATUSID="SUBBROKER"
BEGIN
	SET @STRSQL = "SELECT "
	SET @STRSQL = @STRSQL + "DISTINCT "
	SET @STRSQL = @STRSQL + "	A.CLTCODE, "
	SET @STRSQL = @STRSQL + "	A.ACNAME, "
	SET @STRSQL = @STRSQL + "	C1.SUB_BROKER "
	SET @STRSQL = @STRSQL + "FROM "
	SET @STRSQL = @STRSQL + "	ACMAST A, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT1 C1, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT2 C2, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.SUBBROKERS S, MARGINLEDGER M "
	SET @STRSQL = @STRSQL + "WHERE "
	SET @STRSQL = @STRSQL + "	C1.CL_CODE = C2.CL_CODE AND "
	SET @STRSQL = @STRSQL + "	A.CLTCODE = C2.PARTY_CODE AND "
	SET @STRSQL = @STRSQL + "	C1.SUB_BROKER = S.SUB_BROKER AND "
	SET @STRSQL = @STRSQL + "	C1.SUB_BROKER LIKE '" + @STATUSNAME + "' AND "
	SET @STRSQL = @STRSQL + "	CLTCODE >= '" + @WHATTOLOOKFOR + "' AND "
	SET @STRSQL = @STRSQL + "	CLTCODE <= '" + @COMPARETOWHAT + "'  AND A.CLTCODE=M.PARTY_CODE "
	SET @STRSQL = @STRSQL + "ORDER BY "
	SET @STRSQL = @STRSQL + "	A.CLTCODE, "
	SET @STRSQL = @STRSQL + "	C1.SUB_BROKER "
END

--TRADER LOGIN
IF @STATUSID="TRADER"
BEGIN
	SET @STRSQL = "SELECT "
	SET @STRSQL = @STRSQL + "DISTINCT "
	SET @STRSQL = @STRSQL + "	A.CLTCODE, "
	SET @STRSQL = @STRSQL + "	A.ACNAME, "
	SET @STRSQL = @STRSQL + "	C1.TRADER "
	SET @STRSQL = @STRSQL + "FROM "
	SET @STRSQL = @STRSQL + "	ACMAST A, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT1 C1, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT2 C2, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.BRANCHES S, MARGINLEDGER M "
	SET @STRSQL = @STRSQL + "WHERE "
	SET @STRSQL = @STRSQL + "	C1.CL_CODE = C2.CL_CODE AND "
	SET @STRSQL = @STRSQL + "	A.CLTCODE = C2.PARTY_CODE AND "
	SET @STRSQL = @STRSQL + "	C1.TRADER = S.BRANCH_CD AND "
	SET @STRSQL = @STRSQL + "	C1.TRADER LIKE '" + @STATUSNAME + "' AND "
	SET @STRSQL = @STRSQL + "	CLTCODE >= '" + @WHATTOLOOKFOR + "' AND "
	SET @STRSQL = @STRSQL + "	CLTCODE <= '" + @COMPARETOWHAT + "'   AND A.CLTCODE=M.PARTY_CODE "
	SET @STRSQL = @STRSQL + "ORDER BY "
	SET @STRSQL = @STRSQL + "	A.CLTCODE, "
	SET @STRSQL = @STRSQL + "	C1.TRADER "
END

--FAMILY LOGIN
IF @STATUSID="FAMILY"
BEGIN
	SET @STRSQL = "SELECT "
	SET @STRSQL = @STRSQL + "DISTINCT "
	SET @STRSQL = @STRSQL + "	A.CLTCODE, "
	SET @STRSQL = @STRSQL + "	A.ACNAME, "
	SET @STRSQL = @STRSQL + "	C1.FAMILY "
	SET @STRSQL = @STRSQL + "FROM "
	SET @STRSQL = @STRSQL + "	ACMAST A, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT1 C1, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT2 C2, MARGINLEDGER M "
	SET @STRSQL = @STRSQL + "WHERE "
	SET @STRSQL = @STRSQL + "	C1.CL_CODE = C2.CL_CODE AND "
	SET @STRSQL = @STRSQL + "	A.CLTCODE = C2.PARTY_CODE AND "
	SET @STRSQL = @STRSQL + "	C1.FAMILY LIKE '" + @STATUSNAME + "' AND "
	SET @STRSQL = @STRSQL + "	CLTCODE >= '" + @WHATTOLOOKFOR + "' AND "
	SET @STRSQL = @STRSQL + "	CLTCODE <= '" + @COMPARETOWHAT + "'   AND A.CLTCODE=M.PARTY_CODE"
	SET @STRSQL = @STRSQL + "ORDER BY "
	SET @STRSQL = @STRSQL + "	A.CLTCODE, "
	SET @STRSQL = @STRSQL + "	C1.FAMILY "
END

IF @STATUSID="CLIENT"
BEGIN
	SET @STRSQL = "SELECT "
	SET @STRSQL = @STRSQL + "DISTINCT "
	SET @STRSQL = @STRSQL + "	A.CLTCODE, "
	SET @STRSQL = @STRSQL + "	A.ACNAME "
	SET @STRSQL = @STRSQL + "FROM "
	SET @STRSQL = @STRSQL + "	ACMAST A, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT1 C1, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT2 C2, MARGINLEDGER M "
	SET @STRSQL = @STRSQL + "WHERE "
	SET @STRSQL = @STRSQL + "	C1.CL_CODE = C2.CL_CODE AND "
	SET @STRSQL = @STRSQL + "	A.CLTCODE = C2.PARTY_CODE AND "
	SET @STRSQL = @STRSQL + "	CLTCODE LIKE '" + @STATUSNAME + "'   AND A.CLTCODE=M.PARTY_CODE"
	SET @STRSQL = @STRSQL + "ORDER BY "
	SET @STRSQL = @STRSQL + "	A.CLTCODE "
END

SET @STRSQL = @STRSQL + "	OPTION  (FAST 10)"

PRINT @STRSQL
EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_LISTCLIENT_REPORT_NEW
-- --------------------------------------------------


CREATE PROCEDURE RPT_ACC_LISTCLIENT_REPORT_NEW
 @STATUSID VARCHAR(15), 
 @STATUSNAME VARCHAR(25), 
 @WHATTOLOOKFOR VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
 @WHICHWAY VARCHAR(1),  -- > OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.
 @COMPARETOWHAT VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.
 @ACCAT VARCHAR(3)  , -- ACCOUNT CATEGORY
               @RPTORDER VARCHAR(6)  -- ACCOUNT CATEGORY
AS
DECLARE
@STRSQL VARCHAR(2500), 
@@INACCAT VARCHAR(3)
SELECT @@INACCAT = RTRIM(CONVERT(VARCHAR, CONVERT(INT, @ACCAT)+100, 3))
--SET DEFAULT VALUES
--SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"
/* SET @BOOKTYPE = @BOOKTYPE + "%" */
--BROKER LOGIN
IF  @STATUSID = "BROKER"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " CLTCODE, "
 SET @STRSQL = @STRSQL + " ACNAME, "
 SET @STRSQL = @STRSQL + " BRANCHCODE "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " CLTCODE > = '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' AND "
 SET @STRSQL = @STRSQL + " (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%')"  
            IF @RPTORDER =  "ACCODE"
              BEGIN
  SET @STRSQL = @STRSQL + "ORDER BY "
  SET @STRSQL = @STRSQL + " CLTCODE, "
  SET @STRSQL = @STRSQL + " BRANCHCODE "
              END
           ELSE
              BEGIN
  SET @STRSQL = @STRSQL + "ORDER BY "
  SET @STRSQL = @STRSQL + " ACNAME, "
  SET @STRSQL = @STRSQL + " BRANCHCODE "
              END 
END
--BRANCH LOGIN
IF @STATUSID = "BRANCH"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " CLTCODE, "
 SET @STRSQL = @STRSQL + " ACNAME, "
 SET @STRSQL = @STRSQL + " BRANCHCODE "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " CLTCODE > = '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " (BRANCHCODE = '" + @STATUSNAME + "' OR BRANCHCODE = 'ALL') AND "
 SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' AND "
 SET @STRSQL = @STRSQL + " (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%')"
 /*SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " CLTCODE, "
 SET @STRSQL = @STRSQL + " BRANCHCODE "*/
   IF @RPTORDER =  "ACCODE"
              BEGIN
  SET @STRSQL = @STRSQL + "ORDER BY "
  SET @STRSQL = @STRSQL + " CLTCODE, "
  SET @STRSQL = @STRSQL + " BRANCHCODE "
              END
           ELSE
              BEGIN
  SET @STRSQL = @STRSQL + "ORDER BY "
  SET @STRSQL = @STRSQL + " ACNAME, "
  SET @STRSQL = @STRSQL + " BRANCHCODE "
              END 
END
--SUB-BROKER LOGIN
IF @STATUSID = "SUBBROKER"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME, "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.SUBBROKERS S "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER = S.SUB_BROKER AND "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE > = '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
 /*SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " C1.SUB_BROKER "*/
   IF @RPTORDER =  "ACCODE"
              BEGIN
  SET @STRSQL = @STRSQL + "ORDER BY "
  SET @STRSQL = @STRSQL + " A.CLTCODE, "
  SET @STRSQL = @STRSQL + " C1.SUB_BROKER "
              END
           ELSE
              BEGIN
  SET @STRSQL = @STRSQL + "ORDER BY "
  SET @STRSQL = @STRSQL + " A.ACNAME, "
  SET @STRSQL = @STRSQL + " C1.SUB_BROKER "
              END 
END
--TRADER LOGIN
IF @STATUSID = "TRADER"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME, "
 SET @STRSQL = @STRSQL + " C1.TRADER "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.BRANCHES S "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " C1.BRANCH_CD = S.BRANCH_CD AND "
 SET @STRSQL = @STRSQL + " C1.TRADER LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE > = '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
          
 /*SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " C1.TRADER "*/
   IF @RPTORDER =  "ACCODE"
              BEGIN
  SET @STRSQL = @STRSQL + "ORDER BY "
  SET @STRSQL = @STRSQL + " A.CLTCODE, "
  SET @STRSQL = @STRSQL + " C1.TRADER "
              END
           ELSE
              BEGIN
  SET @STRSQL = @STRSQL + "ORDER BY "
  SET @STRSQL = @STRSQL + " A.ACNAME, "
  SET @STRSQL = @STRSQL + " C1.TRADER  "
              END 
             
END
--FAMILY LOGIN
IF @STATUSID = "FAMILY"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME, "
 SET @STRSQL = @STRSQL + " C1.FAMILY "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " C1.FAMILY LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE > = '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
 /*SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " C1.FAMILY "*/
  IF @RPTORDER =  "ACCODE"
              BEGIN
  SET @STRSQL = @STRSQL + "ORDER BY "
  SET @STRSQL = @STRSQL + " A.CLTCODE, "
  SET @STRSQL = @STRSQL + " C1.FAMILY   "
              END
           ELSE
              BEGIN
  SET @STRSQL = @STRSQL + "ORDER BY "
  SET @STRSQL = @STRSQL + " A.ACNAME, "
  SET @STRSQL = @STRSQL + " C1.FAMILY   "
              END 
END
IF @STATUSID = "CLIENT"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " CLTCODE LIKE '" + @STATUSNAME + "' "
 SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE "
END
IF @STATUSID = "REGION"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " REGION LIKE '" + @STATUSNAME + "' AND"
 SET @STRSQL = @STRSQL + " CLTCODE > = '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
 /*SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " C1.FAMILY "*/
  IF @RPTORDER =  "ACCODE"
              BEGIN
  SET @STRSQL = @STRSQL + "ORDER BY "
  SET @STRSQL = @STRSQL + " A.CLTCODE "
              END
           ELSE
              BEGIN
  SET @STRSQL = @STRSQL + "ORDER BY "
  SET @STRSQL = @STRSQL + " A.ACNAME "
              END 
END
IF @STATUSID = "AREA"
BEGIN
 SET @STRSQL = "SELECT "
 SET @STRSQL = @STRSQL + "DISTINCT "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " A.ACNAME "
 SET @STRSQL = @STRSQL + "FROM "
 SET @STRSQL = @STRSQL + " ACMAST A, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT1 C1, "
 SET @STRSQL = @STRSQL + " MCDXCDS.DBO.CLIENT2 C2 "
 SET @STRSQL = @STRSQL + "WHERE "
 SET @STRSQL = @STRSQL + " C1.CL_CODE = C2.CL_CODE AND "
 SET @STRSQL = @STRSQL + " A.CLTCODE = C2.PARTY_CODE AND "
 SET @STRSQL = @STRSQL + " AREA LIKE '" + @STATUSNAME + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE > = '" + @WHATTOLOOKFOR + "' AND "
 SET @STRSQL = @STRSQL + " CLTCODE < = '" + @COMPARETOWHAT + "' "
 /*SET @STRSQL = @STRSQL + "ORDER BY "
 SET @STRSQL = @STRSQL + " A.CLTCODE, "
 SET @STRSQL = @STRSQL + " C1.FAMILY "*/
  IF @RPTORDER =  "ACCODE"
              BEGIN
  SET @STRSQL = @STRSQL + "ORDER BY "
  SET @STRSQL = @STRSQL + " A.CLTCODE "
              END
           ELSE
              BEGIN
  SET @STRSQL = @STRSQL + "ORDER BY "
  SET @STRSQL = @STRSQL + " A.ACNAME "
              END 
END
 SET @STRSQL = @STRSQL + " OPTION  (FAST 10)"
PRINT @STRSQL
EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_MARGINLEDGER
-- --------------------------------------------------
  
/*USE ACCOUNT          
EXEC RPT_ACC_PARTYLEDGER_ALL 'JAN  1 2007','FEB 12 2007','0Z','ZZZ','ACCODE','VDT','BROKER','BROKER','', 'N'          
EXEC RPT_ACC_MARGINLEDGER 'JAN  1 2007','FEB 12 2007','0Z','ZZZ','ACCODE','VDT','BROKER','BROKER','', 'N'*/          
 --EXEC RPT_ACC_MARGINLEDGER 'AUG  1 2006','AUG 26 2006','012019','012019','ACCODE','VDT','BROKER','BROKER',''                
                
--EXEC RPT_ACC_MARGINLEDGER 'AUG  1 2006','AUG 26 2006','012019','012019','ACCODE','VDT','BROKER','BROKER',''                  
 /*                                
 PROC NAME RPT_ACC_PARTYLEDGER                                
 PARAMETERS FDATE - FROM DATE                                
            TDATE - DATE TO                                
            FCODE - AC CODE FROM                                
            TCODE - AC CODE TO                                
            STRORDER - PRINTING ORDER, POSSIBLE VAUES  ACCODE , ACNAME                                
            SELECTBY - REPORT SELECTION BY , POSSIBLE VALUES VDT, EDT                                
            STATUSID - POSSIBLEVALUES 'BROKER','CLIENT','FAMILY','SUBBORKER','FAMILY','BRANCH'                                
*/                                
                     
CREATE PROCEDURE [dbo].[rpt_acc_Marginledger]                                
                                 
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */                                
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */                                
@FCODE VARCHAR(10),                                
@TCODE VARCHAR(10),                                
@STRORDER VARCHAR(6),                                
@SELECTBY VARCHAR(3),                                
@STATUSID VARCHAR(15),                                
@STATUSNAME VARCHAR(15),                                
@STRBRANCH VARCHAR(10)                                
AS                                
                                
DECLARE @@OPENDATE   AS VARCHAR(11)                                
                          
CREATE TABLE [DBO].[#MARGINLEDGERDATA] (                                  
  [BOOKTYPE] [CHAR] (2) NULL ,                                  
  [VOUDT] [DATETIME] NULL ,                                  
  [EFFDT] [DATETIME] NULL ,                                  
  [ACNAME] [VARCHAR] (100) NULL ,                        
  [SHORTDESC] [CHAR] (6) NULL ,                                    
  [DRCR] [CHAR] (1) NULL ,                                  
  [AMOUNT] [MONEY] NULL ,                                  
  [VNO] [VARCHAR] (12) NULL ,                                  
  [DDNO] [VARCHAR] (12) NULL ,                                  
  [NARRATION] [VARCHAR] (234) NULL ,                                  
  [PARTY_CODE] [VARCHAR] (10) NOT NULL ,                                  
  [VTYP] [SMALLINT] NULL ,                                  
  [VDT] [VARCHAR] (30) NULL ,                                  
  [EDT] [VARCHAR] (30) NULL ,                                              
  [LNO] [DECIMAL](5, 0) NULL,              
  [PDT] [DATETIME] NULL              
 ) ON [PRIMARY]                                  
                                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                
                        
              
                        
                        
                        
SELECT @@OPENDATE = SDTCUR FROM PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR                
                                
/*GETTING LAST OPENING DATE */                                
/*IF UPPER(@SELECTBY) = 'VDT'                                
 BEGIN                                
  SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM MARGINLEDGER WHERE VTYP = 18 AND VDT <= @FDATE )                                
 END                                
ELSE                                
 BEGIN                                
  SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM MARGINLEDGER WHERE VTYP = 18 AND VDT <= @FDATE )                                
 END                */                
                                
/*CREATING BLANK TABLE FOR OPENING BALANCE*/                                
SELECT CLTCODE=PARTY_CODE,OPPBAL=AMOUNT INTO #OPPBALANCE FROM MARGINLEDGER WHERE 1=2                                
                                
/*GETTING OPENING BALANCE*/                                
IF @SELECTBY = 'VDT'                                
BEGIN                                
 IF @@OPENDATE = @FDATE            
 BEGIN                                
  INSERT INTO  #OPPBALANCE                                 
  SELECT CLTCODE=PARTY_CODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0)                                
  FROM MARGINLEDGER                                 
  WHERE PARTY_CODE >= @FCODE AND PARTY_CODE <=@TCODE AND  VDT LIKE @FDATE + '%' AND VTYP = 18                                 
  GROUP BY PARTY_CODE                                
 END                                
 ELSE                                
 BEGIN                                
  INSERT INTO  #OPPBALANCE                                 
  SELECT CLTCODE=PARTY_CODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END),0)                                  
  FROM MARGINLEDGER                                 
  WHERE PARTY_CODE >=@FCODE AND PARTY_CODE <= @TCODE  AND  VDT >=  @@OPENDATE + ' 00:00:00' AND VDT < @FDATE                                 
  GROUP BY PARTY_CODE                                
 END                                
END                                 
ELSE                                
BEGIN                                 
 IF @@OPENDATE = @FDATE                                 
 BEGIN        INSERT INTO  #OPPBALANCE                              
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM(SETT_NO)                            
  FROM MARGINLEDGER                             
  WHERE PARTY_CODE = @FCODE AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                            
  GROUP BY PARTY_CODE                            
 END                              
 ELSE                              
 BEGIN                              
  INSERT INTO  #OPPBALANCE                                 
  SELECT CLTCODE, OPBAL=SUM(OPBAL)                            
  FROM                            
  (                           
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM(SETT_NO)                            
  FROM MARGINLEDGER                             
  WHERE PARTY_CODE = @FCODE AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                            
  GROUP BY PARTY_CODE                            
  UNION ALL                            
  SELECT CLTCODE=PARTY_CODE, OPBAL = SUM( CASE WHEN UPPER(DRCR) = 'D' THEN AMOUNT ELSE -AMOUNT END)                            
  FROM MARGINLEDGER                             
  WHERE PARTY_CODE = @FCODE AND VDT >= @@OPENDATE + ' 00:00:00' AND VDT < @FDATE AND VTYP <> 18                            
  GROUP BY PARTY_CODE) T                            
  GROUP BY CLTCODE                            
 END                              
END                                
                          
                
                          
IF @SELECTBY = 'VDT'                          
BEGIN                          
 INSERT INTO #MARGINLEDGERDATA                          
/*  SELECT M.BOOKTYPE, VOUDT=M.VDT , EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                           
  M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                           
  L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT                           
  FROM MARGINLEDGER M LEFT OUTER JOIN LEDGER L ON M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO             
 AND M.LNO = L.LNO LEFT OUTER JOIN ACMAST A ON M.PARTY_CODE = A.CLTCODE , VMAST V                           
  WHERE L.VDT >= @FDATE + ' 00:00:00' AND L.VDT <= @TDATE + ' 23:59:59'                          
  AND M.PARTY_CODE >= @FCODE AND M.PARTY_CODE <= @TCODE AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE*/  
    
  SELECT M.BOOKTYPE, VOUDT=M.VDT , EFFDT=L.EDT, A.LONGNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                           
  M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                           
  L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT                           
  FROM (SELECT CLTCODE, LONGNAME, ACCAT FROM ACMAST WHERE CLTCODE  >= @FCODE AND CLTCODE <= @TCODE) A, MARGINLEDGER M   
  ,(SELECT VNO, VTYP, BOOKTYPE, LNO, VDT, EDT, NARRATION FROM LEDGER WHERE VDT >= @FDATE + ' 00:00:00' AND VDT <= @TDATE + ' 23:59:59') L, VMAST V  
  WHERE   
  M.PARTY_CODE = A.CLTCODE  
  and M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO  
  AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE                            
END                          
ELSE                          
BEGIN                          
  INSERT INTO #MARGINLEDGERDATA                          
  /*SELECT M.BOOKTYPE, VOUDT=M.VDT, EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                           
  M.VNO,DDNO= ISNULL((SELECT DDNO FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                         
 L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT              
  FROM MARGINLEDGER M LEFT OUTER JOIN LEDGER L ON M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO                         
 AND M.LNO = L.LNO LEFT OUTER JOIN ACMAST A ON M.PARTY_CODE = A.CLTCODE , VMAST V                           
  WHERE L.EDT >= @FDATE + ' 00:00:00' AND L.EDT <= @TDATE + ' 23:59:59'                          
  AND M.PARTY_CODE >= @FCODE AND M.PARTY_CODE <= @TCODE AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE  */  
  SELECT M.BOOKTYPE, VOUDT=M.VDT , EFFDT=L.EDT, A.LONGNAME, ISNULL(SHORTDESC,'') SHORTDESC, M.DRCR,M.AMOUNT,                           
  M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''),                           
  L.NARRATION, M.PARTY_CODE, M.VTYP, CONVERT(VARCHAR,M.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,M.LNO, M.VDT                           
  FROM (SELECT CLTCODE, LONGNAME, ACCAT FROM ACMAST WHERE CLTCODE  >= @FCODE AND CLTCODE <= @TCODE) A, MARGINLEDGER M   
  ,(SELECT VNO, VTYP, BOOKTYPE, LNO, VDT, EDT, NARRATION FROM LEDGER WHERE EDT >= @FDATE + ' 00:00:00' AND EDT <= @TDATE + ' 23:59:59') L, VMAST V  
  WHERE   
  M.PARTY_CODE = A.CLTCODE  
  and M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO  
  AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE                          
END                          
                          
                                
/*GETTING CLIENT LIST*/                                
SELECT C2.PARTY_CODE,BANK_NAME =ISNULL(C4.BANKID,''),                                
L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,C1.BRANCH_CD,                        
FAMILY,C1.SUB_BROKER,TRADER,CL_TYPE,CLTDPID =ISNULL(CLTDPID,'')                                
INTO #LEDGERCLIENTS                                
FROM MCDXCDS.DBO.CLIENT1 C1 ,MCDXCDS.DBO.CLIENT2 C2 LEFT OUTER JOIN MCDXCDS.DBO.CLIENT4  C4 ON                                
(C2.PARTY_CODE=C4.PARTY_CODE  AND  DEPOSITORY NOT IN ('NSDL','CDSL')  AND  DEFDP=1)                                
WHERE C1.CL_CODE=C2.CL_CODE                                
AND C1.BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE  '%' END)                                
AND SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUB_BROKER' THEN @STATUSNAME ELSE  '%' END)                                
AND TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE  '%' END)                                
AND C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE  '%' END)                                
AND C2.PARTY_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE  '%' END)                                
AND C1.BRANCH_CD LIKE @STRBRANCH +'%'                                
AND C2.PARTY_CODE >= @FCODE AND C2.PARTY_CODE <= @TCODE                     
                           
                                                              
/*GETTING LDDGER ENTRIES*/    

ALTER TABLE #LEDGERCLIENTS
ALTER COLUMN BANK_NAME VARCHAR(50)
                  
SELECT M.BOOKTYPE, M.VOUDT, M.EFFDT, M.SHORTDESC,                                 
DRAMT=(CASE WHEN UPPER(M.DRCR) = 'D' THEN M.AMOUNT ELSE 0 END),                                  
CRAMT=(CASE WHEN UPPER(M.DRCR) = 'C' THEN M.AMOUNT ELSE 0 END),                                
M.VNO, M.DDNO, M.NARRATION, C.PARTY_CODE CLTCODE,VTYP = ISNULL(M.VTYP, 18), M.VDT,                                 
M.EDT, M.ACNAME , OPBAL = AMOUNT,                                 
C.L_ADDRESS1,C.L_ADDRESS2,C.L_ADDRESS3,C.L_CITY,C.L_ZIP,C.RES_PHONE1,C.BRANCH_CD, M.PARTY_CODE CROSAC ,                             
EDIFF=DATEDIFF(D,M.EFFDT,GETDATE()), C.FAMILY,C.SUB_BROKER,C.TRADER,C.CL_TYPE,                                
C.BANK_NAME,C.CLTDPID, M.LNO, M.PDT                                       
INTO  #TMPMLEDGER                                       
FROM  #MARGINLEDGERDATA M RIGHT OUTER JOIN #LEDGERCLIENTS C ON (M.PARTY_CODE=C.PARTY_CODE)                                
                  
/*UPDATING OPENING BLANACE*/                                
UPDATE #TMPMLEDGER SET OPBAL = 0                                
UPDATE #TMPMLEDGER SET OPBAL = T.OPPBAL FROM #TMPMLEDGER M,#OPPBALANCE T WHERE M.CLTCODE = T.CLTCODE                                
                          
                                
/*UPDATING BANK NAME*/                               

UPDATE  #TMPMLEDGER SET #TMPMLEDGER.BANK_NAME= B.BANK_NAME  FROM                                
MCDXCDS.DBO.POBANK  B 
--WHERE LTRIM(RTRIM(CAST(B.BANKID  AS CHAR))) = LTRIM(RTRIM(#TMPMLEDGER.BANK_NAME))                                
WHERE CONVERT(varchar,b.bankid)= LTRIM(RTRIM(#TMPMLEDGER.BANK_NAME))                                


                            
UPDATE  #TMPMLEDGER SET #TMPMLEDGER.ACNAME= A.ACNAME  FROM                                
ACMAST A WHERE LTRIM(RTRIM(A.CLTCODE)) = LTRIM(RTRIM(#TMPMLEDGER.CLTCODE))                                
                  
                
                            
IF @STRORDER = 'ACCODE'                                
 BEGIN                                
  IF @SELECTBY = 'VDT'                                
   BEGIN                                 
    SELECT L.* FROM #TMPMLEDGER L,ACMAST A  WHERE      
    L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104')     
 AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
    ORDER BY L.CLTCODE,VOUDT                                
   END                                
  ELSE                                
   BEGIN                                
    SELECT L.* FROM #TMPMLEDGER L,ACMAST A       
    WHERE  L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104')     
 AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
 ORDER BY L.CLTCODE,EFFDT                                
   END                                
 END           
ELSE                                
  BEGIN                                
   IF @SELECTBY = 'VDT'                                
    BEGIN                                 
     SELECT L.* FROM #TMPMLEDGER L,ACMAST A       
 WHERE L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104')     
 AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
 ORDER BY L.ACNAME,VOUDT                                
    END                                
   ELSE                                
    BEGIN                                
     SELECT L.* FROM #TMPMLEDGER L,ACMAST A       WHERE L.CLTCODE = A.CLTCODE AND ACCAT IN ('4','104')     
 AND (cramt <> 0 or dramt <> 0 or opbal <> 0)    
 ORDER BY L.ACNAME,EFFDT                                
    END                                
  END                                
                                
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_PARTYLEDGER
-- --------------------------------------------------



--EXEC RPT_ACC_PARTYLEDGER_ALL 'AUG  1 2007','AUG  8 2007','0000','ZZZZ','ACCODE','VDT','BROKER','BROKER','', 'N','N'  
  
  
--EXEC RPT_ACC_PARTYLEDGER 'JAN  1 2010','JAN 25 2012','0','ZZZ','ACCODE','VDT','BROKER','BROKER',''        
        
CREATE PROCEDURE [DBO].[RPT_ACC_PARTYLEDGER]        
(          
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                
 @FCODE VARCHAR(10),                
 @TCODE VARCHAR(10),                
 @STRORDER VARCHAR(8),                
 @SELECTBY VARCHAR(3),                
 @STATUSID VARCHAR(15),                
 @STATUSNAME VARCHAR(15),                
 @STRBRANCH VARCHAR(10),
 @FORPDF VARCHAR(1) = 'N'
)          
          
AS         
  
DECLARE                
 @@REPTYPE VARCHAR(1),  
 @@STRORDER VARCHAR(6)  
  
  
SELECT @@REPTYPE = .DBO.PIECE(@STRORDER, '~', 2)  
SELECT @@STRORDER = .DBO.PIECE(@STRORDER, '~', 1)  
  
IF @@REPTYPE = 'P'  
BEGIN  
 EXEC RPT_ACC_PARTYLEDGER_PARENT @FDATE, @TDATE, @FCODE, @TCODE, @@STRORDER, @SELECTBY, @STATUSID, @STATUSNAME, @STRBRANCH  
 RETURN  
END  
  
  
                
/*========================================================================          
      EXEC RPT_ACC_PARTYLEDGER_ALL           
            'NOV  1 2005',          
            'DEC 31 2005',          
            'A',          
            'ZZZ',          
            'ACCODE',          
            'VDT',          
            'BROKER',          
            'UNDEFINED',          
            ''          
========================================================================*/          
          
DECLARE           
 @@OPENDATE   AS VARCHAR(11)                
                
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
                
                
/*GETTING LAST OPENING DATE */                
      IF UPPER(@SELECTBY) = 'VDT'                
      BEGIN                
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(VDT), 0), 109), 11)           
                        FROM LEDGER WITH(NOLOCK)           
                        WHERE VTYP = 18           
                              AND VDT < = @FDATE           
                  )           
      END                
      ELSE                
      BEGIN                
            SELECT           
                  @@OPENDATE =           
                  (           
                        SELECT           
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)           
                        FROM LEDGER WITH(NOLOCK)           
                        WHERE VTYP = 18           
                              AND EDT < = @FDATE           
                  )           
      END                
                      
                
      /*CREATING BLANK TABLE FOR OPENING BALANCE*/                
            SELECT           
                  CLTCODE,           
                  OPPBAL = VAMT           
            INTO #OPPBALANCE           
            FROM LEDGER WITH(NOLOCK)           
            WHERE 1 = 2           
                      
                
      /*GETTING OPENING BALANCE*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            IF @@OPENDATE = @FDATE                 
            BEGIN 
				  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                              THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM LEDGER B WITH(NOLOCK)           
				  WHERE B.CLTCODE > = @FCODE           
                        AND B.CLTCODE < = @TCODE           
                        AND B.VDT LIKE @FDATE + '%'           
                        AND VTYP = 18           
                  GROUP BY CLTCODE           

            END                
            ELSE                
            BEGIN                
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT      
                        CLTCODE,           
                        OPPBAL = ISNULL(SUM(           
                        CASE           
                              WHEN UPPER(B.DRCR) = 'D'           
                       THEN B.VAMT           
                              ELSE -B.VAMT           
                        END          
                        ), 0)           
                  FROM LEDGER B WITH(NOLOCK)                         WHERE B.CLTCODE > = @FCODE           
                        AND B.CLTCODE < = @TCODE           
                        AND B.VDT > = @@OPENDATE + ' 00:00:00'           
                        AND VDT < @FDATE           
               GROUP BY CLTCODE           
            END                
      END                 
      ELSE                
      BEGIN                 
            IF @@OPENDATE = @FDATE                 
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
                                    CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
                              FROM LEDGER WITH(NOLOCK)           
                              WHERE CLTCODE = @FCODE           
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
                                          ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM LEDGER B WITH(NOLOCK)           
                              WHERE B.CLTCODE > = @FCODE           
                                    AND B.CLTCODE < = @TCODE           
                                    AND B.VDT < @@OPENDATE          
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
            ELSE              
            BEGIN              
                  INSERT           
                  INTO #OPPBALANCE           
                  SELECT           
                        CLTCODE,           
                        OPBAL = SUM(OPBAL)           
                  FROM           
                        (           
                              SELECT           
        CLTCODE,           
                                    OPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT           
                                    END          
                                    ), 0)           
               FROM LEDGER WITH(NOLOCK)           
                              WHERE CLTCODE = @FCODE           
                                    AND EDT LIKE @@OPENDATE + '%'           
                                    AND VTYP = 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                   SELECT           
                                    CLTCODE,           
                                    OPBAL = SUM(           
                                    CASE           
                                          WHEN UPPER(DRCR) = 'D'           
                                          THEN VAMT           
                                          ELSE -VAMT         
                                    END          
                                    )           
                              FROM LEDGER WITH(NOLOCK)           
                              WHERE CLTCODE = @FCODE           
                                    AND EDT > = @@OPENDATE + ' 00:00:00'           
                                    AND EDT < @FDATE           
                                    AND VTYP <> 18           
                              GROUP BY CLTCODE           
                              UNION ALL           
                              SELECT           
                                    CLTCODE,           
                                    OPPBAL = ISNULL(SUM(           
                                    CASE           
                                          WHEN UPPER(B.DRCR) = 'C'           
                                          THEN B.VAMT           
      ELSE -B.VAMT           
                                    END          
                                    ), 0)           
                              FROM LEDGER B WITH(NOLOCK)           
                              WHERE B.CLTCODE > = @FCODE           
                                    AND B.CLTCODE < = @TCODE           
                                    AND B.VDT < @@OPENDATE           
                                    AND EDT >= @@OPENDATE           
                              GROUP BY CLTCODE           
                        )           
                        T           
                  GROUP BY CLTCODE           
            END              
      END                
                      
      /*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */                
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  SHORTDESC = SPACE(35)           
            INTO #LEDGERDATA           
            FROM LEDGER L WITH(NOLOCK)           
            WHERE 1 = 2           
  
                     
                
                
      /*GETTING FIILTERED LEDGER*/                
      IF @SELECTBY = 'VDT'                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM LEDGER L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE VDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND VDT < = @TDATE +' 23:59:59'           
                  AND CLTCODE > = @FCODE           
                  AND CLTCODE < = @TCODE           
      END                 
      ELSE                
      BEGIN                
            INSERT           
            INTO #LEDGERDATA           
            SELECT           
                  VTYP,VNO,EDT,LNO,ACNAME,DRCR,VAMT,VDT,VNO1,REFNO,BALAMT,NODAYS,CDT,CLTCODE,BOOKTYPE,ENTEREDBY,PDT,CHECKEDBY,ACTNODAYS,L.NARRATION,           
                  ISNULL(V.SHORTDESC, '') SHORTDESC           
            FROM LEDGER L WITH(NOLOCK),           
                  VMAST V WITH(NOLOCK)           
            WHERE EDT > = @FDATE + ' 00:00:00'           
                  AND L.VTYP = V.VTYPE           
                  AND EDT < = @TDATE +' 23:59:59'           
                  AND CLTCODE > = @FCODE           
                  AND CLTCODE < = @TCODE           
      END                
                
          
          
/*GETTING CLIENT LIST*/                
      SELECT           
            C2.PARTY_CODE,          
   C1.LONG_NAME,          
            BANK_NAME = ISNULL(C4.BANKID, ''),           
            L_ADDRESS1,           
            L_ADDRESS2,           
            L_ADDRESS3,           
            L_CITY,           
            L_ZIP,           
            RES_PHONE1,           
            C1.BRANCH_CD,           
           FAMILY,           
            C1.SUB_BROKER,           
            TRADER,           
            CL_TYPE,           
            CLTDPID = ISNULL(CLTDPID, '')           
      INTO #LEDGERCLIENTS           
      FROM MCDXCDS.DBO.CLIENT1 C1 WITH(NOLOCK),           
            MCDXCDS.DBO.CLIENT2 C2 WITH(NOLOCK)           
      LEFT OUTER JOIN           
            MCDXCDS.DBO.CLIENT4 C4 WITH(NOLOCK)           
            ON           
            (          
                  C2.PARTY_CODE = C4.PARTY_CODE           
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')           
				  AND DEFDP = 1          
--                  AND DEFDP = 0      
            )           
      WHERE C1.CL_CODE = C2.CL_CODE           
            AND C1.BRANCH_CD LIKE (          
            CASE           
                  WHEN @STATUSID = 'BRANCH'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )
            AND SUB_BROKER LIKE (          
            CASE           
                  WHEN @STATUSID = 'SUB_BROKER'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
			AND SUB_BROKER LIKE (          
            CASE           
                  WHEN @STATUSID = 'SUBBROKER'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
            AND TRADER LIKE (          
            CASE           
                  WHEN @STATUSID = 'TRADER'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
            AND C1.FAMILY LIKE (          
            CASE           
                  WHEN @STATUSID = 'FAMILY'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
            )           
            AND C2.PARTY_CODE LIKE (          
            CASE           
                  WHEN @STATUSID = 'CLIENT'           
                  THEN @STATUSNAME           
                  ELSE '%'           
            END          
         )           
            AND C1.BRANCH_CD LIKE @STRBRANCH +'%'           
            AND C2.PARTY_CODE > = @FCODE           
            AND C2.PARTY_CODE < = @TCODE           
          
          
      CREATE TABLE [#TMPLEDGER] (          
       [BOOKTYPE] [CHAR] (2)  NULL ,          
       [VOUDT] [DATETIME] NULL ,          
       [EFFDT] [DATETIME] NULL ,          
       [SHORTDESC] [VARCHAR] (35)  NULL ,          
       [DRAMT] [MONEY] NULL ,          
       [CRAMT] [MONEY] NULL ,          
       [VNO] [VARCHAR] (12)  NULL ,          
       [DDNO] [VARCHAR] (15)  NULL ,          
       [NARRATION] [VARCHAR] (234)  NULL ,          
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,          
       [VTYP] [SMALLINT] NULL ,          
       [VDT] [VARCHAR] (30)  NULL ,          
       [EDT] [VARCHAR] (30)  NULL ,          
       [ACNAME] [VARCHAR] (100)  NULL ,          
       [OPBAL] [MONEY] NULL ,          
       [L_ADDRESS1] [VARCHAR] (40)  NOT NULL ,          
       [L_ADDRESS2] [VARCHAR] (40)  NULL ,          
       [L_ADDRESS3] [VARCHAR] (40)  NULL ,          
       [L_CITY] [VARCHAR] (40)  NULL ,          
       [L_ZIP] [VARCHAR] (10)  NULL ,          
       [RES_PHONE1] [VARCHAR] (15)  NULL ,          
       [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,          
       [CROSAC] [VARCHAR] (10)  NULL ,          
       [EDIFF] [INT] NULL ,          
       [FAMILY] [VARCHAR] (10)  NOT NULL ,          
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,          
       [TRADER] [VARCHAR] (20)  NOT NULL ,          
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,          
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,          
       [CLTDPID] [VARCHAR] (20)  NOT NULL ,          
       [LNO] [INT] NULL,        
       [PDT] [DATETIME] NULL
      ) ON [PRIMARY]          
   
           
/*GETTING LDDGER ENTRIES*/                
      INSERT           
            INTO #TMPLEDGER           
      SELECT           
            L.BOOKTYPE,           
 VOUDT = L.VDT,           
            EFFDT = L.EDT,           
            L.SHORTDESC,           
            DRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'D'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            CRAMT = (          
            CASE           
                  WHEN UPPER(L.DRCR) = 'C'           
                  THEN L.VAMT           
                  ELSE 0           
            END          
            ),           
            L.VNO,           
            DDNO = SPACE(15),           
            L.NARRATION,           
            C.PARTY_CODE CLTCODE,           
            VTYP = ISNULL(L.VTYP, 18),           
            CONVERT(VARCHAR, L.VDT, 103) VDT,           
            CONVERT(VARCHAR, L.EDT, 103) EDT,           
--            L.ACNAME ,           
            C.LONG_NAME,          
            OPBAL = VAMT,           
            C.L_ADDRESS1,           
            C.L_ADDRESS2,           
            C.L_ADDRESS3,           
            C.L_CITY,           
            C.L_ZIP,           
            C.RES_PHONE1,           
            C.BRANCH_CD,           
            L.CLTCODE CROSAC ,           
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),           
            C.FAMILY,           
            C.SUB_BROKER,           
            C.TRADER,           
            C.CL_TYPE,           
            C.BANK_NAME,           
            C.CLTDPID,           
            L.LNO,        
			L.PDT
      FROM #LEDGERDATA L WITH(NOLOCK)           
      RIGHT OUTER JOIN           
            #LEDGERCLIENTS C WITH(NOLOCK)           
            ON           
            (          
                  L.CLTCODE = C.PARTY_CODE          
            )           
          
          
                
/*UPDATING OPENING BLANACE*/                
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = 0           
          
      UPDATE           
            #TMPLEDGER           
            SET OPBAL = T.OPPBAL           
      FROM #TMPLEDGER L WITH(NOLOCK),           
            #OPPBALANCE T WITH(NOLOCK)           
      WHERE L.CLTCODE = T.CLTCODE           
                
          
          
/*UPDATING CHEQUE NUMBER*/                
      UPDATE           
            #TMPLEDGER           
            SET DDNO = L1.DDNO           
      FROM LEDGER1 L1 WITH(NOLOCK)           
      WHERE L1.VNO = #TMPLEDGER.VNO           
            AND L1.VTYP = #TMPLEDGER.VTYP           
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE           
            AND L1.LNO = #TMPLEDGER.LNO           
                
          
          
/*UPDATING CROSS ACCOUNT CODE*/                
      UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.CROSAC = B.CLTCODE           
      FROM LEDGER B WITH(NOLOCK),           
            ACMAST V WITH(NOLOCK)           
      WHERE B.CLTCODE = V.CLTCODE           
            AND V.ACCAT = 2           
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE           
            AND #TMPLEDGER.VNO = B.VNO           
            AND #TMPLEDGER.VTYP = B.VTYP           
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')           
                
          
          
/*UPDATING BANK NAME*/                               
      UPDATE           
            #TMPLEDGER           
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME           
      FROM MCDXCDS.DBO.POBANK B WITH(NOLOCK)           
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))           
      
      IF @FORPDF = 'Y'
		BEGIN
			ALTER TABLE #TMPLEDGER ADD PARTYCOUNT INT
			UPDATE #TMPLEDGER SET PARTYCOUNT = C.PCOUNTER
			FROM (SELECT CLTCODE, PCOUNTER = COUNT(1) FROM #TMPLEDGER GROUP BY CLTCODE) C
			WHERE #TMPLEDGER.CLTCODE = C.CLTCODE
		END
                
      IF @@STRORDER = 'ACCODE'                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
    AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)          
                  ORDER BY L.CLTCODE,        
                        VOUDT, PDT        
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
                  ORDER BY L.CLTCODE,          
                        EFFDT, PDT        
            END                
      END                
      ELSE                
      BEGIN                
            IF @SELECTBY = 'VDT'                
            BEGIN                 
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')       
                  ORDER BY L.ACNAME,         
                        VOUDT, PDT           
            END                
            ELSE                
            BEGIN                
                  SELECT           
                        L.*           
                  FROM #TMPLEDGER L WITH(NOLOCK),           
                        ACMAST A WITH(NOLOCK)           
                  WHERE L.CLTCODE = A.CLTCODE           
                        AND ACCAT IN ('4', '104')           
                  ORDER BY L.ACNAME,          
                        EFFDT, PDT        
            END                
      END                
                
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_PARTYLEDGER_16082010
-- --------------------------------------------------
 --EXEC RPT_ACC_PARTYLEDGER 'JAN  1 2007','JAN 25 2007','051','051','ACCODE','VDT','BROKER','BROKER',''            
       
CREATE PROCEDURE [DBO].[RPT_ACC_PARTYLEDGER_16082010]            
(              
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                    
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                    
 @FCODE VARCHAR(10),                    
 @TCODE VARCHAR(10),                    
 @STRORDER VARCHAR(6),                    
 @SELECTBY VARCHAR(3),                    
 @STATUSID VARCHAR(15),                    
 @STATUSNAME VARCHAR(15),                    
 @STRBRANCH VARCHAR(10)                    
)              
              
AS                    
                    
/*========================================================================              
      EXEC RPT_ACC_PARTYLEDGER_ALL               
            'NOV  1 2005',              
            'DEC 31 2005',              
            'A',              
            'ZZZ',              
            'ACCODE',              
            'VDT',              
            'BROKER',              
            'UNDEFINED',              
            ''              
========================================================================*/              
              
DECLARE               
 @@OPENDATE   AS VARCHAR(11)                    
                    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                    
                    
                    
/*GETTING LAST OPENING DATE */                    
      IF UPPER(@SELECTBY) = 'VDT'                    
      BEGIN                    
            SELECT               
                  @@OPENDATE =               
                  (               
                        SELECT               
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(VDT), 0), 109), 11)               
                        FROM LEDGER WITH(NOLOCK)               
                        WHERE VTYP = 18               
                              AND VDT < = @FDATE               
                  )               
      END                    
      ELSE                    
      BEGIN                    
            SELECT               
                  @@OPENDATE =               
                  (               
                        SELECT               
                              LEFT(CONVERT(VARCHAR, ISNULL(MAX(EDT), 0), 109), 11)               
                        FROM LEDGER WITH(NOLOCK)               
                        WHERE VTYP = 18               
                              AND EDT < = @FDATE               
                  )               
      END                    
                          
                    
      /*CREATING BLANK TABLE FOR OPENING BALANCE*/                    
            SELECT               
                  CLTCODE,               
                  OPPBAL = VAMT               
            INTO #OPPBALANCE               
            FROM LEDGER WITH(NOLOCK)               
            WHERE 1 = 2               
                          
                    
      /*GETTING OPENING BALANCE*/                    
      IF @SELECTBY = 'VDT'                    
      BEGIN                    
            IF @@OPENDATE = @FDATE                     
            BEGIN                    
                  INSERT               
                  INTO #OPPBALANCE               
                  SELECT               
                        CLTCODE,               
                        OPPBAL = ISNULL(SUM(               
                        CASE               
                              WHEN UPPER(B.DRCR) = 'D'               
                              THEN B.VAMT               
                              ELSE -B.VAMT               
                        END              
                        ), 0)               
                  FROM LEDGER B WITH(NOLOCK)               
                  WHERE B.CLTCODE > = @FCODE               
                        AND B.CLTCODE < = @TCODE         
                        AND B.VDT LIKE @FDATE + '%'               
                        AND VTYP = 18               
                  GROUP BY CLTCODE               
            END              
            ELSE                    
            BEGIN                    
                  INSERT               
                  INTO #OPPBALANCE               
                  SELECT               
                        CLTCODE,               
                        OPPBAL = ISNULL(SUM(               
                        CASE               
                              WHEN UPPER(B.DRCR) = 'D'               
                       THEN B.VAMT               
                              ELSE -B.VAMT               
                        END              
                        ), 0)               
                  FROM LEDGER B WITH(NOLOCK)                         WHERE B.CLTCODE > = @FCODE               
                        AND B.CLTCODE < = @TCODE               
                        AND B.VDT > = @@OPENDATE + ' 00:00:00'               
                        AND VDT < @FDATE               
               GROUP BY CLTCODE               
            END                    
      END                     
      ELSE                    
      BEGIN                     
            IF @@OPENDATE = @FDATE                     
            BEGIN                  
                  INSERT               
                  INTO #OPPBALANCE               
                  SELECT               
                        CLTCODE,               
OPBAL = SUM(OPBAL)               
                  FROM               
                        (               
                              SELECT               
                                    CLTCODE,               
                                    OPBAL = ISNULL(SUM(               
                                    CASE               
                                          WHEN UPPER(DRCR) = 'D'               
                                          THEN VAMT               
                                          ELSE -VAMT               
                                    END              
                                    ), 0)               
                              FROM LEDGER WITH(NOLOCK)               
                              WHERE CLTCODE = @FCODE               
                                    AND EDT LIKE @@OPENDATE + '%'               
                                    AND VTYP = 18               
                              GROUP BY CLTCODE               
                              UNION ALL               
                              SELECT               
                                    CLTCODE,               
                                    OPPBAL = ISNULL(SUM(               
                                    CASE               
                                          WHEN UPPER(B.DRCR) = 'C'               
                                          THEN B.VAMT               
                                          ELSE -B.VAMT               
                                    END              
                                    ), 0)               
                              FROM LEDGER B WITH(NOLOCK)               
                              WHERE B.CLTCODE > = @FCODE               
                                    AND B.CLTCODE < = @TCODE               
                                    AND B.VDT < @@OPENDATE              
                                    AND EDT >= @@OPENDATE               
                              GROUP BY CLTCODE               
                        )               
                        T               
                  GROUP BY CLTCODE               
            END                  
            ELSE                  
            BEGIN                  
                  INSERT               
                  INTO #OPPBALANCE               
                  SELECT               
                        CLTCODE,       
                        OPBAL = SUM(OPBAL)               
                  FROM               
                        (               
                              SELECT               
                                    CLTCODE,               
                                    OPBAL = ISNULL(SUM(               
         CASE               
                                          WHEN UPPER(DRCR) = 'D'               
                                          THEN VAMT               
                                          ELSE -VAMT               
                                    END              
                                    ), 0)               
          FROM LEDGER WITH(NOLOCK)               
                              WHERE CLTCODE = @FCODE               
                                    AND EDT LIKE @@OPENDATE + '%'               
                                    AND VTYP = 18               
                              GROUP BY CLTCODE               
                              UNION ALL               
                   SELECT               
                                    CLTCODE,               
                                    OPBAL = SUM(               
                                    CASE               
                                          WHEN UPPER(DRCR) = 'D'               
                                          THEN VAMT               
                                          ELSE -VAMT             
                                    END              
                                    )               
                              FROM LEDGER WITH(NOLOCK)               
                              WHERE CLTCODE = @FCODE               
                                    AND EDT > = @@OPENDATE + ' 00:00:00'               
                                    AND EDT < @FDATE               
                                    AND VTYP <> 18               
                              GROUP BY CLTCODE               
                              UNION ALL               
                              SELECT               
                                    CLTCODE,               
                                    OPPBAL = ISNULL(SUM(               
                                    CASE               
                                          WHEN UPPER(B.DRCR) = 'C'               
                                          THEN B.VAMT               
      ELSE -B.VAMT               
                                    END              
                                    ), 0)               
                              FROM LEDGER B WITH(NOLOCK)               
                              WHERE B.CLTCODE > = @FCODE               
                                    AND B.CLTCODE < = @TCODE               
                                    AND B.VDT < @@OPENDATE               
                                    AND EDT >= @@OPENDATE               
                              GROUP BY CLTCODE               
                        )               
                        T               
                  GROUP BY CLTCODE               
            END                  
      END                    
                          
                    
      /*GENERATING BLANK STRUCTURE FOR FILTERED LEDGER */                    
            SELECT               
                  L.*,               
                  SHORTDESC = SPACE(35)               
            INTO #LEDGERDATA               
            FROM LEDGER L WITH(NOLOCK)               
            WHERE 1 = 2               


                          
                    
                    
      /*GETTING FIILTERED LEDGER*/                    
      IF @SELECTBY = 'VDT'                    
      BEGIN                    
            INSERT               
            INTO #LEDGERDATA               
            SELECT               
                  L.*,               
                  ISNULL(V.SHORTDESC, '') SHORTDESC               
            FROM LEDGER L WITH(NOLOCK),               
                  VMAST V WITH(NOLOCK)               
            WHERE VDT > = @FDATE + ' 00:00:00'               
                  AND L.VTYP = V.VTYPE               
                  AND VDT < = @TDATE +' 23:59:59'               
                  AND CLTCODE > = @FCODE               
                  AND CLTCODE < = @TCODE               
      END                     
      ELSE                    
      BEGIN                    
            INSERT               
            INTO #LEDGERDATA               
            SELECT               
                  L.*,               
                  ISNULL(V.SHORTDESC, '') SHORTDESC               
            FROM LEDGER L WITH(NOLOCK),               
                  VMAST V WITH(NOLOCK)               
            WHERE EDT > = @FDATE + ' 00:00:00'               
                  AND L.VTYP = V.VTYPE               
                  AND EDT < = @TDATE +' 23:59:59'               
                  AND CLTCODE > = @FCODE               
                  AND CLTCODE < = @TCODE               
      END                    
                    
       
              
/*GETTING CLIENT LIST*/                    
      SELECT               
            C2.PARTY_CODE,              
   C1.LONG_NAME,              
            BANK_NAME = ISNULL(C4.BANKID, ''),               
            L_ADDRESS1,               
            L_ADDRESS2,               
            L_ADDRESS3,               
            L_CITY,               
            L_ZIP,               
            RES_PHONE1,               
            C1.BRANCH_CD,               
           FAMILY,               
            C1.SUB_BROKER,               
            TRADER,               
            CL_TYPE,               
            CLTDPID = ISNULL(CLTDPID, '')               
      INTO #LEDGERCLIENTS               
      FROM MCDXCDS.DBO.CLIENT1 C1 WITH(NOLOCK),               
            MCDXCDS.DBO.CLIENT2 C2 WITH(NOLOCK)               
      LEFT OUTER JOIN               
            MCDXCDS.DBO.CLIENT4 C4 WITH(NOLOCK)               
            ON               
            (              
                  C2.PARTY_CODE = C4.PARTY_CODE               
                  AND DEPOSITORY NOT IN ('NSDL', 'CDSL')               
-- AND DEFDP = 1              
                  AND DEFDP = 0          
            )               
      WHERE C1.CL_CODE = C2.CL_CODE               
            AND C1.BRANCH_CD LIKE (              
            CASE               
                  WHEN @STATUSID = 'BRANCH'               
                  THEN @STATUSNAME               
                  ELSE '%'               
            END              
            )               
            AND SUB_BROKER LIKE (              
            CASE               
                  WHEN @STATUSID = 'SUB_BROKER'               
                  THEN @STATUSNAME               
                  ELSE '%'               
            END              
            )               
     AND SUB_BROKER LIKE (              
            CASE               
                  WHEN @STATUSID = 'SUBBROKER'               
                  THEN @STATUSNAME               
                  ELSE '%'               
            END              
            )               
            AND TRADER LIKE (              
            CASE               
                  WHEN @STATUSID = 'TRADER'               
                  THEN @STATUSNAME               
                  ELSE '%'               
            END              
            )     
            AND AREA LIKE (              
            CASE               
                  WHEN @STATUSID = 'AREA'               
                  THEN @STATUSNAME               
                  ELSE '%'               
            END              
            )         
            AND REGION LIKE (              
            CASE               
                  WHEN @STATUSID = 'REGION'               
                  THEN @STATUSNAME               
                  ELSE '%'               
            END              
            )                        
            AND C1.FAMILY LIKE (              
            CASE               
                  WHEN @STATUSID = 'FAMILY'               
                  THEN @STATUSNAME               
                  ELSE '%'               
            END              
            )               
            AND C2.PARTY_CODE LIKE (              
            CASE               
                  WHEN @STATUSID = 'CLIENT'               
                  THEN @STATUSNAME               
                  ELSE '%'               
            END              
         )               
            AND C1.BRANCH_CD LIKE @STRBRANCH +'%'               
            AND C2.PARTY_CODE > = @FCODE               
            AND C2.PARTY_CODE < = @TCODE               
              
              
      CREATE TABLE [#TMPLEDGER] (              
       [BOOKTYPE] [CHAR] (2)  NULL ,              
       [VOUDT] [DATETIME] NULL ,              
       [EFFDT] [DATETIME] NULL ,              
       [SHORTDESC] [VARCHAR] (35)  NULL ,              
       [DRAMT] [MONEY] NULL ,              
       [CRAMT] [MONEY] NULL ,              
       [VNO] [VARCHAR] (12)  NULL ,              
       [DDNO] [VARCHAR] (15)  NULL ,              
       [NARRATION] [VARCHAR] (234)  NULL ,              
       [CLTCODE] [VARCHAR] (10)  NOT NULL ,              
       [VTYP] [SMALLINT] NULL ,              
       [VDT] [VARCHAR] (30)  NULL ,              
       [EDT] [VARCHAR] (30)  NULL ,              
       [ACNAME] [VARCHAR] (100)  NULL ,              
       [OPBAL] [MONEY] NULL ,              
       [L_ADDRESS1] [VARCHAR] (40)  NOT NULL ,              
       [L_ADDRESS2] [VARCHAR] (40)  NULL ,              
       [L_ADDRESS3] [VARCHAR] (40)  NULL ,              
       [L_CITY] [VARCHAR] (40)  NULL ,              
       [L_ZIP] [VARCHAR] (10)  NULL ,              
       [RES_PHONE1] [VARCHAR] (15)  NULL ,              
  [BRANCH_CD] [VARCHAR] (10)  NOT NULL ,              
       [CROSAC] [VARCHAR] (10)  NULL ,              
       [EDIFF] [INT] NULL ,              
       [FAMILY] [VARCHAR] (10)  NOT NULL ,              
       [SUB_BROKER] [VARCHAR] (10)  NOT NULL ,              
       [TRADER] [VARCHAR] (20)  NOT NULL ,              
       [CL_TYPE] [VARCHAR] (3)  NOT NULL ,              
       [BANK_NAME] [VARCHAR] (50)  NOT NULL ,              
       [CLTDPID] [VARCHAR] (16)  NOT NULL ,              
       [LNO] [INT] NULL,            
       [PDT] [DATETIME] NULL            
      ) ON [PRIMARY]              
              
                    
/*GETTING LDDGER ENTRIES*/                    
      INSERT               
            INTO #TMPLEDGER               
      SELECT               
            L.BOOKTYPE,               
 VOUDT = L.VDT,               
            EFFDT = L.EDT,               
            L.SHORTDESC,               
            DRAMT = (              
            CASE               
                  WHEN UPPER(L.DRCR) = 'D'               
                  THEN L.VAMT               
                  ELSE 0               
            END              
            ),               
            CRAMT = (              
            CASE               
                  WHEN UPPER(L.DRCR) = 'C'               
                  THEN L.VAMT               
                  ELSE 0               
            END              
            ),               
            L.VNO,               
            DDNO = SPACE(15),               
            L.NARRATION,               
            C.PARTY_CODE CLTCODE,               
            L.VTYP,               
            CONVERT(VARCHAR, L.VDT, 103) VDT,               
            CONVERT(VARCHAR, L.EDT, 103) EDT,               
--            L.ACNAME ,               
            C.LONG_NAME,              
            OPBAL = VAMT,               
            C.L_ADDRESS1,               
            C.L_ADDRESS2,               
            C.L_ADDRESS3,               
            C.L_CITY,       
            C.L_ZIP,               
            C.RES_PHONE1,               
            C.BRANCH_CD,               
            L.CLTCODE CROSAC ,               
            EDIFF = DATEDIFF(D, L.EDT, GETDATE()),               
            C.FAMILY,               
            C.SUB_BROKER,               
            C.TRADER,               
            C.CL_TYPE,               
            C.BANK_NAME,               
            C.CLTDPID,               
            L.LNO,            
  L.PDT               
      FROM #LEDGERDATA L WITH(NOLOCK)               
      RIGHT OUTER JOIN               
            #LEDGERCLIENTS C WITH(NOLOCK)               
            ON               
            (              
                  L.CLTCODE = C.PARTY_CODE              
            )               
              
        select * from #ledgerdata
  select * from #TMPLEDGER

return             
                    
/*UPDATING OPENING BLANACE*/         
      UPDATE               
            #TMPLEDGER               
            SET OPBAL = 0               
              
      UPDATE               
            #TMPLEDGER               
            SET OPBAL = T.OPPBAL               
      FROM #TMPLEDGER L WITH(NOLOCK),               
            #OPPBALANCE T WITH(NOLOCK)               
      WHERE L.CLTCODE = T.CLTCODE               
                    
              
              
/*UPDATING CHEQUE NUMBER*/                    
      UPDATE               
            #TMPLEDGER               
            SET DDNO = L1.DDNO               
      FROM LEDGER1 L1 WITH(NOLOCK)               
      WHERE L1.VNO = #TMPLEDGER.VNO               
            AND L1.VTYP = #TMPLEDGER.VTYP               
            AND L1.BOOKTYPE = #TMPLEDGER.BOOKTYPE               
            AND L1.LNO = #TMPLEDGER.LNO               
                    
              
              
/*UPDATING CROSS ACCOUNT CODE*/                    
      UPDATE               
            #TMPLEDGER               
            SET #TMPLEDGER.CROSAC = B.CLTCODE               
      FROM LEDGER B WITH(NOLOCK),               
            ACMAST V WITH(NOLOCK)               
      WHERE B.CLTCODE = V.CLTCODE               
            AND V.ACCAT = 2               
            AND #TMPLEDGER.BOOKTYPE = B.BOOKTYPE               
            AND #TMPLEDGER.VNO = B.VNO               
            AND #TMPLEDGER.VTYP = B.VTYP               
            AND LTRIM(RTRIM(#TMPLEDGER.VTYP)) IN ('01', '1', '02', '2', '03', '3', '04', '4', '05', '5', '16', '17', '19', '20', '22', '23')               
                    
              
              
/*UPDATING BANK NAME*/                                   
      UPDATE               
            #TMPLEDGER               
            SET #TMPLEDGER.BANK_NAME = B.BANK_NAME               
      FROM MCDXCDS.DBO.POBANK B WITH(NOLOCK)               
      WHERE LTRIM(RTRIM(CAST(B.BANKID AS CHAR))) = LTRIM(RTRIM(#TMPLEDGER.BANK_NAME))               
              
                    
      IF @STRORDER = 'ACCODE'                    
      BEGIN                    
            IF @SELECTBY = 'VDT'                    
            BEGIN                     
                  SELECT               
                        L.*               
                  FROM #TMPLEDGER L WITH(NOLOCK),               
                        ACMAST A WITH(NOLOCK)               
                  WHERE L.CLTCODE = A.CLTCODE               
                        AND ACCAT IN ('4', '104')               
    AND (CRAMT <> 0 OR DRAMT <> 0 OR OPBAL <> 0)              
                  ORDER BY L.CLTCODE,            
                        VOUDT, PDT            
            END                    
            ELSE                    
            BEGIN                    
                  SELECT               
                        L.*               
                  FROM #TMPLEDGER L WITH(NOLOCK),               
                        ACMAST A WITH(NOLOCK)               
                  WHERE L.CLTCODE = A.CLTCODE               
                        AND ACCAT IN ('4', '104')               
        ORDER BY L.CLTCODE,              
                        EFFDT, PDT            
            END                    
      END                    
      ELSE                    
      BEGIN                    
            IF @SELECTBY = 'VDT'                    
            BEGIN                     
                  SELECT               
                        L.*               
                  FROM #TMPLEDGER L WITH(NOLOCK),               
                        ACMAST A WITH(NOLOCK)               
                  WHERE L.CLTCODE = A.CLTCODE               
                        AND ACCAT IN ('4', '104')           
                  ORDER BY L.ACNAME,             
                        VOUDT, PDT               
            END                    
            ELSE                    
            BEGIN                    
                  SELECT               
                        L.*               
                  FROM #TMPLEDGER L WITH(NOLOCK),               
                        ACMAST A WITH(NOLOCK)               
                  WHERE L.CLTCODE = A.CLTCODE               
                        AND ACCAT IN ('4', '104')               
                  ORDER BY L.ACNAME,              
                        EFFDT, PDT            
            END                    
      END                    
                    
/*  ------------------------------   END OF THE PROC  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_PARTYLEDGER_ALL
-- --------------------------------------------------

--EXEC RPT_ACC_PARTYLEDGER_ALL 'APR  1 2007','AUG 14 2007','A','B','ACCODE','VDT','BROKER','BROKER','', 'N'  
  
--EXEC RPT_ACC_PARTYLEDGER_ALL 'APR  1 2007','JUL 17 2007','ALWIND0001','ALWIND0001','ACCODE','VDT','BROKER','BROKER','', 'N'      
      
      
--EXEC RPT_ACC_PARTYLEDGER_ALL 'JAN 1 2007','JAN 25 2007','051','051','ACCODE','VDT','BROKER','BROKER','', 'N'          
          
          
CREATE PROCEDURE [DBO].[RPT_ACC_PARTYLEDGER_ALL]            
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */            
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */            
@FCODE VARCHAR(10),            
@TCODE VARCHAR(10),            
@STRORDER VARCHAR(6),            
@SELECTBY VARCHAR(3),            
@STATUSID VARCHAR(15),            
@STATUSNAME VARCHAR(15),            
@STRBRANCH VARCHAR(10),       
@ORDERFLG VARCHAR(1) = 'N' ,        
@SINGLE VARCHAR(1) = 'N'            
            
AS            
            
BEGIN            
            
CREATE TABLE [DBO].[#TMPLEDGERNEW] (            
  [BOOKTYPE] [CHAR] (2) NULL ,            
  [VOUDT] [DATETIME] NULL ,            
  [EFFDT] [DATETIME] NULL ,            
  [SHORTDESC] [CHAR] (6) NULL ,            
  [DRAMT] [MONEY] NULL ,            
  [CRAMT] [MONEY] NULL ,            
  [VNO] [VARCHAR] (12) NULL ,            
  [DDNO] [VARCHAR] (15) NULL ,            
  [NARRATION] [VARCHAR] (234) NULL ,            
  [CLTCODE] [VARCHAR] (10) NOT NULL ,            
  [VTYP] [SMALLINT] NULL ,            
  [VDT] [VARCHAR] (30) NULL ,            
  [EDT] [VARCHAR] (30) NULL ,            
  [ACNAME] [VARCHAR] (100) NULL ,            
  [OPBAL] [MONEY] NULL ,            
  [L_ADDRESS1] [VARCHAR] (40) NULL ,            
  [L_ADDRESS2] [VARCHAR] (40) NULL ,            
  [L_ADDRESS3] [VARCHAR] (40) NULL ,            
  [L_CITY] [VARCHAR] (40) NULL ,            
  [L_ZIP] [VARCHAR] (10) NULL ,            
  [RES_PHONE1] [VARCHAR] (15) NULL ,            
  [BRANCH_CD] [VARCHAR] (10) NULL ,            
  [CROSAC] [VARCHAR] (10) NULL ,            
  [EDIFF] [INT] NULL ,            
  [FAMILY] [VARCHAR] (10) NULL ,            
  [SUB_BROKER] [VARCHAR] (10) NULL ,            
  [TRADER] [VARCHAR] (20) NULL ,            
  [CL_TYPE] [VARCHAR] (3) NULL ,            
  [BANK_NAME] [VARCHAR] (50) NULL ,            
  [CLTDPID] [VARCHAR] (16) NULL ,            
  [LNO] [DECIMAL](5, 0) NULL ,            
  [PDT] [DATETIME] NULL ,            
  [SEGMENT] [VARCHAR] (4) NULL,            
  [ENTITY] [VARCHAR] (50) NULL,            
  [ORDERSEG][BIGINT] NULL            
 ) ON [PRIMARY]            
            
            
            
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,            
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,            
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)            
EXEC ACCOUNT.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH            
    
 IF @ORDERFLG = 'N'    
 BEGIN    
  UPDATE #TMPLEDGERNEW SET SEGMENT='1NSE',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL            
 END    
 ELSE    
 BEGIN    
   UPDATE #TMPLEDGERNEW SET SEGMENT='1NSE',ENTITY='CAPITAL - NSE', ORDERSEG = 1 WHERE SEGMENT IS NULL            
 END    
          
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,            
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,            
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)            
EXEC ACCOUNTBSE.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH            
IF @ORDERFLG = 'N'    
 BEGIN      
 UPDATE #TMPLEDGERNEW SET SEGMENT='2BSE',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL            
END    
ELSE    
BEGIN    
 UPDATE #TMPLEDGERNEW SET SEGMENT='2BSE',ENTITY='CAPITAL - BSE', ORDERSEG = 2 WHERE SEGMENT IS NULL       
    
    
END    
--NSEFO START            
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,            
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,            
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)            
EXEC ACCOUNTFO.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH            
            
--NSEFO END            
IF @ORDERFLG = 'N'    
 BEGIN              
UPDATE #TMPLEDGERNEW SET SEGMENT='3NFO',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL            
END    
ELSE    
BEGIN    
UPDATE #TMPLEDGERNEW SET SEGMENT='3NFO',ENTITY='DERIVATIVES - NSE', ORDERSEG = 3 WHERE SEGMENT IS NULL          
END    
/*            
--BSEFO START            
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,            
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,            
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)            
EXEC ACCOUNTBSEFO.DBO.RPT_ACC_PARTYLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH            
            
--BSEFO END            
            
UPDATE #TMPLEDGERNEW SET SEGMENT='4BFO',ENTITY='SETTLEMENT LEDGER', ORDERSEG = 1 WHERE SEGMENT IS NULL            
*/          
            
  PRINT '1'          
--MARGIN            
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,            
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,            
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)            
EXEC ACCOUNT.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH            
IF @ORDERFLG = 'N'    
 BEGIN              
UPDATE #TMPLEDGERNEW SET SEGMENT='5NSE',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL            
END    
ELSE    
BEGIN    
UPDATE #TMPLEDGERNEW SET SEGMENT='5NSE',ENTITY='MARGIN - NSE', ORDERSEG = 5 WHERE SEGMENT IS NULL            
END    
    
          
  PRINT '2'            
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,            
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,            
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)            
EXEC ACCOUNTBSE.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH            
     
IF @ORDERFLG = 'N'    
 BEGIN               
UPDATE #TMPLEDGERNEW SET SEGMENT='6BSE',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL            
END     
ELSE    
BEGIN    
UPDATE #TMPLEDGERNEW SET SEGMENT='6BSE',ENTITY='MARGIN - BSE', ORDERSEG = 6 WHERE SEGMENT IS NULL            
END    
           
  PRINT '3'          
--NSEFO START            
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,            
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,            
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)            
EXEC ACCOUNTFO.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH            
--NSEFO END            
            
 IF @ORDERFLG = 'N'    
 BEGIN              
UPDATE #TMPLEDGERNEW SET SEGMENT='7NFO',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL            
END     
ELSE    
BEGIN    
UPDATE #TMPLEDGERNEW SET SEGMENT='7NFO',ENTITY='MARGIN - NFO', ORDERSEG = 7 WHERE SEGMENT IS NULL            
END    
    
    
  PRINT '4'            
          
/*          
--BSEFO START            
INSERT INTO #TMPLEDGERNEW(BOOKTYPE,VOUDT,EFFDT,SHORTDESC,DRAMT,CRAMT,VNO,DDNO,NARRATION,CLTCODE,    
VTYP,VDT,EDT,ACNAME,OPBAL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,RES_PHONE1,BRANCH_CD,            
CROSAC,EDIFF,FAMILY,SUB_BROKER,TRADER,CL_TYPE,BANK_NAME,CLTDPID,LNO, PDT)            
EXEC ACCOUNTBSEFO.DBO.RPT_ACC_MARGINLEDGER @FDATE,@TDATE,@FCODE,@TCODE,@STRORDER ,@SELECTBY,@STATUSID,@STATUSNAME,@STRBRANCH            
--BSEFO END            
            
            
      
UPDATE #TMPLEDGERNEW SET SEGMENT='8BFO',ENTITY='MARGIN  LEDGER', ORDERSEG = 2 WHERE SEGMENT IS NULL            
*/          
    
IF @ORDERFLG = 'N'    
 BEGIN     
SELECT CLTCODE, SEGMENT, ORDERSEG, OPBAL = MAX(OPBAL) INTO #OPBAL FROM #TMPLEDGERNEW       
GROUP BY CLTCODE, SEGMENT, ORDERSEG      
      
SELECT CLTCODE, ORDERSEG, OPBAL = SUM(OPBAL) INTO #FINOPBAL FROM #OPBAL       
GROUP BY CLTCODE, ORDERSEG      
      
      
UPDATE               
            #TMPLEDGERNEW             
            SET OPBAL = 0               
              
      UPDATE               
            #TMPLEDGERNEW              
            SET OPBAL = T.OPBAL               
      FROM #TMPLEDGERNEW L WITH(NOLOCK),               
            #FINOPBAL T WITH(NOLOCK)               
      WHERE L.CLTCODE = T.CLTCODE  AND L.ORDERSEG = T.ORDERSEG           
END    
      
            
IF @STRORDER = 'ACCODE'            
 BEGIN            
  IF @SELECTBY = 'VDT'            
   BEGIN            
    --IF @SINGLE = 'Y'            
    -- BEGIN            
    --  SELECT * FROM #TMPLEDGERNEW ORDER BY ORDERSEG,CLTCODE,VOUDT        
 IF @ORDERFLG = 'N'    
 BEGIN    
 SELECT * FROM #TMPLEDGERNEW ORDER BY CLTCODE,ORDERSEG,VOUDT             
 END    
 ELSE    
 BEGIN    
 SELECT * FROM #TMPLEDGERNEW ORDER BY CLTCODE,VOUDT,ORDERSEG             
 END    
    
    -- END            
   -- ELSE            
   --  BEGIN            
   --   SELECT * FROM #TMPLEDGERNEW ORDER BY CLTCODE,ORDERSEG,VOUDT            
   --  END            
   END            
  ELSE            
   BEGIN            
   -- IF @SINGLE = 'Y'            
    -- BEGIN      
 IF @ORDERFLG = 'N'    
 BEGIN    
      SELECT * FROM #TMPLEDGERNEW ORDER BY CLTCODE,ORDERSEG,EFFDT     
 END    
 ELSE    
 BEGIN       
  SELECT * FROM #TMPLEDGERNEW ORDER BY CLTCODE,EFFDT,ORDERSEG    
 END        
   --  END            
  --  ELSE            
  --   BEGIN            
   --   SELECT * FROM #TMPLEDGERNEW ORDER BY CLTCODE,ORDERSEG,EFFDT            
  --   END            
   END            
 END            
--ELSE            
-- BEGIN            
--  IF @SELECTBY = 'VDT'            
 --  BEGIN            
 --   IF @SINGLE = 'Y'            
--     BEGIN            
--      SELECT * FROM #TMPLEDGERNEW ORDER BY ORDERSEG,ACNAME,VOUDT            
 --    END            
 --   ELSE            
  --   BEGIN            
 --     SELECT * FROM #TMPLEDGERNEW ORDER BY ACNAME,ORDERSEG,VOUDT            
  --   END            
--   END            
--  ELSE            
 --  BEGIN            
 --   IF @SINGLE = 'Y'            
  --   BEGIN            
  --    SELECT * FROM #TMPLEDGERNEW ORDER BY ORDERSEG,ACNAME,EFFDT            
 --    END            
--    ELSE            
 --    BEGIN            
 --     SELECT * FROM #TMPLEDGERNEW ORDER BY ACNAME,ORDERSEG,EFFDT            
  --   END            
 --  END            
-- END            
            
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_acc_partyledger_SEBI
-- --------------------------------------------------
CREATE PROCEDURE Rpt_acc_partyledger_SEBI @fdate      VARCHAR(11),/* As mmm dd yyyy */   
                                    @tdate      VARCHAR(11),/* As mmm dd yyyy */   
                                    @fcode      VARCHAR(10),   
                                    @tcode      VARCHAR(10),   
                                    @strorder   VARCHAR(6),   
                                    @selectby   VARCHAR(3),   
                                    @statusid   VARCHAR(15),   
                                    @statusname VARCHAR(15),   
                                    @strbranch  VARCHAR(10)   
AS   
  DECLARE @@opendate AS VARCHAR(11)   
  
  SET TRANSACTION ISOLATION LEVEL READ uncommitted   
  
  /*Getting last opening date */   
  IF Upper(@selectby) = 'VDT'   
    BEGIN   
        SELECT @@opendate = (SELECT LEFT(CONVERT(VARCHAR, Isnull(MAX(vdt), 0),   
                                         109   
                                         ),   
                                    11)   
                             FROM   ledger_SEBI   
                             WHERE  vtyp = 18   
                                    AND vdt <= @fdate)   
    END   
  ELSE   
    BEGIN   
        SELECT @@opendate = (SELECT LEFT(CONVERT(VARCHAR, Isnull(MAX(edt), 0),   
                                         109   
                                         ),   
                                    11)   
                             FROM   ledger_SEBI   
                             WHERE  vtyp = 18   
                                    AND edt <= @fdate)   
    END   
  
  /*Creating blank table for opening balance*/   
  SELECT cltcode,   
         oppbal=vamt   
  INTO   #oppbalance   
  FROM   ledger_SEBI   
  WHERE  1 = 2   
  
  /*Getting opening balance*/   
  IF @selectby = 'vdt'   
    BEGIN   
        IF @@opendate = @fdate   
          BEGIN   
              INSERT INTO #oppbalance   
              SELECT cltcode,   
                     oppbal = Isnull(SUM(CASE   
                                           WHEN Upper(b.drcr) = 'D' THEN b.vamt   
                                           ELSE -b.vamt   
                                         END), 0)   
              FROM   ledger_SEBI b   
              WHERE  b.cltcode >= @FCode   
                     AND b.cltcode <= @TCode   
                     AND b.vdt LIKE @fdate + '%'   
                     AND vtyp = 18   
              GROUP  BY cltcode   
          END   
        ELSE   
          BEGIN   
              INSERT INTO #oppbalance   
              SELECT cltcode,   
                     oppbal = Isnull(SUM(CASE   
                                           WHEN Upper(b.drcr) = 'D' THEN b.vamt   
                                           ELSE -b.vamt   
                                         END), 0)   
              FROM   ledger_SEBI b   
              WHERE  b.cltcode >= @FCode   
                     AND b.cltcode <= @TCode   
                     AND b.vdt >= @@opendate + ' 00:00:00'   
                     AND vdt < @fdate   
              GROUP  BY cltcode   
          END   
    END     
  ELSE   
    BEGIN   
        IF @@opendate = @fdate   
          BEGIN   
              INSERT INTO #oppbalance   
              SELECT cltcode,   
                     opbal=SUM(opbal)   
              FROM   (SELECT cltcode,   
                             opbal = Isnull(SUM(CASE   
                                                  WHEN Upper(drcr) = 'D' THEN   
                                                  vamt   
                                                  ELSE -vamt   
                                                END), 0)   
                      FROM   ledger_SEBI   
                      WHERE  cltcode >= @FCode   
                             AND cltcode <= @TCode   
                             AND edt LIKE @@opendate + '%'   
                             AND vtyp = 18   
                      GROUP  BY cltcode   
                      UNION ALL   
                      SELECT cltcode,   
                             oppbal = Isnull(SUM(CASE   
                                        WHEN Upper(b.drcr) = 'C' THEN   
                                                   b.vamt   
                                                   ELSE -b.vamt   
                                                 END), 0)   
                      FROM   ledger_SEBI b   
                      WHERE  b.cltcode >= @FCode   
                             AND b.cltcode <= @TCode   
                             AND b.edt >= @@opendate + ' 00:00:00'   
                             AND vdt < @@opendate   
                      GROUP  BY cltcode) t   
              GROUP  BY cltcode   
          END   
        ELSE   
          BEGIN   
              INSERT INTO #oppbalance   
              SELECT cltcode,   
                     opbal=SUM(opbal)   
              FROM   (SELECT cltcode,   
                             opbal = Isnull(SUM(CASE   
                                                  WHEN Upper(drcr) = 'D' THEN   
                                                  vamt   
                                                  ELSE -vamt   
                                                END), 0)   
                      FROM   ledger_SEBI   
                      WHERE  cltcode >= @FCode   
                             AND cltcode <= @TCode   
                             AND edt LIKE @@opendate + '%'   
                             AND vtyp = 18   
                      GROUP  BY cltcode   
                      UNION ALL   
                      SELECT cltcode,   
                             opbal = SUM(CASE   
                                           WHEN Upper(drcr) = 'D' THEN vamt   
                                           ELSE -vamt   
                                         END)   
                      FROM   ledger_SEBI   
                      WHERE  cltcode >= @FCode   
                             AND cltcode <= @TCode   
                             AND edt >= @@opendate + ' 00:00:00'   
                             AND edt < @fdate   
                             AND vtyp <> 18   
                      GROUP  BY cltcode   
                      UNION ALL   
                      SELECT cltcode,   
                             oppbal = Isnull(SUM(CASE   
                                                   WHEN Upper(b.drcr) = 'C' THEN   
                                                   b.vamt   
                                                   ELSE -b.vamt   
                                                 END), 0)   
                      FROM   ledger_SEBI b   
                      WHERE  b.cltcode >= @FCode   
                             AND b.cltcode <= @TCode   
                             AND b.edt >= @@opendate + ' 00:00:00'   
                             AND vdt < @@opendate   
                             AND vtyp <> 18   
                      GROUP  BY cltcode) t   
              GROUP  BY cltcode   
          END   
    END   
  
  /*Generating blank structure for filtered Ledger */   
  SELECT l.*,   
         shortdesc=Space(35)   
  INTO   #ledgerdata   
  FROM   ledger_SEBI l   
  WHERE  1 = 2   
  
  /*Getting fiiltered ledger*/   
  IF @selectby = 'vdt'   
    BEGIN   
        INSERT INTO #ledgerdata   
        SELECT l.*,   
               Isnull(v.shortdesc, '') shortdesc   
        FROM   ledger_SEBI l,   
               vmast v   
        WHERE  vdt >= @fdate + ' 00:00:00'   
               AND l.vtyp = v.vtype   
               AND vdt <= @tdate + ' 23:59:59'   
               AND cltcode >= @fcode   
               AND cltcode <= @tcode   
    END   
  ELSE   
    BEGIN   
        INSERT INTO #ledgerdata   
        SELECT l.*,   
               Isnull(v.shortdesc, '') shortdesc   
        FROM   ledger_SEBI l,   
               vmast v   
        WHERE  edt >= @fdate + ' 00:00:00'   
               AND l.vtyp = v.vtype   
               AND edt <= @tdate + ' 23:59:59'   
               AND cltcode >= @fcode   
               AND cltcode <= @tcode   
    END   
  
  /*Getting client list*/   
  SELECT c2.party_code,   
         bank_name =CONVERT(VARCHAR(50), Isnull(c4.bankid, Space(50))),   
         l_address1 = CONVERT(VARCHAR(100), Isnull(l_address1, Space(100))),   
         l_address2 = CONVERT(VARCHAR(100), Isnull(l_address2, Space(100))),   
         l_address3 = CONVERT(VARCHAR(100), Isnull(l_address3, Space(100))),   
         l_city,   
         l_zip,   
         res_phone1,   
         c1.branch_cd,   
         family,   
         c1.sub_broker,   
         trader,   
         cl_type,   
         cltdpid =Isnull(cltdpid, '')   
  INTO   #ledgerclients   
  FROM   mcdxcds.dbo.client1 c1,   
         mcdxcds.dbo.client2 c2   
         LEFT OUTER JOIN mcdxcds.dbo.client4 c4   
           ON ( c2.party_code = c4.party_code   
                AND depository NOT IN ( 'NSDL', 'CDSL' )   
                AND defdp = 1 )   
  WHERE  c1.cl_code = c2.cl_code   
         AND c1.branch_cd LIKE ( CASE   
                                   WHEN @statusid = 'branch' THEN @statusname   
                                   ELSE '%'   
                                 END )   
         AND sub_broker LIKE ( CASE   
                                 WHEN @statusid = 'subbroker' THEN @statusname   
                                 ELSE '%'   
                               END )   
         AND trader LIKE ( CASE   
                             WHEN @statusid = 'trader' THEN @statusname   
                             ELSE '%'   
                           END )   
         AND c1.family LIKE ( CASE   
                                WHEN @statusid = 'family' THEN @statusname   
                                ELSE '%'   
                              END )   
         AND c2.party_code LIKE ( CASE   
                                    WHEN @statusid = 'client' THEN @statusname   
                                    ELSE '%'   
                                  END )   
         AND c1.branch_cd LIKE @strbranch + '%'   
         AND c2.party_code >= @fcode   
         AND c2.party_code <= @tcode   
  
  IF @statusid = 'broker'   
    BEGIN   
        /*including remissor also at report*/   
        INSERT INTO #ledgerclients   
        SELECT sub_broker      party_code,   
               ' '             bank_name,   
               Rtrim(address1) l_address1,   
               Rtrim(address2) l_address2,   
               ' '             l_address3,   
               city            l_city,   
               zip             l_zip,   
               phone1          res_phone1,   
               branch_code     branch_cd,   
               ' '             family,   
               ' '             sub_broker,   
               ' '             trader,   
               ' '             cl_type,   
               ' '             cltdpid   
        FROM   mcdxcds.dbo.subbrokers   
        WHERE  sub_broker NOT IN (SELECT party_code   
                                  FROM   #ledgerclients)   
    END   
  
  /*Getting lddger entries*/   
  SELECT l.booktype,   
         voudt=l.vdt,   
         effdt=l.edt,   
         l.shortdesc,   
         dramt=( CASE   
                   WHEN Upper(l.drcr) = 'D' THEN l.vamt   
                   ELSE 0   
                 END ),   
         cramt=( CASE   
                   WHEN Upper(l.drcr) = 'C' THEN l.vamt   
                   ELSE 0   
                 END ),   
         l.vno,   
         ddno= Space(15),   
         l.narration,   
         c.party_code                 cltcode,   
         l.vtyp,   
         CONVERT(VARCHAR, l.vdt, 103) vdt,   
         CONVERT(VARCHAR, l.edt, 103) edt,   
         l.acname,   
         opbal = vamt,   
         c.l_address1,   
         c.l_address2,   
         c.l_address3,   
         c.l_city,   
         c.l_zip,   
         c.res_phone1,   
         c.branch_cd,   
         l.cltcode                    crosac,   
         ediff=Datediff(d, l.edt, Getdate()),   
         c.family,   
         c.sub_broker,   
         c.trader,   
         c.cl_type,   
         c.bank_name,   
         c.cltdpid,   
         l.lno   
  INTO   #tmpledger   
  FROM   #ledgerdata l   
         RIGHT OUTER JOIN #ledgerclients c   
           ON ( l.cltcode = c.party_code )   
  
  /*Updating opening blanace*/   
  UPDATE #tmpledger   
  SET    opbal = 0   
  
  UPDATE #tmpledger   
  SET    opbal = t.oppbal   
  FROM   #tmpledger l,   
         #oppbalance t   
  WHERE  l.cltcode = t.cltcode   
  
  /*Updating cheque number*/   
  UPDATE #tmpledger   
  SET    ddno = l1.ddno   
  FROM   ledger1 l1   
  WHERE  l1.vno = #tmpledger.vno   
         AND l1.vtyp = #tmpledger.vtyp   
         AND l1.booktype = #tmpledger.booktype   
         AND l1.lno = #tmpledger.lno   
  
  /*Updating cross account code*/   
  UPDATE #tmpledger   
  SET    #tmpledger.crosac = b.cltcode   
  FROM   ledger_sebi b,   
         acmast v   
  WHERE  b.cltcode = v.cltcode   
         AND v.accat = 2   
         AND #tmpledger.booktype = b.booktype   
         AND #tmpledger.vno = b.vno   
         AND #tmpledger.vtyp = b.vtyp   
         AND Ltrim(Rtrim(#tmpledger.vtyp)) IN ( '01', '1', '02', '2',   
                                                '03', '3', '04', '4',   
                                                '05', '5', '16', '17',   
                                                '19', '20', '22', '23' )   
  
  /*Updating bank name*/   
  UPDATE #tmpledger   
  SET    #tmpledger.bank_name = b.bank_name   
  FROM   mcdxcds.dbo.pobank b   
  WHERE  Ltrim(Rtrim(CAST(b.bankid AS CHAR))) = Ltrim(   
         Rtrim(#tmpledger.bank_name))   
  
  IF @strorder = 'ACCODE'   
    BEGIN   
        IF @selectby = 'vdt'   
          BEGIN   
              SELECT l.*,   
                     a.longname acname   
              FROM   #tmpledger l,   
                     acmast a   
              WHERE  a.cltcode = l.cltcode   
                     AND ( l.dramt <> 0   
                            OR l.cramt <> 0   
                            OR Round(opbal, 0) <> 0 )   
              ORDER  BY l.cltcode,   
                        voudt   
          END   
        ELSE   
          BEGIN   
              SELECT l.*,   
                     a.longname acname   
              FROM   #tmpledger l,   
                     acmast a   
              WHERE  a.cltcode = l.cltcode   
                     AND ( l.dramt <> 0   
                            OR l.cramt <> 0   
                            OR Round(opbal, 0) <> 0 )   
              ORDER  BY l.cltcode,   
                        effdt   
          END   
    END   
  ELSE   
    BEGIN   
        IF @selectby = 'vdt'   
          BEGIN   
              SELECT l.*,   
                     a.longname acname   
              FROM   #tmpledger l,   
                     acmast a   
              WHERE  a.cltcode = l.cltcode   
                     AND ( l.dramt <> 0   
                            OR l.cramt <> 0   
                            OR Round(opbal, 0) <> 0 )   
              ORDER  BY l.acname,   
                        voudt   
          END   
        ELSE   
          BEGIN   
              SELECT l.*,   
                     a.longname acname   
              FROM   #tmpledger l,   
                     acmast a   
              WHERE  a.cltcode = l.cltcode   
                     AND ( l.dramt <> 0   
                            OR l.cramt <> 0   
                            OR Round(opbal, 0) <> 0 )   
              ORDER  BY l.acname,   
                        effdt   
          END   
    END   
/*  ------------------------------   End Of the Proc  -------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_TRIALBALANCE
-- --------------------------------------------------
--Exec rpt_Acc_TrialBalance 'Nov 12 2009', 'codewise','all','NORMAL','Apr  2 2009', 'Apr  1 2009', 0,'Apr  1 2009', 'BRANCH', 'VD', 'vdt' 

---Exec rpt_Acc_TrialBalance 'Sep 30 2009', 'codewise','gl','withopbal','May  1 2009', 'Apr  1 2009', 0,'Apr  1 2009', 'BRANCH', 'VD', 'vdt'   
  
CREATE PROCEDURE RPT_ACC_TRIALBALANCE  
        
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */            
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */            
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */            
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */            
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */            
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */            
@OPENENTRYFLAG INT,            
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */            
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */            
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */            
@SORTBYDATE VARCHAR(3)          /* WHETHER REPORT IS BASED ON VDT OR EDT */            
            
AS            
        
DECLARE          
@@COSTCODE AS VARCHAR(3)        
        
            
SELECT * INTO  #ACMAST FROM ACMAST WHERE 1 = 2            
          
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT INTO #TEMPLEDGER FROM LEDGER WHERE 1=2            
          
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT,ACNAME,VNO BRANCHCODE, LNO ACCAT  INTO #TEMPLEDGERFINAL FROM LEDGER WHERE 1=2            
          
          
IF UPPER(@STATUSID) = 'BROKER'            
BEGIN        
  IF @BALANCE='NORMAL'            
    IF @SORTBYDATE = 'VDT'            
     BEGIN               
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,          
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)            
      FROM LEDGER L WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'              
      GROUP BY L.CLTCODE            
     END            
    ELSE           
      BEGIN            
       INSERT INTO #TEMPLEDGER            
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0             
       FROM              
        (               
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)          
         FROM LEDGER L WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18              
         GROUP BY L.CLTCODE              
          
         UNION ALL              
          
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)           
         FROM LEDGER  L  WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18              
         GROUP BY L.CLTCODE        
          
         UNION ALL              
          
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L.DRCR) = 'C' THEN L.VAMT ELSE -L.VAMT END),0)          
         FROM LEDGER L  WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00'            
         AND EDT < @CURRYRSTDATE              
         GROUP BY L.CLTCODE               
        ) T              
        GROUP BY CLTCODE               
      END            
   ELSE          
      IF @SORTBYDATE = 'VDT'            
       BEGIN            
        IF @STDATE = @CURRYRSTDATE        
        BEGIN        
         INSERT INTO #TEMPLEDGER            
         SELECT L.CLTCODE ,            
         DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),             
         CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),             
         OPBAL = SUM(CASE WHEN (VDT LIKE @STDATE + '%' AND VTYP = '18') THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)            
         FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'             
         GROUP BY L.CLTCODE            
        END        
     ELSE        
        BEGIN        
         INSERT INTO #TEMPLEDGER            
         SELECT L.CLTCODE ,            
         DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),             
         CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),             
         OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)            
         FROM LEDGER L WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'             
         GROUP BY L.CLTCODE            
        END        
       END            
      ELSE            
       BEGIN            
        IF @STDATE = @CURRYRSTDATE        
        BEGIN        
         INSERT INTO #TEMPLEDGER            
         SELECT L.CLTCODE ,            
         DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),             
         CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),             
         OPBAL = SUM(CASE WHEN (VDT LIKE @STDATE + '%' AND VTYP = '18') THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)            
         FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'             
         GROUP BY L.CLTCODE            
       END        
       ELSE        
       BEGIN        
         INSERT INTO #TEMPLEDGER            
         SELECT L.CLTCODE ,            
         DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END) ELSE 0 END),             
         CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE   THEN ( CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END) ELSE 0 END),             
         OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END) ELSE 0 END)            
         FROM LEDGER L WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'             
         GROUP BY L.CLTCODE            
       END        
      END             
          
IF  @VIEWOPTION = 'PARTYWISE'             
 BEGIN            
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT           
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)          
 END            
ELSE            
 IF @VIEWOPTION = 'GL'            
  BEGIN            
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT           
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)          
  END            
 ELSE            
  BEGIN            
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT           
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)          
  END           
          
IF @VIEWOPTION = 'GL'            
 BEGIN          
   INSERT INTO #TEMPLEDGERFINAL          
   SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4           
 END          
END         
         
        
/*  -- FOR BRANCH SELECTION --  */          
IF UPPER(@STATUSID) = 'BRANCH'            
BEGIN        
 SELECT @@COSTCODE = (SELECT COSTCODE FROM COSTMAST C, CATEGORY C2 WHERE C2.CATEGORY = 'BRANCH' AND C.CATCODE = C2.CATCODE AND COSTNAME = @STATUSNAME )          
 IF @BALANCE='NORMAL'            
    IF @SORTBYDATE = 'VDT'            
     BEGIN               
      INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,          
      AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN CAMT ELSE -CAMT END)            
      FROM LEDGER L, LEDGER2 L2 WHERE VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'              
   AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO        
   AND COSTCODE = @@COSTCODE        
      GROUP BY L.CLTCODE            
     END            
    ELSE           
      BEGIN            
       INSERT INTO #TEMPLEDGER            
       SELECT CLTCODE, AMOUNT=SUM(AMOUNT) ,0,0             
       FROM       
        (               
         SELECT L.CLTCODE, AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END),0)          
         FROM LEDGER L, LEDGER2 L2 WHERE EDT LIKE @CURRYRSTDATE + '%' AND VTYP = 18              
      AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO        
         AND COSTCODE = @@COSTCODE        
     GROUP BY L.CLTCODE              
          
         UNION ALL              
          
         SELECT L.CLTCODE, AMOUNT = SUM( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END)           
         FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT < @VDT AND VTYP <> 18              
     AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO        
         AND COSTCODE = @@COSTCODE        
         GROUP BY L.CLTCODE               
          
         UNION ALL              
          
         SELECT L.CLTCODE,AMOUNT = ISNULL(SUM( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE -CAMT END),0)          
         FROM LEDGER L, LEDGER2 L2 WHERE L.VDT >=  @CURRYRSTDATE + ' 00:00:00' AND EDT < @CURRYRSTDATE        
     AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO        
         AND COSTCODE = @@COSTCODE        
         GROUP BY L.CLTCODE               
        ) T              
        GROUP BY CLTCODE               
      END            
   ELSE          
      IF @SORTBYDATE = 'VDT'            
       BEGIN            
        INSERT INTO #TEMPLEDGER            
        SELECT L2.CLTCODE ,    
    
--CHANGE BY SURESH            
        DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END) ELSE 0 END),             
	    CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END),                    
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END)            
        FROM LEDGER L, LEDGER2 L2 WHERE  VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <= @VDT + ' 23:59:59'        
    AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO        
        AND COSTCODE = @@COSTCODE        
        GROUP BY L2.CLTCODE            
       END            
      ELSE            
       BEGIN            
        INSERT INTO #TEMPLEDGER            
        SELECT L2.CLTCODE ,        
--CHANGE BY SURESH        
		DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE    THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END) ELSE 0 END),                      
		CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= @STDATE  THEN ( CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END) ELSE 0 END),             
        OPBAL = SUM(CASE WHEN VDT < @STDATE THEN ( CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE -CAMT END) ELSE 0 END)            
        FROM LEDGER L, LEDGER2 L2 WHERE EDT >= @CURRYRSTDATE + ' 00:00:00' AND EDT <= @VDT + ' 23:59:59'             
        AND L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO        
        AND COSTCODE = @@COSTCODE        
        GROUP BY L2.CLTCODE            
      END             
          
IF  @VIEWOPTION = 'PARTYWISE'             
 BEGIN            
   INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT           
    FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT= 4 AND ( DRTOT <> 0 OR CRTOT <> 0 OR  AMOUNT <> 0)          
 END            
ELSE            
 IF @VIEWOPTION = 'GL'            
  BEGIN            
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT           
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)          
  END            
 ELSE            
  BEGIN            
    INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,30) ACNAME, BRANCHCODE,ACCAT           
     FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)          
  END           
          
IF @VIEWOPTION = 'GL'            
 BEGIN          
   INSERT INTO #TEMPLEDGERFINAL          
   SELECT 'ZZZZZZZZZZ',SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),'CLIENT BALANCES',' ',4  FROM #TEMPLEDGER L, ACMAST A WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4           
 END          
END         
/* ---------------------------- */          
        
        
IF @FLAG = 'CODEWISE'            
 BEGIN          
  SELECT * FROM #TEMPLEDGERFINAL ORDER BY  CLTCODE, ACNAME, BRANCHCODE          
 END          
ELSE          
 BEGIN        
  SELECT * FROM #TEMPLEDGERFINAL  ORDER BY  ACNAME,CLTCODE, BRANCHCODE          
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACC_TRIALBALANCE_ALL
-- --------------------------------------------------





/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACC_TRIALBALANCE_ALL    SCRIPT DATE: 03/28/2005 2:41:12 PM ******/
CREATE  PROCEDURE RPT_ACC_TRIALBALANCE_ALL
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */                
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */                
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */                
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */                
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */                
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */                
@OPENENTRYFLAG INT,                
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */                
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */                
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */                
@SORTBYDATE VARCHAR(3),          /* WHETHER REPORT IS BASED ON VDT OR EDT */                
@SHOWZEROBAL VARCHAR(1),               /* SHOW ZERO BAL   */      
@SHOWMARGIN VARCHAR(1)               /* SHOW MARGIN LEDGER   */      
AS                        
                        
BEGIN                        
                        
CREATE TABLE [DBO].[#TMPTRIALBALANCE] (                          
  [CLTCODE] [VARCHAR] (10) ,              
  [ACNAME] [VARCHAR] (100) NULL ,                         
  [BRANCHCODE] [VARCHAR] (10) NULL,              
  [AMOUNT] [MONEY] NULL ,                          
  [SEGMENT] [VARCHAR] (4) NULL,                    
  [ENTITY] [VARCHAR] (50) NULL                     
 ) ON [PRIMARY]                          
                      
                      
                      
INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)                
EXEC ACCOUNT.DBO.NEWASP_TRIALBALANCE @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE              
            
IF @VIEWOPTION='GL'              
	BEGIN              
		INSERT INTO #TMPTRIALBALANCE(AMOUNT)              
		EXEC ACCOUNT.DBO.NEWASP_TRIALBALANCEPARTYTOTAL @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE              
	END              
                      
UPDATE #TMPTRIALBALANCE SET SEGMENT='1NSE',ENTITY='CAPITAL - NSE' WHERE SEGMENT IS NULL                        
              
INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)                
EXEC ACCOUNTBSE.DBO.NEWASP_TRIALBALANCE @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE              
              
IF @VIEWOPTION='GL'              
	BEGIN              
		INSERT INTO #TMPTRIALBALANCE(AMOUNT)              
		EXEC ACCOUNTBSE.DBO.NEWASP_TRIALBALANCEPARTYTOTAL @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE              
	END              
                      
UPDATE #TMPTRIALBALANCE SET SEGMENT='2BSE',ENTITY='CAPITAL - BSE' WHERE SEGMENT IS NULL                      
/*----------------------------------------------COMMENTED SPECIFICALLY FOR VERSION---------------------------------------
INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)                
EXEC ACCOUNTFO.DBO.NEWASP_TRIALBALANCE @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE              
              
IF @VIEWOPTION='GL'              
	BEGIN              
		INSERT INTO #TMPTRIALBALANCE(AMOUNT)              
		EXEC ACCOUNTFO.DBO.NEWASP_TRIALBALANCEPARTYTOTAL @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE              
	END              
                      
UPDATE #TMPTRIALBALANCE SET SEGMENT='3NFO',ENTITY='DERIVATIVES - NSE' WHERE SEGMENT IS NULL                            
*/          
--MARGIN TRIAL BALANCE          
            
INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)                
EXEC ACCOUNT.DBO.NEWASP_MARGINTRIALBALANCE @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE              
          
IF @VIEWOPTION='GL'              
	BEGIN              
		INSERT INTO #TMPTRIALBALANCE(AMOUNT)             
		EXEC ACCOUNT.DBO.NEWASP_MARGINTRIALBALANCEPARTYTOTAL @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE              
	END             
            
UPDATE #TMPTRIALBALANCE SET SEGMENT='4NSE',ENTITY='MARGIN CAPITAL - NSE' WHERE SEGMENT IS NULL                           
            
INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)            
EXEC ACCOUNTBSE.DBO.NEWASP_MARGINTRIALBALANCE @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE              
            
IF @VIEWOPTION='GL'              
	BEGIN              
		INSERT INTO #TMPTRIALBALANCE(AMOUNT)              
		EXEC ACCOUNTBSE.DBO.NEWASP_MARGINTRIALBALANCEPARTYTOTAL @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE              
	END              
          
UPDATE #TMPTRIALBALANCE SET SEGMENT='5BSE',ENTITY='MARGIN CAPITAL - BSE' WHERE SEGMENT IS NULL                        
            
/*----------------------------------------------COMMENTED SPECIFICALLY FOR VERSION---------------------------------------
INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT)                
EXEC ACCOUNTFO.DBO.NEWASP_MARGINTRIALBALANCE @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE              
          
IF @VIEWOPTION='GL'              
	BEGIN              
		INSERT INTO #TMPTRIALBALANCE(AMOUNT)              
		EXEC ACCOUNTFO.DBO.NEWASP_MARGINTRIALBALANCEPARTYTOTAL @VDT,@FLAG,@VIEWOPTION,@BALANCE,@STDATE,@CURRYRSTDATE,@OPENENTRYFLAG,@OPENINGENTRYDATE,@STATUSID,@STATUSNAME,@SORTBYDATE              
	END              
            
UPDATE #TMPTRIALBALANCE SET SEGMENT='6NFO',ENTITY='MARGIN DERIVATIVES - NSE' WHERE SEGMENT IS NULL                        
*/          
IF @VIEWOPTION='GL'              
	BEGIN              
		UPDATE #TMPTRIALBALANCE SET ACNAME='CLIENT BALANCES',CLTCODE=' ',BRANCHCODE=' ' WHERE CLTCODE IS NULL              
	END              
            
IF @FLAG = 'CODEWISE'        
	BEGIN             
		IF @SHOWZEROBAL='Y'      
			BEGIN      
				SELECT CLTCODE,ACNAME,BRANCHCODE,            
				SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END) AS NETNSECM,              
				SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END) AS NETNSECMML,              
				SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END) AS NETBSECM,              
				SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END) AS NETBSECMML,              
				SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFO,            
				SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFOML            
				FROM #TMPTRIALBALANCE              
				GROUP BY CLTCODE,ACNAME,BRANCHCODE              
				ORDER BY CLTCODE      
			END      
		ELSE      
			BEGIN      
				IF @SHOWMARGIN='Y'        
					BEGIN      
						SELECT CLTCODE,ACNAME,BRANCHCODE,            
							SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END) AS NETNSECM,              
							SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END) AS NETNSECMML,              
							SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END) AS NETBSECM,              
							SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END) AS NETBSECMML,              
							SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFO,            
							SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFOML            
						FROM #TMPTRIALBALANCE              
						GROUP BY CLTCODE,ACNAME,BRANCHCODE              
						HAVING      
							SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END)<>0 OR      
							SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END)<>0 OR      
							SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END)<>0 OR      
							SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END)<>0 OR      
							SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END)<>0 OR      
							SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END)<>0      
						ORDER BY CLTCODE              
					END      
				ELSE      
					BEGIN      
						SELECT CLTCODE,ACNAME,BRANCHCODE,            
						SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END) AS NETNSECM,              
						SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END) AS NETNSECMML,              
						SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END) AS NETBSECM,              
						SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END) AS NETBSECMML,              
						SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFO,            
						SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFOML            
						FROM #TMPTRIALBALANCE
						GROUP BY CLTCODE,ACNAME,BRANCHCODE              
						HAVING      
						SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END)<>0 OR      
						SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END)<>0 OR      
						SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END)<>0 
						ORDER BY CLTCODE              
					END      
			END      
	END        
ELSE        
	BEGIN      
		IF @SHOWZEROBAL='Y'      
			BEGIN      
				SELECT CLTCODE,ACNAME,BRANCHCODE,            
				SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END) AS NETNSECM,              
				SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END) AS NETNSECMML,              
				SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END) AS NETBSECM,              
				SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END) AS NETBSECMML,              
				SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFO,            
				SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFOML            
				FROM #TMPTRIALBALANCE              
				GROUP BY CLTCODE,ACNAME,BRANCHCODE              
				ORDER BY ACNAME            
			END      
		ELSE      
			BEGIN      
				IF @SHOWMARGIN='Y'        
					BEGIN      
						SELECT CLTCODE,ACNAME,BRANCHCODE,            
						SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END) AS NETNSECM,              
						SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END) AS NETNSECMML,              
						SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END) AS NETBSECM,              
						SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END) AS NETBSECMML,              
						SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFO,            
						SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFOML            
						FROM #TMPTRIALBALANCE              
						GROUP BY CLTCODE,ACNAME,BRANCHCODE              
						HAVING      
						SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END)<>0 OR              
						SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END)<>0 OR      
						SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END)<>0 OR      
						SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END)<>0 OR      
						SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END)<>0 OR      
						SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END)<>0      
						ORDER BY ACNAME          
					END      
				ELSE      
					BEGIN     
						SELECT CLTCODE,ACNAME,BRANCHCODE,            
						SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END) AS NETNSECM,              
						SUM(CASE WHEN SEGMENT='4NSE' THEN AMOUNT ELSE 0 END) AS NETNSECMML,              
						SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END) AS NETBSECM,              
						SUM(CASE WHEN SEGMENT='5BSE' THEN AMOUNT ELSE 0 END) AS NETBSECMML,              
						SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFO,            
						SUM(CASE WHEN SEGMENT='6NFO' THEN AMOUNT ELSE 0 END) AS NETNSEFOML            
						FROM #TMPTRIALBALANCE              
						GROUP BY CLTCODE,ACNAME,BRANCHCODE              
						HAVING      
						SUM(CASE WHEN SEGMENT='1NSE' THEN AMOUNT ELSE 0 END)<>0 OR              
						SUM(CASE WHEN SEGMENT='2BSE' THEN AMOUNT ELSE 0 END)<>0 OR      
						SUM(CASE WHEN SEGMENT='3NFO' THEN AMOUNT ELSE 0 END)<>0      
						ORDER BY ACNAME            
					END      
			END      
	END             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCALLPARTYLEDVOUCHERDISP
-- --------------------------------------------------


CREATE PROCEDURE RPT_ACCALLPARTYLEDVOUCHERDISP        
@VTYP SMALLINT ,        
@VNO VARCHAR (12),        
@VDT VARCHAR(12) ,        
@BOOKTYPE VARCHAR(2),        
@BRANCH VARCHAR(10),        
@CLTCODE VARCHAR(10)        
        
AS        
IF @BRANCH = 'FULL' OR @BRANCH = '' OR @BRANCH = '%'        
BEGIN        
 SELECT  VAMT , L.VTYP , L.VNO , L.VDT , L.DRCR , CLTCODE, ACNAME,  L.LNO , DRCRFLAG = (CASE WHEN UPPER(L.DRCR) = 'D' THEN 'DR' ELSE 'CR' END) ,         
 NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,         
 DDDT  =  CONVERT(VARCHAR, DDDT, 103)          
 FROM ACCOUNTMCDXCDS.DBO.LEDGER L LEFT OUTER JOIN ACCOUNTMCDXCDS.DBO.LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO     
--AND L.LNO = L1.LNO        
 WHERE L.VTYP = @VTYP        
 AND L.VNO = @VNO          
 AND L.VDT LIKE  LTRIM(VDT) + '%'        
 AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE        
 ORDER BY L.DRCR DESC , L.LNO         
END        
ELSE        
BEGIN        
 SELECT  VAMT = L2.CAMT , L.VTYP , L2.VNO , VDT , L2.DRCR , L2.CLTCODE, A.ACNAME, L2.LNO ,         
 DRCRFLAG = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN 'DR' ELSE 'CR' END),         
 NAR = NARRATION, BANK = ISNULL(BNKNAME, ''), BRANCH = ISNULL(BRNNAME, '') , ISNULL(DD, '') DD  , ISNULL(DDNO, '') DDNO,         
 DDDT  =  CONVERT(VARCHAR, DDDT, 103)          
 FROM ACCOUNTMCDXCDS.DBO.LEDGER L LEFT OUTER JOIN ACCOUNTMCDXCDS.DBO.LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO,     
--AND L.LNO = L1.LNO,        
 ACCOUNTMCDXCDS.DBO.LEDGER2 L2 LEFT OUTER JOIN ACCOUNTMCDXCDS.DBO.ACMAST A ON L2.CLTCODE = A.CLTCODE        
 WHERE L.VTYP = @VTYP        
 AND L.VNO = @VNO          
 AND L.VDT LIKE  LTRIM(VDT) + '%'        
 AND L.BOOKTYPE = @BOOKTYPE --AND L.CLTCODE = @CLTCODE        
 AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO        
        AND COSTCODE = (SELECT COSTCODE FROM ACCOUNTMCDXCDS.DBO.COSTMAST WHERE COSTNAME = RTRIM(@BRANCH))        
 ORDER BY L2.DRCR DESC , L2.LNO         
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCALLPARTYMARGINLEDVOUCHERDISP
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCALLPARTYMARGINLEDVOUCHERDISP    SCRIPT DATE: 12/27/2005 12:19:25 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCALLPARTYLEDVOUCHERDISP    SCRIPT DATE: 04/15/2004 11:47:30 AM ******/  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCALLPARTYLEDVOUCHERDISP    SCRIPT DATE: 06/11/2004 14:22:56 ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCALLPARTYLEDVOUCHERDISP    SCRIPT DATE: 12/16/2003 12:59:37 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCALLPARTYLEDVOUCHERDISP    SCRIPT DATE: 02/28/2003 2:39:05 PM ******/  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCALLPARTYLEDVOUCHERDISP    SCRIPT DATE: 01/19/2002 12:15:11 ******/  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCALLPARTYLEDVOUCHERDISP    SCRIPT DATE: 01/04/1980 5:06:24 AM ******/  
/* REPORT : ALLPARTYLEDGER   
    FILENAME :  VOUCHERDISP.ASP  
*/  
/* DISPLAYS DETAILS OF A VOUCHER FOR A PARTY FOR A DATE */  
    
CREATE  PROCEDURE RPT_ACCALLPARTYMARGINLEDVOUCHERDISP  
@VTYP SMALLINT ,  
@VNO VARCHAR (12),  
@VDT VARCHAR(12) ,  
@BOOKTYPE VARCHAR(2),  
@BRANCH VARCHAR(10),  
@CLTCODE VARCHAR(10)  
  
AS  
IF @BRANCH = 'FULL' OR @BRANCH= '' OR @BRANCH = '%'  
BEGIN  
	SELECT VAMT=AMOUNT ,L.VTYP , L.VNO , L.VDT , L.DRCR , CLTCODE=PARTY_CODE,A.ACNAME,  L.LNO ,DRCRFLAG = (CASE WHEN UPPER(L.DRCR)='D' THEN 'DR' ELSE 'CR' END) ,   
	NAR=NARRATION, BANK = ISNULL(BNKNAME,''), BRANCH = ISNULL(BRNNAME,'') , ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO,   
	DDDT  =  CONVERT(VARCHAR,DDDT,103)
	FROM MARGINLEDGER M,LEDGER L ,LEDGER1 L1, ACMAST A
	WHERE 
	L1.VTYP = M.VTYP AND L1.BOOKTYPE = M.BOOKTYPE AND L1.VNO = M.VNO AND M.LNO = L1.LNO
	AND L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO AND L.LNO = L1.LNO
	AND M.MCLTCODE=A.CLTCODE 
	AND L.VTYP=@VTYP  
	AND L.VNO= @VNO    
	AND L.VDT LIKE  LTRIM(M.VDT) + '%'  
	AND L.BOOKTYPE = @BOOKTYPE AND M.PARTY_CODE = @CLTCODE  
	ORDER BY L.DRCR DESC , L.LNO 
END  
ELSE  
BEGIN  
/*
 SELECT  VAMT=L2.CAMT ,L.VTYP , L2.VNO , VDT , L2.DRCR , L2.CLTCODE, A.ACNAME, L2.LNO ,   
 DRCRFLAG = (CASE WHEN UPPER(L2.DRCR)='D' THEN 'DR' ELSE 'CR' END),   
 NAR=NARRATION, BANK = ISNULL(BNKNAME,''), BRANCH = ISNULL(BRNNAME,'') , ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO,   
 DDDT  =  CONVERT(VARCHAR,DDDT,103)    
 FROM ACCOUNT.DBO.LEDGER L LEFT OUTER JOIN ACCOUNT.DBO.LEDGER1 L1 ON L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO AND L.LNO = L1.LNO,  
 ACCOUNT.DBO.LEDGER2 L2 LEFT OUTER JOIN ACCOUNT.DBO.ACMAST A ON L2.CLTCODE = A.CLTCODE  
 WHERE L.VTYP=@VTYP  
 AND L.VNO= @VNO    
 AND L.VDT LIKE  LTRIM(VDT) + '%'  
 AND L.BOOKTYPE = @BOOKTYPE AND L.CLTCODE = @CLTCODE  
 AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO  
 AND COSTCODE = (SELECT COSTCODE FROM ACCOUNT.DBO.COSTMAST WHERE COSTNAME = RTRIM(@BRANCH))  
 ORDER BY L2.DRCR DESC , L2.LNO   
*/

SELECT  VAMT=M.AMOUNT ,L.VTYP , L2.VNO , M.VDT , L2.DRCR , CLTCODE=M.PARTY_CODE, A.ACNAME, L2.LNO ,   
DRCRFLAG = (CASE WHEN UPPER(L2.DRCR)='D' THEN 'DR' ELSE 'CR' END),   
NAR=NARRATION, BANK = ISNULL(BNKNAME,''), BRANCH = ISNULL(BRNNAME,'') , ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO,   
DDDT  =  CONVERT(VARCHAR,DDDT,103)    
FROM MARGINLEDGER M,LEDGER L ,LEDGER1 L1,   
LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON L2.CLTCODE = A.CLTCODE  
WHERE M.MCLTCODE=A.CLTCODE
AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND L.LNO = M.LNO
AND L1.VTYP = L.VTYP AND L1.BOOKTYPE = L.BOOKTYPE AND L1.VNO = L.VNO AND L.LNO = L1.LNO
AND L.VNO= @VNO    
AND L.VDT LIKE  LTRIM(M.VDT) + '%'  
AND L.BOOKTYPE = @BOOKTYPE
AND M.PARTY_CODE = @CLTCODE 
AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO  
AND COSTCODE = (SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM(@BRANCH))  
ORDER BY L2.DRCR DESC , L2.LNO   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCCHKPATHSEGBALSIGN
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCCHKPATHSEGBALSIGN    SCRIPT DATE: 05/10/2004 5:11:16 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCCHKPATHSEGBALSIGN    SCRIPT DATE: 01/11/2003 3:46:55 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCCHKPATHSEGBALSIGN    SCRIPT DATE: 01/04/1980 1:40:39 AM ******/  
  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCCHKPATHSEGBALSIGN    SCRIPT DATE: 11/28/2001 12:23:46 PM ******/  
  
CREATE PROCEDURE RPT_ACCCHKPATHSEGBALSIGN  
@SHAREDB VARCHAR(15)  
AS  
SELECT CONPATH ,SEGMENT ,BALSIGN FROM ACCOUNTMCDXCDS.DBO.OWNER   
WHERE SHAREDB = @SHAREDB

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCCOMPANYNAME
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCCOMPANYNAME    SCRIPT DATE: 06/24/2004 8:32:37 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCCOMPANYNAME    SCRIPT DATE: 05/10/2004 5:29:41 PM ******/  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCCOMPANYNAME    SCRIPT DATE: 01/14/2002 20:39:18 ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCCOMPANYNAME    SCRIPT DATE: 01/04/1980 1:40:39 AM ******/  
  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCCOMPANYNAME    SCRIPT DATE: 11/28/2001 12:23:46 PM ******/  
  
CREATE PROC RPT_ACCCOMPANYNAME  
@SHAREDB VARCHAR(15)  
AS  
SELECT COMPANYNAME FROM MULTICOMPANY WHERE SHAREDB = @SHAREDB

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCODELIST
-- --------------------------------------------------





/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCODELIST    SCRIPT DATE: 12/16/2003 12:59:37 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACC_LISTCLIENT    SCRIPT DATE: 04/13/2003 12:09:05 PM ******/
---------------------------------------------------------------------------------------------------------
--		PROC TO LIST CLIENTS ACC TO LOGIN FOR THE DB - ACCOUNT
---------------------------------------------------------------------------------------------------------

CREATE PROCEDURE RPT_ACCODELIST
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@WHATTOLOOKFOR VARCHAR(25),	--	PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
	@WHICHWAY VARCHAR(1),		--	> OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.
	@COMPARETOWHAT VARCHAR(25),	--	PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.
	@ACCAT VARCHAR(3),		--	ACCOUNT CATEGORY
	@LOOKFORNAME VARCHAR(25)	--	PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH
AS

DECLARE
@STRSQL VARCHAR(2500),
@@INACCAT VARCHAR(3)

SELECT @@INACCAT = RTRIM(CONVERT(VARCHAR,CONVERT(INT,@ACCAT)+100,3))

--SET DEFAULT VALUES
SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"
/* SET @BOOKTYPE = @BOOKTYPE + "%" */

--BROKER LOGIN
IF  @STATUSID="BROKER"
BEGIN
	SET @STRSQL = "SELECT "
	SET @STRSQL = @STRSQL + "DISTINCT CLTCODE, ACNAME, BRANCHCODE "
	SET @STRSQL = @STRSQL + "FROM ACMAST "
	SET @STRSQL = @STRSQL + "WHERE "
        IF LEN(RTRIM(@WHATTOLOOKFOR)) <> 0 AND LEN(RTRIM(@LOOKFORNAME)) <> 0 
           BEGIN
	  	SET @STRSQL = @STRSQL + " ( CLTCODE LIKE '" + @WHATTOLOOKFOR + "' AND ACNAME LIKE '" + @LOOKFORNAME + "%') AND (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%' " 
	   END
        ELSE
           IF LEN(RTRIM(@LOOKFORNAME)) <> 0 
               BEGIN
                  SET @STRSQL = @STRSQL + " ( CLTCODE LIKE '" + @WHATTOLOOKFOR + "' OR ACNAME LIKE '" + @LOOKFORNAME + "%') AND (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%' " 
               END
           ELSE
               BEGIN
                  SET @STRSQL = @STRSQL + " ( CLTCODE LIKE '" + @WHATTOLOOKFOR + "' OR ACNAME LIKE '" + @WHATTOLOOKFOR + "') AND (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%' " 
               END
        IF RTRIM(@ACCAT) = '3'
           BEGIN
		SELECT @STRSQL = @STRSQL + " OR ACCAT IN ( '14','18','114','118'))" 
           END
        ELSE
           BEGIN
		SELECT @STRSQL = @STRSQL + " )" 
           END

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS	
	IF @WHICHWAY = ">"
	BEGIN
		SET @STRSQL = @STRSQL + " AND "
		SET @STRSQL = @STRSQL + " CLTCODE >= '" + @COMPARETOWHAT + "' "
	END
	ELSE
	BEGIN
		IF @WHICHWAY = "<"
		BEGIN
			SET @STRSQL = @STRSQL + " AND "
			SET @STRSQL = @STRSQL + " CLTCODE <= '" + @COMPARETOWHAT + "' "
		END
	END

	SET @STRSQL = @STRSQL + "ORDER BY CLTCODE, BRANCHCODE "
END

--BRANCH LOGIN
IF @STATUSID="BRANCH"
BEGIN
	SET @STRSQL = "SELECT "
	SET @STRSQL = @STRSQL + "DISTINCT "
	SET @STRSQL = @STRSQL + "	CLTCODE, "
	SET @STRSQL = @STRSQL + "	ACNAME, "
	SET @STRSQL = @STRSQL + "	BRANCHCODE "
	SET @STRSQL = @STRSQL + "FROM "
	SET @STRSQL = @STRSQL + "	ACMAST "
	SET @STRSQL = @STRSQL + "WHERE "
	SET @STRSQL = @STRSQL + "	CLTCODE LIKE '" + @WHATTOLOOKFOR + "' AND "
	SET @STRSQL = @STRSQL + "	(BRANCHCODE LIKE '" + @STATUSNAME + "' OR BRANCHCODE = 'ALL') AND (ACCAT LIKE '" + @ACCAT  + "%' OR ACCAT LIKE '" + @@INACCAT + "%' " 
        IF RTRIM(@ACCAT) = '3'
           BEGIN
		SELECT @STRSQL = @STRSQL + " OR ACCAT IN ( '14','18','114','118'))" 
           END
        ELSE
           BEGIN
		SELECT @STRSQL = @STRSQL + " )" 
           END

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	IF @WHICHWAY = ">"
	BEGIN
		SET @STRSQL = @STRSQL + "	AND "
		SET @STRSQL = @STRSQL + "	CLTCODE >= '" + @COMPARETOWHAT + "' "
	END
	ELSE
	BEGIN
		IF @WHICHWAY = "<"
		BEGIN
			SET @STRSQL = @STRSQL + "	AND "
			SET @STRSQL = @STRSQL + "	CLTCODE <= '" + @COMPARETOWHAT + "' "
		END
	END
	SET @STRSQL = @STRSQL + "ORDER BY "
	SET @STRSQL = @STRSQL + "	CLTCODE, "
	SET @STRSQL = @STRSQL + "	BRANCHCODE "
END

--SUB-BROKER LOGIN
IF @STATUSID="SUBBROKER"
BEGIN
	SET @STRSQL = "SELECT "
	SET @STRSQL = @STRSQL + "DISTINCT "
	SET @STRSQL = @STRSQL + "	A.CLTCODE, "
	SET @STRSQL = @STRSQL + "	A.ACNAME, "
	SET @STRSQL = @STRSQL + "	C1.SUB_BROKER "
	SET @STRSQL = @STRSQL + "FROM "
	SET @STRSQL = @STRSQL + "	ACMAST A, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT1 C1, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT2 C2, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.SUBBROKERS S "
	SET @STRSQL = @STRSQL + "WHERE "
	SET @STRSQL = @STRSQL + "	C1.CL_CODE = C2.CL_CODE AND "
	SET @STRSQL = @STRSQL + "	A.CLTCODE = C2.PARTY_CODE AND "
	SET @STRSQL = @STRSQL + "	C1.SUB_BROKER = S.SUB_BROKER AND "
	SET @STRSQL = @STRSQL + "	C1.SUB_BROKER LIKE '" + @STATUSNAME + "' AND "
	SET @STRSQL = @STRSQL + "	CLTCODE LIKE '" + @WHATTOLOOKFOR + "' "

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	IF @WHICHWAY = ">"
	BEGIN
		SET @STRSQL = @STRSQL + "	AND "
		SET @STRSQL = @STRSQL + "	CLTCODE >= '" + @COMPARETOWHAT + "' "
	END
	ELSE
	BEGIN
		IF @WHICHWAY = "<"
		BEGIN
			SET @STRSQL = @STRSQL + "	AND "
			SET @STRSQL = @STRSQL + "	CLTCODE <= '" + @COMPARETOWHAT + "' "
		END
	END
	SET @STRSQL = @STRSQL + "ORDER BY "
	SET @STRSQL = @STRSQL + "	A.CLTCODE, "
	SET @STRSQL = @STRSQL + "	C1.SUB_BROKER "
END

--TRADER LOGIN
IF @STATUSID="TRADER"
BEGIN
	SET @STRSQL = "SELECT "
	SET @STRSQL = @STRSQL + "DISTINCT "
	SET @STRSQL = @STRSQL + "	A.CLTCODE, "
	SET @STRSQL = @STRSQL + "	A.ACNAME, "
	SET @STRSQL = @STRSQL + "	C1.TRADER "
	SET @STRSQL = @STRSQL + "FROM "
	SET @STRSQL = @STRSQL + "	ACMAST A, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT1 C1, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT2 C2, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.BRANCHES S "
	SET @STRSQL = @STRSQL + "WHERE "
	SET @STRSQL = @STRSQL + "	C1.CL_CODE = C2.CL_CODE AND "
	SET @STRSQL = @STRSQL + "	A.CLTCODE = C2.PARTY_CODE AND "
	/*SET @STRSQL = @STRSQL + "	C1.TRADER = S.BRANCH_CD AND "*/
             SET @STRSQL = @STRSQL + "	C1.BRANCH_CD = S.BRANCH_CD AND "
	SET @STRSQL = @STRSQL + "	C1.TRADER LIKE '" + @STATUSNAME + "' AND "
	SET @STRSQL = @STRSQL + "	CLTCODE LIKE '" + @WHATTOLOOKFOR + "' "

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	IF @WHICHWAY = ">"
	BEGIN
		SET @STRSQL = @STRSQL + "	AND "
		SET @STRSQL = @STRSQL + "	CLTCODE >= '" + @COMPARETOWHAT + "' "
	END
	ELSE
	BEGIN
		IF @WHICHWAY = "<"
		BEGIN
			SET @STRSQL = @STRSQL + "	AND "
			SET @STRSQL = @STRSQL + "	CLTCODE <= '" + @COMPARETOWHAT + "' "
		END
	END
	SET @STRSQL = @STRSQL + "ORDER BY "
	SET @STRSQL = @STRSQL + "	A.CLTCODE, "
	SET @STRSQL = @STRSQL + "	C1.TRADER "
END

--FAMILY LOGIN
IF @STATUSID="FAMILY"
BEGIN
	SET @STRSQL = "SELECT "
	SET @STRSQL = @STRSQL + "DISTINCT "
	SET @STRSQL = @STRSQL + "	A.CLTCODE, "
	SET @STRSQL = @STRSQL + "	A.ACNAME, "
	SET @STRSQL = @STRSQL + "	C1.FAMILY "
	SET @STRSQL = @STRSQL + "FROM "
	SET @STRSQL = @STRSQL + "	ACMAST A, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT1 C1, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT2 C2 "
	SET @STRSQL = @STRSQL + "WHERE "
	SET @STRSQL = @STRSQL + "	C1.CL_CODE = C2.CL_CODE AND "
	SET @STRSQL = @STRSQL + "	A.CLTCODE = C2.PARTY_CODE AND "
	SET @STRSQL = @STRSQL + "	C1.FAMILY LIKE '" + @STATUSNAME + "' AND "
	SET @STRSQL = @STRSQL + "	CLTCODE LIKE '" + @WHATTOLOOKFOR + "' "

--	TO GET A VALUE GREATER/LESSER THAN ANOTHER.
--	USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS
	IF @WHICHWAY = ">"
	BEGIN
		SET @STRSQL = @STRSQL + "	AND "
		SET @STRSQL = @STRSQL + "	CLTCODE >= '" + @COMPARETOWHAT + "' "
	END
	ELSE
	BEGIN
		IF @WHICHWAY = "<"
		BEGIN
			SET @STRSQL = @STRSQL + "	AND "
			SET @STRSQL = @STRSQL + "	CLTCODE <= '" + @COMPARETOWHAT + "' "
		END
	END
	SET @STRSQL = @STRSQL + "ORDER BY "
	SET @STRSQL = @STRSQL + "	A.CLTCODE, "
	SET @STRSQL = @STRSQL + "	C1.FAMILY "
END

IF @STATUSID="CLIENT"
BEGIN
	SET @STRSQL = "SELECT "
	SET @STRSQL = @STRSQL + "DISTINCT "
	SET @STRSQL = @STRSQL + "	A.CLTCODE, "
	SET @STRSQL = @STRSQL + "	A.ACNAME "
	SET @STRSQL = @STRSQL + "FROM "
	SET @STRSQL = @STRSQL + "	ACMAST A, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT1 C1, "
	SET @STRSQL = @STRSQL + "	MCDXCDS.DBO.CLIENT2 C2 "
	SET @STRSQL = @STRSQL + "WHERE "
	SET @STRSQL = @STRSQL + "	C1.CL_CODE = C2.CL_CODE AND "
	SET @STRSQL = @STRSQL + "	A.CLTCODE = C2.PARTY_CODE AND "
	SET @STRSQL = @STRSQL + "	CLTCODE LIKE '" + @STATUSNAME + "' "
	SET @STRSQL = @STRSQL + "ORDER BY "
	SET @STRSQL = @STRSQL + "	A.CLTCODE "
END

SET @STRSQL = @STRSQL + "	OPTION  (FAST 10)"

PRINT @STRSQL
EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCOWNERCOMPANYNAME
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCOWNERCOMPANYNAME    SCRIPT DATE: 06/24/2004 8:32:37 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCOWNERCOMPANYNAME    SCRIPT DATE: 05/10/2004 5:29:41 PM ******/  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCOWNERCOMPANYNAME    SCRIPT DATE: 01/14/2002 20:39:18 ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCOWNERCOMPANYNAME    SCRIPT DATE: 01/04/1980 1:40:39 AM ******/  
  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_ACCOWNERCOMPANYNAME    SCRIPT DATE: 11/28/2001 12:23:46 PM ******/  
  
CREATE PROC RPT_ACCOWNERCOMPANYNAME  
@SHAREDB VARCHAR(15)  
AS  
SELECT COMPANYNAME FROM ACCOUNTBSE.DBO.OWNER WHERE SHAREDB = @SHAREDB

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ACCVDESC
-- --------------------------------------------------
  /*THIS PROCEDURE GIVES US THE DISCRIPTION FOR SUPPLIED VTYPE*/  
CREATE PROCEDURE   
RPT_ACCVDESC   
@VTYPE SMALLINT  
AS  
SELECT VDESC    FROM ACCOUNTMCDXCDS.DBO.VMAST WHERE   
VTYPE = @VTYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CONPATH
-- --------------------------------------------------

/****** OBJECT:  STORED PROCEDURE DBO.RPT_CONPATH    SCRIPT DATE: 01/15/2005 1:33:40 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_CONPATH    SCRIPT DATE: 12/16/2003 2:31:48 PM ******/  
  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_CONPATH    SCRIPT DATE: 05/08/2002 12:35:11 PM ******/  
  
  
  
  
/*REPORT :  ALLPARTY LEDGER   
    FILE : ALLPARTY.ASP  
    FILE : LEDGERVIEW.ASP  
*/  
  
/* SELECTS CONPATH FROM OWNER FOR A EXCHANGE AND SEGMENT */  
  
CREATE PROCEDURE RPT_CONPATH  
  
@EXCH VARCHAR(3),  
@SEGMENT VARCHAR(20)  
  
AS  
  
SELECT CONPATH FROM OWNER WHERE EXCHANGE=@EXCH AND SEGMENT LIKE LTRIM(@SEGMENT)+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CURRENTOPENTRY
-- --------------------------------------------------


/*
THIS GIVES US THE OPEN ENTRY DATE FOR SUPPLIED YR
*/
CREATE PROCEDURE RPT_CURRENTOPENTRY
@SDTCUR DATETIME , 
@LDTCUR DATETIME
AS
/*
SELECT DISTINCT ISNULL(CONVERT(VARCHAR, VDT, 109), '')  FROM ACCOUNT.DBO.LEDGER WHERE VTYP = '18' AND
VDT > = LTRIM(@SDTCUR) AND VDT < = LTRIM(@LDTCUR) + ' 23:59:59'  
*/
SELECT DISTINCT ISNULL(LEFT(CONVERT(VARCHAR, VDT, 109), 11), '')  FROM LEDGER WHERE VTYP = '18' AND
VDT > = @SDTCUR AND VDT < = @LDTCUR  + ' 23:59:59'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FAMILY
-- --------------------------------------------------



/* FAMILYWISE LEDGER */
/* FINDS FAMILIES FROM CLIENT1 */
CREATE PROCEDURE RPT_FAMILY
@STATUSID VARCHAR(15), 
@STATUSNAME  VARCHAR(25)
AS
IF @STATUSID = 'BROKER'
BEGIN
 SELECT DISTINCT FAMILY FROM CLIENT1
 ORDER BY FAMILY
END
IF @STATUSID = 'FAMILY'
BEGIN
 SELECT DISTINCT FAMILY FROM CLIENT1
 WHERE FAMILY = @STATUSNAME
 ORDER BY FAMILY
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FINYEARLIST
-- --------------------------------------------------

CREATE PROCEDURE  RPT_FINYEARLIST  
AS  
SELECT DISTINCT  SMONTH = DATENAME(MONTH, SDTCUR), SYEAR = DATENAME(YEAR, SDTCUR), EMONTH = DATENAME(MONTH, LDTCUR),   
 LYEAR = DATENAME(YEAR, LDTCUR) , SDT = CONVERT(VARCHAR, SDTCUR, 103),   
LDT = CONVERT(VARCHAR, LDTCUR, 103), CURYEAR FROM ACCOUNTMCDXCDS.DBO.PARAMETER  
ORDER BY CURYEAR DESC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_GRPCOMBINETRIALBALANCE
-- --------------------------------------------------




--EXEC RPT_GRPCOMBINETRIALBALANCE 'APR  1 2005', 'DEC 31 2005', 'NSEFO', ''
CREATE  PROC RPT_GRPCOMBINETRIALBALANCE    
(    
@FROMDATE VARCHAR(11),    
@TODATE VARCHAR(11),    
@SEGMENT VARCHAR(5)='ALL',    
@BRANCHCD VARCHAR(10)=''    
)    
    
AS     
    
    
DECLARE @CODESTRIP VARCHAR(11)    
DECLARE @GRPNAME VARCHAR(100)    
DECLARE @GRPCODE VARCHAR(15)    
DECLARE @TBCUR CURSOR      
    
    
 
CREATE 
    TABLE #TRIALBALANCE 
	( 
		SEGMENT VARCHAR(5), 
		CLTCODE VARCHAR(10), 
		ACNAME VARCHAR(100), 
		GRPCODE VARCHAR(20), 
		GRPNAME VARCHAR(100), 
		AMOUNT MONEY, 
		DRAMOUNT MONEY, 
		CRAMOUNT MONEY, 
		BRANCHCODE VARCHAR(20) 
	)     
	IF @SEGMENT = '' BEGIN 
		SET @SEGMENT = 'ALL' 
	END                             
	IF @SEGMENT = 'ALL' OR @SEGMENT = 'NSECM'    
		BEGIN    
 
			SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
			INSERT 
			INTO #TRIALBALANCE 
			SELECT 
				SEGMENT, 
				CLTCODE, 
				ACNAME, 
				A.GRPCODE, 
				B.GRPNAME, 
				AMOUNT = VAMT, 
				DRAMOUNT = (
				CASE 
					WHEN VAMT >= 0 
					THEN ABS(VAMT) 
					ELSE 0 
				END
				), 
				CRAMOUNT = (
				CASE 
					WHEN VAMT < 0 
					THEN ABS(VAMT) 
					ELSE 0 
				END
				), 
				'' 
			FROM 
				( 
				SELECT 
					SEGMENT = 'NSECM', 
					GRPCODE = A.GRPCODE, 
					CLTCODE = A.CLTCODE, 
					ACNAME = A.ACNAME, 
					VAMT = SUM(
					CASE 
						WHEN DRCR = 'D' 
						THEN VAMT 
						ELSE -VAMT 
					END
					) 
				FROM ACCOUNT.DBO.LEDGER L, --WITH(INDEX(LEDIND),NOLOCK),     
					ACCOUNT.DBO.ACMAST A --WITH(INDEX(ACCAT),NOLOCK)                 
				WHERE L.CLTCODE = A.CLTCODE 
					AND VDT >= @FROMDATE + ' 00:00:00' 
					AND VDT <= @TODATE + ' 23:59:59' 
					AND ACCAT NOT IN (4,104,204) 
				GROUP BY A.GRPCODE,
					A.CLTCODE, 
					A.ACNAME 
				) 
				A, 
				ACCOUNT.DBO.GRPMAST B (NOLOCK) 
			WHERE A.GRPCODE = B.GRPCODE                                               
	            
	
				SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
			INSERT 
			INTO #TRIALBALANCE 
			SELECT 
				SEGMENT, 
				CLTCODE, 
				ACNAME, 
				A.GRPCODE, 
				B.GRPNAME, 
				AMOUNT = VAMT, 
				DRAMOUNT = (
				CASE 
					WHEN VAMT >= 0 
					THEN ABS(VAMT) 
					ELSE 0 
				END
				), 
				CRAMOUNT = (
				CASE 
					WHEN VAMT < 0 
					THEN ABS(VAMT) 
					ELSE 0 
				END
				), 
				'' 
			FROM 
				( 
				SELECT 
					SEGMENT = 'NSECM', 
					GRPCODE = A.GRPCODE, 
					CLTCODE = 'CLIENT A/C', 
					ACNAME = 'CLIENT A/C - SUNDRY DEBTORS', 
					VAMT = SUM(
					CASE 
						WHEN DRCR = 'D' 
						THEN VAMT 
						ELSE -VAMT 
					END
					) 
				FROM ACCOUNT.DBO.LEDGER L, --WITH(INDEX(LEDIND),NOLOCK),     
					ACCOUNT.DBO.ACMAST A --WITH(INDEX(ACCAT),NOLOCK)                 
				WHERE L.CLTCODE = A.CLTCODE 
					AND VDT >= @FROMDATE + ' 00:00:00' 
					AND VDT <= @TODATE + ' 23:59:59' 
					AND ACCAT IN (4,104,204) 
				GROUP BY A.GRPCODE 
				) 
				A, 
				ACCOUNT.DBO.GRPMAST B (NOLOCK) 
			WHERE A.GRPCODE = B.GRPCODE 
		END
                            
                        --- NOW DOING BSE    
		IF @SEGMENT = 'ALL' OR @SEGMENT = 'BSECM'    
			BEGIN    
				INSERT 
				INTO #TRIALBALANCE 
				SELECT 
					SEGMENT, 
					CLTCODE, 
					ACNAME, 
					A.GRPCODE, 
					B.GRPNAME, 
					AMOUNT = VAMT, 
					DRAMOUNT = (
					CASE 
						WHEN VAMT >= 0 
						THEN ABS(VAMT) 
						ELSE 0 
					END
					), 
					CRAMOUNT = (
					CASE 
						WHEN VAMT < 0 
						THEN ABS(VAMT) 
						ELSE 0 
					END
					), 
					'' 
				FROM 
					( 
					SELECT 
						SEGMENT = 'BSECM', 
						GRPCODE = A.GRPCODE, 
						CLTCODE = A.CLTCODE, 
						ACNAME = A.ACNAME, 
						VAMT = SUM(
						CASE 
							WHEN DRCR = 'D' 
							THEN VAMT 
							ELSE -VAMT 
						END
						) 
					FROM ACCOUNTBSE.DBO.LEDGER L, --WITH(INDEX(LEDIND),NOLOCK),     
						ACCOUNTBSE.DBO.ACMAST A --WITH(INDEX(ACCAT),NOLOCK)                 
					WHERE L.CLTCODE = A.CLTCODE 
						AND VDT >= @FROMDATE + ' 00:00:00' 
						AND VDT <= @TODATE + ' 23:59:59' 
						AND ACCAT NOT IN (4,104,204) 
					GROUP BY A.GRPCODE,
						A.CLTCODE, 
						A.ACNAME 
					) 
					A, 
					ACCOUNTBSE.DBO.GRPMAST B (NOLOCK) 
				WHERE A.GRPCODE = B.GRPCODE 
				SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
				INSERT 
				INTO #TRIALBALANCE 
				SELECT 
					SEGMENT, 
					CLTCODE, 
					ACNAME, 
					A.GRPCODE, 
					B.GRPNAME, 
					AMOUNT = VAMT, 
					DRAMOUNT = (
					CASE 
						WHEN VAMT >= 0 
						THEN ABS(VAMT) 
						ELSE 0 
					END
					), 
					CRAMOUNT = (
					CASE 
						WHEN VAMT < 0 
						THEN ABS(VAMT) 
						ELSE 0 
					END
					), 
					'' 
				FROM 
					( 
					SELECT 
						SEGMENT = 'BSECM', 
						GRPCODE = A.GRPCODE, 
						CLTCODE = 'CLIENT A/C', 
						ACNAME = 'CLIENT A/C - SUNDRY DEBTORS', 
						VAMT = SUM(
						CASE 
							WHEN DRCR = 'D' 
							THEN VAMT 
							ELSE -VAMT 
						END
						) 
					FROM ACCOUNTBSE.DBO.LEDGER L, --WITH(INDEX(LEDIND),NOLOCK),     
						ACCOUNTBSE.DBO.ACMAST A --WITH(INDEX(ACCAT),NOLOCK)                 
					WHERE L.CLTCODE = A.CLTCODE 
						AND VDT >= @FROMDATE + ' 00:00:00' 
						AND VDT <= @TODATE + ' 23:59:59' 
						AND ACCAT IN (4,104,204) 
					GROUP BY A.GRPCODE 
					) 
					A, 
					ACCOUNTBSE.DBO.GRPMAST B (NOLOCK) 
				WHERE A.GRPCODE = B.GRPCODE
                            
                                    END    
                        --- NOW DOING FO    
/*-----------------------------COMMENTED SPECIFICALLY FOR VERSION------------------------
		IF @SEGMENT = 'ALL' OR @SEGMENT = 'NSEFO'    
			BEGIN    
					SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
				INSERT 
				INTO #TRIALBALANCE 
				SELECT 
					SEGMENT, 
					CLTCODE, 
					ACNAME, 
					A.GRPCODE, 
					B.GRPNAME, 
					AMOUNT = VAMT, 
					DRAMOUNT = (
					CASE 
						WHEN VAMT >= 0 
						THEN ABS(VAMT) 
						ELSE 0 
					END
					), 
					CRAMOUNT = (
					CASE 
						WHEN VAMT < 0 
						THEN ABS(VAMT) 
						ELSE 0 
					END
					), 
					'' 
				FROM 
					( 
					SELECT 
						SEGMENT = 'NSEFO', 
						GRPCODE = A.GRPCODE, 
						CLTCODE = A.CLTCODE, 
						ACNAME = A.ACNAME, 
						VAMT = SUM(
						CASE 
							WHEN DRCR = 'D' 
							THEN VAMT 
							ELSE -VAMT 
						END
						) 
					FROM ACCOUNTFO.DBO.LEDGER L, --WITH(INDEX(LEDIND),NOLOCK),     
						ACCOUNTFO.DBO.ACMAST A --WITH(INDEX(ACCAT),NOLOCK)                 
					WHERE L.CLTCODE = A.CLTCODE 
						AND VDT >= @FROMDATE + ' 00:00:00' 
						AND VDT <= @TODATE + ' 23:59:59' 
						AND ACCAT NOT IN (4,104,204) 
					GROUP BY A.GRPCODE,
						A.CLTCODE, 
						A.ACNAME 
					) 
					A, 
					ACCOUNTFO.DBO.GRPMAST B (NOLOCK) 
				WHERE A.GRPCODE = B.GRPCODE 

					SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
				INSERT 
				INTO #TRIALBALANCE 
				SELECT 
					SEGMENT, 
					CLTCODE, 
					ACNAME, 
					A.GRPCODE, 
					B.GRPNAME, 
					AMOUNT = VAMT, 
					DRAMOUNT = (
					CASE 
						WHEN VAMT >= 0 
						THEN ABS(VAMT) 
						ELSE 0 
					END
					), 
					CRAMOUNT = (
					CASE 
						WHEN VAMT < 0 
						THEN ABS(VAMT) 
						ELSE 0 
					END
					), 
					'' 
				FROM 
					( 
					SELECT 
						SEGMENT = 'NSEFO', 
						GRPCODE = A.GRPCODE, 
						CLTCODE = 'CLIENT A/C', 
						ACNAME = 'CLIENT A/C - SUNDRY DEBTORS', 
						VAMT = SUM(
						CASE 
							WHEN DRCR = 'D' 
							THEN VAMT 
							ELSE -VAMT 
						END
						) 
					FROM ACCOUNTFO.DBO.LEDGER L, --WITH(INDEX(LEDIND),NOLOCK),     
						ACCOUNTFO.DBO.ACMAST A --WITH(INDEX(ACCAT),NOLOCK)                 
					WHERE L.CLTCODE = A.CLTCODE 
						AND VDT >= @FROMDATE + ' 00:00:00' 
						AND VDT <= @TODATE + ' 23:59:59' 
						AND ACCAT IN (4,104,204) 
					GROUP BY A.GRPCODE 
					) 
					A, 
					ACCOUNTFO.DBO.GRPMAST B (NOLOCK) 
				WHERE A.GRPCODE = B.GRPCODE
			END    
*/
-- NOW GETTING FORMATTED VALUES          
	CREATE 
		TABLE #TBOUTPUT 
		( 
			SNO BIGINT IDENTITY(1,1), 
			SEGMENT VARCHAR(5), 
			LEVELCODE VARCHAR(15), 
			CLTCODE VARCHAR(20), 
			ACNAME VARCHAR(100), 
			AMOUNT MONEY, 
			DRAMOUNT MONEY, 
			CRAMOUNT MONEY 
		)
    
	SET @TBCUR = CURSOR FOR 
	SELECT 
		GRPCODE, 
		GRPNAME, 
		CODESTRIP 
	FROM 
		( 
		SELECT 
			GRPCODE, 
			GRPNAME, 
			CODESTRIP = REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(GRPCODE,'0000000000',''),'000000000',''),'00000000',''),'0000000',''),'000000',''),'00000',''),'0000',''),'000',''),'00','') 
		FROM ACCOUNT.DBO.GRPMAST 
		UNION 
		SELECT 
			GRPCODE, 
			GRPNAME, 
			CODESTRIP = REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(GRPCODE,'0000000000',''),'000000000',''),'00000000',''),'0000000',''),'000000',''),'00000',''),'0000',''),'000',''),'00','') 
		FROM ACCOUNTBSE.DBO.GRPMAST 
/*		UNION 
		SELECT 
			GRPCODE, 
			GRPNAME, 
			CODESTRIP = REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(GRPCODE,'0000000000',''),'000000000',''),'00000000',''),'0000000',''),'000000',''),'00000',''),'0000',''),'000',''),'00','') 
		FROM ACCOUNTFO.DBO.GRPMAST */
		) 
		A 
	ORDER BY GRPCODE 
	OPEN @TBCUR FETCH NEXT 
	FROM @TBCUR 
	INTO @GRPCODE, @GRPNAME, @CODESTRIP
	WHILE @@FETCH_STATUS = 0
		BEGIN 
			INSERT 
			INTO #TBOUTPUT 
			SELECT 
				'', 
				@CODESTRIP, 
				CLTCODE, 
				ACNAME = LEFT(ACNAME,90)+'~'+SEGMENT, 
				SUM(AMOUNT), 
				SUM(DRAMOUNT), 
				SUM(CRAMOUNT) 
			FROM #TRIALBALANCE 
			WHERE GRPCODE = @GRPCODE 
			GROUP BY CLTCODE, 
				LEFT(ACNAME,90)+'~'+SEGMENT FETCH NEXT 
			FROM @TBCUR 
			INTO @GRPCODE, 
				@GRPNAME, 
				@CODESTRIP 
		END 
		SELECT * FROM #TBOUTPUT
		RETURN    
		CLOSE @TBCUR      
		DEALLOCATE @TBCUR      
	DROP TABLE #TRIALBALANCE    
	SELECT 
		SNO, 
		LEVELCODE, 
		CLTCODE, 
		ACNAME, 
		AMOUNT, 
		DRAMOUNT, 
		CRAMOUNT 
	FROM #TBOUTPUT 
	WHERE ISNULL(AMOUNT,0) <> 0 
		OR ISNULL(DRAMOUNT,0) <> 0 
		OR ISNULL(CRAMOUNT,0) <> 0 
	ORDER BY SNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LASTOPENTRY
-- --------------------------------------------------


/*
THIS QUERY IS USED IF OPENING ENTRY FOR CURRENT YR IS NOT FOUND
THIS QUERY GIVES US THE LATEST OPEING ENTRY DATE
*/
CREATE PROCEDURE RPT_LASTOPENTRY
@SDTCUR DATETIME
AS
SELECT   ISNULL(LEFT((CONVERT(VARCHAR, MAX(VDT), 109)), 11), '') FROM LEDGER WHERE VTYP = '18' AND
VDT < @SDTCUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MASTER_PARTYLEDGER
-- --------------------------------------------------
   --Exec RPT_MASTER_PARTYLEDGER 'Dec  1 2005','Dec 14 2005','Apr  1 2005','Apr  1 2005','broker','broker','Edt','c','b','BRANCH','S'      
/*         
THIS PROCEDURE IS A MASTER PROCEDURE WHICH INTERNALLY CALL THE DIFFERENT PROCEDURES ON BASIS OF FOLLOWING PARAMETERS        
@STATUSID         
@REPORTNAME        
@SUMMARYOPT         
IT TAKES A PROCEDURE NAME FROM TBL_MASTER_PARTYLEDGER TABLE AND EXECUTE WITH THE PARAMETERS PASSED IN MASTER PROCEDURE.        
CREATED BY := NIKHIL NAVARE        
CREATED DATE := DECEMBER 12 2005        
DATABASE  := ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX        
SYNTAX AS FOLLOWS -----        
EXEC RPT_MASTER_PARTYLEDGER 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'ABC', 'ZZZ', 'BRANCH', 'S'        
*/        
        
CREATE   PROC RPT_MASTER_PARTYLEDGER        
 @FDATE VARCHAR(11),        
 @TDATE VARCHAR(11),        
 @STDDATE VARCHAR(11),        
 @LSTDATE VARCHAR(11),        
 @STATUSID VARCHAR(20),        
 @STATUSNAME VARCHAR(20),        
 @DISPLAYRPT VARCHAR(3),        
 @FPARTY VARCHAR(10),        
 @TPARTY VARCHAR(10),        
 @REPORTNAME varchar(15),        
 @SUMMARYOPT CHAR(1),  
 @SHOWZERO VARCHAR(1) = 'N'  
        
AS        
        
DECLARE        
@@CALLINGSP VARCHAR(100),        
@@SELECTQUERY VARCHAR(1000)        
        
        
 SELECT         
  @@CALLINGSP = CALLINGSP         
 FROM         
  TBL_MASTER_PARTYLEDGER        
 WHERE        
  REPORTNAME = @REPORTNAME        
  AND STATUSID = @STATUSID        
  AND SUMMARYOPT = @SUMMARYOPT        
      
        
SET @@SELECTQUERY = @@CALLINGSP + ' ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' +  @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY  + ''',''' + @REPORTNAME + ''''   
 
      
  
EXEC (@@SELECTQUERY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MASTER_PARTYLEDGER_13012011
-- --------------------------------------------------
  --EXEC RPT_MASTER_PARTYLEDGER 'DEC  1 2005','DEC 14 2005','APR  1 2005','APR  1 2005','BROKER','BROKER','EDT','C','B','BRANCH','S'    
/*       
THIS PROCEDURE IS A MASTER PROCEDURE WHICH INTERNALLY CALL THE DIFFERENT PROCEDURES ON BASIS OF FOLLOWING PARAMETERS      
@STATUSID       
@REPORTNAME      
@SUMMARYOPT       
IT TAKES A PROCEDURE NAME FROM TBL_MASTER_PARTYLEDGER TABLE AND EXECUTE WITH THE PARAMETERS PASSED IN MASTER PROCEDURE.      
CREATED BY := NIKHIL NAVARE      
CREATED DATE := DECEMBER 12 2005      
DATABASE  := ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX      
SYNTAX AS FOLLOWS -----      
EXEC RPT_MASTER_PARTYLEDGER 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'ABC', 'ZZZ', 'BRANCH', 'S'      
*/      
      
CREATE PROC RPT_MASTER_PARTYLEDGER_13012011      
 @FDATE VARCHAR(11),      
 @TDATE VARCHAR(11),      
 @STDDATE VARCHAR(11),      
 @LSTDATE VARCHAR(11),      
 @STATUSID VARCHAR(20),      
 @STATUSNAME VARCHAR(20),      
 @DISPLAYRPT VARCHAR(3),      
 @FPARTY VARCHAR(10),      
 @TPARTY VARCHAR(10),      
 @REPORTNAME VARCHAR(15),      
 @SUMMARYOPT CHAR(1)      
      
AS      
      
DECLARE      
@@CALLINGSP VARCHAR(100),      
@@SELECTQUERY VARCHAR(1000)      
      
      
 SELECT       
  @@CALLINGSP = CALLINGSP       
 FROM       
  TBL_MASTER_PARTYLEDGER      
 WHERE      
  REPORTNAME = @REPORTNAME      
  AND STATUSID = @STATUSID      
  AND SUMMARYOPT = @SUMMARYOPT      
    
      
SET @@SELECTQUERY = @@CALLINGSP + ' ''' + @FDATE + ''',''' + @TDATE + ''',''' + @STDDATE + ''',''' + @LSTDATE + ''',''' +  @STATUSID + ''',''' + @STATUSNAME + ''',''' + @DISPLAYRPT + ''',''' + @FPARTY + ''',''' + @TPARTY  + ''',''' + @REPORTNAME + ''''  
    
    
EXEC (@@SELECTQUERY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MULTIBANKID
-- --------------------------------------------------


CREATE PROC RPT_MULTIBANKID
(
	@PARTYFROM VARCHAR(20),  
	@PARTYTO VARCHAR(20),  
	@SORTBY VARCHAR(20)  
) 
AS  
IF @PARTYTO ='' BEGIN SET @PARTYTO ='ZZZZZZZ' END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
        
SELECT   
	STRORDER = CASE 
		WHEN @SORTBY= 1 THEN CLTCODE 
		WHEN @SORTBY= 2 THEN CHEQUENAME 
		WHEN @SORTBY= 3 THEN BANK_NAME 
		WHEN @SORTBY= 4 THEN BRANCH_NAME 
		END,

 	CLTCODE,
	CHEQUENAME,
	BANK_NAME,
	BRANCH_NAME,
	ACCTYPE,
	ACCNO,
	DEFAULTBANK = CASE WHEN DEFAULTBANK=1 THEN 'YES' ELSE '' END
FROM   
 	MULTIBANKID (NOLOCK) ,MSAJAG..POBANK P (NOLOCK)
WHERE   
	MULTIBANKID.BANKID=P.BANKID 
	AND CLTCODE BETWEEN @PARTYFROM AND @PARTYTO

ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NETTBALLS
-- --------------------------------------------------


CREATE PROC RPT_NETTBALLS          
@FROMDT VARCHAR(11),          
@TODT VARCHAR(11),          
@STATUSID VARCHAR(15),          
@STATUSNAME VARCHAR(25),  
@LEVEL SMALLINT,  
@MAINGRP VARCHAR(25)          
          
AS          
IF @LEVEL = 1          
 IF @MAINGRP<>''      
     BEGIN      
 SELECT CLTCODE, ACNAME, SUM(AMOUNT) AMOUNT, SUM(DRAMOUNT) DRAMOUNT, SUM(CRAMOUNT) CRAMOUNT  
 FROM (  
 SELECT CLTCODE=SUBSTRING(A.GRPCODE,1,1) , ACNAME=GRPNAME, AMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0),    
 DRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),0),    
 CRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),0)          
 FROM LEDGER L, ACMAST A, GRPMAST G          
 WHERE L.CLTCODE = A.CLTCODE AND SUBSTRING(A.GRPCODE,1,1) IN (@MAINGRP)      
 AND VDT >= @FROMDT + ' 00:00:00' AND VDT <= @TODT + ' 23:59:59'          
 AND G.GRPCODE = SUBSTRING(A.GRPCODE,1,1)+ '0000000000'           
 GROUP BY SUBSTRING(A.GRPCODE,1,1), GRPNAME          
 HAVING ABS(ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)) > 0          
   
 UNION  
   
 SELECT CLTCODE=SUBSTRING(A.GRPCODE,1,1) , ACNAME=GRPNAME, AMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0),    
 DRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),0),    
 CRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),0)          
 FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.ACMAST A, ACCOUNTBSE.DBO.GRPMAST G          
 WHERE L.CLTCODE = A.CLTCODE AND SUBSTRING(A.GRPCODE,1,1) IN (@MAINGRP)      
 AND VDT >= @FROMDT + ' 00:00:00' AND VDT <= @TODT + ' 23:59:59'          
 AND G.GRPCODE = SUBSTRING(A.GRPCODE,1,1)+ '0000000000'           
 GROUP BY SUBSTRING(A.GRPCODE,1,1), GRPNAME          
 HAVING ABS(ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)) > 0          
   
 UNION  
   
 SELECT CLTCODE=SUBSTRING(A.GRPCODE,1,1) , ACNAME=GRPNAME, AMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0),    
 DRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),0),    
 CRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),0)          
 FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.ACMAST A, ACCOUNTFO.DBO.GRPMAST G          
 WHERE L.CLTCODE = A.CLTCODE AND SUBSTRING(A.GRPCODE,1,1) IN (@MAINGRP)      
 AND VDT >= @FROMDT + ' 00:00:00' AND VDT <= @TODT + ' 23:59:59'          
 AND G.GRPCODE = SUBSTRING(A.GRPCODE,1,1)+ '0000000000'           
 GROUP BY SUBSTRING(A.GRPCODE,1,1), GRPNAME          
 HAVING ABS(ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)) > 0          
 ) Z  
 GROUP BY CLTCODE, ACNAME  
 ORDER BY CLTCODE, ACNAME   
     END      
 ELSE      
     BEGIN    
 SELECT CLTCODE, ACNAME, SUM(AMOUNT) AMOUNT, SUM(DRAMOUNT) DRAMOUNT, SUM(CRAMOUNT) CRAMOUNT  
 FROM (  
 SELECT CLTCODE=SUBSTRING(A.GRPCODE,1,1) , ACNAME=GRPNAME, AMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0),    
 DRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),0),    
 CRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),0)          
 FROM LEDGER L, ACMAST A, GRPMAST G  
 WHERE L.CLTCODE = A.CLTCODE AND SUBSTRING(A.GRPCODE,1,1) IN ('A','L','X','N')  
 AND VDT >= @FROMDT + ' 00:00:00' AND VDT <= @TODT + ' 23:59:59'          
 AND G.GRPCODE = SUBSTRING(A.GRPCODE,1,1)+ '0000000000'           
 GROUP BY SUBSTRING(A.GRPCODE,1,1), GRPNAME          
 HAVING ABS(ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)) > 0          
   
 UNION  
   
 SELECT CLTCODE=SUBSTRING(A.GRPCODE,1,1) , ACNAME=GRPNAME, AMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0),    
 DRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),0),    
 CRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),0)          
 FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.ACMAST A, ACCOUNTBSE.DBO.GRPMAST G  
 WHERE L.CLTCODE = A.CLTCODE AND SUBSTRING(A.GRPCODE,1,1) IN ('A','L','X','N')  
 AND VDT >= @FROMDT + ' 00:00:00' AND VDT <= @TODT + ' 23:59:59'          
 AND G.GRPCODE = SUBSTRING(A.GRPCODE,1,1)+ '0000000000'           
 GROUP BY SUBSTRING(A.GRPCODE,1,1), GRPNAME          
 HAVING ABS(ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)) > 0          
   
 UNION  
   
 SELECT CLTCODE=SUBSTRING(A.GRPCODE,1,1) , ACNAME=GRPNAME, AMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0),    
 DRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),0),    
 CRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),0)          
 FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.ACMAST A, ACCOUNTFO.DBO.GRPMAST G  
 WHERE L.CLTCODE = A.CLTCODE AND SUBSTRING(A.GRPCODE,1,1) IN ('A','L','X','N')  
 AND VDT >= @FROMDT + ' 00:00:00' AND VDT <= @TODT + ' 23:59:59'          
 AND G.GRPCODE = SUBSTRING(A.GRPCODE,1,1)+ '0000000000'           
 GROUP BY SUBSTRING(A.GRPCODE,1,1), GRPNAME          
 HAVING ABS(ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)) > 0          
 ) Z  
 GROUP BY CLTCODE, ACNAME  
 ORDER BY CLTCODE, ACNAME   
     END      
ELSE          
     BEGIN          
 SELECT CLTCODE, ACNAME, SUM(AMOUNT) AMOUNT, SUM(DRAMOUNT) DRAMOUNT, SUM(CRAMOUNT) CRAMOUNT  
 FROM (  
 SELECT CLTCODE=SUBSTRING(A.GRPCODE,1,3) , ACNAME=GRPNAME, AMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0),    
 DRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),0),    
 CRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),0)          
 FROM LEDGER L, ACMAST A, GRPMAST G          
 WHERE L.CLTCODE = A.CLTCODE AND SUBSTRING(A.GRPCODE,1,1) IN (@MAINGRP)          
 AND VDT >= @FROMDT + ' 00:00:00' AND VDT <= @TODT + ' 23:59:59'          
 AND G.GRPCODE = SUBSTRING(A.GRPCODE,1,3)+ '00000000' AND A.CLTCODE <> '99999'          
 GROUP BY SUBSTRING(A.GRPCODE,1,3), GRPNAME          
 HAVING ABS(ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)) > 0          
   
 UNION  
   
 SELECT CLTCODE=SUBSTRING(A.GRPCODE,1,3) , ACNAME=GRPNAME, AMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0),    
 DRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),0),    
 CRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),0)          
 FROM ACCOUNTBSE.DBO.LEDGER L, ACCOUNTBSE.DBO.ACMAST A, ACCOUNTBSE.DBO.GRPMAST G          
 WHERE L.CLTCODE = A.CLTCODE AND SUBSTRING(A.GRPCODE,1,1) IN (@MAINGRP)          
 AND VDT >= @FROMDT + ' 00:00:00' AND VDT <= @TODT + ' 23:59:59'          
 AND G.GRPCODE = SUBSTRING(A.GRPCODE,1,3)+ '00000000' AND A.CLTCODE <> '99999'          
 GROUP BY SUBSTRING(A.GRPCODE,1,3), GRPNAME          
 HAVING ABS(ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)) > 0         
   
 UNION  
   
 SELECT CLTCODE=SUBSTRING(A.GRPCODE,1,3) , ACNAME=GRPNAME, AMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0),    
 DRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE 0 END),0),    
 CRAMOUNT=ISNULL(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE 0 END),0)          
 FROM ACCOUNTFO.DBO.LEDGER L, ACCOUNTFO.DBO.ACMAST A, ACCOUNTFO.DBO.GRPMAST G          
 WHERE L.CLTCODE = A.CLTCODE AND SUBSTRING(A.GRPCODE,1,1) IN (@MAINGRP)          
 AND VDT >= @FROMDT + ' 00:00:00' AND VDT <= @TODT + ' 23:59:59'          
 AND G.GRPCODE = SUBSTRING(A.GRPCODE,1,3)+ '00000000' AND A.CLTCODE <> '99999'          
 GROUP BY SUBSTRING(A.GRPCODE,1,3), GRPNAME          
 HAVING ABS(ISNULL(SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),0)) > 0          
 ) Z  
 GROUP BY CLTCODE, ACNAME  
 ORDER BY CLTCODE, ACNAME   
     END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYLEDGER_BRANCH_SUMMARY_V3
-- --------------------------------------------------


/*	*****************************************************************************************************
	THIS PROCEDURE WILL DISPLAY PARTY LEDGER SUMMARY FOR BRANCH
	IN BROKER, AREA, REGION, BRANCH, SUBBROKER, TRADER AND PARTY LOGINS.
	THIS REPORT CAN BE VIEWED ON VOUCHER DATE OR EFFECTIVE DATE.
	CREATED BY	:=	YATIN DESAI
	CREATED DATE	:=	DECEMBER 02 2005
	MODIFIED DATE	:=	DECEMBER 16 2005
	DATABASE		:=	ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX
	SYNTAX AS FOLLOWS -----
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'SUBBROKER', 'BANGALORE', 'VDT', 'A', 'ZZZ', 'AREA'
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'FAMILY'
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'REGION', 'AHM', 'VDT', 'APS', 'ZPS'
	*****************************************************************************************************
*/
CREATE PROC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@STDDATE VARCHAR(11),
	@LSTDATE VARCHAR(11),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(20),
	@DISPLAYRPT VARCHAR(3),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@REPORTNAME VARCHAR(100)

AS

DECLARE
@@SQL AS VARCHAR(2000),
@@RECCOUNTER AS NUMERIC,
@@SHAREDB AS VARCHAR(25),
@@OBJID AS INT
SELECT @@OBJID = ISNULL(OBJECT_ID('NEWPARTYLEDGER'), 0)
IF @@OBJID = 0
	BEGIN
		EXEC CREATEPARTYLEDGER
	END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID

SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER

IF @REPORTNAME = 'BRANCH'
	BEGIN
		IF @STATUSID = 'BROKER' OR @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'
			BEGIN
				--INSERT LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (BRANCH_CODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'BROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
					END
				ELSE IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"
					END
				EXEC (@@SQL)
		
				--INSERT MARGINLEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (BRANCH_CODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'BROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
					END
				ELSE IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"
					END
				PRINT @@SQL
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT BRANCH_CODE, BRANCH, SUM(VAMT) AS LEDGERAMOUNT, SUM(MAMT) AS MARGINAMOUNT"
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + ", SUM(UNREALISED) AS UNREALISED "
					END
				SELECT @@SQL = @@SQL + ", SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY BRANCH_CODE, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY BRANCH_CODE, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)) "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + ", SUM(SUM(UNREALISED)) "
					END
				SELECT @@SQL = @@SQL + ", SUM(SUM(VAMT + MAMT)) "
				PRINT @@SQL
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'AREA'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (AREA, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.AREA A "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (AREA, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.AREA A, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT AREA, BRANCH AS AREANAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY AREA, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY AREA, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'REGION'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (REGION, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL +   "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.REGION R "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (REGION, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.REGION R, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT REGION, BRANCH AS REGIONNAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY REGION, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY REGION, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'SUBBROKER'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (SUB_BROKER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.SUBBROKERS S "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (SUB_BROKER, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.SUBBROKERS S, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT SUB_BROKER, BRANCH AS SUBNAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY SUB_BROKER, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY SUB_BROKER, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'TRADER'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (TRADER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCHES T "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "
				SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (TRADER, BRANCH, CLTCODE, ACNAME, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, C.CL_CODE, C.LONG_NAME, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.BRANCHES T, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT TRADER, BRANCH AS TRADERNAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY TRADER, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY TRADER, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'FAMILY'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY'
			BEGIN
				--INSERTING NORMAL LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (FAMILY, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, FAMILYMST F "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "
				SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "
				SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'FAMILY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "
					END
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				--INSERTING MARGIN LEDGER RECORDS
				SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (FAMILY, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "
				SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, "
				SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "
				SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, FAMILYMST F, "
				SELECT @@SQL = @@SQL + "LEDGER L "
				SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "
				SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "
				SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "
				SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
					END
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'FAMILY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "
					END
		
				PRINT (@@SQL)
				EXEC (@@SQL)
		
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						--DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR
						--INSTEAD OF GIVING REVERSAL EFFECT
						--THIS SAVES UNION JOIN
						SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
						SELECT @@SQL = @@SQL + "AND SPID = @@SPID"
						EXEC (@@SQL)
					END
				SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID
				IF @@RECCOUNTER <= 0
					BEGIN
						SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
						RETURN
					END
				SELECT @@SQL = "SELECT FAMILY, BRANCH AS FAMILYNAME, SUM(VAMT) AS LEDGERAMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "
					END
				SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "
				SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "
				SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "
				SELECT @@SQL = @@SQL + "GROUP BY FAMILY, BRANCH "
				SELECT @@SQL = @@SQL + "ORDER BY FAMILY, BRANCH "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "
				PRINT (@@SQL)
				EXEC (@@SQL)
				DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYLEDGER_SUMMARY_V3
-- --------------------------------------------------
  /* *****************************************************************************************************  
 THIS PROCEDURE WILL DISPLAY PARTY LEDGER SUMMARY FOR BRANCH  
 IN BROKER, AREA, REGION, BRANCH, SUBBROKER, TRADER AND PARTY LOGINS.  
 THIS REPORT CAN BE VIEWED ON VOUCHER DATE OR EFFECTIVE DATE.  
 CREATED BY := YATIN DESAI  
 CREATED DATE := DECEMBER 02 2005  
 MODIFIED DATE := DECEMBER 16 2005  
 DATABASE  := ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX  
 SYNTAX AS FOLLOWS -----  
 EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'SUBBROKER', 'BANGALORE', 'VDT', 'A', 'ZZZ', 'AREA'  
 EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'FAMILY'  
 EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'REGION', 'AHM', 'VDT', 'APS', 'ZPS'  
 *****************************************************************************************************  
*/  
CREATE PROC RPT_PARTYLEDGER_SUMMARY_V3  
 @FDATE VARCHAR(11),  
 @TDATE VARCHAR(11),  
 @STDDATE VARCHAR(11),  
 @LSTDATE VARCHAR(11),  
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(20),  
 @DISPLAYRPT VARCHAR(3),  
 @FPARTY VARCHAR(10),  
 @TPARTY VARCHAR(10),  
 @REPORTNAME VARCHAR(100)  
  
AS  
  
DECLARE  
@@SQL AS VARCHAR(2000),  
@@RECCOUNTER AS NUMERIC,  
@@SHAREDB AS VARCHAR(25),  
@@OBJID AS INT  
SELECT @@OBJID = ISNULL(OBJECT_ID('NEWPARTYLEDGER'), 0)  
IF @@OBJID = 0  
 BEGIN  
  EXEC CREATEPARTYLEDGER  
 END  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
  
SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER  
  
IF @REPORTNAME = 'BRANCH'  
 BEGIN  
  IF @STATUSID = 'BROKER' OR @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'  
   BEGIN  
    --INSERT LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (BRANCH_CODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'BROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
     END  
    ELSE IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"  
     END  
    EXEC (@@SQL)  
    
    --INSERT MARGINLEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (BRANCH_CODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'BROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
     END  
    ELSE IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"  
     END  
    PRINT @@SQL  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT BRANCH_CODE, BRANCH, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0  
      FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT BRANCH_CODE, BRANCH, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT"  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + ", ISNULL(SUM(UNREALISED), 0) AS UNREALISED "  
--     END  
    SELECT @@SQL = @@SQL + ", ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY BRANCH_CODE, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY BRANCH_CODE, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)) "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + ", SUM(ISNULL(SUM(UNREALISED), 0)) "  
--     END  
    SELECT @@SQL = @@SQL + ", SUM(ISNULL(SUM(VAMT + MAMT), 0)) "  
    PRINT @@SQL  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'AREA'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (AREA, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.AREA A "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (AREA, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.AREA A, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT AREA, BRANCH AS AREANAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT AREA, BRANCH AS AREANAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY AREA, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY AREA, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'REGION'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (REGION, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL +   "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.REGION R "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (REGION, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.REGION R, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT REGION, BRANCH AS REGIONNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT REGION, BRANCH AS REGIONNAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY REGION, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY REGION, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'SUBBROKER'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (SUB_BROKER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.SUBBROKERS S "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "  
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (SUB_BROKER, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.SUBBROKERS S, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT SUB_BROKER, BRANCH AS SUBNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT SUB_BROKER, BRANCH AS SUBNAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY SUB_BROKER, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY SUB_BROKER, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'TRADER'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (TRADER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCHES T "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "  
    SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (TRADER, BRANCH, CLTCODE, ACNAME, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, C.CL_CODE, C.LONG_NAME, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.BRANCHES T, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT TRADER, BRANCH AS TRADERNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT TRADER, BRANCH AS TRADERNAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY TRADER, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY TRADER, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'FAMILY'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (FAMILY, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, FAMILYMST F "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "  
    SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'FAMILY'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (FAMILY, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, FAMILYMST F, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'FAMILY'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT FAMILY, BRANCH AS FAMILYNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT FAMILY, BRANCH AS FAMILYNAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY FAMILY, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY FAMILY, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
  
IF @REPORTNAME = 'PARTY'  
 BEGIN  
  IF @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY' OR @STATUSID = 'CLIENT'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (CLTCODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN ISNULL(L.VAMT, 0) ELSE -ISNULL(L.VAMT, 0) END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'FAMILY'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'CLIENT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (CLTCODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN ISNULL(M.AMOUNT, 0) ELSE -ISNULL(M.AMOUNT, 0) END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, MARGINLEDGER M, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'FAMILY'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'CLIENT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT CLTCODE, BRANCH AS LONG_NAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT CLTCODE, BRANCH AS LONG_NAME, ISNULL(SUM(VAMT), 0) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(MAMT), 0) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "ISNULL(SUM(UNREALISED), 0) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "ISNULL(SUM(VAMT + MAMT), 0) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY CLTCODE, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY CLTCODE, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(ISNULL(SUM(VAMT), 0)), SUM(ISNULL(SUM(MAMT), 0)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(UNREALISED), 0)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(ISNULL(SUM(VAMT + MAMT), 0)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYLEDGER_SUMMARY_V3_13012011
-- --------------------------------------------------
CREATE  PROC RPT_PARTYLEDGER_SUMMARY_V3_13012011  
 @FDATE VARCHAR(11),  
 @TDATE VARCHAR(11),  
 @STDDATE VARCHAR(11),  
 @LSTDATE VARCHAR(11),  
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(20),  
 @DISPLAYRPT VARCHAR(3),  
 @FPARTY VARCHAR(10),  
 @TPARTY VARCHAR(10),  
 @REPORTNAME VARCHAR(100)  
  
AS  
  
DECLARE  
@@SQL AS VARCHAR(2000),  
@@RECCOUNTER AS NUMERIC,  
@@SHAREDB AS VARCHAR(25),  
@@OBJID AS INT  
SELECT @@OBJID = ISNULL(OBJECT_ID('NEWPARTYLEDGER'), 0)  
IF @@OBJID = 0  
 BEGIN  
  EXEC CREATEPARTYLEDGER  
 END  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
  
SELECT TOP 1 @@SHAREDB = SHAREDB FROM OWNER  
  
IF @REPORTNAME = 'BRANCH'  
 BEGIN  
  IF @STATUSID = 'BROKER' OR @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'  
   BEGIN  
    --INSERT LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (BRANCH_CODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'BROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
     END  
    ELSE IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"  
     END  
    EXEC (@@SQL)  
    
    --INSERT MARGINLEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (BRANCH_CODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT C.BRANCH_CD, B.BRANCH, CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, LEDGER L, " + @@SHAREDB + ".DBO.BRANCH B "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = B.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'BROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
     END  
    ELSE IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "'"  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "'"  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "'"  
     END  
    PRINT @@SQL  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT BRANCH_CODE, BRANCH, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0  
      FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT BRANCH_CODE, BRANCH, SUM(VAMT) AS LEDGERAMOUNT, SUM(MAMT) AS MARGINAMOUNT"  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + ", SUM(UNREALISED) AS UNREALISED "  
--     END  
    SELECT @@SQL = @@SQL + ", SUM(VAMT + MAMT) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY BRANCH_CODE, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY BRANCH_CODE, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)) "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + ", SUM(SUM(UNREALISED)) "  
--     END  
    SELECT @@SQL = @@SQL + ", SUM(SUM(VAMT + MAMT)) "  
    PRINT @@SQL  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'AREA'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (AREA, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.AREA A "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (AREA, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT A.AREACODE, A.DESCRIPTION, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.AREA A, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.AREA = A.AREACODE AND C.BRANCH_CD = A.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT AREA, BRANCH AS AREANAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT AREA, BRANCH AS AREANAME, SUM(VAMT) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY AREA, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY AREA, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'REGION'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (REGION, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL +   "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.REGION R "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (REGION, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT R.REGIONCODE, R.DESCRIPTION, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.REGION R, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.REGION = R.REGIONCODE AND C.BRANCH_CD = R.BRANCH_CODE "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT REGION, BRANCH AS REGIONNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT REGION, BRANCH AS REGIONNAME, SUM(VAMT) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY REGION, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY REGION, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'SUBBROKER'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (SUB_BROKER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.SUBBROKERS S "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "  
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (SUB_BROKER, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT S.SUB_BROKER, S.NAME, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.SUBBROKERS S, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = S.SUB_BROKER "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.SUB_BROKER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT SUB_BROKER, BRANCH AS SUBNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT SUB_BROKER, BRANCH AS SUBNAME, SUM(VAMT) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY SUB_BROKER, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY SUB_BROKER, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'TRADER'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (TRADER, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, " + @@SHAREDB + ".DBO.BRANCHES T "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "  
    SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (TRADER, BRANCH, CLTCODE, ACNAME, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT T.SHORT_NAME, T.LONG_NAME, C.CL_CODE, C.LONG_NAME, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, " + @@SHAREDB + ".DBO.BRANCHES T, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.TRADER = T.SHORT_NAME AND C.BRANCH_CD = T.BRANCH_CD "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.TRADER BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT TRADER, BRANCH AS TRADERNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT TRADER, BRANCH AS TRADERNAME, SUM(VAMT) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY TRADER, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY TRADER, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
IF @REPORTNAME = 'FAMILY'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (FAMILY, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, LEDGER L, FAMILYMST F "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "  
    SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'FAMILY'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (FAMILY, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT F.FAMILY, F.FAMILYNAME, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, MARGINLEDGER M, FAMILYMST F, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND C.FAMILY = F.FAMILY "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C.FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'FAMILY'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT FAMILY, BRANCH AS FAMILYNAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT FAMILY, BRANCH AS FAMILYNAME, SUM(VAMT) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY FAMILY, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY FAMILY, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END  
  
  
IF @REPORTNAME = 'PARTY'  
 BEGIN  
  IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY' OR @STATUSID = 'CLIENT'  
   BEGIN  
    --INSERTING NORMAL LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (CLTCODE, BRANCH, VAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END AS VAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN L.VAMT ELSE -L.VAMT END ELSE 0 END AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "L.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = L.CLTCODE "  
    SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'FAMILY'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'CLIENT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "  
     END  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    --INSERTING MARGIN LEDGER RECORDS  
    SELECT @@SQL = "INSERT INTO NEWPARTYLEDGER (CLTCODE, BRANCH, MAMT, UNREALISED, VDT, EDT, SPID) "  
    SELECT @@SQL = @@SQL + "SELECT C2.PARTY_CODE, C.LONG_NAME, "  
    SELECT @@SQL = @@SQL + "(CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) AS MAMT, "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "(CASE WHEN L.VDT <= '" + @TDATE + " 23:59:59' AND L.EDT > '" + @TDATE + " 23:59:59' THEN (CASE WHEN M.DRCR = 'C' THEN M.AMOUNT ELSE -M.AMOUNT END) ELSE 0 END ) AS UNREALISED, "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "UNREALISED = 0, "  
     END  
    SELECT @@SQL = @@SQL + "M.VDT, L.EDT, @@SPID "  
    SELECT @@SQL = @@SQL + "FROM " + @@SHAREDB + ".DBO.CLIENT1 C, " + @@SHAREDB + ".DBO.CLIENT2 C2, MARGINLEDGER M, "  
    SELECT @@SQL = @@SQL + "LEDGER L "  
    SELECT @@SQL = @@SQL + "WHERE C.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = M.PARTY_CODE "  
    SELECT @@SQL = @@SQL + "AND M.VNO = L.VNO AND M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.LNO = L.LNO "  
    SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "  
    IF @DISPLAYRPT = 'VDT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND M.VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    ELSE  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND L.EDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "  
     END  
    IF @STATUSID = 'AREA'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.AREA = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'REGION'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.REGION = '" + @STATUSNAME + "' "  
     END      ELSE IF @STATUSID = 'BRANCH'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.BRANCH_CD = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'SUBBROKER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.SUB_BROKER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'TRADER'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.TRADER = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'FAMILY'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C.FAMILY = '" + @STATUSNAME + "' "  
     END  
    ELSE IF @STATUSID = 'CLIENT'  
     BEGIN  
      SELECT @@SQL = @@SQL + "AND C2.PARTY_CODE = '" + @STATUSNAME + "' "  
     END  
    
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    
    IF @DISPLAYRPT = 'EDT'  
     BEGIN  
      --DELETING OVERLAPING ENTRIES OF EFFECTIVE DATE ACCROSS THE YEAR  
      --INSTEAD OF GIVING REVERSAL EFFECT  
      --THIS SAVES UNION JOIN  
      SELECT @@SQL = "DELETE FROM NEWPARTYLEDGER WHERE VDT < '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "  
      SELECT @@SQL = @@SQL + "AND SPID = @@SPID"  
      EXEC (@@SQL)  
     END  
    SELECT @@RECCOUNTER = ISNULL(COUNT(*), 0) FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
    IF @@RECCOUNTER <= 0  
     BEGIN  
      SELECT CLTCODE, BRANCH AS LONG_NAME, LEDGERAMOUNT = 0, MARGINAMOUNT = 0, UNREALISED = 0, HTOTAL = 0 FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
      RETURN  
     END  
    SELECT @@SQL = "SELECT CLTCODE, BRANCH AS LONG_NAME, SUM(VAMT) AS LEDGERAMOUNT, "  
    SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGINAMOUNT, "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(UNREALISED) AS UNREALISED, "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(VAMT + MAMT) AS HTOTAL "  
    SELECT @@SQL = @@SQL + "FROM NEWPARTYLEDGER "  
    SELECT @@SQL = @@SQL + "WHERE SPID = @@SPID "  
    SELECT @@SQL = @@SQL + "GROUP BY CLTCODE, BRANCH "  
    SELECT @@SQL = @@SQL + "ORDER BY CLTCODE, BRANCH "  
    SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "  
/*    IF @DISPLAYRPT = 'VDT'  
     BEGIN*/  
      SELECT @@SQL = @@SQL + "SUM(SUM(UNREALISED)), "  
--     END  
    SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT)) "  
    PRINT (@@SQL)  
    EXEC (@@SQL)  
    DELETE FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
  ELSE  
   BEGIN  
    PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'  
    SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID  
   END  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYLEDGER_SUMMARY_V4
-- --------------------------------------------------


/*	*****************************************************************************************************
	THIS PROCEDURE WILL DISPLAY PARTY LEDGER SUMMARY FOR BRANCH
	IN BROKER, AREA, REGION, BRANCH, SUBBROKER, TRADER AND PARTY LOGINS.
	THIS REPORT CAN BE VIEWED ON VOUCHER DATE OR EFFECTIVE DATE.
	CREATED BY	:=	YATIN DESAI
	CREATED DATE	:=	DECEMBER 02 2005
	MODIFIED DATE	:=	DECEMBER 16 2005
	DATABASE		:=	ACCOUNT AND ACCOUNTBSE AND ACCOUNTFO AND ACCOUNTMCDX AND ACCOUNTNCDX
	SYNTAX AS FOLLOWS -----
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY_V3 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'SUBBROKER', 'BANGALORE', 'VDT', 'A', 'ZZZ', 'AREA'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'BRANCH'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'REGION'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'AREA'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'SUBBROKER'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'TRADER'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'FAMILY'
	EXEC RPT_PARTYLEDGER_BRANCH_SUMMARY 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'REGION', 'AHM', 'VDT', 'APS', 'ZPS'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'PARTY', 'ACO1', 'VDT', 'ADIT1', 'ADIT1', 'PARTY'
	EXEC RPT_PARTYLEDGER_SUMMARY_V4 'APR  1 2005', 'DEC 31 2005', 'APR  1 2005', 'MAR 31 2006', 'BROKER', 'BROKER', 'VDT', 'A', 'ZZZ', 'PARTY'
	*****************************************************************************************************
*/
CREATE PROC RPT_PARTYLEDGER_SUMMARY_V4
	@FDATE VARCHAR(11),
	@TDATE VARCHAR(11),
	@STDDATE VARCHAR(11),
	@LSTDATE VARCHAR(11),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(20),
	@DISPLAYRPT VARCHAR(3),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@REPORTNAME VARCHAR(100)

AS

DECLARE
@@SQL AS VARCHAR(2000),
@@RECCOUNTER AS NUMERIC,
@@SHAREDB AS VARCHAR(20),
@@OBJID AS INT

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @REPORTNAME = 'BRANCH'
	BEGIN
		IF @STATUSID = 'BROKER' OR @STATUSID = 'BRANCH' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'
			BEGIN
				SELECT @@SQL = "SELECT BRANCH_CODE, BRANCH_NAME, SUM(VAMT) AS LEDGER_AMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGIN_AMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE
						SELECT @@SQL = @@SQL + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "HTOTAL = SUM(VAMT + MAMT) "
				SELECT @@SQL = @@SQL + "FROM LEDGER_TEMP_NEW_PARTYLEDGER WITH (NOLOCK) "
				SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND VDT >= '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
					END
				SELECT @@SQL = @@SQL + "AND BRANCH_CODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND BRANCH_CODE = '" + @STATUSNAME + "' "
					END
				SELECT @@SQL = @@SQL + "GROUP BY BRANCH_CODE, BRANCH_NAME "
				SELECT @@SQL = @@SQL + "ORDER BY BRANCH_CODE, BRANCH_NAME "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT))"
				PRINT @@SQL
				EXEC (@@SQL)
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'AREA'
	BEGIN
		IF @STATUSID = 'BROKER' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'
			BEGIN
				SELECT @@SQL = "SELECT AREA, AREA_NAME, SUM(VAMT) AS LEDGER_AMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGIN_AMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE
						SELECT @@SQL = @@SQL + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "HTOTAL = SUM(VAMT + MAMT) "
				SELECT @@SQL = @@SQL + "FROM LEDGER_TEMP_NEW_PARTYLEDGER WITH (NOLOCK) "
				SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND VDT >= '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
					END
				SELECT @@SQL = @@SQL + "AND AREA BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND REGION = '" + @STATUSNAME + "' "
					END
				SELECT @@SQL = @@SQL + "GROUP BY AREA, AREA_NAME "
				SELECT @@SQL = @@SQL + "ORDER BY AREA, AREA_NAME "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT))"
				PRINT @@SQL
				EXEC (@@SQL)
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'REGION'
	BEGIN
		IF @STATUSID = 'BROKER' OR @STATUSID = 'AREA' OR @STATUSID = 'REGION'
			BEGIN
				SELECT @@SQL = "SELECT REGION, REGION_NAME, SUM(VAMT) AS LEDGER_AMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGIN_AMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE
						SELECT @@SQL = @@SQL + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "HTOTAL = SUM(VAMT + MAMT) "
				SELECT @@SQL = @@SQL + "FROM LEDGER_TEMP_NEW_PARTYLEDGER WITH (NOLOCK) "
				SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND VDT >= '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
					END
				SELECT @@SQL = @@SQL + "AND REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND REGION = '" + @STATUSNAME + "' "
					END
				SELECT @@SQL = @@SQL + "GROUP BY REGION, REGION_NAME "
				SELECT @@SQL = @@SQL + "ORDER BY REGION, REGION_NAME "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT))"
				PRINT @@SQL
				EXEC (@@SQL)
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'SUBBROKER'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'
			BEGIN
				SELECT @@SQL = "SELECT SUBBROKER, SUBBROKER_NAME, SUM(VAMT) AS LEDGER_AMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGIN_AMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE
						SELECT @@SQL = @@SQL + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "HTOTAL = SUM(VAMT + MAMT) "
				SELECT @@SQL = @@SQL + "FROM LEDGER_TEMP_NEW_PARTYLEDGER WITH (NOLOCK) "
				SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND VDT >= '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
					END
				SELECT @@SQL = @@SQL + "AND REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND BRANCH_CODE = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND SUBBROKER = '" + @STATUSNAME + "' "
					END
				SELECT @@SQL = @@SQL + "GROUP BY SUBBROKER, SUBBROKER_NAME "
				SELECT @@SQL = @@SQL + "ORDER BY SUBBROKER, SUBBROKER_NAME "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT))"
				PRINT @@SQL
				EXEC (@@SQL)
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'TRADER'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'BRANCH'
			BEGIN
				SELECT @@SQL = "SELECT TRADER, TRADER_NAME, SUM(VAMT) AS LEDGER_AMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGIN_AMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE
						SELECT @@SQL = @@SQL + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "HTOTAL = SUM(VAMT + MAMT) "
				SELECT @@SQL = @@SQL + "FROM LEDGER_TEMP_NEW_PARTYLEDGER WITH (NOLOCK) "
				SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND VDT >= '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
					END
				SELECT @@SQL = @@SQL + "AND REGION BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND BRANCH_CODE = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND SUBBROKER = '" + @STATUSNAME + "' "
					END
				SELECT @@SQL = @@SQL + "GROUP BY TRADER, TRADER_NAME "
				SELECT @@SQL = @@SQL + "ORDER BY TRADER, TRADER_NAME "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT))"
				PRINT @@SQL
				EXEC (@@SQL)
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'FAMILY'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY'
			BEGIN
				SELECT @@SQL = "SELECT FAMILY, FAMILY_NAME, SUM(VAMT) AS LEDGER_AMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGIN_AMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE
						SELECT @@SQL = @@SQL + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "HTOTAL = SUM(VAMT + MAMT) "
				SELECT @@SQL = @@SQL + "FROM LEDGER_TEMP_NEW_PARTYLEDGER WITH (NOLOCK) "
				SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND VDT >= '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
					END
				SELECT @@SQL = @@SQL + "AND FAMILY BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND BRANCH_CODE = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND SUBBROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'FAMILY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND FAMILY = '" + @STATUSNAME + "' "
					END
				SELECT @@SQL = @@SQL + "GROUP BY FAMILY, FAMILY_NAME "
				SELECT @@SQL = @@SQL + "ORDER BY FAMILY, FAMILY_NAME "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT))"
				PRINT @@SQL
				EXEC (@@SQL)
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

IF @REPORTNAME = 'PARTY'
	BEGIN
		IF @STATUSID = 'AREA' OR @STATUSID = 'BROKER' OR @STATUSID = 'REGION' OR @STATUSID = 'SUBBROKER' OR @STATUSID = 'TRADER' OR @STATUSID = 'FAMILY' OR @STATUSID = 'PARTY'
			BEGIN
				SELECT @@SQL = "SELECT CLTCODE, LONGNAME, SUM(VAMT) AS LEDGER_AMOUNT, "
				SELECT @@SQL = @@SQL + "SUM(MAMT) AS MARGIN_AMOUNT, "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE
						SELECT @@SQL = @@SQL + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END) AS UNREALISED, "
					END
				ELSE
					BEGIN
						SELECT @@SQL = @@SQL + "UNREALISED = 0, "
					END
				SELECT @@SQL = @@SQL + "HTOTAL = SUM(VAMT + MAMT) "
				SELECT @@SQL = @@SQL + "FROM LEDGER_TEMP_NEW_PARTYLEDGER WITH (NOLOCK) "
				SELECT @@SQL = @@SQL + "WHERE VDT BETWEEN '" + @STDDATE + "' AND '" + @TDATE + " 23:59:59' "
				IF @DISPLAYRPT = 'EDT'
					BEGIN
						SELECT @@SQL = @@SQL + "AND VDT >= '" + @STDDATE + "' AND EDT >= '" + @STDDATE + "' "
					END
				SELECT @@SQL = @@SQL + "AND CLTCODE BETWEEN '" + @FPARTY + "' AND '" + @TPARTY + "' "
				IF @STATUSID = 'AREA'
					BEGIN
						SELECT @@SQL = @@SQL + "AND AREA = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'REGION'
					BEGIN
						SELECT @@SQL = @@SQL + "AND REGION = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'TRADER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND TRADER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'BRANCH'
					BEGIN
						SELECT @@SQL = @@SQL + "AND BRANCH_CODE = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'SUBBROKER'
					BEGIN
						SELECT @@SQL = @@SQL + "AND SUBBROKER = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'FAMILY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND FAMILY = '" + @STATUSNAME + "' "
					END
				ELSE IF @STATUSID = 'PARTY'
					BEGIN
						SELECT @@SQL = @@SQL + "AND CLTCODE = '" + @STATUSNAME + "' "
					END
				SELECT @@SQL = @@SQL + "GROUP BY CLTCODE, LONGNAME "
				SELECT @@SQL = @@SQL + "ORDER BY CLTCODE, LONGNAME "
				SELECT @@SQL = @@SQL + "COMPUTE SUM(SUM(VAMT)), SUM(SUM(MAMT)), "
				IF @DISPLAYRPT = 'VDT'
					BEGIN
						SELECT @@SQL = @@SQL + "SUM(SUM(CASE WHEN VDT <= '" + @TDATE + " 23:59:59' AND EDT > '" + @TDATE + " 23:59:59' THEN CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END ELSE 0 END)), "
					END
				SELECT @@SQL = @@SQL + "SUM(SUM(VAMT + MAMT))"
				PRINT @@SQL
				EXEC (@@SQL)
			END
		ELSE
			BEGIN
				PRINT 'THE COMBINATION OF LOGIN AND REPORT NOT ALLOWED'
				SELECT * FROM NEWPARTYLEDGER WHERE SPID = @@SPID
			END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_RETURNFIELDS
-- --------------------------------------------------



CREATE PROC RPT_RETURNFIELDS      
 @STATUSID VARCHAR(20),      
 @SUMMARYOPT CHAR(1),      
 @REPORTNAME VARCHAR(15)  
  
AS      
      
DECLARE      
@@RETURNFIELDS AS VARCHAR(1000)      
      
 SELECT  
  RETURNFIELDS
 FROM      
   TBL_MASTER_PARTYLEDGER      
 WHERE      
   REPORTNAME = @REPORTNAME      
   AND STATUSID = @STATUSID      
   AND SUMMARYOPT = @SUMMARYOPT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_TODAYDATE
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.RPT_TODAYDATE    SCRIPT DATE: 06/24/2004 8:32:39 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_TODAYDATE    SCRIPT DATE: 05/10/2004 5:29:46 PM ******/  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_TODAYDATE    SCRIPT DATE: 01/14/2002 20:39:23 ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_TODAYDATE    SCRIPT DATE: 01/04/1980 1:40:42 AM ******/  
  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_TODAYDATE    SCRIPT DATE: 11/28/2001 12:23:51 PM ******/  
  
  
  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_TODAYDATE    SCRIPT DATE: 2/17/01 5:19:55 PM ******/  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_TODAYDATE    SCRIPT DATE: 3/21/01 12:50:24 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_TODAYDATE    SCRIPT DATE: 20-MAR-01 11:39:03 PM ******/  
  
  
  
CREATE PROCEDURE RPT_TODAYDATE  
AS  
SELECT CONVERT(VARCHAR,GETDATE(),103)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_TODAYDATE1
-- --------------------------------------------------


CREATE PROCEDURE RPT_TODAYDATE1
AS
SELECT CONVERT(VARCHAR(11),GETDATE(),109)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_USERRIGHTS
-- --------------------------------------------------


CREATE PROCEDURE [DBO].[RPT_USERRIGHTS]

   @VOUCHER_TYPE VARCHAR(2)

AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT DISTINCT 

	U.USERCATEGORY,
	U.USERSTATUSID,
	VTYP = CONVERT(VARCHAR, U.VTYP) +' ' + V.VDESC,
	BOOKTYPE = CONVERT(VARCHAR, U.BOOKTYPE) +' ' + B.DESCRIPTION,
	U.NODAYS,
	U.NODAYSD 

FROM 

	USERRIGHTS U (NOLOCK),
	VMAST V (NOLOCK),
	BOOKTYPE B (NOLOCK),
	MCDXCDS.DBO.TBLCATEGORY T (NOLOCK)

WHERE

	 U.VTYP = @VOUCHER_TYPE AND
	 U.VTYP = V.VTYPE AND
	 U.BOOKTYPE=B.BOOKTYPE AND
	 U.USERCATEGORY=T.FLDCATEGORYCODE 

ORDER BY

	U.USERCATEGORY,
	U.NODAYS,
	U.NODAYSD

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_VOUCHERPRINTING
-- --------------------------------------------------



/****** OBJECT:  STORED PROCEDURE DBO.RPT_VOUCHERPRINTING    SCRIPT DATE: 06/24/2004 8:32:37 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_VOUCHERPRINTING    SCRIPT DATE: 05/10/2004 5:29:41 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_VOUCHERPRINTING    SCRIPT DATE: 04/07/2003 12:28:25 PM ******/  
  
  
CREATE PROC [dbo].[RPT_VOUCHERPRINTING]  
@VTYP    VARCHAR(2),  
@BOOKTYPE    VARCHAR(2),  
@FROMDATE   VARCHAR(11),  
@TODATE   VARCHAR(11),  
@VNOFROM   VARCHAR(12),  
@VNOTO   VARCHAR(12)  
  
AS  
DECLARE  
  
 @@SELECTQURY   AS VARCHAR(8000),  
 @@FROMTABLES   AS VARCHAR(2000),  
 @@WHEREPART    AS VARCHAR(8000),  
 @@SORTBY       AS VARCHAR(200)  
  
  
   IF @VNOFROM <> '' AND @VNOTO <> ''   
    BEGIN   
      -- SELECT @@WHEREPART = " WHERE L.VTYP = '" + @VTYP + "'  AND L.BOOKTYPE = '" + @BOOKTYPE + "'  
     SELECT @@WHEREPART = " WHERE L.VTYP = '" + @VTYP + "'    
      AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "'    
       AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "  
        
    END  
   ELSE  
    BEGIN  
      -- SELECT @@WHEREPART = " WHERE L.VTYP = '" + @VTYP + "'  AND L.BOOKTYPE = '" + @BOOKTYPE + "'  
     SELECT @@WHEREPART = " WHERE L.VTYP = '" + @VTYP + "'   
       AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "  
    END         
  
  
   IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'    
   BEGIN  
    SELECT @@WHEREPART = @@WHEREPART + "  AND   CLTCODE <> '" + @BOOKTYPE + "'"   
  
   END  
   ELSE  
   BEGIN  
    SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'"  
   END   
  
  
   SELECT @@SELECTQURY = " SELECT DISTINCT L.VNO,ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,  
   CLTCODE,  ACNAME ,   
   ISNULL(L.VAMT,0) VAMT,  L.DRCR,  L.VTYP, L.VNO, L.LNO , L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,  
     BANK = ISNULL(BNKNAME,''), BRANCH = ISNULL(BRNNAME,'') , ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO, DDDT  =  CONVERT(VARCHAR,DDDT,103)  ,  
     L.NARRATION, CLTCODE2 = CLTCODE, ACNAME2 = ACNAME "  
  
   SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN LEDGER1 L1 ON  L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO "  
  
   
      
-- PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )  
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_VOUCHERREPORT
-- --------------------------------------------------


CREATE PROCEDURE RPT_VOUCHERREPORT
@FROMDT VARCHAR(15), 
@TODT VARCHAR(15), 
@TYP INT, 
@VNO VARCHAR(15)
AS
IF @VNO = '%'
BEGIN
IF @TYP IN ('2', '3', '5', '6', '7', '15', '16', '17', '19', '20', '21') 
BEGIN
SELECT DISTINCT L.CLTCODE, LTRIM(RTRIM(L.ACNAME)) AS ACNAME , L.VNO, L.VTYP, 
LEFT(CONVERT(VARCHAR, L.VDT, 109), 11) AS VDT , L1.DDNO, 
CRAMT = CASE WHEN L.DRCR = 'C' THEN VAMT ELSE 0 END, 
DRAMT = CASE WHEN L.DRCR = 'D' THEN VAMT ELSE 0 END, 
LEFT(CONVERT(VARCHAR, L.EDT, 109), 11) AS EDT, L.LNO
FROM LEDGER L, LEDGER1 L1
WHERE L.VDT > = @FROMDT 
AND L.VDT < = @TODT+' 23:59:59' 
AND L.VTYP = @TYP 
AND L1.VTYP = L.VTYP 
AND L.VNO = L1.VNO
ORDER BY L.VTYP, L.VNO
END
IF @TYP NOT IN ('2', '3', '5', '6', '7', '15', '16', '17', '19', '20', '21') 
BEGIN
SELECT DISTINCT L.CLTCODE, LTRIM(RTRIM(L.ACNAME)) AS ACNAME , L.VNO, L.VTYP, 
LEFT(CONVERT(VARCHAR, L.VDT, 109), 11) AS VDT , DDNO = 0, 
CRAMT = CASE WHEN L.DRCR = 'C' THEN VAMT ELSE 0 END, 
DRAMT = CASE WHEN L.DRCR = 'D' THEN VAMT ELSE 0 END, 
LEFT(CONVERT(VARCHAR, L.EDT, 109), 11) AS EDT, L.LNO
FROM LEDGER L
WHERE L.VDT > = @FROMDT 
AND L.VDT < = @TODT+' 23:59:59' 
AND L.VTYP = @TYP 
ORDER BY L.VTYP, L.VNO
END
END
IF @VNO <> '%'
BEGIN
IF @TYP IN ('2', '3', '5', '6', '7', '15', '16', '17', '19', '20', '21') 
BEGIN
SELECT DISTINCT L.CLTCODE, LTRIM(RTRIM(L.ACNAME)) AS ACNAME , L.VNO, L.VTYP, 
LEFT(CONVERT(VARCHAR, L.VDT, 109), 11) AS VDT , L1.DDNO, 
CRAMT = CASE WHEN L.DRCR = 'C' THEN VAMT ELSE 0 END, 
DRAMT = CASE WHEN L.DRCR = 'D' THEN VAMT ELSE 0 END, 
LEFT(CONVERT(VARCHAR, L.EDT, 109), 11) AS EDT, L.LNO
FROM LEDGER L, LEDGER1 L1
WHERE L.VDT > = @FROMDT 
AND L.VDT < = @TODT+' 23:59:59' 
AND L.VTYP = @TYP 
AND L.VNO = @VNO 
AND L1.VTYP = L.VTYP 
AND L.VNO = L1.VNO
ORDER BY L.VTYP, L.VNO
END
IF @TYP NOT IN ('2', '3', '5', '6', '7', '15', '16', '17', '19', '20', '21') 
BEGIN
SELECT DISTINCT L.CLTCODE, LTRIM(RTRIM(L.ACNAME)) AS ACNAME , L.VNO, L.VTYP, 
LEFT(CONVERT(VARCHAR, L.VDT, 109), 11) AS VDT , DDNO = 0, 
CRAMT = CASE WHEN L.DRCR = 'C' THEN VAMT ELSE 0 END, 
DRAMT = CASE WHEN L.DRCR = 'D' THEN VAMT ELSE 0 END, 
LEFT(CONVERT(VARCHAR, L.EDT, 109), 11) AS EDT, L.LNO
FROM LEDGER L
WHERE L.VDT > = @FROMDT 
AND L.VDT < = @TODT+' 23:59:59' 
AND L.VTYP = @TYP 
AND L.VNO = @VNO 
ORDER BY L.VTYP, L.VNO
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sAcc_opbal
-- --------------------------------------------------
CREATE Procedure [dbo].[sAcc_opbal]      
@Sdate Varchar(11),            /* As Mmm Dd Yyyy */      
@Edate Varchar(11),            /* As Mmm Dd Yyyy */      
@Fdate Varchar(11),            /* As Mmm Dd Yyyy */      
@Tdate Varchar(11),            /* As Mmm Dd Yyyy */      
@Fcode Varchar(10),       
@Tcode Varchar(10),       
@Statusid Varchar(30),       
@Statusname Varchar(30),       
@Branch Varchar(10),       
@Selectionby Varchar(3),       
@Groupby Varchar(10),       
@Sortby Varchar(50),       
@Reportname Varchar(30),       
@Reportopt Varchar(10),       
@Fld1 Varchar(10),       
@Fld2 Varchar(10),       
@Fld3 Varchar(10)      
As      
Declare      
@@Opendate   As Varchar(11)      
/* -------------------------------------------------------------------------- */      
If Len(Rtrim(@Fdate)) = 10       
Begin      
   Select @Fdate = Left(@Fdate, 3) + ' ' + Substring(@Fdate, 4, 7)      
End      
If Len(Rtrim(@Sdate)) = 10       
Begin      
   Select @Sdate = Left(@Sdate, 3) + ' ' + Substring(@Sdate, 4, 7)      
End      
If Len(Rtrim(@Tdate)) = 10       
Begin      
   Select @Tdate = Left(@Tdate, 3) + ' ' + Substring(@Tdate, 4, 7)      
End      
If Len(Rtrim(@Edate)) = 10       
Begin      
   Select @Edate = Left(@Edate, 3) + ' ' + Substring(@Edate, 4, 7)      
End      
If @Fdate = ''      
Begin      
   Select @Fdate = @Sdate      
End      
If @Tdate = ''      
Begin      
   Select @Tdate = @Edate      
End      
If @Reportname <> 'Marginledger'      
Begin      
/* Get Opendate From Sdate, Fdate Received As Parameter */      
   If Upper(@Selectionby) = 'Vdt'      
      Begin      
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Sledger_Vw_Final Where Vtyp = 18 And Vdt < = @Fdate )      
      End      
   Else      
      Begin      
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Edt), 0), 109), 11) From Sledger_Vw_Final Where Vtyp = 18 And Edt < = @Fdate )      
   End      
/* -------------------------------------------------------------------------- */           
   If Upper(@Selectionby) = 'Vdt'      
      Begin      
         If @Sdate = @Fdate      
            Begin      
  If @@Opendate = @Fdate       
  Begin      
                Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)      
                From Sledger_Vw_Final       
                Where Cltcode = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18      
                Group By Cltcode      
  End      
  Else      
  Begin      
                Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)      
                From Sledger_Vw_Final       
                Where Cltcode = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate       
                Group By Cltcode      
  End      
            End      
         Else      
            Begin      
               Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)      
               From Sledger_Vw_Final       
               Where Cltcode = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate       
               Group By Cltcode      
            End      
      End      
   Else      
      Begin      
         If @Sdate = @Fdate And @@Opendate = @Fdate      
            Begin      
               Select Cltcode, Opbal = Sum(Balamt)      
               From Sledger_Vw_Final       
               Where Cltcode = @Fcode And Edt Like @@Opendate + '%' And Vtyp = 18      
               Group By Cltcode      
            End      
         Else      
            Begin      
               Select Cltcode, Opbal = Sum(Opbal)      
               From      
               ( Select Cltcode, Opbal = Sum(Balamt)      
                 From Sledger_Vw_Final       
                 Where Cltcode = @Fcode And Edt Like @@Opendate + '%' And Vtyp = 18      
                 Group By Cltcode      
                 Union All      
                 Select Cltcode, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Vamt Else -vamt End)      
                 From Sledger_Vw_Final       
                 Where Cltcode = @Fcode And Edt > = @@Opendate + ' 00:00:00' And Edt < @Fdate And Vtyp <> 18      
                 Group By Cltcode ) T      
               Group By Cltcode      
            End      
      End      
End      
If @Reportname = 'Marginledger'      
Begin      
/* Get Opendate From Sdate, Fdate Received As Parameter */      
   If Upper(@Selectionby) = 'Vdt'      
      Begin      
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Marginledger Where Vtyp = 18 And Vdt < = @Fdate )      
      End      
   Else      
      Begin      
         Select @@Opendate = ( Select Left(Convert(Varchar, Isnull(Max(Vdt), 0), 109), 11) From Marginledger Where Vtyp = 18 And Vdt < = @Fdate )      
   End      
/* -------------------------------------------------------------------------- */           
   If Upper(@Selectionby) = 'Vdt'      
      Begin      
         If @Sdate = @Fdate      
            Begin      
  If @@Opendate = @Fdate       
  Begin      
                Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)      
                From Marginledger       
                Where Party_code = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18      
                Group By Party_code      
  End      
  Else      
  Begin      
      Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)      
                From Marginledger       
                Where Party_code = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate       
                Group By Party_code      
  End      
            End      
         Else      
            Begin      
     Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)      
               From Marginledger       
               Where Party_code = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate       
               Group By Party_code      
            End      
      End      
   Else      
      Begin      
         If @Sdate = @Fdate And @@Opendate = @Fdate      
            Begin      
               Select Cltcode = Party_code, Opbal = Sum(Sett_no)      
               From Marginledger       
               Where Party_code = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18      
               Group By Party_code      
            End      
         Else      
            Begin      
               Select Cltcode, Opbal = Sum(Opbal)      
               From      
               ( Select Cltcode = Party_code, Opbal = Sum(Sett_no)      
                 From Marginledger       
                 Where Party_code = @Fcode And Vdt Like @@Opendate + '%' And Vtyp = 18      
                 Group By Party_code      
                 Union All      
                 Select Cltcode = Party_code, Opbal = Sum( Case When Upper(Drcr) = 'D' Then Amount Else -amount End)      
                 From Marginledger       
                 Where Party_code = @Fcode And Vdt > = @@Opendate + ' 00:00:00' And Vdt < @Fdate And Vtyp <> 18      
                 Group By Party_code) T      
               Group By Cltcode      
            End      
      End      
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SACC_REPORTS
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[SACC_REPORTS]                                
@SDATE VARCHAR(11),            /* AS MMM DD YYYY */                                
@EDATE VARCHAR(11),            /* AS MMM DD YYYY */                                
@FDATE VARCHAR(11),            /* AS MMM DD YYYY */                                
@TDATE VARCHAR(11),            /* AS MMM DD YYYY */                                
@FCODE VARCHAR(10),                                
@TCODE VARCHAR(10),                                
@STATUSID VARCHAR(30),                                
@STATUSNAME VARCHAR(30),                                
@BRANCH VARCHAR(10),                                
@SELECTIONBY VARCHAR(3),                                
@GROUPBY VARCHAR(10),                                
@SORTBY VARCHAR(50),                                
@REPORTNAME VARCHAR(30),                                
@REPORTOPT VARCHAR(10),                                
@FLD1 VARCHAR(50),  /*  TO BE USED FOR SHAREDB IN CASE OF PARTY Sledger_Vw_Final */                                
@FLD2 VARCHAR(10),                                
@FLD3 VARCHAR(10)                                
                                
AS      
DECLARE                                
@@OPENDATE   AS VARCHAR(11),                                         
@@SELECTQURY AS VARCHAR(8000),                                
@@FROMTABLES AS VARCHAR(2000),                                
@@WHEREPART  AS VARCHAR(8000),                                
@@GROUPBY    AS VARCHAR(200),                                
@@SORTBY     AS VARCHAR(200),                                
@@UALL       AS VARCHAR(20),                                
@@USELECTQURY AS VARCHAR(8000),                                
@@UFROMTABLES AS VARCHAR(2000),                                
@@UWHEREPART  AS VARCHAR(8000),                                
@@UGROUPBY    AS VARCHAR(200),                                
@@USORTBY     VARCHAR(200),                                
@@DATEFILTER AS VARCHAR(500),                                
@@DATEFILTER1 AS VARCHAR(500),                                
@@REPORTFROM AS VARCHAR(1)                                
                                
/* -------------------------------------------------------------------------- */                                
IF @FDATE = " "                                 
BEGIN                                
   SELECT @FDATE = @SDATE                                
END                                
                                
IF @TDATE = " "                                
BEGIN                                
   SELECT @TDATE = @EDATE                                
END                                
                                
/* GET FILTER CONDITION ON DATES BASED ON THE VALUE OF @SELECTIONBY */                                
                                
IF @SELECTIONBY = 'VDT'                                
BEGIN                                
   SELECT @@DATEFILTER = " WHERE L.VDT >= '" + @FDATE + " 00:00:00' AND L.VDT <= '" + @TDATE +" 23:59:59'"                                
   SELECT @@DATEFILTER1 = "  VDT >= '" + @FDATE + " 00:00:00' AND VDT <= '" + @TDATE +" 23:59:59'"                                
END                                
ELSE IF @SELECTIONBY = 'EDT'                                
BEGIN                                
   SELECT @@DATEFILTER = " WHERE L.EDT >= '" + @FDATE + " 00:00:00' AND L.EDT <= '" + @TDATE +" 23:59:59'"                                
   SELECT @@DATEFILTER1 = " EDT >= '" + @FDATE + " 00:00:00' AND EDT <= '" + @TDATE +" 23:59:59'"                                
END                                
/* -------------------------------------------------------------------------- */                                     
                                
IF @REPORTNAME = 'CASH BOOK'                                 
BEGIN                                
                                
   IF UPPER(@SORTBY) = 'VDT'                                
         SELECT @@SORTBY = " ORDER BY VOUDT, L.VTYP, L.VNO"                                
   ELSE IF UPPER(@SORTBY) = 'EDT'                                
       SELECT @@SORTBY = " ORDER BY EFFDT, L.VTYP, L.VNO"                                
    ELSE IF UPPER(@SORTBY) = 'VTYPE'                   
          SELECT @@SORTBY = " ORDER BY L.VTYP, L.VDT, L.VNO"                                
  ELSE IF UPPER(@SORTBY) = 'ACCODE'                            
       SELECT @@SORTBY = " ORDER BY L.CLTCODE, L.VDT, L.VTYP, L.VNO"                                
   ELSE IF UPPER(@SORTBY) = 'ACNAME'                                
        SELECT @@SORTBY = " ORDER BY L.ACNAME, L.VDT, L.VTYP, L.VNO"                                
      ELSE IF UPPER(@SORTBY) = 'BOOKTYPE'                                
            SELECT @@SORTBY = " ORDER BY L.BOOKTYPE, L.VDT, L.VTYP, L.VNO"                                
       ELSE IF UPPER(@SORTBY) = 'VNO'                                
             SELECT @@SORTBY = " ORDER BY L.VNO, L.VDT, L.VTYP"                                
        ELSE IF UPPER(@SORTBY) = 'DRCR'                                
              SELECT @@SORTBY = " ORDER BY L.DRCR, L.VDT, L.VTYP, L.VNO"                                
         ELSE IF UPPER(@SORTBY) = 'AMOUNT'                                
               SELECT @@SORTBY = " ORDER BY L.VAMT, L.VDT, L.VTYP, L.VNO"                                
                                
                                
                                
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                                 
      BEGIN       
      
print 'vin111'                               
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, L.VTYP, L.VNO, VDT=CONVERT(VARCHAR,VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), l.CLTCODE, ACNAME=ISNULL(ACNAME,''), VOUDT=L.VDT, EFFDT=L.EDT, DEBIT = (CASE WHEN UPPER(L.DRCR) = 'D' THEN  VAMT  ELSE  0 END 
  
   
),CREDIT = (CASE WHEN UPPER(L.DRCR) = 'C' THEN  VAMT   ELSE  0 END), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.DRCR"           
        SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE FROM Sledger_Vw_Final (NOLOCK) WHERE CLTCODE = '" + @FCODE + "' AND " + @@DATEFILTER1 + " AND VTYP <> 18) T, Sledger_Vw_Final L "          
        SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "'  AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE "SELECT @@GROUPBY = " " END  --ELSE                      
  
    
          
 ELSE IF UPPER(@STATUSID) = 'REGION'                            
      BEGIN                                
                           
PRINT UPPER(@STATUSNAME)       
print 'vin222'                           
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, L.VTYP, L.VNO, VDT=CONVERT(VARCHAR,VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), L.CLTCODE, ACNAME=ISNULL(L.ACNAME,''), VOUDT=L.VDT, EFFDT=L.EDT, DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN  CAMT  ELSE  0 E
  
    
ND),CREDIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT   ELSE  0 END), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.DRCR"                                
        SELECT @@FROMTABLES = " FROM Sledger_Vw_Final L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN sacmast_view A  (NOLOCK) ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK), (SELECT BRANCH_CODE FROM BSEDB_AB.DBO.REGION WHERE UPPER(REGIONCODE) 
  
= '" +    
 @STATUSNAME + "') R "                                
        SELECT @@WHEREPART = @@DATEFILTER + " AND L2.VTYPE <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT <> '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AN
  
    
D L.VNO = L2.VNO AND L.LNO = L2.LNO AND UPPER(COSTNAME) = UPPER(R.BRANCH_CODE) AND L2.COSTCODE = C.COSTCODE "                                
        SELECT @@GROUPBY = " "                                 
        SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                                  
  PRINT @@SELECTQURY+@@FROMTABLES+@@WHEREPART+@@GROUPBY                                       
      END                              
ELSE                      
      BEGIN                      
                     
      
print 'vin333'      
PRINT @@SELECTQURY                 
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, L.VTYP, L.VNO, VDT=CONVERT(VARCHAR,VDT,103), EDT = CONVERT(VARCHAR,L.EDT,103), CLTCODE=L2.CLTCODE, ACNAME=ISNULL(L.ACNAME,''),VOUDT=L.VDT, EFFDT=L.EDT, DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'D' THEN  CAMT  
 
E    
LSE  0 END), CREDIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT   ELSE  0 END),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L2.DRCR"                                
  SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE, LNO FROM Sledger_Vw_Final (NOLOCK)  WHERE CLTCODE = '" + @FCODE + "'  AND " + @@DATEFILTER1 + " AND VTYP <> 18) T, LEDGER2 L2, COSTMAST C, Sledger_Vw_Final L "             
        SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = '" + @FCODE + "' AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "'  AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L.LNO = T.LNO AND 
  
    
L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.BOOKTYPE= L.BOOKTYPE AND L2.LNO = L.LNO AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "           
SELECT @@GROUPBY = " "        
PRINT @@SELECTQURY + @@FROMTABLES+ @@WHEREPART+@@GROUPBY                           
      END                                
END                                
                                
IF @REPORTNAME = 'BANK BOOK'                                 
BEGIN                                
   IF UPPER(@SORTBY) = 'VDT'                                
         SELECT @@SORTBY = " ORDER BY VOUDT, L.VTYP, L.VNO"                                
   ELSE IF UPPER(@SORTBY) = 'EDT'                                
         SELECT @@SORTBY = " ORDER BY EFFDT, L.VTYP, L.VNO"                                
    ELSE IF UPPER(@SORTBY) = 'VTYPE'                                
          SELECT @@SORTBY = " ORDER BY L.VTYP, L.VDT, L.VNO"                                
  ELSE IF UPPER(@SORTBY) = 'ACCODE'                                
       SELECT @@SORTBY = " ORDER BY L.CLTCODE, L.VDT, L.VTYP, L.VNO"                                
   ELSE IF UPPER(@SORTBY) = 'ACNAME'                                
        SELECT @@SORTBY = " ORDER BY L.ACNAME, L.VDT, L.VTYP, L.VNO"                                
      ELSE IF UPPER(@SORTBY) = 'BOOKTYPE'                            
            SELECT @@SORTBY = " ORDER BY L.BOOKTYPE, L.VDT, L.VTYP, L.VNO"                                
       ELSE IF UPPER(@SORTBY) = 'VNO'                                
             SELECT @@SORTBY = " ORDER BY L.VNO, L.VDT, L.VTYP"                                
        ELSE IF UPPER(@SORTBY) = 'DRCR'                                
              SELECT @@SORTBY = " ORDER BY L.DRCR, L.VDT, L.VTYP, L.VNO"                                
         ELSE IF UPPER(@SORTBY) = 'AMOUNT'                                
               SELECT @@SORTBY = " ORDER BY L.VAMT, L.VDT, L.VTYP, L.VNO"                                
                                
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                                 
      BEGIN                                
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EFFDT = L.EDT, EDT = CONVERT(VARCHAR,L.EDT,103), CLTCODE, ACNAME, L.VNO, L.VTYP, VOUDT=L.VDT, DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTY
  
    
P=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), DEBIT = (CASE WHEN UPPER(L.DRCR) = 'C' THEN  VAMT  ELSE  0 END), CREDIT = (CASE WHEN UPPER(L.DRCR) ='D' THEN  VAMT   ELSE  0 END),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','')  "    
  
    
      
        
          
        SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE FROM Sledger_Vw_Final (NOLOCK)  WHERE CLTCODE = '" + @FCODE + "'  AND " + @@DATEFILTER1 + " AND VTYP <> 18) T, Sledger_Vw_Final L "                                
         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE "                           
         SELECT @@GROUPBY = " "                                
      END                                
   ELSE                                
      BEGIN                                
/*         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EFFDT = L.EDT, EDT = CONVERT(VARCHAR,L.EDT,103), L2.CLTCODE, ACNAME, L.VNO, L.VTYP, VOUDT=L.VDT, DDNO= ISNULL((SELECT DDNO FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VT
  
Y    
      
                           
P=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT  ELSE  0 END), CREDIT = (CASE WHEN UPPER(L2.DRCR) ='D' THEN  CAMT   ELSE  0 END), L.NARRATION "                                
         SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYP, VNO, BOOKTYPE FROM Sledger_Vw_Final WHERE CLTCODE = '" + @FCODE + "') T, LEDGER2 L2, COSTMAST C, Sledger_Vw_Final L " */                                
/*         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE 
  
    
     
         
          
                              
AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE NOT IN ( SELECT BRCONTROLAC FROM BRANCHACCOUNTS ) " */                                
/*         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE 
  
    
      
        
              
                                
AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE =L.CLTCODE "                                 
         SELECT @@GROUPBY = " " */                                
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EFFDT = L.EDT, EDT = CONVERT(VARCHAR,L.EDT,103), L2.CLTCODE, ACNAME, L.VNO, L.VTYP, VOUDT=L.VDT, DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.
  
    
VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), DEBIT = (CASE WHEN UPPER(L2.DRCR) = 'C' THEN  CAMT  ELSE  0 END), CREDIT = (CASE WHEN UPPER(L2.DRCR) ='D' THEN  CAMT   ELSE  0 END), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','')"
  
    
      
        
          
          
        SELECT @@FROMTABLES = " FROM (SELECT DISTINCT VTYPE, VNO, BOOKTYPE FROM LEDGER2 (NOLOCK)  WHERE CLTCODE = '" + @FCODE + "' ) T, LEDGER2 L2 (NOLOCK) , COSTMAST C (NOLOCK) , Sledger_Vw_Final L  (NOLOCK) "               
/*         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYP AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND L2.BOOKTYPE = L.BOOKTYPE 
  
    
      
        
          
                                 
AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE NOT IN ( SELECT BRCONTROLAC FROM BRANCHACCOUNTS ) " */                                
         SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE<> 'HOCTRL' AND L2.CLTCODE <> '" + @FCODE + "' AND L.VTYP = T.VTYPE AND L.VNO = T.VNO AND L.BOOKTYPE = T.BOOKTYPE AND L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.LNO = L.LNO AND
  
    
 L2.BOOKTYPE = L.BOOKTYPE AND RTRIM(COSTNAME) = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE " SELECT @@GROUPBY = " "  END              
END                                
  
IF @REPORTNAME = 'GL'                                 
BEGIN                                
                                
/* ASSIGN FROM AND TO ACCOUNT CODES. */                                
   IF @FCODE = ""                                 
      BEGIN                                
         SELECT @FCODE = (SELECT MIN(CLTCODE) FROM sacmast_view WHERE ACCAT <> 4)                                
END                                             
   IF @TCODE = ""                                 
      BEGIN                                
         SELECT @TCODE = (SELECT MAX(CLTCODE) FROM sacmast_view WHERE ACCAT <> 4)                                
END              
                                
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                                 
      BEGIN                                
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO, NARRATION = REPLACE
  
    
(REPLACE(L.NARRATION,'''',''),'""','') , DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L.CLTCODE , A.LONGNAME,VDT, L.VTYP, L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EDT =
  
    
 CONVERT(VARCHAR,L.EDT,103), ACCAT "                                
SELECT @@FROMTABLES = " FROM Sledger_Vw_Final L  (NOLOCK) LEFT OUTER JOIN sacmast_view A  (NOLOCK) ON L.CLTCODE = A.CLTCODE ,VMAST V  (NOLOCK) "              
SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND VTYP = VTYPE AND A.CLTCODE = L.CLTCODE AND A.ACCAT <> '4' "                                
SELECT @@GROUPBY = " "                                
SELECT @@SORTBY = " ORDER BY L.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                                  
      END                              
 ELSE IF UPPER(@STATUSID) = 'REGION'                            
      BEGIN                                
PRINT 'VIN'                 
PRINT UPPER(@STATUSNAME)                            
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END), L.VNO,NARRATION = REPLAC
  
    
E(REPLACE(L.NARRATION,'''',''),'""','') , DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L2.CLTCODE , A.LONGNAME,VDT, L.VTYP, L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EDT
  
    
 = CONVERT(VARCHAR,L.EDT,103), ACCAT "                                
SELECT @@FROMTABLES = " FROM Sledger_Vw_Final L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN sacmast_view A  (NOLOCK) ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK), (SELECT BRANCH_CODE FROM BSEDB_AB.DBO.REGION WHERE UPPER(REGIONCODE) = '" +  
  
   
@STATUSNAME + "') R   "              
SELECT @@WHEREPART = @@DATEFILTER + " AND L2.VTYPE <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT <> '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO 
  
    
= L2.VNO AND L.LNO = L2.LNO AND UPPER(COSTNAME) = UPPER(R.BRANCH_CODE) AND L2.COSTCODE = C.COSTCODE "                            
      
SELECT @@GROUPBY = " "          
              
        SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                                  
  PRINT @@SELECTQURY+@@FROMTABLES+@@WHEREPART+@@GROUPBY                                       
      END                              
   ELSE                                
      BEGIN                                
                                
        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END), L.VNO,NARRATION = REPLAC
  
    
E(REPLACE(L.NARRATION,'''',''),'""','') , DDNO=ISNULL((SELECT MAX(DDNO) FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''), L2.CLTCODE , A.LONGNAME,VDT, L.VTYP, L.BOOKTYPE, VDT = CONVERT(VARCHAR,L.VDT,103), EDT
  
    
= CONVERT(VARCHAR,L.EDT,103), ACCAT "                                
        SELECT @@FROMTABLES = " FROM Sledger_Vw_Final L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN sacmast_view A  (NOLOCK) ON L2.CLTCODE = A.CLTCODE, COSTMAST C (NOLOCK)   "                                
        SELECT @@WHEREPART = @@DATEFILTER + " AND L2.VTYPE <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT <> '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AN
  
    
D L.VNO = L2.VNO AND L.LNO = L2.LNO AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "                      SELECT @@GROUPBY = " "                          SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"            
  
    
      
      
        
          
          PRINT @@SELECTQURY+@@FROMTABLES+@@WHEREPART+@@GROUPBY                                       
      END                                
END                                
                                
IF @REPORTNAME = 'PARTYLEDGER'                                
BEGIN                                
                                
 SELECT @@SORTBY = " VOUDT, L.VTYP DESC, L.VNO"                                 
 IF UPPER(@SORTBY) = 'VDT'                                
    SELECT @@SORTBY = " VOUDT, L.VTYP DESC, L.VNO"                 
   ELSE IF UPPER(@SORTBY) = 'EDT'                                
           SELECT @@SORTBY = " EFFDT, L.VTYP DESC, L.VNO"                                 
                                
 IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                                 
 SELECT @@SORTBY = " L.CLTCODE," + @@SORTBY                                
 ELSE                                
 SELECT @@SORTBY = " L2.CLTCODE," + @@SORTBY                                
                                
 IF UPPER(RTRIM(@GROUPBY)) = 'FAMILY'                                
    SELECT @@SORTBY = " ORDER BY CM.FAMILY, " + @@SORTBY                                
 ELSE IF UPPER(RTRIM(@GROUPBY)) = 'SUBBROKER'                                
       SELECT @@SORTBY = " ORDER BY C1.SUB_BROKER, " + @@SORTBY                                
                                
 IF LEFT(@@SORTBY,6) <> ' ORDER'                                 
    SELECT @@SORTBY = " ORDER BY " + @@SORTBY                                
                                      
   IF UPPER(RTRIM(@GROUPBY)) = 'FAMILY'                                
   BEGIN                                
      IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                                 
         BEGIN                                
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SE
  
    
LECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, C
  
    
ONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                               SELECT @@FROMTABLES = " FROM Sledger_Vw_Final L (NOLOCK)  LEFT OUTER JOIN sacmast_view A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST, MSAJAG.DBO.CLIENTMASTER C
  
M "       
     
         
          
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = A.CLTCODE AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE AND L.CLTCODE = CM.PARTY_CODE"                             
  
   
            SELECT @@GROUPBY = " "                                
         END                                
      ELSE                                
         BEGIN                                
                                
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SE
  
    
LECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CO
  
    
NVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                            SELECT @@FROMTABLES = " FROM Sledger_Vw_Final L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2 (NOLOCK)  LEFT OUTER JOIN sacmast_view A ON L2.CLTCODE = A.CLTCODE, COSTM
  
AST C     
(NOLOCK) , MSAJAG.DBO.CLIENTMASTER CM   (NOLOCK)  "                                  
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT = '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE A
  
    
ND L.VNO = L2.VNO AND L.LNO = L2.LNO  AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE = CM.PARTY_CODE "                                       
          SELECT @@GROUPBY = " "                                 
                                
         END                                  
   END                                
   ELSE IF UPPER(RTRIM(@GROUPBY)) = 'SUBBROKER'                                
   BEGIN                                
      IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                                 
      BEGIN                                
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SE
  
    
LECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CO
  
    
NVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                              SELECT @@FROMTABLES = " FROM Sledger_Vw_Final L  (NOLOCK) LEFT OUTER JOIN sacmast_view A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST, " + RTRIM(@FLD1) + ".DBO.CL
  
IENT1     
C1 (NOLOCK) , " + RTRIM(@FLD1) + ".DBO.CLIENT2 C2  (NOLOCK) "                                
           SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = A.CLTCODE AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE AND L.CLTCODE = C2.PARTY_CODE AND C2.CL_CODE = C1.CL_CODE " 
  
    
      
        
         
             SELECT @@GROUPBY = " "                                
         END                                
      ELSE                                
         BEGIN                                
            SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SE
  
    
LECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CO
  
    
NVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                    SELECT @@FROMTABLES = " FROM Sledger_Vw_Final L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2 (NOLOCK)  LEFT OUTER JOIN sacmast_view A ON L2.CLTCODE = A.CLTCODE, COSTMAST C (N
  
OLOCK)    
 ,  " + RTRIM(@FLD1) + ".DBO.CLIENT1 C1 (NOLOCK) , " + RTRIM(@FLD1) + ".DBO.CLIENT2 C2  (NOLOCK) "                    SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP =
  
    
 V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT = '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.VNO = L2.VNO AND L.LNO = L2.LNO  AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE AND L2.CLTCODE = C2.PARTY_CODE AND C2.CL_C
  
    
ODE = C1.CL_CODE "                                
           SELECT @@GROUPBY = " "                                
         END                                  
   END                                
   ELSE                                
   BEGIN                                
   IF UPPER(@STATUSID) = 'BROKER' OR UPPER(@STATUSID) = 'BRANCH'                                 
   BEGIN                                
      IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                                 
         BEGIN                                
         SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELEC
  
    
T MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVE
  
    
RT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                            SELECT @@FROMTABLES = " FROM Sledger_Vw_Final L  (NOLOCK) LEFT OUTER JOIN sacmast_view A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST  (NOLOCK) "                      
  
          
        
          
  SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L.CLTCODE = A.CLTCODE AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE "                                
            SELECT @@GROUPBY = " "                                
         END                                
      ELSE                                
         BEGIN                                
                                
           SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SEL
  
    
ECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''),NARRATION = REPLACE(REPLACE(L.NARRATION,'''',''),'""','') , L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CON
  
    
VERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                            SELECT @@FROMTABLES = " FROM Sledger_Vw_Final L  (NOLOCK) ,VMAST V (NOLOCK) , LEDGER2 L2  (NOLOCK) LEFT OUTER JOIN sacmast_view A ON L2.CLTCODE = A.CLTCODE, COSTMA
  
ST C (    
NOLOCK)   "                                
          
            SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND L2.CLTCODE >= '" + @FCODE + "' AND L2.CLTCODE <= '" + @TCODE + "' AND L.VTYP = V.VTYPE AND A.CLTCODE = L2.CLTCODE AND A.ACCAT = '4' AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE A
  
    
ND L.VNO = L2.VNO AND L.LNO = L2.LNO  AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "                                     SELECT @@GROUPBY = " "                                
            SELECT @@SORTBY = " ORDER BY L2.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                                
                                
                               
         END                                
   END                                
   ELSE                                
   IF UPPER(@STATUSID) = 'SUB_BROKER'                                
   BEGIN                                
      SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT M
  
    
AX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), L.NARRATION, L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDI
  
    
FF(D,L.EDT,GETDATE()) "                      SELECT @@FROMTABLES = " FROM Sledger_Vw_Final L  (NOLOCK) LEFT OUTER JOIN sacmast_view A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST (NOLOCK) , MSAJAG.DBO.CLIENT1 C1 (NOLOCK) , MSAJAG.DBO.CLIENT2 C2  (NOLOCK) "           
  
          
      
        
          
               
      SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.CLTCODE = C2.PARTY_CODE AND C2.CL_CODE = C1.CL_CODE AND UPPER(SUB_BROKER) = UPPER(@STATUSNAME) AND L.VTY
  
    
P = VTYPE "              SELECT @@GROUPBY = " "                END                     ELSE                     BEGIN                        SELECT @@SELECTQURY = "SELECT L.BOOKTYPE, VOUDT=L.VDT, EFFDT=L.EDT, ISNULL(SHORTDESC,'') SHORTDESC, DRAMT=(CASE WH
  
    
EN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),  CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END), L.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=L.VNO AND L1.VTYP=L.VTYP AND L1.BOOKTYPE=L.BOOKTYPE AND L1.LNO = L.LNO),''), L.NAR
  
    
RATION, L.CLTCODE, A.LONGNAME, VTYP, L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT, L.ACNAME, EDIFF=DATEDIFF(D,L.EDT,GETDATE()) "                               SELECT @@FROMTABLES = " FROM Sledger_Vw_Final L  (NOLOCK) LEFT OUTER JOIN AC
  
    
MAST A  (NOLOCK) ON L.CLTCODE = A.CLTCODE , VMAST  (NOLOCK) "                                
      SELECT @@WHEREPART = @@DATEFILTER + " AND L.VTYP <> 18 AND ACCAT = '4' AND L.CLTCODE >= '" + @FCODE + "' AND L.CLTCODE <= '" + @TCODE + "' AND L.VTYP = VTYPE "                                
      SELECT @@GROUPBY = " "                   
   END                                
   END                                
END                                
                                
IF @REPORTNAME = 'MARGINLEDGER'                                
BEGIN                                
   IF @SELECTIONBY = 'VDT'                                
      BEGIN                                
         SELECT @@SORTBY = " ORDER BY L.CLTCODE, VOUDT, L.VTYP DESC, L.VNO"                                
      END                                
   ELSE                                
      BEGIN                                
         SELECT @@SORTBY = " ORDER BY L.CLTCODE, EFFDT, L.VTYP DESC, L.VNO"                                
      END                          
   IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                                 
      BEGIN                                
         SELECT @@SELECTQURY = "SELECT M.BOOKTYPE, VOUDT=M.VDT, EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, DRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'D' THEN AMOUNT ELSE 0 END ), CRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'C' THEN AMOUNT ELSE 0 END ), 
  
    
 M.VNO,DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''), L.NARRATION, M.PARTY_CODE, A.LONGNAME, M.VTYP, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT "
  
    
          
         SELECT @@FROMTABLES = " FROM MARGINLEDGER M (NOLOCK)  LEFT OUTER JOIN Sledger_Vw_Final L  (NOLOCK) ON M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO LEFT OUTER JOIN sacmast_view A  (NOLOCK) ON M.PARTY_CODE = A.CLTCODE , VMA
  
ST V      
(NOLOCK) "                          SELECT @@WHEREPART = @@DATEFILTER + " AND M.PARTY_CODE >= '" + @FCODE + "' AND M.PARTY_CODE <= '" + @TCODE + "' AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE "                                
         SELECT @@GROUPBY = " "                                
         SELECT @@SORTBY = " ORDER BY M.PARTY_CODE, VOUDT, M.VTYP DESC, M.VNO"                                
      END                                
   ELSE                                
      BEGIN                                
                                
         SELECT @@SELECTQURY = "SELECT M.BOOKTYPE, VOUDT=M.VDT, EFFDT=L.EDT, L.ACNAME, ISNULL(SHORTDESC,'') SHORTDESC, DRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'D' THEN AMOUNT ELSE 0 END ), CRMARGIN = (CASE WHEN UPPER(M.DRCR) = 'C' THEN AMOUNT ELSE 0 END ), 
  
    
M.VNO, DDNO= ISNULL((SELECT MAX(DDNO) FROM LEDGER1 L1 WHERE L1.VNO=M.VNO AND L1.VTYP=M.VTYP AND L1.BOOKTYPE=M.BOOKTYPE AND L1.LNO = M.LNO),''), L.NARRATION, M.PARTY_CODE, A.LONGNAME, M.VTYP, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT "
  
    
      
        
          
    SELECT @@FROMTABLES = " FROM Sledger_Vw_Final L, COSTMAST C, MARGINLEDGER M (NOLOCK)  LEFT OUTER JOIN LEDGER2 L2  (NOLOCK) ON M.VTYP = L2.VTYPE AND M.BOOKTYPE = L2.BOOKTYPE AND M.VNO = L2.VNO AND M.LNO = L2.LNO LEFT OUTER JOIN sacmast_view A  (NOLOCK) ON M.PART
  
Y_CODE    
 = A.CLTCODE , VMAST  V (NOLOCK)  "                        SELECT @@WHEREPART = @@DATEFILTER + " AND M.PARTY_CODE >= '" + @FCODE + "' AND M.PARTY_CODE <= '" + @TCODE + "' AND M.VTYP <> 18 AND ACCAT = '4' AND M.VTYP = V.VTYPE AND M.VTYP = L.VTYP AND M.BOOK
  
    
TYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO AND COSTNAME = RTRIM('" + @BRANCH + "') AND L2.COSTCODE = C.COSTCODE "                                     
SELECT @@GROUPBY = " "                                
         SELECT @@SORTBY = " ORDER BY M.PARTY_CODE, VOUDT, L.VTYP DESC, L.VNO"                                
                                
                                          
      END                                
END                                
                                
--PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY                                 
--SELECT @@WHEREPART = @@WHEREPART + " AND L.VTYP IN (15,21) "                                
                                
                                
--IF @STATUSID = 'BROKER'                                 
--PRINT ('SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED ' + @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )                              
EXEC ('SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED ' + @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@SORTBY )         
        
        
SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SEBI_BANK_BOOK_WEEKLY_BALANCES
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[SEBI_BANK_BOOK_WEEKLY_BALANCES]
	@DATE_FROM VARCHAR(11),
	@REPORT_DATE VARCHAR(11),
	@REPORT_TYPE VARCHAR(3) = 'VDT'
AS

--SEBI_BANK_BOOK_WEEKLY_BALANCES_WRAPPER 'MAY 29 2020'


CREATE TABLE #BANK_BOOK_BAL
(
	BANK_CODE VARCHAR(30),
	BANK_IFSC VARCHAR(30),
	BANK_TYPE VARCHAR(10),
	REPORT_DATE DATETIME,
	AMOUNT MONEY,
	BANK_BALANCE MONEY,
	SNO INT IDENTITY(1, 1)
)

DECLARE
	@SDTCUR VARCHAR(11)

SELECT @SDTCUR = CONVERT(VARCHAR(11), SDTCUR, 109) FROM PARAMETER WHERE @DATE_FROM BETWEEN SDTCUR AND LDTCUR
	
	
--SELECT * FROM #BANK_BOOK_BALANCES
IF @REPORT_TYPE = 'VDT'
BEGIN
	INSERT INTO #BANK_BOOK_BAL
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = @DATE_FROM, AMOUNT = SUM(cASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),BANK_BALANCE =  0
	FROM LEDGER L, ACMAST A, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE L.CLTCODE = A.CLTCODE AND ACCAT = 2
	AND A.Cltcode = BANKCODE AND EXCHANGE + SEGMENT = (SELECT EXCHANGE + SEGMENT FROM OWNER)
	AND VDT BETWEEN @SDTCUR AND @DATE_FROM + ' 23:59'
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE

	INSERT INTO #BANK_BOOK_BAL
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109)), AMOUNT = SUM(cASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),BANK_BALANCE =  0
	FROM LEDGER L, ACMAST A, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE L.CLTCODE = A.CLTCODE AND ACCAT = 2
	AND A.Cltcode = BANKCODE AND EXCHANGE + SEGMENT = (SELECT EXCHANGE + SEGMENT FROM OWNER)
	AND VDT BETWEEN DATEADD(D, 1, @DATE_FROM) AND @REPORT_DATE + ' 23:59'
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109))
	ORDER BY B.ACCOUNTNO, CONVERT(DATETIME, CONVERT(VARCHAR(11), VDT, 109))
END
ELSE
BEGIN
	INSERT INTO #BANK_BOOK_BAL
	SELECT BANK_CODE, BANK_IFSC, BANK_TYPE, REPORT_DATE, AMOUNT = SUM(AMOUNT),BANK_BALANCE =  0
	FROM(
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = @DATE_FROM, AMOUNT = SUM(cASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, ACMAST A, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE L.CLTCODE = A.CLTCODE AND ACCAT = 2
	AND A.Cltcode = BANKCODE AND EXCHANGE + SEGMENT = (SELECT EXCHANGE + SEGMENT FROM OWNER)
	AND EDT BETWEEN @SDTCUR AND @DATE_FROM + ' 23:59'
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE
	UNION ALL
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = @DATE_FROM, AMOUNT = SUM(cASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END)
	FROM LEDGER L, ACMAST A, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE L.CLTCODE = A.CLTCODE AND ACCAT = 2
	AND A.Cltcode = BANKCODE AND EXCHANGE + SEGMENT = (SELECT EXCHANGE + SEGMENT FROM OWNER)
	AND EDT >= @SDTCUR AND VDT < @SDTCUR
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE ) A
	GROUP BY BANK_CODE, BANK_IFSC, BANK_TYPE, REPORT_DATE

	INSERT INTO #BANK_BOOK_BAL
	SELECT BANK_CODE = B.ACCOUNTNO, BANK_IFSC = BANK_IFSC, BANK_TYPE = PURPOSE, REPORT_DATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), EDT, 109)), AMOUNT = SUM(cASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END),BANK_BALANCE =  0
	FROM LEDGER L, ACMAST A, MSAJAG..BANK_PURPOSE_MASTER B
	WHERE L.CLTCODE = A.CLTCODE AND ACCAT = 2
	AND A.Cltcode = BANKCODE AND EXCHANGE + SEGMENT = (SELECT EXCHANGE + SEGMENT FROM OWNER)
	AND EDT BETWEEN DATEADD(D, 1, @DATE_FROM) AND @REPORT_DATE + ' 23:59'
	GROUP BY B.ACCOUNTNO, BANK_IFSC, PURPOSE, CONVERT(DATETIME, CONVERT(VARCHAR(11), EDT, 109))
	ORDER BY B.ACCOUNTNO, CONVERT(DATETIME, CONVERT(VARCHAR(11), EDT, 109))
END

INSERT INTO #BANK_BOOK_BAL
SELECT BANK_CODE, BANK_IFSC, BANK_TYPE, CAL_DATES, AMOUNT = 0, BANK_BALANCE = 0 FROM
(
SELECT * FROM
(SELECT DISTINCT BANK_CODE, BANK_IFSC, BANK_TYPE FROM #BANK_BOOK_BAL) B , CAL_DATES C
) A
WHERE NOT EXISTS(SELECT BANK_CODE FROM #BANK_BOOK_BAL B1 WHERE A.BANK_CODE = B1.BANK_CODE AND A.CAL_DATES = B1.REPORT_DATE)


--UPDATE B SET B.BANK_BALANCE = B1.BANK_BALANCE FROM #BANK_BOOK_BAL B,
--(SELECT BANK_CODE,BANK_IFSC, BANK_TYPE, REPORT_DATE, AMOUNT,
--SUM (AMOUNT) OVER (ORDER BY BANK_CODE, REPORT_DATE) AS BANK_BALANCE
--FROM #BANK_BOOK_BAL) B1
--WHERE B.BANK_CODE = B1.BANK_CODE AND B.REPORT_DATE = B1.

UPDATE B SET BANK_BALANCE = (SELECT SUM(AMOUNT) FROM #BANK_BOOK_BAL B1 WHERE B.BANK_CODE = B1.BANK_CODE AND B1.SNO <= B.SNO) FROM #BANK_BOOK_BAL B

SELECT * FROM #BANK_BOOK_BAL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SEBIPOFILEGEN
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[SEBIPOFILEGEN]
(
	@VTYP VARCHAR(2),
	@FROMDATE VARCHAR(12),
	@TODATE VARCHAR(12),
	@VNOFROM VARCHAR(12),
	@VNOTO VARCHAR(12),
	@BANKCODE VARCHAR(12),	
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(7),
	@FILETYPE VARCHAR(4),
	@PRINTFLAG CHAR(2),
	@ACCESS_FR CHAR(2) = 'SO'
)

AS
	
	DECLARE
		@@SQL VARCHAR(MAX)
		
	SET @@SQL = ''
	
	SELECT @@SQL = @@SQL + "	SELECT "
	SELECT @@SQL = @@SQL + "		L1.DDDT, "
	SELECT @@SQL = @@SQL + "		L.VNO, "
	SELECT @@SQL = @@SQL + "		ISNULL(DD,0) DD, "
	SELECT @@SQL = @@SQL + "		ISNULL(DDNO,'') DDNO, "
	SELECT @@SQL = @@SQL + "		VAMT = ISNULL(L.VAMT,0), "
	SELECT @@SQL = @@SQL + "		L.DRCR, "
	SELECT @@SQL = @@SQL + "		L.CLTCODE, "
	SELECT @@SQL = @@SQL + "		L.ACNAME, "
	SELECT @@SQL = @@SQL + "		CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), "
	SELECT @@SQL = @@SQL + "		L.NARRATION, "
	SELECT @@SQL = @@SQL + "		PRINTEDFLAG = ISNULL(CHQPRINTED,0), "
	SELECT @@SQL = @@SQL + "		L1.MICRNO, "
	SELECT @@SQL = @@SQL + "		L.BOOKTYPE, "
	SELECT @@SQL = @@SQL + "		HOPAYMODE = PAYMODE, "			
	SELECT @@SQL = @@SQL + "		M.ACCNO "
	SELECT @@SQL = @@SQL + "	FROM "	
	SELECT @@SQL = @@SQL + "		ACCOUNT.DBO.SEBIPAYOUT_ALL S (NOLOCK) "
	SELECT @@SQL = @@SQL + "		LEFT OUTER JOIN MULTIBANKID M (NOLOCK) ON S.PARTYCODE = M.CLTCODE AND M.DEFAULTBANK = 1, "	
	SELECT @@SQL = @@SQL + "		LEDGER L (NOLOCK), "
	SELECT @@SQL = @@SQL + "		LEDGER1 L1 (NOLOCK), "
	SELECT @@SQL = @@SQL + "		( "
	SELECT @@SQL = @@SQL + "		SELECT "
	SELECT @@SQL = @@SQL + "			VNO, "
	SELECT @@SQL = @@SQL + "			VTYP, "
	SELECT @@SQL = @@SQL + "			BOOKTYPE "
	SELECT @@SQL = @@SQL + "		FROM "
	SELECT @@SQL = @@SQL + "			LEDGER (NOLOCK) "
	SELECT @@SQL = @@SQL + "		WHERE "
	SELECT @@SQL = @@SQL + "			CLTCODE = '" + @BANKCODE + "' "
	SELECT @@SQL = @@SQL + "			AND VTYP = " + @VTYP + " "
	SELECT @@SQL = @@SQL + "			AND VNO BETWEEN '" + @VNOFROM + "' AND '" + @VNOTO + "' "
	SELECT @@SQL = @@SQL + "			AND VDT BETWEEN '" + @FROMDATE + "' AND '" + @TODATE + " 23:59:59' "
	SELECT @@SQL = @@SQL + "		) B "
	SELECT @@SQL = @@SQL + "	WHERE "
	SELECT @@SQL = @@SQL + "		L.VTYP = " + @VTYP + " "
	SELECT @@SQL = @@SQL + "		AND L.VTYP = L1.VTYP "
	SELECT @@SQL = @@SQL + "		AND L.BOOKTYPE = L1.BOOKTYPE "
	SELECT @@SQL = @@SQL + "		AND L.VNO = L1.VNO "
	SELECT @@SQL = @@SQL + "		AND L.LNO = L1.LNO "		
	SELECT @@SQL = @@SQL + "		AND L.VTYP = B.VTYP "
	SELECT @@SQL = @@SQL + "		AND L.BOOKTYPE = B.BOOKTYPE "
	SELECT @@SQL = @@SQL + "		AND L.VNO = B.VNO "
	SELECT @@SQL = @@SQL + "		AND L.VNO BETWEEN '" + @VNOFROM + "' AND '" + @VNOTO + "' "
	SELECT @@SQL = @@SQL + "		AND L.VDT BETWEEN '" + @FROMDATE + "' AND '" + @TODATE + " 23:59:59' "	
	SELECT @@SQL = @@SQL + "		AND S.PARTYCODE = L.CLTCODE "	
	SELECT @@SQL = @@SQL + "		AND L.CLTCODE <> '" + @BANKCODE + "' "
	SELECT @@SQL = @@SQL + "		AND S.VNO = L.VNO "	
	SELECT @@SQL = @@SQL + "		AND S.PAYMODE = '" + @FILETYPE + "' "
	
	IF @PRINTFLAG = 'FP'
		SELECT @@SQL = @@SQL + "		AND CHQPRINTED = 0 "
	ELSE
		SELECT @@SQL = @@SQL + "		AND CHQPRINTED > 0 "

	SELECT @@SQL = @@SQL + "		AND EXCHANGE = '" + @EXCHANGE + "' "
	SELECT @@SQL = @@SQL + "		AND SEGMENT = '" + @SEGMENT + "' "
	SELECT @@SQL = @@SQL + "	ORDER BY "
	SELECT @@SQL = @@SQL + "		L.VNO "
	
	PRINT (@@SQL)
	EXEC (@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTION_QUERIES_PROC
-- --------------------------------------------------


--EXEC SELECTION_QUERIES_PROC 'BROKER','%','REGION','%'
CREATE PROC SELECTION_QUERIES_PROC
@STATUSID VARCHAR(15),
@STATUSNAME VARCHAR(10),
@SELECTON VARCHAR(15),
@SEARCH VARCHAR(10),
@FROMAC VARCHAR(10) = '0000000000',
@TOAC VARCHAR(10) = 'ZZZZZZZZZZ'
AS

DECLARE
@@SELECTIONQUERY AS VARCHAR(500),
@@FINALQUERY AS VARCHAR(500)

DECLARE CUR_SELECTION_PARAMETER CURSOR FOR
	SELECT 
		SELECTIONQUERY
	FROM
		SELECTION_QUERIES_TABLE
	WHERE
		STATUSID = @STATUSID
		AND SELECTON = @SELECTON		
        
        OPEN CUR_SELECTION_PARAMETER
        
        FETCH NEXT FROM CUR_SELECTION_PARAMETER
        INTO @@SELECTIONQUERY

WHILE @@FETCH_STATUS = 0        
BEGIN
	SELECT @@FINALQUERY = REPLACE(@@SELECTIONQUERY, 'STATUSNAME', '''' + @STATUSNAME + '''')
	SELECT @@FINALQUERY = REPLACE(@@FINALQUERY, 'FROMAC', '''' + @FROMAC + '''')
	SELECT @@FINALQUERY = REPLACE(@@FINALQUERY, 'TOAC', '''' + @TOAC + '''')
	SELECT @@FINALQUERY = REPLACE(@@FINALQUERY, 'SEARCH', '''' + @SEARCH + '''')

	FETCH NEXT FROM CUR_SELECTION_PARAMETER
	INTO @@SELECTIONQUERY
END

CLOSE CUR_SELECTION_PARAMETER
DEALLOCATE CUR_SELECTION_PARAMETER

PRINT @@FINALQUERY
EXEC (@@FINALQUERY)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTVOUCHERDETAILS
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 06/24/2004 8:32:35 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 05/10/2004 5:29:35 PM ******/  
/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 04/07/2003 12:28:25 PM ******/  
CREATE PROC SELECTVOUCHERDETAILS 
@VTYP   VARCHAR(2),  
@BOOKTYPE  VARCHAR(2),  
@FROMDATE  VARCHAR(12),  
@TODATE  VARCHAR(12),  
@VNOFROM  VARCHAR(12),  
@VNOTO   VARCHAR(12),  
@BANKCODE  VARCHAR(12)   
  
AS  
  
DECLARE  
@@SELECTQURY  AS VARCHAR(8000),  
@@FROMTABLES  AS VARCHAR(2000),  
@@WHEREPART   AS VARCHAR(8000),  
@@SORTBY      AS VARCHAR(200)  
  
   
IF @VNOFROM <> '' AND @VNOTO <> ''   
   BEGIN   
   SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "'    
  AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "'    
   AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "  
   END  
ELSE  
   BEGIN  
  SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "'    
 AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "  
   END         
  
IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'    
   BEGIN  
 SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' 
AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "  
 SELECT @@WHEREPART = @@WHEREPART + " AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  CLTCODE <> '" + @BANKCODE + "'"   
   END  
ELSE  
   BEGIN  
 SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'" 
 SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO "  
   END   
  
SELECT @@WHEREPART = @@WHEREPART   
  
SELECT @@SELECTQURY = " SELECT DISTINCT L.VNO,ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO 
  
AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE   
AND PARTY_CODE = CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION ,PRINTEDFLAG = ISNULL(CHQPRINTED,0) , MICRNO ,L.BOOKTYPE"  
  
SELECT @@SORTBY = " ORDER BY L.VNO "  
      
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )   
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTVOUCHERDETAILS_NEW_FP
-- --------------------------------------------------



/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS_NEW_FP    SCRIPT DATE: 10/20/2005 12:19:54 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS_NEW_FP    SCRIPT DATE: 08/29/2005 5:57:25 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 12/16/2003 12:59:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 04/07/2003 12:28:25 PM ******/
CREATE PROC SELECTVOUCHERDETAILS_NEW_FP

@VTYP 		VARCHAR(2),
@BOOKTYPE 	VARCHAR(2),
@FROMDATE 	VARCHAR(12),
@TODATE 	VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO 		VARCHAR(12),
@BANKCODE 	VARCHAR(12) ,
@BANKNAME      VARCHAR(50),
@VTYPE1 	VARCHAR(2),
@BRANCHCODE VARCHAR(12)


AS

DECLARE
@@SELECTQURY 	AS VARCHAR(8000),
@@FROMTABLES 	AS VARCHAR(2000),
@@WHEREPART  	AS VARCHAR(8000),
@@SORTBY     	AS VARCHAR(200)

 
IF @VNOFROM <> '' AND @VNOTO <> '' 
   BEGIN 
 	 SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "'  
		AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "'  
		 AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
   END
ELSE
   BEGIN
	 SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "'  
	AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
   END							

IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'  
   BEGIN
	SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO /*AND L1.DDNO='0' */AND L1.CHQPRINTED=0 AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
	SELECT @@WHEREPART = @@WHEREPART + " /*AND L1.DDNO='0' */AND L1.CHQPRINTED=0 AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' " 
--	SELECT @@WHEREPART = @@WHEREPART + "  AND L1.DDNO=0 "
--	SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
   END
ELSE
   BEGIN
	SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
	SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO "
   END 

IF @VTYPE1 = '98'
BEGIN
  SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
END
ELSE IF @VTYPE1 = '90'
BEGIN
  SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
END
ELSE
BEGIN
  SELECT @@WHEREPART = @@WHEREPART
END

SELECT @@SELECTQURY = " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO 
AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE 
AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION ,PRINTEDFLAG = ISNULL(CHQPRINTED,0) , MICRNO ,L.BOOKTYPE"

SELECT @@SORTBY = " ORDER BY L.VNO "
				
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTVOUCHERDETAILS_NEW_RP
-- --------------------------------------------------



/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS_NEW_RP    SCRIPT DATE: 10/20/2005 12:19:54 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS_NEW_RP    SCRIPT DATE: 08/29/2005 5:57:26 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 12/16/2003 12:59:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 04/07/2003 12:28:25 PM ******/
CREATE PROC SELECTVOUCHERDETAILS_NEW_RP

@VTYP 		VARCHAR(2),
@BOOKTYPE 	VARCHAR(2),
@FROMDATE 	VARCHAR(12),
@TODATE 	VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO 		VARCHAR(12),
@BANKCODE 	VARCHAR(12) ,
@BANKNAME      VARCHAR(50),
@VTYPE1	VARCHAR(2),
@BRANCHCODE VARCHAR(12)


AS

DECLARE
@@SELECTQURY 	AS VARCHAR(8000),
@@FROMTABLES 	AS VARCHAR(2000),
@@WHEREPART  	AS VARCHAR(8000),
@@SORTBY     	AS VARCHAR(200)

 
IF @VNOFROM <> '' AND @VNOTO <> '' 
   BEGIN 
 	 SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "'  
		AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "'  
		 AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
   END
ELSE
   BEGIN
	 SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "'  
	AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
   END							

IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'  
   BEGIN
	SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.DDNO<>'0' AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
	SELECT @@WHEREPART = @@WHEREPART + " AND L1.DDNO<>'0' AND L1.CHQPRINTED > 0 AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' " 
--	SELECT @@WHEREPART = @@WHEREPART + "  AND L1.DDNO=0 "
--	SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
   END
ELSE
   BEGIN
	SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
	SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO "
   END 

IF @VTYPE1 = '98'
BEGIN
  SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
END
ELSE IF @VTYPE1 = '90'
BEGIN
  SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
END
ELSE
BEGIN
  SELECT @@WHEREPART = @@WHEREPART
END

SELECT @@SELECTQURY = " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO 
AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE 
AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION ,PRINTEDFLAG = ISNULL(CHQPRINTED,0) , MICRNO ,L.BOOKTYPE"

SELECT @@SORTBY = " ORDER BY L.VNO "
				
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SELECTVOUCHERDETAILS_UPD
-- --------------------------------------------------



/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS_UPD    SCRIPT DATE: 10/20/2005 12:19:54 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS_UPD    SCRIPT DATE: 08/29/2005 5:57:26 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 12/16/2003 12:59:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.SELECTVOUCHERDETAILS    SCRIPT DATE: 04/07/2003 12:28:25 PM ******/
CREATE PROC SELECTVOUCHERDETAILS_UPD

@VTYP 		VARCHAR(2),
@BOOKTYPE 	VARCHAR(2),
@FROMDATE 	VARCHAR(12),
@TODATE 	VARCHAR(12),
@VNOFROM 	VARCHAR(12),
@VNOTO 		VARCHAR(12),
@BANKCODE 	VARCHAR(12) ,
@BANKNAME      VARCHAR(50),
@VTYPE1	VARCHAR(2),
@BRANCHCODE VARCHAR(12),
@NEWPRINTFLAG VARCHAR(2)


AS

DECLARE
@@SELECTQURY 	AS VARCHAR(8000),
@@FROMTABLES 	AS VARCHAR(2000),
@@WHEREPART  	AS VARCHAR(8000),
@@SORTBY     	AS VARCHAR(200)

 
IF @VNOFROM <> '' AND @VNOTO <> '' 
   BEGIN 
 	 SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "'  
		AND L.VNO >= '" + @VNOFROM + "'  AND L.VNO <= '" + @VNOTO + "'  
		 AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
   END
ELSE
   BEGIN
	 SELECT @@WHEREPART = " WHERE  L.VTYP = '" + @VTYP + "'  
	AND  L.VDT >= '" + @FROMDATE + " 00:00:00' AND L.VDT <= '" + @TODATE +" 23:59:59' "
   END							

IF @VTYP = '2'  OR @VTYP = '3' OR @VTYP = '5'  OR @VTYP = '16'  OR @VTYP = '17'  OR @VTYP =  '20'  OR @VTYP = '19' OR  @VTYP = '1' OR  @VTYP = '4' OR  @VTYP = '22' OR  @VTYP = '23'  
   BEGIN
	SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L1.DDNO>'0' AND L.LNO = L1.LNO, ( SELECT DISTINCT VTYP, BOOKTYPE, VNO FROM LEDGER WHERE  CLTCODE = '" + @BANKCODE + "' AND VTYP = '" + @VTYP + "' AND VDT >= '" + @FROMDATE + " 00:00:00' AND VDT <= '" + @TODATE + " 23:59:59' ) T "
	IF @NEWPRINTFLAG = 'FP'
		SELECT @@WHEREPART = @@WHEREPART + " AND L1.CHQPRINTED = 0 "
	IF @NEWPRINTFLAG = 'RP'
		SELECT @@WHEREPART = @@WHEREPART + " AND L1.CHQPRINTED > 0 "
	SELECT @@WHEREPART = @@WHEREPART + " AND L1.DDNO>'0' AND L.VTYP = T.VTYP AND L.BOOKTYPE = T.BOOKTYPE AND L.VNO = T.VNO AND  L.CLTCODE <> '" + @BANKCODE + "' AND DD = 'C' " 
--	SELECT @@WHEREPART = @@WHEREPART + "  AND L1.DDNO=0 "
--	SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
   END
ELSE
   BEGIN
	SELECT @@WHEREPART = @@WHEREPART + "  AND L.BOOKTYPE = '" + @BOOKTYPE + "'"
	SELECT @@FROMTABLES = " FROM LEDGER L LEFT OUTER JOIN  LEDGER1 L1  ON L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.VNO = L1.VNO AND L.LNO = L1.LNO AND L1.DDNO>'0' "
   END 

IF @VTYPE1 = '98'
BEGIN
  SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'SETTNO%'  "
END
ELSE IF @VTYPE1 = '90'
BEGIN
  SELECT @@WHEREPART = @@WHEREPART + " AND L.NARRATION LIKE 'ADHOC PAYOUT%'  "
END
ELSE
BEGIN
  SELECT @@WHEREPART = @@WHEREPART
END

SELECT @@SELECTQURY = " SELECT DISTINCT L1.DDDT,L.VNO,ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO,VAMT = ISNULL(L.VAMT,0), L.DRCR,CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO 
AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE ) ELSE L.CLTCODE END) ,0), ACNAME = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 THEN (SELECT ACNAME FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE 
AND PARTY_CODE = L.CLTCODE) ELSE L.ACNAME END ),0), CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), L.NARRATION ,PRINTEDFLAG = ISNULL(CHQPRINTED,0) , MICRNO ,L.BOOKTYPE"

SELECT @@SORTBY = " ORDER BY L.VNO "
				
PRINT  (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY ) 
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP
-- --------------------------------------------------
  
CREATE PROC SP @spName VARCHAR(25)AS               
Select * from sysobjects where name Like '%' + @spName + '%' and xtype='P' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_ADDBRANCH_EXECUTE
-- --------------------------------------------------


--INSERT INTO DELSEGMENT SELECT * FROM GUNAVATTA.MSAJAG.DBO.DELSEGMENT
  /****** OBJECT:  STORED PROCEDURE DBO.SP_ADDBRANCH_EXECUTE    SCRIPT DATE: 01/15/2005 4:39:22 PM ******/  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.SP_ADDBRANCH_EXECUTE    SCRIPT DATE: 12/16/2003 2:21:39 PM ******/  
  
  
CREATE PROC SP_ADDBRANCH_EXECUTE  
@STRSQL VARCHAR(8000)  
AS  
 PRINT @STRSQL  
 EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_ADDCLIENT_EXECUTE
-- --------------------------------------------------


--INSERT INTO DELSEGMENT SELECT * FROM GUNAVATTA.MSAJAG.DBO.DELSEGMENT
 /****** OBJECT:  STORED PROCEDURE DBO.SP_ADDCLIENT_EXECUTE    SCRIPT DATE: 01/15/2005 4:39:23 PM ******/  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.SP_ADDCLIENT_EXECUTE    SCRIPT DATE: 12/16/2003 2:21:39 PM ******/  
  
CREATE PROC SP_ADDCLIENT_EXECUTE  
@STRSQL VARCHAR(8000)  
AS  
 PRINT @STRSQL  
 EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_alterdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_creatediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_dropdiagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagramdefinition
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagramdefinition
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_helpdiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_helpdiagrams
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_LEDGER_SB_PRN1
-- --------------------------------------------------
CREATE PROCEDURE SP_LEDGER_SB_PRN1(@fdate as varchar(11),@Tdate as varchar(11),@sbcode as varchar(11),@with_opnbal as varchar(1))                     
AS                    
                    
SET NOCOUNT ON                    
                    
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                    
                    
/*                
Exec SP_LEDGER_SB_PRN1 'Apr  1 2006','Jan 19 2007','ZC','Y'             
declare @fdate as varchar(11),@Tdate as varchar(11),@sbcode as varchar(11),@with_opnbal as varchar(1)                    
set @fdate='Apr  1 2006'                    
set @tdate='Dec 31 2006'                    
set @sbcode='ZC'                    
set @with_opnbal = 'Y'                    
*/                
/*                
declare @fdate as varchar(11),@Tdate as varchar(11),@fcode as varchar(11),@Tcode as varchar(11),@MVNO AS VARCHAR(15),@with_opnbal as varchar(1)                    
set @fdate='Dec  1 2004'                    
set @tdate='Nov 30 2005'                    
set @fcode='28000001'                    
set @tcode='28999999'                    
set @with_opnbal = 'N'                    
*/                
        
select *,flag=' ' into #ledgera  from Intranet.risk.dbo.ledger_format                       
                    
if @with_opnbal='Y'                     
begin                    
 insert into #ledgera                    
 select coname='MCXSX',cltcode,acname=space(200),vdt=@fdate,vtyp='18',shortdesc='OPENEN',        
 vno=replace(convert(varchar(10),convert(datetime,@fdate),102),'.','')+'0000',        
 narration='Opening Balance',                    
 Debit=case when         
 sum(case when drcr='D' then vamt else -vamt end) > 0 then sum(case when drcr='D' then vamt else -vamt end) else 0 end,                    
 Credit=case when         
 sum(case when drcr='C' then vamt else -vamt end) > 0 then sum(case when drcr='C' then vamt else -vamt end) else 0 end,Flag='Y'          
 from ledger a (nolock)        
 where vdt >= (select sdtcur from parameter where sdtcur<= @fdate and ldtcur >= @fdate+' 23:59:59')        
 and vdt < @fdate+' 00:00:00'                    
 and cltcode in (select code from Intranet.risk.dbo.Ledger010909)--select pcode from Intranet.risk.dbo.pcode_temp--(select pcode from Temp_CLI_BSE)           
 group by cltcode        
    
end        
        
 insert into #ledgera                    
 select coname='MCXSX',cltcode,substring(acname,1,200),vdt,vtyp,shortdesc,vno,substring(a.narration,1,200),                   
 Debit=(case when drcr='D' then vamt else 0 end),                    
 Credit=(case when drcr='C' then vamt else 0 end),Flag='Y'from ledger a (nolock),                   
 (select vtype,shortdesc from dbo.vmast ) b                     
 where a.vtyp=b.vtype and vdt >=@fdate+' 00:00:00' and vdt < @tdate+' 23:59:59'                    
 and cltcode in (select code from Intranet.risk.dbo.Ledger010909)--select pcode from Intranet.risk.dbo.pcode_temp---(select pcode from Temp_CLI_BSE)           
          
 update #ledgera set flag='N' where vdt < @fdate             
         
 delete from #ledgera where flag='N'          
 update #ledgera set acname = b.acname from acmast b (nolock) where #ledgera.cltcode=b.cltcode        
                
--update #ledgera set acname = b.long_name from client_Details b                     
--where b.party_Code=#ledgera.cltcode                 
                
update #ledgera set cltcode=ltrim(rtrim(cltcode))                
update #ledgera set acname=ltrim(rtrim(acname))                
--update #ledgera set acname=substring(acname,1,40)+replicate(char(255),(40-len(Acname)))                
update #ledgera set acname=substring(acname,1,40)+replicate(' ',(40-len(Acname)))                
            
            
                
select *,tdt=convert(varchar(11),vdt,103) from #ledgera where debit+credit <> 0                 
order by cltcode,coname,vno

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_renamediagram
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.sp_upgraddiagrams
-- --------------------------------------------------

	CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_VOUCHERREPORT
-- --------------------------------------------------


CREATE   PROCEDURE SP_VOUCHERREPORT
 ( @REPTYPE VARCHAR(2), @FROMDATE VARCHAR(11), @TODATE VARCHAR(11), @FROMBANKCODE VARCHAR(10), 
  @TOBANKCODE VARCHAR(10), @FROMCLIENTID VARCHAR(10), @TOCLIENTID VARCHAR(10), @STATUSID VARCHAR(12), @STATUSNAME VARCHAR(12) )
AS
DECLARE @STRSQL AS VARCHAR(1000)
IF  @STATUSID <> 'BRANCH'
BEGIN
-- **** OTHER THAN BRANCH LOGIN.
 IF @REPTYPE = '1'
  BEGIN
--  ****  CHEQUE IS CANCELLED.
  SET @STRSQL = "SELECT C.DDNO, A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, " + 
   " A.DRCR, A.VAMT, CONVERT(VARCHAR(11), C.DDDT, 109) CDT, A.NARRATION FROM LEDGER A" + 
   " INNER JOIN (SELECT VNO, CLTCODE, ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = 16 AND DRCR = 'D' " 
   IF  @FROMBANKCODE <> '' 
    BEGIN
     SET @STRSQL = @STRSQL + " AND (CLTCODE > = ' " + @FROMBANKCODE + "' AND CLTCODE < = '" + @TOBANKCODE + "')"
    END
   
  SET @STRSQL = @STRSQL + " ) D ON A.VNO = D.VNO AND A.VTYP = D.VTYP AND A.BOOKTYPE = D.BOOKTYPE " +
   " INNER JOIN LEDGER1 C ON A.VNO = C.VNO AND A.VTYP = C.VTYP AND A.BOOKTYPE = C.BOOKTYPE " +
   " WHERE A.VNO <> '' AND A.VTYP = 16 AND A.DRCR = 'C' AND A.VDT > = '" + @FROMDATE + "' AND A.VDT < = '" + @TODATE + " 23:59:59'" --TEST
   IF @FROMCLIENTID <> ''
    BEGIN
     SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "')" 
    END
  SET @STRSQL = @STRSQL + " GROUP BY C.DDNO, A.VTYP, A.CLTCODE, A.VNO, A.VDT, A.ACNAME, A.DRCR, A.VAMT, C.DDDT, A.NARRATION ORDER BY A.VNO, A.VDT, A.DRCR DESC "
  END 
 ELSE IF @REPTYPE = '2' 
  BEGIN
--  ****  CHEQUE IS RETURNED.
  SET @STRSQL = "SELECT C.DDNO, A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, " +
   " A.VAMT, CONVERT(VARCHAR(11), C.DDDT, 109) CDT, A.NARRATION FROM LEDGER A " +
   " INNER JOIN (SELECT VNO, CLTCODE, ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = 17 AND DRCR = 'C' " 
   IF @FROMBANKCODE <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (CLTCODE > = '" + @FROMBANKCODE + "' AND CLTCODE < = '" + @TOBANKCODE + "')" 
   END 
  SET @STRSQL = @STRSQL + " ) D ON A.VNO = D.VNO AND A.VTYP = D.VTYP AND A.BOOKTYPE = D.BOOKTYPE " +
   " INNER JOIN LEDGER1 C ON A.VNO = C.VNO AND A.VTYP = C.VTYP AND A.BOOKTYPE = C.BOOKTYPE " +
   " WHERE A.VNO <> '' AND A.VTYP = 17 AND A.DRCR = 'D' AND A.VDT > = '" + @FROMDATE + " 00:00:00'" +
   " AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMCLIENTID <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "')" 
   END
  SET @STRSQL = @STRSQL + " GROUP BY C.DDNO, A.VTYP, A.CLTCODE, A.VNO, A.VDT, A.ACNAME, A.DRCR, A.VAMT, C.DDDT, A.NARRATION " +
    "ORDER BY A.VNO, A.VDT, A.DRCR DESC "
  END
 ELSE IF @REPTYPE = '4' 
  BEGIN
--  **** MARGIN BANK RECEIVED.
  SET @STRSQL = "SELECT LEDGER.NARRATION, A.BOOKTYPE, A.VTYP, A.VNO, A.PARTY_CODE CLTCODE,  " +
   "CONVERT(VARCHAR(11), A.VDT, 109) VDT, B.ACNAME, A.AMOUNT VAMT, A.DRCR, C.DDNO, CONVERT(VARCHAR(11), C.DDDT, 109) CDT " +
   "FROM LEDGER INNER JOIN MARGINLEDGER A ON LEDGER.VNO = A.VNO AND LEDGER.VTYP = A.VTYP AND LEDGER.BOOKTYPE = A.BOOKTYPE " +
   "INNER JOIN LEDGER1 C ON A.VNO = C.VNO AND A.VTYP = C.VTYP AND A.BOOKTYPE = C.BOOKTYPE " +
   "INNER JOIN ACMAST B ON A.PARTY_CODE = B.CLTCODE WHERE A.VTYP = 19 AND A.VDT > = '" + @FROMDATE + " 00:00:00'" +
   " AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMBANKCODE <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMBANKCODE + "' AND A.PARTY_CODE < = '" + @TOBANKCODE + "')"     
   END
   IF @FROMCLIENTID <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMCLIENTID + "' AND A.PARTY_CODE < = '" + @TOCLIENTID + "')"
   END
 
  SET @STRSQL = @STRSQL + " GROUP BY A.BOOKTYPE, A.VTYP, A.VNO,  A.PARTY_CODE, A.VDT, B.ACNAME, A.AMOUNT, A.DRCR, C.DDNO, C.DDDT, LEDGER.NARRATION"
  END
 ELSE IF @REPTYPE = '7' 
  BEGIN
--  **** JOURNAL VOUCHER.
  SET @STRSQL = "SELECT  A.VTYP,  A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, " +
   "A.VAMT, A.NARRATION FROM LEDGER A WHERE A.VNO <> '' AND A.VTYP = 8  " +
   "AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' "
  
   /*IF(@FROMBANKCODE <> "") 
    --@STRSQL = @STRSQL + " AND (CLTCODE > = '" & TRIM(STRBANKCODE) & "' AND CLTCODE < = '" & TRIM(STRTOBANKCODE) & "')"     
   END IF
  
   IF(TRIM(STRFROMCLIENTID) <> "") 
    'STRSQL = STRSQL + " AND (A.CLTCODE > = '" & TRIM(STRFROMCLIENTID) & "' AND A.CLTCODE < = '" & TRIM(STRTOCLIENTID) & "') " 
   END IF */
  SET @STRSQL = @STRSQL + " GROUP BY  A.VTYP,  A.CLTCODE, A.VNO, A.VDT, A.ACNAME, A.DRCR, A.VAMT,  A.NARRATION " +
   "ORDER BY A.VNO, A.VDT, A.DRCR DESC "
  END
 ELSE IF @REPTYPE = '9' 
  BEGIN
--  **** DEBIT NOTE.
  SET @STRSQL = "SELECT  A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, A.VAMT, " +
   "CONVERT(VARCHAR(11), A.CDT, 109) CDT, B.POBANKNAME, B.POBANKCODE, A.NARRATION " +
   "FROM LEDGER A INNER JOIN ACMAST B ON A.CLTCODE = B.CLTCODE WHERE A.VTYP = 6  " +
   "AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' "
   
   IF @FROMBANKCODE <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMBANKCODE + "' AND A.CLTCODE < = '" + @TOBANKCODE + "')" 
   END
  
   IF @FROMCLIENTID <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "') " 
   END
  SET @STRSQL = @STRSQL + " ORDER BY A.VNO, A.VDT, A.DRCR DESC"
  END
 ELSE IF @REPTYPE = '10' 
  BEGIN
--  **** CREDIT NOTE.
  SET @STRSQL = "SELECT  A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, A.VAMT, " +
   "CONVERT(VARCHAR(11), A.CDT, 109) CDT, B.POBANKNAME, B.POBANKCODE, A.NARRATION " +
   "FROM LEDGER A INNER JOIN ACMAST B ON A.CLTCODE = B.CLTCODE WHERE A.VTYP = 7  " +
   "AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMBANKCODE <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMBANKCODE + " AND A.CLTCODE < = '" + @TOBANKCODE + "')"
   END
  
   IF @FROMCLIENTID <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "') " 
   END
  SET @STRSQL = @STRSQL + " ORDER BY A.VNO, A.VDT, A.DRCR DESC"
  END
 ELSE IF @REPTYPE = '11' 
  BEGIN
--  **** CONTRA ENTRY.
  SET @STRSQL = "SELECT  A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, A.VAMT, " +
   "CONVERT(VARCHAR(11), A.CDT, 109) CDT, B.POBANKNAME, B.POBANKCODE, A.NARRATION " +
   "FROM LEDGER A INNER JOIN ACMAST B ON A.CLTCODE = B.CLTCODE WHERE A.VTYP = 5 " +
   "AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMBANKCODE <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMBANKCODE + "' AND A.CLTCODE < = '" + @TOBANKCODE + "')" 
   END
  
   IF @FROMCLIENTID <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "') " 
   END
  SET @STRSQL = @STRSQL + " ORDER BY A.VNO, A.VDT, A.DRCR DESC"
 
  END
 ELSE IF @REPTYPE = '13' 
  BEGIN
--  **** MARGIN BANK REPAYMENT.
  SET @STRSQL = "SELECT LEDGER.NARRATION, A.BOOKTYPE, A.VTYP, A.VNO, A.PARTY_CODE CLTCODE, " +
   "CONVERT(VARCHAR(11), A.VDT, 109) VDT, B.ACNAME, A.AMOUNT VAMT, A.DRCR, C.DDNO, CONVERT(VARCHAR(11), C.DDDT, 109) CDT " +
   "FROM LEDGER INNER JOIN MARGINLEDGER A ON LEDGER.VNO = A.VNO AND LEDGER.VTYP = A.VTYP AND " +
   "LEDGER.BOOKTYPE = A.BOOKTYPE INNER JOIN LEDGER1 C ON A.VNO = C.VNO AND A.VTYP = C.VTYP AND " +
   "A.BOOKTYPE = C.BOOKTYPE INNER JOIN ACMAST B ON A.PARTY_CODE = B.CLTCODE WHERE A.VTYP = 20 "
   IF @FROMBANKCODE <> '' 
  BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMBANKCODE + "' AND A.PARTY_CODE < = '" + @TOBANKCODE + "')"     
   END
   IF @FROMCLIENTID <> ''
   BEGIN 
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMCLIENTID + "' AND A.PARTY_CODE < = '" + @TOCLIENTID + "')"
   END
 
  SET @STRSQL = @STRSQL + " GROUP BY A.BOOKTYPE, A.VTYP, A.VNO,  A.PARTY_CODE, A.VDT, B.ACNAME, A.AMOUNT, A.DRCR, 
   C.DDNO,  C.DDDT, LEDGER.NARRATION"
  END
 ELSE IF @REPTYPE = '14'  
  BEGIN
--  **** MARGIN CASH RECEIVED.  
  SET @STRSQL = "SELECT LEDGER.NARRATION, A.BOOKTYPE, A.VTYP, A.VNO, A.PARTY_CODE CLTCODE, " +
   "CONVERT(VARCHAR(11), A.VDT, 109) VDT, B.ACNAME, A.AMOUNT VAMT, A.DRCR  FROM LEDGER " +
   "INNER JOIN MARGINLEDGER A ON LEDGER.VNO = A.VNO AND LEDGER.VTYP = A.VTYP AND LEDGER.BOOKTYPE = A.BOOKTYPE " +
   "INNER JOIN ACMAST B ON A.PARTY_CODE = B.CLTCODE WHERE A.VTYP = 22 "
   IF @FROMBANKCODE <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMBANKCODE + "' AND A.PARTY_CODE < = '" + @TOBANKCODE + "')" 
   END
   IF @FROMCLIENTID <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMCLIENTID + "' AND A.PARTY_CODE < = '" + @TOCLIENTID + "')"
   END
 
  SET @STRSQL = @STRSQL + " GROUP BY A.BOOKTYPE, A.VTYP, A.VNO,  A.PARTY_CODE, A.VDT, B.ACNAME, A.AMOUNT, A.DRCR, LEDGER.NARRATION"
  END
 ELSE IF @REPTYPE = '15' 
  BEGIN
--  **** MARGIN CASH REPAYMENT.
  SET @STRSQL = "SELECT LEDGER.NARRATION, A.BOOKTYPE, A.VTYP, A.VNO, A.PARTY_CODE CLTCODE, " +
   "CONVERT(VARCHAR(11), A.VDT, 109) VDT, B.ACNAME, A.AMOUNT VAMT, A.DRCR  FROM LEDGER " +
   "INNER JOIN MARGINLEDGER A ON LEDGER.VNO = A.VNO AND LEDGER.VTYP = A.VTYP AND LEDGER.BOOKTYPE = A.BOOKTYPE " +
   "INNER JOIN ACMAST B ON A.PARTY_CODE = B.CLTCODE WHERE A.VTYP = 23 "
   IF @FROMBANKCODE <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMBANKCODE + "' AND A.PARTY_CODE < = '" + @TOBANKCODE + "')" 
   END
   IF @FROMCLIENTID <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMCLIENTID + "' AND A.PARTY_CODE < = '" + @TOCLIENTID + "')"
   END
 
  SET @STRSQL = @STRSQL + " GROUP BY A.BOOKTYPE, A.VTYP, A.VNO,  A.PARTY_CODE, A.VDT, B.ACNAME, A.AMOUNT, A.DRCR, LEDGER.NARRATION"
  END
 ELSE IF @REPTYPE = '16'    
  BEGIN
--  **** MARGIN JOURNAL ENTRIES.(VTYP = 24)
  
  SET @STRSQL = "SELECT A.VTYP, A.PARTY_CODE  CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, B.ACNAME, A.DRCR, " +
   " A.AMOUNT VAMT, C.NARRATION FROM MARGINLEDGER A INNER JOIN LEDGER C ON A.VNO = C.VNO AND A.VTYP = C.VTYP " +
   "AND A.BOOKTYPE = C.BOOKTYPE INNER JOIN ACMAST B ON  A.PARTY_CODE = B.CLTCODE " +
   "WHERE A.VNO <> ''  AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' " 
   /*IF(TRIM(STRBANKCODE) <> "") 
    'STRSQL = STRSQL + " AND (CLTCODE > = '" & TRIM(STRBANKCODE) & "' AND CLTCODE < = '" & TRIM(STRTOBANKCODE) & "')"     
   END IF */
  
   IF @FROMCLIENTID <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMCLIENTID + "' AND A.PARTY_CODE < = '" + @TOCLIENTID + "') " 
   END
  SET @STRSQL = @STRSQL + " GROUP BY  A.VTYP, A.PARTY_CODE, A.VNO, A.VDT, B.ACNAME, A.DRCR, A.AMOUNT, C.NARRATION " +
     "ORDER BY A.VNO, A.VDT, A.DRCR DESC "
  END
 ELSE IF @REPTYPE = '19' 
--  **** PAYMENT BANK.
  BEGIN
  SET @STRSQL = "SELECT C.DDNO, A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, A.VAMT, " +
   "CONVERT(VARCHAR(11), C.DDDT, 109) CDT, A.NARRATION FROM LEDGER A INNER JOIN (SELECT VNO, CLTCODE, ACNAME, VTYP, " +
   "BOOKTYPE FROM LEDGER WHERE VTYP = 3 AND DRCR = 'C' "
   IF @FROMBANKCODE <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (CLTCODE > = '" + @FROMBANKCODE + "' AND CLTCODE < = '" + @TOBANKCODE + "')"     
   END
 
   SET @STRSQL = @STRSQL + " ) D ON A.VNO = D.VNO AND A.VTYP = D.VTYP AND A.BOOKTYPE = D.BOOKTYPE INNER JOIN " +
   "LEDGER1 C ON A.VNO = C.VNO AND A.VTYP = C.VTYP AND A.BOOKTYPE = C.BOOKTYPE WHERE A.VNO <> '' " +
   "AND A.VTYP = 3 AND A.DRCR = 'D' AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMCLIENTID <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "')" 
   END
  SET @STRSQL = @STRSQL + " GROUP BY C.DDNO, A.VTYP, A.CLTCODE, A.VNO, A.VDT, A.ACNAME, A.DRCR, A.VAMT, 
     C.DDDT, A.NARRATION ORDER BY A.VNO, A.VDT, A.DRCR DESC "
  END
 ELSE IF @REPTYPE = '20' 
  BEGIN
--  **** PAYMENT CASH.
  SET @STRSQL = "SELECT  A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, A.VAMT,  A.NARRATION FROM LEDGER A INNER JOIN (SELECT VNO, CLTCODE, ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = 4 AND DRCR = 'C' "
   IF @FROMBANKCODE <> '' 
   BEGIN 
    SET @STRSQL = @STRSQL + " AND (CLTCODE > = '" + @FROMBANKCODE + "' AND CLTCODE < = '" + @TOBANKCODE + "')" 
   END
   SET @STRSQL = @STRSQL + " ) D ON A.VNO = D.VNO AND A.VTYP = D.VTYP AND A.BOOKTYPE = D.BOOKTYPE WHERE A.VNO <> '' AND A.VTYP = 4 AND A.DRCR = 'D' AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' " 
   IF @FROMCLIENTID <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "')" 
   END
  SET @STRSQL = @STRSQL + " GROUP BY  A.VTYP, A.CLTCODE, A.VNO, A.VDT, A.ACNAME, A.DRCR, A.VAMT,  A.NARRATION " +
     "ORDER BY A.VNO, A.VDT, A.DRCR DESC "
  END
 ELSE IF @REPTYPE =  '21' 
  BEGIN
--  **** RECEIPT BANK.
  SET @STRSQL = "SELECT C.DDNO, A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, " +
   "A.VAMT, CONVERT(VARCHAR(11), C.DDDT, 109) CDT, A.NARRATION FROM LEDGER A INNER JOIN " +
   "(SELECT VNO, CLTCODE, ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = 2 AND DRCR = 'D' "
   IF @FROMBANKCODE <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (CLTCODE > = '" + @FROMBANKCODE + "' AND CLTCODE < = '" + @TOBANKCODE + "')"     
   END
   SET @STRSQL = @STRSQL + " ) D ON A.VNO = D.VNO AND A.VTYP = D.VTYP AND A.BOOKTYPE = D.BOOKTYPE " +
   "INNER JOIN LEDGER1 C ON A.VNO = C.VNO AND A.VTYP = C.VTYP AND A.BOOKTYPE = C.BOOKTYPE " +
   "WHERE A.VNO <> '' AND A.VTYP = 2 AND A.DRCR = 'C' AND A.VDT > = '" + @FROMDATE + " 00:00:00' " +
   "AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMCLIENTID <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "' )" 
   END
  SET @STRSQL = @STRSQL + " GROUP BY C.DDNO, A.VTYP, A.CLTCODE, A.VNO, A.VDT, A.ACNAME, A.DRCR, A.VAMT, C.DDDT, A.NARRATION ORDER BY A.VNO, A.VDT, A.DRCR DESC "
  END
 ELSE IF @REPTYPE = '22' 
  BEGIN
--  **** RECEIPT CASH.
  SET @STRSQL = "SELECT  A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, A.VAMT,  A.NARRATION FROM LEDGER A INNER JOIN (SELECT VNO, CLTCODE, ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = 1 AND DRCR = 'D' "
   IF @FROMBANKCODE <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (CLTCODE > = '" + @FROMBANKCODE + "' AND CLTCODE < = '" + @TOBANKCODE + "')" 
   END
   SET @STRSQL = @STRSQL + " ) D ON A.VNO = D.VNO AND A.VTYP = D.VTYP AND A.BOOKTYPE = D.BOOKTYPE WHERE A.VNO <> '' " +
   "AND A.VTYP = 1 AND A.DRCR = 'C' AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMCLIENTID <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "')" 
   END
  SET @STRSQL = @STRSQL + " GROUP BY  A.VTYP, A.CLTCODE, A.VNO, A.VDT, A.ACNAME, A.DRCR, A.VAMT,  A.NARRATION " +
   "ORDER BY A.VNO, A.VDT, A.DRCR DESC "
 
 --ELSE RAISERROR ('50001 : NO VOUCHER TYPE FOUND', 0, 13)
  END
END
ELSE
BEGIN
-- **** BRANCH LOGIN.
 IF @REPTYPE = '1' 
  BEGIN
--  **** WHEN CHEQUE IS CANCELLED.
  SET @STRSQL = "SELECT C.DDNO, A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, " +
   "A.DRCR, A.VAMT, CONVERT(VARCHAR(11), C.DDDT, 109) CDT, A.NARRATION FROM LEDGER A " +
   "INNER JOIN (SELECT VNO, CLTCODE, ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = 16 AND DRCR = 'D' "
   IF @FROMBANKCODE <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (CLTCODE > = '" + @FROMBANKCODE + "' AND CLTCODE < = '" + @TOBANKCODE + "')"
   END
  
  SET @STRSQL = @STRSQL + " ) D ON A.VNO = D.VNO AND A.VTYP = D.VTYP AND A.BOOKTYPE = D.BOOKTYPE " +
   "INNER JOIN ACMAST B ON A.CLTCODE = B.CLTCODE " +
   "INNER JOIN LEDGER1 C ON A.VNO = C.VNO AND A.VTYP = C.VTYP AND A.BOOKTYPE = C.BOOKTYPE " +
   "WHERE A.VNO <> '' AND B.BRANCHCODE = '" + @STATUSNAME + "' AND A.VTYP = 16 AND A.DRCR = 'C' " +
   "AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMCLIENTID <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "')" 
   END
  SET @STRSQL = @STRSQL + " GROUP BY C.DDNO, A.VTYP, A.CLTCODE, A.VNO, A.VDT, A.ACNAME, A.DRCR, A.VAMT, C.DDDT, A.NARRATION  " +
     "ORDER BY A.VNO, A.VDT, A.DRCR DESC "
  END
 ELSE IF @REPTYPE = '2' 
  BEGIN
--  **** WHEN CHEQUE IS RETURNED.(VTYP = 17)
  SET @STRSQL = "SELECT C.DDNO, A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, " +
   ".VAMT, CONVERT(VARCHAR(11), C.DDDT, 109) CDT, A.NARRATION FROM LEDGER A " +
   "NNER JOIN (SELECT VNO, CLTCODE, ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = 17 AND DRCR = 'C' "
   IF @FROMBANKCODE <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (CLTCODE > = '" + @FROMBANKCODE + "' AND CLTCODE < = '" + @TOBANKCODE + "')" 
   END
  SET @STRSQL = @STRSQL + " ) D ON A.VNO = D.VNO AND A.VTYP = D.VTYP AND A.BOOKTYPE = D.BOOKTYPE  " +
   "INNER JOIN ACMAST B ON A.CLTCODE = B.CLTCODE " +
   "INNER JOIN LEDGER1 C ON A.VNO = C.VNO AND A.VTYP = C.VTYP AND A.BOOKTYPE = C.BOOKTYPE  " +
   "WHERE A.VNO <> '' AND B.BRANCHCODE = '" + @STATUSNAME + "' AND A.VTYP = 17 AND A.DRCR = 'D' AND A.VDT > = '" + @FROMDATE + " 00:00:00' " +
   "AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMCLIENTID <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "')" 
   END
  SET @STRSQL = @STRSQL + " GROUP BY C.DDNO, A.VTYP, A.CLTCODE, A.VNO, A.VDT, A.ACNAME, A.DRCR, A.VAMT, C.DDDT, A.NARRATION " +
     "ORDER BY A.VNO, A.VDT, A.DRCR DESC "
  END
 ELSE IF @REPTYPE = '4' 
  BEGIN
--  **** MARGIN BANK RECEIVED.(VTYP = 19)
  SET @STRSQL = "SELECT LEDGER.NARRATION, A.BOOKTYPE, A.VTYP, A.VNO, A.PARTY_CODE CLTCODE,  " +
   "CONVERT(VARCHAR(11), A.VDT, 109) VDT, B.ACNAME, A.AMOUNT VAMT, A.DRCR, C.DDNO, CONVERT(VARCHAR(11), C.DDDT, 109) CDT " +
   "FROM LEDGER INNER JOIN MARGINLEDGER A ON LEDGER.VNO = A.VNO AND LEDGER.VTYP = A.VTYP AND LEDGER.BOOKTYPE = A.BOOKTYPE  " +
   "INNER JOIN LEDGER1 C ON A.VNO = C.VNO AND A.VTYP = C.VTYP AND A.BOOKTYPE = C.BOOKTYPE " +
   "INNER JOIN ACMAST B ON A.PARTY_CODE = B.CLTCODE WHERE B.BRANCHCODE = '" + @STATUSNAME + "' A.VTYP = 19 AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMBANKCODE <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMBANKCODE + "' AND A.PARTY_CODE < = '" + @TOBANKCODE + "')" 
   END
   IF @FROMCLIENTID <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMCLIENTID + "' AND A.PARTY_CODE < = '" + @TOCLIENTID + "')"
   END
 
  SET @STRSQL = @STRSQL + " GROUP BY A.BOOKTYPE, A.VTYP, A.VNO,  A.PARTY_CODE, A.VDT, B.ACNAME, A.AMOUNT, A.DRCR, C.DDNO, C.DDDT, LEDGER.NARRATION"
  
  END
 ELSE IF @REPTYPE = '7' 
  BEGIN
--  **** JOURNAL VOUCHER.(VTYP = 8)
  SET @STRSQL = "SELECT  A.VTYP,  A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, " + 
   "A.VAMT, A.NARRATION FROM LEDGER A INNER JOIN ACMAST B ON A.CLTCODE = B.CLTCODE WHERE A.VNO <> '' " +
   "AND B.BRANCHCODE = '" + @STATUSNAME + "' AND A.VTYP = 8  " +
   "AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' "
  
   /*IF(@FROMBANKCODE <> "") 
    --@STRSQL = @STRSQL + " AND (CLTCODE > = '" & TRIM(STRBANKCODE) & "' AND CLTCODE < = '" & TRIM(STRTOBANKCODE) & "')"     
   END IF
  
   IF(TRIM(STRFROMCLIENTID) <> "") 
    'STRSQL = STRSQL + " AND (A.CLTCODE > = '" & TRIM(STRFROMCLIENTID) & "' AND A.CLTCODE < = '" & TRIM(STRTOCLIENTID) & "') " 
   END IF */
  SET @STRSQL = @STRSQL + " GROUP BY  A.VTYP,  A.CLTCODE, A.VNO, A.VDT, A.ACNAME, A.DRCR, A.VAMT,  A.NARRATION " +
   "ORDER BY A.VNO, A.VDT, A.DRCR DESC "
  END
 ELSE IF @REPTYPE = '9' 
  BEGIN
--  **** DEBIT NOTE.(VTYP = 6)
  SET @STRSQL = "SELECT  A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, A.VAMT, " +
   "CONVERT(VARCHAR(11), A.CDT, 109) CDT, B.POBANKNAME, B.POBANKCODE, A.NARRATION " +
   "FROM LEDGER A INNER JOIN ACMAST B ON A.CLTCODE = B.CLTCODE WHERE B.BRANCHCODE = '" + @STATUSNAME + "' A.VTYP = 6  " +
   "AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' "
   
   IF @FROMBANKCODE <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMBANKCODE + "' AND A.CLTCODE < = '" + @TOBANKCODE + "')"     
   END
  
   IF @FROMCLIENTID <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID +"' ) " 
   END
  SET @STRSQL = @STRSQL + " ORDER BY A.VNO, A.VDT, A.DRCR DESC"
  END
 ELSE IF @REPTYPE = '10'
  BEGIN 
--  **** CREDIT NOTE.(VTYP = 7)
  SET @STRSQL = "SELECT  A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, A.VAMT, " +
   "CONVERT(VARCHAR(11), A.CDT, 109) CDT, B.POBANKNAME, B.POBANKCODE, A.NARRATION " +
   "FROM LEDGER A INNER JOIN ACMAST B ON A.CLTCODE = B.CLTCODE WHERE B.BRANCHCODE = '" + @STATUSNAME + "' A.VTYP = 7   " +
   "AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMBANKCODE <> ''
   BEGIN 
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMBANKCODE + "' AND A.CLTCODE < = '" + @TOBANKCODE + "')" 
   END 
  
   IF @FROMCLIENTID <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "') " 
   END
  SET @STRSQL = @STRSQL + " ORDER BY A.VNO, A.VDT, A.DRCR DESC"
  END
 ELSE IF @REPTYPE = '11' 
  BEGIN
--  **** CONTRA ENTRY. (VTYP = 5)
  SET @STRSQL = "SELECT  A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, A.VAMT, " +
   "CONVERT(VARCHAR(11), A.CDT, 109) CDT, B.POBANKNAME, B.POBANKCODE, A.NARRATION " +
   "FROM LEDGER A INNER JOIN ACMAST B ON A.CLTCODE = B.CLTCODE WHERE B.BRANCHCODE = '" + @STATUSNAME + "' A.VTYP = 5 " +
   "AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMBANKCODE <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMBANKCODE + "' AND A.CLTCODE < = '" + @TOBANKCODE + "')" 
   END
  
   IF @FROMCLIENTID <> '' 
   BEGIN 
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "') " 
   END
  SET @STRSQL = @STRSQL + " ORDER BY A.VNO, A.VDT, A.DRCR DESC"
 
  END
 ELSE IF @REPTYPE = '13' 
  BEGIN
--  **** MARGIN BANK REPAYMENT. (VTYP = 20)
  SET @STRSQL = "SELECT LEDGER.NARRATION, A.BOOKTYPE, A.VTYP, A.VNO, A.PARTY_CODE CLTCODE, " +
   "CONVERT(VARCHAR(11), A.VDT, 109) VDT, B.ACNAME, A.AMOUNT VAMT, A.DRCR, C.DDNO, CONVERT(VARCHAR(11), C.DDDT, 109) CDT  " +
   "FROM LEDGER INNER JOIN MARGINLEDGER A ON LEDGER.VNO = A.VNO AND LEDGER.VTYP = A.VTYP AND " +
   "LEDGER.BOOKTYPE = A.BOOKTYPE INNER JOIN LEDGER1 C ON A.VNO = C.VNO AND A.VTYP = C.VTYP AND " +
   "A.BOOKTYPE = C.BOOKTYPE INNER JOIN ACMAST B ON A.PARTY_CODE = B.CLTCODE WHERE B.BRANCHCODE = '" + @STATUSNAME + "' A.VTYP = 20 "
   IF (@FROMBANKCODE <> "") 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMBANKCODE + "' AND A.PARTY_CODE < = '" + @TOBANKCODE + "' )"
   END
   IF @FROMCLIENTID <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMCLIENTID + "' AND A.PARTY_CODE < = '" + @TOCLIENTID + "')"
   END
 
  SET @STRSQL = @STRSQL + " GROUP BY A.BOOKTYPE, A.VTYP, A.VNO,  A.PARTY_CODE, A.VDT, B.ACNAME, A.AMOUNT, A.DRCR, " +
   "C.DDNO,  C.DDDT, LEDGER.NARRATION"
  END
 ELSE IF @REPTYPE = '14' 
  BEGIN
--  **** MARGIN CASH RECEIVED.(VTYP = 22)  
  SET @STRSQL = "SELECT LEDGER.NARRATION, A.BOOKTYPE, A.VTYP, A.VNO, A.PARTY_CODE CLTCODE,  " +
   "CONVERT(VARCHAR(11), A.VDT, 109) VDT, B.ACNAME, A.AMOUNT VAMT, A.DRCR  FROM LEDGER " +
   "INNER JOIN MARGINLEDGER A ON LEDGER.VNO = A.VNO AND LEDGER.VTYP = A.VTYP AND LEDGER.BOOKTYPE = A.BOOKTYPE " +
   "INNER JOIN ACMAST B ON A.PARTY_CODE = B.CLTCODE WHERE B.BRANCHCODE = '" + @STATUSNAME + "' A.VTYP = 22 "
   IF @FROMBANKCODE <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMBANKCODE + "' AND A.PARTY_CODE < = '" + @TOBANKCODE + "')" 
   END
   IF @FROMCLIENTID <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMCLIENTID + "' AND A.PARTY_CODE < = '" + @TOCLIENTID + "')"
   END
 
  SET @STRSQL = @STRSQL + " GROUP BY A.BOOKTYPE, A.VTYP, A.VNO,  A.PARTY_CODE, A.VDT, B.ACNAME, A.AMOUNT, A.DRCR, LEDGER.NARRATION"
  
  END  
 ELSE IF @REPTYPE = '15' 
  BEGIN
--  **** MARGIN CASH REPAYMENT.
  SET @STRSQL = "SELECT LEDGER.NARRATION, A.BOOKTYPE, A.VTYP, A.VNO, A.PARTY_CODE CLTCODE, " +
   "CONVERT(VARCHAR(11), A.VDT, 109) VDT, B.ACNAME, A.AMOUNT VAMT, A.DRCR  FROM LEDGER " +
   "INNER JOIN MARGINLEDGER A ON LEDGER.VNO = A.VNO AND LEDGER.VTYP = A.VTYP AND LEDGER.BOOKTYPE = A.BOOKTYPE " +
   "INNER JOIN ACMAST B ON A.PARTY_CODE = B.CLTCODE WHERE B.BRANCHCODE = '" + @STATUSNAME + "' A.VTYP = 23 "
   IF @FROMBANKCODE <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMBANKCODE + "' AND A.PARTY_CODE < = '" + @TOBANKCODE + "')" 
   END
   IF @FROMCLIENTID <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.PARTY_CODE > = '" + @FROMCLIENTID + "' AND A.PARTY_CODE < = '" + @TOCLIENTID + "')"
   END
 
  SET @STRSQL = @STRSQL + " GROUP BY A.BOOKTYPE, A.VTYP, A.VNO,  A.PARTY_CODE, A.VDT, B.ACNAME, A.AMOUNT, A.DRCR, LEDGER.NARRATION"
  END
 ELSE IF @REPTYPE = '16'    
  BEGIN
--  **** MARGIN JOURNAL ENTRIES.(VTYP = 24)
  
  SET @STRSQL = "SELECT A.VTYP, A.PARTY_CODE  CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, B.ACNAME, A.DRCR, "+
   " A.AMOUNT VAMT, C.NARRATION FROM MARGINLEDGER A INNER JOIN LEDGER C ON A.VNO = C.VNO AND A.VTYP = C.VTYP " +
   "AND A.BOOKTYPE = C.BOOKTYPE INNER JOIN ACMAST B ON  A.PARTY_CODE = B.CLTCODE AND A.BOOKTYPE = B.BOOKTYPE " +
   "WHERE A.VNO <> '' AND B.BRANCHCODE = '" + @STATUSNAME + "' AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' " 
   /*IF(TRIM(STRBANKCODE) <> "") 
    'STRSQL = STRSQL + " AND (CLTCODE > = '" & TRIM(STRBANKCODE) & "' AND CLTCODE < = '" & TRIM(STRTOBANKCODE) & "')"     
   END IF */
  
   IF @FROMCLIENTID <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "') " 
   END 
  SET @STRSQL = @STRSQL + " GROUP BY  A.VTYP, A.PARTY_CODE, A.VNO, A.VDT, B.ACNAME, A.DRCR, A.AMOUNT, C.NARRATION  " +
     "ORDER BY A.VNO, A.VDT, A.DRCR DESC "
  END
 ELSE IF @REPTYPE = '19' 
  BEGIN
--  **** PAYMENT BANK.
  SET @STRSQL = "SELECT C.DDNO, A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, A.VAMT, " +
   "CONVERT(VARCHAR(11), C.DDDT, 109) CDT, A.NARRATION FROM LEDGER A INNER JOIN (SELECT VNO, CLTCODE, ACNAME, VTYP, " +
   "BOOKTYPE FROM LEDGER WHERE VTYP = 3 AND DRCR = 'C' "
   IF @FROMBANKCODE <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (CLTCODE > = '" + @FROMBANKCODE + "' AND CLTCODE < = '" + @TOBANKCODE + "')" 
   END
 
   SET @STRSQL = @STRSQL + " ) D ON A.VNO = D.VNO AND A.VTYP = D.VTYP AND A.BOOKTYPE = D.BOOKTYPE " +
   "INNER JOIN ACMAST B ON A.CLTCODE = B.CLTCODE INNER JOIN LEDGER1 C ON A.VNO = C.VNO " +
   "AND A.VTYP = C.VTYP AND A.BOOKTYPE = C.BOOKTYPE WHERE A.VNO <> '' AND B.BRANCHCODE = '" + @STATUSNAME + "'" +
   "AND A.VTYP = 3 AND A.DRCR = 'D' AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMCLIENTID <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "' )" 
   END
  SET @STRSQL = @STRSQL + " GROUP BY C.DDNO, A.VTYP, A.CLTCODE, A.VNO, A.VDT, A.ACNAME, A.DRCR, A.VAMT, " +
     "C.DDDT, A.NARRATION ORDER BY A.VNO, A.VDT, A.DRCR DESC "
  END
 ELSE IF @REPTYPE = '20' 
  BEGIN
--  **** PAYMENT CASH.
  SET @STRSQL = "SELECT  A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, A.VAMT,  A.NARRATION " +
   "FROM LEDGER A INNER JOIN (SELECT VNO, CLTCODE, ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = 4 AND DRCR = 'C' "
   IF @FROMBANKCODE <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (CLTCODE > = '" + @FROMBANKCODE + "' AND CLTCODE < = '" + @TOBANKCODE + "')" 
   END 
   SET @STRSQL = @STRSQL + " ) D ON A.VNO = D.VNO AND A.VTYP = D.VTYP AND A.BOOKTYPE = D.BOOKTYPE " +
   "INNER JOIN ACMAST B ON A.CLTCODE = B.CLTCODE WHERE A.VNO <> '' AND B.BRANCHCODE = '" + @STATUSNAME + "'" +
   "AND A.VTYP = 4 AND A.DRCR = 'D' AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' " 
   IF @FROMCLIENTID <> ''  
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "')" 
   END 
  SET @STRSQL = @STRSQL + " GROUP BY  A.VTYP, A.CLTCODE, A.VNO, A.VDT, A.ACNAME, A.DRCR, A.VAMT,  A.NARRATION " +
     "ORDER BY A.VNO, A.VDT, A.DRCR DESC "
  END
 ELSE IF @REPTYPE = '21' 
  BEGIN
--  **** RECEIPT BANK.
  SET @STRSQL = "SELECT C.DDNO, A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, " +
   "A.VAMT, CONVERT(VARCHAR(11), C.DDDT, 109) CDT, A.NARRATION FROM LEDGER A INNER JOIN " +
   "(SELECT VNO, CLTCODE, ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = 2 AND DRCR = 'D' "
   IF @FROMBANKCODE <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (CLTCODE > = '" + @FROMBANKCODE + "' AND CLTCODE < = '" + @TOBANKCODE + "' )"
   END
   SET @STRSQL = @STRSQL + " ) D ON A.VNO = D.VNO AND A.VTYP = D.VTYP AND A.BOOKTYPE = D.BOOKTYPE " +
   "INNER JOIN ACMAST B ON A.CLTCODE = B.CLTCODE " +
   "INNER JOIN LEDGER1 C ON A.VNO = C.VNO AND A.VTYP = C.VTYP AND A.BOOKTYPE = C.BOOKTYPE " +
   "WHERE A.VNO <> '' AND B.BRANCHCODE = '" + @STATUSNAME + "' AND A.VTYP = 2 AND A.DRCR = 'C' AND A.VDT > = '" + @FROMDATE + " 00:00:00' " +
   "AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMCLIENTID <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "')" 
   END
  SET @STRSQL = @STRSQL + " GROUP BY C.DDNO, A.VTYP, A.CLTCODE, A.VNO, A.VDT, A.ACNAME, A.DRCR, A.VAMT, C.DDDT, A.NARRATION ORDER BY A.VNO, A.VDT, A.DRCR DESC "
  END
 ELSE IF @REPTYPE = '22' 
  BEGIN
--  **** RECEIPT CASH.
  SET @STRSQL = "SELECT  A.VTYP, A.CLTCODE, A.VNO, CONVERT(VARCHAR(11), A.VDT, 109) VDT, A.ACNAME, A.DRCR, A.VAMT,  A.NARRATION FROM LEDGER A INNER JOIN (SELECT VNO, CLTCODE, ACNAME, VTYP, BOOKTYPE FROM LEDGER WHERE VTYP = 1 AND DRCR = 'D' "
   IF @FROMBANKCODE <> '' 
   BEGIN
    SET @STRSQL = @STRSQL + " AND (CLTCODE > = '" + @FROMBANKCODE + "' AND CLTCODE < = '" + @TOBANKCODE + "')"     
   END
   SET @STRSQL = @STRSQL + " ) D ON A.VNO = D.VNO AND A.VTYP = D.VTYP AND A.BOOKTYPE = D.BOOKTYPE " +
   " INNER JOIN ACMAST B ON A.CLTCODE = B.CLTCODE WHERE A.VNO <> '' AND B.BRANCHCODE = '" + @STATUSNAME + "'" +
   " AND A.VTYP = 1 AND A.DRCR = 'C' AND A.VDT > = '" + @FROMDATE + " 00:00:00' AND A.VDT < = '" + @TODATE + " 23:59:59' "
   IF @FROMCLIENTID <> ''
   BEGIN
    SET @STRSQL = @STRSQL + " AND (A.CLTCODE > = '" + @FROMCLIENTID + "' AND A.CLTCODE < = '" + @TOCLIENTID + "')" 
   END
  SET @STRSQL = @STRSQL + " GROUP BY  A.VTYP, A.CLTCODE, A.VNO, A.VDT, A.ACNAME, A.DRCR, A.VAMT,  A.NARRATION " +
   "ORDER BY A.VNO, A.VDT, A.DRCR DESC "
 --ELSE RAISERROR ('50001 : NO VOUCHER TYPE FOUND FOR BRANCH.', 0, 13)
 END
END
PRINT @STRSQL
EXECUTE ( @STRSQL )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPA_INSVOUCHERTEMP
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.SPA_INSVOUCHERTEMP    SCRIPT DATE: 06/24/2004 8:32:35 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.SPA_INSVOUCHERTEMP    SCRIPT DATE: 05/10/2004 5:29:35 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.SPA_INSVOUCHERTEMP    SCRIPT DATE: 02/18/2003 10:25:07 AM ******/  
/****** OBJECT:  STORED PROCEDURE DBO.SPA_INSVOUCHERTEMP    SCRIPT DATE: 01/27/2003 9:57:08 PM ******/  
CREATE PROCEDURE SPA_INSVOUCHERTEMP  
 @VNO VARCHAR(20),  
 @VTYPE VARCHAR(2),  
 @BOOKTYPE VARCHAR(2),  
 @BILLFLAG CHAR(1),  
 @COSTFLAG CHAR(1),  
 @SID VARCHAR(20)  
 AS  
DECLARE @@TMPCAT VARCHAR(50),  
@@TMPLNO VARCHAR(3),  
@@TMPCOST VARCHAR(50),  
@@TMPCOSTNAME VARCHAR(50),  
@@TMPEXISTS INTEGER,  
@@TMPCLTCODE VARCHAR(16),  
@@CNO CURSOR  
  
IF @BILLFLAG=1  
BEGIN  
INSERT INTO TEMPBILLDETAILS   
/*  
 SELECT DISTINCT EXCHANGE,M.PARTY_CODE,SETT_NO,SETT_TYPE,M.DRCR,B.AMOUNT,BALAMT,PAYAMOUT= M.AMOUNT,SESSIONID=@SID,M.LLNO,M.LNO,  
 B.DATE,M.DESCRIPTION,BILLBOOKTYPE=B.BOOKTYPE,BILLVTYPE=B.VTYPE,M.LBOOKTYPE,M.LVTYPE,B.VNO   
 FROM MATCHDETAILS M LEFT OUTER JOIN BILLMATCH B ON M.VNO=B.VNO AND M.VTYPE=B.VTYPE AND M.BOOKTYPE= B.BOOKTYPE AND   
 M.LNO=B.LNO AND B.VTYPE=15 WHERE M.LVNO = @VNO AND M.LVTYPE = @VTYPE AND M.LBOOKTYPE = @BOOKTYPE    
 AND M.DESCRIPTION NOT LIKE 'ADVANCES%' */  
  
  
 SELECT DISTINCT EXCHANGE,M.PARTY_CODE,SETT_NO,SETT_TYPE,M.DRCR,B.AMOUNT,BALAMT,PAYAMOUT= M.AMOUNT,SESSIONID=@SID,M.LLNO,M.LNO,  
 B.DATE,M.DESCRIPTION,BILLBOOKTYPE=B.BOOKTYPE,BILLVTYPE=B.VTYPE,M.LBOOKTYPE,M.LVTYPE,B.VNO   
 FROM BILLMATCH B LEFT OUTER JOIN MATCHDETAILS M ON B.VNO=M.VNO AND B.VTYPE=M.VTYPE AND B.BOOKTYPE= M.BOOKTYPE AND   
 B.LNO=M.LNO AND B.PARTY_CODE = M.PARTY_CODE AND B.VTYPE=15  
 WHERE M.LVNO = @VNO AND M.LVTYPE = @VTYPE AND M.LBOOKTYPE = @BOOKTYPE  AND M.DESCRIPTION NOT LIKE 'ADVANCES%'  
END  
  
  
IF @COSTFLAG=1  
BEGIN  
 INSERT INTO TEMPLEDGER2 (VTYPE,VNO,LNO,DRCR,PAIDAMT,COSTCODE,BOOKTYPE,SESSIONID,PARTY_CODE)  
 SELECT DISTINCT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,SESSIONID=@SID,CLTCODE  
 FROM LEDGER2  WHERE VNO= @VNO AND VTYPE=@VTYPE AND BOOKTYPE= @BOOKTYPE  
  
  
 SET @@CNO = CURSOR FOR   
 SELECT DISTINCT LNO,COSTCODE,CLTCODE  
 FROM LEDGER2  WHERE VNO= @VNO  AND VTYPE=@VTYPE AND BOOKTYPE= @BOOKTYPE  
 OPEN @@CNO   
 FETCH NEXT FROM @@CNO INTO @@TMPLNO,@@TMPCOST,@@TMPCLTCODE  
 WHILE @@FETCH_STATUS = 0   
 BEGIN  
  SELECT @@TMPEXISTS = (SELECT COUNT(*) AS CNT FROM BRANCHACCOUNTS WHERE BRCONTROLAC =  @@TMPCLTCODE)  
  IF @@TMPEXISTS = 0  
  BEGIN  
   SELECT @@TMPCAT = (SELECT DISTINCT TOP 1 C.CATEGORY FROM CATEGORY C, COSTMAST M   
   WHERE C.CATCODE = M.CATCODE AND M.COSTCODE=@@TMPCOST)  
   UPDATE TEMPLEDGER2   SET CATEGORY= @@TMPCAT WHERE COSTCODE = @@TMPCOST AND SESSIONID = @SID AND VTYPE=@VTYPE AND BOOKTYPE =@BOOKTYPE AND LNO = @@TMPLNO AND  PARTY_CODE =@@TMPCLTCODE  
  END   
  ELSE   
  BEGIN  
   SELECT @@TMPCAT = 'BRANCH'  
   UPDATE TEMPLEDGER2   SET CATEGORY= 'BRANCH' WHERE COSTCODE = @@TMPCOST AND SESSIONID = @SID AND VTYPE=@VTYPE AND BOOKTYPE =@BOOKTYPE AND LNO = @@TMPLNO AND PARTY_CODE =@@TMPCLTCODE  
  END  
 PRINT @@TMPCOST   
 SELECT @@TMPCOSTNAME = (SELECT DISTINCT TOP 1 M.COSTNAME FROM CATEGORY C, COSTMAST M WHERE C.CATCODE = M.CATCODE AND M.COSTCODE= @@TMPCOST)  
 UPDATE TEMPLEDGER2 SET BRANCH = @@TMPCOSTNAME  WHERE SESSIONID = @SID AND VTYPE=@VTYPE AND BOOKTYPE =@BOOKTYPE AND LNO = @@TMPLNO AND PARTY_CODE = @@TMPCLTCODE AND COSTCODE=@@TMPCOST  
 SELECT @@TMPCAT= ''  
 SELECT @@TMPCOSTNAME =''  
 SELECT @@TMPCLTCODE = ''  
 SELECT @@TMPCOST=''  
 FETCH NEXT FROM @@CNO INTO @@TMPLNO,@@TMPCOST,@@TMPCLTCODE  
 END  
 CLOSE @@CNO  
 DEALLOCATE @@CNO  
  
 DELETE FROM TEMPLEDGER2 WHERE PARTY_CODE IN ( SELECT BRCONTROLAC FROM BRANCHACCOUNTS)  
 UPDATE TEMPLEDGER2 SET COSTFLAG = 'A', ROWID = LNO  
        WHERE UPPER(CATEGORY) = 'BRANCH' AND SESSIONID = @SID AND VTYPE=@VTYPE AND BOOKTYPE =@BOOKTYPE AND VNO= @VNO  
 UPDATE TEMPLEDGER2 SET COSTFLAG = 'A', ROWID = LNO  
        WHERE UPPER(CATEGORY) <> 'BRANCH' AND SESSIONID = @SID AND VTYPE=@VTYPE AND BOOKTYPE =@BOOKTYPE AND VNO= @VNO  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SPDELETEVALAN
-- --------------------------------------------------





/****** OBJECT:  STORED PROCEDURE DBO.SPDELETEVALAN    SCRIPT DATE: 3/1/03 1:30:55 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.SPDELETEVOUCHER    SCRIPT DATE: 02/18/2003 10:37:42 AM ******/
/****** OBJECT:  STORED PROCEDURE DBO.SPDELETEVOUCHER    SCRIPT DATE: 06/05/2002 12:03:48 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.SPDELETEVOUCHER    SCRIPT DATE: 01/04/1980 1:40:43 AM ******/
/****** OBJECT:  STORED PROCEDURE DBO.SPDELETEVOUCHER    SCRIPT DATE: 12/12/2001 6:42:36 PM ******/
/*DELETES A VOUCHER ENTRY FROM LEDGER,LEDGER1,LEDGER3 TABLE  DEPENDING ON THE VTYP PASSED */

CREATE PROCEDURE SPDELETEVALAN
@VTYP  SMALLINT,
@VNO VARCHAR(12),
@BOOKTYPE VARCHAR(2)
AS

DELETE FROM LEDGER    WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE
DELETE FROM LEDGER1  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE
DELETE FROM LEDGER2  WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE
DELETE FROM LEDGER3  WHERE VTYP = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE
DELETE FROM BILLMATCH WHERE VTYPE = @VTYP AND VNO = @VNO AND BOOKTYPE = @BOOKTYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.srpt_Acc_GlReport
-- --------------------------------------------------
                      
/*        
SRPT_ACC_GLREPORT '01/04/2011', '31/03/2012', 'Apr  1 2011', 'May 10 2011', '99988', '99988', 'region', 'ahmedabad', 'ahmedabad','vdt', 'Segment', 'codewise', 'GL',''        
        
*/        
CREATE PROC [dbo].[srpt_Acc_GlReport]                        
 @SDATE VARCHAR(11),            /* AS MMM DD YYYY */                        
 @EDATE VARCHAR(11),            /* AS MMM DD YYYY */                        
 @FDATE VARCHAR(11),            /* AS MMM DD YYYY */                        
 @TDATE VARCHAR(11),            /* AS MMM DD YYYY */                        
 @FCODE VARCHAR(10),                        
 @TCODE VARCHAR(10),                        
 @STATUSID VARCHAR(30),                        
 @STATUSNAME VARCHAR(30),                        
 @BRANCH VARCHAR(10),                        
 @SELECTIONBY VARCHAR(3),                        
 @GROUPBY VARCHAR(10),                        
 @SORTBY VARCHAR(50),                        
 @REPORTNAME VARCHAR(30),                        
 @REPORTOPT VARCHAR(10) = ''                       
                        
AS          
DECLARE                        
 @@OPENDATE AS VARCHAR(11),          
 @@COSTCODE AS SMALLINT,          
 @SHAREDB AS VARCHAR(25),          
 @@SQL AS VARCHAR(1000)          
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                        
                        
SELECT @@OPENDATE = CONVERT(VARCHAR(11),SDTCUR,109) FROM PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR                     
                        
SELECT CLTCODE,VAMT AS OPBAL INTO #OPBAL FROM Sledger_Vw_Final   WHERE 1 =2                        
                  
CREATE TABLE [DBO].[#TEMPTABLE_GL] (                      
  [BOOKTYPE] [CHAR] (2)  NULL ,                      
  [VOUDT1] [VARCHAR] (20) NULL ,                      
  [EFFDT1] [VARCHAR] (20) NULL ,                      
  [SHORTDESC] [CHAR] (6) NULL ,                      
  [DRAMT] [MONEY] NULL ,                      
  [CRAMT] [MONEY] NULL ,                      
  [VNO] [VARCHAR] (12) NULL ,                      
  [NARRATION] [VARCHAR] (234) NULL ,                  
  [DDNO] [VARCHAR] (15) NULL ,                      
  [CLTCODE] [VARCHAR] (10) NOT NULL ,                  
  [LONGNAME] [VARCHAR] (100) NULL ,                  
  [VDT] [DATETIME] NULL ,                        
  [VTYP] [SMALLINT] NULL ,                      
  [ACCAT] [VARCHAR] (30) NULL ,                      
  [OPBAL] [MONEY] NULL ,                      
  [CROSAC] [VARCHAR] (10) NULL ,                      
  [ACNAME] [VARCHAR] (150) NULL ,                   
  [BRANCHCODE] [VARCHAR] (20) NULL ,                  
  [LNO][SMALLINT] NULL,                  
 )              
 SET @SHAREDB = 'MSAJAG'        
 CREATE TABLE #COSTMAST        
 (        
  COSTCODE INT,        
  COSTNAME VARCHAR(50)        
 )        
        
 IF @STATUSID = 'REGION'        
 BEGIN        
  SET @@SQL = 'INSERT INTO #COSTMAST'        
  SET @@SQL = @@SQL + ' SELECT COSTCODE, COSTNAME FROM COSTMAST C,'+ @SHAREDB +'.DBO.REGION R WHERE REGIONCODE = RTRIM('''+@STATUSNAME+''') AND COSTNAME = BRANCH_CODE'        
 END        
        
 IF @STATUSID = 'AREA'        
 BEGIN        
  SET @@SQL = 'INSERT INTO #COSTMAST'        
  SET @@SQL = @@SQL + ' SELECT COSTCODE ,COSTNAME FROM COSTMAST C,'+ @SHAREDB +'.DBO.AREA A WHERE AREACODE = RTRIM('''+@STATUSNAME+''') AND COSTNAME = BRANCH_CODE'        
 END        
        
 IF @STATUSID = 'BRANCH'        
 BEGIN        
  SET @@SQL = 'INSERT INTO #COSTMAST'        
  SET @@SQL = @@SQL + ' SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM('''+@STATUSNAME+''')'        
 END        
 PRINT(@@SQL)          
 EXEC(@@SQL)        
        
        
--select @@costcode=costcode from costmast where costname=@BRANCH          
          
IF @SELECTIONBY = 'VDT'                        
 BEGIN                        
  IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                        
   BEGIN                 
  INSERT INTO #OPBAL            
  SELECT CLTCODE, SUM(OPBAL) FROM                       
  (            
SELECT                        
   CLTCODE,                        
   OPBAL = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)                        
   FROM                        
   Sledger_Vw_Final        
   WHERE                        
    CLTCODE BETWEEN @FCODE AND @TCODE                        
    AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18                    
   GROUP BY             
    CLTCODE             
             
   UNION ALL            
   SELECT                        
    CLTCODE,                        
    OPBAL = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)             
   FROM                        
    Sledger_Vw_Final                         
   WHERE                        
    CLTCODE BETWEEN @FCODE AND @TCODE                        
    AND VDT >= @@OPENDATE AND VDT < @FDATE AND VTYP <> 18                    
   GROUP BY CLTCODE             
   ) A            
   GROUP BY            
    CLTCODE            
   ORDER BY             
    CLTCODE                
                     
                        
  INSERT INTO #TEMPTABLE_GL                        
  SELECT                        
   L.BOOKTYPE,                        
   VOUDT1=L.VDT,                        
   EFFDT1=L.EDT,                        
   ISNULL(SHORTDESC,'') SHORTDESC,                        
   DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                        
   CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                        
   L.VNO,                        
   REPLACE( L.NARRATION,'"','') NARRATION,                        
   DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                        
   L.CLTCODE,                        
   A.LONGNAME,                        
   VDT,                        
   L.VTYP,                        
   ACCAT,                        
   OPBAL=0,                        
   CROSAC='',                        
   A.ACNAME,                  
   A.BRANCHCODE,                        
   L.LNO                        
  FROM                        
   Sledger_Vw_Final  L,                        
   sacmast_view A,                        
   VMAST V                        
  WHERE                        
   L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                        
   AND VTYP = VTYPE                        
   AND L.CLTCODE = A.CLTCODE                        
   AND L.CLTCODE BETWEEN @FCODE AND @TCODE                        
   --AND (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')                        
  ORDER BY                        
   L.CLTCODE,                        
   VOUDT1,                        
   L.VTYP DESC,                        
   L.VNO                        
    END                        
   ELSE                        
    BEGIN               
     INSERT INTO #OPBAL                        
  SELECT                        
   CLTCODE,                        
   SUM(OPBAL) FROM           
   (          
   SELECT L2.CLTCODE ,SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                        
  FROM                        
   LEDGER2 L2,                        
   Sledger_Vw_Final  L        
  WHERE                        
   L2.CLTCODE BETWEEN @FCODE AND @TCODE                        
   AND L.VTYP=L2.VTYPE                        
   AND L.BOOKTYPE=L2.BOOKTYPE                        
   AND L.VNO=L2.VNO                        
   AND L.LNO=L2.LNO               
   --AND L2.COSTCODE = @@costcode                         
   --AND C.COSTNAME = @BRANCH                     
   AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)        
   AND VDT LIKE @@OPENDATE + '%' AND L2.VTYPE = 18                
  GROUP BY L2.CLTCODE                        
          
    UNION ALL          
               
    SELECT                        
     L2.CLTCODE,                        
     SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                        
    FROM                  
     LEDGER2 L2,                        
     Sledger_Vw_Final  L        
    WHERE                        
     L2.CLTCODE BETWEEN @FCODE AND @TCODE                        
     AND L.VTYP=L2.VTYPE                        
     AND L.BOOKTYPE=L2.BOOKTYPE                        
     AND L.VNO=L2.VNO                        
     AND L.LNO=L2.LNO             
 --AND L2.COSTCODE = @@costcode                        
 --AND C.COSTNAME = @BRANCH           
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)                   
     AND VDT >= @@OPENDATE AND VDT < @FDATE AND VTYPE <> 18                        
    GROUP BY L2.CLTCODE                        
    ) T1             
    GROUP BY CLTCODE                        
 ORDER BY CLTCODE                 
          
                        
    INSERT INTO #TEMPTABLE_GL           
    SELECT                        
     L.BOOKTYPE,                        
     VOUDT1=L.VDT,                        
     EFFDT1=L.EDT,                        
     ISNULL(SHORTDESC,'') SHORTDESC,                        
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                        
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                        
     L.VNO,                        
     REPLACE( L.NARRATION,'"','') NARRATION,                        
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                        
     L2.CLTCODE,                        
     A.LONGNAME,                        
     VDT,                        
     L.VTYP,                        
     ACCAT,                        
     OPBAL=0,                        
     CROSAC='',                        
     A.ACNAME,                        
     A.BRANCHCODE,                        
     L.LNO                        
    FROM                        
     Sledger_Vw_Final  L,                        
     VMAST V,                        
     LEDGER2 L2,                        
     sacmast_view A/*,                        
     COSTMAST C*/         
    WHERE                        
     L.VDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                        
     AND L.VTYP = L2.VTYPE                        
     AND  L.VNO = L2.VNO                        
     AND L.LNO = L2.LNO                        
     AND L.BOOKTYPE = L2.BOOKTYPE                        
     AND L2.CLTCODE=A.CLTCODE                        
     AND L.VTYP = V.VTYPE                        
     AND L2.CLTCODE BETWEEN @FCODE AND  @TCODE                        
     AND A.ACCAT <> '4'                        
     --AND COSTNAME = RTRIM(@BRANCH)                        
     --AND L2.COSTCODE = C.COSTCODE           
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)        
     AND  L2.VTYPE <> 18                        
    ORDER BY                        
     L2.CLTCODE,                        
     VOUDT1,                
     L.VTYP DESC,                        
     L.VNO                        
   END                        
 END                        
ELSE                        
 BEGIN                        
  IF RTRIM(@BRANCH) = '' OR RTRIM(@BRANCH) = '%'                        
   BEGIN                        
    INSERT INTO #OPBAL                        
    SELECT                        
     CLTCODE,                        
     SUM(OPBAL) OPBAL                        
    FROM                        
     (                        
      SELECT                        
       CLTCODE,                        
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL                        
      FROM                        
       Sledger_Vw_Final                         
      WHERE                        
       CLTCODE BETWEEN @FCODE AND @TCODE                        
       AND VDT LIKE @@OPENDATE + '%' AND VTYP = 18             
                    
      GROUP BY                        
       CLTCODE              
  UNION ALL                
  SELECT                        
       CLTCODE,                        
       SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END) AS OPBAL                        
      FROM                        
       Sledger_Vw_Final                         
      WHERE                        
       CLTCODE BETWEEN @FCODE AND @TCODE                        
       AND EDT >= @@OPENDATE AND EDT < @FDATE AND VTYP <> 18                        
      GROUP BY                        
       CLTCODE                   
     UNION ALL                        
      SELECT                        
       CLTCODE,                        
       SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END) AS OPBAL                        
      FROM                        
       Sledger_Vw_Final                         
      WHERE                        
       CLTCODE BETWEEN  @FCODE AND  @TCODE                        
       AND VDT < @@OPENDATE                        
       AND EDT >= @@OPENDATE                        
       GROUP BY CLTCODE                        
     ) T                        
    GROUP BY CLTCODE                        
    ORDER BY CLTCODE                        
                        
    INSERT INTO #TEMPTABLE_GL                        
    SELECT                
     L.BOOKTYPE,                        
     VOUDT1=L.VDT,                        
     EFFDT1=L.EDT,                        
     ISNULL(SHORTDESC,'') SHORTDESC,                        
     DRAMT=(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE 0 END),                        
     CRAMT=(CASE WHEN UPPER(L.DRCR) = 'C' THEN VAMT ELSE 0 END),                        
     L.VNO,                        
     REPLACE( L.NARRATION,'"','') NARRATION,                        
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                     
     L.CLTCODE,                        
     A.LONGNAME,                        
     VDT,                        
     L.VTYP,                        
     ACCAT,                        
     OPBAL=0,                        
     CROSAC='',                        
     A.ACNAME,                        
     A.BRANCHCODE,                        
     L.LNO                        
    FROM                        
     Sledger_Vw_Final  L,                        
     sacmast_view A,                        
     VMAST V                        
    WHERE                        
     VTYP = VTYPE                        
     AND A.CLTCODE = L.CLTCODE                        
     AND L.CLTCODE BETWEEN @FCODE AND @TCODE                        
     AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                        
     AND L.VTYP <> 18                        
     --AND (A.ACCAT LIKE '3%'  OR A.ACCAT LIKE '14%'  OR A.ACCAT LIKE '103%')                        
    ORDER BY                        
     L.CLTCODE,                        
     VOUDT1,                        
     L.VTYP DESC,                        
     L.VNO                        
   END                        
  ELSE                        
   BEGIN               
print 'nse'                   
    INSERT INTO #OPBAL                        
    SELECT                        
     CLTCODE,                        
     SUM(OPBAL) OPBAL                        
    FROM                        
     (                        
      SELECT                        
       L2.CLTCODE,                        
       SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                        
      FROM                        
       LEDGER2 L2,                        
       Sledger_Vw_Final  L --, COSTMAST C                      
      WHERE                        
       VDT LIKE @@OPENDATE + '%' AND VTYPE = 18                
       AND L.VNO=L2.VNO                        
       AND L.VTYP=L2.VTYPE                        
       AND L.BOOKTYPE=L2.BOOKTYPE                        
       AND L.LNO=L2.LNO             
  --AND L2.COSTCODE = @@costcode                        
        --AND C.COSTNAME = @BRANCH                      
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)        
        AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                        
      GROUP BY                        
       L2.CLTCODE                        
      UNION ALL                        
   SELECT                        
       L2.CLTCODE,                        
       SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) AS OPBAL                        
      FROM                        
       LEDGER2 L2,                        
       Sledger_Vw_Final  L    --, COSTMAST C                                 
      WHERE                        
       EDT >= @@OPENDATE AND EDT < @FDATE AND VTYPE <> 18                
       AND L.VNO=L2.VNO                        
       AND L.VTYP=L2.VTYPE               
       AND L.BOOKTYPE=L2.BOOKTYPE                        
       AND L.LNO=L2.LNO                  
       --AND L2.COSTCODE = @@costcode                      
       --AND C.COSTNAME = @BRANCH                      
       AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)        
       AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                        
      GROUP BY                        
       L2.CLTCODE                        
      UNION ALL                
       SELECT                        
        L2.CLTCODE,                        
        SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END) AS OPBAL                        
       FROM                        
        LEDGER2 L2,                        
        Sledger_Vw_Final  L , COSTMAST C            
       WHERE                        
        L.VNO=L2.VNO                        
        AND L.VTYP=L2.VTYPE                        
        AND L.BOOKTYPE=L2.BOOKTYPE                        
        AND L.LNO=L2.LNO                        
        AND VDT < @@OPENDATE                        
        AND EDT >= @@OPENDATE             
  AND L2.COSTCODE = @@costcode                         
  AND C.COSTNAME = @BRANCH                      
        AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                        
       GROUP BY                        
        L2.CLTCODE                        
     ) T                        
    GROUP BY                        
     CLTCODE                        
    ORDER BY                        
    CLTCODE                        
    INSERT INTO #TEMPTABLE_GL                        
    SELECT                        
     L.BOOKTYPE,                
     VOUDT1=L.VDT,                        
     EFFDT1=L.EDT,                        
     ISNULL(SHORTDESC,'') SHORTDESC,                        
     DRAMT=(CASE WHEN UPPER(L2.DRCR) = 'D' THEN CAMT ELSE 0 END),                        
     CRAMT=(CASE WHEN UPPER(L2.DRCR) = 'C' THEN CAMT ELSE 0 END),                        
     L.VNO,                        
     REPLACE(L.NARRATION,'"','') NARRATION,                        
     DDNO=ISNULL((SELECT TOP 1 DDNO FROM LEDGER1 WHERE VTYP = L.VTYP AND VNO = L.VNO AND BOOKTYPE = L.BOOKTYPE AND LNO = L.LNO),''),                        
     L2.CLTCODE,                        
     A.LONGNAME,                        
     VDT,                        
     L.VTYP,                        
     ACCAT,                     
     OPBAL=0,                        
     CROSAC='',                        
     A.ACNAME,                        
     A.BRANCHCODE,                        
     L.LNO                        
    FROM                        
     Sledger_Vw_Final  L,                        
     VMAST V,                        
     LEDGER2 L2,                        
     sacmast_view A/*,                        
     COSTMAST C */                       
    WHERE                        
     L.VNO = L2.VNO                        
     AND L.VTYP = L2.VTYPE                        
     AND L.BOOKTYPE = L2.BOOKTYPE                        
     AND L.LNO = L2.LNO                        
     AND A.CLTCODE = L2.CLTCODE                        
     AND L2.CLTCODE BETWEEN @FCODE AND @TCODE                        
     AND L.VTYP = V.VTYPE                        
     AND A.ACCAT <> '4'                        
     AND L2.CLTCODE=A.CLTCODE                        
     --AND COSTNAME = RTRIM(@BRANCH)                        
  AND EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L2.COSTCODE = C.COSTCODE)           
     AND L2.VTYPE <> 18                        
     AND L2.COSTCODE = C.COSTCODE                        
     AND  L.EDT BETWEEN @FDATE AND @TDATE + ' 23:59:59'                        
    ORDER BY                        
     L2.CLTCODE,                        
     VOUDT1,                        
     L.VTYP DESC,                        
     L.VNO                        
   END                        
 END                        
                        
UPDATE                        
 #TEMPTABLE_GL                        
SET                        
 OPBAL = L.OPBAL                        
FROM                        
 #OPBAL L                  
WHERE                        
 #TEMPTABLE_GL.CLTCODE = L.CLTCODE                        
                        
UPDATE                        
 #TEMPTABLE_GL                        
SET                        
 CROSAC = L.CLTCODE                        
FROM                        
 Sledger_Vw_Final  L                        
WHERE                        
 L.VTYP IN('2','3')                        
 AND #TEMPTABLE_GL.VTYP = L.VTYP                        
 AND #TEMPTABLE_GL.BOOKTYPE = L.BOOKTYPE                        
 AND #TEMPTABLE_GL.VNO = L.VNO                        
 AND #TEMPTABLE_GL.CLTCODE <> L.CLTCODE                        
                        
UPDATE                        
 #TEMPTABLE_GL                        
SET                        
 BRANCHCODE = COSTNAME                        
FROM                        
 LEDGER2 L2,                        
 #COSTMAST C                        
WHERE                        
 #TEMPTABLE_GL.VNO = L2.VNO                        
 AND #TEMPTABLE_GL.VTYP = L2.VTYPE                        
 AND #TEMPTABLE_GL.BOOKTYPE = L2.BOOKTYPE                     
 AND #TEMPTABLE_GL.LNO = L2.LNO                        
 AND #TEMPTABLE_GL.CLTCODE = L2.CLTCODE                        
 AND L2.COSTCODE = C.COSTCODE                    
              
DELETE #TEMPTABLE_GL WHERE  VTYP=18              
              
INSERT INTO #TEMPTABLE_GL              
SELECT '','','','',0,0,'','','',CLTCODE,'','',18,'',OPBAL,CLTCODE,'','',''                          
FROM #OPBAL WHERE CLTCODE NOT IN (SELECT CLTCODE FROM #TEMPTABLE_GL WHERE VTYP<>18)                   
                     
SELECT                        
 BOOKTYPE,                        
 VOUDT = CONVERT(VARCHAR(11),CONVERT(DATETIME, CONVERT(VARCHAR(11), VOUDT1, 109)), 103),              
 EFFDT = CONVERT(VARCHAR(11), CONVERT(DATETIME, CONVERT(VARCHAR(11), EFFDT1, 109)), 103),              
 SHORTDESC,                        
 DRAMT,                        
 CRAMT,                        
 VNO,                        
 NARRATION,                        
 DDNO,                        
 CLTCODE,                        
 LONGNAME,                        
 VDT,                
 VTYP,                        
 ACCAT,                        
 OPBAL,                        
 CROSAC,                        
 ACNAME,                        
 BRANCHCODE,                        
 LNO                        
FROM                        
 #TEMPTABLE_GL                        
ORDER BY                        
 CLTCODE,      
VDT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.srpt_Acc_ListClient_Report
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[srpt_Acc_ListClient_Report]                    
 @STATUSID VARCHAR(15),                          
 @STATUSNAME VARCHAR(25),                          
 @WHATTOLOOKFOR VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH                          
 @WHICHWAY VARCHAR(1),  -- > OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.                          
 @COMPARETOWHAT VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.                          
 @ACCAT VARCHAR(3)   -- Account Category                          
                          
AS              
DECLARE                          
@strSQL VarChar(2500),                          
@@Inaccat varchar(3)                          
                          
select @@inaccat = rtrim(convert(varchar,convert(int,@accat)+100,3))                          
                          
--SET DEFAULT VALUES                          
--SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + "%"                          
/* SET @BOOKTYPE = @BOOKTYPE + "%" */                          
                          
--BROKER LOGIN                          
If  @STATUSID='BROKER'                          
Begin                          
 Set @strSQL = 'SELECT '                          
 Set @strSQL = @strSQL + 'DISTINCT '                          
 Set @strSQL = @strSQL + ' a.cltcode, '                          
 Set @strSQL = @strSQL + ' acname=isnull(b.sbname,a.acname), '                          
 Set @strSQL = @strSQL + ' branchcode '                          
 Set @strSQL = @strSQL + 'FROM '                          
 Set @strSQL = @strSQL + ' acmast a left outer join sebiinsp_sbnameswap b on a.cltcode=b.cltcode  '                          
 Set @strSQL = @strSQL + 'WHERE '                          
 Set @strSQL = @strSQL + ' a.cltcode >= ''' + @WHATTOLOOKFOR + ''' AND '                          
 Set @strSQL = @strSQL + ' a.cltcode <= ''' + @COMPARETOWHAT + ''' AND '                          
 Set @strSQL = @strSQL + ' a.CLTCODE NOT IN (select gl_code from angelfo.accountfo.dbo.SEBIINSP_NTS with (nolock)) AND '  
 Set @strSQL = @strSQL + ' (accat LIKE ''' + @ACCAT  + '%'' or accat LIKE ''' + @@Inaccat + '%'' '                            
        if rtrim(@accat) = '3'                          
           begin                          
  select @strSQL = @strSQL + ' or accat in ( ''14'',''18'',''114'',''118''))'                           
           end                          
        else                          
           begin                          
  select @strSQL = @strSQL + ' )'                           
           end                          
                          
 Set @strSQL = @strSQL + ' ORDER BY '                          
 Set @strSQL = @strSQL + ' cltcode, '                          
 Set @strSQL = @strSQL + ' branchcode '                          
End                          
                      
                      
 Set @strSQL ='set transaction isolation level read uncommitted '+ @strSQL + ' OPTION  (FAST 10)'                          
                          
Print @strSQL                          
Exec (@strSQL)               
              
SET ANSI_NULLS ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SRPT_ACC_TRIALBALANCE
-- --------------------------------------------------
CREATE PROCEDURE SRPT_ACC_TRIALBALANCE                              
                          
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */                              
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */                              
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */                              
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */                              
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */                              
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */                              
@OPENENTRYFLAG INT,                              
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */                              
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */                              
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */                              
@SORTBYDATE VARCHAR(3)          /* WHETHER REPORT IS BASED ON VDT OR EDT */                              
                              
AS                              
                          
DECLARE                            
@@COSTCODE AS VARCHAR(3)                          
                          
                  
/* Dump series */                  
                  
                  
insert into sebiinsp_glgrp                  
select b.grpcode,a.cltcode,b.grpname from                   
(select * from acmast where cltcode like '21%' and cltcode not in (Select cltcode from sebiinsp_glgrp)) a,                  
(select top 1 grpcode,grpname from sebiinsp_glgrp where cltcode like '21%') b                  
                
insert into sebiinsp_glgrp                  
select b.grpcode,a.cltcode,b.grpname from                   
(select * from acmast where cltcode like '35%' and cltcode not in (Select cltcode from sebiinsp_glgrp)                
and isnumeric(substring(cltcode,3,10)) =0                
) a,                  
(select top 1 grpcode,grpname from sebiinsp_glgrp where cltcode like '35%') b                  
                
                
insert into sebiinsp_glgrp                  
select b.grpcode,a.cltcode,b.grpname from                   
(select * from acmast where cltcode like '30%' and cltcode not in (Select cltcode from sebiinsp_glgrp)                
and isnumeric(substring(cltcode,3,10)) =0                
) a,                  
(select top 1 grpcode,grpname from sebiinsp_glgrp where cltcode like '30%') b                  
                
                
insert into sebiinsp_glgrp                  
select b.grpcode,a.cltcode,b.grpname from                   
(select * from acmast where cltcode like '6%' and cltcode not in (Select cltcode from sebiinsp_glgrp)                
and isnumeric(substring(cltcode,2,10)) =0                
) a,                  
(select top 1 grpcode,grpname from sebiinsp_glgrp where cltcode like '6%') b                  
                
                
                
insert into sebiinsp_glgrp                  
select b.grpcode,a.cltcode,b.grpname from                   
(                
select * from acmast where cltcode like '7%' and cltcode not in (Select cltcode from sebiinsp_glgrp)                 
and isnumeric(substring(cltcode,2,10)) =0                
) a,                  
(select top 1 grpcode,grpname from sebiinsp_glgrp where cltcode like '7%') b                  
                
                
insert into sebiinsp_glgrp                  
select b.grpcode,a.cltcode,b.grpname from                   
(                
select * from acmast where cltcode like '17%' and cltcode not in (Select cltcode from sebiinsp_glgrp)                
and isnumeric(substring(cltcode,3,10)) =0                
) a,                  
(select top 1 grpcode,grpname from sebiinsp_glgrp where cltcode like '17%') b                  
                
   
insert into sebiinsp_glgrp                  
select b.grpcode,a.cltcode,b.grpname from                   
(select * from acmast where cltcode like '16%' and cltcode not in (Select cltcode from sebiinsp_glgrp)                
and isnumeric(substring(cltcode,3,10)) =0                
) a,       
(select top 1 grpcode,grpname from sebiinsp_glgrp where cltcode like '16%') b                  
                
                
insert into sebiinsp_glgrp                  
select b.grpcode,a.cltcode,b.grpname from                   
(select * from acmast where cltcode like '40%' and cltcode not in (Select cltcode from sebiinsp_glgrp)                
and isnumeric(substring(cltcode,3,10)) =0                
) a,                  
(select top 1 grpcode,grpname from sebiinsp_glgrp where cltcode like '40%') b                  
                
                
/*...... copy the above code and add as many series required .... */                  
                              
SELECT * INTO  #sacmast_view FROM sacmast_view WHERE 1 = 2                              
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT INTO #TEMPLEDGER FROM LEDGER WHERE 1=2                              
SELECT CLTCODE,VAMT DRTOT,VAMT CRTOT, VAMT AMOUNT,ACNAME,VNO BRANCHCODE, LNO ACCAT  INTO #TEMPLEDGERFINAL FROM LEDGER WHERE 1=2                              
      
      
INSERT INTO #TEMPLEDGER SELECT L.CLTCODE , 0,0,                            
AMOUNT = SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN VAMT ELSE -VAMT END)                              
FROM LEDGER L WHERE (VDT >= @CURRYRSTDATE + ' 00:00:00' AND VDT <=  @VDT + ' 23:59:59'   )          
and  VDT   <  'Nov 01 2011' + ' 00:00:00'          
--FROM LEDGER L WHERE VDT >= 'Apr  1 2011' + ' 00:00:00' AND VDT <=  'Nov 30 2011' + ' 23:59:59'                                
GROUP BY L.CLTCODE                              
       
       
        
IF  @VIEWOPTION = 'GL'            
BEGIN                            
 INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT                             
 FROM #TEMPLEDGER L, sacmast_view A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)                            
              
 INSERT INTO #TEMPLEDGERFINAL                            
 SELECT A.bgrpcode,SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),A.bgrpname,' ',4                      
 FROM #TEMPLEDGER L, sacmast_view A                      
 WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)                     
 GROUP BY A.BGRPCODE,A.BGRPNAME having SUM(AMOUNT) <> 0                    
END        
ELSE IF  @VIEWOPTION = 'PARTYWISE'           
BEGIN        
 INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT                             
 FROM #TEMPLEDGER L, sacmast_view A WHERE L.CLTCODE =A.CLTCODE         
 --AND A.CLTCODE >='A000' AND A.CLTCODE <='ZZZ9999'         
 and a.cltcode in (select party_Code from anand1.msajag.dbo.client_Details with (nolock) where isnumeric(substring(party_code,1,1))=0 )      
 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)                            
END        
ELSE        
BEGIN        
      
 INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT                             
 FROM #TEMPLEDGER L, sacmast_view A WHERE L.CLTCODE =A.CLTCODE   AND ACCAT <> 4 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)                            
      
 INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT                             
 FROM #TEMPLEDGER L, sacmast_view A WHERE L.CLTCODE =A.CLTCODE         
 --AND (A.CLTCODE >='A000' AND A.CLTCODE <='ZZZ9999')       
 and a.cltcode in (select party_Code from anand1.msajag.dbo.client_Details with (nolock) where isnumeric(substring(party_code,1,1))=0 )      
 AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)                            
      
 INSERT INTO #TEMPLEDGERFINAL                            
 SELECT A.bgrpcode,SUM(DRTOT),SUM(CRTOT),SUM(AMOUNT),A.bgrpname,' ',4                      
 FROM #TEMPLEDGER L, sacmast_view A                      
 WHERE L.CLTCODE =A.CLTCODE  AND ACCAT = 4  AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)                     
 --AND NOT (A.CLTCODE >='A000' AND A.CLTCODE <='ZZZ9999')         
 and not a.cltcode in (select party_Code from anand1.msajag.dbo.client_Details with (nolock) where isnumeric(substring(party_code,1,1))=0 )      
 GROUP BY A.BGRPCODE,A.BGRPNAME having SUM(AMOUNT) <> 0                    
      
 /*      
 INSERT INTO #TEMPLEDGERFINAL SELECT L.*,LEFT(ACNAME,45) ACNAME, BRANCHCODE,ACCAT                             
 FROM #TEMPLEDGER L, sacmast_view A WHERE L.CLTCODE =A.CLTCODE   AND ( DRTOT <> 0  OR CRTOT <> 0 OR  AMOUNT <> 0)                            
 */      
END             
      
delete from #TEMPLEDGERFINAL where abs(amount) <= 0.001       
  
      
/* add this line to change SB Name */                
Update #TEMPLEDGERFINAL set cltcode=b.new_cltcode,acname=left(b.sbname,45) from sebiinsp_sbnameswap b where #TEMPLEDGERFINAL.cltcode=b.cltcode                      
  
/* delete from #TEMPLEDGERFINAL where CLTCODE IN (select gl_code from angelfo.accountfo.dbo.SEBIINSP_NTS with (nolock))  */
    
select cltcode,drtot=sum(drtot),crtot=sum(crtot),amount=sum(amount),acname=max(acname),branchcode=max(branchcode),accat=max(Accat)     
into #TEMPLEDGERFINALx from #TEMPLEDGERFINAL  group by cltcode    
    
IF @FLAG = 'CODEWISE'                              
 BEGIN                            
  SELECT * FROM #TEMPLEDGERFINALx ORDER BY  CLTCODE, ACNAME, BRANCHCODE                            
 END                            
ELSE                            
 BEGIN                            
  SELECT * FROM #TEMPLEDGERFINALx ORDER BY  ACNAME,CLTCODE, BRANCHCODE                            
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.srpt_AccodeList
-- --------------------------------------------------

  
    
/****** Object:  Stored Procedure dbo.rpt_Acc_ListClient    Script Date: 04/13/2003 12:09:05 PM ******/        
---------------------------------------------------------------------------------------------------------        
--  PROC TO LIST CLIENTS ACC TO LOGIN FOR THE DB - ACCOUNT        
---------------------------------------------------------------------------------------------------------        
        
CREATE PROCEDURE srpt_AccodeList        
 @STATUSID VARCHAR(15),        
 @STATUSNAME VARCHAR(25),        
 @WHATTOLOOKFOR VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH        
 @WHICHWAY VARCHAR(1),  -- > OR <, DEPENDING ON HOW THE ABOVE STRING IS TO BE COMPARED TO THE BELOW ONE.        
 @COMPARETOWHAT VARCHAR(25), -- PARTIAL/COMPLETE/NULL STRING TO INDICATE THE UPPER/LOWER LIMIT OF THE SEARCH.        
 @ACCAT varchar(3),  -- Account Category        
 @LOOKFORNAME VARCHAR(25) -- PARTIAL/COMPLETE/NULL STRING - FORMS THE BASIS FOR THE SEARCH        
AS        
        
DECLARE        
@strSQL VarChar(2500),        
@@Inaccat varchar(3)        
        
        
Set @STATUSID = LTrim(RTrim(@STATUSID))        
Set @STATUSNAME = LTrim(RTrim(@STATUSNAME))        
Set @WHATTOLOOKFOR = LTrim(RTrim(@WHATTOLOOKFOR))        
Set @WHICHWAY = LTrim(RTrim(@WHICHWAY))        
Set @COMPARETOWHAT = LTrim(RTrim(@COMPARETOWHAT))        
Set @ACCAT = LTrim(RTrim(@ACCAT))        
Set @LOOKFORNAME = LTrim(RTrim(@LOOKFORNAME))        
        
select @@inaccat = rtrim(convert(varchar,convert(int,@accat)+100,3))        

IF @WHATTOLOOKFOR <> ''        
BEGIN
--SET DEFAULT VALUES        
SET @WHATTOLOOKFOR = @WHATTOLOOKFOR + '%'        
/* SET @BOOKTYPE = @BOOKTYPE + "%" */        
        
--BROKER LOGIN        
If  @STATUSID='BROKER'        
Begin        
 Set @strSQL = 'SELECT '        
 Set @strSQL = @strSQL + 'DISTINCT a.cltcode, acname=isnull(b.sbname,a.acname) , branchcode '        
 Set @strSQL = @strSQL + 'FROM acmast a left outer join sebiinsp_sbnameswap b on a.cltcode=b.cltcode '        
 Set @strSQL = @strSQL + 'WHERE a.cltcode not like ''21%'' and a.cltcode not in (select gl_code from angelfo.accountfo.dbo.SEBIINSP_NTS with (nolock)) and '        
        if len(rtrim(@WHATTOLOOKFOR)) <> 0 and len(rtrim(@LOOKFORNAME)) <> 0         
           begin        
    Set @strSQL = @strSQL + ' ( a.cltcode LIKE ''' + @WHATTOLOOKFOR + ''' and acname LIKE ''' + @LOOKFORNAME + '%'') and (accat LIKE ''' + @ACCAT  + '%'' or accat like ''' + @@inaccat + '%'' '         
    end        
        else        
           if len(rtrim(@LOOKFORNAME)) <> 0         
               begin        
                  Set @strSQL = @strSQL + ' ( a.cltcode LIKE ''' + @WHATTOLOOKFOR + ''' or acname LIKE ''' + @LOOKFORNAME + '%'') and (accat LIKE ''' + @ACCAT  + '%'' or accat like ''' + @@inaccat + '%'' '         
               end        
           else        
               begin        
                  Set @strSQL = @strSQL + ' ( a.cltcode LIKE ''' + @WHATTOLOOKFOR + ''' or acname LIKE ''' + @WHATTOLOOKFOR + ''') and (accat LIKE ''' + @ACCAT  + '%'' or accat like ''' + @@inaccat + '%'' '         
               end        
        if rtrim(@accat) = '3'        
           begin        
  select @strSQL = @strSQL + ' or accat in ( ''14'',''18'',''114'',''118''))'         
           end        
        else        
           begin        
  select @strSQL = @strSQL + ' )'         
           end        
        
-- TO GET A VALUE GREATER/LESSER THAN ANOTHER.        
-- USEFUL WHILE TAKING FROM-TO TYPE SELECTIONS         
 If @WHICHWAY = '>'        
 Begin        
  Set @strSQL = @strSQL + ' AND '        
  Set @strSQL = @strSQL + ' a.cltcode >= ''' + @COMPARETOWHAT + ''' '        
 End        
 Else        
 Begin        
  If @WHICHWAY = '<'        
  Begin        
   Set @strSQL = @strSQL + ' AND '        
   Set @strSQL = @strSQL + ' a.cltcode <= ''' + @COMPARETOWHAT + ''''        
  End        
 End        
        
 Set @strSQL = @strSQL + 'ORDER BY a.cltcode, branchcode '        
End        
        
      
Set @strSQL = ' Set Transaction Isolation Level Read Uncommitted ' + @strSQL + ' OPTION  (FAST 10)'        
END
ELSE
begin
 Set @strSQL = 'SELECT '        
 Set @strSQL = @strSQL + 'DISTINCT cltcode, acname , branchcode '        
 Set @strSQL = @strSQL + 'FROM acmast where 1=2'
end        
Print @strSQL        
Exec (@strSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Tbl
-- --------------------------------------------------
  

  
CREATE PROC Tbl @TblName VARCHAR(25)AS             
Select * from sysobjects where name Like '%' + @TblName + '%' and xtype='U' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATE_POA_RECO
-- --------------------------------------------------


/*      
BEGIN TRAN      
EXEC UPDATE_POA_RECO 'FEB 10 2015', '300002', 'H'      
SELECT * FROM BANKRECO WHERE CrossReferenceNo IN(161791, 161797)  
SELECT * FROM LEDGER1 WHERE REFNO = 161791  
ROLLBACK    
COMMIT    
*/      
  
CREATE PROCEDURE [dbo].[UPDATE_POA_RECO]    
(      
 @PROCESS_DATE VARCHAR(11),      
 @CLTCODE VARCHAR(10),      
 @STATEMENT_TYPE CHAR(1)      
)      
AS      
  
DECLARE    
 @VDT DATETIME    
  
 --SET @VDT ='NOV 11 2014'    
SELECT @VDT = START_DATE FROM MSAJAG.DBO.SETT_MST WHERE FUNDS_PAYIN LIKE @PROCESS_DATE + '%' AND SETT_TYPE = 'N' AND EXCHANGE = 'NSE'    
  
IF @STATEMENT_TYPE = 'I'      
BEGIN      
 UPDATE BR SET STATUS = 'MATCHED'       
 FROM     
  (SELECT * FROM BANKRECO WHERE BOOKDATE LIKE  @PROCESS_DATE + '%' AND CLTCODE = @CLTCODE) BR,     
  LEDGER L,    
  LEDGER1 L1,     
  MULTIBANKID M,      
  (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @CLTCODE) L2     
 WHERE       
  (.DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 2) = M.ACCNO  OR .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 4) = M.ACCNO OR .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 3) = M.ACCNO)    
  AND M.CLTCODE = L.CLTCODE AND L1.RELDT = ''      
  AND VAMT = AMOUNT AND BR.DRCR = L.DRCR  AND VDT = BOOKDATE -->= @VDT --= BOOKDATE      
  AND L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE      
  AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO      
        
  
 UPDATE L1 SET RELDT = VALUEDATE, L1.REFNO = CROSSREFERENCENO      
 FROM     
  (SELECT * FROM BANKRECO WHERE BOOKDATE LIKE  @PROCESS_DATE + '%' AND CLTCODE = @CLTCODE) BR,     
  LEDGER L,    
  LEDGER1 L1,     
  MULTIBANKID M,      
  (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @CLTCODE) L2     
 WHERE       
  (.DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 2) = M.ACCNO OR .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 4) = M.ACCNO OR .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 3) = M.ACCNO)    
  AND M.CLTCODE = L.CLTCODE AND L1.RELDT = ''       
  AND VAMT = AMOUNT AND BR.DRCR = L.DRCR  AND VDT = BOOKDATE -->= @VDT    
  AND L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE      
  AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO    
      
 UPDATE BR SET STATUS = 'MATCHED'       
 FROM     
  (SELECT * FROM LEDGER WHERE VDT LIKE @PROCESS_DATE + '%') L,       
  (      
    SELECT     
   CLTCODE, ACTNODAYS,     
   DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END) > 0 THEN 'C' ELSE 'D' END,     
   NET = ABS(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END))     
    FROM      
   LEDGER L, LEDGER1 L1,      
   (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @CLTCODE AND VDT LIKE @PROCESS_DATE + '%') L2      
    WHERE     
   L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE      
   AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO AND RELDT = ''      
    GROUP BY     
   CLTCODE, ACTNODAYS      
   ) T,    
   LEDGER1 L1,     
   MULTIBANKID M,     
   (SELECT * FROM BANKRECO WHERE BOOKDATE LIKE  @PROCESS_DATE + '%' AND CLTCODE = @CLTCODE) BR      
 WHERE     
  L.CLTCODE = T.CLTCODE --AND L.DRCR = T.DRCR       
  AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO       
  AND RELDT = ''      
  AND (.DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 2) = M.ACCNO OR .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 4) = M.ACCNO OR .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 3) = M.ACCNO) AND VDT = BOOKDATE    
  AND M.CLTCODE = L.CLTCODE  AND  NET = AMOUNT AND T.DRCR = BR.DRCR AND T.ACTNODAYS = L.ACTNODAYS           
       
 UPDATE L1 SET RELDT = VALUEDATE, L1.REFNO = CROSSREFERENCENO      
 FROM     
  (SELECT * FROM LEDGER WHERE VDT LIKE @PROCESS_DATE + '%') L,       
  (      
   SELECT     
    CLTCODE, ACTNODAYS,     
    DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END) > 0 THEN 'C' ELSE 'D' END,     
    NET = ABS(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END))     
   FROM      
    LEDGER L, LEDGER1 L1,      
    (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @CLTCODE AND VDT LIKE @PROCESS_DATE + '%') L2      
   WHERE     
    L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE      
    AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO AND RELDT = ''      
   GROUP BY     
    CLTCODE, ACTNODAYS      
  ) T,    
  LEDGER1 L1,     
  MULTIBANKID M,     
  (SELECT * FROM BANKRECO WHERE BOOKDATE LIKE  @PROCESS_DATE + '%' AND CLTCODE = @CLTCODE) BR      
 WHERE     
  L.CLTCODE = T.CLTCODE --AND L.DRCR = T.DRCR       
  AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO       
  AND RELDT = ''      
  AND (.DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 2) = M.ACCNO OR .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 4) = M.ACCNO OR .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 3) = M.ACCNO) AND VDT = BOOKDATE    
  AND M.CLTCODE = L.CLTCODE  AND  NET = AMOUNT AND T.DRCR = BR.DRCR AND T.ACTNODAYS = L.ACTNODAYS               
       
 UPDATE BR SET STATUS = 'MATCHED'       
 FROM     
  (SELECT * FROM LEDGER WHERE VDT >= @VDT AND VDT <= @PROCESS_DATE + ' 23 :59') L,       
  (      
   SELECT     
    CLTCODE, ACTNODAYS,     
    DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END) > 0 THEN 'C' ELSE 'D' END,     
    NET = ABS(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END))     
   FROM      
    LEDGER L, LEDGER1 L1,      
    (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @CLTCODE AND VDT >= @VDT AND VDT <= @PROCESS_DATE + ' 23 :59') L2      
   WHERE     
    L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE      
    AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO AND RELDT = ''      
   GROUP BY     
    CLTCODE, ACTNODAYS      
  ) T,LEDGER1 L1, MULTIBANKID M, (SELECT * FROM BANKRECO WHERE BOOKDATE LIKE  @PROCESS_DATE + '%' AND CLTCODE = @CLTCODE) BR      
 WHERE     
  L.CLTCODE = T.CLTCODE --AND L.DRCR = T.DRCR       
  AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO       
  AND RELDT = ''      
  AND (.DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 2) = M.ACCNO OR .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 4) = M.ACCNO OR .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 3) = M.ACCNO) AND VDT >= @VDT AND VDT <= @PROCESS_DATE + ' 23 :59'    
  AND M.CLTCODE = L.CLTCODE  AND  NET = AMOUNT AND T.DRCR = BR.DRCR AND T.ACTNODAYS = L.ACTNODAYS            
       
 UPDATE L1 SET RELDT = VALUEDATE, L1.REFNO = CROSSREFERENCENO      
 FROM     
  (SELECT * FROM LEDGER WHERE VDT >= @VDT AND VDT <= @PROCESS_DATE + ' 23 :59') L,       
  (      
   SELECT     
    CLTCODE, ACTNODAYS,     
    DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END) > 0 THEN 'C' ELSE 'D' END,     
    NET = ABS(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END))     
   FROM      
    LEDGER L, LEDGER1 L1,      
    (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @CLTCODE AND VDT >= @VDT AND VDT <= @PROCESS_DATE + ' 23 :59') L2      
   WHERE     
    L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE      
    AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO AND RELDT = ''      
   GROUP BY     
    CLTCODE, ACTNODAYS      
  ) T,LEDGER1 L1, MULTIBANKID M, (SELECT * FROM BANKRECO WHERE BOOKDATE LIKE  @PROCESS_DATE + '%' AND CLTCODE = @CLTCODE) BR      
 WHERE     
  L.CLTCODE = T.CLTCODE --AND L.DRCR = T.DRCR       
  AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO       
  AND RELDT = ''      
  AND (.DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 2) = M.ACCNO OR .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 4) = M.ACCNO OR .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 3) = M.ACCNO) AND VDT >= @VDT AND VDT <= @PROCESS_DATE + ' 23 :59'    
  AND M.CLTCODE = L.CLTCODE  AND  NET = AMOUNT AND T.DRCR = BR.DRCR AND T.ACTNODAYS = L.ACTNODAYS            
END      
ELSE      
BEGIN      
 UPDATE BR SET STATUS = 'MATCHED'       
 FROM     
  (SELECT * FROM BANKRECO WHERE BOOKDATE LIKE  @PROCESS_DATE + '%' AND CLTCODE = @CLTCODE AND STATUS = 'UNMATCHED') BR,     
  LEDGER L,    
  LEDGER1 L1,       
  (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @CLTCODE) L2     
 WHERE       
  CASE WHEN CHARINDEX('PAYOUT', DESCRIPTION) > 0 THEN .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 2) ELSE .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 3) END = L.CLTCODE AND L1.RELDT = ''      
  AND VAMT = AMOUNT AND BR.DRCR = L.DRCR AND VDT >= @VDT AND VDT <= @PROCESS_DATE + ' 23:59'     
  AND L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE      
  AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO       
    
 UPDATE L1 SET RELDT = VALUEDATE, L1.REFNO = CROSSREFERENCENO      
 FROM     
  (SELECT * FROM BANKRECO WHERE BOOKDATE LIKE  @PROCESS_DATE + '%' AND CLTCODE = @CLTCODE) BR, LEDGER L,LEDGER1 L1,       
  (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @CLTCODE) L2     
 WHERE       
  CASE WHEN CHARINDEX('PAYOUT', DESCRIPTION) > 0 THEN .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 2) ELSE .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 3) END = L.CLTCODE AND L1.RELDT = ''      
  AND VAMT = AMOUNT AND BR.DRCR = L.DRCR AND VDT >= @VDT AND VDT <= @PROCESS_DATE + ' 23:59'      
  AND L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE      
  AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO       
    
 UPDATE BR SET STATUS = 'MATCHED'      
 FROM     
  (SELECT * FROM LEDGER WHERE VDT >= @VDT) L,       
  (      
   SELECT     
    CLTCODE, ACTNODAYS, VDT,     
    DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END) > 0 THEN 'C' ELSE 'D' END,     
    NET = ABS(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END))     
   FROM      
    LEDGER L,      
    (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @CLTCODE AND VDT >= @VDT AND VDT <= @PROCESS_DATE + ' 23:59') L2      
   WHERE     
    L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE      
   GROUP BY     
    CLTCODE, ACTNODAYS, VDT--, DRCR      
  ) T,LEDGER1 L1, (SELECT * FROM BANKRECO WHERE BOOKDATE LIKE  @PROCESS_DATE + '%' AND CLTCODE = @CLTCODE AND STATUS = 'UNMATCHED') BR      
 WHERE     
  L.CLTCODE = T.CLTCODE AND L.ACTNODAYS = T.ACTNODAYS AND L.VDT = T.VDT--AND L.DRCR = T.DRCR       
  AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO       
  AND RELDT = ''      
  AND CASE WHEN CHARINDEX('PAYOUT', DESCRIPTION) > 0 THEN .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 2) ELSE .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 3) END = L.CLTCODE AND  NET = AMOUNT AND T.DRCR = BR.DRCR      
    
  
 UPDATE L1 SET RELDT = VALUEDATE, REFNO = CROSSREFERENCENO       
 FROM     
  (SELECT * FROM LEDGER WHERE VDT >= @VDT) L,       
  (      
  SELECT CLTCODE, ACTNODAYS, VDT, DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END) > 0 THEN 'C' ELSE 'D' END, NET = ABS(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END)) FROM      
  LEDGER L,      
  (SELECT VNO, VTYP, BOOKTYPE FROM LEDGER WHERE CLTCODE = @CLTCODE AND VDT >= @VDT AND VDT <= @PROCESS_DATE + ' 23:59') L2      
  WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYP AND L.BOOKTYPE = L2.BOOKTYPE      
  GROUP BY CLTCODE, ACTNODAYS, VDT--, DRCR      
  ) T,    
  LEDGER1 L1,     
  (SELECT * FROM BANKRECO WHERE BOOKDATE LIKE  @PROCESS_DATE + '%' AND CLTCODE = @CLTCODE) BR      
 WHERE     
  L.CLTCODE = T.CLTCODE AND L.ACTNODAYS = T.ACTNODAYS AND L.VDT = T.VDT--AND L.DRCR = T.DRCR       
  AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO       
  AND RELDT = ''      
  AND CASE WHEN CHARINDEX('PAYOUT', DESCRIPTION) > 0 THEN .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 2) ELSE .DBO.PIECE(REPLACE(DESCRIPTION, ' ', ','), ',', 3) END = L.CLTCODE     
  AND  NET = AMOUNT AND T.DRCR = BR.DRCR      
  
  CREATE TABLE #RECO_MATCH  
(  
 enteredby VARCHAR(20),  
 actnodays VARCHAR(3),  
 VDT DATETIME,   
 CDT DATETIME,  
 VAMT MONEY,  
 VALUEDATE DATETIME,   
 CROSSREFERENCENO INT,  
 STATUS VARCHAR(1)  
)  
  
INSERT INTO #RECO_MATCH  
SELECT enteredby,actnodays,VDT,CDT, VAMT, valuedate, br.CrossReferenceNo, ''   
FROM (select * from bankreco where cltcode = @CLTCODE and bookdate like @PROCESS_DATE+'%' and status = 'unmatched' and drcr = 'd') BR,   
(select enteredby,actnodays,VDT,CDT,VAMT = sum(vamt) from (  
 select b.enteredby,b.vdt,b.cltcode,b.actnodays,CDT,vamt =(sum(case when B.drcr ='d' then b.vamt else b.vamt*-1 end)) -- into #a   
 from ledger b, acmast as m, (select actnodays,vno,vtyp,booktype,vamt from ledger where  cltcode =@cltcode  
 and vdt>=@vdt AND VDT <=@PROCESS_DATE + ' 23:59') a,LEDGER1 AS L1  
 where b.vno =a.vno and b.vtyp=a.vtyp and b.booktype =a.booktype and a.actnodays=b.actnodays  
 AND b.Vno =L1.Vno and b.Vtyp=L1.Vtyp and b.Booktype =L1.Booktype AND B.LNO = L1.Lno   
 AND L1.RELDT = ''  
 AND L1.REFNO IN('0', '')  
 and m.cltcode=b.cltcode and m.accat =4  
 and b.cltcode <> @cltcode  
 --AND B.ACTNODAYS >0  
 group by b.cltcode,b.actnodays,b.vdt,b.enteredby,Cdt  
 having sum(case when B.drcr ='d' then b.vamt else b.vamt*-1 end) > 0  
 )a  group by enteredby,actnodays,VDT,CDT  
 ) X  
 WHERE VAMT = Amount  
  
 SELECT * FROM #RECO_MATCH  
   
   
  
UPDATE R SET STATUS = 'MATCHED' FROM BANKRECO R, #RECO_MATCH M  
WHERE R.CrossReferenceNo = M.CROSSREFERENCENO  
   
  
UPDATE L1 SET RELDT = VALUEDATE, REFNO = CROSSREFERENCENO  FROM LEDGER L, LEDGER1 L1,  
(select b.enteredby,b.vdt,b.cltcode,b.actnodays,CDT,vamt =(sum(case when B.drcr ='d' then b.vamt else b.vamt*-1 end)) -- into #a   
 from ledger b, acmast as m, (select actnodays,vno,vtyp,booktype,vamt from ledger where  cltcode =@cltcode  
 and vdt>=@vdt AND VDT <=@PROCESS_DATE + ' 23:59') a,LEDGER1 AS L1  
 where b.vno =a.vno and b.vtyp=a.vtyp and b.booktype =a.booktype and a.actnodays=b.actnodays  
 AND b.Vno =L1.Vno and b.Vtyp=L1.Vtyp and b.Booktype =L1.Booktype AND B.LNO = L1.Lno   
 AND L1.REFNO IN('0', '')  
 and m.cltcode=b.cltcode and m.accat =4  
 and b.cltcode <> @cltcode  
 --AND B.ACTNODAYS >0  
 group by b.cltcode,b.actnodays,b.vdt,b.enteredby,Cdt  
 having sum(case when B.drcr ='d' then b.vamt else b.vamt*-1 end) > 0  
) X, #RECO_MATCH R  
WHERE L.CLTCODE = X.CLTCODE AND L.enteredby = X.enteredby AND X.actnodays = L.actnodays AND L.vdt = X.vdt AND L.CDT = X.CDT  
AND L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE AND L.LNO = L1.LNO  
AND R.enteredby = X.enteredby AND R.actnodays = L.actnodays AND R.vdt = X.vdt AND R.CDT = X.CDT  
AND L1.RELDT = ''  
AND L1.REFNO IN('0', '')  
  
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATEACMAST
-- --------------------------------------------------

CREATE PROC [dbo].[UPDATEACMAST]  
 @EXCHANGE VARCHAR(20),  
 @SEGMENT VARCHAR(20),  
 @COMPANY VARCHAR(100)  
AS  
DECLARE  
 @@SHAREDB AS VARCHAR(50),  
 @@GRPCODE AS VARCHAR(50),  
 @@SQL AS VARCHAR(2000)  
/*  
 EXEC UPDATEACMAST 'NSE', 'CAPITAL', 'MOTILAL OSWAL SECURITIES LTD'  
*/  
SELECT @@SHAREDB = ''  
SELECT TOP 1  
 @@SHAREDB = SHAREDB  
FROM  
 PRADNYA.DBO.MULTICOMPANY  
WHERE  
 EXCHANGE = @EXCHANGE  
 AND SEGMENT = @SEGMENT  
 AND COMPANYNAME = @COMPANY  
 AND PRIMARYSERVER = 1  
  
SELECT @@GRPCODE = ''  
SELECT  
 @@GRPCODE = ISNULL(GRPCODE, '')  
FROM  
 OWNER O,  
 GRPMAST G  
WHERE  
 O.CLIENTGROUP = G.GRPNAME  
IF @@SHAREDB = ''  
 BEGIN  
  SELECT ERR = 1, DESCRIPTION = 'SHARE DATABASE NOT FOUND.CANNOT CONTINUE...'  
  RETURN  
 END  
--BEGIN TRANSACTION  
SELECT @@SQL = "INSERT INTO ACMAST SELECT LONG_NAME, LONG_NAME , 'ASSET', '4', '', PARTY_CODE , '', "  
SELECT @@SQL = @@SQL + "'" + @@GRPCODE + "', '', 0, BRANCH_CD, '0', 'C', 'HDFC BANK', 'MUMBAI', 'GB019' "  
SELECT @@SQL = @@SQL + "FROM " + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT1 C1 (NOLOCK), " + LTRIM(RTRIM(@@SHAREDB))  
SELECT @@SQL = @@SQL + ".DBO.CLIENT2 C2 (NOLOCK) WHERE C1.CL_CODE=C2.CL_CODE "  
SELECT @@SQL = @@SQL + "AND PARTY_CODE NOT IN (SELECT CLTCODE FROM ACMAST WHERE ACCAT = 4) "  
SELECT @@SQL = @@SQL + "UPDATE ACMAST SET ACNAME = LONG_NAME, LONGNAME = LONG_NAME, "  
SELECT @@SQL = @@SQL + "BRANCHCODE = BRANCH_CD, GRPCODE = '" + @@GRPCODE + "' "  
SELECT @@SQL = @@SQL + "FROM " + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT1 C1 (NOLOCK), "  
SELECT @@SQL = @@SQL + LTRIM(RTRIM(@@SHAREDB)) + ".DBO.CLIENT2 C2 (NOLOCK) "  
SELECT @@SQL = @@SQL + "WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = ACMAST.CLTCODE "  
SELECT @@SQL = @@SQL + "UPDATE ACMAST SET ACNAME = LONGNAME WHERE ACNAME <> LONGNAME "  
SELECT @@SQL = @@SQL + "UPDATE LEDGER SET ACNAME = A.LONGNAME "  
SELECT @@SQL = @@SQL + "FROM ACMAST A (NOLOCK) WHERE LEDGER.CLTCODE = A.CLTCODE "  
SELECT @@SQL = @@SQL + "AND LEDGER.ACNAME <> A.LONGNAME "  
  
--PRINT @@SQL  
EXEC (@@SQL)  
--COMMIT TRANSACTION  
SELECT ERR = 0, DESCRIPTION = 'ACMAST UPDATED SUCCESSFULLY...'  
  
SET QUOTED_IDENTIFIER ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPDATECOST_FULL
-- --------------------------------------------------


CREATE  PROC UPDATECOST_FULL    
AS    
DECLARE    
 @@BRANCH_CODE AS VARCHAR(10),    
 @@COSTCODE AS VARCHAR(10),    
 @@BRCNT AS INT,    
 @@BRCURS AS CURSOR    
------------------------------------------UPDATING NSE SEGMENT --------------------------------------------------------  
SET @@BRCURS = CURSOR FOR    
 SELECT DISTINCT   
  BRANCH_CODE   
 FROM MSAJAG.DBO.BRANCH   
 WHERE BRANCH_CODE NOT IN   
  (  
  SELECT DISTINCT   
   COSTNAME   
  FROM ACCOUNT.DBO.COSTMAST  
  )  
OPEN @@BRCURS    
 FETCH NEXT   
 FROM @@BRCURS   
 INTO @@BRANCH_CODE  
WHILE @@FETCH_STATUS = 0    
 BEGIN    
  SELECT   
   @@COSTCODE = CONVERT(VARCHAR(10), ISNULL(MAX(COSTCODE)+1, 1))   
  FROM ACCOUNT.DBO.COSTMAST   
  INSERT   
  INTO ACCOUNT.DBO.COSTMAST VALUES   
   (  
    @@BRANCH_CODE,   
    @@COSTCODE,   
    1,   
    '10000000000'  
   )   
   FETCH NEXT   
  FROM @@BRCURS   
  INTO @@BRANCH_CODE  
 END    
CLOSE @@BRCURS    
SET @@BRCURS = CURSOR FOR    
 SELECT DISTINCT   
  COSTNAME   
 FROM ACCOUNT.DBO.COSTMAST   
 WHERE COSTNAME NOT IN   
  (  
  SELECT DISTINCT   
   BRANCHNAME   
  FROM ACCOUNT.DBO.BRANCHACCOUNTS  
  )  
OPEN @@BRCURS    
 FETCH NEXT  
 FROM @@BRCURS  
 INTO @@BRANCH_CODE    
WHILE @@FETCH_STATUS = 0    
 BEGIN    
  INSERT   
  INTO ACCOUNT.DBO.BRANCHACCOUNTS VALUES   
   (  
    @@BRANCH_CODE,   
    @@BRANCH_CODE,   
    'HOCTRL',   
    0  
   )   
  FETCH NEXT   
  FROM @@BRCURS   
  INTO @@BRANCH_CODE  
 END    
CLOSE @@BRCURS    
 INSERT   
 INTO ACCOUNT.DBO.ACMAST   
 SELECT   
  LTRIM(RTRIM(BRANCHNAME)) + ' CONTROL A/C',   
  LTRIM(RTRIM(BRANCHNAME)) + ' CONTROL A/C',   
  'ASSET',   
  '4',   
  '',   
  LTRIM(RTRIM(BRCONTROLAC)),   
  '',   
  'A0000000000',   
  '',   
  '0',   
  LTRIM(RTRIM(BRANCHNAME)),   
  '0',   
  'C',   
  '',   
  '',   
  ''   
 FROM ACCOUNT.DBO.BRANCHACCOUNTS   
 WHERE BRCONTROLAC NOT IN   
  (  
  SELECT DISTINCT   
   CLTCODE   
  FROM ACCOUNT.DBO.ACMAST  
  )  
    
------------------------------------------UPDATING BSE SEGMENT --------------------------------------------------------  
  
SET @@BRCURS = CURSOR FOR    
 SELECT DISTINCT   
  BRANCH_CODE   
 FROM BSEDB.DBO.BRANCH   
 WHERE BRANCH_CODE NOT IN   
  (  
  SELECT DISTINCT   
   COSTNAME   
  FROM ACCOUNTBSE.DBO.COSTMAST  
  )  
OPEN @@BRCURS    
 FETCH NEXT  
 FROM @@BRCURS  
 INTO @@BRANCH_CODE  
WHILE @@FETCH_STATUS = 0    
 BEGIN    
  SELECT   
   @@COSTCODE = CONVERT(VARCHAR(10), ISNULL(MAX(COSTCODE)+1, 1))   
  FROM ACCOUNTBSE.DBO.COSTMAST   
  INSERT   
  INTO ACCOUNTBSE.DBO.COSTMAST VALUES   
   (  
    @@BRANCH_CODE,   
    @@COSTCODE,   
    1,   
    '10000000000'  
   )   
  FETCH NEXT   
  FROM @@BRCURS   
  INTO @@BRANCH_CODE   
 END    
CLOSE @@BRCURS    
SET @@BRCURS = CURSOR FOR    
 SELECT DISTINCT   
  COSTNAME   
 FROM ACCOUNTBSE.DBO.COSTMAST   
 WHERE COSTNAME NOT IN   
  (  
  SELECT DISTINCT   
   BRANCHNAME   
  FROM ACCOUNTBSE.DBO.BRANCHACCOUNTS  
  )  
OPEN @@BRCURS    
 FETCH NEXT  
 FROM @@BRCURS  
 INTO @@BRANCH_CODE  
WHILE @@FETCH_STATUS = 0    
 BEGIN    
  INSERT   
  INTO ACCOUNTBSE.DBO.BRANCHACCOUNTS VALUES   
   (  
    @@BRANCH_CODE,   
    @@BRANCH_CODE,   
    'HOCTRL',   
    0  
   )   
  FETCH NEXT   
  FROM @@BRCURS   
  INTO @@BRANCH_CODE  
 END    
CLOSE @@BRCURS    
 INSERT   
 INTO ACCOUNTBSE.DBO.ACMAST   
 SELECT   
  LTRIM(RTRIM(BRANCHNAME)) + ' CONTROL A/C',   
  LTRIM(RTRIM(BRANCHNAME)) + ' CONTROL A/C',   
  'ASSET',   
  '4',   
  '',   
  LTRIM(RTRIM(BRCONTROLAC)),   
  '',   
  'A0000000000',   
  '',   
  '0',   
  LTRIM(RTRIM(BRANCHNAME)),   
  '0',   
  'C',   
  '',   
  '',   
  ''   
 FROM ACCOUNTBSE.DBO.BRANCHACCOUNTS   
 WHERE BRCONTROLAC NOT IN   
  (  
  SELECT DISTINCT   
   CLTCODE   
  FROM ACCOUNTBSE.DBO.ACMAST  
  )  
  
  
------------------------------------------UPDATING NSEFO SEGMENT --------------------------------------------------------  
  
SET @@BRCURS = CURSOR FOR    
 SELECT DISTINCT   
  BRANCH_CODE   
 FROM NSEFO.DBO.BRANCH   
 WHERE BRANCH_CODE NOT IN   
  (  
  SELECT DISTINCT   
   COSTNAME   
  FROM ACCOUNTFO.DBO.COSTMAST  
  )  
OPEN @@BRCURS    
 FETCH NEXT  
 FROM @@BRCURS  
 INTO @@BRANCH_CODE  
WHILE @@FETCH_STATUS = 0    
 BEGIN    
  SELECT   
   @@COSTCODE = CONVERT(VARCHAR(10), ISNULL(MAX(COSTCODE)+1, 1))   
  FROM ACCOUNTFO.DBO.COSTMAST   
  INSERT   
  INTO ACCOUNTFO.DBO.COSTMAST VALUES   
   (  
    @@BRANCH_CODE,   
    @@COSTCODE,   
    1,   
    '10000000000'  
   )   
  FETCH NEXT   
  FROM @@BRCURS   
  INTO @@BRANCH_CODE   
 END    
CLOSE @@BRCURS    
SET @@BRCURS = CURSOR FOR    
 SELECT DISTINCT   
  COSTNAME   
 FROM ACCOUNTFO.DBO.COSTMAST   
 WHERE COSTNAME NOT IN   
  (  
  SELECT DISTINCT   
   BRANCHNAME   
  FROM ACCOUNTFO.DBO.BRANCHACCOUNTS  
  )  
OPEN @@BRCURS    
 FETCH NEXT  
 FROM @@BRCURS  
 INTO @@BRANCH_CODE  
WHILE @@FETCH_STATUS = 0    
 BEGIN    
  INSERT   
  INTO ACCOUNTFO.DBO.BRANCHACCOUNTS VALUES   
   (  
    @@BRANCH_CODE,   
    @@BRANCH_CODE,   
    'HOCTRL',   
    0  
   )   
  FETCH NEXT   
  FROM @@BRCURS   
  INTO @@BRANCH_CODE  
 END    
CLOSE @@BRCURS    
 INSERT   
 INTO ACCOUNTFO.DBO.ACMAST   
 SELECT   
  LTRIM(RTRIM(BRANCHNAME)) + ' CONTROL A/C',   
  LTRIM(RTRIM(BRANCHNAME)) + ' CONTROL A/C',   
  'ASSET',   
  '4',   
  '',   
  LTRIM(RTRIM(BRCONTROLAC)),   
  '',   
  'A0000000000',   
  '',   
  '0',   
  LTRIM(RTRIM(BRANCHNAME)),   
  '0',   
  'C',   
  '',   
  '',   
  ''   
 FROM ACCOUNTFO.DBO.BRANCHACCOUNTS   
 WHERE BRCONTROLAC NOT IN   
  (  
  SELECT DISTINCT   
   CLTCODE   
  FROM ACCOUNTFO.DBO.ACMAST  
  )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_BANKPOFILEGEN
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[V2_BANKPOFILEGEN]
(
	@VTYP VARCHAR(2),
	@FROMDATE VARCHAR(12),
	@TODATE VARCHAR(12),
	@VNOFROM VARCHAR(12),
	@VNOTO VARCHAR(12),
	@BANKCODE VARCHAR(12),	
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(7),
	@FILETYPE VARCHAR(4),
	@PRINTFLAG CHAR(2)
)

AS
	
	IF @PRINTFLAG = 'FP'
	BEGIN
		SELECT 
			L1.DDDT,
			L.VNO,
			ISNULL(DD,0) DD,
			ISNULL(DDNO,'') DDNO,
			VAMT = ISNULL(L.VAMT,0), 
			L.DRCR,
			L.CLTCODE, 
			L.ACNAME,
			CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), 
			L.NARRATION,
			PRINTEDFLAG = ISNULL(CHQPRINTED,0), 
			L1.MICRNO,
			L.BOOKTYPE, 
			HOPAYMODE,
			M.ACCNO
		FROM 
			ACCOUNT.DBO.V2_SETTPAYOUT_ALL S (NOLOCK)
			LEFT OUTER JOIN MULTIBANKID M (NOLOCK) ON S.CLTCODE = M.CLTCODE AND M.DEFAULTBANK = 1, 
			LEDGER L (NOLOCK), 	
			LEDGER1 L1 (NOLOCK),
			(
			SELECT 
				VNO, 
				VTYP, 
				BOOKTYPE 
			FROM 
				LEDGER (NOLOCK)
			WHERE 
				CLTCODE = @BANKCODE 
				AND VTYP = @VTYP
				AND VNO BETWEEN @VNOFROM AND @VNOTO 
				AND VDT BETWEEN @FROMDATE AND @TODATE
			) B
		WHERE 
			L.VTYP = @VTYP 
			AND L.VTYP = L1.VTYP 
			AND L.BOOKTYPE = L1.BOOKTYPE 
			AND L.VNO = L1.VNO 
			AND L.LNO = L1.LNO			
			AND L.VTYP = B.VTYP 
			AND L.BOOKTYPE = B.BOOKTYPE 
			AND L.VNO = B.VNO
			AND L.VNO BETWEEN @VNOFROM AND @VNOTO 
			AND L.VDT BETWEEN @FROMDATE AND @TODATE 
			AND S.CLTCODE = L.CLTCODE
			AND L.CLTCODE <> @BANKCODE
			AND S.VNO = L.VNO 
			AND S.HOPAYMODE = @FILETYPE 
			AND CHQPRINTED = 0
			AND EXCHANGE = @EXCHANGE 
			AND SEGMENT = @SEGMENT
		ORDER BY 
			L.VNO 
	END
	
	ELSE
	BEGIN
		SELECT 
			L1.DDDT,
			L.VNO,
			ISNULL(DD,0) DD,
			ISNULL(DDNO,'') DDNO,
			VAMT = ISNULL(L.VAMT,0), 
			L.DRCR,
			L.CLTCODE, 
			L.ACNAME,
			CHEQUEINNAME = ISNULL(CHEQUEINNAME,''), 
			L.NARRATION,
			PRINTEDFLAG = ISNULL(CHQPRINTED,0), 
			L1.MICRNO,
			L.BOOKTYPE, 
			HOPAYMODE,
			M.ACCNO
		FROM 
			ACCOUNT.DBO.V2_SETTPAYOUT_ALL S (NOLOCK)
			LEFT OUTER JOIN MULTIBANKID M (NOLOCK) ON S.CLTCODE = M.CLTCODE AND M.DEFAULTBANK = 1,  
			LEDGER L (NOLOCK), 	
			LEDGER1 L1 (NOLOCK),
			(
			SELECT 
				VNO, 
				VTYP, 
				BOOKTYPE 
			FROM 
				LEDGER (NOLOCK)
			WHERE 
				CLTCODE = @BANKCODE 
				AND VTYP = @VTYP
				AND VNO BETWEEN @VNOFROM AND @VNOTO 
				AND VDT BETWEEN @FROMDATE AND @TODATE
			) B
		WHERE 
			L.VTYP = @VTYP 
			AND L.VTYP = L1.VTYP 
			AND L.BOOKTYPE = L1.BOOKTYPE 
			AND L.VNO = L1.VNO 
			AND L.LNO = L1.LNO			
			AND L.VTYP = B.VTYP 
			AND L.BOOKTYPE = B.BOOKTYPE 
			AND L.VNO = B.VNO
			AND L.VNO BETWEEN @VNOFROM AND @VNOTO 
			AND L.VDT BETWEEN @FROMDATE AND @TODATE 
			AND S.CLTCODE = L.CLTCODE
			AND L.CLTCODE <> @BANKCODE
			AND S.VNO = L.VNO 
			AND S.HOPAYMODE = @FILETYPE 
			AND CHQPRINTED > 0
			AND EXCHANGE = @EXCHANGE 
			AND SEGMENT = @SEGMENT			
		ORDER BY 
			L.VNO
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_BULKPAYOUTPOSTING_ALL
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[V2_BULKPAYOUTPOSTING_ALL]
(
	@SESSIONID VARCHAR(50),
	@UNAME VARCHAR(50),
	@S_SESSIONID VARCHAR(50),
	@GENFLAG VARCHAR(1),
	@SEGMENT VARCHAR(6),
	@CLIENT VARCHAR(10) = ''
)

AS

	-- EXEC ACCOUNT.DBO.V2_BULKPAYOUTPOSTING_ALL '84449309411212008', 'DEMO', '844493094', 'A', 'NSECM' 

	SET NOCOUNT ON

	DECLARE
		@@NEWVNO AS VARCHAR(12),
		@@MAXCOUNT AS INT,
		@@VDT AS VARCHAR(11),
		@@BANKBRANCH AS VARCHAR(10),
		@@BANKCOST AS NUMERIC,
		@@VNOCUR AS CURSOR,
		@@LNOCUR AS CURSOR,
		@@LNOVNO AS VARCHAR(12),
		@@ERROR_COUNT INT,
		@@STD_DATE VARCHAR(11),
		@@LST_DATE VARCHAR(11),
		@@VNOMETHOD INT,
		@@ACNAME CHAR(100),
		@@BOOKTYPE CHAR(2),
		@@MICRNO VARCHAR(10),
		@@DRCR VARCHAR(1),
		@@VTYP SMALLINT,
		@@BNKCODE VARCHAR(100),
		@@MAXVNO INT,
		@@SQL VARCHAR(2500),
		@@EXCH CHAR(3),
		@@SEG CHAR(7)

	IF @SEGMENT = 'NSECM'
	BEGIN
		SET @@EXCH = 'NSE'
		SET @@SEG = 'CAPITAL'
	END

	IF @SEGMENT = 'BSECM'
	BEGIN
		SET @@EXCH = 'BSE'
		SET @@SEG = 'CAPITAL'
	END

	IF @SEGMENT = 'NSEFUT'
	BEGIN
		SET @@EXCH = 'NSE'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'BSEFUT'
	BEGIN
		SET @@EXCH = 'BSE'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'NSXFUT'
	BEGIN
		SET @@EXCH = 'NSX'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'MCDFUT'
	BEGIN
		SET @@EXCH = 'MCD'
		SET @@SEG = 'FUTURES'
	END
	-------------------------- UPDATE BANK CODE DETAILS ------------------------
	UPDATE
		P
	SET 
		BNKNAME = A.ACNAME,
		BRANCHCODE = A.BRANCHCODE,
		MICRNO = A.MICRNO,
		BOOKTYPE = A.BOOKTYPE,
		ACCDTLS = A.ACCDTLS,
		UPDFLAG = 'Y'
	FROM 
		V2_PAYOUT_TEMP P,
		ACMAST A
	WHERE 
		P.BNKCODE = A.CLTCODE
		AND ACCAT = 2
		AND SESSIONID = @SESSIONID

	UPDATE
		P
	SET 
		COSTCODE = C.COSTCODE,
		ACNAME = A.LONGNAME
	FROM 
		ACMAST A,
		COSTMAST C,
		V2_PAYOUT_TEMP P
	WHERE 
		A.CLTCODE = ACCODE
		AND ACCAT IN ('4')
		AND A.BRANCHCODE = C.COSTNAME
		AND SESSIONID = @SESSIONID

	UPDATE
		P
	SET 
		BANKCOST = C.COSTCODE
	FROM 
		ACMAST A,
		COSTMAST C,
		V2_PAYOUT_TEMP P
	WHERE 
		A.CLTCODE = BNKCODE
		AND ACCAT IN ('2')
		AND A.BRANCHCODE = C.COSTNAME
		AND SESSIONID = @SESSIONID

	UPDATE
		V2_PAYOUT_TEMP
	SET 
		BANKCOST = COSTCODE
	WHERE 
		BANKCOST = ''
		AND SESSIONID = @SESSIONID

	-------------------------- VALIDATION BASED ON UPDFLAG ------------------------
	SELECT @@ERROR_COUNT = COUNT(1) FROM
	(
		SELECT DISTINCT 
			ACCODE
		FROM 
			V2_PAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			UPDFLAG = 'N' 
			AND SESSIONID = @SESSIONID
	) A

	IF @@ERROR_COUNT > 0
	BEGIN
		SELECT 
			'FOLLOWING CLIENTS DO NOT EXIST<BR>'
		UNION ALL
		SELECT DISTINCT 
			ACCODE
		FROM 
			V2_PAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			UPDFLAG = 'N' 
			AND SESSIONID = @SESSIONID
		DELETE FROM 
			V2_PAYOUT_TEMP 
		WHERE 
			SESSIONID = @SESSIONID
		RETURN
	END

	--------------------------AUTO GENERATION OF VNO ------------------------
	SELECT
		@@STD_DATE = LEFT(SDTCUR, 11),
		@@LST_DATE = LEFT(LDTCUR, 11),
		@@VNOMETHOD = VNOFLAG
	FROM 
		PARAMETER
	WHERE 
		CURYEAR = 1     

	SET @@VNOCUR = CURSOR FOR
	SELECT DISTINCT
		BNKCODE,
		BOOKTYPE,
		VTYP
	FROM
		V2_PAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	OPEN @@VNOCUR
	FETCH NEXT
	FROM
		@@VNOCUR
	INTO
		@@BNKCODE,
		@@BOOKTYPE,
		@@VTYP
	WHILE @@FETCH_STATUS = 0

	BEGIN
		CREATE TABLE
		#BANK_VNO
		(
			SRNO INT,
			NEWSRNO INT IDENTITY (1, 1)
		)

	INSERT INTO
		#BANK_VNO
	SELECT DISTINCT 
		SRNO
	FROM
		V2_PAYOUT_TEMP WITH(NOLOCK)
	WHERE
		BNKCODE = @@BNKCODE
		AND BOOKTYPE = @@BOOKTYPE
		AND SESSIONID = @SESSIONID

	SELECT
		@@MAXCOUNT = COUNT(DISTINCT SRNO)
	FROM
		V2_PAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	SELECT TOP 1
		@@VDT = VDT
	FROM
		V2_PAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	SELECT  
		LASTVNO  
	INTO 
		#VNO  
	FROM  
		LASTVNO  
	WHERE  
		1 = 2

	SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO  

	INSERT INTO 
		#VNO
	EXEC 
		ACC_GENVNO_NEW
		@@VDT,
		@@VTYP,
		@@BOOKTYPE,
		@@STD_DATE,
		@@LST_DATE,  
		@@MAXVNO  

	SELECT  
		@@NEWVNO = LASTVNO  
	FROM  
		#VNO

	UPDATE
		P
	SET 
		VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1)) 
	FROM
		V2_PAYOUT_TEMP P WITH(NOLOCK),
		#BANK_VNO BV
	WHERE
		P.SRNO = BV.SRNO 
		AND SESSIONID = @SESSIONID

	DROP TABLE #VNO  
	DROP TABLE #BANK_VNO

	FETCH NEXT  
	FROM @@VNOCUR  
	INTO  
		@@BNKCODE,  
		@@BOOKTYPE,
		@@VTYP  
	END  

	DEALLOCATE @@VNOCUR

	--------------------------AUTO GENERATION OF LNO ------------------------
	UPDATE
		V2_PAYOUT_TEMP
	SET 
		LNO = 2
	WHERE 
		VNO IN
	(
		SELECT
			VNO
		FROM 
			V2_PAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			SESSIONID = @SESSIONID
		GROUP BY 
			VNO
		HAVING 
			COUNT(*) = 1
	)

	SET @@LNOCUR = CURSOR FOR
	SELECT
		VNO
	FROM 
		V2_PAYOUT_TEMP WITH(NOLOCK) 
	WHERE 
		SESSIONID = @SESSIONID
	GROUP BY 
		VNO
	HAVING 
		COUNT(*) > 1

	OPEN @@LNOCUR
	FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
	WHILE @@FETCH_STATUS = 0

	BEGIN
		CREATE TABLE [#LNOGEN] 
		(
			VNO VARCHAR(12),
			SNO INT,
			LNO INT IDENTITY(1,1)
		)

		INSERT INTO 
			#LNOGEN
		SELECT
			VNO,
			SRNO
		FROM 
			V2_PAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			VNO = @@LNOVNO 
			AND SESSIONID = @SESSIONID
		ORDER BY 
			SRNO

		UPDATE
			V2_PAYOUT_TEMP
		SET 
			LNO = L.LNO + 1
		FROM 
			#LNOGEN L
		WHERE 
			V2_PAYOUT_TEMP.VNO = L.VNO
			AND V2_PAYOUT_TEMP.SRNO = L.SNO
			AND V2_PAYOUT_TEMP.LNO = 0 
			AND SESSIONID = @SESSIONID

		DROP TABLE #LNOGEN
		FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
	END

	CLOSE @@LNOCUR
	DEALLOCATE @@LNOCUR

	BEGIN TRANSACTION

	--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------
	INSERT INTO 
		LEDGER1
	SELECT
		BNKNAME,
		BRNNAME = BRCODE,
		DD = LEFT(PAYMODE, 1),
		DDNO,
		DDDT = VDT,
		RELDT = '',
		RELAMT = AMT,
		REFNO = 0,
		RECEIPTNO = 0,
		VTYP,
		VNO,
		LNO = 2,
		DRCR,
		BOOKTYPE,
		MICRNO,
		SLIPNO = 0,
		SLIPDATE = '',
		CHEQUEINNAME = ISNULL(ACNAME,''),
		CHQPRINTED = 0,
		CLEAR_MODE = ''
	FROM
		V2_PAYOUT_TEMP 
	WHERE 
		SESSIONID = @SESSIONID

	/*==============================
	CLIENT SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER
	SELECT
		VTYP,
		VNO,
		EDT,
		LNO,
		ACNAME,
		DRCR,
		VAMT = AMT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE = ACCODE,
		BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	INSERT INTO 
		LEDGER2
	SELECT
		VTYP,
		VNO,
		LNO,
		DRCR,
		CAMT = AMT,
		COSTCODE,
		BOOKTYPE,
		CLTCODE = ACCODE
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID
		AND COSTCODE = BANKCOST

	/*==============================
	BANK SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER
	SELECT
		VTYP,
		VNO,
		EDT,
		LNO = 1,
		BNKNAME,
		DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
		VAMT = AMT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE = BNKCODE,
		BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	INSERT INTO 
		LEDGER2
	SELECT
		VTYP,
		VNO,
		LNO = 1,
		DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
		CAMT = AMT,
		COSTCODE,
		BOOKTYPE,
		CLTCODE = BNKCODE
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID
		AND COSTCODE = BANKCOST

	UPDATE 
		V2_PAYOUT_TEMP 
	SET 
		LEDGER2_UPD = 'Y' 
	WHERE 
		SESSIONID = @SESSIONID 
		AND COSTCODE = BANKCOST

	/*==============================
	BANK SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER3
	SELECT
		NARATNO = 1,
		NARRATION,
		REFNO = 0,
		VTYP,
		VNO,
		BOOKTYPE
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	/*==============================
	CLIENT SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER3
	SELECT
		NARATNO = LNO,
		NARR = NARRATION,
		REFNO = 0,
		VTYP,
		VNO,
		BOOKTYPE
	FROM
		V2_PAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	DECLARE @@L2CUR AS CURSOR,
	@@L2VNO AS VARCHAR(12)

	SET @@L2CUR = CURSOR FOR
	SELECT DISTINCT VNO FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND LEDGER2_UPD = 'N' ORDER BY VNO
	OPEN @@L2CUR
	FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	WHILE @@FETCH_STATUS = 0

	BEGIN
		DELETE FROM 
			TEMPLEDGER2
		WHERE 
			SESSIONID =  @S_SESSIONID

		/*==============================
		CLIENT SIDE RECORD
		==============================*/

		INSERT INTO TEMPLEDGER2
		SELECT
			'BRANCH',
			C.COSTNAME,
			AMT,
			VTYP,
			VNO,
			LNO,
			DRCR,
			'0',
			BOOKTYPE,
			@S_SESSIONID ,
			ACCODE,
			'A',
			'0'
		FROM
			V2_PAYOUT_TEMP RP,
			COSTMAST C
		WHERE
			RP.COSTCODE = C.COSTCODE
			AND VNO = @@L2VNO
			AND SESSIONID = @SESSIONID

		/*==============================
		BANK SIDE RECORD
		==============================*/

		INSERT INTO TEMPLEDGER2
		SELECT
			'BRANCH',
			BRANCHCODE,
			SUM(AMT),
			VTYP,
			VNO,
			LNO = 1,
			DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
			'0',
			BOOKTYPE,
			@S_SESSIONID,
			BNKCODE,
			'A',
			'0'
		FROM
			V2_PAYOUT_TEMP
		WHERE
			VNO = @@L2VNO
			AND SESSIONID = @SESSIONID
		GROUP BY 
			BRANCHCODE, 
			VTYP, 
			VNO, 
			(CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), BNKCODE, BOOKTYPE

		EXEC INSERTTOLEDGER2 
				@S_SESSIONID, 
				@@L2VNO, 
				'1', 
				'1', 
				'1', 
				'BROKER', 
				'BROKER'

		FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	END

	DELETE FROM 
		TEMPLEDGER2
	WHERE 
		SESSIONID =  @S_SESSIONID

	SELECT @@SQL = ""
	SELECT @@SQL = @@SQL + "UPDATE S "
	SELECT @@SQL = @@SQL + "SET "
	SELECT @@SQL = @@SQL + "	STATUS = 'A', "
	SELECT @@SQL = @@SQL + "	APPROVEDDT = GETDATE(), "
	SELECT @@SQL = @@SQL + "	HOPAYMODE = P.PAYMODE, "
	SELECT @@SQL = @@SQL + "	BANKCODE = P.BNKCODE, "
	SELECT @@SQL = @@SQL + "	VNO = P.VNO, "
	SELECT @@SQL = @@SQL + "	VDT = P.VDT, "
	SELECT @@SQL = @@SQL + "	EDT = P.EDT, "
	SELECT @@SQL = @@SQL + "	AMOUNTTOBEPAID = P.AMT, "
	SELECT @@SQL = @@SQL + "	REMARK = P.REMARK "
	SELECT @@SQL = @@SQL + "FROM "
	SELECT @@SQL = @@SQL + "	ACCOUNT.DBO.V2_SETTPAYOUT_ALL S, "
	SELECT @@SQL = @@SQL + "	V2_PAYOUT_TEMP P "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	CLTCODE = ACCODE "
	SELECT @@SQL = @@SQL + "	AND S.BRANCHCODE = BRCODE "
	SELECT @@SQL = @@SQL + "	AND GENFLAG = '" + @GENFLAG + "' "
	SELECT @@SQL = @@SQL + "	AND STATUS IN ('P', 'I') "
	SELECT @@SQL = @@SQL + "	AND P.SESSIONID = '" + @SESSIONID + "' "
	SELECT @@SQL = @@SQL + "	AND S.EXCHANGE = '" + @@EXCH + "' "
	SELECT @@SQL = @@SQL + "	AND S.SEGMENT = '" + @@SEG + "' "
	SELECT @@SQL = @@SQL + "	AND S.CLIENT = '" + @CLIENT + "' "

	SELECT @@SQL = @@SQL + "INSERT INTO ACCOUNT.DBO.V2_PAYOUTCLIENT "
	SELECT @@SQL = @@SQL + "SELECT ACCODE FROM V2_PAYOUT_TEMP WHERE UPDFLAG = 'Y' AND SESSIONID = '" + @SESSIONID + "' "

	SELECT @@SQL = @@SQL + "DELETE FROM "
	SELECT @@SQL = @@SQL + "	ACCOUNT.DBO.V2_LEDGERBALANCE_ALL "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	PARTYCODE IN (SELECT CLTCODE FROM ACCOUNT.DBO.V2_PAYOUTCLIENT) "
	SELECT @@SQL = @@SQL + "	AND CLIENT = '" + @CLIENT + "' "

	SELECT @@SQL = @@SQL + "DELETE FROM "
	SELECT @@SQL = @@SQL + "	ACCOUNT.DBO.V2_LEDGERBALANCE_NET "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	PARTY_CODE IN (SELECT CLTCODE FROM ACCOUNT.DBO.V2_PAYOUTCLIENT) "
	SELECT @@SQL = @@SQL + "	AND CLIENT = '" + @CLIENT + "' "

	SELECT @@SQL = @@SQL + "DELETE FROM "
	SELECT @@SQL = @@SQL + "	ACCOUNT.DBO.V2_FOLEDBAL "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	CLTCODE IN (SELECT CLTCODE FROM ACCOUNT.DBO.V2_PAYOUTCLIENT) "

	SELECT @@SQL = @@SQL + "DELETE FROM ACCOUNT.DBO.V2_PAYOUTCLIENT "

	EXEC (@@SQL)

	SELECT @SEGMENT + ' VOUCHER NUMBERS GENERATED : <BR>'
	UNION ALL
	SELECT 'VNO          : ACCODE     : BANKCODE   : AMOUNT~' AS RESULT
	UNION ALL
	SELECT VNO + ' : ' + ACCODE + SPACE(10 - LEN(ACCODE)) + ' : ' + BNKCODE + SPACE(10 - LEN(BNKCODE)) + ' : ' + CONVERT(VARCHAR, AMT) + '~' AS RESULT
	FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
	UNION ALL
	SELECT '<HR>'
	UNION ALL
	SELECT 'NO. OF VOUCHERS POSTED : ' + CONVERT(VARCHAR, COUNT(1)) + '<BR>'
	FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
	UNION ALL
	SELECT 'TOTAL AMOUNT : ' + CONVERT(VARCHAR, SUM(AMT)) + + '<BR><BR>~'
	FROM V2_PAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'

	DELETE FROM 
		V2_PAYOUT_TEMP 
	WHERE 
		SESSIONID = @SESSIONID

	COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_BULKPAYOUTPOSTING_SEBI
-- --------------------------------------------------

CREATE PROCEDURE [DBO].[V2_BULKPAYOUTPOSTING_SEBI]
(
	@SESSIONID VARCHAR(50),
	@UNAME VARCHAR(50),
	@S_SESSIONID VARCHAR(50),
	@GENFLAG VARCHAR(1),
	@SEGMENT VARCHAR(6)
)

AS

	-- EXEC ACCOUNT.DBO.V2_BULKPAYOUTPOSTING_SEBI '84449309411212008', 'DEMO', '844493094', 'A', 'NSECM' 

	SET NOCOUNT ON

	DECLARE
		@@NEWVNO AS VARCHAR(12),
		@@MAXCOUNT AS INT,
		@@VDT AS VARCHAR(11),
		@@BANKBRANCH AS VARCHAR(10),
		@@BANKCOST AS NUMERIC,
		@@VNOCUR AS CURSOR,
		@@LNOCUR AS CURSOR,
		@@LNOVNO AS VARCHAR(12),
		@@ERROR_COUNT INT,
		@@STD_DATE VARCHAR(11),
		@@LST_DATE VARCHAR(11),
		@@VNOMETHOD INT,
		@@ACNAME CHAR(100),
		@@BOOKTYPE CHAR(2),
		@@MICRNO VARCHAR(10),
		@@DRCR VARCHAR(1),
		@@VTYP SMALLINT,
		@@BNKCODE VARCHAR(100),
		@@MAXVNO INT,
		@@SQL VARCHAR(MAX),
		@@EXCH CHAR(3),
		@@SEG CHAR(7)

	IF @SEGMENT = 'NSECM'
	BEGIN
		SET @@EXCH = 'NSE'
		SET @@SEG = 'CAPITAL'
	END

	IF @SEGMENT = 'BSECM'
	BEGIN
		SET @@EXCH = 'BSE'
		SET @@SEG = 'CAPITAL'
	END

	IF @SEGMENT = 'NSEFUT'
	BEGIN
		SET @@EXCH = 'NSE'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'BSEFUT'
	BEGIN
		SET @@EXCH = 'BSE'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'NSXFUT'
	BEGIN
		SET @@EXCH = 'NSX'
		SET @@SEG = 'FUTURES'
	END

	IF @SEGMENT = 'MCDFUT'
	BEGIN
		SET @@EXCH = 'MCD'
		SET @@SEG = 'FUTURES'
	END
	-------------------------- UPDATE BANK CODE DETAILS ------------------------
	UPDATE
		P
	SET 
		BNKNAME = A.ACNAME,
		BRANCHCODE = A.BRANCHCODE,
		MICRNO = A.MICRNO,
		BOOKTYPE = A.BOOKTYPE,
		ACCDTLS = A.ACCDTLS,
		UPDFLAG = 'Y'
	FROM 
		V2_SEBIPAYOUT_TEMP P,
		ACMAST A
	WHERE 
		P.BNKCODE = A.CLTCODE
		AND ACCAT = 2
		AND SESSIONID = @SESSIONID

	UPDATE
		P
	SET 
		COSTCODE = C.COSTCODE,
		ACNAME = A.LONGNAME
	FROM 
		ACMAST A,
		COSTMAST C,
		V2_SEBIPAYOUT_TEMP P
	WHERE 
		A.CLTCODE = ACCODE
		AND ACCAT IN ('4')
		AND A.BRANCHCODE = C.COSTNAME
		AND SESSIONID = @SESSIONID

	UPDATE
		P
	SET 
		BANKCOST = C.COSTCODE
	FROM 
		ACMAST A,
		COSTMAST C,
		V2_SEBIPAYOUT_TEMP P
	WHERE 
		A.CLTCODE = BNKCODE
		AND ACCAT IN ('2')
		AND A.BRANCHCODE = C.COSTNAME
		AND SESSIONID = @SESSIONID

	UPDATE
		V2_SEBIPAYOUT_TEMP
	SET 
		BANKCOST = COSTCODE
	WHERE 
		BANKCOST = ''
		AND SESSIONID = @SESSIONID

	-------------------------- VALIDATION BASED ON UPDFLAG ------------------------
	SELECT @@ERROR_COUNT = COUNT(1) FROM
	(
		SELECT DISTINCT 
			ACCODE
		FROM 
			V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			UPDFLAG = 'N' 
			AND SESSIONID = @SESSIONID
	) A

	IF @@ERROR_COUNT > 0
	BEGIN
		SELECT 
			'FOLLOWING CLIENTS DO NOT EXIST<BR>'
		UNION ALL
		SELECT DISTINCT 
			ACCODE
		FROM 
			V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			UPDFLAG = 'N' 
			AND SESSIONID = @SESSIONID
		DELETE FROM 
			V2_SEBIPAYOUT_TEMP 
		WHERE 
			SESSIONID = @SESSIONID
		RETURN
	END

	--------------------------AUTO GENERATION OF VNO ------------------------
	SELECT
		@@STD_DATE = LEFT(SDTCUR, 11),
		@@LST_DATE = LEFT(LDTCUR, 11),
		@@VNOMETHOD = VNOFLAG
	FROM 
		PARAMETER
	WHERE 
		CURYEAR = 1     

	SET @@VNOCUR = CURSOR FOR
	SELECT DISTINCT
		BNKCODE,
		BOOKTYPE,
		VTYP
	FROM
		V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	OPEN @@VNOCUR
	FETCH NEXT
	FROM
		@@VNOCUR
	INTO
		@@BNKCODE,
		@@BOOKTYPE,
		@@VTYP
	WHILE @@FETCH_STATUS = 0

	BEGIN
		CREATE TABLE
		#BANK_VNO
		(
			SRNO INT,
			NEWSRNO INT IDENTITY (1, 1)
		)

	INSERT INTO
		#BANK_VNO
	SELECT DISTINCT 
		SRNO
	FROM
		V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
	WHERE
		BNKCODE = @@BNKCODE
		AND BOOKTYPE = @@BOOKTYPE
		AND SESSIONID = @SESSIONID

	SELECT
		@@MAXCOUNT = COUNT(DISTINCT SRNO)
	FROM
		V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	SELECT TOP 1
		@@VDT = VDT
	FROM
		V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
	WHERE
		SESSIONID = @SESSIONID

	SELECT  
		LASTVNO  
	INTO 
		#VNO  
	FROM  
		LASTVNO  
	WHERE  
		1 = 2

	SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO  

	INSERT INTO 
		#VNO
	EXEC 
		ACC_GENVNO_NEW
		@@VDT,
		@@VTYP,
		@@BOOKTYPE,
		@@STD_DATE,
		@@LST_DATE,  
		@@MAXVNO  

	SELECT  
		@@NEWVNO = LASTVNO  
	FROM  
		#VNO

	UPDATE
		P
	SET 
		VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1)) 
	FROM
		V2_SEBIPAYOUT_TEMP P WITH(NOLOCK),
		#BANK_VNO BV
	WHERE
		P.SRNO = BV.SRNO 
		AND SESSIONID = @SESSIONID

	DROP TABLE #VNO  
	DROP TABLE #BANK_VNO

	FETCH NEXT  
	FROM @@VNOCUR  
	INTO  
		@@BNKCODE,  
		@@BOOKTYPE,
		@@VTYP  
	END  

	DEALLOCATE @@VNOCUR

	--------------------------AUTO GENERATION OF LNO ------------------------
	UPDATE
		V2_SEBIPAYOUT_TEMP
	SET 
		LNO = 2
	WHERE 
		VNO IN
	(
		SELECT
			VNO
		FROM 
			V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			SESSIONID = @SESSIONID
		GROUP BY 
			VNO
		HAVING 
			COUNT(*) = 1
	)

	SET @@LNOCUR = CURSOR FOR
	SELECT
		VNO
	FROM 
		V2_SEBIPAYOUT_TEMP WITH(NOLOCK) 
	WHERE 
		SESSIONID = @SESSIONID
	GROUP BY 
		VNO
	HAVING 
		COUNT(*) > 1

	OPEN @@LNOCUR
	FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
	WHILE @@FETCH_STATUS = 0

	BEGIN
		CREATE TABLE [#LNOGEN] 
		(
			VNO VARCHAR(12),
			SNO INT,
			LNO INT IDENTITY(1,1)
		)

		INSERT INTO 
			#LNOGEN
		SELECT
			VNO,
			SRNO
		FROM 
			V2_SEBIPAYOUT_TEMP WITH(NOLOCK)
		WHERE 
			VNO = @@LNOVNO 
			AND SESSIONID = @SESSIONID
		ORDER BY 
			SRNO

		UPDATE
			V2_SEBIPAYOUT_TEMP
		SET 
			LNO = L.LNO + 1
		FROM 
			#LNOGEN L
		WHERE 
			V2_SEBIPAYOUT_TEMP.VNO = L.VNO
			AND V2_SEBIPAYOUT_TEMP.SRNO = L.SNO
			AND V2_SEBIPAYOUT_TEMP.LNO = 0 
			AND SESSIONID = @SESSIONID

		DROP TABLE #LNOGEN
		FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO
	END

	CLOSE @@LNOCUR
	DEALLOCATE @@LNOCUR

	BEGIN TRANSACTION

	--------------------------BEGIN POSTING TO TRANSACTION TABLES ------------------------
	INSERT INTO 
		LEDGER1
	SELECT
		BNKNAME,
		BRNNAME = BRCODE,
		DD = LEFT(PAYMODE, 1),
		DDNO,
		DDDT = VDT,
		RELDT = '',
		RELAMT = AMT,
		REFNO = 0,
		RECEIPTNO = 0,
		VTYP,
		VNO,
		LNO = 2,
		DRCR,
		BOOKTYPE,
		MICRNO,
		SLIPNO = 0,
		SLIPDATE = '',
		CHEQUEINNAME = ISNULL(ACNAME,''),
		CHQPRINTED = 0,
		CLEAR_MODE = ''
	FROM
		V2_SEBIPAYOUT_TEMP 
	WHERE 
		SESSIONID = @SESSIONID

	/*==============================
	CLIENT SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER
	SELECT
		VTYP,
		VNO,
		EDT,
		LNO,
		ACNAME,
		DRCR,
		VAMT = AMT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE = ACCODE,
		BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		V2_SEBIPAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	INSERT INTO 
		LEDGER2
	SELECT
		VTYP,
		VNO,
		LNO,
		DRCR,
		CAMT = AMT,
		COSTCODE,
		BOOKTYPE,
		CLTCODE = ACCODE
	FROM
		V2_SEBIPAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID
		AND COSTCODE = BANKCOST

	/*==============================
	BANK SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER
	SELECT
		VTYP,
		VNO,
		EDT,
		LNO = 1,
		BNKNAME,
		DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
		VAMT = AMT,
		VDT,
		VNO1 = VNO,
		REFNO = 0,
		BALAMT = AMT,
		NODAYS = 0,
		CDT = GETDATE(),
		CLTCODE = BNKCODE,
		BOOKTYPE,
		ENTEREDBY = @UNAME,
		PDT = GETDATE(),
		CHECKEDBY = @UNAME,
		ACTNODAYS = 0,
		NARRATION
	FROM
		V2_SEBIPAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	INSERT INTO 
		LEDGER2
	SELECT
		VTYP,
		VNO,
		LNO = 1,
		DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
		CAMT = AMT,
		COSTCODE,
		BOOKTYPE,
		CLTCODE = BNKCODE
	FROM
		V2_SEBIPAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID
		AND COSTCODE = BANKCOST

	UPDATE 
		V2_SEBIPAYOUT_TEMP 
	SET 
		LEDGER2_UPD = 'Y' 
	WHERE 
		SESSIONID = @SESSIONID 
		AND COSTCODE = BANKCOST

	/*==============================
	BANK SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER3
	SELECT
		NARATNO = 1,
		NARRATION,
		REFNO = 0,
		VTYP,
		VNO,
		BOOKTYPE
	FROM
		V2_SEBIPAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	/*==============================
	CLIENT SIDE RECORD
	==============================*/
	INSERT INTO 
		LEDGER3
	SELECT
		NARATNO = LNO,
		NARR = NARRATION,
		REFNO = 0,
		VTYP,
		VNO,
		BOOKTYPE
	FROM
		V2_SEBIPAYOUT_TEMP
	WHERE
		SESSIONID = @SESSIONID

	DECLARE @@L2CUR AS CURSOR,
	@@L2VNO AS VARCHAR(12)

	SET @@L2CUR = CURSOR FOR
	SELECT DISTINCT VNO FROM V2_SEBIPAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND LEDGER2_UPD = 'N' ORDER BY VNO
	OPEN @@L2CUR
	FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	WHILE @@FETCH_STATUS = 0

	BEGIN
		DELETE FROM 
			TEMPLEDGER2
		WHERE 
			SESSIONID =  @S_SESSIONID

		/*==============================
		CLIENT SIDE RECORD
		==============================*/

		INSERT INTO TEMPLEDGER2
		SELECT
			'BRANCH',
			C.COSTNAME,
			AMT,
			VTYP,
			VNO,
			LNO,
			DRCR,
			'0',
			BOOKTYPE,
			@S_SESSIONID ,
			ACCODE,
			'A',
			'0'
		FROM
			V2_SEBIPAYOUT_TEMP RP,
			COSTMAST C
		WHERE
			RP.COSTCODE = C.COSTCODE
			AND VNO = @@L2VNO
			AND SESSIONID = @SESSIONID

		/*==============================
		BANK SIDE RECORD
		==============================*/

		INSERT INTO TEMPLEDGER2
		SELECT
			'BRANCH',
			BRANCHCODE,
			SUM(AMT),
			VTYP,
			VNO,
			LNO = 1,
			DRCR = (CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END),
			'0',
			BOOKTYPE,
			@S_SESSIONID,
			BNKCODE,
			'A',
			'0'
		FROM
			V2_SEBIPAYOUT_TEMP
		WHERE
			VNO = @@L2VNO
			AND SESSIONID = @SESSIONID
		GROUP BY 
			BRANCHCODE, 
			VTYP, 
			VNO, 
			(CASE WHEN DRCR = 'D' THEN 'C' ELSE 'D' END), BNKCODE, BOOKTYPE

		EXEC INSERTTOLEDGER2 
				@S_SESSIONID, 
				@@L2VNO, 
				'1', 
				'1', 
				'1', 
				'BROKER', 
				'BROKER'

		FETCH NEXT FROM @@L2CUR INTO @@L2VNO
	END

	DELETE FROM 
		TEMPLEDGER2
	WHERE 
		SESSIONID =  @S_SESSIONID

	SELECT @@SQL = ""
	SELECT @@SQL = @@SQL + "UPDATE S "
	SELECT @@SQL = @@SQL + "SET "
	SELECT @@SQL = @@SQL + "	STATUS = 'A', "
	SELECT @@SQL = @@SQL + "	PROCESS_DT = GETDATE(), "
	SELECT @@SQL = @@SQL + "	PAYMODE = P.PAYMODE, "
	SELECT @@SQL = @@SQL + "	BANKCODE = P.BNKCODE, "
	SELECT @@SQL = @@SQL + "	VNO = P.VNO, "
	SELECT @@SQL = @@SQL + "	VCH_DT = P.VDT, "	
	SELECT @@SQL = @@SQL + "	SEBIPOAMT = P.AMT, "
	SELECT @@SQL = @@SQL + "	REMARK = P.REMARK, "
	SELECT @@SQL = @@SQL + "	ACCNO = P.ACCNO "
	SELECT @@SQL = @@SQL + "FROM "
	SELECT @@SQL = @@SQL + "	ACCOUNT.DBO.SEBIPAYOUT_ALL S, "
	SELECT @@SQL = @@SQL + "	V2_SEBIPAYOUT_TEMP P "
	SELECT @@SQL = @@SQL + "WHERE "
	SELECT @@SQL = @@SQL + "	PARTYCODE = ACCODE "	
	SELECT @@SQL = @@SQL + "	AND STATUS = 'P' "
	SELECT @@SQL = @@SQL + "	AND P.SESSIONID = '" + @SESSIONID + "' "
	SELECT @@SQL = @@SQL + "	AND S.EXCHANGE = '" + @@EXCH + "' "
	SELECT @@SQL = @@SQL + "	AND S.SEGMENT = '" + @@SEG + "' "
		
	EXEC (@@SQL)

	SELECT @SEGMENT + ' VOUCHER NUMBERS GENERATED : <BR>'
	UNION ALL
	SELECT 'VNO          : ACCODE     : BANKCODE   : AMOUNT~' AS RESULT
	UNION ALL
	SELECT VNO + ' : ' + ACCODE + SPACE(10 - LEN(ACCODE)) + ' : ' + BNKCODE + SPACE(10 - LEN(BNKCODE)) + ' : ' + CONVERT(VARCHAR, AMT) + '~' AS RESULT
	FROM V2_SEBIPAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
	UNION ALL
	SELECT '<HR>'
	UNION ALL
	SELECT 'NO. OF VOUCHERS POSTED : ' + CONVERT(VARCHAR, COUNT(1)) + '<BR>'
	FROM V2_SEBIPAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'
	UNION ALL
	SELECT 'TOTAL AMOUNT : ' + CONVERT(VARCHAR, SUM(AMT)) + + '<BR><BR>~'
	FROM V2_SEBIPAYOUT_TEMP WHERE SESSIONID = @SESSIONID AND UPDFLAG = 'Y'

	DELETE FROM 
		V2_SEBIPAYOUT_TEMP 
	WHERE 
		SESSIONID = @SESSIONID

	COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_FT_COMBINED
-- --------------------------------------------------


/****** OBJECT:  STORED PROCEDURE DBO.V2_FT_COMBINED    SCRIPT DATE: 02/27/2008 1:33:57 PM ******/


CREATE  PROC [DBO].[V2_FT_COMBINED]  
 @START_DATE VARCHAR(11),  
 @END_DATE VARCHAR(11),  
 @VDT VARCHAR(11),  
 @CLIENT_FR VARCHAR(15),  
 @CLIENT_TO VARCHAR(15),  
 @BRANCH_CODE VARCHAR(15),  
 @DATE_TYPE CHAR(3),  
 @SR_NO VARCHAR(100),  
 @GL_CODE VARCHAR(15),  
 @GL_NAME VARCHAR(50),  
 @UNAME VARCHAR(100),  
 @COMPUTE_FLG BIT,  
 @COMP_FLAG CHAR(3) = 'FDT',  
 @ML_CODE VARCHAR(15) = 'MARG001' ,  
 @ML_NAME VARCHAR(50) = 'MARGIN'  
  
AS  
  
  
/*  
BEGIN TRAN  
EXEC V2_FT_COMBINED 'APR  1 2007', 'MAR 31 2008', 'FEB  1 2008', 'ARSL1', 'ARSL1', '', '', '1,2,3,4,5,6,7,8', 'GL_TEST', 'GL_NAME', 'NIKHIL', 0  
ROLLBACK  
*/  
  
DECLARE   
 @SDTCUR VARCHAR(11),   
 @LDTCUR VARCHAR(11)   
  
 SELECT @SDTCUR = LEFT(CONVERT(VARCHAR,SDTCUR,109),11),  
        @LDTCUR = LEFT(CONVERT(VARCHAR,LDTCUR,109),11)    
 FROM   ACCOUNTMCDXCDS.DBO.PARAMETER  
 WHERE  @VDT BETWEEN SDTCUR AND LDTCUR  
   
/*MCX COLLATERAL CALCULATION*/  
 DELETE FROM MSAJAG.DBO.C_MARGINLEDGER  
               
 INSERT INTO MSAJAG.DBO.C_MARGINLEDGER  
 SELECT   M.EXCHANGE,  
          LEFT(M.SEGMENT,8),  
          M.PARTY_CODE,  
          CAMT = ISNULL((CASE   
                           WHEN DRCR = 'C' THEN SUM(AMOUNT)  
                           ELSE 0  
                         END),0),  
          DAMT = ISNULL((CASE   
                           WHEN DRCR = 'D' THEN SUM(AMOUNT)  
                           ELSE 0  
                         END),0),  
          DRCR  
 FROM     ACCOUNTMCDXCDS.DBO.MARGINLEDGER M  
          LEFT OUTER JOIN MSAJAG.DBO.C_ACCOUNTMAPPING A  
            ON (MCLTCODE = ACCOUNTCODE  
                AND A.PARTY_CODE = M.PARTY_CODE  
                AND A.EXCHANGE = M.EXCHANGE  
                AND A.SEGMENT = LEFT(M.SEGMENT,7)  
                AND ACTIVE = 1  
                AND EFFDATE <= @VDT + ' 23:59:59')  
 WHERE    VDT >= @SDTCUR  
          AND VDT <= @VDT + ' 23:59:59'  
          AND M.EXCHANGE = 'MCD'  
          AND LEFT(M.SEGMENT,7) = 'FUTURES'  
    AND M.PARTY_CODE BETWEEN @CLIENT_FR AND @CLIENT_TO   
 GROUP BY DRCR,M.PARTY_CODE,M.EXCHANGE,LEFT(M.SEGMENT,8)  
            
 EXEC MSAJAG.DBO.C_COLLATERALCALCULATIONSPMS  
   'MCD' ,  
   'FUTURES' ,  
   @CLIENT_FR,  
   @CLIENT_TO,  
   @VDT,  
   'MCDX' ,  
   'RMBKOFFDB1' ,  
   1  


  
/*NCDEX COLLATERAL CALCULATION*/  
 DELETE FROM MSAJAG.DBO.C_MARGINLEDGER  
               
 INSERT INTO MSAJAG.DBO.C_MARGINLEDGER  
 SELECT   M.EXCHANGE,  
          LEFT(M.SEGMENT,8),  
          M.PARTY_CODE,  
          CAMT = ISNULL((CASE   
                           WHEN DRCR = 'C' THEN SUM(AMOUNT)  
                           ELSE 0  
                         END),0),  
          DAMT = ISNULL((CASE   
                           WHEN DRCR = 'D' THEN SUM(AMOUNT)  
                           ELSE 0  
                         END),0),  
          DRCR  
 FROM     ACCOUNTNCDX.DBO.MARGINLEDGER M  
          LEFT OUTER JOIN MSAJAG.DBO.C_ACCOUNTMAPPING A  
            ON (MCLTCODE = ACCOUNTCODE  
                AND A.PARTY_CODE = M.PARTY_CODE  
                AND A.EXCHANGE = M.EXCHANGE  
                AND A.SEGMENT = LEFT(M.SEGMENT,7)  
                AND ACTIVE = 1  
                AND EFFDATE <= @VDT + ' 23:59:59')  
 WHERE    VDT >= @SDTCUR  
          AND VDT <= @VDT + ' 23:59:59'  
          AND M.EXCHANGE = 'NCX'  
          AND LEFT(M.SEGMENT,7) = 'FUTURES'  
    AND M.PARTY_CODE BETWEEN @CLIENT_FR AND @CLIENT_TO   
 GROUP BY DRCR,M.PARTY_CODE,M.EXCHANGE,LEFT(M.SEGMENT,8)  
            
 EXEC MSAJAG.DBO.C_COLLATERALCALCULATIONSPMS  
   'NCX' ,  
   'FUTURES' ,  
   @CLIENT_FR,  
   @CLIENT_TO,  
   @VDT,  
   'NCDX' ,  
   'RMBKOFFDB1' ,  
   1  


  
/*MARGIN CALCULATION FOR NCDEX*/  
 EXEC NCDX.DBO.CLIENTMARGIN_UPD @VDT  
/*MARGIN CALCULATION FOR MCX */  
 EXEC MCDXCDS.DBO.CLIENTMARGIN_UPD @VDT  
  
  
DECLARE  
 @@COMPUTE_CUR AS CURSOR,  
 @@FT_CUR AS CURSOR,  
 @@EXCH_FR VARCHAR(15),  
 @@DB_FR VARCHAR(15),  
 @@EXCH_TO VARCHAR(15),  
 @@EXCH_DEFAULT VARCHAR(15),  
 @@DB_TO VARCHAR(15),  
 @@SR_NO SMALLINT,  
 @@TRF_TYPE TINYINT,  
 @@VNO_FR VARCHAR(12),  
 @@VNO_TO VARCHAR(12),  
 @@VNO_COMMON VARCHAR(12),  
 @@VNO_COUNT INT,  
 @@SQL VARCHAR(8000),  
 @@MCL_CODE VARCHAR(15),  
 @@MCL_NAME VARCHAR(50),  
 @@JV_CODE VARCHAR(15),  
 @@JV_NAME VARCHAR(50)  
  
/*SET @@MCL_CODE = '16004'  
SELECT @@MCL_NAME = ACNAME FROM ACCOUNTMCDXCDS.DBO.ACMAST WHERE CLTCODE = @@MCL_CODE  */

SET @@MCL_CODE = '77777'  
SELECT @@MCL_NAME = ACNAME FROM ACCOUNTMCDXCDS.DBO.ACMAST WHERE CLTCODE = @@MCL_CODE  
  
SET @@JV_CODE = '77777'  
SELECT @@JV_NAME = ACNAME FROM ACCOUNTMCDXCDS.DBO.ACMAST WHERE CLTCODE = @@JV_CODE  
  
TRUNCATE TABLE V2_FT_COMPUTEBALANCES  
  
CREATE TABLE #EXCHANGE_LIST  
(  
 EXCH_FR VARCHAR(15),  
 DB_FR VARCHAR(15)  
)  
  
CREATE TABLE #SRNO  
(  
 SRNO SMALLINT  
)  
  
INSERT INTO #EXCHANGE_LIST  
SELECT EXCH_FR, DB_FR FROM V2_FT_PRIORITY WHERE SR_NO IN (SELECT * FROM SPLIT(@SR_NO, ','))  
UNION ALL  
SELECT EXCH_TO, DB_TO FROM V2_FT_PRIORITY WHERE SR_NO IN (SELECT * FROM SPLIT(@SR_NO, ','))  
  
SET @@COMPUTE_CUR = CURSOR FOR  
 SELECT DISTINCT EXCH_FR, DB_FR FROM #EXCHANGE_LIST  
  
OPEN @@COMPUTE_CUR  
FETCH NEXT FROM @@COMPUTE_CUR INTO @@EXCH_FR, @@DB_FR  
  
WHILE @@FETCH_STATUS = 0  
 BEGIN  
  
  IF @@EXCH_FR <> 'MCXMRG' AND @@EXCH_FR <> 'NCXMRG'  
  BEGIN  
   SET @@SQL = " INSERT INTO V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " SELECT CLTCODE, ACNAME, LEDGER_TYPE, 0, SUM(FINAL_AMOUNT), SUM(LEDGER_AMOUNT), 0, 0, 0, 0, 0, 0, 0, '', '', LNO, '' FROM "  
   SET @@SQL = @@SQL + " (SELECT A.CLTCODE, A.ACNAME, LEDGER_TYPE = '" + @@EXCH_FR + "', VTYPE = 0, "  
   SET @@SQL = @@SQL + " FINAL_AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END), "  
   SET @@SQL = @@SQL + " LEDGER_AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END), "  
   SET @@SQL = @@SQL + " MARGIN_AMOUNT = 0, "  
   SET @@SQL = @@SQL + " CASH_COLL = 0, "  
   SET @@SQL = @@SQL + " NONCASH_COLL = 0, "  
   SET @@SQL = @@SQL + " INITIALMARGIN = 0, "  
   SET @@SQL = @@SQL + " MTMMARGIN = 0, "  
   SET @@SQL = @@SQL + " ADDITIONAL_MARGIN = 0, "  
   SET @@SQL = @@SQL + " ENTRY_TYPE = 0, "  
   SET @@SQL = @@SQL + " SOURCE_VO = '', "  
   SET @@SQL = @@SQL + " TARGET_VNO = '', "  
   SET @@SQL = @@SQL + " LNO = 0, "  
   SET @@SQL = @@SQL + " NARRATION = '' "  
   SET @@SQL = @@SQL + " FROM " + @@DB_FR + ".DBO.LEDGER L, "  
   SET @@SQL = @@SQL + @@DB_FR + ".DBO.ACMAST A"  
   SET @@SQL = @@SQL + " WHERE A.CLTCODE = L.CLTCODE "  
   SET @@SQL = @@SQL + " AND A.ACCAT = 4 "  
  
   IF @COMP_FLAG = "EDT" OR @COMP_FLAG = "FDT"  
   BEGIN  
    SET @@SQL = @@SQL + " AND EDT BETWEEN '" + @START_DATE + "' AND '" + @VDT + " 23:59:59'"  
   END  
   ELSE  
   BEGIN  
    SET @@SQL = @@SQL + " AND VDT BETWEEN '" + @START_DATE + "' AND '" + @VDT + " 23:59:59'"  
   END  
  
   SET @@SQL = @@SQL + " AND A.CLTCODE BETWEEN '" + @CLIENT_FR + "' AND '" + @CLIENT_TO + "'"  
   SET @@SQL = @@SQL + " GROUP BY A.CLTCODE, A.ACNAME "  
  
   IF @COMP_FLAG = "EDT" OR @COMP_FLAG = "FDT"  
   BEGIN  
    SET @@SQL = @@SQL + " UNION ALL "  
    SET @@SQL = @@SQL + " SELECT A.CLTCODE, A.ACNAME, LEDGER_TYPE = '" + @@EXCH_FR + "', VTYPE = 0, "  
    SET @@SQL = @@SQL + " FINAL_AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END), "  
    SET @@SQL = @@SQL + " LEDGER_AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END), "  
    SET @@SQL = @@SQL + " MARGIN_AMOUNT = 0, "  
    SET @@SQL = @@SQL + " CASH_COLL = 0, "  
    SET @@SQL = @@SQL + " NONCASH_COLL = 0, "  
    SET @@SQL = @@SQL + " INITIALMARGIN = 0, "  
    SET @@SQL = @@SQL + " MTMMARGIN = 0, "  
    SET @@SQL = @@SQL + " ADDITIONAL_MARGIN = 0, "  
    SET @@SQL = @@SQL + " ENTRY_TYPE = 0, "  
    SET @@SQL = @@SQL + " SOURCE_VO = '', "  
    SET @@SQL = @@SQL + " TARGET_VNO = '', "  
    SET @@SQL = @@SQL + " LNO = 0, "  
    SET @@SQL = @@SQL + " NARRATION = '' "  
    SET @@SQL = @@SQL + " FROM " + @@DB_FR + ".DBO.LEDGER L, "  
    SET @@SQL = @@SQL + @@DB_FR + ".DBO.ACMAST A"  
    SET @@SQL = @@SQL + " WHERE A.CLTCODE = L.CLTCODE "  
    SET @@SQL = @@SQL + " AND A.ACCAT = 4 "  
    SET @@SQL = @@SQL + " AND EDT >= '" + @START_DATE + "' AND VDT < '" + @START_DATE + "'"  
    SET @@SQL = @@SQL + " AND A.CLTCODE BETWEEN '" + @CLIENT_FR + "' AND '" + @CLIENT_TO + "'"  
    SET @@SQL = @@SQL + " GROUP BY A.CLTCODE, A.ACNAME "  
   END  
  
 /*  IF @COMP_FLAG = "FDT"  
   BEGIN  
    SET @@SQL = @@SQL + " UNION ALL "     
    SET @@SQL = @@SQL + " SELECT A.CLTCODE, A.ACNAME, LEDGER_TYPE = '" + @@EXCH_FR + "', VTYPE = 0, "  
    SET @@SQL = @@SQL + " FINAL_AMOUNT = SUM(CASE DRCR WHEN 'C' THEN 0 ELSE -VAMT END), "  
    SET @@SQL = @@SQL + " LEDGER_AMOUNT = SUM(CASE DRCR WHEN 'C' THEN 0 ELSE -VAMT END), "  
    SET @@SQL = @@SQL + " MARGIN_AMOUNT = 0, "  
    SET @@SQL = @@SQL + " CASH_COLL = 0, "  
    SET @@SQL = @@SQL + " NONCASH_COLL = 0, "  
    SET @@SQL = @@SQL + " INITIALMARGIN = 0, "  
    SET @@SQL = @@SQL + " MTMMARGIN = 0, "  
    SET @@SQL = @@SQL + " ADDITIONAL_MARGIN = 0, "  
    SET @@SQL = @@SQL + " ENTRY_TYPE = 0, "  
    SET @@SQL = @@SQL + " SOURCE_VO = '', "  
    SET @@SQL = @@SQL + " TARGET_VNO = '', "  
    SET @@SQL = @@SQL + " LNO = 0, "  
    SET @@SQL = @@SQL + " NARRATION = '' "  
    SET @@SQL = @@SQL + " FROM " + @@DB_FR + ".DBO.LEDGER L, "  
    SET @@SQL = @@SQL + @@DB_FR + ".DBO.ACMAST A"  
    SET @@SQL = @@SQL + " WHERE A.CLTCODE = L.CLTCODE "  
    SET @@SQL = @@SQL + " AND A.ACCAT = 4 "  
    SET @@SQL = @@SQL + " AND EDT > '" + @VDT + " 23:59:59'"  
    SET @@SQL = @@SQL + " AND A.CLTCODE BETWEEN '" + @CLIENT_FR + "' AND '" + @CLIENT_TO + "'"  
    SET @@SQL = @@SQL + " GROUP BY A.CLTCODE, A.ACNAME "  
   END  
  */
   SET @@SQL = @@SQL + ") B GROUP BY CLTCODE, LEDGER_TYPE, ACNAME, LNO "  
  
   EXEC (@@SQL)  
  END  
/*  
  IF @@EXCH_FR = 'MCXMRG' OR @@EXCH_FR = 'NCXMRG'  
  BEGIN  
   SET @@SQL = " INSERT INTO V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " SELECT A.CLTCODE, A.ACNAME, LEDGER_TYPE = '" + @@EXCH_FR + "', VTYPE = 0, "  
   SET @@SQL = @@SQL + " FINAL_AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END), "  
   SET @@SQL = @@SQL + " LEDGER_AMOUNT = SUM(CASE DRCR WHEN 'C' THEN AMOUNT ELSE -AMOUNT END), "  
   SET @@SQL = @@SQL + " MARGIN_AMOUNT = 0, "  
   SET @@SQL = @@SQL + " CASH_COLL = 0, "  
   SET @@SQL = @@SQL + " NONCASH_COLL = 0, "  
   SET @@SQL = @@SQL + " INITIALMARGIN = 0, "  
   SET @@SQL = @@SQL + " MTMMARGIN = 0, "  
   SET @@SQL = @@SQL + " ADDITIONAL_MARGIN = 0, "  
   SET @@SQL = @@SQL + " ENTRY_TYPE = 0, "  
   SET @@SQL = @@SQL + " SOURCE_VO = '', "  
   SET @@SQL = @@SQL + " TARGET_VNO = '', "  
   SET @@SQL = @@SQL + " LNO = 0, "  
   SET @@SQL = @@SQL + " NARRATION = '' "  
   SET @@SQL = @@SQL + " FROM " + @@DB_FR + ".DBO.MARGINLEDGER L, "  
   SET @@SQL = @@SQL + @@DB_FR + ".DBO.ACMAST A"  
   SET @@SQL = @@SQL + " WHERE A.CLTCODE = L.PARTY_CODE "  
   SET @@SQL = @@SQL + " AND A.ACCAT = 4 "  
   SET @@SQL = @@SQL + " AND VDT BETWEEN '" + @START_DATE + "' AND '" + @VDT + " 23:59:59'"  
   SET @@SQL = @@SQL + " AND A.CLTCODE BETWEEN '" + @CLIENT_FR + "' AND '" + @CLIENT_TO + "'"  
   SET @@SQL = @@SQL + " GROUP BY A.CLTCODE, A.ACNAME "  
  
   EXEC (@@SQL)  
  END  
*/  
  IF @@EXCH_FR = 'MCXMRG'  
  BEGIN  
   SET @@SQL = " INSERT INTO V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " SELECT A.CLTCODE, A.ACNAME, LEDGER_TYPE = '" + @@EXCH_FR + "', VTYPE = 0, "  
   SET @@SQL = @@SQL + " FINAL_AMOUNT = CASH_COLL + (CASE WHEN (CL.NONCASH_COLL - (CL.INITIALMARGIN + CL.MTMMARGIN)) > 0 THEN 0 ELSE (CL.NONCASH_COLL - (CL.INITIALMARGIN + CL.MTMMARGIN)) END), "  
   SET @@SQL = @@SQL + " LEDGER_AMOUNT = CASH_COLL, "  
   SET @@SQL = @@SQL + " MARGIN_AMOUNT = 0, "  
   SET @@SQL = @@SQL + " CASH_COLL = 0, "  
   SET @@SQL = @@SQL + " NONCASH_COLL = NONCASH_COLL, "  
   SET @@SQL = @@SQL + " INITIALMARGIN = INITIALMARGIN, "  
   SET @@SQL = @@SQL + " MTMMARGIN = MTMMARGIN, "  
   SET @@SQL = @@SQL + " ADDITIONAL_MARGIN = 0, "  
   SET @@SQL = @@SQL + " ENTRY_TYPE = 0, "  
   SET @@SQL = @@SQL + " SOURCE_VO = '', "  
   SET @@SQL = @@SQL + " TARGET_VNO = '', "  
   SET @@SQL = @@SQL + " LNO = 0, "  
   SET @@SQL = @@SQL + " NARRATION = '' "  
   SET @@SQL = @@SQL + " FROM MCDXCDS.DBO.TBL_CLIENTMARGIN CL, "  
   SET @@SQL = @@SQL + @@DB_FR + ".DBO.ACMAST A"  
   SET @@SQL = @@SQL + " WHERE A.CLTCODE = CL.PARTY_CODE "  
   SET @@SQL = @@SQL + " AND A.ACCAT = 4 "  
   SET @@SQL = @@SQL + " AND MARGINDATE = "  
   SET @@SQL = @@SQL + "   (SELECT MAX(MARGINDATE) FROM MCDXCDS.DBO.TBL_CLIENTMARGIN WITH (NOLOCK) "  
   SET @@SQL = @@SQL + "   WHERE MARGINDATE <= '" + @VDT + " 23:59:59') "  
   SET @@SQL = @@SQL + " AND A.CLTCODE BETWEEN '" + @CLIENT_FR + "' AND '" + @CLIENT_TO + "'"  
  
/*  
   SET @@SQL = " UPDATE V2_FT_COMPUTEBALANCES SET "  
   SET @@SQL = @@SQL + " MARGIN_AMOUNT = CL.NONCASH_COLL - (CL.INITIALMARGIN + CL.MTMMARGIN), "  
   SET @@SQL = @@SQL + " FINAL_AMOUNT = LEDGER_AMOUNT + (CL.NONCASH_COLL - (CL.INITIALMARGIN + CL.MTMMARGIN)), "  
   SET @@SQL = @@SQL + " CASH_COLL = 0, "  
   SET @@SQL = @@SQL + " NONCASH_COLL = CL.NONCASH_COLL, "  
   SET @@SQL = @@SQL + " INITIALMARGIN = CL.INITIALMARGIN, "  
   SET @@SQL = @@SQL + " MTMMARGIN = CL.MTMMARGIN "  
   SET @@SQL = @@SQL + " FROM MCDXCDS..TBL_CLIENTMARGIN CL "  
   SET @@SQL = @@SQL + " WHERE V2_FT_COMPUTEBALANCES.CLTCODE = CL.PARTY_CODE "  
   SET @@SQL = @@SQL + " AND MARGINDATE = "  
   SET @@SQL = @@SQL + "   (SELECT MAX(MARGINDATE) FROM MCDXCDS.DBO.TBL_CLIENTMARGIN WITH (NOLOCK) "  
   SET @@SQL = @@SQL + "   WHERE MARGINDATE <= LEFT(GETDATE(),11)) "  
   SET @@SQL = @@SQL + " AND LEDGER_TYPE = 'MCD' "  
*/  
  
  
   EXEC (@@SQL)  
               
  END  
  
  IF @@EXCH_FR = 'NCXMRG'  
  BEGIN  
   SET @@SQL = " INSERT INTO V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " SELECT A.CLTCODE, A.ACNAME, LEDGER_TYPE = '" + @@EXCH_FR + "', VTYPE = 0, "  
   SET @@SQL = @@SQL + " FINAL_AMOUNT = CASH_COLL + (CASE WHEN (CL.NONCASH_COLL - (CL.INITIALMARGIN + CL.MTMMARGIN)) > 0 THEN 0 ELSE (CL.NONCASH_COLL - (CL.INITIALMARGIN + CL.MTMMARGIN)) END), "  
   SET @@SQL = @@SQL + " LEDGER_AMOUNT = CASH_COLL, "  
   SET @@SQL = @@SQL + " MARGIN_AMOUNT = 0, "  
   SET @@SQL = @@SQL + " CASH_COLL = 0, "  
   SET @@SQL = @@SQL + " NONCASH_COLL = NONCASH_COLL, "  
   SET @@SQL = @@SQL + " INITIALMARGIN = INITIALMARGIN, "  
   SET @@SQL = @@SQL + " MTMMARGIN = MTMMARGIN, "  
   SET @@SQL = @@SQL + " ADDITIONAL_MARGIN = 0, "  
   SET @@SQL = @@SQL + " ENTRY_TYPE = 0, "  
   SET @@SQL = @@SQL + " SOURCE_VO = '', "  
   SET @@SQL = @@SQL + " TARGET_VNO = '', "  
   SET @@SQL = @@SQL + " LNO = 0, "  
   SET @@SQL = @@SQL + " NARRATION = '' "  
   SET @@SQL = @@SQL + " FROM NCDX.DBO.TBL_CLIENTMARGIN CL, "  
   SET @@SQL = @@SQL + @@DB_FR + ".DBO.ACMAST A"  
   SET @@SQL = @@SQL + " WHERE A.CLTCODE = CL.PARTY_CODE "  
   SET @@SQL = @@SQL + " AND A.ACCAT = 4 "  
   SET @@SQL = @@SQL + " AND MARGINDATE = "  
   SET @@SQL = @@SQL + "   (SELECT MAX(MARGINDATE) FROM MCDXCDS.DBO.TBL_CLIENTMARGIN WITH (NOLOCK) "  
   SET @@SQL = @@SQL + "   WHERE MARGINDATE <= '" + @VDT + " 23:59:59') "  
   SET @@SQL = @@SQL + " AND A.CLTCODE BETWEEN '" + @CLIENT_FR + "' AND '" + @CLIENT_TO + "'"  
/*  
   SET @@SQL = " UPDATE V2_FT_COMPUTEBALANCES SET "  
   SET @@SQL = @@SQL + " MARGIN_AMOUNT = CL.NONCASH_COLL - (CL.INITIALMARGIN + CL.MTMMARGIN), "  
   SET @@SQL = @@SQL + " FINAL_AMOUNT = LEDGER_AMOUNT + (CL.NONCASH_COLL - (CL.INITIALMARGIN + CL.MTMMARGIN)), "  
   SET @@SQL = @@SQL + " CASH_COLL = 0, "  
   SET @@SQL = @@SQL + " NONCASH_COLL = CL.NONCASH_COLL, "  
   SET @@SQL = @@SQL + " INITIALMARGIN = CL.INITIALMARGIN, "  
   SET @@SQL = @@SQL + " MTMMARGIN = CL.MTMMARGIN "  
   SET @@SQL = @@SQL + " FROM NCDX..TBL_CLIENTMARGIN CL "  
   SET @@SQL = @@SQL + " WHERE V2_FT_COMPUTEBALANCES.CLTCODE = CL.PARTY_CODE "  
   SET @@SQL = @@SQL + " AND MARGINDATE = "  
   SET @@SQL = @@SQL + "   (SELECT MAX(MARGINDATE) FROM NCDX.DBO.TBL_CLIENTMARGIN WITH (NOLOCK) "  
   SET @@SQL = @@SQL + "   WHERE MARGINDATE <= LEFT(GETDATE(),11)) "  
   SET @@SQL = @@SQL + " AND LEDGER_TYPE = 'NCX' "  
*/  
   EXEC (@@SQL)  
  END  
  
  FETCH NEXT FROM @@COMPUTE_CUR INTO @@EXCH_FR, @@DB_FR  
 END  

DELETE
	F
FROM
	V2_FT_COMPUTEBALANCES F,
	ACCOUNTMCDXCDS.DBO.FT_ACMAST A
WHERE
	F.CLTCODE = A.CLTCODE
  
CREATE TABLE #FUND_TRF  
(  
 CLTCODE VARCHAR(15),  
 ACNAME VARCHAR(100),  
 TRF_AMOUNT MONEY,  
 SR_NO INT IDENTITY(2,1)  
)  
  
CREATE TABLE #VNO  
(  
 VNO VARCHAR(12)  
)  
  
SET @@FT_CUR = CURSOR FOR  
 SELECT SR_NO, EXCH_FR, EXCH_TO, EXCH_DEFAULT, DB_FR, DB_TO, TRF_TYPE FROM V2_FT_PRIORITY ORDER BY SR_NO  
  
OPEN @@FT_CUR  
FETCH NEXT FROM @@FT_CUR INTO @@SR_NO, @@EXCH_FR, @@EXCH_TO, @@EXCH_DEFAULT, @@DB_FR, @@DB_TO, @@TRF_TYPE  
  
WHILE @@FETCH_STATUS = 0  
 BEGIN  
  
  TRUNCATE TABLE #FUND_TRF  
  
  IF @@EXCH_TO = 'COMMON'  
  BEGIN  
   INSERT INTO #FUND_TRF  
   SELECT  
    CLTCODE, ACNAME, FINAL_AMOUNT = SUM(CASE WHEN @@TRF_TYPE = 0 THEN LEDGER_AMOUNT ELSE FINAL_AMOUNT END)  
   FROM  
    V2_FT_COMPUTEBALANCES  
   WHERE  
    LEDGER_TYPE = @@EXCH_FR  
   GROUP BY  
    CLTCODE, LEDGER_TYPE, ACNAME  
   HAVING  
    SUM(CASE WHEN @@TRF_TYPE = 0 THEN LEDGER_AMOUNT ELSE FINAL_AMOUNT END) > 0  
    AND CLTCODE BETWEEN @CLIENT_FR AND @CLIENT_TO     
  END    
  
  IF @@TRF_TYPE = 1 AND @@EXCH_FR = 'COMMON'   
  BEGIN  
   INSERT INTO #FUND_TRF  
   SELECT  
    A.CLTCODE, A.ACNAME, CASE WHEN ABS(A.FINAL_AMOUNT) <= ABS(B.FINAL_AMOUNT) THEN ABS(A.FINAL_AMOUNT) ELSE ABS(B.FINAL_AMOUNT) END  
   FROM  
    (SELECT  
     CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(FINAL_AMOUNT)  
    FROM  
     V2_FT_COMPUTEBALANCES  
    WHERE  
     LEDGER_TYPE = @@EXCH_FR  
    GROUP BY  
     CLTCODE, LEDGER_TYPE, ACNAME  
    HAVING  
     SUM(FINAL_AMOUNT) > 0) A,  
    (SELECT  
     CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(FINAL_AMOUNT)  
    FROM  
     V2_FT_COMPUTEBALANCES  
    WHERE  
     LEDGER_TYPE = @@EXCH_TO   
    GROUP BY  
     CLTCODE, LEDGER_TYPE, ACNAME  
    HAVING  
     SUM(FINAL_AMOUNT) < 0) B  
   WHERE  
    A.CLTCODE = B.CLTCODE  
    AND A.CLTCODE BETWEEN @CLIENT_FR AND @CLIENT_TO     
  END  
  
  IF @@TRF_TYPE = 0 AND @@EXCH_FR = 'COMMON'   
  BEGIN  
   INSERT INTO #FUND_TRF  
   SELECT  
    A.CLTCODE, A.ACNAME, CASE WHEN ABS(A.FINAL_AMOUNT) <= ABS(B.FINAL_AMOUNT) THEN ABS(A.FINAL_AMOUNT) ELSE ABS(B.FINAL_AMOUNT) END  
   FROM  
    (SELECT  
     CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(FINAL_AMOUNT)  
    FROM  
     V2_FT_COMPUTEBALANCES  
    WHERE  
     LEDGER_TYPE = @@EXCH_FR  
    GROUP BY  
     CLTCODE, LEDGER_TYPE, ACNAME  
    HAVING  
     SUM(FINAL_AMOUNT) > 0) A,  
    (SELECT  
     CLTCODE, ACNAME, LEDGER_TYPE, FINAL_AMOUNT = SUM(LEDGER_AMOUNT)  
    FROM  
     V2_FT_COMPUTEBALANCES  
    WHERE  
     LEDGER_TYPE = @@EXCH_TO  
    GROUP BY  
     CLTCODE, LEDGER_TYPE, ACNAME  
    HAVING  
     SUM(LEDGER_AMOUNT) < 0) B  
   WHERE  
    A.CLTCODE = B.CLTCODE  
    AND A.CLTCODE BETWEEN @CLIENT_FR AND @CLIENT_TO     
  END  
  
  INSERT INTO V2_FT_COMPUTEBALANCES  
  SELECT  
   CLTCODE, ACNAME, @@EXCH_FR, 88, -(TRF_AMOUNT), -(TRF_AMOUNT), 0, 0, 0, 0, 0, 0, @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO  
  FROM #FUND_TRF  
  
  INSERT INTO V2_FT_COMPUTEBALANCES  
  SELECT  
   CLTCODE, ACNAME, @@EXCH_TO, 88, (TRF_AMOUNT), (TRF_AMOUNT), 0, 0, 0, 0, 0, 0, @@SR_NO, '', '', SR_NO, 'FUND TRANSFER FROM ' + @@EXCH_FR + ' TO ' + @@EXCH_TO  
  FROM #FUND_TRF  
  
  SELECT @@VNO_COUNT = MAX(SR_NO) FROM #FUND_TRF  
  
  SET @@SQL = "INSERT INTO #VNO "  
--  IF @@EXCH_FR = 'COMMON'   
   SET @@SQL = @@SQL + " EXEC ACCOUNTMCDXCDS.DBO.ACC_GENVNO_NEW '" + @VDT + "', 88, '01', '" + @START_DATE + "', '" + @END_DATE + "'"  
--   ELSE   
--    SET @@SQL = @@SQL + " EXEC " + @@DB_FR + ".DBO.ACC_GENVNO_NEW '" + @VDT + "', 88, '01', '" + @START_DATE + "', '" + @END_DATE + "'"  
  
  EXEC (@@SQL)  
  
  SELECT @@VNO_FR = VNO FROM #VNO  
  SELECT @@VNO_TO = VNO FROM #VNO  
  
/*  
  TRUNCATE TABLE #VNO  
  
  SET @@SQL = "INSERT INTO #VNO "  
  SET @@SQL = @@SQL + " EXEC " + @@DB_TO + ".DBO.ACC_GENVNO_NEW '" + @VDT + "', 88, '01', '" + @START_DATE + "', '" + @END_DATE + "'"  
  
  EXEC (@@SQL)  
  
  SELECT @@VNO_TO = VNO FROM #VNO  
*/  
  
  TRUNCATE TABLE #VNO  
  
  UPDATE V2_FT_COMPUTEBALANCES SET SOURCE_VNO = CONVERT(NUMERIC, @@VNO_FR) FROM #FUND_TRF F WHERE F.CLTCODE = V2_FT_COMPUTEBALANCES.CLTCODE AND ENTRY_TYPE = @@SR_NO  
  UPDATE V2_FT_COMPUTEBALANCES SET TARGET_VNO = CONVERT(NUMERIC, @@VNO_TO) FROM #FUND_TRF F WHERE F.CLTCODE = V2_FT_COMPUTEBALANCES.CLTCODE AND ENTRY_TYPE = @@SR_NO  
  
  IF @@TRF_TYPE = 0  
  BEGIN  
  
   SET @@SQL = "INSERT INTO " + @@DB_FR + ".DBO.LEDGER "  
   SET @@SQL = @@SQL + " SELECT "  
   SET @@SQL = @@SQL + "  88, "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "'" + @VDT + "', "  
   SET @@SQL = @@SQL + "  LNO, "  
   SET @@SQL = @@SQL + "  ACNAME, CASE WHEN FINAL_AMOUNT < 0 THEN 'D' ELSE 'C' END, "  
   SET @@SQL = @@SQL + "  ABS(FINAL_AMOUNT), "  
   SET @@SQL = @@SQL + "'" + @VDT + "',"  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "  REFNO = '', "  
   SET @@SQL = @@SQL + "  BALAMT = 0, "  
   SET @@SQL = @@SQL + "  NODAYS = 0, "  
   SET @@SQL = @@SQL + "  CDT = GETDATE(), "  
   SET @@SQL = @@SQL + "  CLTCODE, "  
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + "  PDT = GETDATE(), "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + " ACTNODAYS = 0, "  
   SET @@SQL = @@SQL + " NARRATION "  
   SET @@SQL = @@SQL + " FROM "  
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)  
  
   SET @@SQL = @@SQL + " INSERT INTO " + @@DB_FR + ".DBO.TEMPLEDGER2 "  
   SET @@SQL = @@SQL + " SELECT 'BRANCH', BRANCHCODE, ABS(FINAL_AMOUNT), 88, SOURCE_VNO, LNO, "  
   SET @@SQL = @@SQL + " CASE WHEN FINAL_AMOUNT < 0 THEN 'D' ELSE 'C' END, 0, '01', '9999999999', A.CLTCODE, 'A', 0"  
   SET @@SQL = @@SQL + " FROM V2_FT_COMPUTEBALANCES F, " + @@DB_FR + ".DBO.ACMAST A "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)   
   SET @@SQL = @@SQL + "  AND F.CLTCODE = A.CLTCODE "  
  
   SET @@SQL = @@SQL + " INSERT INTO " + @@DB_FR + ".DBO.LEDGER "  
   SET @@SQL = @@SQL + " SELECT "  
   SET @@SQL = @@SQL + "  88, "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "'" + @VDT + "', "  
   SET @@SQL = @@SQL + "  1, "  
  
   IF @@DB_FR = @@EXCH_DEFAULT  
    SET @@SQL = @@SQL + "  '" + @GL_NAME + "', "  
   ELSE  
    SET @@SQL = @@SQL + "  '" + @@JV_NAME + "', "  
  
   SET @@SQL = @@SQL + " CASE WHEN SUM(FINAL_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "  
   SET @@SQL = @@SQL + "  ABS(SUM(FINAL_AMOUNT)), "  
   SET @@SQL = @@SQL + "'" + @VDT + "',"  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "  REFNO = '', "  
   SET @@SQL = @@SQL + "  BALAMT = 0, "  
   SET @@SQL = @@SQL + "  NODAYS = 0, "  
   SET @@SQL = @@SQL + "  CDT = GETDATE(), "  
     
   IF @@DB_FR = @@EXCH_DEFAULT  
    SET @@SQL = @@SQL + "  '" + @GL_CODE + "', "  
   ELSE  
    SET @@SQL = @@SQL + "  '" + @@JV_CODE + "', "  
     
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + "  PDT = GETDATE(), "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + " ACTNODAYS = 0, "  
   SET @@SQL = @@SQL + " NARRATION "  
   SET @@SQL = @@SQL + " FROM "  
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)  
   SET @@SQL = @@SQL + " GROUP BY "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, NARRATION "  
  
   SET @@SQL = @@SQL + " INSERT INTO " + @@DB_FR + ".DBO.TEMPLEDGER2 "  
   SET @@SQL = @@SQL + " SELECT 'BRANCH', BRANCHCODE, ABS(SUM(FINAL_AMOUNT)), 88, SOURCE_VNO, 1, "  
   SET @@SQL = @@SQL + " CASE WHEN SUM(FINAL_AMOUNT) < 0 THEN 'C' ELSE 'D' END, 0, '01', '9999999999', "  
  
   IF @@DB_FR = @@EXCH_DEFAULT  
    SET @@SQL = @@SQL + "  '" + @GL_CODE + "', "  
   ELSE  
    SET @@SQL = @@SQL + "  '" + @@JV_CODE + "', "  
  
   SET @@SQL = @@SQL + " 'A', 0 "  
   SET @@SQL = @@SQL + " FROM V2_FT_COMPUTEBALANCES F, " + @@DB_FR + ".DBO.ACMAST A "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)   
   IF @@DB_FR = @@EXCH_DEFAULT  
    SET @@SQL = @@SQL + " AND A.CLTCODE = '" + @GL_CODE + "' "  
   ELSE  
    SET @@SQL = @@SQL + " AND A.CLTCODE = '" + @@JV_CODE + "' "  
  
   SET @@SQL = @@SQL + "  GROUP BY BRANCHCODE, SOURCE_VNO "  
     
   EXEC (@@SQL)  
  
   SET @@SQL = "INSERT INTO " + @@DB_TO + ".DBO.LEDGER "  
   SET @@SQL = @@SQL + " SELECT "  
   SET @@SQL = @@SQL + "  88, "  
   SET @@SQL = @@SQL + "  TARGET_VNO, "  
   SET @@SQL = @@SQL + "'" + @VDT + "', "  
   SET @@SQL = @@SQL + "  LNO, "  
   SET @@SQL = @@SQL + "  ACNAME, CASE WHEN FINAL_AMOUNT < 0 THEN 'D' ELSE 'C' END, "  
   SET @@SQL = @@SQL + "  ABS(FINAL_AMOUNT), "  
   SET @@SQL = @@SQL + "'" + @VDT + "',"  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "  REFNO = '', "  
   SET @@SQL = @@SQL + "  BALAMT = 0, "  
   SET @@SQL = @@SQL + "  NODAYS = 0, "  
   SET @@SQL = @@SQL + "  CDT = GETDATE(), "  
   SET @@SQL = @@SQL + "  CLTCODE, "  
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + "  PDT = GETDATE(), "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + " ACTNODAYS = 0, "  
   SET @@SQL = @@SQL + " NARRATION "  
   SET @@SQL = @@SQL + " FROM "  
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_TO + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)  
  
   SET @@SQL = @@SQL + " INSERT INTO " + @@DB_TO + ".DBO.LEDGER "  
   SET @@SQL = @@SQL + " SELECT "  
   SET @@SQL = @@SQL + "  88, "  
   SET @@SQL = @@SQL + "  TARGET_VNO, "  
   SET @@SQL = @@SQL + "'" + @VDT + "', "  
   SET @@SQL = @@SQL + "  1, "  
--   SET @@SQL = @@SQL + "  '" + @@MCL_NAME + "', 
   IF @@DB_TO = @@EXCH_DEFAULT  
    SET @@SQL = @@SQL + "  '" + @GL_NAME + "', "  
   ELSE  
    SET @@SQL = @@SQL + "  '" + @@JV_NAME + "', "  
   SET @@SQL = @@SQL + "  CASE WHEN SUM(FINAL_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "  
   SET @@SQL = @@SQL + "  ABS(SUM(FINAL_AMOUNT)), "  
   SET @@SQL = @@SQL + "'" + @VDT + "',"  
   SET @@SQL = @@SQL + "  TARGET_VNO, "  
   SET @@SQL = @@SQL + "  REFNO = '', "  
   SET @@SQL = @@SQL + "  BALAMT = 0, "  
   SET @@SQL = @@SQL + "  NODAYS = 0, "  
   SET @@SQL = @@SQL + "  CDT = GETDATE(), "  
   IF @@DB_TO = @@EXCH_DEFAULT  
    SET @@SQL = @@SQL + "  '" + @GL_CODE + "', "  
   ELSE  
    SET @@SQL = @@SQL + "  '" + @@JV_CODE + "', "  
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + "  PDT = GETDATE(), "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + " ACTNODAYS = 0, "  
   SET @@SQL = @@SQL + " NARRATION "  
   SET @@SQL = @@SQL + " FROM "  
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_TO + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)  
   SET @@SQL = @@SQL + " GROUP BY "  
   SET @@SQL = @@SQL + "  TARGET_VNO, NARRATION "  
  
   EXEC (@@SQL)  
  
  END  
  
  IF @@TRF_TYPE = 1  
  BEGIN  
     
   IF @@EXCH_FR = 'COMMON'  
    SET @@SQL = "INSERT INTO " + @@DB_TO + ".DBO.MARGINLEDGER "  
   ELSE  
    SET @@SQL = "INSERT INTO " + @@DB_FR + ".DBO.MARGINLEDGER "  
   SET @@SQL = @@SQL + " SELECT "  
   SET @@SQL = @@SQL + "  88, "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "     
   SET @@SQL = @@SQL + "  LNO, "  
   IF @@EXCH_FR = 'COMMON'  
    SET @@SQL = @@SQL + "  CASE WHEN FINAL_AMOUNT < 0 THEN 'C' ELSE 'D' END, "  
   ELSE  
    SET @@SQL = @@SQL + "  CASE WHEN FINAL_AMOUNT < 0 THEN 'D' ELSE 'C' END, "  
   SET @@SQL = @@SQL + "'" + @VDT + "', "  
   SET @@SQL = @@SQL + "  ABS(FINAL_AMOUNT), "  
   SET @@SQL = @@SQL + "  CLTCODE, "  
   IF @@EXCH_FR = 'COMMON'  
    SET @@SQL = @@SQL + "'" + LEFT(@@EXCH_TO, 3) + "', "  
   ELSE  
    SET @@SQL = @@SQL + "'" + LEFT(@@EXCH_FR, 3) + "', "  
   SET @@SQL = @@SQL + "'FUTURES', "  
   SET @@SQL = @@SQL + "  0, '', "  
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "  
   SET @@SQL = @@SQL + "'" + @ML_CODE + "' "  
   SET @@SQL = @@SQL + " FROM "  
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)  
  
   SET @@SQL = @@SQL + " INSERT INTO " + @@DB_FR + ".DBO.LEDGER "  
   SET @@SQL = @@SQL + " SELECT "  
   SET @@SQL = @@SQL + "  88, "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "'" + @VDT + "', "  
   SET @@SQL = @@SQL + "  1, "  
   IF @@DB_FR = @@EXCH_DEFAULT
	   SET @@SQL = @@SQL + "  '" + @GL_NAME + "', " 
   ELSE
	   SET @@SQL = @@SQL + "  '" + @@JV_NAME + "', " 
   SET @@SQL = @@SQL + "  CASE WHEN SUM(FINAL_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "  
   SET @@SQL = @@SQL + "  ABS(SUM(FINAL_AMOUNT)), "  
   SET @@SQL = @@SQL + "'" + @VDT + "',"  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "  REFNO = '', "  
   SET @@SQL = @@SQL + "  BALAMT = 0, "  
   SET @@SQL = @@SQL + "  NODAYS = 0, "  
   SET @@SQL = @@SQL + "  CDT = GETDATE(), "  
   IF @@DB_FR = @@EXCH_DEFAULT
	   SET @@SQL = @@SQL + "'" + @GL_CODE + "', "  
   ELSE
	   SET @@SQL = @@SQL + "'" + @@JV_CODE + "', "     
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + "  PDT = GETDATE(), "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + " ACTNODAYS = 0, "  
   SET @@SQL = @@SQL + " NARRATION "  
   SET @@SQL = @@SQL + " FROM "  
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)  
   SET @@SQL = @@SQL + " GROUP BY "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, NARRATION "  
  
   SET @@SQL = @@SQL + " INSERT INTO " + @@DB_FR + ".DBO.LEDGER "  
   SET @@SQL = @@SQL + " SELECT "  
   SET @@SQL = @@SQL + "  88, "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "'" + @VDT + "', "  
   SET @@SQL = @@SQL + "  LNO, "  
   IF @@EXCH_FR = 'COMMON'  
    SET @@SQL = @@SQL + "  ACNAME, CASE WHEN SUM(FINAL_AMOUNT) > 0 THEN 'C' ELSE 'D' END, "  
    ELSE  
     SET @@SQL = @@SQL + "  '" + @ML_NAME + "', CASE WHEN SUM(FINAL_AMOUNT) > 0 THEN 'C' ELSE 'D' END, "  
   SET @@SQL = @@SQL + "  ABS(SUM(FINAL_AMOUNT)), "  
   SET @@SQL = @@SQL + "'" + @VDT + "',"  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "  REFNO = '', "  
   SET @@SQL = @@SQL + "  BALAMT = 0, "  
   SET @@SQL = @@SQL + "  NODAYS = 0, "  
   SET @@SQL = @@SQL + "  CDT = GETDATE(), "  
   IF @@EXCH_FR = 'COMMON'  
    SET @@SQL = @@SQL + "CLTCODE, "  
    ELSE  
     SET @@SQL = @@SQL + "'" + @ML_CODE + "', "  
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + "  PDT = GETDATE(), "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + " ACTNODAYS = 0, "  
   SET @@SQL = @@SQL + " NARRATION "  
   SET @@SQL = @@SQL + " FROM "  
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)  
   SET @@SQL = @@SQL + " GROUP BY "  
   IF @@EXCH_FR = 'COMMON'  
    SET @@SQL = @@SQL + "  CLTCODE, ACNAME, SOURCE_VNO, LNO, NARRATION "  
    ELSE  
     SET @@SQL = @@SQL + "  SOURCE_VNO, LNO, NARRATION "  
  
   EXEC (@@SQL)  
  
   SET @@SQL = "INSERT INTO " + @@DB_TO + ".DBO.LEDGER "  
   SET @@SQL = @@SQL + " SELECT "  
   SET @@SQL = @@SQL + "  88, "  
   SET @@SQL = @@SQL + "  TARGET_VNO, "  
   SET @@SQL = @@SQL + "'" + @VDT + "', "  
   SET @@SQL = @@SQL + "  LNO, "  
   IF @@EXCH_FR = 'COMMON'  
    SET @@SQL = @@SQL + "  '" + @ML_NAME + "', CASE WHEN FINAL_AMOUNT < 0 THEN 'D' ELSE 'C' END, "  
    ELSE  
     SET @@SQL = @@SQL + "  ACNAME, CASE WHEN FINAL_AMOUNT < 0 THEN 'D' ELSE 'C' END, "  
   SET @@SQL = @@SQL + "  ABS(FINAL_AMOUNT), "  
   SET @@SQL = @@SQL + "'" + @VDT + "',"  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "  REFNO = '', "  
   SET @@SQL = @@SQL + "  BALAMT = 0, "  
   SET @@SQL = @@SQL + "  NODAYS = 0, "  
   SET @@SQL = @@SQL + "  CDT = GETDATE(), "  
   IF @@EXCH_FR = 'COMMON'  
    SET @@SQL = @@SQL + "  '" + @ML_CODE + "', "  
    ELSE  
     SET @@SQL = @@SQL + "  CLTCODE, "  
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + "  PDT = GETDATE(), "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + " ACTNODAYS = 0, "  
   SET @@SQL = @@SQL + " NARRATION "  
   SET @@SQL = @@SQL + " FROM "  
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_TO + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)  
  
   SET @@SQL = @@SQL + " INSERT INTO " + @@DB_TO + ".DBO.LEDGER "  
   SET @@SQL = @@SQL + " SELECT "  
   SET @@SQL = @@SQL + "  88, "  
   SET @@SQL = @@SQL + "  TARGET_VNO, "  
   SET @@SQL = @@SQL + "'" + @VDT + "', "  
   SET @@SQL = @@SQL + "  1, "  
   IF @@DB_TO = @@EXCH_DEFAULT
	   SET @@SQL = @@SQL + "  '" + @GL_NAME + "', CASE WHEN SUM(FINAL_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "  
   ELSE
	   SET @@SQL = @@SQL + "  '" + @@MCL_NAME + "', CASE WHEN SUM(FINAL_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "  
   SET @@SQL = @@SQL + "  ABS(SUM(FINAL_AMOUNT)), "  
   SET @@SQL = @@SQL + "'" + @VDT + "',"  
   SET @@SQL = @@SQL + "  TARGET_VNO, "  
   SET @@SQL = @@SQL + "  REFNO = '', "  
   SET @@SQL = @@SQL + "  BALAMT = 0, "  
   SET @@SQL = @@SQL + "  NODAYS = 0, "  
   SET @@SQL = @@SQL + "  CDT = GETDATE(), "  
   IF @@DB_TO = @@EXCH_DEFAULT
	   SET @@SQL = @@SQL + "'" + @GL_CODE + "', "  
   ELSE
	   SET @@SQL = @@SQL + "'" + @@MCL_CODE + "', "  	
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + "  PDT = GETDATE(), "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + " ACTNODAYS = 0, "  
   SET @@SQL = @@SQL + " NARRATION "  
   SET @@SQL = @@SQL + " FROM "  
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_TO + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)  
   SET @@SQL = @@SQL + " GROUP BY "  
   SET @@SQL = @@SQL + "  TARGET_VNO, NARRATION "  
  
   EXEC (@@SQL)  
  
  END  
  
  IF @@DB_FR <> @@EXCH_DEFAULT AND @@DB_TO <> @@EXCH_DEFAULT AND @@TRF_TYPE = 0 
  BEGIN  
   SET @@SQL = "INSERT INTO " + @@EXCH_DEFAULT + ".DBO.LEDGER "  
   SET @@SQL = @@SQL + " SELECT "  
   SET @@SQL = @@SQL + "  88, "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "'" + @VDT + "', "  
   SET @@SQL = @@SQL + "  LNO, " 
   IF @@EXCH_FR = 'COMMON'   
   	SET @@SQL = @@SQL + "  '" + @GL_NAME + "', CASE WHEN SUM(FINAL_AMOUNT) < 0 THEN 'D' ELSE 'C' END, "  
   ELSE
   	SET @@SQL = @@SQL + "  '" + @@JV_NAME + "', CASE WHEN SUM(FINAL_AMOUNT) < 0 THEN 'D' ELSE 'C' END, "  
   SET @@SQL = @@SQL + "  ABS(SUM(FINAL_AMOUNT)), "  
   SET @@SQL = @@SQL + "'" + @VDT + "',"  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "  REFNO = '', "  
   SET @@SQL = @@SQL + "  BALAMT = 0, "  
   SET @@SQL = @@SQL + "  NODAYS = 0, "  
   SET @@SQL = @@SQL + "  CDT = GETDATE(), "  
   IF @@EXCH_FR = 'COMMON'  
	   SET @@SQL = @@SQL + "  '" + @GL_CODE + "', "  
   ELSE
	   SET @@SQL = @@SQL + "  '" + @@JV_CODE + "', "  
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + "  PDT = GETDATE(), "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + " ACTNODAYS = 0, "  
   SET @@SQL = @@SQL + " NARRATION "  
   SET @@SQL = @@SQL + " FROM "  
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)  
   SET @@SQL = @@SQL + " GROUP BY "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, LNO, NARRATION "  
  
   SET @@SQL = @@SQL + " INSERT INTO " + @@EXCH_DEFAULT + ".DBO.LEDGER "  
   SET @@SQL = @@SQL + " SELECT "  
   SET @@SQL = @@SQL + "  88, "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "'" + @VDT + "', "  
   SET @@SQL = @@SQL + "  1, "     
   IF @@EXCH_TO = 'COMMON'  
	   SET @@SQL = @@SQL + "  '" + @GL_NAME + "', "  
   ELSE
   	   SET @@SQL = @@SQL + "  '" + @@JV_NAME + "', "  
   SET @@SQL = @@SQL + " CASE WHEN SUM(FINAL_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "  
   SET @@SQL = @@SQL + "  ABS(SUM(FINAL_AMOUNT)), "  
   SET @@SQL = @@SQL + "'" + @VDT + "',"  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "  REFNO = '', "  
   SET @@SQL = @@SQL + "  BALAMT = 0, "  
   SET @@SQL = @@SQL + "  NODAYS = 0, "  
   SET @@SQL = @@SQL + "  CDT = GETDATE(), "  
   IF @@EXCH_TO = 'COMMON'  
	   SET @@SQL = @@SQL + "  '" + @GL_CODE + "', "     
   ELSE
	   SET @@SQL = @@SQL + "  '" + @@JV_CODE + "', "     
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + "  PDT = GETDATE(), "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + " ACTNODAYS = 0, "  
   SET @@SQL = @@SQL + " NARRATION "  
   SET @@SQL = @@SQL + " FROM "  
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)  
   SET @@SQL = @@SQL + " GROUP BY "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, NARRATION "  
  
   EXEC (@@SQL)  
     
  END  

  IF @@DB_FR <> @@EXCH_DEFAULT AND @@DB_TO <> @@EXCH_DEFAULT AND @@TRF_TYPE = 1 
  BEGIN  
   SET @@SQL = "INSERT INTO " + @@EXCH_DEFAULT + ".DBO.LEDGER "  
   SET @@SQL = @@SQL + " SELECT "  
   SET @@SQL = @@SQL + "  88, "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "'" + @VDT + "', "  
   SET @@SQL = @@SQL + "  LNO, "  
   IF @@EXCH_FR = 'COMMON'   
	   SET @@SQL = @@SQL + "  '" + @GL_NAME + "', CASE WHEN SUM(FINAL_AMOUNT) < 0 THEN 'D' ELSE 'C' END, "  
   ELSE
	   SET @@SQL = @@SQL + "  '" + @@JV_NAME + "', CASE WHEN SUM(FINAL_AMOUNT) < 0 THEN 'D' ELSE 'C' END, "  
   SET @@SQL = @@SQL + "  ABS(SUM(FINAL_AMOUNT)), "  
   SET @@SQL = @@SQL + "'" + @VDT + "',"  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "  REFNO = '', "  
   SET @@SQL = @@SQL + "  BALAMT = 0, "  
   SET @@SQL = @@SQL + "  NODAYS = 0, "  
   SET @@SQL = @@SQL + "  CDT = GETDATE(), "  
   IF @@EXCH_FR = 'COMMON'   
	   SET @@SQL = @@SQL + "  '" + @GL_CODE + "', "  
   ELSE
	   SET @@SQL = @@SQL + "  '" + @@JV_CODE + "', "  
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + "  PDT = GETDATE(), "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + " ACTNODAYS = 0, "  
   SET @@SQL = @@SQL + " NARRATION "  
   SET @@SQL = @@SQL + " FROM "  
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)  
   SET @@SQL = @@SQL + " GROUP BY "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, LNO, NARRATION "  
  
   SET @@SQL = @@SQL + " INSERT INTO " + @@EXCH_DEFAULT + ".DBO.LEDGER "  
   SET @@SQL = @@SQL + " SELECT "  
   SET @@SQL = @@SQL + "  88, "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "'" + @VDT + "', "  
   SET @@SQL = @@SQL + "  1, "     
   IF @@EXCH_TO = 'COMMON' 
	   SET @@SQL = @@SQL + "  '" + @GL_NAME + "', "  
   ELSE
	   SET @@SQL = @@SQL + "  '" + @@JV_NAME + "', "  
   SET @@SQL = @@SQL + " CASE WHEN SUM(FINAL_AMOUNT) < 0 THEN 'C' ELSE 'D' END, "  
   SET @@SQL = @@SQL + "  ABS(SUM(FINAL_AMOUNT)), "  
   SET @@SQL = @@SQL + "'" + @VDT + "',"  
   SET @@SQL = @@SQL + "  SOURCE_VNO, "  
   SET @@SQL = @@SQL + "  REFNO = '', "  
   SET @@SQL = @@SQL + "  BALAMT = 0, "  
   SET @@SQL = @@SQL + "  NODAYS = 0, "  
   SET @@SQL = @@SQL + "  CDT = GETDATE(), "  
   IF @@EXCH_TO = 'COMMON' 
	   SET @@SQL = @@SQL + "  '" + @GL_CODE + "', "     
   ELSE
	   SET @@SQL = @@SQL + "  '" + @@JV_CODE + "', "     
   SET @@SQL = @@SQL + "  BOOKTYPE = '01', "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + "  PDT = GETDATE(), "  
   SET @@SQL = @@SQL + "'" + @UNAME + "', "  
   SET @@SQL = @@SQL + " ACTNODAYS = 0, "  
   SET @@SQL = @@SQL + " NARRATION "  
   SET @@SQL = @@SQL + " FROM "  
   SET @@SQL = @@SQL + " V2_FT_COMPUTEBALANCES "  
   SET @@SQL = @@SQL + " WHERE "  
   SET @@SQL = @@SQL + "  LEDGER_TYPE = '" + @@EXCH_FR + "' AND ENTRY_TYPE = " + CONVERT(VARCHAR, @@SR_NO)  
   SET @@SQL = @@SQL + " GROUP BY "  
   SET @@SQL = @@SQL + "  SOURCE_VNO, NARRATION "  
  
   EXEC (@@SQL)  
     
  END  
  
  INSERT INTO ACCCOMMODITY.DBO.V2_LEDGERTRANSFER  
  SELECT  
   A.BRANCHCODE,  
   F.CLTCODE,  
   F.ACNAME,  
   LEDGER_AMOUNT,  
   FINAL_AMOUNT,  
   INITIALMARGIN,  
   MTMMARGIN,  
   CASH_COLL,  
   NONCASH_COLL,  
   '',  
   @@EXCH_FR,  
   @@EXCH_TO,  
   @VDT,  
   'P',  
   @UNAME,  
   GETDATE(),  
   'FT',  
   NARRATION,  
   0  
  FROM  
   V2_FT_COMPUTEBALANCES F,  
   ACMAST A     
  WHERE   
   LEDGER_TYPE = @@EXCH_FR AND ENTRY_TYPE = CONVERT(VARCHAR, @@SR_NO)  
   AND A.CLTCODE = F.CLTCODE  
  
  FETCH NEXT FROM @@FT_CUR INTO @@SR_NO, @@EXCH_FR, @@EXCH_TO, @@EXCH_DEFAULT, @@DB_FR, @@DB_TO, @@TRF_TYPE  
 END   
  
/*MCX COLLATERAL CALCULATION*/  
 DELETE FROM MSAJAG.DBO.C_MARGINLEDGER  
               
 INSERT INTO MSAJAG.DBO.C_MARGINLEDGER  
 SELECT   M.EXCHANGE,  
          LEFT(M.SEGMENT,8),  
          M.PARTY_CODE,  
          CAMT = ISNULL((CASE   
                           WHEN DRCR = 'C' THEN SUM(AMOUNT)  
                           ELSE 0  
                         END),0),  
          DAMT = ISNULL((CASE   
                           WHEN DRCR = 'D' THEN SUM(AMOUNT)  
                           ELSE 0  
                         END),0),  
          DRCR  
 FROM     ACCOUNTMCDXCDS.DBO.MARGINLEDGER M  
          LEFT OUTER JOIN MSAJAG.DBO.C_ACCOUNTMAPPING A  
            ON (MCLTCODE = ACCOUNTCODE  
                AND A.PARTY_CODE = M.PARTY_CODE  
                AND A.EXCHANGE = M.EXCHANGE  
                AND A.SEGMENT = LEFT(M.SEGMENT,7)  
                AND ACTIVE = 1  
                AND EFFDATE <= @VDT + ' 23:59:59')  
 WHERE    VDT >= @SDTCUR  
          AND VDT <= @VDT + ' 23:59:59'  
          AND M.EXCHANGE = 'MCD'  
          AND LEFT(M.SEGMENT,7) = 'FUTURES'  
 GROUP BY DRCR,M.PARTY_CODE,M.EXCHANGE,LEFT(M.SEGMENT,8)  
            
 EXEC MSAJAG.DBO.C_COLLATERALCALCULATIONSPMS  
   'MCD' ,  
   'FUTURES' ,  
   '0' ,  
   'ZZZZZZZZ' ,  
   @VDT,  
   'MCDX' ,  
   'RMBKOFFDB1' ,  
   1  

  
/*NCDEX COLLATERAL CALCULATION*/  
 DELETE FROM MSAJAG.DBO.C_MARGINLEDGER  
               
 INSERT INTO MSAJAG.DBO.C_MARGINLEDGER  
 SELECT   M.EXCHANGE,  
          LEFT(M.SEGMENT,8),  
          M.PARTY_CODE,  
          CAMT = ISNULL((CASE   
                           WHEN DRCR = 'C' THEN SUM(AMOUNT)  
                           ELSE 0  
                         END),0),  
          DAMT = ISNULL((CASE   
                           WHEN DRCR = 'D' THEN SUM(AMOUNT)  
                           ELSE 0  
                         END),0),  
          DRCR  
 FROM     ACCOUNTNCDX.DBO.MARGINLEDGER M  
          LEFT OUTER JOIN MSAJAG.DBO.C_ACCOUNTMAPPING A  
            ON (MCLTCODE = ACCOUNTCODE  
                AND A.PARTY_CODE = M.PARTY_CODE  
                AND A.EXCHANGE = M.EXCHANGE  
                AND A.SEGMENT = LEFT(M.SEGMENT,7)  
                AND ACTIVE = 1  
                AND EFFDATE <= @VDT + ' 23:59:59')  
 WHERE    VDT >= @SDTCUR  
          AND VDT <= @VDT + ' 23:59:59'  
          AND M.EXCHANGE = 'NCX'  
          AND LEFT(M.SEGMENT,7) = 'FUTURES'  
 GROUP BY DRCR,M.PARTY_CODE,M.EXCHANGE,LEFT(M.SEGMENT,8)  
            
 EXEC MSAJAG.DBO.C_COLLATERALCALCULATIONSPMS  
   'NCX' ,  
   'FUTURES' ,  
   '0' ,  
   'ZZZZZZZZ' ,  
   @VDT,  
   'NCDX' ,  
   'RMBKOFFDB1' ,  
   1  

/*MARGIN CALCULATION FOR MCX */  
 EXEC MCDXCDS.DBO.CLIENTMARGIN_UPD @VDT  
  
/*MARGIN CALCULATION FOR NCDEX*/  
 EXEC NCDX.DBO.CLIENTMARGIN_UPD @VDT  
  
SELECT * FROM V2_FT_COMPUTEBALANCES  
 /*  
 SELECT * FROM ACCCOMMON.DBO.V2_LEDGERTRANSFER  
 SELECT * FROM LEDGER WHERE VTYP = 88 ORDER BY VNO  
 SELECT * FROM ACCCOMMON..LEDGER WHERE VTYP = 88 ORDER BY VNO  
 SELECT * FROM ACCOUNTBSE..LEDGER WHERE VTYP = 88  
 SELECT * FROM ACCOUNTFO..LEDGER WHERE VTYP = 88*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_NEWASP_MARGINTRIALBALANCE
-- --------------------------------------------------


--NEWASP_MARGINTRIALBALANCE 'Mar 31 2006', 'codewise','partywise','normal','Apr 1 2005', 'Apr 1 2005', 1,'Apr 1 2005', 'BRANCH', 'TEST', 'vdt', '11212','','BSE','',''

CREATE PROCEDURE  [dbo].[V2_NEWASP_MARGINTRIALBALANCE]  
  
@VDT VARCHAR(11),               /* AS ON DATE ENTERED BY USER */  
@FLAG VARCHAR(15),              /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */  
@VIEWOPTION VARCHAR(10),        /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */  
@BALANCE VARCHAR(10),           /* NORMAL OR WITHOPBAL */  
@STDATE VARCHAR(11),            /* START DATE ENTERED BY USER */  
@CURRYRSTDATE VARCHAR(11), /* START DATE OF FINANCIAL YEAR */  
@OPENENTRYFLAG INT,  
@OPENINGENTRYDATE VARCHAR(11),  /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */  
@STATUSID VARCHAR(20),          /* AS BROKER/BRANCH/CLIENT ETC. */  
@STATUSNAME VARCHAR(20),        /* IN CASE OF BRANCH LOGIN BRANCHCODE */  
@SORTBYDATE VARCHAR(3),          /* WHETHER REPORT IS BASED ON VDT OR EDT */  
@SHOWZEROBAL VARCHAR(1) = 'N',  /* SHOW ZERO BAL   */ 
@GRPCODE VARCHAR(20),
@SHAREDB VARCHAR(20),
@EXCHANGE VARCHAR(10),
@SEGMENT VARCHAR(9)  
AS  
  
DECLARE  
@@SELECTQURY  AS VARCHAR(2000),  
@@FROMTABLES  AS VARCHAR(2000),  
@@WHEREPART   AS VARCHAR(1000),  
@@SQL		  AS VARCHAR(1000),  
@@WHEREPART1  AS VARCHAR(500),  
@@WHEREPART2  AS VARCHAR(500),  
@@WHEREPART3  AS VARCHAR(500),  
@@ADDWHERE    AS VARCHAR(200),  
@@GROUPBY     AS VARCHAR(200),  
@@SORTBY      AS VARCHAR(200),  
@@HAVING      AS VARCHAR(200),
@@COSTCODE    AS VARCHAR(3)  
 

CREATE TABLE #COSTMAST
(
	COSTNAME VARCHAR(100)
)

IF @STATUSID = 'REGION'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTNAME FROM COSTMAST C, "+ @SHAREDB +".DBO.REGION R WHERE REGIONCODE = RTRIM('"+@STATUSNAME+"') AND COSTNAME = BRANCH_CODE "
END

IF @STATUSID = 'AREA'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTNAME FROM COSTMAST C, "+ @SHAREDB +".DBO.AREA A WHERE AREACODE = RTRIM('"+@STATUSNAME+"') AND COSTNAME = BRANCH_CODE "
END

IF @STATUSID = 'BRANCH'
BEGIN
	SET @@SQL = " INSERT INTO #COSTMAST "
	SET @@SQL = @@SQL + " SELECT COSTNAME FROM COSTMAST WHERE COSTNAME = RTRIM('"+@STATUSNAME+"') "
END
PRINT(@@SQL)  
EXEC(@@SQL) 

IF UPPER(@STATUSID) = 'BROKER'  
BEGIN  
 SELECT @@GROUPBY    = " GROUP BY L.PARTY_CODE , A.ACNAME, BRANCHCODE, ACCAT, GRPCODE, GRPNAME"  
END  
ELSE  
BEGIN  
 SELECT @@GROUPBY    = " GROUP BY ML.PARTY_CODE , A.ACNAME, BRANCHCODE, ACCAT, GRPCODE, GRPNAME"
END  
  
IF UPPER(@STATUSID) = 'BROKER'  
BEGIN  
 IF @FLAG = 'CODEWISE'  
 BEGIN  
    SELECT @@SORTBY = " ORDER BY  L.PARTY_CODE, A.ACNAME, BRANCHCODE"  
 END  
 ELSE   
 BEGIN   
    SELECT @@SORTBY = " ORDER BY  A.ACNAME, L.PARTY_CODE, BRANCHCODE"  
 END  
END  
ELSE  
BEGIN  
 IF @FLAG = 'CODEWISE'  
 BEGIN  
    SELECT @@SORTBY = " ORDER BY  ML.PARTY_CODE, A.ACNAME"  
 END  
 ELSE   
 BEGIN   
    SELECT @@SORTBY = " ORDER BY  A.ACNAME, ML.PARTY_CODE"  
 END  
END  
  
IF @VIEWOPTION = 'PARTYWISE'  
BEGIN  
   SELECT @@ADDWHERE  = " AND A.ACCAT = 4 "   
END  
ELSE IF @VIEWOPTION = 'GL'  
BEGIN  
	SELECT @@ADDWHERE  = " AND A.ACCAT <> 4 "   
END  
ELSE  
BEGIN  
	SELECT @@ADDWHERE  = " "   
END  
  
IF @STATUSID = 'BROKER'  
BEGIN  
      	SELECT @@WHEREPART1 = " WHERE VDT <= '" + @VDT + " 23:59:59' AND L.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART2 = " WHERE VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND L.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART3 = " WHERE VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND L.PARTY_CODE=  A.CLTCODE"   
END  
ELSE
BEGIN  
		SELECT @@WHEREPART1 = " WHERE EXISTS(SELECT COSTNAME FROM #COSTMAST C WHERE BRANCHCODE = C.COSTNAME) AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART2 = " WHERE EXISTS(SELECT COSTNAME FROM #COSTMAST C WHERE BRANCHCODE = C.COSTNAME) AND VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART3 = " WHERE EXISTS(SELECT COSTNAME FROM #COSTMAST C WHERE BRANCHCODE = C.COSTNAME) AND VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=  A.CLTCODE"   

      	/*SELECT @@WHEREPART1 = " WHERE EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L.COSTCODE = C.COSTCODE) AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE AND ML.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART2 = " WHERE EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L.COSTCODE = C.COSTCODE) AND VDT >= '" + @CURRYRSTDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE AND ML.PARTY_CODE=  A.CLTCODE"   
      	SELECT @@WHEREPART3 = " WHERE EXISTS(SELECT COSTCODE FROM #COSTMAST C WHERE L.COSTCODE = C.COSTCODE) AND VDT >= '" + @OPENINGENTRYDATE + " 00:00:00' AND VDT <= '" + @VDT + " 23:59:59' AND ML.PARTY_CODE=A.CLTCODE AND ML.MCLTCODE=L.CLTCODE AND ML.PARTY_CODE=  A.CLTCODE"   */
END  

IF @STATUSID = 'BROKER'  
BEGIN  
IF @BALANCE='NORMAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0   
   BEGIN  
      SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE AMOUNT END),0),ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"', GRPCODE, GRPNAME "  
      SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
      SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 1  
   BEGIN  
        SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE AMOUNT END),0),ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"', GRPCODE, GRPNAME "  
        SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
        SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 2  
   BEGIN  
        SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, AMOUNT = ISNULL(SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE AMOUNT END),0),ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"', GRPCODE, GRPNAME "  
        SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
        SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
ELSE IF @BALANCE='WITHOPBAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0 
   BEGIN  
      IF @CURRYRSTDATE = @STDATE   
         BEGIN  
            SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE, DRTOT = SUM(CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE 0 END), CRTOT = SUM(CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END),OPBAL = 0 "  
            SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
            SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
         END  
      ELSE  
         BEGIN  
           SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'    THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE -AMOUNT END) ELSE 0 END) "  
           SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
           SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
         END  
   END  
   ELSE IF @OPENENTRYFLAG = 1 
   BEGIN  
      IF @CURRYRSTDATE = @STDATE   
         BEGIN  
                SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VTYP = 18 THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE -AMOUNT END) ELSE 0 END)"  
                SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
                SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
         END  
      ELSE  
         BEGIN  
           SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'    THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'  THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE -AMOUNT END) ELSE 0 END) "  
           SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
           SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
         END  
   END  
   ELSE IF @OPENENTRYFLAG = 2  
   BEGIN  
      	SELECT @@SELECTQURY = "SELECT L.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,DRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'     THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE 0 END) ELSE 0 END),CRTOT = SUM(CASE WHEN VTYP <> 18 AND VDT >= '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'C' THEN AMOUNT ELSE 0 END) ELSE 0 END),OPBAL = SUM(CASE WHEN VDT < '" + @STDATE + "'   THEN ( CASE WHEN UPPER(DRCR) = 'D' THEN -AMOUNT ELSE -AMOUNT END) ELSE 0 END) "  
      	SELECT @@FROMTABLES = " FROM MARGINLEDGER L , (SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
      	SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
END    
  
  
IF @STATUSID = 'BRANCH'  
BEGIN  
IF @BALANCE='NORMAL'  
BEGIN  
   IF @OPENENTRYFLAG = 0  
   BEGIN  
      	SELECT @@SELECTQURY = " SELECT ML.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN -ML.AMOUNT ELSE ML.AMOUNT END),0), ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"', GRPCODE, GRPNAME "  
      	SELECT @@FROMTABLES = " FROM (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML,(SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
      	SELECT @@WHEREPART  = @@WHEREPART1 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 1  
   BEGIN  
      	SELECT @@SELECTQURY = " SELECT ML.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN -ML.AMOUNT ELSE ML.AMOUNT END),0), ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"', GRPCODE, GRPNAME "  
      	SELECT @@FROMTABLES = " FROM (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ,(SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
      	SELECT @@WHEREPART  = @@WHEREPART2 + @@ADDWHERE  
   END  
   ELSE IF @OPENENTRYFLAG = 2  
   BEGIN  
      	SELECT @@SELECTQURY = " SELECT ML.PARTY_CODE , ACNAME=ISNULL(A.ACNAME,''), BRANCHCODE,AMOUNT = ISNULL(SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN -ML.AMOUNT ELSE ML.AMOUNT END),0), ACCAT,'" + @EXCHANGE + "','MARGIN " + @EXCHANGE + " - " + @SEGMENT +"', GRPCODE, GRPNAME "  
      	SELECT @@FROMTABLES = " FROM (SELECT PARTY_CODE,AMOUNT,VTYP,VNO,BOOKTYPE,LNO,DRCR,MCLTCODE,VDT FROM MARGINLEDGER) ML ,(SELECT CLTCODE, ACNAME = LONGNAME, ACCAT, BRANCHCODE, A.GRPCODE, FN.GRPNAME FROM ACMAST A WITH(NOLOCK), (SELECT DISTINCT GRPCODE, GRPNAME FROM FN_ACC_GETALLSUBGRPCD ('" + @GRPCODE + "')) FN WHERE  A.GRPCODE = FN.GRPCODE ) A "   
      	SELECT @@WHEREPART  = @@WHEREPART3 + @@ADDWHERE  
   END  
END  
END 

IF @STATUSID = 'BRANCH'  
BEGIN  
	SELECT @@HAVING = " HAVING	CASE WHEN '" + @SHOWZEROBAL + "' <> 'Y' THEN SUM(CASE WHEN UPPER(ML.DRCR) = 'D' THEN -AMOUNT ELSE AMOUNT END) ELSE 1 END <> 0  "
END
ELSE
BEGIN
	SELECT @@HAVING = " HAVING	CASE WHEN '" + @SHOWZEROBAL + "' <> 'Y' THEN SUM(CASE WHEN UPPER(L.DRCR) = 'D' THEN -AMOUNT ELSE AMOUNT END) ELSE 1 END <> 0  "
END
  
PRINT @@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY + @@HAVING + @@SORTBY   
  
EXEC (@@SELECTQURY + @@FROMTABLES + @@WHEREPART + @@GROUPBY +  @@HAVING + @@SORTBY )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_NEWASP_TRIALBALANCE
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[V2_NEWASP_TRIALBALANCE] @VDT VARCHAR(11)  
 ,/* AS ON DATE ENTERED BY USER */  
 @FLAG VARCHAR(15)  
 ,/* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */  
 @VIEWOPTION VARCHAR(10)  
 ,/* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */  
 @BALANCE VARCHAR(10)  
 ,/* NORMAL OR WITHOPBAL */  
 @STDATE VARCHAR(11)  
 ,/* START DATE ENTERED BY USER */  
 @CURRYRSTDATE VARCHAR(11)  
 ,/* START DATE OF FINANCIAL YEAR */  
 @OPENENTRYFLAG INT  
 ,@OPENINGENTRYDATE VARCHAR(11)  
 ,/* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */  
 @STATUSID VARCHAR(20)  
 ,/* AS BROKER/BRANCH/CLIENT ETC. */  
 @STATUSNAME VARCHAR(20)  
 ,/* IN CASE OF BRANCH LOGIN BRANCHCODE */  
 @SORTBYDATE VARCHAR(3)  
 ,/* WHETHER REPORT IS BASED ON VDT OR EDT */  
 @SHOWZEROBAL VARCHAR(1) = 'N'  
 ,/* SHOW ZERO BAL   */  
 @GRPCODE VARCHAR(20)  
 ,@SHAREDB VARCHAR(20)  
 ,@EXCHANGE VARCHAR(10)  
 ,@SEGMENT VARCHAR(9)  
AS  
DECLARE @@COSTCODE AS INT  
 ,@@SQL AS VARCHAR(1000)  
  
CREATE TABLE #COSTMAST (COSTCODE INT)  
  
IF @STATUSID = 'REGION'  
BEGIN  
 SET @@SQL = " INSERT INTO #COSTMAST "  
 SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST C, " + @SHAREDB + ".DBO.REGION R WHERE REGIONCODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "  
END  
  
IF @STATUSID = 'AREA'  
BEGIN  
 SET @@SQL = " INSERT INTO #COSTMAST "  
 SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST C, " + @SHAREDB + ".DBO.AREA A WHERE AREACODE = RTRIM('" + @STATUSNAME + "') AND COSTNAME = BRANCH_CODE "  
END  
  
IF @STATUSID = 'BRANCH'  
BEGIN  
 SET @@SQL = " INSERT INTO #COSTMAST "  
 SET @@SQL = @@SQL + " SELECT COSTCODE FROM COSTMAST WHERE COSTNAME = RTRIM('" + @STATUSNAME + "') "  
END  
  
PRINT (@@SQL)  
  
EXEC (@@SQL)  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
IF UPPER(@STATUSID) = 'BROKER'  
BEGIN  
 IF UPPER(@VIEWOPTION) = 'GL'  
 BEGIN  
  IF UPPER(@SORTBYDATE) = 'VDT'  
  BEGIN  
   SELECT L.CLTCODE  
    ,ACNAME = ISNULL(A.ACNAME, '')  
    ,BRANCHCODE  
    ,AMOUNT = ISNULL(SUM(CASE   
       WHEN UPPER(DRCR) = 'D'  
        THEN - VAMT  
       ELSE VAMT  
       END), 0)  
    ,ACCAT  
    ,@EXCHANGE  
    ,@EXCHANGE + ' - ' + @SEGMENT  
    ,A.GRPCODE  
    ,A.GRPNAME  
   FROM LEDGER L WITH (NOLOCK)  
    ,(  
     SELECT CLTCODE  
      ,ACNAME = LONGNAME  
      ,ACCAT  
      ,BRANCHCODE  
      ,A.GRPCODE  
      ,GRPNAME  
     FROM ACMAST A WITH (NOLOCK)  
      ,#ABC FN  
     WHERE A.GRPCODE = FN.GRPCODE  
     ) A  
   WHERE L.CLTCODE = A.CLTCODE  
    AND VDT >= @CURRYRSTDATE  
    AND VDT <= @VDT + ' 23:59'  
    AND A.ACCAT <> 4  
   GROUP BY L.CLTCODE  
    ,A.ACNAME  
    ,BRANCHCODE  
    ,ACCAT  
    ,A.GRPCODE  
    ,A.GRPNAME  
   HAVING CASE   
     WHEN @SHOWZEROBAL <> 'Y'  
      THEN SUM(CASE   
         WHEN UPPER(DRCR) = 'D'  
          THEN - VAMT  
         ELSE VAMT  
         END)  
     ELSE 1  
     END <> 0  
  END  
  ELSE  
   IF UPPER(@SORTBYDATE) = 'EDT'  
   BEGIN  
    SELECT CLTCODE  
     ,ACNAME  
     ,BRANCHCODE  
     ,AMOUNT = ISNULL(SUM(AMOUNT), 0)  
     ,ACCAT  
     ,@EXCHANGE  
     ,@EXCHANGE + ' - ' + @SEGMENT  
     ,GRPCODE  
     ,GRPNAME  
    FROM (  
     SELECT L.CLTCODE  
      ,ACNAME = ISNULL(A.ACNAME, '')  
      ,BRANCHCODE  
      ,AMOUNT = SUM(CASE   
        WHEN UPPER(DRCR) = 'D'  
         THEN - VAMT  
        ELSE VAMT  
        END)  
      ,ACCAT  
      ,A.GRPCODE  
      ,GRPNAME  
     FROM LEDGER L WITH (NOLOCK)  
      ,(  
       SELECT CLTCODE  
        ,ACNAME = LONGNAME  
        ,ACCAT  
        ,BRANCHCODE  
        ,A.GRPCODE  
        ,FN.GRPNAME  
       FROM ACMAST A WITH (NOLOCK)  
        ,#ABC FN  
       WHERE A.GRPCODE = FN.GRPCODE  
       ) A  
     WHERE L.CLTCODE = A.CLTCODE  
      AND EDT LIKE @CURRYRSTDATE + '%'  
      AND A.ACCAT <> 4  
      AND L.VTYP = 18  
     GROUP BY L.CLTCODE  
      ,A.ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,A.GRPCODE  
      ,GRPNAME  
       
     UNION ALL  
       
     SELECT L.CLTCODE  
      ,ACNAME = ISNULL(A.ACNAME, '')  
      ,BRANCHCODE  
      ,AMOUNT = SUM(CASE   
        WHEN UPPER(DRCR) = 'D'  
         THEN VAMT  
        ELSE - VAMT  
        END)  
      ,ACCAT  
      ,A.GRPCODE  
      ,GRPNAME  
     FROM LEDGER L WITH (NOLOCK)  
      ,(  
       SELECT CLTCODE  
        ,ACNAME = LONGNAME  
        ,ACCAT  
        ,BRANCHCODE  
        ,A.GRPCODE  
        ,FN.GRPNAME  
       FROM ACMAST A WITH (NOLOCK)  
        ,#ABC FN  
       WHERE A.GRPCODE = FN.GRPCODE  
       ) A  
     WHERE L.CLTCODE = A.CLTCODE  
      AND EDT >= @CURRYRSTDATE  
      AND VDT < @CURRYRSTDATE  
      AND A.ACCAT <> 4  
     GROUP BY L.CLTCODE  
      ,A.ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,A.GRPCODE  
      ,GRPNAME  
       
     UNION ALL  
       
     SELECT L.CLTCODE  
      ,ACNAME = ISNULL(A.ACNAME, '')  
      ,BRANCHCODE  
      ,AMOUNT = SUM(CASE   
        WHEN UPPER(DRCR) = 'D'  
         THEN - VAMT  
        ELSE VAMT  
        END)  
      ,ACCAT  
      ,A.GRPCODE  
      ,GRPNAME  
     FROM LEDGER L WITH (NOLOCK)  
      ,(  
       SELECT CLTCODE  
        ,ACNAME = LONGNAME  
        ,ACCAT  
        ,BRANCHCODE  
        ,A.GRPCODE  
        ,FN.GRPNAME  
       FROM ACMAST A WITH (NOLOCK)  
        ,#ABC FN  
       WHERE A.GRPCODE = FN.GRPCODE  
       ) A  
     WHERE L.CLTCODE = A.CLTCODE  
      AND EDT >= @CURRYRSTDATE  
      AND EDT <= @VDT + ' 23:59'  
      AND A.ACCAT <> 4  
      AND L.VTYP <> 18  
     GROUP BY L.CLTCODE  
      ,A.ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,A.GRPCODE  
      ,GRPNAME  
     ) L  
    GROUP BY L.CLTCODE  
     ,ACNAME  
     ,BRANCHCODE  
     ,ACCAT  
     ,GRPCODE  
     ,GRPNAME  
    HAVING CASE   
      WHEN @SHOWZEROBAL <> 'Y'  
       THEN SUM(AMOUNT)  
      ELSE 1  
      END <> 0  
   END  
 END  
 ELSE  
  IF UPPER(@VIEWOPTION) = 'PARTYWISE'  
  BEGIN  
   IF UPPER(@SORTBYDATE) = 'VDT'  
   BEGIN  
    PRINT ';here'  
  
    SELECT L.CLTCODE  
     ,ACNAME = ISNULL(A.ACNAME, '')  
     ,BRANCHCODE  
     ,AMOUNT = ISNULL(SUM(CASE   
        WHEN UPPER(DRCR) = 'D'  
         THEN - VAMT  
        ELSE VAMT  
        END), 0)  
     ,ACCAT  
     ,@EXCHANGE  
     ,@EXCHANGE + ' - ' + @SEGMENT  
     ,GRPCODE  
     ,GRPNAME  
    FROM LEDGER L WITH (NOLOCK)  
     ,(  
      SELECT CLTCODE  
       ,ACNAME = LONGNAME  
       ,ACCAT  
       ,BRANCHCODE  
       ,A.GRPCODE  
       ,GRPNAME  
      FROM ACMAST A WITH (NOLOCK)  
       ,#ABC FN  
      WHERE A.GRPCODE = FN.GRPCODE  
      ) A  
    WHERE L.CLTCODE = A.CLTCODE  
     AND VDT >= @CURRYRSTDATE  
     AND VDT <= @VDT + ' 23:59'  
     AND A.ACCAT = 4  
    GROUP BY L.CLTCODE  
     ,A.ACNAME  
     ,BRANCHCODE  
     ,ACCAT  
     ,GRPCODE  
     ,GRPNAME  
    HAVING CASE   
      WHEN @SHOWZEROBAL <> 'Y'  
       THEN SUM(CASE   
          WHEN UPPER(DRCR) = 'D'  
           THEN - VAMT  
          ELSE VAMT  
          END)  
      ELSE 1  
      END <> 0  
   END  
   ELSE  
    IF UPPER(@SORTBYDATE) = 'EDT'  
    BEGIN  
     SELECT CLTCODE  
      ,ACNAME  
      ,BRANCHCODE  
      ,AMOUNT = ISNULL(SUM(AMOUNT), 0)  
      ,ACCAT  
      ,@EXCHANGE  
      ,@EXCHANGE + ' - ' + @SEGMENT  
      ,GRPCODE  
      ,GRPNAME  
     FROM (  
      SELECT L.CLTCODE  
       ,ACNAME = ISNULL(A.ACNAME, '')  
       ,BRANCHCODE  
       ,AMOUNT = SUM(CASE   
         WHEN UPPER(DRCR) = 'D'  
          THEN - VAMT  
         ELSE VAMT  
         END)  
       ,ACCAT  
       ,A.GRPCODE  
       ,GRPNAME  
      FROM LEDGER L WITH (NOLOCK)  
       ,(  
        SELECT CLTCODE  
         ,ACNAME = LONGNAME  
         ,ACCAT  
         ,BRANCHCODE  
         ,A.GRPCODE  
         ,GRPNAME  
        FROM ACMAST A WITH (NOLOCK)  
         ,#ABC FN  
        WHERE A.GRPCODE = FN.GRPCODE  
        ) A  
      WHERE L.CLTCODE = A.CLTCODE  
       AND EDT LIKE @CURRYRSTDATE + '%'  
       AND A.ACCAT = 4  
       AND L.VTYP = 18  
      GROUP BY L.CLTCODE  
       ,A.ACNAME  
       ,BRANCHCODE  
       ,ACCAT  
       ,A.GRPCODE  
       ,GRPNAME  
        
      UNION ALL  
        
      SELECT L.CLTCODE  
       ,ACNAME = ISNULL(A.ACNAME, '')  
       ,BRANCHCODE  
       ,AMOUNT = SUM(CASE   
         WHEN UPPER(DRCR) = 'D'  
          THEN VAMT  
         ELSE - VAMT  
         END)  
       ,ACCAT  
       ,A.GRPCODE  
       ,GRPNAME  
      FROM LEDGER L WITH (NOLOCK)  
       ,(  
        SELECT CLTCODE  
         ,ACNAME = LONGNAME  
         ,ACCAT  
         ,BRANCHCODE  
         ,A.GRPCODE  
         ,GRPNAME  
        FROM ACMAST A WITH (NOLOCK)  
         ,#ABC FN  
        WHERE A.GRPCODE = FN.GRPCODE  
        ) A  
      WHERE L.CLTCODE = A.CLTCODE  
       AND EDT >= @CURRYRSTDATE  
       AND VDT < @CURRYRSTDATE  
       AND A.ACCAT = 4  
      GROUP BY L.CLTCODE  
       ,A.ACNAME  
       ,BRANCHCODE  
       ,ACCAT  
       ,A.GRPCODE  
       ,GRPNAME  
        
      UNION ALL  
        
      SELECT L.CLTCODE  
       ,ACNAME = ISNULL(A.ACNAME, '')  
       ,BRANCHCODE  
       ,AMOUNT = SUM(CASE   
         WHEN UPPER(DRCR) = 'D'  
          THEN - VAMT  
         ELSE VAMT  
         END)  
       ,ACCAT  
       ,A.GRPCODE  
       ,GRPNAME  
      FROM LEDGER L WITH (NOLOCK)  
       ,(  
        SELECT CLTCODE  
         ,ACNAME = LONGNAME  
         ,ACCAT  
         ,BRANCHCODE  
         ,A.GRPCODE  
         ,GRPNAME  
        FROM ACMAST A WITH (NOLOCK)  
         ,#ABC FN  
        WHERE A.GRPCODE = FN.GRPCODE  
        ) A  
      WHERE L.CLTCODE = A.CLTCODE  
       AND EDT >= @CURRYRSTDATE  
       AND EDT <= @VDT + ' 23:59'  
       AND A.ACCAT = 4  
       AND L.VTYP <> 18  
      GROUP BY L.CLTCODE  
       ,A.ACNAME  
       ,BRANCHCODE  
       ,ACCAT  
       ,A.GRPCODE  
       ,GRPNAME  
      ) L  
     GROUP BY L.CLTCODE  
      ,ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,GRPCODE  
      ,GRPNAME  
     HAVING CASE   
       WHEN @SHOWZEROBAL <> 'Y'  
        THEN SUM(AMOUNT)  
       ELSE 1  
       END <> 0  
    END  
  END  
  ELSE  
   IF UPPER(@VIEWOPTION) = 'ALL'  
   BEGIN  
    IF UPPER(@SORTBYDATE) = 'VDT'  
    BEGIN  
     SELECT L.CLTCODE  
      ,ACNAME = ISNULL(A.ACNAME, '')  
      ,BRANCHCODE  
      ,AMOUNT = ISNULL(SUM(CASE   
         WHEN UPPER(DRCR) = 'D'  
          THEN - VAMT  
         ELSE VAMT  
         END), 0)  
      ,ACCAT  
      ,@EXCHANGE  
      ,@EXCHANGE + ' - ' + @SEGMENT  
      ,GRPCODE  
      ,GRPNAME  
     FROM LEDGER L WITH (NOLOCK)  
      ,(  
       SELECT CLTCODE  
        ,ACNAME = LONGNAME  
        ,ACCAT  
        ,BRANCHCODE  
        ,A.GRPCODE  
        ,GRPNAME  
       FROM ACMAST A WITH (NOLOCK)  
        ,#ABC FN  
       WHERE A.GRPCODE = FN.GRPCODE  
       ) A  
     WHERE L.CLTCODE = A.CLTCODE  
      AND VDT >= @CURRYRSTDATE  
      AND VDT <= @VDT + ' 23:59'  
     GROUP BY L.CLTCODE  
      ,A.ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,GRPCODE  
      ,GRPNAME  
     HAVING CASE   
       WHEN @SHOWZEROBAL <> 'Y'  
        THEN SUM(CASE   
           WHEN UPPER(DRCR) = 'D'  
            THEN - VAMT  
           ELSE VAMT  
           END)  
       ELSE 1  
       END <> 0  
    END  
    ELSE  
     IF UPPER(@SORTBYDATE) = 'EDT'  
     BEGIN  
      SELECT CLTCODE  
       ,ACNAME  
       ,BRANCHCODE  
       ,AMOUNT = ISNULL(SUM(AMOUNT), 0)  
       ,ACCAT  
       ,@EXCHANGE  
       ,@EXCHANGE + ' - ' + @SEGMENT  
       ,GRPCODE  
       ,GRPNAME  
      FROM (  
       SELECT L.CLTCODE  
        ,ACNAME = ISNULL(A.ACNAME, '')  
        ,BRANCHCODE  
        ,AMOUNT = SUM(CASE   
          WHEN UPPER(DRCR) = 'D'  
           THEN - VAMT  
          ELSE VAMT  
          END)  
        ,ACCAT  
        ,A.GRPCODE  
        ,GRPNAME  
       FROM LEDGER L WITH (NOLOCK)  
        ,(  
         SELECT CLTCODE  
          ,ACNAME = LONGNAME  
          ,ACCAT  
          ,BRANCHCODE  
          ,A.GRPCODE  
          ,GRPNAME  
         FROM ACMAST A WITH (NOLOCK)  
          ,#ABC FN  
         WHERE A.GRPCODE = FN.GRPCODE  
         ) A  
       WHERE L.CLTCODE = A.CLTCODE  
        AND EDT >= @CURRYRSTDATE  
        AND EDT <= @VDT + ' 23:59'  
        AND L.VTYP = 18  
       GROUP BY L.CLTCODE  
        ,A.ACNAME  
        ,BRANCHCODE  
        ,ACCAT  
        ,A.GRPCODE  
        ,GRPNAME  
         
       UNION ALL  
         
       SELECT L.CLTCODE  
        ,ACNAME = ISNULL(A.ACNAME, '')  
        ,BRANCHCODE  
        ,AMOUNT = SUM(CASE   
          WHEN UPPER(DRCR) = 'D'  
           THEN VAMT  
          ELSE - VAMT  
          END)  
        ,ACCAT  
        ,A.GRPCODE  
        ,GRPNAME  
       FROM LEDGER L WITH (NOLOCK)  
        ,(  
         SELECT CLTCODE  
          ,ACNAME = LONGNAME  
          ,ACCAT  
          ,BRANCHCODE  
          ,A.GRPCODE  
          ,GRPNAME  
         FROM ACMAST A WITH (NOLOCK)  
          ,#ABC FN  
         WHERE A.GRPCODE = FN.GRPCODE  
         ) A  
       WHERE L.CLTCODE = A.CLTCODE  
        AND EDT >= @CURRYRSTDATE  
        AND VDT < @CURRYRSTDATE  
       GROUP BY L.CLTCODE  
        ,A.ACNAME  
        ,BRANCHCODE  
        ,ACCAT  
        ,A.GRPCODE  
        ,GRPNAME  
         
       UNION ALL  
         
       SELECT L.CLTCODE  
        ,ACNAME = ISNULL(A.ACNAME, '')  
        ,BRANCHCODE  
        ,AMOUNT = SUM(CASE   
          WHEN UPPER(DRCR) = 'D'  
           THEN - VAMT  
          ELSE VAMT  
          END)  
        ,ACCAT  
        ,A.GRPCODE  
        ,GRPNAME  
       FROM LEDGER L WITH (NOLOCK)  
        ,(  
         SELECT CLTCODE  
          ,ACNAME = LONGNAME  
          ,ACCAT  
          ,BRANCHCODE  
          ,A.GRPCODE  
          ,GRPNAME  
         FROM ACMAST A WITH (NOLOCK)  
          ,#ABC FN  
         WHERE A.GRPCODE = FN.GRPCODE  
         ) A  
       WHERE L.CLTCODE = A.CLTCODE  
        AND EDT >= @CURRYRSTDATE  
        AND EDT <= @VDT + ' 23:59'  
        AND L.VTYP <> 18  
       GROUP BY L.CLTCODE  
        ,A.ACNAME  
        ,BRANCHCODE  
        ,ACCAT  
        ,A.GRPCODE  
        ,GRPNAME  
       ) L  
      GROUP BY L.CLTCODE  
       ,ACNAME  
       ,BRANCHCODE  
       ,ACCAT  
       ,GRPCODE  
       ,GRPNAME  
      HAVING CASE   
        WHEN @SHOWZEROBAL <> 'Y'  
         THEN SUM(AMOUNT)  
        ELSE 1  
        END <> 0  
     END  
   END  
END  
  
IF UPPER(@STATUSID) = 'BRANCH'  
BEGIN  
 IF UPPER(@VIEWOPTION) = 'GL'  
 BEGIN  
  IF UPPER(@SORTBYDATE) = 'VDT'  
  BEGIN  
   SELECT L2.CLTCODE  
    ,ACNAME = ISNULL(A.ACNAME, '')  
    ,BRANCHCODE  
    ,AMOUNT = ISNULL(SUM(CASE   
       WHEN UPPER(L2.DRCR) = 'D'  
        THEN - CAMT  
       ELSE CAMT  
       END), 0)  
    ,ACCAT  
    ,@EXCHANGE  
    ,@EXCHANGE + ' - ' + @SEGMENT  
    ,A.GRPCODE  
    ,GRPNAME  
   FROM LEDGER L WITH (NOLOCK)  
    ,LEDGER2 L2 WITH (NOLOCK)  
    ,(  
     SELECT CLTCODE  
      ,ACNAME = LONGNAME  
      ,ACCAT  
      ,BRANCHCODE  
      ,FN.GRPCODE  
      ,GRPNAME  
     FROM ACMAST A WITH (NOLOCK)  
      ,#ABC FN  
     WHERE A.GRPCODE = FN.GRPCODE  
     ) A  
   WHERE L2.CLTCODE = A.CLTCODE  
    AND L2.VTYPE = L.VTYP  
    AND L2.BOOKTYPE = L.BOOKTYPE  
    AND L2.VNO = L.VNO  
    AND L2.LNO = L.LNO  
    AND EXISTS (  
     SELECT COSTCODE  
     FROM #COSTMAST C  
     WHERE L2.COSTCODE = C.COSTCODE  
     )  
    AND VDT >= @CURRYRSTDATE  
    AND VDT <= @VDT + ' 23:59'  
    AND A.ACCAT <> 4  
   GROUP BY L2.CLTCODE  
    ,A.ACNAME  
    ,BRANCHCODE  
    ,ACCAT  
    ,A.GRPCODE  
    ,GRPNAME  
   HAVING CASE   
     WHEN @SHOWZEROBAL <> 'Y'  
      THEN SUM(CASE   
         WHEN UPPER(L2.DRCR) = 'D'  
          THEN - CAMT  
         ELSE CAMT  
         END)  
     ELSE 1  
     END <> 0  
  END  
  ELSE  
   IF UPPER(@SORTBYDATE) = 'EDT'  
   BEGIN  
    SELECT CLTCODE  
     ,ACNAME  
     ,BRANCHCODE  
     ,AMOUNT = ISNULL(SUM(AMOUNT), 0)  
     ,ACCAT  
     ,@EXCHANGE  
     ,@EXCHANGE + ' - ' + @SEGMENT  
     ,GRPCODE  
     ,GRPNAME  
    FROM (  
     SELECT L2.CLTCODE  
      ,ACNAME = ISNULL(A.ACNAME, '')  
      ,BRANCHCODE  
      ,AMOUNT = SUM(CASE   
        WHEN UPPER(L2.DRCR) = 'D'  
         THEN CAMT  
        ELSE - CAMT  
        END)  
      ,ACCAT  
      ,A.GRPCODE  
      ,A.GRPNAME  
     FROM LEDGER L WITH (NOLOCK)  
      ,LEDGER2 L2 WITH (NOLOCK)  
      ,(  
       SELECT CLTCODE  
        ,ACNAME = LONGNAME  
        ,ACCAT  
        ,BRANCHCODE  
        ,FN.GRPCODE  
        ,FN.GRPNAME  
       FROM ACMAST A WITH (NOLOCK)  
        ,#ABC FN  
       WHERE A.GRPCODE = FN.GRPCODE  
       ) A  
     WHERE L2.CLTCODE = A.CLTCODE  
      AND L2.VTYPE = L.VTYP  
      AND L2.BOOKTYPE = L.BOOKTYPE  
      AND L2.VNO = L.VNO  
      AND L2.LNO = L.LNO  
      AND EXISTS (  
       SELECT COSTCODE  
       FROM #COSTMAST C  
       WHERE L2.COSTCODE = C.COSTCODE  
       )  
      AND EDT >= @CURRYRSTDATE  
      AND VDT < @CURRYRSTDATE  
      AND A.ACCAT <> 4  
     GROUP BY L2.CLTCODE  
      ,A.ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,A.GRPCODE  
      ,A.GRPNAME  
       
     UNION ALL  
       
     SELECT L2.CLTCODE  
      ,ACNAME = ISNULL(A.ACNAME, '')  
      ,BRANCHCODE  
      ,AMOUNT = SUM(CASE   
        WHEN UPPER(L2.DRCR) = 'D'  
         THEN - CAMT  
        ELSE CAMT  
        END)  
      ,ACCAT  
      ,A.GRPCODE  
      ,A.GRPNAME  
     FROM LEDGER L WITH (NOLOCK)  
      ,LEDGER2 L2 WITH (NOLOCK)  
      ,(  
       SELECT CLTCODE  
        ,ACNAME = LONGNAME  
        ,ACCAT  
        ,BRANCHCODE  
        ,FN.GRPCODE  
        ,GRPNAME  
       FROM ACMAST A WITH (NOLOCK)  
        ,#ABC FN  
       WHERE A.GRPCODE = FN.GRPCODE  
       ) A  
     WHERE L2.CLTCODE = A.CLTCODE  
      AND L2.VTYPE = L.VTYP  
      AND L2.BOOKTYPE = L.BOOKTYPE  
      AND L2.VNO = L.VNO  
      AND L2.LNO = L.LNO  
      AND EXISTS (  
       SELECT COSTCODE  
       FROM #COSTMAST C  
       WHERE L2.COSTCODE = C.COSTCODE  
       )  
      AND EDT >= @CURRYRSTDATE  
      AND EDT <= @VDT + ' 23:59'  
      AND A.ACCAT <> 4  
     GROUP BY L2.CLTCODE  
      ,A.ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,A.GRPCODE  
      ,A.GRPNAME  
     ) L  
    GROUP BY L.CLTCODE  
     ,ACNAME  
     ,BRANCHCODE  
     ,ACCAT  
     ,GRPCODE  
     ,GRPNAME  
    HAVING CASE   
      WHEN @SHOWZEROBAL <> 'Y'  
       THEN SUM(AMOUNT)  
      ELSE 1  
      END <> 0  
   END  
 END  
 ELSE  
  IF UPPER(@VIEWOPTION) = 'PARTYWISE'  
  BEGIN  
   IF UPPER(@SORTBYDATE) = 'VDT'  
   BEGIN  
    PRINT 'here1'  
  
    SELECT L2.CLTCODE  
     ,ACNAME = ISNULL(A.ACNAME, '')  
     ,BRANCHCODE  
     ,AMOUNT = ISNULL(SUM(CASE   
        WHEN UPPER(L2.DRCR) = 'D'  
         THEN - CAMT  
        ELSE CAMT  
        END), 0)  
     ,ACCAT  
     ,@EXCHANGE  
     ,@EXCHANGE + ' - ' + @SEGMENT  
     ,A.GRPCODE  
     ,A.GRPNAME  
    FROM LEDGER L WITH (NOLOCK)  
     ,LEDGER2 L2 WITH (NOLOCK)  
     ,(  
      SELECT CLTCODE  
       ,ACNAME = LONGNAME  
       ,ACCAT  
       ,BRANCHCODE  
       ,FN.GRPCODE  
       ,GRPNAME  
      FROM ACMAST A WITH (NOLOCK)  
       ,#ABC FN  
      WHERE A.GRPCODE = FN.GRPCODE  
      ) A  
    WHERE L2.CLTCODE = A.CLTCODE  
     AND L2.VTYPE = L.VTYP  
     AND L2.BOOKTYPE = L.BOOKTYPE  
     AND L2.VNO = L.VNO  
     AND L2.LNO = L.LNO  
     AND EXISTS (  
      SELECT COSTCODE  
      FROM #COSTMAST C  
      WHERE L2.COSTCODE = C.COSTCODE  
      )  
     AND VDT >= @CURRYRSTDATE  
     AND VDT <= @VDT + ' 23:59'  
     AND A.ACCAT = 4  
    GROUP BY L2.CLTCODE  
     ,A.ACNAME  
     ,BRANCHCODE  
     ,ACCAT  
     ,A.GRPCODE  
     ,A.GRPNAME  
    HAVING CASE   
      WHEN @SHOWZEROBAL <> 'Y'  
       THEN SUM(CASE   
          WHEN UPPER(L2.DRCR) = 'D'  
           THEN - CAMT  
          ELSE CAMT  
          END)  
      ELSE 1  
      END <> 0  
   END  
   ELSE  
    IF UPPER(@SORTBYDATE) = 'EDT'  
    BEGIN  
     PRINT 'BHRT'  
  
     SELECT CLTCODE  
      ,ACNAME  
      ,BRANCHCODE  
      ,AMOUNT = ISNULL(SUM(AMOUNT), 0)  
      ,ACCAT  
      ,@EXCHANGE  
      ,@EXCHANGE + ' - ' + @SEGMENT  
      ,GRPCODE  
      ,GRPNAME  
     FROM (  
      SELECT L2.CLTCODE  
       ,ACNAME = ISNULL(A.ACNAME, '')  
       ,BRANCHCODE  
       ,AMOUNT = SUM(CASE   
         WHEN UPPER(L2.DRCR) = 'D'  
          THEN CAMT  
         ELSE - CAMT  
         END)  
       ,ACCAT  
       ,A.GRPCODE  
       ,A.GRPNAME  
      FROM LEDGER L WITH (NOLOCK)  
       ,LEDGER2 L2 WITH (NOLOCK)  
       ,(  
        SELECT CLTCODE  
         ,ACNAME = LONGNAME  
         ,ACCAT  
         ,BRANCHCODE  
         ,FN.GRPCODE  
         ,FN.GRPNAME  
        FROM ACMAST A WITH (NOLOCK)  
         ,#ABC FN  
        WHERE A.GRPCODE = FN.GRPCODE  
        ) A  
      WHERE L2.CLTCODE = A.CLTCODE  
       AND L2.VTYPE = L.VTYP  
       AND L2.BOOKTYPE = L.BOOKTYPE  
       AND L2.VNO = L.VNO  
       AND L2.LNO = L.LNO  
       AND EXISTS (  
        SELECT COSTCODE  
        FROM #COSTMAST C  
        WHERE L2.COSTCODE = C.COSTCODE  
        )  
       AND EDT >= @CURRYRSTDATE  
       AND VDT < @CURRYRSTDATE  
       AND A.ACCAT = 4  
      GROUP BY L2.CLTCODE  
       ,A.ACNAME  
       ,BRANCHCODE  
       ,ACCAT  
       ,A.GRPCODE  
       ,A.GRPNAME  
        
      UNION ALL  
        
      SELECT L2.CLTCODE  
       ,ACNAME = ISNULL(A.ACNAME, '')  
       ,BRANCHCODE  
       ,AMOUNT = SUM(CASE   
         WHEN UPPER(L2.DRCR) = 'D'  
          THEN - CAMT  
         ELSE CAMT  
         END)  
       ,ACCAT  
       ,A.GRPCODE  
       ,GRPNAME  
      FROM LEDGER L WITH (NOLOCK)  
       ,LEDGER2 L2 WITH (NOLOCK)  
       ,(  
        SELECT CLTCODE  
         ,ACNAME = LONGNAME  
         ,ACCAT  
         ,BRANCHCODE  
         ,FN.GRPCODE  
         ,FN.GRPNAME  
        FROM ACMAST A WITH (NOLOCK)  
         ,#ABC FN  
        WHERE A.GRPCODE = FN.GRPCODE  
        ) A  
      WHERE L2.CLTCODE = A.CLTCODE  
       AND L2.VTYPE = L.VTYP  
       AND L2.BOOKTYPE = L.BOOKTYPE  
       AND L2.VNO = L.VNO  
       AND L2.LNO = L.LNO  
       AND EXISTS (  
        SELECT COSTCODE  
        FROM #COSTMAST C  
        WHERE L2.COSTCODE = C.COSTCODE  
        )  
       AND EDT >= @CURRYRSTDATE  
       AND EDT <= @VDT + ' 23:59'  
       AND A.ACCAT = 4  
      GROUP BY L2.CLTCODE  
       ,A.ACNAME  
       ,BRANCHCODE  
       ,ACCAT  
       ,A.GRPCODE  
       ,A.GRPNAME  
      ) L  
     GROUP BY L.CLTCODE  
      ,ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,GRPCODE  
      ,GRPNAME  
     HAVING CASE   
       WHEN @SHOWZEROBAL <> 'Y'  
        THEN SUM(AMOUNT)  
       ELSE 1  
       END <> 0  
    END  
  END  
  ELSE  
   IF UPPER(@VIEWOPTION) = 'ALL'  
   BEGIN  
    IF UPPER(@SORTBYDATE) = 'VDT'  
    BEGIN  
     SELECT L2.CLTCODE  
      ,ACNAME = ISNULL(A.ACNAME, '')  
      ,BRANCHCODE  
      ,AMOUNT = ISNULL(SUM(CASE   
         WHEN UPPER(L2.DRCR) = 'D'  
          THEN - CAMT  
         ELSE CAMT  
         END), 0)  
      ,ACCAT  
      ,@EXCHANGE  
      ,@EXCHANGE + ' - ' + @SEGMENT  
      ,A.GRPCODE  
      ,A.GRPNAME  
     FROM LEDGER L WITH (NOLOCK)  
      ,LEDGER2 L2 WITH (NOLOCK)  
      ,(  
       SELECT CLTCODE  
        ,ACNAME = LONGNAME  
        ,ACCAT  
        ,BRANCHCODE  
        ,FN.GRPCODE  
        ,GRPNAME  
       FROM ACMAST A WITH (NOLOCK)  
        ,#ABC FN  
       WHERE A.GRPCODE = FN.GRPCODE  
       ) A  
     WHERE L2.CLTCODE = A.CLTCODE  
      AND L2.VTYPE = L.VTYP  
      AND L2.BOOKTYPE = L.BOOKTYPE  
      AND L2.VNO = L.VNO  
      AND L2.LNO = L.LNO  
      AND EXISTS (  
       SELECT COSTCODE  
       FROM #COSTMAST C  
       WHERE L2.COSTCODE = C.COSTCODE  
       )  
      AND VDT >= @CURRYRSTDATE  
      AND VDT <= @VDT + ' 23:59'  
     GROUP BY L2.CLTCODE  
      ,A.ACNAME  
      ,BRANCHCODE  
      ,ACCAT  
      ,GRPCODE  
      ,GRPNAME  
     HAVING CASE   
       WHEN @SHOWZEROBAL <> 'Y'  
        THEN SUM(CASE   
           WHEN UPPER(L2.DRCR) = 'D'  
            THEN - CAMT  
           ELSE CAMT  
           END)  
       ELSE 1  
       END <> 0  
    END  
    ELSE  
     IF UPPER(@SORTBYDATE) = 'EDT'  
     BEGIN  
      SELECT CLTCODE  
       ,ACNAME  
       ,BRANCHCODE  
       ,AMOUNT = ISNULL(SUM(AMOUNT), 0)  
       ,ACCAT  
       ,@EXCHANGE  
       ,@EXCHANGE + ' - ' + @SEGMENT  
       ,GRPCODE  
       ,GRPNAME  
      FROM (  
       SELECT L2.CLTCODE  
        ,ACNAME = ISNULL(A.ACNAME, '')  
        ,BRANCHCODE  
        ,AMOUNT = SUM(CASE   
          WHEN UPPER(L2.DRCR) = 'D'  
           THEN CAMT  
          ELSE - CAMT  
          END)  
        ,ACCAT  
        ,A.GRPCODE  
        ,A.GRPNAME  
       FROM LEDGER L WITH (NOLOCK)  
        ,LEDGER2 L2 WITH (NOLOCK)  
        ,(  
         SELECT CLTCODE  
          ,ACNAME = LONGNAME  
          ,ACCAT  
          ,BRANCHCODE  
          ,FN.GRPCODE  
          ,FN.GRPNAME  
         FROM ACMAST A WITH (NOLOCK)  
          ,#ABC FN  
         WHERE A.GRPCODE = FN.GRPCODE  
         ) A  
       WHERE L2.CLTCODE = A.CLTCODE  
        AND L2.VTYPE = L.VTYP  
        AND L2.BOOKTYPE = L.BOOKTYPE  
        AND L2.VNO = L.VNO  
        AND L2.LNO = L.LNO  
        AND EXISTS (  
         SELECT COSTCODE  
         FROM #COSTMAST C  
         WHERE L2.COSTCODE = C.COSTCODE  
         )  
        AND EDT >= @CURRYRSTDATE  
        AND VDT < @CURRYRSTDATE  
       GROUP BY L2.CLTCODE  
        ,A.ACNAME  
        ,BRANCHCODE  
        ,ACCAT  
        ,A.GRPCODE  
        ,A.GRPNAME  
         
       UNION ALL  
         
       SELECT L2.CLTCODE  
        ,ACNAME = ISNULL(A.ACNAME, '')  
        ,BRANCHCODE  
        ,AMOUNT = SUM(CASE   
          WHEN UPPER(L2.DRCR) = 'D'  
           THEN - CAMT  
          ELSE CAMT  
          END)  
        ,ACCAT  
        ,A.GRPCODE  
        ,A.GRPNAME  
       FROM LEDGER L WITH (NOLOCK)  
        ,LEDGER2 L2 WITH (NOLOCK)  
        ,(  
         SELECT CLTCODE  
          ,ACNAME = LONGNAME  
          ,ACCAT  
          ,BRANCHCODE  
          ,FN.GRPCODE  
          ,FN.GRPNAME  
         FROM ACMAST A WITH (NOLOCK)  
          ,#ABC FN  
         WHERE A.GRPCODE = FN.GRPCODE  
         ) A  
       WHERE L2.CLTCODE = A.CLTCODE  
        AND L2.VTYPE = L.VTYP  
        AND L2.BOOKTYPE = L.BOOKTYPE  
        AND L2.VNO = L.VNO  
        AND L2.LNO = L.LNO  
        AND EXISTS (  
         SELECT COSTCODE  
         FROM #COSTMAST C  
         WHERE L2.COSTCODE = C.COSTCODE  
         )  
        AND EDT >= @CURRYRSTDATE  
        AND EDT <= @VDT + ' 23:59'  
       GROUP BY L2.CLTCODE  
        ,A.ACNAME  
        ,BRANCHCODE  
        ,ACCAT  
        ,A.GRPCODE  
        ,A.GRPNAME  
       ) L  
      GROUP BY L.CLTCODE  
       ,ACNAME  
       ,BRANCHCODE  
       ,ACCAT  
       ,GRPCODE  
       ,GRPNAME  
      HAVING CASE   
        WHEN @SHOWZEROBAL <> 'Y'  
         THEN SUM(AMOUNT)  
        ELSE 1  
        END <> 0  
     END  
   END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_COSTCENTER_REPORT
-- --------------------------------------------------

create Procedure [dbo].[V2_OFFLINE_COSTCENTER_REPORT]  
as  
  
select  /*a.FldAuto as [S No],  */
 a.VoucherNo as [Ref No],  
 a.LedgerVNo as [V No],  
 a.VoucherType as [V Type],    
 a.BookType as [Book Type],    
 a.SNo  as [L No],    
 a.VDate as [V Dt],    
 a.Edate as [E Dt],    
 a.CltCode  as [Clt Code],    
 a.OppCode  as [GL Code],    
 [Credit Amt] = (Case when b.CreditAmt <> 0 then b.CreditAmt else a.CreditAmt end),  
 [Debit Amt] = (case when b.DebitAmt <> 0 then b.DebitAmt else a.DebitAmt end),  
 isnull(b.BranchCode, a.BranchCode) as [Branch Cd],  
 isnull(b.CatCode, a.BranchCode) as [Cat Cd],  
 isnull(b.CostCode, a.BranchCode) as [Cost Cd]/*,  
 a.addby  as [Add By],    
 a.adddt  as [Add Dt] */
from   
 anand.account_ab_dbo.v2_offline_cc_entries b  
inner  join   
 anand.account_ab_dbo.v2_offline_ledger_entries a  
 on (b.VOLE_RefNo = a.FldAuto)  
Where  
 a.RowState = 0  
Order by A.FldAuto

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_ENTRIES_FROMLEDGER
-- --------------------------------------------------

CREATE Proc [dbo].[V2_OFFLINE_ENTRIES_FROMLEDGER]    
(@EXCHANGE VARCHAR(3), @SEGMENT VARCHAR(10))  
  
as    
  
--INSERT INTO V2_OFFLINE_LEDGER_ENTRIES  
Select z.*  from     
(    
Select l.Vtyp, l.BookTYpe,  
Lno =(case when L.vtyp not in ('6','7','8') then    
 CAST(L.LNO AS INT) - 1   
else  
 l.lno  
   end    
 ),  
vdt =cast(left(l.Vdt,11) as datetime), evdt =cast(left(l.edt,11) as datetime), l.CltCode,CreditAmt= Case when L.drcr = 'C' then l.Vamt else 0 end ,    
DebitAmt = Case when L.drcr = 'D' then l.Vamt else 0 end,     
l.Narration,     
OppCode = (case when L.vtyp not in (6,7,8) then    
  case when L.lno = 1 then l.CltCode     
   else    
    (Select top 1 CltCode from Ledger x where x.vno = l.vno and x.vtyp = l.vtyp and x.booktype = l.booktype and x.lno = 1)    
   end    
    else '' end),    
MARGINCODE = '',  
BankName= l1.BNKNAME,    
BankBranch = L1.BRNNAME, a.BranchCode,     
DDNo = L1.DDNO,     
ChqMode =  L1.DD,  
ChqDt = L1.DDDT,     
ChqName = L1.CHEQUEINNAME,    
ClearMode = L1.CLEAR_MODE,     
TPACNum = (CASE WHEN A.ACNAME = L1.CHEQUEINNAME THEN 1 ELSE 0 END),   
Exchange='NSE',    
Segment='CAPITAL',    
TPFlag = '0',    
AddDt = l.pdt,     
AddBy = l.EnteredBy,    
StatusId= 'STATUSID',    
StatusName = 'STATUSNAME',    
RowState = 1,    
ApprovalFlag = 1,    
ApprovedDt = l.pdt,     
ApprovedBy = l.CheckedBy,     
VoucherNo = l.Vno,     
UploadDt = l.Pdt,     
LedgerVno = l.vno,     
ClientName = a.AcName,     
OppCodeName = a.AcName,     
MarginCodeName = '',    
SettNo = '',    
SettType = '',    
ProductType = '',    
RevAmt = 0,    
RevCode = '',    
MICR = L1.MICRNO
From Ledger l    
join acmast a    
on (a.cltcode = l.cltcode)    
LEFT OUTER JOIN LEDGER1 L1  
ON (L1.VTYP = L.VTYP AND L1.VNO = L.VNO AND L1.BOOKTYPE = L.BOOKTYPE AND L1.LNO = L.LNO)  
LEFT OUTER JOIN LEDGER2 L2
	LEFT OUTER JOIN COSTMAST CM
		LEFT OUTER JOIN CATEGORY C ON (C.CATCODE = CM.CATCODE)
		ON (CM.COSTCODE = L2.COSTCODE)
ON (L2.VTYPE = L.VTYP AND L2.VNO = L.VNO AND L2.BOOKTYPE = L.BOOKTYPE AND L2.LNO = L.LNO)  
Where l.Vtyp < '10'    
) z     
where z.cltcode <> z.oppcode    
Order by VTyp    
    
--INSERT INTO V2_OFFLINE_CC_ENTRIES  
SELECT V.FLDAUTO, 
CCCREDIT = CASE WHEN L2.DRCR = 'D' THEN CAMT ELSE 0 END,
CCDEBIT = CASE WHEN L2.DRCR = 'C' THEN CAMT ELSE 0 END,
V.CLTCODE, 
V.OPPCODE,
V.BRANCHCODE,
C.CATEGORY,
CM.COSTNAME,
V.ADDBY,
V.STATUSID,
V.STATUSNAME,
V.ADDDT
FROM ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES V
LEFT OUTER JOIN LEDGER2 L2
	LEFT OUTER JOIN COSTMAST CM
		LEFT OUTER JOIN CATEGORY C ON (C.CATCODE = CM.CATCODE)
		ON (CM.COSTCODE = L2.COSTCODE)
ON (L2.VTYPE = V.VOUCHERTYPE AND L2.VNO = V.LEDGERVNO AND L2.BOOKTYPE = V.BOOKTYPE AND L2.LNO = V.SNO)  
WHERE ISNULL(C.CATEGORY,'') <> ''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_JVDRCR_UPLOAD
-- --------------------------------------------------


create PROC [dbo].[V2_OFFLINE_JVDRCR_UPLOAD]
	@FNAME VARCHAR(100),
	@UNAME VARCHAR(25),
	@VTYP SMALLINT,
	@BOOKTYPE VARCHAR(2),
	@EXCHANGE VARCHAR(3),
    @SEGMENT  VARCHAR(10),
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(15)
 

AS
/*
	Exec V2_OFFLINE_JVDRCR_UPLOAD 'D:\BackOffice\DrCrNotes\TEST.Csv', 'BHRATA', 6, '01' 
	EXEC V2_OFFLINE_JVDRCR_UPLOAD 'D:\BACKOFFICE\DRCRNOTES\TEST.CSV', 'DEMO', 8, '01', 'NSE', 'CAPITAL','BROKER','BROKER' 
	
	SP CREATED BY		-	BHARAT
	SP CREATED ON		-	JAN, 22 2009
	ROLLBACK
*/
	SET NOCOUNT ON
	SELECT @UNAME = 'B_' + LTRIM(RTRIM(@UNAME))
	DECLARE
		@@ERROR_COUNT AS INT,
		@@SQL AS VARCHAR(2000),
		@@STD_DATE VARCHAR(11),
		@@LST_DATE VARCHAR(11),
		@@VNOMETHOD INT,
		@@ACNAME CHAR(100),
		@@MICRNO VARCHAR(10),
		@@DRCR VARCHAR(1),
		@@NEWVNO AS VARCHAR(12),
		@@VDT AS VARCHAR(11),
		@@LNOCUR AS CURSOR,
		@@LNOVNO AS INT,
		@@NOREC AS INT,
		@@MAXVNO AS VARCHAR(12),
		@@VNO AS VARCHAR(12),
		@@RCOUNT AS INT,
		@@L2CUR AS CURSOR,
		@@BRANCHFLAG AS SMALLINT,
		@@L2VNO AS VARCHAR(12),
		@@MyTempVno AS VARCHAR(12)
/* '--------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/
	IF LTRIM(RTRIM(@FNAME)) = ''
		BEGIN
			SELECT RESULT = 'INVALID FILENAME SPECIFIED. PLEASE TRY AGAIN.'
			RETURN
		END

	CREATE TABLE #FEXIST
		(F1 INT, F2 INT, F3 INT)
	
	SELECT @@SQL = "INSERT INTO #FEXIST EXEC MASTER.DBO.XP_FILEEXIST  '" + @FNAME + "' "
	EXEC (@@SQL)

	SELECT @@ERROR_COUNT = F1 FROM #FEXIST
	IF @@ERROR_COUNT = 0
		BEGIN
			SELECT RESULT = 'THE SPECIFIED FILE DOES NOT EXIST. PLEASE TYPE CORRECT FILENAME.'
			DROP TABLE #FEXIST
			RETURN
		END

	BEGIN DISTRIBUTED TRANSACTION --BEGIN TRAN
	IF @VTYP = 8
		BEGIN
			SELECT 
				@@ERROR_COUNT = COUNT(1) 
			FROM
				(SELECT 
					U_FILENAME 
				FROM 
					V2_UPLOADED_FILES
				WHERE 
					U_FILENAME = @FNAME 
					AND U_MODULE = 'JV UPLOAD') A
		END
	ELSE
		BEGIN
			SELECT 
				@@ERROR_COUNT = COUNT(1) 
			FROM
				(SELECT 
					U_FILENAME 
				FROM 
					V2_UPLOADED_FILES
				WHERE 
					U_FILENAME = @FNAME 
					AND U_MODULE = 'DRCR NOTE UPLOAD') A
		END

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.' + @FNAME
			ROLLBACK TRAN
			RETURN
		END


	CREATE TABLE #RECPAY_TABLE_TMP
	(
		SRNO INT,
		VVDT VARCHAR(10),
		EEDT VARCHAR(10),
		CLTCODE VARCHAR(10),
		DRCR VARCHAR(1),
		AMOUNT MONEY,
		NARRATION VARCHAR(500)
	)

	CREATE TABLE [#RECPAY_TABLE]
	(
		SRNO INT,
		VVDT VARCHAR(10),
		EEDT VARCHAR(10),
		CLTCODE VARCHAR(10),
		DRCR VARCHAR(1),
		AMOUNT MONEY,
		NARRATION VARCHAR(500),
		SNO INT IDENTITY (1, 1) NOT NULL ,
		VDT DATETIME NULL ,
		UPDFLAG VARCHAR (1)  NOT NULL DEFAULT('N'),
		EDT DATETIME NULL ,
		VNO VARCHAR (12)  NULL ,
		ACNAME VARCHAR (100)  NULL ,
		FYSTART DATETIME NULL,
		FYEND DATETIME NULL,
		COSTCODE SMALLINT NULL,
		LNO SMALLINT NOT NULL DEFAULT(0)
	) ON [PRIMARY]

	CREATE TABLE [#RECPAY_TABLE_LNO]
	(
		SNO INT ,
		LNO INT IDENTITY (1, 1) NOT NULL
	) ON [PRIMARY]

	SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '"+ @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2) "
	EXEC(@@SQL)

	IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			SELECT 'DUE TO SOME ERROR IN BULK UPLOAD, FILE COULD NOT BE UPLOADED.'
			RETURN
		END

	IF @VTYP = 8
		BEGIN
		      INSERT INTO V2_UPLOADED_FILES
		      SELECT
				@FNAME,
				@FNAME,
				COUNT(1),
				'B',
				GETDATE(),
				@UNAME,
				'JV UPLOAD'
		END
	ELSE
		BEGIN
		      INSERT INTO V2_UPLOADED_FILES
		      SELECT
				@FNAME,
				@FNAME,
				COUNT(1),
				'B',
				GETDATE(),
				@UNAME,
				'DRCR NOTE UPLOAD'
		END

	INSERT INTO #RECPAY_TABLE
		(SRNO,
		VVDT,
		EEDT,
		CLTCODE,
		DRCR,
		AMOUNT,
		NARRATION)
	SELECT
		SRNO,
		VVDT,
		EEDT,
		UPPER(CLTCODE),
		DRCR,
		AMOUNT,
		LEFT(NARRATION, 234)
	FROM #RECPAY_TABLE_TMP

	IF @@ERROR <> 0
		BEGIN
			ROLLBACK TRAN
			SELECT 'DUE TO SYSTEM ERROR, FILE COULD NOT BE UPLOADED.'
			RETURN
		END

	UPDATE
		#RECPAY_TABLE
	SET
		VDT = CONVERT(DATETIME, RIGHT(VVDT,4) + '-' + SUBSTRING(VVDT,4,2) + '-' + LEFT(VVDT,2)),
		EDT = CONVERT(DATETIME, RIGHT(EEDT,4) + '-' + SUBSTRING(EEDT,4,2) + '-' + LEFT(EEDT,2))

	SELECT TOP 1
		@@VDT = CONVERT(VARCHAR(11), VDT, 109)
	FROM
		#RECPAY_TABLE

	SELECT TOP 1
		@@VNOMETHOD = VNOFLAG,
		@@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),
		@@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),
		@@BRANCHFLAG = BRANCHFLAG
	FROM
		PARAMETER
	WHERE
		@@VDT BETWEEN SDTCUR AND LDTCUR

	IF @@BRANCHFLAG = 1
		BEGIN
			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = LONGNAME,
					COSTCODE = C.COSTCODE
		      FROM ACMAST A, PARAMETER P, COSTMAST C
		      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
		      AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
		      AND A.ACCAT IN ('3','4','104')
		      AND A.BRANCHCODE = C.COSTNAME
		      AND A.BRANCHCODE <> 'ALL'

			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = LONGNAME,
					COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
		      FROM ACMAST A, PARAMETER P
		      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
		      AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
		      AND A.ACCAT IN ('3','4','104')
		      AND A.BRANCHCODE = 'ALL'
		END
	ELSE
		BEGIN
			UPDATE
				#RECPAY_TABLE
				SET
					FYSTART = P.SDTCUR,
					FYEND = P.LDTCUR,
					UPDFLAG = 'Y',
					ACNAME = LONGNAME
		      FROM ACMAST A, PARAMETER P
		      WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE
		      AND @@VDT BETWEEN P.SDTCUR AND P.LDTCUR
		      AND A.ACCAT IN ('3','4','104')
		END

/* '--------------------------VALIDATION FOR VOUCHER DATE NOT IN CURRENT FIN YEAR ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM #RECPAY_TABLE WHERE VDT NOT BETWEEN FYSTART AND FYEND

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'SOME OF THE VOUCHERS ARE NOT FALLING IN THE RESPECTIVE FINANCIAL YEAR.'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			IF @VTYP = 8
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
				END
			ELSE
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
				END
			RETURN
		END

/* '--------------------------UPDATE OF COST CODE ------------------------*/
	IF @@BRANCHFLAG = 1
		BEGIN
			UPDATE #RECPAY_TABLE
				SET COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')
			WHERE COSTCODE IS NULL
		END

/*--------------------------VALIDATION FOR DIFFERENT VDTS IN SAME VOUCHER ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT) FROM  #RECPAY_TABLE WHERE SRNO IN (SELECT DISTINCT SRNO FROM #RECPAY_TABLE)
	GROUP BY SRNO HAVING COUNT(DISTINCT VDT) > 1
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			IF @VTYP = 8
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
				END
			ELSE
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
				END
			RETURN
		END

/*--------------------------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ------------------------*/
	SELECT @@ERROR_COUNT = 0
	SELECT @@ERROR_COUNT = COUNT(1) FROM
		(SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)
		FROM #RECPAY_TABLE
		GROUP BY SRNO
		HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A
	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'
			ROLLBACK TRAN
			IF @VTYP = 8
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
				END
			ELSE
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
				END
			RETURN
		END

/* '--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/

	SELECT @@ERROR_COUNT = COUNT(1) FROM
	(
		SELECT DISTINCT
			CLTCODE
		FROM #RECPAY_TABLE
		WHERE UPDFLAG = 'N'
	) A

	IF @@ERROR_COUNT > 0
		BEGIN
			SELECT 'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST' UNION ALL
			SELECT DISTINCT
				CLTCODE
			FROM #RECPAY_TABLE
			WHERE UPDFLAG = 'N'
			DROP TABLE #RECPAY_TABLE_TMP
			DROP TABLE #RECPAY_TABLE
			ROLLBACK TRAN
			IF @VTYP = 8
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'JV UPLOAD'
				END
			ELSE
				BEGIN
					DELETE FROM V2_UPLOADED_FILES
						WHERE U_FILENAME = @FNAME AND U_MODULE = 'DRCR NOTE UPLOAD'
				END
			RETURN
		END

	UPDATE #RECPAY_TABLE 
	SET ACNAME = A.LONGNAME 
	FROM ACMAST A (NOLOCK) 
	WHERE A.CLTCODE = #RECPAY_TABLE.CLTCODE 

	SET @@MyTempVno = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6) 

	INSERT INTO ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES
			(VOUCHERTYPE,
			BOOKTYPE,
			SNO,
			VDATE,
			EDATE,
			CLTCODE,
			CREDITAMT,
			DEBITAMT,
			NARRATION,
			EXCHANGE,
			SEGMENT,
			TPFLAG,
			ADDDT,
			ADDBY,
			STATUSID,
			STATUSNAME,
			ROWSTATE,
			APPROVALFLAG,
			APPROVALDATE,
			APPROVEDBY,
			VOUCHERNO,
			UPLOADDT,
			CLIENTNAME)

	SELECT 
		@VTYP,'01',SRNO, VDT, EDT, CLTCODE, 
		CASE WHEN DRCR = 'D' THEN AMOUNT ELSE 0 END, CASE WHEN DRCR = 'C' THEN AMOUNT ELSE 0 END, NARRATION, 
		@EXCHANGE, @SEGMENT,0,GETDATE(),@UNAME,@STATUSID,@STATUSNAME,0,0,
		GETDATE(),'',@@MyTempVno,GETDATE(),ACNAME
	FROM 
		#RECPAY_TABLE

	COMMIT TRANSACTION
	SELECT RESULT = 'Data Uploaded Successfully'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_JVDRCRUPLOAD
-- --------------------------------------------------
--EXEC V2_OFFLINE_JVDRCRUPLOAD 'OFFLINE',1,'BSE','CAPITAL','SEP  3 2010','N','8' 
--ROLLBACK

CREATE PROC [dbo].[V2_OFFLINE_JVDRCRUPLOAD](

  @UNAME     VARCHAR(25),
  @USERCAT   INT,
  @EXCHANGE  VARCHAR(3),
  @SEGMENT   VARCHAR(10),
  @IP_VDATE  VARCHAR(11),
  @RECOFLAG  CHAR(1) = 'N',
  @VTYP		 SMALLINT
)
AS

  SET NOCOUNT ON

  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/
  DECLARE  @@STD_DATE        VARCHAR(11),
           @@LST_DATE        VARCHAR(11),
           @@BRANCHFLAG       AS TINYINT,
           @@VNOFLAG          AS TINYINT,
           @@VNOMETHOD       INT,
           @@ACNAME          CHAR(100),
           @@BOOKTYPE        CHAR(2),
           @@MICRNO          VARCHAR(10),
           @@DRCR            VARCHAR(1),
           @@VTYP            SMALLINT,
           @@BANK_CODE       VARCHAR(100),
           @@BACKDAYS        INT,
           @@BACKDATE        VARCHAR(11),
           @@BRNCOUNT        TINYINT,
           @@MonthlyVdt      VARCHAR(11),
           @@SERIAL_NO       INT,
           @@COSTCODECOUNT   TINYINT,
           @@COSTCODEUPDATES CURSOR,
           @@NEWVNO           AS VARCHAR(12),
           @@MAXCOUNT         AS INT,
           @@VDT              AS VARCHAR(11),
           @@BANKBRANCH       AS VARCHAR(10),
           @@BANKCOST         AS NUMERIC,
           @@LNOCUR           AS CURSOR,
           @@VNOCUR           AS CURSOR,
           @@LNOVNO           AS VARCHAR(12),
		   @@FLD_AUTO		  AS INT,
           @@MAXVNO           AS INT,
           @@L2CUR            AS CURSOR,
           @@L2VNO            AS VARCHAR(12),
           @@ERROR_COUNT      AS BIGINT,
           @@FILEEXISTS       AS INT,
           @@SQL              AS VARCHAR(2000),
           @ERRORCODE         AS INT,
           @MESSAGE           AS VARCHAR(200), 
		   @@VOUCHERNO		  AS VARCHAR(12),
		   @@SQLPARA		  AS VARCHAR(5000),	  	
		   @@RECPAYTBLCOUNT BIGINT,
		   @@ACCOUNTDB VARCHAR(20),
		   @@SHAREDB VARCHAR(20),	  
		   @@ACCOUNTSVR VARCHAR(20)



 SET @@VTYP = @VTYP
 SET @@BOOKTYPE = '01' 

	SELECT  @@ACCOUNTSVR = ACCOUNTSERVER
	FROM PRADNYA.DBO.MULTICOMPANY (NOLOCK) WHERE PRIMARYSERVER = 1 AND EXCHANGE = @EXCHANGE 
	AND SEGMENT = @SEGMENT ORDER BY EXCHANGE 

  BEGIN TRAN
  CREATE TABLE [#RECPAY_TABLE] (
    SERIAL_NO    INT   IDENTITY ( 1,1 ),
    EDATE        VARCHAR(20),
    VOUCHER_DATE VARCHAR(20),
    CLIENT_CODE  VARCHAR(50),
    AMOUNT       MONEY,
    DRCR         VARCHAR(1),
    NARRATION    VARCHAR(234),
    BANK_CODE    VARCHAR(10),
    BANK_NAME    VARCHAR(100),
    REF_NO       VARCHAR(15),
    BRANCHCODE   VARCHAR(20),
    BRANCH_NAME  VARCHAR(50),
    CHQ_MODE     VARCHAR(1),
    CHQ_DATE     VARCHAR(20),
    CHQ_NAME     VARCHAR(100),
    CL_MODE      VARCHAR(1),
    FLD_AUTO     BIGINT,
    ENTEREDBY    VARCHAR(25),
    VDT          DATETIME   NULL,
    FYSTART      DATETIME   NULL,
    FYEND        DATETIME   NULL,
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),
    EDT          DATETIME   NULL,
    DDDT         DATETIME   NULL,
    VNO          VARCHAR(12)   NULL,
    VTYP         SMALLINT   NULL,
    ACNAME       VARCHAR(100)   NULL,
    COSTCODE     SMALLINT   NULL,
    BANKCOST     SMALLINT   NULL,                  LNO          SMALLINT   NOT NULL   DEFAULT (0),
    BANKNAME     VARCHAR(100)   NULL,
    MICRNO       INT   NULL,
    BOOKTYPE     VARCHAR(2)   NULL,
    ACC_NO       VARCHAR(16),
	VOUCHERNO    VARCHAR(12)   NULL)
  ON [PRIMARY]

  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */


SET @@SQLPARA = " INSERT INTO #RECPAY_TABLE "
SET @@SQLPARA = @@SQLPARA + "              (EDATE, "
SET @@SQLPARA = @@SQLPARA + "              VOUCHER_DATE, "
SET @@SQLPARA = @@SQLPARA + "              CLIENT_CODE, "
SET @@SQLPARA = @@SQLPARA + "              AMOUNT, "
SET @@SQLPARA = @@SQLPARA + "              DRCR, "
SET @@SQLPARA = @@SQLPARA + "              NARRATION, "
SET @@SQLPARA = @@SQLPARA + "              BANK_CODE, "
SET @@SQLPARA = @@SQLPARA + "              BANK_NAME, "
SET @@SQLPARA = @@SQLPARA + "              REF_NO, "
SET @@SQLPARA = @@SQLPARA + "              BRANCHCODE, "
SET @@SQLPARA = @@SQLPARA + "              BRANCH_NAME, "
SET @@SQLPARA = @@SQLPARA + "              CHQ_MODE, "
SET @@SQLPARA = @@SQLPARA + "              CHQ_DATE, "
SET @@SQLPARA = @@SQLPARA + "              CHQ_NAME, "
SET @@SQLPARA = @@SQLPARA + "              CL_MODE, "
SET @@SQLPARA = @@SQLPARA + "              FLD_AUTO, "
SET @@SQLPARA = @@SQLPARA + "              ENTEREDBY, "
SET @@SQLPARA = @@SQLPARA + "              VDT, "
SET @@SQLPARA = @@SQLPARA + "              EDT, "
SET @@SQLPARA = @@SQLPARA + "              DDDT, "
SET @@SQLPARA = @@SQLPARA + "              ACC_NO,VTYP,VOUCHERNO) "
SET @@SQLPARA = @@SQLPARA + "  SELECT CONVERT(VARCHAR,EDATE,103), "
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,VDATE,103), "
SET @@SQLPARA = @@SQLPARA + "         O.CLTCODE, "
SET @@SQLPARA = @@SQLPARA + "         AMOUNT = CONVERT(VARCHAR,CASE WHEN CC.CREDITAMT IS NULL THEN CASE WHEN O.CREDITAMT = '' THEN O.DEBITAMT ELSE O.CREDITAMT END ELSE CASE WHEN CC.CREDITAMT = '' THEN CC.DEBITAMT ELSE CC.CREDITAMT END END) , "
SET @@SQLPARA = @@SQLPARA + "         DRCR = CONVERT(VARCHAR,CASE WHEN CC.CREDITAMT IS NULL THEN CASE WHEN O.CREDITAMT = '' THEN 'D' ELSE 'C' END ELSE CASE WHEN CC.CREDITAMT = '' THEN 'D' ELSE 'C' END END), "
SET @@SQLPARA = @@SQLPARA + "         NARRATION, "
SET @@SQLPARA = @@SQLPARA + "         OPPCODE, "
SET @@SQLPARA = @@SQLPARA + "         OPPCODENAME, "
SET @@SQLPARA = @@SQLPARA + "         DDNO, "
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,CASE WHEN CC.COSTCODE IS NOT NULL THEN CC.COSTCODE ELSE 'ALL' END), "
SET @@SQLPARA = @@SQLPARA + "         'ALL', "
SET @@SQLPARA = @@SQLPARA + "        CHEQUEMODE, "
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,CHEQUEDATE,103), "
SET @@SQLPARA = @@SQLPARA + "         CHEQUENAME, "
SET @@SQLPARA = @@SQLPARA + "         CLEAR_MODE, "
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,O.FLDAUTO), " 
SET @@SQLPARA = @@SQLPARA + "         O.ADDBY, "
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,VDATE), "
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,EDATE), "
SET @@SQLPARA = @@SQLPARA + "         CHEQUEDATE, "
SET @@SQLPARA = @@SQLPARA + "        TPACCOUNTNUMBER, CONVERT(VARCHAR,VOUCHERTYPE),VOUCHERNO "
IF @@ACCOUNTSVR <> @@SERVERNAME
 BEGIN 
SET @@SQLPARA = @@SQLPARA + "  FROM   " + @@ACCOUNTSVR + ".ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES O WITH(NOLOCK) "
SET @@SQLPARA = @@SQLPARA + "			LEFT OUTER JOIN "+ @@ACCOUNTSVR +".ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_CC_ENTRIES CC "
SET @@SQLPARA = @@SQLPARA + "			ON "
SET @@SQLPARA = @@SQLPARA + "				O.FLDAUTO = CC.VOLE_REFNO "
END
ELSE
 BEGIN
SET @@SQLPARA = @@SQLPARA + "	FROM   ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES O WITH(NOLOCK) "
SET @@SQLPARA = @@SQLPARA + "			LEFT OUTER JOIN ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_CC_ENTRIES CC "
SET @@SQLPARA = @@SQLPARA + "			ON "
SET @@SQLPARA = @@SQLPARA + "				 O.FLDAUTO = CC.VOLE_REFNO "
END
SET @@SQLPARA = @@SQLPARA + "  WHERE  CONVERT(VARCHAR,VOUCHERTYPE) = '"+CONVERT(VARCHAR,@@VTYP)+"' " 
SET @@SQLPARA = @@SQLPARA + "         AND EXCHANGE = '"+@EXCHANGE+"' "
SET @@SQLPARA = @@SQLPARA + "         AND SEGMENT = '"+@SEGMENT+"' "
SET @@SQLPARA = @@SQLPARA + "         AND CONVERT(VARCHAR,ISNULL(ROWSTATE,0)) = '0' "
SET @@SQLPARA = @@SQLPARA + "   AND CONVERT(VARCHAR,VDATE) LIKE '"+@IP_VDATE+"' + '%' "
SET @@SQLPARA = @@SQLPARA + "   AND CONVERT(VARCHAR,APPROVALFLAG) = '1' "

EXEC(@@SQLPARA)
 
SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE

 IF @@RECPAYTBLCOUNT = 0
 BEGIN
  COMMIT
  RETURN
 END

IF @@ACCOUNTSVR <> @@SERVERNAME
 BEGIN
 SET @@SQLPARA = "   UPDATE " + @@ACCOUNTSVR + ".ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH (ROWLOCK) "
 END
ELSE
 BEGIN
 SET @@SQLPARA = "   UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH (ROWLOCK) "
END 
SET @@SQLPARA = @@SQLPARA + "   SET    ROWSTATE = 9 "
SET @@SQLPARA = @@SQLPARA + "   FROM   #RECPAY_TABLE "
SET @@SQLPARA = @@SQLPARA + "   WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO "
EXEC(@@SQLPARA) 



  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)
  FROM   #RECPAY_TABLE

  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),
         @@BRANCHFLAG = BRANCHFLAG,
         @@VNOFLAG = VNOFLAG
  FROM   PARAMETER WITH(NOLOCK)
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR

  IF @@VNOFLAG <> 0
    BEGIN
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)
      FROM   #RECPAY_TABLE

      IF @@ERROR_COUNT > 1
        BEGIN
     DROP TABLE #RECPAY_TABLE
     ROLLBACK TRANSACTION
     SET @ERRORCODE = 1
     SET @MESSAGE = 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'
     EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME
     RETURN
        END
    END

  IF @@BRANCHFLAG = 1
    BEGIN
	  UPDATE #RECPAY_TABLE
      SET    BRANCHCODE = A.BRANCHCODE,
             FYSTART = P.SDTCUR,
             FYEND = P.LDTCUR,
             UPDFLAG = 'Y',
             ACNAME = A.LONGNAME,
             COSTCODE = C.COSTCODE,
             BANKNAME = '',
             BOOKTYPE = '01',
             MICRNO = '0'
      FROM   ACMAST A WITH(NOLOCK),
             PARAMETER P WITH(NOLOCK),
             COSTMAST C WITH(NOLOCK)
      WHERE  A.CLTCODE = CLIENT_CODE
             AND P.CURYEAR = 1
             AND A.ACCAT IN ('3','4','18')
             AND A.BRANCHCODE = COSTNAME

	  UPDATE #RECPAY_TABLE
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),
             FYSTART = P.SDTCUR,
             FYEND = P.LDTCUR,
             UPDFLAG = 'Y',
             ACNAME = A.LONGNAME,
             COSTCODE = (SELECT TOP 1 COSTCODE
                         FROM   COSTMAST
                         WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),
             BANKNAME = '',
             BOOKTYPE = '01',
             MICRNO = '0'
      FROM   ACMAST A WITH(NOLOCK),
             PARAMETER P WITH(NOLOCK)
      WHERE  A.CLTCODE = CLIENT_CODE
             AND P.CURYEAR = 1
             AND A.ACCAT IN ('3','4','18')
             AND A.BRANCHCODE = 'ALL'
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'

      UPDATE #RECPAY_TABLE
      SET    BRANCHCODE = 'HO',
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),
             FYSTART = P.SDTCUR,
             FYEND = P.LDTCUR,
             UPDFLAG = 'Y',
             ACNAME = A.LONGNAME,
             COSTCODE = (SELECT TOP 1 COSTCODE
                         FROM   COSTMAST
             WHERE  COSTNAME = 'HO'),
             BANKNAME = '',
             BOOKTYPE = '01',
             MICRNO = ''
      FROM   ACMAST A WITH(NOLOCK),
             PARAMETER P WITH(NOLOCK)
      WHERE  A.CLTCODE = CLIENT_CODE
             AND P.CURYEAR = 1
             AND A.ACCAT IN ('3','4','18')
             AND A.BRANCHCODE = 'ALL'
             AND #RECPAY_TABLE.BRANCHCODE = 'ALL'
    END
 ELSE
    BEGIN
      UPDATE #RECPAY_TABLE
      SET    FYSTART = @@STD_DATE,
             FYEND = @@LST_DATE + ' 23:59:59',
             UPDFLAG = 'Y',
             ACNAME = A.LONGNAME,
             BANKNAME = '',
             BOOKTYPE = '01',
             MICRNO = ''
      FROM   ACMAST A WITH(NOLOCK)
      WHERE  A.CLTCODE = CLIENT_CODE
             AND A.ACCAT IN ('3','4','18')

    END

  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */
  SELECT @@ERROR_COUNT = COUNT(SERIAL_NO)
  FROM   #RECPAY_TABLE
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND

  IF @@ERROR_COUNT > 0
    BEGIN
    DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END

  SET @@ERROR_COUNT = 0

  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/
  SELECT @@ERROR_COUNT = COUNT(1)
  FROM   #RECPAY_TABLE
  WHERE  VDT > EDT

  IF @@ERROR_COUNT > 0
    BEGIN
    DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END

/*-----------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ----*/	
  	SELECT @@ERROR_COUNT = COUNT(1) FROM
	(SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)
	FROM #RECPAY_TABLE
	HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A

	IF @@ERROR_COUNT > 0
	  BEGIN
	  DROP TABLE #RECPAY_TABLE
	  ROLLBACK TRAN
	  SET @ERRORCODE = 1
	  SET @MESSAGE ='DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'
      EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME
      RETURN
      END

  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/
  SELECT @@ERROR_COUNT = COUNT(1)
  FROM   (SELECT DISTINCT CLIENT_CODE
          FROM   #RECPAY_TABLE
          WHERE  UPDFLAG = 'N') A

  IF @@ERROR_COUNT > 0
    BEGIN
    DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END

  /*    ----------AUTO GENERATION OF VNO -------- */
	CREATE TABLE  
    #BANK_VNO  
    (  
     VOUCHERNO VARCHAR(12),  
     NEWSRNO INT IDENTITY (1, 1)  
    )  
  
   INSERT INTO  
    #BANK_VNO  
   SELECT  
    DISTINCT VOUCHERNO  
   FROM  
    #RECPAY_TABLE  
     
   SELECT TOP 1  
    @@VDT = VDT  
   FROM  
    #RECPAY_TABLE  
  
   SELECT  
    @@STD_DATE = LEFT(SDTCUR, 11),  
    @@LST_DATE = LEFT(LDTCUR, 11),  
    @@VNOMETHOD = VNOFLAG  
   FROM  
    PARAMETER  
   WHERE  
    @@VDT BETWEEN SDTCUR AND LDTCUR  
  
   SELECT  
    @@MAXCOUNT = COUNT(DISTINCT VOUCHERNO)  
   FROM  
    #RECPAY_TABLE  
  
   SELECT  
    LASTVNO  
   INTO #VNO  
   FROM  
    LASTVNO  
   WHERE  
    1 = 2  
  
   SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO  
  
   INSERT INTO  
    #VNO  
   EXEC   
    ACC_GENVNO_NEW  
     @@VDT,  
     @@VTYP,  
     @@BOOKTYPE,  
     @@STD_DATE,  
     @@LST_DATE,  
     @@MAXVNO  
  
   SELECT  
    @@NEWVNO = LASTVNO  
   FROM  
    #VNO  
        
   UPDATE  
    RP  
   SET   
    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))  
   FROM  
    #RECPAY_TABLE RP,  
    #BANK_VNO BV  
   WHERE  
      RP.VOUCHERNO = BV.VOUCHERNO
  
   DROP TABLE #VNO  
   DROP TABLE #BANK_VNO     
 
/* '-----------AUTO GENERATION OF LNO --------------*/
--bhrt
 	CREATE TABLE [#RECPAY_TABLE_LNO]
	(
		SNO VARCHAR(12) ,
		FLD_AUTO INT,
		LNO INT IDENTITY (1, 1) NOT NULL
	) ON [PRIMARY]

	SET @@LNOCUR = CURSOR FOR
		SELECT DISTINCT VOUCHERNO, FLD_AUTO FROM #RECPAY_TABLE
	OPEN @@LNOCUR
		FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO, @@FLD_AUTO
	WHILE @@FETCH_STATUS = 0
		BEGIN

			INSERT INTO #RECPAY_TABLE_LNO
				(SNO, FLD_AUTO)
			SELECT DISTINCT VOUCHERNO, FLD_AUTO FROM #RECPAY_TABLE WHERE VOUCHERNO = @@LNOVNO
			UPDATE RP
				SET LNO = RL.LNO
			FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL
			WHERE RP.VOUCHERNO = RL.SNO AND RP.FLD_AUTO = RL.FLD_AUTO
			TRUNCATE TABLE #RECPAY_TABLE_LNO
			FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO, @@FLD_AUTO
		END
	CLOSE @@LNOCUR
	DEALLOCATE @@LNOCUR
	DROP TABLE #RECPAY_TABLE_LNO


/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/
  CREATE TABLE #LEDGER (
    VTYP      SMALLINT,
    VNO       VARCHAR(12),
    EDT       DATETIME,
    LNO       SMALLINT,
    ACNAME    VARCHAR(100),
    DRCR      VARCHAR(1),
    VAMT      MONEY,
    VDT       DATETIME,
    VNO1      VARCHAR(12),
    REFNO     CHAR(12),
    BALAMT    MONEY,
    NODAYS    INT,
    CDT       DATETIME,
    CLTCODE   VARCHAR(10),
    BOOKTYPE  VARCHAR(2),
    ENTEREDBY VARCHAR(25),
    PDT       DATETIME,
    CHECKEDBY VARCHAR(25),
    ACTNODAYS INT,
    NARRATION VARCHAR(234))

/*======CLIENT SIDE RECORD======*/
  INSERT INTO #LEDGER
             (VTYP,
              VNO,
              EDT,
              LNO,
              ACNAME,
              DRCR,
              VAMT,
              VDT,
              VNO1,
              REFNO,
              BALAMT,
              NODAYS,
              CDT,
              CLTCODE,
              BOOKTYPE,
              ENTEREDBY,
              PDT,
              CHECKEDBY,
              ACTNODAYS,
              NARRATION)
  SELECT VTYP,
         VNO,
         EDT = (CASE
                  WHEN VTYP = @@VTYP
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/
                  ELSE EDT
                END),
         LNO,
         ACNAME,
         DRCR,
         VAMT = SUM(AMOUNT),
         VDT,
         VNO1 = VNO,
         REFNO = 0,
         BALAMT = SUM(AMOUNT),
         NODAYS = 0,
         CDT = GETDATE(),
         CLTCODE = CLIENT_CODE,
         BOOKTYPE = BOOKTYPE,
         ENTEREDBY = ENTEREDBY,
         PDT = GETDATE(),
         CHECKEDBY = @UNAME,
         ACTNODAYS = 0,
         NARRATION
  FROM   #RECPAY_TABLE
  GROUP BY
		 VTYP,
	     VNO,
         (CASE
                  WHEN VTYP = @@VTYP
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/
                  ELSE EDT
                END),
         LNO,
         ACNAME,
         DRCR,
         VDT,
         CLIENT_CODE,
         BOOKTYPE,
         ENTEREDBY,
         NARRATION



/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/
  INSERT INTO LEDGER
 (VTYP,
              VNO,
              EDT,
              LNO,
              ACNAME,
              DRCR,
              VAMT,
              VDT,
              VNO1,
              REFNO,
              BALAMT,
              NODAYS,
              CDT,
              CLTCODE,
              BOOKTYPE,
              ENTEREDBY,
              PDT,
              CHECKEDBY,
              ACTNODAYS,
              NARRATION)
  SELECT   VTYP,
           VNO,
		   EDT,
           LNO,
           ACNAME,
           DRCR,
           VAMT,
           VDT,
           VNO1,
           REFNO,
           BALAMT,
           NODAYS,
           CDT,
           CLTCODE,
           BOOKTYPE,
           ENTEREDBY,
           PDT,
           CHECKEDBY,
           ACTNODAYS,
           NARRATION
  FROM     #LEDGER
  ORDER BY BOOKTYPE,
           VTYP,
           VNO,
           LNO

  IF @@ERROR <> 0
    BEGIN
    DROP TABLE #LEDGER
    DROP TABLE #RECPAY_TABLE
    ROLLBACK TRAN
    SET @ERRORCODE = 1
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME
    RETURN
    END

  DROP TABLE #LEDGER


IF @@BRANCHFLAG = 1  
    BEGIN  

      SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO  
                               FROM     #RECPAY_TABLE  
                               ORDER BY VNO  
      OPEN @@L2CUR  
  
      FETCH NEXT FROM @@L2CUR  
      INTO @@L2VNO  
  
      WHILE @@FETCH_STATUS = 0  
        BEGIN  
          DELETE FROM TEMPLEDGER2  
          WHERE       SESSIONID = '9999999999'  

		/*======CLIENT SIDE RECORD======*/  
          INSERT INTO TEMPLEDGER2  
          SELECT 'BRANCH',  
                 C.COSTNAME,  
                 AMOUNT,  
                 VTYP,  
                 VNO,  
                 LNO,  
                 DRCR,  
                 '0',  
                 BOOKTYPE,  
                 '9999999999',  
                 CLIENT_CODE,  
                 'A',  
                 '0'  
		  FROM   #RECPAY_TABLE RP,  
                 COSTMAST C WITH(NOLOCK)  
          WHERE  RP.COSTCODE = C.COSTCODE  
                 AND VNO = @@L2VNO  
  
          EXEC INSERTTOLEDGER2  
            '9999999999' ,  
            @@L2VNO ,  
            '1' ,  
            '1' ,  
            '1' ,  
            'BROKER' ,  
            'BROKER'  
  
		FETCH NEXT FROM @@L2CUR  
          INTO @@L2VNO  
        END  

      DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)  
      WHERE       SESSIONID = '9999999999'  
 END  

IF @@ACCOUNTSVR <> @@SERVERNAME
 BEGIN 
	SET @@SQLPARA = " UPDATE "+ @@ACCOUNTSVR +".ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(ROWLOCK) " 
 END
ELSE
 BEGIN
	SET @@SQLPARA = " UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(ROWLOCK) " 
END  
SET @@SQLPARA = @@SQLPARA + " SET "
SET @@SQLPARA = @@SQLPARA + "  ROWSTATE = 1, "
SET @@SQLPARA = @@SQLPARA + "  APPROVALFLAG = 1, "
SET @@SQLPARA = @@SQLPARA + "  APPROVALDATE = GETDATE(), "
SET @@SQLPARA = @@SQLPARA + "  LEDGERVNO = VNO "
SET @@SQLPARA = @@SQLPARA + " FROM   #RECPAY_TABLE "
SET @@SQLPARA = @@SQLPARA + " WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO "
EXEC(@@SQLPARA)
COMMIT TRAN 

DROP TABLE #RECPAY_TABLE
SET @ERRORCODE = 0
SET @MESSAGE = 'POSTED SUCCESSFULLY'
EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME

--SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_JVDRCRUPLOAD_RND
-- --------------------------------------------------
create PROC [dbo].[V2_OFFLINE_JVDRCRUPLOAD_RND](                      
                      
  @UNAME     VARCHAR(25),                      
  @USERCAT   INT,                      
  @EXCHANGE  VARCHAR(3),                      
  @SEGMENT   VARCHAR(10),                      
  @IP_VDATE  VARCHAR(11),                      
  @RECOFLAG  CHAR(1) = 'N',                      
  @VTYP   SMALLINT                      
)                      
AS                      
set XACT_ABORT          on                
  SET NOCOUNT ON                     
/*                  
begin tran                  
exec V2_OFFLINE_JVDRCRUPLOAD_RND 'OFFLINE',1,'NSE','CAPITAL','oct 20 2010','N',8                  
rollback                  
SELECT TOP 1* FROM LEDGER2              
*/                   
                      
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/                      
  DECLARE  @@STD_DATE        VARCHAR(11),                      
           @@LST_DATE        VARCHAR(11),                      
           @@BRANCHFLAG       AS TINYINT,                      
           @@VNOFLAG          AS TINYINT,                      
           @@VNOMETHOD       INT,                      
           @@ACNAME          CHAR(100),                      
           @@BOOKTYPE        CHAR(2),                      
           @@MICRNO          VARCHAR(10),                      
           @@DRCR            VARCHAR(1),                      
           @@VTYP            SMALLINT,                      
           @@BANK_CODE       VARCHAR(100),                      
           @@BACKDAYS        INT,                      
           @@BACKDATE        VARCHAR(11),                      
           @@BRNCOUNT        TINYINT,                      
           @@MonthlyVdt      VARCHAR(11),                      
           @@SERIAL_NO       INT,                      
           @@COSTCODECOUNT   TINYINT,                      
           @@COSTCODEUPDATES CURSOR,                      
           @@NEWVNO           AS VARCHAR(12),                      
           @@MAXCOUNT         AS INT,                      
           @@VDT              AS VARCHAR(11),                      
           @@BANKBRANCH       AS VARCHAR(10),                      
           @@BANKCOST         AS NUMERIC,                      
           @@LNOCUR           AS CURSOR,                      
           @@VNOCUR           AS CURSOR,                      
           @@LNOVNO           AS VARCHAR(12),                      
     @@FLD_AUTO    AS INT,                      
           @@MAXVNO           AS INT,                      
           @@L2CUR            AS CURSOR,                      
           @@L2VNO            AS VARCHAR(12),                      
           @@ERROR_COUNT      AS BIGINT,                      
           @@FILEEXISTS       AS INT,                      
           @@SQL              AS VARCHAR(2000),                      
           @ERRORCODE         AS INT,                      
           @MESSAGE           AS VARCHAR(200),                       
     @@VOUCHERNO    AS VARCHAR(12),                      
     @@SQLPARA    AS VARCHAR(5000),                          
     @@RECPAYTBLCOUNT BIGINT,                      
     @@ACCOUNTDB VARCHAR(20),                      
     @@SHAREDB VARCHAR(20),                         
     @@ACCOUNTSVR VARCHAR(20)                      
                      
                      
                      
 SET @@VTYP = @VTYP                      
 SET @@BOOKTYPE = '01'                       
            
                      
 SELECT  @@ACCOUNTSVR = ACCOUNTSERVER                      
 FROM ANAND1.PRADNYA.DBO.MULTICOMPANY  WHERE PRIMARYSERVER = 1 AND EXCHANGE = @EXCHANGE                       
 AND SEGMENT = @SEGMENT ORDER BY EXCHANGE                       
                      
  BEGIN TRAN                      
  CREATE TABLE [#RECPAY_TABLE] (                      
    SERIAL_NO    INT   IDENTITY ( 1,1 ),                      
    SNO INT,                    
    EDATE  VARCHAR(20),                      
    VOUCHER_DATE VARCHAR(20),                      
    CLIENT_CODE  VARCHAR(50),                      
    AMOUNT       MONEY,                      
    DRCR         VARCHAR(1),                      
    NARRATION    VARCHAR(234),                      
    BANK_CODE    VARCHAR(10),                      
   BANK_NAME    VARCHAR(100),                      
    REF_NO       VARCHAR(15),                      
    BRANCHCODE   VARCHAR(20),                      
    BRANCH_NAME  VARCHAR(50),                    
    CHQ_MODE     VARCHAR(1),                      
    CHQ_DATE     VARCHAR(20),                      
    CHQ_NAME     VARCHAR(100),                      
    CL_MODE      VARCHAR(1),                 
    FLD_AUTO     BIGINT,                      
    ENTEREDBY    VARCHAR(25),                      
    VDT          DATETIME   NULL,                      
    FYSTART      DATETIME   NULL,                      
    FYEND        DATETIME   NULL,                      
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),                      
    EDT          DATETIME   NULL,                      
    DDDT         DATETIME   NULL,                      
    VNO          VARCHAR(12)   NULL,                      
    VTYP         SMALLINT   NULL,                      
    ACNAME       VARCHAR(100)   NULL,                      
    COSTCODE     SMALLINT   NULL,                      
    BANKCOST     SMALLINT   NULL,                  LNO          SMALLINT   NOT NULL   DEFAULT (0),                      
    BANKNAME     VARCHAR(100)   NULL,                      
    MICRNO       INT   NULL,                      
    BOOKTYPE     VARCHAR(2)   NULL,                      
    ACC_NO       VARCHAR(16),                      
 VOUCHERNO    VARCHAR(12)   NULL,              
 SRNO TINYINT )                    
  ON [PRIMARY]                      
                      
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */                      
                      
                      
/*SET @@SQLPARA = " INSERT INTO #RECPAY_TABLE "                      
SET @@SQLPARA = @@SQLPARA + "              (SNO,EDATE, "                      
SET @@SQLPARA = @@SQLPARA + "              VOUCHER_DATE, "                      
SET @@SQLPARA = @@SQLPARA + "              CLIENT_CODE, "                      
SET @@SQLPARA = @@SQLPARA + "              AMOUNT, "                      
SET @@SQLPARA = @@SQLPARA + "          DRCR, "                      
SET @@SQLPARA = @@SQLPARA + "              NARRATION, "                      
SET @@SQLPARA = @@SQLPARA + "              BANK_CODE, "                      
SET @@SQLPARA = @@SQLPARA + "              BANK_NAME, "                      
SET @@SQLPARA = @@SQLPARA + "              REF_NO, "                      
SET @@SQLPARA = @@SQLPARA + "              BRANCHCODE, "                      
SET @@SQLPARA = @@SQLPARA + "              BRANCH_NAME, "                      
SET @@SQLPARA = @@SQLPARA + "              CHQ_MODE, "                      
SET @@SQLPARA = @@SQLPARA + "              CHQ_DATE, "                      
SET @@SQLPARA = @@SQLPARA + "              CHQ_NAME, "                      
SET @@SQLPARA = @@SQLPARA + "              CL_MODE, "                      
SET @@SQLPARA = @@SQLPARA + "              FLD_AUTO, "                      
SET @@SQLPARA = @@SQLPARA + "              ENTEREDBY, "                      
SET @@SQLPARA = @@SQLPARA + "              VDT, "                      
SET @@SQLPARA = @@SQLPARA + "              EDT, "                      
SET @@SQLPARA = @@SQLPARA + "              DDDT, "                      
SET @@SQLPARA = @@SQLPARA + "              ACC_NO,VTYP,VOUCHERNO) "                      
SET @@SQLPARA = @@SQLPARA + "  SELECT o.SNO,CONVERT(VARCHAR,EDATE,103), "                      
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,VDATE,103), "                      
SET @@SQLPARA = @@SQLPARA + "         O.CLTCODE, "                      
SET @@SQLPARA = @@SQLPARA + "         AMOUNT = CONVERT(VARCHAR,CASE WHEN CC.CREDITAMT IS NULL THEN CASE WHEN O.CREDITAMT = '' THEN O.DEBITAMT ELSE O.CREDITAMT END ELSE CASE WHEN CC.CREDITAMT = '' THEN CC.DEBITAMT ELSE CC.CREDITAMT END END) , "           
   
    
     
        
           
SET @@SQLPARA = @@SQLPARA + "         DRCR = CONVERT(VARCHAR,CASE WHEN CC.CREDITAMT IS NULL THEN CASE WHEN O.CREDITAMT = '' THEN 'D' ELSE 'C' END ELSE CASE WHEN CC.CREDITAMT = '' THEN 'D' ELSE 'C' END END), "                      
SET @@SQLPARA = @@SQLPARA + "         NARRATION, "                      
SET @@SQLPARA = @@SQLPARA + "         OPPCODE, "                      
SET @@SQLPARA = @@SQLPARA + "         OPPCODENAME, "                      
SET @@SQLPARA = @@SQLPARA + "         DDNO, "                      
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,CASE WHEN CC.COSTCODE IS NOT NULL THEN CC.COSTCODE ELSE 'ALL' END), "                      
SET @@SQLPARA = @@SQLPARA + "         'ALL', "                      
SET @@SQLPARA = @@SQLPARA + "        CHEQUEMODE, "                      
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,CHEQUEDATE,103), "                      
SET @@SQLPARA = @@SQLPARA + "         CHEQUENAME, "              SET @@SQLPARA = @@SQLPARA + "         CLEAR_MODE, "                      
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,O.FLDAUTO), "                       
SET @@SQLPARA = @@SQLPARA + "         O.ADDBY, "                      
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,VDATE), "                      
SET @@SQLPARA = @@SQLPARA + "         CONVERT(VARCHAR,EDATE), "                      
SET @@SQLPARA = @@SQLPARA + "         CHEQUEDATE, "                      
SET @@SQLPARA = @@SQLPARA + "        TPACCOUNTNUMBER, CONVERT(VARCHAR,VOUCHERTYPE),VOUCHERNO "                      
IF @@ACCOUNTSVR <> @@SERVERNAME                      
 BEGIN                       
SET @@SQLPARA = @@SQLPARA + "  FROM   " + @@ACCOUNTSVR + ".ACCOUNT.DBO.V2_OFFLINE_LEDGER_ENTRIES O WITH(NOLOCK) "                      
SET @@SQLPARA = @@SQLPARA + "   LEFT OUTER JOIN "+ @@ACCOUNTSVR +".ACCOUNT.DBO.V2_OFFLINE_CC_ENTRIES CC "                      
SET @@SQLPARA = @@SQLPARA + "   ON "                      
SET @@SQLPARA = @@SQLPARA + "    O.FLDAUTO = CC.VOLE_REFNO "                      
END                      
ELSE                      
 BEGIN                      
SET @@SQLPARA = @@SQLPARA + " FROM   ACCOUNT.DBO.V2_OFFLINE_LEDGER_ENTRIES O WITH(NOLOCK) "                      
SET @@SQLPARA = @@SQLPARA + "   LEFT OUTER JOIN ACCOUNT.DBO.V2_OFFLINE_CC_ENTRIES CC "                      
SET @@SQLPARA = @@SQLPARA + "   ON "                      
SET @@SQLPARA = @@SQLPARA + "     O.FLDAUTO = CC.VOLE_REFNO "                      
END                      
SET @@SQLPARA = @@SQLPARA + "  WHERE  CONVERT(VARCHAR,VOUCHERTYPE) = '"+CONVERT(VARCHAR,@@VTYP)+"' "                       
SET @@SQLPARA = @@SQLPARA + "         AND EXCHANGE = '"+@EXCHANGE+"' "                      
SET @@SQLPARA = @@SQLPARA + "         AND SEGMENT = '"+@SEGMENT+"' "                      
SET @@SQLPARA = @@SQLPARA + "         AND CONVERT(VARCHAR,ISNULL(ROWSTATE,0)) = '0' "                      
SET @@SQLPARA = @@SQLPARA + "   AND CONVERT(VARCHAR,VDATE) LIKE '"+@IP_VDATE+"' + '%' "                      
SET @@SQLPARA = @@SQLPARA + "   AND CONVERT(VARCHAR,APPROVALFLAG) = '1' "                      
                      
EXEC(@@SQLPARA)   */              
              
 SET @@SQLPARA = " INSERT INTO #RECPAY_TABLE "                      
 SET @@SQLPARA = @@SQLPARA + "              (SNO,EDATE, "                      
 SET @@SQLPARA = @@SQLPARA + "              VOUCHER_DATE, "                      
 SET @@SQLPARA = @@SQLPARA + "              CLIENT_CODE, "                      
 SET @@SQLPARA = @@SQLPARA + "              AMOUNT, "                      
 SET @@SQLPARA = @@SQLPARA + "      DRCR, "                      
 SET @@SQLPARA = @@SQLPARA + "              NARRATION, "                      
 SET @@SQLPARA = @@SQLPARA + "              BANK_CODE, "                      
 SET @@SQLPARA = @@SQLPARA + "              BANK_NAME, "                      
 SET @@SQLPARA = @@SQLPARA + "              REF_NO, "                      
 SET @@SQLPARA = @@SQLPARA + "              BRANCHCODE, "                      
 SET @@SQLPARA = @@SQLPARA + "              BRANCH_NAME, "                      
 SET @@SQLPARA = @@SQLPARA + "              CHQ_MODE, "                      
 SET @@SQLPARA = @@SQLPARA + "              CHQ_DATE, "                      
 SET @@SQLPARA = @@SQLPARA + "              CHQ_NAME, "                      
 SET @@SQLPARA = @@SQLPARA + "              CL_MODE, "                      
 SET @@SQLPARA = @@SQLPARA + "              FLD_AUTO, "                      
 SET @@SQLPARA = @@SQLPARA + "              ENTEREDBY, "                      
 SET @@SQLPARA = @@SQLPARA + "              VDT, "                      
 SET @@SQLPARA = @@SQLPARA + "              EDT, "                      
 SET @@SQLPARA = @@SQLPARA + "              DDDT, "                      
 SET @@SQLPARA = @@SQLPARA + "              ACC_NO,VTYP,VOUCHERNO,SRNO) "               
 IF @@ACCOUNTSVR <> 'ABCSOMKTUATSVR1'                      
  BEGIN                       
  SET @@SQLPARA = @@SQLPARA + "  EXEC ACCOUNT_AB.DBO.V2_OFFLINE_FILL_REC "+CONVERT(VARCHAR,@@VTYP)+",'"+@EXCHANGE+"', '"+@SEGMENT+"', '"+@IP_VDATE+"' "                  
  END                      
 ELSE                      
  BEGIN                      
  SET @@SQLPARA = @@SQLPARA + " EXEC V2_OFFLINE_FILL_REC "+CONVERT(VARCHAR,@@VTYP)+",'"+@EXCHANGE+"', '"+@SEGMENT+"', '"+@IP_VDATE+"' "              
  END              
 PRINT @@SQLPARA              
 EXEC(@@SQLPARA)               
             
 SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE                      
                      
 IF @@RECPAYTBLCOUNT = 0                      
 BEGIN                      
  COMMIT                      
  RETURN                      
 END                      
                
                      
                      
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)                      
  FROM   #RECPAY_TABLE                      
                      
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),                      
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),                      
         @@BRANCHFLAG = BRANCHFLAG,                      
         @@VNOFLAG = VNOFLAG                      
  FROM   PARAMETER WITH(NOLOCK)                      
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR                      
                      
  IF @@VNOFLAG <> 0                      
    BEGIN                      
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)                      
      FROM   #RECPAY_TABLE                      
                      
      IF @@ERROR_COUNT > 1                      
        BEGIN                      
     DROP TABLE #RECPAY_TABLE                      
     ROLLBACK TRANSACTION                      
     SET @ERRORCODE = 1                      
     SET @MESSAGE = 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                      
     EXEC ACCOUNTMCDXCDS.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                      
     RETURN                      
        END                      
    END                      
                      
  IF @@BRANCHFLAG = 1                      
    BEGIN                      
   UPDATE #RECPAY_TABLE                      
      SET    BRANCHCODE = A.BRANCHCODE,                      
             FYSTART = P.SDTCUR,                      
             FYEND = P.LDTCUR,                      
             UPDFLAG = 'Y',                      
             ACNAME = A.LONGNAME,                      
             COSTCODE = C.COSTCODE,                      
             BANKNAME = '',                      
             BOOKTYPE = '01',                      
             MICRNO = '0'                      
      FROM   ACMAST A WITH(NOLOCK),                      
             PARAMETER P WITH(NOLOCK),                      
             COSTMAST C WITH(NOLOCK)                      
      WHERE  A.CLTCODE = CLIENT_CODE                      
             AND P.CURYEAR = 1                      
             AND A.ACCAT IN ('3','4','18')                      
             AND A.BRANCHCODE = COSTNAME                      
                      
   UPDATE #RECPAY_TABLE                      
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                      
             FYSTART = P.SDTCUR,                      
             FYEND = P.LDTCUR,                      
             UPDFLAG = 'Y',                      
             ACNAME = A.LONGNAME,                      
             COSTCODE = (SELECT TOP 1 COSTCODE                      
                         FROM   COSTMAST                      
                         WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),                      
       BANKNAME = '',                      
             BOOKTYPE = '01',                      
             MICRNO = '0'                      
      FROM   ACMAST A WITH(NOLOCK),                      
             PARAMETER P WITH(NOLOCK)                      
      WHERE  A.CLTCODE = CLIENT_CODE                      
             AND P.CURYEAR = 1                      
             AND A.ACCAT IN ('3','4','18')                      
             AND A.BRANCHCODE = 'ALL'                      
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                      
                      
      UPDATE #RECPAY_TABLE                      
      SET    BRANCHCODE = 'HO',                      
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                      
             FYSTART = P.SDTCUR,                      
 FYEND = P.LDTCUR,                      
             UPDFLAG = 'Y',                      
             ACNAME = A.LONGNAME,                      
             COSTCODE = (SELECT TOP 1 COSTCODE                      
                         FROM   COSTMAST                      
             WHERE  COSTNAME = 'HO'),                      
             BANKNAME = '',                      
             BOOKTYPE = '01',                      
             MICRNO = ''                      
      FROM   ACMAST A WITH(NOLOCK),                      
             PARAMETER P WITH(NOLOCK)                      
      WHERE  A.CLTCODE = CLIENT_CODE                      
             AND P.CURYEAR = 1                      
             AND A.ACCAT IN ('3','4','18')                      
             AND A.BRANCHCODE = 'ALL'                      
             AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                      
    END                      
 ELSE                      
    BEGIN                      
      UPDATE #RECPAY_TABLE                      
      SET    FYSTART = @@STD_DATE,                      
             FYEND = @@LST_DATE + ' 23:59:59',                      
             UPDFLAG = 'Y',                      
             ACNAME = A.LONGNAME,                      
             BANKNAME = '',                      
             BOOKTYPE = '01',                      
             MICRNO = ''                      
      FROM   ACMAST A WITH(NOLOCK)                      
      WHERE  A.CLTCODE = CLIENT_CODE                   
             AND A.ACCAT IN ('3','4','18')                      
                      
    END                      
              
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */                      
 SELECT @@ERROR_COUNT = COUNT(SERIAL_NO)                      
  FROM   #RECPAY_TABLE                      
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND                      
                      
  IF @@ERROR_COUNT > 0                      
    BEGIN                      
    DROP TABLE #RECPAY_TABLE                      
    ROLLBACK TRAN                      
    SET @ERRORCODE = 1                      
    SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'                      
    EXEC ACCOUNTMCDXCDS.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                      
    END                      
                      
  SET @@ERROR_COUNT = 0                      
                      
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/                      
  SELECT @@ERROR_COUNT = COUNT(1)                      
  FROM   #RECPAY_TABLE                      
  WHERE  VDT > EDT                      
                      
  IF @@ERROR_COUNT > 0                      
    BEGIN                      
    DROP TABLE #RECPAY_TABLE                      
    ROLLBACK TRAN                      
    SET @ERRORCODE = 1                      
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                      
    EXEC ACCOUNTMCDXCDS.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                      
    END                      
                      
/*-----------VALIDATION FOR DRCR MISMATCH IN SAME VOUCHER ----*/                       
   SELECT @@ERROR_COUNT = COUNT(1) FROM                      
 (SELECT AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)                      
 FROM #RECPAY_TABLE                      
 HAVING SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) <> 0) A                      
                      
 IF @@ERROR_COUNT > 0                      
   BEGIN                      
   DROP TABLE #RECPAY_TABLE                      
   ROLLBACK TRAN                      
   SET @ERRORCODE = 1                      
   SET @MESSAGE ='DEBIT AND CREDIT TOTALS DO NOT MATCH IN SOME VOUCHERS.'                      
      EXEC ACCOUNTMCDXCDS.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                      
      RETURN                      
      END                              
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/                      
  SELECT @@ERROR_COUNT = COUNT(1)                      
  FROM   (SELECT DISTINCT CLIENT_CODE                      
          FROM   #RECPAY_TABLE                      
          WHERE  UPDFLAG = 'N') A                      
                      
  IF @@ERROR_COUNT > 0                      
    BEGIN                      
    DROP TABLE #RECPAY_TABLE                      
    ROLLBACK TRAN                      
    SET @ERRORCODE = 1                      
   SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'                      
    EXEC ACCOUNTMCDXCDS.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                      
    END                      
                      
  /*----------AUTO GENERATION OF VNO -------- */                      
 CREATE TABLE                        
    #BANK_VNO                        
    (                        
     VOUCHERNO VARCHAR(12),                    
  SNO INT,                        
     NEWSRNO INT IDENTITY (1, 1)                        
    )                        
                        
   INSERT INTO                        
    #BANK_VNO                        
   SELECT                        
    DISTINCT VOUCHERNO,SNO                        
   FROM                        
    #RECPAY_TABLE     
    ORDER BY VOUCHERNO,SNO                        
                           
   SELECT TOP 1                        
    @@VDT = VDT                        
   FROM             
    #RECPAY_TABLE                        
                        
   SELECT                        
    @@STD_DATE = LEFT(SDTCUR, 11),                        
    @@LST_DATE = LEFT(LDTCUR, 11),                        
    @@VNOMETHOD = VNOFLAG                        
   FROM                        
    PARAMETER                        
   WHERE                        
    @@VDT BETWEEN SDTCUR AND LDTCUR                        
                        
   SELECT                        
    @@MAXCOUNT = COUNT(DISTINCT VOUCHERNO)                        
   FROM                        
    #RECPAY_TABLE                        
                        
   SELECT                        
    LASTVNO                        
   INTO #VNO                        
   FROM                        
    LASTVNO                        
   WHERE                        
    1 = 2                        
                        
   SELECT @@MAXVNO = MAX(NEWSRNO) FROM #BANK_VNO                        
                        
   INSERT INTO                        
    #VNO                        
   EXEC                         
    ACC_GENVNO_NEW                        
     @@VDT,                       
     @@VTYP,                        
     @@BOOKTYPE,                        
     @@STD_DATE,                        
     @@LST_DATE,                        
     @@MAXVNO                        
                        
   SELECT                        
    @@NEWVNO = LASTVNO                        
   FROM                        
    #VNO                        
                              
   UPDATE                        
    RP                        
   SET                         
    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))               
   FROM                        
    #RECPAY_TABLE RP,                        
    #BANK_VNO BV                        
   WHERE                        
      RP.VOUCHERNO = BV.VOUCHERNO                     
   AND RP.SNO = BV.SNO               
            
            
              
                   
   DROP TABLE #VNO                        
   DROP TABLE #BANK_VNO                           
                       
/* '-----------AUTO GENERATION OF LNO --------------*/                      
--bhrt                 
              
UPDATE #RECPAY_TABLE SET LNO = LNO + (SELECT SUM(SRNO) FROM #RECPAY_TABLE L1             
WHERE #RECPAY_TABLE.VNO = L1.VNO AND #RECPAY_TABLE.SERIAL_NO <= L1.SERIAL_NO)             
            
               
                  
  /*CREATE TABLE [#RECPAY_TABLE_LNO]                      
 (                      
  SNO VARCHAR(12) ,                      
  FLD_AUTO INT,                      
  LNO INT IDENTITY (1, 1) NOT NULL                      
 ) ON [PRIMARY]                      
                      
 SET @@LNOCUR = CURSOR FOR           
  SELECT DISTINCT VOUCHERNO, FLD_AUTO FROM #RECPAY_TABLE                      
 OPEN @@LNOCUR                      
  FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO, @@FLD_AUTO                      
 WHILE @@FETCH_STATUS = 0                      
  BEGIN                      
                      
   INSERT INTO #RECPAY_TABLE_LNO                      
    (SNO, FLD_AUTO)                      
   SELECT DISTINCT VOUCHERNO, FLD_AUTO FROM #RECPAY_TABLE WHERE VOUCHERNO = @@LNOVNO                      
   UPDATE RP                      
    SET LNO = RL.LNO                      
   FROM #RECPAY_TABLE RP, #RECPAY_TABLE_LNO RL                      
   WHERE RP.VOUCHERNO = RL.SNO AND RP.FLD_AUTO = RL.FLD_AUTO                      
   TRUNCATE TABLE #RECPAY_TABLE_LNO                      
   FETCH NEXT FROM @@LNOCUR INTO @@LNOVNO, @@FLD_AUTO                      
  END                      
 CLOSE @@LNOCUR                      
 DEALLOCATE @@LNOCUR                      
 DROP TABLE #RECPAY_TABLE_LNO     */                 
                     
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/                      
  CREATE TABLE #LEDGER (                      
    VTYP      SMALLINT,                      
    VNO       VARCHAR(12),                      
    EDT       DATETIME,                      
    LNO       SMALLINT,                      
    ACNAME    VARCHAR(100),                      
    DRCR      VARCHAR(1),                      
    VAMT      MONEY,                      
    VDT       DATETIME,                      
    VNO1      VARCHAR(12),                      
    REFNO     CHAR(12),                      
    BALAMT    MONEY,                      
    NODAYS    INT,                      
    CDT       DATETIME,                      
    CLTCODE   VARCHAR(10),                      
    BOOKTYPE  VARCHAR(2),                      
    ENTEREDBY VARCHAR(25),                      
    PDT       DATETIME,                      
    CHECKEDBY VARCHAR(25),                      
    ACTNODAYS INT,                      
    NARRATION VARCHAR(234))                      
              
/*======CLIENT SIDE RECORD======*/              
            
                    
  INSERT INTO #LEDGER                      
             (VTYP,                      
              VNO,                      
              EDT,                      
              LNO,                      
              ACNAME,                      
              DRCR,                      
   VAMT,                  
              VDT,                      
              VNO1,                      
              REFNO,                      
              BALAMT,                      
              NODAYS,                      
              CDT,                      
              CLTCODE,                      
              BOOKTYPE,                      
              ENTEREDBY,                      
              PDT,                      
              CHECKEDBY,                      
              ACTNODAYS,                      
              NARRATION)                      
  SELECT VTYP,                      
         VNO,                      
         EDT = (CASE                      
                  WHEN VTYP = @@VTYP                      
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                      
                 ELSE EDT                      
                END),                      
         LNO,                      
         ACNAME,                      
         DRCR,                      
         VAMT = SUM(AMOUNT),                      
         VDT,                      
         VNO1 = VNO,                      
         REFNO = 0,                      
         BALAMT = SUM(AMOUNT),                      
         NODAYS = 0,                      
         CDT = GETDATE(),                      
         CLTCODE = CLIENT_CODE,                      
      BOOKTYPE = BOOKTYPE,                      
         ENTEREDBY = ENTEREDBY,                      
         PDT = GETDATE(),                      
         CHECKEDBY = @UNAME,                      
         ACTNODAYS = 0,                      
         NARRATION                      
  FROM   #RECPAY_TABLE                      
  GROUP BY                      
   VTYP,                      
      VNO,                      
         (CASE                      
                  WHEN VTYP = @@VTYP                      
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                      
                  ELSE EDT                      
                END),                      
         LNO,         
         ACNAME,                      
         DRCR,                      
         VDT,                      
         CLIENT_CODE,                      
         BOOKTYPE,                      
         ENTEREDBY,                      
         NARRATION                      
                      
                      
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/                      
  INSERT INTO LEDGER                
 (VTYP,                      
              VNO,                      
              EDT,                      
              LNO,                      
              ACNAME,                      
              DRCR,                      
              VAMT,                      
              VDT,                      
              VNO1,                      
              REFNO,                      
              BALAMT,                      
              NODAYS,                      
              CDT,                      
              CLTCODE,                      
              BOOKTYPE,                      
              ENTEREDBY,                      
              PDT,                      
              CHECKEDBY,                      
              ACTNODAYS,                      
              NARRATION)                      
  SELECT   VTYP,                      
           VNO,                      
     EDT,                      
           LNO,                      
           ACNAME,                 
           DRCR,                      
           VAMT,                      
           VDT,                      
           VNO1,                      
           REFNO,                      
           BALAMT,                      
  NODAYS,                      
           CDT,                      
           CLTCODE,                      
           BOOKTYPE,                      
           ENTEREDBY,                      
           PDT,                      
           CHECKEDBY,                      
           ACTNODAYS,                      
           NARRATION                      
  FROM     #LEDGER                      
  ORDER BY BOOKTYPE,                      
           VTYP,                      
           VNO,                      
           LNO                      
                      
  IF @@ERROR <> 0                      
    BEGIN                      
    DROP TABLE #LEDGER                      
    DROP TABLE #RECPAY_TABLE                      
    ROLLBACK TRAN                      
    SET @ERRORCODE = 1                      
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                      
    EXEC ACCOUNTMCDXCDS.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                      
    END                      
                      
                      
IF @@BRANCHFLAG = 1                        
    BEGIN                 
                
 SELECT * INTO #LEDGER2 FROM LEDGER2 WHERE 1 = 2                
                
 INSERT INTO #LEDGER2                
 SELECT VTYP, VNO, LNO, DRCR, VAMT, COSTCODE, L.BOOKTYPE, L.CLTCODE                
 FROM #LEDGER L, COSTMAST C, ACMAST A WHERE                 
 L.CLTCODE = A.CLTCODE AND C.COSTNAME = CASE WHEN UPPER(A.BRANCHCODE) = 'ALL' THEN 'HO' ELSE A.BRANCHCODE END                
                
 INSERT INTO #LEDGER2                
 SELECT VTYPE, VNO, LNO, CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END, CAMT, COSTCODE, BOOKTYPE, 'HOCTRL'                
 FROM #LEDGER2 WHERE COSTCODE IN(SELECT COSTCODE FROM COSTMAST WHERE COSTNAME <> 'HO')                
                
 DECLARE @@COSTCODE INT                
                
 SELECT @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO'                
                
 INSERT INTO #LEDGER2                
 SELECT VTYPE, VNO, LNO, DRCR, CAMT, @@COSTCODE, BOOKTYPE, BRCONTROLAC                
 FROM #LEDGER2 L2, BRANCHACCOUNTS B, COSTMAST C                
 WHERE L2.COSTCODE = C.COSTCODE AND COSTNAME <> 'HO' AND CLTCODE <> 'HOCTRL'                
 AND COSTNAME = BRANCHNAME                 
                
 INSERT INTO LEDGER2 (VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE )                     
 SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE FROM #LEDGER2                
                      
      /*SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO                        
                               FROM     #RECPAY_TABLE                        
                               ORDER BY VNO                        
      OPEN @@L2CUR                        
                        
      FETCH NEXT FROM @@L2CUR                        
      INTO @@L2VNO                                    
      WHILE @@FETCH_STATUS = 0                        
        BEGIN                        
          DELETE FROM TEMPLEDGER2                        
          WHERE       SESSIONID = '9999999999'                        
                      
  /*======CLIENT SIDE RECORD======*/                        
          INSERT INTO TEMPLEDGER2                        
          SELECT 'BRANCH',                        
                 C.COSTNAME,                        
                 AMOUNT,                        
                 VTYP,                        
                 VNO,                        
                 LNO,                        
                 DRCR,                        
                 '0',                        
                 BOOKTYPE,                        
                 '9999999999',                        
                 CLIENT_CODE,                        
                 'A',                        
                 '0'                        
    FROM   #RECPAY_TABLE RP,                        
                 COSTMAST C WITH(NOLOCK)                        
          WHERE  RP.COSTCODE = C.COSTCODE       
                 AND VNO = @@L2VNO                        
                        
          EXEC INSERTTOLEDGER2                        
            '9999999999' ,                        
            @@L2VNO ,                        
            '1' ,                        
            '1' ,                        
            '1' ,                        
            'BROKER' ,                        
         'BROKER'                        
                        
  FETCH NEXT FROM @@L2CUR                        
          INTO @@L2VNO                        
        END                        
                      
      DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)                        
      WHERE       SESSIONID = '9999999999'    */                    
 END                        
                
              
DROP TABLE #LEDGER                
                      
              
IF @@ACCOUNTSVR <> 'ABCSOMKTUATSVR1'            
 BEGIN                       
 SET @@SQLPARA = " EXEC ACCOUNT_AB.DBO.V2_OFFLINE_REV_UPDATE '" + @@NEWVNO + "','" + @EXCHANGE + "','" + @SEGMENT + "' "              
 END                      
ELSE                      
 BEGIN                      
 SET @@SQLPARA = " EXEC V2_OFFLINE_REV_UPDATE '" + @@NEWVNO + "','" + @EXCHANGE + "','" + @SEGMENT + "' "              
END                 
print @@SQLPARA                   
EXEC(@@SQLPARA)                 
                 
COMMIT TRAN                           
                          
DROP TABLE #RECPAY_TABLE                          
SET @ERRORCODE = 0                          
SET @MESSAGE = 'POSTED SUCCESSFULLY'                          
EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, @@VTYP, @ERRORCODE, @MESSAGE, @UNAME                          
                          
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_LEDGER_REPORT
-- --------------------------------------------------

 
create PROC [dbo].[V2_OFFLINE_LEDGER_REPORT]            
(            
@startDate varchar(11),            
@endDate varchar(11),          
@fromParty varchar(10),          
@toParty varchar(10),      
@Selectionby VARCHAR(3),
@SortBy varchar(6),
@EXCSEGMENT VARCHAR(11)         
)            
AS          
    
/*    
EXEC V2_OFFLINE_LEDGER_REPORT 'SEP  1 2007','SEP 17 2007','0a141','0a141','VDT'    
*/    
    
DECLARE @@QRY AS VARCHAR(8000)    
DECLARE @@CLOSEBALQRY as VARCHAR(8000)
DECLARE @@OPENDATE AS VARCHAR(11)    
DECLARE @@FINSTART AS DATETIME    
DECLARE @@FINSTARTCHAR AS VARCHAR(11)    
    
SELECT @@QRY = "  "
SELECT @@CLOSEBALQRY = " SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED "    
    
SELECT @@FINSTART = SDTCUR, @@FINSTARTCHAR = LEFT(SDTCUR,11) FROM PARAMETER (NOLOCK) WHERE CONVERT(DATETIME,@startDate,109) BETWEEN SDTCUR AND LDTCUR      
    
IF UPPER(@SELECTIONBY) = 'VDT'    
BEGIN    
 SELECT @@OPENDATE = (SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDATE),0),109),11) FROM V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) WHERE VOUCHERTYPE = 18    
      AND VDATE <= @@FINSTART)    
    
    
END    
ELSE    
BEGIN    
 SELECT @@OPENDATE = (SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(EDATE),0),109),11) FROM V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) WHERE VOUCHERTYPE = 18    
      AND EDATE <= @@FINSTART)    
END    
    

BEGIN DISTRIBUTED TRANSACTION    

IF Upper(@Selectionby) = 'VDT'      
  BEGIN      
  IF @startDate = @@FINSTART     
        Begin      
   If @@Opendate = @@FINSTARTCHAR       
   Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "   
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE Like '" + @@Opendate + "%' And VOUCHERTYPE = 18  "   
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
   End      
   Else      
   Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "      
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE >= '" + @@Opendate + " 00:00:00' And VDATE < '" + @@FINSTARTCHAR + "'"    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
   End      
        End      
  Else      
        Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "    
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE >= '" + @@Opendate + " 00:00:00' And VDATE < '" + @@FINSTARTCHAR + "'"    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
        End      
END       
ELSE     
  BEGIN      
  If @StartDate = @@FINSTARTCHAR And @@Opendate = @@FINSTARTCHAR      
        Begin      
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) <= 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " CASE WHEN Sum(DEBITAMT - CREDITAMT) > 0 THEN ABS(Sum(DEBITAMT - CREDITAMT)) ELSE 0 END AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "    
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And EDate Like '" + @@Opendate + "%' And VOUCHERTYPE = 18  "    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By CLTCODE, BRANCHCODE, EXCHANGE, SEGMENT  "    
        End      
  Else      
        Begin      
    
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@QRY = @@QRY + " 'OPBAL' AS VNAME, "    
      SELECT @@QRY = @@QRY + " '' AS VTYP, "    
      SELECT @@QRY = @@QRY + " '' AS BOOKTYPE, "    
      SELECT @@QRY = @@QRY + " '' as VDt, "            
      SELECT @@QRY = @@QRY + " '' as Edt, "            
      SELECT @@QRY = @@QRY + " '' as GLCode, "    
      SELECT @@QRY = @@QRY + " CltCode,"    
      SELECT @@QRY = @@QRY + " BranchCode,"    
      SELECT @@QRY = @@QRY + " (CASE WHEN SUM(OPBAL) <= 0 THEN ABS(SUM(OPBAL)) ELSE 0 END) AS CREDITAMT, "          
      SELECT @@QRY = @@QRY + " (CASE WHEN SUM(OPBAL) > 0 THEN ABS(SUM(OPBAL)) ELSE 0 END) AS DEBITAMT, "         
      SELECT @@QRY = @@QRY + " 'OPENING BALANCE' AS Narration, "                   
      SELECT @@QRY = @@QRY + " '' AS VNO, "        
      SELECT @@QRY = @@QRY + " '' AS Vdate, "     
      SELECT @@QRY = @@QRY + " '' AS BankName, "   
      SELECT @@QRY = @@QRY + " '' AS BranchName "     
      SELECT @@QRY = @@QRY + " FROM "     
      SELECT @@QRY = @@QRY + " (Select EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE, Opbal = Sum(DEBITAMT - CREDITAMT) "     
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And EDate Like '" + @@Opendate + "%' And VOUCHERTYPE = 18  "    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE  "    
      SELECT @@QRY = @@QRY + " UNION ALL  "    
      SELECT @@QRY = @@QRY + " Select EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE, Opbal = Sum(DEBITAMT - CREDITAMT) "     
      SELECT @@QRY = @@QRY + " From V2_OFFLINE_LEDGER_ENTRIES (NOLOCK) "       
      SELECT @@QRY = @@QRY + " Where Cltcode >= '" + @FromParty + "' and CLTCODE <= '" + @ToParty + "'"    
      SELECT @@QRY = @@QRY + " And VDATE >= '" + @@Opendate + " 00:00:00' And EDATE < '" + @@FINSTARTCHAR + "' AND VOUCHERTYPE <> 18"    
	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END
      SELECT @@QRY = @@QRY + " Group By EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE ) T"     
      SELECT @@QRY = @@QRY + " GROUP BY EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE "    
        End      
  End      
    
    
 SELECT @@QRY = @@QRY + " UNION ALL "    
 SELECT @@QRY = @@QRY + " select A.Exchange, A.Segment, "     
 SELECT @@QRY = @@QRY + " UPPER(ISNULL(V.SHORTDESC,'')) AS VNAME, "       
 SELECT @@QRY = @@QRY + " A.VOUCHERTYPE AS VTYP, "    
 SELECT @@QRY = @@QRY + " A.BOOKTYPE AS BOOKTYPE, "      
 SELECT @@QRY = @@QRY + " Convert(varchar,a.Vdate,105) as VDt, "            
 SELECT @@QRY = @@QRY + " Convert(varchar,a.Edate,105) as Edt, "            
 SELECT @@QRY = @@QRY + " a.OppCode as GLCode, "    
 SELECT @@QRY = @@QRY + " a.CltCode,"    
 SELECT @@QRY = @@QRY + " a.BranchCode,"    
 SELECT @@QRY = @@QRY + " a.CreditAmt, "          
 SELECT @@QRY = @@QRY + " a.DebitAmt,"           
 SELECT @@QRY = @@QRY + " a.Narration, "                   
 SELECT @@QRY = @@QRY + " a.VoucherNo as VNO, "        
 SELECT @@QRY = @@QRY + " a.Vdate, "     
 SELECT @@QRY = @@QRY + " a.BankName, "   
 SELECT @@QRY = @@QRY + " a.BranchName "   
 SELECT @@QRY = @@QRY + " from "        
 SELECT @@QRY = @@QRY + " v2_offline_ledger_entries a (NOLOCK) "    
 SELECT @@QRY = @@QRY + " LEFT OUTER JOIN "    
 SELECT @@QRY = @@QRY + " VMAST V ON (V.VTYPE = A.VOUCHERTYPE) "       
 SELECT @@QRY = @@QRY + " Where 1=1 "        
 IF Upper(@Selectionby) = 'VDT'    
 BEGIN      
 SELECT @@QRY = @@QRY + " And a.vDATE >= convert(datetime,'" + @startDate + "',109) "           
 SELECT @@QRY = @@QRY + " and a.vDATE <= convert(datetime,'" + @endDate + " 23:59:59',109) "           
 END    
 ELSE    
 BEGIN    
 SELECT @@QRY = @@QRY + " And a.EDATE >= convert(datetime,'" + @startDate + "',109) "           
 SELECT @@QRY = @@QRY + " and a.EDATE <= convert(datetime,'" + @endDate + " 23:59:59',109) "    
 END    
 SELECT @@QRY = @@QRY + " and a.CltCode >= '" + @FromParty + "' "         
 SELECT @@QRY = @@QRY + " and a.CltCode <= '" + @ToParty + "'"         
 SELECT @@QRY = @@QRY + " AND A.VOUCHERTYPE <> '18'"      
 	  IF ISNULL(@EXCSEGMENT,'ALL') <> 'ALL'
	  BEGIN 
      SELECT @@QRY = @@QRY + " And EXCHANGE + '-' + SEGMENT = '" + @EXCSEGMENT + "'"
	  END 


      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " Select EXCHANGE, SEGMENT,"     
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " 'CLOSEBAL' AS VNAME, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS VTYP, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS BOOKTYPE, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' as VDt, "            
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' as Edt, "            
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' as GLCode, "    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " CltCode,"    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " BranchCode,"    
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " (CASE WHEN SUM(CREDITAMT) - SUM(DEBITAMT) > 0 THEN SUM(CREDITAMT) - SUM(DEBITAMT) ELSE 0 END) AS CREDITAMT, "          
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " (CASE WHEN SUM(CREDITAMT) - SUM(DEBITAMT) <= 0 THEN SUM(DEBITAMT) - SUM(CREDITAMT) ELSE 0 END) AS DEBITAMT, "         
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " 'CLOSING BALANCE' AS Narration, "                   
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS VNO, "        
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '31-DEC-2049' AS Vdate, "     
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS BankName, "   
      SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " '' AS BranchName "  
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " FROM "
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " ( "
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + @@QRY
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " ) X " 
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " GROUP BY EXCHANGE, SEGMENT, CLTCODE, BRANCHCODE " 
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " UNION ALL " 
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + @@QRY
	if @SORTBY = 'DTASC'
	begin
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " Order by  CLTCODE, Exchange, Segment, Vdate asc" 
	end
	else
	begin
	  SELECT @@CLOSEBALQRY = @@CLOSEBALQRY + " Order by  CLTCODE, Exchange, Segment, Vdate desc" 
	end
EXEC (@@CLOSEBALQRY)

COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_PAYMENTUPLOAD
-- --------------------------------------------------
  
CREATE PROC [dbo].[V2_OFFLINE_PAYMENTUPLOAD](                            
                            
           @UNAME     VARCHAR(25),                            
           @USERCAT   INT,                            
           @EXCHANGE  VARCHAR(3),                            
           @SEGMENT   VARCHAR(10),                            
      @IP_VDATE varchar(11),          
           @RECOFLAG  CHAR(1) = 'N')                            
                            
AS                            
    
                          
                          
  SET NOCOUNT ON                            
                              
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/                            
  DECLARE  @@STD_DATE        VARCHAR(11),                            
           @@LST_DATE        VARCHAR(11),                            
           @@BRANCHFLAG       AS TINYINT,                            
           @@VNOFLAG          AS TINYINT,                            
           @@VNOMETHOD       INT,                            
           @@ACNAME          CHAR(100),                            
           @@BOOKTYPE        CHAR(2),                            
           @@MICRNO          VARCHAR(10),                            
           @@DRCR            VARCHAR(1),                            
           @@VTYP            SMALLINT,                            
           @@BANK_CODE       VARCHAR(100),                            
           @@BACKDAYS        INT,                            
           @@BACKDATE        VARCHAR(11),                            
           @@BRNCOUNT        TINYINT,                            
           @@MonthlyVdt      VARCHAR(11),                            
           @@SERIAL_NO       INT,                            
           @@COSTCODECOUNT   TINYINT,                            
           @@COSTCODEUPDATES CURSOR,                            
           @@NEWVNO           AS VARCHAR(12),                            
           @@MAXCOUNT         AS INT,                            
           @@VDT              AS VARCHAR(11),                            
           @@BANKBRANCH       AS VARCHAR(10),                            
           @@BANKCOST         AS NUMERIC,                            
           @@LNOCUR           AS CURSOR,                            
           @@VNOCUR           AS CURSOR,                            
           @@LNOVNO           AS VARCHAR(12),                            
           @@MAXVNO           AS INT,                            
           @@L2CUR            AS CURSOR,                            
           @@L2VNO            AS VARCHAR(12),                            
           @@ERROR_COUNT      AS BIGINT,                            
           @@FILEEXISTS       AS INT,                            
           @@SQL              AS VARCHAR(2000),                            
           @ERRORCODE         AS INT,                            
           @MESSAGE           AS VARCHAR(200) ,                    
   @@RECPAYTBLCOUNT BIGINT                    
                                                 
                            
 SET @@VTYP = 3                         
                          
       BEGIN DISTRIBUTED TRANSACTION --BEGIN TRAN                            
                            
  CREATE TABLE [#RECPAY_TABLE] (                            
    SNO    INT   IDENTITY ( 1,1 ),                            
    EDATE        VARCHAR(20),                            
    VOUCHER_DATE VARCHAR(20),                            
    CLIENT_CODE  VARCHAR(50),                            
    AMOUNT       MONEY,                            
    DRCR         VARCHAR(1),                            
    NARRATION    VARCHAR(234),                            
    BANK_CODE    VARCHAR(10),                            
    BANK_NAME    VARCHAR(100),               
    REF_NO       VARCHAR(15),                            
    BRANCHCODE   VARCHAR(20),     
    BRANCH_NAME  VARCHAR(50),                            
    CHQ_MODE     VARCHAR(1),                            
    CHQ_DATE     VARCHAR(20),                       
    CHQ_NAME     VARCHAR(100),                            
    CL_MODE      VARCHAR(1),                            
    FLD_AUTO     BIGINT,                     
    ENTEREDBY    VARCHAR(25),                            
    VDT          DATETIME   NULL,                            
    FYSTART      DATETIME   NULL,                      
    FYEND        DATETIME   NULL,                            
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),                            
    EDT          DATETIME   NULL,                            
    DDDT         DATETIME   NULL,                            
    VNO          VARCHAR(12)   NULL,                            
    VTYP         SMALLINT   NULL,                            
    ACNAME       VARCHAR(100)   NULL,                            
    COSTCODE     SMALLINT   NULL,                            
    BANKCOST     SMALLINT   NULL,                            
    LNO          SMALLINT   NOT NULL DEFAULT (0),                            
    BANKNAME     VARCHAR(100)   NULL,                            
    MICRNO       INT   NULL,                            
    BOOKTYPE     VARCHAR(2)   NULL,                            
    ACC_NO       VARCHAR(16))                            
  ON [PRIMARY]                            
                              
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */                            
  INSERT INTO #RECPAY_TABLE                            
             (EDATE,                            
              VOUCHER_DATE,                            
              CLIENT_CODE,                            
              AMOUNT,                            
              DRCR,                            
              NARRATION,                            
              BANK_CODE,                            
              BANK_NAME,                            
              REF_NO,                            
              BRANCHCODE,                            
              BRANCH_NAME,                            
              CHQ_MODE,                            
              CHQ_DATE,                            
              CHQ_NAME,                            
              CL_MODE,                            
              FLD_AUTO,                            
              ENTEREDBY,                            
              VDT,                             
              EDT,                             
              DDDT,                            
              ACC_NO,VTYP)                            
  SELECT CONVERT(VARCHAR,EDATE,103),                            
         CONVERT(VARCHAR,VDATE,103),                            
         CLTCODE,                            
         DEBITAMT,                            
         'C',                            
         NARRATION,                            
         OPPCODE,                            
         BANKNAME,                            
         DDNO,                            
         'ALL',                            
         BRANCHNAME,                            
         CHEQUEMODE,                            
         CONVERT(VARCHAR,CHEQUEDATE,103),                            
         CHEQUENAME,                            
         CLEAR_MODE,                            
         FLDAUTO,                            
         ADDBY,                             
         VDATE,                             
         EDATE,                             
         CHEQUEDATE,                             
         TPAccountNumber, VOUCHERTYPE                            
  FROM   ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES-- WITH(NOLOCK)                             
  WHERE  VOUCHERTYPE = 3                          
         AND EXCHANGE = @EXCHANGE                            
         AND SEGMENT = @SEGMENT                    
         AND ISNULL(ROWSTATE,0) = 0       
   AND ISNULL(APPROVALFLAG,0) = 1                      
   AND VDATE LIKE @IP_VDATE + '%'           
                 
                        
                      
  SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE                    
                    
 IF @@RECPAYTBLCOUNT = 0                    
 BEGIN                    
  COMMIT                    
  RETURN                    
 END                    
             
              
              
--TRUNCATE table #RECPAY_TABLE              
--return                    
              
                 
  UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES --WITH (ROWLOCK)                             
  SET    ROWSTATE = 9                            
  FROM   #RECPAY_TABLE                            
  WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                                  
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)                            
  FROM   #RECPAY_TABLE                            
                                     
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),                            
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),                            
         @@BRANCHFLAG = BRANCHFLAG,                            
         @@VNOFLAG = VNOFLAG                            
  FROM   PARAMETER WITH(NOLOCK)                             
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR                            
                                                              
  IF @@VNOFLAG <> 0                            
    BEGIN                            
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)                            
      FROM   #RECPAY_TABLE                            
                                         
      IF @@ERROR_COUNT > 1                            
        BEGIN                            
     DROP TABLE #RECPAY_TABLE                                        
     ROLLBACK TRANSACTION                            
     SET @ERRORCODE = 1                                      
     SET @MESSAGE = 'PAYMENT FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                            
     EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                     
     RETURN                            
        END                            
    END                            
                            
  IF @@BRANCHFLAG = 1                            
    BEGIN                            
      UPDATE #RECPAY_TABLE                            
      SET    BRANCHCODE = A.BRANCHCODE,                            
             FYSTART = P.SDTCUR,                            
           FYEND = P.LDTCUR,                            
             UPDFLAG = 'Y',                            
             ACNAME = A.LONGNAME,                            
             COSTCODE = C.COSTCODE,                            
             BANKNAME = B.LONGNAME,                            
             BOOKTYPE = B.BOOKTYPE,                            
             MICRNO = ISNULL(B.MICRNO,0)                            
      FROM   ACMAST A WITH(NOLOCK),                            
             PARAMETER P WITH(NOLOCK),                            
            COSTMAST C WITH(NOLOCK),                            
             ACMAST B WITH(NOLOCK)                            
      WHERE  A.CLTCODE = CLIENT_CODE                            
             AND B.CLTCODE = BANK_CODE                            
             --AND P.CURYEAR = 1   
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                           
             AND A.ACCAT IN ('3','4','18')                            
             AND B.ACCAT = '2'                            
             AND A.BRANCHCODE = COSTNAME                            
              
      UPDATE #RECPAY_TABLE                            
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                            
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                            
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),     
             FYSTART = P.SDTCUR,                            
             FYEND = P.LDTCUR,                            
             UPDFLAG = 'Y',                            
             ACNAME = A.LONGNAME,                            
             COSTCODE = (SELECT TOP 1 COSTCODE                            
                         FROM   COSTMAST                            
                         WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),                            
             BANKNAME = B.LONGNAME,                            
             BOOKTYPE = B.BOOKTYPE,                            
             MICRNO = ISNULL(B.MICRNO,0)                            
      FROM   ACMAST A WITH(NOLOCK),                            
             PARAMETER P WITH(NOLOCK),                            
             COSTMAST C WITH(NOLOCK),                            
             ACMAST B WITH(NOLOCK)                            
      WHERE  A.CLTCODE = CLIENT_CODE                  
             AND B.CLTCODE = BANK_CODE                            
             --AND P.CURYEAR = 1   
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                           
             AND A.ACCAT IN ('3','4','18')                            
             AND B.ACCAT = '2'                            
             AND A.BRANCHCODE = 'ALL'                            
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                            
                                                                         
      UPDATE #RECPAY_TABLE             
      SET    BRANCHCODE = 'HO',                            
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                            
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                            
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                            
             FYSTART = P.SDTCUR,                            
             FYEND = P.LDTCUR,                            
             UPDFLAG = 'Y',                            
             ACNAME = A.LONGNAME,                            
             COSTCODE = (SELECT TOP 1 COSTCODE                            
                         FROM   COSTMAST                            
             WHERE  COSTNAME = 'HO'),                            
             BANKNAME = B.LONGNAME,                            
             BOOKTYPE = B.BOOKTYPE,                            
             MICRNO = ISNULL(B.MICRNO,0)                            
      FROM   ACMAST A WITH(NOLOCK),                            
       PARAMETER P WITH(NOLOCK),                            
             COSTMAST C WITH(NOLOCK),                            
             ACMAST B WITH(NOLOCK)                            
      WHERE  A.CLTCODE = CLIENT_CODE                            
             AND B.CLTCODE = BANK_CODE                            
             --AND P.CURYEAR = 1   
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                           
             AND A.ACCAT IN ('3','4','18')                            
             AND B.ACCAT = '2'                            
             AND A.BRANCHCODE = 'ALL'                            
             AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                            
    END                            
  ELSE                       
    BEGIN                            
      UPDATE #RECPAY_TABLE                            
      SET    FYSTART = @@STD_DATE,                            
             FYEND = @@LST_DATE + ' 23:59:59',                
             UPDFLAG = 'Y',                            
             ACNAME = A.LONGNAME,                            
             BANKNAME = B.LONGNAME,                            
             BOOKTYPE = B.BOOKTYPE,                            
             MICRNO = ISNULL(B.MICRNO,0)                            
      FROM   ACMAST A WITH(NOLOCK),                            
             ACMAST B WITH(NOLOCK)                            
      WHERE  A.CLTCODE = CLIENT_CODE                            
             AND B.CLTCODE = BANK_CODE                            
             AND A.ACCAT IN ('3','4','18')                            
             AND B.ACCAT = '2'                            
    END                            
                                
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */                            
  SELECT @@ERROR_COUNT = COUNT(SNO)                            
  FROM   #RECPAY_TABLE                            
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND                            
                            
  IF @@ERROR_COUNT > 0                      
    BEGIN                         
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                         
    SET @ERRORCODE = 1                                     
    SET @MESSAGE = 'PAYMENT SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'                            
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                            
    END                            
                                
  SET @@ERROR_COUNT = 0                            
                              
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/                            
  SELECT @@ERROR_COUNT = COUNT(1)                            
  FROM   #RECPAY_TABLE                            
  WHERE  VDT > EDT                            
                              
  IF @@ERROR_COUNT > 0                            
    BEGIN                          
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                     
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                   
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                            
    END                            
            /*----------VALIDATION FOR ZERO AMOUNT --------*/                            
  SELECT @@ERROR_COUNT = COUNT(1)                            
  FROM   #RECPAY_TABLE                            
  WHERE  AMOUNT <= 0                            
                              
  IF @@ERROR_COUNT > 0                            
    BEGIN                             
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                   
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                   
    END                            
                              
  /*   ----------VALIDATION FOR CHEQUE NUMBER -------- */                            
  SELECT @@ERROR_COUNT = COUNT(1)                            
  FROM   (SELECT DISTINCT DDNO = RP.REF_NO,                            
                          CLTCODE = RP.CLIENT_CODE                            
   FROM   #RECPAY_TABLE RP,                            
                 LEDGER L WITH(NOLOCK),                            
               LEDGER1 L1 WITH(NOLOCK)                            
          WHERE  L1.DDNO = RP.REF_NO                            
                 AND L1.DD = RP.CHQ_MODE                            
                 AND L1.DRCR = @@DRCR                  
                 AND L1.VTYP = @@VTYP                            
                 AND RP.REF_NO <> 0                            
                 AND L.VTYP = @@VTYP                            
                 AND L.VNO = L1.VNO                            
                 AND L.BOOKTYPE = L1.BOOKTYPE                            
                 AND L.DRCR = @@DRCR                            
                 AND L.CLTCODE = RP.CLIENT_CODE) A                            
                              
  IF @@ERROR_COUNT > 0                            
    BEGIN                            
 DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CHEQUE NUMBERS ALREADY EXISTS'                  
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                   
    END                            
                              
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/                            
  SELECT @@ERROR_COUNT = COUNT(1)                            
  FROM   (SELECT DISTINCT CLIENT_CODE                            
          FROM   #RECPAY_TABLE                            
          WHERE  UPDFLAG = 'N') A                            
                              
  IF @@ERROR_COUNT > 0                            
    BEGIN                            
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'                   
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                       
    END                            
                        
  /*    ----------AUTO GENERATION OF VNO -------- */                            
  SET @@VNOCUR = CURSOR FOR SELECT DISTINCT BANK_CODE,                            
         BOOKTYPE                            
                            FROM   #RECPAY_TABLE WITH (NOLOCK)                            
                              
  OPEN @@VNOCUR                            
                              
  FETCH NEXT FROM @@VNOCUR                            
  INTO @@BANK_CODE,                            
       @@BOOKTYPE                            
                              
  WHILE @@FETCH_STATUS = 0                            
    BEGIN                            
      IF @@BRANCHFLAG = 1                            
        BEGIN                            
          SELECT @@BANKBRANCH = BRANCHCODE,                            
                 @@BANKCOST = ISNULL(C.COSTCODE,-1)                            
          FROM   ACMAST A WITH(NOLOCK)                            
                 LEFT OUTER JOIN COSTMAST C WITH(NOLOCK)                            
                   ON (A.BRANCHCODE = C.COSTNAME)                            
          WHERE  A.CLTCODE = @@BANK_CODE                            
                                      
          IF @@BANKBRANCH <> 'ALL'                            
            BEGIN                            
              UPDATE RP                            
              SET    COSTCODE = @@BANKCOST                            
              FROM   #RECPAY_TABLE RP,                            
                     ACMAST A WITH(NOLOCK)                            
              WHERE  A.CLTCODE = RP.CLIENT_CODE                            
                     AND A.BRANCHCODE = 'ALL'                            
                                   
              UPDATE #RECPAY_TABLE                            
              SET    BANKCOST = @@BANKCOST                                          WHERE  BANK_CODE = @@BANK_CODE                            
            END                            
          ELSE                            
            BEGIN                            
              UPDATE #RECPAY_TABLE                            
              SET    COSTCODE = (SELECT TOP 1 COSTCODE                            
                                 FROM   COSTMAST WITH(NOLOCK)                            
                                 WHERE  COSTNAME = 'HO')                            
              WHERE  COSTCODE = ''                            
                     AND BANK_CODE = @@BANK_CODE                            
                                          
              SET @@COSTCODEUPDATES = CURSOR FOR SELECT   SNO,                            
                                    COUNT(DISTINCT COSTCODE)                            
                                                 FROM     #RECPAY_TABLE                             
                                                 WHERE    BANK_CODE = @@BANK_CODE                            
                                                 GROUP BY SNO                            
                                                 HAVING   COUNT(DISTINCT COSTCODE) > 1                            
                                          
              OPEN @@COSTCODEUPDATES                            
                                          
              FETCH NEXT FROM @@COSTCODEUPDATES                            
              INTO @@SERIAL_NO,                            
                   @@COSTCODECOUNT                            
                            
              WHILE @@FETCH_STATUS = 0                            
                BEGIN                            
                  UPDATE #RECPAY_TABLE                            
                  SET    BANKCOST = (SELECT TOP 1 COSTCODE                            
                                  FROM   COSTMAST WITH(NOLOCK)                            
                                     WHERE  COSTNAME = 'HO')                            
                  WHERE  (BANKCOST = ''                            
                           OR BANKCOST IS NULL)                            
                         AND BANK_CODE = @@BANK_CODE                            
                         AND SNO = @@SERIAL_NO                            
                                              
                  FETCH NEXT FROM @@COSTCODEUPDATES                            
                  INTO @@SERIAL_NO,                            
         @@COSTCODECOUNT                            
                END                            
                                          
              CLOSE @@COSTCODEUPDATES                            
                                          
              DEALLOCATE @@COSTCODEUPDATES                            
                                          
              UPDATE #RECPAY_TABLE                            
              SET    BANKCOST = COSTCODE                            
              WHERE  BANK_CODE = @@BANK_CODE                            
                     AND (BANKCOST = ''                            
                           OR BANKCOST IS NULL)                           
END                            
        END                            
                                  
      CREATE TABLE #BANK_VNO (                            
        SRNO    INT,                            
        NEWSRNO INT   IDENTITY ( 1,1 ))                            
                                  
      INSERT INTO #BANK_VNO                            
      SELECT DISTINCT SNO                            
      FROM   #RECPAY_TABLE                            
      WHERE  BANK_CODE = @@BANK_CODE                            
          AND BOOKTYPE = @@BOOKTYPE                            
                                                        
      SELECT @@MAXCOUNT = COUNT(DISTINCT SNO)                        
      FROM   #RECPAY_TABLE                            
                                         
      SELECT TOP 1 @@VDT = VDT                            
      FROM   #RECPAY_TABLE                            
                                  
      SELECT LASTVNO                            
      INTO   #VNO                            
      FROM   LASTVNO WITH(NOLOCK)                            
      WHERE  1 = 2                            
                                  
      SELECT @@MAXVNO = MAX(NEWSRNO)                            
      FROM   #BANK_VNO                            
                           
                          
              
              
      INSERT INTO #VNO                            
      EXEC ACC_GENVNO_NEW                            
        @@VDT ,                            
    @@VTYP ,                            
        @@BOOKTYPE ,                            
   @@STD_DATE ,                            
        @@LST_DATE ,                            
        @@MAXVNO                            
                                  
      SELECT @@NEWVNO = LASTVNO                            
      FROM   #VNO                            
                                  
      UPDATE RP                            
      SET    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                            
      FROM   #RECPAY_TABLE RP,                            
             #BANK_VNO BV                            
      WHERE  RP.SNO = BV.SRNO                            
                                  
               
              
      DROP TABLE #VNO                            
                                  
      DROP TABLE #BANK_VNO                            
                                  
      FETCH NEXT FROM @@VNOCUR                            
      INTO @@BANK_CODE,                            
           @@BOOKTYPE                            
    END                       
                              
  /*   ----------AUTO GENERATION OF LNO -------- */                            
  UPDATE #RECPAY_TABLE                            
 SET    LNO = 2                            
  WHERE  VNO IN (SELECT   VNO                            
                 FROM     #RECPAY_TABLE                             
                 GROUP BY VNO                            
                 HAVING   COUNT(*) = 1)                            
                
              
              
                            
  SET @@LNOCUR = CURSOR FOR SELECT   VNO                            
                            FROM     #RECPAY_TABLE                             
                            GROUP BY VNO                            
                            HAVING   COUNT(*) > 1                            
                              
  OPEN @@LNOCUR                            
                              
  FETCH NEXT FROM @@LNOCUR                            
  INTO @@LNOVNO                            
                              
  WHILE @@FETCH_STATUS = 0                            
    BEGIN                            
      CREATE TABLE [#LNOGEN] (                            
        VNO VARCHAR(12),                            
        SNO INT,                            
        LNO INT   IDENTITY ( 1,1 ))                            
                                  
      INSERT INTO #LNOGEN                            
      SELECT   VNO, SNO                            
      FROM     #RECPAY_TABLE WITH (NOLOCK)                            
      WHERE    VNO = @@LNOVNO                            
      ORDER BY SNO                            
                                  
      UPDATE #RECPAY_TABLE                            
      SET    LNO = L.LNO + 1                            
      FROM   #LNOGEN L    
      WHERE  #RECPAY_TABLE.VNO = L.VNO                            
             AND #RECPAY_TABLE.SNO = L.SNO                            
             AND #RECPAY_TABLE.LNO = 0             
                                  
      DROP TABLE #LNOGEN                            
                                  
      FETCH NEXT FROM @@LNOCUR                            
      INTO @@LNOVNO                            
    END                            
                              
  CLOSE @@LNOCUR                            
                              
  DEALLOCATE @@LNOCUR                            
                              
  /* ----------BEGIN POSTING TO TRANSACTION TABLES -------- */                            
  INSERT INTO LEDGER1                            
             (BNKNAME,                            
              BRNNAME,                            
              DD,                            
     DDNO,                            
              DDDT,                            
              RELDT,                            
              RELAMT,                            
              REFNO,                            
              RECEIPTNO,                            
              VTYP,                            
     VNO,                            
              LNO,                            
     DRCR,                            
              BOOKTYPE,                            
              MICRNO,                            
              SLIPNO,                            
              SLIPDATE,                            
              CHEQUEINNAME,                            
              CHQPRINTED,                            
              CLEAR_MODE)                            
  SELECT   BNKNAME = MAX(BANK_NAME),                            
           BRNNAME = MAX(BRANCH_NAME),                            
           DD = MAX(CHQ_MODE),                            
           DDNO = MAX(REF_NO),                            
           DDDT = MAX(DDDT),                          
           RELDT = '',                            
           RELAMT = SUM(AMOUNT),                            
           REFNO = 0,                            
           RECEIPTNO = 0,                            
           VTYP,                            
           VNO,                            
           LNO = 2,                            
           DRCR,                            
           BOOKTYPE = BOOKTYPE,                           
           MICRNO = MICRNO,                            
           SLIPNO = 0,                            
           SLIPDATE = '',                            
           CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                            
           CHQPRINTED = 0,                            
           CLEAR_MODE = MAX(CL_MODE)                            
  FROM     #RECPAY_TABLE                            
  GROUP BY VTYP,VNO,DRCR,BOOKTYPE,                            
           MICRNO                            
                               
  IF @@ERROR <> 0                            
    BEGIN                              
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE ='DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                   
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                    
    END                            
                                
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/                            
  CREATE TABLE #LEDGER (                            
    VTYP      SMALLINT,                            
    VNO       VARCHAR(12),                            
    EDT       DATETIME,                            
    LNO       SMALLINT,                            
    ACNAME    VARCHAR(100),             
    DRCR      VARCHAR(1),                            
    VAMT      MONEY,                            
    VDT       DATETIME,                            
    VNO1      VARCHAR(12),           
    REFNO     CHAR(12),                            
    BALAMT    MONEY,                            
    NODAYS    INT,                            
    CDT       DATETIME,                            
    CLTCODE   VARCHAR(10),                            
    BOOKTYPE  VARCHAR(2),                            
    ENTEREDBY VARCHAR(25),                            
    PDT       DATETIME,                            
    CHECKEDBY VARCHAR(25),                            
    ACTNODAYS INT,                            
    NARRATION VARCHAR(234))                                
                              
  CREATE TABLE #LEDGER3 (                            
    NARATNO  INT,                            
    NARR     VARCHAR(234),                            
    REFNO    CHAR(12),                            
    VTYP     SMALLINT,                            
    VNO      VARCHAR(12),                            
    BOOKTYPE VARCHAR(2))                            
                              
/*======CLIENT SIDE RECORD======*/                            
  INSERT INTO #LEDGER                      
             (VTYP,                            
              VNO,                            
              EDT,                            
              LNO,                            
              ACNAME,                            
              DRCR,                           
      VAMT,                            
              VDT,                            
              VNO1,                            
              REFNO,                            
              BALAMT,                            
              NODAYS,                            
              CDT,                            
              CLTCODE,                            
              BOOKTYPE,                            
              ENTEREDBY,                            
              PDT,                            
              CHECKEDBY,                            
              ACTNODAYS,                            
              NARRATION)                            
  SELECT VTYP,                            
         VNO,                            
         EDT = (CASE                             
                  WHEN VTYP = 3                            
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                            
                  ELSE EDT                            
                END),                        
         LNO,                            
         ACNAME,                            
         DRCR,                            
         VAMT = AMOUNT,                            
         VDT,                            
         VNO1 = VNO,                            
         REFNO = 0,                            
         BALAMT = AMOUNT,                            
         NODAYS = 0,                            
         CDT = GETDATE(),                            
         CLTCODE = CLIENT_CODE,                            
         BOOKTYPE = BOOKTYPE,                            
         ENTEREDBY = ENTEREDBY,                            
         PDT = GETDATE(),                            
         CHECKEDBY = @UNAME,                            
         ACTNODAYS = 0,                            
         NARRATION                            
  FROM   #RECPAY_TABLE                            
                              
/*======BANK SIDE RECORD======*/                            
  INSERT INTO #LEDGER                            
  SELECT   VTYP,                            
           VNO,                            
           EDT = (CASE                             
                    WHEN VTYP = 3                            
                         AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                            
         ELSE EDT                            
                  END),                            
           LNO = 1,                            
           BANKNAME,                            
           DRCR = (CASE                         
                     WHEN DRCR = 'D' THEN 'C'                            
                     ELSE 'D'                
                   END),                            
           VAMT = SUM(AMOUNT),                            
           VDT,                            
           VNO1 = VNO,                            
           REFNO = 0,                            
           BALAMT = SUM(AMOUNT),                            
           NODAYS = 0,                            
CDT = GETDATE(),                            
           CLTCODE = BANK_CODE,                            
           BOOKTYPE = BOOKTYPE,                            
           ENTEREDBY = ENTEREDBY,                            
           PDT = GETDATE(),                            
           CHECKEDBY = @UNAME,                            
           ACTNODAYS = 0,                            
           NARRATION = MAX(NARRATION)                            
  FROM     #RECPAY_TABLE                            
  GROUP BY VTYP,VNO,EDT,DRCR,                            
           VDT,BANK_CODE,BOOKTYPE,BANKNAME,                            
           ENTEREDBY                            
                              
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/                            
  INSERT INTO LEDGER                            
 (VTYP,                            
              VNO,                            
              EDT,                            
              LNO,                            
              ACNAME,                            
              DRCR,                            
              VAMT,                            
              VDT,                            
              VNO1,                            
              REFNO,                           
              BALAMT,                            
              NODAYS,                            
              CDT,                            
              CLTCODE,                            
              BOOKTYPE,                            
              ENTEREDBY,                            
              PDT,                            
              CHECKEDBY,                            
              ACTNODAYS,                            
              NARRATION)                            
  SELECT   VTYP,                            
           VNO,                            
       EDT,                            
           LNO,                            
           ACNAME,                            
           DRCR,                            
           VAMT,                            
           VDT,                            
           VNO1,                            
           REFNO,                            
           BALAMT,                            
           NODAYS,                            
           CDT,                            
           CLTCODE,           
           BOOKTYPE,                            
           ENTEREDBY,                            
           PDT,                            
           CHECKEDBY,                            
           ACTNODAYS,                            
           NARRATION                            
  FROM     #LEDGER                            
  ORDER BY BOOKTYPE,                            
           VTYP,                            
           VNO,                            
           LNO                            
                                       
  IF @@ERROR <> 0                            
    BEGIN                            
    DROP TABLE #LEDGER                            
    DROP TABLE #LEDGER3                                
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1          
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                  
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
RETURN                   
    END                            
                              
  DROP TABLE #LEDGER                            
                              
/*======BANK SIDE RECORD======*/                            
  INSERT INTO #LEDGER3                            
  SELECT   NARATNO = 1,                            
           NARRATION = MAX(NARRATION),                            
           REFNO = 0,                            
           VTYP,                            
           VNO,                            
           BOOKTYPE                            
  FROM     #RECPAY_TABLE              
  GROUP BY VTYP,VNO,BOOKTYPE                     
                              
/*======CLIENT SIDE RECORD======*/                            
  INSERT INTO #LEDGER3                            
  SELECT NARATNO = LNO,                            
         NARR = NARRATION,                            
         REFNO = 0,                            
         VTYP,                            
         VNO,                            
         BOOKTYPE                            
  FROM   #RECPAY_TABLE                            
                                     
/*======INSERTING ALL LEDGER3 RECORDS AT ONE TIME======*/                            
  INSERT INTO LEDGER3                            
  SELECT   *                            
  FROM     #LEDGER3                            
  ORDER BY BOOKTYPE,                            
           VTYP,                            
   VNO,                            
           NARATNO                            
                                       
  IF @@ERROR <> 0                            
    BEGIN                            
    DROP TABLE #LEDGER3                                
    DROP TABLE #RECPAY_TABLE                            
    ROLLBACK TRAN                    
    SET @ERRORCODE = 1                                     
    SET @MESSAGE = 'PAYMENT DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                   
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                   
    END                            
                              
  DROP TABLE #LEDGER3                            
                              
  IF @@BRANCHFLAG = 1                            
    BEGIN                            
      SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO                            
              FROM     #RECPAY_TABLE                            
                               ORDER BY VNO                            
                                  
      OPEN @@L2CUR                            
                                  
      FETCH NEXT FROM @@L2CUR                            
      INTO @@L2VNO                            
                                  
      WHILE @@FETCH_STATUS = 0                            
        BEGIN                            
          DELETE FROM TEMPLEDGER2                            
          WHERE       SESSIONID = '9999999999'                            
                                      
/*======CLIENT SIDE RECORD======*/                            
          INSERT INTO TEMPLEDGER2                            
          SELECT 'BRANCH',                            
                 C.COSTNAME,                            
                 AMOUNT,                            
                 VTYP,                            
                 VNO,                            
                 LNO,                            
                 DRCR,                            
                 '0',                            
                 BOOKTYPE,                            
                 '9999999999',                    
                 CLIENT_CODE,                            
'A',                            
                 '0'                            
          FROM   #RECPAY_TABLE RP,                            
                 COSTMAST C WITH(NOLOCK)                             
          WHERE  RP.COSTCODE = C.COSTCODE                            
                 AND VNO = @@L2VNO                            
                                      
/*======BANK SIDE RECORD======*/                            
          INSERT INTO TEMPLEDGER2                            
          SELECT   'BRANCH',                            
                   C.COSTNAME,                            
                   SUM(AMOUNT),                            
                   VTYP,                            
                   VNO,                        
                   LNO = 1,                            
                   DRCR = (CASE                             
                             WHEN DRCR = 'D' THEN 'C'                            
                             ELSE 'D'                            
                           END),                            
                   '0',                            
                   BOOKTYPE,                            
                   '9999999999',                            
                   BANK_CODE,                            
                   'A',                            
                   '0'                            
          FROM     #RECPAY_TABLE RP,                            
                   COSTMAST C WITH(NOLOCK)                            
          WHERE    RP.BANKCOST = C.COSTCODE                            
                   AND VNO = @@L2VNO                            
          GROUP BY C.COSTNAME,VTYP,VNO,(CASE                             
                      WHEN DRCR = 'D' THEN 'C'                            
                      ELSE 'D'                            
                    END),                            
                   BANK_CODE,BOOKTYPE                            
                                      
          EXEC INSERTTOLEDGER2                            
            '9999999999' ,                            
            @@L2VNO ,                            
            '1' ,                            
            '1' ,                            
            '1' ,                            
            'BROKER' ,                            
            'BROKER'                            
                                      
 FETCH NEXT FROM @@L2CUR                            
          INTO @@L2VNO                            
        END                            
                                  
      DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)                            
      WHERE       SESSIONID = '9999999999'                            
                            
      IF EXISTS (SELECT *                            
           FROM   DBO.SYSOBJECTS WITH(NOLOCK)                             
           WHERE  ID = OBJECT_ID(N'[THIRDPARTY_COLLECTION]')                            
                  AND OBJECTPROPERTY(ID,N'IsUserTable') = 1)                             
         AND @@VTYP = 3                            
        BEGIN                            
          INSERT INTO THIRDPARTY_COLLECTION                            
(VNO,                            
                      VTYP,                            
                      BOOKTYPE,                            
                      CLTCODE,                            
                      AMOUNT,                            
                      VDT,                            
                      DDNO,                            
 ACCOUNT_NO,                            
                      TPR_FLAG)                            
          SELECT   VNO,                            
                   VTYP,                            
                   BOOKTYPE,                            
                CLIENT_CODE,                            
                   AMOUNT,                            
                   VDT,                            
                   MAX(REF_NO),                            
                   ACC_NO,                          
                   TPR_FLAG = 'S'                            
          FROM     #RECPAY_TABLE                            
          GROUP BY VNO,VTYP,BOOKTYPE,CLIENT_CODE,                            
                   AMOUNT,VDT,ACC_NO                            
                                               
          UPDATE T                            
          SET    TPR_FLAG = 'C'                            
          FROM                     
     THIRDPARTY_COLLECTION T WITH(NOLOCK),                            
                 MULTIBANKID M WITH(NOLOCK),                            
                 #RECPAY_TABLE R                            
          WHERE  T.CLTCODE = M.CLTCODE                            
                 AND M.ACCNO = T.ACCOUNT_NO                            
                 AND T.VNO = R.VNO                            
                 AND T.VTYP = R.VTYP                            
                 AND T.BOOKTYPE = R.BOOKTYPE                            
        END                            
                              
   COMMIT TRANSACTION                            
 END                            
                                
UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES --WITH(ROWLOCK)                             
SET                      
 ROWSTATE = 1,                          
 APPROVALFLAG = 1,                          
 APPROVALDATE = GETDATE(),                          
 APPROVEDBY = 'SYSTEM',                          
 LEDGERVNO = VNO,  
 UPLOADDT = GETDATE()                            
FROM   #RECPAY_TABLE            
WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                            
                                  
                              
DROP TABLE #RECPAY_TABLE                            
SET @ERRORCODE = 0                 
SET @MESSAGE = 'PAYMENT POSTED SUCCESSFULLY'                    
EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 3, @ERRORCODE, @MESSAGE, @UNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD
-- --------------------------------------------------
          
CREATE PROC [dbo].[V2_OFFLINE_RECPAYUPLOAD](                                                              
                                                              
           @UNAME     VARCHAR(25),                                                              
           @USERCAT   INT,                                                              
           @EXCHANGE  VARCHAR(3),                                                              
           @SEGMENT   VARCHAR(10),                                                              
           @IP_VDATE varchar(11),                                            
           @RECOFLAG  CHAR(1) = 'N')                                                              
                                                              
AS                                                              
                                      
SET XACT_ABORT ON                                                              
/*                                                            
V2_OFFLINE_RECPAYUPLOAD 'OFFLINE',1,'NSE','CAPITAL','N'                                                           
*/                                                            
                                                            
                                                            
  SET NOCOUNT ON                                                              
                                                                
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/                                                              
  DECLARE  @@STD_DATE        VARCHAR(11),                                                              
           @@LST_DATE        VARCHAR(11),                                                              
           @@BRANCHFLAG       AS TINYINT,                                                              
           @@VNOFLAG          AS TINYINT,                                                              
           @@VNOMETHOD       INT,                                                              
           @@ACNAME          CHAR(100),                                                              
           @@BOOKTYPE        CHAR(2),                                                              
           @@MICRNO          VARCHAR(10),                                                              
           @@DRCR            VARCHAR(1),                                                              
           @@VTYP            SMALLINT,                                                              
           @@BANK_CODE       VARCHAR(100),                                                              
           @@BACKDAYS        INT,                                                              
           @@BACKDATE        VARCHAR(11),                                                              
           @@BRNCOUNT        TINYINT,                                                              
           @@MonthlyVdt      VARCHAR(11),                                                              
           @@SERIAL_NO       INT,                                                              
           @@COSTCODECOUNT   TINYINT,                                                              
           @@COSTCODEUPDATES CURSOR,                                                              
           @@NEWVNO           AS VARCHAR(12),                                                              
           @@MAXCOUNT         AS INT,                                                              
           @@VDT              AS VARCHAR(11),                                                              
           @@BANKBRANCH       AS VARCHAR(10),                                                              
           @@BANKCOST         AS NUMERIC,                                                              
           @@LNOCUR           AS CURSOR,                                       
           @@VNOCUR           AS CURSOR,                                                   
           @@LNOVNO           AS VARCHAR(12),                                                              
           @@MAXVNO           AS INT,                                                           
           @@L2CUR            AS CURSOR,                                                      
           @@L2VNO            AS VARCHAR(12),                                                            
           @@ERROR_COUNT      AS BIGINT,                                              
           @@FILEEXISTS       AS INT,                                         
           @@SQL              AS VARCHAR(2000),                                           
           @ERRORCODE         AS INT,                                                              
     @MESSAGE           AS VARCHAR(200) ,                                                      
   @@RECPAYTBLCOUNT BIGINT                                                  
                                                                                   
                                          
 SET @@VTYP = 2                                                            
                                                            
BEGIN DISTRIBUTED TRANSACTION                                                              
                                                              
  CREATE TABLE [#RECPAY_TABLE] (                                                           
    SNO    INT   IDENTITY ( 1,1 ),                                                              
    EDATE        VARCHAR(20),                                                              
    VOUCHER_DATE VARCHAR(20),                                                              
    CLIENT_CODE  VARCHAR(50),                                                              
    AMOUNT       MONEY,                                                              
    DRCR         VARCHAR(1),                                             
    NARRATION    VARCHAR(234),                                                              
    BANK_CODE    VARCHAR(10),                                                              
    BANK_NAME    VARCHAR(100),                                                              
    REF_NO       VARCHAR(15),                                                              
    BRANCHCODE   VARCHAR(20),                                                              
    BRANCH_NAME  VARCHAR(50),                                                              
    CHQ_MODE     VARCHAR(1),                                                              
    CHQ_DATE     VARCHAR(20),                                                         
    CHQ_NAME     VARCHAR(100),                                                              
    CL_MODE      VARCHAR(1),                                                              
    FLD_AUTO     BIGINT,                                                       
    ENTEREDBY    VARCHAR(25),                                                              
    VDT          DATETIME   NULL,                                                              
    FYSTART      DATETIME   NULL,                                                        
    FYEND        DATETIME   NULL,                                                              
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),                                                              
    EDT          DATETIME   NULL,                                                              
    DDDT         DATETIME   NULL,                                                              
    VNO          VARCHAR(12)   NULL,                                                              
    VTYP         SMALLINT   NULL,                                                              
    ACNAME       VARCHAR(100)   NULL,                                         
    COSTCODE     SMALLINT   NULL,                                                              
    BANKCOST     SMALLINT   NULL,                                                            
    LNO          SMALLINT   NOT NULL DEFAULT (0),                                                              
    BANKNAME     VARCHAR(100)   NULL,                                                              
    MICRNO       INT   NULL,                                                              
    BOOKTYPE     VARCHAR(2)   NULL,                                                              
    ACC_NO       VARCHAR(20))                                                              
  ON [PRIMARY]                                 
                                                        
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */                                                
  INSERT INTO #RECPAY_TABLE                                                              
             (EDATE,               
              VOUCHER_DATE,                                     
              CLIENT_CODE,                                                              
              AMOUNT,                                 
              DRCR,                                                              
              NARRATION,                                                              
              BANK_CODE,                                                            
              BANK_NAME,                                                              
              REF_NO,                                                              
              BRANCHCODE,                                               
              BRANCH_NAME,                                                              
              CHQ_MODE,                                                              
              CHQ_DATE,                               
              CHQ_NAME,                                                              
              CL_MODE,                                                              
              FLD_AUTO,                                                              
              ENTEREDBY,                                                              
              VDT,                                                               
              EDT,                                                               
              DDDT,                                                              
              ACC_NO,VTYP)                                                              
  SELECT CONVERT(VARCHAR,EDATE,103),                                                              
         CONVERT(VARCHAR,VDATE,103),                                                              
         CLTCODE,                                                 
         CREDITAMT,                                                              
         'C',                                                              
         NARRATION,                                                              
         OPPCODE,                                                              
         BANKNAME,                                                           
         DDNO,                                                              
         'ALL',                                                              
         BRANCHNAME,                                                              
         CHEQUEMODE,                                                              
         CONVERT(VARCHAR,CHEQUEDATE,103),                                                              
         CHEQUENAME,                                                              
         CLEAR_MODE,                                                              
         FLDAUTO,     
         ADDBY,                                                               
         VDATE,                                                               
         EDATE,                                                               
         CHEQUEDATE,                                                     
         TPAccountNumber, VOUCHERTYPE                                                              
  FROM   ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(NOLOCK)                                                   
  WHERE  VOUCHERTYPE = 2                                                              
         AND EXCHANGE = @EXCHANGE                                                              
         AND SEGMENT = @SEGMENT                                                              
         AND ISNULL(ROWSTATE,0) = 0          
   AND ISNULL(APPROVALFLAG,0) = 1                                                        
   AND VDATE LIKE @IP_VDATE + '%'                                             
                                                              
             
                                                        
  SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE                                                      
                                                      
 IF @@RECPAYTBLCOUNT = 0                                                      
 BEGIN                                     
  COMMIT                                                      
  RETURN                                                      
 END                                                      
                                               
                               
                                                
--TRUNCATE table #RECPAY_TABLE                                                
--return                                                      
                                                
                                                   
  UPDATE ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES-- WITH (ROWLOCK)                                                               
  SET    ROWSTATE = 9                                                              
  FROM   #RECPAY_TABLE                                                              
  WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                     
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)                                                              
  FROM   #RECPAY_TABLE                                                              
                                                                       
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),                                                              
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),                                                              
         @@BRANCHFLAG = BRANCHFLAG,                                                              
         @@VNOFLAG = VNOFLAG                                                              
  FROM   PARAMETER WITH(NOLOCK)                                                               
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR                                                              
                                                                                                
  IF @@VNOFLAG <> 0                                                              
    BEGIN                                                              
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)                                     
      FROM   #RECPAY_TABLE                                                              
                                                                           
      IF @@ERROR_COUNT > 1                                                              
        BEGIN                                                              
     DROP TABLE #RECPAY_TABLE                                                                          
     ROLLBACK TRANSACTION                                                    
     SET @ERRORCODE = 1                                                                        
     SET @MESSAGE = 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                                                              
     EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                       
     RETURN                                             
        END                                                              
    END                                                              
                                                              
  IF @@BRANCHFLAG = 1                            
    BEGIN                                                              
      UPDATE #RECPAY_TABLE                                                              
      SET    BRANCHCODE = A.BRANCHCODE,                                                              
             FYSTART = P.SDTCUR,                                                              
           FYEND = P.LDTCUR,                                                              
             UPDFLAG = 'Y',                                                              
             ACNAME = A.LONGNAME,                                                              
             COSTCODE = C.COSTCODE,                                                              
             BANKNAME = B.LONGNAME,                     
             BOOKTYPE = B.BOOKTYPE,                                                              
             MICRNO = ISNULL(B.MICRNO,0)                                                              
      FROM   ACMAST A WITH(NOLOCK),                                                              
             PARAMETER P WITH(NOLOCK),                                                              
            COSTMAST C WITH(NOLOCK),                                                              
             ACMAST B WITH(NOLOCK)                                                              
      WHERE  A.CLTCODE = CLIENT_CODE                    
             AND B.CLTCODE = BANK_CODE                                                              
             --AND P.CURYEAR = 1                                     
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                             
             AND A.ACCAT IN ('3','4','18')                                                              
             AND B.ACCAT = '2'                              
             AND A.BRANCHCODE = COSTNAME                                          
                                                                                              
      UPDATE #RECPAY_TABLE                                                              
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                                                              
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                                                              
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                                                              
             FYSTART = P.SDTCUR,                           
             FYEND = P.LDTCUR,                                                              
             UPDFLAG = 'Y',                                                              
             ACNAME = A.LONGNAME,                                                              
             COSTCODE = (SELECT TOP 1 COSTCODE                                                              
                         FROM   COSTMAST                                                              
    WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),                                                              
             BANKNAME = B.LONGNAME,                                                              
             BOOKTYPE = B.BOOKTYPE,                                                              
             MICRNO = ISNULL(B.MICRNO,0)                                                              
      FROM   ACMAST A WITH(NOLOCK),                      
             PARAMETER P WITH(NOLOCK),                                                              
             COSTMAST C WITH(NOLOCK),                                                              
             ACMAST B WITH(NOLOCK)                                                              
      WHERE  A.CLTCODE = CLIENT_CODE                                                    
             AND B.CLTCODE = BANK_CODE                                                 
             --AND P.CURYEAR = 1                                     
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                      
             AND A.ACCAT IN ('3','4','18')                                                              
             AND B.ACCAT = '2'                                                              
             AND A.BRANCHCODE = 'ALL'                            
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                                                              
                                                                                                           
      UPDATE #RECPAY_TABLE                                  
      SET    BRANCHCODE = 'HO',                                                              
           VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                                                              
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                                                              
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                            
             FYSTART = P.SDTCUR,                                                              
             FYEND = P.LDTCUR,                                                              
             UPDFLAG = 'Y',                                                              
             ACNAME = A.LONGNAME,                                                              
             COSTCODE = (SELECT TOP 1 COSTCODE                                                              
                         FROM   COSTMAST                                                              
             WHERE  COSTNAME = 'HO'),                                                              
             BANKNAME = B.LONGNAME,                                                              
             BOOKTYPE = B.BOOKTYPE,                                                              
             MICRNO = ISNULL(B.MICRNO,0)                                                              
      FROM   ACMAST A WITH(NOLOCK),                                                              
       PARAMETER P WITH(NOLOCK),                                                              
             COSTMAST C WITH(NOLOCK),                                                              
             ACMAST B WITH(NOLOCK)                                                              
      WHERE  A.CLTCODE = CLIENT_CODE                      
             AND B.CLTCODE = BANK_CODE                                                              
             --AND P.CURYEAR = 1                                     
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                             
             AND A.ACCAT IN ('3','4','18')                                                              
            AND B.ACCAT = '2'                                                              
             AND A.BRANCHCODE = 'ALL'                                                              
             AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                                                              
    END                                                              
  ELSE                                                         
    BEGIN              
      UPDATE #RECPAY_TABLE                                                              
      SET    FYSTART = @@STD_DATE,                                                              
             FYEND = @@LST_DATE + ' 23:59:59',                                                              
             UPDFLAG = 'Y',                                                    
             ACNAME = A.LONGNAME,                                                              
             BANKNAME = B.LONGNAME,                                              
             BOOKTYPE = B.BOOKTYPE,                                                              
             MICRNO = ISNULL(B.MICRNO,0)                                                              
      FROM   ACMAST A WITH(NOLOCK),                                                              
             ACMAST B WITH(NOLOCK)                                                              
      WHERE  A.CLTCODE = CLIENT_CODE                                                          
             AND B.CLTCODE = BANK_CODE                                                              
             AND A.ACCAT IN ('3','4','18')                                                              
             AND B.ACCAT = '2'                                                              
    END                                                              
                                                                  
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */                                                              
  SELECT @@ERROR_COUNT = COUNT(SNO)                                                              
  FROM   #RECPAY_TABLE                                                              
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND                                                              
                                                              
  IF @@ERROR_COUNT > 0                                                        
    BEGIN                                                           
    DROP TABLE #RECPAY_TABLE                                             
    ROLLBACK TRAN                                                           
    SET @ERRORCODE = 1                                                                       
    SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'                                                 
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                        
    RETURN                                                              
    END                                                              
                                              
  SET @@ERROR_COUNT = 0                                                              
                                                                
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/                                                              
  SELECT @@ERROR_COUNT = COUNT(1)                                                              
  FROM   #RECPAY_TABLE                         
  WHERE  VDT > EDT                                                              
                                                                
  IF @@ERROR_COUNT > 0                                                              
    BEGIN                                                            
    DROP TABLE #RECPAY_TABLE                                                              
    ROLLBACK TRAN                                                       
    SET @ERRORCODE = 1                                                                       
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                                                     
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                          
    RETURN                                     
    END                                                              
            /*----------VALIDATION FOR ZERO AMOUNT --------*/                                                              
  SELECT @@ERROR_COUNT = COUNT(1)                                                              
  FROM   #RECPAY_TABLE                                                              
  WHERE  AMOUNT <= 0                                                              
                                                       
  IF @@ERROR_COUNT > 0                     
    BEGIN                                                               
    DROP TABLE #RECPAY_TABLE                                                              
    ROLLBACK TRAN                                                      
    SET @ERRORCODE = 1                                                                       
    SET @MESSAGE ='VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                                                     
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                          
 RETURN                                         
    END                                                              
                                                       
  /*   ----------VALIDATION FOR CHEQUE NUMBER -------- */                                                              
  SELECT @@ERROR_COUNT = COUNT(1)                                                              
  FROM   (SELECT DISTINCT DDNO = RP.REF_NO,                                                              
                          CLTCODE = RP.CLIENT_CODE                                                              
   FROM   #RECPAY_TABLE RP,                                      
                 LEDGER L WITH(NOLOCK),                                                              
                 LEDGER1 L1 WITH(NOLOCK)                                                              
          WHERE  L1.DDNO = RP.REF_NO                                                              
                 AND L1.DD = RP.CHQ_MODE                                                              
                 AND L1.DRCR = @@DRCR                                                    
                 AND L1.VTYP = @@VTYP                                                              
                 AND RP.REF_NO <> '0'                                                              
                 AND L.VTYP = @@VTYP                                                              
                 AND L.VNO = L1.VNO                                                              
                 AND L.BOOKTYPE = L1.BOOKTYPE                                                              
                 AND L.DRCR = @@DRCR                                                              
                 AND L.CLTCODE = RP.CLIENT_CODE) A                     
                                                                
  IF @@ERROR_COUNT > 0                                          
    BEGIN                                                              
    DROP TABLE #RECPAY_TABLE                                                              
    ROLLBACK TRAN                                                      
    SET @ERRORCODE = 1                
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CHEQUE NUMBERS ALREADY EXISTS'                                                    
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                  
    RETURN                                                     
    END                                                              
                                                                
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/                                                              
  SELECT @@ERROR_COUNT = COUNT(1)                                                              
  FROM   (SELECT DISTINCT CLIENT_CODE                                                              
          FROM   #RECPAY_TABLE                                                              
          WHERE  UPDFLAG = 'N') A                                                              
                                       
  IF @@ERROR_COUNT > 0                                                              
    BEGIN                                                              
    DROP TABLE #RECPAY_TABLE                                                              
   ROLLBACK TRAN                                                     
    SET @ERRORCODE = 1                                                                       
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'                                                     
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                          
    RETURN                                                         
    END
    
      /*   ----------VALIDATION FOR INACTIVE CLIENT CODES -------- */     

           
    SELECT @@ERROR_COUNT = COUNT(1)
             
    FROM   (SELECT DISTINCT RP.CLIENT_CODE         
            FROM   #RECPAY_TABLE RP,         
                   CLIENT5 C WITH(NOLOCK)         
            WHERE C.INACTIVEFROM < GETDATE()     
                   AND C.CL_CODE = RP.CLIENT_CODE) A         
        
    IF @@ERROR_COUNT > 0         
      BEGIN         
          DROP TABLE #RECPAY_TABLE         
        
          ROLLBACK TRAN         
        
          SET @ERRORCODE = 1         
          SET @MESSAGE =         
          'DATA CANNOT BE UPLOADED AS THE SOME CLIENTS ARE INACTIVE'         
        
          EXEC V2_OFFLINE_UPLOAD_PUTLOG         
            @EXCHANGE,         
            @SEGMENT,         
            2,         
            @ERRORCODE,         
            @MESSAGE,         
            @UNAME         
        
          RETURN         
  END                                      
                                                          
  /*    ----------AUTO GENERATION OF VNO -------- */                                                              
  SET @@VNOCUR = CURSOR FOR SELECT DISTINCT BANK_CODE,                                                              
         BOOKTYPE                                                              
                            FROM   #RECPAY_TABLE WITH (NOLOCK)                                                           
                                                                
  OPEN @@VNOCUR                                                              
                                                                
  FETCH NEXT FROM @@VNOCUR                                                              
  INTO @@BANK_CODE,                                                              
       @@BOOKTYPE                                         
                                                                
  WHILE @@FETCH_STATUS = 0                                                              
    BEGIN                                                              
      IF @@BRANCHFLAG = 1                                                              
        BEGIN                                                              
          SELECT @@BANKBRANCH = BRANCHCODE,                                                              
                 @@BANKCOST = ISNULL(C.COSTCODE,-1)                                                              
          FROM   ACMAST A WITH(NOLOCK)                                       
                 LEFT OUTER JOIN COSTMAST C WITH(NOLOCK)                                     
                   ON (A.BRANCHCODE = C.COSTNAME)                                                              
  WHERE  A.CLTCODE = @@BANK_CODE                                                              
                                                                        
          IF @@BANKBRANCH <> 'ALL'                                                              
            BEGIN                                                              
              UPDATE RP                                                              
              SET    COSTCODE = @@BANKCOST                                  
              FROM   #RECPAY_TABLE RP,                                                              
                     ACMAST A WITH(NOLOCK)                                                              
              WHERE  A.CLTCODE = RP.CLIENT_CODE                                                              
                     AND A.BRANCHCODE = 'ALL'                                                              
                                                                            
              UPDATE #RECPAY_TABLE               
              SET    BANKCOST = @@BANKCOST                                                              
              WHERE  BANK_CODE = @@BANK_CODE                                                              
        END                                                              
          ELSE                                                              
            BEGIN                                                              
              UPDATE #RECPAY_TABLE                                                              
              SET    COSTCODE = (SELECT TOP 1 COSTCODE                                                              
                                 FROM   COSTMAST WITH(NOLOCK)                               
                                 WHERE  COSTNAME = 'HO')                                                              
              WHERE  COSTCODE = ''                                        
                     AND BANK_CODE = @@BANK_CODE                                            
                                                                            
              SET @@COSTCODEUPDATES = CURSOR FOR SELECT   SNO,                                                          
                                                          COUNT(DISTINCT COSTCODE)                                                              
                                                 FROM     #RECPAY_TABLE                                                               
         WHERE    BANK_CODE = @@BANK_CODE                                                              
                                                 GROUP BY SNO                                                              
                                                 HAVING   COUNT(DISTINCT COSTCODE) > 1                                             
                                           
              OPEN @@COSTCODEUPDATES                                                              
                                                                            
              FETCH NEXT FROM @@COSTCODEUPDATES                                                              
              INTO @@SERIAL_NO,                                                              
                @@COSTCODECOUNT                                                              
                                                 
              WHILE @@FETCH_STATUS = 0                                                              
                BEGIN                                                              
                  UPDATE #RECPAY_TABLE                                                              
                  SET    BANKCOST = (SELECT TOP 1 COSTCODE                                                              
                            FROM   COSTMAST WITH(NOLOCK)                                                              
                                     WHERE  COSTNAME = 'HO')                                                              
                WHERE  (BANKCOST = ''                                       
                           OR BANKCOST IS NULL)                                                              
                         AND BANK_CODE = @@BANK_CODE                                               
                         AND SNO = @@SERIAL_NO                                                              
                                                                                
                  FETCH NEXT FROM @@COSTCODEUPDATES                                                              
                  INTO @@SERIAL_NO,                                                              
         @@COSTCODECOUNT                                        
               END                                                              
                                                                            
              CLOSE @@COSTCODEUPDATES                    
                                       
              DEALLOCATE @@COSTCODEUPDATES                                                                                                          
              UPDATE #RECPAY_TABLE                                                              
              SET    BANKCOST = COSTCODE                                                              
              WHERE  BANK_CODE = @@BANK_CODE                                                              
                     AND (BANKCOST = ''                                                              
           OR BANKCOST IS NULL)                                                             
END                                                              
        END           
                          
      CREATE TABLE #BANK_VNO (                                                              
        SRNO    INT,                                                              
        NEWSRNO INT   IDENTITY ( 1,1 ))                                                              
                                                                    
      INSERT INTO #BANK_VNO                                                              
      SELECT DISTINCT SNO                                                              
      FROM   #RECPAY_TABLE                                         
      WHERE  BANK_CODE = @@BANK_CODE                                                              
             AND BOOKTYPE = @@BOOKTYPE                                                              
                  
      SELECT @@MAXCOUNT = COUNT(DISTINCT SNO)                                                              
      FROM   #RECPAY_TABLE                                                              
                                                                           
      SELECT TOP 1 @@VDT = VDT                                                 
      FROM   #RECPAY_TABLE                                                              
                                                                    
      SELECT LASTVNO                                                              
      INTO   #VNO                                                              
      FROM   LASTVNO WITH(NOLOCK)                                                              
      WHERE  1 = 2                                                              
                                    SELECT @@MAXVNO = MAX(NEWSRNO)           
      FROM   #BANK_VNO                                                              
                                                             
                                                            
                                           
                                                
      INSERT INTO #VNO                                                              
      EXEC ACC_GENVNO_NEW                                                              
        @@VDT ,                                                              
    @@VTYP ,                                                              
 @@BOOKTYPE ,                                                              
       @@STD_DATE ,        
        @@LST_DATE ,                                                              
        @@MAXVNO                                                              
                                                                    
      SELECT @@NEWVNO = LASTVNO                                                              
      FROM   #VNO                                                          
                                                                    
      UPDATE RP                                                              
      SET    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                                                              
      FROM   #RECPAY_TABLE RP,                                                              
             #BANK_VNO BV      
      WHERE  RP.SNO = BV.SRNO                                                              
                                                                    
                                                 
                                                
      DROP TABLE #VNO                  
                                                                    
      DROP TABLE #BANK_VNO                                                              
                                                                    
      FETCH NEXT FROM @@VNOCUR                                         
      INTO @@BANK_CODE,                                                              
           @@BOOKTYPE                             
    END          
        
                                                     
                                                                
  /*   ----------AUTO GENERATION OF LNO -------- */                                                              
  UPDATE #RECPAY_TABLE                                                              
 SET    LNO = 2                                                              
  WHERE  VNO IN (SELECT   VNO                                                              
                 FROM     #RECPAY_TABLE                                                               
                 GROUP BY VNO                                                              
                 HAVING   COUNT(*) = 1)                                                              
                                                  
                                                
                                                
                                                              
  SET @@LNOCUR = CURSOR FOR SELECT   VNO                                                   
                            FROM     #RECPAY_TABLE                                                               
                            GROUP BY VNO                                                              
                            HAVING   COUNT(*) > 1                                                       
                                                     
  OPEN @@LNOCUR                                                              
                                                                
  FETCH NEXT FROM @@LNOCUR                                                              
  INTO @@LNOVNO                                                              
                                                                
  WHILE @@FETCH_STATUS = 0                                                              
    BEGIN                                                              
      CREATE TABLE [#LNOGEN] (                                                              
        VNO VARCHAR(12),                                   
        SNO INT,                                                              
        LNO INT   IDENTITY ( 1,1 ))                                                              
                                                                    
      INSERT INTO #LNOGEN                      
      SELECT   VNO, SNO                                                              
      FROM     #RECPAY_TABLE WITH (NOLOCK)                                          
      WHERE    VNO = @@LNOVNO                                                              
  ORDER BY SNO                                                              
                                                                    
      UPDATE #RECPAY_TABLE                                                              
      SET    LNO = L.LNO + 1                                                          
      FROM   #LNOGEN L                                                     
      WHERE  #RECPAY_TABLE.VNO = L.VNO                                                              
             AND #RECPAY_TABLE.SNO = L.SNO                                                              
             AND #RECPAY_TABLE.LNO = 0                                                            
                                                                    
      DROP TABLE #LNOGEN                                                              
                                                                    
      FETCH NEXT FROM @@LNOCUR                                                              
      INTO @@LNOVNO                                                              
    END                 
                        
  CLOSE @@LNOCUR                                                              
                                                                
  DEALLOCATE @@LNOCUR                                                              
                                                                
  /* ----------BEGIN POSTING TO TRANSACTION TABLES -------- */                                                        
  INSERT INTO LEDGER1                                                              
        (BNKNAME,                                                              
              BRNNAME,                                                              
              DD,                                                              
     DDNO,                                                              
              DDDT,                                                              
              RELDT,                                                              
              RELAMT,                                                              
              REFNO,                                                              
              RECEIPTNO,                                   
   VTYP,                                                              
              VNO,                                                              
              LNO,                                             
     DRCR,                                                              
              BOOKTYPE,                                                              
              MICRNO,                                                              
              SLIPNO,                                                              
              SLIPDATE,                                                              
              CHEQUEINNAME,                                                              
              CHQPRINTED,                                                              
              CLEAR_MODE)                                                              
  SELECT   BNKNAME = MAX(BANK_NAME),                                                              
           BRNNAME = MAX(BRANCH_NAME),                                                              
           DD = MAX(CHQ_MODE),                                                              
           DDNO = MAX(REF_NO),                                                              
           DDDT = MAX(DDDT),                                                            
           RELDT = '',                                                 
           RELAMT = SUM(AMOUNT),                                                     
           REFNO = 0,                                                              
           RECEIPTNO = 0,                                                              
    VTYP,                                                              
           VNO,                                                              
           LNO = 2,                                                              
           DRCR,                                                              
           BOOKTYPE = BOOKTYPE,                                                             
           MICRNO = MICRNO,                                                              
           SLIPNO = 0,                                                              
           SLIPDATE = '',                                                              
           CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                                                         
           CHQPRINTED = 0,                                               CLEAR_MODE = MAX(CL_MODE)                                                              
  FROM     #RECPAY_TABLE                                                              
  GROUP BY VTYP,VNO,DRCR,BOOKTYPE,                                                              
           MICRNO                                                              
                                                                 
  IF @@ERROR <> 0                                                              
    BEGIN                                                                
    DROP TABLE #RECPAY_TABLE                                                              
    ROLLBACK TRAN                                                      
    SET @ERRORCODE = 1                                                                       
    SET @MESSAGE ='DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                                                     
   EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                          
    RETURN                                                      
    END                                                              
                                                                
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/                                                
  CREATE TABLE #LEDGER (                                                              
    VTYP      SMALLINT,                                                              
    VNO       VARCHAR(12),                                                              
    EDT       DATETIME,                                                              
    LNO       SMALLINT,                                                            
    ACNAME    VARCHAR(100),                                                              
    DRCR      VARCHAR(1),                                                              
    VAMT      MONEY,                                                              
    VDT       DATETIME,                               
    VNO1      VARCHAR(12),                                                              
    REFNO     CHAR(12),                                                              
    BALAMT    MONEY,                                                 
    NODAYS    INT,                                                              
    CDT       DATETIME,                                                              
    CLTCODE   VARCHAR(10),                                                              
    BOOKTYPE  VARCHAR(2),                                                              
    ENTEREDBY VARCHAR(25),                                                              
    PDT       DATETIME,                             
    CHECKEDBY VARCHAR(25),                                                              
    ACTNODAYS INT,                                                              
    NARRATION VARCHAR(234))                                                                  
            
  CREATE TABLE #LEDGER3 (                                                              
    NARATNO  INT,                                                              
    NARR     VARCHAR(234),                                                              
    REFNO    CHAR(12),                                       
    VTYP     SMALLINT,                                                              
    VNO      VARCHAR(12),                                                              
    BOOKTYPE VARCHAR(2))            
            
                                                         
    --PRINT 'SURESH'                                                            
/*======CLIENT SIDE RECORD======*/                                                              
  INSERT INTO #LEDGER                                        
             (VTYP,                                                              
              VNO,                                                             
              EDT,                                    
              LNO,                                                              
              ACNAME,                                                              
              DRCR,                                                             
      VAMT,                        
              VDT,                                             
              VNO1,                                                              
              REFNO,                                                              
              BALAMT,                                                              
              NODAYS,                                                              
              CDT,                                                              
      CLTCODE,                                                              
              BOOKTYPE,                                                              
              ENTEREDBY,                                                  
              PDT,                                                              
              CHECKEDBY,                                                              
              ACTNODAYS,                                                              
              NARRATION)                                                   
  SELECT VTYP,                                                              
         VNO,                                                              
         EDT = (CASE                                                               
                  WHEN VTYP = 2                                                              
   AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                                                              
                  ELSE EDT                                                              
                END),                                           
         LNO,                                                              
         ACNAME,                                                              
     DRCR,                                                              
         VAMT = AMOUNT,                                                        
         VDT,                                                              
         VNO1 = VNO,                                                              
         REFNO = 0,                                                              
         BALAMT = AMOUNT,                                                              
         NODAYS = 0,                                                              
         CDT = GETDATE(),                                      
         CLTCODE = CLIENT_CODE,                                                              
         BOOKTYPE = BOOKTYPE,                                                              
         ENTEREDBY = ENTEREDBY,                                                              
         PDT = GETDATE(),                                                              
         CHECKEDBY = @UNAME,                                                              
         ACTNODAYS = 0,                                                              
         NARRATION                                                              
  FROM   #RECPAY_TABLE              
            
        
        
        
        
                                                                
/*======BANK SIDE RECORD======*/                                                              
  INSERT INTO #LEDGER                                                              
  SELECT   VTYP,                                                              
           VNO,                                                              
           EDT = (CASE        
                    WHEN VTYP = 2                                                              
       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                                                              
                    ELSE EDT                                                          
                  END),                                                              
           LNO = 1,                                                              
           BANKNAME,                                                              
           DRCR = (CASE                                                               
                     WHEN DRCR = 'D' THEN 'C'                                                              
                     ELSE 'D'                                                  
                   END),             
           VAMT = SUM(AMOUNT),                                                              
           VDT,                                                              
           VNO1 = VNO,                                                              
           REFNO = 0,                                                              
           BALAMT = SUM(AMOUNT),                                                              
NODAYS = 0,                                                              
CDT = GETDATE(),                                                              
           CLTCODE = BANK_CODE,                                                              
           BOOKTYPE = BOOKTYPE,                                                              
           ENTEREDBY = ENTEREDBY,                                                              
           PDT = GETDATE(),                                                              
CHECKEDBY = @UNAME,                                              
           ACTNODAYS = 0,                                                              
 NARRATION = MAX(NARRATION)                                        
  FROM     #RECPAY_TABLE                                                              
  GROUP BY VTYP,VNO,EDT,DRCR,                                                              
           VDT,BANK_CODE,BOOKTYPE,BANKNAME,                                                              
           ENTEREDBY               
--PRINT 'NIKHIL'            
                              
                                                                
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/                                                              
  INSERT INTO LEDGER                                         
             (VTYP,                                                              
              VNO,                                                              
              EDT,                                             
              LNO,                                                              
              ACNAME,                                                              
              DRCR,                                                              
              VAMT,                                                              
              VDT,                                                              
              VNO1,                                                              
              REFNO,                                                             
              BALAMT,                                                            
          NODAYS,                                                              
              CDT,                                                              
              CLTCODE,                                                              
              BOOKTYPE,                     
              ENTEREDBY,                                                              
              PDT,                                                              
              CHECKEDBY,                   
              ACTNODAYS,                
 NARRATION)                                                              
  SELECT   VTYP,                                                              
           VNO,                                                              
       EDT,                                                              
           LNO,                                                              
           ACNAME,                                                              
           DRCR,                                                              
           VAMT,                                                              
           VDT,                                                              
           VNO1,                                                              
           REFNO,                                                              
           BALAMT,                        
           NODAYS,                                                              
           CDT,                                                              
           CLTCODE,                                             
           BOOKTYPE,                          
           ENTEREDBY,                                                              
           PDT,                                                              
           CHECKEDBY,          
           ACTNODAYS,                                                              
           NARRATION                                                              
  FROM     #LEDGER                                                              
  ORDER BY BOOKTYPE,                                 
           VTYP,                                                              
           VNO,                                                              
           LNO              
            
PRINT 'ANI'                                                            
                                                                         
  IF @@ERROR <> 0                                                              
    BEGIN                                                              
    DROP TABLE #LEDGER                                                              
    DROP TABLE #LEDGER3                                                                  
    DROP TABLE #RECPAY_TABLE                                                              
    ROLLBACK TRAN                             
    SET @ERRORCODE = 1                                                                       
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                                 
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                               
    RETURN                                               
    END                                                              
                                                                
  DROP TABLE #LEDGER                                                              
                                      
/*======BANK SIDE RECORD======*/                                                              
  INSERT INTO #LEDGER3                                                              
  SELECT   NARATNO = 1,                                                              
           NARRATION = MAX(NARRATION),                                                              
           REFNO = 0,                                                              
           VTYP,                                                              
           VNO,                                                              
           BOOKTYPE                                                              
  FROM     #RECPAY_TABLE                                                
  GROUP BY VTYP,VNO,BOOKTYPE                                                       
                                                                
/*======CLIENT SIDE RECORD======*/                                              
  INSERT INTO #LEDGER3                                                              
  SELECT NARATNO = LNO,                                                              
         NARR = NARRATION,                                                    
         REFNO = 0,                                                              
         VTYP,                                                              
VNO,                                                              
         BOOKTYPE                                                              
  FROM   #RECPAY_TABLE                                                              
                                                                       
/*======INSERTING ALL LEDGER3 RECORDS AT ONE TIME======*/                                                              
  INSERT INTO LEDGER3                                                              
  SELECT   *                                                              
  FROM     #LEDGER3                                                              
  ORDER BY BOOKTYPE,                                                              
    VTYP,                                                              
           VNO,                                                              
           NARATNO                                                              
                                                                         
  IF @@ERROR <> 0                                                          
    BEGIN                 
    DROP TABLE #LEDGER3                                                                  
    DROP TABLE #RECPAY_TABLE                                                              
    ROLLBACK TRAN                                                      
    SET @ERRORCODE = 1                                                                       
    SET @MESSAGE = 'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                                                     
    EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                          
    RETURN                                                     
    END                                                                                                        
  DROP TABLE #LEDGER3                                                              
                                                                
  IF @@BRANCHFLAG = 1                                                              
    BEGIN                                                              
      SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO                                                              
              FROM     #RECPAY_TABLE                                                              
         ORDER BY VNO                                                              
                                               
      OPEN @@L2CUR                                                              
                                                                    
      FETCH NEXT FROM @@L2CUR                                                              
      INTO @@L2VNO                 
                                                                  
      WHILE @@FETCH_STATUS = 0                                                    BEGIN                                                              
          DELETE FROM TEMPLEDGER2                                                              
          WHERE       SESSIONID = '9999999999'                                                              
                                                                        
/*======CLIENT SIDE RECORD======*/                                                              
          INSERT INTO TEMPLEDGER2                                                              
          SELECT 'BRANCH',                                                              
                 C.COSTNAME,                                           
                 AMOUNT,                                                              
                 VTYP,                                                              
                 VNO,                                           
                 LNO,                                                              
                 DRCR,                                                              
                 '0',                           
    BOOKTYPE,                                                              
                 '9999999999',                                                              
                 CLIENT_CODE,                                                              
'A',                                                              
                 '0'                                                              
          FROM   #RECPAY_TABLE RP,                                                              
                 COSTMAST C WITH(NOLOCK)                                                               
          WHERE  RP.COSTCODE = C.COSTCODE                                                              
                 AND VNO = @@L2VNO                                                              
                                                     
/*======BANK SIDE RECORD======*/                                                              
          INSERT INTO TEMPLEDGER2                                                              
          SELECT   'BRANCH',                                                              
                   C.COSTNAME,                                                              
                   SUM(AMOUNT),                                                              
                   VTYP,                                                              
           VNO,                                                          
                   LNO = 1,                                                              
                   DRCR = (CASE                                                               
                             WHEN DRCR = 'D' THEN 'C'                                                              
                       ELSE 'D'                                                              
                           END),                                                              
                   '0',                                                              
                   BOOKTYPE,                                  
                   '9999999999',                                                              
                   BANK_CODE,                                                              
                   'A',                                                              
                   '0'                                                              
          FROM     #RECPAY_TABLE RP,                                                              
                   COSTMAST C WITH(NOLOCK)                                
          WHERE    RP.BANKCOST = C.COSTCODE                                                              
    AND VNO = @@L2VNO                                            
          GROUP BY C.COSTNAME,VTYP,VNO,(CASE                                                               
                   WHEN DRCR = 'D' THEN 'C'                                                              
                      ELSE 'D'                                                              
                    END),                                                              
      BANK_CODE,BOOKTYPE                                                              
                                                                        
          EXEC INSERTTOLEDGER2                                                              
            '9999999999' ,                                                              
            @@L2VNO ,                                              
            '1' ,                                                              
       '1' ,                                                              
            '1' ,                                                              
            'BROKER' ,                                                              
            'BROKER'                                                              
                            
 FETCH NEXT FROM @@L2CUR                                                              
          INTO @@L2VNO                                                              
        END                                    
                                                                    
     DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)                                                              
      WHERE       SESSIONID = '9999999999'                                                              
                                
      IF EXISTS (SELECT *                                                              
           FROM   DBO.SYSOBJECTS WITH(NOLOCK)                                                               
           WHERE  ID = OBJECT_ID(N'[THIRDPARTY_COLLECTION]')                                                              
                  AND OBJECTPROPERTY(ID,N'IsUserTable') = 1)                                                         
         AND @@VTYP = 2                                                              
        BEGIN                                                              
          INSERT INTO THIRDPARTY_COLLECTION                                        
(VNO,                                                              
                      VTYP,                                                              
                      BOOKTYPE,                                                              
                      CLTCODE,                                                              
                      AMOUNT,                                                              
                      VDT,                           
                      DDNO,                               
 ACCOUNT_NO,                                                              
                      TPR_FLAG)                                                              
          SELECT   VNO,                                                              
                   VTYP,                          
                   BOOKTYPE,                                                              
                   CLIENT_CODE,                                                              
                   AMOUNT,                                                              
                   VDT,                                 
                   MAX(REF_NO),                                                              
                   ACC_NO,                                                              
                   TPR_FLAG = 'S'                                 
          FROM     #RECPAY_TABLE                                                              
          GROUP BY VNO,VTYP,BOOKTYPE,CLIENT_CODE,         
                   AMOUNT,VDT,ACC_NO                                                              
                                                                                 
          UPDATE T                                                              
          SET    TPR_FLAG = 'C'                                                              
          FROM                                         
     THIRDPARTY_COLLECTION T WITH(NOLOCK),                                                              
                 MULTIBANKID M WITH(NOLOCK),                                                              
                 #RECPAY_TABLE R                                                              
          WHERE  T.CLTCODE = M.CLTCODE                                                              
                 AND M.ACCNO = T.ACCOUNT_NO                                                              
                 AND T.VNO = R.VNO                                                   
                 AND T.VTYP = R.VTYP                                                              
                 AND T.BOOKTYPE = R.BOOKTYPE                                                              
        END                                                              
                                                                
   COMMIT TRANSACTION                                                              
 END                                                              
                                             
UPDATE ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES --WITH(ROWLOCK)                            
SET                                                        
 ROWSTATE = 1,                                                            
 APPROVALFLAG = 1,                           
 APPROVALDATE = GETDATE(),                                                            
-- APPROVEDBY = 'SYSTEM',                                                            
 LEDGERVNO = VNO                                                              
FROM   #RECPAY_TABLE                                              
WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                                              
                                                                    
                                             
DROP TABLE #RECPAY_TABLE                                         
SET @ERRORCODE = 0                                                                       
SET @MESSAGE = 'POSTED SUCCESSFULLY'            
EXEC ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                       
                                      
                                      
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD_09032011
-- --------------------------------------------------
            
CREATE PROC [DBO].[V2_OFFLINE_RECPAYUPLOAD_09032011](                                                      
                                                      
           @UNAME     VARCHAR(25),                                                      
           @USERCAT   INT,                                                      
           @EXCHANGE  VARCHAR(3),                                                      
           @SEGMENT   VARCHAR(10),                                                      
     @IP_VDATE varchar(11),                                    
           @RECOFLAG  CHAR(1) = 'N')                                                      
                                                      
AS                                                      
                              
SET XACT_ABORT ON                                                      
/*                                                    
V2_OFFLINE_RECPAYUPLOAD 'OFFLINE',1,'NSE','CAPITAL','N'                                                   
*/                                                    
                                                    
                                                    
  SET NOCOUNT ON                                                      
                                                        
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/                                                      
  DECLARE  @@STD_DATE        VARCHAR(11),                                                      
           @@LST_DATE        VARCHAR(11),                                                      
           @@BRANCHFLAG       AS TINYINT,                                                      
           @@VNOFLAG          AS TINYINT,                                                      
           @@VNOMETHOD       INT,                                                      
           @@ACNAME          CHAR(100),                                                      
           @@BOOKTYPE        CHAR(2),                                                      
           @@MICRNO          VARCHAR(10),                                                      
           @@DRCR            VARCHAR(1),                                                      
           @@VTYP            SMALLINT,                                                      
           @@BANK_CODE       VARCHAR(100),                                                      
           @@BACKDAYS        INT,                                                      
           @@BACKDATE        VARCHAR(11),                                                      
           @@BRNCOUNT        TINYINT,                                                      
           @@MonthlyVdt      VARCHAR(11),                                                      
           @@SERIAL_NO       INT,                                                      
           @@COSTCODECOUNT   TINYINT,                                                      
           @@COSTCODEUPDATES CURSOR,                                                      
           @@NEWVNO           AS VARCHAR(12),                                                      
           @@MAXCOUNT         AS INT,                                                      
           @@VDT              AS VARCHAR(11),                                                      
           @@BANKBRANCH       AS VARCHAR(10),                                                      
           @@BANKCOST         AS NUMERIC,                                                      
           @@LNOCUR           AS CURSOR,                                                      
           @@VNOCUR           AS CURSOR,                                                      
           @@LNOVNO           AS VARCHAR(12),                                                      
           @@MAXVNO           AS INT,                                                      
           @@L2CUR            AS CURSOR,                                                      
           @@L2VNO            AS VARCHAR(12),                                                      
           @@ERROR_COUNT      AS BIGINT,                                                      
           @@FILEEXISTS       AS INT,                                           
           @@SQL              AS VARCHAR(2000),                                  
           @ERRORCODE         AS INT,                                                      
           @MESSAGE           AS VARCHAR(200) ,                                              
   @@RECPAYTBLCOUNT BIGINT                                              
                                                                           
                                    
 SET @@VTYP = 2                                                    
                                                    
BEGIN TRAN                                                      
                                                      
  CREATE TABLE [#RECPAY_TABLE] (                                                   
    SNO    INT   IDENTITY ( 1,1 ),                                                      
    EDATE        VARCHAR(20),                                                      
    VOUCHER_DATE VARCHAR(20),                                                      
    CLIENT_CODE  VARCHAR(50),                                                      
    AMOUNT       MONEY,                                                      
    DRCR         VARCHAR(1),                                     
    NARRATION    VARCHAR(234),                                                      
    BANK_CODE    VARCHAR(10),                                                      
  BANK_NAME    VARCHAR(100),                                                      
    REF_NO       VARCHAR(15),                                                      
    BRANCHCODE   VARCHAR(20),                                                      
    BRANCH_NAME  VARCHAR(50),                                                      
    CHQ_MODE     VARCHAR(1),                                                      
    CHQ_DATE     VARCHAR(20),                                                 
    CHQ_NAME     VARCHAR(100),                                                      
    CL_MODE      VARCHAR(1),                                                      
    FLD_AUTO     BIGINT,                                               
    ENTEREDBY    VARCHAR(25),                                                      
    VDT          DATETIME   NULL,                                                      
    FYSTART      DATETIME   NULL,                                                
    FYEND        DATETIME   NULL,                                                      
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),                                                      
    EDT          DATETIME   NULL,                                                      
    DDDT         DATETIME   NULL,                                                      
    VNO          VARCHAR(12)   NULL,                                                      
    VTYP         SMALLINT   NULL,                                                      
    ACNAME       VARCHAR(100)   NULL,                                                      
    COSTCODE     SMALLINT   NULL,                                                      
    BANKCOST     SMALLINT   NULL,                                                      
    LNO          SMALLINT   NOT NULL DEFAULT (0),                                                      
    BANKNAME     VARCHAR(100)   NULL,                                                      
    MICRNO       INT   NULL,                                                      
    BOOKTYPE     VARCHAR(2)   NULL,                                                      
    ACC_NO       VARCHAR(16))                                                      
  ON [PRIMARY]                                                      
                                                        
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */                                                      
  INSERT INTO #RECPAY_TABLE                                                      
             (EDATE,                   
              VOUCHER_DATE,                                                      
              CLIENT_CODE,                                                      
              AMOUNT,                                              
              DRCR,                                                      
              NARRATION,                                                      
              BANK_CODE,                                                      
              BANK_NAME,                                                      
              REF_NO,                                                      
              BRANCHCODE,                                                   
              BRANCH_NAME,                                                      
              CHQ_MODE,                                                      
              CHQ_DATE,                             
              CHQ_NAME,                                                      
              CL_MODE,                                                      
              FLD_AUTO,                                                      
        ENTEREDBY,                                                      
              VDT,                                                       
              EDT,                                                       
              DDDT,                                                      
              ACC_NO,VTYP)                                                      
  SELECT CONVERT(VARCHAR,EDATE,103),                                                      
         CONVERT(VARCHAR,VDATE,103),                                                      
         CLTCODE,                                         
         CREDITAMT,                                                      
         'C',                                                      
         NARRATION,                                                      
         OPPCODE,                                                      
         BANKNAME,                                                   
         DDNO,                                                      
         'ALL',                                                      
         BRANCHNAME,                                                      
         CHEQUEMODE,                                                      
         CONVERT(VARCHAR,CHEQUEDATE,103),                                                      
         CHEQUENAME,                                                      
         CLEAR_MODE,                                                      
         FLDAUTO,                                                      
         ADDBY,                                                       
         VDATE,                                                       
         EDATE,                                                       
         CHEQUEDATE,                                                       
         TPAccountNumber, VOUCHERTYPE                                                      
  FROM   ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(NOLOCK)                                           
  WHERE  VOUCHERTYPE = 2                                                      
         AND EXCHANGE = @EXCHANGE                                                      
         AND SEGMENT = @SEGMENT                                                      
         AND ISNULL(ROWSTATE,0) = 0                                 
   AND ISNULL(APPROVALFLAG,0) = 1                                                
   AND VDATE LIKE @IP_VDATE + '%'                          
                                                      
                                                  
                                                
  SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE                                              
                
 IF @@RECPAYTBLCOUNT = 0                                              
 BEGIN                                              
  COMMIT                                              
  RETURN                                              
 END        
                                       
                                        
                                     
--TRUNCATE table #RECPAY_TABLE                                        
--return                                              
                                        
                                           
  UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES  --WITH (ROWLOCK)                                                       
  SET    ROWSTATE = 9                                                      
  FROM   #RECPAY_TABLE                                                      
  WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                             
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)                                                      
  FROM   #RECPAY_TABLE                                                      
                                                               
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),                      
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),                                                      
         @@BRANCHFLAG = BRANCHFLAG,                                                      
         @@VNOFLAG = VNOFLAG                                                      
  FROM   PARAMETER WITH(NOLOCK)                
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR                                                      
                                                                                        
  IF @@VNOFLAG <> 0                                                      
    BEGIN                                                      
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)                                  
      FROM   #RECPAY_TABLE                                                      
                                                                   
      IF @@ERROR_COUNT > 1                                                      
        BEGIN                                                      
     DROP TABLE #RECPAY_TABLE                                                                  
     ROLLBACK TRANSACTION                                             
     SET @ERRORCODE = 1                                                                
     SET @MESSAGE = 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                                                      
     EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                               
     RETURN                                       
        END                                                      
    END                                                      
                                                      
  IF @@BRANCHFLAG = 1                                                      
    BEGIN                                                      
      UPDATE #RECPAY_TABLE                                                      
      SET    BRANCHCODE = A.BRANCHCODE,                                                      
             FYSTART = P.SDTCUR,                                                      
           FYEND = P.LDTCUR,                                                      
             UPDFLAG = 'Y',                                                      
             ACNAME = A.LONGNAME,                                                      
             COSTCODE = C.COSTCODE,                                                      
             BANKNAME = B.LONGNAME,                                                      
             BOOKTYPE = B.BOOKTYPE,                                                      
             MICRNO = ISNULL(B.MICRNO,0)                                                      
      FROM   ACMAST A WITH(NOLOCK),                               
             PARAMETER P WITH(NOLOCK),                                                      
            COSTMAST C WITH(NOLOCK),                                                      
             ACMAST B WITH(NOLOCK)                                                      
      WHERE  A.CLTCODE = CLIENT_CODE                                     
             AND B.CLTCODE = BANK_CODE                               
             --AND P.CURYEAR = 1                             
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                     
             AND A.ACCAT IN ('3','4','18')                                                      
             AND B.ACCAT = '2'                                       
             AND A.BRANCHCODE = COSTNAME                                  
                                                                                      
      UPDATE #RECPAY_TABLE                                                      
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                                      
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                                                      
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                                                      
             FYSTART = P.SDTCUR,                                                      
             FYEND = P.LDTCUR,                                                      
             UPDFLAG = 'Y',                                                      
             ACNAME = A.LONGNAME,                                                      
             COSTCODE = (SELECT TOP 1 COSTCODE                                                      
                         FROM   COSTMAST                                                      
                       WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),                                                      
             BANKNAME = B.LONGNAME,                                                      
             BOOKTYPE = B.BOOKTYPE,                                                      
             MICRNO = ISNULL(B.MICRNO,0)                                                      
      FROM   ACMAST A WITH(NOLOCK),                                                      
       PARAMETER P WITH(NOLOCK),                                                      
             COSTMAST C WITH(NOLOCK),                                                      
             ACMAST B WITH(NOLOCK)                                                      
      WHERE  A.CLTCODE = CLIENT_CODE                                            
             AND B.CLTCODE = BANK_CODE                                                      
             --AND P.CURYEAR = 1                             
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                 
             AND A.ACCAT IN ('3','4','18')                                                      
             AND B.ACCAT = '2'                                                      
             AND A.BRANCHCODE = 'ALL'                                                      
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                                                      
                                                                                                   
      UPDATE #RECPAY_TABLE    
      SET    BRANCHCODE = 'HO',                                                      
             VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                                                      
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                                                      
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                                          
             FYSTART = P.SDTCUR,                                                      
             FYEND = P.LDTCUR,                                                      
             UPDFLAG = 'Y',                                                      
             ACNAME = A.LONGNAME,                                                      
             COSTCODE = (SELECT TOP 1 COSTCODE                                                      
                         FROM   COSTMAST                                                      
             WHERE  COSTNAME = 'HO'),                                                      
             BANKNAME = B.LONGNAME,                                                      
             BOOKTYPE = B.BOOKTYPE,                       
             MICRNO = ISNULL(B.MICRNO,0)                                                      
      FROM   ACMAST A WITH(NOLOCK),                                                      
       PARAMETER P WITH(NOLOCK),                                                      
             COSTMAST C WITH(NOLOCK),                                                      
             ACMAST B WITH(NOLOCK)                                                      
      WHERE  A.CLTCODE = CLIENT_CODE                                  
             AND B.CLTCODE = BANK_CODE                                                      
             --AND P.CURYEAR = 1                             
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                     
             AND A.ACCAT IN ('3','4','18')                                                      
             AND B.ACCAT = '2'                                                      
             AND A.BRANCHCODE = 'ALL'                                                      
         AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                                                      
    END                                                      
  ELSE                                                 
    BEGIN                                                      
      UPDATE #RECPAY_TABLE                                                      
      SET    FYSTART = @@STD_DATE,                                                      
             FYEND = @@LST_DATE + ' 23:59:59',                                                      
             UPDFLAG = 'Y',                                                      
             ACNAME = A.LONGNAME,                                                      
             BANKNAME = B.LONGNAME,                                                      
             BOOKTYPE = B.BOOKTYPE,                                                      
             MICRNO = ISNULL(B.MICRNO,0)                                                      
      FROM   ACMAST A WITH(NOLOCK),                                                      
             ACMAST B WITH(NOLOCK)                                                      
      WHERE A.CLTCODE = CLIENT_CODE                                                  
             AND B.CLTCODE = BANK_CODE                                                      
             AND A.ACCAT IN ('3','4','18')                                                      
             AND B.ACCAT = '2'                                                      
    END                                                      
                                 
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */                                                      
  SELECT @@ERROR_COUNT = COUNT(SNO)                                                      
  FROM   #RECPAY_TABLE                                                      
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND                                                      
                                                      
  IF @@ERROR_COUNT > 0                                                
  BEGIN                                                   
    DROP TABLE #RECPAY_TABLE                                                      
    ROLLBACK TRAN                                                   
    SET @ERRORCODE = 1                                                               
    SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'                                           
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                  
    RETURN                                                      
    END                                                      
                                                          
  SET @@ERROR_COUNT = 0                                                      
                                                        
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/                                                      
  SELECT @@ERROR_COUNT = COUNT(1)                                          
  FROM   #RECPAY_TABLE                                        
  WHERE  VDT > EDT                                                      
                                                        
  IF @@ERROR_COUNT > 0                                                      
    BEGIN                                                    
    DROP TABLE #RECPAY_TABLE                                                      
    ROLLBACK TRAN                                               
    SET @ERRORCODE = 1                                                               
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                                             
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                  
    RETURN                             
    END                                                      
            /*----------VALIDATION FOR ZERO AMOUNT --------*/                                                      
  SELECT @@ERROR_COUNT = COUNT(1)                                                      
  FROM   #RECPAY_TABLE                                                      
  WHERE  AMOUNT <= 0                       
                                                        
  IF @@ERROR_COUNT > 0                                                      
    BEGIN                                                       
    DROP TABLE #RECPAY_TABLE                                                      
    ROLLBACK TRAN                                              
    SET @ERRORCODE = 1                                                               
    SET @MESSAGE ='VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                                             
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                             
    RETURN                                             
    END                                                      
                                                        
  /*   ----------VALIDATION FOR CHEQUE NUMBER -------- */                                                      
  SELECT @@ERROR_COUNT = COUNT(1)                                                      
  FROM   (SELECT DISTINCT DDNO = RP.REF_NO,                                                  
                          CLTCODE = RP.CLIENT_CODE                                                      
   FROM   #RECPAY_TABLE RP,                              
                 LEDGER L WITH(NOLOCK),                                                      
     LEDGER1 L1 WITH(NOLOCK)                                                      
          WHERE  L1.DDNO = RP.REF_NO                                                      
                 AND L1.DD = RP.CHQ_MODE                                                      
                 AND L1.DRCR = @@DRCR        
                 AND L1.VTYP = @@VTYP                                                      
                 AND RP.REF_NO <> 0                                                      
                 AND L.VTYP = @@VTYP                                                      
                 AND L.VNO = L1.VNO                                                      
                 AND L.BOOKTYPE = L1.BOOKTYPE                                                      
    AND L.DRCR = @@DRCR                                                      
                 AND L.CLTCODE = RP.CLIENT_CODE) A                                         
                                                        
  IF @@ERROR_COUNT > 0                                  
    BEGIN                                                      
    DROP TABLE #RECPAY_TABLE                                                      
    ROLLBACK TRAN                                              
    SET @ERRORCODE = 1                                                               
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CHEQUE NUMBERS ALREADY EXISTS'                                            
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                  
    RETURN                                             
    END                                                      
                                                        
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/                                                      
  SELECT @@ERROR_COUNT = COUNT(1)                                                      
  FROM   (SELECT DISTINCT CLIENT_CODE                                                      
          FROM   #RECPAY_TABLE                                                      
          WHERE  UPDFLAG = 'N') A                                                      
                                                        
  IF @@ERROR_COUNT > 0                                                      
    BEGIN                                                      
    DROP TABLE #RECPAY_TABLE                           
    ROLLBACK TRAN                                              
    SET @ERRORCODE = 1                                                               
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'                                             
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                  
    RETURN                                                 
    END                                                      
                      
  /*    ----------AUTO GENERATION OF VNO -------- */                                                      
  SET @@VNOCUR = CURSOR FOR SELECT DISTINCT BANK_CODE,                                                      
         BOOKTYPE                                                      
                            FROM   #RECPAY_TABLE WITH (NOLOCK)                                                      
                                                        
  OPEN @@VNOCUR                                                      
                                                        
  FETCH NEXT FROM @@VNOCUR                                               
  INTO @@BANK_CODE,                                                      
       @@BOOKTYPE                              
                                                        
  WHILE @@FETCH_STATUS = 0                                                      
    BEGIN                                                      
      IF @@BRANCHFLAG = 1                                                      
        BEGIN                                                      
          SELECT @@BANKBRANCH = BRANCHCODE,                                                      
                 @@BANKCOST = ISNULL(C.COSTCODE,-1)     
          FROM   ACMAST A WITH(NOLOCK)                               
                 LEFT OUTER JOIN COSTMAST C WITH(NOLOCK)                                                      
                   ON (A.BRANCHCODE = C.COSTNAME)                                                      
          WHERE  A.CLTCODE = @@BANK_CODE                                                      
                                                                
          IF @@BANKBRANCH <> 'ALL'                                                      
            BEGIN                                                      
              UPDATE RP                                                      
              SET    COSTCODE = @@BANKCOST                                                      
              FROM   #RECPAY_TABLE RP,                                                      
                     ACMAST A WITH(NOLOCK)                                                      
              WHERE  A.CLTCODE = RP.CLIENT_CODE                                                      
                     AND A.BRANCHCODE = 'ALL'                                                      
                                                                    
              UPDATE #RECPAY_TABLE                                                      
              SET    BANKCOST = @@BANKCOST                                                      
              WHERE  BANK_CODE = @@BANK_CODE                         
            END                                                      
          ELSE                                                      
            BEGIN                                                      
              UPDATE #RECPAY_TABLE                                                      
              SET    COSTCODE = (SELECT TOP 1 COSTCODE                                                      
                                 FROM   COSTMAST WITH(NOLOCK)                                                      
                                 WHERE  COSTNAME = 'HO')                                                      
              WHERE  COSTCODE = ''                                                      
                    AND BANK_CODE = @@BANK_CODE                                                      
                                                             
              SET @@COSTCODEUPDATES = CURSOR FOR SELECT   SNO,                                                  
                                                          COUNT(DISTINCT COSTCODE)                                                      
                                                 FROM     #RECPAY_TABLE                                                       
                                                 WHERE    BANK_CODE = @@BANK_CODE                                                      
                                                 GROUP BY SNO                                                      
                                                 HAVING   COUNT(DISTINCT COSTCODE) > 1                                                                                         
              OPEN @@COSTCODEUPDATES                                                      
                                                                    
              FETCH NEXT FROM @@COSTCODEUPDATES                                                      
              INTO @@SERIAL_NO,                                                      
                   @@COSTCODECOUNT                                                      
                                                      
              WHILE @@FETCH_STATUS = 0                                                      
                BEGIN                                                      
                  UPDATE #RECPAY_TABLE                                                      
                  SET    BANKCOST = (SELECT TOP 1 COSTCODE                           
                                  FROM   COSTMAST WITH(NOLOCK)                      
                                     WHERE  COSTNAME = 'HO')                            
                  WHERE  (BANKCOST = ''                                                      
                           OR BANKCOST IS NULL)                                                      
                         AND BANK_CODE = @@BANK_CODE                                                      
                         AND SNO = @@SERIAL_NO                                                      
                                                                        
                  FETCH NEXT FROM @@COSTCODEUPDATES                                                      
                  INTO @@SERIAL_NO,                                                      
         @@COSTCODECOUNT                                                      
           END                    
                                                                    
              CLOSE @@COSTCODEUPDATES                                                      
                                                                    
              DEALLOCATE @@COSTCODEUPDATES                                                                                                  
              UPDATE #RECPAY_TABLE                                                      
              SET    BANKCOST = COSTCODE                                                      
              WHERE  BANK_CODE = @@BANK_CODE                                                      
                     AND (BANKCOST = ''                   
                           OR BANKCOST IS NULL)                                                     
END                                                      
        END                                                      
                   
      CREATE TABLE #BANK_VNO (                                                      
        SRNO    INT,                                                      
        NEWSRNO INT   IDENTITY ( 1,1 ))                                                      
                                                            
      INSERT INTO #BANK_VNO                                                      
      SELECT DISTINCT SNO                                                      
      FROM   #RECPAY_TABLE                                 
      WHERE  BANK_CODE = @@BANK_CODE                                                      
             AND BOOKTYPE = @@BOOKTYPE                
                                                                                  
      SELECT @@MAXCOUNT = COUNT(DISTINCT SNO)                                                      
      FROM   #RECPAY_TABLE                                                      
                                                                   
      SELECT TOP 1 @@VDT = VDT                                                      
FROM   #RECPAY_TABLE                                                      
                                                            
      SELECT LASTVNO                                                      
      INTO   #VNO                                                      
      FROM   LASTVNO WITH(NOLOCK)                                                            WHERE  1 = 2                                                      
                                                            
      SELECT @@MAXVNO = MAX(NEWSRNO)                                    
      FROM   #BANK_VNO                                                      
                                                     
                                                    
                                        
                                        
      INSERT INTO #VNO                                                      
      EXEC ACC_GENVNO_NEW                                                      
        @@VDT ,                                                      
    @@VTYP ,                                                      
 @@BOOKTYPE ,                                                      
    @@STD_DATE ,                                   
        @@LST_DATE ,                                                      
        @@MAXVNO                                                      
                                                            
      SELECT @@NEWVNO = LASTVNO                                                      
      FROM   #VNO                                    
                                                            
      UPDATE RP                                                      
      SET    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                                                      
      FROM   #RECPAY_TABLE RP,                                                      
             #BANK_VNO BV                                                      
      WHERE  RP.SNO = BV.SRNO                             
                                                            
                                         
                         
      DROP TABLE #VNO                                                      
                                                            
      DROP TABLE #BANK_VNO                                                      
                                                            
      FETCH NEXT FROM @@VNOCUR                                        
      INTO @@BANK_CODE,                                                      
           @@BOOKTYPE                  
    END                                                 
                                                        
  /*   ----------AUTO GENERATION OF LNO -------- */                                                      
  UPDATE #RECPAY_TABLE                                                      
 SET    LNO = 2                          
  WHERE  VNO IN (SELECT   VNO                                                      
                 FROM     #RECPAY_TABLE                                                       
                 GROUP BY VNO                                                      
                 HAVING   COUNT(*) = 1)                                                      
                                          
                                        
                                        
                                                      
  SET @@LNOCUR = CURSOR FOR SELECT   VNO                                                      
                            FROM     #RECPAY_TABLE                                                       
                            GROUP BY VNO                                                      
                            HAVING   COUNT(*) > 1                                               
                                                        
  OPEN @@LNOCUR                 
                                                        
  FETCH NEXT FROM @@LNOCUR                                                      
  INTO @@LNOVNO                                                      
                                                        
  WHILE @@FETCH_STATUS = 0                                                      
    BEGIN                                 
      CREATE TABLE [#LNOGEN] (                                                      
        VNO VARCHAR(12),                                                      
        SNO INT,                                                      
        LNO INT   IDENTITY ( 1,1 ))                                                      
                                                            
      INSERT INTO #LNOGEN                                                      
      SELECT   VNO, SNO                                                      
      FROM     #RECPAY_TABLE WITH (NOLOCK)                                                      
      WHERE    VNO = @@LNOVNO                           
      ORDER BY SNO                                  
                                                            
      UPDATE #RECPAY_TABLE                                                      
      SET    LNO = L.LNO + 1                                                  
      FROM   #LNOGEN L                                                      
      WHERE  #RECPAY_TABLE.VNO = L.VNO                                                      
             AND #RECPAY_TABLE.SNO = L.SNO                                                      
             AND #RECPAY_TABLE.LNO = 0                                                      
                                                            
      DROP TABLE #LNOGEN                                                      
                                                            
      FETCH NEXT FROM @@LNOCUR                                                      
      INTO @@LNOVNO                                                      
    END                                                      
                                                        
  CLOSE @@LNOCUR                                                 
                                      
  DEALLOCATE @@LNOCUR                                                      
           
  /* ----------BEGIN POSTING TO TRANSACTION TABLES -------- */                                                      
  INSERT INTO LEDGER1                                                      
             (BNKNAME,                                                      
              BRNNAME,                                                      
              DD,                                                      
     DDNO,                                                      
              DDDT,                                                      
              RELDT,                                                      
              RELAMT,                                                      
              REFNO,                                                      
              RECEIPTNO,                                                      
   VTYP,                             
              VNO,                                                      
              LNO,                  
     DRCR,                                                      
              BOOKTYPE,                                                      
              MICRNO,                                                      
              SLIPNO,                                                      
              SLIPDATE,                                                      
              CHEQUEINNAME,                                                      
              CHQPRINTED,                                                      
              CLEAR_MODE)                                                      
  SELECT   BNKNAME = MAX(BANK_NAME),                                                      
           BRNNAME = MAX(BRANCH_NAME),                                                      
           DD = MAX(CHQ_MODE),                                                      
           DDNO = MAX(REF_NO),                                                      
           DDDT = MAX(DDDT),                      
           RELDT = '',                                                      
           RELAMT = SUM(AMOUNT),                                                      
           REFNO = 0,                                                      
           RECEIPTNO = 0,                                                      
           VTYP,                                                 
           VNO,                                                      
           LNO = 2,                                                      
           DRCR,                                                      
           BOOKTYPE = BOOKTYPE,                                                     
           MICRNO = MICRNO,                                                      
           SLIPNO = 0,                                                      
           SLIPDATE = '',                                                      
           CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                                                      
           CHQPRINTED = 0,                                                      
   CLEAR_MODE = MAX(CL_MODE)                                                      
  FROM     #RECPAY_TABLE                                                      
  GROUP BY VTYP,VNO,DRCR,BOOKTYPE,                                                      
           MICRNO                                                      
                                                         
  IF @@ERROR <> 0                                                      
    BEGIN                                                        
    DROP TABLE #RECPAY_TABLE                                                      
    ROLLBACK TRAN                                              
    SET @ERRORCODE = 1                                   
    SET @MESSAGE ='DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                                             
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                  
    RETURN                                              
    END                     
                                                          
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/                                                      
  CREATE TABLE #LEDGER (                                   
    VTYP      SMALLINT,                                                      
    VNO       VARCHAR(12),                                                      
    EDT       DATETIME,                                                      
    LNO       SMALLINT,                                                    
    ACNAME    VARCHAR(100),                                                      
    DRCR      VARCHAR(1),                                                      
    VAMT      MONEY,                                                      
    VDT       DATETIME,                                                      
    VNO1      VARCHAR(12),                                                      
    REFNO     CHAR(12),                                               
    BALAMT    MONEY,                                  
    NODAYS    INT,                                                      
    CDT       DATETIME,                                                      
    CLTCODE   VARCHAR(10),                                                      
    BOOKTYPE  VARCHAR(2),                                                      
    ENTEREDBY VARCHAR(25),                                                      
    PDT       DATETIME,                                                      
    CHECKEDBY VARCHAR(25),                                   
    ACTNODAYS INT,                                                      
    NARRATION VARCHAR(234))                                                          
    
  CREATE TABLE #LEDGER3 (                                                      
    NARATNO  INT,                                                      
    NARR     VARCHAR(234),                                                      
    REFNO    CHAR(12),                                                      
    VTYP     SMALLINT,                                                      
    VNO      VARCHAR(12),                                                   
    BOOKTYPE VARCHAR(2))                                                      
                                                        
/*======CLIENT SIDE RECORD======*/                                                      
  INSERT INTO #LEDGER                                                
             (VTYP,                                                      
              VNO,                                                     
              EDT,                                   
              LNO,                                                      
              ACNAME,                                                      
              DRCR,         
      VAMT,                                                      
              VDT,                                                      
              VNO1,                                                   
              REFNO,                                                      
              BALAMT,                                                      
              NODAYS,                                                      
              CDT,                                                      
              CLTCODE,                                                      
              BOOKTYPE,                                                     
              ENTEREDBY,                                                      
              PDT,                                                      
              CHECKEDBY,                                                      
              ACTNODAYS,                                                      
              NARRATION)                                                      
  SELECT VTYP,                       
         VNO,                                                      
         EDT = (CASE                                                       
                  WHEN VTYP = 2                                                      
                       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                                                      
                  ELSE EDT                                                      
                END),                                   
         LNO,                                                      
         ACNAME,                                                      
         DRCR,                              
         VAMT = AMOUNT,                                                      
         VDT,                                                      
         VNO1 = VNO,                                                      
         REFNO = 0,                                                      
         BALAMT = AMOUNT,                                                      
         NODAYS = 0,                                                      
         CDT = GETDATE(),                                                      
         CLTCODE = CLIENT_CODE,                                 
         BOOKTYPE = BOOKTYPE,                                                      
         ENTEREDBY = ENTEREDBY,                                                      
         PDT = GETDATE(),                                                      
         CHECKEDBY = @UNAME,                                                      
         ACTNODAYS = 0,                                                      
         NARRATION                                                      
  FROM   #RECPAY_TABLE          
                                                        
/*======BANK SIDE RECORD======*/                                                      
  INSERT INTO #LEDGER                                                      
  SELECT   VTYP,                                                      
           VNO,                                                      
           EDT = (CASE                                                       
                    WHEN VTYP = 2                                                      
        AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                                                      
                    ELSE EDT                                                      
                  END),                                                      
           LNO = 1,                                                      
           BANKNAME,                                                      
           DRCR = (CASE                                                       
                     WHEN DRCR = 'D' THEN 'C'                                                      
                     ELSE 'D'                                          
                   END),                                           
           VAMT = SUM(AMOUNT),                                                      
           VDT,                                                      
           VNO1 = VNO,                                                      
           REFNO = 0,                                                      
           BALAMT = SUM(AMOUNT),                                                      
           NODAYS = 0,                                                      
CDT = GETDATE(),                                                      
           CLTCODE = BANK_CODE,                                                      
           BOOKTYPE = BOOKTYPE,                                                      
           ENTEREDBY = ENTEREDBY,                                                      
           PDT = GETDATE(),                                                      
           CHECKEDBY = @UNAME,                                                      
           ACTNODAYS = 0,                         
           NARRATION = MAX(NARRATION)                                       
  FROM     #RECPAY_TABLE                                 
  GROUP BY VTYP,VNO,EDT,DRCR,                                                      
           VDT,BANK_CODE,BOOKTYPE,BANKNAME,                                                      
         ENTEREDBY                                                      
                                                        
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/                                                      
  INSERT INTO LEDGER                                                      
             (VTYP,                                                      
              VNO,                                                      
              EDT,                                                      
              LNO,                                                      
              ACNAME,                                                      
              DRCR,                                                      
              VAMT,                                                      
              VDT,                                                      
              VNO1,                                                      
              REFNO,                                                     
              BALAMT,                                                      
              NODAYS,                         CDT,                                                      
              CLTCODE,                                                      
              BOOKTYPE,                                  
              ENTEREDBY,          
              PDT,                                                      
              CHECKEDBY,                                                      
              ACTNODAYS,                                                      
 NARRATION)                                                      
  SELECT   VTYP,                                                      
           VNO,                                                      
       EDT,                                                      
           LNO,                                                      
           ACNAME,                                                      
           DRCR,                                                      
           VAMT,                                                      
           VDT,                                                      
           VNO1,                                                      
           REFNO,                                                      
           BALAMT,                                                      
           NODAYS,                                                      
           CDT,                                                      
           CLTCODE,                               
           BOOKTYPE,         
           ENTEREDBY,                                                      
           PDT,                                                      
           CHECKEDBY,                                                      
           ACTNODAYS,                                                      
           NARRATION                                                      
  FROM     #LEDGER                                                      
  ORDER BY BOOKTYPE,                                
           VTYP,                                                      
           VNO,                                                      
           LNO                                                      
                                                                 
  IF @@ERROR <> 0                                                      
    BEGIN                                                      
    DROP TABLE #LEDGER                                                      
    DROP TABLE #LEDGER3                                                          
    DROP TABLE #RECPAY_TABLE                                                      
    ROLLBACK TRAN                                              
    SET @ERRORCODE = 1                       
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                                            
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                  
    RETURN                                             
    END                                                      
                                                        
                                                    
                                                        
/*======BANK SIDE RECORD======*/                                
  INSERT INTO #LEDGER3                                                      
  SELECT   NARATNO = 1,                                                      
           NARRATION = MAX(NARRATION),                                                      
           REFNO = 0,                                                      
           VTYP,                                                      
           VNO,                                                      
           BOOKTYPE                                                      
  FROM     #RECPAY_TABLE                           
  GROUP BY VTYP,VNO,BOOKTYPE                                               
                                                        
/*======CLIENT SIDE RECORD======*/                                                      
  INSERT INTO #LEDGER3                                          
  SELECT NARATNO = LNO,                                                      
         NARR = NARRATION,                                                      
         REFNO = 0,                                                      
         VTYP,                                                      
         VNO,                  
         BOOKTYPE                                                      
  FROM   #RECPAY_TABLE                                                      
                                                               
/*======INSERTING ALL LEDGER3 RECORDS AT ONE TIME======*/                                                      
  INSERT INTO LEDGER3                                                      
  SELECT   *                                                      
  FROM     #LEDGER3                                                      
  ORDER BY BOOKTYPE,                                                      
    VTYP,                                               VNO,                                                      
           NARATNO                                                      
                                                                 
  IF @@ERROR <> 0                                                      
    BEGIN                                                      
    DROP TABLE #LEDGER3                                                          
    DROP TABLE #RECPAY_TABLE                                                      
    ROLLBACK TRAN                                              
    SET @ERRORCODE = 1                                                               
    SET @MESSAGE = 'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                                             
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                  
    RETURN                                             
    END                                                      
                                                        
  DROP TABLE #LEDGER3                                                 
   
  
                                                              
  IF @@BRANCHFLAG = 1                                                            
    BEGIN     
  
        
  SELECT * INTO #LEDGER2 FROM LEDGER2 WHERE 1 = 2      
  
  INSERT INTO #LEDGER2      
  SELECT VTYP, VNO, LNO, DRCR, VAMT, COSTCODE, L.BOOKTYPE, L.CLTCODE      
  FROM #LEDGER L, COSTMAST C, ACMAST A WHERE       
  L.CLTCODE = A.CLTCODE AND C.COSTNAME = CASE WHEN UPPER(A.BRANCHCODE) = 'ALL' THEN 'HO' ELSE A.BRANCHCODE END      
  
  INSERT INTO #LEDGER2      
  SELECT VTYPE, VNO, LNO, CASE WHEN DRCR = 'C' THEN 'D' ELSE 'C' END, CAMT, COSTCODE, BOOKTYPE, 'HOCTRL'      
  FROM #LEDGER2 WHERE COSTCODE IN(SELECT COSTCODE FROM COSTMAST WHERE COSTNAME <> 'HO')      
  
  DECLARE @@COSTCODE INT      
  
  SELECT @@COSTCODE = COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO'      
  
  INSERT INTO #LEDGER2      
  SELECT VTYPE, VNO, LNO, DRCR, CAMT, @@COSTCODE, BOOKTYPE, BRCONTROLAC      
  FROM #LEDGER2 L2, BRANCHACCOUNTS B, COSTMAST C      
  WHERE L2.COSTCODE = C.COSTCODE AND COSTNAME <> 'HO' AND CLTCODE <> 'HOCTRL'      
  AND COSTNAME = BRANCHNAME       
  
  INSERT INTO LEDGER2 (VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE )           
  SELECT VTYPE,VNO,LNO,DRCR,CAMT,COSTCODE,BOOKTYPE,CLTCODE FROM #LEDGER2                                                         
 /* IF @@BRANCHFLAG = 1                                                      
    BEGIN                                                      
      SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO                                                      
              FROM     #RECPAY_TABLE                                                      
                               ORDER BY VNO                                                      
           
      OPEN @@L2CUR                                                      
                                                            
      FETCH NEXT FROM @@L2CUR                                                      
      INTO @@L2VNO                                                      
                                                    
      WHILE @@FETCH_STATUS = 0                                                      
        BEGIN                                                      
          DELETE FROM TEMPLEDGER2                                                      
          WHERE  SESSIONID = '9999999999'                                                      
                                                                
/*======CLIENT SIDE RECORD======*/                                                      
          INSERT INTO TEMPLEDGER2                                                      
          SELECT 'BRANCH',                                                      
                 C.COSTNAME,                                                      
                 AMOUNT,                                                      
                 VTYP,                                                      
                 VNO,                                                      
                 LNO,                                                      
    DRCR,                                                      
                 '0',                                                      
    BOOKTYPE,                     
                 '9999999999',                                                      
                 CLIENT_CODE,                                                      
'A',                                                      
                 '0'                                                      
          FROM   #RECPAY_TABLE RP,                                                      
                 COSTMAST C WITH(NOLOCK)                                                       
          WHERE  RP.COSTCODE = C.COSTCODE                                                      
                 AND VNO = @@L2VNO                                                      
                                                                
/*======BANK SIDE RECORD======*/                                                      
          INSERT INTO TEMPLEDGER2                                                      
     SELECT   'BRANCH',                                                      
                   C.COSTNAME,                                                      
                   SUM(AMOUNT),                                                      
                   VTYP,                                 
                   VNO,                                                  
                   LNO = 1,                                                      
                   DRCR = (CASE                                                       
                             WHEN DRCR = 'D' THEN 'C'                                                      
                             ELSE 'D'                                                      
                           END),                                  
                   '0',                                                      
          BOOKTYPE,                                                      
                   '9999999999',                                                      
                   BANK_CODE,                                                      
                   'A',                                                      
                   '0'                                                      
          FROM     #RECPAY_TABLE RP,                                                      
                   COSTMAST C WITH(NOLOCK)                                                      
          WHERE    RP.BANKCOST = C.COSTCODE                         
                   AND VNO = @@L2VNO                                                      
          GROUP BY C.COSTNAME,VTYP,VNO,(CASE                                    
                   WHEN DRCR = 'D' THEN 'C'                                                      
                      ELSE 'D'                                                      
                    END),                       
                   BANK_CODE,BOOKTYPE                                                      
                                                                
          EXEC INSERTTOLEDGER2                                                      
            '9999999999' ,                                                      
            @@L2VNO ,                                                      
            '1' ,                                                      
            '1' ,                                                      
            '1' ,                                                      
            'BROKER' ,                                                 
            'BROKER'                                                      
                                                                
 FETCH NEXT FROM @@L2CUR                                                      
          INTO @@L2VNO                                                      
        END                                                      
                                                        
      DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)                                                      
      WHERE       SESSIONID = '9999999999' */                                                     
                                                      
      IF EXISTS (SELECT *                              
           FROM   DBO.SYSOBJECTS WITH(NOLOCK)                                                       
           WHERE  ID = OBJECT_ID(N'[THIRDPARTY_COLLECTION]')                                                      
                  AND OBJECTPROPERTY(ID,N'IsUserTable') = 1)                                                       
         AND @@VTYP = 2                            
        BEGIN                                                      
          INSERT INTO THIRDPARTY_COLLECTION                                                      
(VNO,                                                      
                      VTYP,                                                      
                      BOOKTYPE,                                                      
                      CLTCODE,                                                      
                      AMOUNT,                                                      
                      VDT,                                                      
                 DDNO,                            
 ACCOUNT_NO,                                                      
                      TPR_FLAG)                                                      
          SELECT   VNO,                                                      
                   VTYP,                                             
                   BOOKTYPE,                                                      
                   CLIENT_CODE,                                                      
                   AMOUNT,                                                      
                   VDT,                                                      
                   MAX(REF_NO),                                                      
                   ACC_NO,                                              
                   TPR_FLAG = 'S'                                
          FROM     #RECPAY_TABLE                                                      
          GROUP BY VNO,VTYP,BOOKTYPE,CLIENT_CODE,                                                      
                   AMOUNT,VDT,ACC_NO       
                                                                         
          UPDATE T                                                      
          SET    TPR_FLAG = 'C'                                                      
          FROM                                               
     THIRDPARTY_COLLECTION T WITH(NOLOCK),                                                     
                 MULTIBANKID M WITH(NOLOCK),                                                      
                 #RECPAY_TABLE R                                                      
          WHERE  T.CLTCODE = M.CLTCODE                                                      
                 AND M.ACCNO = T.ACCOUNT_NO                                                      
                 AND T.VNO = R.VNO                                                      
                 AND T.VTYP = R.VTYP                                            
                 AND T.BOOKTYPE = R.BOOKTYPE                                                      
        END                                                      
                                                        
   COMMIT TRAN                                                      
 END   
  
  DROP TABLE #LEDGER                                                       
                                                          
UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES -- WITH(ROWLOCK)                                                       
SET                                                
 ROWSTATE = 1,                                                    
 APPROVALFLAG = 1,                                                   
 APPROVALDATE = GETDATE(),                                                    
 APPROVEDBY = 'SYSTEM',                                                    
 LEDGERVNO = VNO                                                      
FROM   #RECPAY_TABLE                                      
WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                                      
                                                            
                        
DROP TABLE #RECPAY_TABLE                                 
SET @ERRORCODE = 0                                                               
SET @MESSAGE = 'POSTED SUCCESSFULLY'                                              
EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                               
                              
                              
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD_25052011
-- --------------------------------------------------
        
CREATE PROC [dbo].[V2_OFFLINE_RECPAYUPLOAD_25052011](
                                                            
           @UNAME     VARCHAR(25),                                                            
           @USERCAT   INT,                                                            
           @EXCHANGE  VARCHAR(3),                                                            
           @SEGMENT   VARCHAR(10),                                                            
           @IP_VDATE varchar(11),                                          
           @RECOFLAG  CHAR(1) = 'N')                                                            
                                                            
AS                                                            
                                    
SET XACT_ABORT ON                                                            
/*                                                          
V2_OFFLINE_RECPAYUPLOAD 'OFFLINE',1,'NSE','CAPITAL','N'                                                         
*/                                                          
                                                          
                                                          
  SET NOCOUNT ON                                                            
                                                              
  /*---------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR --------*/                                                            
  DECLARE  @@STD_DATE        VARCHAR(11),                                                            
           @@LST_DATE        VARCHAR(11),                                                            
           @@BRANCHFLAG       AS TINYINT,                                                            
           @@VNOFLAG          AS TINYINT,                                                            
           @@VNOMETHOD       INT,                                                            
           @@ACNAME          CHAR(100),                                                            
           @@BOOKTYPE        CHAR(2),                                                            
           @@MICRNO          VARCHAR(10),                                                            
           @@DRCR            VARCHAR(1),                                                            
           @@VTYP            SMALLINT,                                                            
           @@BANK_CODE       VARCHAR(100),                                                            
           @@BACKDAYS        INT,                                                            
           @@BACKDATE        VARCHAR(11),                                                            
           @@BRNCOUNT        TINYINT,                                                            
           @@MonthlyVdt      VARCHAR(11),                                                            
           @@SERIAL_NO       INT,                                                            
           @@COSTCODECOUNT   TINYINT,                                                            
           @@COSTCODEUPDATES CURSOR,                                                            
           @@NEWVNO           AS VARCHAR(12),                                                            
           @@MAXCOUNT         AS INT,                                                            
           @@VDT              AS VARCHAR(11),                                                            
           @@BANKBRANCH       AS VARCHAR(10),                                                            
           @@BANKCOST         AS NUMERIC,                                                            
           @@LNOCUR           AS CURSOR,                                                            
           @@VNOCUR           AS CURSOR,                                                 
           @@LNOVNO           AS VARCHAR(12),                                                            
           @@MAXVNO           AS INT,                                                         
           @@L2CUR            AS CURSOR,                                                    
           @@L2VNO            AS VARCHAR(12),                                                          
           @@ERROR_COUNT      AS BIGINT,                                            
           @@FILEEXISTS       AS INT,                                       
           @@SQL              AS VARCHAR(2000),                                         
           @ERRORCODE         AS INT,                                                            
     @MESSAGE           AS VARCHAR(200) ,                                                    
   @@RECPAYTBLCOUNT BIGINT                                                
                                                                                 
                                        
 SET @@VTYP = 2                                                          
                                                          
BEGIN DISTRIBUTED TRANSACTION                                                            
                                                            
  CREATE TABLE [#RECPAY_TABLE] (                                                         
    SNO    INT   IDENTITY ( 1,1 ),                                                            
    EDATE        VARCHAR(20),                                                            
    VOUCHER_DATE VARCHAR(20),                                                            
    CLIENT_CODE  VARCHAR(50),                                                            
    AMOUNT       MONEY,                                                            
    DRCR         VARCHAR(1),                                           
    NARRATION    VARCHAR(234),                                                            
    BANK_CODE    VARCHAR(10),                                                            
    BANK_NAME    VARCHAR(100),                                                            
    REF_NO       VARCHAR(15),                                                            
    BRANCHCODE   VARCHAR(20),                                                            
    BRANCH_NAME  VARCHAR(50),                                                            
    CHQ_MODE     VARCHAR(1),                                                            
    CHQ_DATE     VARCHAR(20),                                                       
    CHQ_NAME     VARCHAR(100),                                                            
    CL_MODE      VARCHAR(1),                                                            
    FLD_AUTO     BIGINT,                                                     
    ENTEREDBY    VARCHAR(25),                                                            
    VDT          DATETIME   NULL,                                                            
    FYSTART      DATETIME   NULL,                                                      
    FYEND        DATETIME   NULL,                                                            
    UPDFLAG      VARCHAR(1)   NOT NULL   DEFAULT ('N'),                                                            
    EDT          DATETIME   NULL,                                                            
    DDDT         DATETIME   NULL,                                                            
    VNO          VARCHAR(12)   NULL,                                                            
    VTYP         SMALLINT   NULL,                                                            
    ACNAME       VARCHAR(100)   NULL,                                                            
    COSTCODE     SMALLINT   NULL,                                                            
    BANKCOST     SMALLINT   NULL,                                                          
    LNO          SMALLINT   NOT NULL DEFAULT (0),                                                            
    BANKNAME     VARCHAR(100)   NULL,                                                            
    MICRNO       INT   NULL,                                                            
    BOOKTYPE     VARCHAR(2)   NULL,                                                            
    ACC_NO       VARCHAR(16))                                                            
  ON [PRIMARY]                               
                                                      
  /* POPULATE APPROVED RECORDS FROM OFFLINE ENTRIES TABLE TO TEMP TABLE FOR THE EXCHANGE-SEGMENT */                                              
  INSERT INTO #RECPAY_TABLE                                                            
             (EDATE,             
              VOUCHER_DATE,                                   
              CLIENT_CODE,                                                            
              AMOUNT,                               
              DRCR,                                                            
              NARRATION,                                                            
              BANK_CODE,                                                          
              BANK_NAME,                                                            
              REF_NO,                                                            
              BRANCHCODE,                                             
              BRANCH_NAME,                                                            
              CHQ_MODE,                                                            
              CHQ_DATE,                             
              CHQ_NAME,                                                            
              CL_MODE,                                                            
              FLD_AUTO,                                                            
              ENTEREDBY,                                                            
              VDT,                                                             
              EDT,                                                             
              DDDT,                                                            
              ACC_NO,VTYP)                                                            
  SELECT CONVERT(VARCHAR,EDATE,103),                                                            
         CONVERT(VARCHAR,VDATE,103),                                                            
         CLTCODE,                                               
         CREDITAMT,                                                            
         'C',                                                            
         NARRATION,                                                            
         OPPCODE,                                                            
         BANKNAME,                                                         
         DDNO,                                                            
         'ALL',                                                            
         BRANCHNAME,                                                            
         CHEQUEMODE,                                                            
         CONVERT(VARCHAR,CHEQUEDATE,103),                                                            
         CHEQUENAME,                                                            
         CLEAR_MODE,                                                            
         FLDAUTO,                                                            
         ADDBY,                                                             
         VDATE,                                                             
         EDATE,                                                             
         CHEQUEDATE,                                                   
         TPAccountNumber, VOUCHERTYPE                                                            
  FROM   ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES WITH(NOLOCK)                                                 
  WHERE  VOUCHERTYPE = 2                                                            
         AND EXCHANGE = @EXCHANGE                                                            
         AND SEGMENT = @SEGMENT                                                            
         AND ISNULL(ROWSTATE,0) = 0        
   AND ISNULL(APPROVALFLAG,0) = 1                                                      
   AND VDATE LIKE @IP_VDATE + '%'                                           
                                                            
           
                                                      
  SELECT @@RECPAYTBLCOUNT = COUNT(1) FROM #RECPAY_TABLE                                                    
                                                    
 IF @@RECPAYTBLCOUNT = 0                                                    
 BEGIN                                   
  COMMIT                                                    
  RETURN                                                    
 END                                                    
                                             
                             
                                              
--TRUNCATE table #RECPAY_TABLE                                              
--return                                                    
                                              
                                                 
  UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES-- WITH (ROWLOCK)                                                             
  SET    ROWSTATE = 9                                                            
  FROM   #RECPAY_TABLE                                                            
  WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                   
  SELECT TOP 1 @@VDT = CONVERT(VARCHAR(11),VDT,109)                                                            
  FROM   #RECPAY_TABLE                                                            
                                                                     
  SELECT @@STD_DATE = CONVERT(VARCHAR(11),SDTCUR,109),                                                            
         @@LST_DATE = CONVERT(VARCHAR(11),LDTCUR,109),                                                            
         @@BRANCHFLAG = BRANCHFLAG,                                                            
         @@VNOFLAG = VNOFLAG                                                            
  FROM   PARAMETER WITH(NOLOCK)                                                             
  WHERE  @@VDT BETWEEN SDTCUR AND LDTCUR                                                            
                                                                                              
  IF @@VNOFLAG <> 0                                                            
    BEGIN                                                            
      SELECT @@ERROR_COUNT = COUNT(DISTINCT VDT)                                   
      FROM   #RECPAY_TABLE                                                            
                                                                         
      IF @@ERROR_COUNT > 1                                                            
        BEGIN                                                            
     DROP TABLE #RECPAY_TABLE                                                                        
     ROLLBACK TRANSACTION                                                  
     SET @ERRORCODE = 1                                                                      
     SET @MESSAGE = 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                                                            
     EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                     
     RETURN                                           
        END                                                            
    END                                                            
                                                            
  IF @@BRANCHFLAG = 1                          
    BEGIN                                                            
      UPDATE #RECPAY_TABLE                                                            
      SET    BRANCHCODE = A.BRANCHCODE,                                                            
             FYSTART = P.SDTCUR,                                                            
           FYEND = P.LDTCUR,                                                            
             UPDFLAG = 'Y',                                                            
             ACNAME = A.LONGNAME,                                                            
             COSTCODE = C.COSTCODE,                                                            
             BANKNAME = B.LONGNAME,                   
             BOOKTYPE = B.BOOKTYPE,                                                            
             MICRNO = ISNULL(B.MICRNO,0)                                                            
      FROM   ACMAST A WITH(NOLOCK),                                                            
             PARAMETER P WITH(NOLOCK),                                                            
            COSTMAST C WITH(NOLOCK),                                                            
             ACMAST B WITH(NOLOCK)                                                            
      WHERE  A.CLTCODE = CLIENT_CODE                  
             AND B.CLTCODE = BANK_CODE                                                            
             --AND P.CURYEAR = 1                                   
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                           
             AND A.ACCAT IN ('3','4','18')                                                            
             AND B.ACCAT = '2'                            
             AND A.BRANCHCODE = COSTNAME                                        
                                                                                            
      UPDATE #RECPAY_TABLE                                                            
      SET    VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                                                            
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                                                            
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                                                            
             FYSTART = P.SDTCUR,                         
             FYEND = P.LDTCUR,                                                            
             UPDFLAG = 'Y',                                                            
             ACNAME = A.LONGNAME,                                                            
             COSTCODE = (SELECT TOP 1 COSTCODE                                                            
                         FROM   COSTMAST                                                            
    WHERE  COSTNAME = #RECPAY_TABLE.BRANCHCODE),                                                            
             BANKNAME = B.LONGNAME,                                                            
             BOOKTYPE = B.BOOKTYPE,                                                            
             MICRNO = ISNULL(B.MICRNO,0)                                                            
      FROM   ACMAST A WITH(NOLOCK),                    
             PARAMETER P WITH(NOLOCK),                                                            
             COSTMAST C WITH(NOLOCK),                                                            
             ACMAST B WITH(NOLOCK)                                                            
      WHERE  A.CLTCODE = CLIENT_CODE                                                  
             AND B.CLTCODE = BANK_CODE                                               
             --AND P.CURYEAR = 1                                   
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                    
             AND A.ACCAT IN ('3','4','18')                                                            
             AND B.ACCAT = '2'                                                            
             AND A.BRANCHCODE = 'ALL'                          
             AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                                                            
                                                                                                         
      UPDATE #RECPAY_TABLE                                
      SET    BRANCHCODE = 'HO',                                                            
           VDT = CONVERT(DATETIME,RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                                                            
             DDDT = CONVERT(DATETIME,RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                                                            
             EDT = CONVERT(DATETIME,RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                          
             FYSTART = P.SDTCUR,                                                            
             FYEND = P.LDTCUR,                                                            
             UPDFLAG = 'Y',                                                            
             ACNAME = A.LONGNAME,                                                            
             COSTCODE = (SELECT TOP 1 COSTCODE                                                            
                         FROM   COSTMAST                                                            
             WHERE  COSTNAME = 'HO'),                                                            
             BANKNAME = B.LONGNAME,                                                            
             BOOKTYPE = B.BOOKTYPE,                                                            
             MICRNO = ISNULL(B.MICRNO,0)                                                            
      FROM   ACMAST A WITH(NOLOCK),                                                            
       PARAMETER P WITH(NOLOCK),                                                            
             COSTMAST C WITH(NOLOCK),                                                            
             ACMAST B WITH(NOLOCK)                                                            
      WHERE  A.CLTCODE = CLIENT_CODE                    
             AND B.CLTCODE = BANK_CODE                                                            
             --AND P.CURYEAR = 1                                   
    AND #RECPAY_TABLE.VDT BETWEEN SDTCUR AND LDTCUR                                                           
             AND A.ACCAT IN ('3','4','18')                                                            
             AND B.ACCAT = '2'                                                            
             AND A.BRANCHCODE = 'ALL'                                                            
             AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                                                            
    END                                                            
  ELSE                                                       
    BEGIN            
      UPDATE #RECPAY_TABLE                                                            
      SET    FYSTART = @@STD_DATE,                                                            
             FYEND = @@LST_DATE + ' 23:59:59',                                                            
             UPDFLAG = 'Y',                                                  
             ACNAME = A.LONGNAME,                                                            
             BANKNAME = B.LONGNAME,                                            
             BOOKTYPE = B.BOOKTYPE,                                                            
             MICRNO = ISNULL(B.MICRNO,0)                                                            
      FROM   ACMAST A WITH(NOLOCK),                                                            
             ACMAST B WITH(NOLOCK)                                                            
      WHERE  A.CLTCODE = CLIENT_CODE                                                        
             AND B.CLTCODE = BANK_CODE                                                            
             AND A.ACCAT IN ('3','4','18')                                                            
             AND B.ACCAT = '2'                                                            
    END                                                            
                                                                
  /* ------ VALIDATION FOR CURRENT FINANCIAL YEAR DATE RANGE---------- */                                                            
  SELECT @@ERROR_COUNT = COUNT(SNO)                                                            
  FROM   #RECPAY_TABLE                                                            
  WHERE  VDT NOT BETWEEN FYSTART AND FYEND                                                            
                                                            
  IF @@ERROR_COUNT > 0                                                      
    BEGIN                                                         
    DROP TABLE #RECPAY_TABLE                                           
    ROLLBACK TRAN                                                         
    SET @ERRORCODE = 1                                                                     
    SET @MESSAGE = 'SOME OF THE VOUCHERS ARE NOT BETWEEN THE CURRENT FINANCIAL YEAR DATE RANGE.'                                               
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                      
    RETURN                                                            
    END                                                            
                                            
  SET @@ERROR_COUNT = 0                                                            
                                                              
  /*----------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE --------*/                                                            
  SELECT @@ERROR_COUNT = COUNT(1)                                                            
  FROM   #RECPAY_TABLE                       
  WHERE  VDT > EDT                                                            
                                                              
  IF @@ERROR_COUNT > 0                                                            
    BEGIN                                                          
    DROP TABLE #RECPAY_TABLE                                                            
    ROLLBACK TRAN                                                     
    SET @ERRORCODE = 1                                                                     
    SET @MESSAGE ='VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                                                   
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                        
    RETURN                                   
    END                                                            
            /*----------VALIDATION FOR ZERO AMOUNT --------*/                                                            
  SELECT @@ERROR_COUNT = COUNT(1)                                                            
  FROM   #RECPAY_TABLE                                                            
  WHERE  AMOUNT <= 0                                                            
                                                     
  IF @@ERROR_COUNT > 0                   
    BEGIN                                                             
    DROP TABLE #RECPAY_TABLE                                                            
    ROLLBACK TRAN                                                    
    SET @ERRORCODE = 1                                                                     
    SET @MESSAGE ='VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                                                   
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                        
 RETURN                                       
    END                                                            
                                                     
  /*   ----------VALIDATION FOR CHEQUE NUMBER -------- */                                                            
  SELECT @@ERROR_COUNT = COUNT(1)                                                            
  FROM   (SELECT DISTINCT DDNO = RP.REF_NO,                                                            
                          CLTCODE = RP.CLIENT_CODE                                                            
   FROM   #RECPAY_TABLE RP,                                    
                 LEDGER L WITH(NOLOCK),                                                            
                 LEDGER1 L1 WITH(NOLOCK)                                                            
          WHERE  L1.DDNO = RP.REF_NO                                                            
                 AND L1.DD = RP.CHQ_MODE                                                            
                 AND L1.DRCR = @@DRCR                                                  
                 AND L1.VTYP = @@VTYP                                                            
                 AND RP.REF_NO <> '0'                                                            
                 AND L.VTYP = @@VTYP                                                            
                 AND L.VNO = L1.VNO                                                            
                 AND L.BOOKTYPE = L1.BOOKTYPE                                                            
                 AND L.DRCR = @@DRCR                                                            
                 AND L.CLTCODE = RP.CLIENT_CODE) A                   
                                                              
  IF @@ERROR_COUNT > 0                                        
    BEGIN                                                            
    DROP TABLE #RECPAY_TABLE                                                            
    ROLLBACK TRAN                                                    
    SET @ERRORCODE = 1                                                                     
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CHEQUE NUMBERS ALREADY EXISTS'                                                  
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                
    RETURN                                                   
    END                                                            
                                                              
  /*----------FINAL VALIDATION BASED ON UPDFLAG --------*/                                                            
  SELECT @@ERROR_COUNT = COUNT(1)                                                            
  FROM   (SELECT DISTINCT CLIENT_CODE                                                            
          FROM   #RECPAY_TABLE                                                            
          WHERE  UPDFLAG = 'N') A                                                            
                                     
  IF @@ERROR_COUNT > 0                                                            
    BEGIN                                                            
    DROP TABLE #RECPAY_TABLE                                                            
   ROLLBACK TRAN                                                   
    SET @ERRORCODE = 1                                                                     
    SET @MESSAGE ='DATA CANNOT BE UPLOADED AS THE SOME CLIENTS DO NOT EXIST'                                                   
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                        
    RETURN                                                       
    END                           
                                                        
  /*    ----------AUTO GENERATION OF VNO -------- */                                                            
  SET @@VNOCUR = CURSOR FOR SELECT DISTINCT BANK_CODE,                                                            
         BOOKTYPE                                                            
                            FROM   #RECPAY_TABLE WITH (NOLOCK)                                                         
                                                              
  OPEN @@VNOCUR                                                            
                                                              
  FETCH NEXT FROM @@VNOCUR                                                            
  INTO @@BANK_CODE,                                                            
       @@BOOKTYPE                                       
                                                              
  WHILE @@FETCH_STATUS = 0                                                            
    BEGIN                                                            
      IF @@BRANCHFLAG = 1                                                            
        BEGIN                                                            
          SELECT @@BANKBRANCH = BRANCHCODE,                                                            
                 @@BANKCOST = ISNULL(C.COSTCODE,-1)                                                            
          FROM   ACMAST A WITH(NOLOCK)                                     
                 LEFT OUTER JOIN COSTMAST C WITH(NOLOCK)                                   
                   ON (A.BRANCHCODE = C.COSTNAME)                                                            
  WHERE  A.CLTCODE = @@BANK_CODE                                                            
                                                                      
          IF @@BANKBRANCH <> 'ALL'                                                            
            BEGIN                                                            
              UPDATE RP                                                            
              SET    COSTCODE = @@BANKCOST                                
              FROM   #RECPAY_TABLE RP,                                                            
                     ACMAST A WITH(NOLOCK)                                                            
              WHERE  A.CLTCODE = RP.CLIENT_CODE                                                            
                     AND A.BRANCHCODE = 'ALL'                                                            
                                                                          
              UPDATE #RECPAY_TABLE             
              SET    BANKCOST = @@BANKCOST                                                            
              WHERE  BANK_CODE = @@BANK_CODE                                                            
        END                                                            
          ELSE                                                            
            BEGIN                                                            
              UPDATE #RECPAY_TABLE                                                            
              SET    COSTCODE = (SELECT TOP 1 COSTCODE                                                            
                                 FROM   COSTMAST WITH(NOLOCK)                             
                                 WHERE  COSTNAME = 'HO')                                                            
              WHERE  COSTCODE = ''                                      
                     AND BANK_CODE = @@BANK_CODE                                          
                                                                          
              SET @@COSTCODEUPDATES = CURSOR FOR SELECT   SNO,                                                        
                                                          COUNT(DISTINCT COSTCODE)                                                            
                                                 FROM     #RECPAY_TABLE                                                             
         WHERE    BANK_CODE = @@BANK_CODE                                                            
                                                 GROUP BY SNO                                                            
                                                 HAVING   COUNT(DISTINCT COSTCODE) > 1                                           
                                         
              OPEN @@COSTCODEUPDATES                                                            
                                                                          
              FETCH NEXT FROM @@COSTCODEUPDATES                                                            
              INTO @@SERIAL_NO,                                                            
                @@COSTCODECOUNT                                                            
                                               
              WHILE @@FETCH_STATUS = 0                                                            
                BEGIN                                                            
                  UPDATE #RECPAY_TABLE                                                            
                  SET    BANKCOST = (SELECT TOP 1 COSTCODE                                                            
                            FROM   COSTMAST WITH(NOLOCK)                                                            
                                     WHERE  COSTNAME = 'HO')                                                            
                WHERE  (BANKCOST = ''                                     
                           OR BANKCOST IS NULL)                                                            
                         AND BANK_CODE = @@BANK_CODE                                                            
                         AND SNO = @@SERIAL_NO                                                            
                                                                              
                  FETCH NEXT FROM @@COSTCODEUPDATES                                                            
                  INTO @@SERIAL_NO,                                                            
         @@COSTCODECOUNT                                      
               END                                                            
                                                                          
              CLOSE @@COSTCODEUPDATES                  
                                     
              DEALLOCATE @@COSTCODEUPDATES                                                                                                        
              UPDATE #RECPAY_TABLE                                                            
              SET    BANKCOST = COSTCODE                                                            
              WHERE  BANK_CODE = @@BANK_CODE                                                            
                     AND (BANKCOST = ''                                                            
           OR BANKCOST IS NULL)                                                           
END                                                            
        END         
                        
      CREATE TABLE #BANK_VNO (                                                            
        SRNO    INT,                                                            
        NEWSRNO INT   IDENTITY ( 1,1 ))                                                            
                                                                  
      INSERT INTO #BANK_VNO                                                            
      SELECT DISTINCT SNO                                                            
      FROM   #RECPAY_TABLE                                       
      WHERE  BANK_CODE = @@BANK_CODE                                                            
             AND BOOKTYPE = @@BOOKTYPE                                                            
                
      SELECT @@MAXCOUNT = COUNT(DISTINCT SNO)                                                            
      FROM   #RECPAY_TABLE                                                            
                                                                         
      SELECT TOP 1 @@VDT = VDT                                               
      FROM   #RECPAY_TABLE                                                            
                                                                  
      SELECT LASTVNO                                                            
      INTO   #VNO                                                            
      FROM   LASTVNO WITH(NOLOCK)                                                            
      WHERE  1 = 2                                                            
                                    SELECT @@MAXVNO = MAX(NEWSRNO)         
      FROM   #BANK_VNO                                                            
                                                           
                                                          
                                         
                                              
      INSERT INTO #VNO                                                            
      EXEC ACC_GENVNO_NEW                                                            
        @@VDT ,                                                            
    @@VTYP ,                                                            
 @@BOOKTYPE ,                                                            
       @@STD_DATE ,                                                       
        @@LST_DATE ,                                                            
        @@MAXVNO                                                            
                                                                  
      SELECT @@NEWVNO = LASTVNO                                                            
      FROM   #VNO                                                        
                                                                  
      UPDATE RP                                                            
      SET    VNO = CONVERT(VARCHAR(12),CONVERT(NUMERIC,@@NEWVNO) + (NEWSRNO - 1))                                                            
      FROM   #RECPAY_TABLE RP,                                                            
             #BANK_VNO BV    
      WHERE  RP.SNO = BV.SRNO                                                            
                                                                  
                                               
                                              
      DROP TABLE #VNO                
                                                                  
      DROP TABLE #BANK_VNO                                                            
                                                                  
      FETCH NEXT FROM @@VNOCUR                                       
      INTO @@BANK_CODE,                                                            
           @@BOOKTYPE                           
    END        
      
                                                   
                                                              
  /*   ----------AUTO GENERATION OF LNO -------- */                                                            
  UPDATE #RECPAY_TABLE                                                            
 SET    LNO = 2                                                            
  WHERE  VNO IN (SELECT   VNO                                                            
                 FROM     #RECPAY_TABLE                                                             
                 GROUP BY VNO                                                            
                 HAVING   COUNT(*) = 1)                                                            
                                                
                                              
                                              
                                                            
  SET @@LNOCUR = CURSOR FOR SELECT   VNO                                                 
                            FROM     #RECPAY_TABLE                                                             
                            GROUP BY VNO                                                            
                            HAVING   COUNT(*) > 1                                                     
                                                   
  OPEN @@LNOCUR                                                            
                                                              
  FETCH NEXT FROM @@LNOCUR                                                            
  INTO @@LNOVNO                                                            
                                                              
  WHILE @@FETCH_STATUS = 0                                                            
    BEGIN                                                            
      CREATE TABLE [#LNOGEN] (                                                            
        VNO VARCHAR(12),                                 
        SNO INT,                                                            
        LNO INT   IDENTITY ( 1,1 ))                                                            
                                                                  
      INSERT INTO #LNOGEN                                                            
      SELECT   VNO, SNO                                                            
      FROM     #RECPAY_TABLE WITH (NOLOCK)                                        
      WHERE    VNO = @@LNOVNO                                                            
  ORDER BY SNO                                                            
                                                                  
      UPDATE #RECPAY_TABLE                                                            
      SET    LNO = L.LNO + 1                                                        
      FROM   #LNOGEN L                                                   
      WHERE  #RECPAY_TABLE.VNO = L.VNO                                                            
             AND #RECPAY_TABLE.SNO = L.SNO                                                            
             AND #RECPAY_TABLE.LNO = 0                                                          
                                                                  
      DROP TABLE #LNOGEN                                                            
                                                                  
      FETCH NEXT FROM @@LNOCUR                                                            
      INTO @@LNOVNO                                                            
    END               
                      
  CLOSE @@LNOCUR                                                            
                                                              
  DEALLOCATE @@LNOCUR                                                            
                                                              
  /* ----------BEGIN POSTING TO TRANSACTION TABLES -------- */                                                      
  INSERT INTO LEDGER1                                                            
        (BNKNAME,                                                            
              BRNNAME,                                                            
              DD,                                                            
     DDNO,                                                            
              DDDT,                                                            
              RELDT,                                                            
              RELAMT,                                                            
              REFNO,                                                            
              RECEIPTNO,                                 
   VTYP,                                                            
              VNO,                                                            
              LNO,                                           
     DRCR,                                                            
              BOOKTYPE,                                                            
              MICRNO,                                                            
              SLIPNO,                                                            
              SLIPDATE,                                                            
              CHEQUEINNAME,                                                            
              CHQPRINTED,                                                            
              CLEAR_MODE)                                                            
  SELECT   BNKNAME = MAX(BANK_NAME),                                                            
           BRNNAME = MAX(BRANCH_NAME),                                                            
           DD = MAX(CHQ_MODE),                                                            
           DDNO = MAX(REF_NO),                                                            
           DDDT = MAX(DDDT),                                                          
           RELDT = '',                                                            
           RELAMT = SUM(AMOUNT),                                                   
           REFNO = 0,                                                            
           RECEIPTNO = 0,                                                            
    VTYP,                                                            
           VNO,                                                            
           LNO = 2,                                                            
           DRCR,                                                            
           BOOKTYPE = BOOKTYPE,                                                           
           MICRNO = MICRNO,                                                            
           SLIPNO = 0,                                                            
           SLIPDATE = '',                                                            
           CHEQUEINNAME = MAX(ISNULL(CHQ_NAME,'')),                                                       
           CHQPRINTED = 0,                                               CLEAR_MODE = MAX(CL_MODE)                                                            
  FROM     #RECPAY_TABLE                                                            
  GROUP BY VTYP,VNO,DRCR,BOOKTYPE,                                                            
           MICRNO                                                            
                                                               
  IF @@ERROR <> 0                                                            
    BEGIN                                                              
    DROP TABLE #RECPAY_TABLE                                                            
    ROLLBACK TRAN                                                    
    SET @ERRORCODE = 1                                                                     
    SET @MESSAGE ='DUE TO ERROR IN LEDGER1 POSTING, THE FILE COULD NOT BE UPLOADED.'                                                   
   EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                        
    RETURN                                                    
    END                                                            
                                                              
/*==CREATING LEDGER AND LEDGER3 STRUCTURE TO INSERT IN BULK=====*/                                              
  CREATE TABLE #LEDGER (                                                            
    VTYP      SMALLINT,                                                            
    VNO       VARCHAR(12),                                                            
    EDT       DATETIME,                                                            
    LNO       SMALLINT,                                                          
    ACNAME    VARCHAR(100),                                                            
    DRCR      VARCHAR(1),                                                            
    VAMT      MONEY,                                                            
    VDT       DATETIME,                             
    VNO1      VARCHAR(12),                                                            
    REFNO     CHAR(12),                                                            
    BALAMT    MONEY,                                               
    NODAYS    INT,                                                            
    CDT       DATETIME,                                                            
    CLTCODE   VARCHAR(10),                                                            
    BOOKTYPE  VARCHAR(2),                                                            
    ENTEREDBY VARCHAR(25),                                                            
    PDT       DATETIME,                           
    CHECKEDBY VARCHAR(25),                                                            
    ACTNODAYS INT,                                                            
    NARRATION VARCHAR(234))                                                                
          
  CREATE TABLE #LEDGER3 (                                                            
    NARATNO  INT,                                                            
    NARR     VARCHAR(234),                                                            
    REFNO    CHAR(12),                                     
    VTYP     SMALLINT,                                                            
    VNO      VARCHAR(12),                                                            
    BOOKTYPE VARCHAR(2))          
          
                                                       
    --PRINT 'SURESH'                                                          
/*======CLIENT SIDE RECORD======*/                                                            
  INSERT INTO #LEDGER                                      
             (VTYP,                                                            
              VNO,                                                           
              EDT,                                  
              LNO,                                                            
              ACNAME,                                                            
              DRCR,                                                           
      VAMT,                      
              VDT,                                           
              VNO1,                                                            
              REFNO,                                                            
              BALAMT,                                                            
              NODAYS,                                                            
              CDT,                                                            
      CLTCODE,                                                            
              BOOKTYPE,                                                            
              ENTEREDBY,                                                
              PDT,                                                            
              CHECKEDBY,                                                            
              ACTNODAYS,                                                            
              NARRATION)                                                 
  SELECT VTYP,                                                            
         VNO,                                                            
         EDT = (CASE                                                             
                  WHEN VTYP = 2                                                            
   AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                                                            
                  ELSE EDT                                                            
                END),                                         
         LNO,                                                            
         ACNAME,                                                            
     DRCR,                                                            
         VAMT = AMOUNT,                                                      
         VDT,                                                            
         VNO1 = VNO,                                                            
         REFNO = 0,                                                            
         BALAMT = AMOUNT,                                                            
         NODAYS = 0,                                                            
         CDT = GETDATE(),                                              
         CLTCODE = CLIENT_CODE,                                                            
         BOOKTYPE = BOOKTYPE,                                                            
         ENTEREDBY = ENTEREDBY,                                                            
         PDT = GETDATE(),                                                            
         CHECKEDBY = @UNAME,                                                            
         ACTNODAYS = 0,                                                            
         NARRATION                                                            
  FROM   #RECPAY_TABLE            
          
      
      
      
      
                                                              
/*======BANK SIDE RECORD======*/                                                            
  INSERT INTO #LEDGER                                                            
  SELECT   VTYP,                                                            
           VNO,                                                            
           EDT = (CASE      
                    WHEN VTYP = 2                                                            
       AND @RECOFLAG = 'Y' THEN EDT /*'DEC 31 2049'*/                                                            
                    ELSE EDT                                                        
                  END),                                                            
           LNO = 1,                                                            
           BANKNAME,                                                            
           DRCR = (CASE                                                             
                     WHEN DRCR = 'D' THEN 'C'                                                            
                     ELSE 'D'                                                
                   END),           
           VAMT = SUM(AMOUNT),                                                            
           VDT,                                                            
           VNO1 = VNO,                                                            
           REFNO = 0,                                                            
           BALAMT = SUM(AMOUNT),                                                            
NODAYS = 0,                                                            
CDT = GETDATE(),                                                            
           CLTCODE = BANK_CODE,                                                            
           BOOKTYPE = BOOKTYPE,                                                            
           ENTEREDBY = ENTEREDBY,                                                            
           PDT = GETDATE(),                                                            
CHECKEDBY = @UNAME,                                            
           ACTNODAYS = 0,                                                            
 NARRATION = MAX(NARRATION)                                      
  FROM     #RECPAY_TABLE                                                            
  GROUP BY VTYP,VNO,EDT,DRCR,                                                            
           VDT,BANK_CODE,BOOKTYPE,BANKNAME,                                                            
           ENTEREDBY             
--PRINT 'NIKHIL'          
                            
                                                              
/*======INSERTING ALL LEDGER RECORDS AT ONE TIME======*/                                                            
  INSERT INTO LEDGER                                       
             (VTYP,                                                            
              VNO,                                                            
              EDT,                                                            
              LNO,                                                            
              ACNAME,                                                            
              DRCR,                                                            
              VAMT,                                                            
              VDT,                                                            
              VNO1,                                                            
              REFNO,                                                           
              BALAMT,                                                          
          NODAYS,                                                            
              CDT,                                                            
              CLTCODE,                                                            
              BOOKTYPE,                   
              ENTEREDBY,                                                            
              PDT,                                                            
              CHECKEDBY,                 
              ACTNODAYS,              
 NARRATION)                                                            
  SELECT   VTYP,                                                            
           VNO,                                                            
       EDT,                                                            
           LNO,                                                            
           ACNAME,                                                            
           DRCR,                                                            
           VAMT,                                                            
           VDT,                                                            
           VNO1,                                                            
           REFNO,                                                            
           BALAMT,                      
           NODAYS,                                                            
           CDT,                                                            
           CLTCODE,                                           
           BOOKTYPE,                        
           ENTEREDBY,                                                            
           PDT,                                                            
           CHECKEDBY,        
           ACTNODAYS,                                                            
           NARRATION                                                            
  FROM     #LEDGER                                                            
  ORDER BY BOOKTYPE,                               
           VTYP,                                                            
           VNO,                                                            
           LNO            
          
PRINT 'ANI'                                                          
                                                                       
  IF @@ERROR <> 0                                                            
    BEGIN                                                            
    DROP TABLE #LEDGER                                                            
    DROP TABLE #LEDGER3                                                                
    DROP TABLE #RECPAY_TABLE                                                            
    ROLLBACK TRAN                           
    SET @ERRORCODE = 1                                                                     
    SET @MESSAGE ='DUE TO ERROR IN LEDGER POSTING, THE FILE COULD NOT BE UPLOADED.'                               
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                       
    RETURN                                             
    END                                                            
                                                              
  DROP TABLE #LEDGER                                                            
                                    
/*======BANK SIDE RECORD======*/                                                            
  INSERT INTO #LEDGER3                                                            
  SELECT   NARATNO = 1,                                                            
           NARRATION = MAX(NARRATION),                                                            
           REFNO = 0,                                                            
           VTYP,                                                            
           VNO,                                                            
           BOOKTYPE                                                            
  FROM     #RECPAY_TABLE                                              
  GROUP BY VTYP,VNO,BOOKTYPE                                                     
                                                              
/*======CLIENT SIDE RECORD======*/                                            
  INSERT INTO #LEDGER3                                                            
  SELECT NARATNO = LNO,                                                            
         NARR = NARRATION,                                                  
         REFNO = 0,                                                            
         VTYP,                                                            
VNO,                                                            
         BOOKTYPE                                                            
  FROM   #RECPAY_TABLE                                                            
                                                                     
/*======INSERTING ALL LEDGER3 RECORDS AT ONE TIME======*/                                                            
  INSERT INTO LEDGER3                                                            
  SELECT   *                                                            
  FROM     #LEDGER3                                                            
  ORDER BY BOOKTYPE,                                                            
    VTYP,                                                            
           VNO,                                                            
           NARATNO                                                            
                                                                       
  IF @@ERROR <> 0                                                        
    BEGIN               
    DROP TABLE #LEDGER3                                                                
    DROP TABLE #RECPAY_TABLE                                                            
    ROLLBACK TRAN                                                    
    SET @ERRORCODE = 1                                                                     
    SET @MESSAGE = 'DUE TO ERROR IN LEDGER3 POSTING, THE FILE COULD NOT BE UPLOADED.'                                                   
    EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                                        
    RETURN                                                   
    END                                                                                                      
  DROP TABLE #LEDGER3                                                            
                                                              
  IF @@BRANCHFLAG = 1                                                            
    BEGIN                                                            
      SET @@L2CUR = CURSOR FOR SELECT   DISTINCT VNO                                                            
              FROM     #RECPAY_TABLE                                                            
         ORDER BY VNO                                                            
                                             
      OPEN @@L2CUR                                                            
                                                                  
      FETCH NEXT FROM @@L2CUR                                                            
      INTO @@L2VNO               
                                                                
      WHILE @@FETCH_STATUS = 0                                                    BEGIN                                                            
          DELETE FROM TEMPLEDGER2                                                            
          WHERE       SESSIONID = '9999999999'                                                            
                                                                      
/*======CLIENT SIDE RECORD======*/                                                            
          INSERT INTO TEMPLEDGER2                                                            
          SELECT 'BRANCH',                                                            
                 C.COSTNAME,                                         
                 AMOUNT,                                                            
                 VTYP,                                                            
                 VNO,                                         
                 LNO,                                                            
                 DRCR,                                                            
                 '0',                         
    BOOKTYPE,                                                            
                 '9999999999',                                                            
                 CLIENT_CODE,                                                            
'A',                                                            
                 '0'                                                            
          FROM   #RECPAY_TABLE RP,                                                            
                 COSTMAST C WITH(NOLOCK)                                                             
          WHERE  RP.COSTCODE = C.COSTCODE                                                            
                 AND VNO = @@L2VNO     
  
PRINT 'suresh bamanikar ANI'                                                         
                                                   
/*======BANK SIDE RECORD======*/                                                            
          INSERT INTO TEMPLEDGER2                                                            
          SELECT   'BRANCH',                                                            
                   C.COSTNAME,                                                            
                   SUM(AMOUNT),                                                            
                   VTYP,                                                            
           VNO,                                                        
                   LNO = 1,                                                            
                   DRCR = (CASE                                                             
                             WHEN DRCR = 'D' THEN 'C'                                                            
                       ELSE 'D'                                                            
                           END),                                                            
                   '0',                                                            
                   BOOKTYPE,                                                            
                   '9999999999',                                                            
                   BANK_CODE,                                                            
                   'A',                                                            
                   '0'                                                            
          FROM     #RECPAY_TABLE RP,                                                            
                   COSTMAST C WITH(NOLOCK)                              
          WHERE    RP.BANKCOST = C.COSTCODE                                                            
    AND VNO = @@L2VNO                                          
          GROUP BY C.COSTNAME,VTYP,VNO,(CASE                                                             
                   WHEN DRCR = 'D' THEN 'C'                                                            
                      ELSE 'D'                                                            
                    END),                                                            
      BANK_CODE,BOOKTYPE                                                            
                                                                      
          EXEC INSERTTOLEDGER2                                                            
            '9999999999' ,                                                            
      @@L2VNO ,                                                            
            '1' ,                                                            
       '1' ,                                                            
            '1' ,                                                            
            'BROKER' ,                                                            
            'BROKER'                                                            
                          
 FETCH NEXT FROM @@L2CUR                                                            
          INTO @@L2VNO                                                            
        END                                  
                                                                  
     DELETE FROM TEMPLEDGER2 WITH(ROWLOCK)                                                            
      WHERE       SESSIONID = '9999999999'                                                            
                              
      IF EXISTS (SELECT *                                                            
           FROM   DBO.SYSOBJECTS WITH(NOLOCK)                                                             
           WHERE  ID = OBJECT_ID(N'[THIRDPARTY_COLLECTION]')                                                            
                  AND OBJECTPROPERTY(ID,N'IsUserTable') = 1)                                                       
         AND @@VTYP = 2                                                            
        BEGIN                                                            
          INSERT INTO THIRDPARTY_COLLECTION                                      
(VNO,                                                            
                      VTYP,                                                            
                      BOOKTYPE,                                                            
                      CLTCODE,                                                            
                      AMOUNT,                                                            
                      VDT,                         
                      DDNO,                             
 ACCOUNT_NO,                                                            
                      TPR_FLAG)                                                            
          SELECT   VNO,                                                            
                   VTYP,                                                   
                   BOOKTYPE,                                                            
                   CLIENT_CODE,                                                            
                   AMOUNT,                                                            
                   VDT,                               
                   MAX(REF_NO),                                                            
                   ACC_NO,                                                            
                   TPR_FLAG = 'S'                               
          FROM     #RECPAY_TABLE                                                            
          GROUP BY VNO,VTYP,BOOKTYPE,CLIENT_CODE,       
                   AMOUNT,VDT,ACC_NO                                                            
                                                                               
          UPDATE T                                                            
          SET    TPR_FLAG = 'C'                                                            
          FROM                                       
     THIRDPARTY_COLLECTION T WITH(NOLOCK),                                                            
                 MULTIBANKID M WITH(NOLOCK),                                                            
                 #RECPAY_TABLE R                                                            
          WHERE  T.CLTCODE = M.CLTCODE               
                 AND M.ACCNO = T.ACCOUNT_NO                                                            
                 AND T.VNO = R.VNO                                                 
                 AND T.VTYP = R.VTYP                                                            
                 AND T.BOOKTYPE = R.BOOKTYPE                                                            
        END                                                            
                                                              
   COMMIT TRANSACTION                                                            
 END                                                            
                                           
UPDATE ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES --WITH(ROWLOCK)                          
SET                                                      
 ROWSTATE = 1,                                                          
 APPROVALFLAG = 1,                         
 APPROVALDATE = GETDATE(),                                                          
 APPROVEDBY = 'SYSTEM',                                                          
 LEDGERVNO = VNO                                                            
FROM   #RECPAY_TABLE                                            
WHERE  FLDAUTO = #RECPAY_TABLE.FLD_AUTO                                                            
                                                                  
                                           
DROP TABLE #RECPAY_TABLE                                       
SET @ERRORCODE = 0                                                                     
SET @MESSAGE = 'POSTED SUCCESSFULLY'          
EXEC ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_UPLOAD_PUTLOG  @EXCHANGE, @SEGMENT, 2, @ERRORCODE, @MESSAGE, @UNAME                                     
                                    
                                    
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD_BULK
-- --------------------------------------------------

CREATE PROC [dbo].[V2_OFFLINE_RECPAYUPLOAD_BULK]                      
 @FNAME VARCHAR(100),                      
 @UNAME VARCHAR(25),                      
 @USERCAT SMALLINT,                  
 @EXCHANGE VARCHAR(3),                    
 @SEGMENT  VARCHAR(10),                    
 @STATUSID VARCHAR(15),                    
 @STATUSNAME VARCHAR(15)                      
                      
AS                      
/*                      
BEGIN DISTRIBUTED TRANSACTION --BEGIN TRAN                      
Exec V2_OFFLINE_RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\Recpay.csv', 'DEMO', 120,'NSE', 'CAPITAL','broker','broker'                 
ROLLBACK                      
*/                      
set xact_abort on            
            
            
SET NOCOUNT ON                      
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/                      
DECLARE                      
 @@STD_DATE VARCHAR(11),                      
 @@LST_DATE VARCHAR(11),                      
 @@BRANCHFLAG AS TINYINT,                      
 @@VNOFLAG AS TINYINT,                      
 @@VNOMETHOD INT,                      
 @@ACNAME CHAR(100),                      
 @@BOOKTYPE CHAR(2),                      
 @@MICRNO VARCHAR(10),                      
 @@DRCR VARCHAR(1),                      
 @@VTYP SMALLINT,                      
 @@BANK_CODE VARCHAR(100),                      
 @@BACKDAYS INT,                      
 @@BACKDATE VARCHAR(11),                      
 @@BRNCOUNT   TINYINT,                      
 @@MonthlyVdt VARCHAR(11),                      
 @@SERIAL_NO INT,                      
 @@COSTCODECOUNT TINYINT,                      
 @@COSTCODEUPDATES CURSOR,                      
 @@NEWVNO AS VARCHAR(12),                      
 @@MAXCOUNT AS INT,                      
 @@VDT AS VARCHAR(11),                      
 @@BANKBRANCH AS VARCHAR(10),                      
 @@BANKCOST AS NUMERIC,                      
 @@LNOCUR AS CURSOR,                      
 @@VNOCUR AS CURSOR,                      
 @@LNOVNO AS VARCHAR(12),                      
 @@MAXVNO AS INT,                      
 @@L2CUR AS CURSOR,                      
 @@L2VNO AS VARCHAR(12),                      
 @@ERROR_COUNT AS INT,                      
 @@FILEEXISTS AS INT,                      
 @@SQL AS VARCHAR(2000),                  
 @@MyTempVno AS VARCHAR(12)                        
                      
SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
  SELECT                      
   U_FILENAME                      
  FROM                      
   V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
 ) A                      
IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT                      
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'                      
  RETURN                      
 END                      
CREATE TABLE #FEXIST                      
(                      
 F1 SMALLINT,                      
 F2 SMALLINT,                      
 F3 SMALLINT                      
)                      
SELECT @@SQL = "INSERT INTO "                      
SELECT @@SQL = @@SQL + " #FEXIST "                      
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                      
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                      
                      
EXEC(@@SQL)                      
                      
SELECT                      
 @@FILEEXISTS = F1                      
FROM                      
 #FEXIST                      
                      
IF @@FILEEXISTS = 0                      
 BEGIN                      
  DROP TABLE #FEXIST                      
  SELECT                      
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                      
  RETURN                      
 END                      
DROP TABLE #FEXIST                      
                      
BEGIN DISTRIBUTED TRANSACTION --BEGIN TRAN                 
CREATE TABLE #RECPAY_TABLE_TMP                      
(                      
 SERIAL_NO INT,                      
 EDATE VARCHAR(20),                      
 VOUCHER_DATE VARCHAR(20),                      
 CLIENT_CODE VARCHAR(50),                      
 AMOUNT MONEY,                      
 DRCR VARCHAR(1),                      
 NARRATION VARCHAR(234),                      
 BANK_CODE VARCHAR(10),                      
 BANK_NAME VARCHAR(100),                  
 REF_NO VARCHAR(30),                      
 BRANCHCODE VARCHAR(20),                      
 BRANCH_NAME VARCHAR(50),                      
 CHQ_MODE VARCHAR(1),                      
 CHQ_DATE VARCHAR(20),                      
 CHQ_NAME VARCHAR(100),                      
 CL_MODE VARCHAR(1),                          
 ACCOUNTNO VARCHAR(25)                  
)                   
                    
CREATE TABLE [#RECPAY_TABLE]                      
 (                      
  SERIAL_NO INT,                      
  EDATE VARCHAR(20),                      
  VOUCHER_DATE VARCHAR(20),                      
  CLIENT_CODE VARCHAR(50),                      
  AMOUNT MONEY,                      
  DRCR VARCHAR(1),                      
  NARRATION VARCHAR(234),                      
  BANK_CODE VARCHAR(10),                      
  BANK_NAME VARCHAR(100),                      
  REF_NO VARCHAR(30),                      
  BRANCHCODE VARCHAR(20),                      
  BRANCH_NAME VARCHAR(50),                      
  CHQ_MODE VARCHAR(1),                      
  CHQ_DATE VARCHAR(20),                      
  CHQ_NAME VARCHAR(100),                      
  CL_MODE VARCHAR(1),                      
  SNO INT IDENTITY (1, 1) NOT NULL ,                      
  VDT DATETIME NULL ,                      
  FYSTART DATETIME NULL ,                      
  FYEND DATETIME NULL ,                      
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),                      
  EDT DATETIME NULL ,                      
  DDDT DATETIME NULL ,                      
  VNO VARCHAR (12) NULL ,                      
  VTYP SMALLINT NULL ,                      
  ACNAME VARCHAR (100) NULL ,                      
  COSTCODE SMALLINT NULL,                      
  BANKCOST SMALLINT NULL,                      
  LNO SMALLINT NOT NULL DEFAULT(0),                      
  BANKNAME VARCHAR(100) NULL,                    
  MICRNO INT NULL,                      
  BOOKTYPE VARCHAR(2) NULL,                   
  ACCOUNTNO VARCHAR(25),                
  TPFLAG INT                   
 ) ON [PRIMARY]                    
                  
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                      
EXEC (@@SQL)                      
                      
IF @@ERROR <> 0                      
 BEGIN                      
  DROP TABLE #RECPAY_TABLE_TMP                      
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRANSACTION                      
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                      
  RETURN                      
 END                      
INSERT INTO                      
 V2_UPLOADED_FILES                      
SELECT                      
 @FNAME,                      
 @FNAME,                      
 CNT = COUNT(1),                      
 'B',                      
 GETDATE(),                      
 @UNAME,                      
 'RECEIPT/PAYMENT UPLOAD'                      
                      
INSERT INTO                      
 #RECPAY_TABLE                      
 (                      
  SERIAL_NO,                      
  EDATE,                      
  VOUCHER_DATE,                      
  CLIENT_CODE,                      
  AMOUNT,                      
  DRCR,                      
  NARRATION,                      
  BANK_CODE,                 
  BANK_NAME,                      
  REF_NO,                      
  BRANCHCODE,                      
  BRANCH_NAME,                      
  CHQ_MODE,                      
  CHQ_DATE,                      
  CHQ_NAME,                      
  CL_MODE,                  
  ACCOUNTNO,                
  TPFLAG                      
 )                      
SELECT                      
 SERIAL_NO,                      
 EDATE,                      
 VOUCHER_DATE,                      
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),                      
 AMOUNT,                      
 UPPER(LTRIM(RTRIM(DRCR))),                      
 NARRATION,                      
 UPPER(LTRIM(RTRIM(BANK_CODE))),                      
 UPPER(LTRIM(RTRIM(BANK_NAME))),                      
 REF_NO,                      
 UPPER(LTRIM(RTRIM(BRANCHCODE))),                      
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),                      
 UPPER(LTRIM(RTRIM(CHQ_MODE))),                      
 CHQ_DATE,                      
 CHQ_NAME,                      
 CL_MODE,                  
 ACCOUNTNO,                
 TPFLAG = 1                  
FROM                      
 #RECPAY_TABLE_TMP                      
                      
UPDATE                      
 #RECPAY_TABLE                      
SET                      
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))                      
                      
                     
SELECT                      
 @@ERROR_COUNT = COUNT(DISTINCT VDT)                      
FROM                      
 #RECPAY_TABLE                      
                      
IF @@ERROR_COUNT > 1                      
 BEGIN                      
  DROP TABLE #RECPAY_TABLE_TMP                      
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRANSACTION                      
  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                      
  RETURN                      
 END                      
                      
SELECT TOP 1                      
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)                      
FROM                      
 #RECPAY_TABLE                      
                      
SELECT                      
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                      
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                      
 @@BRANCHFLAG = BRANCHFLAG,             @@VNOFLAG = VNOFLAG                      
FROM                      
 PARAMETER                      
WHERE                      
 @@VDT BETWEEN SDTCUR AND LDTCUR                      
                  
DECLARE @@VDTNEW VARCHAR(11)
SELECT TOP 1 @@VDTNEW = CONVERT(VARCHAR(11),CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),109)  
FROM #RECPAY_TABLE

                      
IF @@BRANCHFLAG = 1                      
 BEGIN                     
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   BRANCHCODE = A.BRANCHCODE,                      
   FYSTART = P.SDTCUR,                      
   FYEND = P.LDTCUR,                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                      
   COSTCODE = C.COSTCODE,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                      
  WHERE                      
   A.CLTCODE = CLIENT_CODE                      
   AND B.CLTCODE = BANK_CODE                      
-- AND P.CURYEAR = 1                      
   AND @@VDTNEW BETWEEN P.SDTCUR AND P.LDTCUR
   AND A.ACCAT IN ('3','4','18')                      
   AND B.ACCAT = '2'                      
   AND A.BRANCHCODE = COSTNAME                      
                        
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                      
   FYSTART = P.SDTCUR,                      
   FYEND = P.LDTCUR,                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                      
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                      
  WHERE                      
   A.CLTCODE = CLIENT_CODE                      
   AND B.CLTCODE = BANK_CODE                      
-- AND P.CURYEAR = 1                      
   AND @@VDTNEW BETWEEN P.SDTCUR AND P.LDTCUR
   AND A.ACCAT IN ('3','4','18')                      
   AND B.ACCAT = '2'                      
   AND A.BRANCHCODE = 'ALL'                      
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                      
                    
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   BRANCHCODE = 'HO',                      
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                      
   FYSTART = P.SDTCUR,                      
   FYEND = P.LDTCUR,                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                    
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                      
  WHERE                      
   A.CLTCODE = CLIENT_CODE                      
   AND B.CLTCODE = BANK_CODE                      
-- AND P.CURYEAR = 1                      
   AND @@VDTNEW BETWEEN P.SDTCUR AND P.LDTCUR
   AND A.ACCAT IN ('3','4','18')                      
   AND B.ACCAT = '2'                      
   AND A.BRANCHCODE = 'ALL'                      
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                      
 END                      
ELSE                
 BEGIN                      
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   FYSTART = @@STD_DATE,                      
   FYEND = @@LST_DATE + ' 23:59:59',                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   ACMAST A, ACMAST B                      
  WHERE                      
   A.CLTCODE = CLIENT_CODE                      
   AND B.CLTCODE = BANK_CODE                      
   AND A.ACCAT IN ('3','4','18')                      
   AND B.ACCAT = '2'                      
 END 
 
  
 UPDATE R SET UPDFLAG = 'B'     
 FROM #RECPAY_TABLE R    
 WHERE BANK_CODE  IN (SELECT CLTCODE FROM ACMAST_DETAILS WHERE INACTIVE_FLAG = 'N') 
 
 /* VALIDATION OF DUPLICATE CHEQUE ENTRY WITHIN FILE */
 
 SET @@ERROR_COUNT = 0

 SELECT @@ERROR_COUNT = COUNT(1) FROM
 (SELECT CLTCODE, REF_NO, AMOUNT, DRCR FROM #RECPAY_TABLE GROUP BY CLTCODE, REF_NO, AMOUNT, DRCR HAVING COUNT(1) > 1) A

 IF @@ERROR_COUNT > 0
 BEGIN                      
   SELECT                      
    RESULT = 'SOME OF THE CHEQUE ENTRIES ARE DUPLICATE IN FILE'                      
   UNION ALL                      
   SELECT                      
    RESULT = 'DUPLICATE CHQ:' + LTRIM(RTRIM(CONVERT(VARCHAR, REF_NO))) + ', CLTCODE:' + CONVERT(VARCHAR, CLTCODE)                      
   FROM                      
    #RECPAY_TABLE                      
   GROUP BY CLTCODE, REF_NO, AMOUNT, DRCR HAVING COUNT(1) > 1                    
                      
   DROP TABLE #RECPAY_TABLE_TMP                      
   DROP TABLE #RECPAY_TABLE                      
   ROLLBACK TRAN                      
   DELETE                      
   FROM                      
    V2_UPLOADED_FILES                      
   WHERE                      
    U_FILENAME = @FNAME                      
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
 END 
 /* VALIDATION OF DUPLICATE CHEQUE ENTRY WITHIN FILE */
                      
                      
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */                      
                      
 SELECT                      
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                      
 FROM                      
  #RECPAY_TABLE                      
 IF @@ERROR_COUNT > 1                      
  BEGIN                      
   SELECT                      
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'                      
   DROP TABLE #RECPAY_TABLE_TMP                      
   DROP TABLE #RECPAY_TABLE                      
   ROLLBACK TRAN                      
   DELETE                      
   FROM                      
    V2_UPLOADED_FILES                      
   WHERE                      
    U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
  END                      
                  
                  
/*--------------------------VALIDATION FOR DIFFERENT SERIAL_NO IN SAME VOUCHER ------------------------*/                      
/*SELECT @@ERROR_COUNT = COUNT(SERIAL_NO) FROM  #RECPAY_TABLE                   
GROUP BY SERIAL_NO, VDT HAVING COUNT(SERIAL_NO) > 1                  
 IF @@ERROR_COUNT > 1                     
  BEGIN                      
   SELECT 'SOME OF THE VOUCHERS ARE HAVING SAME SERIAL_NO ', 'NA', 'NA'                      
   DROP TABLE #RecPay_Table_Tmp                      
   DROP TABLE #RecPay_Table                      
   ROLLBACK TRAN                      
   DELETE FROM V2_Uploaded_Files                      
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
  END        */          
                      
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */                      
 SELECT                      
  @@ERROR_COUNT = COUNT(1)                      
 FROM                      
  (                      
   SELECT                      
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),                      
    SERIAL_NO                      
   FROM                      
    #RECPAY_TABLE                      
   GROUP BY                    
    SERIAL_NO                      
   HAVING                      
    COUNT(DISTINCT BANK_CODE) > 1                      
  ) A                      
 IF @@ERROR_COUNT > 0                      
  BEGIN                      
   SELECT                      
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'                      
   UNION ALL                      
   SELECT                      
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))                      
   FROM                      
    #RECPAY_TABLE                      
   GROUP BY                      
    SERIAL_NO                      
   HAVING                      
    COUNT(DISTINCT BANK_CODE) > 1                      
                      
   DROP TABLE #RECPAY_TABLE_TMP                      
   DROP TABLE #RECPAY_TABLE                      
   ROLLBACK TRAN                      
   DELETE                      
   FROM                      
    V2_UPLOADED_FILES                      
   WHERE                      
    U_FILENAME = @FNAME                      
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
 END                      
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */                      
SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
 SELECT DISTINCT                      
  DRCR                      
 FROM                      
  #RECPAY_TABLE                      
 ) A                      
IF @@ERROR_COUNT > 1                      
 BEGIN                      
  SELECT                      
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'                      
  DROP TABLE #RECPAY_TABLE_TMP                      
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRAN                      
  DELETE                      
  FROM                      
   V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
ELSE                      
 BEGIN                      
  SELECT TOP 1                      
   @@DRCR = DRCR,                      
   @@VTYP =                      
    (                      
    CASE                      
     WHEN DRCR = 'D'                      
     THEN 3                      
     ELSE 2                      
    END                      
    )                      
  FROM                      
   #RECPAY_TABLE                      
  UPDATE                      
   #RECPAY_TABLE                      
  SET VTYP =                      
   (                      
   CASE                      
     WHEN DRCR = 'D'                      
     THEN 3                      
     ELSE 2                      
    END                 
   )                      
 END                      
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/                      
 SELECT @@ERROR_COUNT = COUNT(1)                      
 FROM #RECPAY_TABLE                      
 WHERE VDT > EDT                      
            IF @@ERROR_COUNT > 0                      
             BEGIN                      
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                      
     DROP TABLE #RECPAY_TABLE_TMP                      
     DROP TABLE #RECPAY_TABLE                      
     ROLLBACK TRAN                      
     DELETE FROM                      
      V2_UPLOADED_FILES                      
     WHERE                      
      U_FILENAME = @FNAME                      
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
     RETURN                      
             END                      
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/                      
 SELECT @@ERROR_COUNT = COUNT(1)                      
 FROM #RECPAY_TABLE                      
 WHERE AMOUNT <= 0                      
 IF @@ERROR_COUNT > 0                      
  BEGIN                      
     SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                      
     DROP TABLE #RECPAY_TABLE_TMP                      
     DROP TABLE #RECPAY_TABLE                      
     ROLLBACK TRAN                      
     DELETE FROM                      
      V2_UPLOADED_FILES                      
     WHERE                      
      U_FILENAME = @FNAME                      
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
     RETURN                      
  END        
            
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------                            
   SELECT                                  
     @@BACKDAYS = ISNULL(MIN(NODAYS), 0)                                  
    FROM                                  
     USERWRITESTABLE            
    WHERE                                  
     USERCATEGORY = @USERCAT                                  
     AND VTYP = @@VTYP                                  
     AND BOOKTYPE = '01'            
                               
    SELECT                                  
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS                                  
    SELECT                                  
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)                                  
    FROM                                  
     #RECPAY_TABLE                                  
    WHERE                                  
     VDT < @@BACKDATE    
                                 
    IF @@ERROR_COUNT > 0                                  
     BEGIN                                  
  SELECT 'FEW OF THE VOUCHRS ARE BACKDATED WHICH IS NOT ALLOWED.'                  
  DROP TABLE #RECPAY_TABLE_TMP            
  DROP TABLE #RECPAY_TABLE            
  ROLLBACK TRAN            
  IF @@VTYP = 2     
   BEGIN            
    DELETE FROM V2_UPLOADED_FILES            
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
   END            
  ELSE            
   BEGIN            
    DELETE FROM V2_UPLOADED_FILES            
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
   END            
  RETURN                          
     END               
        
/*--------VALIDATION OF FUTURE DATE WITH HARDCODE 2 DAYS -----*/  
        
 SELECT                
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                
 FROM        
  #RECPAY_TABLE where vdt > getdate()+2     
  
IF @@ERROR_COUNT > 0                                  
   BEGIN                                  
  SELECT 'FEW OF THE VOUCHRS ARE FUTURE DATED WHICH IS NOT ALLOWED.'                  
  DROP TABLE #RECPAY_TABLE_TMP            
  DROP TABLE #RECPAY_TABLE            
  ROLLBACK TRAN            
  IF @@VTYP = 2            
   BEGIN            
    DELETE FROM V2_UPLOADED_FILES            
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
   END            
  ELSE            
   BEGIN            
    DELETE FROM V2_UPLOADED_FILES            
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
   END            
  RETURN                          
 END                 
           
/*------------ */          
  
             
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */   
SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
   SELECT DISTINCT              
   DDNO  = RP.REF_NO             
  FROM              
   #RECPAY_TABLE RP,              
   LEDGER1 L1 WITH (NOLOCK),LEDGER L              
    WITH(NOLOCK)              
  WHERE              
   L1.DDNO = RP.REF_NO    
   AND L.VNO=L1.VNO
   AND L.VTYP=L1.VTYP
   AND L.BOOKTYPE=L1.BOOKTYPE  
   AND L.VDT>= CONVERT(VARCHAR(11),GETDATE()-45,120)    
    AND  L.CLTCODE=RP.CLIENT_CODE    
  -- AND L1.BNKNAME = RP.BANK_NAME            
   --AND L1.DD = RP.CHQ_MODE              
   AND L1.DRCR = @@DRCR              
   AND L1.VTYP = @@VTYP              
   AND RP.REF_NO <> '0'   
   
   UNION 

   SELECT DISTINCT              
   DDNO  = RP.REF_NO             
  FROM              
   #RECPAY_TABLE RP,              
   ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES L1    WITH(NOLOCK)          
                  
  WHERE              
   L1.DDNO = RP.REF_NO    
   --AND L.VTYP=L1.VTYP
   ---AND L.BOOKTYPE=L1.BOOKTYPE  
   AND L1.vdate>= CONVERT(VARCHAR(11),GETDATE()-45,120)    
    AND  L1.CLTCODE=RP.CLIENT_CODE    
  -- AND L1.BNKNAME = RP.BANK_NAME            
   --AND L1.DD = RP.CHQ_MODE              
   --AND L1.DRCR = @@DRCR              
   --AND L1.VTYP = @@VTYP              
   AND RP.REF_NO <> '0'   
          
 ) A              
IF @@ERROR_COUNT > 0              
 BEGIN              
  SELECT              
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'              
  UNION ALL              
  SELECT DISTINCT              
   RP.REF_NO, 'NA','NA'              
  FROM              
   #RECPAY_TABLE RP,              
    LEDGER1 L1 WITH (NOLOCK),LEDGER L              
    WITH(NOLOCK)              
  WHERE              
   L1.DDNO = RP.REF_NO    
   AND L.VNO=L1.VNO
   AND L.VTYP=L1.VTYP
   AND L.BOOKTYPE=L1.BOOKTYPE  
   AND L.VDT>= CONVERT(VARCHAR(11),GETDATE()-45,120)   
   AND  L.CLTCODE=RP.CLIENT_CODE    
  -- AND L1.BNKNAME = RP.BANK_NAME            
   --AND L1.DD = RP.CHQ_MODE              
   AND L1.DRCR = @@DRCR              
   AND L1.VTYP = @@VTYP                
   AND RP.CHQ_MODE <> 'N'  
   
   
   
    UNION 

   SELECT DISTINCT              
   DDNO  = RP.REF_NO , 'NA','NA'                    
  FROM              
   #RECPAY_TABLE RP,              
   ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES L1    WITH(NOLOCK)          
                
  WHERE              
   L1.DDNO = RP.REF_NO    
   --AND L.VTYP=L1.VTYP
   ---AND L.BOOKTYPE=L1.BOOKTYPE  
   AND L1.Vdate>= CONVERT(VARCHAR(11),GETDATE()-45,120)    
    AND  L1.CLTCODE=RP.CLIENT_CODE    
  -- AND L1.BNKNAME = RP.BANK_NAME            
   --AND L1.DD = RP.CHQ_MODE              
   --AND L1.DRCR = @@DRCR              
   --AND L1.VTYP = @@VTYP   
   
                          
  DROP TABLE #RECPAY_TABLE_TMP                   
   DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE FROM                          
   V2_UPLOADED_FILES                          
  WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
  RETURN                          
 END                 
                
/*   --------------------------VALIDATION FOR ACCOUNT NUMBER ------------------------ */                      
/*SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
  SELECT DISTINCT                      
   RP.ACCOUNTNO                    
  FROM                      
   #RECPAY_TABLE RP,                      
   MULTIBANKID M                      
    WITH(NOLOCK)                     
  WHERE                      
   M.ACCNO = RP.ACCOUNTNO                      
 ) A                      
IF @@ERROR_COUNT <= 0                      
 BEGIN                      
  SELECT                      
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING ACCOUNT NUMBER DOEST NOT EXISTS', 'NA','NA'                      
  UNION ALL                      
  SELECT DISTINCT                      
   RP.ACCOUNTNO, 'NA','NA'                      
  FROM                      
   #RECPAY_TABLE RP,                      
   MULTIBANKID M                      
    WITH(NOLOCK)                      
  WHERE                      
   M.ACCNO <> RP.ACCOUNTNO                   
                      
  DROP TABLE #RECPAY_TABLE_TMP                     
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRAN                      
  DELETE FROM                      
   V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
*/    

/*--------------------------FINAL VALIDATION BASED ON BLOCKING ------------------------*/                            
SELECT                            
 @@ERROR_COUNT = COUNT(1)                            
FROM                            
 (                            
  SELECT DISTINCT                            
   BANK_CODE                            
  FROM                            
   #RECPAY_TABLE                            
  WHERE                            
   UPDFLAG = 'B'                            
 ) A                            
IF @@ERROR_COUNT > 0                            
 BEGIN                            
  SELECT                            
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS ARE BLOCKED', 'NA','NA'                            
  UNION ALL                            
  SELECT DISTINCT                            
   BANK_CODE, 'NA','NA'                            
  FROM                            
   #RECPAY_TABLE                            
  WHERE                            
   UPDFLAG = 'B'                            
  DROP TABLE #RECPAY_TABLE_TMP                            
DROP TABLE #RECPAY_TABLE                            
  ROLLBACK TRAN                            
  DELETE FROM                            
   V2_UPLOADED_FILES                          WHERE                     
   U_FILENAME = @FNAME                            
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                            
  RETURN                            
 END                              
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/                      
SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
  SELECT DISTINCT                      
   CLIENT_CODE                      
  FROM                      
   #RECPAY_TABLE                      
  WHERE                      
   UPDFLAG = 'N'                      
 ) A                      
IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT                      
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'                      
  UNION ALL                      
  SELECT DISTINCT                      
   CLIENT_CODE, 'NA','NA'                      
  FROM                      
   #RECPAY_TABLE                      
  WHERE                      
   UPDFLAG = 'N'                      
  DROP TABLE #RECPAY_TABLE_TMP                      
DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRAN                      
  DELETE FROM                      
   V2_UPLOADED_FILES                      
  WHERE               
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
                 
 SET @@MyTempVno = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6)                     
                
                 
UPDATE                      
 R                
SET                 
TPFLAG = 0                
FROM                
 #RECPAY_TABLE R,                
 MULTIBANKID M                
WHERE                 
 R.CLIENT_CODE = M.CLTCODE                
 AND M.ACCNO = R.ACCOUNTNO                
                 
                
INSERT INTO ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES                      
   (VOUCHERTYPE,                      
   BOOKTYPE,                      
   SNO,                      
   VDATE,                      
   EDATE,                      
   CLTCODE,                      
   CREDITAMT,                      
   DEBITAMT,                      
   NARRATION,                    
   OPPCODE,                    
   BANKNAME,                    
   DDNO,                    
   BRANCHCODE,                    
   BRANCHNAME,                    
   CHEQUEMODE,                    
   CHEQUEDATE,                    
   CHEQUENAME,                    
   CLEAR_MODE,                    
   EXCHANGE,                      
   SEGMENT,                      
   TPFLAG,                      
   ADDDT,                      
   ADDBY,                      
   STATUSID,                      
   STATUSNAME,                      
   ROWSTATE,                      
   APPROVALFLAG,                      
   APPROVALDATE,                      
   APPROVEDBY,                      
   VOUCHERNO,              
   UPLOADDT,                      
   CLIENTNAME,                
   TPACCOUNTNUMBER)                      
                     
 SELECT                       
  @@VTYP,'01',SERIAL_NO, VDT, EDT, CLIENT_CODE,                       
  CASE WHEN DRCR = 'C' THEN AMOUNT ELSE 0 END, CASE WHEN DRCR = 'D' THEN AMOUNT ELSE 0 END, NARRATION,                    
  BANK_CODE,BANK_NAME,REF_NO,BRANCHCODE,BRANCH_NAME,CHQ_MODE,DDDT,CHQ_NAME,CL_MODE,                         
  @EXCHANGE, @SEGMENT,TPFLAG,GETDATE(),@UNAME,@STATUSID,@STATUSNAME,0,0,                      
  GETDATE(),'',@@MyTempVno,GETDATE(),ACNAME,ACCOUNTNO                      
 FROM                       
  #RECPAY_TABLE                      
                    
COMMIT TRANSACTION                    
                      
SELECT 'CLTCODE, AMOUNT, REF_VNO' Union ALL                        
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + @@MyTempVno As RESULT FROM #RECPAY_TABLE                        
                    
DROP TABLE #RECPAY_TABLE_TMP                        
DROP TABLE #RECPAY_TABLE             
            
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD_BULK_12072011
-- --------------------------------------------------

CREATE PROC [dbo].[V2_OFFLINE_RECPAYUPLOAD_BULK_12072011]                      
 @FNAME VARCHAR(100),                      
 @UNAME VARCHAR(25),                      
 @USERCAT SMALLINT,                  
 @EXCHANGE VARCHAR(3),                    
 @SEGMENT  VARCHAR(10),                    
 @STATUSID VARCHAR(15),                    
 @STATUSNAME VARCHAR(15)                      
                      
AS                      
/*                      
BEGIN DISTRIBUTED TRANSACTION --BEGIN TRAN                      
Exec V2_OFFLINE_RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\Recpay.csv', 'DEMO', 120,'NSE', 'CAPITAL','broker','broker'                 
ROLLBACK                      
*/                      
set xact_abort on            
            
            
SET NOCOUNT ON                      
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/                      
DECLARE                      
 @@STD_DATE VARCHAR(11),                      
 @@LST_DATE VARCHAR(11),                      
 @@BRANCHFLAG AS TINYINT,                      
 @@VNOFLAG AS TINYINT,                      
 @@VNOMETHOD INT,                      
 @@ACNAME CHAR(100),                      
 @@BOOKTYPE CHAR(2),                      
 @@MICRNO VARCHAR(10),                      
 @@DRCR VARCHAR(1),                      
 @@VTYP SMALLINT,                      
 @@BANK_CODE VARCHAR(100),                      
 @@BACKDAYS INT,                      
 @@BACKDATE VARCHAR(11),                      
 @@BRNCOUNT   TINYINT,                      
 @@MonthlyVdt VARCHAR(11),                      
 @@SERIAL_NO INT,                      
 @@COSTCODECOUNT TINYINT,                      
 @@COSTCODEUPDATES CURSOR,                      
 @@NEWVNO AS VARCHAR(12),                      
 @@MAXCOUNT AS INT,                      
 @@VDT AS VARCHAR(11),                      
 @@BANKBRANCH AS VARCHAR(10),                      
 @@BANKCOST AS NUMERIC,                      
 @@LNOCUR AS CURSOR,                      
 @@VNOCUR AS CURSOR,                      
 @@LNOVNO AS VARCHAR(12),                      
 @@MAXVNO AS INT,                      
 @@L2CUR AS CURSOR,                      
 @@L2VNO AS VARCHAR(12),                      
 @@ERROR_COUNT AS INT,                      
 @@FILEEXISTS AS INT,                      
 @@SQL AS VARCHAR(2000),                  
 @@MyTempVno AS VARCHAR(12)                        
                      
SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
  SELECT                      
   U_FILENAME                      
  FROM                      
   V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
 ) A                      
IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT                      
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'                      
  RETURN                      
 END                      
CREATE TABLE #FEXIST                      
(                      
 F1 SMALLINT,                      
 F2 SMALLINT,                      
 F3 SMALLINT                      
)                      
SELECT @@SQL = "INSERT INTO "                      
SELECT @@SQL = @@SQL + " #FEXIST "                      
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                      
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                      
                      
EXEC(@@SQL)                      
                      
SELECT                      
 @@FILEEXISTS = F1                      
FROM                      
 #FEXIST                      
                      
IF @@FILEEXISTS = 0                      
 BEGIN                      
  DROP TABLE #FEXIST                      
  SELECT                      
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                      
  RETURN                      
 END                      
DROP TABLE #FEXIST                      
                      
BEGIN DISTRIBUTED TRANSACTION --BEGIN TRAN                 
CREATE TABLE #RECPAY_TABLE_TMP                      
(                      
 SERIAL_NO INT,                      
 EDATE VARCHAR(20),                      
 VOUCHER_DATE VARCHAR(20),                      
 CLIENT_CODE VARCHAR(50),                      
 AMOUNT MONEY,                      
 DRCR VARCHAR(1),                      
 NARRATION VARCHAR(234),                      
 BANK_CODE VARCHAR(10),                      
 BANK_NAME VARCHAR(100),                  
 REF_NO VARCHAR(15),                      
 BRANCHCODE VARCHAR(20),                      
 BRANCH_NAME VARCHAR(50),                      
 CHQ_MODE VARCHAR(1),                      
 CHQ_DATE VARCHAR(20),                      
 CHQ_NAME VARCHAR(100),                      
 CL_MODE VARCHAR(1),                          
 ACCOUNTNO VARCHAR(25)                  
)                   
                    
CREATE TABLE [#RECPAY_TABLE]                      
 (                      
  SERIAL_NO INT,                      
  EDATE VARCHAR(20),                      
  VOUCHER_DATE VARCHAR(20),                      
  CLIENT_CODE VARCHAR(50),                      
  AMOUNT MONEY,                      
  DRCR VARCHAR(1),                      
  NARRATION VARCHAR(234),                      
  BANK_CODE VARCHAR(10),                      
  BANK_NAME VARCHAR(100),                      
  REF_NO VARCHAR(15),                      
  BRANCHCODE VARCHAR(20),                      
  BRANCH_NAME VARCHAR(50),                      
  CHQ_MODE VARCHAR(1),                      
  CHQ_DATE VARCHAR(20),                      
  CHQ_NAME VARCHAR(100),                      
  CL_MODE VARCHAR(1),                      
  SNO INT IDENTITY (1, 1) NOT NULL ,                      
  VDT DATETIME NULL ,                      
  FYSTART DATETIME NULL ,                      
  FYEND DATETIME NULL ,                      
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),                      
  EDT DATETIME NULL ,                      
  DDDT DATETIME NULL ,                      
  VNO VARCHAR (12) NULL ,                      
  VTYP SMALLINT NULL ,                      
  ACNAME VARCHAR (100) NULL ,                      
  COSTCODE SMALLINT NULL,                      
  BANKCOST SMALLINT NULL,                      
  LNO SMALLINT NOT NULL DEFAULT(0),                      
  BANKNAME VARCHAR(100) NULL,                    
  MICRNO INT NULL,                      
  BOOKTYPE VARCHAR(2) NULL,                   
  ACCOUNTNO VARCHAR(25),                
  TPFLAG INT                   
 ) ON [PRIMARY]                    
                  
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                      
EXEC (@@SQL)                      
                      
IF @@ERROR <> 0                      
 BEGIN                      
  DROP TABLE #RECPAY_TABLE_TMP                      
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRANSACTION                      
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                      
  RETURN                      
 END                      
INSERT INTO                      
 V2_UPLOADED_FILES                      
SELECT                      
 @FNAME,                      
 @FNAME,                      
 CNT = COUNT(1),                      
 'B',                      
 GETDATE(),                      
 @UNAME,                      
 'RECEIPT/PAYMENT UPLOAD'                      
                      
INSERT INTO                      
 #RECPAY_TABLE                      
 (                      
  SERIAL_NO,                      
  EDATE,                      
  VOUCHER_DATE,                      
  CLIENT_CODE,                      
  AMOUNT,                      
  DRCR,                      
  NARRATION,                      
  BANK_CODE,                 
  BANK_NAME,                      
  REF_NO,                      
  BRANCHCODE,                      
  BRANCH_NAME,                      
  CHQ_MODE,                      
  CHQ_DATE,                      
  CHQ_NAME,                      
  CL_MODE,                  
  ACCOUNTNO,                
  TPFLAG                      
 )                      
SELECT                      
 SERIAL_NO,                      
 EDATE,                      
 VOUCHER_DATE,                      
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),                      
 AMOUNT,                      
 UPPER(LTRIM(RTRIM(DRCR))),                      
 NARRATION,                      
 UPPER(LTRIM(RTRIM(BANK_CODE))),                      
 UPPER(LTRIM(RTRIM(BANK_NAME))),                      
 REF_NO,                      
 UPPER(LTRIM(RTRIM(BRANCHCODE))),                      
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),                      
 UPPER(LTRIM(RTRIM(CHQ_MODE))),                      
 CHQ_DATE,                      
 CHQ_NAME,                      
 CL_MODE,                  
 ACCOUNTNO,                
 TPFLAG = 1                  
FROM                      
 #RECPAY_TABLE_TMP                      
                      
UPDATE                      
 #RECPAY_TABLE                      
SET                      
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))                      
                      
                     
SELECT                      
 @@ERROR_COUNT = COUNT(DISTINCT VDT)                      
FROM                      
 #RECPAY_TABLE                      
                      
IF @@ERROR_COUNT > 1                      
 BEGIN                      
  DROP TABLE #RECPAY_TABLE_TMP                      
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRANSACTION                      
  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                      
  RETURN                      
 END                      
                      
SELECT TOP 1                      
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)                      
FROM                      
 #RECPAY_TABLE                      
                      
SELECT                      
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                      
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                      
 @@BRANCHFLAG = BRANCHFLAG,             @@VNOFLAG = VNOFLAG                      
FROM                      
 PARAMETER                      
WHERE                      
 @@VDT BETWEEN SDTCUR AND LDTCUR                      
                  
                      
IF @@BRANCHFLAG = 1                      
 BEGIN                     
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   BRANCHCODE = A.BRANCHCODE,                      
   FYSTART = P.SDTCUR,                      
   FYEND = P.LDTCUR,                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                      
   COSTCODE = C.COSTCODE,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                      
  WHERE                      
   A.CLTCODE = CLIENT_CODE                      
   AND B.CLTCODE = BANK_CODE                      
   AND P.CURYEAR = 1                      
   AND A.ACCAT IN ('3','4','18')                      
   AND B.ACCAT = '2'                      
   AND A.BRANCHCODE = COSTNAME                      
                        
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                      
   FYSTART = P.SDTCUR,                      
   FYEND = P.LDTCUR,                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                      
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                      
  WHERE                      
   A.CLTCODE = CLIENT_CODE                      
   AND B.CLTCODE = BANK_CODE                      
   AND P.CURYEAR = 1                      
   AND A.ACCAT IN ('3','4','18')                      
   AND B.ACCAT = '2'                      
   AND A.BRANCHCODE = 'ALL'                      
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                      
                    
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   BRANCHCODE = 'HO',                      
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                      
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                      
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                      
   FYSTART = P.SDTCUR,                      
   FYEND = P.LDTCUR,                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                    
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                      
  WHERE                      
   A.CLTCODE = CLIENT_CODE                      
   AND B.CLTCODE = BANK_CODE                      
   AND P.CURYEAR = 1                      
   AND A.ACCAT IN ('3','4','18')                      
   AND B.ACCAT = '2'                      
   AND A.BRANCHCODE = 'ALL'                      
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                      
 END                      
ELSE                
 BEGIN                      
  UPDATE                      
   #RECPAY_TABLE                      
  SET                      
   FYSTART = @@STD_DATE,                      
   FYEND = @@LST_DATE + ' 23:59:59',                      
   UPDFLAG = 'Y',                      
   ACNAME = A.LONGNAME,                      
   BANKNAME = B.LONGNAME,                      
   BOOKTYPE = B.BOOKTYPE,                      
   MICRNO = ISNULL(B.MICRNO, 0)                      
  FROM                      
   ACMAST A, ACMAST B                      
  WHERE                      
   A.CLTCODE = CLIENT_CODE                      
   AND B.CLTCODE = BANK_CODE                      
   AND A.ACCAT IN ('3','4','18')                      
   AND B.ACCAT = '2'                      
 END                      
                      
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */                      
                      
 SELECT                      
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                      
 FROM                      
  #RECPAY_TABLE                      
 IF @@ERROR_COUNT > 1                      
  BEGIN                      
   SELECT                      
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'                      
   DROP TABLE #RECPAY_TABLE_TMP                      
   DROP TABLE #RECPAY_TABLE                      
   ROLLBACK TRAN                      
   DELETE                      
   FROM                      
    V2_UPLOADED_FILES                      
   WHERE                      
    U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
  END                      
                  
                  
/*--------------------------VALIDATION FOR DIFFERENT SERIAL_NO IN SAME VOUCHER ------------------------*/                      
/*SELECT @@ERROR_COUNT = COUNT(SERIAL_NO) FROM  #RECPAY_TABLE                   
GROUP BY SERIAL_NO, VDT HAVING COUNT(SERIAL_NO) > 1                  
 IF @@ERROR_COUNT > 1                     
  BEGIN                      
   SELECT 'SOME OF THE VOUCHERS ARE HAVING SAME SERIAL_NO ', 'NA', 'NA'                      
   DROP TABLE #RecPay_Table_Tmp                      
   DROP TABLE #RecPay_Table                      
   ROLLBACK TRAN                      
   DELETE FROM V2_Uploaded_Files                      
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
  END        */          
                      
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */                      
 SELECT                      
  @@ERROR_COUNT = COUNT(1)                      
 FROM                      
  (                      
   SELECT                      
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),                      
    SERIAL_NO                      
   FROM                      
    #RECPAY_TABLE                      
   GROUP BY                    
    SERIAL_NO                      
   HAVING                      
    COUNT(DISTINCT BANK_CODE) > 1                      
  ) A                      
 IF @@ERROR_COUNT > 0                      
  BEGIN                      
   SELECT                      
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'                      
   UNION ALL                      
   SELECT                      
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))                      
   FROM                      
    #RECPAY_TABLE                      
   GROUP BY                      
    SERIAL_NO                      
   HAVING                      
    COUNT(DISTINCT BANK_CODE) > 1                      
                      
   DROP TABLE #RECPAY_TABLE_TMP                      
   DROP TABLE #RECPAY_TABLE                      
   ROLLBACK TRAN                      
   DELETE                      
   FROM                      
    V2_UPLOADED_FILES                      
   WHERE                      
    U_FILENAME = @FNAME                      
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
   RETURN                      
 END                      
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */                      
SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
 SELECT DISTINCT                      
  DRCR                      
 FROM                      
  #RECPAY_TABLE                      
 ) A                      
IF @@ERROR_COUNT > 1                      
 BEGIN                      
  SELECT                      
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'                      
  DROP TABLE #RECPAY_TABLE_TMP                      
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRAN                      
  DELETE                      
  FROM                      
   V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
ELSE                      
 BEGIN                      
  SELECT TOP 1                      
   @@DRCR = DRCR,                      
   @@VTYP =                      
    (                      
    CASE                      
     WHEN DRCR = 'D'                      
     THEN 3                      
     ELSE 2                      
    END                      
    )                      
  FROM                      
   #RECPAY_TABLE                      
  UPDATE                      
   #RECPAY_TABLE                      
  SET VTYP =                      
   (                      
   CASE                      
     WHEN DRCR = 'D'                      
     THEN 3                      
     ELSE 2                      
    END                 
   )                      
 END                      
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/                      
 SELECT @@ERROR_COUNT = COUNT(1)                      
 FROM #RECPAY_TABLE                      
 WHERE VDT > EDT                      
            IF @@ERROR_COUNT > 0                      
             BEGIN                      
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                      
     DROP TABLE #RECPAY_TABLE_TMP                      
     DROP TABLE #RECPAY_TABLE                      
     ROLLBACK TRAN                      
     DELETE FROM                      
      V2_UPLOADED_FILES                      
     WHERE                      
      U_FILENAME = @FNAME                      
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
     RETURN                      
             END                      
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/                      
 SELECT @@ERROR_COUNT = COUNT(1)                      
 FROM #RECPAY_TABLE                      
 WHERE AMOUNT <= 0                      
 IF @@ERROR_COUNT > 0                      
  BEGIN                      
     SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                      
     DROP TABLE #RECPAY_TABLE_TMP                      
     DROP TABLE #RECPAY_TABLE                      
     ROLLBACK TRAN                      
     DELETE FROM                      
      V2_UPLOADED_FILES                      
     WHERE                      
      U_FILENAME = @FNAME                      
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
     RETURN                      
  END        
            
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------                            
   SELECT                                  
     @@BACKDAYS = ISNULL(MIN(NODAYS), 0)                                  
    FROM                                  
     USERWRITESTABLE            
    WHERE                                  
     USERCATEGORY = @USERCAT                                  
     AND VTYP = @@VTYP                                  
     AND BOOKTYPE = '01'            
                               
    SELECT                                  
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS                                  
    SELECT                                  
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)                                  
    FROM                                  
     #RECPAY_TABLE                                  
    WHERE                                  
     VDT < @@BACKDATE    
                                 
    IF @@ERROR_COUNT > 0                                  
     BEGIN                                  
  SELECT 'FEW OF THE VOUCHRS ARE BACKDATED WHICH IS NOT ALLOWED.'                  
  DROP TABLE #RECPAY_TABLE_TMP            
  DROP TABLE #RECPAY_TABLE            
  ROLLBACK TRAN            
  IF @@VTYP = 2     
   BEGIN            
    DELETE FROM V2_UPLOADED_FILES            
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
   END            
  ELSE            
   BEGIN            
    DELETE FROM V2_UPLOADED_FILES            
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
   END            
  RETURN                          
     END               
        
/*--------VALIDATION OF FUTURE DATE WITH HARDCODE 2 DAYS -----*/  
        
 SELECT                
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                
 FROM        
  #RECPAY_TABLE where vdt > getdate()+2     
  
IF @@ERROR_COUNT > 0                                  
   BEGIN                                  
  SELECT 'FEW OF THE VOUCHRS ARE FUTURE DATED WHICH IS NOT ALLOWED.'                  
  DROP TABLE #RECPAY_TABLE_TMP            
  DROP TABLE #RECPAY_TABLE            
  ROLLBACK TRAN            
  IF @@VTYP = 2            
   BEGIN            
    DELETE FROM V2_UPLOADED_FILES            
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
   END            
  ELSE            
   BEGIN            
    DELETE FROM V2_UPLOADED_FILES            
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'            
   END            
  RETURN                          
 END                 
           
/*------------ */          
  
             
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */                          
/*SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
  SELECT DISTINCT                          
   DDNO  = RP.REF_NO                          
  FROM                          
   #RECPAY_TABLE RP,                          
   LEDGER1 L1                          
    WITH(NOLOCK)                          
  WHERE                          
   L1.DDNO = RP.REF_NO                          
  AND L1.BNKNAME = RP.BANK_NAME                          
  AND L1.DD = RP.CHQ_MODE     
  AND L1.DRCR = @@DRCR                          
  AND L1.VTYP = @@VTYP                          
  AND RP.REF_NO <> '0'                          
  AND ISNUMERIC(RP.REF_NO) = 1                         
 ) A                          
IF @@ERROR_COUNT > 0                          
 BEGIN                          
  SELECT                          
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'                          
  UNION ALL                          
  SELECT DISTINCT                          
   RP.REF_NO, 'NA','NA'                          
  FROM                          
   #RECPAY_TABLE RP,                          
   LEDGER1 L1                          
    WITH(NOLOCK)                          
  WHERE                          
   L1.DDNO = RP.REF_NO                          
   AND L1.DD = RP.CHQ_MODE                          
   AND L1.DRCR = @@DRCR                          
   AND L1.VTYP = @@VTYP                          
   AND RP.CHQ_MODE <> 'N'                          
  DROP TABLE #RECPAY_TABLE_TMP                    DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE FROM                          
   V2_UPLOADED_FILES                          
  WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
  RETURN                          
 END                 
*/                     
                  
/*   --------------------------VALIDATION FOR ACCOUNT NUMBER ------------------------ */                      
/*SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
  SELECT DISTINCT                      
   RP.ACCOUNTNO                    
  FROM                      
   #RECPAY_TABLE RP,                      
   MULTIBANKID M                      
    WITH(NOLOCK)                     
  WHERE                      
   M.ACCNO = RP.ACCOUNTNO                      
 ) A                      
IF @@ERROR_COUNT <= 0                      
 BEGIN                      
  SELECT                      
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING ACCOUNT NUMBER DOEST NOT EXISTS', 'NA','NA'                      
  UNION ALL                      
  SELECT DISTINCT                      
   RP.ACCOUNTNO, 'NA','NA'                      
  FROM                      
   #RECPAY_TABLE RP,                      
   MULTIBANKID M                      
    WITH(NOLOCK)                      
  WHERE                      
   M.ACCNO <> RP.ACCOUNTNO                   
                      
  DROP TABLE #RECPAY_TABLE_TMP                     
  DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRAN                      
  DELETE FROM                      
   V2_UPLOADED_FILES                      
  WHERE                      
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
*/                  
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/                      
SELECT                      
 @@ERROR_COUNT = COUNT(1)                      
FROM                      
 (                      
  SELECT DISTINCT                      
   CLIENT_CODE                      
  FROM                      
   #RECPAY_TABLE                      
  WHERE                      
   UPDFLAG = 'N'                      
 ) A                      
IF @@ERROR_COUNT > 0                      
 BEGIN                      
  SELECT                      
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'                      
  UNION ALL                      
  SELECT DISTINCT                      
   CLIENT_CODE, 'NA','NA'                      
  FROM                      
   #RECPAY_TABLE                      
  WHERE                      
   UPDFLAG = 'N'                      
  DROP TABLE #RECPAY_TABLE_TMP                      
DROP TABLE #RECPAY_TABLE                      
  ROLLBACK TRAN                      
  DELETE FROM                      
   V2_UPLOADED_FILES                      
  WHERE               
   U_FILENAME = @FNAME                      
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                      
  RETURN                      
 END                      
                 
 SET @@MyTempVno = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6)                     
                
                 
UPDATE                      
 R                
SET                 
TPFLAG = 0                
FROM                
 #RECPAY_TABLE R,                
 MULTIBANKID M                
WHERE                 
 R.CLIENT_CODE = M.CLTCODE                
 AND M.ACCNO = R.ACCOUNTNO                
                 
                
INSERT INTO ANAND.ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES                      
   (VOUCHERTYPE,                      
   BOOKTYPE,                      
   SNO,                      
   VDATE,                      
   EDATE,                      
   CLTCODE,                      
   CREDITAMT,                      
   DEBITAMT,                      
   NARRATION,                    
   OPPCODE,                    
   BANKNAME,                    
   DDNO,                    
   BRANCHCODE,                    
   BRANCHNAME,                    
   CHEQUEMODE,                    
   CHEQUEDATE,                    
   CHEQUENAME,                    
   CLEAR_MODE,                    
   EXCHANGE,                      
   SEGMENT,                      
   TPFLAG,                      
   ADDDT,                      
   ADDBY,                      
   STATUSID,                      
   STATUSNAME,                      
   ROWSTATE,                      
   APPROVALFLAG,                      
   APPROVALDATE,                      
   APPROVEDBY,                      
   VOUCHERNO,              
   UPLOADDT,                      
   CLIENTNAME,                
   TPACCOUNTNUMBER)                      
                     
 SELECT                       
  @@VTYP,'01',SERIAL_NO, VDT, EDT, CLIENT_CODE,                       
  CASE WHEN DRCR = 'C' THEN AMOUNT ELSE 0 END, CASE WHEN DRCR = 'D' THEN AMOUNT ELSE 0 END, NARRATION,                    
  BANK_CODE,BANK_NAME,REF_NO,BRANCHCODE,BRANCH_NAME,CHQ_MODE,DDDT,CHQ_NAME,CL_MODE,                         
  @EXCHANGE, @SEGMENT,TPFLAG,GETDATE(),@UNAME,@STATUSID,@STATUSNAME,0,0,                      
  GETDATE(),'',@@MyTempVno,GETDATE(),ACNAME,ACCOUNTNO                      
 FROM                       
  #RECPAY_TABLE                      
                    
COMMIT TRANSACTION                    
                      
SELECT 'CLTCODE, AMOUNT, REF_VNO' Union ALL                        
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + @@MyTempVno As RESULT FROM #RECPAY_TABLE                        
                    
DROP TABLE #RECPAY_TABLE_TMP                        
DROP TABLE #RECPAY_TABLE             
            
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_RECPAYUPLOAD_BULK_BKUP_07DEC2018
-- --------------------------------------------------
create PROC [dbo].[V2_OFFLINE_RECPAYUPLOAD_BULK_BKUP_07DEC2018]                          
 @FNAME VARCHAR(100),                          
 @UNAME VARCHAR(25),                          
 @USERCAT SMALLINT,                      
 @EXCHANGE VARCHAR(3),                        
 @SEGMENT  VARCHAR(10),                        
 @STATUSID VARCHAR(15),                        
 @STATUSNAME VARCHAR(15)                          
                          
AS                          
/*                          
BEGIN DISTRIBUTED TRANSACTION --BEGIN TRAN                          
Exec V2_OFFLINE_RECPAYUPLOAD_BULK 'D:\BackOffice\RecPayFiles\Recpay.csv', 'DEMO', 120,'NSE', 'CAPITAL','broker','broker'                     
ROLLBACK                          
*/                          
set xact_abort on                
                
                
SET NOCOUNT ON                          
/*-------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------*/                          
DECLARE                          
 @@STD_DATE VARCHAR(11),                          
 @@LST_DATE VARCHAR(11),                          
 @@BRANCHFLAG AS TINYINT,                          
 @@VNOFLAG AS TINYINT,                          
 @@VNOMETHOD INT,                          
 @@ACNAME CHAR(100),                          
 @@BOOKTYPE CHAR(2),                          
 @@MICRNO VARCHAR(10),                          
 @@DRCR VARCHAR(1),                          
 @@VTYP SMALLINT,                          
 @@BANK_CODE VARCHAR(100),                          
 @@BACKDAYS INT,                          
 @@BACKDATE VARCHAR(11),                          
 @@BRNCOUNT   TINYINT,                          
 @@MonthlyVdt VARCHAR(11),                          
 @@SERIAL_NO INT,                          
 @@COSTCODECOUNT TINYINT,                          
 @@COSTCODEUPDATES CURSOR,                          
 @@NEWVNO AS VARCHAR(12),                          
 @@MAXCOUNT AS INT,                          
 @@VDT AS VARCHAR(11),                          
 @@BANKBRANCH AS VARCHAR(10),                          
 @@BANKCOST AS NUMERIC,                          
 @@LNOCUR AS CURSOR,                          
 @@VNOCUR AS CURSOR,                          
 @@LNOVNO AS VARCHAR(12),                          
 @@MAXVNO AS INT,                          
 @@L2CUR AS CURSOR,                          
 @@L2VNO AS VARCHAR(12),                          
 @@ERROR_COUNT AS INT,                          
 @@FILEEXISTS AS INT,                          
 @@SQL AS VARCHAR(2000),                      
 @@MyTempVno AS VARCHAR(12)                            
                          
SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
  SELECT                          
   U_FILENAME                          
  FROM                          
   V2_UPLOADED_FILES                          
  WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
 ) A                          
IF @@ERROR_COUNT > 0                          
 BEGIN                          
  SELECT                          
   'THE FILE YOU ARE UPLOADING IS ALREADY UPLOADED. PLEASE UPLOAD ANOTHER FILE.', @FNAME, 'NA'                          
  RETURN                          
 END                          
CREATE TABLE #FEXIST                          
(                          
 F1 SMALLINT,                          
 F2 SMALLINT,                          
 F3 SMALLINT                          
)                          
SELECT @@SQL = "INSERT INTO "                          
SELECT @@SQL = @@SQL + " #FEXIST "                          
SELECT @@SQL = @@SQL + " (F1, F2, F3) "                          
SELECT @@SQL = @@SQL + "EXEC MASTER.DBO.XP_FILEEXIST '" + @FNAME + "' "                          
                          
EXEC(@@SQL)                          
                          
SELECT          
 @@FILEEXISTS = F1                          
FROM                          
 #FEXIST                          
                          
IF @@FILEEXISTS = 0       
 BEGIN                          
  DROP TABLE #FEXIST                          
  SELECT                          
   'THE FILE YOU ARE UPLOADING DOES NOT EXIST. PLEASE VERIFY THE PATH AND FILENAME.'                          
  RETURN                          
 END                          
DROP TABLE #FEXIST                          
                          
BEGIN DISTRIBUTED TRANSACTION --BEGIN TRAN                     
CREATE TABLE #RECPAY_TABLE_TMP                          
(                          
 SERIAL_NO INT,                          
 EDATE VARCHAR(20),                          
 VOUCHER_DATE VARCHAR(20),                          
 CLIENT_CODE VARCHAR(50),                          
 AMOUNT MONEY,                          
 DRCR VARCHAR(1),                          
 NARRATION VARCHAR(234),                          
 BANK_CODE VARCHAR(10),                          
 BANK_NAME VARCHAR(100),                      
 REF_NO VARCHAR(15),                          
 BRANCHCODE VARCHAR(20),                          
 BRANCH_NAME VARCHAR(50),                          
 CHQ_MODE VARCHAR(1),                          
 CHQ_DATE VARCHAR(20),                          
 CHQ_NAME VARCHAR(100),                          
 CL_MODE VARCHAR(1),                              
 ACCOUNTNO VARCHAR(25)                      
)                       
                        
CREATE TABLE [#RECPAY_TABLE]                          
 (                          
  SERIAL_NO INT,                          
  EDATE VARCHAR(20),                          
  VOUCHER_DATE VARCHAR(20),                          
  CLIENT_CODE VARCHAR(50),                          
  AMOUNT MONEY,                          
  DRCR VARCHAR(1),                          
  NARRATION VARCHAR(234),                          
  BANK_CODE VARCHAR(10),                          
  BANK_NAME VARCHAR(100),                          
  REF_NO VARCHAR(15),                          
  BRANCHCODE VARCHAR(20),                          
  BRANCH_NAME VARCHAR(50),                          
  CHQ_MODE VARCHAR(1),                          
  CHQ_DATE VARCHAR(20),                          
  CHQ_NAME VARCHAR(100),                          
  CL_MODE VARCHAR(1),                          
  SNO INT IDENTITY (1, 1) NOT NULL ,                          
  VDT DATETIME NULL ,                          
  FYSTART DATETIME NULL ,                          
  FYEND DATETIME NULL ,                          
  UPDFLAG VARCHAR (1) NOT NULL DEFAULT('N'),                          
  EDT DATETIME NULL ,                          
  DDDT DATETIME NULL ,                          
  VNO VARCHAR (12) NULL ,                          
  VTYP SMALLINT NULL ,                          
  ACNAME VARCHAR (100) NULL ,                          
  COSTCODE SMALLINT NULL,                          
  BANKCOST SMALLINT NULL,                          
  LNO SMALLINT NOT NULL DEFAULT(0),                          
  BANKNAME VARCHAR(100) NULL,                        
  MICRNO INT NULL,                          
  BOOKTYPE VARCHAR(2) NULL,                       
  ACCOUNTNO VARCHAR(25),                    
  TPFLAG INT                       
 ) ON [PRIMARY]                        
                      
SELECT @@SQL = "BULK INSERT #RECPAY_TABLE_TMP FROM '" + @FNAME + "' WITH (FIELDTERMINATOR = ',', FIRSTROW = 2, KEEPNULLS) "                          
EXEC (@@SQL)                          
                          
IF @@ERROR <> 0                          
 BEGIN                          
  DROP TABLE #RECPAY_TABLE_TMP                          
  DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRANSACTION                          
  SELECT 'DUE TO SOME ERROR IN BULK INSERT, THE FILE COULD NOT BE UPLOADED...'                          
  RETURN                          
 END                          
INSERT INTO   
 V2_UPLOADED_FILES                          
SELECT                          
 @FNAME,                          
 @FNAME,                          
 CNT = COUNT(1),                          
 'B',                          
 GETDATE(),                          
 @UNAME,                          
 'RECEIPT/PAYMENT UPLOAD'                          
                        
INSERT INTO                          
 #RECPAY_TABLE                          
 (                          
  SERIAL_NO,                          
  EDATE,                          
  VOUCHER_DATE,                          
  CLIENT_CODE,                          
  AMOUNT,                          
  DRCR,                          
  NARRATION,                          
  BANK_CODE,                     
  BANK_NAME,                          
  REF_NO,                          
  BRANCHCODE,                          
  BRANCH_NAME,                          
  CHQ_MODE,                          
  CHQ_DATE,                          
  CHQ_NAME,                          
  CL_MODE,                      
  ACCOUNTNO,                    
  TPFLAG                          
 )                          
SELECT                          
 SERIAL_NO,                          
 EDATE,                          
 VOUCHER_DATE,                          
 UPPER(LTRIM(RTRIM(CLIENT_CODE))),                          
 AMOUNT,                          
 UPPER(LTRIM(RTRIM(DRCR))),                          
 NARRATION,                          
 UPPER(LTRIM(RTRIM(BANK_CODE))),                          
 UPPER(LTRIM(RTRIM(BANK_NAME))),                          
 REF_NO,                          
 UPPER(LTRIM(RTRIM(BRANCHCODE))),                          
 UPPER(LTRIM(RTRIM(BRANCH_NAME))),                          
 UPPER(LTRIM(RTRIM(CHQ_MODE))),                          
 CHQ_DATE,                          
 CHQ_NAME,                          
 CL_MODE,                      
 ACCOUNTNO,                    
 TPFLAG = 1                      
FROM                          
 #RECPAY_TABLE_TMP                          
                          
UPDATE                          
 #RECPAY_TABLE                          
SET                          
 VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                          
 DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                          
 EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2))                          
                          
                         
SELECT                          
 @@ERROR_COUNT = COUNT(DISTINCT VDT)                          
FROM                          
 #RECPAY_TABLE                          
                          
IF @@ERROR_COUNT > 1                          
 BEGIN                          
  DROP TABLE #RECPAY_TABLE_TMP                          
  DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRANSACTION                          
  SELECT 'FILE CANNOT BE UPLOADED WITH MULTIPLE VDTs.'                          
  RETURN                          
 END                          
                          
SELECT TOP 1                          
 @@VDT = CONVERT(VARCHAR(11), VDT, 109)                          
FROM                          
 #RECPAY_TABLE                          
                          
SELECT                          
 @@STD_DATE = CONVERT(VARCHAR(11), SDTCUR, 109),                          
 @@LST_DATE = CONVERT(VARCHAR(11), LDTCUR, 109),                          
 @@BRANCHFLAG = BRANCHFLAG,             @@VNOFLAG = VNOFLAG                          
FROM                          
 PARAMETER                          
WHERE                          
 @@VDT BETWEEN SDTCUR AND LDTCUR                          
                      
                          
IF @@BRANCHFLAG = 1                          
 BEGIN                         
  UPDATE                          
   #RECPAY_TABLE                    
  SET                          
   BRANCHCODE = A.BRANCHCODE,                          
   FYSTART = P.SDTCUR,                          
   FYEND = P.LDTCUR,                          
   UPDFLAG = 'Y',                          
   ACNAME = A.LONGNAME,                          
   COSTCODE = C.COSTCODE,                          
   BANKNAME = B.LONGNAME,                          
   BOOKTYPE = B.BOOKTYPE,                          
   MICRNO = ISNULL(B.MICRNO, 0)                          
  FROM                          
 ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                          
  WHERE                          
   A.CLTCODE = CLIENT_CODE                          
   AND B.CLTCODE = BANK_CODE                          
   AND P.CURYEAR = 1                          
   AND A.ACCAT IN ('3','4','18')     
  -- AND CLTCODE NOT IN (SELECT CLTCODE FROM ACMAST_DETAILS WHERE INACTIVE_FLAG = 'N')                         
   AND B.ACCAT = '2'                          
   AND A.BRANCHCODE = COSTNAME                          
                            
  UPDATE                          
   #RECPAY_TABLE                          
  SET                          
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                          
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                          
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                          
   FYSTART = P.SDTCUR,                          
   FYEND = P.LDTCUR,                          
   UPDFLAG = 'Y',                          
   ACNAME = A.LONGNAME,                          
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = #RECPAY_TABLE.BRANCHCODE)  ,                          
   BANKNAME = B.LONGNAME,                          
   BOOKTYPE = B.BOOKTYPE,                          
   MICRNO = ISNULL(B.MICRNO, 0)                          
  FROM                          
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                          
  WHERE                          
   A.CLTCODE = CLIENT_CODE                          
   AND B.CLTCODE = BANK_CODE                          
   AND P.CURYEAR = 1                          
   AND A.ACCAT IN ('3','4','18')    
   --AND CLTCODE NOT IN (SELECT CLTCODE FROM ACMAST_DETAILS WHERE INACTIVE_FLAG = 'N')                          
   AND B.ACCAT = '2'                          
   AND A.BRANCHCODE = 'ALL'                          
   AND #RECPAY_TABLE.BRANCHCODE <> 'ALL'                          
                        
  UPDATE                          
   #RECPAY_TABLE                          
  SET                          
   BRANCHCODE = 'HO',                          
   VDT = CONVERT(DATETIME, RIGHT(VOUCHER_DATE,4) + '-' + SUBSTRING(VOUCHER_DATE,4,2) + '-' + LEFT(VOUCHER_DATE,2)),                          
   DDDT = CONVERT(DATETIME, RIGHT(CHQ_DATE,4) + '-' + SUBSTRING(CHQ_DATE,4,2) + '-' + LEFT(CHQ_DATE,2)),                          
   EDT = CONVERT(DATETIME, RIGHT(EDATE,4) + '-' + SUBSTRING(EDATE,4,2) + '-' + LEFT(EDATE,2)),                          
   FYSTART = P.SDTCUR,                          
   FYEND = P.LDTCUR,                          
   UPDFLAG = 'Y',                          
   ACNAME = A.LONGNAME,                        
   COSTCODE = (SELECT TOP 1 COSTCODE FROM COSTMAST WHERE COSTNAME = 'HO')  ,                          
   BANKNAME = B.LONGNAME,                          
   BOOKTYPE = B.BOOKTYPE,                          
   MICRNO = ISNULL(B.MICRNO, 0)                          
  FROM                          
   ACMAST A, PARAMETER P, COSTMAST C, ACMAST B                          
  WHERE                          
   A.CLTCODE = CLIENT_CODE                          
   AND B.CLTCODE = BANK_CODE                          
   AND P.CURYEAR = 1                          
   AND A.ACCAT IN ('3','4','18')                          
   --AND CLTCODE NOT IN (SELECT CLTCODE FROM ACMAST_DETAILS WHERE INACTIVE_FLAG = 'N')    
   AND B.ACCAT = '2'                          
   AND A.BRANCHCODE = 'ALL'                          
   AND #RECPAY_TABLE.BRANCHCODE = 'ALL'                          
 END                          
ELSE                    
 BEGIN                          
  UPDATE                          
   #RECPAY_TABLE                          
  SET                          
   FYSTART = @@STD_DATE,                          
   FYEND = @@LST_DATE + ' 23:59:59',                          
   UPDFLAG = 'Y',                          
   ACNAME = A.LONGNAME,                          
   BANKNAME = B.LONGNAME,              
   BOOKTYPE = B.BOOKTYPE,                          
   MICRNO = ISNULL(B.MICRNO, 0)                          
  FROM                          
   ACMAST A, ACMAST B                          
  WHERE                          
   A.CLTCODE = CLIENT_CODE                          
   AND B.CLTCODE = BANK_CODE                          
   AND A.ACCAT IN ('3','4','18')                          
  -- AND CLTCODE NOT IN (SELECT CLTCODE FROM ACMAST_DETAILS WHERE INACTIVE_FLAG = 'N')    
   AND B.ACCAT = '2'                          
 END   
   
 UPDATE R SET UPDFLAG = 'B'   
 FROM #RECPAY_TABLE R  
 WHERE BANK_CODE  IN (SELECT CLTCODE FROM ACMAST_DETAILS WHERE INACTIVE_FLAG = 'N')  
                          
/* -------------- VALIDATION FOR MULTIPLE VOUCHER DATES-------------------------- */                          
                          
 SELECT                          
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                          
 FROM                          
  #RECPAY_TABLE                          
 IF @@ERROR_COUNT > 1                          
  BEGIN                          
   SELECT                          
    'SOME OF THE VOUCHERS ARE HAVING DIFFERENT VOUCHER DATES', 'NA', 'NA'                          
   DROP TABLE #RECPAY_TABLE_TMP                          
   DROP TABLE #RECPAY_TABLE                          
   ROLLBACK TRAN                          
   DELETE                          
   FROM                          
    V2_UPLOADED_FILES                          
   WHERE                          
    U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
   RETURN                          
  END                          
                      
                      
/*--------------------------VALIDATION FOR DIFFERENT SERIAL_NO IN SAME VOUCHER ------------------------*/                          
/*SELECT @@ERROR_COUNT = COUNT(SERIAL_NO) FROM  #RECPAY_TABLE                       
GROUP BY SERIAL_NO, VDT HAVING COUNT(SERIAL_NO) > 1                      
 IF @@ERROR_COUNT > 1                         
  BEGIN                          
   SELECT 'SOME OF THE VOUCHERS ARE HAVING SAME SERIAL_NO ', 'NA', 'NA'                          
   DROP TABLE #RecPay_Table_Tmp                          
   DROP TABLE #RecPay_Table                          
   ROLLBACK TRAN                          
   DELETE FROM V2_Uploaded_Files                          
   WHERE U_FILENAME = ' & FName & ' AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
   RETURN                          
  END        */              
                          
/*  --------------------------VALIDATION FOR MULTIPLE BANK CODES IN SINGLE VOUCHER------------------------ */                          
 SELECT                          
  @@ERROR_COUNT = COUNT(1)                          
 FROM                          
  (                          
   SELECT                          
    BANK_CNT = ISNULL(COUNT(DISTINCT BANK_CODE), 0),                          
    SERIAL_NO                          
   FROM                          
    #RECPAY_TABLE                          
   GROUP BY                        
    SERIAL_NO                          
   HAVING                          
    COUNT(DISTINCT BANK_CODE) > 1                          
  ) A                          
 IF @@ERROR_COUNT > 0                          
  BEGIN                          
   SELECT                          
    RESULT = 'MULTIPLE BANK CODES CAN NOT BE SPECIFIED IN ONE TRANSACTIONS. PLEASE REFER TO THE FOLLOWING ROWS.'                          
   UNION ALL                          
   SELECT                          
    RESULT = 'SR.NO.:' + LTRIM(RTRIM(CONVERT(VARCHAR, SERIAL_NO))) + ', BANK CODES:' + CONVERT(VARCHAR, ISNULL(COUNT(DISTINCT BANK_CODE), 0))                          
   FROM                          
    #RECPAY_TABLE                          
   GROUP BY                          
    SERIAL_NO                          
   HAVING                          
    COUNT(DISTINCT BANK_CODE) > 1                          
                          
   DROP TABLE #RECPAY_TABLE_TMP                          
   DROP TABLE #RECPAY_TABLE                          
   ROLLBACK TRAN                          
   DELETE                          
   FROM                         
    V2_UPLOADED_FILES                          
   WHERE                          
    U_FILENAME = @FNAME                          
    AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
   RETURN                          
 END                          
/*  --------------------------VALIDATION FOR SINGLE VOUCHER TYPE BASED ON DRCR ------------------------ */                          
SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
 SELECT DISTINCT                          
  DRCR                          
 FROM                          
  #RECPAY_TABLE                          
 ) A                          
IF @@ERROR_COUNT > 1                          
 BEGIN                          
  SELECT                          
   'PLEASE ENSURE THAT THERE IS EITHER RECIEPT OR PAYMENT ENTRY. BOTH TYPES OF ENTRY ARE NOT ALLOWED IN THE SAME FILE.', 'NA', 'NA'                          
  DROP TABLE #RECPAY_TABLE_TMP                          
  DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE                          
  FROM                          
   V2_UPLOADED_FILES                          
  WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
  RETURN                          
 END                          
ELSE                          
 BEGIN                          
  SELECT TOP 1                          
   @@DRCR = DRCR,                          
   @@VTYP =                          
    (                          
    CASE                          
     WHEN DRCR = 'D'                          
     THEN 3                          
     ELSE 2                          
    END                          
    )                          
  FROM                          
   #RECPAY_TABLE                          
  UPDATE                          
   #RECPAY_TABLE                          
  SET VTYP =                          
   (                          
   CASE                          
     WHEN DRCR = 'D'                          
     THEN 3                          
     ELSE 2                          
    END                     
   )                          
 END                          
/*--------------------------VALIDATION FOR VOUCHER DATE GRATER THAN EFFECTIVE DATE ------------------------*/                          
 SELECT @@ERROR_COUNT = COUNT(1)                          
 FROM #RECPAY_TABLE                          
 WHERE VDT > EDT                          
            IF @@ERROR_COUNT > 0                          
             BEGIN                          
              SELECT 'VOUHER DATE CAN NOT BE GRATER THAT EFFECTIVE DATE.'                          
     DROP TABLE #RECPAY_TABLE_TMP                          
     DROP TABLE #RECPAY_TABLE                          
     ROLLBACK TRAN                          
     DELETE FROM        
      V2_UPLOADED_FILES                          
     WHERE                          
      U_FILENAME = @FNAME                          
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
     RETURN                          
             END                          
            /*--------------------------VALIDATION FOR ZERO AMOUNT ------------------------*/                          
 SELECT @@ERROR_COUNT = COUNT(1)                          
 FROM #RECPAY_TABLE                          
 WHERE AMOUNT <= 0                          
 IF @@ERROR_COUNT > 0                          
  BEGIN                          
     SELECT 'VOUHER AMOUNT SHOULD BE ALWAY GRATER THAN 0'                          
     DROP TABLE #RECPAY_TABLE_TMP                          
     DROP TABLE #RECPAY_TABLE                          
     ROLLBACK TRAN                          
     DELETE FROM                          
      V2_UPLOADED_FILES                          
     WHERE                          
      U_FILENAME = @FNAME                          
     AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
     RETURN                          
  END            
                
--------------------------VALIDATION WITH USERRIGHTS TABLE ------------------------                                
   SELECT                                      
     @@BACKDAYS = ISNULL(MIN(NODAYS), 0)                                      
    FROM                                      
     USERWRITESTABLE                
    WHERE                                      
     USERCATEGORY = @USERCAT                                      
     AND VTYP = @@VTYP                                      
     AND BOOKTYPE = '01'                
                                   
    SELECT                                      
     @@BACKDATE = CONVERT(DATETIME, CONVERT(VARCHAR(11), GETDATE(), 109)) - @@BACKDAYS                                      
    SELECT                                      
     @@ERROR_COUNT = ISNULL(COUNT(VDT), 0)                                      
    FROM                                      
     #RECPAY_TABLE                                      
    WHERE                                      
     VDT < @@BACKDATE        
                                     
    IF @@ERROR_COUNT > 0                                      
     BEGIN                                      
  SELECT 'FEW OF THE VOUCHRS ARE BACKDATED WHICH IS NOT ALLOWED.'                      
  DROP TABLE #RECPAY_TABLE_TMP                
  DROP TABLE #RECPAY_TABLE                
  ROLLBACK TRAN                
  IF @@VTYP = 2         
   BEGIN                
    DELETE FROM V2_UPLOADED_FILES                
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                
   END                
  ELSE                
   BEGIN                
    DELETE FROM V2_UPLOADED_FILES                
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                
   END                
  RETURN                              
     END                   
            
/*--------VALIDATION OF FUTURE DATE WITH HARDCODE 2 DAYS -----*/      
            
 SELECT                    
  @@ERROR_COUNT = COUNT(DISTINCT VDT)                    
 FROM            
  #RECPAY_TABLE where vdt > getdate()+2         
      
IF @@ERROR_COUNT > 0                                      
   BEGIN                                      
  SELECT 'FEW OF THE VOUCHRS ARE FUTURE DATED WHICH IS NOT ALLOWED.'                      
  DROP TABLE #RECPAY_TABLE_TMP                
  DROP TABLE #RECPAY_TABLE                
  ROLLBACK TRAN                
  IF @@VTYP = 2                
   BEGIN                
    DELETE FROM V2_UPLOADED_FILES                
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                
   END                
  ELSE                
   BEGIN                
    DELETE FROM V2_UPLOADED_FILES                
     WHERE U_FILENAME = @FNAME AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                
   END                
  RETURN                              
 END                     
               
/*------------ */              
      
                 
/*   --------------------------VALIDATION FOR CHEQUE NUMBER ------------------------ */                              
/*SELECT                              
 @@ERROR_COUNT = COUNT(1)                              
FROM                              
 (                              
  SELECT DISTINCT                              
   DDNO  = RP.REF_NO                              
  FROM                              
   #RECPAY_TABLE RP,                              
   LEDGER1 L1                              
    WITH(NOLOCK)                              
  WHERE                              
   L1.DDNO = RP.REF_NO                              
  AND L1.BNKNAME = RP.BANK_NAME                              
  AND L1.DD = RP.CHQ_MODE         
  AND L1.DRCR = @@DRCR                              
  AND L1.VTYP = @@VTYP                              
  AND RP.REF_NO <> '0'                              
  AND ISNUMERIC(RP.REF_NO) = 1                             
 ) A                              
IF @@ERROR_COUNT > 0                              
 BEGIN                              
  SELECT                              
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CHEQUE NUMBER ALREADY EXISTS', 'NA','NA'                              
  UNION ALL                              
  SELECT DISTINCT                              
   RP.REF_NO, 'NA','NA'                              
  FROM                              
   #RECPAY_TABLE RP,                              
   LEDGER1 L1                              
    WITH(NOLOCK)                              
  WHERE                              
   L1.DDNO = RP.REF_NO                              
   AND L1.DD = RP.CHQ_MODE                              
   AND L1.DRCR = @@DRCR                              
   AND L1.VTYP = @@VTYP                              
   AND RP.CHQ_MODE <> 'N'                              
  DROP TABLE #RECPAY_TABLE_TMP                    DROP TABLE #RECPAY_TABLE                              
  ROLLBACK TRAN                              
  DELETE FROM                              
   V2_UPLOADED_FILES                              
  WHERE                              
   U_FILENAME = @FNAME                              
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                              
  RETURN                              
 END                     
*/                         
                      
/*   --------------------------VALIDATION FOR ACCOUNT NUMBER ------------------------ */                          
/*SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
  SELECT DISTINCT                          
   RP.ACCOUNTNO                        
  FROM                          
   #RECPAY_TABLE RP,                          
   MULTIBANKID M                          
    WITH(NOLOCK)                         
  WHERE                          
   M.ACCNO = RP.ACCOUNTNO                          
 ) A                          
IF @@ERROR_COUNT <= 0                          
 BEGIN                          
  SELECT                          
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING ACCOUNT NUMBER DOEST NOT EXISTS', 'NA','NA'                          
  UNION ALL                          
  SELECT DISTINCT                          
   RP.ACCOUNTNO, 'NA','NA'                          
  FROM                          
   #RECPAY_TABLE RP,                          
   MULTIBANKID M                          
    WITH(NOLOCK)                          
  WHERE                          
   M.ACCNO <> RP.ACCOUNTNO                       
                          
  DROP TABLE #RECPAY_TABLE_TMP                         
  DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE FROM                          
   V2_UPLOADED_FILES              
  WHERE                          
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
  RETURN                          
 END                          
*/     
  
  
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/                          
SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
  SELECT DISTINCT                          
   BANK_CODE                          
  FROM                          
   #RECPAY_TABLE                          
  WHERE                          
   UPDFLAG = 'B'                          
 ) A                          
IF @@ERROR_COUNT > 0                          
 BEGIN                          
  SELECT                          
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS ARE BLOCKED', 'NA','NA'                          
  UNION ALL                          
  SELECT DISTINCT                          
   BANK_CODE, 'NA','NA'                          
  FROM                          
   #RECPAY_TABLE                          
  WHERE                          
   UPDFLAG = 'B'                          
  DROP TABLE #RECPAY_TABLE_TMP                          
DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE FROM                          
   V2_UPLOADED_FILES                          WHERE                   
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
  RETURN                          
 END                              
/*--------------------------FINAL VALIDATION BASED ON UPDFLAG ------------------------*/                          
SELECT                          
 @@ERROR_COUNT = COUNT(1)                          
FROM                          
 (                          
  SELECT DISTINCT                          
   CLIENT_CODE                          
  FROM                          
   #RECPAY_TABLE                          
  WHERE                          
   UPDFLAG = 'N'                          
 ) A                          
IF @@ERROR_COUNT > 0                          
 BEGIN                          
  SELECT                          
   'FILE CANNOT BE UPLOADED AS THE FOLLOWING CLIENTS DO NOT EXIST', 'NA','NA'                          
  UNION ALL                          
  SELECT DISTINCT                          
   CLIENT_CODE, 'NA','NA'                          
  FROM                          
   #RECPAY_TABLE                          
  WHERE                          
   UPDFLAG = 'N'                          
  DROP TABLE #RECPAY_TABLE_TMP                          
DROP TABLE #RECPAY_TABLE                          
  ROLLBACK TRAN                          
  DELETE FROM                          
   V2_UPLOADED_FILES                          WHERE                   
   U_FILENAME = @FNAME                          
   AND U_MODULE = 'RECEIPT/PAYMENT UPLOAD'                          
  RETURN                          
 END                          
                     
 SET @@MyTempVno = CONVERT(VARCHAR,GETDATE(),12)+RIGHT(REPLACE(CONVERT(VARCHAR,GETDATE(),114),':',''),6)                         
                    
                     
UPDATE                          
 R                    
SET                     
TPFLAG = 0                    
FROM                    
 #RECPAY_TABLE R,                    
 MULTIBANKID M                    
WHERE                     
 R.CLIENT_CODE = M.CLTCODE                    
 AND M.ACCNO = R.ACCOUNTNO                    
                     
                    
INSERT INTO ACCOUNT_AB.DBO.V2_OFFLINE_LEDGER_ENTRIES                          
   (VOUCHERTYPE,                          
   BOOKTYPE,                          
   SNO,                          
   VDATE,                          
   EDATE,                          
   CLTCODE,                          
   CREDITAMT,                       
   DEBITAMT,                          
   NARRATION,                        
   OPPCODE,                        
   BANKNAME,                        
   DDNO,                        
   BRANCHCODE,                        
   BRANCHNAME,                        
   CHEQUEMODE,                        
   CHEQUEDATE,                        
   CHEQUENAME,                        
   CLEAR_MODE,                        
   EXCHANGE,                          
   SEGMENT,                          
   TPFLAG,                          
   ADDDT,                          
   ADDBY,                          
   STATUSID,                          
   STATUSNAME,                          
   ROWSTATE,                          
   APPROVALFLAG,                          
   APPROVALDATE,                          
   APPROVEDBY,                          
   VOUCHERNO,                  
   UPLOADDT,                          
   CLIENTNAME,                    
   TPACCOUNTNUMBER)                          
                         
 SELECT                           
  @@VTYP,'01',SERIAL_NO, VDT, EDT, CLIENT_CODE,                           
  CASE WHEN DRCR = 'C' THEN AMOUNT ELSE 0 END, CASE WHEN DRCR = 'D' THEN AMOUNT ELSE 0 END, NARRATION,                        
  BANK_CODE,BANK_NAME,REF_NO,BRANCHCODE,BRANCH_NAME,CHQ_MODE,DDDT,CHQ_NAME,CL_MODE,                             
  @EXCHANGE, @SEGMENT,TPFLAG,GETDATE(),@UNAME,@STATUSID,@STATUSNAME,0,0,                          
  GETDATE(),'',@@MyTempVno,GETDATE(),ACNAME,ACCOUNTNO                          
 FROM                           
  #RECPAY_TABLE                          
                        
COMMIT TRANSACTION                        
                          
SELECT 'CLTCODE, AMOUNT, REF_VNO' Union ALL                            
SELECT CLIENT_CODE + ',' + LTRIM(RTRIM(CONVERT(VARCHAR, AMOUNT))) + ',' + @@MyTempVno As RESULT FROM #RECPAY_TABLE                            
                        
DROP TABLE #RECPAY_TABLE_TMP                            
DROP TABLE #RECPAY_TABLE                 
                
SET XACT_ABORT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OFFLINE_UPLOAD_PUTLOG
-- --------------------------------------------------
    
    
CREATE PROC [dbo].[V2_OFFLINE_UPLOAD_PUTLOG]    
(    
 @P_EXCHANGE VARCHAR(3),    
 @P_SEGMENT VARCHAR(10),    
 @P_VOUCHERTYPE SMALLINT,    
 @P_ERRORCODE INT,    
 @P_ERRORMSG VARCHAR(255),    
 @P_UPDATEBY VARCHAR(25)    
)    
AS    
  
BEGIN DISTRIBUTED TRANSACTION   
  
INSERT INTO ANAND.ACCOUNT_AB.DBO.OFFLINE_UPLOAD_LOG    
(    
 OUL_EXCHANGE,    
 OUL_SEGMENT,    
 OUL_VOUCHERTYPE,    
 OUL_ERRORCODE,    
 OUL_ERRORMSG ,    
 OUL_UPDATEBY,    
 OUL_UPDATEDT    
)    
VALUES    
(    
 @P_EXCHANGE,    
 @P_SEGMENT,    
 @P_VOUCHERTYPE,    
 @P_ERRORCODE,    
 @P_ERRORMSG,    
 @P_UPDATEBY,    
 GETDATE()    
)  
  
COMMIT TRANSACTION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_RECREATE_VNO
-- --------------------------------------------------

CREATE PROC V2_RECREATE_VNO
AS
/*
            VNOFLAG = 0 YEARLY  
            VNOFLAG = 1 DAILY  
            VNOFLAG = 2 MONTHLY  
*/




INSERT INTO V2_LASTVNO
SELECT F.VTYP, F.BOOKTYPE, F.VDT, MAX(LASTVNO), F.VNOFLAG, F.FINYEAR
FROM
(
      SELECT 
            X.VTYP, 
            X.BOOKTYPE,
            VDT = (CASE WHEN X.VNOFLAG = 0 THEN CAST('JAN  1 '+CAST(X.YR AS VARCHAR) AS DATETIME)
                              WHEN X.VNOFLAG = 1 THEN CAST(LEFT(X.VDT,11) AS DATETIME)
                              WHEN X.VNOFLAG = 2 THEN CAST(X.MN + ' 1 '+CAST(X.YR AS VARCHAR) AS DATETIME)
                        END),
            X.LASTVNO,
            X.VNOFLAG,
            FINYEAR = X.FLDAUTO
      FROM
            (
                  SELECT 
                  A.VTYP, 
                  A.BOOKTYPE, 
                  A.VDT, 
                  A.LASTVNO, 
                  B.VNOFLAG, 
                  B.FLDAUTO, 
                  YR = YEAR(B.SDTCUR) , 
                  MN = LEFT(A.VDT,3),
                  DT = DAY(A.VDT)
                  FROM LASTVNO A, PARAMETER B
                  WHERE A.VDT BETWEEN B.SDTCUR AND B.LDTCUR
            ) X
) F
GROUP BY 
F.VTYP, F.BOOKTYPE, F.VDT, F.VNOFLAG, F.FINYEAR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_Rpt_Acc_PartyLedger_All
-- --------------------------------------------------



--Exec RPT_ACC_PARTYLEDGER_ALL 'Apr  2 2010','Jun 15 2010','0a141','0a146','ACCODE','vdt','broker','broker','','Y'
CREATE PROCEDURE [dbo].[V2_Rpt_Acc_PartyLedger_All]
                @fdate      VARCHAR(11),            /* As mmm dd yyyy */
                @tdate      VARCHAR(11),            /* As mmm dd yyyy */
                @fcode      VARCHAR(10),
                @tcode      VARCHAR(10),
                @strorder   VARCHAR(6),
                @selectby   VARCHAR(3), 
                @statusid   VARCHAR(15),
                @statusname VARCHAR(15),
                @strbranch  VARCHAR(10),
                @orderflg   VARCHAR(1)  = 'N',
                @EXCSEGMENT VARCHAR(1000) = '',
                @ENTITY_TYPE VARCHAR(20) = 'ENTITY',
                @Single     VARCHAR(1)  = 'N',
                @FORPDF  VARCHAR(1) = 'N'
                

AS
/*
select * from COMPANY_MASTER_SETTING
 Exec [V2_Rpt_Acc_PartyLedger_All] 'Apr 1 2008','Mar 2 2009','0','0a143','ACCODE','vdt','broker','broker','','','','','ACCOUNT~ACCOUNTBSE~ACCOUNTFO'
commit
Exec rpt_acc_partyledger_all 'APR  1 2008','Mar  2 2009','0','0a143','ACCODE','vdt','broker','broker','',''
commit
*/

SET NOCOUNT ON

  BEGIN
 IF LEN(@FDATE) = 10 AND CHARINDEX('/', @FDATE) > 0
  BEGIN
   SET @FDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FDATE, 103), 109)
  END
 IF LEN(@TDATE) = 10 AND CHARINDEX('/', @TDATE) > 0
  BEGIN
   SET @TDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TDATE, 103), 109)
  END
    CREATE TABLE [DBO].[#TMPLEDGERNEW] (
		[BOOKTYPE]   [CHAR](2)   NULL,
		[VOUDT]      [DATETIME]   NULL,
		[EFFDT]      [DATETIME]   NULL,
		[SHORTDESC]  [CHAR](6)   NULL,
		[DRAMT]      [MONEY]   NULL,
		[CRAMT]      [MONEY]   NULL,
		[VNO]        [VARCHAR](12)   NULL,
		[DDNO]       [VARCHAR](15)   NULL,
		[NARRATION]  [VARCHAR](234)   NULL,
		[CLTCODE]    [VARCHAR](10)   NOT NULL,
		[VTYP]       [SMALLINT]   NULL,
		[VDT]        [VARCHAR](30)   NULL,
		[EDT]        [VARCHAR](30)   NULL,
		[ACNAME]     [VARCHAR](100)   NULL,
		[OPBAL]      [MONEY]   NULL,
		[L_ADDRESS1] [VARCHAR](40)   NULL,
		[L_ADDRESS2] [VARCHAR](40)   NULL,
		[L_ADDRESS3] [VARCHAR](40)   NULL,
		[L_CITY]     [VARCHAR](40)   NULL,
		[L_ZIP]      [VARCHAR](10)   NULL,
		[RES_PHONE1] [VARCHAR](15)   NULL,
		[BRANCH_CD]  [VARCHAR](10)   NULL,
		[CROSAC]     [VARCHAR](10)   NULL,
		[EDIFF]      [INT]   NULL,
		[FAMILY]     [VARCHAR](10)   NULL,
		[SUB_BROKER] [VARCHAR](10)   NULL,
		[TRADER]     [VARCHAR](20)   NULL,
		[CL_TYPE]    [VARCHAR](3)   NULL,
		[BANK_NAME]  [VARCHAR](50)   NULL,
		[CLTDPID]    [VARCHAR](16)   NULL,
		[LNO]        [INT]    NULL,
		[PDT]        [DATETIME]   NULL,
		[EXCHANGE] [VARCHAR] (15) NULL,
		[SEGMENT]    [VARCHAR](10)   NULL,
		[ENTITY]     [VARCHAR](50)   NULL,
		[ORDERSEG]   [BIGINT]   NULL,
		[ACTIVE_SEG] [VARCHAR] (MAX),
		[PARTYROWCOUNT] [INT] NULL,
		[TOTALPAGES] [INT] NULL
      )
    ON [PRIMARY]

 CREATE TABLE [DBO].[#DBNAME]    
 (    
  ACCOUNTDB VARCHAR(20),     
  EXCHANGE VARCHAR(6),     
  SEGMENT VARCHAR(10),    
  ACCOUNTSERVER VARCHAR(20),  
  SHAREDB VARCHAR(20),
  GROUPID VARCHAR(20),
  ORDER_SEGMENT INT  
 ) ON [PRIMARY]  
DECLARE  @@DB VARCHAR(1000)

IF @EXCSEGMENT = ''
	SELECT @EXCSEGMENT = EXCHANGE + '~' + SEGMENT FROM OWNER

IF @ENTITY_TYPE = 'ENTITY'	
	SELECT @@DB = " INSERT INTO #DBNAME SELECT ACCOUNTDB, EXCHANGE, SEGMENT, ACCOUNTSERVER, SHAREDB, GROUPID, ORDER_SEGMENT FROM COMPANY_MASTER_SETTING (NOLOCK) WHERE EXCHANGE + '~' + SEGMENT IN ('" + REPLACE(@EXCSEGMENT,',',''',''') + "') ORDER BY EXCHANGE "    
ELSE
	SELECT @@DB = " INSERT INTO #DBNAME SELECT ACCOUNTDB, EXCHANGE, SEGMENT, ACCOUNTSERVER, SHAREDB, GROUPID, ORDER_SEGMENT FROM COMPANY_MASTER_SETTING (NOLOCK) WHERE GROUPID IN ('" + REPLACE(@EXCSEGMENT,',',''',''') + "') ORDER BY GROUPID "    

PRINT @@DB
EXEC(@@DB)  




DECLARE @@MAINREC AS CURSOR,
		@@ACCOUNTDB VARCHAR(20),  
		@@SHAREDB VARCHAR(20),     
		@@ACCOUNTSVR VARCHAR(20),    
		@@EXCHANGE VARCHAR(15),    
		@@SEGMENT VARCHAR(15),
		@@GROUPID VARCHAR(20),
		@@ORDERSEG VARCHAR(3),
		@@ORDERSECOUNT INT
SET @@ORDERSECOUNT = (SELECT COUNT(1) FROM COMPANY_MASTER_SETTING) 

DECLARE @@SQL VARCHAR(MAX)
--SET @@SQL = ""
SET @@MAINREC = CURSOR FOR    
				 SELECT ACCOUNTDB, EXCHANGE, SEGMENT,ACCOUNTSERVER,SHAREDB,GROUPID,ORDER_SEGMENT FROM #DBNAME   
				 
OPEN @@MAINREC    
	FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT, @@ACCOUNTSVR, @@SHAREDB,@@GROUPID,@@ORDERSEG    
		WHILE @@FETCH_STATUS = 0    
		BEGIN			
		PRINT @@ACCOUNTDB 
	SET @@SQL = " INSERT INTO #TMPLEDGERNEW "
	SET @@SQL = @@SQL + " (BOOKTYPE, "
	SET @@SQL = @@SQL +" VOUDT, "
	SET @@SQL = @@SQL +" EFFDT, "
	SET @@SQL = @@SQL +" SHORTDESC, "
	SET @@SQL = @@SQL +" DRAMT, "
	SET @@SQL = @@SQL +" CRAMT, "
	SET @@SQL = @@SQL +" VNO, "
	SET @@SQL = @@SQL +" DDNO, "
	SET @@SQL = @@SQL +" NARRATION, "
	SET @@SQL = @@SQL +" CLTCODE, "
	SET @@SQL = @@SQL +" VTYP, "
	SET @@SQL = @@SQL +" VDT, "
	SET @@SQL = @@SQL +" EDT, "
	SET @@SQL = @@SQL +" ACNAME, "
	SET @@SQL = @@SQL +" OPBAL, "
	SET @@SQL = @@SQL +" L_ADDRESS1, "
	SET @@SQL = @@SQL +" L_ADDRESS2, "
	SET @@SQL = @@SQL +" L_ADDRESS3, "
	SET @@SQL = @@SQL +" L_CITY, "
	SET @@SQL = @@SQL +" L_ZIP, "
	SET @@SQL = @@SQL +" RES_PHONE1, "
	SET @@SQL = @@SQL +" BRANCH_CD, "
	SET @@SQL = @@SQL +" CROSAC, "
	SET @@SQL = @@SQL +" EDIFF, "
	SET @@SQL = @@SQL +" FAMILY, "
	SET @@SQL = @@SQL +" SUB_BROKER, "
	SET @@SQL = @@SQL +" TRADER, "
	SET @@SQL = @@SQL +" CL_TYPE, "
	SET @@SQL = @@SQL +" BANK_NAME, "
	SET @@SQL = @@SQL +" CLTDPID, "
	SET @@SQL = @@SQL +" LNO, "
	SET @@SQL = @@SQL +" PDT) "
	SET @@SQL = @@SQL +" EXEC "+@@ACCOUNTDB+"..RPT_ACC_PARTYLEDGER "
	SET @@SQL = @@SQL +"'" +@fdate +"', "
	SET @@SQL = @@SQL +"'" +@tdate +"', "
	SET @@SQL = @@SQL +"'" +@fcode +"', "
	SET @@SQL = @@SQL +"'" +@tcode +"', "
	SET @@SQL = @@SQL +"'" +@strorder +"', "
	SET @@SQL = @@SQL +"'" +@selectby +"', "
	SET @@SQL = @@SQL +"'" +@statusid +"', "
	SET @@SQL = @@SQL +"'" +@statusname+"', "
	SET @@SQL = @@SQL +"'" +@strbranch +"'" 
		  --return


EXEC (@@SQL)

		IF @ORDERFLG = 'N'
		  BEGIN
			 UPDATE #TMPLEDGERNEW 
				SET EXCHANGE = @@EXCHANGE, 
					SEGMENT = @@SEGMENT,
	 				ENTITY = 'SETTLEMENT LEDGER',
					ORDERSEG = 1 
			 WHERE  SEGMENT IS NULL 
		END 
		ELSE 
			BEGIN
				UPDATE #TMPLEDGERNEW 
	 				SET		EXCHANGE = @@EXCHANGE,
							SEGMENT =@@SEGMENT,
							ENTITY = CASE WHEN @ENTITY_TYPE = 'ENTITY'	THEN @@SEGMENT +"-"+ @@EXCHANGE ELSE @@GROUPID + ' - SETTLEMENT LEDGER' END,
	--IF @@ACCOUNTDB = 'ACCOUNT'
	--	SET @@SQL = @@SQL +	" 	 		   ORDERSEG = 1"
	--ELSE IF @@ACCOUNTDB = 'ACCOUNTBSE'
	--	SET @@SQL = @@SQL +	" 	 		   ORDERSEG = 2"
	--ELSE IF @@ACCOUNTDB = 'ACCOUNTFO'
	--	SET @@SQL = @@SQL +	" 	 		   ORDERSEG = 3"
							ORDERSEG = @@ORDERSEG 
				WHERE  SEGMENT IS NULL 
	END 

SET @@SQL = " 	INSERT INTO #TMPLEDGERNEW "
SET @@SQL = @@SQL +	" (BOOKTYPE, "
SET @@SQL = @@SQL +	"  VOUDT, "
SET @@SQL = @@SQL +	"  EFFDT, "
SET @@SQL = @@SQL +	"  SHORTDESC, "
SET @@SQL = @@SQL +	"  DRAMT, "
SET @@SQL = @@SQL +	"  CRAMT, "
SET @@SQL = @@SQL +	"  VNO, "
SET @@SQL = @@SQL +	"  DDNO, "
SET @@SQL = @@SQL +	"  NARRATION, "
SET @@SQL = @@SQL +	"  CLTCODE, "
SET @@SQL = @@SQL +	"  VTYP, "
SET @@SQL = @@SQL +	"  VDT, "
SET @@SQL = @@SQL +	"  EDT, "
SET @@SQL = @@SQL +	"  ACNAME, "
SET @@SQL = @@SQL +	"  OPBAL, "
SET @@SQL = @@SQL +	"  L_ADDRESS1, "
SET @@SQL = @@SQL +	"  L_ADDRESS2, "
SET @@SQL = @@SQL +	"  L_ADDRESS3, "
SET @@SQL = @@SQL +	"  L_CITY, "
SET @@SQL = @@SQL +	"  L_ZIP, "
SET @@SQL = @@SQL +	"  RES_PHONE1, "
SET @@SQL = @@SQL +	"  BRANCH_CD, "
SET @@SQL = @@SQL +	"  CROSAC, "
SET @@SQL = @@SQL +	"  EDIFF, "
SET @@SQL = @@SQL +	"  FAMILY, "
SET @@SQL = @@SQL +	"  SUB_BROKER, "
SET @@SQL = @@SQL +	"  TRADER, "
SET @@SQL = @@SQL +	"  CL_TYPE, "
SET @@SQL = @@SQL +	"  BANK_NAME, "
SET @@SQL = @@SQL +	"  CLTDPID, "
SET @@SQL = @@SQL +	"  LNO, "
SET @@SQL = @@SQL +	"  PDT) "
SET @@SQL = @@SQL +	"    EXEC "+@@ACCOUNTDB+"..RPT_ACC_MARGINLEDGER "
SET @@SQL = @@SQL +"'" +	@fdate +"', "
SET @@SQL = @@SQL +"'" +	@tdate +"', "
SET @@SQL = @@SQL +"'" +	@fcode +"', "
SET @@SQL = @@SQL +"'" +	@tcode +"', "
SET @@SQL = @@SQL +"'" +	@strorder +"', "
SET @@SQL = @@SQL +"'" +	@selectby +"', "
SET @@SQL = @@SQL +"'" +	@statusid +"', "
SET @@SQL = @@SQL +"'" +	@statusname +"', "
SET @@SQL = @@SQL +"'" +@strbranch+"'"  

EXEC (@@SQL)
    IF @orderflg = 'N'
      BEGIN
		UPDATE #TMPLEDGERNEW 
			SET   EXCHANGE =@@EXCHANGE,
			SEGMENT = @@SEGMENT ,
			ENTITY = 'MARGIN  LEDGER', 
			ORDERSEG = 2 
		WHERE SEGMENT IS NULL 
      END
    ELSE
      BEGIN
		UPDATE #TMPLEDGERNEW 
			SET    EXCHANGE = @@EXCHANGE,
			SEGMENT = @@SEGMENT,
			ENTITY = CASE WHEN @ENTITY_TYPE = 'ENTITY'	THEN 'MARGIN-' + @@EXCHANGE ELSE @@GROUPID + ' - MARGIN LEDGER' END,
			--IF @@ACCOUNTDB = 'ACCOUNT'
			--	SET @@SQL = @@SQL +	" 	 		   ORDERSEG = 4"
			--ELSE IF @@ACCOUNTDB = 'ACCOUNTBSE'
			--	SET @@SQL = @@SQL +	" 	 		   ORDERSEG = 5"
			--ELSE IF @@ACCOUNTDB = 'ACCOUNTFO'
			--	SET @@SQL = @@SQL +	" 	 		   ORDERSEG = 6"
				
			ORDERSEG = @@ORDERSEG+ @@ORDERSECOUNT
		WHERE  SEGMENT IS NULL 
	END
	

FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT, @@ACCOUNTSVR, @@SHAREDB ,@@GROUPID, @@ORDERSEG   
END
CLOSE @@MAINREC
DEALLOCATE @@MAINREC

--IF ((SELECT COUNT(1) FROM [#DBNAME] WHERE ACCOUNTDB = 'ACCOUNTFO') = 1)
--BEGIN
--    INSERT INTO #TMPLEDGERNEW
--              (VOUDT,
--               EFFDT,
--               SHORTDESC,
--               DRAMT,
--               CRAMT,
--               VNO,
--               DDNO,
--               NARRATION,
--               CLTCODE,
--               VTYP,
--               VDT,
--               EDT)
--    EXEC NSEFO.DBO.V2_GETMARGINREQ
--      @TDATE ,
--      @FCODE ,
--      @TCODE ,
--		@STATUSID ,
--      @STATUSNAME ,
--      @STRBRANCH
 
      
--        UPDATE #TMPLEDGERNEW
--        SET    EXCHANGE = 'NSE',
--          SEGMENT = 'FUTURES',
--               ENTITY = 'MARGIN REQ - NFO',
--               ORDERSEG = (@@ORDERSECOUNT * 2)+ 1
--        WHERE  SEGMENT IS NULL
      
--END

    IF @orderflg = 'N'
      BEGIN
        SELECT   CLTCODE,
         EXCHANGE,
                 SEGMENT,
                 ORDERSEG,
                 OPBAL = MAX(OPBAL)
        INTO     #OPBAL
        FROM     #TMPLEDGERNEW
        GROUP BY CLTCODE,EXCHANGE,SEGMENT,ORDERSEG


        SELECT   CLTCODE,
                 ORDERSEG,
                 OPBAL = SUM(OPBAL)
        INTO     #FINOPBAL
        FROM     #OPBAL
        GROUP BY CLTCODE,ORDERSEG

        UPDATE #TMPLEDGERNEW
        SET    OPBAL = 0

        UPDATE #TMPLEDGERNEW
        SET    OPBAL = ISNULL(T.OPBAL,0)
        FROM   #TMPLEDGERNEW L WITH (NoLock),
               #FINOPBAL T WITH (NoLock)
        WHERE  
			L.CLTCODE = T.CLTCODE                     
			AND L.ORDERSEG = T.ORDERSEG
      END
      UPDATE #TMPLEDGERNEW SET ACTIVE_SEG = 'NSE,BSE,FNO,COMMODITY'

	DELETE FROM #TMPLEDGERNEW WHERE VTYP = 18 AND VNO IS NOT NULL
    IF @FORPDF = 'Y'
  BEGIN
   ALTER TABLE #TMPLEDGERNEW ADD PDFLINES INT
   UPDATE #TMPLEDGERNEW SET PDFLINES = LEN(LTRIM(RTRIM(ISNULL(NARRATION, '')))) / 35 + 1 WHERE VTYP <> '18'
   UPDATE #TMPLEDGERNEW SET PDFLINES = (I.LNO + 1) FROM (SELECT CLTCODE, LNO = SUM(PDFLINES) FROM #TMPLEDGERNEW GROUP BY CLTCODE) I
     WHERE #TMPLEDGERNEW.CLTCODE = I.CLTCODE


   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = CEILING(CONVERT(NUMERIC(10,2), LEN(ISNULL(NARRATION, ''))) / 35)
   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = 1 WHERE LEN(ISNULL(NARRATION, '')) = 0
   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = (SELECT SUM(PARTYROWCOUNT) /*+ COUNT(DISTINCT ORDERSEG)*/ FROM #TMPLEDGERNEW I WHERE #TMPLEDGERNEW.CLTCODE = I.CLTCODE GROUP BY CLTCODE)
   UPDATE #TMPLEDGERNEW SET PARTYROWCOUNT = PARTYROWCOUNT + (SELECT (COUNT(DISTINCT ORDERSEG) * 1) + 1 FROM #TMPLEDGERNEW I WHERE #TMPLEDGERNEW.CLTCODE = I.CLTCODE GROUP BY CLTCODE)
   UPDATE #TMPLEDGERNEW SET TOTALPAGES = .dbo.PARTYLEDGERPAGES(PARTYROWCOUNT)


  END
    IF @strorder = 'ACCODE'
      BEGIN
        IF @selectby = 'vdt'
          BEGIN
            IF @orderflg = 'N'
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW
				
                ORDER BY CLTCODE,
                         ORDERSEG,
                         VOUDT
              END
            ELSE
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW
                ORDER BY CLTCODE,
                         ORDERSEG,
                         VOUDT
              END
          END
        ELSE
          BEGIN
            IF @orderflg = 'N'
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW
                ORDER BY CLTCODE,
                         ORDERSEG,
                         EFFDT
              END
            ELSE
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW
                ORDER BY CLTCODE,
                         ORDERSEG,
                         EFFDT
              END
          END
      END
  ELSE
	BEGIN
	IF @selectby = 'vdt'
          BEGIN
            IF @orderflg = 'N'
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW T
                ORDER BY ACNAME,
                         ORDERSEG,
                         VOUDT
              END
            ELSE
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW
                ORDER BY ACNAME,
                         ORDERSEG,
                         VOUDT
              END
          END
        ELSE
          BEGIN
            IF @orderflg = 'N'
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW
                ORDER BY ACNAME,
                         ORDERSEG,
                         EFFDT
              END
            ELSE
              BEGIN
                SELECT   *
                FROM     #TMPLEDGERNEW
                ORDER BY ACNAME,
                         ORDERSEG,
                         EFFDT
              END
          END
      END
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_RPT_ACC_TRIALBALANCE_ALL_NEW
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_RPT_ACC_TRIALBALANCE_ALL_NEW]      
 @VDT VARCHAR(11),         /* AS ON DATE ENTERED BY USER */      
 @FLAG VARCHAR(15),         /* SORT ORDER FOR REPORT - CODEWISE OR NAMEWISE */      
 @VIEWOPTION VARCHAR(10),      /* OPTIONS FOR ACCOUNTS SELECTION - ALL, GL, PARTY */      
 @BALANCE VARCHAR(10),       /* NORMAL OR WITHOPBAL */      
 @STDATE VARCHAR(11),       /* START DATE ENTERED BY USER */      
 @CURRYRSTDATE VARCHAR(11),     /* START DATE OF FINANCIAL YEAR */      
 @OPENENTRYFLAG INT,      
 @OPENINGENTRYDATE VARCHAR(11),   /* O/P ENTRY DATE ( VTYP = 18 ) FROUND FROM LEDGER FOR VDT <= LAST DATE ENTERED BY USER */      
 @STATUSID VARCHAR(20),       /* AS BROKER/BRANCH/CLIENT ETC. */      
 @STATUSNAME VARCHAR(20),      /* IN CASE OF BRANCH LOGIN BRANCHCODE */      
 @SORTBYDATE VARCHAR(3),       /* WHETHER REPORT IS BASED ON VDT OR EDT */      
 @SHOWZEROBAL VARCHAR(1),      /* SHOW ZERO BAL   */      
 @SHOWMARGIN VARCHAR(1),       /* SHOW MARGIN LEDGER   */      
 @EXCSEGMENT VARCHAR(2000),    
 @GRPCODE VARCHAR(20)      
AS      
      
DECLARE @CHKFLAG INT      
         
CREATE TABLE [DBO].[#TMPTRIALBALANCE]      
 (      
 [CLTCODE] [VARCHAR] (10) ,      
 [ACNAME] [VARCHAR] (100) NULL ,      
 [BRANCHCODE] [VARCHAR] (10) NULL,      
 [AMOUNT] [MONEY] NULL ,      
 [SEGMENT] [VARCHAR] (5) NULL,      
 [ENTITY] [VARCHAR] (50) NULL,      
 [ACCAT][CHAR](3),    
 [GRPCODE][VARCHAR](13),    
 [GRPNAME][VARCHAR](60)    
 ) ON [PRIMARY]      
      
 CREATE TABLE [DBO].[#DBNAME]      
 (      
  ACCOUNTDB VARCHAR(20),       
  EXCHANGE VARCHAR(6),       
  SEGMENT VARCHAR(10),      
  ACCOUNTSERVER VARCHAR(20),    
  SHAREDB VARCHAR(20)    
 ) ON [PRIMARY]      
       
DECLARE      
 @@ACCOUNTDB VARCHAR(20),    
 @@SHAREDB VARCHAR(20),       
 @@ACCOUNTSVR VARCHAR(20),      
 @@EXCHANGE VARCHAR(15),      
 @@SEGMENT VARCHAR(15),      
 @@ORDERFLAG VARCHAR(1),      
 @@SQL VARCHAR(5000),      
 @@REPORTSQL VARCHAR(8000),      
 @@TOTAMT VARCHAR(5000),      
 @@DB VARCHAR(1000),      
 @@SUMSQL VARCHAR(3000),      
 @@SEGORD TINYINT,      
 @@MAINREC AS CURSOR  


SELECT DISTINCT GRPCODE
	,GRPNAME
INTO #ABC
FROM FN_ACC_GETALLSUBGRPCD('')    
      
SELECT @@DB = " INSERT INTO #DBNAME SELECT ACCOUNTDB, EXCHANGE, SEGMENT, ACCOUNTSERVER, SHAREDB FROM PRADNYA.DBO.MULTICOMPANY (NOLOCK) WHERE PRIMARYSERVER = 1 AND EXCHANGE + '~' + SEGMENT IN ('" + REPLACE(@EXCSEGMENT,',',''',''') + "') ORDER BY EXCHANGE,SEGMENT "
      
PRINT @@DB    
EXEC(@@DB)       
      
SET @@REPORTSQL = " SELECT CLTCODE = ISNULL(CLTCODE,''),ACNAME = ISNULL(ACNAME,'CLIENT BALANCE'),BRANCHCODE = ISNULL(BRANCHCODE,''),GRPNAME = ISNULL(GRPNAME,''), "      
SET @@SUMSQL = ""      
SET @@TOTAMT = ""      
      
SET @@MAINREC = CURSOR FOR      
      
SELECT ACCOUNTDB, EXCHANGE, SEGMENT,ACCOUNTSERVER,SHAREDB FROM #DBNAME      
SET @@SEGORD = 1      
      
OPEN @@MAINREC      
 FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT, @@ACCOUNTSVR, @@SHAREDB      
WHILE @@FETCH_STATUS = 0      
BEGIN      
 IF @@ACCOUNTSVR <> @@SERVERNAME      
  BEGIN      
  SET @@SQL = " INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT,ACCAT,SEGMENT,ENTITY,GRPCODE,GRPNAME) "      
  SET @@SQL = @@SQL + " EXEC " + @@ACCOUNTSVR + "." + @@ACCOUNTDB + ".DBO.V2_NEWASP_TRIALBALANCE '" + @VDT + "','" + @FLAG + "','" + @VIEWOPTION + "','"      
  SET @@SQL = @@SQL + @BALANCE + "','" + @STDATE + "','" + @CURRYRSTDATE + "'," + CONVERT(VARCHAR,@OPENENTRYFLAG) + ",'" + @OPENINGENTRYDATE + "','"    
  SET @@SQL = @@SQL + @STATUSID + "','" + @STATUSNAME + "','" + @SORTBYDATE + "','" + @SHOWZEROBAL + "','" + @GRPCODE + "','"+ @@SHAREDB +"','"+ @@EXCHANGE +"','"+ @@SEGMENT +"' "      
   END      
 ELSE      
  BEGIN      
  SET @@SQL = " INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT,ACCAT,SEGMENT,ENTITY,GRPCODE,GRPNAME) "      
  SET @@SQL = @@SQL + " EXEC " + @@ACCOUNTDB + ".DBO.V2_NEWASP_TRIALBALANCE '" + @VDT + "','" + @FLAG + "','" + @VIEWOPTION + "','"      
  SET @@SQL = @@SQL + @BALANCE + "','" + @STDATE + "','" + @CURRYRSTDATE + "'," + CONVERT(VARCHAR,@OPENENTRYFLAG) + ",'" + @OPENINGENTRYDATE + "','"     
  SET @@SQL = @@SQL + @STATUSID + "','" + @STATUSNAME + "','" + @SORTBYDATE + "','" + @SHOWZEROBAL + "','" + @GRPCODE + "','"+ @@SHAREDB +"','"+ @@EXCHANGE +"','"+ @@SEGMENT +"' "     
 END      
      
 IF @VIEWOPTION='GL'      
  BEGIN      
  IF @@ACCOUNTSVR <> @@SERVERNAME      
   BEGIN         
   SET @@SQL = @@SQL + " INSERT INTO #TMPTRIALBALANCE(AMOUNT,SEGMENT,ENTITY,GRPCODE,GRPNAME)"      
   SET @@SQL = @@SQL + " EXEC " + @@ACCOUNTSVR + "." + @@ACCOUNTDB + ".DBO.V2_NEWASP_TRIALBALANCEPARTYTOTAL '" + @VDT + "','" + @FLAG + "','" + @VIEWOPTION + "','"      
   SET @@SQL = @@SQL +  @BALANCE + "','" + @STDATE + "','" + @CURRYRSTDATE + "'," + CONVERT(VARCHAR,@OPENENTRYFLAG) + ",'" + @OPENINGENTRYDATE + "','" + @STATUSID + "','"     
   SET @@SQL = @@SQL +  @STATUSNAME + "','" + @SORTBYDATE + "','" + @GRPCODE + "','"+ @@SHAREDB +"','"+ @@EXCHANGE +"','"+ @@SEGMENT +"'  "      
   END      
  ELSE      
   BEGIN       
   SET @@SQL = @@SQL + " INSERT INTO #TMPTRIALBALANCE(AMOUNT,SEGMENT,ENTITY,GRPCODE,GRPNAME)"      
   SET @@SQL = @@SQL + " EXEC " + @@ACCOUNTDB + ".DBO.V2_NEWASP_TRIALBALANCEPARTYTOTAL '" + @VDT + "','" + @FLAG + "','" + @VIEWOPTION + "','"      
   SET @@SQL = @@SQL +  @BALANCE + "','" + @STDATE + "','" + @CURRYRSTDATE + "'," + CONVERT(VARCHAR,@OPENENTRYFLAG) + ",'" + @OPENINGENTRYDATE + "','" + @STATUSID + "','"    
   SET @@SQL = @@SQL +  @STATUSNAME + "','" + @SORTBYDATE + "','" + @GRPCODE + "','"+ @@SHAREDB +"','"+ @@EXCHANGE +"','"+ @@SEGMENT +"' "      
  END       
  END      
      
 PRINT (@@SQL)    
 EXEC (@@SQL)        
 --For Margin Ledger      
 IF @SHOWMARGIN = 'Y'      
 BEGIN    
  IF @@ACCOUNTSVR <> @@SERVERNAME      
   BEGIN       
    SET @@SQL = " INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT,ACCAT,SEGMENT,ENTITY,GRPCODE,GRPNAME)"      
    SET @@SQL = @@SQL + " EXEC " + @@ACCOUNTSVR + "." + @@ACCOUNTDB + ".DBO.V2_NEWASP_MARGINTRIALBALANCE '" + @VDT + "','" + @FLAG + "','" + @VIEWOPTION + "','"      
    SET @@SQL = @@SQL + @BALANCE + "','" + @STDATE + "','" + @CURRYRSTDATE + "'," + CONVERT(VARCHAR,@OPENENTRYFLAG) + ",'" + @OPENINGENTRYDATE + "','"     
    SET @@SQL = @@SQL + @STATUSID + "','" + @STATUSNAME + "','" + @SORTBYDATE +"','" + @SHOWZEROBAL + "','" + @GRPCODE + "','"+ @@SHAREDB +"','"+ @@EXCHANGE +"','"+ @@SEGMENT +"' "      
    END      
  ELSE      
   BEGIN       
    SET @@SQL = " INSERT INTO #TMPTRIALBALANCE(CLTCODE,ACNAME,BRANCHCODE,AMOUNT,ACCAT,SEGMENT,ENTITY,GRPCODE,GRPNAME)"      
    SET @@SQL = @@SQL + " EXEC " + @@ACCOUNTDB + ".DBO.V2_NEWASP_MARGINTRIALBALANCE '" + @VDT + "','" + @FLAG + "','" + @VIEWOPTION + "','"      
    SET @@SQL = @@SQL + @BALANCE + "','" + @STDATE + "','" + @CURRYRSTDATE + "'," + CONVERT(VARCHAR,@OPENENTRYFLAG) + ",'" + @OPENINGENTRYDATE + "','"     
    SET @@SQL = @@SQL + @STATUSID + "','" + @STATUSNAME + "','" + @SORTBYDATE +"','" + @SHOWZEROBAL + "','" + @GRPCODE + "','"+ @@SHAREDB +"','"+ @@EXCHANGE +"','"+ @@SEGMENT +"' "      
   END     
      
  IF @VIEWOPTION='GL'      
   BEGIN    
   IF @@ACCOUNTSVR <> @@SERVERNAME      
   BEGIN      
    SET @@SQL = @@SQL + " INSERT INTO #TMPTRIALBALANCE(AMOUNT,SEGMENT,ENTITY,GRPCODE,GRPNAME)"      
    SET @@SQL = @@SQL + " EXEC " + @@ACCOUNTSVR + "." + @@ACCOUNTDB + ".DBO.V2_NEWASP_MARGINTRIALBALANCEPARTYTOTAL '" + @VDT + "','" + @FLAG + "','" + @VIEWOPTION + "','"      
    SET @@SQL = @@SQL + @BALANCE + "','" + @STDATE + "','" + @CURRYRSTDATE + "'," + CONVERT(VARCHAR,@OPENENTRYFLAG) + ",'" + @OPENINGENTRYDATE + "','"     
 SET @@SQL = @@SQL + @STATUSID + "','" + @STATUSNAME + "','" + @SORTBYDATE +"','" + @GRPCODE + "','"+ @@SHAREDB +"','"+ @@EXCHANGE +"','"+ @@SEGMENT +"' "      
 END      
  ELSE      
   BEGIN     
 SET @@SQL = @@SQL + " INSERT INTO #TMPTRIALBALANCE(AMOUNT,SEGMENT,ENTITY,GRPCODE,GRPNAME)"      
    SET @@SQL = @@SQL + " EXEC " + @@ACCOUNTDB + ".DBO.V2_NEWASP_MARGINTRIALBALANCEPARTYTOTAL '" + @VDT + "','" + @FLAG + "','" + @VIEWOPTION + "','"      
    SET @@SQL = @@SQL + @BALANCE + "','" + @STDATE + "','" + @CURRYRSTDATE + "'," + CONVERT(VARCHAR,@OPENENTRYFLAG) + ",'" + @OPENINGENTRYDATE + "','"     
 SET @@SQL = @@SQL + @STATUSID + "','" + @STATUSNAME + "','" + @SORTBYDATE +"','" + @GRPCODE + "','"+ @@SHAREDB +"','"+ @@EXCHANGE +"','"+ @@SEGMENT +"' "      
   END      
  END    
      
  SET @@SQL = @@SQL + " UPDATE #TMPTRIALBALANCE SET SEGMENT='" + @@EXCHANGE + "', ENTITY= 'MARGIN " + @@EXCHANGE + " - " + @@SEGMENT +"' WHERE SEGMENT IS NULL "      
  PRINT(@@SQL)     
  EXEC (@@SQL)      
 END      
     
 IF @STATUSID = 'CLIENT'      
 BEGIN      
  DELETE FROM #TMPTRIALBALANCE      
  WHERE CLTCODE <> @STATUSNAME      
 END      
       
 SET @@REPORTSQL = @@REPORTSQL + " NET" + @@EXCHANGE + LEFT(@@SEGMENT,3) +" = SUM(CASE WHEN SEGMENT='" + @@EXCHANGE + "' AND ENTITY = '" + @@EXCHANGE + " - " + @@SEGMENT +"' THEN AMOUNT ELSE 0 END), "      
       
 IF @@TOTAMT = ''      
  SET @@TOTAMT = " SUM(CASE WHEN SEGMENT='" + @@EXCHANGE + "' AND ENTITY = '" + @@EXCHANGE + " - " + @@SEGMENT +"' THEN AMOUNT ELSE 0 END) "      
 ELSE      
  SET @@TOTAMT = @@TOTAMT + " + SUM(CASE WHEN SEGMENT='" + @@EXCHANGE + "' AND ENTITY = '" + @@EXCHANGE + " - " + @@SEGMENT +"' THEN AMOUNT ELSE 0 END) "      
      
    IF @SHOWMARGIN='Y'      
  BEGIN       
  SET @@REPORTSQL = @@REPORTSQL + " NET" + @@EXCHANGE + LEFT(@@SEGMENT,3) +"ML  = SUM(CASE WHEN SEGMENT='" + @@EXCHANGE + "' AND ENTITY = 'MARGIN " + @@EXCHANGE + " - " + @@SEGMENT +"' THEN AMOUNT ELSE 0 END), "      
  SET @@TOTAMT = @@TOTAMT + " + SUM(CASE WHEN SEGMENT='" + @@EXCHANGE + "' AND ENTITY = 'MARGIN " + @@EXCHANGE + " - " + @@SEGMENT +"' THEN AMOUNT ELSE 0 END) "      
     END      
 --SUM OF SEGMENT TOTAL AMOUNT      
 IF @@SUMSQL = ''      
  BEGIN      
  SET @@SUMSQL = " COMPUTE SUM(SUM(CASE WHEN SEGMENT='" + @@EXCHANGE + "' AND ENTITY = '" + @@EXCHANGE + " - " + @@SEGMENT +"' THEN AMOUNT ELSE 0 END)) "      
  IF @SHOWMARGIN='Y'      
   BEGIN        
   SET @@SUMSQL = @@SUMSQL + " ,SUM(SUM(CASE WHEN SEGMENT='" + @@EXCHANGE + "' AND ENTITY = 'MARGIN " + @@EXCHANGE + " - " + @@SEGMENT +"' THEN AMOUNT ELSE 0 END)) "      
   END      
  END      
 ELSE      
  BEGIN      
  SET @@SUMSQL = @@SUMSQL + " ,SUM(SUM(CASE WHEN SEGMENT='" + @@EXCHANGE + "' AND ENTITY = '" + @@EXCHANGE + " - " + @@SEGMENT +"' THEN AMOUNT ELSE 0 END)) "      
  IF @SHOWMARGIN='Y'      
   BEGIN       
   SET @@SUMSQL = @@SUMSQL + " ,SUM(SUM(CASE WHEN SEGMENT='" + @@EXCHANGE + "' AND ENTITY = 'MARGIN " + @@EXCHANGE + " - " + @@SEGMENT +"' THEN AMOUNT ELSE 0 END)) "      
   END      
  END      
       
 SET @@SEGORD = @@SEGORD + 1      
      
      
 FETCH NEXT FROM @@MAINREC INTO @@ACCOUNTDB, @@EXCHANGE, @@SEGMENT, @@ACCOUNTSVR,@@SHAREDB      
END      
      
SET @@REPORTSQL = @@REPORTSQL + "" + @@TOTAMT + ", ACCAT FROM #TMPTRIALBALANCE "      
SET @@REPORTSQL = @@REPORTSQL + " GROUP BY CLTCODE,ACNAME,BRANCHCODE,ACCAT, GRPNAME "      
IF UPPER(@FLAG) = 'CODEWISE'      
 BEGIN       
 SET @@REPORTSQL = @@REPORTSQL + " ORDER BY CLTCODE "      
 END      
ELSE      
 BEGIN      
 SET @@REPORTSQL = @@REPORTSQL + " ORDER BY ACNAME "      
 END       
SET @@REPORTSQL = @@REPORTSQL +  @@SUMSQL       
    
PRINT @@REPORTSQL      
EXEC(@@REPORTSQL)      
      
TRUNCATE TABLE #DBNAME      
TRUNCATE TABLE #TMPTRIALBALANCE      
DROP TABLE #DBNAME      
DROP TABLE #TMPTRIALBALANCE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VDTYEAREND
-- --------------------------------------------------


CREATE PROCEDURE VDTYEAREND  
@SDTCUR VARCHAR(11),  
@LDTCUR VARCHAR(11),  
@VTYP   SMALLINT,  
@VNO VARCHAR(12),  
@BOOKTYPE CHAR(2),  
@VDT    DATETIME,  
@MSG1   VARCHAR(234)  
AS  
DECLARE  
@@CLTCODE AS VARCHAR(10),  
@@ACNAME  AS VARCHAR(100),  
@@VDTBAL  AS MONEY,  
@@LNO     AS INT,  
@@CDT     AS DATETIME,  
@@NETDIFF AS MONEY,  
@@PLCOUNT AS INT,  
@@PLBAL   AS MONEY,  
@@RCURSOR AS CURSOR,
@@FIXCODE VARCHAR(10) 

SELECT @@FIXCODE = '999999'

SELECT @@CDT = ( SELECT GETDATE() )  
  
SET @@RCURSOR = CURSOR FOR  
SELECT L.CLTCODE,L.ACNAME , BALANCE=ISNULL(SUM( CASE WHEN UPPER(DRCR) = 'D' THEN VAMT ELSE -VAMT END),0)  
FROM LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE  
WHERE L.VDT > = @SDTCUR + ' 00:00:00' AND L.VDT <= @LDTCUR + ' 23:59:59'  
AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%') AND L.CLTCODE <> @@FIXCODE  
GROUP BY L.CLTCODE,L.ACNAME  
ORDER BY L.CLTCODE,L.ACNAME  
  
OPEN @@RCURSOR  
FETCH NEXT FROM @@RCURSOR   
INTO @@CLTCODE, @@ACNAME, @@VDTBAL  
  
SELECT @@LNO = 0  
SELECT @@NETDIFF = 0  
WHILE @@FETCH_STATUS = 0  
BEGIN  
   SELECT @@LNO = @@LNO + 1  
   SELECT @@NETDIFF = @@NETDIFF + @@VDTBAL  
  
   INSERT INTO LEDGER(VTYP,VNO,DRCR,VAMT,VDT,REFNO,CLTCODE,  
                      ENTEREDBY,LNO,BALAMT,VNO1,BOOKTYPE,EDT,CDT,PDT,NODAYS,ACTNODAYS,CHECKEDBY,ACNAME,NARRATION)   
               VALUES (@VTYP,@VNO,(CASE WHEN @@VDTBAL >= 0 THEN 'D' ELSE 'C' END),ISNULL(ABS(@@VDTBAL),0),@VDT,'',UPPER(@@CLTCODE),  
                       'SYSTEM',@@LNO,0,@VNO,@BOOKTYPE,@VDT,@@CDT,@@CDT,0,0,'SYSTEM',@@ACNAME,@MSG1)  
  
  
   INSERT INTO LEDGER3(NARATNO,NARR,REFNO,VTYP,VNO,BOOKTYPE)   
                VALUES(@@LNO,@MSG1,'',@VTYP,@VNO,@BOOKTYPE)  
  
   FETCH NEXT FROM @@RCURSOR   
   INTO @@CLTCODE, @@ACNAME, @@VDTBAL  
END  
  
CLOSE @@RCURSOR  
DEALLOCATE @@RCURSOR  
  
SELECT @@LNO = @@LNO + 1  
SELECT @@ACNAME = ( SELECT ACNAME FROM ACMAST WHERE CLTCODE = @@FIXCODE)  
INSERT INTO LEDGER(VTYP,VNO,DRCR,VAMT,VDT,REFNO,CLTCODE,  
                   ENTEREDBY,LNO,BALAMT,VNO1,BOOKTYPE,EDT,CDT,PDT,NODAYS,ACTNODAYS,CHECKEDBY,ACNAME,NARRATION)   
            VALUES (@VTYP,@VNO,(CASE WHEN @@NETDIFF >= 0 THEN 'C' ELSE 'D' END),ABS(@@NETDIFF),@VDT,'',@@FIXCODE,  
                    'SYSTEM',@@LNO,0,@VNO,@BOOKTYPE,@VDT,@@CDT,@@CDT,0,0,'SYSTEM',@@ACNAME,@MSG1)  
  
  
INSERT INTO LEDGER3  
SELECT LNO, NARRATION, REFNO, VTYP, VNO, BOOKTYPE  
FROM LEDGER  
WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO AND  CLTCODE=@@FIXCODE  
  
INSERT INTO LEDGER3  
SELECT 0, NARRATION, REFNO, VTYP, VNO, BOOKTYPE  
FROM LEDGER  
WHERE VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE AND VNO = @VNO AND LNO = 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VOUCHERPRINTINGSP
-- --------------------------------------------------


--EXEC VOUCHERPRINTINGSP '7','01','01','','','200504070007','200504070007',1,1         
        
--EXEC VOUCHERPRINTINGSP '4','01','01','','','200504020001','200504020001',1,1            
          
/****** OBJECT:  STORED PROCEDURE DBO.VOUCHERPRINTINGSP    SCRIPT DATE: 06/24/2004 8:32:35 PM ******/              
              
/****** OBJECT:  STORED PROCEDURE DBO.VOUCHERPRINTINGSP    SCRIPT DATE: 05/10/2004 5:29:36 PM ******/              
/* COMM. NARR REPLACED LINE NARRATION  BY AMIT REQUIRMENT IN MOSL ON 18/10/2002*/              
              
CREATE PROC VOUCHERPRINTINGSP               
@VTYP VARCHAR(2),              
@BOOKTYPEFROM VARCHAR(2),              
@BOOKTYPETO VARCHAR(2),              
@STARTDATE VARCHAR(11),              
@ENDDATE VARCHAR(11),              
@VNOFROM VARCHAR(12),              
@VNOTO VARCHAR(12),              
@VNOVDTFLAG INT,              
@FLAG INT              
AS              
              
IF @FLAG = 0              
BEGIN              
   IF @STARTDATE = ''               
      BEGIN              
/* CONDITIONS OF VNO ONLY */              
   SELECT   CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24               
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                     ELSE L.CLTCODE END ),0),               
     ACNAME= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24               
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                        ELSE L.ACNAME END ),0),                
     ISNULL(L.VAMT,0) VAMT, L.DRCR, L.VTYP,L.VNO, L.LNO , L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,              
     BANK = ISNULL(BNKNAME,''), BRANCH = ISNULL(BRNNAME,'') , ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO, DDDT  =  CONVERT(VARCHAR,DDDT,103)  ,              
     NARR = ISNULL(L.NARRATION,'') ,              
     /*CNAR = ISNULL((SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = 0 AND L3.BOOKTYPE = L.BOOKTYPE),'') ,*/              
     CNAR = ISNULL(L.NARRATION,'') ,              
   CLTCODE2 = CLTCODE, ACNAME2 = ACNAME              
    FROM LEDGER L ,LEDGER1 L1              
    WHERE L1.VTYP = L.VTYP AND L1.VNO = L.VNO AND L1.BOOKTYPE = L.BOOKTYPE                
    AND L.VTYP = @VTYP AND L.BOOKTYPE >= @BOOKTYPEFROM AND L.BOOKTYPE <= @BOOKTYPETO               
    AND L.VNO >= @VNOFROM  AND L.VNO <= @VNOTO               
  ORDER BY L.VDT, L.VTYP, L.BOOKTYPE, L.VNO, /*L.DRCR DESC, */L.LNO    
      END              
   ELSE              
   IF @VNOFROM = ''               
      BEGIN              
         /* CONDITIONS ON VDT ONLY */              
  SELECT   CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                
               THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                    ELSE L.CLTCODE END ),0),               
    ACNAME= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24               
                      THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                       ELSE L.ACNAME END ),0),                
    ISNULL(L.VAMT,0) VAMT, L.DRCR, L.VTYP,L.VNO, L.LNO , L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,              
    BANK = ISNULL(BNKNAME,''), BRANCH = ISNULL(BRNNAME,'') , ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO, DDDT  =  CONVERT(VARCHAR,DDDT,103)  ,              
    NARR = ISNULL(L.NARRATION,'') ,              
     /*CNAR = ISNULL((SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = 0 AND L3.BOOKTYPE = L.BOOKTYPE),''), */              
  CNAR = ISNULL(L.NARRATION,'') ,              
  CLTCODE2 = CLTCODE, ACNAME2 = ACNAME          
    FROM LEDGER L ,LEDGER1 L1              
   WHERE   L.VTYP = @VTYP AND L.BOOKTYPE >= @BOOKTYPEFROM AND L.BOOKTYPE <= @BOOKTYPETO AND VDT >= @STARTDATE + ' 00:00:00'              
   AND L1.VTYP = L.VTYP AND L1.VNO = L.VNO AND L1.BOOKTYPE = L.BOOKTYPE               
    AND VDT <=@ENDDATE + ' 23:59:59'              
    ORDER BY L.VDT, L.VTYP, L.BOOKTYPE, L.VNO, L.LNO              
              
      END              
   ELSE              
      BEGIN              
         /* CONDITIONS ON VDT AND VNO */              
   SELECT   CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24               
                 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                     ELSE L.CLTCODE END ),0),               
     ACNAME= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24               
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                        ELSE L.ACNAME END ),0),                
     ISNULL(L.VAMT,0) VAMT, L.DRCR, L.VTYP,L.VNO, L.LNO , L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,              
     BANK = ISNULL(BNKNAME,''), BRANCH = ISNULL(BRNNAME,'') , ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO, DDDT  =  CONVERT(VARCHAR,DDDT,103)  ,              
     NARR = ISNULL(L.NARRATION,'') ,              
     /*CNAR = ISNULL((SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = 0 AND L3.BOOKTYPE = L.BOOKTYPE),'') ,*/              
   CNAR = ISNULL(L.NARRATION,'') ,              
   CLTCODE2 = CLTCODE, ACNAME2 = ACNAME              
    FROM LEDGER L ,LEDGER1 L1              
    WHERE L1.VTYP = L.VTYP AND L1.VNO = L.VNO AND L1.BOOKTYPE = L.BOOKTYPE                
    AND L.VTYP = @VTYP AND L.BOOKTYPE >= @BOOKTYPEFROM AND L.BOOKTYPE <= @BOOKTYPETO               
    AND L.VNO >= @VNOFROM  AND L.VNO <= @VNOTO               
/* FOLL CONDITION ADDED BY KALPANA ON 19/09/2002 */              
  AND VDT >= (CASE WHEN @STARTDATE <> ''  THEN @STARTDATE  + ' 00:00:00'              
    ELSE 'JAN  1 1900' + ' 00:00:00'              
    END)               
  AND VDT <= (CASE WHEN @ENDDATE <> ''  THEN @ENDDATE + ' 23:59:59'              
    ELSE GETDATE()              
    END)               
    ORDER BY L.VDT, L.VTYP, L.BOOKTYPE, L.VNO, /*L.DRCR DESC, */L.LNO -- DESC              
      END              
END            
              
ELSE IF @FLAG = 1              
BEGIN              
  IF @STARTDATE = ''               
     BEGIN              
  /* CONDITIONS OF VNO ONLY */              
  SELECT   CLTCODE = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24               
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                     ELSE L.CLTCODE END ),0),               
     ACNAME= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24               
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                       ELSE L.ACNAME END ),0),                
   ISNULL(L.VAMT,0) VAMT, L.DRCR, L.VTYP,L.VNO, L.LNO , L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,              
     NARR = ISNULL(L.NARRATION,'') ,              
     /*CNAR = ISNULL((SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = 0 AND L3.BOOKTYPE = L.BOOKTYPE),'') ,*/              
   CNAR = ISNULL(L.NARRATION,'') ,              
   CLTCODE2 = CLTCODE, ACNAME2 = ACNAME              
     FROM LEDGER L               
    WHERE  L.VTYP = @VTYP AND L.BOOKTYPE >= @BOOKTYPEFROM AND L.BOOKTYPE <= @BOOKTYPETO               
    AND L.VNO >= @VNOFROM  AND L.VNO <= @VNOTO            
   --AND L.DRCR IN (CASE WHEN @VTYP='6' THEN 'C' ELSE CASE WHEN @VTYP='7' THEN 'D' ELSE 'C''D' END END)            
  ORDER BY L.VDT, L.VTYP, L.BOOKTYPE, L.VNO, /*L.DRCR DESC, */L.LNO --DESC              
     END              
 ELSE              
 IF @VNOFROM = ''               
     BEGIN              
                /* CONDITIONS ON VDT ONLY */              
                
   SELECT   CLTCODE = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24               
                     THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                      ELSE L.CLTCODE END ),0),               
     ACNAME= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24               
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                         ELSE L.ACNAME END ),0),                
     ISNULL(L.VAMT,0) VAMT, L.DRCR, L.VTYP,L.VNO, L.LNO , L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,              
     NARR = ISNULL(L.NARRATION,'') ,              
 /*CNAR = ISNULL((SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = 0 AND L3.BOOKTYPE = L.BOOKTYPE),'') , */              
   CNAR = ISNULL(L.NARRATION,'') ,              
   CLTCODE2 = CLTCODE, ACNAME2 = ACNAME              
    FROM LEDGER L               
    WHERE   L.VTYP = @VTYP AND L.BOOKTYPE >= @BOOKTYPEFROM AND L.BOOKTYPE <= @BOOKTYPETO AND VDT >= @STARTDATE + ' 00:00:00'               
    AND VDT <=@ENDDATE + ' 23:59:59'              
    ORDER BY L.VDT, L.VTYP, L.BOOKTYPE, L.VNO              
     END              
   ELSE               
          /* CONDITIONS ON VDT AND VNO */              
      BEGIN               
    SELECT   CLTCODE = ISNULL((CASE WHEN  L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24               
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                     ELSE L.CLTCODE END ),0),               
     ACNAME= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 22 OR L.VTYP = 23 OR L.VTYP = 24               
                        THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                       ELSE L.ACNAME END ),0),                
   ISNULL(L.VAMT,0) VAMT, L.DRCR, L.VTYP,L.VNO, L.LNO , L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,              
     NARR = ISNULL(L.NARRATION,'') ,              
     /*CNAR = ISNULL((SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = 0 AND L3.BOOKTYPE = L.BOOKTYPE),'') ,*/              
   CNAR = ISNULL(L.NARRATION,'') ,              
   CLTCODE2 = CLTCODE, ACNAME2 = ACNAME              
     FROM LEDGER L               
    WHERE  L.VTYP = @VTYP AND L.BOOKTYPE >= @BOOKTYPEFROM AND L.BOOKTYPE <= @BOOKTYPETO               
    AND L.VNO >= @VNOFROM  AND L.VNO <= @VNOTO               
/* FOLL CONDITION ADDED BY KALPANA ON 19/09/2002 */              
  AND VDT >= (CASE WHEN @STARTDATE <> ''  THEN @STARTDATE  + ' 00:00:00'              
    ELSE 'JAN  1 1900' + ' 00:00:00'              
    END)               
  AND VDT <= (CASE WHEN @ENDDATE <> ''  THEN @ENDDATE + ' 23:59:59'              
    ELSE GETDATE()              
    END)               
    ORDER BY L.VDT, L.VTYP, L.BOOKTYPE, L.VNO, /*L.DRCR DESC, */L.LNO --DESC              
      END                
END              
            
ELSE IF @FLAG = 2              
BEGIN              
 IF @STARTDATE = ''               
  BEGIN              
  /* CONDITIONS OF VNO ONLY */              
  SELECT   CLTCODE = ISNULL((CASE WHEN A.ACCAT = 14  THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
          ELSE L.CLTCODE END ),0),              
     ACNAME = ISNULL((CASE WHEN A.ACCAT = 14   THEN (SELECT ACMAST.ACNAME FROM MARGINLEDGER M ,ACMAST WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND M.PARTY_CODE = ACMAST.CLTCODE)               
          ELSE L.ACNAME END ),0),              
     L.VAMT,L.DRCR,L.VTYP,L.VNO,L.LNO,L.BOOKTYPE,VDT = CONVERT(VARCHAR,L.VDT,103),EDT = CONVERT(VARCHAR,L.EDT,103),              
     NARR = ISNULL(L.NARRATION,'') ,              
     /* CNAR = ISNULL((SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = 0 AND L3.BOOKTYPE = L.BOOKTYPE),'') ,*/              
                        CNAR = ISNULL(L.NARRATION,'') ,              
   CLTCODE2 = L.CLTCODE, ACNAME2 = L.ACNAME              
    FROM LEDGER L, ACMAST A              
    WHERE L.CLTCODE = A.CLTCODE AND L.VTYP = 24  AND L.BOOKTYPE >= @BOOKTYPEFROM AND L.BOOKTYPE <= @BOOKTYPETO               
    AND L.VNO >= @VNOFROM  AND L.VNO <= @VNOTO               
    ORDER BY L.VDT, L.VTYP, L.BOOKTYPE, L.VNO, /*L.DRCR DESC, */L.LNO --DESC              
  END               
    ELSE              
 IF @VNOFROM = ''               
     BEGIN              
                /* CONDITIONS ON VDT ONLY */                
    SELECT   CLTCODE = ISNULL((CASE WHEN A.ACCAT = 14 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                    ELSE L.CLTCODE END ),0),              
     ACNAME = ISNULL((CASE WHEN A.ACCAT = 14  THEN (SELECT ACMAST.ACNAME FROM MARGINLEDGER M ,ACMAST WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND M.PARTY_CODE = ACMAST.CLTCODE)               
           ELSE L.ACNAME END ),0),              
    L.VAMT,L.DRCR,L.VTYP,L.VNO,L.LNO,L.BOOKTYPE,VDT = CONVERT(VARCHAR,L.VDT,103),EDT = CONVERT(VARCHAR,L.EDT,103),              
    NARR = ISNULL(L.NARRATION,'') ,              
    /*CNAR = ISNULL((SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = 0 AND L3.BOOKTYPE = L.BOOKTYPE),'') ,*/              
  CNAR = ISNULL(L.NARRATION,'') ,              
  CLTCODE2 = L.CLTCODE, ACNAME2 = L.ACNAME              
    FROM LEDGER L, ACMAST A              
    WHERE L.CLTCODE = A.CLTCODE AND L.VTYP = 24  AND L.BOOKTYPE >= @BOOKTYPEFROM AND L.BOOKTYPE <= @BOOKTYPETO AND VDT >= @STARTDATE + ' 00:00:00'               
    AND VDT <=@ENDDATE + ' 23:59:59'              
    ORDER BY L.VDT, L.VTYP, L.BOOKTYPE, L.VNO, L.LNO              
              
                  
  END               
  ELSE               
          /* CONDITIONS ON VDT AND VNO */              
  BEGIN              
    SELECT   CLTCODE = ISNULL((CASE WHEN A.ACCAT = 14  THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
          ELSE L.CLTCODE END ),0),              
     ACNAME = ISNULL((CASE WHEN A.ACCAT = 14   THEN (SELECT ACMAST.ACNAME FROM MARGINLEDGER M ,ACMAST WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND M.PARTY_CODE = ACMAST.CLTCODE)               
          ELSE L.ACNAME END ),0),              
     L.VAMT,L.DRCR,L.VTYP,L.VNO,L.LNO,L.BOOKTYPE,VDT = CONVERT(VARCHAR,L.VDT,103),EDT = CONVERT(VARCHAR,L.EDT,103),              
     NARR = ISNULL(L.NARRATION,'') ,              
     /*CNAR = ISNULL((SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = 0 AND L3.BOOKTYPE = L.BOOKTYPE),'') ,*/              
   CNAR = ISNULL(L.NARRATION,'') ,              
   CLTCODE2 = L.CLTCODE, ACNAME2 = L.ACNAME         
    FROM LEDGER L, ACMAST A              
    WHERE L.CLTCODE = A.CLTCODE AND L.VTYP = 24  AND L.BOOKTYPE >= @BOOKTYPEFROM AND L.BOOKTYPE <= @BOOKTYPETO               
    AND L.VNO >= @VNOFROM  AND L.VNO <= @VNOTO               
/* FOLL CONDITION ADDED BY KALPANA ON 19/09/2002 */              
  AND VDT >= (CASE WHEN @STARTDATE <> ''  THEN @STARTDATE  + ' 00:00:00'              
    ELSE 'JAN  1 1900' + ' 00:00:00'              
    END)              
  AND VDT <= (CASE WHEN @ENDDATE <> ''  THEN @ENDDATE + ' 23:59:59'              
    ELSE GETDATE()              
    END)               
    ORDER BY L.VDT, L.VTYP, L.BOOKTYPE, L.VNO, /*L.DRCR DESC, */L.LNO              
  END               
              
END              
ELSE IF @FLAG = 3              
BEGIN              
   IF @STARTDATE = ''               
      BEGIN              
/* CONDITIONS OF VNO ONLY */              
   SELECT   CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24              
                    THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                     ELSE L.CLTCODE END ),0),               
     ACNAME= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24               
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                        ELSE L.ACNAME END ),0),                
     ISNULL(L.VAMT,0) VAMT, L.DRCR, L.VTYP,L.VNO, L.LNO , L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,              
     BANK = ISNULL(BNKNAME,''), BRANCH = ISNULL(BRNNAME,'') , ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO, DDDT  =  CONVERT(VARCHAR,DDDT,103)  ,              
     NARR = ISNULL(L.NARRATION,'') ,              
     /*CNAR = ISNULL((SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = 0 AND L3.BOOKTYPE = L.BOOKTYPE),'') ,*/              
   CNAR = ISNULL(L.NARRATION,'') ,              
   CLTCODE2 = CLTCODE, ACNAME2 = ACNAME              
    FROM LEDGER L ,LEDGER1 L1              
    WHERE L1.VTYP = L.VTYP AND L1.VNO = L.VNO AND L1.BOOKTYPE = L.BOOKTYPE AND L.LNO = L1.LNO              
    AND L.VTYP = @VTYP AND L.BOOKTYPE >= @BOOKTYPEFROM AND L.BOOKTYPE <= @BOOKTYPETO               
    AND L.VNO >= @VNOFROM  AND L.VNO <= @VNOTO               
  ORDER BY L.VDT, L.VTYP, L.BOOKTYPE, L.VNO, /*L.DRCR DESC, */L.LNO --DESC              
      END              
   ELSE              
   IF @VNOFROM = ''               
      BEGIN              
         /* CONDITIONS ON VDT ONLY */              
  SELECT   CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24                
               THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                    ELSE L.CLTCODE END ),0),               
    ACNAME= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24               
                      THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                       ELSE L.ACNAME END ),0),                
    ISNULL(L.VAMT,0) VAMT, L.DRCR, L.VTYP,L.VNO, L.LNO , L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,              
    BANK = ISNULL(BNKNAME,''), BRANCH = ISNULL(BRNNAME,'') , ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO, DDDT  =  CONVERT(VARCHAR,DDDT,103)  ,              
    NARR = ISNULL(L.NARRATION,'') ,              
     /*CNAR = ISNULL((SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = 0 AND L3.BOOKTYPE = L.BOOKTYPE),''), */              
  CNAR = ISNULL(L.NARRATION,'') ,              
  CLTCODE2 = CLTCODE, ACNAME2 = ACNAME              
    FROM LEDGER L ,LEDGER1 L1             
   WHERE   L.VTYP = @VTYP AND L.BOOKTYPE >= @BOOKTYPEFROM AND L.BOOKTYPE <= @BOOKTYPETO AND VDT >= @STARTDATE + ' 00:00:00'              
   AND L1.VTYP = L.VTYP AND L1.VNO = L.VNO AND L1.BOOKTYPE = L.BOOKTYPE  AND L.LNO = L1.LNO              
    AND VDT <=@ENDDATE + ' 23:59:59'              
    ORDER BY L.VDT, L.VTYP, L.BOOKTYPE, L.VNO, L.LNO              
              
      END              
   ELSE              
      BEGIN              
         /* CONDITIONS ON VDT AND VNO */              
   SELECT   CLTCODE = ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20  OR L.VTYP = 24               
                 THEN (SELECT PARTY_CODE FROM MARGINLEDGER M WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND BOOKTYPE = L.BOOKTYPE)               
                     ELSE L.CLTCODE END ),0),               
     ACNAME= ISNULL((CASE WHEN L.VTYP = 19 OR L.VTYP = 20 OR L.VTYP = 24               
                       THEN (SELECT ACNAME FROM MARGINLEDGER M , ACMAST A WHERE VTYP = L.VTYP AND M.VNO = L.VNO AND LNO = L.LNO AND M.BOOKTYPE = L.BOOKTYPE AND PARTY_CODE = CLTCODE)               
                        ELSE L.ACNAME END ),0),                
 ISNULL(L.VAMT,0) VAMT, L.DRCR, L.VTYP,L.VNO, L.LNO , L.BOOKTYPE, CONVERT(VARCHAR,L.VDT,103) VDT, CONVERT(VARCHAR,L.EDT,103) EDT,              
     BANK = ISNULL(BNKNAME,''), BRANCH = ISNULL(BRNNAME,'') , ISNULL(DD,'') DD  ,ISNULL(DDNO,'') DDNO, DDDT  =  CONVERT(VARCHAR,DDDT,103)  ,              
     NARR = ISNULL(L.NARRATION,'') ,              
     /*CNAR = ISNULL((SELECT NARR FROM LEDGER3 L3 WHERE L3.VTYP = L.VTYP AND L3.VNO = L.VNO AND L3.NARATNO = 0 AND L3.BOOKTYPE = L.BOOKTYPE),'') ,*/              
   CNAR = ISNULL(L.NARRATION,'') ,              
   CLTCODE2 = CLTCODE, ACNAME2 = ACNAME              
  FROM LEDGER L ,LEDGER1 L1              
    WHERE L1.VTYP = L.VTYP AND L1.VNO = L.VNO AND L1.BOOKTYPE = L.BOOKTYPE   AND L.LNO = L1.LNO              
    AND L.VTYP = @VTYP AND L.BOOKTYPE >= @BOOKTYPEFROM AND L.BOOKTYPE <= @BOOKTYPETO               
    AND L.VNO >= @VNOFROM  AND L.VNO <= @VNOTO               
/* FOLL CONDITION ADDED BY KALPANA ON 19/09/2002 */              
  AND VDT >= (CASE WHEN @STARTDATE <> ''  THEN @STARTDATE  + ' 00:00:00'              
    ELSE 'JAN  1 1900' + ' 00:00:00'              
    END)               
  AND VDT <= (CASE WHEN @ENDDATE <> ''  THEN @ENDDATE + ' 23:59:59'              
    ELSE GETDATE()              
    END)               
    ORDER BY L.VDT, L.VTYP, L.BOOKTYPE, L.VNO, /*L.DRCR DESC, */L.LNO --DESC              
      END             
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Vw
-- --------------------------------------------------
    
CREATE PROC Vw @VwName VARCHAR(25)AS                   
Select * from sysobjects where name Like '%' + @VwName + '%' and xtype='V' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND
-- --------------------------------------------------
    
 /*        
SELECT * FROM LEDGER WHERE VNO  ='200800000001' AND VTYP = 18        
EXEC YEAREND 'APR  1 2007', 'MAR 31 2008', 18, '200804010001', '01', 'APR  1 2008', 'OPENING BALANCE'      
*/        
CREATE PROC YEAREND        
 @SDTCUR VARCHAR(11),        
 @LDTCUR VARCHAR(11),        
 @VTYP SMALLINT,        
 @VNO VARCHAR(12),        
 @BOOKTYPE VARCHAR(2),        
 @VDT VARCHAR(11),        
 @MSG1 VARCHAR(234),      
 @PNL_CODE VARCHAR(10) = '99999'      
AS        
/*        
 EXEC YEAREND 'APR  1 2006', 'MAR 31 2007', 18, '200700000001', '01', 'APR  1 2007', 'TEST OPENING ENTRY'        
 EXEC YEAREND 'Apr  1 2006','Mar 31 2007', 18, '200700000001', '01', 'Apr  1 2007', 'Opening balance'        
 SELECT COUNT(1) FROM LEDGER WHERE VTYP = 18 AND VDT >= 'APR  1 2007'        
         
*/        
      
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED        
        
 DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE        
 DELETE FROM LEDGER2 WHERE VNO = @VNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE        
 DELETE FROM LEDGER3 WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE        
 DELETE FROM MARGINLEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE        
        
 CREATE TABLE #VDT        
 (        
  CLTCODE VARCHAR(10),        
  ACNAME VARCHAR(100),        
  DRCR VARCHAR(1),        
  BALANCE MONEY        
 )        
        
 INSERT INTO #VDT        
  (CLTCODE, ACNAME, DRCR, BALANCE)        
 SELECT        
  A.CLTCODE,        
  ACNAME = ISNULL(A.LONGNAME, ''),        
  DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) >= 0 THEN 'D' ELSE 'C' END,        
  VAMT = ABS(SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END))        
 FROM        
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE        
 WHERE        
  L.VDT BETWEEN @SDTCUR  AND @LDTCUR + ' 23:59:59'        
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')        
  AND L.CLTCODE <> @PNL_CODE        
 GROUP BY        
  A.CLTCODE,        
  A.LONGNAME        
        
        
 CREATE TABLE #EDT        
 (        
  CLTCODE VARCHAR(10),        
  BALANCE MONEY        
 )        
        
 INSERT INTO #EDT        
  (CLTCODE, BALANCE)        
 SELECT        
  A.CLTCODE,        
  BALANCE = SUM(CASE WHEN L.VTYP = 18 THEN BALAMT ELSE CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END END)        
 FROM        
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE        
 WHERE        
  L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'        
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')        
  AND L.CLTCODE <> @PNL_CODE        
 GROUP BY        
  A.CLTCODE        
        
        
 CREATE TABLE #LEDGER        
 (        
  VTYP SMALLINT,        
  VNO VARCHAR(12),        
  EDT DATETIME,        
  LNO INT IDENTITY(1,1),        
  ACNAME VARCHAR(100),        
  DRCR CHAR(1),        
  VAMT MONEY,        
  VDT DATETIME,        
  VNO1 VARCHAR(12),        
  REFNO CHAR(12),        
  BALAMT MONEY,        
  NODAYS INT,        
  CDT DATETIME,        
  CLTCODE VARCHAR(10),        
  BOOKTYPE VARCHAR(2),        
  ENTEREDBY VARCHAR(25),        
  PDT DATETIME,        
  CHECKEDBY VARCHAR(25),        
  ACTNODAYS INT,        
  NARRATION VARCHAR(234)        
 )        
        
INSERT INTO #LEDGER        
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)        
SELECT        
 VTYP = @VTYP,        
 VNO = @VNO,        
 EDT = @VDT,        
 ACNAME = V.ACNAME,        
 DRCR = V.DRCR,        
 VAMT = V.BALANCE,        
 VDT = @VDT,        
 VNO1 = @VNO,        
 REFNO = '',        
 BALAMT = ISNULL(E.BALANCE, 0),        
 NODAYS = 0,        
 CDT = GETDATE(),        
 V.CLTCODE,        
 BOOKTYPE = @BOOKTYPE,        
 ENTEREDBY = 'SYSTEM',        
 PDT = GETDATE(),        
 CHECKEDBY = 'SYSTEM',        
 ACTNODAYS = 0,        
 NARRATION = @MSG1        
FROM        
 #VDT V LEFT OUTER JOIN #EDT E ON V.CLTCODE = E.CLTCODE        
        
        
CREATE TABLE #PANDL        
(        
 VDTBAL MONEY,        
 EDTBAL MONEY        
)        
INSERT INTO #PANDL SELECT VDTBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), EDTBAL = (SUM(BALAMT)) FROM #LEDGER        
        
INSERT INTO #LEDGER        
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)        
SELECT        
 VTYP = @VTYP,        
 VNO = @VNO,        
 EDT = @VDT,        
 ACNAME = ISNULL(A.ACNAME, 'PROFIT AND LOSS A/C'),        
 DRCR = CASE WHEN VDTBAL < 0 THEN 'D' ELSE 'C' END,        
 VAMT = ABS(VDTBAL),        
 VDT = @VDT,        
 VNO1 = @VNO,        
 REFNO = '',        
 BALAMT = EDTBAL,        
 NODAYS = 0,        
 CDT = GETDATE(),        
 A.CLTCODE,        
 BOOKTYPE = @BOOKTYPE,        
 ENTEREDBY = 'SYSTEM',        
 PDT = GETDATE(),        
 CHECKEDBY = 'SYSTEM',        
 ACTNODAYS = 0,        
 NARRATION = @MSG1        
FROM        
 #PANDL,        
 ACMAST A        
WHERE        
 A.CLTCODE = @PNL_CODE        
        
        
        
DROP TABLE #VDT        
DROP TABLE #EDT        
DROP TABLE #PANDL        
        
CREATE TABLE #MVDT        
(        
 PARTY_CODE VARCHAR(10),        
 MCLTCODE VARCHAR(10),        
 EXCHANGE VARCHAR(3),        
 SEGMENT VARCHAR(20),        
 DRCR VARCHAR(1),        
 AMOUNT MONEY        
)        
        
INSERT INTO #MVDT        
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, DRCR, AMOUNT)        
SELECT        
 PARTY_CODE,        
 MCLTCODE,        
 EXCHANGE,        
 SEGMENT,        
 DRCR = CASE WHEN SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) >= 0 THEN 'D' ELSE 'C' END,        
 AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)        
FROM        
 MARGINLEDGER        
WHERE        
 VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'        
GROUP BY        
 PARTY_CODE,        
 MCLTCODE,        
 EXCHANGE,        
 SEGMENT        
        
CREATE TABLE #MEDT        
(        
 PARTY_CODE VARCHAR(10),        
 MCLTCODE VARCHAR(10),        
 EXCHANGE VARCHAR(3),        
 SEGMENT VARCHAR(20),        
 AMOUNT MONEY        
)        
        
INSERT INTO #MEDT        
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, AMOUNT)        
SELECT        
 M.PARTY_CODE,        
 M.MCLTCODE,        
 M.EXCHANGE,        
 M.SEGMENT,        
 AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN M.AMOUNT ELSE -M.AMOUNT END)        
FROM        
 MARGINLEDGER M,        
 LEDGER L        
WHERE        
 M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO        
 AND L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'        
GROUP BY        
 M.PARTY_CODE,        
 M.MCLTCODE,        
 M.EXCHANGE,        
 M.SEGMENT        
        
CREATE TABLE #MARGINLEDGER        
(        
 VTYP SMALLINT,        
 VNO VARCHAR(12),        
 LNO INT,        
 DRCR VARCHAR(1),        
 VDT DATETIME,        
 AMOUNT MONEY,        
 PARTY_CODE VARCHAR(10),        
 EXCHANGE VARCHAR(3),        
 SEGMENT VARCHAR(20),        
 SETT_NO MONEY,        
 SETT_TYPE VARCHAR(3),        
 BOOKTYPE VARCHAR(2),        
 MCLTCODE VARCHAR(10)        
)        
        
INSERT INTO #MARGINLEDGER        
 (VTYP, VNO, DRCR, VDT, AMOUNT, PARTY_CODE, EXCHANGE, SEGMENT, SETT_NO, SETT_TYPE, BOOKTYPE, MCLTCODE)        
SELECT        
 VTYP = @VTYP,        
 VNO = @VNO,        
 DRCR = V.DRCR,        
 VDT = @VDT,        
 AMOUNT = ABS(V.AMOUNT),        
 PARTY_CODE = V.PARTY_CODE,        
 EXCHANGE = V.EXCHANGE,        
 SEGMENT = V.SEGMENT,        
 SETT_NO = ISNULL(E.AMOUNT, 0),        
 SETT_TYPE = '',        
 BOOKTYPE = @BOOKTYPE,        
 MCLTCODE = V.MCLTCODE        
FROM        
 #MVDT V LEFT OUTER JOIN #MEDT E ON        
  V.PARTY_CODE = E.PARTY_CODE        
  AND V.MCLTCODE = E.MCLTCODE        
  AND V.EXCHANGE = E.EXCHANGE        
  AND V.SEGMENT = E.SEGMENT        
        
UPDATE        
 H        
SET        
 LNO = L.LNO        
FROM        
 #MARGINLEDGER H,        
 #LEDGER L        
WHERE        
 H.MCLTCODE = L.CLTCODE        
        
SELECT MCLTCODE, BALANCE = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) INTO #SUMMARGIN FROM #MARGINLEDGER GROUP BY MCLTCODE        
SELECT L.CLTCODE, BALANCE = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) INTO #SUMLEDGER FROM #LEDGER L, #SUMMARGIN M        
WHERE L.CLTCODE = M.MCLTCODE  GROUP BY L.CLTCODE        
DECLARE @ISDIFF INT        
SET @ISDIFF = 0        
SELECT        
 @ISDIFF = ISNULL(COUNT(1), 0) FROM #SUMMARGIN M, #SUMLEDGER L        
WHERE        
 M.MCLTCODE = L.CLTCODE        
 AND M.BALANCE <> L.BALANCE        
        
/*IF @ISDIFF <> 0        
 BEGIN        
  DROP TABLE #LEDGER        
  DROP TABLE #MARGINLEDGER        
  SELECT ERRNO = 1, ERRMSG = 'MARGIN BALANCE DOES NOT MATCH.'        
 END        
ELSE        
 BEGIN  */      
  INSERT INTO LEDGER SELECT * FROM #LEDGER        
  INSERT INTO LEDGER3 SELECT LNO, NARRATION, REFNO = '', VTYP, VNO, BOOKTYPE FROM #LEDGER        
  INSERT INTO MARGINLEDGER SELECT * FROM #MARGINLEDGER        
  EXEC BR_YEAREND  @SDTCUR, @LDTCUR, @VTYP, @VNO, @BOOKTYPE, @VDT, @PNL_CODE        
  DROP TABLE #LEDGER        
  DROP TABLE #MARGINLEDGER        
  SELECT ERRNO = 0, ERRMSG = 'OPENING BALANCES CALCULATED SUCCESSFULLY'        
-- END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND_suresh
-- --------------------------------------------------
        
        
          
 /*              
SELECT * FROM LEDGER WHERE VNO  ='200800000001' AND VTYP = 18              
EXEC YEAREND 'APR  1 2007', 'MAR 31 2008', 18, '200804010001', '01', 'APR  1 2008', 'OPENING BALANCE'            
*/              
CREATE PROC YEAREND_suresh              
 @SDTCUR VARCHAR(11),              
 @LDTCUR VARCHAR(11),              
 @VTYP SMALLINT,              
 @VNO VARCHAR(12),              
 @BOOKTYPE VARCHAR(2),              
 @VDT VARCHAR(11),              
 @MSG1 VARCHAR(234),            
 @PNL_CODE VARCHAR(10) = '99999'            
AS              
/*              
 EXEC YEAREND 'APR  1 2006', 'MAR 31 2007', 18, '200700000001', '01', 'APR  1 2007', 'TEST OPENING ENTRY'              
 EXEC YEAREND 'Apr  1 2006','Mar 31 2007', 18, '200700000001', '01', 'Apr  1 2007', 'Opening balance'              
 SELECT COUNT(1) FROM LEDGER WHERE VTYP = 18 AND VDT >= 'APR  1 2007'              
               
*/              
            
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED              
              
 DELETE FROM LEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE              
 DELETE FROM LEDGER2 WHERE VNO = @VNO AND VTYPE = @VTYP AND BOOKTYPE = @BOOKTYPE              
 DELETE FROM LEDGER3 WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE              
 DELETE FROM MARGINLEDGER WHERE VNO = @VNO AND VTYP = @VTYP AND BOOKTYPE = @BOOKTYPE              
              
 CREATE TABLE #VDT              
 (              
  CLTCODE VARCHAR(10),              
  ACNAME VARCHAR(100),              
  DRCR VARCHAR(1),              
  BALANCE MONEY              
 )              
              
 INSERT INTO #VDT              
  (CLTCODE, ACNAME, DRCR, BALANCE)              
 SELECT              
  A.CLTCODE,              
  ACNAME = ISNULL(A.LONGNAME, ''),              
  DRCR = CASE WHEN SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) >= 0 THEN 'D' ELSE 'C' END,              
  VAMT = ABS(SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END))              
 FROM              
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE              
 WHERE              
  L.VDT BETWEEN @SDTCUR  AND @LDTCUR + ' 23:59:59'              
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')              
  AND L.CLTCODE <> @PNL_CODE              
 GROUP BY              
  A.CLTCODE,              
  A.LONGNAME              
              
              
 CREATE TABLE #EDT              
 (              
  CLTCODE VARCHAR(10),              
  BALANCE MONEY              
 )              
              
 INSERT INTO #EDT              
  (CLTCODE, BALANCE)              
 SELECT              
  A.CLTCODE,              
  BALANCE = SUM(CASE WHEN L.VTYP = 18 THEN BALAMT ELSE CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END END)              
 FROM              
  LEDGER L LEFT OUTER JOIN ACMAST A ON L.CLTCODE = A.CLTCODE              
 WHERE              
  L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'              
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')              
  AND L.CLTCODE <> @PNL_CODE              
 GROUP BY              
  A.CLTCODE              
              
              
 CREATE TABLE #LEDGER              
 (              
  VTYP SMALLINT,              
  VNO VARCHAR(12),              
  EDT DATETIME,              
  LNO INT IDENTITY(1,1),              
  ACNAME VARCHAR(100),              
  DRCR CHAR(1),              
  VAMT MONEY,              
  VDT DATETIME,              
  VNO1 VARCHAR(12),              
  REFNO CHAR(12),              
  BALAMT MONEY,              
  NODAYS INT,              
  CDT DATETIME,              
  CLTCODE VARCHAR(10),              
  BOOKTYPE VARCHAR(2),              
  ENTEREDBY VARCHAR(25),              
  PDT DATETIME,              
  CHECKEDBY VARCHAR(25),              
  ACTNODAYS INT,              
  NARRATION VARCHAR(234)              
 )              
              
INSERT INTO #LEDGER              
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)              
SELECT              
 VTYP = @VTYP,              
 VNO = @VNO,              
 EDT = @VDT,              
 ACNAME = V.ACNAME,              
 DRCR = V.DRCR,              
 VAMT = V.BALANCE,              
 VDT = @VDT,              
 VNO1 = @VNO,              
 REFNO = '',              
 BALAMT = ISNULL(E.BALANCE, 0),              
 NODAYS = 0,              
 CDT = GETDATE(),              
 V.CLTCODE,              
 BOOKTYPE = @BOOKTYPE,         
 ENTEREDBY = 'SYSTEM',              
 PDT = GETDATE(),              
 CHECKEDBY = 'SYSTEM',              
 ACTNODAYS = 0,              
 NARRATION = @MSG1              
FROM              
 #VDT V LEFT OUTER JOIN #EDT E ON V.CLTCODE = E.CLTCODE              
              
              
CREATE TABLE #PANDL              
(              
 VDTBAL MONEY,              
 EDTBAL MONEY              
)              
INSERT INTO #PANDL SELECT VDTBAL = SUM(CASE WHEN DRCR = 'D' THEN VAMT ELSE -VAMT END), EDTBAL = (SUM(BALAMT)) FROM #LEDGER              
              
INSERT INTO #LEDGER              
 (VTYP, VNO, EDT, ACNAME, DRCR, VAMT, VDT, VNO1, REFNO, BALAMT, NODAYS, CDT, CLTCODE, BOOKTYPE, ENTEREDBY, PDT, CHECKEDBY, ACTNODAYS, NARRATION)              
SELECT              
 VTYP = @VTYP,              
 VNO = @VNO,              
 EDT = @VDT,              
 ACNAME = ISNULL(A.ACNAME, 'PROFIT AND LOSS A/C'),              
 DRCR = CASE WHEN VDTBAL < 0 THEN 'D' ELSE 'C' END,              
 VAMT = ABS(VDTBAL),              
 VDT = @VDT,              
 VNO1 = @VNO,              
 REFNO = '',              
 BALAMT = EDTBAL,              
 NODAYS = 0,              
 CDT = GETDATE(),              
 A.CLTCODE,              
 BOOKTYPE = @BOOKTYPE,              
 ENTEREDBY = 'SYSTEM',              
 PDT = GETDATE(),              
 CHECKEDBY = 'SYSTEM',              
 ACTNODAYS = 0,              
 NARRATION = @MSG1              
FROM              
 #PANDL,              
 ACMAST A              
WHERE              
 A.CLTCODE = @PNL_CODE              
              
              
              
DROP TABLE #VDT              
DROP TABLE #EDT              
DROP TABLE #PANDL              
              
CREATE TABLE #MVDT              
(              
 PARTY_CODE VARCHAR(10),              
 MCLTCODE VARCHAR(10),              
 EXCHANGE VARCHAR(3),              
 SEGMENT VARCHAR(20),              
 DRCR VARCHAR(1),              
 AMOUNT MONEY              
)              
              
INSERT INTO #MVDT              
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, DRCR, AMOUNT)              
SELECT              
 PARTY_CODE,              
 MCLTCODE,              
 EXCHANGE,              
 SEGMENT,              
 DRCR = CASE WHEN SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) >= 0 THEN 'D' ELSE 'C' END,              
 AMOUNT = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)              
FROM              
 MARGINLEDGER              
WHERE              
 VDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'              
GROUP BY              
 PARTY_CODE,              
 MCLTCODE,              
 EXCHANGE,              
 SEGMENT              
              
CREATE TABLE #MEDT              
(              
 PARTY_CODE VARCHAR(10),              
 MCLTCODE VARCHAR(10),              
 EXCHANGE VARCHAR(3),              
 SEGMENT VARCHAR(20),              
 AMOUNT MONEY              
)              
              
INSERT INTO #MEDT              
 (PARTY_CODE, MCLTCODE, EXCHANGE, SEGMENT, AMOUNT)              
SELECT              
 M.PARTY_CODE,              
 M.MCLTCODE,              
 M.EXCHANGE,              
 M.SEGMENT,              
 AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN M.AMOUNT ELSE -M.AMOUNT END)              
FROM              
 MARGINLEDGER M,              
 LEDGER L              
WHERE              
 M.VTYP = L.VTYP AND M.BOOKTYPE = L.BOOKTYPE AND M.VNO = L.VNO AND M.LNO = L.LNO              
 AND L.EDT BETWEEN @SDTCUR AND @LDTCUR + ' 23:59:59'              
GROUP BY              
 M.PARTY_CODE,              
 M.MCLTCODE,              
 M.EXCHANGE,              
 M.SEGMENT   
              
CREATE TABLE #MARGINLEDGER              
(              
 VTYP SMALLINT,              
 VNO VARCHAR(12),              
 LNO INT,              
 DRCR VARCHAR(1),              
 VDT DATETIME,              
 AMOUNT MONEY,              
 PARTY_CODE VARCHAR(10),              
 EXCHANGE VARCHAR(3),              
 SEGMENT VARCHAR(20),              
 SETT_NO MONEY,              
 SETT_TYPE VARCHAR(3),              
 BOOKTYPE VARCHAR(2),              
 MCLTCODE VARCHAR(10)              
)              
              
INSERT INTO #MARGINLEDGER              
 (VTYP, VNO, DRCR, VDT, AMOUNT, PARTY_CODE, EXCHANGE, SEGMENT, SETT_NO, SETT_TYPE, BOOKTYPE, MCLTCODE)              
SELECT              
 VTYP = @VTYP,              
 VNO = @VNO,              
 DRCR = V.DRCR,              
 VDT = @VDT,              
 AMOUNT = ABS(V.AMOUNT),              
 PARTY_CODE = V.PARTY_CODE,              
 EXCHANGE = V.EXCHANGE,              
 SEGMENT = V.SEGMENT,              
 SETT_NO = ISNULL(E.AMOUNT, 0),              
 SETT_TYPE = '',              
 BOOKTYPE = @BOOKTYPE,              
 MCLTCODE = V.MCLTCODE              
FROM              
 #MVDT V LEFT OUTER JOIN #MEDT E ON              
  V.PARTY_CODE = E.PARTY_CODE              
  AND V.MCLTCODE = E.MCLTCODE              
  AND V.EXCHANGE = E.EXCHANGE              
  AND V.SEGMENT = E.SEGMENT              
              
UPDATE              
 H              
SET              
 LNO = L.LNO              
FROM              
 #MARGINLEDGER H,              
 #LEDGER L              
WHERE              
 H.MCLTCODE = L.CLTCODE              
              
SELECT MCLTCODE, BALANCE = SUM(CASE WHEN DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END) INTO #SUMMARGIN FROM #MARGINLEDGER GROUP BY MCLTCODE              
SELECT L.CLTCODE, BALANCE = SUM(CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE -L.VAMT END) INTO #SUMLEDGER FROM #LEDGER L, #SUMMARGIN M              
WHERE L.CLTCODE = M.MCLTCODE  GROUP BY L.CLTCODE              
DECLARE @ISDIFF INT              
SET @ISDIFF = 0              
SELECT              
 @ISDIFF = ISNULL(COUNT(1), 0) FROM #SUMMARGIN M, #SUMLEDGER L              
WHERE              
 M.MCLTCODE = L.CLTCODE              
 AND M.BALANCE <> L.BALANCE              
              
/*IF @ISDIFF <> 0              
 BEGIN              
  DROP TABLE #LEDGER              
  DROP TABLE #MARGINLEDGER              
  SELECT ERRNO = 1, ERRMSG = 'MARGIN BALANCE DOES NOT MATCH.'              
 END              
ELSE              
 BEGIN  */            
  INSERT INTO LEDGER SELECT * FROM #LEDGER              
  INSERT INTO LEDGER3 SELECT LNO, NARRATION, REFNO = '', VTYP, VNO, BOOKTYPE FROM #LEDGER              
  INSERT INTO MARGINLEDGER SELECT * FROM #MARGINLEDGER              
  --EXEC BR_YEAREND  @SDTCUR, @LDTCUR, @VTYP, @VNO, @BOOKTYPE, @VDT, @PNL_CODE              
  DROP TABLE #LEDGER              
  DROP TABLE #MARGINLEDGER              
  SELECT ERRNO = 0, ERRMSG = 'OPENING BALANCES CALCULATED SUCCESSFULLY'              
-- END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND_VARIFICATION
-- --------------------------------------------------
 CREATE  PROC YEAREND_VARIFICATION  
 @MSG1 VARCHAR(234)='OPENING BALANCE',    
 @PNL_CODE VARCHAR(10) = '999999'     
AS    
  
DECLARE   
@@VNO  VARCHAR(12),  
@@SDTCURNEW VARCHAR(11),      
@@LDTCURNEW VARCHAR(11),  
@@SDTCUROLD VARCHAR(11),      
@@LDTCUROLD VARCHAR(11),  
@@MAXSDT  VARCHAR(11),  
@@BRFLAG INT   
  
--SELECT DISTINCT @@VNO=VNO FROM LEDGER WHERE  VDT like @VDT +'%' AND VTYP=18  
PRINT  @@VNO  
    
SELECT @@SDTCURNEW=SDTCUR,@@LDTCURNEW=LDTCUR FROM PARAMETER WHERE CURYEAR=1   
  
SELECT @@MAXSDT=MAX(SDTCUR) FROM PARAMETER WHERE CURYEAR<>1  
  
SELECT @@VNO=VNO FROM LEDGER WHERE VDT LIKE @@SDTCURNEW +'%' AND VTYP=18  
  
SELECT @@SDTCUROLD=SDTCUR ,@@LDTCUROLD=LDTCUR FROM PARAMETER WHERE SDTCUR LIKE @@MAXSDT +'%'   
  
SELECT @@BRFLAG=BRANCHFLAG FROM PARAMETER WHERE BRANCHFLAG=1  
  
  
PRINT @@SDTCURNEW  
PRINT @@MAXSDT  
PRINT @@VNO  
PRINT @@SDTCUROLD  
  
  
 SELECT 'LEDGER BALANCES MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L.CLTCODE <> @PNL_CODE    
  GROUP BY L.CLTCODE    
  UNION ALL    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L.CLTCODE <> @PNL_CODE    
  GROUP BY L.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
  
IF @@BRFLAG = 1  
PRINT 'VIN'   
BEGIN     
 SELECT 'BRANCHWISE BALANCES MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE, LEDGER L    
  WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO     
  AND VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L2.CLTCODE <> @PNL_CODE    
  GROUP BY L2.CLTCODE    
  UNION ALL    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE, LEDGER L     
  WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO     
  AND L2.VNO = @@VNO AND VTYPE = '18' AND L2.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L2.CLTCODE <> @PNL_CODE    
  GROUP BY L2.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
END  
    
 SELECT 'PROFIT AND LOSS MISMATCH', 0    
 UNION ALL    
 SELECT 'AMOUNT_MISMATCH', SUM(AMOUNT) FROM    
 (    
  SELECT AMOUNT = SUM(AMOUNT) FROM    
  (SELECT AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
   FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
   WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
   AND (A.ACTYP LIKE 'INCO%' OR A.ACTYP LIKE 'EXP%')      
   UNION ALL    
  SELECT AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
   FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
   WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
   AND L.CLTCODE = @PNL_CODE    
  ) L1    
  UNION ALL    
  SELECT AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND L.CLTCODE = @PNL_CODE    
 ) L    
  
 SELECT 'LEDGER AND LEDGER2 MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE    
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  GROUP BY L.CLTCODE    
  UNION ALL    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE    
  WHERE L2.VNO = @@VNO AND VTYPE = '18' AND L2.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  GROUP BY L2.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
    
 SELECT 'COSTCODEWISE AMOUNT MISMATCH', 0    
 UNION ALL    
 SELECT CONVERT(VARCHAR, COSTCODE), SUM(CASE DRCR WHEN 'D' THEN CAMT ELSE -CAMT END)    
 FROM LEDGER2    
 WHERE VNO = @@VNO AND VTYPE = '18' AND BOOKTYPE = '01'    
 GROUP BY CONVERT(VARCHAR, COSTCODE)    
 HAVING SUM(CASE DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) <> 0    
  
SELECT 'MARGINLEDGER AMOUNT MISMATCH', 0 ,'',0   
UNION ALL  
SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
FROM MARGINLEDGER M, LEDGER L   
WHERE M.MCLTCODE=L.CLTCODE  
AND AMOUNT<>VAMT  
AND M.VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'   
GROUP BY MCLTCODE,CLTCODE  
  
   
SELECT 'MISMATCH BETWEEN MARGINLEDGER AND LEDGER AMOUNT', 0   
UNION ALL  
 SELECT CLTCODE, SUM(AMOUNT) FROM  (  
 SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
 ,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
 FROM MARGINLEDGER M, LEDGER L   
 WHERE M.MCLTCODE=L.CLTCODE  
 AND M.VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'   
 GROUP BY MCLTCODE,CLTCODE  
UNION ALL   
 SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
 ,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
 FROM MARGINLEDGER M, LEDGER L   
 WHERE M.MCLTCODE=L.CLTCODE  
 AND M.VTYP='18' AND M.VNO LIKE @@VNO + '%'  
 GROUP BY MCLTCODE,CLTCODE  
 )M  
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.YEAREND_VARIFICATION_suresh
-- --------------------------------------------------
--exec YEAREND_VARIFICATION_suresh

create proc   YEAREND_VARIFICATION_suresh
 @MSG1 VARCHAR(234)='OPENING BALANCE',    
 @PNL_CODE VARCHAR(10) = '999999'     
AS    
  
DECLARE   
@@VNO  VARCHAR(12),  
@@SDTCURNEW VARCHAR(11),      
@@LDTCURNEW VARCHAR(11),  
@@SDTCUROLD VARCHAR(11),      
@@LDTCUROLD VARCHAR(11),  
@@MAXSDT  VARCHAR(11),  
@@BRFLAG INT   
  
--SELECT DISTINCT @@VNO=VNO FROM LEDGER WHERE  VDT like @VDT +'%' AND VTYP=18  
PRINT  @@VNO  
    
SELECT @@SDTCURNEW=SDTCUR,@@LDTCURNEW=LDTCUR FROM PARAMETER WHERE CURYEAR=1   
  
SELECT @@MAXSDT=MAX(SDTCUR) FROM PARAMETER WHERE CURYEAR<>1  
  
SELECT @@VNO=VNO FROM LEDGER WHERE VDT LIKE @@SDTCURNEW +'%' AND VTYP=18  
  
SELECT @@SDTCUROLD=SDTCUR ,@@LDTCUROLD=LDTCUR FROM PARAMETER WHERE SDTCUR LIKE @@MAXSDT +'%'   
  
SELECT @@BRFLAG=BRANCHFLAG FROM PARAMETER WHERE BRANCHFLAG=1  
  
  
PRINT @@SDTCURNEW  
PRINT @@MAXSDT  
PRINT @@VNO  
PRINT @@SDTCUROLD  
  
  
 SELECT 'LEDGER BALANCES MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L.CLTCODE <> @PNL_CODE    
  GROUP BY L.CLTCODE    
  UNION ALL    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L.CLTCODE <> @PNL_CODE    
  GROUP BY L.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
  
IF @@BRFLAG = 1  
PRINT 'VIN'   
BEGIN     
 SELECT 'BRANCHWISE BALANCES MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE L2.DRCR WHEN 'D' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE, LEDGER L    
  WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO     
  AND VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L2.CLTCODE <> @PNL_CODE    
  GROUP BY L2.CLTCODE    
  UNION ALL    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE L2.DRCR WHEN 'C' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE, LEDGER L     
  WHERE L.VNO = L2.VNO AND L.VTYP = L2.VTYPE AND L.BOOKTYPE = L2.BOOKTYPE AND L.LNO = L2.LNO     
  AND L2.VNO = @@VNO AND VTYPE = '18' AND L2.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  AND L2.CLTCODE <> @PNL_CODE    
  GROUP BY L2.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
END  
    
 SELECT 'PROFIT AND LOSS MISMATCH', 0    
 UNION ALL    
 SELECT 'AMOUNT_MISMATCH', SUM(AMOUNT) FROM    
 (    
  SELECT AMOUNT = SUM(AMOUNT) FROM    
  (SELECT AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
   FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
   WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
   AND (A.ACTYP LIKE 'INCO%' OR A.ACTYP LIKE 'EXP%')      
   UNION ALL    
  SELECT AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
   FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
   WHERE VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'    
   AND L.CLTCODE = @PNL_CODE    
  ) L1    
  UNION ALL    
  SELECT AMOUNT = SUM(CASE DRCR WHEN 'C' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE     
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND L.CLTCODE = @PNL_CODE    
 ) L    
  
 SELECT 'LEDGER AND LEDGER2 MISMATCH', 0    
 UNION ALL    
 SELECT CLTCODE, SUM(AMOUNT) FROM    
 (    
  SELECT L.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'D' THEN VAMT ELSE -VAMT END)    
  FROM LEDGER L LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L.CLTCODE    
  WHERE VNO = @@VNO AND VTYP = '18' AND L.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  GROUP BY L.CLTCODE    
  UNION ALL    
  SELECT L2.CLTCODE, AMOUNT = SUM(CASE DRCR WHEN 'C' THEN CAMT ELSE -CAMT END)    
  FROM LEDGER2 L2 LEFT OUTER JOIN ACMAST A ON A.CLTCODE = L2.CLTCODE    
  WHERE L2.VNO = @@VNO AND VTYPE = '18' AND L2.BOOKTYPE = '01'    
  AND (A.ACTYP LIKE 'ASS%' OR A.ACTYP LIKE 'LIAB%')      
  GROUP BY L2.CLTCODE    
 ) L    
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0    
    
 SELECT 'COSTCODEWISE AMOUNT MISMATCH', 0    
 UNION ALL    
 SELECT CONVERT(VARCHAR, COSTCODE), SUM(CASE DRCR WHEN 'D' THEN CAMT ELSE -CAMT END)    
 FROM LEDGER2    
 WHERE VNO = @@VNO AND VTYPE = '18' AND BOOKTYPE = '01'    
 GROUP BY CONVERT(VARCHAR, COSTCODE)    
 HAVING SUM(CASE DRCR WHEN 'D' THEN CAMT ELSE -CAMT END) <> 0    
  
SELECT 'MARGINLEDGER AMOUNT MISMATCH', 0 ,'',0   
UNION ALL  
SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
FROM MARGINLEDGER M, LEDGER L   
WHERE M.MCLTCODE=L.CLTCODE  
AND AMOUNT<>VAMT  
AND M.VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'   
GROUP BY MCLTCODE,CLTCODE  
  
   
SELECT 'MISMATCH BETWEEN MARGINLEDGER AND LEDGER AMOUNT', 0   
UNION ALL  
 SELECT CLTCODE, SUM(AMOUNT) FROM  (  
 SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
 ,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
 FROM MARGINLEDGER M, LEDGER L   
 WHERE M.MCLTCODE=L.CLTCODE  
 AND M.VDT BETWEEN @@SDTCUROLD AND @@LDTCUROLD + ' 23:59'   
 GROUP BY MCLTCODE,CLTCODE  
UNION ALL   
 SELECT MCLTCODE, AMOUNT = SUM(CASE WHEN M.DRCR = 'D' THEN AMOUNT ELSE -AMOUNT END)  
 ,CLTCODE, VAMT = SUM(CASE WHEN L.DRCR = 'D' THEN VAMT ELSE -VAMT END)  
 FROM MARGINLEDGER M, LEDGER L   
 WHERE M.MCLTCODE=L.CLTCODE  
 AND M.VTYP='18' AND M.VNO LIKE @@VNO + '%'  
 GROUP BY MCLTCODE,CLTCODE  
 )M  
 GROUP BY CLTCODE    
 HAVING SUM(AMOUNT) <> 0

GO

-- --------------------------------------------------
-- TABLE dbo.A16829_SEBI
-- --------------------------------------------------
CREATE TABLE [dbo].[A16829_SEBI]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NOT NULL,
    [edt] DATETIME NULL,
    [lno] INT NOT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NOT NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(14) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acccategory
-- --------------------------------------------------
CREATE TABLE [dbo].[acccategory]
(
    [Categoryid] VARCHAR(10) NULL,
    [Categoryname] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.accountscategory
-- --------------------------------------------------
CREATE TABLE [dbo].[accountscategory]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] VARCHAR(100) NULL,
    [Category] VARCHAR(100) NULL,
    [Intrestdr] VARCHAR(100) NULL,
    [Intrestcr] VARCHAR(100) NULL,
    [Dummy1] VARCHAR(100) NULL,
    [Dummy2] VARCHAR(100) NULL,
    [Dummy3] VARCHAR(100) NULL,
    [Dummy4] VARCHAR(100) NULL,
    [Dummy5] VARCHAR(100) NULL,
    [Dummy6] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acmast
-- --------------------------------------------------
CREATE TABLE [dbo].[acmast]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(10) NULL,
    [Branchcode] VARCHAR(10) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.acmast_details
-- --------------------------------------------------
CREATE TABLE [dbo].[acmast_details]
(
    [CLTCODE] VARCHAR(10) NULL,
    [LONGNAME] VARCHAR(100) NULL,
    [INACTIVE_FLAG] CHAR(1) NULL,
    [MAPPING_GL] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angel_BANK_Accno
-- --------------------------------------------------
CREATE TABLE [dbo].[angel_BANK_Accno]
(
    [accno] VARCHAR(25) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Angel_client_deposit_recno
-- --------------------------------------------------
CREATE TABLE [dbo].[Angel_client_deposit_recno]
(
    [accno] VARCHAR(10) NOT NULL,
    [vtyp] SMALLINT NOT NULL,
    [booktype] CHAR(2) NULL,
    [vno] VARCHAR(12) NULL,
    [vdt] DATETIME NULL,
    [tdate] VARCHAR(30) NULL,
    [ddno] VARCHAR(15) NOT NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(100) NOT NULL,
    [drcr] CHAR(1) NULL,
    [Dramt] MONEY NULL,
    [Cramt] MONEY NULL,
    [treldt] VARCHAR(30) NOT NULL,
    [refno] CHAR(12) NULL,
    [last_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.angel_temp_mis
-- --------------------------------------------------
CREATE TABLE [dbo].[angel_temp_mis]
(
    [cltcode] VARCHAR(10) NULL,
    [acname] VARCHAR(100) NULL,
    [branchcode] VARCHAR(10) NULL,
    [KAM                                ] MONEY NOT NULL,
    [KOLKATTA                           ] MONEY NOT NULL,
    [KOMAL                              ] MONEY NOT NULL,
    [parel                              ] MONEY NOT NULL,
    [PRIYARAJ                           ] MONEY NOT NULL,
    [PUSHA                              ] MONEY NOT NULL,
    [RADHA                              ] MONEY NOT NULL,
    [RADHA1                             ] MONEY NOT NULL,
    [RANCHI2                            ] MONEY NOT NULL,
    [RGTRJH                             ] MONEY NOT NULL,
    [rrr                                ] MONEY NOT NULL,
    [sss1                               ] MONEY NOT NULL,
    [test                               ] MONEY NOT NULL,
    [test1                              ] MONEY NOT NULL,
    [test5                              ] MONEY NOT NULL,
    [TESTAC                             ] MONEY NOT NULL,
    [ttt                                ] MONEY NOT NULL,
    [11                                 ] MONEY NOT NULL,
    [1234563                            ] MONEY NOT NULL,
    [A                                  ] MONEY NOT NULL,
    [A123                               ] MONEY NOT NULL,
    [abc                                ] MONEY NOT NULL,
    [AL001                              ] MONEY NOT NULL,
    [ani                                ] MONEY NOT NULL,
    [Arcadia                            ] MONEY NOT NULL,
    [Bhopal                             ] MONEY NOT NULL,
    [CHECK                              ] MONEY NOT NULL,
    [CMBT1                              ] MONEY NOT NULL,
    [dom                                ] MONEY NOT NULL,
    [FAR                                ] MONEY NOT NULL,
    [HDFC                               ] MONEY NOT NULL,
    [ho4                                ] MONEY NOT NULL,
    [HO                                 ] MONEY NOT NULL,
    [DELHI                              ] MONEY NOT NULL,
    [ahd                                ] MONEY NOT NULL,
    [Jaip                               ] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Audit_ACMAST_TRG
-- --------------------------------------------------
CREATE TABLE [dbo].[Audit_ACMAST_TRG]
(
    [AuditID] INT IDENTITY(1,1) NOT NULL,
    [acname] VARCHAR(100) NULL,
    [longname] VARCHAR(100) NULL,
    [actyp] CHAR(10) NULL,
    [accat] CHAR(10) NULL,
    [familycd] CHAR(10) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [accdtls] CHAR(35) NULL,
    [grpcode] CHAR(13) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] VARCHAR(10) NULL,
    [branchcode] VARCHAR(10) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL,
    [UserName] VARCHAR(128) NULL,
    [COMP_NAME] VARCHAR(200) NULL,
    [UpdateDate] DATETIME NULL DEFAULT (getdate()),
    [DBACTION] VARCHAR(15) NULL,
    [APPLICATION] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AUDIT_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[AUDIT_DATA]
(
    [CLTCODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [ENTITY_LEVEL] VARCHAR(20) NULL,
    [ENTITY_CODE] VARCHAR(25) NULL,
    [VDTBAL] MONEY NULL,
    [EDTBAL] MONEY NULL,
    [FDT_RECEIPT] MONEY NULL,
    [FDT_PAYMENTS] MONEY NULL,
    [EXCHANGE] VARCHAR(20) NULL,
    [SEGMENT] VARCHAR(20) NULL,
    [SESSIONID] VARCHAR(50) NULL,
    [POPULATE_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Audit_LASTVNO_TRG
-- --------------------------------------------------
CREATE TABLE [dbo].[Audit_LASTVNO_TRG]
(
    [AuditID] INT IDENTITY(1,1) NOT NULL,
    [VTYP] INT NULL,
    [BOOKTYPE] VARCHAR(3) NULL,
    [VDT] DATETIME NULL,
    [LASTVNO] VARCHAR(12) NULL,
    [UserName] VARCHAR(128) NULL,
    [COMP_NAME] VARCHAR(200) NULL,
    [UpdateDate] DATETIME NULL DEFAULT (getdate()),
    [DBACTION] VARCHAR(15) NULL,
    [APPLICATION] VARCHAR(200) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.baddebt
-- --------------------------------------------------
CREATE TABLE [dbo].[baddebt]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Edt] DATETIME NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Acname] VARCHAR(100) NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bak_parameter
-- --------------------------------------------------
CREATE TABLE [dbo].[bak_parameter]
(
    [Sdtcur] DATETIME NULL,
    [Ldtcur] DATETIME NULL,
    [Ldtprv] DATETIME NULL,
    [Sdtnxt] DATETIME NULL,
    [Curyear] TINYINT NULL,
    [Vnoflag] SMALLINT NULL,
    [Match_btob] SMALLINT NULL,
    [Match_ctoc] SMALLINT NULL,
    [Maker_checker] SMALLINT NULL,
    [Voucherprintflag] SMALLINT NULL,
    [Branchflag] SMALLINT NULL,
    [FldAuto] INT NOT NULL,
    [REPORTDAYS] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANKDETAILS_FINAL
-- --------------------------------------------------
CREATE TABLE [dbo].[BANKDETAILS_FINAL]
(
    [fld_party_code] VARCHAR(15) NULL,
    [bank_name] VARCHAR(255) NULL,
    [branch_name] VARCHAR(255) NULL,
    [fld_bank_acno] VARCHAR(22) NULL,
    [BANKID] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Banklocat
-- --------------------------------------------------
CREATE TABLE [dbo].[Banklocat]
(
    [Cheque] VARCHAR(10) NULL,
    [Type] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Bankreco
-- --------------------------------------------------
CREATE TABLE [dbo].[Bankreco]
(
    [Cltcode] VARCHAR(10) NULL,
    [Bookdate] DATETIME NULL,
    [Description] VARCHAR(50) NULL,
    [Amount] MONEY NULL,
    [Drcr] VARCHAR(1) NULL,
    [Valuedate] DATETIME NULL,
    [Referenceno] VARCHAR(30) NULL,
    [Statusid] VARCHAR(15) NULL,
    [Statusname] VARCHAR(25) NULL,
    [Loginname] VARCHAR(25) NULL,
    [Crossreferenceno] INT NULL,
    [Status] VARCHAR(9) NULL,
    [Micrno] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [BR_SNo] BIGINT IDENTITY(1,1) NOT NULL,
    [CMS_SrNo] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANKRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[BANKRECO_LOG]
(
    [Cltcode] VARCHAR(10) NULL,
    [Bookdate] DATETIME NULL,
    [Description] VARCHAR(50) NULL,
    [Amount] MONEY NULL,
    [Drcr] VARCHAR(1) NULL,
    [Valuedate] DATETIME NULL,
    [Referenceno] VARCHAR(30) NULL,
    [Statusid] VARCHAR(15) NULL,
    [Statusname] VARCHAR(25) NULL,
    [Loginname] VARCHAR(25) NULL,
    [Crossreferenceno] INT NULL,
    [Status] VARCHAR(9) NULL,
    [Micrno] INT NULL,
    [Dummy1] VARCHAR(20) NULL,
    [Dummy2] VARCHAR(20) NULL,
    [BR_SNo] BIGINT NULL,
    [CMS_SrNo] BIGINT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLLOG
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLLOG]
(
    [GENNO] VARCHAR(50) NULL,
    [STARTTIME] DATETIME NULL,
    [ENDTIME] DATETIME NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(2) NULL,
    [USERNAME] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Billmatch
-- --------------------------------------------------
CREATE TABLE [dbo].[Billmatch]
(
    [Exchange] CHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Sett_type] VARCHAR(3) NULL,
    [Sett_no] VARCHAR(12) NULL,
    [Billno] VARCHAR(10) NULL,
    [Date] DATETIME NULL,
    [Party_code] VARCHAR(10) NULL,
    [Amount] MONEY NULL,
    [Drcr] CHAR(1) NULL,
    [Balamt] MONEY NULL,
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Branch] VARCHAR(10) NULL,
    [Booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BillPosted
-- --------------------------------------------------
CREATE TABLE [dbo].[BillPosted]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL,
    [BookType] CHAR(2) NULL,
    [vdt] DATETIME NULL,
    [BillDate] DATETIME NULL,
    [Sett_No] VARCHAR(12) NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [narration] VARCHAR(500) NULL,
    [UserName] VARCHAR(25) NULL,
    [PostDate] DATETIME NULL,
    [EdtDr] DATETIME NULL,
    [EdtCr] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLPOSTED_04052016
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLPOSTED_04052016]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL,
    [BookType] CHAR(2) NULL,
    [vdt] DATETIME NULL,
    [BillDate] DATETIME NULL,
    [Sett_No] VARCHAR(12) NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [narration] VARCHAR(500) NULL,
    [UserName] VARCHAR(25) NULL,
    [PostDate] DATETIME NULL,
    [EdtDr] DATETIME NULL,
    [EdtCr] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLPROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLPROCESS]
(
    [IN_PROCESS] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Booktype
-- --------------------------------------------------
CREATE TABLE [dbo].[Booktype]
(
    [Vtyp] INT NOT NULL,
    [Booktype] CHAR(2) NOT NULL,
    [Description] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Branchaccounts
-- --------------------------------------------------
CREATE TABLE [dbo].[Branchaccounts]
(
    [Branchname] VARCHAR(10) NOT NULL,
    [Brcontrolac] VARCHAR(10) NOT NULL,
    [Maincontrolac] VARCHAR(10) NOT NULL,
    [Defaultac] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branchaccounts_new
-- --------------------------------------------------
CREATE TABLE [dbo].[branchaccounts_new]
(
    [Branchname] VARCHAR(10) NOT NULL,
    [Brcontrolac] VARCHAR(10) NOT NULL,
    [Maincontrolac] VARCHAR(10) NOT NULL,
    [Defaultac] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.branchwiseclbal
-- --------------------------------------------------
CREATE TABLE [dbo].[branchwiseclbal]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] VARCHAR(100) NULL,
    [Costcode] INT NULL,
    [Balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bseled
-- --------------------------------------------------
CREATE TABLE [dbo].[bseled]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [Vamt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CAL_DATES
-- --------------------------------------------------
CREATE TABLE [dbo].[CAL_DATES]
(
    [CAL_DATES] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Category
-- --------------------------------------------------
CREATE TABLE [dbo].[Category]
(
    [Category] CHAR(35) NOT NULL,
    [Catcode] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.catmast
-- --------------------------------------------------
CREATE TABLE [dbo].[catmast]
(
    [Accat] CHAR(10) NOT NULL,
    [Catname] CHAR(35) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.chequeformats
-- --------------------------------------------------
CREATE TABLE [dbo].[chequeformats]
(
    [Bankstyle] VARCHAR(50) NOT NULL,
    [Formatcode] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Class_SQLTableIndex
-- --------------------------------------------------
CREATE TABLE [dbo].[Class_SQLTableIndex]
(
    [TableName] VARCHAR(50) NULL,
    [IndexName] VARCHAR(200) NULL,
    [IndexType] VARCHAR(18) NULL,
    [IndexColumns] NVARCHAR(800) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Class_SQLTableListing
-- --------------------------------------------------
CREATE TABLE [dbo].[Class_SQLTableListing]
(
    [TableName] VARCHAR(50) NULL,
    [Description] VARCHAR(200) NULL,
    [StatusFlag] CHAR(1) NULL,
    [CreatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_BANKRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_BANKRECO_LOG]
(
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKDATE] DATETIME NULL,
    [DESCRIPTION] VARCHAR(100) NULL,
    [AMOUNT] MONEY NULL,
    [DRCR] VARCHAR(1) NULL,
    [VALUEDATE] DATETIME NULL,
    [REFERENCENO] VARCHAR(30) NULL,
    [STATUSID] VARCHAR(15) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [LOGINNAME] VARCHAR(25) NULL,
    [CROSSREFERENCENO] INT NULL,
    [STATUS] VARCHAR(9) NULL,
    [MICRNO] INT NULL,
    [DUMMY1] VARCHAR(20) NULL,
    [DUMMY2] VARCHAR(20) NULL,
    [BR_SNO] BIGINT NOT NULL,
    [CMS_SRNO] BIGINT NULL DEFAULT ((0)),
    [UPDATED_BY] VARCHAR(25) NULL,
    [UPDATE_DT] DATETIME NULL,
    [RECO_STATUS] VARCHAR(9) NULL,
    [SRNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_LEDGER1_BANKRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_LEDGER1_BANKRECO_LOG]
(
    [Bnkname] VARCHAR(100) NULL,
    [Brnname] VARCHAR(20) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(30) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(150) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL,
    [Reset_EDT] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Costmast
-- --------------------------------------------------
CREATE TABLE [dbo].[Costmast]
(
    [Costname] CHAR(35) NOT NULL,
    [Costcode] SMALLINT NOT NULL,
    [Catcode] SMALLINT NOT NULL,
    [Grpcode] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Costmast_KIRAN
-- --------------------------------------------------
CREATE TABLE [dbo].[Costmast_KIRAN]
(
    [Costname] CHAR(35) NOT NULL,
    [Costcode] SMALLINT NOT NULL,
    [Catcode] SMALLINT NOT NULL,
    [Grpcode] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.costmast_new
-- --------------------------------------------------
CREATE TABLE [dbo].[costmast_new]
(
    [Costname] CHAR(35) NOT NULL,
    [Costcode] SMALLINT NOT NULL,
    [Catcode] SMALLINT NOT NULL,
    [Grpcode] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.creditors
-- --------------------------------------------------
CREATE TABLE [dbo].[creditors]
(
    [Cltcode] NVARCHAR(10) NOT NULL,
    [L_address1] NVARCHAR(40) NULL,
    [L_address2] NVARCHAR(40) NULL,
    [L_address3] NVARCHAR(40) NULL,
    [L_city] NVARCHAR(20) NULL,
    [L_state] NVARCHAR(15) NULL,
    [L_nation] NVARCHAR(15) NULL,
    [L_zip] NVARCHAR(10) NULL,
    [Fax] NVARCHAR(15) NULL,
    [Off_phone1] NVARCHAR(15) NULL,
    [Off_phone2] NVARCHAR(15) NULL,
    [Email] NVARCHAR(50) NULL,
    [Mobile_pager] NVARCHAR(40) NULL,
    [Regsupplier] TINYINT NULL,
    [Cstno] NVARCHAR(40) NULL,
    [Sstno] NVARCHAR(40) NULL,
    [Omsflag] TINYINT NULL,
    [Crlimit] MONEY NULL,
    [Crdays] TINYINT NULL,
    [Pan_no] VARCHAR(50) NULL,
    [Servicetax_no] VARCHAR(50) NULL,
    [Tds_no] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ddvno
-- --------------------------------------------------
CREATE TABLE [dbo].[ddvno]
(
    [vno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.edtclbal
-- --------------------------------------------------
CREATE TABLE [dbo].[edtclbal]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] VARCHAR(100) NULL,
    [Balance] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Errvouchers
-- --------------------------------------------------
CREATE TABLE [dbo].[Errvouchers]
(
    [Cdt] DATETIME NULL,
    [Errstr] VARCHAR(300) NULL,
    [Statusid] VARCHAR(30) NULL,
    [Statusname] VARCHAR(30) NULL,
    [Username] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EXISTS_RECORDS
-- --------------------------------------------------
CREATE TABLE [dbo].[EXISTS_RECORDS]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [RECORDSTATUS] BIT NULL,
    [UPLOADID] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FORMULA_CLIENT_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[FORMULA_CLIENT_MASTER]
(
    [CLTCODE] VARCHAR(10) NOT NULL,
    [PARTY_NAME] VARCHAR(100) NULL,
    [ENTITY_LEVEL] VARCHAR(20) NULL,
    [ENTITY_CODE] VARCHAR(25) NULL,
    [SESSION_ID] VARCHAR(500) NOT NULL,
    [POPULATE_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FORMULA_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[FORMULA_MASTER]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PROCESSCODE] VARCHAR(10) NULL,
    [PROCESSNAME] VARCHAR(50) NULL,
    [EXCHANGE] VARCHAR(5) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [FORMULANAME] VARCHAR(MAX) NULL,
    [COMPAREWITH] VARCHAR(20) NULL,
    [COMPARISON] VARCHAR(10) NULL,
    [TR_TYPE] TINYINT NULL,
    [DBTYPE] VARCHAR(30) NULL,
    [ADDITIONAL_PARAMETERS] VARCHAR(1000) NULL,
    [FORMULA_FIELDS] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FT_GL
-- --------------------------------------------------
CREATE TABLE [dbo].[FT_GL]
(
    [SR_NO] SMALLINT IDENTITY(1,1) NOT NULL,
    [EXCH_FR] VARCHAR(10) NULL,
    [EXCH_TO] VARCHAR(10) NULL,
    [JV_CODE] VARCHAR(10) NULL,
    [JV_NAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.grpmast
-- --------------------------------------------------
CREATE TABLE [dbo].[grpmast]
(
    [Grpname] VARCHAR(60) NULL,
    [Grpmain] VARCHAR(13) NULL,
    [Grpcode] VARCHAR(13) NULL,
    [Vtyp] FLOAT NULL,
    [Dispdetail] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Lastchequeno
-- --------------------------------------------------
CREATE TABLE [dbo].[Lastchequeno]
(
    [Bankcode] VARCHAR(10) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Ddno] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Lastvno
-- --------------------------------------------------
CREATE TABLE [dbo].[Lastvno]
(
    [Vtyp] SMALLINT NULL,
    [Booktype] VARCHAR(2) NULL,
    [Vdt] SMALLDATETIME NULL,
    [Lastvno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger]
(
    [VTYP] SMALLINT NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [EDT] DATETIME NULL,
    [LNO] INT NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [DRCR] CHAR(1) NOT NULL,
    [VAMT] MONEY NULL,
    [VDT] DATETIME NOT NULL,
    [VNO1] VARCHAR(12) NULL,
    [REFNO] CHAR(12) NULL,
    [BALAMT] MONEY NOT NULL,
    [NODAYS] INT NULL,
    [CDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [BOOKTYPE] VARCHAR(3) NOT NULL,
    [ENTEREDBY] VARCHAR(25) NULL,
    [PDT] DATETIME NULL,
    [CHECKEDBY] VARCHAR(25) NULL,
    [ACTNODAYS] INT NULL,
    [NARRATION] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_1
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_1]
(
    [VTYP] SMALLINT NOT NULL,
    [VNO] VARCHAR(12) NOT NULL,
    [EDT] DATETIME NULL,
    [LNO] INT NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [DRCR] CHAR(1) NOT NULL,
    [VAMT] MONEY NULL,
    [VDT] DATETIME NOT NULL,
    [VNO1] VARCHAR(12) NULL,
    [REFNO] CHAR(12) NULL,
    [BALAMT] MONEY NOT NULL,
    [NODAYS] INT NULL,
    [CDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NOT NULL,
    [BOOKTYPE] VARCHAR(3) NOT NULL,
    [ENTEREDBY] VARCHAR(25) NULL,
    [PDT] DATETIME NULL,
    [CHECKEDBY] VARCHAR(25) NULL,
    [ACTNODAYS] INT NULL,
    [NARRATION] VARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_BRANCHBREAKUP
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_BRANCHBREAKUP]
(
    [VNO] VARCHAR(12) NULL,
    [VTYPE] SMALLINT NULL,
    [BOOKTYPE] CHAR(2) NULL,
    [LNO] INT NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [CAMT] MONEY NULL,
    [COSTCODE] SMALLINT NULL,
    [DRCR] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_log]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] DECIMAL(4, 0) NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL,
    [optcode] CHAR(1) NULL,
    [Editdate] DATETIME NULL,
    [EditName] VARCHAR(15) NULL,
    [Status] VARCHAR(6) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger_org
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger_org]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NOT NULL,
    [Edt] DATETIME NULL,
    [Lno] INT NULL,
    [Acname] VARCHAR(100) NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NOT NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger_pay
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger_pay]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(100) NULL,
    [region] VARCHAR(20) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [vdt] DATETIME NULL,
    [vno] VARCHAR(12) NULL,
    [narration] VARCHAR(234) NULL,
    [vamt] MONEY NULL,
    [drcr] CHAR(1) NULL,
    [vtype] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger_Report
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger_Report]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Edt] DATETIME NULL,
    [Lno] NUMERIC(4, 0) NULL,
    [Acname] VARCHAR(100) NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL,
    [SNo] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger_Temp_New
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger_Temp_New]
(
    [Vno] INT NOT NULL,
    [CltCode] VARCHAR(10) NOT NULL,
    [Vdt] DATETIME NULL,
    [Edt] DATETIME NULL,
    [VTyp] SMALLINT NOT NULL,
    [Vamt] MONEY NULL,
    [DrCr] CHAR(1) NULL,
    [branch_cd] VARCHAR(10) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [trader] VARCHAR(15) NOT NULL,
    [acname] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_TEMP_NEW_PARTYLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_TEMP_NEW_PARTYLEDGER]
(
    [CLTCODE] VARCHAR(10) NULL,
    [LONGNAME] VARCHAR(100) NULL,
    [VDT] VARCHAR(11) NULL,
    [EDT] VARCHAR(11) NULL,
    [VAMT] MONEY NULL,
    [MAMT] MONEY NULL,
    [DRCR] CHAR(2) NULL,
    [AREA] VARCHAR(10) NULL,
    [AREA_NAME] VARCHAR(100) NULL,
    [REGION] VARCHAR(10) NULL,
    [REGION_NAME] VARCHAR(100) NULL,
    [BRANCH_CODE] VARCHAR(10) NULL,
    [BRANCH_NAME] VARCHAR(100) NULL,
    [SUBBROKER] VARCHAR(10) NULL,
    [SUBBROKER_NAME] VARCHAR(100) NULL,
    [TRADER] VARCHAR(10) NULL,
    [TRADER_NAME] VARCHAR(100) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [FAMILY_NAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_TRIG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_TRIG]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] INT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_TRIG_HIS
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_TRIG_HIS]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [edt] DATETIME NULL,
    [lno] INT NULL,
    [acname] VARCHAR(100) NULL,
    [drcr] CHAR(1) NULL,
    [vamt] MONEY NULL,
    [vdt] DATETIME NULL,
    [vno1] VARCHAR(12) NULL,
    [refno] CHAR(12) NULL,
    [balamt] MONEY NOT NULL,
    [NoDays] INT NULL,
    [cdt] DATETIME NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [BookType] CHAR(2) NULL,
    [EnteredBy] VARCHAR(25) NULL,
    [pdt] DATETIME NULL,
    [CheckedBy] VARCHAR(25) NULL,
    [actnodays] INT NULL,
    [narration] VARCHAR(234) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1]
(
    [Bnkname] VARCHAR(100) NULL,
    [Brnname] VARCHAR(100) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(30) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] NUMERIC(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_BANKRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_BANKRECO_LOG]
(
    [Bnkname] VARCHAR(100) NULL,
    [Brnname] VARCHAR(100) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(15) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger1_log
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger1_log]
(
    [bnkname] VARCHAR(100) NULL,
    [brnname] VARCHAR(100) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(18, 0) NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_MANUALRECO_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_MANUALRECO_LOG]
(
    [Bnkname] VARCHAR(100) NULL,
    [Brnname] VARCHAR(100) NULL,
    [Dd] CHAR(1) NULL,
    [Ddno] VARCHAR(15) NULL,
    [Dddt] DATETIME NULL,
    [Reldt] DATETIME NULL,
    [Relamt] MONEY NULL,
    [Refno] CHAR(12) NOT NULL,
    [Receiptno] INT NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(18, 0) NULL,
    [Drcr] CHAR(1) NULL,
    [Booktype] CHAR(2) NULL,
    [Micrno] INT NULL,
    [Slipno] INT NULL,
    [Slipdate] DATETIME NULL,
    [Chequeinname] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [Clear_mode] CHAR(1) NULL,
    [L1_SNo] BIGINT NOT NULL,
    [Updated_by] VARCHAR(25) NULL,
    [Update_Dt] DATETIME NULL,
    [Reco_Status] VARCHAR(9) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger1_pay
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger1_pay]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [ddno] VARCHAR(15) NULL,
    [drcr] CHAR(1) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_TRIG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_TRIG]
(
    [bnkname] VARCHAR(100) NULL,
    [brnname] VARCHAR(100) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER1_TRIG_HIS
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER1_TRIG_HIS]
(
    [bnkname] VARCHAR(100) NULL,
    [brnname] VARCHAR(100) NULL,
    [dd] CHAR(1) NULL,
    [ddno] VARCHAR(15) NULL,
    [dddt] DATETIME NULL,
    [reldt] DATETIME NULL,
    [relamt] MONEY NULL,
    [refno] CHAR(12) NOT NULL,
    [receiptno] INT NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] INT NULL,
    [drcr] CHAR(1) NULL,
    [BookType] CHAR(2) NULL,
    [MicrNo] INT NULL,
    [SlipNo] INT NULL,
    [slipdate] DATETIME NULL,
    [ChequeInName] VARCHAR(100) NULL,
    [Chqprinted] TINYINT NULL,
    [clear_mode] CHAR(1) NULL,
    [COMP_NAME] VARCHAR(50) NULL,
    [UPDDATE] DATETIME NULL,
    [DBACTION] VARCHAR(20) NULL,
    [SNO] BIGINT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledger2
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledger2]
(
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] INT NULL,
    [Drcr] CHAR(1) NULL,
    [Camt] MONEY NULL,
    [Costcode] SMALLINT NULL,
    [Booktype] CHAR(2) NULL,
    [Cltcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger2_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger2_log]
(
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [drcr] CHAR(1) NULL,
    [camt] MONEY NULL,
    [costcode] SMALLINT NULL,
    [BookType] CHAR(2) NULL,
    [cltcode] VARCHAR(10) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger3
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger3]
(
    [Naratno] INT NOT NULL,
    [Narr] VARCHAR(234) NULL,
    [Refno] CHAR(12) NULL,
    [Vtyp] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ledger3_log
-- --------------------------------------------------
CREATE TABLE [dbo].[ledger3_log]
(
    [naratno] INT NOT NULL,
    [narr] VARCHAR(234) NULL,
    [refno] CHAR(12) NULL,
    [vtyp] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [BookType] CHAR(2) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Ledgerbalances
-- --------------------------------------------------
CREATE TABLE [dbo].[Ledgerbalances]
(
    [Familycode] VARCHAR(50) NULL,
    [Cltcode] VARCHAR(50) NULL,
    [Acname] VARCHAR(100) NULL,
    [Nsebalance] MONEY NULL,
    [Bsebalance] MONEY NULL,
    [Nsefobalance] MONEY NULL,
    [Nseestimated1] MONEY NULL,
    [Nseestimated2] MONEY NULL,
    [Bseestimated1] MONEY NULL,
    [Bseestimated2] MONEY NULL,
    [Faactual] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGERRENUM_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGERRENUM_LOG]
(
    [VNO] VARCHAR(12) NULL,
    [VTYPE] INT NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [OVNO] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Marginledger
-- --------------------------------------------------
CREATE TABLE [dbo].[Marginledger]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NOT NULL,
    [Drcr] CHAR(1) NOT NULL,
    [Vdt] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [Sett_no] MONEY NULL,
    [Sett_type] VARCHAR(3) NOT NULL,
    [Booktype] CHAR(2) NULL,
    [Mcltcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.marginledger_log
-- --------------------------------------------------
CREATE TABLE [dbo].[marginledger_log]
(
    [vtyp] SMALLINT NOT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NOT NULL,
    [drcr] CHAR(1) NOT NULL,
    [vdt] DATETIME NOT NULL,
    [Amount] MONEY NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Segment] VARCHAR(20) NOT NULL,
    [Sett_no] MONEY NULL,
    [Sett_type] VARCHAR(3) NOT NULL,
    [BookType] CHAR(2) NULL,
    [MCltcode] VARCHAR(10) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Matchdetails
-- --------------------------------------------------
CREATE TABLE [dbo].[Matchdetails]
(
    [Description] VARCHAR(20) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Vtype] SMALLINT NULL,
    [Vno] VARCHAR(12) NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Booktype] CHAR(2) NULL,
    [Drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [Lvtype] SMALLINT NULL,
    [Lvno] VARCHAR(12) NULL,
    [Llno] DECIMAL(4, 0) NULL,
    [Lbooktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.matchdetails_log
-- --------------------------------------------------
CREATE TABLE [dbo].[matchdetails_log]
(
    [Description] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [vtype] SMALLINT NULL,
    [vno] VARCHAR(12) NULL,
    [lno] DECIMAL(4, 0) NULL,
    [Booktype] CHAR(2) NULL,
    [drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [lvtype] SMALLINT NULL,
    [lvno] VARCHAR(12) NULL,
    [llno] DECIMAL(4, 0) NULL,
    [lBookType] CHAR(2) NULL,
    [optcode] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Mis_Temp_ACPLMCD
-- --------------------------------------------------
CREATE TABLE [dbo].[Mis_Temp_ACPLMCD]
(
    [cltcode] VARCHAR(10) NULL,
    [acname] VARCHAR(100) NULL,
    [branchcode] VARCHAR(10) NULL,
    [KAM                                ] MONEY NOT NULL,
    [KOLKATTA                           ] MONEY NOT NULL,
    [KOMAL                              ] MONEY NOT NULL,
    [parel                              ] MONEY NOT NULL,
    [PRIYARAJ                           ] MONEY NOT NULL,
    [PUSHA                              ] MONEY NOT NULL,
    [RADHA                              ] MONEY NOT NULL,
    [RADHA1                             ] MONEY NOT NULL,
    [RANCHI2                            ] MONEY NOT NULL,
    [RGTRJH                             ] MONEY NOT NULL,
    [rrr                                ] MONEY NOT NULL,
    [sss1                               ] MONEY NOT NULL,
    [test                               ] MONEY NOT NULL,
    [test1                              ] MONEY NOT NULL,
    [test5                              ] MONEY NOT NULL,
    [TESTAC                             ] MONEY NOT NULL,
    [ttt                                ] MONEY NOT NULL,
    [11                                 ] MONEY NOT NULL,
    [1234563                            ] MONEY NOT NULL,
    [A                                  ] MONEY NOT NULL,
    [A123                               ] MONEY NOT NULL,
    [abc                                ] MONEY NOT NULL,
    [AL001                              ] MONEY NOT NULL,
    [ani                                ] MONEY NOT NULL,
    [Arcadia                            ] MONEY NOT NULL,
    [Bhopal                             ] MONEY NOT NULL,
    [CHECK                              ] MONEY NOT NULL,
    [CMBT1                              ] MONEY NOT NULL,
    [dom                                ] MONEY NOT NULL,
    [FAR                                ] MONEY NOT NULL,
    [HDFC                               ] MONEY NOT NULL,
    [ho4                                ] MONEY NOT NULL,
    [HO                                 ] MONEY NOT NULL,
    [DELHI                              ] MONEY NOT NULL,
    [ahd                                ] MONEY NOT NULL,
    [Jaip                               ] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Multibankid
-- --------------------------------------------------
CREATE TABLE [dbo].[Multibankid]
(
    [Srno] INT NOT NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Bankid] VARCHAR(20) NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NOT NULL,
    [Chequename] VARCHAR(100) NOT NULL,
    [Defaultbank] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTIBANKID_2307
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTIBANKID_2307]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Bankid] VARCHAR(20) NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NOT NULL,
    [Chequename] VARCHAR(100) NOT NULL,
    [Defaultbank] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Multibankid_AUDIT
-- --------------------------------------------------
CREATE TABLE [dbo].[Multibankid_AUDIT]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Bankid] VARCHAR(20) NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NOT NULL,
    [Chequename] VARCHAR(100) NOT NULL,
    [Defaultbank] CHAR(1) NOT NULL,
    [Action] VARCHAR(10) NULL,
    [Action_ModifiedDate] SMALLDATETIME NULL,
    [Action_ModifiedBy] NVARCHAR(256) NULL,
    [USER_IP] VARCHAR(25) NULL,
    [APPNAME] VARCHAR(100) NULL,
    [HOSTNAME] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTIBANKID_DONOT_DELETE
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTIBANKID_DONOT_DELETE]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Bankid] VARCHAR(20) NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NOT NULL,
    [Chequename] VARCHAR(100) NOT NULL,
    [Defaultbank] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.multibankid_N25431
-- --------------------------------------------------
CREATE TABLE [dbo].[multibankid_N25431]
(
    [Srno] INT IDENTITY(1,1) NOT NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Bankid] VARCHAR(20) NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NOT NULL,
    [Chequename] VARCHAR(100) NOT NULL,
    [Defaultbank] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NEWPARTYLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[NEWPARTYLEDGER]
(
    [BRANCH_CODE] VARCHAR(11) NULL,
    [BRANCH] VARCHAR(40) NULL,
    [CLTCODE] VARCHAR(11) NULL,
    [ACNAME] VARCHAR(50) NULL,
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [TRADER] VARCHAR(20) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [AREA] VARCHAR(10) NULL,
    [REGION] VARCHAR(50) NULL,
    [PARTY] VARCHAR(10) NULL,
    [VAMT] MONEY NULL,
    [MAMT] MONEY NULL,
    [UNREALISED] MONEY NULL,
    [SPID] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.opencltcode
-- --------------------------------------------------
CREATE TABLE [dbo].[opencltcode]
(
    [Acname] VARCHAR(100) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Drcr] CHAR(1) NULL,
    [Amount] MONEY NULL,
    [Branch] VARCHAR(35) NULL,
    [Status] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Owner
-- --------------------------------------------------
CREATE TABLE [dbo].[Owner]
(
    [Companyname] VARCHAR(60) NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Sharedb] VARCHAR(10) NOT NULL,
    [Accountdb] VARCHAR(30) NULL,
    [Clientgroup] VARCHAR(35) NULL,
    [Balsign] TINYINT NULL,
    [Conpath] VARCHAR(50) NULL,
    [Segment] VARCHAR(20) NULL,
    [Membertype] VARCHAR(15) NULL,
    [Panno] VARCHAR(40) NULL,
    [recoflag] VARCHAR(2) NULL,
    [CIN] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.p1
-- --------------------------------------------------
CREATE TABLE [dbo].[p1]
(
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Edt] DATETIME NULL,
    [Lno] DECIMAL(4, 0) NULL,
    [Acname] VARCHAR(100) NULL,
    [Drcr] CHAR(1) NULL,
    [Vamt] MONEY NULL,
    [Vdt] DATETIME NULL,
    [Vno1] VARCHAR(12) NULL,
    [Refno] CHAR(12) NULL,
    [Balamt] MONEY NOT NULL,
    [Nodays] INT NULL,
    [Cdt] DATETIME NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Booktype] CHAR(2) NULL,
    [Enteredby] VARCHAR(25) NULL,
    [Pdt] DATETIME NULL,
    [Checkedby] VARCHAR(25) NULL,
    [Actnodays] INT NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.parameter
-- --------------------------------------------------
CREATE TABLE [dbo].[parameter]
(
    [Sdtcur] DATETIME NULL,
    [Ldtcur] DATETIME NULL,
    [Ldtprv] DATETIME NULL,
    [Sdtnxt] DATETIME NULL,
    [Curyear] TINYINT NULL,
    [Vnoflag] SMALLINT NULL,
    [Match_btob] SMALLINT NULL,
    [Match_ctoc] SMALLINT NULL,
    [Maker_checker] SMALLINT NULL,
    [Voucherprintflag] SMALLINT NULL,
    [Branchflag] SMALLINT NULL,
    [FldAuto] INT NOT NULL,
    [REPORTDAYS] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Payadv
-- --------------------------------------------------
CREATE TABLE [dbo].[Payadv]
(
    [Cltcode] VARCHAR(10) NULL,
    [Acname] CHAR(100) NULL,
    [Vdt] SMALLDATETIME NULL,
    [Amt] MONEY NULL,
    [Chequeno] VARCHAR(15) NULL,
    [Chequeinname] VARCHAR(50) NULL,
    [Narration] VARCHAR(234) NULL,
    [Printedflag] TINYINT NULL,
    [Actamt] MONEY NULL,
    [Shortage] MONEY NULL,
    [Vtyp] SMALLINT NOT NULL,
    [Vno] VARCHAR(12) NULL,
    [Booktype] CHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PostBillLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[PostBillLedger]
(
    [VTYP] SMALLINT NULL,
    [VNO] VARCHAR(12) NULL,
    [EDT] DATETIME NULL,
    [LNO] INT IDENTITY(1,1) NOT NULL,
    [ACNAME] VARCHAR(100) NULL,
    [DRCR] VARCHAR(1) NULL,
    [VAMT] MONEY NULL,
    [VDT] DATETIME NULL,
    [VNO1] VARCHAR(12) NULL,
    [REFNO] CHAR(12) NULL,
    [BALAMT] MONEY NULL,
    [NODAYS] INT NULL,
    [CDT] DATETIME NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [ENTEREDBY] VARCHAR(25) NULL,
    [PDT] DATETIME NULL,
    [CHECKEDBY] VARCHAR(25) NULL,
    [ACTNODAYS] INT NULL,
    [NARRATION] VARCHAR(234) NULL,
    [SNO] BIGINT NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [BILL_NO] INT NULL,
    [ACCAT] CHAR(10) NULL,
    [BRANCHCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.POSTBILLLEDGER2
-- --------------------------------------------------
CREATE TABLE [dbo].[POSTBILLLEDGER2]
(
    [DRCR] CHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_BANK_DELETION_LOGS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_BANK_DELETION_LOGS]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NOT NULL,
    [SEGMENT] NVARCHAR(50) NOT NULL,
    [BANKCODE] NVARCHAR(50) NOT NULL,
    [BANKNAME] NVARCHAR(50) NULL,
    [FILETYPE] NVARCHAR(50) NOT NULL,
    [BANKACCOUNT] NVARCHAR(100) NULL,
    [UPLOADFILENAME] NVARCHAR(100) NULL,
    [MODIFIEDDATE] DATETIME NOT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [FILEUPLOAD_SDATE] DATETIME NULL,
    [FILEUPLOAD_EDATE] DATETIME NULL,
    [VALUEDATE] DATETIME NULL,
    [ROWTYPE] NVARCHAR(25) NULL,
    [DRCR] NVARCHAR(5) NULL,
    [REFERENCENO] NVARCHAR(50) NULL,
    [AMOUNT] DECIMAL(20, 2) NULL,
    [DRAWER_NAME] NVARCHAR(100) NULL,
    [CLTCODE] NVARCHAR(50) NULL,
    [CLTACCNO] NVARCHAR(50) NULL,
    [VNO] NVARCHAR(50) NULL,
    [VTYP] NVARCHAR(50) NULL,
    [BOOKTYPE] NVARCHAR(50) NULL,
    [MATCHEDFLAG] BIT NOT NULL,
    [UPLOADEDDATE] DATETIME NULL,
    [BOOKDATE] DATETIME NULL,
    [CROSS_NO] NVARCHAR(50) NULL,
    [DESCRIPTION] NVARCHAR(300) NULL,
    [LEDGERBALANCE] NVARCHAR(100) NULL,
    [CUSTOMERREFERENCE] NVARCHAR(100) NULL,
    [TRANSACTIONDETAIL] NVARCHAR(150) NULL,
    [USERNAME] NVARCHAR(50) NULL,
    [PERFORMDATE] DATETIME NULL,
    [ERROR1] NVARCHAR(MAX) NULL,
    [ERROR2] NVARCHAR(MAX) NULL,
    [ERROR3] NVARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_BANK_FILEUPLOAD_LOGS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_BANK_FILEUPLOAD_LOGS]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NOT NULL,
    [SEGMENT] NVARCHAR(50) NOT NULL,
    [BANKCODE] NVARCHAR(50) NOT NULL,
    [BANKNAME] NVARCHAR(50) NULL,
    [FILETYPE] NVARCHAR(50) NOT NULL,
    [BANKACCOUNT] NVARCHAR(100) NULL,
    [UPLOADFILENAME] NVARCHAR(100) NULL,
    [MODIFIEDDATE] DATETIME NOT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [FILEUPLOAD_SDATE] DATETIME NULL,
    [FILEUPLOAD_EDATE] DATETIME NULL,
    [VALUEDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_BANK_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_BANK_MASTER]
(
    [BANKMASTERID] INT IDENTITY(1,1) NOT NULL,
    [SEGMENT] NVARCHAR(50) NOT NULL,
    [BANKNAME] NVARCHAR(100) NULL,
    [BANKCODE] NVARCHAR(50) NOT NULL,
    [BANKACCOUNT] NVARCHAR(50) NULL,
    [CLIENT] NVARCHAR(100) NULL,
    [FILETYPE] NVARCHAR(50) NOT NULL,
    [INSERTEDDATETIME] DATETIME NOT NULL DEFAULT (getdate()),
    [LASTUPDATE] DATETIME NOT NULL DEFAULT (getdate())
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_BANK_UPLOAD_PROCESS_INFO
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_BANK_UPLOAD_PROCESS_INFO]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NOT NULL,
    [SEGMENT] NVARCHAR(50) NOT NULL,
    [BANKCODE] NVARCHAR(50) NOT NULL,
    [BANKNAME] NVARCHAR(50) NOT NULL,
    [FILETYPE] NVARCHAR(50) NOT NULL,
    [BANKACCOUNT] NVARCHAR(100) NULL,
    [UPLOADFILENAME] NVARCHAR(100) NULL,
    [MODIFIEDDATE] DATETIME NOT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [FILEUPLOAD_SDATE] DATETIME NULL,
    [FILEUPLOAD_EDATE] DATETIME NULL,
    [VALUEDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Recon_CMS_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[Recon_CMS_Data]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [BANKCODE] NVARCHAR(50) NULL,
    [RowType] NVARCHAR(50) NULL,
    [Valuedate] DATETIME NULL,
    [DrCr] NVARCHAR(50) NULL,
    [Inst_no_Check] NVARCHAR(50) NULL,
    [Inst_Amt] DECIMAL(20, 2) NULL,
    [Drawer_Name] NVARCHAR(250) NULL,
    [CltCode] NVARCHAR(50) NULL,
    [CltAccNo] NVARCHAR(50) NULL,
    [VNO] NVARCHAR(50) NULL,
    [VTYP] NVARCHAR(50) NULL,
    [BOOKTYPE] NVARCHAR(50) NULL,
    [MatchedFlag] BIT NULL,
    [UploadStatus] NVARCHAR(50) NULL,
    [UPLOADEDDATE] DATETIME NULL,
    [ModifiedDate] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [BOOKDATE] DATETIME NULL,
    [CROSS_NO] INT NULL,
    [MATCHCODE] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_ENCRYPTION_DETAILS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_ENCRYPTION_DETAILS]
(
    [ENCRY_SRNO] INT IDENTITY(1,1) NOT NULL,
    [ENCRY_NUMBER] NVARCHAR(50) NULL,
    [REFERENCESNUMBER] NVARCHAR(50) NULL,
    [INCRYPTIONDATE] DATETIME NULL,
    [ENCRY_DESCRIPTION] NVARCHAR(200) NULL,
    [ENCRY_AMOUNT] MONEY NULL,
    [ENCRY_STATUS] NVARCHAR(25) NULL,
    [ENCRY_CHEQUENUMBER] NVARCHAR(25) NULL,
    [UPLOADDATE] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [MATCH_STATUS] INT NULL,
    [UPLOADTYPE] NVARCHAR(20) NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [SEGMENT] NVARCHAR(100) NULL,
    [BANKNAME] NVARCHAR(100) NULL,
    [BANKCODE] NVARCHAR(100) NULL,
    [BANKACCOUNT] NVARCHAR(100) NULL,
    [FILETYPE] NVARCHAR(100) NULL,
    [CROSS_NO] NVARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECON_LOGS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECON_LOGS]
(
    [LOGID] INT IDENTITY(1,1) NOT NULL,
    [SERVERNAME] NVARCHAR(100) NULL,
    [DATABASENAME] NVARCHAR(100) NULL,
    [USERNAME] NVARCHAR(50) NULL,
    [BANKNAME] NVARCHAR(100) NULL,
    [LOGDATE] DATETIME NULL,
    [ERRORLOGS] NVARCHAR(250) NULL,
    [SOURCENAME] NVARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Recon_NONCMS_Data
-- --------------------------------------------------
CREATE TABLE [dbo].[Recon_NONCMS_Data]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [BANKACCOUNT] NVARCHAR(50) NULL,
    [BANKCODE] NVARCHAR(50) NULL,
    [Description] NVARCHAR(150) NULL,
    [LedgerBalance] NVARCHAR(50) NULL,
    [DrCr] NVARCHAR(50) NULL,
    [Amt] DECIMAL(20, 2) NULL,
    [ValueDate] DATETIME NULL,
    [ReferenceNo] NVARCHAR(50) NULL,
    [CLTACCOUNT] NVARCHAR(50) NULL,
    [CustomerReference] NVARCHAR(50) NULL,
    [TransaCtionDetail] NVARCHAR(400) NULL,
    [VNO] NVARCHAR(50) NULL,
    [VTYP] INT NULL,
    [BOOKTYPE] NVARCHAR(50) NULL,
    [MatchedFlag] BIT NULL,
    [UploadStatus] NVARCHAR(50) NULL,
    [UPLOADEDDATE] DATETIME NULL,
    [ModifiedDate] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [BOOKDATE] DATETIME NULL,
    [CROSS_NO] INT NULL,
    [MATCHCODE] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RECOPROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[RECOPROCESS]
(
    [INPROCESS] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RecPay_Table
-- --------------------------------------------------
CREATE TABLE [dbo].[RecPay_Table]
(
    [SRNO] INT NULL,
    [VVDT] VARCHAR(10) NULL,
    [EEDT] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [DRCR] VARCHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [NARRATION] VARCHAR(500) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [VDT] DATETIME NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL DEFAULT 'N',
    [EDT] DATETIME NULL,
    [VNO] VARCHAR(12) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [FYSTART] DATETIME NULL,
    [FYEND] DATETIME NULL,
    [COSTCODE] SMALLINT NULL,
    [ORGBRANCH] VARCHAR(10) NULL,
    [LNO] SMALLINT NOT NULL DEFAULT ((0))
);

GO

-- --------------------------------------------------
-- TABLE dbo.RecPay_Table_Tmp
-- --------------------------------------------------
CREATE TABLE [dbo].[RecPay_Table_Tmp]
(
    [SRNO] INT NULL,
    [VVDT] VARCHAR(10) NULL,
    [EEDT] VARCHAR(10) NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [DRCR] VARCHAR(1) NULL,
    [AMOUNT] MONEY NULL,
    [NARRATION] VARCHAR(500) NULL,
    [BRANCHCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sachin1
-- --------------------------------------------------
CREATE TABLE [dbo].[sachin1]
(
    [vno] VARCHAR(12) NULL,
    [vtyp] SMALLINT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sacmast
-- --------------------------------------------------
CREATE TABLE [dbo].[sacmast]
(
    [Acname] VARCHAR(100) NULL,
    [Longname] VARCHAR(100) NULL,
    [Actyp] CHAR(10) NULL,
    [Accat] CHAR(10) NULL,
    [Familycd] CHAR(10) NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Accdtls] CHAR(35) NULL,
    [Grpcode] CHAR(13) NULL,
    [Booktype] CHAR(4) NULL,
    [Micrno] VARCHAR(10) NULL,
    [Branchcode] VARCHAR(10) NULL,
    [Btobpayment] INT NULL,
    [Paymode] CHAR(1) NULL,
    [Pobankname] VARCHAR(50) NULL,
    [Pobranch] VARCHAR(25) NULL,
    [Pobankcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SEBIINSP_glgrp
-- --------------------------------------------------
CREATE TABLE [dbo].[SEBIINSP_glgrp]
(
    [grpcode] VARCHAR(25) NULL,
    [cltcode] VARCHAR(25) NULL,
    [GRPNAME] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sebiinsp_GlMerge
-- --------------------------------------------------
CREATE TABLE [dbo].[sebiinsp_GlMerge]
(
    [segment] VARCHAR(10) NULL,
    [Cltcode] VARCHAR(10) NULL,
    [Grpcode] VARCHAR(10) NULL,
    [Grpname] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sebiinsp_narr
-- --------------------------------------------------
CREATE TABLE [dbo].[sebiinsp_narr]
(
    [vtyp] VARCHAR(2) NULL,
    [vno] VARCHAR(15) NULL,
    [narration] VARCHAR(234) NULL,
    [REV_VTYP] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sebiinsp_sbnameswap
-- --------------------------------------------------
CREATE TABLE [dbo].[sebiinsp_sbnameswap]
(
    [segment] VARCHAR(10) NULL,
    [sbcode] VARCHAR(10) NULL,
    [Cltcode] VARCHAR(10) NULL,
    [New_Sbcode] VARCHAR(10) NULL,
    [sbname] VARCHAR(100) NULL,
    [new_cltcode] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sebiinsp_sbnameswap_1
-- --------------------------------------------------
CREATE TABLE [dbo].[sebiinsp_sbnameswap_1]
(
    [cltcode] VARCHAR(10) NULL,
    [sbname] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Selection_Levels_PartyLedger
-- --------------------------------------------------
CREATE TABLE [dbo].[Selection_Levels_PartyLedger]
(
    [Level_No] SMALLINT NULL,
    [Level_Name] VARCHAR(20) NULL,
    [Enable_Flg] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SELECTION_QUERIES_TABLE
-- --------------------------------------------------
CREATE TABLE [dbo].[SELECTION_QUERIES_TABLE]
(
    [SRNO] SMALLINT NOT NULL,
    [STATUSID] VARCHAR(15) NOT NULL,
    [SELECTON] VARCHAR(15) NOT NULL,
    [SELECTIONQUERY] VARCHAR(500) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SMULTIBANKID
-- --------------------------------------------------
CREATE TABLE [dbo].[SMULTIBANKID]
(
    [Srno] INT NOT NULL,
    [Cltcode] VARCHAR(10) NOT NULL,
    [Bankid] VARCHAR(20) NULL,
    [Accno] VARCHAR(20) NULL,
    [Acctype] VARCHAR(7) NOT NULL,
    [Chequename] VARCHAR(100) NOT NULL,
    [Defaultbank] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sureshhh
-- --------------------------------------------------
CREATE TABLE [dbo].[sureshhh]
(
    [Costname] CHAR(35) NOT NULL,
    [Costcode] SMALLINT NOT NULL,
    [Catcode] SMALLINT NOT NULL,
    [Grpcode] VARCHAR(20) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.sysdiagrams
-- --------------------------------------------------
CREATE TABLE [dbo].[sysdiagrams]
(
    [name] NVARCHAR(128) NOT NULL,
    [principal_id] INT NOT NULL,
    [diagram_id] INT IDENTITY(1,1) NOT NULL,
    [version] INT NULL,
    [definition] VARBINARY(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_GLReport
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_GLReport]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [booktype] CHAR(2) NULL,
    [voudt] VARCHAR(10) NULL,
    [effdt] VARCHAR(10) NULL,
    [shortdesc] CHAR(6) NOT NULL,
    [dramt] MONEY NULL,
    [cramt] MONEY NULL,
    [vno] VARCHAR(12) NULL,
    [narration] VARCHAR(234) NULL,
    [ddno] VARCHAR(15) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [longname] VARCHAR(100) NULL,
    [vdt] DATETIME NULL,
    [vtyp] SMALLINT NOT NULL,
    [accat] CHAR(2) NULL,
    [opbal] MONEY NOT NULL,
    [crosac] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(100) NULL,
    [branchcode] VARCHAR(10) NULL,
    [ProcID] BIGINT NULL,
    [RepDate] VARCHAR(8) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_GLReport_New
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_GLReport_New]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [booktype] CHAR(2) NULL,
    [voudt] VARCHAR(10) NULL,
    [effdt] VARCHAR(10) NULL,
    [shortdesc] CHAR(6) NOT NULL,
    [dramt] MONEY NULL,
    [cramt] MONEY NULL,
    [vno] VARCHAR(12) NULL,
    [narration] VARCHAR(234) NULL,
    [ddno] VARCHAR(15) NULL,
    [cltcode] VARCHAR(10) NOT NULL,
    [longname] VARCHAR(100) NULL,
    [vdt] DATETIME NULL,
    [vtyp] SMALLINT NOT NULL,
    [accat] CHAR(2) NULL,
    [opbal] MONEY NOT NULL,
    [crosac] VARCHAR(10) NOT NULL,
    [acname] VARCHAR(100) NULL,
    [branchcode] VARCHAR(10) NULL,
    [ProcID] BIGINT NULL,
    [RepDate] VARCHAR(8) NULL,
    [MainCode] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_MASTER_PARTYLEDGER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_MASTER_PARTYLEDGER]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [StatusId] VARCHAR(25) NULL,
    [ReportName] VARCHAR(200) NULL,
    [SummaryOpt] VARCHAR(1) NULL,
    [CallingSP] VARCHAR(100) NULL,
    [ReturnFields] VARCHAR(1000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_OppBalance
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_OppBalance]
(
    [SrNo] BIGINT IDENTITY(1,1) NOT NULL,
    [cltCode] VARCHAR(10) NULL,
    [OppBal] MONEY NULL,
    [ProcID] BIGINT NULL,
    [RepDate] VARCHAR(8) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_CMS_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_CMS_DATA]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [BANKCODE] NVARCHAR(50) NULL,
    [ROWTYPE] NVARCHAR(50) NULL,
    [VALUEDATE] DATETIME NULL,
    [DRCR] NVARCHAR(50) NULL,
    [INST_NO_CHECK] NVARCHAR(50) NULL,
    [INST_AMT] DECIMAL(20, 2) NULL,
    [DRAWER_NAME] NVARCHAR(250) NULL,
    [CLTCODE] NVARCHAR(50) NULL,
    [CLTACCNO] NVARCHAR(50) NULL,
    [VNO] NVARCHAR(20) NULL,
    [VTYP] NVARCHAR(20) NULL,
    [BOOKTYPE] NVARCHAR(20) NULL,
    [MATCHEDFLAG] BIT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADEDDATE] NVARCHAR(50) NULL,
    [MODIFIEDDATE] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [CROSS_NO] INT NULL,
    [MATCHCODE] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_FILE2
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_FILE2]
(
    [fld_party_code] VARCHAR(15) NULL,
    [bank_name] VARCHAR(255) NULL,
    [branch_name] VARCHAR(255) NULL,
    [fld_bank_acno] VARCHAR(22) NULL,
    [BANKID] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_mcd
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_mcd]
(
    [cltcode] VARCHAR(10) NOT NULL,
    [amt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TEMP_NONCMS_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TEMP_NONCMS_DATA]
(
    [SRNONCMS] INT IDENTITY(1,1) NOT NULL,
    [UPLOADID] NVARCHAR(50) NULL,
    [BANKACCOUNT] NVARCHAR(50) NULL,
    [BANKCODE] NVARCHAR(50) NULL,
    [DESCRIPTION] NVARCHAR(150) NULL,
    [LEDGERBALANCE] NVARCHAR(50) NULL,
    [DRCR] NVARCHAR(50) NULL,
    [AMT] DECIMAL(20, 2) NULL,
    [VALUEDATE] NVARCHAR(50) NULL,
    [REFERENCENO] NVARCHAR(50) NULL,
    [CLTACCOUNT] NVARCHAR(50) NULL,
    [CUSTOMERREFERENCE] NVARCHAR(150) NULL,
    [TRANSACTIONDETAIL] NVARCHAR(200) NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYP] INT NULL,
    [BOOKTYPE] VARCHAR(3) NULL,
    [MATCHEDFLAG] BIT NULL,
    [UPLOADSTATUS] NVARCHAR(50) NULL,
    [UPLOADEDDATE] DATETIME NULL,
    [MODIFIEDDATE] DATETIME NULL,
    [UPLOADBY] NVARCHAR(50) NULL,
    [BOOKDATE] NVARCHAR(50) NULL,
    [CROSS_NO] INT NULL,
    [MATCHCODE] INT NULL,
    [CLOSINGBALANCE] DECIMAL(18, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.temp_notin_multi1
-- --------------------------------------------------
CREATE TABLE [dbo].[temp_notin_multi1]
(
    [fld_party_code] VARCHAR(15) NULL,
    [bank_name] VARCHAR(255) NULL,
    [branch_name] VARCHAR(255) NULL,
    [fld_bank_acno] VARCHAR(22) NULL,
    [BANKID] NUMERIC(18, 0) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tempbilldetails
-- --------------------------------------------------
CREATE TABLE [dbo].[Tempbilldetails]
(
    [Exchange] CHAR(10) NULL,
    [Party_code] VARCHAR(25) NULL,
    [Sett_no] VARCHAR(25) NULL,
    [Sett_type] CHAR(10) NULL,
    [Drcr] CHAR(1) NULL,
    [Billamount] MONEY NULL,
    [Balamt] MONEY NULL,
    [Payamount] MONEY NULL,
    [Sessionid] VARCHAR(50) NULL,
    [Rowid] DECIMAL(4, 0) NULL,
    [Billlno] DECIMAL(4, 0) NULL,
    [Date] DATETIME NULL,
    [Description] VARCHAR(20) NULL,
    [Billbooktype] CHAR(2) NULL,
    [Billvtype] SMALLINT NULL,
    [Booktype] CHAR(2) NULL,
    [Vtype] VARCHAR(50) NULL,
    [Billvno] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Templedger2
-- --------------------------------------------------
CREATE TABLE [dbo].[Templedger2]
(
    [Category] VARCHAR(20) NULL,
    [Branch] VARCHAR(25) NULL,
    [Paidamt] MONEY NULL,
    [Vtype] VARCHAR(2) NULL,
    [Vno] VARCHAR(25) NULL,
    [Lno] INT NULL,
    [Drcr] CHAR(1) NULL,
    [Costcode] INT NULL,
    [Booktype] CHAR(2) NULL,
    [Sessionid] VARCHAR(15) NULL,
    [Party_code] VARCHAR(25) NULL,
    [Costflag] CHAR(1) NULL,
    [Rowid] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temppartybalances1
-- --------------------------------------------------
CREATE TABLE [dbo].[Temppartybalances1]
(
    [Cltcode] VARCHAR(10) NULL,
    [Balancedate] DATETIME NULL,
    [Balance] MONEY NULL,
    [Sessionid] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TMP_VNO
-- --------------------------------------------------
CREATE TABLE [dbo].[TMP_VNO]
(
    [LASTVNO] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.USERRIGHTS
-- --------------------------------------------------
CREATE TABLE [dbo].[USERRIGHTS]
(
    [UserCategory] VARCHAR(50) NULL,
    [UserStatusId] VARCHAR(25) NULL,
    [vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [NoDays] INT NULL,
    [NoDaysD] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.userrights_log
-- --------------------------------------------------
CREATE TABLE [dbo].[userrights_log]
(
    [UserCategory] VARCHAR(50) NULL,
    [UserStatusId] VARCHAR(25) NULL,
    [vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [NoDays] INT NULL,
    [NoDaysD] INT NULL,
    [Activity_date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Userwritestable
-- --------------------------------------------------
CREATE TABLE [dbo].[Userwritestable]
(
    [Usercategory] VARCHAR(50) NULL,
    [Userstatusid] VARCHAR(25) NULL,
    [Vtyp] INT NULL,
    [Booktype] CHAR(2) NULL,
    [Nodays] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LastVno
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LastVno]
(
    [FldAuto] BIGINT IDENTITY(1,1) NOT NULL,
    [Vtyp] SMALLINT NULL,
    [Booktype] VARCHAR(2) NULL,
    [Vdt] SMALLDATETIME NULL,
    [Lastvno] VARCHAR(12) NULL,
    [VnoFlag] TINYINT NULL,
    [FinYear] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_OFFLINE_CC_ENTRIES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_OFFLINE_CC_ENTRIES]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [VOLE_REFNO] BIGINT NOT NULL,
    [SNO] INT NULL,
    [CREDITAMT] MONEY NULL,
    [DEBITAMT] MONEY NULL,
    [CLTCODE] VARCHAR(10) NULL,
    [BRANCHCODE] VARCHAR(10) NULL,
    [CATCODE] VARCHAR(35) NULL,
    [COSTCODE] VARCHAR(35) NULL,
    [ADDBY] VARCHAR(25) NULL,
    [STATUSID] VARCHAR(25) NULL,
    [STATUSNAME] VARCHAR(25) NULL,
    [ADDDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_PAYOUT_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_PAYOUT_TEMP]
(
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [ACCODE] VARCHAR(50) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [AMT] MONEY NULL,
    [DRCR] CHAR(1) NULL,
    [BNKCODE] VARCHAR(10) NULL,
    [BNKNAME] VARCHAR(50) NULL,
    [DDNO] VARCHAR(15) NULL,
    [BRCODE] VARCHAR(25) NULL,
    [NARRATION] VARCHAR(500) NULL,
    [PAYMODE] VARCHAR(4) NULL,
    [SRNO] INT NULL,
    [BRANCHCODE] VARCHAR(25) NULL,
    [MICRNO] INT NULL,
    [BOOKTYPE] CHAR(4) NULL,
    [ACCDTLS] CHAR(35) NULL,
    [LNO] SMALLINT NOT NULL,
    [COSTCODE] SMALLINT NULL,
    [BANKCOST] SMALLINT NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYP] SMALLINT NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL,
    [SESSIONID] VARCHAR(50) NULL,
    [LEDGER2_UPD] CHAR(1) NOT NULL,
    [REMARK] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_PAYOUTCLIENT
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_PAYOUTCLIENT]
(
    [CLTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_SEBIPAYOUT_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_SEBIPAYOUT_TEMP]
(
    [VDT] DATETIME NULL,
    [EDT] DATETIME NULL,
    [ACCODE] VARCHAR(50) NULL,
    [ACNAME] VARCHAR(100) NULL,
    [AMT] MONEY NULL,
    [DRCR] CHAR(1) NULL,
    [BNKCODE] VARCHAR(10) NULL,
    [BNKNAME] VARCHAR(50) NULL,
    [DDNO] VARCHAR(15) NULL,
    [BRCODE] VARCHAR(25) NULL,
    [NARRATION] VARCHAR(500) NULL,
    [PAYMODE] VARCHAR(25) NULL,
    [SRNO] INT NULL,
    [BRANCHCODE] VARCHAR(25) NULL,
    [MICRNO] INT NULL,
    [BOOKTYPE] CHAR(4) NULL,
    [ACCDTLS] CHAR(35) NULL,
    [LNO] SMALLINT NOT NULL,
    [COSTCODE] SMALLINT NULL,
    [BANKCOST] SMALLINT NULL,
    [VNO] VARCHAR(12) NULL,
    [VTYP] SMALLINT NULL,
    [UPDFLAG] VARCHAR(1) NOT NULL,
    [SESSIONID] VARCHAR(50) NULL,
    [LEDGER2_UPD] CHAR(1) NOT NULL,
    [REMARK] VARCHAR(234) NULL,
    [ACCNO] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_UPLOADED_FILES
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_UPLOADED_FILES]
(
    [U_SNO] INT IDENTITY(1,1) NOT NULL,
    [U_FILENAME] VARCHAR(500) NULL,
    [U_PATHNAME] VARCHAR(500) NULL,
    [U_RECORDS] INT NULL,
    [U_STATUS] VARCHAR(2) NULL,
    [U_DATE] DATETIME NULL,
    [U_UNAME] VARCHAR(25) NULL,
    [U_MODULE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vishal123
-- --------------------------------------------------
CREATE TABLE [dbo].[vishal123]
(
    [vno] VARCHAR(12) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMAIN
-- --------------------------------------------------
CREATE TABLE [dbo].[VMAIN]
(
    [VTYPE] VARCHAR(2) NULL,
    [VPATH] VARCHAR(100) NULL,
    [SINGLEVOUCHER] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Vmast
-- --------------------------------------------------
CREATE TABLE [dbo].[Vmast]
(
    [Vtype] SMALLINT NOT NULL,
    [Vdesc] VARCHAR(35) NOT NULL,
    [Shortdesc] CHAR(6) NULL,
    [Dispflag] CHAR(1) NULL,
    [Narration] VARCHAR(234) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VW_V2_TBL_COLLATERAL_MARGIN_ALL_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[VW_V2_TBL_COLLATERAL_MARGIN_ALL_DATA]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [EFFDATE] DATETIME NULL,
    [CASH_NCASH] VARCHAR(2) NULL,
    [RMS_FINALAMOUNT] MONEY NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [SEGMENT] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TRIGGER dbo.LASTVNO_UP
-- --------------------------------------------------
create TRIGGER [DBO].[LASTVNO_UP] ON [DBO].[LASTVNO] 
FOR UPDATE
AS
DECLARE @OLD VARCHAR(100),
	    @NEW VARCHAR(100)
SELECT @OLD = LASTVNO FROM DELETED
SELECT @NEW = LASTVNO FROM INSERTED

IF @NEW IS NULL OR @NEW = '' 
 BEGIN 
	UPDATE L SET L.LASTVNO = D.LASTVNO FROM LASTVNO L, DELETED D
	WHERE L.VTYP = D.VTYP AND L.BOOKTYPE = D.BOOKTYPE AND L.VDT = D.VDT 
	
	INSERT INTO Audit_LASTVNO_TRG
			(VTYP,BOOKTYPE,VDT,LASTVNO,UserName,COMP_NAME,DBACTION,APPLICATION	)
			SELECT VTYP,BOOKTYPE,VDT,LASTVNO,UserName=SUSER_SNAME(),COMP_NAME = HOST_NAME(),DBACTION = 'DELETED',APPLICATION = APP_NAME()
			FROM deleted
 END

GO

-- --------------------------------------------------
-- TRIGGER dbo.Ledger_DEL
-- --------------------------------------------------


CREATE TRIGGER [dbo].[Ledger_DEL] ON [dbo].[ledger]     
FOR DELETE     
AS    
INSERT INTO Ledger_TRIG    
SELECT *, HOST_NAME(), GETDATE(), 'DELETED' FROM DELETED

GO

-- --------------------------------------------------
-- TRIGGER dbo.Ledger_MOD
-- --------------------------------------------------

    
CREATE TRIGGER [dbo].[Ledger_MOD] ON [dbo].[ledger]     
FOR UPDATE    
AS    
INSERT INTO Ledger_TRIG    
SELECT *, HOST_NAME(), GETDATE(), 'MODIFIED' FROM DELETED

GO

-- --------------------------------------------------
-- VIEW dbo.ACC_LEDGER_MASTER
-- --------------------------------------------------


CREATE VIEW [dbo].[ACC_LEDGER_MASTER]
AS
SELECT
	EXCHANGE = O.EXCHANGE,
	SEGMENT = O.SEGMENT,
	L.VNO,
	VTYPE = L.VTYP,
	L.BOOKTYPE,
	L.VDT,
	VDT_C = CONVERT(VARCHAR(10), L.VDT, 103),
	P.SDTCUR,
	P.LDTCUR,
	MKCKFLAG = '4',
	VNO_MK = L.VNO,
	MASTERSNO = 0,
	REMARK = '',
	REFSNO = L.REFNO,
	POSTED_ON = L.PDT,
	POSTED_BY = L.ENTEREDBY,
	CHECKED_ON = L.CDT,
	CHECKED_BY = L.CHECKEDBY,
	ENTRY_AMT = 0,
	SOURCE_MODULE = '',
	ENTRY_TYPE = 'N',
	SETT_NO = '',
	SETT_TYPE = '',
	BILL_NO = '',
	SELL_BUY = '',
	LOCK_FLAG = CONVERT(BIT, 0),
	DISPLAY_FLAG = CONVERT(BIT, 1),
	L.EDT,
	EDT_C = CONVERT(VARCHAR(10), L.EDT, 103),
	DRAMOUNT = CASE WHEN L.DRCR = 'D' THEN L.VAMT ELSE 0 END,
	CRAMOUNT = CASE WHEN L.DRCR = 'C' THEN L.VAMT ELSE 0 END,
	L.CLTCODE,
	A.ACNAME,
	A.ACCAT,
	--MAINLEDGER = ISNULL(M.MCLTCODE, L.CLTCODE),
	--MAINLEDGERNAME = ISNULL(M.ACNAME, A.ACNAME),
	--MAINACCAT = ISNULL(M.ACCAT, A.ACCAT),
	L.NARRATION,
	L.BALAMT,
	A.BRANCHCODE,
	REFCODE = A.BRANCHCODE,
	OPPACCOUNT = CASE WHEN L.VTYP IN (1,2,3,4) THEN (SELECT TOP 1 IL.CLTCODE FROM LEDGER IL, ACMAST IA WHERE IL.CLTCODE = IA.CLTCODE AND IA.ACCAT IN (1, 2) AND IL.VNO = L.VNO AND IL.VTYP = L.VTYP AND IL.BOOKTYPE = L.BOOKTYPE) ELSE '' END,
	CURRENCY = '',
	BNKNAME = ISNULL(L1.BNKNAME, ''),
	BRNNAME = ISNULL(L1.BRNNAME, ''),
	CHQDD = ISNULL(L1.DD, ''),
	INSTNO = ISNULL(L1.DDNO, ''),
	INSTDATE = ISNULL(L1.DDDT, ''),
	INSTDATE_C = CONVERT(VARCHAR(10), ISNULL(L1.DDDT, ''), 103),
	DR_RELDT = ISNULL(L1.RELDT, ''),
	CR_RELDT = ISNULL(L1.RELDT, ''),
	DR_RELDT_C = CONVERT(VARCHAR(10), L1.RELDT, 103),
	CR_RELDT_C = CONVERT(VARCHAR(10), L1.RELDT, 103),
	DR_RELAMT = ISNULL(L1.RELAMT, 0),
	CR_RELAMT = ISNULL(L1.RELAMT, 0),
	DR_REFNO = ISNULL(L1.REFNO, 0),
	CR_REFNO = ISNULL(L1.REFNO, 0),
	DR_MICRNO = ISNULL(L1.MICRNO, 0),
	CR_MICRNO = ISNULL(L1.MICRNO, 0),
	RECEIPTNO = ISNULL(L1.RECEIPTNO, 0),
	SLIP_NO = ISNULL(L1.SLIPNO, 0),
	SLIP_DATE = ISNULL(L1.SLIPDATE, ''),
	CHQINNAME = ISNULL(L1.CHEQUEINNAME, ''),
	CHQPRINTED = ISNULL(L1.CHQPRINTED, 0),
	CLEARMODE = ISNULL(L1.CLEAR_MODE, ''),
	V.VDESC,
	V.SHORTDESC
FROM
	LEDGER L
		LEFT JOIN LEDGER1 L1 ON (L.VNO = L1.VNO AND L.VTYP = L1.VTYP AND L.BOOKTYPE = L1.BOOKTYPE)
		/*LEFT JOIN (SELECT ML.VNO, ML.VTYP, ML.BOOKTYPE, ML.MCLTCODE, MA.ACCAT, MA.ACNAME FROM MARGINLEDGER ML INNER JOIN ACMAST MA ON (ML.MCLTCODE = MA.CLTCODE)) M ON (L.VNO = M.VNO AND L.VTYP = M.VTYP AND L.BOOKTYPE = M.BOOKTYPE)*/
	INNER JOIN VMAST V ON (L.VTYP = V.VTYPE)
	INNER JOIN ACMAST A ON (L.CLTCODE = A.CLTCODE),
	PARAMETER P,
	OWNER O
WHERE
	L.VDT BETWEEN P.SDTCUR AND P.LDTCUR/*
ORDER BY
	L.BOOKTYPE,
	L.VTYP,
	L.VNO
*/

GO

-- --------------------------------------------------
-- VIEW dbo.ACCOUNTCURFO_LEDGER_VIEW
-- --------------------------------------------------

CREATE VIEW ACCOUNTCURFO_LEDGER_VIEW AS  
  
SELECT * FROM ACCOUNTMCDXCDS.DBO.LEDGER (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.BVCLIENT1
-- --------------------------------------------------
CREATE VIEW BVCLIENT1  
AS  
SELECT * FROM [MCDXCDS].[DBO].[CLIENT1]

GO

-- --------------------------------------------------
-- VIEW dbo.BVledger
-- --------------------------------------------------
CREATE view [dbo].[BVledger] as  
select * from ledger where vtyp in('2','3', '17', '5')

GO

-- --------------------------------------------------
-- VIEW dbo.BVledger1
-- --------------------------------------------------

CREATE view [dbo].[BVledger1] as  
select * from ledger1 where vtyp in('2','3', '17', '5')

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT_DETAILS
-- --------------------------------------------------


CREATE VIEW CLIENT_DETAILS
AS

SELECT * FROM ANAND1.MSAJAG.DBO.CLIENT_DETAILS

GO

-- --------------------------------------------------
-- VIEW dbo.CLS_MULTIBANKID_RECO_VW
-- --------------------------------------------------

CREATE VIEW [dbo].[CLS_MULTIBANKID_RECO_VW]
AS
SELECT DISTINCT CLTCODE AS 'CLTCODE',ACCNO AS 'ACCNO' FROM ACCOUNT.DBO.CLS_MULTIBANKID_RECO

GO

-- --------------------------------------------------
-- VIEW dbo.COMPANY_MASTER_SETTING
-- --------------------------------------------------

CREATE VIEW [dbo].[COMPANY_MASTER_SETTING] 
AS
 
SELECT 
	A.EXCHANGE, A.SEGMENT, A.EXCHANGE + ' ' + A.SEGMENT AS EXCHSEG FROM PRADNYA.DBO.MULTICOMPANY A , .DBO.OWNER B
WHERE 
	A.SEGMENT = B.SEGMENT 
	AND A.EXCHANGE = B.EXCHANGE

GO

-- --------------------------------------------------
-- VIEW dbo.DPC_MASTER_SETTING
-- --------------------------------------------------
CREATE VIEW DPC_MASTER_SETTING
AS
SELECT * FROM anand1.account.DBO.DPC_MASTER_SETTING

GO

-- --------------------------------------------------
-- VIEW dbo.EXISTS_RECORDS_VW
-- --------------------------------------------------

CREATE VIEW [dbo].[EXISTS_RECORDS_VW] 
AS
SELECT * FROM ACCOUNT..EXISTS_RECORDS
UNION ALL
SELECT * FROM ACCOUNT_AB..EXISTS_RECORDS
UNION ALL
SELECT * FROM ACCOUNTCURFO..EXISTS_RECORDS
UNION ALL
SELECT * FROM ACCOUNTFO..EXISTS_RECORDS
UNION ALL
SELECT * FROM ACCOUNTMCDX..EXISTS_RECORDS
UNION ALL
SELECT * FROM ACCOUNTMCDXCDS..EXISTS_RECORDS
UNION ALL
SELECT * FROM ACCOUNTNCDX..EXISTS_RECORDS

GO

-- --------------------------------------------------
-- VIEW dbo.FAMILYMST
-- --------------------------------------------------

/*
	SELECT * FROM FAMILYMST
*/
CREATE VIEW FAMILYMST
AS
SELECT 
--	C.CL_CODE, 
--	C.SHORT_NAME, 
	F.FAMILY,
	C.LONG_NAME AS FAMILYNAME
/*	C.L_ADDRESS1, 
	C.L_ADDRESS2, 
	C.L_CITY, 
	C.L_STATE, 
	C.L_NATION, 
	C.L_ZIP,
	FAX, 
	C.RES_PHONE1, 
	C.RES_PHONE2, 
	C.OFF_PHONE1, 
	C.OFF_PHONE2, 
	C.EMAIL, 
	C.BRANCH_CD, 
	C.CREDIT_LIMIT, 
	C.CL_TYPE, 
	C.CL_STATUS, 
	C.GL_CODE, 
	C.FD_CODE, */
/*	C.PENALTY, 
	C.SUB_BROKER, 
	C.CONFIRM_FAX, 
	C.PHONEOLD, 
	C.L_ADDRESS3, 
	C.MOBILE_PAGER, 
	C.PAN_GIR_NO, 
	C.TRADER, 
	C.WARD_NO, 
	C.REGION, 
	C.AREA, 
	C.CLRATING */
FROM MSAJAG.DBO.CLIENT1 C, 
	(
	SELECT DISTINCT 
		FAMILY 
	FROM MSAJAG.DBO.CLIENT1
	) 
	F 
WHERE C.CL_CODE = F.FAMILY

GO

-- --------------------------------------------------
-- VIEW dbo.FILEDATA_BANKRECO
-- --------------------------------------------------


CREATE VIEW [dbo].[FILEDATA_BANKRECO]
AS 
SELECT * FROM MSAJAG..FILEDATA

GO

-- --------------------------------------------------
-- VIEW dbo.ledger_SEBI
-- --------------------------------------------------
CREATE View ledger_SEBI    
as    
  
select   
Vtyp,Vno,Edt,Lno,Acname,Drcr,  
Vamt=convert(money,case when cltcode='A16829' and vtyp=18 and vdt='Apr  1 2012' then vamt+246915.00 else vamt end),  
Vdt,Vno1,Refno,Balamt,Nodays,Cdt,Cltcode,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration  
from  
(  
select     
a.Vtyp,a.Vno,Edt,Lno,    
Acname=case when cltcode='590002' then 'BROKERAGE REALISED' else acname end    
,Drcr,Vamt,Vdt,Vno1,Refno,Balamt,Nodays,Cdt,    
Cltcode=case when cltcode='590002' then '99890' else cltcode end,Booktype,Enteredby,Pdt,Checkedby,Actnodays,Narration    
from ledger a with (nolock)     
left outer join Vw_Vdet_SEBI b on a.vno=b.vno and a.vtyp=b.vtyp where b.vtyp is null     
union all  
select * from A16829_SEBI  
) x

GO

-- --------------------------------------------------
-- VIEW dbo.Ledgerdrcr
-- --------------------------------------------------
Create View Dbo.Ledgerdrcr  
As  
Select Sum(vamt) As Totalamount, Drcr  
From Ledger  
Group By Drcr

GO

-- --------------------------------------------------
-- VIEW dbo.ledgermismatch
-- --------------------------------------------------
  
  
CREATE view  [dbo].[ledgermismatch]  
as  
select vtyp, vno, debit = ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'D'),  
credit = ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'C'),  
balance = ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'D')  
          - ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'C')  
from ledger l1  
group by vtyp, vno  
having ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'D') <> ( select isnull(sum(vamt),0) from ledger l2 where l2.vtyp = l1.vtyp and l2.vno = l1.vno and l2.drcr = 'C')

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_BANK_FILEUPLOAD_LOGS_VIEW
-- --------------------------------------------------
CREATE VIEW [dbo].[RECON_BANK_FILEUPLOAD_LOGS_VIEW]
AS
SELECT * FROM ACCOUNT..RECON_BANK_FILEUPLOAD_LOGS

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_BANK_FILEUPLOAD_LOGS_VW
-- --------------------------------------------------

CREATE VIEW [dbo].[RECON_BANK_FILEUPLOAD_LOGS_VW]
AS
SELECT * FROM ACCOUNT..RECON_BANK_FILEUPLOAD_LOGS 
UNION ALL 
SELECT * FROM ACCOUNT_AB..RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ACCOUNTFO..RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ACCOUNTCURFO..RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ACCOUNTMCDXCDS..RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ACCOUNTMCDX..RECON_BANK_FILEUPLOAD_LOGS
UNION ALL 
SELECT * FROM ACCOUNTNCDX..RECON_BANK_FILEUPLOAD_LOGS

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_BANK_MASTER_VW
-- --------------------------------------------------


CREATE VIEW [dbo].[RECON_BANK_MASTER_VW] 
AS
SELECT * FROM   ACCOUNT..RECON_BANK_MASTER (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_BANK_MASTER_VW_F2
-- --------------------------------------------------

CREATE VIEW [DBO].[RECON_BANK_MASTER_VW_F2] 
AS
SELECT DISTINCT SEGMENT ,BANKNAME,BANKCODE FROM   ACCOUNT..RECON_BANK_MASTER (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_EXCLUDE_MASTER_VW
-- --------------------------------------------------
CREATE VIEW RECON_EXCLUDE_MASTER_VW
AS
SELECT * FROM ACCOUNT..RECON_EXCLUDE_MASTER

GO

-- --------------------------------------------------
-- VIEW dbo.RECON_REPORT_STATUS_VW
-- --------------------------------------------------

CREATE VIEW [dbo].[RECON_REPORT_STATUS_VW]
AS
SELECT * FROM ACCOUNT..RECON_REPORT_STATUS

GO

-- --------------------------------------------------
-- VIEW dbo.rpt_chequelist
-- --------------------------------------------------

/****** Object:  View dbo.rpt_chequelist    Script Date: 10/6/2001 11:56:32 AM ******/

CREATE view rpt_chequelist as

select l.acname,l.cltcode,l.drcr,l1.ddno,l.vamt,vdt= left(convert(varchar,l.vdt,109),11),edt=left(convert(varchar,l.edt,109),11),
reldt= Case When  (Reldt = '1900-01-01 00:00:00.000'   or   reldt > GetDate() ) Then 'Unrealized' else left(convert(varchar,RelDt,109),11) end,
l1.bnkname,l1.brnname,
nar = (case when (select narr from ledger3 where vtyp = l.vtyp and vno=l.vno and naratno = l.lno) is not null
            then (select narr from ledger3 where vtyp = l.vtyp and vno=l.vno and naratno = l.lno)
	    else (select narr from ledger3 where vtyp = l.vtyp and vno=l.vno)
            end),l.vno,l.vtyp	
 from ledger l,ledger1 l1 where l.vtyp=l1.vtyp and l.vno=l1.vno and l.lno = l1.lno

GO

-- --------------------------------------------------
-- VIEW dbo.sacmast_view
-- --------------------------------------------------
CREATE view sacmast_view          
as          
      
select upper(a.aname) as acname,upper(a.lname) as longname,a.actyp,        
(case when b.grpcode is not null then 4 else a.accat end) as accat,      
a.familycd,a.cltcode,a.accdtls,a.grpcode,a.BookType,a.MicrNo,        
a.branchcode,a.Btobpayment,a.Paymode,a.Pobankname,a.Pobranch,a.Pobankcode,          
isnull(b.grpcode,'SDrCrBal') as bgrpcode,          
isnull(b.grpname,'SUNDRY DEBTORS/ CREDITORS BAL') as bgrpname          
from (select x.*,aname=isnull(y.sbname,x.acname),lname=isnull(y.sbname,x.longname) from acmast x left outer join sebiinsp_sbnameswap y on x.cltcode=y.cltcode)a left outer join sebiinsp_glgrp b          
on a.cltcode=b.cltcode

GO

-- --------------------------------------------------
-- VIEW dbo.SEBIINSP_NTS
-- --------------------------------------------------
create view SEBIINSP_NTS
as
select * from  angelfo.accountfo.dbo.SEBIINSP_GblNTS with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.sebiinsp_sbnameswap_view
-- --------------------------------------------------
create view sebiinsp_sbnameswap_view  
as   
select a.*,branchcode FROM sebiinsp_sbnameswap a with (nolock) left outer join acmast b with (nolock)    
on a.cltcode=b.cltcode

GO

-- --------------------------------------------------
-- VIEW dbo.sledger_view
-- --------------------------------------------------


CREATE view sledger_view        
as        
      
select x.vtyp,x.vno,x.edt,x.lno,x.acname,x.drcr,x.vamt,x.vdt,x.vno1,x.refno,x.balamt,x.NoDays,x.cdt,cltcode=isnull(y.grpcode,x.cltcode),      
x.BookType,x.EnteredBy,x.pdt,x.CheckedBy,x.actnodays,NARRATION=
CASE 
WHEN X.NARRATION LIKE '%FORFETIURE%'  
	THEN REPLACE(X.NARRATION,'FORFETIURE','S.FEES')
WHEN X.NARRATION LIKE '%Prepaid%'
	THEN REPLACE(X.NARRATION,'PREPAID','SUBSCRIPTION')
ELSE 
	X.NARRATION
END
from       
(      
SELECT       
a.vtyp,a.vno,a.edt,a.lno,a.acname,a.drcr,a.vamt,a.vdt,a.vno1,a.refno,a.balamt,a.NoDays,a.cdt,      
cltcode=isnull(b.new_cltcode,a.cltcode),a.BookType,a.EnteredBy,a.pdt,a.CheckedBy,a.actnodays,        
narration=        
CASE WHEN ( A.NARRATION LIKE '%'+B.SBCODE+'%'  OR A.NARRATION LIKE '%'+B.SBname+'%') and B.SBCODE is not null        
THEN        
REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(        
(case when narration like '%TDS on share of%' and narration like '%-%' then substring(narration,1,charindex('-',narration,0)-1) else narration end)        
,' '+B.SBCODE+' ',' '+B.new_SBCODE+' '),' of '+branchcode+' ',' '),' '+branchcode+' ',' '),' '+branchcode,' '),'BRANCH','')        
,' 05'+B.SBCODE+' ',' 05'+B.new_SBCODE+' ')        
,' '+B.SBCODE+'1 ',' '+B.new_SBCODE+'1 ')        
ELSE        
a.NARRATION        
END        
FROM        
(  
SELECT * FROM LEDGER WITH (NOLOCK) WHERE CLTCODE NOT LIKE '21%' AND   
CLTCODE NOT IN (select gl_code from angelfo.accountfo.dbo.SEBIINSP_NTS with (nolock)))  
A LEFT OUTER JOIN         
(select * from sebiinsp_sbnameswap_view )B ON B.CLTCODE=a.cltcode         
) x left outer join sebiinsp_GlMerge y on x.cltcode=y.cltcode

GO

-- --------------------------------------------------
-- VIEW dbo.Sledger_Vw_Final
-- --------------------------------------------------
CREATE view Sledger_Vw_Final  
as  
select VTYP=ISNULL(B.REV_VTYP,a.vtyp),a.vno,a.edt,a.lno,a.acname,a.drcr,a.vamt,a.vdt,a.vno1,a.refno,a.balamt,a.NoDays,a.cdt,a.cltcode,a.BookType,a.EnteredBy,a.pdt,a.CheckedBy,a.actnodays,  
narration=isnull(b.narration,a.narration)  
from sledger_view a left outer join sebiinsp_narr b on a.vno=b.vno and a.vtyp=b.vtyp

GO

-- --------------------------------------------------
-- VIEW dbo.V2_CLIENTPROFILES_NEW
-- --------------------------------------------------
CREATE VIEW V2_CLIENTPROFILES_NEW
AS
SELECT * FROM anand1.ACCOUNT.DBO.V2_CLIENTPROFILES_NEW

GO

-- --------------------------------------------------
-- VIEW dbo.vClient1
-- --------------------------------------------------
CREATE view vClient1  
AS  
SELECT * FROM [MSAJAG].[dbo].[Client1]

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_Vdet_SEBI
-- --------------------------------------------------

CREATE View Vw_Vdet_SEBI
as
select a.vno,a.vtyp from     
(select * from ledger where cltcode='99890') a join     
(select * from ledger where cltcode='590002') b on a.vno=b.vno and a.vtyp=b.vtyp and a.vamt=b.vamt
and (case when a.drcr='D' then -a.vamt else +a.vamt end)+(case when b.drcr='D' then -b.vamt else +b.vamt end)=0

GO

