-- DDL Export
-- Server: 10.253.50.28
-- Database: BSECURFO
-- Exported: 2026-01-30T12:37:59.498219

USE BSECURFO;
GO

-- --------------------------------------------------
-- FUNCTION dbo.ConvertDigit
-- --------------------------------------------------

CREATE Function [dbo].[ConvertDigit] ( @MyDigit char(1)) returns varchar(10) 
	as 
	Begin
	 declare @vOutput varchar(8)
	 set @vOutput =  Case @MyDigit
	            when '1' then 'One'
	            when '2' then 'Two'
	            when '3' then 'Three'
	            when '4' then 'Four'
	            when '5' then 'Five'
	            when '6' then 'Six'
	            when '7' then 'Seven'
	            when '8' then 'Eight'
	            when '9' then 'Nine'
        	    Else '' end 
      	Return (@vOutPut)
	End

GO

-- --------------------------------------------------
-- FUNCTION dbo.ConvertHundreds
-- --------------------------------------------------
/*
Print dbo.ConvertHundreds('121')
*/
CREATE Function [dbo].[ConvertHundreds](@MyNumber varchar(3)) returns varchar(200)
as
Begin
	Declare @Result varchar(200)
	set @Result = ''
	-- Exit if there is nothing to convert.
	If convert(int,@MyNumber) <> 0 
	Begin
		--' Append leading zeros to number.
		set @MyNumber = Right('000' + @MyNumber, 3)
		--' Do we have a hundreds place digit to convert?
		If Left(@MyNumber, 1) <> '0' 
		Begin
			set @Result = dbo.ConvertDigit(Left(@MyNumber, 1)) + ' Hundred '
		End
		
		--' Do we have a tens place digit to convert?
		If SubString(@MyNumber, 2, 1) <> '0' 
		Begin
			set @Result = @Result + dbo.ConvertTens(SubString(@MyNumber, 2,2))
		End
		Else
		Begin
			--' If not, then convert the ones place digit.
			set @Result = @Result +  dbo.ConvertDigit(SubString(@MyNumber, 3,1))
		end
		
	End
	return (@Result)
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.ConvertIntoIndianCurEng
-- --------------------------------------------------
/*
Print dbo.ConvertIntoIndianCurEng('500.51')
*/

CREATE Function [dbo].[ConvertIntoIndianCurEng]( @MyNumber varchar(200)) returns varchar(200)
as
Begin
	Declare @Temp varchar(200),
	@Dollars varchar(200), @Cents varchar(100),
	@DecimalPlace int, @Count int , @Return varchar(200)
	
	--' Convert MyNumber to a string, trimming extra spaces.
	set @MyNumber = ltrim(rtrim(@mynumber))
	
	--' Find decimal place.
	set @DecimalPlace = CHARINDEX ('.',@MyNumber)

	set @Cents = ''
	set @Dollars = ''

	--' If we find decimal place...
	If @DecimalPlace > 0 
	Begin
		--' Convert cents
		set @Temp = Left(substring(@MyNumber, @DecimalPlace + 1,2) + '00', 2)
		set @Cents = dbo.ConvertTens(@Temp)
		--' Strip off cents from remainder to convert.
		set @MyNumber = Left(@MyNumber, @DecimalPlace - 1)
	End 

	

	set @Count = 1
	set @Temp = dbo.ConvertHundreds(Right(@MyNumber, 3))


	If @Temp <> '' 
		set @Dollars = @Temp + dbo.Place(@Count) + @Dollars
	
	If Len(@MyNumber) > 3 
		--' Remove last 3 converted digits from MyNumber.
		set @MyNumber = Left(@MyNumber, Len(@MyNumber) - 3)
	Else
		set @MyNumber = ''

	set @Count = @Count + 1

	While @MyNumber <> ''
	Begin
		--' Convert last 2 digits of MyNumber to Indian Rs.
		set @Temp = dbo.ConvertHundreds(Right(@MyNumber, 2))
		If @Temp <> '' 
			set @Dollars = @Temp + dbo.Place(@Count) + @Dollars

		If Len(@MyNumber) > 2 
			--' Remove last 2 converted digits from MyNumber.
			set @MyNumber = Left(@MyNumber, Len(@MyNumber) - 2)
		Else
			set @MyNumber = ''
		set @Count = @Count + 1
	end
	
	--' Clean up Rupees.

	set @Dollars = Case @Dollars
			when '' then 'Zero '
			when 'One' then 'One '
			Else @Dollars + ''
			end 

	
	--' Clean up cents.
	set @Cents  = Case @Cents
			when '' then '' 	--'Cents = " And zero Paise"
			when 'One' then ' And Paisa One '
			Else ' And ' +  'Paise ' + @Cents 
			end 
	

	set @Return =  @Dollars + @Cents + ' Only'
	Return (@Return) 
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.ConvertTens
-- --------------------------------------------------

/*
Print dbo.ConvertTens(13)
*/
CREATE Function [dbo].[ConvertTens] (@MyTens char(2)) returns varchar(15)
  as 
  Begin
  Declare @Result varchar(15)
  
  -- Is value between 10 and 19?
	If Left(@MyTens, 1) = 1 
	Begin
		set  @Result = Case convert(int,(@MyTens))
		when 10 then 'Ten'
		when 11 then 'Eleven'
		when 12 then 'Twelve'
		when 13 then 'Thirteen'
		when 14 then 'Fourteen'
		when 15 then 'Fifteen'
		when 16 then 'Sixteen'
		when 17 then 'Seventeen'
		when 18 then 'Eighteen'
		when 19 then 'Nineteen'
		Else ''
		end 
	End
	Else
	Begin
		--' .. otherwise it's between 20 and 99.
		set  @Result = Case convert(int,Left(@MyTens, 1))
		when 2 then 'Twenty '
		when 3 then 'Thirty '
		when 4 then 'Forty '
		when 5 then 'Fifty '
		when 6 then 'Sixty '
		when 7 then 'Seventy '
		when 8 then 'Eighty '
		when 9 then 'Ninety '
		Else ''
		end 
		set @Result = @Result + dbo.ConvertDigit(Right(@MyTens, 1))
	End


    -- Convert ones place digit.
    
  Return (@Result)
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.DATE_CONVERT
-- --------------------------------------------------

CREATE  FUNCTION [dbo].[DATE_CONVERT](@CHRDATE VARCHAR(8),@INTDATEFORMAT INT)
RETURNS VARCHAR(12)
AS
BEGIN
	DECLARE @RETDDATE  VARCHAR(12)
	IF LEN(@CHRDATE) = 7
	BEGIN
		SET @CHRDATE  = '0' + @CHRDATE
	END
	SET @RETDDATE = LEFT(@CHRDATE,2) + '/'  + SUBSTRING(@CHRDATE,3,2) + '/' + RIGHT(@CHRDATE,4)
	
	IF @INTDATEFORMAT <> 103
	BEGIN
		SET @RETDDATE = LEFT(CONVERT(DATETIME,@RETDDATE,103),11)
	END
	
	RETURN (@RETDDATE)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FN_DATA_DECRYPT
-- --------------------------------------------------



CREATE FUNCTION [dbo].[FN_DATA_DECRYPT]
(
	@KEY	VARCHAR(100),
	@DATA	VARBINARY(8000)
) RETURNS VARCHAR(MAX)
AS
BEGIN
DECLARE @DECRYPT_DATA VARCHAR(MAX)

SELECT @DECRYPT_DATA =  DECRYPTBYKEY(@DATA,1,HASHBYTES(@KEY,CONVERT( VARBINARY, @KEY)))

RETURN @DECRYPT_DATA
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.FN_DATA_ENCRYPT
-- --------------------------------------------------



CREATE FUNCTION [dbo].[FN_DATA_ENCRYPT]
(
	@KEY	VARCHAR(100),
	@DATA	VARCHAR(MAX)
) RETURNS VARBINARY(8000)
AS
BEGIN
DECLARE @ENCRYPT_DATA VARBINARY(8000)

SELECT @ENCRYPT_DATA = ENCRYPTBYKEY(KEY_GUID('Key4CertAutoProcess'),@DATA,1,HASHBYTES(@KEY,CONVERT( VARBINARY, @KEY)))

RETURN @ENCRYPT_DATA
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.fnSplitString2Tbl
-- --------------------------------------------------




CREATE FUNCTION [dbo].[fnSplitString2Tbl] (
      @InputString                  VARCHAR(8000),
      @Delimiter                    VARCHAR(50)
)

RETURNS @Items TABLE (
      Item                          VARCHAR(8000)
)

AS
BEGIN
      IF @Delimiter = ' '
      BEGIN
            SET @Delimiter = ','
            SET @InputString = REPLACE(@InputString, ' ', @Delimiter)
      END

      IF (@Delimiter IS NULL OR @Delimiter = '')
            SET @Delimiter = ','

      DECLARE @Item                 VARCHAR(8000)
      DECLARE @ItemList       VARCHAR(8000)
      DECLARE @DelimIndex     INT

      SET @ItemList = @InputString
      SET @DelimIndex = CHARINDEX(@Delimiter, @ItemList, 0)
      WHILE (@DelimIndex != 0)
      BEGIN
            SET @Item = SUBSTRING(@ItemList, 0, @DelimIndex)
            INSERT INTO @Items VALUES (@Item)

            -- Set @ItemList = @ItemList minus one less item
            SET @ItemList = SUBSTRING(@ItemList, @DelimIndex+1, LEN(@ItemList)-@DelimIndex)
            SET @DelimIndex = CHARINDEX(@Delimiter, @ItemList, 0)
      END -- End WHILE

      IF @Item IS NOT NULL -- At least one delimiter was encountered in @InputString
      BEGIN
            SET @Item = @ItemList
            INSERT INTO @Items VALUES (@Item)
      END

      -- No delimiters were encountered in @InputString, so just return @InputString
      ELSE INSERT INTO @Items VALUES (@InputString)

      RETURN

END -- End Function

GO

-- --------------------------------------------------
-- FUNCTION dbo.FUN_SPLITSTRING
-- --------------------------------------------------



CREATE FUNCTION [dbo].[FUN_SPLITSTRING](
                @SPLITSTRING VARCHAR(1000),
                @DELIMITER   VARCHAR(3))
RETURNS @SPLITTED TABLE (
    [SNO] [INT] IDENTITY(1,1) NOT NULL, 
    [SPLITTED_VALUE] [VARCHAR](100) NOT NULL)

AS

/* Split the String and get splitted values in the result-set. Delimiter upto 3 characters long can be used for splitting */
BEGIN   
  DECLARE  @STRING         VARCHAR(1000),
           @POSITION       INT,
           @START_LOCATION INT,
           @STRING_LENGTH  INT
                           
  SET @STRING = @SPLITSTRING
                
  SET @POSITION = 0
                  
  SET @START_LOCATION = 0
                        
  SET @STRING_LENGTH = LEN(@STRING)
                       
  WHILE @STRING_LENGTH > 0
    BEGIN
    
      SET @POSITION = CHARINDEX(@DELIMITER,@STRING,@START_LOCATION)
                      
      IF @POSITION = 0
        BEGIN
          INSERT INTO @SPLITTED
          SELECT @STRING
                 
          SET @STRING_LENGTH = 0
                               
        END
      ELSE
        BEGIN
          INSERT INTO @SPLITTED
          SELECT LEFT(@STRING,@POSITION - 1)
                 
          SET @STRING = RIGHT(@STRING,@STRING_LENGTH - @POSITION)
                        
          SET @STRING_LENGTH = LEN(@STRING)
        END
        
    END

  RETURN 

END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GETACCOUNTCODE
-- --------------------------------------------------


CREATE   FUNCTION [dbo].[GETACCOUNTCODE]
		(
		@SAUDA_DATE VARCHAR(11),
		@SYMBOL VARCHAR(12),
		@RPTREPORTNO INT,
		@RPTACCOUNTCODE VARCHAR(15),
		@RPTACCOUNTTYPE VARCHAR(15)
		)

RETURNS VARCHAR(25) 

AS
  BEGIN

    DECLARE  @ACCOUNTCODE VARCHAR(25)		
	SET @ACCOUNTCODE = ''	
	/*
	IF @RPTREPORTNO = 51 AND @RPTACCOUNTTYPE = 'ACCOUNTCODE' 
	BEGIN
		IF (SELECT COUNT(1) FROM V2_INST_PARTYMAPPING WHERE RPT_REPORT_NO = 16 AND PARTY_CODE = @RPTACCOUNTCODE) > 0 AND (SELECT COUNT(1) FROM MSAJAG.DBO.SCRIP_INDEX WHERE SCRIP_CD = @SYMBOL AND INDEXNAME = 'NIFTY' AND @SAUDA_DATE BETWEEN START_DATE AND END_DATE) > 0
		BEGIN
			SELECT @ACCOUNTCODE = '07500PGT'
		END
		ELSE IF (SELECT COUNT(1) FROM V2_INST_PARTYMAPPING WHERE RPT_REPORT_NO = 16 AND PARTY_CODE = @RPTACCOUNTCODE) > 0 
		BEGIN
			SELECT @ACCOUNTCODE = '07500MAC'
		END
		ELSE IF (SELECT COUNT(1) FROM V2_INST_PARTYMAPPING WHERE RPT_REPORT_NO = 18 AND PARTY_CODE = @RPTACCOUNTCODE) > 0 AND (SELECT COUNT(1) FROM MSAJAG.DBO.SCRIP_INDEX WHERE SCRIP_CD = @SYMBOL AND INDEXNAME = 'NIFTY' AND @SAUDA_DATE BETWEEN START_DATE AND END_DATE) > 0
		BEGIN
			SELECT @ACCOUNTCODE = '07500FFD'
		END
		ELSE IF (SELECT COUNT(1) FROM V2_INST_PARTYMAPPING WHERE RPT_REPORT_NO = 18 AND PARTY_CODE = @RPTACCOUNTCODE) > 0
		BEGIN
			SELECT @ACCOUNTCODE = '07500FFC'
		END
		ELSE
		BEGIN
			SELECT @ACCOUNTCODE = @RPTACCOUNTCODE
		END
	END


	IF @RPTREPORTNO = 51 AND @RPTACCOUNTTYPE = 'BROKERCODE'
	BEGIN
		IF (SELECT COUNT(1) FROM V2_INST_PARTYMAPPING WHERE RPT_REPORT_NO = 16 AND PARTY_CODE = @RPTACCOUNTCODE) > 0 
		BEGIN
			SELECT @ACCOUNTCODE = 'QUALNF'
		END
		ELSE IF (SELECT COUNT(1) FROM V2_INST_PARTYMAPPING WHERE RPT_REPORT_NO = 18 AND PARTY_CODE = @RPTACCOUNTCODE) > 0 
		BEGIN
			SELECT @ACCOUNTCODE = 'QUAMMF'
		END
	END
	*/
    RETURN @ACCOUNTCODE 

  END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GETBLOOMBERGCODE
-- --------------------------------------------------

CREATE FUNCTION [dbo].[GETBLOOMBERGCODE]
               (@INST_TYPE VARCHAR(6), 
                @SYMBOL VARCHAR(12),
                @EXPIRYDATE VARCHAR(11), 
                @STRIKE_PRICE MONEY, 
                @OPTION_TYPE VARCHAR(2),
				@RPTREPORTNO INT
				)
RETURNS VARCHAR(30) 
AS
BEGIN
    DECLARE  @BLOOMBERG VARCHAR(30) 
	--DECLARE	 @RPTREPORTNO INT
	
    SET @BLOOMBERG = ''
    --SET @RPTREPORTNO = 0

 IF LEFT(@INST_TYPE,3) = 'FUT' AND @SYMBOL = 'NFTYMCAP50'
    BEGIN
      SELECT @BLOOMBERG = 'IMC' 
                        + RC_CODE 
                        + RIGHT(@EXPIRYDATE,1) 
                        + ' Index'
      FROM   SCRIP_CODES R, 
             REUTERS_CALENDER C 
      WHERE  R.SYMBOL = @SYMBOL 
             AND C.INST_TYPE = @INST_TYPE 
             AND C.OPTION_TYPE = @OPTION_TYPE 
             AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END
    ELSE 


 IF LEFT(@INST_TYPE,3) = 'FUT' AND @SYMBOL = 'MINIFTY'
    BEGIN
      SELECT @BLOOMBERG = 'JBE' 
                        + RC_CODE 
                        + RIGHT(@EXPIRYDATE,1) 
                        + ' Index'
      FROM   SCRIP_CODES R, 
             REUTERS_CALENDER C 
      WHERE  R.SYMBOL = @SYMBOL 
             AND C.INST_TYPE = @INST_TYPE 
             AND C.OPTION_TYPE = @OPTION_TYPE 
             AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END
    ELSE 


 IF LEFT(@INST_TYPE,3) = 'FUT' AND @SYMBOL = 'DEFTY'
    BEGIN
      SELECT @BLOOMBERG = 'DFY' 
                        + RC_CODE 
                        + RIGHT(@EXPIRYDATE,1) 
                        + ' Index'
      FROM   SCRIP_CODES R, 
             REUTERS_CALENDER C 
      WHERE  R.SYMBOL = @SYMBOL 
             AND C.INST_TYPE = @INST_TYPE 
             AND C.OPTION_TYPE = @OPTION_TYPE 
             AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END
    ELSE 

 IF LEFT(@INST_TYPE,3) = 'FUT' AND @SYMBOL = 'CNX100'
    BEGIN
      SELECT @BLOOMBERG = 'KD' 
                        + RC_CODE 
                        + RIGHT(@EXPIRYDATE,1) 
                        + ' Index'
      FROM   SCRIP_CODES R, 
             REUTERS_CALENDER C 
      WHERE  R.SYMBOL = @SYMBOL 
             AND C.INST_TYPE = @INST_TYPE 
             AND C.OPTION_TYPE = @OPTION_TYPE 
             AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END
    ELSE 


 IF LEFT(@INST_TYPE,3) = 'FUT' AND @SYMBOL = 'CNXIT'
    BEGIN
      SELECT @BLOOMBERG = 'NB' 
                        + RC_CODE 
                        + RIGHT(@EXPIRYDATE,1) 
                        + ' Index'
      FROM   SCRIP_CODES R, 
             REUTERS_CALENDER C 
      WHERE  R.SYMBOL = @SYMBOL 
             AND C.INST_TYPE = @INST_TYPE 
             AND C.OPTION_TYPE = @OPTION_TYPE 
             AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END
    ELSE 


 IF LEFT(@INST_TYPE,3) = 'FUT' AND @SYMBOL = 'NIFTYA'
    BEGIN
      SELECT @BLOOMBERG = 'JBE' 
                        + RC_CODE 
                        + RIGHT(@EXPIRYDATE,1) 
                        + ' Index'
      FROM   SCRIP_CODES R, 
             REUTERS_CALENDER C 
      WHERE  R.SYMBOL = @SYMBOL 
             AND C.INST_TYPE = @INST_TYPE 
             AND C.OPTION_TYPE = @OPTION_TYPE 
             AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END
    ELSE 


 IF LEFT(@INST_TYPE,3) = 'FUT' AND @SYMBOL = 'JUNIOR'
    BEGIN
      SELECT @BLOOMBERG = 'KB' 
                        + RC_CODE 
                        + RIGHT(@EXPIRYDATE,1) 
                        + ' Index'
      FROM   SCRIP_CODES R, 
             REUTERS_CALENDER C 
      WHERE  R.SYMBOL = @SYMBOL 
             AND C.INST_TYPE = @INST_TYPE 
             AND C.OPTION_TYPE = @OPTION_TYPE 
             AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END
    ELSE 


 IF LEFT(@INST_TYPE,3) = 'FUT' AND @SYMBOL = 'BANKNIFTY'
    BEGIN
      SELECT @BLOOMBERG = 'AF' 
                        + RC_CODE 
                        + RIGHT(@EXPIRYDATE,1) 
                        + ' Index'
      FROM   SCRIP_CODES R, 
             REUTERS_CALENDER C 
      WHERE  R.SYMBOL = @SYMBOL 
             AND C.INST_TYPE = @INST_TYPE 
             AND C.OPTION_TYPE = @OPTION_TYPE 
             AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END
    ELSE 


    IF LEFT(@INST_TYPE,3) = 'FUT' AND @SYMBOL = 'NIFTY'
    BEGIN
      SELECT @BLOOMBERG = 'NZ' 
                        + RC_CODE 
                        + RIGHT(@EXPIRYDATE,1) 
                        + ' Index'
      FROM   SCRIP_CODES R, 
             REUTERS_CALENDER C 
      WHERE  R.SYMBOL = @SYMBOL 
             AND C.INST_TYPE = @INST_TYPE 
             AND C.OPTION_TYPE = @OPTION_TYPE 
             AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END
    ELSE 
    IF LEFT(@INST_TYPE,3) = 'OPT' AND @SYMBOL = 'NIFTY'
    BEGIN
      SELECT @BLOOMBERG = 'Nifty '
                        + CASE 
							WHEN LEN(LTRIM(RTRIM(CONVERT(CHAR,MONTH(@EXPIRYDATE))))) = 1 
							THEN '0'+ LTRIM(RTRIM(CONVERT(CHAR,MONTH(@EXPIRYDATE)))) 
							ELSE LTRIM(RTRIM(CONVERT(CHAR,MONTH(@EXPIRYDATE)))) 
							END
                        + '/'
                        + RIGHT(@EXPIRYDATE,2) 
                        + ' '
                        + LEFT(@OPTION_TYPE,1) 
                        + LTRIM(RTRIM(CONVERT(CHAR,CONVERT(INT,@STRIKE_PRICE)))) 
                        + ' Index'
      FROM   SCRIP_CODES R, 
             REUTERS_CALENDER C 
      WHERE  R.SYMBOL = @SYMBOL 
             AND C.INST_TYPE = @INST_TYPE 
             AND C.OPTION_TYPE = @OPTION_TYPE 
             AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END
    ELSE 
    IF @INST_TYPE = 'FUTSTK' 
    BEGIN
      SELECT @BLOOMBERG = BLOOMBERG 
                        + (CASE WHEN @RPTREPORTNO IN (0) THEN '' ELSE '=' END) 
                        + RC_CODE 
                        + RIGHT(@EXPIRYDATE,1) 
                        + (CASE WHEN @RPTREPORTNO IN (0) THEN '' ELSE ' IS Equity' END)  
      FROM   SCRIP_CODES R, 
             REUTERS_CALENDER C 
      WHERE  R.SYMBOL = @SYMBOL 
             AND C.INST_TYPE = @INST_TYPE 
             AND C.OPTION_TYPE = @OPTION_TYPE 
             AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END
    ELSE 
    IF @INST_TYPE = 'OPTSTK' 
    BEGIN
      SELECT @BLOOMBERG = BLOOMBERG 
                        + (CASE WHEN @RPTREPORTNO IN (0) THEN '' ELSE ' IS ' END)
                        + CASE 
							WHEN LEN(LTRIM(RTRIM(CONVERT(CHAR,MONTH(@EXPIRYDATE))))) = 1 
							THEN '0'+ LTRIM(RTRIM(CONVERT(CHAR,MONTH(@EXPIRYDATE)))) 
							ELSE LTRIM(RTRIM(CONVERT(CHAR,MONTH(@EXPIRYDATE)))) 
							END 
                        + '/'
                        + RIGHT(@EXPIRYDATE,2) 
                        + ' '
                        + LEFT(@OPTION_TYPE,1) 
                        + LTRIM(RTRIM(CONVERT(CHAR,CONVERT(INT,@STRIKE_PRICE)))) 
                        + (CASE WHEN @RPTREPORTNO IN (0) THEN '' ELSE ' Equity' END)
      FROM   SCRIP_CODES R, 
             REUTERS_CALENDER C 
      WHERE  R.SYMBOL = @SYMBOL 
             AND C.INST_TYPE = @INST_TYPE 
             AND C.OPTION_TYPE = @OPTION_TYPE 
             AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END

    RETURN @BLOOMBERG
  END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GETCHECK_DIGIT
-- --------------------------------------------------

CREATE  FUNCTION [dbo].[GETCHECK_DIGIT]
               (@VALUE VARCHAR(20))
RETURNS VARCHAR(1) 
AS
  BEGIN
    DECLARE  @CHECKDIGIT VARCHAR(1),
             @CURDIGIT VARCHAR(1),  
             @STRINGLENGTH INT, 
             @ATLOCATION INT, 
             @EVENODD INT, 
             @CHECKSUM INT  

	SET @VALUE = UPPER(@VALUE)
	SET @STRINGLENGTH = LEN(@VALUE)
	SET @ATLOCATION = 1 
	SET @EVENODD = 1 
	SET @CHECKSUM = 0 
	--58021EN8 

	WHILE @STRINGLENGTH >= @ATLOCATION
	BEGIN 
		SET @CURDIGIT = RIGHT(LEFT(@VALUE,@ATLOCATION),1) 
		SET @CHECKSUM = @CHECKSUM + (CASE 
									   WHEN ASCII(@CURDIGIT) < 65 THEN (CASE WHEN CONVERT(INT,@CURDIGIT) * @EVENODD >= 10 
                                                                             THEN CONVERT(INT,LEFT(LTRIM(RTRIM(CONVERT(VARCHAR,CONVERT(INT,@CURDIGIT) * @EVENODD))),1)) 
                                                                                  + CONVERT(INT,RIGHT(LTRIM(RTRIM(CONVERT(VARCHAR,CONVERT(INT,@CURDIGIT) * @EVENODD))),1)) 
                                                                             ELSE CONVERT(INT,@CURDIGIT) * @EVENODD 
                                                                        END) 
									   ELSE (CASE WHEN CONVERT(INT,LEFT(LTRIM(RTRIM(CONVERT(VARCHAR,ASCII(@CURDIGIT)-55))),1)) * @EVENODD < 10 
                                                  THEN CONVERT(INT,LEFT(LTRIM(RTRIM(CONVERT(VARCHAR,ASCII(@CURDIGIT)-55))),1)) * @EVENODD 
                                                  ELSE CONVERT(INT,LEFT(CONVERT(VARCHAR,CONVERT(INT,LEFT(LTRIM(RTRIM(CONVERT(VARCHAR,ASCII(@CURDIGIT)-55))),1)) * @EVENODD),1)) 
                                                       + CONVERT(INT,RIGHT(CONVERT(VARCHAR,CONVERT(INT,LEFT(LTRIM(RTRIM(CONVERT(VARCHAR,ASCII(@CURDIGIT)-55))),1)) * @EVENODD),1)) 
                                             END) 
											+ (CASE WHEN CONVERT(INT,RIGHT(LTRIM(RTRIM(CONVERT(VARCHAR,ASCII(@CURDIGIT)-55))),1)) * @EVENODD < 10 
                                                    THEN CONVERT(INT,RIGHT(LTRIM(RTRIM(CONVERT(VARCHAR,ASCII(@CURDIGIT)-55))),1)) * @EVENODD 
                                                    ELSE CONVERT(INT,LEFT(CONVERT(VARCHAR,CONVERT(INT,RIGHT(LTRIM(RTRIM(CONVERT(VARCHAR,ASCII(@CURDIGIT)-55))),1)) * @EVENODD),1),1) 
                                                         + CONVERT(INT,RIGHT(CONVERT(VARCHAR,CONVERT(INT,RIGHT(LTRIM(RTRIM(CONVERT(VARCHAR,ASCII(@CURDIGIT)-55))),1)) * @EVENODD),1),1) 
                                             END) 
									 END) 

	  IF @EVENODD = 1 
        BEGIN 
          SET @EVENODD = 2
        END 
        ELSE 
        BEGIN 
	      SET @EVENODD = 1
        END 

    	SET @ATLOCATION = @ATLOCATION + 1 
	END   

    SET @CHECKDIGIT = CASE WHEN RIGHT(CONVERT(VARCHAR,@CHECKSUM),1) = '0' THEN '0' 
                           ELSE CONVERT(VARCHAR,10 - CONVERT(INT,RIGHT(CONVERT(VARCHAR,@CHECKSUM),1))) 
                      END 

    RETURN @CHECKDIGIT 
  END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GETCOUNTRY_STATE_CITY_CODE
-- --------------------------------------------------

CREATE  FUNCTION [dbo].[GETCOUNTRY_STATE_CITY_CODE]
		(
		@SEARCH		VARCHAR(10),
                @COUNTRY	VARCHAR(50),
                @STATE		VARCHAR(50),
                @CITY		VARCHAR(100),
                @SEGMENT	VARCHAR(11)
		)

	RETURNS VARCHAR(30) 

	AS

	BEGIN
    	DECLARE  @GETCODE VARCHAR(30) 
  		SET @GETCODE = '' 

		IF @SEARCH = 'COUNTRY'
		BEGIN
			SELECT	@GETCODE = MAX(COUNTRY_CODE)
			FROM	MSAJAG..TBL_STATECITY_MASTER (NOLOCK)
			WHERE	COUNTRY = @COUNTRY
		END
			
		IF @SEARCH = 'STATE'
		BEGIN
			
			SELECT	@GETCODE = ISNULL(MAX(STATE_CODE),'99')
			FROM	MSAJAG..TBL_STATECITY_MASTER (NOLOCK)
			WHERE	COUNTRY = @COUNTRY
			AND		STATE = @STATE
		END

		IF @SEARCH = 'CITY'
		BEGIN
			SELECT	@GETCODE = MAX(STATECITY_CODE)
			FROM	MSAJAG..TBL_STATECITY_MASTER (NOLOCK)
			WHERE	COUNTRY = @COUNTRY
			AND		STATE = @STATE
			AND		CITY = @CITY
		END

		RETURN @GETCODE
	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GETCUSIP
-- --------------------------------------------------

CREATE  FUNCTION [dbo].[GETCUSIP]
               (@INST_TYPE VARCHAR(6), 
                @SYMBOL VARCHAR(12),
                @EXPIRYDATE VARCHAR(11), 
                @STRIKE_PRICE MONEY, 
                @OPTION_TYPE VARCHAR(2))
RETURNS VARCHAR(20) 
AS
BEGIN
    DECLARE  @RICCODE VARCHAR(20)
    SET @RICCODE = ''	 

    IF @INST_TYPE = 'FUTSTK' 
    BEGIN
      SELECT @RICCODE = CUSIP 
                        + RC_CODE 
                        + RIGHT(@EXPIRYDATE,1) 
      FROM   SCRIP_CODES R, 
             REUTERS_CALENDER C 
      WHERE  R.SYMBOL = @SYMBOL 
             AND C.INST_TYPE = @INST_TYPE 
             AND C.OPTION_TYPE = @OPTION_TYPE 
             AND C.MNTH = LEFT(@EXPIRYDATE,3) 
	     AND LTRIM(RTRIM(ISNULL(CUSIP,''))) <> ''

      IF ISNULL(@RICCODE,'') <> ''	
      	BEGIN	
      		SELECT @RICCODE = @RICCODE + DBO.GETCHECK_DIGIT(ISNULL(@RICCODE,''))
      	END
	ELSE
	BEGIN
		SELECT @RICCODE = ''
	END
    END
    ELSE
    BEGIN
      SELECT @RICCODE = ''
    END

    RETURN @RICCODE
  END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GETMDSCODE
-- --------------------------------------------------


CREATE  FUNCTION [dbo].[GETMDSCODE]
		(
		@SCRIP_CD VARCHAR(12),
        @EXCHANGE VARCHAR(3),
		@RPTREPORTNO INT = 0
		)

	RETURNS VARCHAR(25) 

	AS

	BEGIN
    	DECLARE  @GETMDSCODE VARCHAR(25) 
	  	SET @GETMDSCODE = '' 
	
		IF (@EXCHANGE = 'NSE') OR (@EXCHANGE = 'BSE')
		BEGIN 
			SELECT @GETMDSCODE = MDSCODE 
			FROM   SCRIP_CODES R
			WHERE  R.SYMBOL = @SCRIP_CD 
		END
		
		IF @EXCHANGE = 'MCXFO'
		BEGIN 
			SELECT @GETMDSCODE = MDSCODE 
			FROM   MCXFO.DBO.SCRIP_CODES R
			WHERE  R.SYMBOL = @SCRIP_CD
		END

		RETURN @GETMDSCODE
 	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GETMERRYLCODE
-- --------------------------------------------------

CREATE FUNCTION [dbo].[GETMERRYLCODE]
	(
	@SYMBOL VARCHAR(12)
	)

	RETURNS VARCHAR(20) 
	
	AS
	BEGIN
		DECLARE  @MERRYLCODE VARCHAR(20) 

	    SELECT @MERRYLCODE = MERRYLCODE
	    FROM   SCRIP_CODES R
	    WHERE  R.SYMBOL = @SYMBOL 

		RETURN @MERRYLCODE
	END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GETRICBASIC
-- --------------------------------------------------

CREATE FUNCTION [dbo].[GETRICBASIC]
	(
	@SYMBOL VARCHAR(12)
	)

RETURNS VARCHAR(20) 
AS
  BEGIN
    DECLARE  @RICBASIC VARCHAR(20) 
	
	    SELECT @RICBASIC = RICBASIC 
	    FROM   SCRIP_CODES R
	    WHERE  R.SYMBOL = @SYMBOL 
    RETURN @RICBASIC
  END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GETRICCODE
-- --------------------------------------------------


CREATE   FUNCTION [dbo].[GETRICCODE]
               (@INST_TYPE VARCHAR(6), 
                @SYMBOL VARCHAR(12),
                @EXPIRYDATE VARCHAR(11), 
                @STRIKE_PRICE MONEY, 
                @OPTION_TYPE VARCHAR(2),
                @RPTREPORTNO INT)
RETURNS VARCHAR(20) 
AS
  BEGIN
    DECLARE  @RICCODE VARCHAR(20) 

    IF LEFT(@INST_TYPE,3) = 'FUT' 
    BEGIN
    SELECT @RICCODE = RICBASIC 
                      + RC_CODE 
                      + (CASE 
							WHEN @RPTREPORTNO = 20 THEN '.' 
								+ (CASE WHEN LEN(CONVERT(VARCHAR,MONTH(@EXPIRYDATE)))=1 THEN '0'+CONVERT(VARCHAR,MONTH(@EXPIRYDATE)) ELSE CONVERT(VARCHAR,MONTH(@EXPIRYDATE)) END)
								+ RIGHT(CONVERT(VARCHAR,YEAR(@EXPIRYDATE)),2)
							ELSE RIGHT(@EXPIRYDATE,1) 
						END)
                      + (CASE 
							WHEN @SYMBOL ='NIFTY' THEN ''
							WHEN @INST_TYPE = 'FUTIDX' THEN (CASE @RPTREPORTNO 
                                                              WHEN 20 THEN '' 
                                                              WHEN 22 THEN '' 
                                                              ELSE ':NS' 
                                                            END)
							ELSE ':NS'
                         END) 
    FROM   SCRIP_CODES R, 
           REUTERS_CALENDER C 
    WHERE  R.SYMBOL = @SYMBOL 
           AND C.INST_TYPE = @INST_TYPE 
           AND C.OPTION_TYPE = @OPTION_TYPE 
           AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END


    IF LEFT(@INST_TYPE,3) = 'OPT' 
    BEGIN
    SELECT @RICCODE = RICBASIC 
                      + REPLICATE('0',4-LEN(LTRIM(RTRIM(CONVERT(CHAR,CONVERT(INT,@STRIKE_PRICE)))))) 
                      + LTRIM(RTRIM(CONVERT(CHAR,CONVERT(INT,@STRIKE_PRICE)))) 
                      + (CASE WHEN @INST_TYPE = 'OPTSTK' THEN '00' ELSE '' END) 
                      + RC_CODE 
                      + (CASE 
							WHEN @RPTREPORTNO = 20 THEN '.' 
								+ (CASE WHEN LEN(CONVERT(VARCHAR,MONTH(@EXPIRYDATE)))=1 THEN '0'+CONVERT(VARCHAR,MONTH(@EXPIRYDATE)) ELSE CONVERT(VARCHAR,MONTH(@EXPIRYDATE)) END)
								+ RIGHT(CONVERT(VARCHAR,YEAR(@EXPIRYDATE)),2)
							ELSE RIGHT(@EXPIRYDATE,1) 
						END)
					  + (CASE @RPTREPORTNO
									  WHEN 0 THEN '' 
									  WHEN 20 THEN ''
									  ELSE '.NS' 
									END)
    FROM   SCRIP_CODES R, 
           REUTERS_CALENDER C 
    WHERE  R.SYMBOL = @SYMBOL 
           AND C.INST_TYPE = @INST_TYPE 
           AND C.OPTION_TYPE = @OPTION_TYPE 
           AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END

    RETURN @RICCODE
  END

GO

-- --------------------------------------------------
-- FUNCTION dbo.GETRICCODE_CITI
-- --------------------------------------------------

CREATE FUNCTION [dbo].[GETRICCODE_CITI]
               (@INST_TYPE VARCHAR(6), 
                @SYMBOL VARCHAR(12),
                @EXPIRYDATE VARCHAR(11), 
                @STRIKE_PRICE MONEY, 
                @OPTION_TYPE VARCHAR(2),
                @RPTREPORTNO INT)
RETURNS VARCHAR(20) 
AS
  BEGIN
    DECLARE  @RICCODE VARCHAR(20) 

    IF LEFT(@INST_TYPE,3) = 'FUT' 
    BEGIN
    SELECT @RICCODE = RICBASIC 
                      + RC_CODE 
                      + RIGHT(@EXPIRYDATE,2) 
                      + '.NS'
    FROM   SCRIP_CODES R, 
           REUTERS_CALENDER C 
    WHERE  R.SYMBOL = @SYMBOL 
           AND C.INST_TYPE = @INST_TYPE 
           AND C.OPTION_TYPE = @OPTION_TYPE 
           AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END

    IF LEFT(@INST_TYPE,3) = 'OPT' 
    BEGIN
    SELECT @RICCODE = RICBASIC 
                      + REPLICATE('0',4-LEN(LTRIM(RTRIM(CONVERT(CHAR,CONVERT(INT,@STRIKE_PRICE)))))) 
                      + LTRIM(RTRIM(CONVERT(CHAR,CONVERT(INT,@STRIKE_PRICE)))) 
                      + (CASE WHEN @INST_TYPE = 'OPTSTK' THEN '00' ELSE '' END) 
                      + RC_CODE 
                      + RIGHT(@EXPIRYDATE,2) 
                      + '.NS'
    FROM   SCRIP_CODES R, 
           REUTERS_CALENDER C 
    WHERE  R.SYMBOL = @SYMBOL 
           AND C.INST_TYPE = @INST_TYPE 
           AND C.OPTION_TYPE = @OPTION_TYPE 
           AND C.MNTH = LEFT(@EXPIRYDATE,3) 
    END

    RETURN @RICCODE
  END

GO

-- --------------------------------------------------
-- FUNCTION dbo.Mkt_rounding
-- --------------------------------------------------
  
  
CREATE FUNCTION [dbo].[Mkt_rounding]  
(  
@Amt numeric(18,9),      
@Roundstyle int   
)  
Returns Numeric(18,6)  
      
As       
  
begin  
  
Select @Amt = ((floor(( @amt * power(10,ROUNDMARKETRATE)+ ROFIG + ERRNUM)/(ROFIG + NOZERO )) * (ROFIG + NOZERO))/power(10,ROUNDMARKETRATE))      
FROM ROUNDPARAM  
WHERE ROUNDSTYLE = @ROUNDSTYLE  
  
RETURN CONVERT(NUMERIC(18,6),@Amt)  
end

GO

-- --------------------------------------------------
-- FUNCTION dbo.PIECE
-- --------------------------------------------------

CREATE FUNCTION [dbo].[PIECE] ( @CHARACTEREXPRESSION VARCHAR(8000), @DELIMITER CHAR(1), @POSITION INTEGER)
RETURNS VARCHAR(8000)
AS
BEGIN
	IF @POSITION<1 RETURN NULL
	IF LEN(@DELIMITER)<>1 RETURN NULL
	DECLARE @START INTEGER
	SET @START=1
	WHILE @POSITION>1
		BEGIN
			SET @START=ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
			IF @START=0 RETURN NULL
			SET @POSITION= @POSITION-1
			SET @START=@START+1
		END
	DECLARE @END INTEGER
	SET @END= ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
	IF @END=0 SET @END=LEN(@CHARACTEREXPRESSION)+1
	RETURN SUBSTRING(@CHARACTEREXPRESSION, @START, @END-@START)
END

GO

-- --------------------------------------------------
-- FUNCTION dbo.Place
-- --------------------------------------------------

CREATE Function [dbo].[Place](@Count as int ) Returns varchar(15)
as 
Begin
	Declare @Return varchar(15)
	set @Return = case @Count
			when 2 then ' Thousand '
			when 3 then ' Lakhs '
			when 4 then ' Crores '
			when 5 then ' Arab '
			else ''
			end
	Return(@Return)
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.REPLACETRADENO
-- --------------------------------------------------

CREATE  FUNCTION [DBO].[REPLACETRADENO](@TRADENO VARCHAR(15))
RETURNS VARCHAR(15)
AS
BEGIN
	SELECT @TRADENO = ( REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(@TRADENO,'R',''),'E',''),'A',''),'X',''),'B',''),'T',''),'S',''),'I',''),'U','') )
	RETURN (@TRADENO)
END

GO

-- --------------------------------------------------
-- INDEX dbo.ACCBILL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[ACCBILL] ([SETT_NO], [SETT_TYPE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.AREA
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxArea] ON [dbo].[AREA] ([Branch_Code], [AreaCode])

GO

-- --------------------------------------------------
-- INDEX dbo.BANK
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxBank] ON [dbo].[BANK] ([BankId])

GO

-- --------------------------------------------------
-- INDEX dbo.BBGFOSETTLEMENT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [BBGFOMain_Inx] ON [dbo].[BBGFOSETTLEMENT] ([Party_Code], [Inst_type], [Symbol], [Expirydate], [Strike_price], [Option_type])

GO

-- --------------------------------------------------
-- INDEX dbo.BILL_DIGITAL_DATA
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXTYPE] ON [dbo].[BILL_DIGITAL_DATA] ([C_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.BILL_DIGITAL_TEXT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxType] ON [dbo].[BILL_DIGITAL_TEXT] ([C_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.BILLNO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[BILLNO] ([party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.BRANCH
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxBr] ON [dbo].[BRANCH] ([BRANCH_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.BranchBrokTable
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxBrTbl] ON [dbo].[BranchBrokTable] ([Sr_No], [Branch_Code], [Table_No])

GO

-- --------------------------------------------------
-- INDEX dbo.BRANCHES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Branches] ON [dbo].[BRANCHES] ([Short_Name], [Branch_cd], [Com_Perc])

GO

-- --------------------------------------------------
-- INDEX dbo.BRANCHES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Branchshort] ON [dbo].[BRANCHES] ([Branch_cd], [Short_Name], [Com_Perc])

GO

-- --------------------------------------------------
-- INDEX dbo.BRANCHES
-- --------------------------------------------------
CREATE CLUSTERED INDEX [Pk_Branches] ON [dbo].[BRANCHES] ([Short_Name])

GO

-- --------------------------------------------------
-- INDEX dbo.BRANCHPAYMODE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxBrPmode] ON [dbo].[BRANCHPAYMODE] ([Sr_no], [Branch], [CltCode])

GO

-- --------------------------------------------------
-- INDEX dbo.BROKTABLE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Bk] ON [dbo].[BROKTABLE] ([Table_No], [Line_No], [Trd_Del], [Val_perc], [Upper_lim])

GO

-- --------------------------------------------------
-- INDEX dbo.BROKTABLE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [BrokTable_Upperlim] ON [dbo].[BROKTABLE] ([Trd_Del], [Def_table], [Table_No], [Upper_lim], [Line_No], [Val_perc], [Day_puc], [Day_Sales], [Sett_Purch])

GO

-- --------------------------------------------------
-- INDEX dbo.BROKTABLE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Tabnouplim] ON [dbo].[BROKTABLE] ([Table_No], [Upper_lim], [Line_No], [Val_perc])

GO

-- --------------------------------------------------
-- INDEX dbo.BROKTABLE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Upperlim] ON [dbo].[BROKTABLE] ([Trd_Del], [Def_table], [Table_No], [Upper_lim], [Line_No], [Val_perc], [Day_puc], [Day_Sales], [Sett_Purch], [sett_sales], [round_to])

GO

-- --------------------------------------------------
-- INDEX dbo.CHARGES_DETAIL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [CHARGES_DETAIL2] ON [dbo].[CHARGES_DETAIL] ([CD_PARTY_CODE], [CD_INST_TYPE], [CD_SYMBOL], [CD_OPTION_TYPE], [CD_STRIKE_PRICE], [CD_AUCTIONPART], [CD_SAUDA_DATE], [CD_EXPIRY_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.CHARGES_DETAIL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[CHARGES_DETAIL] ([CD_PARTY_CODE], [CD_SAUDA_DATE], [CD_INST_TYPE], [CD_SYMBOL], [CD_EXPIRY_DATE], [CD_OPTION_TYPE], [CD_STRIKE_PRICE])

GO

-- --------------------------------------------------
-- INDEX dbo.CHARGES_DETAIL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXVBB] ON [dbo].[CHARGES_DETAIL] ([CD_COMPUTATIONLEVEL], [CD_PARTY_CODE], [CD_SAUDA_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.Class_SQLTableIndex
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTbl] ON [dbo].[Class_SQLTableIndex] ([TableName])

GO

-- --------------------------------------------------
-- INDEX dbo.Class_SQLTableListing
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxTbl] ON [dbo].[Class_SQLTableListing] ([TableName])

GO

-- --------------------------------------------------
-- INDEX dbo.CLASSFILEUPD
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXSESSION] ON [dbo].[CLASSFILEUPD] ([SESSION_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.CLASSFILEUPD_LOG
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXUSR] ON [dbo].[CLASSFILEUPD_LOG] ([SESSION_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENT_BROK_DETAILS_TMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[CLIENT_BROK_DETAILS_TMP] ([CL_CODE], [EXCHANGE], [SEGMENT])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENT_PARTY_MODIFICATION_TMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[CLIENT_PARTY_MODIFICATION_TMP] ([OLD_PARTY_CODE], [NEW_PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENT1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Clcode] ON [dbo].[CLIENT1] ([Cl_Code], [trader], [Family])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENT1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [indxcl1] ON [dbo].[CLIENT1] ([Cl_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENT1
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Tclcode] ON [dbo].[CLIENT1] ([trader], [Cl_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENT2_LOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Indx_Log_Report] ON [dbo].[CLIENT2_LOG] ([Party_Code], [Logfld_When_109])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENT3
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Clcodeparty] ON [dbo].[CLIENT3] ([cl_code], [party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENT4
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Clparty] ON [dbo].[CLIENT4] ([Cl_code], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENT4
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [Clt4] ON [dbo].[CLIENT4] ([Party_code], [DefDp], [Depository], [BankID], [Cltdpid])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENT5
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [clcodeidx] ON [dbo].[CLIENT5] ([cl_code])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENT6
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXCL] ON [dbo].[CLIENT6] ([Cl_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENTBROK_SCHEME
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[CLIENTBROK_SCHEME] ([PARTY_CODE], [FROM_DATE], [TO_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENTSETTINGS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[CLIENTSETTINGS] ([CL_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENTSTATUS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXST] ON [dbo].[CLIENTSTATUS] ([CL_STATUS])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENTTAXES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [PARTYFROM] ON [dbo].[CLIENTTAXES] ([PARTY_CODE], [FROMDATE], [TODATE])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENTTAXES_NEW
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[CLIENTTAXES_NEW] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.CLIENTTYPE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxType] ON [dbo].[CLIENTTYPE] ([Cl_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.CLOSING
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXDT] ON [dbo].[CLOSING] ([SYSDATE], [SCRIP_CD])

GO

-- --------------------------------------------------
-- INDEX dbo.CLS_EXCH_IMPFILE_TYPE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXCD] ON [dbo].[CLS_EXCH_IMPFILE_TYPE] ([FILETYPE_CD])

GO

-- --------------------------------------------------
-- INDEX dbo.CLS_TRADEFILE_TYPE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXCD] ON [dbo].[CLS_TRADEFILE_TYPE] ([FILETYPE_CD])

GO

-- --------------------------------------------------
-- INDEX dbo.ContGen
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxDt] ON [dbo].[ContGen] ([Start_Date], [End_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.CONTLOGIN
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[CONTLOGIN] ([SAUDA_DATE], [FROMPARTY], [TOPARTY])

GO

-- --------------------------------------------------
-- INDEX dbo.CONTRACT_DATA
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[CONTRACT_DATA] ([SAUDA_DATE], [PARTY_CODE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE], [AUCTIONPART])

GO

-- --------------------------------------------------
-- INDEX dbo.CONTRACT_DATA_DET
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[CONTRACT_DATA_DET] ([SAUDA_DATE], [PARTY_CODE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE], [AUCTIONPART])

GO

-- --------------------------------------------------
-- INDEX dbo.CONTRACT_MASTER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[CONTRACT_MASTER] ([TRADE_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.CONTRACT_MST
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXSCRIP] ON [dbo].[CONTRACT_MST] ([INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.CONTRACT_ROUNDING
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[CONTRACT_ROUNDING] ([CR_PARTY_CODE], [CR_DATE_FROM], [CR_DATE_TO])

GO

-- --------------------------------------------------
-- INDEX dbo.CUSTODIAN
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXCUST] ON [dbo].[CUSTODIAN] ([CUSTODIANCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.EMAIL_BLANK_CHECK
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxFlag] ON [dbo].[EMAIL_BLANK_CHECK] ([Email_Blank_Flag])

GO

-- --------------------------------------------------
-- INDEX dbo.EMAIL_LOGIN_USER
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[EMAIL_LOGIN_USER] ([EMail_Login_Id])

GO

-- --------------------------------------------------
-- INDEX dbo.EMAIL_PARTYREPORT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxPartty] ON [dbo].[EMAIL_PARTYREPORT] ([EMail_Party_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.EMAIL_REPORT_LOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[EMAIL_REPORT_LOG] ([EMail_Report_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.EMAIL_REPORT_SETTINGS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxReport] ON [dbo].[EMAIL_REPORT_SETTINGS] ([email_report_name])

GO

-- --------------------------------------------------
-- INDEX dbo.ERRORLOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXDT] ON [dbo].[ERRORLOG] ([ERRDATE])

GO

-- --------------------------------------------------
-- INDEX dbo.FO_POS_DETAILS_DAS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXDT] ON [dbo].[FO_POS_DETAILS_DAS] ([FOPDD_SAUDA_DATE], [FOPDD_PARTY_CODE], [FOPDD_INST_TYPE], [FOPDD_SYMBOL], [FOPDD_STRIKE_PRICE], [FOPDD_OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FO_TRADE_DETAILS_DAS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[FO_TRADE_DETAILS_DAS] ([FOTDD_SAUDA_DATE], [FOTDD_PARTY_CODE], [FOTDD_INST_TYPE], [FOTDD_SYMBOL], [FOTDD_STRIKE_PRICE], [FOTDD_OPTION_TYPE], [FOTDD_EXPIRY_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOACCBILL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [FOACC] ON [dbo].[FOACCBILL] ([BILLDATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOACCBILL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXDTPARTY] ON [dbo].[FOACCBILL] ([BILLDATE], [BRANCHCD], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOBILLNO
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[FOBILLNO] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOBILLVALAN
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXCL] ON [dbo].[FOBILLVALAN] ([SAUDA_DATE], [PARTY_CODE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [OPTION_TYPE], [STRIKE_PRICE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOBILLVALAN
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXDT] ON [dbo].[FOBILLVALAN] ([SAUDA_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOBILLVALAN
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[FOBILLVALAN] ([SAUDA_DATE], [PARTY_CODE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOBILLVALAN_TEMP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXDT] ON [dbo].[FOBILLVALAN_TEMP] ([SAUDA_DATE], [PARTY_CODE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [OPTION_TYPE], [STRIKE_PRICE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOCLIENTBROKSCHEME
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXCL] ON [dbo].[FOCLIENTBROKSCHEME] ([PARTY_CODE], [DATE_FROM], [DATE_TO])

GO

-- --------------------------------------------------
-- INDEX dbo.FOCLIENTTAXES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXCL] ON [dbo].[FOCLIENTTAXES] ([PARTY_CODE], [DATE_FROM], [DATE_TO])

GO

-- --------------------------------------------------
-- INDEX dbo.FOCLOSING
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[FOCLOSING] ([TRADE_DATE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOCLOSING_IMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[FOCLOSING_IMP] ([TRADE_DATE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOERRORLOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXDT] ON [dbo].[FOERRORLOG] ([ERRDATE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOEXALLOCSETTLEMENT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXDT] ON [dbo].[FOEXALLOCSETTLEMENT] ([SAUDA_DATE], [PARTY_CODE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOEXALLOCTRADE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXDT] ON [dbo].[FOEXALLOCTRADE] ([FOEATRD_ACTIVITYTIME], [FOEATRD_PARTY_CODE], [FOEATRD_INST_TYPE], [FOEATRD_SYMBOL], [FOEATRD_EXPIRYDATE], [FOEATRD_STRIKE_PRICE], [FOEATRD_OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOEXALLOCTRADEHIST
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXDT] ON [dbo].[FOEXALLOCTRADEHIST] ([FOEATRD_ACTIVITYTIME], [FOEATRD_PARTY_CODE], [FOEATRD_INST_TYPE], [FOEATRD_SYMBOL], [FOEATRD_EXPIRYDATE], [FOEATRD_STRIKE_PRICE], [FOEATRD_OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOEXERCISEALLOCATION
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXPOS] ON [dbo].[FOEXERCISEALLOCATION] ([FOEA_POSITION_DATE], [FOEA_PARTY_CODE], [FOEA_INST_TYPE], [FOEA_SYMBOL], [FOEA_EXPIRYDATE], [FOEA_OPTION_TYPE], [FOEA_STRIKE_PRICE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOEXERCISEALLOCATION_IMP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXPOS] ON [dbo].[FOEXERCISEALLOCATION_IMP] ([FOEA_POSITION_DATE], [FOEA_PARTY_CODE], [FOEA_INST_TYPE], [FOEA_SYMBOL], [FOEA_EXPIRYDATE], [FOEA_OPTION_TYPE], [FOEA_STRIKE_PRICE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOEXPIRYSETTLEMENT
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXDT] ON [dbo].[FOEXPIRYSETTLEMENT] ([SAUDA_DATE], [PARTY_CODE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOMARGIN_PENALTY
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[FOMARGIN_PENALTY] ([MARGIN_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOMARGIN_PENALTY_MST
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[FOMARGIN_PENALTY_MST] ([FROM_DATE], [TO_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOMARGIN_PENALTY_POST_STAT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[FOMARGIN_PENALTY_POST_STAT] ([MARGIN_DATE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOMARGIN_REPORT_STAT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[FOMARGIN_REPORT_STAT] ([MARGIN_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOMARGINNEW_EFFCOLL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [INDXFOMARGINEFFCOL] ON [dbo].[FOMARGINNEW_EFFCOLL] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOMARGINPERCENT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXPARTY] ON [dbo].[FOMARGINPERCENT] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOMG13PENALTYMASTER
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXEDT] ON [dbo].[FOMG13PENALTYMASTER] ([EFFECTIVEDATE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOMG13REFERENCE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXSRNO] ON [dbo].[FOMG13REFERENCE] ([REFNO], [SUBMENUREFNO])

GO

-- --------------------------------------------------
-- INDEX dbo.FOMG13SHORTAGE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[FOMG13SHORTAGE] ([FILEDATE], [PARTY_CODE], [BATCH_NO], [REFNO])

GO

-- --------------------------------------------------
-- INDEX dbo.FOSCRIP_IMP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXSCRIP] ON [dbo].[FOSCRIP_IMP] ([INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOSETTLEMENTEXPIRY
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [INDXFOSETT] ON [dbo].[FOSETTLEMENTEXPIRY] ([SAUDA_DATE], [PARTY_CODE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOSTAT_TRD
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[FOSTAT_TRD] ([SYSDATE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTAXES
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXEXC] ON [dbo].[FOTAXES] ([EXCHANGE], [FROM_DATE], [TO_DATE], [INST_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTMCLCHRG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [SAUDADATE] ON [dbo].[FOTMCLCHRG] ([SAUDA_DATE], [PARTY_CODE], [SELL_BUY], [ORDERNO], [TRADE_NO])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTMINFO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXTM] ON [dbo].[FOTMINFO] ([TM_CODE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRADE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [PARTYCODE] ON [dbo].[FOTRADE] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRADE
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [PARTYSYMBOL] ON [dbo].[FOTRADE] ([PARTY_CODE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE], [SELL_BUY])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRADEMISSING
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[FOTRADEMISSING] ([ACTIVITYTIME], [PARTY_CODE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRD_BROKTABLE
-- --------------------------------------------------
CREATE CLUSTERED INDEX [FOBRK_INX] ON [dbo].[FOTRD_BROKTABLE] ([TABLE_NO], [LINE_NO])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRD_CLIENT1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [CLCODE] ON [dbo].[FOTRD_CLIENT1] ([CL_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRD_CLIENT2
-- --------------------------------------------------
CREATE CLUSTERED INDEX [PARTYCODE] ON [dbo].[FOTRD_CLIENT2] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRD_CLIENTBROKSCHEME
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXPARTY] ON [dbo].[FOTRD_CLIENTBROKSCHEME] ([DATE_FROM], [DATE_TO], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRD_CLIENTTAXES
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXCL] ON [dbo].[FOTRD_CLIENTTAXES] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRD_CLIENTTAXES
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXPARTY] ON [dbo].[FOTRD_CLIENTTAXES] ([PARTY_CODE], [DATE_FROM], [DATE_TO])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRD_CONTRACTNO
-- --------------------------------------------------
CREATE CLUSTERED INDEX [PARTYCONT] ON [dbo].[FOTRD_CONTRACTNO] ([PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRD_FOSCRIP1
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXSYTMBOL] ON [dbo].[FOTRD_FOSCRIP1] ([INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.FOTRD_FOSCRIP2
-- --------------------------------------------------
CREATE CLUSTERED INDEX [INDXFOTRD_FOSCRIP2] ON [dbo].[FOTRD_FOSCRIP2] ([INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE], [OPTION_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.IMP_FILEPATH
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxFl] ON [dbo].[IMP_FILEPATH] ([File_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.INST_LOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[INST_LOG] ([SAUDA_DATE], [PARTY_CODE], [NEW_PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.INSTCLIENT_TBL
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXPARTY] ON [dbo].[INSTCLIENT_TBL] ([PARTYCODE])

GO

-- --------------------------------------------------
-- INDEX dbo.LEDGER_DETAILS_DAS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxParty] ON [dbo].[LEDGER_DETAILS_DAS] ([LEDDD_SAUDA_DATE], [LEDDD_PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.LOG_PWDMAILS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[LOG_PWDMAILS] ([UPDATEDATE], [FLDID])

GO

-- --------------------------------------------------
-- INDEX dbo.LOGIN_EXP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXPR] ON [dbo].[LOGIN_EXP] ([EXP_PERIOD_TYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.MARGIN_REPORTING
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[MARGIN_REPORTING] ([SAUDA_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.MARGIN_REPORTING
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [MINDX] ON [dbo].[MARGIN_REPORTING] ([SAUDA_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.MG13BATCHNO_TBL
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXFL] ON [dbo].[MG13BATCHNO_TBL] ([FILEDATE], [BATCHNO])

GO

-- --------------------------------------------------
-- INDEX dbo.MULTICLTID
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [MCLTID] ON [dbo].[MULTICLTID] ([PARTY_CODE], [DEF], [DPTYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.MULTICLTID
-- --------------------------------------------------
CREATE CLUSTERED INDEX [PK_MULTICLTID] ON [dbo].[MULTICLTID] ([PARTY_CODE], [CLTDPNO], [DPID])

GO

-- --------------------------------------------------
-- INDEX dbo.PARTYMAPPING
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [INDXPARTYMAP] ON [dbo].[PARTYMAPPING] ([OLDPARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.POBANK
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxBank] ON [dbo].[POBANK] ([BankId])

GO

-- --------------------------------------------------
-- INDEX dbo.RATING
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxRt] ON [dbo].[RATING] ([Rating])

GO

-- --------------------------------------------------
-- INDEX dbo.REGION
-- --------------------------------------------------
CREATE CLUSTERED INDEX [irdregion] ON [dbo].[REGION] ([RegionCode], [Branch_Code])

GO

-- --------------------------------------------------
-- INDEX dbo.ROUNDPARAM
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxRd] ON [dbo].[ROUNDPARAM] ([RoundStyle])

GO

-- --------------------------------------------------
-- INDEX dbo.SBU_MASTER
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXSBU] ON [dbo].[SBU_MASTER] ([SBU_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.SCHEME_MAPPING
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[SCHEME_MAPPING] ([SP_PARTY_CODE], [SP_DATE_FROM], [SP_DATE_TO], [SP_INST_TYPE], [SP_SCRIP])

GO

-- --------------------------------------------------
-- INDEX dbo.SCHEME_MAPPING
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXS] ON [dbo].[SCHEME_MAPPING] ([SP_BROK_COMPUTETYPE])

GO

-- --------------------------------------------------
-- INDEX dbo.SCHEME_MASTER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXSCHEME] ON [dbo].[SCHEME_MASTER] ([SM_SCHEME_ID])

GO

-- --------------------------------------------------
-- INDEX dbo.SCHEMES
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSc] ON [dbo].[SCHEMES] ([schemeID])

GO

-- --------------------------------------------------
-- INDEX dbo.STT_EXCEPTION
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXSYMBOL] ON [dbo].[STT_EXCEPTION] ([SYMBOL], [EFFDATE_FROM], [EFFDATE_TO])

GO

-- --------------------------------------------------
-- INDEX dbo.STT_EXCHG
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXPARTY] ON [dbo].[STT_EXCHG] ([STT_DATE], [PARTY_CODE], [INST_TYPE], [SYMBOL], [EXPIRYDATE], [STRIKE_PRICE])

GO

-- --------------------------------------------------
-- INDEX dbo.SUBBROKERS_29012016
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxSb] ON [dbo].[SUBBROKERS_29012016] ([Sub_Broker], [Branch_code])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLADMIN
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxAdmin] ON [dbo].[TBLADMIN] ([fldauto_admin])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLADMINCONFIG
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxAdmin] ON [dbo].[TBLADMINCONFIG] ([Fldauto])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLCATEGORY
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [categoryidx] ON [dbo].[TBLCATEGORY] ([fldcategorycode])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLCATMENU
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxAdmin] ON [dbo].[TBLCATMENU] ([fldauto])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLCATMENU_LOG
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXREP] ON [dbo].[TBLCATMENU_LOG] ([Fldreportcode], [Fldadminauto], [CREATED_ON])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLCLASSUSERLOGINS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXLOGIN] ON [dbo].[TBLCLASSUSERLOGINS] ([FLDUSERNAME], [FLDSESSION], [FLDIPADDRESS])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLMENUHEAD
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxMenu] ON [dbo].[TBLMENUHEAD] ([fldmenucode])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLPRADNYAUSERS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[TBLPRADNYAUSERS] ([fldauto], [fldadminauto])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLREPORTGRP
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxRpr] ON [dbo].[TBLREPORTGRP] ([fldreportgrp], [fldmenugrp])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLREPORTS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxReport] ON [dbo].[TBLREPORTS] ([fldreportcode])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLREPORTS_BLOCKED
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxRpt] ON [dbo].[TBLREPORTS_BLOCKED] ([fldadminauto], [Fldreportcode])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLUSERCONTROLGLOBALS
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[TBLUSERCONTROLGLOBALS] ([FLDAUTO])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLUSERCONTROLMASTER
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [AutoIDx] ON [dbo].[TBLUSERCONTROLMASTER] ([FLDAUTO])

GO

-- --------------------------------------------------
-- INDEX dbo.TBLUSERCONTROLMASTER_JRNL
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxUser] ON [dbo].[TBLUSERCONTROLMASTER_JRNL] ([FLDAUTO])

GO

-- --------------------------------------------------
-- INDEX dbo.TERMLIMIT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXUSER] ON [dbo].[TERMLIMIT] ([USERID])

GO

-- --------------------------------------------------
-- INDEX dbo.TERMPARTY
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [TERMPARTY_INX] ON [dbo].[TERMPARTY] ([PROCLI])

GO

-- --------------------------------------------------
-- INDEX dbo.TERMPARTY
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [TERMPARTY_USER] ON [dbo].[TERMPARTY] ([USERID])

GO

-- --------------------------------------------------
-- INDEX dbo.TURNTAX_EXCEPTION
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXSYMBOL] ON [dbo].[TURNTAX_EXCEPTION] ([EFFDATE_FROM], [EFFDATE_TO], [INST_TYPE], [SYMBOL])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_BUSINESS_PROCESS
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [idxDt] ON [dbo].[V2_BUSINESS_PROCESS] ([Business_Date])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_CLIENTBROK_SCHEME
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXPARTY] ON [dbo].[V2_CLIENTBROK_SCHEME] ([FROM_DATE], [TO_DATE], [PARTY_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_DIGITAL_FILE_NAME
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxType] ON [dbo].[V2_DIGITAL_FILE_NAME] ([D_Type])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_LOGIN_ERR_LOG
-- --------------------------------------------------
CREATE CLUSTERED INDEX [IDXDT] ON [dbo].[V2_LOGIN_ERR_LOG] ([LOGIN_DT])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_LOGIN_LOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXUSER] ON [dbo].[V2_LOGIN_LOG] ([ADDDT], [USERID])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_PROCESS_STATUS_LOG
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxDt] ON [dbo].[V2_PROCESS_STATUS_LOG] ([BusinessDate], [ProcessId])

GO

-- --------------------------------------------------
-- INDEX dbo.V2_REPORT_ACCESS_LOG
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IDXREPORT] ON [dbo].[V2_REPORT_ACCESS_LOG] ([SNO])

GO

-- --------------------------------------------------
-- INDEX dbo.VALANACCOUNT
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxAcc] ON [dbo].[VALANACCOUNT] ([AcCode])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.FoSettlement
-- --------------------------------------------------
ALTER TABLE [dbo].[FoSettlement] ADD CONSTRAINT [PK_FoSettlement] PRIMARY KEY ([SrNo])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.TBL_CLIENT_GST_DATA
-- --------------------------------------------------
ALTER TABLE [dbo].[TBL_CLIENT_GST_DATA] ADD CONSTRAINT [PK_TBL_CLIENT_GST_DATA] PRIMARY KEY ([PARTY_CODE], [EFF_FROM_DATE], [EFF_TO_DATE])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.TBLUSERCONTROLMASTER
-- --------------------------------------------------
ALTER TABLE [dbo].[TBLUSERCONTROLMASTER] ADD CONSTRAINT [PK_TBLUSERCONTROLMASTER] PRIMARY KEY ([FLDUSERID])

GO

-- --------------------------------------------------
-- PK_UNIQUE dbo.TBLUSERPASSHIST
-- --------------------------------------------------
ALTER TABLE [dbo].[TBLUSERPASSHIST] ADD CONSTRAINT [PK_TBLUSERPASSHIST] PRIMARY KEY ([FLDAUTO])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADD_CLIENT_PROC_SHARE_CLIENT_INSERT
-- --------------------------------------------------
CREATE   PROC [dbo].[ADD_CLIENT_PROC_SHARE_CLIENT_INSERT] AS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADD_CLIENT_SHARE_PROC_INSERT
-- --------------------------------------------------
CREATE  PROC [dbo].[ADD_CLIENT_SHARE_PROC_INSERT] (
@EXCHANGE VARCHAR(3), 
@SEGMENT VARCHAR(7), 
@BRANCH_CD VARCHAR(10), 
@FROMPARTY VARCHAR(10),
@TOPARTY VARCHAR(10),
@MAINDATE VARCHAR(30),
@DETDATE VARCHAR(30)
) AS

UPDATE OWNER SET MEMBERCODE = MEMBERCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADD_CLIENT_SHARE_PROC_UPDATE
-- --------------------------------------------------



/****** OBJECT:  STORED PROCEDURE DBO.ADD_CLIENT_SHARE_PROC_UPDATE    SCRIPT DATE: 01/18/2006 12:58:59 ******/  
CREATE PROC [dbo].[ADD_CLIENT_SHARE_PROC_UPDATE] (    
@EXCHANGE VARCHAR(3),     
@SEGMENT VARCHAR(7),     
@BRANCH_CD VARCHAR(10),     
@FROMPARTY VARCHAR(10),    
@TOPARTY VARCHAR(10),    
@MAINDATE VARCHAR(30),    
@DETDATE VARCHAR(30)    
) AS    
/*    
STATUS = 'U', IMP_STATUS = '0' -- FOR FRESH INSERT    
IF IMP_STATUS = '0' THEN --DON'T UPDATE STATUS FEILD    
ELSE --UPDATE STATUS FEILD AS 'U'AND IMP_STATUS AS '0'    
*/    
    
TRUNCATE TABLE CLIENT_DETAILS_TMP    
TRUNCATE TABLE CLIENT_BROK_DETAILS_TMP    
TRUNCATE TABLE CLIENT_PARTY_MODIFICATION_TMP

INSERT INTO CLIENT_DETAILS_TMP    
SELECT C.*    
       FROM MSAJAG.DBO.CLIENT_DETAILS C, MSAJAG.DBO.CLIENT_BROK_DETAILS D    
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
       AND C.CL_CODE = D.CL_CODE    
       AND (C.IMP_STATUS = '0' OR D.IMP_STATUS = '0')
       AND D.IMP_STATUS <> '2' AND C.IMP_STATUS <> '2'    
       AND C.BRANCH_CD LIKE @BRANCH_CD    
       AND C.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY     
       AND C.MODIFIDEDON <= @MAINDATE AND D.MODIFIEDON <= @DETDATE    
    
INSERT INTO CLIENT_BROK_DETAILS_TMP    
SELECT D.*     
       FROM MSAJAG.DBO.CLIENT_DETAILS C, MSAJAG.DBO.CLIENT_BROK_DETAILS D    
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
       AND C.CL_CODE = D.CL_CODE    
       AND (C.IMP_STATUS = '0' OR D.IMP_STATUS = '0') 
       AND D.IMP_STATUS <> '2' AND C.IMP_STATUS <> '2'    
       AND C.BRANCH_CD LIKE @BRANCH_CD    
       AND C.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY     
       AND C.MODIFIDEDON <= @MAINDATE AND D.MODIFIEDON <= @DETDATE    

INSERT INTO CLIENT_PARTY_MODIFICATION_TMP
SELECT OLD_PARTY_CODE,NEW_PARTY_CODE,BRANCH_CD,SUB_BROKER,TRADER,FAMILY,AREA,REGION,STATUS,
ADDEDBY,ADDEDON,UPDATEDON
FROM MSAJAG.DBO.CLIENT_PARTY_MODIFICATION
WHERE STATUS = 0

DELETE FROM CLIENT1 WHERE CL_CODE IN ( SELECT C.CL_CODE     
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
       AND C.CL_CODE = D.CL_CODE)    
    
/* CLIENT1 INSERT QUERY */    
INSERT INTO CLIENT1    
SELECT C.CL_CODE,SHORT_NAME,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,FAX,RES_PHONE1,    
RES_PHONE2,OFF_PHONE1,OFF_PHONE2,EMAIL,BRANCH_CD,CREDIT_LIMIT,CL_TYPE,CL_STATUS,GL_CODE=PAYLOCATION,FD_CODE=SEBI_REGN_NO,FAMILY,    
PENALTY=0,SUB_BROKER,CONFIRM_FAX=0,PHONEOLD='',L_ADDRESS3,MOBILE_PAGER,PAN_GIR_NO,TRADER,WARD_NO,REGION,AREA,CLRATING=CLIENT_RATING   
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
AND C.CL_CODE = D.CL_CODE     
    
DELETE FROM CLIENT2 WHERE PARTY_CODE IN ( SELECT PARTY_CODE     
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
       AND C.CL_CODE = D.CL_CODE )    
    
/* CLIENT2 INSERT QUERY */    
INSERT INTO CLIENT2    
SELECT C.CL_CODE,D.EXCHANGE,TRAN_CAT='TRD',SCRIP_CAT=0,PARTY_CODE=C.CL_CODE,TRD_BROK,DEL_BROK,MARGIN=0,    
TURNOVER_TAX=FUT_TRAN_CHRGS,    
SEBI_TURN_TAX=FUT_SEBI_FEES,    
INSURANCE_CHRG=FUT_STT,    
SER_TAX,STD_RATE=FUT_BROK,P_TO_P=0,    
EXPOSURE_LIM=0,DEMAT_TABLENO=DEL_BROK,BANKID=PARTICIPANT_CODE,CLTDPNO=CUSTODIAN_CODE,PRINTF=PRINT_OPTIONS,    
ALBMDELCHRG=0,ALBMDELIVERY=0,ALBMCF_TABLENO=0,MF_TABLENO=DEL_BROK,SB_TABLENO=0,    
BROK1_TABLENO=FUT_FUT_FIN_BROK,BROK2_TABLENO=FUT_OPT_BROK,BROK3_TABLENO=0,    
BROKERNOTE=FUT_STAMP_DUTY,    
OTHER_CHRG=FUT_OTHER_CHRGS,    
D.BROK_SCHEME,CONTCHARGE=0,MINCONTAMT=0,ADDLEDGERBAL=0,DUMMY1=FUT_BROK_APPLICABLE,    
DUMMY2=FUT_OPT_EXC,INSCONT=(CASE WHEN INST_CONTRACT = '' OR INST_CONTRACT IS NULL THEN 'N' ELSE INST_CONTRACT END),SERTAXMETHOD=SER_TAX_METHOD,DUMMY6=STP_PROVIDER,    
DUMMY7=STP_RP_STYLE,DUMMY8=REL_MGR,DUMMY9=SBU,DUMMY10=C_GROUP, PARENTCODE, PRODUCTCODE
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
AND C.CL_CODE = D.CL_CODE     
    
DELETE FROM CLIENT3 WHERE PARTY_CODE IN ( SELECT PARTY_CODE     
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
       AND C.CL_CODE = D.CL_CODE)    
    
/* CLIENT3 INSERT QUERY */    
INSERT INTO CLIENT3    
SELECT C.CL_CODE,C.PARTY_CODE,EXCHANGE,MARKETTYPE=SEGMENT,MARGIN=0,NOOFTIMES=0,MARGIN_RECD=CHARGED,MTOM=0,    
PMARGINRATE=MULTIPLIER,MTOMDATE=GETDATE(),INITIALMARGIN=CHARGED,MAINENANCETMARGIN=MAINTENANCE,MARGINEXCHANGE=REQD_BY_EXCH,MARGINBROKER=0,    
DUMMY1=0,DUMMY2=0    
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
AND C.CL_CODE = D.CL_CODE
    
INSERT INTO CLIENT4    
SELECT C.CL_CODE,PARTY_CODE,INSTRU=0,BANKID=DPID1,CLTDPID1,DEPOSITORY1,DEF=1     
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
AND C.CL_CODE = D.CL_CODE     
AND DPID1 <> '' AND CLTDPID1 <> ''     
AND DEPOSITORY1 IN ('NSDL', 'CDSL')     
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM CLIENT4 WHERE DEPOSITORY IN ('NSDL', 'CDSL') )    
    
INSERT INTO MULTICLTID    
SELECT PARTY_CODE, CLTDPID1, DPID1, LONG_NAME, DEPOSITORY1, POA1     
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
AND C.CL_CODE = D.CL_CODE     
AND DPID1 <> '' AND CLTDPID1 <> ''     
AND DEPOSITORY1 IN ('NSDL', 'CDSL')    
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MULTICLTID WHERE DPID = DPID1 AND CLTDPNO = CLTDPID1)    
    
/* MULTICLTID INSERT QUERY */    
INSERT INTO MULTICLTID    
SELECT PARTY_CODE, CLTDPID2, DPID2, LONG_NAME, DEPOSITORY2, POA2     
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
AND C.CL_CODE = D.CL_CODE     
AND DPID2 <> '' AND CLTDPID2 <> ''    
AND DEPOSITORY2 IN ('NSDL', 'CDSL')    
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MULTICLTID WHERE DPID = DPID2 AND CLTDPNO = CLTDPID2)    
    
/* MULTICLTID INSERT QUERY */    
INSERT INTO MULTICLTID    
SELECT PARTY_CODE, CLTDPID3, DPID3, LONG_NAME, DEPOSITORY3, POA3     
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
AND C.CL_CODE = D.CL_CODE     
AND DPID3 <> '' AND CLTDPID3 <> ''    
AND DEPOSITORY3 IN ('NSDL', 'CDSL')    
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM MULTICLTID WHERE DPID = DPID3 AND CLTDPNO = CLTDPID3)    
    
DELETE FROM CLIENT4 WHERE CL_CODE IN ( SELECT C.CL_CODE     
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
       AND C.CL_CODE = D.CL_CODE )    
       AND DEPOSITORY NOT IN ('NSDL', 'CDSL')    
    
INSERT INTO POBANK (BANK_NAME,BRANCH_NAME,IFSCCODE,MICRNO)      
SELECT DISTINCT BANK_NAME, BRANCH_NAME,BANK_ID,MICR_NO      
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D      
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
       AND C.CL_CODE = D.CL_CODE
       AND BANK_NAME NOT IN (SELECT BANK_NAME FROM POBANK 
							WHERE POBANK.BANK_NAME = C.BANK_NAME 
							AND POBANK.BRANCH_NAME = C.BRANCH_NAME	
							AND POBANK.MICRNO = C.MICR_NO
							AND POBANK.IFSCCODE = C.BANK_ID						 
							)      
      
/* CLIENT4 INSERT QUERY */      
INSERT INTO CLIENT4      
SELECT C.CL_CODE,PARTY_CODE,INSTRU=1,BANKID=P.BANKID,CLTDPID=AC_NUM,      
DEPOSITORY=ISNULL((CASE WHEN AC_TYPE = 'S' THEN 'SAVING'       
                        WHEN AC_TYPE = 'C' THEN 'CURRENT'       
                        ELSE 'OTHER' END), 'OTHER'),      
DEF=0      
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D, POBANK P      
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT        
AND C.CL_CODE = D.CL_CODE      
AND AC_TYPE <> ''      
AND C.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM CLIENT4 WHERE DEPOSITORY NOT IN ('CDSL','NSDL'))      
AND P.BANK_NAME = C.BANK_NAME 
AND P.BRANCH_NAME = C.BRANCH_NAME 
AND P.MICRNO = C.MICR_NO
AND P.IFSCCODE = C.BANK_ID    
     
DELETE FROM CLIENT5 WHERE CL_CODE IN ( SELECT C.CL_CODE     
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
       AND C.CL_CODE = D.CL_CODE)    
    
/* CLIENT5 INSERT QUERY */    
INSERT INTO CLIENT5    
SELECT C.CL_CODE,BIRTHDATE=DOB,SEX,ACTIVEFROM=ACTIVE_DATE,INTERACTMODE,    
REPATRIATAC=(CASE WHEN LEN(REPATRIAT_BANK) = 0 THEN 1 ELSE 0 END),    
REPATRIATBANK=REPATRIAT_BANK,REPATRIATACNO=REPATRIAT_BANK_AC_NO,    
INTRODUCER,APPROVER,KYCFORM=CHK_KYC_FORM,BANKCERT=CHK_BANK_CERTIFICATE,    
PASSPORT=(CASE WHEN PASSPORT_NO <> '' THEN 1 ELSE 0 END), PASSPORTDTL=PASSPORT_NO,    
VOTERSID=(CASE WHEN VOTERSID_NO <> '' THEN 1 ELSE 0 END), VOTERSIDDTL = VOTERSID_NO,    
ITRETURN=(CASE WHEN IT_RETURN_YR <> '' THEN 1 ELSE 0 END), ITRETURNDTL=IT_RETURN_YR,    
DRIVELICEN=(CASE WHEN LICENCE_NO <> '' THEN 1 ELSE 0 END), DRIVELICENDTL = LICENCE_NO,    
RATIONCARD=(CASE WHEN RAT_CARD_NO <> '' THEN 1 ELSE 0 END), RATIONCARDDTL = RAT_CARD_NO,    
CORPDTLRECD=CHK_CORPORATE_DEED,CORPDEED=CHK_CORP_DTLS_RECD,    
ANUALREPORT=CHK_ANNUAL_REPORT,NETWORTHCERT=CHK_NETWORTH_CERT,INACTIVEFROM=INACTIVE_FROM,    
P_ADDRESS1,P_ADDRESS2,P_ADDRESS3,P_CITY,P_STATE,P_NATION,P_PHONE,P_ZIP,ADDEMAILID,    
PASSPORTDATEOFISSUE=PASSPORT_ISSUED_ON,PASSPORTPLACEOFISSUE=PASSPORT_ISSUED_AT,    
VOTERIDDATEOFISSUE=VOTERSID_ISSUED_ON,VOTERIDPLACEOFISSUE=VOTERSID_ISSUED_AT,    
ITRETURNDATEOFFILING=IT_RETURN_FILED_ON,LICENCENODATEOFISSUE=LICENCE_ISSUED_ON,    
LICENCENOPLACEOFISSUE=LICENCE_ISSUED_AT,RATIONCARDDATEOFISSUE=RAT_CARD_ISSUED_ON,    
RATIONCARDPLACEOFISSUE=RAT_CARD_ISSUED_AT,CLIENT_AGRE_DT=CLIENT_AGREEMENT_ON,REGR_NO=REGR_NO,    
REGR_PLACE=REGR_AT,REGR_DATE=REGR_ON,REGR_AUTH=REGR_AUTHORITY,INTROD_CLIENT_ID=INTRODUCER_ID,    
INTROD_RELATION=INTRODUCER_RELATION,    
ANY_OTHER_ACC=OTHER_AC_NO,SETT_MODE,DEALING_WITH_OTHRER_TM=ISNULL(DEALING_WITH_OTHER_TM,''),    
SYSTUMDATE=SYSTEMDATE,PASSPORTEXPDATE=PASSPORT_EXPIRES_ON,DRIVEEXPDATE=LICENCE_EXPIRES_ON,DIRECTOR_NAME     
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
AND C.CL_CODE = D.CL_CODE    
    
DELETE FROM INSTCLIENT_TBL WHERE PARTYCODE IN ( SELECT PARTY_CODE     
       FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
       WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
       AND C.CL_CODE = D.CL_CODE )    
    
/* INSTCLIENT_TBL INSERT QUERY     
INSERT INTO INSTCLIENT_TBL    
SELECT PARTY_CODE, ROUNDPRICE, ROUNDBROKERAGE, ROUNDNETRATE, NO_OF_COPIES, RES1 = 0, RES2 = 0, RES3 = 0, RES4 = 0    
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D, ROUNDPARAM R    
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT      
AND C.CL_CODE = D.CL_CODE     
AND D.ROUND_STYLE = R.ROUNDSTYLE */   

IF @SEGMENT = 'CAPITAL' OR @SEGMENT = 'SLBS' 
BEGIN
	UPDATE CLIENTBROK_SCHEME SET TO_DATE = LEFT(BROK_EFF_DATE - 1,11) + ' 23:59:59'
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	     WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
	     AND C.CL_CODE = D.CL_CODE     
	     AND C.PARTY_CODE = CLIENTBROK_SCHEME.PARTY_CODE    
	     AND TO_DATE LIKE 'DEC 31 2049%'    
	    
	/* CLIENTBROK_SCHEME INSERT QUERY FOR TRD NORMAL */    
	INSERT INTO CLIENTBROK_SCHEME    
	SELECT PARTY_CODE, TABLE_NO = TRD_BROK, SCHEME_TYPE = 'TRD', SCRIP_CD = 'ALL',     
	TRADE_TYPE = 'NRM', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'    
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
	AND C.CL_CODE = D.CL_CODE    
	    
	/* CLIENTBROK_SCHEME INSERT QUERY FOR DEL NORMAL */    
	INSERT INTO CLIENTBROK_SCHEME    
	SELECT PARTY_CODE, TABLE_NO = DEL_BROK, SCHEME_TYPE = 'DEL', SCRIP_CD = 'ALL',     
	TRADE_TYPE = 'NRM', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'    
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
	AND C.CL_CODE = D.CL_CODE    
	    
	/* CLIENTBROK_SCHEME INSERT QUERY FOR TRD INS */    
	INSERT INTO CLIENTBROK_SCHEME    
	SELECT PARTY_CODE, TABLE_NO = INST_TRD_BROK, SCHEME_TYPE = 'TRD', SCRIP_CD = 'ALL',     
	TRADE_TYPE = 'INS', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'    
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
	AND C.CL_CODE = D.CL_CODE    
	    
	/* CLIENTBROK_SCHEME INSERT QUERY FOR DEL INS */    
	INSERT INTO CLIENTBROK_SCHEME    
	SELECT PARTY_CODE, TABLE_NO = INST_DEL_BROK, SCHEME_TYPE = 'DEL', SCRIP_CD = 'ALL',     
	TRADE_TYPE = 'INS', BROK_SCHEME, FROM_DATE = LEFT(BROK_EFF_DATE,11), TO_DATE = 'DEC 31 2049 23:59:59'    
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
	AND C.CL_CODE = D.CL_CODE    
	    
	UPDATE CLIENTTAXES_NEW SET TODATE = TRD_EFF_DT - 1     
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	     WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
	     AND C.CL_CODE = D.CL_CODE     
	     AND C.PARTY_CODE = CLIENTTAXES_NEW.PARTY_CODE    
	     AND CLIENTTAXES_NEW.TODATE LIKE 'DEC 31 2049%'    
	      
	/* CLIENTTAXES_NEW INSERT QUERY FOR TRD */    
	INSERT INTO CLIENTTAXES_NEW    
	SELECT D.EXCHANGE, 1, PARTY_CODE, CL_TYPE, TRANS_CAT = 'TRD', INSURANCE_CHRG = TRD_STT,    
	TURNOVER_TAX = TRD_TRAN_CHRGS, OTHER_CHRG = TRD_OTHER_CHRGS, SEBITURN_TAX = TRD_SEBI_FEES,     
	BROKER_NOTE = TRD_STAMP_DUTY, DEMAT_INSURE = 0, SERVICE_TAX = 0, TAX1 = 0, TAX2 = 0, TAX3 = 0, TAX4 = 0,     
	TAX5 = 0, TAX6 = 0, TAX7 = 0, TAX8 = 0, TAX9 = 0, TAX10 = 0, LATEST = 1, STATE = '', FROMDATE = LEFT(TRD_EFF_DT,11),    
	TODATE = 'DEC 31 2049 23:59',     
	ROUND_TO = ROUND_TO_DIGIT, 
    ROFIG = (CASE WHEN ROUNDING_METHOD = 'ACTUAL' THEN 0 ELSE ROUND_TO_PAISE END),     
	ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'     
	               THEN 0.5    
	               WHEN ROUNDING_METHOD = 'NEXT'    
	               THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1     
	                          THEN -0.01    
	                          ELSE -0.1    
	                     END)                   
	        WHEN ROUNDING_METHOD = 'PREVIOUS'     
	               THEN (CASE WHEN ABS(ROUND_TO_PAISE) = -1
	                          THEN 0.000001   
	                          ELSE 0.000001
	                     END)                   
	        WHEN ROUNDING_METHOD = 'BANKER' OR ROUNDING_METHOD = 'BANKERS'
	               THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 5    
	                          THEN -2.5    
	                          ELSE 2.5    
	                     END)                   
	          END ),     
	NOZERO = (CASE WHEN ROUNDING_METHOD = 'ACTUAL' THEN 1 
				  ELSE 0 END)    
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
	AND C.CL_CODE = D.CL_CODE    
	    
	/* CLIENTTAXES_NEW INSERT QUERY FOR DEL */    
	INSERT INTO CLIENTTAXES_NEW    
	SELECT D.EXCHANGE, 1, PARTY_CODE, CL_TYPE, TRANS_CAT = 'DEL', INSURANCE_CHRG = DEL_STT,    
	TURNOVER_TAX = DEL_TRAN_CHRGS, OTHER_CHRG = DEL_OTHER_CHRGS, SEBITURN_TAX = DEL_SEBI_FEES,     
	BROKER_NOTE = DEL_STAMP_DUTY, DEMAT_INSURE = 0, SERVICE_TAX = 0, TAX1 = 0, TAX2 = 0, TAX3 = 0, TAX4 = 0,     
	TAX5 = 0, TAX6 = 0, TAX7 = 0, TAX8 = 0, TAX9 = 0, TAX10 = 0, LATEST = 1, STATE = '', FROMDATE = LEFT(DEL_EFF_DT,11),     
	TODATE = 'DEC 31 2049 23:59',     
	ROUND_TO = ROUND_TO_DIGIT, ROFIG = (CASE WHEN ROUNDING_METHOD = 'ACTUAL' THEN 0 ELSE ROUND_TO_PAISE END),     
	ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'     
	               THEN 0.5    
	               WHEN ROUNDING_METHOD = 'NEXT'    
	               THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1     
	                          THEN -0.01    
	                          ELSE -0.1    
	                     END)                   
	        WHEN ROUNDING_METHOD = 'PREVIOUS'     
	               THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1     
	                          THEN 0.000001    
	                          ELSE 0.000001    
	                     END)                   
	        WHEN ROUNDING_METHOD = 'BANKER' OR ROUNDING_METHOD = 'BANKERS'
	               THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 5    
	                          THEN -2.5    
	                          ELSE 2.5    
	                     END)                   
	          END ),     
	NOZERO = (CASE WHEN ROUNDING_METHOD = 'ACTUAL' THEN 1 
				  ELSE 0 END)   
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
	AND C.CL_CODE = D.CL_CODE 

	DELETE FROM CLIENTTAXES_NEW WHERE FROMDATE > TODATE
	DELETE FROM CLIENTBROK_SCHEME WHERE FROM_DATE > TO_DATE

END

IF @SEGMENT = 'FUTURES'
BEGIN
	UPDATE FOCLIENTBROKSCHEME SET DATE_TO = LEFT(BROK_EFF_DATE - 1,11) + ' 23:59:59'
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT
	AND C.CL_CODE = D.CL_CODE     
	AND C.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE    
	AND DATE_TO LIKE 'DEC 31 2049%'

	INSERT INTO FOCLIENTBROKSCHEME    
	SELECT PARTY_CODE, DATE_FROM = LEFT(BROK_EFF_DATE,11), DATE_TO = 'DEC 31 2049 23:59:59',
	FUT_BROKTABLE = FUT_BROK, OPT_BROKTABLE = FUT_OPT_BROK, 
	FUT_EXP_BROKTABLE = FUT_FUT_FIN_BROK, OPT_EXC_BROKTABLE = FUT_OPT_EXC,
	COMM_DEL_BROKTABLE = DEL_BROK, BROK_SCHEME, 
	OPT_BROK_COMPUTEON = (CASE WHEN FUT_BROK_APPLICABLE = 0
	    			   THEN 'PRICE' 
				   WHEN FUT_BROK_APPLICABLE = 1
				   THEN 'SPRICE'   
	    			   ELSE 'SSPRICE' 
			       END)
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
	AND C.CL_CODE = D.CL_CODE

	UPDATE FOCLIENTTAXES SET DATE_TO = BROK_EFF_DATE - 1     
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
	AND C.CL_CODE = D.CL_CODE     
	AND C.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE    
	AND FOCLIENTTAXES.DATE_TO LIKE 'DEC 31 2049%'

	INSERT INTO FOCLIENTTAXES    
	SELECT PARTY_CODE, DATE_FROM = LEFT(BROK_EFF_DATE,11), DATE_TO = 'DEC 31 2049 23:59',
	FUT_INSURANCE_CHRG = TRD_STT, FUT_TURNOVER_TAX = TRD_TRAN_CHRGS, 
	FUT_OTHER_CHRG = TRD_OTHER_CHRGS, FUT_SEBITURN_TAX = TRD_SEBI_FEES,     
	FUT_BROKER_NOTE = TRD_STAMP_DUTY,
	OPT_INSURANCE_CHRG = DEL_STT, OPT_TURNOVER_TAX = DEL_TRAN_CHRGS, 
	OPT_OTHER_CHRG = DEL_OTHER_CHRGS, OPT_SEBITURN_TAX = DEL_SEBI_FEES,     
	OPT_BROKER_NOTE = DEL_STAMP_DUTY,
	ROUND_TO = ROUND_TO_DIGIT, ROFIG = (CASE WHEN ROUNDING_METHOD = 'ACTUAL' THEN 0 ELSE ROUND_TO_PAISE END),     
	ERRNUM = (CASE WHEN ROUNDING_METHOD = 'ACTUAL'     
	               THEN 0.5    
	               WHEN ROUNDING_METHOD = 'NEXT'    
	               THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 1     
	                          THEN -0.01    
	                          ELSE -0.1    
	                     END)                   
	        WHEN ROUNDING_METHOD = 'PREVIOUS'     
	               THEN (CASE WHEN ABS(ROUND_TO_PAISE) = -1
	                          THEN 0.000001 
	                          ELSE 0.000001  
	                     END)                   
	        WHEN ROUNDING_METHOD = 'BANKER' OR ROUNDING_METHOD = 'BANKERS'
	               THEN (CASE WHEN ABS(ROUND_TO_PAISE) = 5    
	                          THEN -2.5    
	                          ELSE 2.5    
	                     END)                   
	          END ),     
	NOZERO = (CASE WHEN ROUNDING_METHOD = 'ACTUAL' THEN 1 
				  ELSE 0 END)
	FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
	WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
	AND C.CL_CODE = D.CL_CODE

	DELETE FROM FOCLIENTTAXES WHERE DATE_FROM > DATE_TO
	DELETE FROM FOCLIENTBROKSCHEME WHERE DATE_FROM > DATE_TO

END

IF @SEGMENT = 'SLBS'
BEGIN
	UPDATE CLIENT_DETAILS_TMP SET UCC_CODE = ISNULL(U.UCC_CODE, '') 
	FROM UCC_CLIENT U
	WHERE U.PARTY_CODE = CLIENT_DETAILS_TMP.PARTY_CODE
END

DELETE FROM UCC_CLIENT    
WHERE PARTY_CODE IN ( SELECT PARTY_CODE     
      FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
      AND C.CL_CODE = D.CL_CODE)     
    
INSERT INTO UCC_CLIENT    
SELECT PARTY_CODE, LONG_NAME, CONTRACT_PERSON = INTRODUCER, CLEARINGNO1 = '', CLEARINGNO2 = '', CLEARINGNO3 = '',    
CLEARINGNO4 = '', MAPIDID = MAPIN_ID, FMCODE = FMCODE, DEALING_WITH_OTHER_TM, ANY_OTHER_ACC = OTHER_AC_NO,     
FAMILY_CODE1 = '', FAMILY_CODE2 = '', FAMILY_CODE3 = '', FAMILY_CODE4 = '', REMARK = '', UCC_CODE,     
STPPROVIDER = '', DUMMY1 = '', DUMMY2 = ''    
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
AND C.CL_CODE = D.CL_CODE

DELETE FROM DELPARTYFLAG   
WHERE PARTY_CODE IN ( SELECT PARTY_CODE     
      FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
      WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
      AND C.CL_CODE = D.CL_CODE)     

INSERT INTO DELPARTYFLAG
SELECT PARTY_CODE, DEBIT_BALANCE, INTER_SETT
FROM CLIENT_DETAILS_TMP C, CLIENT_BROK_DETAILS_TMP D    
WHERE D.EXCHANGE = @EXCHANGE AND D.SEGMENT = @SEGMENT    
AND C.CL_CODE = D.CL_CODE

DELETE FROM CLIENT4 WHERE PARTY_CODE IN (SELECT OLD_PARTY_CODE FROM CLIENT_PARTY_MODIFICATION_TMP)
AND DEPOSITORY IN ('NSDL', 'CDSL')

DELETE FROM MULTICLTID WHERE PARTY_CODE IN (SELECT OLD_PARTY_CODE FROM CLIENT_PARTY_MODIFICATION_TMP)


------------------------GST

UPDATE TBL_CLIENT_GST_DATA SET EFF_TO_DATE = LEFT(GETDATE()-1,11) + ' 23:59:59'
FROM CLIENT_DETAILS_TMP
WHERE TBL_CLIENT_GST_DATA.PARTY_CODE = CLIENT_DETAILS_TMP.CL_CODE
AND EFF_TO_DATE >= LEFT(GETDATE(),11)

DELETE FROM TBL_CLIENT_GST_DATA
WHERE EFF_FROM_DATE > EFF_TO_DATE

INSERT INTO TBL_CLIENT_GST_DATA 
SELECT PARTY_CODE, BRANCH_CD, SUB_BROKER, LONG_NAME, L_ADDRESS1, L_ADDRESS2, L_ADDRESS3, L_CITY, L_STATE, L_ZIP, L_NATION, GST_NO, GST_LOCATION,
EFF_FROM_DATE = LEFT(GETDATE(),11), EFF_TO_DATE = 'DEC 31 2049 23:59:59', CREATED_ON = GETDATE()
FROM CLIENT_DETAILS_TMP

--------------------------END GST

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADMIN_DELUSER
-- --------------------------------------------------
CREATE PROC [dbo].[ADMIN_DELUSER]
(
	@FLDAUTO VARCHAR(500),
	@ADMIN_NAME VARCHAR(50),
	@IPADD VARCHAR(20)
)

AS
/*
ADMIN_DELUSER '19,10,11,13','BROKER_CHECKER','10.11.12.74' 
SELECT * FROM TBLUSERCONTROLMASTER_JRNL
SELECT * FROM TBLPRADNYAUSERS_LOG WHERE FLDUSERNAME  ='TESTBHRT'

ROLLBACK
*/
CREATE TABLE #TEMPID
(
	ID INT
)

DECLARE 
	@LOOPID INT,
	@LOOPDATA VARCHAR(300),
	@GLOBALDATE DATETIME,
	@ADMINID INT

SET @GLOBALDATE = GETDATE()
SELECT  @ADMINID = FLDAUTO_ADMIN FROM TBLADMIN WHERE FLDNAME = @ADMIN_NAME

BEGIN TRAN
	SET @LOOPID = 1
	WHILE 1 = 1
	 BEGIN
		SET @LOOPDATA = .DBO.PIECE(@FLDAUTO,',',@LOOPID)

		IF @LOOPDATA = '' OR @LOOPDATA IS NULL
		 BEGIN
			BREAK
		 END
			
		INSERT INTO #TEMPID(ID) VALUES(@LOOPDATA)
		SET @LOOPID = @LOOPID + 1 
	 END	
SELECT * FROM #TEMPID
	INSERT INTO TBLPRADNYAUSERS_LOG 
		(FLDAUTO,
		FLDUSERNAME,
		FLDPASSWORD,
		FLDFIRSTNAME,
		FLDMIDDLENAME,
		FLDLASTNAME,
		FLDSEX,
		FLDADDRESS1,
		FLDADDRESS2,
		FLDPHONE1,
		FLDPHONE2,
		FLDCATEGORY,
		FLDADMINAUTO,
		FLDSTNAME,
		PWD_EXPIRY_DATE,
		EDIT_FLAG,
		CREATED_BY,
		CREATED_ON,
		MACHINEIP,
		FLDLOG_DATA)
	SELECT 
		FLDAUTO,
		FLDUSERNAME,
		FLDPASSWORD,
		FLDFIRSTNAME,
		FLDMIDDLENAME,
		FLDLASTNAME,
		FLDSEX,
		FLDADDRESS1,
		FLDADDRESS2,
		FLDPHONE1,
		FLDPHONE2,
		FLDCATEGORY,
		FLDADMINAUTO,
		FLDSTNAME,
		PWD_EXPIRY_DATE,
		'D',
		@ADMIN_NAME,
		@GLOBALDATE,
		@IPADD,
		'DELETEENTRY' 
	FROM 
		TBLPRADNYAUSERS, #TEMPID
	WHERE 
		FLDAUTO = ID

	INSERT INTO TBLUSERCONTROLMASTER_JRNL
		(FLDAUTO,
		FLDUSERID,
		FLDPWDEXPIRY,
		FLDMAXATTEMPT,
		FLDATTEMPTCNT,
		FLDSTATUS,
		FLDLOGINFLAG,
		FLDACCESSLVL,
		FLDIPADD,
		FLDTIMEOUT,
		FLDFIRSTLOGIN,
		FLDFORCELOGOUT,
		FLDUPDTBY,
		FLDUPDTDT)
	SELECT 
		FLDAUTO,
		FLDUSERID,
		FLDPWDEXPIRY,
		FLDMAXATTEMPT,
		FLDATTEMPTCNT,
		FLDSTATUS,
		FLDLOGINFLAG,
		FLDACCESSLVL,
		FLDIPADD,
		FLDTIMEOUT,
		FLDFIRSTLOGIN,
		FLDFORCELOGOUT,
		@ADMINID,
		@GLOBALDATE 
	FROM 
		TBLUSERCONTROLMASTER TBC, #TEMPID
	WHERE 
		FLDUSERID = ID
	
	DELETE 
		TB
	FROM 
		TBLPRADNYAUSERS TB,  #TEMPID 
	WHERE 
		FLDAUTO = ID
COMMIT

DROP TABLE #TEMPID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ADMIN_GET_CATEGORIES
-- --------------------------------------------------
CREATE PROC [dbo].[ADMIN_GET_CATEGORIES]
(
	@FLDADMINAUTO INT
)
AS
/*
ADMIN_GET_CATEGORIES 26
SELECT * FROM TBLADMIN
SELECT * FROM TBLCATEGORY
DROP PROC  GET_CATEGORIES
*/

SELECT 
	FLDAUTO_ADMIN, FLDSTATUS 
INTO 
	#TEMP
FROM 
	TBLADMIN 
WHERE FLDSTATUS = (SELECT FLDSTATUS FROM TBLADMIN WHERE FLDAUTO_ADMIN = @FLDADMINAUTO)

--SELECT * FROM #TEMP

SELECT * FROM TBLCATEGORY, #TEMP WHERE FLDAUTO_ADMIN = FLDADMINAUTO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGDIRECTFOGENCONTRACT_EXALLOC
-- --------------------------------------------------
/*
DROP PROCEDURE BBGDIRECTFOGENCONTRACT_EXALLOC

EXECUTE BBGDIRECTFOGENCONTRACT_EXALLOC

*/
CREATE PROCEDURE [dbo].[BBGDIRECTFOGENCONTRACT_EXALLOC]
AS 
DECLARE @@PARTY VARCHAR(12),
        @@SETT_TYPE VARCHAR(2),  
        @@CONTNO VARCHAR(7),
        @@CONTNOPARTIPANT VARCHAR(7),
        @@PARTICIPANTCODE VARCHAR(15),
        @@MEMBERCODE VARCHAR(15),
        @@SAUDA_DATE VARCHAR(11),
        @@ORDER_NO VARCHAR(20),
        @@SCRIP_CD VARCHAR(12),
        @@SERIES VARCHAR(2),
        @@SELL_BUY INT,
        @@STYLE INT,
        @@STARTDATE VARCHAR(11),
        @@ENDDATE VARCHAR(11),
        @@FLAG INT,
        @@CONT CURSOR  ,  
        @@PARTYCONT CURSOR    ,
        @@CURSETTTYPE VARCHAR(2),
        @@INSCONTNO VARCHAR(7),
 	@@INSTTYPE VARCHAR(6),
	@@SYMBOL VARCHAR(12),
	@@EXPIRYDATE DATETIME,
	@@STRIKEPRICE MONEY,
	@@OPTIONTYPE VARCHAR(2),      
        @@MAXCONTNOS INT,
        @@MAXCONNOI  INT,
        @@BBGCONTCUR CURSOR,
        @@GETMAXCONTNO CURSOR,
        @@INSCONT   VARCHAR(4)

SET @@PARTYCONT = CURSOR FOR
     SELECT DISTINCT SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) FROM BBGFOSETTLEMENT
     OPEN @@PARTYCONT
     FETCH NEXT  FROM @@PARTYCONT INTO   @@SAUDA_DATE
CLOSE @@PARTYCONT
     
SET @@PARTYCONT = CURSOR FOR 
    SELECT MEMBERCODE,STYLE=ISNULL(STYLE,0) FROM FOOWNER
    OPEN @@PARTYCONT
    FETCH NEXT  FROM @@PARTYCONT INTO   @@MEMBERCODE,@@STYLE
CLOSE @@PARTYCONT

PRINT ' INSERTING INTO BBGSETTLEMENT FROM CONFIRMVIEW '

IF @@STYLE = 0
BEGIN
     SET @@BBGCONTCUR =  CURSOR FOR
     SELECT ISNULL(MAX(CONVERT(INT,CONTRACTNO)),0) FROM FOSETTLEMENT WHERE SAUDA_DATE LIKE  @@SAUDA_DATE +'%' AND CONVERT(INT,CONTRACTNO) <> 0
END


IF @@STYLE = 1 
BEGIN
     SET @@BBGCONTCUR = CURSOR FOR	
     SELECT ISNULL(CONVERT(INT,CONTRACTNO),0) FROM CONTGEN WHERE START_DATE <= @@SAUDA_DATE AND END_DATE >= @@SAUDA_DATE +' 23:59:59'
END 


                   
OPEN @@BBGCONTCUR
FETCH NEXT FROM @@BBGCONTCUR INTO @@MAXCONTNOS
CLOSE @@BBGCONTCUR

PRINT @@SAUDA_DATE
PRINT @@MAXCONTNOS

PRINT 'INSERTED ALL RECORDS INTO BBGFOSETTLEMENT '
/* NOW FIRST WE WILL UPDATE THE PARTIES WHO HAVE PREVIOUS CONTRACTS IN EITHER SCRIP OR ORDER */    
     SET @@PARTYCONT = CURSOR FOR
     SELECT DISTINCT I.PARTY_CODE,I.CONTRACTNO,I.ORDER_NO,I.INST_TYPE,I.SYMBOL,I.EXPIRYDATE,
	I.STRIKE_PRICE,I.OPTION_TYPE,INSCONT 
       FROM FOSETTLEMENT I ,CLIENT2 C2 
	WHERE I.SAUDA_DATE LIKE @@SAUDA_DATE +'%'  
	AND I.PARTY_CODE = C2.PARTY_CODE 
     AND CONVERT(INT,I.CONTRACTNO) <> 0
     ORDER BY I.PARTY_CODE,I.INST_TYPE,I.SYMBOL,I.EXPIRYDATE,I.STRIKE_PRICE,I.OPTION_TYPE,I.ORDER_NO,I.CONTRACTNO
     OPEN @@PARTYCONT
     FETCH NEXT  FROM @@PARTYCONT INTO  @@PARTY,@@CONTNO,@@ORDER_NO,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE,@@INSCONT
     WHILE @@FETCH_STATUS = 0
     BEGIN
          IF @@INSCONT = 'N' OR @@INSCONT IS NULL OR @@INSCONT = ''
          BEGIN
               UPDATE BBGFOSETTLEMENT SET CONTRACTNO = @@CONTNO 
               WHERE
               PARTY_CODE = @@PARTY
          END
          IF @@INSCONT = 'O' 
 BEGIN 
         UPDATE BBGFOSETTLEMENT SET CONTRACTNO = @@CONTNO 
               WHERE
               PARTY_CODE = @@PARTY
               AND
               ORDER_NO = @@ORDER_NO
          END
          IF @@INSCONT = 'S' 
          BEGIN 
               UPDATE BBGFOSETTLEMENT SET CONTRACTNO = @@CONTNO 
               WHERE
               PARTY_CODE = @@PARTY
               AND
               INST_TYPE = @@INSTTYPE
               AND
               SYMBOL = @@SYMBOL
               AND
               EXPIRYDATE = @@EXPIRYDATE
               AND
               STRIKE_PRICE = @@STRIKEPRICE
               AND
               OPTION_TYPE = @@OPTIONTYPE
          END
     FETCH NEXT  FROM @@PARTYCONT INTO  @@PARTY,@@CONTNO,@@ORDER_NO,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE,@@INSCONT
END 
 CLOSE @@PARTYCONT
     SELECT @@PARTY=''
        
     SET @@PARTYCONT = CURSOR FOR 
     SELECT DISTINCT BBGFOSETTLEMENT.PARTY_CODE  FROM BBGFOSETTLEMENT,CLIENT2,CLIENT1 
     WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE AND INSCONT =  'N'
     AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'
     ORDER BY BBGFOSETTLEMENT.PARTY_CODE 
     OPEN @@PARTYCONT
     FETCH NEXT  FROM @@PARTYCONT INTO   @@PARTY
     WHILE @@FETCH_STATUS = 0
     BEGIN
          SELECT @@CONTNO =@@MAXCONTNOS +1
          SELECT @@MAXCONTNOS = @@MAXCONTNOS + 1
          SELECT @@PARTY,@@CONTNO
          UPDATE BBGFOSETTLEMENT SET CONTRACTNO = STUFF('0000000', 8 - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO) WHERE PARTY_CODE =@@PARTY 
		PRINT @@MAXCONTNOS

          FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY
     END
     CLOSE @@PARTYCONT
     SELECT @@PARTY=''

/* NOW ORDER WISE    */
     SET @@PARTYCONT = CURSOR FOR 
     SELECT DISTINCT BBGFOSETTLEMENT.PARTY_CODE,BBGFOSETTLEMENT.ORDER_NO FROM BBGFOSETTLEMENT,CLIENT2,CLIENT1
     WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE
     AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'
     AND INSCONT  =  'O'
     ORDER BY BBGFOSETTLEMENT.PARTY_CODE,BBGFOSETTLEMENT.ORDER_NO  
     OPEN @@PARTYCONT
     FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY,@@ORDER_NO
     WHILE @@FETCH_STATUS = 0
     BEGIN
          SELECT @@CONTNO = 0
          SELECT @@CONTNO =@@MAXCONTNOS +1
          SELECT @@MAXCONTNOS = @@MAXCONTNOS + 1
          UPDATE BBGFOSETTLEMENT SET CONTRACTNO = STUFF('0000000', 8 - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO) WHERE
          PARTY_CODE =@@PARTY 
          AND ORDER_NO = @@ORDER_NO

		PRINT @@MAXCONTNOS
          FETCH NEXT  FROM @@PARTYCONT INTO  @@PARTY,@@ORDER_NO
     END
/*     IF @@STYLE = 1 
     UPDATE CONTGEN SET CONTRACTNO = @@CONTNO WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE  */
 
     CLOSE @@PARTYCONT
     SELECT @@PARTY=''
     SELECT @@ORDER_NO = ''	
/* NOW SCRIP_WISE   */
      
        SET @@PARTYCONT = CURSOR FOR 
        SELECT DISTINCT BBGFOSETTLEMENT.PARTY_CODE,BBGFOSETTLEMENT.INST_TYPE,BBGFOSETTLEMENT.SYMBOL,BBGFOSETTLEMENT.EXPIRYDATE,BBGFOSETTLEMENT.STRIKE_PRICE,BBGFOSETTLEMENT.OPTION_TYPE 
	FROM BBGFOSETTLEMENT,CLIENT2,CLIENT1
	WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE AND INSCONT =  'S'
     	AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'
        ORDER BY BBGFOSETTLEMENT.PARTY_CODE,BBGFOSETTLEMENT.INST_TYPE,BBGFOSETTLEMENT.SYMBOL,BBGFOSETTLEMENT.EXPIRYDATE,BBGFOSETTLEMENT.STRIKE_PRICE,BBGFOSETTLEMENT.OPTION_TYPE 
        OPEN @@PARTYCONT
        FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE
        SELECT @@PARTY,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE
        WHILE @@FETCH_STATUS = 0
        BEGIN
             SELECT @@CONTNO = 0
             SELECT @@CONTNO =@@MAXCONTNOS +1
    	     SELECT @@MAXCONTNOS = @@MAXCONTNOS + 1
             UPDATE BBGFOSETTLEMENT SET CONTRACTNO = STUFF('0000000', 8 - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO) WHERE
             PARTY_CODE =@@PARTY 
             AND
             INST_TYPE = @@INSTTYPE
             AND
             SYMBOL = @@SYMBOL
             AND
             EXPIRYDATE = @@EXPIRYDATE
             AND
             STRIKE_PRICE = @@STRIKEPRICE
             AND
             OPTION_TYPE = @@OPTIONTYPE

		PRINT @@MAXCONTNOS
        FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE
        END
        CLOSE @@PARTYCONT

PRINT @@CONTNO	
PRINT @@MAXCONTNOS


	IF @@MAXCONTNOS IS NOT NULL
	BEGIN

	UPDATE FOOWNER SET CONTNO = @@MAXCONTNOS

        IF @@STYLE = 1
	BEGIN
	UPDATE CONTGEN SET CONTRACTNO = @@MAXCONTNOS WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE 
	END

	END
DEALLOCATE @@PARTYCONT

PRINT @@MAXCONTNOS
PRINT @@CONTNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.BBGDIRECTFOGENCONTRACT_EXPIRY
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[BBGDIRECTFOGENCONTRACT_EXPIRY]
AS 
DECLARE @@PARTY VARCHAR(12),
        @@SETT_TYPE VARCHAR(2),  
        @@CONTNO VARCHAR(7),
        @@CONTNOPARTIPANT VARCHAR(7),
        @@PARTICIPANTCODE VARCHAR(15),
        @@MEMBERCODE VARCHAR(15),
        @@SAUDA_DATE VARCHAR(11),
        @@ORDER_NO VARCHAR(20),
        @@SCRIP_CD VARCHAR(12),
        @@SERIES VARCHAR(2),
        @@SELL_BUY INT,
        @@STYLE INT,
        @@STARTDATE VARCHAR(11),
        @@ENDDATE VARCHAR(11),
        @@FLAG INT,
        @@CONT CURSOR  ,  
        @@PARTYCONT CURSOR    ,
        @@CURSETTTYPE VARCHAR(2),
        @@INSCONTNO VARCHAR(7),
 	@@INSTTYPE VARCHAR(6),
	@@SYMBOL VARCHAR(12),
	@@EXPIRYDATE DATETIME,
	@@STRIKEPRICE MONEY,
	@@OPTIONTYPE VARCHAR(2),      
        @@MAXCONTNOS INT,
        @@MAXCONNOI  INT,
        @@BBGCONTCUR CURSOR,
        @@GETMAXCONTNO CURSOR,
        @@INSCONT   VARCHAR(4)
SET @@PARTYCONT = CURSOR FOR
     SELECT DISTINCT SAUDA_DATE = LEFT(CONVERT(VARCHAR,ACTIVITYTIME,109),11) FROM  FOTRADE 
     OPEN @@PARTYCONT
     FETCH NEXT  FROM @@PARTYCONT INTO   @@SAUDA_DATE
CLOSE @@PARTYCONT
     
SET @@PARTYCONT = CURSOR FOR 
    SELECT MEMBERCODE,STYLE=ISNULL(STYLE,0) FROM FOOWNER
    OPEN @@PARTYCONT
    FETCH NEXT  FROM @@PARTYCONT INTO   @@MEMBERCODE,@@STYLE
CLOSE @@PARTYCONT

IF @@STYLE = 0
BEGIN
     SET @@BBGCONTCUR =  CURSOR FOR
     SELECT ISNULL(MAX(CONVERT(INT,CONTRACTNO)),0) FROM FOSETTLEMENT
     WHERE SAUDA_DATE LIKE  @@SAUDA_DATE +'%'
     AND CONVERT(INT,CONTRACTNO) <> 0
END

IF @@STYLE = 1 
BEGIN
     SET @@BBGCONTCUR = CURSOR FOR	
     SELECT ISNULL(CONVERT(INT,CONTRACTNO),0) FROM CONTGEN WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE 
END 
                   
OPEN @@BBGCONTCUR
FETCH NEXT FROM @@BBGCONTCUR INTO @@MAXCONTNOS
CLOSE @@BBGCONTCUR

     SET @@PARTYCONT = CURSOR FOR
	SELECT DISTINCT I.PARTY_CODE,I.CONTRACTNO,I.ORDER_NO,I.INST_TYPE,I.SYMBOL,I.EXPIRYDATE,
	I.STRIKE_PRICE,I.OPTION_TYPE,INSCONT 
	FROM FOSETTLEMENT I ,CLIENT2 C2 
	WHERE I.SAUDA_DATE LIKE @@SAUDA_DATE +'%'  
	AND I.PARTY_CODE = C2.PARTY_CODE 
	AND CONVERT(INT,I.CONTRACTNO) <> 0
	ORDER BY I.PARTY_CODE,I.INST_TYPE,I.SYMBOL,I.EXPIRYDATE,I.STRIKE_PRICE,I.OPTION_TYPE,I.ORDER_NO,I.CONTRACTNO
     OPEN @@PARTYCONT
     FETCH NEXT  FROM @@PARTYCONT INTO  @@PARTY,@@CONTNO,@@ORDER_NO,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE,@@INSCONT
     WHILE @@FETCH_STATUS = 0
     BEGIN
          IF @@INSCONT = 'N' OR @@INSCONT IS NULL OR @@INSCONT = ''
          BEGIN
               UPDATE BBGFOSETTLEMENT SET CONTRACTNO = @@CONTNO 
               WHERE
               PARTY_CODE = @@PARTY
          END
          IF @@INSCONT = 'O' 
	 BEGIN 
         UPDATE BBGFOSETTLEMENT SET CONTRACTNO = @@CONTNO 
               WHERE
               PARTY_CODE = @@PARTY
               AND
               ORDER_NO = @@ORDER_NO
          END
          IF @@INSCONT = 'S' 
          BEGIN 
               UPDATE BBGFOSETTLEMENT SET CONTRACTNO = @@CONTNO 
               WHERE
               PARTY_CODE = @@PARTY
               AND
               INST_TYPE = @@INSTTYPE
               AND
               SYMBOL = @@SYMBOL
               AND
               EXPIRYDATE = @@EXPIRYDATE
               AND
               STRIKE_PRICE = @@STRIKEPRICE
               AND
               OPTION_TYPE = @@OPTIONTYPE
          END
     FETCH NEXT  FROM @@PARTYCONT INTO  @@PARTY,@@CONTNO,@@ORDER_NO,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE,@@INSCONT
     END     
     CLOSE @@PARTYCONT
     SELECT @@PARTY=''
        
     SET @@PARTYCONT = CURSOR FOR 
     SELECT DISTINCT BBGFOSETTLEMENT.PARTY_CODE  FROM BBGFOSETTLEMENT,CLIENT2,CLIENT1 
     WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE AND INSCONT NOT IN ('O','S')
     AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'  AND PRICE <> 0
     ORDER BY BBGFOSETTLEMENT.PARTY_CODE 
     OPEN @@PARTYCONT
     FETCH NEXT  FROM @@PARTYCONT INTO   @@PARTY
     WHILE @@FETCH_STATUS = 0
     BEGIN
          SELECT @@CONTNO =@@MAXCONTNOS +1
          SELECT @@MAXCONTNOS = @@MAXCONTNOS + 1
          SELECT @@PARTY,@@CONTNO
          UPDATE BBGFOSETTLEMENT SET CONTRACTNO = STUFF('0000000', 8 - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO) WHERE
          PARTY_CODE =@@PARTY 
          FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY
     END
     CLOSE @@PARTYCONT
     SELECT @@PARTY=''
     SET @@PARTYCONT = CURSOR FOR 
     SELECT DISTINCT BBGFOSETTLEMENT.PARTY_CODE,BBGFOSETTLEMENT.ORDER_NO FROM BBGFOSETTLEMENT,CLIENT2,CLIENT1
     WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE
     AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'   AND PRICE <> 0
     AND INSCONT  =  'O'
     ORDER BY BBGFOSETTLEMENT.PARTY_CODE,BBGFOSETTLEMENT.ORDER_NO  
     OPEN @@PARTYCONT
     FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY,@@ORDER_NO
     WHILE @@FETCH_STATUS = 0
     BEGIN
          SELECT @@CONTNO = 0
          SELECT @@CONTNO =@@MAXCONTNOS +1
          SELECT @@MAXCONTNOS = @@MAXCONTNOS + 1
          UPDATE BBGFOSETTLEMENT SET CONTRACTNO = STUFF('0000000', 8 - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO) WHERE
          PARTY_CODE =@@PARTY 
          AND ORDER_NO = @@ORDER_NO
          FETCH NEXT  FROM @@PARTYCONT INTO  @@PARTY,@@ORDER_NO
     END
 
     CLOSE @@PARTYCONT
     SELECT @@PARTY=''
     SELECT @@ORDER_NO = ''	
      
        SET @@PARTYCONT = CURSOR FOR 
        SELECT DISTINCT BBGFOSETTLEMENT.PARTY_CODE,BBGFOSETTLEMENT.INST_TYPE,BBGFOSETTLEMENT.SYMBOL,BBGFOSETTLEMENT.EXPIRYDATE,BBGFOSETTLEMENT.STRIKE_PRICE,BBGFOSETTLEMENT.OPTION_TYPE 
	FROM BBGFOSETTLEMENT,CLIENT2,CLIENT1
	WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE AND INSCONT =  'S'
     	AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'   AND PRICE <> 0
        ORDER BY BBGFOSETTLEMENT.PARTY_CODE,BBGFOSETTLEMENT.INST_TYPE,BBGFOSETTLEMENT.SYMBOL,BBGFOSETTLEMENT.EXPIRYDATE,BBGFOSETTLEMENT.STRIKE_PRICE,BBGFOSETTLEMENT.OPTION_TYPE 
        OPEN @@PARTYCONT
        FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE
        SELECT @@PARTY,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE
        WHILE @@FETCH_STATUS = 0
        BEGIN
             SELECT @@CONTNO = 0
             SELECT @@CONTNO =@@MAXCONTNOS +1
    	     SELECT @@MAXCONTNOS = @@MAXCONTNOS + 1
             UPDATE BBGFOSETTLEMENT SET CONTRACTNO = STUFF('0000000', 8 - LEN(@@CONTNO), LEN(@@CONTNO), @@CONTNO) WHERE
             PARTY_CODE =@@PARTY 
             AND
             INST_TYPE = @@INSTTYPE
             AND
             SYMBOL = @@SYMBOL
             AND
             EXPIRYDATE = @@EXPIRYDATE
             AND
             STRIKE_PRICE = @@STRIKEPRICE
             AND
             OPTION_TYPE = @@OPTIONTYPE
        FETCH NEXT  FROM @@PARTYCONT INTO @@PARTY,@@INSTTYPE,@@SYMBOL,@@EXPIRYDATE,@@STRIKEPRICE,@@OPTIONTYPE
        END
        CLOSE @@PARTYCONT

	IF @@MAXCONTNOS IS NOT NULL
	BEGIN
		UPDATE FOOWNER SET CONTNO = @@MAXCONTNOS 
	
        	IF @@STYLE = 1 
		BEGIN
		UPDATE CONTGEN SET CONTRACTNO = @@MAXCONTNOS WHERE @@SAUDA_DATE >= START_DATE AND @@SAUDA_DATE <= END_DATE 
		END
	END
DEALLOCATE @@PARTYCONT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCULATE_STAMP_DUTY
-- --------------------------------------------------


  
  
  
  
CREATE PROC [dbo].[CALCULATE_STAMP_DUTY]           
(                    
 @SAUDA_DATE VARCHAR(11),              
 @FROMPARTY VARCHAR(10)='0',                     
 @TOPARTY VARCHAR(10)='ZZZZZZZ'                    
)              
AS              
DECLARE @OWNERSTATE VARCHAR(50)    
    
SELECT @OWNERSTATE = STATE FROM FOOWNER              
          
IF @SAUDA_DATE = '' OR @SAUDA_DATE = '%' BEGIN  RETURN  END          
            
BEGIN TRAN          
          
CREATE TABLE #STAMP           
(          
  [PARTY_CODE]         [VARCHAR](10),          
  [BROKER_NOTE]        NUMERIC (36,12),          
  [L_STATE]            [VARCHAR](50),          
  [TURNOVER]           NUMERIC (36,12),          
  [ROUNDEDTURNOVER]    NUMERIC (36,12),          
  [TOBECHRG_STAMPDUTY] NUMERIC (36,12)          
)          
          
CREATE TABLE #CLIENTLIST           
(          
  PARTYCODE VARCHAR(10)          
)          
          
INSERT INTO #CLIENTLIST          
SELECT PARTY_CODE          
FROM   FOCLIENTTAXES (NOLOCK)          
WHERE  @SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO          
       AND FUT_BROKER_NOTE = 0          
                                       
INSERT INTO #CLIENTLIST          
SELECT PARTY_CODE          
FROM   CLIENT2 (NOLOCK)          
WHERE  BROKERNOTE = 0          
AND    PARTY_CODE NOT IN (SELECT PARTYCODE FROM #CLIENTLIST)     

     
                              
/*UPDATING REST RECORDS BASED ON CLIENT'S STATE*/          
UPDATE FOSETTLEMENT          
SET    BROKER_CHRG = 0          
WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'          
       AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY          
       AND EXISTS (SELECT PARTYCODE          
                   FROM   #CLIENTLIST (NOLOCK) WHERE PARTY_CODE = PARTYCODE)          
                    
        
        
UPDATE FOSETTLEMENT          
SET    BROKER_CHRG = ABS(CASE           
                        WHEN CLIENT1.CL_TYPE = 'PRO' THEN PROSTAMPDUTY          
                        ELSE TRDSTAMPDUTY          
                      END * (CASE           
                               WHEN BROKER_NOTE_ON = 'PRICE' THEN PRICE          
                               ELSE CASE           
                                      WHEN BROKER_NOTE_ON = 'SPRICE' THEN CASE           
                                                                WHEN STRIKE_PRICE = 0 THEN PRICE          
                                                                ELSE STRIKE_PRICE          
                                                              END          
                                      ELSE  STRIKE_PRICE + PRICE          
                                    END          
                             END) * TRADEQTY / 100)          
FROM   CLIENT1 (NOLOCK),          
       CLIENT2 (NOLOCK),          
       STATE_MASTER (NOLOCK),          
       (SELECT BROKER_NOTE_ON,TRANS_CAT,INST_TYPE FROM FOTAXES (NOLOCK) WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE) FOTAXES                
WHERE  CLIENT1.CL_CODE = CLIENT2.CL_CODE          
       AND CLIENT2.PARTY_CODE = FOSETTLEMENT.PARTY_CODE          
       AND L_STATE = STATE_MASTER.STATE          
       AND SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE          
       AND FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'          
       AND FOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY          
       AND AUCTIONPART <> 'CA'          
       AND FOTAXES.INST_TYPE = LEFT(FOSETTLEMENT.INST_TYPE,3)        
       AND FOTAXES.TRANS_CAT = CASE         
     WHEN CLIENT2.TRAN_CAT ='PRO' THEN 'PRO' ELSE         
      CASE WHEN FOSETTLEMENT.AUCTIONPART ='' THEN 'TRD' ELSE 'DEL' END         
     END        
       AND NOT EXISTS (SELECT PARTYCODE          
                       FROM   #CLIENTLIST (NOLOCK) WHERE CLIENT2.PARTY_CODE = PARTYCODE)  
                       
                       
                       
                       
---------------------------FOR RAJASTHAN-----------------------------------
   UPDATE FOSETTLEMENT                    
SET    BROKER_CHRG = ABS(CASE                     
                        WHEN CLIENT1.CL_TYPE = 'PRO' THEN PROSTAMPDUTY                    
                        ELSE DELSTAMPDUTY                    
                      END * (CASE                     
                               WHEN BROKER_NOTE_ON = 'PRICE' THEN PRICE                    
                               ELSE CASE                     
                                      WHEN BROKER_NOTE_ON = 'SPRICE' THEN CASE                     
                                                                WHEN STRIKE_PRICE = 0 THEN PRICE                    
                                                                ELSE STRIKE_PRICE                    
                                                              END                    
                                       ELSE  STRIKE_PRICE + PRICE                   
                                    END                    
                             END) * TRADEQTY / 100)                    
FROM   CLIENT1 (NOLOCK),                    
       CLIENT2 (NOLOCK),                    
       STATE_MASTER (NOLOCK),                    
       (SELECT BROKER_NOTE_ON,TRANS_CAT,INST_TYPE FROM FOTAXES (NOLOCK) WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE) FOTAXES                          
WHERE  CLIENT1.CL_CODE = CLIENT2.CL_CODE                    
       AND CLIENT2.PARTY_CODE = FOSETTLEMENT.PARTY_CODE                    
       AND L_STATE = STATE_MASTER.STATE                    
       AND SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE                    
       AND FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'                    
       AND FOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY   
       AND L_State='RAJASTHAN'             
      AND AUCTIONPART <> 'CA'                    
       AND FOTAXES.INST_TYPE = LEFT(FOSETTLEMENT.INST_TYPE,3)    
       AND LEFT(FOSETTLEMENT.INST_TYPE,3)='OPT'                
       AND FOTAXES.TRANS_CAT = CASE                   
     WHEN CLIENT2.TRAN_CAT ='PRO' THEN 'PRO' ELSE                   
      CASE WHEN FOSETTLEMENT.AUCTIONPART ='' THEN 'TRD' ELSE 'DEL' END                   
     END                  
       AND NOT EXISTS (SELECT PARTYCODE                    
                      FROM   #CLIENTLIST (NOLOCK) WHERE CLIENT2.PARTY_CODE = PARTYCODE)       
  
/*  
UPDATE FOSETTLEMENT                    
SET    BROKER_CHRG=0  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'     
AND PARTY_CODE IN (SELECT CL_CODE FROM CLIENT1 WHERE L_STATE='RAJASTHAN')  
AND SELL_BUY=1   
AND LEFT(INST_TYPE,3)='FUT'  */
-----------------------------------------DONE----------------------------------------------                            
                                
        
/*UPDATING REST RECORDS BASED ON MEMEBER'S STATE*/          
UPDATE FOSETTLEMENT          
SET    BROKER_CHRG = ABS(CASE           
                        WHEN CLIENT1.CL_TYPE = 'PRO' THEN PROSTAMPDUTY          
                        ELSE TRDSTAMPDUTY          
                      END * (CASE           
                               WHEN BROKER_NOTE_ON = 'PRICE' THEN PRICE          
                               ELSE CASE           
                                      WHEN BROKER_NOTE_ON = 'SPRICE'           
        THEN CASE           
                                         WHEN STRIKE_PRICE = 0 THEN PRICE          
                              ELSE STRIKE_PRICE          
                                       END          
                                      ELSE  STRIKE_PRICE + PRICE       
            END          
                             END) * TRADEQTY / 100)          
FROM   CLIENT1 (NOLOCK),          
       CLIENT2 (NOLOCK),          
       STATE_MASTER (NOLOCK),          
       (SELECT BROKER_NOTE_ON,TRANS_CAT,INST_TYPE FROM FOTAXES (NOLOCK) WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE) FOTAXES          
WHERE  CLIENT1.CL_CODE = CLIENT2.CL_CODE          
       AND CLIENT2.PARTY_CODE = FOSETTLEMENT.PARTY_CODE          
       AND STATE = @OWNERSTATE    
       AND L_STATE NOT IN (SELECT STATE          
                           FROM   STATE_MASTER  (NOLOCK)        
                           WHERE  @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE)          
       AND FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'          
       AND FOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY          
       AND AUCTIONPART <> 'CA'          
       AND FOTAXES.INST_TYPE = LEFT(FOSETTLEMENT.INST_TYPE,3)        
       AND FOTAXES.TRANS_CAT = CASE         
     WHEN CLIENT2.TRAN_CAT ='PRO' THEN 'PRO' ELSE         
      CASE WHEN FOSETTLEMENT.AUCTIONPART ='' THEN 'TRD' ELSE 'DEL' END         
     END        
       AND NOT EXISTS (SELECT PARTYCODE          
                 FROM   #CLIENTLIST (NOLOCK) WHERE CLIENT2.PARTY_CODE = PARTYCODE)          
                     

/*            
UPDATE FOSETTLEMENT SET BROKER_CHRG = ((FLOOR(( BROKER_CHRG * POWER(10,ROUND_TO)+ ROFIG + ERRNUM)/(ROFIG + NOZERO )) * (ROFIG + NOZERO))/POWER(10,ROUND_TO))  
FROM FOCLIENTTAXES (NOLOCK)  
WHERE FOSETTLEMENT.SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO  
AND FOSETTLEMENT.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE  
AND SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'  
 */          
INSERT INTO #STAMP          
SELECT   S.PARTY_CODE,          
         BROKER_NOTE = SUM(BROKER_CHRG),          
         L_STATE,          
         TURNOVER = ABS(SUM(TRADEQTY * (CASE           
                                      WHEN BROKER_NOTE_ON = 'PRICE' THEN PRICE          
                                      ELSE CASE           
                                             WHEN BROKER_NOTE_ON = 'SPRICE'           
           THEN CASE           
                                                       WHEN STRIKE_PRICE = 0 THEN PRICE          
                                                       ELSE STRIKE_PRICE          
                                                     END          
                                              ELSE  STRIKE_PRICE + PRICE         
                                           END          
                                    END))),          
         ROUNDEDTURNOVER = ABS(SUM(TRADEQTY * (CASE           
                                             WHEN BROKER_NOTE_ON = 'PRICE' THEN PRICE          
                                             ELSE CASE           
                                                    WHEN BROKER_NOTE_ON = 'SPRICE'           
             THEN CASE           
                                                       WHEN STRIKE_PRICE = 0 THEN PRICE          
            ELSE STRIKE_PRICE         
                         END          
                                                   ELSE  STRIKE_PRICE + PRICE          
                                                  END          
                                           END))),          
         TOBECHRG_STAMPDUTY = SUM(BROKER_CHRG)          
FROM     FOSETTLEMENT S,          
         CLIENT1 C1 (NOLOCK),          
         CLIENT2 C2 (NOLOCK),          
         (SELECT BROKER_NOTE_ON,TRANS_CAT,INST_TYPE FROM FOTAXES (NOLOCK) WHERE @SAUDA_DATE BETWEEN FROM_DATE AND TO_DATE) FOTAXES           
WHERE    SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'          
         AND C1.CL_CODE = C2.CL_CODE          
         AND C2.PARTY_CODE = S.PARTY_CODE          
         AND C2.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY          
         AND TRADEQTY > 0          
         AND PRICE > 0          
        AND AUCTIONPART <> 'CA'          
         AND NOT EXISTS (SELECT PARTYCODE          
          FROM   #CLIENTLIST (NOLOCK) WHERE C2.PARTY_CODE = PARTYCODE)          
         AND L_STATE IN (SELECT STATE          
                         FROM   STATE_MASTER          
                         WHERE  MIN_MULTIPLIER > 0          
                                 OR MAXIMUM_LIMIT > 0          
                                    AND @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE)          
       AND FOTAXES.INST_TYPE = LEFT(S.INST_TYPE,3)        
       AND FOTAXES.TRANS_CAT = CASE         
     WHEN C2.TRAN_CAT ='PRO' THEN 'PRO' ELSE         
      CASE WHEN S.AUCTIONPART ='' THEN 'TRD' ELSE 'DEL' END         
     END        
GROUP BY S.PARTY_CODE,L_STATE          
                   
UPDATE #STAMP          
SET    ROUNDEDTURNOVER = PRADNYA.DBO.ROUNDEDTURNOVER(TURNOVER,FOR_TURNOVER)          
FROM   STATE_MASTER          
WHERE  L_STATE = STATE          
       AND FOR_TURNOVER > 0          
       AND @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE          
                                                             
UPDATE #STAMP          
SET    TOBECHRG_STAMPDUTY = (CASE           
                               WHEN ROUNDEDTURNOVER / FOR_TURNOVER * MIN_MULTIPLIER > MAXIMUM_LIMIT          
                                    AND MAXIMUM_LIMIT > 0 THEN MAXIMUM_LIMIT          
                               WHEN ROUNDEDTURNOVER / FOR_TURNOVER * MIN_MULTIPLIER > BROKER_NOTE           
     THEN ROUNDEDTURNOVER / FOR_TURNOVER * MIN_MULTIPLIER          
                               WHEN BROKER_NOTE > MAXIMUM_LIMIT          
                                    AND MAXIMUM_LIMIT > 0 THEN MAXIMUM_LIMIT          
                               ELSE BROKER_NOTE          
                             END)          
FROM   STATE_MASTER          
WHERE  L_STATE = STATE          
       AND FOR_TURNOVER > 0          
       AND @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE          
                                                             
UPDATE FOSETTLEMENT          
SET    BROKER_CHRG = 0          
WHERE  EXISTS (SELECT PARTY_CODE          
               FROM   #STAMP          
               WHERE  FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'          
                      AND #STAMP.PARTY_CODE = FOSETTLEMENT.PARTY_CODE)          
                        
SELECT   PARTY_CODE,          
         TRADESCRIPSELL = MIN(TRADE_NO + ORDER_NO + CONVERT(CHAR(1),SELL_BUY))          
INTO     #SETTSTAMP          
FROM     FOSETTLEMENT          
WHERE    SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'          
        AND AUCTIONPART <> 'CA'          
         AND TRADEQTY > 0          
         AND PRICE > 0          
         AND EXISTS (SELECT PARTY_CODE          
                     FROM   #STAMP          
                     WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'          
                            AND #STAMP.PARTY_CODE = FOSETTLEMENT.PARTY_CODE)          GROUP BY PARTY_CODE          
                   
UPDATE FOSETTLEMENT          
SET    BROKER_CHRG = TOBECHRG_STAMPDUTY          
FROM   #STAMP,          
       #SETTSTAMP          
WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE +' 23:59'          
       AND #STAMP.PARTY_CODE = FOSETTLEMENT.PARTY_CODE          
       AND #SETTSTAMP.PARTY_CODE = #STAMP.PARTY_CODE          
       AND #SETTSTAMP.TRADESCRIPSELL = FOSETTLEMENT.TRADE_NO + FOSETTLEMENT.ORDER_NO +          
     CONVERT(CHAR(1),FOSETTLEMENT.SELL_BUY)          
                                                                                                 
COMMIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCULATE_STAMP_DUTY_BAK_24102018
-- --------------------------------------------------

CREATE  PROC [dbo].[CALCULATE_STAMP_DUTY_BAK_24102018]        
(              
 @SAUDA_DATE VARCHAR(11),        
 @FROMPARTY VARCHAR(10)='0',               
 @TOPARTY VARCHAR(10)='ZZZZZZZ'              
)        
AS        
        
    
IF @SAUDA_DATE = '' OR @SAUDA_DATE = '%' BEGIN  RETURN  END    
      
BEGIN TRAN    
    
CREATE TABLE #STAMP     
(    
  [PARTY_CODE]         [VARCHAR](10),    
  [BROKER_NOTE]        NUMERIC (36,12),    
  [L_STATE]            [VARCHAR](50),    
  [TURNOVER]           NUMERIC (36,12),    
  [ROUNDEDTURNOVER]    NUMERIC (36,12),    
  [TOBECHRG_STAMPDUTY] NUMERIC (36,12)    
)    
    
CREATE TABLE #CLIENTLIST     
(    
  PARTYCODE VARCHAR(10)    
)    

SELECT DISTINCT PARTY_CODE INTO #FOSETT FROM FOSETTLEMENT
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'    
       AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY    

SELECT * INTO #CLIENT1
FROM CLIENT1
WHERE EXISTS (SELECT PARTY_CODE FROM #FOSETT WHERE #FOSETT.PARTY_CODE = CL_CODE)

SELECT * INTO #CLIENT2
FROM CLIENT2
WHERE EXISTS (SELECT PARTY_CODE FROM #FOSETT WHERE #FOSETT.PARTY_CODE = CL_CODE)

INSERT INTO #CLIENTLIST    
SELECT PARTY_CODE    
FROM   FOCLIENTTAXES (NOLOCK)    
WHERE  @SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO    
       AND FUT_BROKER_NOTE = 0 AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
                                 
INSERT INTO #CLIENTLIST    
SELECT PARTY_CODE    
FROM   CLIENT2 (NOLOCK)    
WHERE  BROKERNOTE = 0    
AND    PARTY_CODE NOT IN (SELECT PARTYCODE FROM #CLIENTLIST)    
                        
/*UPDATING REST RECORDS BASED ON CLIENT'S STATE*/    
UPDATE FOSETTLEMENT    
SET    BROKER_CHRG = 0    
WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'  
       AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY    
       AND EXISTS (SELECT PARTYCODE    
                   FROM   #CLIENTLIST (NOLOCK) WHERE PARTY_CODE = PARTYCODE)    
                     
UPDATE FOSETTLEMENT    
SET    BROKER_CHRG = ROUND((CASE     
                        WHEN CLIENT1.CL_TYPE = 'PRO' THEN PROSTAMPDUTY    
                        ELSE TRDSTAMPDUTY    
                      END * (CASE     
                               WHEN TAXESFLAG = 0 THEN PRICE    
                               ELSE CASE     
                                      WHEN TAXESFLAG = 1 THEN CASE     
                                                                WHEN STRIKE_PRICE = 0 THEN PRICE    
                                                                ELSE STRIKE_PRICE    
                                                              END    
                                      ELSE STRIKE_PRICE + PRICE    
                                    END    
                             END) * TRADEQTY  / 100),4)
FROM   #CLIENT1 CLIENT1,    
       #CLIENT2 CLIENT2,    
       STATE_MASTER,    
       FOOWNER    
WHERE  CLIENT1.CL_CODE = CLIENT2.CL_CODE    
       AND CLIENT2.PARTY_CODE = FOSETTLEMENT.PARTY_CODE    
       AND L_STATE = STATE_MASTER.STATE    
       AND SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE    
       AND FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'    
       AND FOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY    
       AND AUCTIONPART <> 'CA'    
       AND NOT EXISTS (SELECT PARTYCODE    
                       FROM   #CLIENTLIST (NOLOCK) WHERE CLIENT2.PARTY_CODE = PARTYCODE)    
                          
/*UPDATING REST RECORDS BASED ON MEMEBER'S STATE*/    
UPDATE FOSETTLEMENT    
SET    BROKER_CHRG = ROUND((CASE     
                        WHEN CLIENT1.CL_TYPE = 'PRO' THEN PROSTAMPDUTY    
                        ELSE TRDSTAMPDUTY    
                      END * (CASE     
                               WHEN TAXESFLAG = 0 THEN PRICE    
                               ELSE CASE     
                                      WHEN TAXESFLAG = 1     
     THEN CASE     
                                         WHEN STRIKE_PRICE = 0 THEN PRICE    
                                         ELSE STRIKE_PRICE    
                                       END    
                                      ELSE STRIKE_PRICE + PRICE    
                                    END    
                             END) * TRADEQTY  / 100),4)  
FROM   #CLIENT1 CLIENT1,    
       #CLIENT2 CLIENT2,    
       STATE_MASTER,    
       FOOWNER    
WHERE  CLIENT1.CL_CODE = CLIENT2.CL_CODE    
       AND CLIENT2.PARTY_CODE = FOSETTLEMENT.PARTY_CODE    
       AND STATE_MASTER.STATE = FOOWNER.STATE 
       AND L_STATE NOT IN (SELECT STATE    
                           FROM   STATE_MASTER    
                           WHERE  @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE)    
       AND FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'   
       AND FOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY    
       AND AUCTIONPART <> 'CA'    
       AND NOT EXISTS (SELECT PARTYCODE    
                 FROM   #CLIENTLIST (NOLOCK) WHERE CLIENT2.PARTY_CODE = PARTYCODE)    
                         
     
INSERT INTO #STAMP    
SELECT   S.PARTY_CODE,    
         BROKER_NOTE = SUM(BROKER_CHRG),    
         L_STATE,    
         TURNOVER = SUM(TRADEQTY  * (CASE     
                                      WHEN TAXESFLAG = 0 THEN PRICE    
                                      ELSE CASE     
                                             WHEN TAXESFLAG = 1     
      THEN CASE     
                                                       WHEN STRIKE_PRICE = 0 THEN PRICE    
                                                       ELSE STRIKE_PRICE    
                                                     END    
                                             ELSE STRIKE_PRICE + PRICE    
                                           END    
                                    END)),    
         ROUNDEDTURNOVER = SUM(TRADEQTY  * (CASE     
                                             WHEN TAXESFLAG = 0 THEN PRICE    
                                             ELSE CASE     
                                                    WHEN TAXESFLAG = 1     
       THEN CASE     
                                                       WHEN STRIKE_PRICE = 0 THEN PRICE    
                                                       ELSE STRIKE_PRICE    
                                                     END    
                                                    ELSE STRIKE_PRICE + PRICE    
                                                  END    
                                           END)),    
         TOBECHRG_STAMPDUTY = SUM(BROKER_CHRG)    
FROM     FOSETTLEMENT S,    
         #CLIENT1 C1,    
         #CLIENT2 C2,    
         FOOWNER    
WHERE    SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'  
         AND C1.CL_CODE = C2.CL_CODE    
         AND C2.PARTY_CODE = S.PARTY_CODE    
         AND S.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY    
         AND TRADEQTY > 0    
         AND PRICE > 0    
         AND AUCTIONPART <> 'CA'    
         AND NOT EXISTS (SELECT PARTYCODE    
                         FROM   #CLIENTLIST (NOLOCK) WHERE S.PARTY_CODE = PARTYCODE)    
         AND L_STATE IN (SELECT STATE    
                         FROM   STATE_MASTER    
                         WHERE  MIN_MULTIPLIER > 0    
                                 OR MAXIMUM_LIMIT > 0    
                                    AND @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE)    
GROUP BY S.PARTY_CODE,L_STATE    
             
UPDATE #STAMP    
SET    ROUNDEDTURNOVER = PRADNYA.DBO.ROUNDEDTURNOVER(TURNOVER,FOR_TURNOVER)    
FROM   STATE_MASTER    
WHERE  L_STATE = STATE    
       AND FOR_TURNOVER > 0    
       AND @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE    
                                                       
UPDATE #STAMP    
SET    TOBECHRG_STAMPDUTY = ROUND((CASE     
                               WHEN ROUNDEDTURNOVER / FOR_TURNOVER * MIN_MULTIPLIER > MAXIMUM_LIMIT    
                                    AND MAXIMUM_LIMIT > 0 THEN MAXIMUM_LIMIT    
                               WHEN ROUNDEDTURNOVER / FOR_TURNOVER * MIN_MULTIPLIER > BROKER_NOTE     
     THEN ROUNDEDTURNOVER / FOR_TURNOVER * MIN_MULTIPLIER    
                               WHEN BROKER_NOTE > MAXIMUM_LIMIT    
                                    AND MAXIMUM_LIMIT > 0 THEN MAXIMUM_LIMIT    
                               ELSE BROKER_NOTE    
                             END),4)    
FROM   STATE_MASTER    
WHERE  L_STATE = STATE    
       AND FOR_TURNOVER > 0    
       AND @SAUDA_DATE BETWEEN YEAR_START_DATE AND YEAR_END_DATE    
                                                       
UPDATE FOSETTLEMENT    
SET    BROKER_CHRG = 0    
WHERE FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'    
                      AND EXISTS (SELECT PARTY_CODE    
 FROM   #STAMP    
               WHERE  #STAMP.PARTY_CODE = FOSETTLEMENT.PARTY_CODE)    
                  
SELECT   PARTY_CODE,    
         TRADESCRIPSELL = MIN(TRADE_NO + ORDER_NO + CONVERT(CHAR(1),SELL_BUY))    
INTO     #SETTSTAMP    
FROM     FOSETTLEMENT    
WHERE    SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'   
         AND AUCTIONPART <> 'CA'    
         AND TRADEQTY > 0    
         AND PRICE > 0    
         AND EXISTS (SELECT PARTY_CODE    
                     FROM   #STAMP    
                     WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'   
                            AND #STAMP.PARTY_CODE = FOSETTLEMENT.PARTY_CODE)    
GROUP BY PARTY_CODE    
             
UPDATE FOSETTLEMENT    
SET    BROKER_CHRG = TOBECHRG_STAMPDUTY    
FROM   #STAMP,    
       #SETTSTAMP    
WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'
	   AND FOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY    
       AND #STAMP.PARTY_CODE = FOSETTLEMENT.PARTY_CODE    
       AND #SETTSTAMP.PARTY_CODE = #STAMP.PARTY_CODE    
       AND #SETTSTAMP.TRADESCRIPSELL = FOSETTLEMENT.TRADE_NO + FOSETTLEMENT.ORDER_NO +    
     CONVERT(CHAR(1),FOSETTLEMENT.SELL_BUY)    
                                                                                           
COMMIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CALCULATESTAMPDUTY
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[CALCULATESTAMPDUTY] (@SAUDADATE VARCHAR(11))   
AS  
/*  
UPDATE FOSETTLEMENT SET BROKER_CHRG =(((FLOOR((PRICE*TRADEQTY*BOOKTYPE/INSTRUMENT*FUT_BROKER_NOTE/100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+  
		FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) *
		(FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO   ) ) /  POWER(10,FOCLIENTTAXES.ROUND_TO))
FROM  CLIENT1 (NOLOCK), CLIENT2 (NOLOCK), FOCLIENTTAXES (NOLOCK)
WHERE 
	CLIENT1.CL_CODE = CLIENT2.CL_CODE
	AND CLIENT2.PARTY_CODE = FOSETTLEMENT.PARTY_CODE
	AND SAUDA_DATE BETWEEN @SAUDADATE AND @SAUDADATE + ' 23:59'
	AND FOSETTLEMENT.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE
  	AND FOSETTLEMENT.SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO
	AND FUT_BROKER_NOTE <> 0
*/
EXEC CALCULATE_STAMP_DUTY @SAUDADATE, 0, 'ZZZZZZZZZZ'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CBO_ACCESSIBLEUSER
-- --------------------------------------------------
CREATE PROC [dbo].[CBO_ACCESSIBLEUSER]  
 @REPORTCODE INT,  
 @USERCATEGORY VARCHAR(2000)  
AS  
/*  
 CBO_ACCESSIBLEUSER 1056, 388  
*/  
  
IF (SELECT COUNT(1) FROM TBLCATMENU WHERE FLDREPORTCODE = @REPORTCODE AND FLDCATEGORYCODE LIKE '%' + @USERCATEGORY + '%') > 0  
 SELECT ALLOWED = 1  
ELSE  
 SELECT ALLOWED = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECK_USER
-- --------------------------------------------------
CREATE PROC [dbo].[CHECK_USER]      
(      
 @UID VARCHAR(50),      
 @STNAME VARCHAR(50),      
 @RESULT INT OUTPUT      
)       
/*      
CHECK_USER 'DFS','',''
      
SELECT * FROM MSAJAG..CLIENT_DETAILS WHERE CL_CODE = '00000031'       
SELECT * FROM TBLPRADNYAUSERS WHERE FLDUSERNAME ='TEST'
*/       
     
AS      
 DECLARE @COUNT SMALLINT      
       
SET @COUNT = 0       
      
IF UPPER(@STNAME) = 'CLIENT'      
 BEGIN      
 SELECT @COUNT = COUNT(*) FROM MSAJAG.DBO.CLIENT_DETAILS WHERE CL_CODE = @UID      
       
 IF @COUNT = 0       
  BEGIN      
  SET @RESULT = 2 --'NOTEXISTS'      
  SELECT @RESULT      
  RETURN      
  END      
 END       

SELECT @COUNT = COUNT(FLDNAME) FROM TBLUSERBLOCK WHERE FLDNAME LIKE '%'+@UID OR FLDNAME LIKE @UID+'%'
IF @COUNT <> 0       
 BEGIN      
 SET @RESULT = 4 --'INVALID'      
 SELECT @RESULT      
 RETURN      
 END      

      
SELECT       
 @COUNT = COUNT(FLDUSERNAME) FROM TBLPRADNYAUSERS (NOLOCK) WHERE FLDUSERNAME LIKE @UID      
      
IF @COUNT <> 0       
 BEGIN      
 SET @RESULT = 1 --'EXSITSINMASTER'      
 SELECT @RESULT      
 RETURN      
 END      
ELSE      
 BEGIN      
 SET @RESULT = 0 --'OK'      
 SELECT @RESULT      
 RETURN      
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '7=99U92WJ6X9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!0'
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_11Jan2019
-- --------------------------------------------------


CREATE PROC [dbo].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '0=>9S52WJ7Y9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!0'
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_16112018
-- --------------------------------------------------


CREATE PROC [dbo].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '0=>9S52WJ7Y9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!0'
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_24May2019
-- --------------------------------------------------

CREATE PROC [DBO].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '7=99U72WJ7Y9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!0'
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHECKVERSION_bkup_20Jan2020
-- --------------------------------------------------


CREATE PROC [dbo].[CHECKVERSION]
AS

DECLARE 
@ERRCODE1 VARCHAR(100),
@ERRCODE2 VARCHAR(20),
@ERRCODE3 VARCHAR(2),
@ERRCODE4 VARCHAR(10),
@ERRCODE5 VARCHAR(10),
@ERRCODE6 VARCHAR(100),
@ERRCODE7 VARCHAR(100),
@ERRCODE8 VARCHAR(100),
@ERRCODE9 VARCHAR(100),
@ERRCODE10 VARCHAR(10),
@ERRCODE11 VARCHAR(10),
@ERRCODE12 VARCHAR(100),
@ERRCODE13 VARCHAR(10),
@ERRCODE14 VARCHAR(100)

SET @ERRCODE1 = '<&{:9-{75)[*/-@!7]/:@-F<5@&:3]4Y9&<#7-}6T8?*/?@Y$@<[.)*Y4@[/>$)YT([(.$)&HK'
SET @ERRCODE2 = '5,/9S52WJ7Y9S8xTKD2 '
SET @ERRCODE3 = 'R4'
SET @ERRCODE4 = '$!0'
SET @ERRCODE5 = '///\3?0'
SET @ERRCODE6 = 'LICENSE PERIOD OVER '
SET @ERRCODE7 = 'LICENSE PERIOD WILL BE EXPIRED ON'
SET @ERRCODE8 = ''
SET @ERRCODE9 = 'LICENSE NOT VALID'
SET @ERRCODE10 = 'N75'
SET @ERRCODE11 = 'R7X'
SET @ERRCODE12 = 'NO OF BRANCH LICENSE IS REACHED TO ALERT LIMIT, PLEASE GET ADDITIONAL LICENSE'
SET @ERRCODE13 = 'R5X'
SET @ERRCODE14 = 'BRANCH LICENSE HAD REACHED TO ITS LIMIT, PLEASE GET ADDITIONAL LICENSE'

SELECT
 ERRCODE1 = @ERRCODE1,
 ERRCODE2 = @ERRCODE2,
 ERRCODE3 = @ERRCODE3,
 ERRCODE4 = @ERRCODE4,
 ERRCODE5 = @ERRCODE5,
 ERRCODE6 = @ERRCODE6,
 ERRCODE7 = @ERRCODE7,
 ERRCODE8 = @ERRCODE8,
 ERRCODE9 = @ERRCODE9,
 ERRCODE10 = @ERRCODE10,
 ERRCODE11 = @ERRCODE11,
 ERRCODE12 = @ERRCODE12,
 ERRCODE13 = @ERRCODE13,
 ERRCODE14 = @ERRCODE14

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CHKBUSINESSDATESTATUS
-- --------------------------------------------------
CREATE PROC [dbo].[CHKBUSINESSDATESTATUS] AS
	SELECT 
		COUNT(1) 
	FROM 
		V2_BUSINESS_PROCESS (NOLOCK)
	WHERE 
		OPEN_CLOSE = 1 AND 
		LEFT(BUSINESS_DATE,11) = (SELECT TOP 1 LEFT(ACTIVITYTIME,11) FROM FOTRADE)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTHORIZED_COUNT
-- --------------------------------------------------
CREATE PROC [dbo].[CLASS_AUTHORIZED_COUNT]    
(    
 @UNAME VARCHAR(30),    
 @ADMIN_NAME VARCHAR(30),  
 @CUREXCHSEG VARCHAR(50)      
)    
/*    
 CLASS_USER_COUNT 'BHA', 'ADMINISTRATOR', ''    
 SELECT * FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = 'DSS'    
EXEC CLASS_USER_COUNT 'SAMARTHLANJEKAR','BROKER','NSE~~CAPITAL'  
  
*/    
AS    
 DECLARE      
 @@EXCHANGE AS VARCHAR(3),    
 @@SEGMENT AS VARCHAR(15),    
 @@SHARESVR AS VARCHAR(20),    
 @@SHAREDB   AS VARCHAR(20),    
 @@SEGORD AS TINYINT,    
 @@SQL  AS VARCHAR(500),    
 @@MAINREC AS CURSOR    
     
  CREATE TABLE [DBO].[#RESULT]      
  (      
  EXCHANGE VARCHAR(6),       
  SEGMENT VARCHAR(10),    
  RESULT VARCHAR(100)    
  ) ON [PRIMARY]    
      
 CREATE TABLE #USERS    
 (    
  FLDUSERNAME VARCHAR(30)    
 )    
    
 IF UPPER(@ADMIN_NAME) = 'ADMINISTRATOR'  
 BEGIN  
  SET @@MAINREC = CURSOR FOR       
 SELECT EXCHANGE, SEGMENT, SHAREDB, SHARESERVER FROM PRADNYA.DBO.MULTICOMPANY_ALL WHERE PRIMARYSERVER = 1 ORDER BY 1     
 END  
 ELSE  
 BEGIN  
  SET @@MAINREC = CURSOR FOR    
 SELECT EXCHANGE, SEGMENT, SHAREDB, SHARESERVER FROM PRADNYA.DBO.MULTICOMPANY_ALL WHERE EXCHANGE + '~~' + SEGMENT =  @CUREXCHSEG  AND PRIMARYSERVER = 1 ORDER BY 1  
 END    
     
 SET @@SEGORD = 1      
 OPEN @@MAINREC      
 FETCH NEXT FROM @@MAINREC INTO @@EXCHANGE, @@SEGMENT, @@SHAREDB, @@SHARESVR     
  WHILE @@FETCH_STATUS = 0    
   BEGIN    
   IF @@SHARESVR <> @@SERVERNAME     
    BEGIN    
     SET @@SQL = " INSERT INTO #USERS SELECT FLDUSERNAME FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU WHERE TP.FLDAUTO = TU.FLDUSERID AND FLDSTATUS <> 0 AND FLDUSERNAME = '"+ @UNAME +"' "    
    END    
    ELSE    
    BEGIN     
     SET @@SQL = " INSERT INTO #USERS SELECT FLDUSERNAME #USERS FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS TP, " + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TU WHERE TP.FLDAUTO = TU.FLDUSERID AND FLDSTATUS <> 0 AND FLDUSERNAME = '"+ @UNAME +"' "    
    END    
   PRINT(@@SQL)    
   EXEC(@@SQL)     
  --SELECT * FROM #USERS     
  IF @@ROWCOUNT <> 0    
   BEGIN    
   INSERT INTO #RESULT VALUES(@@EXCHANGE,@@SEGMENT,'USER AVAILABLE')    
   END     
      
 SET @@SEGORD = @@SEGORD + 1    
 FETCH NEXT FROM @@MAINREC INTO @@EXCHANGE, @@SEGMENT, @@SHAREDB, @@SHARESVR    
 END     
    
 SELECT * FROM #RESULT    
 DROP TABLE #RESULT    
 DROP TABLE #USERS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_ALERT
-- --------------------------------------------------

CREATE PROC [dbo].[CLASS_AUTO_PROCESS_ALERT]      
AS      
      
DECLARE @SNO NUMERIC(18,0),      
  @EXCHANGE VARCHAR(3),      
  @SEGMENT VARCHAR(7),      
  @BUSINESS_DATE VARCHAR(11),      
  @PROCESS_FOR VARCHAR(30),      
  @PROCESS_STATUS INT,      
  @PROCESS_START_DATE DATETIME,      
  @PROCESS_HALTED_REASON VARCHAR(500),      
  @PROCESS_FILE_NAME VARCHAR(500),      
  @SETT_NO  VARCHAR(10),      
  @SETT_TYPE  VARCHAR(10),      
  @TO_EMAIL_ID VARCHAR(500),      
  @CC_EMAIL_ID VARCHAR(500),      
  @BCC_EMAIL_ID VARCHAR(500),      
  @ALERT_CURSOR CURSOR,      
  @BODYTEXT  VARCHAR(MAX),      
  @SUBJECTTEXT    VARCHAR(MAX),      
  @PROCESS_OUTPUT_QUERY VARCHAR(MAX),      
  @XML NVARCHAR(MAX),      
  @INTERNAL_PROCESS_ID INT,      
  @ATTACHEMENT_FILE_NAME VARCHAR(200),      
  @FILE_DWLOAD_LOCATION VARCHAR(200),      
  @FILE_DWLOAD_NAME  VARCHAR(200),  
  @SQL VARCHAR(MAX),  
  @RECCOUNT INT     
  
  
DECLARE @PROCESS_GROUP VARCHAR(100),  
  @PROCESSCUR  CURSOR,  
  @PROCESS_CNT INT,  
  @PROCESS_STATUS_CNT INT  
    
DECLARE @PDATE DATETIME  
SET @PDATE = GETDATE()  
      
OPEN SYMMETRIC KEY   Key4CertAutoProcess      
     DECRYPTION BY   CERTIFICATE CertAutoProcess       
     
SET @ALERT_CURSOR = CURSOR FOR      
SELECT SNO, D.EXCHANGE, D.SEGMENT, BUSINESS_DATE, D.PROCESS_FOR, PROCESS_STATUS, PROCESS_START_DATE,       
PROCESS_FILE_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(.DBO.FN_DATA_DECRYPT('MKTTECH.IN',D.PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),      
PROCESS_HALTED_REASON = (CASE WHEN PROCESS_STATUS = 99       
         THEN (CASE WHEN PROCESS_STARTED_DATE + ' ' + APPROX_END_TIME < @PDATE THEN 'PROCESS IS STILL GOING ON, PLEASE CHECK - STARTED AT - ' + CONVERT(VARCHAR,PROCESS_STARTED_DATE) + ' AND EXPECTED END - ' + CONVERT(VARCHAR,PROCESS_STARTED_DATE + ' ' + APPROX_END_TIME) + ' AND CHECKED AT ' + CONVERT(VARCHAR,@PDATE)   
         ELSE 'NOACTION' END)      
         WHEN PROCESS_STATUS = 0 AND PROCESS_HALTED_REASON = ''      
         THEN 'NOT YET STARTED'      
         ELSE PROCESS_HALTED_REASON END),    
TO_EMAIL_ID, CC_EMAIL_ID, BCC_EMAIL_ID,       
--TO_EMAIL_ID=CC_EMAIL_ID, CC_EMAIL_ID = '', BCC_EMAIL_ID = '',    
PROCESS_OUTPUT_QUERY = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(D.PROCESS_OUTPUT_QUERY,BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),      
D.SETT_NO, LTRIM(RTRIM(D.SETT_TYPE)), INTERNAL_PROCESS_ID, ATTACHEMENT_FILE_NAME      
FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK), TBL_AUTO_PROCESS_EMAIL E, OWNER      
WHERE PROCESS_DATE = LEFT(@PDATE,11)      
AND D.EXCHANGE = E.EXCHANGE      
AND D.SEGMENT = E.SEGMENT      
AND D.PROCESS_FOR = E.PROCESS_FOR      
AND PROCESS_STATUS_ALERT > PROCESS_STATUS_ALERT_COUNT       
AND @PDATE >= PROCESS_LAST_ALERT_DATE + ' ' + PROCESS_STATUS_ALERT_INTERVAL      
AND (D.PROCESS_START_DATE <= @PDATE + D.WAIT_PERIOD      
OR D.PROCESS_START_DATE <= @PDATE)      
AND 1 = (CASE WHEN PROCESS_STATUS = 0 AND PROCESS_HALTED_REASON = ''       
        THEN 0       
     ELSE 1      
   END)      
AND (CASE WHEN PROCESS_STATUS = 99       
         THEN (CASE WHEN PROCESS_STARTED_DATE + ' ' + APPROX_END_TIME < @PDATE THEN 'PROCESS IS STILL GOING ON, PLEASE CHECK - STARTED AT - ' + CONVERT(VARCHAR,PROCESS_STARTED_DATE) + ' AND EXPECTED END - ' + CONVERT(VARCHAR,PROCESS_STARTED_DATE + ' ' + APPROX_END_TIME) + ' AND CHECKED AT ' + CONVERT(VARCHAR,@PDATE)   
         ELSE 'NOACTION' END)      
         ELSE PROCESS_HALTED_REASON END) <> 'NOACTION'      
AND IS_DEPEND_ON = ''      
AND EMAIL_SEND_FLAG = 1  
AND PROCESS_HALTED_REASON NOT LIKE 'CAN NOT START THE%'   
AND 1 = (CASE WHEN PROCESS_STATUS = 100 AND PROCESS_OUTPUT_QUERY = '' AND ATTACHEMENT_FILE_NAME = ''  
     THEN 0  
     ELSE 1   
   END)  
AND PROCESS_STARTED_DATE LIKE LEFT(@PDATE,11) + '%'  
ORDER BY SNO      
OPEN @ALERT_CURSOR      
FETCH NEXT FROM @ALERT_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_FOR, @PROCESS_STATUS, @PROCESS_START_DATE, @PROCESS_FILE_NAME,       
       @PROCESS_HALTED_REASON, @TO_EMAIL_ID, @CC_EMAIL_ID, @BCC_EMAIL_ID, @PROCESS_OUTPUT_QUERY, @SETT_NO, @SETT_TYPE, @INTERNAL_PROCESS_ID,       
    @ATTACHEMENT_FILE_NAME      
WHILE @@FETCH_STATUS = 0      
BEGIN      
/*  
 SET @TO_EMAIL_ID = 'animesh.jain@mkttech.in'  
 SET @CC_EMAIL_ID = ''  
 SET @BCC_EMAIL_ID = ''  
*/  
 SET @BODYTEXT = 'Live SERVER - ALERT STATUS OF ' + @PROCESS_FOR + ' FOR THE EXCHANGE ' + @EXCHANGE + ' AND SEGMENT ' + @SEGMENT       
 IF LEN(@SETT_NO) <> ''       
 BEGIN      
  SET @BODYTEXT = @BODYTEXT + ' SETT NO - ' + CONVERT(VARCHAR,@SETT_NO) + ' AND SETT TYPE - ' + CONVERT(VARCHAR,@SETT_TYPE)      
 END      
 --SET @BODYTEXT = @BODYTEXT + ' FOR THE PROCESS NO - ' + CONVERT(VARCHAR,@SNO)      
 SET @SUBJECTTEXT = @BODYTEXT      
 SET @BODYTEXT = @BODYTEXT + ' <BR> ' + @PROCESS_HALTED_REASON       
 IF LEN(@PROCESS_FILE_NAME) > 0       
 BEGIN       
  IF @PROCESS_FILE_NAME NOT LIKE '%#%'      
  BEGIN      
   SET @BODYTEXT = @BODYTEXT + ' AS PER THE FILE ' + @PROCESS_FILE_NAME      
  END      
  ELSE      
  BEGIN      
   SELECT       
   @FILE_DWLOAD_LOCATION = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_LOCATION),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),      
   @FILE_DWLOAD_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE)))      
   FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK),       
   TBL_AUTO_PROCESS_MASTER M,       
   OWNER O      
   WHERE PROCESS_DATE = LEFT(@PDATE,11)      
   AND D.PROCESS_FOR = M.PROCESS_FOR      
   AND D.SNO = @SNO      
   SET @BODYTEXT = @BODYTEXT + ' NO NEW FILE PRESENT IN LOCATION ' + @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME      
  END      
 END       
      
 IF @PROCESS_OUTPUT_QUERY <> '' AND @PROCESS_STATUS <> 0 AND @ATTACHEMENT_FILE_NAME <> ''  
 BEGIN        
  --SET @PROCESS_OUTPUT_QUERY = 'EXECUTE SaveTableAsHTML @DBFetch = ''' + replace(@PROCESS_OUTPUT_QUERY,'''','''''') + ''''       
      
  --SET @PROCESS_OUTPUT_QUERY = ''''+replace(@PROCESS_OUTPUT_QUERY,'''','''''')+''''      
  --PRINT @PROCESS_OUTPUT_QUERY      
        
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL WHERE SNO = @SNO      
   AND PROCESS_STATUS_ALERT > PROCESS_STATUS_ALERT_COUNT) > 0      
  BEGIN      
       
   UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS_ALERT_COUNT = PROCESS_STATUS_ALERT_COUNT + 1, PROCESS_LAST_ALERT_DATE = @PDATE      
   WHERE SNO = @SNO     
      
  SELECT @RECCOUNT = 1  
    
  IF @PROCESS_STATUS = 100 AND @ATTACHEMENT_FILE_NAME = ''  
  BEGIN  
 SET @SQL = ' DECLARE @RECCNT NUMERIC(18,0) '  
 SET @SQL = @SQL + ' SELECT @RECCNT = ISNULL(COUNT(1),0) FROM (' + @PROCESS_OUTPUT_QUERY + ' ) A '  
 SET @SQL = @SQL + ' IF (@RECCNT) <= 0 '            
    SET @SQL = @SQL + ' BEGIN '            
    SET @SQL = @SQL + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_OUTPUT_QUERY = '''' '            
    SET @SQL = @SQL + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 100 '  
    SET @SQL = @SQL + ' END '            
 EXEC (@SQL)   
   
 SELECT @RECCOUNT = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL WHERE SNO = @SNO AND PROCESS_OUTPUT_QUERY <> ''  
  END  
  IF @RECCOUNT > 0  
  BEGIN  
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL WHERE SNO = @SNO      
   AND PROCESS_STATUS_ALERT >= PROCESS_STATUS_ALERT_COUNT) > 0      
  BEGIN      
   exec SpCustomTable2HTML @PROCESS_OUTPUT_QUERY, @XML OUTPUT, ' border="1" cellpadding="2" cellspacing="0" style="font-size:14px";', ' style="color:blue;background-color:yellow;"'      
   --SELECT ISNULL(@XML,'')      
   SET @BODYTEXT = @BODYTEXT + ISNULL(@XML,'')      
    
    EXEC MSDB.DBO.SP_SEND_DBMAIL       
    @profile_name= 'CLASS AUTO PROCESS Test Profile',      
    @RECIPIENTS=@TO_EMAIL_ID,      
    @BODY=@BODYTEXT,       
    @copy_recipients = @CC_EMAIL_ID,       
    @blind_copy_recipients = @BCC_EMAIL_ID,      
    @subject = @SUBJECTTEXT,      
    @body_format = 'HTML',      
    @FILE_ATTACHMENTS = @ATTACHEMENT_FILE_NAME   
   END    
  END  
  END      
 END      
 ELSE      
 BEGIN      
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL WHERE SNO = @SNO      
   AND PROCESS_STATUS_ALERT > PROCESS_STATUS_ALERT_COUNT) > 0      
  BEGIN      
    
    UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS_ALERT_COUNT = PROCESS_STATUS_ALERT_COUNT + 1, PROCESS_LAST_ALERT_DATE = @PDATE      
 WHERE SNO = @SNO      
    
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL WHERE SNO = @SNO      
   AND PROCESS_STATUS_ALERT >= PROCESS_STATUS_ALERT_COUNT) > 0      
  BEGIN      
    EXEC MSDB.DBO.SP_SEND_DBMAIL       
    @profile_name= 'CLASS AUTO PROCESS Test Profile',      
    @RECIPIENTS=@TO_EMAIL_ID,      
    @BODY=@BODYTEXT,       
    @copy_recipients = @CC_EMAIL_ID,       
    @blind_copy_recipients = @BCC_EMAIL_ID,      
    @subject = @SUBJECTTEXT,      
    @body_format = 'HTML',      
    @FILE_ATTACHMENTS = @ATTACHEMENT_FILE_NAME   
 END    
  END      
 END      
     
 FETCH NEXT FROM @ALERT_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_FOR, @PROCESS_STATUS, @PROCESS_START_DATE, @PROCESS_FILE_NAME,       
           @PROCESS_HALTED_REASON, @TO_EMAIL_ID, @CC_EMAIL_ID, @BCC_EMAIL_ID, @PROCESS_OUTPUT_QUERY, @SETT_NO, @SETT_TYPE, @INTERNAL_PROCESS_ID,       
     @ATTACHEMENT_FILE_NAME       
END      
CLOSE @ALERT_CURSOR      
DEALLOCATE @ALERT_CURSOR      
  
SET @ATTACHEMENT_FILE_NAME = ''  
  
SET @PROCESSCUR = CURSOR FOR  
SELECT EXCHANGE, SEGMENT, PROCESS_GROUP,   
    TO_EMAIL_ID = MAX(TO_EMAIL_ID),   
    CC_EMAIL_ID = MAX(CC_EMAIL_ID),   
    BCC_EMAIL_ID = MAX(BCC_EMAIL_ID)  
FROM TBL_AUTO_PROCESS_EMAIL_GRP E  
WHERE NOT EXISTS (SELECT PROCESS_GROUP FROM TBL_AUTO_PROCESS_EMAIL_GROUP_LOG L  
      WHERE L.PROCESS_DATE = LEFT(@PDATE,11)  
      AND E.PROCESS_GROUP = L.PROCESS_GROUP )      
GROUP BY EXCHANGE, SEGMENT, PROCESS_GROUP  
ORDER BY 1  
OPEN @PROCESSCUR  
FETCH NEXT FROM @PROCESSCUR INTO @EXCHANGE, @SEGMENT, @PROCESS_GROUP, @TO_EMAIL_ID, @CC_EMAIL_ID, @BCC_EMAIL_ID  
WHILE @@FETCH_STATUS = 0   
BEGIN  
/*  
 SET @TO_EMAIL_ID = 'animesh.jain@mkttech.in'  
 SET @CC_EMAIL_ID = ''  
 SET @BCC_EMAIL_ID = ''  
*/  
   
 SELECT @PROCESS_STATUS_CNT = ISNULL(SUM(CASE WHEN PROCESS_STATUS = 100 THEN 1 ELSE 0 END),0),   
     @PROCESS_CNT = ISNULL(COUNT(1),0)  
 FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK), TBL_AUTO_PROCESS_EMAIL_GRP E, OWNER      
 WHERE PROCESS_DATE = LEFT(@PDATE,11)      
 AND D.EXCHANGE = E.EXCHANGE      
 AND D.SEGMENT = E.SEGMENT      
 AND D.PROCESS_FOR = E.PROCESS_FOR      
 AND PROCESS_GROUP = @PROCESS_GROUP   
 AND NOT EXISTS (SELECT PROCESS_GROUP FROM TBL_AUTO_PROCESS_EMAIL_GROUP_LOG L  
      WHERE D.PROCESS_DATE = L.PROCESS_DATE   
      AND E.PROCESS_GROUP = L.PROCESS_GROUP )  
        
 IF @PROCESS_CNT = @PROCESS_STATUS_CNT AND @PROCESS_CNT > 0    
 BEGIN  
  SELECT PROCESS_ORDER_ID, BUSINESS_DATE = CONVERT(VARCHAR,BUSINESS_DATE,103),   
  PROCESS_GROUP,D.PROCESS_FOR, D.SETT_NO, SETT_TYPE=LTRIM(RTRIM(D.SETT_TYPE)),   
  EXPECTED_START_TIME = CONVERT(VARCHAR,PROCESS_START_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_START_DATE,108),       
  ACTUAL_START_TIME = CONVERT(VARCHAR,PROCESS_STARTED_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_STARTED_DATE,108),       
  EXPECTED_END_TIME = CONVERT(VARCHAR,PROCESS_END_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_END_DATE,108),       
  ACTUAL_END_TIME = CONVERT(VARCHAR,PROCESS_ENDED_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_ENDED_DATE,108),       
  PROCESS_FILE_NAME = PRADNYA.DBO.FN_CLASS_AUTO_PROCESS_REPLACE(.DBO.FN_DATA_DECRYPT('MKTTECH.IN',D.PROCESS_FILE_NAME),  
  BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),      
  PROCESS_HALTED_REASON,     
  ATTACHEMENT_FILE_NAME  
  INTO #TEMP      
  FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK), TBL_AUTO_PROCESS_EMAIL_GRP E, OWNER      
  WHERE PROCESS_DATE = LEFT(@PDATE,11)      
  AND D.EXCHANGE = E.EXCHANGE      
  AND D.SEGMENT = E.SEGMENT      
  AND D.PROCESS_FOR = E.PROCESS_FOR      
  AND PROCESS_STATUS = 100  
  AND PROCESS_GROUP = @PROCESS_GROUP   
  AND NOT EXISTS (SELECT PROCESS_GROUP FROM TBL_AUTO_PROCESS_EMAIL_GROUP_LOG L  
        WHERE D.PROCESS_DATE = L.PROCESS_DATE   
        AND E.PROCESS_GROUP = L.PROCESS_GROUP )  
  ORDER BY PROCESS_ORDER_ID    
    
  SET @SUBJECTTEXT = @EXCHANGE + '-' + @SEGMENT + ' Live SERVER - ' + @PROCESS_GROUP + ' COMPLETE PROCESS STATUS FOR THE DAY ' +  CONVERT(VARCHAR,@PDATE,103)  
    
  SET @BODYTEXT = @SUBJECTTEXT + '<BR>'  
    
  SET @SQL = 'SELECT * FROM #TEMP '  
  exec SpCustomTable2HTML @SQL, @XML OUTPUT, ' border="1" cellpadding="2" cellspacing="0" style="font-size:14px";', ' style="color:blue;background-color:yellow;"'      
  SET @BODYTEXT = @BODYTEXT + ISNULL(@XML,'')      
  
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_EMAIL_GROUP_LOG   
   WHERE PROCESS_DATE = LEFT(@PDATE,11) AND PROCESS_GROUP = @PROCESS_GROUP ) = 0   
  BEGIN  
   INSERT INTO TBL_AUTO_PROCESS_EMAIL_GROUP_LOG   
   SELECT LEFT(@PDATE,11), @PROCESS_GROUP, GETDATE()  
      
   EXEC MSDB.DBO.SP_SEND_DBMAIL       
   @profile_name= 'CLASS AUTO PROCESS Test Profile',      
   @RECIPIENTS=@TO_EMAIL_ID,      
   @BODY=@BODYTEXT,       
   @copy_recipients = @CC_EMAIL_ID,       
   @blind_copy_recipients = @BCC_EMAIL_ID,      
   @subject = @SUBJECTTEXT,      
   @body_format = 'HTML',      
   @FILE_ATTACHMENTS = @ATTACHEMENT_FILE_NAME   
  END  
  DROP TABLE #TEMP  
 END  
   
 FETCH NEXT FROM @PROCESSCUR INTO @EXCHANGE, @SEGMENT, @PROCESS_GROUP, @TO_EMAIL_ID, @CC_EMAIL_ID, @BCC_EMAIL_ID  
END  
CLOSE @PROCESSCUR  
DEALLOCATE @PROCESSCUR  
      
CLOSE SYMMETRIC KEY   Key4CertAutoProcess;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_BULK_UPDATE
-- --------------------------------------------------


  
create PROCEDURE [dbo].[CLASS_AUTO_PROCESS_BULK_UPDATE]   
(  
 @UPD_DATA VARCHAR(MAX)  
)  
--NEWDATA~NEWDATA~NEWDATA~OLDDATA~OLDDATA~OLDDATA|  
AS  
--exec CLASS_AUTO_PROCESS_BULK_UPDATE @UPD_DATA='ftp.connect2nse.com~10412~Most@123~FTP.CONNECT2NSE.COM~10412~MOST@123|FTP.CONNECT2NSE.COM~10412~MOST@123~ftp.connect2nse.com~10412~Most@123|NEWDATA~NEWDATA~NEWDATA~OLDDATA~OLDDATA~OLDDATA|'  
BEGIN  
  
 DECLARE @RECNO INT,  
   @OLDFILE_DWLOAD_LOCATION VARCHAR(MAX),  
   @OLDFILE_DWLOAD_USERID  VARCHAR(MAX),  
   @OLDFILE_DWLOAD_PWD   VARCHAR(MAX),  
  
   @NEWFILE_DWLOAD_LOCATION VARCHAR(MAX),  
   @NEWFILE_DWLOAD_USERID  VARCHAR(MAX),  
   @NEWFILE_DWLOAD_PWD   VARCHAR(MAX)  
  
  
 SET @RECNO = 1  
  
 OPEN SYMMETRIC KEY   Key4CertAutoProcess            
   DECRYPTION BY   CERTIFICATE CertAutoProcess  
  
 WHILE ISNULL(.DBO.PIECE(@UPD_DATA,'|',@RECNO),'') <> ''  
 BEGIN  
  SELECT      
   @NEWFILE_DWLOAD_LOCATION = .DBO.PIECE(ISNULL(.DBO.PIECE(@UPD_DATA,'|',@RECNO),''),'~',1),  
   @NEWFILE_DWLOAD_USERID = .DBO.PIECE(ISNULL(.DBO.PIECE(@UPD_DATA,'|',@RECNO),''),'~',2),  
   @NEWFILE_DWLOAD_PWD = .DBO.PIECE(ISNULL(.DBO.PIECE(@UPD_DATA,'|',@RECNO),''),'~',3),  
   @OLDFILE_DWLOAD_LOCATION = ISNULL(.DBO.PIECE(ISNULL(.DBO.PIECE(@UPD_DATA,'|',@RECNO),''),'~',4),''),  
   @OLDFILE_DWLOAD_USERID = ISNULL(.DBO.PIECE(ISNULL(.DBO.PIECE(@UPD_DATA,'|',@RECNO),''),'~',5),''),  
   @OLDFILE_DWLOAD_PWD = ISNULL(.DBO.PIECE(ISNULL(.DBO.PIECE(@UPD_DATA,'|',@RECNO),''),'~',6),'')  
  
  UPDATE TBL_AUTO_PROCESS_MASTER SET  
  FILE_DWLOAD_LOCATION=DBO.FN_DATA_ENCRYPT('MKTTECH.IN',@NEWFILE_DWLOAD_LOCATION),  
  FILE_DWLOAD_USERID=DBO.FN_DATA_ENCRYPT('MKTTECH.IN',@NEWFILE_DWLOAD_USERID),  
  FILE_DWLOAD_PWD=DBO.FN_DATA_ENCRYPT('MKTTECH.IN',@NEWFILE_DWLOAD_PWD)  
  WHERE DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_LOCATION) = @OLDFILE_DWLOAD_LOCATION  
     AND DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID) = @OLDFILE_DWLOAD_USERID  
     AND DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD) = @OLDFILE_DWLOAD_PWD  
  
  SET @RECNO = @RECNO + 1   
 END  
 CLOSE SYMMETRIC KEY   Key4CertAutoProcess;    
 SELECT ERRCODE='0',MESSAGETEXT='DONE'  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_EDIT_MASTER
-- --------------------------------------------------


  
CREATE PROCEDURE [dbo].[CLASS_AUTO_PROCESS_EDIT_MASTER]   
(  
 @TYPE varchar(1),  
 @PROCESSFOR varchar(30),  
 @PROCESSTYPE varchar(30)  
)   
AS    
  
SELECT @PROCESSFOR = (CASE WHEN @PROCESSFOR = '' THEN '--SELECT--' ELSE @PROCESSFOR END)  
SELECT @PROCESSTYPE = (CASE WHEN @PROCESSTYPE = '' THEN '--SELECT--' ELSE @PROCESSTYPE END)  
-- EXEC CLASS_AUTO_PROCESS_EDIT_MASTER 'E', 'SELECT','SELECT'  
BEGIN    
OPEN SYMMETRIC KEY   Key4CertAutoProcess  
     DECRYPTION BY   CERTIFICATE CertAutoProcess   
  
 IF @TYPE='P'  
 BEGIN  
  SELECT     
   SNO,PROCESS_TYPE,PROCESS_FOR,    
   PROCESS_START_TIME = LEFT(PROCESS_START_TIME,5),      
   PROCESS_END_TIME = LEFT(PROCESS_END_TIME,5) ,    
   IS_FILE_BASED,  
   PROCESS_ORDER_ID,    
   FILE_DWLOAD_LOCATION=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_LOCATION),    
   FILE_DWLOAD_NAME=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_NAME),    
   FILE_DWLOAD_USERID=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID),    
   FILE_DWLOAD_PWD=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD),    
   FILE_DWLOAD_MAP_DRIVE,    
   PROCESS_FILE_PATH=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_PATH),    
   PROCESS_FILE_NAME=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_NAME),    
   PROCESS_FILE_MOVE_PATH =.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_MOVE_PATH)     
  FROM  TBL_AUTO_PROCESS_MASTER    
  WHERE PROCESS_FOR = (CASE WHEN @PROCESSFOR LIKE '%SELECT%' THEN PROCESS_FOR ELSE @PROCESSFOR END)  
  AND   PROCESS_TYPE = (CASE WHEN @PROCESSTYPE LIKE '%SELECT%' THEN PROCESS_TYPE ELSE @PROCESSTYPE END)  
  ORDER BY PROCESS_TYPE,IS_FILE_BASED    
 END  
 IF @TYPE='E'  
 BEGIN  
  SELECT E.PROCESS_FOR,TO_EMAIL_ID,CC_EMAIL_ID,BCC_EMAIL_ID,EMAIL_SEND_FLAG  FROM TBL_AUTO_PROCESS_EMAIL E,  
  TBL_AUTO_PROCESS_MASTER M  
  WHERE E.PROCESS_FOR = M.PROCESS_FOR  
  AND E.PROCESS_FOR = (CASE WHEN @PROCESSFOR LIKE '%SELECT%' THEN E.PROCESS_FOR ELSE @PROCESSFOR END)  
  AND PROCESS_TYPE = (CASE WHEN @PROCESSTYPE LIKE '%SELECT%' THEN PROCESS_TYPE ELSE @PROCESSTYPE END)  
 END  
CLOSE SYMMETRIC KEY   Key4CertAutoProcess;  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_EDIT_MASTER_UPDATE
-- --------------------------------------------------


  
  
CREATE procedure [dbo].[CLASS_AUTO_PROCESS_EDIT_MASTER_UPDATE]  
(  
 @PROCESSDATA VARCHAR(MAX),  
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(50),  
 @UNAME VARCHAR(50),  
 @REQIP VARCHAR(200)  
)  
AS  
BEGIN  
OPEN SYMMETRIC KEY   Key4CertAutoProcess  
     DECRYPTION BY   CERTIFICATE CertAutoProcess   
  
 CREATE TABLE #DATA (FDATA VARCHAR(MAX))    
 INSERT INTO #DATA     
 SELECT * FROM dbo.fnSplitString2Tbl(@PROCESSDATA,'|')   
   
 UPDATE TBL_AUTO_PROCESS_MASTER SET     
  PROCESS_START_TIME = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 2))),  
  PROCESS_END_TIME = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 3))),  
  IS_FILE_BASED = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 4))),  
  FILE_DWLOAD_LOCATION = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 5)))),  
  FILE_DWLOAD_NAME = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 6)))),  
  FILE_DWLOAD_USERID = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 7)))),  
  FILE_DWLOAD_PWD = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 8)))),  
  FILE_DWLOAD_MAP_DRIVE = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 9))),  
  PROCESS_FILE_PATH  = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 10)))),  
  PROCESS_FILE_NAME  = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 11)))),  
  PROCESS_FILE_MOVE_PATH  = .DBO.FN_DATA_ENCRYPT('MKTTECH.IN',LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 12)))),  
  PROCESS_ORDER_ID = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 13)))  
 FROM #DATA B    
 WHERE SNO = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 1)))  
 AND FDATA<>''  
  
 CLOSE SYMMETRIC KEY   Key4CertAutoProcess;  
   
 SELECT ERRCODE='1',ERRDESC='Master Updated Sucessfully...'  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_EMAIL_MASTER_UPDATE
-- --------------------------------------------------


CREATE procedure [dbo].[CLASS_AUTO_PROCESS_EMAIL_MASTER_UPDATE]  
(  
 @PROCESSDATA VARCHAR(MAX),  
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(50),  
 @UNAME VARCHAR(50),  
 @REQIP VARCHAR(200)  
)  
AS  
BEGIN  
 CREATE TABLE #DATA (FDATA VARCHAR(MAX))    
 INSERT INTO #DATA     
 SELECT * FROM dbo.fnSplitString2Tbl(@PROCESSDATA,'|')   
   
 UPDATE TBL_AUTO_PROCESS_EMAIL SET     
  TO_EMAIL_ID = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 2))),  
  CC_EMAIL_ID = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 3))),  
  BCC_EMAIL_ID = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 4))),  
  EMAIL_SEND_FLAG = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 5)))  
 FROM #DATA B    
 WHERE PROCESS_FOR = LTRIM(RTRIM(.dbo.PIECE(B.FDATA, '~', 1)))  
 AND FDATA<>''  
   
 SELECT ERRCODE='1',ERRDESC='Master Updated Sucessfully...'  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_FILE
-- --------------------------------------------------


  
CREATE PROC [dbo].[CLASS_AUTO_PROCESS_FILE] (@FILEPATH VARCHAR(100), @BUSINESS_DATE VARCHAR(11), @FLD_FILEDATE DATETIME OUTPUT, @FLD_FILENAME VARCHAR(200) OUTPUT)        
AS         
      
SET @FILEPATH = 'DIR ' +@FILEPATH + ' /C'   
  
CREATE TABLE #FILELIST         
( FILENAMELIST VARCHAR(100))        
INSERT INTO #FILELIST         
EXEC MASTER.DBO.XP_CMDSHELL @FILEPATH       
  
UPDATE #FILELIST SET FILENAMELIST = REPLACE(FILENAMELIST,' ','#')  
WHERE FILENAMELIST IS NOT NULL  
AND FILENAMELIST LIKE '%'  
AND FILENAMELIST LIKE '%/%'  
  
SELECT FLD_FILEDATE=CONVERT(DATETIME,LEFT(CONVERT(DATETIME,LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',1))),101),11) + ' ' + LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',3))) + ' ' + LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',4)))),  
FLD_FILENAME=LTRIM(RTRIM(REVERSE(DBO.PIECE(REVERSE(FILENAMELIST),'#',1))))  
INTO #FILELISTNEW     
FROM #FILELIST   
WHERE FILENAMELIST IS NOT NULL  
AND FILENAMELIST LIKE '%'  
AND FILENAMELIST LIKE '%/%'  
AND LTRIM(RTRIM(REVERSE(DBO.PIECE(REVERSE(FILENAMELIST),'#',1)))) LIKE '%.%'  
  
SELECT TOP 1 @FLD_FILEDATE = FLD_FILEDATE, @FLD_FILENAME = FLD_FILENAME FROM #FILELISTNEW N  
WHERE FLD_FILEDATE LIKE @BUSINESS_DATE + '%'  
AND FLD_FILENAME NOT IN (SELECT FLD_FILENAME FROM TBL_AUTO_PROCESS_FILE F  
       WHERE F.FLD_FILEDATE LIKE @BUSINESS_DATE + '%'  
       AND N.FLD_FILEDATE = F.FLD_FILEDATE)  
ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_PRM
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[CLASS_AUTO_PROCESS_PRM]      
(      
 @FOR VARCHAR(2)      
)      
AS      
BEGIN      
 IF @FOR='1'      
  BEGIN      
   SELECT DISTINCT PROCESS_TYPE FROM TBL_AUTO_PROCESS_MASTER      
  END      
 IF @FOR='2'      
  BEGIN      
   SELECT DISTINCT PROCESS_FOR FROM TBL_AUTO_PROCESS_MASTER      
  END      
 IF @FOR='3'      
  BEGIN      
   SELECT DISTINCT  UPPER(LTRIM(RTRIM(EXCHANGE))) , UPPER(LTRIM(RTRIM(SEGMENT))),(CASE WHEN PRIMARYSERVER = 1 THEN 'PRIMARY-' ELSE 'DELIVERY-' END) + UPPER(LTRIM(RTRIM(EXCHANGE))) +'-'+ UPPER(LTRIM(RTRIM(SEGMENT))) AS SEGMENT,SERVERNAME = SHARESERVER+ '.'


  
  
  
  
 + SHAREDB + '.dbo.'  FROM PRADNYA.DBO.MULTICOMPANY ORDER BY 2,1 DESC      
  END      
END      
    
-- exec CLASS_AUTO_PROCESS_PRM 3

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_SETTLEMENT
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLASS_AUTO_PROCESS_SETTLEMENT]            
(             
 @PROCESS_DATE VARCHAR(11)            
)            
AS            
            
-- EXEC CLASS_AUTO_PROCESS_SETTLEMENT 'JUN  3 2015'            
SET @PROCESS_DATE = LEFT(GETDATE(),11)            
            
DECLARE @SNO     NUMERIC(18,0),            
  @EXCHANGE    VARCHAR(3),            
  @SEGMENT    VARCHAR(7),            
  @BUSINESS_DATE   VARCHAR(11),            
  @PROCESS_FOR   VARCHAR(30),            
  @INTERNAL_PROCESS_ID INT,            
  @FILE_DWLOAD_LOCATION VARCHAR(200),            
  @FILE_DWLOAD_NAME  VARCHAR(200),            
  @FILE_DWLOAD_NAME_TEMP varchar(200),            
  @FILE_DWLOAD_MAP_DRIVE VARCHAR(100),            
  @FILE_DWLOAD_USERID  VARCHAR(100),            
  @FILE_DWLOAD_PWD  VARCHAR(100),            
  @PROCESS_FILE_PATH  VARCHAR(200),            
  @PROCESS_FILE_NAME  VARCHAR(200),            
  @PROCESS_FILE_NAME_NEW VARCHAR(200),            
  @PROCESS_FILE_MOVE_PATH VARCHAR(200),            
  @PROCESS_SP_NAME  VARCHAR(8000),            
  @PROCESS_CHECK_QUERY VARCHAR(MAX),            
  @PROCESS_HALTED_REASON VARCHAR(500),            
  @FILE_INTERNET_LOCATION VARCHAR(500),            
  @FILE_INTERNAL_ISS_PATH VARCHAR(500),            
  @PROCESS_CURSOR   CURSOR,            
  @IS_FILE_BASED   VARCHAR(1),            
  @PROCESS_ID    INT,            
  @SUB_PROCESS_ID   INT,            
  @ISEXISTS    INT,            
  @ERRFLAG    INT,            
  @CMD     VARCHAR(8000),            
  @TIME     VARCHAR(8),            
  @CHKFLAG    INT,            
  @MYOUTPUT    VARCHAR(MAX),            
  @OTHER_DBDETAILS  VARCHAR(200),             
  @OTHER_PROCESS_FOR  VARCHAR(200),             
  @SETT_NO    VARCHAR(20),             
  @SETT_TYPE    VARCHAR(20),            
  @FLD_FILEDATE   DATETIME,            
  @FLD_FILENAME   VARCHAR(200),      
  @PREV_DATE   VARCHAR(11)              
            
SET NOCOUNT ON            
SET @ERRFLAG = 0            
SET @CHKFLAG = 1            
            
OPEN SYMMETRIC KEY   Key4CertAutoProcess            
     DECRYPTION BY   CERTIFICATE CertAutoProcess             
    
SELECT @PREV_DATE = LEFT(ISNULL(MAX(TRADE_DATE),@BUSINESS_DATE),11) FROM FOCLOSING      
WHERE TRADE_DATE < @PROCESS_DATE  
            
SET @PROCESS_CURSOR = CURSOR FOR              
            
SELECT              
DISTINCT D.SNO, D.EXCHANGE, D.SEGMENT, BUSINESS_DATE, D.PROCESS_ID, D.INTERNAL_PROCESS_ID, D.PROCESS_FOR,             
PROCESS_FILE_PATH = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),            
PROCESS_FILE_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),            
PROCESS_FILE_MOVE_PATH = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_MOVE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),            
PROCESS_SP_NAME = Replace(Replace(Replace(PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_SP_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),'<FileName>',            
       '''' + PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_PATH),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))) +             
       PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))) + ''''),            
       '<SNO>',D.Sno),'<SUBPROCESSID>',D.SUB_PROCESS_ID),            
PROCESS_CHECK_QUERY = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_CHECK_QUERY),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),            
IS_FILE_BASED,            
FILE_DWLOAD_LOCATION = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_LOCATION),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),            
FILE_DWLOAD_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),            
FILE_DWLOAD_MAP_DRIVE, FILE_DWLOAD_USERID=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID), FILE_DWLOAD_PWD=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD),            
FILE_INTERNET_LOCATION, FILE_INTERNAL_ISS_PATH, SUB_PROCESS_ID, OTHER_DBDETAILS, OTHER_PROCESS_FOR, D.SETT_NO, D.SETT_TYPE            
FROM TBL_AUTO_PROCESS_DETAIL D (NOLOCK),             
     TBL_AUTO_PROCESS_MASTER M (NOLOCK),             
  OWNER O            
WHERE PROCESS_DATE = LEFT(GETDATE(),11)            
AND D.PROCESS_FOR = M.PROCESS_FOR            
AND D.INTERNAL_PROCESS_ID = M.INTERNAL_PROCESS_ID            
AND D.PROCESS_STATUS = 0            
AND (D.PROCESS_START_DATE <= GETDATE() + D.WAIT_PERIOD            
OR D.PROCESS_START_DATE <= GETDATE())            
AND (D.PROCESS_END_DATE + D.WAIT_PERIOD >= GETDATE()             
OR D.PROCESS_END_DATE >= GETDATE())            
AND D.IS_DEPEND_ON = ''            
AND IS_FILE_BASED <> ''         
ORDER BY D.SNO            
            
OPEN @PROCESS_CURSOR            
FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH,             
          @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY,             
          @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,            
          @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,            
          @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE            
WHILE @@FETCH_STATUS = 0            
BEGIN            
            
 SELECT @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH,             
          @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY,             
          @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,            
          @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,            
          @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE                  
 SET @PROCESS_FILE_NAME_NEW = ''            
 SET @FLD_FILENAME = ''            
            
 SELECT @CHKFLAG = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)            
 WHERE PROCESS_DATE = @PROCESS_DATE             
 AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT            
 AND PROCESS_FOR = @PROCESS_FOR            
 AND PROCESS_STATUS NOT IN (0, 100)            
 IF @CHKFLAG = 1             
 BEGIN            
  SET @PROCESS_HALTED_REASON = 'CAN NOT START THE NEW PROCESS AS THE OLD PROCESS IS NOT YET COMPLETED.'            
 END             
            
 IF @CHKFLAG = 0             
 BEGIN            
  SELECT @CHKFLAG = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)            
  WHERE PROCESS_DATE = @PROCESS_DATE             
  AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT            
  AND INTERNAL_PROCESS_ID = (CASE WHEN @INTERNAL_PROCESS_ID = 0             
          THEN -1             
          ELSE @INTERNAL_PROCESS_ID             
           END)            
  AND PROCESS_STATUS NOT IN (0, 100)            
  IF @CHKFLAG = 1             
  BEGIN            
   SET @PROCESS_HALTED_REASON = 'CAN NOT START THE NEW PROCESS AS THE OLD PROCESS IS NOT YET COMPLETED.'            
  END             
 END            
     
 IF @CHKFLAG = 0             
 BEGIN            
  IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL (NOLOCK)            
   WHERE SNO = @SNO            
   AND PROCESS_STATUS = 0) = 0            
  BEGIN            
   SET @CHKFLAG = -1             
  END            
 END            
 IF @CHKFLAG = 0             
 BEGIN            
  SET @ISEXISTS = 0             
  IF (@IS_FILE_BASED = 'L' OR @IS_FILE_BASED = 'F' OR @IS_FILE_BASED = 'I') AND @SUB_PROCESS_ID = 0            
  BEGIN            
   IF @FILE_DWLOAD_LOCATION <> ''            
   BEGIN     
  IF @IS_FILE_BASED = 'I'            
    BEGIN            
     SET @PROCESS_FILE_NAME_NEW = @FILE_INTERNAL_ISS_PATH + @FILE_INTERNET_LOCATION + '&FILENAME=' + @FILE_DWLOAD_NAME            
     EXEC HTTP_REQUEST @PROCESS_FILE_NAME_NEW, @MYOUTPUT             
    END            
                
    IF @IS_FILE_BASED = 'L' OR @IS_FILE_BASED = 'I'            
    BEGIN            
     SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'            
  EXEC (@CMD)            
     IF @FILE_DWLOAD_MAP_DRIVE <> ''            
     BEGIN            
      SET @CMD = 'EXEC XP_CMDSHELL ''net use "' + @FILE_DWLOAD_LOCATION + '" /USER:' + @FILE_DWLOAD_USERID + ' ' + @FILE_DWLOAD_PWD + ' /persistent:Y'' , NO_OUTPUT'            
     print @CMD
	  EXEC (@CMD)            
     END             
     IF @FILE_DWLOAD_NAME LIKE '%*%'            
     BEGIN            
      SET @PROCESS_SP_NAME = REPLACE(@PROCESS_SP_NAME,@PROCESS_FILE_NAME,'#')            
        
      IF @FILE_DWLOAD_MAP_DRIVE <> ''            
      BEGIN            
       SET @PROCESS_FILE_NAME_NEW = @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME            
      END            
      ELSE            
      BEGIN            
       SET @PROCESS_FILE_NAME_NEW = @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME            
      END            
      EXEC CLASS_AUTO_PROCESS_FILE @PROCESS_FILE_NAME_NEW, @BUSINESS_DATE, @FLD_FILEDATE OUTPUT, @FLD_FILENAME OUTPUT                 
    
      SET @FILE_DWLOAD_NAME = @FLD_FILENAME         
          
      IF @FILE_DWLOAD_NAME <> ''            
      BEGIN            
       IF @PROCESS_FILE_NAME NOT LIKE '%#%'             
       BEGIN            
        SET @PROCESS_FILE_NAME = @FLD_FILENAME            
       END            
       ELSE            
       BEGIN              
        SET @PROCESS_FILE_NAME = LEFT(@FLD_FILENAME, LEN(@FILE_DWLOAD_NAME)-LEN(.DBO.PIECE(@PROCESS_FILE_NAME,'#',1))) + .DBO.PIECE(@PROCESS_FILE_NAME,'#',2)            
       END            
       SET @PROCESS_SP_NAME = REPLACE(@PROCESS_SP_NAME,'#',@PROCESS_FILE_NAME)             
                      
      END            
      ELSE            
      BEGIN            
       SET @PROCESS_FILE_NAME = ''            
      END            
     END            
         
     IF @FILE_DWLOAD_NAME <> ''            
     BEGIN            
      IF @FILE_DWLOAD_MAP_DRIVE <> ''            
      BEGIN            
      print @CMD
	   SET @CMD = 'EXEC XP_CMDSHELL ''Copy ' + @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME + ' ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ''', NO_OUTPUT'            
       EXEC (@CMD)            
      END            
      ELSE            
      BEGIN            
       SET @CMD = 'EXEC XP_CMDSHELL ''Copy ' + @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME + ' ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ''', NO_OUTPUT'            
       PRINT @CMD            
       EXEC (@CMD)            
      END            
      IF @IS_FILE_BASED = 'I'            
      BEGIN            
       SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @FILE_DWLOAD_LOCATION + '\' + @FILE_DWLOAD_NAME + ''', NO_OUTPUT '            
       EXEC (@CMD)            
      END            
      IF @FILE_DWLOAD_MAP_DRIVE <> ''            
      BEGIN            
       SET @CMD = 'EXEC XP_CMDSHELL ''net use ' + @FILE_DWLOAD_LOCATION + ' /delete'', NO_OUTPUT'            
       EXEC (@CMD)            
      END            
     END             
    END            
    ELSE            
    IF @IS_FILE_BASED = 'F'            
    BEGIN            
     SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'            
     EXEC (@CMD)            
     --SELECT @FILE_DWLOAD_LOCATION, @PROCESS_FILE_PATH, @FILE_DWLOAD_NAME, @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_DWLOAD_MAP_DRIVE            
     SET @FILE_DWLOAD_NAME_TEMP = @FILE_DWLOAD_NAME + '_1'            
     SELECT  @cmd = 'echo '+ 'open ' + @FILE_DWLOAD_LOCATION+ ' > ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP            
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT            
     SELECT  @cmd = 'echo '+ @FILE_DWLOAD_USERID+ '>> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP            
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT            
     SELECT  @cmd = 'echo '+ @FILE_DWLOAD_PWD+ '>> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP            
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT            
          select  @cmd = 'echo '+ 'dir ' + @file_dwload_map_drive + @file_dwload_name + ' >> ' + @process_file_path + @file_dwload_name_temp            
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT            
     SELECT  @cmd = 'echo '+ 'get ' + @FILE_DWLOAD_MAP_DRIVE + @FILE_DWLOAD_NAME + ' ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ' >> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP       
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT            
     SELECT  @cmd = 'echo '+ 'quit'+ ' >> ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP            
     -- Executing steps from working file            
     EXEC master..xp_cmdshell @cmd, NO_OUTPUT            
            
     CREATE TABLE #FILELIST                   
     (             
      FILENAMELIST VARCHAR(MAX)            
     )             
            
     SELECT  @cmd = 'ftp -s:' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP            
     -- Executing final step            
     INSERT INTO #FILELIST            
     EXEC master..xp_cmdshell @cmd--, NO_OUTPUT            
            
     DELETE FROM #FILELIST            
     WHERE FILENAMELIST IS  NULL            
            
     DELETE FROM #FILELIST            
     WHERE FILENAMELIST NOT LIKE '%' + @FILE_DWLOAD_NAME + '%'            
            
     DELETE FROM #FILELIST            
     WHERE FILENAMELIST LIKE 'DIR%'            
            
     DELETE FROM #FILELIST            
     WHERE FILENAMELIST LIKE 'GET%'            
            
     UPDATE #FILELIST SET FILENAMELIST = REPLACE(FILENAMELIST,' ','#')            
            
     SET @FLD_FILEDATE = '1900-01-01'            
            
     SELECT @FLD_FILEDATE = CONVERT(DATETIME,LTRIM(RTRIM(DBO.PIECE(FILENAMELIST,'#',1))),1)            
     FROM #FILELIST            
 
   IF LEFT(@FLD_FILEDATE,11) <> @BUSINESS_DATE        
   BEGIN        
    IF (@PROCESS_FOR = 'EXCHANGE APP VAR' OR @PROCESS_FOR = 'IMPORT_CONTRACT_MASTER') AND @PREV_DATE = LEFT(@FLD_FILEDATE,11)       
    BEGIN        
     SET @CMD = ''            
    END      
    ELSE       
    BEGIN        
     SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @process_file_path + @file_dwload_name + ''', NO_OUTPUT '        
     EXEC (@CMD)              
    END        
   END 
          
   SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME_TEMP + ''', NO_OUTPUT '        
   EXEC (@CMD)        
    
   DROP TABLE #FILELIST        
  END        
 END     
         
   IF @PROCESS_FILE_NAME <> ''            
   BEGIN            
    SET @PROCESS_FILE_NAME_NEW = @PROCESS_FILE_PATH + @PROCESS_FILE_NAME            
    IF PRADNYA.DBO.CHECKZIPFILE(@FILE_DWLOAD_NAME) > 0            
    BEGIN            
     SET @CMD = 'EXEC XP_CMDSHELL ''"C:\program files\Winzip\WZUNZIP.exe" -yb -o ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ' ' + @PROCESS_FILE_PATH + ''', NO_OUTPUT'            
     EXEC (@CMD)            
            
     SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_PATH + @FILE_DWLOAD_NAME + ''', NO_OUTPUT '            
     EXEC (@CMD)            
    END            
   END            
        
   EXEC MASTER.DBO.XP_FILEEXIST @PROCESS_FILE_NAME_NEW, @ISEXISTS OUTPUT            
   IF @ISEXISTS = 0             
   BEGIN            
    UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = 'FILE NOT AVAILABLE IN THE SPECIFIED LOCATION.',            
    PROCESS_STARTED_DATE = GETDATE(), PROCESS_ENDED_DATE = GETDATE()            
    WHERE SNO = @SNO            
   END            
   ELSE            
   BEGIN               
    SET @ERRFLAG = 0 
    UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS = 99, PROCESS_STARTED_DATE = GETDATE(), PROCESS_FILE_NAME = DBO.FN_DATA_ENCRYPT('MKTTECH.IN',ISNULL(@PROCESS_FILE_NAME_NEW,''))            
    WHERE SNO = @SNO     
         
    BEGIN            
   IF @INTERNAL_PROCESS_ID <= 1000             
   BEGIN    
     BEGIN TRAN            
   END    
      BEGIN TRY            
       SET @CMD = @PROCESS_SP_NAME             
       --PRINT @CMD            
       EXEC (@CMD)                   
      END TRY            
   BEGIN CATCH         
  IF @INTERNAL_PROCESS_ID <= 1000             
  BEGIN       
   ROLLBACK TRAN            
  END    
       UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = ERROR_MESSAGE(),            
       PROCESS_STATUS = 0            
       WHERE SNO = @SNO            
       SET @ERRFLAG = 1            
      END CATCH            
                  
     SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR ' + @PROCESS_FILE_MOVE_PATH + ''', NO_OUTPUT'            
     EXEC (@CMD)            
     SELECT @TIME = REPLACE(CONVERT(VARCHAR,GETDATE(),108),':','')            
     IF LEN(@PROCESS_FILE_MOVE_PATH) > 0             
     BEGIN            
      SET @CMD = 'EXEC XP_CMDSHELL ''MOVE ' + @PROCESS_FILE_NAME_NEW + ' ' + @PROCESS_FILE_MOVE_PATH + @PROCESS_FILE_NAME + @TIME + ''', NO_OUTPUT'            
     END            
     ELSE            
     BEGIN            
      SET @CMD = 'EXEC XP_CMDSHELL ''DEL ' + @PROCESS_FILE_NAME_NEW + ''', NO_OUTPUT'            
     END            
     EXEC (@CMD)            
            
     IF @ERRFLAG = 0         
  BEGIN             
   IF ISNULL(@FLD_FILENAME,'') <> ''    
   BEGIN    
  INSERT INTO TBL_AUTO_PROCESS_FILE VALUES (@FLD_FILENAME, @FLD_FILEDATE, GETDATE())            
      END    
   IF @INTERNAL_PROCESS_ID <= 1000             
   BEGIN    
      COMMIT TRAN            
   END    
               
      IF LEN(@PROCESS_CHECK_QUERY) > 0             
      BEGIN            
       SET @CMD = 'DECLARE @RECCNT NUMERIC(18,0), @MSG VARCHAR(500) SELECT @RECCNT = FLAG, @MSG = MSG ' + @PROCESS_CHECK_QUERY + ''            
       SET @CMD = @CMD + ' IF (@RECCNT) > 0 '            
       SET @CMD = @CMD + ' BEGIN '            
       SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @MSG, PROCESS_STATUS_ALERT_INTERVAL = ''00:00:00'','            
       SET @CMD = @CMD + '  PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(), PROCESS_STATUS_ALERT = 1, PROCESS_STATUS_ALERT_COUNT = 0 '            
       SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '            
                   
       SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '            
       SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '            
       SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '             
       SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'        
    SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''            
                   
       IF @OTHER_DBDETAILS <> ''            
       BEGIN            
        SET @CMD = @CMD + '  UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '            
        SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '            
        SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '             
        SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'            
        SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''            
        SET @CMD = @CMD + '  AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''            
       END            
       SET @CMD = @CMD + ' END '            
       SET @CMD = @CMD + ' ELSE '             
       SET @CMD = @CMD + ' BEGIN '             
       SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET '            
       SET @CMD = @CMD + '  PROCESS_HALTED_REASON = @MSG,'            
       SET @CMD = @CMD + '  PROCESS_STATUS = 0, PROCESS_ENDED_DATE = GETDATE() '            
       SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '            
       SET @CMD = @CMD + ' END '            
       EXEC (@CMD)            
      END            
      ELSE            
      BEGIN            
       SET @CMD = ' IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL '            
       SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 100) > 0 '            
       SET @CMD = @CMD + ' BEGIN '            
            
       SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '            
       SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '            
       SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '             
       SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'            
       SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''            
       IF @OTHER_DBDETAILS <> ''            
       BEGIN            
     SET @CMD = @CMD + '  UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '            
        SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '            
        SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '             
        SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'            
        SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''            
        SET @CMD = @CMD + '  AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''            
       END            
       SET @CMD = @CMD + ' END '            
       EXEC (@CMD)            
      END            
 END                
    END            
   END            
  END            
 ELSE            
  BEGIN            
   SET @ERRFLAG = 0            
   UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_STATUS = 99, PROCESS_STARTED_DATE = GETDATE(), PROCESS_FILE_NAME = DBO.FN_DATA_ENCRYPT('MKTTECH.IN',ISNULL(@PROCESS_FILE_NAME_NEW,''))   
   WHERE SNO = @SNO    
   IF @INTERNAL_PROCESS_ID <= 1000             
   BEGIN    
  BEGIN TRAN              
   END    
    BEGIN TRY            
     SET @CMD = @PROCESS_SP_NAME             
     --PRINT @CMD            
     EXEC (@CMD)            
    END TRY            
    BEGIN CATCH            
 IF @INTERNAL_PROCESS_ID <= 1000             
 BEGIN    
   ROLLBACK TRAN            
 END    
--print ERROR_MESSAGE()            
     UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = ERROR_MESSAGE(),            
     PROCESS_STATUS = 0            
     WHERE SNO = @SNO            
     SET @ERRFLAG = 1            
    END CATCH            
   IF @ERRFLAG = 0                  
   BEGIN            
 IF @INTERNAL_PROCESS_ID <= 1000             
    BEGIN    
  COMMIT TRAN            
    END    
        
    IF LEN(@PROCESS_CHECK_QUERY) > 0             
    Begin            
  SET @CMD = 'DECLARE @RECCNT NUMERIC(18,0), @MSG VARCHAR(500) SELECT @RECCNT = FLAG, @MSG = MSG ' + @PROCESS_CHECK_QUERY + ''            
     SET @CMD = @CMD + ' IF (@RECCNT) > 0 '            
     SET @CMD = @CMD + ' BEGIN '            
     SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @MSG, PROCESS_STATUS_ALERT_INTERVAL = ''00:00:00'','            
     SET @CMD = @CMD + '  PROCESS_STATUS = 100, PROCESS_ENDED_DATE = GETDATE(), PROCESS_STATUS_ALERT = 1, PROCESS_STATUS_ALERT_COUNT = 0 '            
     SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '            
            
     SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '            
     SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '            
     SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '             
     SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'            
     SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''            
     IF @OTHER_DBDETAILS <> ''            
     BEGIN            
      SET @CMD = @CMD + '  UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '            
      SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '            
      SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '             
      SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'            
      SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''            
      SET @CMD = @CMD + '  AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''            
     END            
            
     SET @CMD = @CMD + ' END '            
     SET @CMD = @CMD + ' ELSE '             
     SET @CMD = @CMD + ' BEGIN '             
     SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET '            
     SET @CMD = @CMD + '  PROCESS_HALTED_REASON = @MSG,'            
     SET @CMD = @CMD + '  PROCESS_STATUS = 0, PROCESS_ENDED_DATE = GETDATE() '            
     SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 99 '            
     SET @CMD = @CMD + ' END '            
     EXEC (@CMD)            
    END            
    ELSE            
    BEGIN            
     SET @CMD = ' IF (SELECT ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_DETAIL '            
     SET @CMD = @CMD + '  WHERE SNO = ' + CONVERT(VARCHAR,@SNO) + ' AND PROCESS_STATUS = 100) > 0 '            
     SET @CMD = @CMD + ' BEGIN '            
         
     SET @CMD = @CMD + '  UPDATE TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#'+CONVERT(VARCHAR,@PROCESS_ID)+','',''''), '            
     SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '            
     SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '             
     SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'            
     SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#'+CONVERT(VARCHAR,@PROCESS_ID)+',%'''            
     IF @OTHER_DBDETAILS <> ''            
     BEGIN            
      SET @CMD = @CMD + '  UPDATE ' + @OTHER_DBDETAILS + '.TBL_AUTO_PROCESS_DETAIL SET IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,''#0,'','''') , '            
      SET @CMD = @CMD + '  PROCESS_START_DATE = GETDATE() + '' 00:01:00'', '            
      SET @CMD = @CMD + '  PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + '' 00:01:00'' + APPROX_END_TIME) THEN PROCESS_END_DATE '             
      SET @CMD = @CMD + '  ELSE GETDATE() + '' 00:01:00'' + APPROX_END_TIME END)'            
      SET @CMD = @CMD + '  WHERE PROCESS_DATE = ''' + @PROCESS_DATE + ''' AND IS_DEPEND_ON LIKE ' + '''%#0,%'''            
      SET @CMD = @CMD + '  AND SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' AND PROCESS_FOR = ''' + @OTHER_PROCESS_FOR + ''''            
     END            
     SET @CMD = @CMD + ' END '            
     EXEC (@CMD)            
    END            
   END            
  END            
 END            
 ELSE            
 BEGIN            
  IF @CHKFLAG = 1             
  BEGIN            
   UPDATE TBL_AUTO_PROCESS_DETAIL SET PROCESS_HALTED_REASON = @PROCESS_HALTED_REASON,            
   PROCESS_STARTED_DATE = GETDATE(), PROCESS_ENDED_DATE = GETDATE()            
   WHERE SNO = @SNO AND PROCESS_STATUS = 0            
  END          
 END            
 FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @EXCHANGE, @SEGMENT, @BUSINESS_DATE, @PROCESS_ID, @INTERNAL_PROCESS_ID, @PROCESS_FOR, @PROCESS_FILE_PATH,             
              @PROCESS_FILE_NAME, @PROCESS_FILE_MOVE_PATH, @PROCESS_SP_NAME, @PROCESS_CHECK_QUERY,            
           @IS_FILE_BASED, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_NAME, @FILE_DWLOAD_MAP_DRIVE,        
           @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @FILE_INTERNET_LOCATION, @FILE_INTERNAL_ISS_PATH, @SUB_PROCESS_ID,            
              @OTHER_DBDETAILS, @OTHER_PROCESS_FOR, @SETT_NO, @SETT_TYPE            
END            
CLOSE @PROCESS_CURSOR            
DEALLOCATE @PROCESS_CURSOR            
            
CLOSE SYMMETRIC KEY   Key4CertAutoProcess;            
            
EXEC CLASS_AUTO_PROCESS_ALERT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_SETUP
-- --------------------------------------------------

CREATE PROC [dbo].[CLASS_AUTO_PROCESS_SETUP]                
(                
 @BUSINESS_DATE VARCHAR(11)                
)                
AS                
                
DECLARE @PROCESSCURSOR CURSOR,                
  @SETT_NO  VARCHAR(7),                 
  @SETT_TYPE  VARCHAR(2),                
  @NEWPROCESS_ID INT                
                
IF (SELECT ISNULL(COUNT(1),0) FROM MSAJAG.DBO.SETT_MST              
 WHERE START_DATE = @BUSINESS_DATE) > 0              
BEGIN                
      
 SELECT * INTO #TBL_AUTO_PROCESS_MASTER      
 FROM TBL_AUTO_PROCESS_MASTER      
 --WHERE PROCESS_FOR LIKE 'COLLATERAL%'
        
IF (      
 SELECT ISNULL(COUNT(1),0) FROM FOSCRIP2       
 WHERE MATURITYDATE LIKE @BUSINESS_DATE + '%'      
 AND SYMBOL = 'S&P500'      
   ) <= 0      
BEGIN      
 DELETE FROM #TBL_AUTO_PROCESS_MASTER      
 WHERE PROCESS_FOR LIKE '%P500'      
END      
      
 SELECT @NEWPROCESS_ID = MAX(PROCESS_ID)                 
 FROM   #TBL_AUTO_PROCESS_MASTER                
                 
 CREATE TABLE #MASTER_SETUP                
 (                
  [PROCESS_ID]  [INT] ,                
  [SETT_NO]   [VARCHAR](20) ,                
  [SETT_TYPE]   [VARCHAR](20) ,                
  [PROCESS_FOR]  [VARCHAR](30) ,                
  [IS_DEPEND_ON]  [VARCHAR](20) ,                
  [NEWPROCESS_ID]  [INT]  ,                
  [BUSINESS_DATE]  [VARCHAR](11)  ,                
  [PROCESS_START_DATE][DATETIME] ,                
  [PROCESS_END_DATE] [DATETIME]                 
 )                
                 
 IF (SELECT DISTINCT SEGMENT FROM PRADNYA.DBO.MULTICOMPANY WHERE SHAREDB = DB_NAME()) ='futures'                
 BEGIN   
 print 'suresh'              
  INSERT INTO #MASTER_SETUP                
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,                 
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,                
   BUSINESS_DATE = @BUSINESS_DATE,                
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),                
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)                
                  
  FROM #TBL_AUTO_PROCESS_MASTER T, Msajag.DBO.SETT_MST       M                 
   WHERE LEFT(START_DATE,11) = @BUSINESS_DATE                
   AND M.SETT_TYPE NOT IN ('O', 'Z', 'L' ,'S', 'P', 'B', 'A', 'AD', 'X', 'AC', 'H', 'T', 'OS', 'TS')                
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'                 
    THEN 500                 
    ELSE 0                 
     END)                
   AND PROCESS_TYPE = 'TRADE'                
   AND PROCESS_FOR <> 'FINOBL'                
   AND PROCESS_FOR <> 'DAILYOBL'                
   AND T.SETT_TYPE <> ''                
   AND PROCESS_FREQ = 'ONCE'                
  ORDER BY 1                
        
                 
  INSERT INTO #MASTER_SETUP                
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,                 
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,                
   BUSINESS_DATE = @BUSINESS_DATE,                
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),                
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)                
  FROM #TBL_AUTO_PROCESS_MASTER T, Msajag.DBO.SETT_MST       M                 
   WHERE LEFT(SEC_PAYIN,11) = @BUSINESS_DATE                
   AND M.SETT_TYPE NOT IN ('O', 'Z', 'L' ,'S', 'P', 'B', 'A', 'AD', 'X', 'AC', 'H', 'T', 'OS', 'TS')                
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'                 
    THEN 500                 
    ELSE 0                 
     END)                
   AND PROCESS_TYPE = 'SETTLEMENT'                
   AND PROCESS_FOR <> 'FINOBL'                
   AND T.SETT_TYPE <> ''                
   AND PROCESS_FREQ = 'ONCE'                
  ORDER BY 1                
                 
  INSERT INTO #MASTER_SETUP                
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,                 
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,                
   BUSINESS_DATE = @BUSINESS_DATE,                
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),                
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)                
  FROM #TBL_AUTO_PROCESS_MASTER T, Msajag.DBO.SETT_MST       M                 
   WHERE LEFT(START_DATE,11) = @BUSINESS_DATE                
   AND M.SETT_TYPE NOT IN ('O', 'Z')                
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'                 
    THEN 500                 
    ELSE 0                 
     END)                
   AND PROCESS_TYPE = 'TRADE'                
   AND PROCESS_FOR <> 'FINOBL'                
   AND PROCESS_FOR = 'DAILYOBL'                
   AND T.SETT_TYPE <> ''                
   AND PROCESS_FREQ = 'ONCE'                
   AND M.SETT_TYPE IN ('N', 'W', 'C', 'D')                
  ORDER BY 1                
                 
  INSERT INTO #MASTER_SETUP                
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,                 
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,                
   BUSINESS_DATE = @BUSINESS_DATE,                
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),                
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)                
  FROM #TBL_AUTO_PROCESS_MASTER T, Msajag.DBO.SETT_MST       M, (SELECT START_DATE = MAX(START_DATE) FROM MSAJAG.DBO.SETT_MST M1                 
     WHERE CONVERT(DATETIME,LEFT(START_DATE,11)) < @BUSINESS_DATE                
     AND SETT_TYPE IN ('N', 'D')) M1                
   WHERE LEFT(M.START_DATE,11) = LEFT(M1.START_DATE,11)                
   AND M.SETT_TYPE NOT IN ('O', 'Z')                
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'                 
    THEN 500                 
    ELSE 0                 
     END)                
   AND PROCESS_TYPE = 'SETTLEMENT'                
   AND PROCESS_FOR = 'FINOBL'                
   AND T.SETT_TYPE <> ''                
   AND PROCESS_FREQ = 'ONCE'                
   AND M.SETT_TYPE IN ('N', 'W', 'C', 'D')                
  ORDER BY 1                
            
  INSERT INTO #MASTER_SETUP                
  SELECT PROCESS_ID, SETT_NO, SETT_TYPE,                 
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,                
   BUSINESS_DATE = @BUSINESS_DATE,                
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),                
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)                 
  FROM #TBL_AUTO_PROCESS_MASTER T                
  WHERE PROCESS_TYPE <> 'SETTLEMENT'                
  AND PROCESS_FREQ = 'ONCE'                
  AND T.SETT_TYPE = ''                
  ORDER BY 1                  
 END                
 ELSE                
 BEGIN                
  INSERT INTO #MASTER_SETUP                
  SELECT PROCESS_ID, SETT_NO, SETT_TYPE,                 
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,                
   BUSINESS_DATE = @BUSINESS_DATE,                
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),                
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)                 
  FROM #TBL_AUTO_PROCESS_MASTER T                
  WHERE PROCESS_TYPE = 'TRADE'                
  AND PROCESS_FREQ = 'ONCE'                
  ORDER BY 1                
 END  
 
                 
 DECLARE @PROCESS_ID     INT,                
   @STARTDATE     DATETIME,                
   @ENDDATE     DATETIME,                
   @PROCESS_REPEAT_INTERVAL INT,                
   @PROCESS_CURSOR    CURSOR,                
   @TEMPPROCESS_ID    INT,                
   @NEWSTARTDATE    DATETIME,                
   @NEWENDDATE     DATETIME                
                 
                 
 CREATE TABLE #DATA                
 (                
  PROCESS_ID INT,                
  STARTDATE DATETIME,                
  ENDDATE  DATETIME                
 )                
                 
 SET @PROCESS_CURSOR = CURSOR FOR                
 SELECT PROCESS_ID,                
  STARTDATE = LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME,                 
  ENDDATE = LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME,                
  PROCESS_REPEAT_INTERVAL                
 FROM #TBL_AUTO_PROCESS_MASTER                
 WHERE PROCESS_FREQ = 'MULTIPLE'                
 ORDER BY PROCESS_ID                
 OPEN @PROCESS_CURSOR              
 FETCH NEXT FROM @PROCESS_CURSOR INTO @PROCESS_ID, @STARTDATE, @ENDDATE, @PROCESS_REPEAT_INTERVAL                
 WHILE @@FETCH_STATUS = 0                
 BEGIN                
  SET @TEMPPROCESS_ID = @PROCESS_ID                
  SET @NEWSTARTDATE = @STARTDATE                
  WHILE @NEWSTARTDATE < @ENDDATE AND @@FETCH_STATUS = 0                
  BEGIN                 
   SET @NEWENDDATE = DATEADD(MI,@PROCESS_REPEAT_INTERVAL,@NEWSTARTDATE)                
   IF @NEWENDDATE > @ENDDATE                
   BEGIN                
    SET @NEWENDDATE = @ENDDATE                
   END                
   INSERT INTO #DATA VALUES (@PROCESS_ID, @NEWSTARTDATE, @NEWENDDATE)                
   SET @NEWSTARTDATE = DATEADD(MI,@PROCESS_REPEAT_INTERVAL,@NEWSTARTDATE)                
  END                
  FETCH NEXT FROM @PROCESS_CURSOR INTO @PROCESS_ID, @STARTDATE, @ENDDATE, @PROCESS_REPEAT_INTERVAL                
 END                
 CLOSE @PROCESS_CURSOR                
 DEALLOCATE @PROCESS_CURSOR                
                 
 INSERT INTO #MASTER_SETUP                
 SELECT M.PROCESS_ID, M.SETT_NO, M.SETT_TYPE,                 
  PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,                
  BUSINESS_DATE = @BUSINESS_DATE,                
  PROCESS_START_DATE=STARTDATE,                
  PROCESS_END_DATE=ENDDATE                
  FROM #TBL_AUTO_PROCESS_MASTER M, #DATA D                
 WHERE M.PROCESS_ID = D.PROCESS_ID                
                 
 TRUNCATE TABLE #DATA                
 DROP TABLE #DATA                
                 
 ALTER TABLE #MASTER_SETUP                
 ADD SNO INT IDENTITY(1,1)                
                 
 UPDATE #MASTER_SETUP SET NEWPROCESS_ID = @NEWPROCESS_ID + SNO                
              
 DECLARE @INTLOOP INT                
 DECLARE @INTLOOP_MAX INT                
 SET @INTLOOP = 1                
 SELECT @INTLOOP_MAX =MAX(LEN(IS_DEPEND_ON)-LEN(REPLACE(IS_DEPEND_ON,'#',''))) FROM #MASTER_SETUP                
                 
 WHILE @INTLOOP <= @INTLOOP_MAX                
 BEGIN                
  UPDATE #MASTER_SETUP SET IS_DEPEND_ON = REPLACE(#MASTER_SETUP.IS_DEPEND_ON,'#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',','#' + CONVERT(VARCHAR,M1.NEWPROCESS_ID) + ',')                
  FROM #MASTER_SETUP M1, #MASTER_SETUP                
  WHERE #MASTER_SETUP.IS_DEPEND_ON LIKE '%#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',%'                
  AND #MASTER_SETUP.SETT_NO = M1.SETT_NO                
  AND #MASTER_SETUP.SETT_TYPE = M1.SETT_TYPE                
  AND M1.PROCESS_START_DATE <= #MASTER_SETUP.PROCESS_START_DATE                
  AND #MASTER_SETUP.PROCESS_START_DATE = (SELECT MIN(PROCESS_START_DATE) FROM #MASTER_SETUP M2                
    WHERE M1.PROCESS_ID = M2.PROCESS_ID                
    AND M1.PROCESS_START_DATE <= M2.PROCESS_START_DATE)                
  SET @INTLOOP = @INTLOOP + 1                
 END                
                 
 ALTER TABLE #MASTER_SETUP                
 ADD IS_DEPEND_ON_ORG_TEMP VARCHAR(500)                
                 
 UPDATE #MASTER_SETUP SET IS_DEPEND_ON_ORG_TEMP = IS_DEPEND_ON              
                 
 SELECT @INTLOOP = MIN(NEWPROCESS_ID)  FROM #MASTER_SETUP                
 SELECT @INTLOOP_MAX =MAX(NEWPROCESS_ID) FROM #MASTER_SETUP                
                 
 WHILE @INTLOOP <= @INTLOOP_MAX                
 BEGIN                
  UPDATE #MASTER_SETUP SET IS_DEPEND_ON_ORG_TEMP =               
  REPLACE(#MASTER_SETUP.IS_DEPEND_ON_ORG_TEMP + '#' + CONVERT(VARCHAR,M1.NEWPROCESS_ID) + ',',              
  '#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',','')                  
  FROM #MASTER_SETUP M1, #MASTER_SETUP    
  WHERE #MASTER_SETUP.IS_DEPEND_ON LIKE '%#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',%'                
  AND M1.NEWPROCESS_ID = @INTLOOP                 
                 
  SET @INTLOOP = @INTLOOP + 1                
 END                  
              
 UPDATE #MASTER_SETUP SET IS_DEPEND_ON = IS_DEPEND_ON_ORG_TEMP                
 WHERE IS_DEPEND_ON_ORG_TEMP <> ''                
        
 DELETE TBL_AUTO_PROCESS_DETAIL                
 WHERE PROCESS_DATE = LEFT(GETDATE(),11)                
                 
 INSERT INTO TBL_AUTO_PROCESS_DETAIL                
 SELECT PROCESS_DATE=LEFT(GETDATE(),11),BUSINESS_DATE=CONVERT(DATETIME,@BUSINESS_DATE),                
  EXCHANGE,SEGMENT,PROCESS_TYPE,PROCESS_FOR,PROCESS_ID,                
  SETT_NO,                
  SETT_TYPE,                
  INTERNAL_PROCESS_ID,SUB_PROCESS_ID=0,                
  PROCESS_START_DATE=LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME,PROCESS_STARTED_DATE='',                
  PROCESS_END_DATE=LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME,PROCESS_ENDED_DATE='',                
  PROCESS_FILE_NAME,IS_DEPEND_ON,IS_DEPEND_ON,WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS=0,                
  PROCESS_HALTED_AT=0,PROCESS_HALTED_REASON='',PROCESS_STATUS_ALERT,                 
  PROCESS_STATUS_ALERT_COUNT=0, PROCESS_STATUS_ALERT_INTERVAL, '',                
  PROCESS_OUTPUT_QUERY,'',          
  PROCESS_ORDER_ID                
 FROM #TBL_AUTO_PROCESS_MASTER                
 WHERE PROCESS_ID NOT IN (SELECT PROCESS_ID FROM #MASTER_SETUP)                
 AND SETT_NO <> '<SETNO>'                
                 
 INSERT INTO TBL_AUTO_PROCESS_DETAIL                
 SELECT PROCESS_DATE=LEFT(GETDATE(),11),BUSINESS_DATE=CONVERT(DATETIME,S.BUSINESS_DATE),                
  EXCHANGE,SEGMENT,M.PROCESS_TYPE,M.PROCESS_FOR,S.NEWPROCESS_ID,                
  S.SETT_NO,                
  S.SETT_TYPE,                
  INTERNAL_PROCESS_ID,SUB_PROCESS_ID=0,                
  S.PROCESS_START_DATE,PROCESS_STARTED_DATE='',S.PROCESS_END_DATE,                
  PROCESS_ENDED_DATE='',PROCESS_FILE_NAME,S.IS_DEPEND_ON,S.IS_DEPEND_ON,                
  WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS=0,PROCESS_HALTED_AT=0,                
  PROCESS_HALTED_REASON='',PROCESS_STATUS_ALERT, PROCESS_STATUS_ALERT_COUNT=0,                 
  PROCESS_STATUS_ALERT_INTERVAL, '',                
  PROCESS_OUTPUT_QUERY,'',          
  PROCESS_ORDER_ID                
 FROM #TBL_AUTO_PROCESS_MASTER M, #MASTER_SETUP S                
 WHERE M.PROCESS_ID = S.PROCESS_ID                
 AND S.SETT_NO <> '<SETNO>'                
                 
 TRUNCATE TABLE #MASTER_SETUP                
 DROP TABLE #MASTER_SETUP            
END              
                
/*                
SET @PROCESSCURSOR = CURSOR FOR                
 SELECT SETT_NO, SETT_TYPE FROM SETT_MST WHERE START_DATE = @BUSINESS_DATE                
 AND SETT_TYPE NOT IN ('O', 'Z')                
 AND RIGHT(SETT_NO,3) > (CASE WHEN SETT_TYPE = 'P' THEN 500 ELSE 0 END)                
 ORDER BY SETT_NO, SETT_TYPE                
OPEN @PROCESSCURSOR                
FETCH NEXT FROM @PROCESSCURSOR INTO @SETT_NO, @SETT_TYPE                
WHILE @@FETCH_STATUS = 0                
BEGIN                
 SELECT @SETT_NO, @SETT_TYPE                
 FETCH NEXT FROM @PROCESSCURSOR INTO @SETT_NO, @SETT_TYPE                
END                
CLOSE @PROCESSCURSOR                
DEALLOCATE @PROCESSCURSOR                
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_SETUP_Bkup_01Nov18
-- --------------------------------------------------


  
create PROC [dbo].[CLASS_AUTO_PROCESS_SETUP_Bkup_01Nov18]          
(          
 @BUSINESS_DATE VARCHAR(11)          
)          
AS          
          
DECLARE @PROCESSCURSOR CURSOR,          
  @SETT_NO  VARCHAR(7),           
  @SETT_TYPE  VARCHAR(2),          
  @NEWPROCESS_ID INT          
          
IF (SELECT ISNULL(COUNT(1),0) FROM msajag.dbo.sett_mst        
 WHERE START_DATE = LEFT(GETDATE(),11)) > 0        
BEGIN          
 SELECT @NEWPROCESS_ID = MAX(PROCESS_ID)           
 FROM   TBL_AUTO_PROCESS_MASTER          
           
 CREATE TABLE #MASTER_SETUP          
 (          
  [PROCESS_ID]  [INT] ,          
  [SETT_NO]   [VARCHAR](20) ,          
  [SETT_TYPE]   [VARCHAR](20) ,          
  [PROCESS_FOR]  [VARCHAR](30) ,          
  [IS_DEPEND_ON]  [VARCHAR](20) ,          
  [NEWPROCESS_ID]  [INT]  ,          
  [BUSINESS_DATE]  [VARCHAR](11)  ,          
  [PROCESS_START_DATE][DATETIME] ,          
  [PROCESS_END_DATE] [DATETIME]           
 )          
           
 IF (SELECT DISTINCT SEGMENT FROM PRADNYA.DBO.MULTICOMPANY WHERE SHAREDB = DB_NAME()) ='CAPITAL'          
 BEGIN          
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)          
            
  FROM TBL_AUTO_PROCESS_MASTER T, msajag.dbo.sett_mst M           
   WHERE LEFT(START_DATE,11) = @BUSINESS_DATE          
   AND M.SETT_TYPE NOT IN ('O', 'Z', 'L' ,'S', 'P', 'B', 'A', 'AD', 'X', 'AC', 'H', 'T', 'OS', 'TS', 'I', 'Q')          
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'           
    THEN 500           
    ELSE 0           
     END)          
   AND PROCESS_TYPE = 'TRADE'          
   AND PROCESS_FOR <> 'FINOBL'          
   AND PROCESS_FOR <> 'DAILYOBL'          
   AND T.SETT_TYPE <> ''          
   AND PROCESS_FREQ = 'ONCE'          
  ORDER BY 1          
           
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)          
  FROM TBL_AUTO_PROCESS_MASTER T, msajag.dbo.sett_mst M           
   WHERE LEFT(SEC_PAYIN,11) = @BUSINESS_DATE          
   AND M.SETT_TYPE NOT IN ('O', 'Z', 'L' ,'S', 'P', 'B', 'A', 'AD', 'X', 'AC', 'H', 'T', 'OS', 'TS', 'I', 'Q')          
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'           
    THEN 500           
    ELSE 0           
     END)          
   AND PROCESS_TYPE = 'SETTLEMENT'          
   AND PROCESS_FOR <> 'FINOBL'          
   AND T.SETT_TYPE <> ''          
   AND PROCESS_FREQ = 'ONCE'          
  ORDER BY 1          
           
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)          
  FROM TBL_AUTO_PROCESS_MASTER T, msajag.dbo.sett_mst M           
   WHERE LEFT(START_DATE,11) = @BUSINESS_DATE          
   AND M.SETT_TYPE NOT IN ('O', 'Z')          
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'           
    THEN 500           
    ELSE 0           
     END)          
   AND PROCESS_TYPE = 'TRADE'          
   AND PROCESS_FOR <> 'FINOBL'          
   AND PROCESS_FOR = 'DAILYOBL'          
   AND T.SETT_TYPE <> ''          
   AND PROCESS_FREQ = 'ONCE'          
   AND M.SETT_TYPE IN ('N', 'W', 'C', 'D')          
  ORDER BY 1          
           
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)          
  FROM TBL_AUTO_PROCESS_MASTER T, msajag.dbo.sett_mst M, (SELECT START_DATE = MAX(START_DATE) FROM msajag.dbo.sett_mst M1           
     WHERE CONVERT(DATETIME,LEFT(START_DATE,11)) < @BUSINESS_DATE          
     AND SETT_TYPE IN ('N', 'D')) M1          
   WHERE LEFT(M.START_DATE,11) = LEFT(M1.START_DATE,11)          
   AND M.SETT_TYPE NOT IN ('O', 'Z')          
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'           
    THEN 500           
    ELSE 0           
     END)          
   AND PROCESS_TYPE = 'SETTLEMENT'          
   AND PROCESS_FOR = 'FINOBL'          
   AND T.SETT_TYPE <> ''          
   AND PROCESS_FREQ = 'ONCE'          
   AND M.SETT_TYPE IN ('N', 'W', 'C', 'D')          
  ORDER BY 1          
           
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, SETT_NO, SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)           
  FROM TBL_AUTO_PROCESS_MASTER T          
  WHERE PROCESS_TYPE <> 'SETTLEMENT'          
  AND PROCESS_FREQ = 'ONCE'          
  AND T.SETT_TYPE = ''          
  ORDER BY 1          
 END          
 ELSE          
 BEGIN          
  INSERT INTO #MASTER_SETUP          
  SELECT PROCESS_ID, SETT_NO, SETT_TYPE,           
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
   BUSINESS_DATE = @BUSINESS_DATE,          
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),          
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)           
  FROM TBL_AUTO_PROCESS_MASTER T          
  WHERE PROCESS_TYPE = 'TRADE'          
  AND PROCESS_FREQ = 'ONCE'          
  ORDER BY 1          
 END          
           
 DECLARE @PROCESS_ID     INT,          
   @STARTDATE     DATETIME,          
   @ENDDATE     DATETIME,          
   @PROCESS_REPEAT_INTERVAL INT,          
   @PROCESS_CURSOR    CURSOR,          
   @TEMPPROCESS_ID    INT,          
   @NEWSTARTDATE    DATETIME,          
   @NEWENDDATE     DATETIME          
           
           
 CREATE TABLE #DATA          
 (          
  PROCESS_ID INT,          
  STARTDATE DATETIME,          
  ENDDATE  DATETIME          
 )          
           
 SET @PROCESS_CURSOR = CURSOR FOR          
 SELECT PROCESS_ID,          
  STARTDATE = LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME,           
  ENDDATE = LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME,          
  PROCESS_REPEAT_INTERVAL          
 FROM TBL_AUTO_PROCESS_MASTER          
 WHERE PROCESS_FREQ = 'MULTIPLE'          
 ORDER BY PROCESS_ID          
 OPEN @PROCESS_CURSOR          
 FETCH NEXT FROM @PROCESS_CURSOR INTO @PROCESS_ID, @STARTDATE, @ENDDATE, @PROCESS_REPEAT_INTERVAL          
 WHILE @@FETCH_STATUS = 0          
 BEGIN          
  SET @TEMPPROCESS_ID = @PROCESS_ID          
  SET @NEWSTARTDATE = @STARTDATE          
  WHILE @NEWSTARTDATE < @ENDDATE AND @@FETCH_STATUS = 0          
  BEGIN           
   SET @NEWENDDATE = DATEADD(MI,@PROCESS_REPEAT_INTERVAL,@NEWSTARTDATE)          
   IF @NEWENDDATE > @ENDDATE          
   BEGIN          
    SET @NEWENDDATE = @ENDDATE          
   END          
   INSERT INTO #DATA VALUES (@PROCESS_ID, @NEWSTARTDATE, @NEWENDDATE)          
   SET @NEWSTARTDATE = DATEADD(MI,@PROCESS_REPEAT_INTERVAL,@NEWSTARTDATE)          
  END          
  FETCH NEXT FROM @PROCESS_CURSOR INTO @PROCESS_ID, @STARTDATE, @ENDDATE, @PROCESS_REPEAT_INTERVAL          
 END          
 CLOSE @PROCESS_CURSOR          
 DEALLOCATE @PROCESS_CURSOR          
           
 INSERT INTO #MASTER_SETUP          
 SELECT M.PROCESS_ID, M.SETT_NO, M.SETT_TYPE,           
  PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,          
  BUSINESS_DATE = @BUSINESS_DATE,          
  PROCESS_START_DATE=STARTDATE,          
  PROCESS_END_DATE=ENDDATE          
  FROM TBL_AUTO_PROCESS_MASTER M, #DATA D          
 WHERE M.PROCESS_ID = D.PROCESS_ID          
           
 TRUNCATE TABLE #DATA          
 DROP TABLE #DATA          
           
 ALTER TABLE #MASTER_SETUP          
 ADD SNO INT IDENTITY(1,1)          
           
 UPDATE #MASTER_SETUP SET NEWPROCESS_ID = @NEWPROCESS_ID + SNO          
        
 DECLARE @INTLOOP INT          
 DECLARE @INTLOOP_MAX INT          
 SET @INTLOOP = 1          
 SELECT @INTLOOP_MAX =MAX(LEN(IS_DEPEND_ON)-LEN(REPLACE(IS_DEPEND_ON,'#',''))) FROM #MASTER_SETUP          
           
 WHILE @INTLOOP <= @INTLOOP_MAX          
 BEGIN          
  UPDATE #MASTER_SETUP SET IS_DEPEND_ON = REPLACE(#MASTER_SETUP.IS_DEPEND_ON,'#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',','#' + CONVERT(VARCHAR,M1.NEWPROCESS_ID) + ',')          
  FROM #MASTER_SETUP M1, #MASTER_SETUP          
  WHERE #MASTER_SETUP.IS_DEPEND_ON LIKE '%#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',%'          
  AND #MASTER_SETUP.SETT_NO = M1.SETT_NO          
  AND #MASTER_SETUP.SETT_TYPE = M1.SETT_TYPE          
  AND M1.PROCESS_START_DATE <= #MASTER_SETUP.PROCESS_START_DATE          
  AND #MASTER_SETUP.PROCESS_START_DATE = (SELECT MIN(PROCESS_START_DATE) FROM #MASTER_SETUP M2          
    WHERE M1.PROCESS_ID = M2.PROCESS_ID          
    AND M1.PROCESS_START_DATE <= M2.PROCESS_START_DATE)          
  SET @INTLOOP = @INTLOOP + 1          
 END          
           
 ALTER TABLE #MASTER_SETUP          
 ADD IS_DEPEND_ON_ORG_TEMP VARCHAR(500)          
           
 UPDATE #MASTER_SETUP SET IS_DEPEND_ON_ORG_TEMP = IS_DEPEND_ON        
           
 SELECT @INTLOOP = MIN(NEWPROCESS_ID)  FROM #MASTER_SETUP          
 SELECT @INTLOOP_MAX =MAX(NEWPROCESS_ID) FROM #MASTER_SETUP          
           
 WHILE @INTLOOP <= @INTLOOP_MAX          
 BEGIN          
  UPDATE #MASTER_SETUP SET IS_DEPEND_ON_ORG_TEMP =         
  REPLACE(#MASTER_SETUP.IS_DEPEND_ON_ORG_TEMP + '#' + CONVERT(VARCHAR,M1.NEWPROCESS_ID) + ',',        
  '#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',','')            
  FROM #MASTER_SETUP M1, #MASTER_SETUP          
  WHERE #MASTER_SETUP.IS_DEPEND_ON LIKE '%#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',%'          
  AND M1.NEWPROCESS_ID = @INTLOOP           
           
  SET @INTLOOP = @INTLOOP + 1          
 END            
        
 UPDATE #MASTER_SETUP SET IS_DEPEND_ON = IS_DEPEND_ON_ORG_TEMP          
 WHERE IS_DEPEND_ON_ORG_TEMP <> ''          
           
 DELETE TBL_AUTO_PROCESS_DETAIL          
 WHERE PROCESS_DATE = LEFT(GETDATE(),11)          
 --AND PROCESS_FOR <> 'COLLATERAL'  
           
 INSERT INTO TBL_AUTO_PROCESS_DETAIL          
 SELECT PROCESS_DATE=LEFT(GETDATE(),11),BUSINESS_DATE=CONVERT(DATETIME,@BUSINESS_DATE),          
  EXCHANGE,SEGMENT,PROCESS_TYPE,PROCESS_FOR,PROCESS_ID,          
  SETT_NO,          
  SETT_TYPE,          
  INTERNAL_PROCESS_ID,SUB_PROCESS_ID=0,          
  PROCESS_START_DATE=LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME,PROCESS_STARTED_DATE='',          
  PROCESS_END_DATE=LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME,PROCESS_ENDED_DATE='',          
  PROCESS_FILE_NAME,IS_DEPEND_ON,IS_DEPEND_ON,WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS=0,          
  PROCESS_HALTED_AT=0,PROCESS_HALTED_REASON='',PROCESS_STATUS_ALERT,           
  PROCESS_STATUS_ALERT_COUNT=0, PROCESS_STATUS_ALERT_INTERVAL, '',          
  PROCESS_OUTPUT_QUERY,'',    
  PROCESS_ORDER_ID          
 FROM TBL_AUTO_PROCESS_MASTER          
 WHERE PROCESS_ID NOT IN (SELECT PROCESS_ID FROM #MASTER_SETUP)          
 AND SETT_NO <> '<SETNO>'          
 --AND PROCESS_FOR <> 'COLLATERAL'  
           
 INSERT INTO TBL_AUTO_PROCESS_DETAIL          
 SELECT PROCESS_DATE=LEFT(GETDATE(),11),BUSINESS_DATE=CONVERT(DATETIME,S.BUSINESS_DATE),          
  EXCHANGE,SEGMENT,M.PROCESS_TYPE,M.PROCESS_FOR,S.NEWPROCESS_ID,          
  S.SETT_NO,          
  S.SETT_TYPE,          
  INTERNAL_PROCESS_ID,SUB_PROCESS_ID=0,          
  S.PROCESS_START_DATE,PROCESS_STARTED_DATE='',S.PROCESS_END_DATE,          
  PROCESS_ENDED_DATE='',PROCESS_FILE_NAME,S.IS_DEPEND_ON,S.IS_DEPEND_ON,          
  WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS=0,PROCESS_HALTED_AT=0,          
  PROCESS_HALTED_REASON='',PROCESS_STATUS_ALERT, PROCESS_STATUS_ALERT_COUNT=0,           
  PROCESS_STATUS_ALERT_INTERVAL, '',          
  PROCESS_OUTPUT_QUERY,'',    
  PROCESS_ORDER_ID          
 FROM TBL_AUTO_PROCESS_MASTER M, #MASTER_SETUP S          
 WHERE M.PROCESS_ID = S.PROCESS_ID          
 AND S.SETT_NO <> '<SETNO>'          
 --AND M.PROCESS_FOR <> 'COLLATERAL'  
           
 TRUNCATE TABLE #MASTER_SETUP          
 DROP TABLE #MASTER_SETUP      
END        
          
/*          
SET @PROCESSCURSOR = CURSOR FOR          
 SELECT SETT_NO, SETT_TYPE FROM msajag.dbo.sett_mst WHERE START_DATE = @BUSINESS_DATE          
 AND SETT_TYPE NOT IN ('O', 'Z')          
 AND RIGHT(SETT_NO,3) > (CASE WHEN SETT_TYPE = 'P' THEN 500 ELSE 0 END)          
 ORDER BY SETT_NO, SETT_TYPE          
OPEN @PROCESSCURSOR          
FETCH NEXT FROM @PROCESSCURSOR INTO @SETT_NO, @SETT_TYPE          
WHILE @@FETCH_STATUS = 0          
BEGIN          
 SELECT @SETT_NO, @SETT_TYPE          
 FETCH NEXT FROM @PROCESSCURSOR INTO @SETT_NO, @SETT_TYPE          
END          
CLOSE @PROCESSCURSOR          
DEALLOCATE @PROCESSCURSOR          
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_SETUP_Bkup_01NOV2048
-- --------------------------------------------------

create PROC [dbo].[CLASS_AUTO_PROCESS_SETUP_Bkup_01NOV2048]                
(                
 @BUSINESS_DATE VARCHAR(11)                
)                
AS                
                
DECLARE @PROCESSCURSOR CURSOR,                
  @SETT_NO  VARCHAR(7),                 
  @SETT_TYPE  VARCHAR(2),                
  @NEWPROCESS_ID INT                
                
IF (SELECT ISNULL(COUNT(1),0) FROM MSAJAG.DBO.SETT_MST              
 WHERE START_DATE = @BUSINESS_DATE) > 0              
BEGIN                
      
 SELECT * INTO #TBL_AUTO_PROCESS_MASTER      
 FROM TBL_AUTO_PROCESS_MASTER      
 --WHERE PROCESS_FOR LIKE 'COLLATERAL%'
        
IF (      
 SELECT ISNULL(COUNT(1),0) FROM FOSCRIP2       
 WHERE MATURITYDATE LIKE @BUSINESS_DATE + '%'      
 AND SYMBOL = 'S&P500'      
   ) <= 0      
BEGIN      
 DELETE FROM #TBL_AUTO_PROCESS_MASTER      
 WHERE PROCESS_FOR LIKE '%P500'      
END      
      
 SELECT @NEWPROCESS_ID = MAX(PROCESS_ID)                 
 FROM   #TBL_AUTO_PROCESS_MASTER                
                 
 CREATE TABLE #MASTER_SETUP                
 (                
  [PROCESS_ID]  [INT] ,                
  [SETT_NO]   [VARCHAR](20) ,                
  [SETT_TYPE]   [VARCHAR](20) ,                
  [PROCESS_FOR]  [VARCHAR](30) ,                
  [IS_DEPEND_ON]  [VARCHAR](20) ,                
  [NEWPROCESS_ID]  [INT]  ,                
  [BUSINESS_DATE]  [VARCHAR](11)  ,                
  [PROCESS_START_DATE][DATETIME] ,                
  [PROCESS_END_DATE] [DATETIME]                 
 )                
                 
 IF (SELECT DISTINCT SEGMENT FROM PRADNYA.DBO.MULTICOMPANY WHERE SHAREDB = DB_NAME()) ='futures'                
 BEGIN   
 print 'suresh'              
  INSERT INTO #MASTER_SETUP                
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,                 
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,                
   BUSINESS_DATE = @BUSINESS_DATE,                
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),                
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)                
                  
  FROM #TBL_AUTO_PROCESS_MASTER T, MSAJAG.DBO.SETT_MST       M                 
   WHERE LEFT(START_DATE,11) = @BUSINESS_DATE                
   AND M.SETT_TYPE NOT IN ('O', 'Z', 'L' ,'S', 'P', 'B', 'A', 'AD', 'X', 'AC', 'H', 'T', 'OS', 'TS')                
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'                 
    THEN 500                 
    ELSE 0                 
     END)                
   AND PROCESS_TYPE = 'TRADE'                
   AND PROCESS_FOR <> 'FINOBL'                
   AND PROCESS_FOR <> 'DAILYOBL'                
   AND T.SETT_TYPE <> ''                
   AND PROCESS_FREQ = 'ONCE'                
  ORDER BY 1                
        
       print 'suresh1'          
  INSERT INTO #MASTER_SETUP                
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,                 
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,                
   BUSINESS_DATE = @BUSINESS_DATE,                
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),                
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)                
  FROM #TBL_AUTO_PROCESS_MASTER T, MSAJAG.DBO.SETT_MST       M                 
   WHERE LEFT(SEC_PAYIN,11) = @BUSINESS_DATE                
   AND M.SETT_TYPE NOT IN ('O', 'Z', 'L' ,'S', 'P', 'B', 'A', 'AD', 'X', 'AC', 'H', 'T', 'OS', 'TS')                
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'                 
    THEN 500                 
    ELSE 0                 
     END)                
   AND PROCESS_TYPE = 'SETTLEMENT'                
   AND PROCESS_FOR <> 'FINOBL'                
   AND T.SETT_TYPE <> ''                
   AND PROCESS_FREQ = 'ONCE'                
  ORDER BY 1                
                 print 'suresh2'
  INSERT INTO #MASTER_SETUP                
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,                 
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,                
   BUSINESS_DATE = @BUSINESS_DATE,                
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),                
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)                
  FROM #TBL_AUTO_PROCESS_MASTER T, MSAJAG.DBO.SETT_MST       M                 
   WHERE LEFT(START_DATE,11) = @BUSINESS_DATE                
   AND M.SETT_TYPE NOT IN ('O', 'Z')                
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'                 
    THEN 500                 
    ELSE 0                 
     END)                
   AND PROCESS_TYPE = 'TRADE'                
   AND PROCESS_FOR <> 'FINOBL'                
   AND PROCESS_FOR = 'DAILYOBL'                
   AND T.SETT_TYPE <> ''                
   AND PROCESS_FREQ = 'ONCE'                
   AND M.SETT_TYPE IN ('N', 'W', 'C', 'D')                
  ORDER BY 1                
                 
  INSERT INTO #MASTER_SETUP                
  SELECT PROCESS_ID, M.SETT_NO, M.SETT_TYPE,                 
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,                
   BUSINESS_DATE = @BUSINESS_DATE,                
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),                
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)                
  FROM #TBL_AUTO_PROCESS_MASTER T, MSAJAG.DBO.SETT_MST       M, (SELECT START_DATE = MAX(START_DATE) FROM MSAJAG.DBO.SETT_MST M1                 
     WHERE CONVERT(DATETIME,LEFT(START_DATE,11)) < @BUSINESS_DATE                
     AND SETT_TYPE IN ('N', 'D')) M1                
   WHERE LEFT(M.START_DATE,11) = LEFT(M1.START_DATE,11)                
   AND M.SETT_TYPE NOT IN ('O', 'Z')                
   AND RIGHT(M.SETT_NO,3) > (CASE WHEN M.SETT_TYPE = 'P'                 
    THEN 500                 
    ELSE 0                 
     END)                
   AND PROCESS_TYPE = 'SETTLEMENT'                
   AND PROCESS_FOR = 'FINOBL'                
   AND T.SETT_TYPE <> ''                
   AND PROCESS_FREQ = 'ONCE'                
   AND M.SETT_TYPE IN ('N', 'W', 'C', 'D')                
  ORDER BY 1                
                 print 'suresh3'
  INSERT INTO #MASTER_SETUP                
  SELECT PROCESS_ID, SETT_NO, SETT_TYPE,                 
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,                
   BUSINESS_DATE = @BUSINESS_DATE,                
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),                
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)                 
  FROM #TBL_AUTO_PROCESS_MASTER T                
  WHERE PROCESS_TYPE <> 'SETTLEMENT'                
  AND PROCESS_FREQ = 'ONCE'                
  AND T.SETT_TYPE = ''                
  ORDER BY 1                  
 END                
 ELSE                
 BEGIN                
  INSERT INTO #MASTER_SETUP                
  SELECT PROCESS_ID, SETT_NO, SETT_TYPE,                 
   PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,                
   BUSINESS_DATE = @BUSINESS_DATE,                
   PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),                
   PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)                 
  FROM #TBL_AUTO_PROCESS_MASTER T                
  WHERE PROCESS_TYPE = 'TRADE'                
  AND PROCESS_FREQ = 'ONCE'                
  ORDER BY 1                
 END  
                 
 DECLARE @PROCESS_ID     INT,                
   @STARTDATE     DATETIME,                
   @ENDDATE     DATETIME,                
   @PROCESS_REPEAT_INTERVAL INT,                
   @PROCESS_CURSOR    CURSOR,                
   @TEMPPROCESS_ID    INT,                
   @NEWSTARTDATE    DATETIME,                
   @NEWENDDATE     DATETIME                
                 
              
 CREATE TABLE #DATA                
 (                
  PROCESS_ID INT,                
  STARTDATE DATETIME,                
  ENDDATE  DATETIME                
 )                
                 
 SET @PROCESS_CURSOR = CURSOR FOR                
 SELECT PROCESS_ID,                
  STARTDATE = LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME,                 
  ENDDATE = LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME,                
  PROCESS_REPEAT_INTERVAL                
 FROM #TBL_AUTO_PROCESS_MASTER                
 WHERE PROCESS_FREQ = 'MULTIPLE'                
 ORDER BY PROCESS_ID                
 OPEN @PROCESS_CURSOR              
 FETCH NEXT FROM @PROCESS_CURSOR INTO @PROCESS_ID, @STARTDATE, @ENDDATE, @PROCESS_REPEAT_INTERVAL                
 WHILE @@FETCH_STATUS = 0                
 BEGIN                
  SET @TEMPPROCESS_ID = @PROCESS_ID                
  SET @NEWSTARTDATE = @STARTDATE                
  WHILE @NEWSTARTDATE < @ENDDATE AND @@FETCH_STATUS = 0                
  BEGIN                 
   SET @NEWENDDATE = DATEADD(MI,@PROCESS_REPEAT_INTERVAL,@NEWSTARTDATE)                
   IF @NEWENDDATE > @ENDDATE                
   BEGIN                
    SET @NEWENDDATE = @ENDDATE                
   END                
   INSERT INTO #DATA VALUES (@PROCESS_ID, @NEWSTARTDATE, @NEWENDDATE)                
   SET @NEWSTARTDATE = DATEADD(MI,@PROCESS_REPEAT_INTERVAL,@NEWSTARTDATE)                
  END                
  FETCH NEXT FROM @PROCESS_CURSOR INTO @PROCESS_ID, @STARTDATE, @ENDDATE, @PROCESS_REPEAT_INTERVAL                
 END                
 CLOSE @PROCESS_CURSOR                
 DEALLOCATE @PROCESS_CURSOR                
                 
 INSERT INTO #MASTER_SETUP                
 SELECT M.PROCESS_ID, M.SETT_NO, M.SETT_TYPE,                 
  PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,                
  BUSINESS_DATE = @BUSINESS_DATE,                
  PROCESS_START_DATE=STARTDATE,                
  PROCESS_END_DATE=ENDDATE                
  FROM #TBL_AUTO_PROCESS_MASTER M, #DATA D                
 WHERE M.PROCESS_ID = D.PROCESS_ID                
                 
 TRUNCATE TABLE #DATA                
 DROP TABLE #DATA                
                 
 ALTER TABLE #MASTER_SETUP                
 ADD SNO INT IDENTITY(1,1)                
                 
 UPDATE #MASTER_SETUP SET NEWPROCESS_ID = @NEWPROCESS_ID + SNO                
              
 DECLARE @INTLOOP INT                
 DECLARE @INTLOOP_MAX INT                
 SET @INTLOOP = 1                
 SELECT @INTLOOP_MAX =MAX(LEN(IS_DEPEND_ON)-LEN(REPLACE(IS_DEPEND_ON,'#',''))) FROM #MASTER_SETUP                
                 
 WHILE @INTLOOP <= @INTLOOP_MAX                
 BEGIN                
  UPDATE #MASTER_SETUP SET IS_DEPEND_ON = REPLACE(#MASTER_SETUP.IS_DEPEND_ON,'#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',','#' + CONVERT(VARCHAR,M1.NEWPROCESS_ID) + ',')                
  FROM #MASTER_SETUP M1, #MASTER_SETUP                
  WHERE #MASTER_SETUP.IS_DEPEND_ON LIKE '%#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',%'                
  AND #MASTER_SETUP.SETT_NO = M1.SETT_NO                
  AND #MASTER_SETUP.SETT_TYPE = M1.SETT_TYPE                
  AND M1.PROCESS_START_DATE <= #MASTER_SETUP.PROCESS_START_DATE                
  AND #MASTER_SETUP.PROCESS_START_DATE = (SELECT MIN(PROCESS_START_DATE) FROM #MASTER_SETUP M2                
    WHERE M1.PROCESS_ID = M2.PROCESS_ID                
    AND M1.PROCESS_START_DATE <= M2.PROCESS_START_DATE)                
  SET @INTLOOP = @INTLOOP + 1                
 END                
                 
 ALTER TABLE #MASTER_SETUP                
 ADD IS_DEPEND_ON_ORG_TEMP VARCHAR(500)                
                 
 UPDATE #MASTER_SETUP SET IS_DEPEND_ON_ORG_TEMP = IS_DEPEND_ON              
                 
 SELECT @INTLOOP = MIN(NEWPROCESS_ID)  FROM #MASTER_SETUP                
 SELECT @INTLOOP_MAX =MAX(NEWPROCESS_ID) FROM #MASTER_SETUP                
                 
 WHILE @INTLOOP <= @INTLOOP_MAX                
 BEGIN                
  UPDATE #MASTER_SETUP SET IS_DEPEND_ON_ORG_TEMP =               
  REPLACE(#MASTER_SETUP.IS_DEPEND_ON_ORG_TEMP + '#' + CONVERT(VARCHAR,M1.NEWPROCESS_ID) + ',',              
  '#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',','')                  
  FROM #MASTER_SETUP M1, #MASTER_SETUP    
  WHERE #MASTER_SETUP.IS_DEPEND_ON LIKE '%#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',%'                
  AND M1.NEWPROCESS_ID = @INTLOOP                 
                 
  SET @INTLOOP = @INTLOOP + 1                
 END                  
              
 UPDATE #MASTER_SETUP SET IS_DEPEND_ON = IS_DEPEND_ON_ORG_TEMP                
 WHERE IS_DEPEND_ON_ORG_TEMP <> ''                
        
 DELETE TBL_AUTO_PROCESS_DETAIL                
 WHERE PROCESS_DATE = LEFT(GETDATE(),11)                
                 
 INSERT INTO TBL_AUTO_PROCESS_DETAIL                
 SELECT PROCESS_DATE=LEFT(GETDATE(),11),BUSINESS_DATE=CONVERT(DATETIME,@BUSINESS_DATE),                
  EXCHANGE,SEGMENT,PROCESS_TYPE,PROCESS_FOR,PROCESS_ID,                
  SETT_NO,                
  SETT_TYPE,                
  INTERNAL_PROCESS_ID,SUB_PROCESS_ID=0,                
  PROCESS_START_DATE=LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME,PROCESS_STARTED_DATE='',                
  PROCESS_END_DATE=LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME,PROCESS_ENDED_DATE='',                
  PROCESS_FILE_NAME,IS_DEPEND_ON,IS_DEPEND_ON,WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS=0,                
  PROCESS_HALTED_AT=0,PROCESS_HALTED_REASON='',PROCESS_STATUS_ALERT,                 
  PROCESS_STATUS_ALERT_COUNT=0, PROCESS_STATUS_ALERT_INTERVAL, '',                
  PROCESS_OUTPUT_QUERY,'',          
  PROCESS_ORDER_ID                
 FROM #TBL_AUTO_PROCESS_MASTER                
 WHERE PROCESS_ID NOT IN (SELECT PROCESS_ID FROM #MASTER_SETUP)                
 AND SETT_NO <> '<SETNO>'                
                 
 INSERT INTO TBL_AUTO_PROCESS_DETAIL                
 SELECT PROCESS_DATE=LEFT(GETDATE(),11),BUSINESS_DATE=CONVERT(DATETIME,S.BUSINESS_DATE),                
  EXCHANGE,SEGMENT,M.PROCESS_TYPE,M.PROCESS_FOR,S.NEWPROCESS_ID,                
  S.SETT_NO,                
  S.SETT_TYPE,                
  INTERNAL_PROCESS_ID,SUB_PROCESS_ID=0,                
  S.PROCESS_START_DATE,PROCESS_STARTED_DATE='',S.PROCESS_END_DATE,                
  PROCESS_ENDED_DATE='',PROCESS_FILE_NAME,S.IS_DEPEND_ON,S.IS_DEPEND_ON,                
  WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS=0,PROCESS_HALTED_AT=0,                
  PROCESS_HALTED_REASON='',PROCESS_STATUS_ALERT, PROCESS_STATUS_ALERT_COUNT=0,                 
  PROCESS_STATUS_ALERT_INTERVAL, '',                
  PROCESS_OUTPUT_QUERY,'',          
  PROCESS_ORDER_ID                
 FROM #TBL_AUTO_PROCESS_MASTER M, #MASTER_SETUP S                
 WHERE M.PROCESS_ID = S.PROCESS_ID                
 AND S.SETT_NO <> '<SETNO>'                
                 
 TRUNCATE TABLE #MASTER_SETUP                
 DROP TABLE #MASTER_SETUP            
END              
                
/*                
SET @PROCESSCURSOR = CURSOR FOR                
 SELECT SETT_NO, SETT_TYPE FROM SETT_MST WHERE START_DATE = @BUSINESS_DATE                
 AND SETT_TYPE NOT IN ('O', 'Z')                
 AND RIGHT(SETT_NO,3) > (CASE WHEN SETT_TYPE = 'P' THEN 500 ELSE 0 END)                
 ORDER BY SETT_NO, SETT_TYPE                
OPEN @PROCESSCURSOR                
FETCH NEXT FROM @PROCESSCURSOR INTO @SETT_NO, @SETT_TYPE                
WHILE @@FETCH_STATUS = 0                
BEGIN                
 SELECT @SETT_NO, @SETT_TYPE                
 FETCH NEXT FROM @PROCESSCURSOR INTO @SETT_NO, @SETT_TYPE                
END                
CLOSE @PROCESSCURSOR                
DEALLOCATE @PROCESSCURSOR                
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_UPDATE
-- --------------------------------------------------


  
  
    
    
create PROCEDURE [dbo].[CLASS_AUTO_PROCESS_UPDATE]    
(    
 @PROCESSDATE VARCHAR(11),    
 @PROCESSFLAG VARCHAR(2),    
 @PROCESSID VARCHAR(MAX),    
 @TIME VARCHAR(5),    
 @UNAME VARCHAR(25),    
 @STATUSNAME VARCHAR(25),    
 @REQIP VARCHAR(100),    
 @STATUSID VARCHAR(25)    
)    
AS    
--EXEC CLASS_AUTO_PROCESS_UPDATE @PROCESSDATE='19/12/2014',@PROCESSFLAG='RS',@PROCESSID='51~63~55~59~',@TIME='15:52',@STATUSID='BROKER',@STATUSNAME='BROKER',@UNAME='YATINN',@REQIP='::1'    
    
    
/*    
 @PROCESSFLAG  : RS - RE SCHEDULE PROCESS    
 @PROCESSFLAG  : RM - MARK TO RESUMING A PROCESS    
 @PROCESSFLAG  : CM - MARK TO PROCESS COMPLETED    
    
 PROCESS_STATUS = 0  - 'PENDING'     
 PROCESS_STATUS = 100 - 'COMPLETTED'     
 PROCESS_STATUS = 99  - 'IN - PROCESS'     
 ELSE     -'HALT DUE TO SOME ISSUE'    
     
*/    
    
SET @PROCESSDATE = LEFT(CONVERT(DATETIME,@PROCESSDATE,103),11)    
    
DECLARE @NEWSTART_TIME DATETIME    
DECLARE @ERRCODE INT    
DECLARE @ERRSDESC VARCHAR(100)    
    
CREATE TABLE #PROCESSID (PSNO INT IDENTITY(1,1), PROCID INT)    
INSERT INTO #PROCESSID     
SELECT * FROM DBO.FNSPLITSTRING2TBL(@PROCESSID,'~')    
    
--------------------------------- RE SCHEDULE ----------------------------------    
IF @PROCESSFLAG='RS'      
BEGIN    
 SET @NEWSTART_TIME = LEFT(CONVERT(DATETIME, @PROCESSDATE),11) + ' ' + @TIME  
  
 IF @NEWSTART_TIME < GETDATE()    
 BEGIN    
  SET @ERRCODE = -1    
  SET @ERRSDESC = 'INVALID PROCESS START NEW TIME'    
  SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC    
  RETURN    
 END    
      
 UPDATE TBL_AUTO_PROCESS_DETAIL SET     
 PROCESS_START_DATE = @NEWSTART_TIME,     
 PROCESS_STARTED_DATE = '',     
 PROCESS_ENDED_DATE = '',     
 PROCESS_END_DATE  = (CASE WHEN PROCESS_END_DATE <= @NEWSTART_TIME   
         THEN DATEADD(MI,  DATEDIFF(MI,PROCESS_START_DATE,PROCESS_END_DATE),@NEWSTART_TIME)    
         ELSE PROCESS_END_DATE  
       END),  
 PROCESS_STATUS = 0,  
 PROCESS_HALTED_REASON = '',  
 IS_DEPEND_ON = (CASE WHEN B.PSNO = 1 THEN IS_DEPEND_ON ELSE IS_DEPEND_ON_ORG END)  
 FROM #PROCESSID B    
 WHERE PROCESS_DATE = @PROCESSDATE    
 AND PROCESS_ID = B.PROCID    
 AND PROCESS_START_DATE < @NEWSTART_TIME    
    
 DROP TABLE #PROCESSID    
     
 SET @ERRCODE = 0    
 SET @ERRSDESC = 'UPDATED SUCCESSFULLY'    
 SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC    
 RETURN    
END    
    
    
--------------------------------- MARK TO RESUMING A PROCESS ---------------------------------    
IF @PROCESSFLAG='RM'      
BEGIN    
 SET @NEWSTART_TIME = CONVERT(DATETIME, @PROCESSDATE + ' ' + CONVERT(VARCHAR(5),GETDATE(),114))    
     
 UPDATE TBL_AUTO_PROCESS_DETAIL SET  PROCESS_STATUS = 0    
 FROM #PROCESSID B    
 WHERE PROCESS_DATE = @PROCESSDATE    
 AND PROCESS_ID = B.PROCID    
     
 -- RE SCHEDULING TO NEW TIMING     
 UPDATE TBL_AUTO_PROCESS_DETAIL SET     
 PROCESS_START_DATE = @NEWSTART_TIME,     
 PROCESS_END_DATE  = (CASE WHEN PROCESS_END_DATE <= @NEWSTART_TIME   
         THEN DATEADD(MI,  DATEDIFF(MI,PROCESS_START_DATE,PROCESS_END_DATE),@NEWSTART_TIME)    
         ELSE PROCESS_END_DATE  
       END)  
 FROM #PROCESSID B    
 WHERE PROCESS_DATE = @PROCESSDATE    
 AND PROCESS_ID = B.PROCID    
 AND PROCESS_START_DATE < @NEWSTART_TIME    
    
 DROP TABLE #PROCESSID    
     
 SET @ERRCODE = 0    
 SET @ERRSDESC = 'UPDATED SUCCESSFULLY'    
 SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC    
 RETURN    
    
END    
     
--------------------------------- MARK TO COMPLETE ---------------------------------    
IF @PROCESSFLAG='CM'       
BEGIN    
     
 UPDATE TBL_AUTO_PROCESS_DETAIL SET  PROCESS_STATUS = 100,  
 PROCESS_HALTED_REASON = 'MARKED SUCCESS BY THE USER ' + UPPER(@UNAME),  
 PROCESS_STATUS_ALERT = 1, PROCESS_STATUS_ALERT_COUNT = 1,  
 PROCESS_ENDED_DATE = GETDATE()  
 FROM #PROCESSID B    
 WHERE PROCESS_DATE = @PROCESSDATE    
 AND PROCESS_ID = B.PROCID    
 AND B.PSNO = 1   
  
UPDATE TBL_AUTO_PROCESS_DETAIL SET  IS_DEPEND_ON = REPLACE(IS_DEPEND_ON,'#'+CONVERT(VARCHAR,C.PROCID)+',',''),  
PROCESS_START_DATE = GETDATE() + ' 00:01:00',   
PROCESS_END_DATE = (CASE WHEN PROCESS_END_DATE > (GETDATE() + ' 00:01:00' + APPROX_END_TIME) THEN PROCESS_END_DATE  
    ELSE GETDATE() + ' 00:01:00' + APPROX_END_TIME END)  
 FROM #PROCESSID B, #PROCESSID C    
 WHERE PROCESS_DATE = @PROCESSDATE    
 AND PROCESS_ID = B.PROCID    
 AND B.PSNO <> 1   
 AND C.PSNO = 1  
 AND IS_DEPEND_ON LIKE '%#'+CONVERT(VARCHAR,C.PROCID)+',%'  
 DROP TABLE #PROCESSID    
     
 SET @ERRCODE = 0    
 SET @ERRSDESC = 'UPDATED SUCCESSFULLY'    
 SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC    
 RETURN    
END    
    
/*------------------------------------------ END OF THE PROC ---------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_AUTO_PROCESS_VIEW
-- --------------------------------------------------


    
CREATE PROCEDURE [dbo].[CLASS_AUTO_PROCESS_VIEW]    
(     
 @PROCESSDATE VARCHAR(11),    
 @PROCESSON VARCHAR(30),    
 @PROCESSTYPE VARCHAR(30),    
 @PROCESSFOR VARCHAR(30),    
 @UNAME VARCHAR(25),    
 @STATUSNAME VARCHAR(25),    
 @REQIP VARCHAR(100),    
 @STATUSID VARCHAR(25),    
 @PROCESSID BIGINT,    
 @LEVEL VARCHAR(1)     
)    
AS    
    
OPEN SYMMETRIC KEY   Key4CertAutoProcess    
     DECRYPTION BY   CERTIFICATE CertAutoProcess     
    
SET @PROCESSDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @PROCESSDATE, 103), 109)     
BEGIN     
      
 IF @LEVEL='1'---summary    
 BEGIN     
  SELECT SNO    
  ,PROCESS_TYPE    
  ,PROCESS_FOR    
  ,PROCESS_ID    
  ,SETT_NO    
  ,SETT_TYPE    
  ,PROCESS_START_DATE = CONVERT(VARCHAR(5),(CASE WHEN PROCESS_STARTED_DATE NOT LIKE 'JAN  1 1900%' THEN PROCESS_START_DATE ELSE PROCESS_START_DATE END),114)    
  ,PROCESS_END_DATE = CONVERT(VARCHAR(5),(CASE WHEN PROCESS_ENDED_DATE NOT LIKE 'JAN  1 1900%' THEN PROCESS_ENDED_DATE ELSE PROCESS_END_DATE END),114)    
  ,PROCESS_FILE_NAME=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_NAME)    
  ,WAIT_PERIOD = LEFT(WAIT_PERIOD,5)    
  ,APPROX_END_TIME = LEFT(APPROX_END_TIME,5)    
  ,PROCESS_STATUS = (CASE WHEN PROCESS_STATUS = 0 THEN 'PENDING' WHEN PROCESS_STATUS = 100 THEN 'COMPLETTED'     
       WHEN PROCESS_STATUS = 99 THEN 'IN - PROCESS' ELSE 'HALT DUE TO SOME ISSUE' END)     
  ,PROCESS_HALTED_REASON = REPLACE(REPLACE(PROCESS_HALTED_REASON, '<FONT COLOR=''RED''>',''),'</FONT>','')  
  , PROCESS_ORDER_ID          
  FROM .DBO.TBL_AUTO_PROCESS_DETAIL (NOLOCK)    
  WHERE     
  PROCESS_DATE = @PROCESSDATE    
  AND PROCESS_FOR LIKE CASE WHEN @PROCESSFOR='-----SELECT-----' THEN '' ELSE @PROCESSFOR END + '%'    
  AND PROCESS_TYPE LIKE CASE WHEN @PROCESSTYPE='-----SELECT-----' THEN '' ELSE @PROCESSTYPE END + '%'    
  AND PROCESS_STATUS  = CASE WHEN @PROCESSON <> '' THEN @PROCESSON ELSE PROCESS_STATUS END     
  ORDER BY PROCESS_ORDER_ID               
 END    
     
 IF @LEVEL='2'---detail    
 BEGIN     
      
  DECLARE @PROCESSCUR CURSOR     
  DECLARE @IS_DEPEND_ON_ORG VARCHAR(20)    
  DECLARE @PROCESS_ID BIGINT       
      
  CREATE TABLE #PROCESSID (PROCID BIGINT,DEPEND_ON BIGINT)    
    
  SET @PROCESSCUR = CURSOR FOR        
      SELECT PROCESS_ID,IS_DEPEND_ON_ORG=REPLACE(IS_DEPEND_ON_ORG,'#','')     
      FROM .DBO.TBL_AUTO_PROCESS_DETAIL (NOLOCK)    
      WHERE PROCESS_DATE = @PROCESSDATE    
      AND IS_DEPEND_ON_ORG <> ''    
      --AND IS_DEPEND_ON_ORG LIKE '%#' + CONVERT(VARCHAR,@PROCESSID) + ',%'    
  OPEN @PROCESSCUR    
      
  FETCH NEXT FROM @PROCESSCUR INTO @PROCESS_ID, @IS_DEPEND_ON_ORG    
  WHILE @@FETCH_STATUS = 0    
  BEGIN    
   INSERT INTO #PROCESSID    
   SELECT @PROCESS_ID,* FROM dbo.fnSplitString2Tbl(@IS_DEPEND_ON_ORG,',')    
       
   FETCH NEXT FROM @PROCESSCUR INTO @PROCESS_ID, @IS_DEPEND_ON_ORG    
  END    
  CLOSE @PROCESSCUR    
  DEALLOCATE @PROCESSCUR    
  delete from #processid where DEPEND_ON = 0     
    
  INSERT INTO #PROCESSID    
  SELECT PROCESS_ID,IS_DEPEND_ON_ORG=REPLACE(REPLACE(IS_DEPEND_ON_ORG,'#',''),',','')     
  FROM  .DBO.TBL_AUTO_PROCESS_DETAIL (NOLOCK) WHERE PROCESS_DATE = @PROCESSDATE     
  AND PROCESS_ID NOT IN(SELECT PROCID FROM #PROCESSID)    
  --AND IS_DEPEND_ON_ORG LIKE '%#' + CONVERT(VARCHAR,@PROCESSID) + ',%'    
    
  CREATE TABLE #PROC(PROCID BIGINT,DPND BIGINT,FLAG BIGINT)    
  INSERT INTO #PROC VALUES(@PROCESSID,0,1)    
      
  DECLARE @EXITLOOP BIGINT    
  SET @EXITLOOP = 0    
    
  DECLARE @I BIGINT    
  SET @I = 1    
  --exec CLASS_AUTO_PROCESS_VIEW '18/12/2014','','','','','','','','12','2'    
  WHILE @EXITLOOP = 0    
  BEGIN    
   SET @I = @I + 1    
       
   INSERT INTO #PROC    
   SELECT PROCID,DEPEND_ON,@I FROM #PROCESSID WHERE DEPEND_ON IN (SELECT PROCID FROM #PROC WHERE FLAG=@I-1)    
       
   IF (SELECT COUNT(1) FROM #PROC WHERE FLAG=@I) =0    
   BEGIN    
    SET @EXITLOOP = 1    
   END    
    
  END    
       
  SELECT SNO    
  ,PROCESS_TYPE    
  ,PROCESS_FOR    
  ,PROCESS_ID    
  ,SETT_NO    
  ,SETT_TYPE    
  ,PROCESS_START_DATE = CONVERT(VARCHAR(5),PROCESS_START_DATE,114)    
  ,PROCESS_END_DATE = CONVERT(VARCHAR(5),PROCESS_END_DATE,114)    
  ,PROCESS_FILE_NAME=.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_NAME)    
  ,WAIT_PERIOD = LEFT(WAIT_PERIOD,5)    
  ,APPROX_END_TIME = LEFT(APPROX_END_TIME,5)    
  ,PROCESS_STATUS = (CASE WHEN PROCESS_STATUS = 0 THEN 'PENDING' WHEN PROCESS_STATUS = 100 THEN 'COMPLETTED'     
       WHEN PROCESS_STATUS = 99 THEN 'IN - PROCESS' ELSE 'HALT DUE TO SOME ISSUE' END)     
  ,PROCESS_HALTED_REASON, PROCESS_ORDER_ID         
  FROM .DBO.TBL_AUTO_PROCESS_DETAIL D (NOLOCK),#PROC     
  WHERE     
  PROCESS_DATE = @PROCESSDATE    
  --AND PROCESS_FOR LIKE CASE WHEN @PROCESSFOR='-----SELECT-----' THEN '' ELSE @PROCESSFOR END + '%'    
  --AND PROCESS_TYPE LIKE CASE WHEN @PROCESSTYPE='-----SELECT-----' THEN '' ELSE @PROCESSTYPE END + '%'    
  --AND PROCESS_STATUS  = CASE WHEN @PROCESSON <> '' THEN @PROCESSON ELSE PROCESS_STATUS END    
  AND PROCESS_ID = #PROC.PROCID    
  ORDER BY FLAG, PROCESS_ORDER_ID    
      
  DROP TABLE #PROCESSID    
  DROP TABLE #PROC    
    
 END     
END    
    
CLOSE SYMMETRIC KEY   Key4CertAutoProcess;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_GET_AUTO_PROCESS_FOR_BULK
-- --------------------------------------------------


  
CREATE PROCEDURE [dbo].[CLASS_GET_AUTO_PROCESS_FOR_BULK]  
  
AS  
BEGIN  
 OPEN SYMMETRIC KEY   Key4CertAutoProcess            
   DECRYPTION BY   CERTIFICATE CertAutoProcess       
  
 SELECT DISTINCT   
 FILE_DWLOAD_LOCATION=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_LOCATION),  
 FILE_DWLOAD_USERID=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID),  
 FILE_DWLOAD_PWD=DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD)  
 FROM TBL_AUTO_PROCESS_MASTER  
 WHERE DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_LOCATION) <> ''  
    OR DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID) <> ''   
    OR DBO.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD) <> ''  
  
 CLOSE SYMMETRIC KEY   Key4CertAutoProcess;    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_USER_COUNT
-- --------------------------------------------------
CREATE PROC [dbo].[CLASS_USER_COUNT]  
(  
 @UNAME VARCHAR(30),  
 @ADMIN_NAME VARCHAR(30),
 @CUREXCHSEG VARCHAR(50) 	  
)  
/*  
 CLASS_USER_COUNT 'TEST', 'ADMINISTRATOR', ''  
 SELECT * FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = 'DSS'  
EXEC CLASS_USER_COUNT 'SAMARTHLANJEKAR','BROKER','NSE~~CAPITAL'

*/  
AS  
 DECLARE    
 @@EXCHANGE AS VARCHAR(3),  
 @@SEGMENT AS VARCHAR(15),  
 @@SHARESVR AS VARCHAR(20),  
 @@SHAREDB   AS VARCHAR(20),  
 @@SEGORD AS TINYINT,  
 @@SQL  AS VARCHAR(500),  
 @@MAINREC AS CURSOR  
   
  CREATE TABLE [DBO].[#RESULT]    
  (    
  EXCHANGE VARCHAR(6),     
  SEGMENT VARCHAR(10),  
  RESULT VARCHAR(100)  
  ) ON [PRIMARY]  
    
 CREATE TABLE #USERS  
 (  
  FLDUSERNAME VARCHAR(30)  
 )  
  
 IF UPPER(@ADMIN_NAME) = 'ADMINISTRATOR'
 BEGIN
  SET @@MAINREC = CURSOR FOR 	  	
 SELECT EXCHANGE, SEGMENT, SHAREDB, SHARESERVER FROM PRADNYA.DBO.MULTICOMPANY_ALL WHERE PRIMARYSERVER = 1 ORDER BY 1   
 END
 ELSE
 BEGIN
  SET @@MAINREC = CURSOR FOR 	
 SELECT EXCHANGE, SEGMENT, SHAREDB, SHARESERVER FROM PRADNYA.DBO.MULTICOMPANY_ALL WHERE EXCHANGE + '~~' + SEGMENT = 	@CUREXCHSEG  AND PRIMARYSERVER = 1 ORDER BY 1
 END		
   
 SET @@SEGORD = 1    
 OPEN @@MAINREC    
 FETCH NEXT FROM @@MAINREC INTO @@EXCHANGE, @@SEGMENT, @@SHAREDB, @@SHARESVR   
  WHILE @@FETCH_STATUS = 0  
   BEGIN  
   IF @@SHARESVR <> @@SERVERNAME   
    BEGIN  
     SET @@SQL = " INSERT INTO #USERS SELECT FLDUSERNAME FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+ @UNAME +"' "  
    END  
    ELSE  
    BEGIN   
     SET @@SQL = " INSERT INTO #USERS SELECT FLDUSERNAME #USERS FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+ @UNAME +"' "  
    END  
   PRINT(@@SQL)  
   EXEC(@@SQL)   
  --SELECT * FROM #USERS   
  IF @@ROWCOUNT <> 0  
   BEGIN  
   INSERT INTO #RESULT VALUES(@@EXCHANGE,@@SEGMENT,'USER AVAILABLE')  
   END   
    
 SET @@SEGORD = @@SEGORD + 1  
 FETCH NEXT FROM @@MAINREC INTO @@EXCHANGE, @@SEGMENT, @@SHAREDB, @@SHARESVR  
 END   
  
 SELECT * FROM #RESULT  
 DROP TABLE #RESULT  
 DROP TABLE #USERS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_VALIDATE_ADMIN
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CLASS_VALIDATE_ADMIN]    
(    
    @ADMINID     VARCHAR(50),    
    @IPADDRESS  VARCHAR(20),    
    @RETCODE    INT  OUTPUT,    
    @RETMSG     VARCHAR(200)  OUTPUT,    
    @UM_SESSION UNIQUEIDENTIFIER  OUTPUT,    
    @LASTLOGIN VARCHAR(40) OUTPUT    
)    
AS    

  DECLARE  @@USER_COUNT TINYINT    
  DECLARE  @@LASTLOGIN VARCHAR(40)      
  DECLARE  @@USER_SESSION VARCHAR(200)    
    
                              
  SELECT @@USER_COUNT = COUNT(1)    
  FROM   TBLCLASSADMINLOGINS (NOLOCK)    
  WHERE  FLDADMINNAME = @ADMINID    
                        
  IF ISNULL(@@USER_COUNT,0) = 0    
    BEGIN    
      INSERT INTO TBLCLASSADMINLOGINS    
	  (    
	   FLDAUTO,    
	   FLDADMINNAME,    
	   FLDSTATUS,    
	   FLDSTNAME,    
	   FLDSESSION,    
	   FLDIPADDRESS,    
	   FLDLASTVISIT,    
	   FLDTIMEOUTPRD    
	  )  
	  SELECT A.FLDAUTO_ADMIN,    
		A.FLDNAME,    
		A.FLDSTATUS,    
		A.FLDSTNAME,    
		'',    
		'',    
		GETDATE(),    
		''   
	  FROM   TBLADMIN A (NOLOCK)    
	  WHERE  A.FLDNAME = @ADMINID   
                                 
	  IF @@ERROR <> 0    
		BEGIN    
		 SET @RETCODE = 0    
		 SET @RETMSG = 'UNABLE TO FETCH USER INFORMATION'    
		 RETURN    
		END    
	END    
        
    
 SELECT @@LASTLOGIN = CONVERT(VARCHAR,ISNULL(FLDLASTLOGIN,''),113)    
 FROM TBLCLASSADMINLOGINS    
 WHERE FLDADMINNAME = @ADMINID    
    
    
 SET @@USER_SESSION = NEWID()    
                           
 UPDATE TBLCLASSADMINLOGINS    
 SET    FLDIPADDRESS = @IPADDRESS,    
   FLDSESSION = @@USER_SESSION,    
   FLDLASTVISIT = GETDATE(),    
   FLDLASTLOGIN = GETDATE()    
 WHERE  FLDADMINNAME = @ADMINID    
                            
  IF @@ERROR <> 0    
    BEGIN    
  SET @RETCODE = 0    
  SET @RETMSG = 'UNABLE TO UPDATE LOGIN INFORMATION'    
  RETURN    
    END    
        
  SET @RETCODE = 1    
  SET @RETMSG = 'USER LOGGED IN SUCCESSFULLY'    
  SET @UM_SESSION = @@USER_SESSION    
  SET @LASTLOGIN = @@LASTLOGIN                    
  RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_VALIDATE_USER
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[CLASS_VALIDATE_USER]  
(  
                @USERID     VARCHAR(50),  
                @IPADDRESS  VARCHAR(20),  
                @RETCODE    INT  OUTPUT,  
                @RETMSG     VARCHAR(200)  OUTPUT,  
                @UM_SESSION UNIQUEIDENTIFIER  OUTPUT,  
				@LASTLOGIN VARCHAR(40) OUTPUT  
)  
AS  
  
  DECLARE  @@USER_COUNT TINYINT  
  DECLARE  @@LASTLOGIN VARCHAR(40)    
  DECLARE  @@USER_SESSION VARCHAR(200)  
  
                            
  SELECT @@USER_COUNT = COUNT(1)  
  FROM   TBLCLASSUSERLOGINS (NOLOCK)  
  WHERE  FLDUSERNAME = @USERID  
                         
  IF ISNULL(@@USER_COUNT,0) = 0  
    BEGIN  
      
		INSERT INTO TBLCLASSUSERLOGINS  
		(  
			FLDAUTO,  
			FLDUSERNAME,  
			FLDSTATUS,  
			FLDSTNAME,  
			FLDSESSION,  
			FLDIPADDRESS,  
			FLDLASTVISIT,  
			FLDTIMEOUTPRD  
		)  
		SELECT P.FLDAUTO,  
			P.FLDUSERNAME,  
			A.FLDSTATUS,  
			P.FLDSTNAME,  
			'',  
			'',  
			GETDATE(),  
			ISNULL(M.FLDTIMEOUT,1)  
		FROM   TBLPRADNYAUSERS P (NOLOCK)  
		LEFT OUTER JOIN TBLUSERCONTROLMASTER M (NOLOCK)  
		ON (M.FLDUSERID = P.FLDAUTO)  
		INNER JOIN TBLADMIN A (NOLOCK)  
		ON (P.FLDADMINAUTO = A.FLDAUTO_ADMIN)  
		WHERE  P.FLDUSERNAME = @USERID  
  
		BEGIN  
			SET @RETCODE = 0               
			SET @RETMSG = 'UNABLE TO FETCH USER INFORMATION'               
			RETURN  
		END  
	END  
        
      
  
SELECT @@LASTLOGIN = CONVERT(VARCHAR,ISNULL(FLDLASTLOGIN,''),113)  
FROM TBLCLASSUSERLOGINS  
WHERE FLDUSERNAME = @USERID  
  
  
 SET @@USER_SESSION = NEWID()  
                         
 UPDATE TBLCLASSUSERLOGINS  
 SET    FLDIPADDRESS = @IPADDRESS,  
   FLDSESSION = @@USER_SESSION,  
   FLDLASTVISIT = GETDATE(),  
   FLDLASTLOGIN = GETDATE()  
 WHERE  FLDUSERNAME = @USERID  
                          
  IF @@ERROR <> 0  
    BEGIN  

		INSERT INTO V2_LOGIN_ERR_LOG VALUES (@USERID,'',@IPADDRESS,'LOGIN_FAIL','USER',GETDATE())
		SET @RETCODE = 0  
		SET @RETMSG = 'UNABLE TO UPDATE LOGIN INFORMATION'  

	RETURN  
    END  
								
		INSERT INTO V2_LOGIN_LOG (USERID, USERNAME, CATEGORY, STATUSNAME, STATUSID, IPADD, ACTION, ADDDT)
		SELECT  FLDAUTO,FLDUSERNAME, FLDCATEGORY,TBLPRADNYAUSERS.FLDSTNAME,FLDSTATUS, @IPADDRESS,'LOGIN',GETDATE() 
		FROM TBLPRADNYAUSERS , TBLADMIN WHERE 
		TBLADMIN.FLDAUTO_ADMIN = TBLPRADNYAUSERS.FLDADMINAUTO
		AND FLDUSERNAME = @USERID  

		SET @RETCODE = 1  
		SET @RETMSG = 'USER LOGGED IN SUCCESSFULLY'  
		SET @UM_SESSION = @@USER_SESSION  
		SET @LASTLOGIN = @@LASTLOGIN                  
  RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLIENTMARGIN_UPD
-- --------------------------------------------------




CREATE  PROCEDURE [dbo].[CLIENTMARGIN_UPD]                   
(                  
 @MDATE VARCHAR(11),                              
 @FROMPARTY VARCHAR(10) = '0',                              
 @TOPARTY VARCHAR(10) = 'ZZZZZZZZZZ',                
 @FLAG INT = 0                  
 ) AS         
/* begin tran      
 exec CLIENTMARGIN_UPD 'JUN  5 2013','0','ZZZ',1            
 rollback      
 */               
                             
 DECLARE @@OPENDATE  AS VARCHAR(11)                              
                             
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                            
                             
CREATE TABLE [#TBL_CLIENTMARGIN]                           
(                          
 [PARTY_CODE] [VARCHAR] (15)   ,                          
 [MARGINDATE] [DATETIME]  ,                          
 [BILLAMOUNT] [MONEY]  ,                          
 [LEDGERAMOUNT] [MONEY]  ,                          
 [CASH_COLL] [MONEY]  ,                          
 [NONCASH_COLL] [MONEY]  ,                          
 [INITIALMARGIN] [MONEY]  ,                          
 [LST_UPDATE_DT] [DATETIME]  ,                          
 [SHORT_NAME] [VARCHAR] (100)  ,                          
 [LONG_NAME] [VARCHAR] (100)  ,                          
 [BRANCH_CD] [VARCHAR] (20)  ,                          
 [FAMILY] [VARCHAR] (20)  ,                          
 [SUB_BROKER] [VARCHAR] (20)  ,                          
 [TRADER] [VARCHAR] (20)  ,                          
 [MTMMARGIN] [MONEY] NULL ,                          
 [ACTNONCASH_COLL] [MONEY] NULL ,                          
 [CLIENT_CTGRY] [VARCHAR] (10)  ,                          
 [ADDMARGIN] [MONEY] NULL ,                          
 [UNCLEARAMOUNT] [MONEY],                          
 [MRG_REP_COLL_CASH]  [MONEY],                          
 [MRG_REP_COLL_NCASH] [MONEY],                  
 [PREV_BILLAMOUNT] [MONEY],                  
 [PREMIUM_MARGIN] [MONEY]                  
)                          
                          
                          
 INSERT INTO #TBL_CLIENTMARGIN                             
                             
 SELECT  C2.PARTY_CODE,@MDATE + ' 00:00',0,0,0,0,0,GETDATE(),C1.SHORT_NAME,                             
 LEFT(C1.LONG_NAME,50),LTRIM(RTRIM(C1.BRANCH_CD)),LTRIM(RTRIM(C1.FAMILY)),LTRIM(RTRIM(C1.SUB_BROKER)),                            
 LTRIM(RTRIM(C1.TRADER)),0,0,DUMMY10,0,0,0,0,0,0 FROM CLIENT2 C2, CLIENT1 C1                            
 WHERE C1.CL_CODE = C2.CL_CODE                          
 and party_code between @FROMPARTY and @TOPARTY                
                          
CREATE INDEX [IDXPARTY] ON [DBO].[#TBL_CLIENTMARGIN] ([PARTY_CODE])                          
                          
                            
 UPDATE T SET BILLAMOUNT=AMOUNT FROM #TBL_CLIENTMARGIN T,                           
(                           
  SELECT PARTY_CODE,AMOUNT=ISNULL(SUM((CASE WHEN SELL_BUY=2 THEN                          
  ISNULL(AMOUNT,0) ELSE (0-ISNULL(AMOUNT,0)) END)),0)                              
  FROM FOACCBILL                              
  WHERE BILLDATE BETWEEN  @MDATE + ' 00:00:00' AND @MDATE +' 23:59:00'                
  and party_code between @FROMPARTY and @TOPARTY                          
  GROUP BY PARTY_CODE                            
) P WHERE P.PARTY_CODE = T.PARTY_CODE                            
                             
                            
 DECLARE @MAXMARGINDATE VARCHAR(11)                  
 SELECT @MAXMARGINDATE = MAX(BILLDATE) FROM FOACCBILL                      
 WHERE BILLDATE < @MDATE                  
                  
 UPDATE T SET PREV_BILLAMOUNT=AMOUNT FROM #TBL_CLIENTMARGIN T,                   
(                   
  SELECT PARTY_CODE,AMOUNT=ISNULL(SUM((CASE WHEN SELL_BUY=2 THEN                  
  ISNULL(AMOUNT,0) ELSE (0-ISNULL(AMOUNT,0)) END)),0)                      
  FROM FOACCBILL                      
  WHERE BILLDATE BETWEEN  @MAXMARGINDATE + ' 00:00:00' AND @MAXMARGINDATE +' 23:59:00'                 
  and party_code between @FROMPARTY and @TOPARTY                 
  GROUP BY PARTY_CODE                    
) P WHERE P.PARTY_CODE = T.PARTY_CODE                    
                           
                             
 SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM ACCOUNTFO_LEDGER_VIEW WHERE VTYP= 18                             
            AND VDT <= @MDATE +' 23:59' )                              
                             
 SELECT CLTCODE,OPPBAL=VAMT INTO #OPPBALANCE FROM ACCOUNTFO_LEDGER_VIEW WHERE 1=2                              
            
 IF @@OPENDATE <> ''                            
  BEGIN                              
      INSERT INTO  #OPPBALANCE                               
                             
    SELECT CLTCODE,SUM(OPPBAL) OPPBAL FROM                             
    (                            
      SELECT CLTCODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END),0)                              
      FROM ACCOUNTFO_LEDGER_VIEW B WHERE   B.VDT BETWEEN @@OPENDATE + ' 00:00:00' AND @@OPENDATE + ' 23:59:00' AND VTYP = 18                          
 AND CLTCODE IN  (SELECT PARTY_CODE FROM #TBL_CLIENTMARGIN)                           
      GROUP BY CLTCODE                              
                             
    UNION ALL                            
                             
      SELECT CLTCODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END),0)                                
      FROM ACCOUNTFO_LEDGER_VIEW B  WHERE B.VDT >=  @@OPENDATE AND EDT <= @MDATE AND VTYP <> 18                             
 AND CLTCODE IN  (SELECT PARTY_CODE FROM #TBL_CLIENTMARGIN)                           
      GROUP BY CLTCODE                          
    )                          
    T                            
    GROUP BY CLTCODE                              
  END                            
 ELSE                            
  BEGIN                            
 INSERT INTO  #OPPBALANCE                      
      SELECT CLTCODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END),0)                                
      FROM ACCOUNTFO_LEDGER_VIEW B  WHERE  VDT < @MDATE                             
 AND CLTCODE IN  (SELECT PARTY_CODE FROM #TBL_CLIENTMARGIN)                           
      GROUP BY CLTCODE                              
  END 
  
    
                           
                             
 SELECT CLTCODE,ROUND(SUM(OPPBAL),2) OPPBAL                             
 INTO  #OPPBALANCEFINAL                            
 FROM                            
   (                            
   SELECT CLTCODE,SUM(OPPBAL) OPPBAL  FROM #OPPBALANCE                              
     GROUP BY CLTCODE                              
    /*                          
   UNION ALL                            
                             
     SELECT CLTCODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END),0)                            
     FROM ACCOUNTFO_LEDGER_VIEW B  WHERE  VDT BETWEEN  @MDATE + ' 00:00:00' AND @MDATE +' 23:59:00'  AND                            
  VTYP <> '15' AND VTYP <> '18'
                             
 AND CLTCODE IN  (SELECT PARTY_CODE FROM #TBL_CLIENTMARGIN)                           
     GROUP BY CLTCODE*/                              
   ) T                            
 GROUP BY CLTCODE   

                          
                               
 UPDATE T SET LEDGERAMOUNT=OPPBAL FROM #TBL_CLIENTMARGIN T,#OPPBALANCEFINAL P WHERE P.CLTCODE = T.PARTY_CODE 
                                 
                            
 /*GETTING COLLATERAL FROM MSAJAG*/                            
                  
set @MAXMARGINDATE = @MDATE                            
 SELECT @MAXMARGINDATE = MAX(TRANS_DATE) FROM MSAJAG.DBO.COLLATERAL                              
  WHERE EXCHANGE = 'NSE'                              
  AND SEGMENT LIKE 'FUT%'                  
AND TRANS_DATE <= @MDATE + ' 23:59:00'          
                  
 UPDATE T SET CASH_COLL=CASH,NONCASH_COLL=NONCASH,ACTNONCASH_COLL=ACTNONCASH FROM #TBL_CLIENTMARGIN T,                           
(                          
  SELECT PARTY_CODE,                          
  CASH = ISNULL(CASH,0),                          
  NONCASH=ISNULL(NONCASH,0)   ,                          
  ACTNONCASH=ISNULL(ACTUALNONCASH,0)                           
  FROM MSAJAG.DBO.COLLATERAL                              
  WHERE EXCHANGE = 'NSE'                              
  AND SEGMENT LIKE 'FUT%'                              
  AND TRANS_DATE BETWEEN  @MAXMARGINDATE + ' 00:00:00' AND @MAXMARGINDATE +' 23:59:00'                          
)                          
 P                           
 WHERE P.PARTY_CODE = T.PARTY_CODE                            
                             
set @MAXMARGINDATE = @MDATE                             
 SELECT @MAXMARGINDATE = MAX(MDATE) FROM FOMARGINNEW                            
  WHERE MDATE <= @MDATE + ' 23:59:00'                  
                                 
 /*UPDATING MARGIN DETAILS*/                            
 UPDATE T SET INITIALMARGIN=P.MARGINAMOUNT,MTMMARGIN=P.MTMMARGIN,ADDMARGIN=P.ADDMARGIN,                  
 PREMIUM_MARGIN = ISNULL(P.NONSPREADMARGIN,0)                  
 FROM #TBL_CLIENTMARGIN T,                           
(                          
 SELECT  PARTY_CODE,SUM(PSPANMARGIN) MARGINAMOUNT, MTMMARGIN = SUM(MTOM), ADDMARGIN = SUM(ADDMARGIN),                  
 NONSPREADMARGIN=SUM(NONSPREADMARGIN)                          
 FROM FOMARGINNEW                            
 WHERE CL_TYPE LIKE 'C%'                           
 AND MDATE LIKE  (SELECT LEFT (MAX (BUSINESS_DATE), 11)                           
   FROM V2_BUSINESS_PROCESS (NOLOCK)                           
   WHERE BILLING > 0 AND BUSINESS_DATE <=  @MAXMARGINDATE) + '%'                          
 GROUP BY PARTY_CODE                            
) P                           
 WHERE P.PARTY_CODE = T.PARTY_CODE                            
                  
   
                             
                          
 UPDATE #TBL_CLIENTMARGIN                           
 SET UNCLEARAMOUNT = ISNULL(AMOUNT,0)                          
 from                          
 (                          
 SELECT                          
  AMOUNT = SUM(VAMT),                          
  CLTCODE                          
 FROM                           
  ACCOUNTFO_LEDGER_VIEW L                          
 WHERE                           
  VDT LIKE @MDATE +'%'                          
  AND EDT > VDT                          
  AND VTYP = 2                          
 GROUP BY                          
  CLTCODE                          
 ) UA                          
 WHERE                           
 UA.CLTCODE = #TBL_CLIENTMARGIN.PARTY_CODE                          
                          
                             
UPDATE #TBL_CLIENTMARGIN                          
SET                           
 MRG_REP_COLL_CASH = CASH,                          
 MRG_REP_COLL_NCASH = NONCASH                          
FROM                           
 TBL_COLLATERAL_MARGIN (NOLOCK)                          
WHERE                           
 EFFDATE BETWEEN  @MDATE + ' 00:00:00' AND @MDATE +' 23:59:00'                          
 AND TBL_COLLATERAL_MARGIN.PARTY_CODE = #TBL_CLIENTMARGIN.PARTY_CODE           
              
                
if @FLAG = 0                 
begin                          
 /*UPDATING TBL_CLIENTMARGIN*/                            
 DELETE TBL_CLIENTMARGIN  WHERE MARGINDATE BETWEEN  @MDATE + ' 00:00:00' AND @MDATE +' 23:59:00'                          
 and party_code between @FROMPARTY and @TOPARTY                
                             
 INSERT  INTO TBL_CLIENTMARGIN SELECT * FROM #TBL_CLIENTMARGIN WHERE                          
 (BILLAMOUNT<>0 OR INITIALMARGIN <> 0 OR LEDGERAMOUNT <> 0 OR  CASH_COLL <> 0 OR NONCASH_COLL <> 0)                            
 ORDER BY PARTY_CODE                            
                   
                          
                          
/*------------------------- PROCESS CONTROLER PLUG IN --------------------------------*/                          
UPDATE                           
 V2_BUSINESS_PROCESS                           
SET                           
 CLIENTMARGINPOP = CLIENTMARGINPOP + 1 ,                          
 LASTUPDATEDATE = GETDATE()                          
WHERE                           
 LEFT(BUSINESS_DATE,11) = @MDATE                          
                          
INSERT INTO V2_PROCESS_STATUS_LOG                           
(                           
 EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,                          
 FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP                          
)                          
SELECT                          
 EXCHANGE=(SELECT TOP 1 EXCHANGE FROM FOTAXES),                          
 SEGMENT='FUTURES',                          
 BUSINESSDATE=@MDATE,                          
 PROCESSID = 'MRGPOP',                          
 PROCESSNAME='CLIENT MARGIN POP',                          
 FILENAME='',                          
 START_END_FLAG=1,                          
 PROCESSDATE=GETDATE(),                          
 PROCESSBY='',                          
 MACHINEIP=''                          
       
      
                          
/*-----------------------------------------------------------------------------------*/                           
                        
 EXEC PROC_MARGIN_REPORTING @MDATE,'0','ZZZZZZZZ'                   
end            
Else                
Begin  
PRINT 'SURESH'              
/* SELECT PARTY_CODE,                                     
 AMOUNT = -(CASE WHEN LEDGERAMOUNT >= ((LEDGERAMOUNT + CASH_COLL + NONCASH_COLL) - (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN))                
    THEN ((LEDGERAMOUNT + CASH_COLL + NONCASH_COLL) - (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN))                
       ELSE LEDGERAMOUNT                
    END)                                 
 FROM  #TBL_CLIENTMARGIN                
 where ((LEDGERAMOUNT + CASH_COLL + NONCASH_COLL) - (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN)) > 0               
 and LEDGERAMOUNT > 0               
 */            
 
 SELECT PARTY_CODE,                                     
 JVAMT = -(CASE WHEN ((LEDGERAMOUNT + CASH_COLL + NONCASH_COLL) - (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN)) > 0              
			   THEN (CASE WHEN LEDGERAMOUNT > 0 
						  THEN (CASE WHEN LEDGERAMOUNT > ((LEDGERAMOUNT + CASH_COLL + NONCASH_COLL) - (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN)) 
									 then ((LEDGERAMOUNT + CASH_COLL + NONCASH_COLL) - (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN))
									 else LEDGERAMOUNT
							    End)									 
						  ELSE 0 END)
			   ELSE 0 END), 
 AMOUNT = (Case when (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN) = 0 Then (CASH_COLL + NONCASH_COLL)          
      Else (CASE WHEN ((LEDGERAMOUNT + CASH_COLL + NONCASH_COLL) - (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN)) > 0              
    THEN (CASE WHEN LEDGERAMOUNT > 0 AND ((CASH_COLL + NONCASH_COLL) - (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN)) > 0            
      THEN ((CASH_COLL + NONCASH_COLL) - (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN))            
      ELSE (CASE WHEN LEDGERAMOUNT > 0 THEN 0 
			ELSE ((LEDGERAMOUNT + CASH_COLL + NONCASH_COLL) - (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN))                    
			END)
    END)                  
       ELSE 0 End)                
    END)                          
 FROM  #TBL_CLIENTMARGIN                
 where ( ((LEDGERAMOUNT + CASH_COLL + NONCASH_COLL) - (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN)) > 0               
 Or (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN) = 0
 or (CASE WHEN ((LEDGERAMOUNT + CASH_COLL + NONCASH_COLL) - (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN)) > 0              
			   THEN (CASE WHEN LEDGERAMOUNT > 0 
						  THEN (CASE WHEN LEDGERAMOUNT > ((LEDGERAMOUNT + CASH_COLL + NONCASH_COLL) - (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN)) 
									 then ((LEDGERAMOUNT + CASH_COLL + NONCASH_COLL) - (INITIALMARGIN + MTMMARGIN + ADDMARGIN + PREMIUM_MARGIN))
									 else LEDGERAMOUNT
							    End)									 
						  ELSE 0 END)
			   ELSE 0 END) > 0 )  
			       
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLIENTMARGIN_UPD_BKUP_05NOV18
-- --------------------------------------------------

create PROC [dbo].[CLIENTMARGIN_UPD_BKUP_05NOV18] (@MDATE VARCHAR(11) ) AS    
     
 DECLARE @@OPENDATE  AS VARCHAR(11)      
     
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
     
CREATE TABLE [#TBL_CLIENTMARGIN]   
(  
 [PARTY_CODE] [VARCHAR] (15),  
 [MARGINDATE] [DATETIME],  
 [BILLAMOUNT] [MONEY],  
 [LEDGERAMOUNT] [MONEY],  
 [CASH_COLL] [MONEY],  
 [NONCASH_COLL] [MONEY],  
 [INITIALMARGIN] [MONEY],  
 [LST_UPDATE_DT] [DATETIME],  
 [SHORT_NAME] [VARCHAR] (100),  
 [LONG_NAME] [VARCHAR] (100),  
 [BRANCH_CD] [VARCHAR] (20),  
 [FAMILY] [VARCHAR] (20),  
 [SUB_BROKER] [VARCHAR] (20),  
 [TRADER] [VARCHAR] (20),  
 [MTMMARGIN] [MONEY] NULL,  
 [ACTNONCASH_COLL] [MONEY] NULL,  
 [CLIENT_CTGRY] [VARCHAR] (10),  
 [ADDMARGIN] [MONEY] NULL,  
 [UNCLEARAMOUNT] [MONEY],  
 [MRG_REP_COLL_CASH]  [MONEY],  
 [MRG_REP_COLL_NCASH] [MONEY],  
 [PREV_BILLAMOUNT] [MONEY],  
 [PREMIUM_MARGIN] [MONEY]  
)  
  
  
 INSERT INTO #TBL_CLIENTMARGIN     
     
 SELECT  C2.PARTY_CODE,@MDATE + ' 00:00',0,0,0,0,0,GETDATE(),C1.SHORT_NAME,     
 LEFT(C1.LONG_NAME,50),LTRIM(RTRIM(C1.BRANCH_CD)),LTRIM(RTRIM(C1.FAMILY)),LTRIM(RTRIM(C1.SUB_BROKER)),    
 LTRIM(RTRIM(C1.TRADER)),0,0,DUMMY10,0,0,0,0,0,0 FROM CLIENT2 C2, CLIENT1 C1    
 WHERE C1.CL_CODE = C2.CL_CODE  
  
 CREATE INDEX [IDXPARTY] ON [DBO].[#TBL_CLIENTMARGIN] ([PARTY_CODE])  
  
    
 UPDATE T SET BILLAMOUNT=AMOUNT FROM #TBL_CLIENTMARGIN T,   
(   
  SELECT PARTY_CODE,AMOUNT=ISNULL(SUM((CASE WHEN SELL_BUY=2 THEN  
  ISNULL(AMOUNT,0) ELSE (0-ISNULL(AMOUNT,0)) END)),0)      
  FROM FOACCBILL      
  WHERE BILLDATE BETWEEN  @MDATE + ' 00:00:00' AND @MDATE +' 23:59:59'  
  GROUP BY PARTY_CODE    
) P WHERE P.PARTY_CODE = T.PARTY_CODE    
     
 DECLARE @MAXMARGINDATE VARCHAR(11)  
 SELECT @MAXMARGINDATE = MAX(BILLDATE) FROM FOACCBILL      
 WHERE BILLDATE < @MDATE  
  
 UPDATE T SET PREV_BILLAMOUNT=AMOUNT FROM #TBL_CLIENTMARGIN T,   
(   
  SELECT PARTY_CODE,AMOUNT=ISNULL(SUM((CASE WHEN SELL_BUY=2 THEN  
  ISNULL(AMOUNT,0) ELSE (0-ISNULL(AMOUNT,0)) END)),0)      
  FROM FOACCBILL      
  WHERE BILLDATE BETWEEN  @MAXMARGINDATE + ' 00:00:00' AND @MAXMARGINDATE +' 23:59:59'  
  GROUP BY PARTY_CODE    
) P WHERE P.PARTY_CODE = T.PARTY_CODE    
     
 SELECT @@OPENDATE = ( SELECT LEFT(CONVERT(VARCHAR,ISNULL(MAX(VDT),0),109),11) FROM ACCOUNTCURBFO.DBO.LEDGER WHERE VTYP= 18     
            AND VDT <= @MDATE +' 23:59' )      
     
 SELECT CLTCODE,OPPBAL=VAMT INTO #OPPBALANCE FROM ACCOUNTCURBFO.DBO.LEDGER WHERE 1=2      
     
 IF @@OPENDATE <> ''    
  BEGIN      
      INSERT INTO  #OPPBALANCE       
     
    SELECT CLTCODE,SUM(OPPBAL) OPPBAL FROM     
    (    
      SELECT CLTCODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END),0)      
      FROM ACCOUNTCURBFO.DBO.LEDGER B WHERE   B.VDT BETWEEN @@OPENDATE + ' 00:00:00' AND @@OPENDATE + ' 23:59:59' AND VTYP = 18  
 AND CLTCODE IN  (SELECT PARTY_CODE FROM #TBL_CLIENTMARGIN)   
      GROUP BY CLTCODE      
     
    UNION ALL    
     
      SELECT CLTCODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END),0)        
      FROM ACCOUNTCURBFO.DBO.LEDGER B  WHERE B.VDT >=  @@OPENDATE AND VDT < @MDATE AND VTYP <> 18     
 AND CLTCODE IN  (SELECT PARTY_CODE FROM #TBL_CLIENTMARGIN)   
      GROUP BY CLTCODE  
    )  
    T    
    GROUP BY CLTCODE      
  END    
 ELSE    
  BEGIN    
      INSERT INTO  #OPPBALANCE       
      SELECT CLTCODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END),0)        
      FROM ACCOUNTCURBFO.DBO.LEDGER B  WHERE  VDT < @MDATE     
 AND CLTCODE IN  (SELECT PARTY_CODE FROM #TBL_CLIENTMARGIN)   
      GROUP BY CLTCODE      
  END    
     
 SELECT CLTCODE,ROUND(SUM(OPPBAL),2) OPPBAL     
 INTO  #OPPBALANCEFINAL    
 FROM    
   (    
   SELECT CLTCODE,SUM(OPPBAL) OPPBAL  FROM #OPPBALANCE      
     GROUP BY CLTCODE      
    
   UNION ALL    
     
     SELECT CLTCODE,OPPBAL = ISNULL(SUM( CASE WHEN UPPER(B.DRCR) = 'C' THEN B.VAMT ELSE -B.VAMT END),0)        
     FROM ACCOUNTCURBFO.DBO.LEDGER B  WHERE  VDT BETWEEN  @MDATE + ' 00:00:00' AND @MDATE +' 23:59:59'  AND    
  VTYP <> '15' AND VTYP <> '18'    
 AND CLTCODE IN  (SELECT PARTY_CODE FROM #TBL_CLIENTMARGIN)   
     GROUP BY CLTCODE      
   ) T    
 GROUP BY CLTCODE      
       
 UPDATE T SET LEDGERAMOUNT=OPPBAL FROM #TBL_CLIENTMARGIN T,#OPPBALANCEFINAL P WHERE P.CLTCODE = T.PARTY_CODE    
     
    
 /*GETTING COLLATERAL FROM MSAJAG*/    
 UPDATE T SET CASH_COLL=CASH,NONCASH_COLL=NONCASH,ACTNONCASH_COLL=ACTNONCASH FROM #TBL_CLIENTMARGIN T,   
(  
  SELECT PARTY_CODE,  
  CASH = ISNULL(CASH,0),  
  NONCASH=ISNULL(NONCASH,0)  ,  
  ACTNONCASH=ISNULL(ACTUALNONCASH,0)   
  FROM MSAJAG.DBO.COLLATERAL      
  WHERE EXCHANGE = (SELECT EXCHANGE FROM FOGLOBALS)  
  AND SEGMENT LIKE 'FUT%'      
  AND TRANS_DATE BETWEEN  @MDATE + ' 00:00:00' AND @MDATE +' 23:59:59'  
)  
 P   
 WHERE P.PARTY_CODE = T.PARTY_CODE    
     
    
  
 UPDATE T SET INITIALMARGIN=P.INTIAL_MARGIN,MTMMARGIN=0,ADDMARGIN=0
 FROM #TBL_CLIENTMARGIN T,   
 (  
  SELECT  PARTY_CODE,INTIAL_MARGIN=SUM(INTIAL_MARGIN+NET_BUY_PREMIUM)
  FROM FOMARGINNEW    
  WHERE CLIENT_TYPE LIKE 'C%'   
  AND MDATE BETWEEN @MDATE AND @MDATE + ' 23:59'  
  GROUP BY PARTY_CODE    
 ) P   
  WHERE P.PARTY_CODE = T.PARTY_CODE    
  
  
 UPDATE #TBL_CLIENTMARGIN   
 SET UNCLEARAMOUNT = ISNULL(AMOUNT,0)  
 FROM  
 (  
 SELECT  
  AMOUNT = SUM(VAMT),  
  CLTCODE  
 FROM   
  ACCOUNTCURBFO.DBO.LEDGER L  
 WHERE   
  VDT LIKE @MDATE +'%'  
  AND EDT > VDT  
  AND VTYP = 2  
 GROUP BY  
  CLTCODE  
 ) UA  
 WHERE   
 UA.CLTCODE = #TBL_CLIENTMARGIN.PARTY_CODE  
  
     
UPDATE #TBL_CLIENTMARGIN  
SET   
 MRG_REP_COLL_CASH = CASH,  
 MRG_REP_COLL_NCASH = NONCASH  
FROM   
 TBL_COLLATERAL_MARGIN (NOLOCK)  
WHERE   
 EFFDATE BETWEEN  @MDATE + ' 00:00:00' AND @MDATE +' 23:59:59'  
 AND TBL_COLLATERAL_MARGIN.PARTY_CODE = #TBL_CLIENTMARGIN.PARTY_CODE  
  
 /*UPDATING TBL_CLIENTMARGIN*/    
 DELETE TBL_CLIENTMARGIN  WHERE MARGINDATE BETWEEN  @MDATE + ' 00:00:00' AND @MDATE +' 23:59:59'  
     
 INSERT  INTO TBL_CLIENTMARGIN SELECT    
 PARTY_CODE,MARGINDATE,BILLAMOUNT,  
 LEDGERAMOUNT,CASH_COLL,NONCASH_COLL,  
 INITIALMARGIN,LST_UPDATE_DT,SHORT_NAME,  
 LONG_NAME,BRANCH_CD,FAMILY,  
 SUB_BROKER,TRADER,MTMMARGIN,  
 ACTNONCASH_COLL,CLIENT_CTGRY,  
 ADDMARGIN,UNCLEARAMOUNT,  
 MRG_REP_COLL_CASH,MRG_REP_COLL_NCASH,  
 PREV_BILLAMOUNT,  
 PREMIUM_MARGIN  
 FROM #TBL_CLIENTMARGIN  WHERE  
 (BILLAMOUNT<>0 OR INITIALMARGIN <> 0 OR LEDGERAMOUNT <> 0 OR  CASH_COLL <> 0 OR NONCASH_COLL <> 0)    
 ORDER BY PARTY_CODE    
  
 EXEC V2_PROCESS_STATUS_LOG_UPD @MDATE,'MRGPOP','','',''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLIENTMARGIN_UPD_NEW
-- --------------------------------------------------
CREATE  PROC  [dbo].[CLIENTMARGIN_UPD_NEW] (@DATEFROM VARCHAR (20),@DATETO AS VARCHAR(20))
AS      
  
DECLARE      
@MDATE  VARCHAR(11),
@DATECUR CURSOR      
      
CREATE TABLE #MARGINDATES (MDATE DATETIME)
DECLARE @REPORTDATE AS DATETIME   
SET   @REPORTDATE  = @DATEFROM  
  
WHILE @REPORTDATE <=  @DATETO --+ ' 23:59'     
 BEGIN    
 INSERT INTO #MARGINDATES VALUES (CONVERT(VARCHAR,@REPORTDATE,101))  
 SELECT @REPORTDATE = DATEADD(DAY,1,@REPORTDATE)                
END 
      
SET @DATECUR = CURSOR FOR  SELECT LEFT(MDATE,11) FROM  #MARGINDATES
OPEN @DATECUR      
          
      
FETCH NEXT FROM @DATECUR INTO @MDATE
WHILE @@FETCH_STATUS = 0       
BEGIN      
      
 EXECUTE CLIENTMARGIN_UPD  @MDATE
    
 FETCH NEXT FROM @DATECUR INTO @MDATE
END      
CLOSE @DATECUR      
DEALLOCATE @DATECUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLIENTNAME
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.CLIENTNAME    SCRIPT DATE: 09/10/2001 6:27:17 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.CLIENTNAME    SCRIPT DATE: 09/07/2001 10:36:00 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.CLIENTNAME    SCRIPT DATE: 9/7/01 5:07:17 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.CLIENTNAME    SCRIPT DATE: 9/7/2001 4:09:58 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.CLIENTNAME    SCRIPT DATE: 08/10/2001 4:53:36 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.CLIENTNAME    SCRIPT DATE: 08/10/01 4:45:24 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.CLIENTNAME    SCRIPT DATE: 7/25/01 10:05:55 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.CLIENTNAME    SCRIPT DATE: 7/1/01 2:26:21 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.CLIENTNAME    SCRIPT DATE: 06/26/2001 8:47:46 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.CLIENTNAME    SCRIPT DATE: 3/17/01 9:55:48 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.CLIENTNAME    SCRIPT DATE: 3/21/01 12:50:04 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.CLIENTNAME    SCRIPT DATE: 20-MAR-01 11:38:47 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.CLIENTNAME    SCRIPT DATE: 2/5/01 12:06:10 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.CLIENTNAME    SCRIPT DATE: 12/27/00 8:58:47 PM ******/
CREATE PROCEDURE [dbo].[CLIENTNAME]
@PARTYCODE VARCHAR(10)
 AS
SELECT C1.SHORT_NAME, ISNULL(C2.BANKID,''), ISNULL(C2.CLTDPNO,'') FROM CLIENT1 C1, CLIENT2 C2  WHERE  C2.PARTY_CODE=@PARTYCODE
AND C1.CL_CODE=C2.CL_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_AUTOPROCESS_STATUS
-- --------------------------------------------------


      
CREATE PROC [dbo].[CLS_AUTOPROCESS_STATUS]            
(            
 @STATUSID VARCHAR(50),            
 @STATUSNAME VARCHAR(50),            
 @FROMDATE VARCHAR(11),            
 @TODATE  VARCHAR(11),            
 @FROMPARTY VARCHAR(10),            
 @TOPARTY VARCHAR(10),            
 @FROMSCRIP VARCHAR(12)='',            
 @TOSCRIP VARCHAR(12)='',            
 @OPT VARCHAR(20)=''          
)           
        
as        
-- EXEC CLS_AUTOPROCESS_STATUS 'BROKER', 'BROKER', 'JAN  6 2015', 'JAN  6 2015', '', '', '', '', ''        
OPEN SYMMETRIC KEY   Key4CertAutoProcess        
     DECRYPTION BY   CERTIFICATE CertAutoProcess         
        
SELECT SNO, PROCESS_DATE=CONVERT(VARCHAR,PROCESS_DATE,103),        
BUSINESS_DATE=CONVERT(VARCHAR,BUSINESS_DATE,103),EXCHANGE,SEGMENT,PROCESS_FOR,        
SETT_NO,SETT_TYPE,        
PROCESS_START_DATE=CONVERT(VARCHAR,PROCESS_START_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_START_DATE,108),        
PROCESS_STARTED_DATE=CONVERT(VARCHAR,PROCESS_STARTED_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_STARTED_DATE,108),        
PROCESS_END_DATE=CONVERT(VARCHAR,PROCESS_END_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_END_DATE,108),        
PROCESS_ENDED_DATE=CONVERT(VARCHAR,PROCESS_ENDED_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_ENDED_DATE,108),        
PROCESS_FILE_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),        
PROCESS_STATUS=(CASE WHEN PROCESS_STATUS = 100 THEN 'COMPLETTED'        
      WHEN PROCESS_STATUS = 0 THEN 'NOT YET STARTED'         
         WHEN PROCESS_STATUS = 99 THEN 'IN - PROCESS'        
      ELSE 'HALTED DUE TO SOME ERROR'        
    END),REMARK = PROCESS_HALTED_REASON,   PROCESS_ORDER_ID      
FROM TBL_AUTO_PROCESS_detail d (Nolock), owner        
WHERE BUSINESS_DATE >= @FROMDATE        
AND BUSINESS_DATE <= @TODATE      
and 1 = (case when @OPT = '' then 1      
     when @opt = 'A' then 1      
     When @opt = 'P' and PROCESS_STATUS < 99 then 1      
     When @opt = 'C' and PROCESS_STATUS = 100 then 1        
     When @opt = 'I' and PROCESS_STATUS = 99 then 1      
   ELSE 2 END)      
ORDER BY PROCESS_ORDER_ID        
CLOSE SYMMETRIC KEY   Key4CertAutoProcess;

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLIENTLIST_REPORT
-- --------------------------------------------------

-- EXEC CLS_CLIENTLIST_REPORT '30/07/2014','30/07/2014','','','','','ALL','PARTYCODE','BRANCH','STAFF'

CREATE PROCEDURE  [DBO].[CLS_CLIENTLIST_REPORT]
 (
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@FROMPARTY VARCHAR(10),
	@TOPARTY VARCHAR(10),
	@CLTYPE VARCHAR(10) ='',
	@CLTSTATUS VARCHAR(10)='',
	@FILTERCD VARCHAR(10) ='ALL',
	@ORDER_BY AS VARCHAR(16)='PARTYCODE',
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25)
 )
 
 AS
 
 
 /*
	@FILTERCD
	A 		 - 	 ACTIVE
	IN 		 - 	 INACTIVE
	ACT 	 - 	 ACTIVATED
	DACT 	 - 	 DEACTIVATED
	MAIL 	 - 	 NOT HAVING MAIL ID
	PAN 	 - 	 NOT HAVING PAN NO
	TELR 	 - 	 NOT HAVING TELEPHONE (R)
	TELO 	 - 	 NOT HAVING TELEPHONE (O)
	MOBILE 	 - 	 NOT HAVING MOBILE
	FAX 	 - 	 NOT HAVING FAX
	ADD1 	 - 	 NOT HAVING ADDRESS1
	ADD2 	 - 	 NOT HAVING ADDRESS2
	ADD3 	 - 	 NOT HAVING ADDRESS3
	CITY 	 - 	 NOT HAVING CITY
	STATE 	 - 	 NOT HAVING STATE
	ZIP 	 - 	 NOT HAVING ZIP
	
	
	@ORDER_BY
	BRANCH		-	BRANCH
	PARTYCODE	-	PARTY CODE
	CLIENT		-	CLIENT NAME
	ACTIVE		-	ACTIVE
	INACTIVE	-	INACTIVE

*/

SET @FROMDATE = LEFT(CONVERT(DATETIME,@FROMDATE,103),11)
SET @TODATE = LEFT(CONVERT(DATETIME,@TODATE,103),11)

IF @TOPARTY =''
SET @TOPARTY = 'ZZZZZZZ'

SELECT            
    C1.CL_CODE,         
    C1.SHORT_NAME,         
    C1.LONG_NAME,         
    ISNULL(C1.BRANCH_CD,'-') AS BRANCH_CD,         
    ISNULL(C1.PAN_GIR_NO,'-') AS PAN_GIR_NO,
    ISNULL(CONVERT(VARCHAR(11),ACTIVEFROM),'-') AS ACTIVEFROM,         
    ISNULL(CONVERT(VARCHAR(11),INACTIVEFROM),'-') AS INACTIVEFROM,
	ORDERBY = (          
    CASE           
        WHEN @ORDER_BY = 'BRANCH'           
        THEN C1.BRANCH_CD+C2.PARTY_CODE           
        ELSE       
        CASE
            WHEN @ORDER_BY = 'PARTYCODE'           
            THEN C2.PARTY_CODE           
            ELSE           
            CASE           
                WHEN @ORDER_BY = 'CLIENT'           
                THEN C1.SHORT_NAME+C2.PARTY_CODE           
                ELSE           
                CASE           
                    WHEN @ORDER_BY = 'ACTIVE'           
                    THEN CONVERT(VARCHAR(11),ACTIVEFROM)+C2.PARTY_CODE           
                    ELSE           
                    CASE           
                        WHEN @ORDER_BY = 'INACTIVE'           
                        THEN CONVERT(VARCHAR(11),INACTIVEFROM)+C2.PARTY_CODE        
                    END           
                END           
            END           
        END           
    END           
    )        
FROM CLIENT1 C1 (NOLOCK),    
CLIENT5 CL5 (NOLOCK), 
CLIENT2 C2 (NOLOCK)  
WHERE  1 = (CASE WHEN @FILTERCD='' THEN CASE WHEN CL5.ACTIVEFROM BETWEEN  @FROMDATE AND @TODATE + ' 23:59:59'  THEN 1 ELSE 2 END ELSE   
	   CASE WHEN @FILTERCD = 'MAIL' THEN (CASE WHEN C1.EMAIL = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'PAN' THEN (CASE WHEN C1.PAN_GIR_NO = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'TELR' THEN (CASE WHEN C1.RES_PHONE1 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'TELO' THEN (CASE WHEN C1.OFF_PHONE1 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'MOBILE' THEN (CASE WHEN C1.MOBILE_PAGER = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'FAX' THEN (CASE WHEN C1.FAX = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'ADD1' THEN (CASE WHEN C1.L_ADDRESS1 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'ADD2' THEN (CASE WHEN C1.L_ADDRESS2 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'ADD3' THEN (CASE WHEN C1.L_ADDRESS3 = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'CITY' THEN (CASE WHEN C1.L_CITY = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'STATE' THEN (CASE WHEN C1.L_STATE = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'ZIP' THEN (CASE WHEN C1.L_ZIP = '' THEN 1 ELSE 2 END)    
	   WHEN @FILTERCD = 'A' THEN (CASE WHEN GETDATE() BETWEEN ACTIVEFROM AND INACTIVEFROM THEN 1 ELSE 2 END)
	   WHEN @FILTERCD = 'IN' THEN (CASE WHEN INACTIVEFROM < GETDATE()  THEN 1 ELSE 2 END) 
	   WHEN @FILTERCD = 'ACT' THEN (CASE WHEN CL5.ACTIVEFROM BETWEEN @FROMDATE AND @TODATE + ' 23:59' THEN 1 ELSE 2 END) 
	   WHEN @FILTERCD = 'DACT' THEN (CASE WHEN CL5.INACTIVEFROM BETWEEN @FROMDATE AND @TODATE + ' 23:59'  THEN 1 ELSE 2 END) 
     ELSE 1
    END
    END )      
	AND	
C1.CL_CODE = CL5.CL_CODE
AND C1.CL_CODE = C2.CL_CODE        
AND C2.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	AND CL5.SYSTUMDATE BETWEEN  @FROMDATE AND @TODATE + ' 23:59:59'
	AND CL_TYPE  = CASE WHEN @CLTYPE = '' THEN CL_TYPE ELSE @CLTYPE END
	AND CL_STATUS  = CASE WHEN @CLTSTATUS = '' THEN CL_STATUS ELSE @CLTSTATUS END
	AND @STATUSNAME = (CASE WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
		WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
		WHEN @STATUSID = 'TRADER' THEN C1.TRADER
		WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
		WHEN @STATUSID = 'AREA' THEN C1.AREA
		WHEN @STATUSID = 'REGION' THEN C1.REGION
		WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
	ELSE 'BROKER' END)
ORDER BY 8

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_CLOSING_RATE
-- --------------------------------------------------

  
CREATE PROC [DBO].[CLS_CLOSING_RATE]  
 (  
	@FRMDATE VARCHAR(10),  
	@TODATE  VARCHAR(10),
	@SCRIPCD VARCHAR(20),
	@INST_TYPE VARCHAR(3)
 )  
   
 AS  
  
 --EXEC CLS_CLOSING_RATE '01/05/2000','31/12/2014' ,'' ,'' 
   
 DECLARE @R_FRMDATE VARCHAR(11),  
   @R_TODATE VARCHAR(11)  
   
 SELECT @R_FRMDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FRMDATE,103),109)  
 SELECT @R_TODATE = CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE,103),109)  
   
 SELECT  
	TRADE_DATE=CONVERT(VARCHAR(11),TRADE_DATE,103),
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE = CONVERT(VARCHAR(11),EXPIRYDATE,103),
	STRIKE_PRICE,
	OPTION_TYPE,
	CL_RATE
 FROM  
  FOCLOSING (NOLOCK)  
 WHERE  
  TRADE_DATE BETWEEN @R_FRMDATE AND @R_TODATE + ' 23:59:59' 
  AND SYMBOL = (CASE WHEN @SCRIPCD = '' THEN SYMBOL ELSE @SCRIPCD END)
  AND LEFT(INST_TYPE,3) = (CASE WHEN @INST_TYPE = '' THEN LEFT(INST_TYPE,3) ELSE @INST_TYPE END)
 ORDER BY  1,2,3

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_DAS_HEADER
-- --------------------------------------------------
  
CREATE PROC [DBO].[CLS_DAS_HEADER]  
 (  
  @FROMDATE VARCHAR(11)  
 )  
   
 AS  
   
 /*  
 DECLARE @FROMDATE VARCHAR(11)  
 SET  @FROMDATE = '12/09/2014'  
 EXEC CLS_COMMON_CONTRACT_HEADER '17/03/2009'   
 */  
  
 CREATE TABLE #COMPANY_INFO  
  (  
  COMPANY   VARCHAR(100),   
  COMPANY_ADDR1 VARCHAR(100),   
  COMPANY_ADDR2 VARCHAR(100),   
  COMPANY_CITY VARCHAR(50),   
  COMPANY_ZIP  VARCHAR(10),   
  COMPANY_PHONE VARCHAR(50),   
  COMPANY_FAX  VARCHAR(50),  
  EXCHANGECODE VARCHAR(3),   
  TM_CODE   VARCHAR(20),  
  BROKERSEBIREGNO VARCHAR(20),  
  COMPANY_PANNO VARCHAR(50),   
  COMPANY_EMAIL VARCHAR(100),  
  COMPLIANCE_NAME VARCHAR(100),  
  COMPLIANCE_EMAIL VARCHAR(100),  
  COMPLIANCE_PHONE VARCHAR(50),  
  COMPLIANCE_MOBILE VARCHAR(50),  
  SERVICES_TAXNO  VARCHAR(50),  
  WEBSITE_ID   VARCHAR(100),  
  LOGO_FILE_PATH  VARCHAR(100),  
  COMPANY_CIN   VARCHAR(30) 
  /*COMMONSEBINO  VARCHAR(200),  
  COMMONMEMBERCODE VARCHAR(200),  
  IGRIV_EMAIL   VARCHAR(200),   
  CORP_ADDR1   VARCHAR(100),  
  CORP_ADDR2   VARCHAR(100),  
  CORP_ADDR3   VARCHAR(100),  
  CORP_PHONE   VARCHAR(50),  
  CORP_ZIP   VARCHAR(10),  
  CORP_CITY   VARCHAR(50),  
  CORP_STATE   VARCHAR(50),  
  CORP_COUNTRY  VARCHAR(50),  
  AUTHORISEDSIGNETORY1 VARCHAR(150),  
  AUTHORISEDSIGNETORY2 VARCHAR(150),  
  AUTHORISEDSIGNETORY3 VARCHAR(150),  
  AUTHORISEDSIGNETORY4 VARCHAR(150),  
  AUTHORISEDSIGNETORY5 VARCHAR(150),  
  AUTHORISEDSIGNETORY6 VARCHAR(150),  
  AUTHORISEDSIGNETORY7 VARCHAR(150),  
  CONTRACT_TYPE  INT,   
  FNO_CONTRACT_BILL INT,  
  PRINT_SUB_TOT  INT,  
  PRINT_NET_TOT  INT,  
  PRINT_DEALING  VARCHAR(10),  
  PRINT_STT_COLUMN INT,  
  SERTAXPER   NUMERIC(18,2),  
  CONTRACTDATE  VARCHAR(11),  
  CESS_TAX   NUMERIC(18,2),  
  EDUCESSTAX   NUMERIC(18,2) */   
  )  
   
 INSERT INTO #COMPANY_INFO    
 SELECT   
  COMPANY,   
  ADDR1,   
  ADDR2,   
  CITY,   
  ZIP,   
  PHONE,   
  FAX,   
  EXCHANGECODE='',   
  TM_CODE='',   
  BROKERSEBIREGNO,   
  PANNO,   
  EMAIL,   
  COMPLIANCE_NAME = ISNULL(COMPLIANCE_NAME,''),  
  COMPLIANCE_EMAIL = ISNULL(COMPLIANCE_EMAIL,''),  
  COMPLIANCE_PHONE = ISNULL(COMPLIANCE_PHONE,''),  
  COMPLIANCE_MOBILE = ISNULL(COMPLIANCE_MOBILE,''),  
  SERVICES_TAXNO = ISNULL(SERVICES_TAXNO,''),  
  WEBSITE_ID = ISNULL(WEBSITE_ID,''),  
  LOGO_FILE_PATH = '',  
  CIN = ISNULL(CIN,'')  
  
  /*COMMONSEBINO = ISNULL(COMMONSEBINO,''),  
  COMMONMEMBERCODE = ISNULL(COMMONMEMBERCODE,''),  
  
  IGRIV_EMAIL = ISNULL(IGRIV_EMAIL,''),   
  CORP_ADDR1 = ISNULL(CORP_ADDR1,''),  
  CORP_ADDR2 = ISNULL(CORP_ADDR2,''),  
  CORP_ADDR3 = ISNULL(CORP_ADDR3,''),  
  CORP_PHONE = ISNULL(CORP_PHONE,''),  
  CORP_ZIP = ISNULL(CORP_ZIP,''),  
  CORP_CITY = ISNULL(CORP_CITY,''),  
  CORP_STATE = ISNULL(CORP_STATE,''),  
  CORP_COUNTRY = ISNULL(CORP_COUNTRY,''),  
  AUTHORISEDSIGNETORY1 = '',  
  AUTHORISEDSIGNETORY2 = '',  
  AUTHORISEDSIGNETORY3 = '',  
  AUTHORISEDSIGNETORY4 = '',  
  AUTHORISEDSIGNETORY5 = '',  
  AUTHORISEDSIGNETORY6 = '',  
  AUTHORISEDSIGNETORY7 = '',  
  CONTRACT_TYPE  = '',  
  FNO_CONTRACT_BILL = '',  
  PRINT_SUB_TOT  = '',  
  PRINT_NET_TOT  = '',  
  PRINT_DEALING  = '',  
  PRINT_STT_COLUMN = 0,  
  SERTAXPER   = 0,  
  CONTRACTDATE  = '',  
  CESS_TAX   = 0,  
  EDUCESSTAX   = 0 */ 
      
 FROM   
  OWNER (NOLOCK)  
  
  
 /*UPDATE #COMPANY_INFO  
 SET  AUTHORISEDSIGNETORY1 = ISNULL(A.AUTHORISEDSIGNETORY1,''),  
   AUTHORISEDSIGNETORY2 = ISNULL(A.AUTHORISEDSIGNETORY2,''),  
   AUTHORISEDSIGNETORY3 = ISNULL(A.AUTHORISEDSIGNETORY3,''),  
   AUTHORISEDSIGNETORY4 = ISNULL(A.AUTHORISEDSIGNETORY4,''),  
   AUTHORISEDSIGNETORY5 = ISNULL(A.AUTHORISEDSIGNETORY5,''),  
   AUTHORISEDSIGNETORY6 = ISNULL(A.AUTHORISEDSIGNETORY6,''),  
   AUTHORISEDSIGNETORY7 = ISNULL(A.AUTHORISEDSIGNETORY7,'')  
 FROM AUTHORISEDSIGNETORIES A (NOLOCK)  
   
   
 UPDATE #COMPANY_INFO  
 SET  CONTRACT_TYPE  = ISNULL(T.CONTRACT_TYPE,0),  
   FNO_CONTRACT_BILL = ISNULL(T.FNO_CONTRACT_BILL,0),  
   PRINT_SUB_TOT  = ISNULL(T.PRINT_SUB_TOT,0),  
   PRINT_NET_TOT  = ISNULL(T.PRINT_NET_TOT,0),  
   PRINT_DEALING  = ISNULL(T.PRINT_DEALING,''),  
   PRINT_STT_COLUMN = ISNULL(T.PRINT_STT_COLUMN,'')  
 FROM TBL_COMMONCONTRACT_MASTER T (NOLOCK)   
 WHERE GETDATE() BETWEEN EFFECTIVE_FROM AND EFFECTIVE_TO   
  
  
 UPDATE #COMPANY_INFO  
 SET  SERTAXPER  = SERVICE_TAX,  
   CONTRACTDATE = CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE,103),112),  
   CESS_TAX  = ISNULL(G.CESS_TAX,0),  
   EDUCESSTAX  = ISNULL(G.EDUCESSTAX,0)  
 FROM GLOBALS G (NOLOCK)  
 WHERE @FROMDATE BETWEEN YEAR_START_DT AND YEAR_END_DT*/  
   
   
 SELECT * FROM #COMPANY_INFO  
   
 DROP TABLE #COMPANY_INFO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_BILLDETAIL_RPT
-- --------------------------------------------------

/*
EXEC CLS_FO_BILLDETAIL_RPT '17 AUG 2004', '17 AUG 2014','','','BROKER','BROKER','SUMMARY'
EXEC CLS_FO_BILLDETAIL_RPT '14/11/2014', '14/11/2014','AKB2','AKB2','BROKER','BROKER','DETAIL'

*/

CREATE PROC [DBO].[CLS_FO_BILLDETAIL_RPT]
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@FROMPARTY VARCHAR(20),
	@TOPARTY VARCHAR (20), 
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@REPORTTYPE VARCHAR(10) = 'SUMMARY'
)

AS

/*
	@REPORTTYPE  : SUMMARY /DETAIL
*/


SET @DATEFROM = LEFT(CONVERT(DATETIME,@DATEFROM,103),11)
SET @DATETO = LEFT(CONVERT(DATETIME,@DATETO,103),11)


IF @TOPARTY =''
SET @TOPARTY ='ZZZZZZZ'

IF @REPORTTYPE = 'SUMMARY'
BEGIN
	SELECT
		CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDA_DATE,
		CLIENT_CODE=F.PARTY_CODE, 
		LEFT(C1.LONG_NAME, 25) AS CLIENT_NAME,
		

		CONVERT(NUMERIC(18,2), SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			(F.PBILLAMT - F.SBILLAMT)
		ELSE
			(F.PBILLAMT+F.SBILLAMT)
		END))
		 AS NET_DRCR, 
		CONVERT(NUMERIC(18,2), SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) 
			+ (F.OTHER_CHRG) + (F.PBROKAMT+F.SBROKAMT)) )) AS CHRG_TOTAL,
			
		CONVERT(NUMERIC(18,2), SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) 
			+  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - ((F.SBILLAMT)  )
		ELSE
			((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) 
			+  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) + ((F.SBILLAMT)  )
		END))
		 AS NETBILLAMT
	FROM
		FOBILLVALAN F (NOLOCK), 
		CLIENT1 C1 (NOLOCK), 
		CLIENT2 C2 (NOLOCK),
		FOOWNER (NOLOCK)
	WHERE
		C1.CL_CODE = C2.CL_CODE AND
		C2.PARTY_CODE = F.PARTY_CODE AND
		F.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY AND
		F.SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59' AND	
		F.TRADETYPE = CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN 'BT' ELSE F.TRADETYPE  END AND	
		@STATUSNAME = (CASE 	
					WHEN @STATUSID = 'BRANCH' THEN F.BRANCH_CODE
					WHEN @STATUSID = 'SUBBROKER' THEN F.SUB_BROKER
					WHEN @STATUSID = 'TRADER' THEN F.TRADER
					WHEN @STATUSID = 'FAMILY' THEN F.FAMILY
					WHEN @STATUSID = 'AREA' THEN F.AREA
					WHEN @STATUSID = 'REGION' THEN F.REGION
					WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE
					WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
				END)
	GROUP BY 
		F.SAUDA_DATE,
		F.PARTY_CODE, 
		C1.LONG_NAME

	ORDER BY 
		F.SAUDA_DATE,
		F.PARTY_CODE
		
END
ELSE			-- DETAIL REPORT
BEGIN
	SELECT
		CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDA_DATE,
		CLIENT_CODE=F.PARTY_CODE, 
		LEFT(C1.LONG_NAME, 25) AS CLIENT_NAME,
		
		F.INST_TYPE, 
		F.SYMBOL,
		CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,
		F.STRIKE_PRICE, 
		CASE WHEN F.OPTION_TYPE = '' THEN '' ELSE F.OPTION_TYPE END AS OPTION_TYPE,
		CL_RATE AS CLOSINGRATE,	

		CONVERT(NUMERIC(18,2), CASE WHEN TRADETYPE = 'BF' 
			 THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) 
				   THEN CASE WHEN SUM(PQTY) > 0 
						 THEN SUM(PAMT)/SUM(PQTY) 
						 ELSE 0 
					END 
				   ELSE 0 
			  END 
			 ELSE CASE WHEN SUM(PQTY) > 0 
				   THEN SUM(PRATE*PQTY)/SUM(PQTY) 
				   ELSE 0 
			  END 
		END) AS PRATE,
		CONVERT(NUMERIC(18,2), CASE WHEN TRADETYPE = 'BF' 
			 THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) 
					   THEN CASE WHEN SUM(SQTY) > 0 
					 THEN SUM(SAMT)/SUM(SQTY) 
					 ELSE 0 
					END 
				   ELSE 0 
			  END 
			 ELSE CASE WHEN SUM(SQTY) > 0 
				   THEN SUM(SRATE*SQTY)/SUM(SQTY)
				   ELSE 0
			  END 
		END) AS SRATE,

		CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN SUM(F.PQTY) - SUM(F.SQTY) ELSE 0 END ELSE SUM(F.PQTY) END AS PQTY,
		CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN SUM(F.SQTY) - SUM(F.PQTY) ELSE 0 END ELSE SUM(F.SQTY) END AS SQTY,
		
		CONVERT(NUMERIC(18,2), CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END 
		ELSE
			SUM(F.PBILLAMT+F.SBILLAMT)
		END)
		AS PBILLAMT,
		
		CONVERT(NUMERIC(18,2), CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END 
		ELSE
			0
		END)
		AS SBILLAMT,
		
		CONVERT(NUMERIC(18,2), CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			SUM((F.PBILLAMT)) - SUM((F.SBILLAMT))
		ELSE
			SUM(F.PBILLAMT+F.SBILLAMT)
		END)
		 AS NET_DRCR,
		
		CONVERT(NUMERIC(18,4), SUM(F.SERVICE_TAX - F.EXSER_TAX))AS 'SERVICE_TAX',
		CONVERT(NUMERIC(18,4), SUM(F.SEBI_TAX)) AS 'SEBI_TAX',
		CONVERT(NUMERIC(18,4), SUM(F.TURN_TAX)) AS 'TURNOVER_TAX',
		CONVERT(NUMERIC(18,4), SUM(F.BROKER_NOTE)) AS 'STAMP_DUTY',
		CONVERT(NUMERIC(18,4), SUM(F.INS_CHRG)) AS 'STT_CHARGES',
		CONVERT(NUMERIC(18,4), SUM(F.OTHER_CHRG)) AS  'OTHER_CHARGES',
		CONVERT(NUMERIC(18,4), SUM(F.PBROKAMT+F.SBROKAMT)) AS 'BROKERAGE',
		
		CONVERT(NUMERIC(18,4), SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) 
			+ (F.OTHER_CHRG) + (F.PBROKAMT+F.SBROKAMT)) )) AS CHRG_TOTAL,
			
		CONVERT(NUMERIC(18,4), CASE WHEN PARTICIPANTCODE = MEMBERCODE THEN
			SUM((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) 
			+  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  )
		ELSE
			SUM((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) 
			+  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) + SUM((F.SBILLAMT)  )
		END)
		 AS NETBILLAMT,

		C1.L_ADDRESS1, 
		C1.L_ADDRESS2,
		C1.L_ADDRESS3,
		C1.L_CITY,
		C1.L_STATE,
		C1.L_NATION,
		C1.L_ZIP,
		C1.RES_PHONE1,
		C1.EMAIL 
		 
		 
	FROM
		FOBILLVALAN F (NOLOCK), 
		CLIENT1 C1 (NOLOCK), 
		CLIENT2 C2 (NOLOCK),
		FOOWNER (NOLOCK)
	WHERE
		C1.CL_CODE = C2.CL_CODE AND
		C2.PARTY_CODE = F.PARTY_CODE AND
		F.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY AND
		F.SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59' AND	
		F.TRADETYPE = CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN 'BT' ELSE F.TRADETYPE  END AND	
		@STATUSNAME = (CASE 	
					WHEN @STATUSID = 'BRANCH' THEN F.BRANCH_CODE
					WHEN @STATUSID = 'SUBBROKER' THEN F.SUB_BROKER
					WHEN @STATUSID = 'TRADER' THEN F.TRADER
					WHEN @STATUSID = 'FAMILY' THEN F.FAMILY
					WHEN @STATUSID = 'AREA' THEN F.AREA
					WHEN @STATUSID = 'REGION' THEN F.REGION
					WHEN @STATUSID = 'CLIENT' THEN F.PARTY_CODE
					WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
				END)
	GROUP BY 
		F.SAUDA_DATE,
		F.PARTY_CODE, 
		C1.LONG_NAME,  
		F.SYMBOL, 
		F.INST_TYPE, 
		F.EXPIRYDATE, 
		F.STRIKE_PRICE, 
		F.OPTION_TYPE,
		F.TRADETYPE, 
		CL_RATE,
		AUCTIONPART,
		PARTICIPANTCODE,
		MEMBERCODE,		
		C1.L_ADDRESS1, 
		C1.L_ADDRESS2,
		C1.L_ADDRESS3,
		C1.L_CITY,
		C1.L_STATE,
		C1.L_NATION,
		C1.L_ZIP,
		C1.RES_PHONE1,
		C1.EMAIL 		

	HAVING CASE WHEN TRADETYPE = 'BF' THEN SUM(SQTY-PQTY) ELSE 1 END <> 0 

	ORDER BY 
		F.SAUDA_DATE,
		F.PARTY_CODE, 
		C1.LONG_NAME, 
		F.SYMBOL, 
		F.INST_TYPE, 
		F.EXPIRYDATE, 
		F.STRIKE_PRICE, 
		F.OPTION_TYPE, 
		F.TRADETYPE
END

/*---------------------------------------------------------- END OF THE PROC -------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_COLLATERAL_DETAILS_DAS_GET
-- --------------------------------------------------


CREATE PROC [DBO].[CLS_FO_COLLATERAL_DETAILS_DAS_GET]
	(
 	@SDATE VARCHAR(11),
	@PARTYCODE VARCHAR(20),
	@TOCODE VARCHAR(20) = '',
	@DISPLAY VARCHAR(1) = ''
	)

	AS
	
	IF LEN(@SDATE) = 10 AND CHARINDEX('/',@SDATE) > 0    
	SET @SDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SDATE,103),109)  
	
	IF @TOCODE = ''
		BEGIN
			SET @TOCODE = @PARTYCODE
		END
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	IF @DISPLAY <> ''
		BEGIN
			SELECT 
				PARTY_CODE=PARENTCODE,
				EXCHANGE = 'NSE',
				SEGMENT = 'FUTURES',
				QTY=SUM(QTY),
				FINALAMOUNT=SUM(FINALAMOUNT)
			FROM
				MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK),
				CLIENT2_VIEW (NOLOCK)
			WHERE
				CL_CODE = C.PARTY_CODE
				AND C.EXCHANGE = 'NSE'
				AND C.SEGMENT = 'FUTURES'
				AND EFFDATE LIKE @SDATE + '%'
				AND PARENTCODE BETWEEN @PARTYCODE AND @TOCODE
			GROUP BY 
				PARENTCODE
			ORDER BY
				PARENTCODE
		END
	ELSE
		BEGIN
			SELECT 
				PARTY_CODE=PARENTCODE,
				EXCHANGE = 'NSE',
				SEGMENT = 'FUTURES',
				SCRIP_CD =(
				CASE 
					WHEN COLL_TYPE IN ('FD','BG') 
						THEN COLL_TYPE +'-'+ FD_BG_NO
					WHEN COLL_TYPE = 'SEC'
						THEN SCRIP_CD
					ELSE COLL_TYPE
				END),
				EXPIRYDATE = (
				CASE WHEN COLL_TYPE IN ('FD','BG') 
					THEN CONVERT(VARCHAR,MATURITY_DATE,11)
					ELSE ''
				END),	
				QTY=SUM(QTY),
				CL_RATE,
				VAKUATIONPER = MAX(100 - HAIRCUT),
				FINALAMOUNT=SUM(FINALAMOUNT),
				CASH_NCASH,
				SERIES = ISNULL(SERIES,'')
			INTO
				#COLLDETAILS
			FROM
				MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK),
				CLIENT2_VIEW (NOLOCK)
			WHERE
				CL_CODE = C.PARTY_CODE
				AND C.EXCHANGE = 'NSE'
				AND C.SEGMENT = 'FUTURES'
				AND EFFDATE LIKE @SDATE + '%'
				AND PARENTCODE BETWEEN @PARTYCODE AND @TOCODE
			GROUP BY 
				PARENTCODE,SCRIP_CD,CL_RATE,CASH_NCASH,ISNULL(SERIES,''),
				(
				CASE WHEN COLL_TYPE IN ('FD','BG') 
					THEN CONVERT(VARCHAR,MATURITY_DATE,11)
					ELSE ''
				END),
				(
				CASE 
					WHEN COLL_TYPE IN ('FD','BG') 
						THEN COLL_TYPE +'-'+ FD_BG_NO
					WHEN COLL_TYPE = 'SEC'
						THEN SCRIP_CD
					ELSE COLL_TYPE
				END)				
			ORDER BY
				CASH_NCASH,
				PARTY_CODE,
				SCRIP_CD


			UPDATE 
				#COLLDETAILS
				SET SCRIP_CD = S2.SCRIP_CD
			FROM 
				BSEDB.DBO.SCRIP2 S2,
				BSEDB.DBO.SCRIP2 S1
			WHERE 
				S1.CO_CODE = S2.CO_CODE
				AND S1.SERIES = S2.SERIES
				AND #COLLDETAILS.SCRIP_CD = S2.BSECODE
				AND #COLLDETAILS.SERIES = 'BSE'
				

			SELECT *
			FROM #COLLDETAILS C
			ORDER BY PARTY_CODE,CASH_NCASH, SCRIP_CD
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_LEDGER_DETAILS_DAS_UP
-- --------------------------------------------------

/****** OBJECT:  STORED PROCEDURE DBO.PR_FO_LEDGER_DETAILS_DAS_UP    SCRIPT DATE: 4/28/2009 4:16:42 PM ******/


CREATE  PROCEDURE [DBO].[CLS_FO_LEDGER_DETAILS_DAS_UP]                 
(                
    @SDATE VARCHAR(11),                 
    @PARTYCODE VARCHAR(20),
	@TOCODE VARCHAR(20) = '',
	@DISPLAY VARCHAR(1) = ''
)
       
        
AS

IF LEN(@SDATE) = 10 AND CHARINDEX('/',@SDATE) > 0    
	SET @SDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SDATE,103),109)                  

IF @TOCODE = ''
	BEGIN
		SET @TOCODE = @PARTYCODE
	END
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF @DISPLAY <> ''
	BEGIN
		SELECT
			LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,
			LEDDD_CLOSING_BAL = SUM(LEDDD_CLOSING_BAL),
			MARGINAMT = SUM((LEDDD_CASH_MARGIN + LEDDD_NONCASH_COLL_HC) - (LEDDD_INIT_EXPO_MARGIN + LEDDD_ADD_MARGIN))
		FROM
			LEDGER_DETAILS_DAS (NOLOCK)
		WHERE
			LEDDD_SAUDA_DATE LIKE @SDATE +'%'
			AND LEDDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
		GROUP BY
			LEDDD_PARTY_CODE
	END
ELSE
	BEGIN
		SELECT
			LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,
			LEDDD_SAUDA_DATE = @SDATE,
			LEDDD_OPENING_BAL = SUM(LEDDD_OPENING_BAL),
			LEDDD_CHQ_REC = SUM(LEDDD_CHQ_REC),
			LEDDD_CHQ_PAY = SUM(LEDDD_CHQ_PAY),
			LEDDD_JV_ENTRY = SUM(LEDDD_JV_ENTRY),
			LEDDD_CLOSING_BAL = SUM(LEDDD_CLOSING_BAL),
			LEDDD_CASH_MARGIN = SUM(LEDDD_CASH_MARGIN),
			LEDDD_OPENING_INIT_MARGIN = SUM(LEDDD_OPENING_INIT_MARGIN),
			LEDDD_MRG_REC = SUM(LEDDD_MRG_REC),
			LEDDD_MRG_REPAY = SUM(LEDDD_MRG_REPAY),
			LEDDD_MRG_JV_ENTRY = SUM(LEDDD_MRG_JV_ENTRY),
			LEDDD_CLOSING_INIT_MARGIN = SUM(LEDDD_CLOSING_INIT_MARGIN),
			LEDDD_NONCASH_COLL_HC = SUM(LEDDD_NONCASH_COLL_HC),
			LEDDD_INIT_EXPO_MARGIN = SUM(LEDDD_INIT_EXPO_MARGIN),
			LEDDD_CREATED_BY = 'BACK-END',
			LEDDD_CREATED_DT = GETDATE(),
			LEDDD_ADD_MARGIN = SUM(LEDDD_ADD_MARGIN),
			LEDDD_FT_D = SUM(LEDDD_FT_D),
			LEDDD_FT_C = SUM(LEDDD_FT_C),
			LEDDD_MRG_FT = SUM(LEDDD_MRG_FT),
			LEDDD_RUNNINGBAL = SUM(LEDDD_RUNNINGBAL),
			LEDDD_CASH_COLL_HC = SUM(LEDDD_CASH_COLL_HC)
		FROM
			LEDGER_DETAILS_DAS (NOLOCK)
		WHERE
			LEDDD_SAUDA_DATE LIKE @SDATE +'%'
			AND LEDDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
		GROUP BY
			LEDDD_PARTY_CODE
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_OPEN_POSITION_DAS_GET
-- --------------------------------------------------

CREATE  PROCEDURE [DBO].[CLS_FO_OPEN_POSITION_DAS_GET]
(            
    @SDATE VARCHAR(11),             
    @PARTYCODE VARCHAR(20),
	@TOCODE VARCHAR(20) = '',
	@DISPLAY VARCHAR(1) = '',
	@BLOCK VARCHAR(2) = ''
)            
            
AS  


IF LEN(@SDATE) = 10 AND CHARINDEX('/',@SDATE) > 0    
SET @SDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SDATE,103),109)            

IF @TOCODE = ''
	BEGIN
		SET @TOCODE = @PARTYCODE
	END
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
  
IF @DISPLAY <> ''
	BEGIN
		SELECT             
			FOPDD_PARTY_CODE,
			FOPDD_CLOSING_PQTY = SUM(FOPDD_CLOSING_PQTY),
			FOPDD_CLOSING_SQTY = SUM(FOPDD_CLOSING_SQTY),
			FOPDD_INST_TYPE
		FROM             
			FO_POS_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOPDD_SAUDA_DATE LIKE @SDATE +'%'             
			AND FOPDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			--AND (CHARINDEX(LEFT(FOPDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
			AND (@BLOCK=CASE WHEN CHARINDEX(LEFT(FOPDD_INST_TYPE,3),'FUT')>0 THEN '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+4) ELSE '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+3) END OR @BLOCK='')
		GROUP BY
			FOPDD_PARTY_CODE,
			FOPDD_INST_TYPE
		ORDER BY             
			FOPDD_PARTY_CODE,
			FOPDD_INST_TYPE
	END
ELSE
	BEGIN
		PRINT @BLOCK
		SELECT             
			FOPDD_PARTY_CODE,             
			FOPDD_INST_TYPE,             
			FOPDD_SYMBOL,             
			FOPDD_STRIKE_PRICE,             
			FOPDD_OPTION_TYPE,     
			FOPDD_INTFLAG=ISNULL(FOPDD_INTFLAG,'IN'),            
			FOPDD_EXPIRYDATE = LEFT(FOPDD_EXPIRYDATE,11),             
			FOPDD_SEC_NAME,             
			FOPDD_OPENING_PQTY = SUM(FOPDD_OPENING_PQTY),   
			FOPDD_OPENING_SQTY = SUM(FOPDD_OPENING_SQTY),   
			FOPDD_TODAY_PQTY = SUM(FOPDD_TODAY_PQTY),   
			FOPDD_TODAY_SQTY = SUM(FOPDD_TODAY_SQTY),   
			FOPDD_EXERCISEDQTY = SUM(FOPDD_EXERCISEDQTY) ,   
			FOPDD_ASSIGNEDQTY = SUM(FOPDD_ASSIGNEDQTY),   
			FOPDD_INS_PQTY = SUM(FOPDD_INS_PQTY),   
			FOPDD_INS_SQTY = SUM(FOPDD_INS_SQTY),   
			FOPDD_CLOSING_PQTY = SUM(FOPDD_CLOSING_PQTY),   
			FOPDD_CLOSING_SQTY = SUM(FOPDD_CLOSING_SQTY),   
			FOPDD_EXPQTY = SUM(FOPDD_EXPQTY),   
			FOPDD_AUTOCORPQTY = SUM(FOPDD_AUTOCORPQTY),   
			FOPDD_LONGVALUE = SUM(FOPDD_LONGVALUE),   
			FOPDD_SHORTVALUE = SUM(FOPDD_SHORTVALUE),   
			FOPDD_CLOSINGPRICE= MAX(FOPDD_CLOSINGPRICE) ,           
			FOPDD_STLMNTPRICE=MAX(FOPDD_STLMNTPRICE)  ,            
			FOPDD_FLAG         ,          
			FOPDD_SAUDA_DATE   ,     FOPDD_CREATED_BY   ,          
			FOPDD_CREATED_DT = LEFT(FOPDD_CREATED_DT,11)             
		FROM             
			FO_POS_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOPDD_SAUDA_DATE LIKE @SDATE +'%'             
			AND FOPDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			--AND (CHARINDEX(LEFT(FOPDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
			AND (@BLOCK=CASE WHEN CHARINDEX(LEFT(FOPDD_INST_TYPE,3),'FUT')>0 THEN '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+4) ELSE '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+3) END OR @BLOCK='')
		GROUP BY
			FOPDD_PARTY_CODE,             
			FOPDD_INST_TYPE,             
			FOPDD_SYMBOL,             
			FOPDD_STRIKE_PRICE,             
			FOPDD_OPTION_TYPE,     
			ISNULL(FOPDD_INTFLAG,'IN'),            
			LEFT(FOPDD_EXPIRYDATE,11),             
			FOPDD_SEC_NAME,             
			FOPDD_FLAG         ,          
			FOPDD_SAUDA_DATE   ,     
			FOPDD_CREATED_BY   ,          
			LEFT(FOPDD_CREATED_DT,11)
		ORDER BY             
			FOPDD_PARTY_CODE,             
			FOPDD_FLAG,               
			FOPDD_INST_TYPE,             
			FOPDD_SYMBOL,             
			FOPDD_STRIKE_PRICE,             
			FOPDD_OPTION_TYPE ,           
			FOPDD_EXPIRYDATE   
	END
SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_FO_TRADE_DETAILS_DAS_GET
-- --------------------------------------------------


CREATE PROCEDURE [DBO].[CLS_FO_TRADE_DETAILS_DAS_GET]             
(            
    @SDATE VARCHAR(11),             
    @PARTYCODE VARCHAR(20),
	@TOCODE VARCHAR(20) = '',
	@DISPLAY VARCHAR(1) = '',
	@BLOCK VARCHAR(2) = ''
)            

AS

IF LEN(@SDATE) = 10 AND CHARINDEX('/',@SDATE) > 0    
SET @SDATE=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SDATE,103),109)             

IF @TOCODE = ''
	BEGIN
		SET @TOCODE = @PARTYCODE
	END
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF @DISPLAY <> ''
	BEGIN
		SELECT             
			FOTDD_PARTY_CODE,             
			FOTDD_PQTY = SUM(FOTDD_PQTY),
			FOTDD_SQTY = SUM(FOTDD_SQTY),
			FOTDD_PAMT = SUM(FOTDD_PAMT),
			FOTDD_SAMT = SUM(FOTDD_SAMT),
			TRADE_TYPE = RIGHT(FOTDD_FLAG,2),
			FOTDD_INST_TYPE
		FROM             
			FO_TRADE_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOTDD_SAUDA_DATE LIKE @SDATE +'%'             
			AND FOTDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			AND (CHARINDEX(LEFT(FOTDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
		GROUP BY
			FOTDD_PARTY_CODE,
			RIGHT(FOTDD_FLAG,2),   
		    FOTDD_INST_TYPE
		ORDER BY             
			FOTDD_PARTY_CODE ,
			RIGHT(FOTDD_FLAG,2)
	END
ELSE
	BEGIN
		SELECT             
			FOTDD_PARTY_CODE,             
			FOTDD_INST_TYPE,             
			FOTDD_SYMBOL,             
			FOTDD_STRIKE_PRICE,             
			FOTDD_OPTION_TYPE,             
			FOTDD_EXPIRY_DATE = LEFT(FOTDD_EXPIRY_DATE,11),             
			FOTDD_SEC_NAME,             
			FOTDD_TRADEQTY,             
			FOTDD_VALUE,             
			FOTDD_PRICE,             
			FOTDD_PQTY,             
			FOTDD_SQTY,             
			FOTDD_PAMT,             
			FOTDD_SAMT,             
			FOTDD_NETRATE,             
			FOTDD_CFPPRICE,             
			FOTDD_CFSPRICE,             
			FOTDD_SETTPRICE,             
			FOTDD_SAUDA_DATE = LEFT(FOTDD_SAUDA_DATE,11),             
			FOTDD_PNETRATE,             
			FOTDD_SNETRATE,             
			FOTDD_CHARGES,             
			FOTDD_BROKERAGE,             
			FOTDD_SERVICE_TAX,             
			FOTDD_BROKER_NOTE,             
			FOTDD_TURN_TAX,             
			FOTDD_SEBI_TAX,             
			FOTDD_CONTRACTNO,             
			FOTDD_PCOMM,             
			FOTDD_SCOMM,             
			FOTDD_INS_CHRG,             
			FOTDD_FLAG = LEFT(FOTDD_FLAG,2),     
			TRADE_TYPE = RIGHT(FOTDD_FLAG,2),     
			FOTDD_O_C_FLAG,             
			FOTDD_AUCTIONPART,             
			FOTDD_CREATED_BY,             
			FOTDD_CREATED_DT = LEFT(FOTDD_CREATED_DT,11)--,
			--CONTRACTDESCRIPTOR =  FOTDD_INST_TYPE + ' ' + FOTDD_SYMBOL + ' ' + FOTDD_OPTION_TYPE + ' ' + CONVERT(VARCHAR, FOTDD_STRIKE_PRICE) + ' ' + CONVERT(VARCHAR(11), FOTDD_EXPIRY_DATE, 109)
		FROM             
			FO_TRADE_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOTDD_SAUDA_DATE LIKE @SDATE +'%'             
			AND FOTDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			AND (CHARINDEX(LEFT(FOTDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
		ORDER BY             
			FOTDD_PARTY_CODE,           
			LEFT(FOTDD_FLAG,2),           
			FOTDD_INST_TYPE,           
			FOTDD_SYMBOL,           
			FOTDD_STRIKE_PRICE,           
			FOTDD_OPTION_TYPE,           
			FOTDD_EXPIRY_DATE,     
			TRADE_TYPE
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_IMPFILE_PARAM_GET
-- --------------------------------------------------


CREATE  PROC [DBO].[CLS_IMPFILE_PARAM_GET] 
(	@MODE VARCHAR(20),
	@FILETYPE VARCHAR(20) ='',
	@EXCHANGE VARCHAR(3)='',
	@SEGMENT VARCHAR(7)='',
	@SAUDA_DATE VARCHAR(11)=''
	
) AS 

/*
	@MODE : IMPFILE_TYPE - TO FETCH IMPORT TRADE FILE TYPES
	@MODE : TRDFILE_TYPE - TO FETCH IMPORT TRADE FILE TYPES
	@MODE : BULK_IMP_PATH - TO FETCH THE BULK IMPORT DEFAULT PATH
	@MODE : MEMBER_DET - TO FETCH THE MEMBER DETAILS
	@MODE : TMINFO_DET - TO FETCH THE TM INFO
	@MODE : TRDATE_STAT - TO FETCH THE BUSSINESS DATE CLOSE STATUS
*/

DECLARE @STRSQL VARCHAR(MAX)


-----------------------------------------------------------------
IF @MODE = 'IMPFILE_TYPE'			-- IMPORT EXCHANGE FILES
BEGIN
	SELECT FILETYPE_CD,FILETYPE_DESC FROM CLS_EXCH_IMPFILE_TYPE (NOLOCK)
	WHERE VALID_FLAG =1 ORDER BY 2
END

-----------------------------------------------------------------
IF @MODE = 'TRDFILE_TYPE'		-- TRADE FILE IMPORT
BEGIN
	SELECT FILETYPE_CD,FILETYPE_DESC FROM CLS_TRADEFILE_TYPE (NOLOCK)
	WHERE VALID_FLAG =1 ORDER BY 2
END
-----------------------------------------------------------------

IF @MODE = 'BULK_IMP_PATH'
BEGIN
	IF (SELECT COUNT(1) FROM IMP_FILEPATH WHERE FILE_TYPE =@FILETYPE) > 0
	BEGIN
		SELECT FILE_PATH FROM IMP_FILEPATH WHERE FILE_TYPE =@FILETYPE
	END
	ELSE
	BEGIN
		SELECT 'C:' AS FILE_PATH
	END
END
-------------------------------------------------------------------

IF @MODE = 'MEMBER_DET'
BEGIN
	IF @SEGMENT = 'FUTURES'
	BEGIN
		SET @STRSQL ='SELECT COMPANY,MEMBERTYPE,MEMBERCODE FROM [FOOWNER] (NOLOCK)'
	END
	ELSE
	BEGIN
		SET @STRSQL ='SELECT COMPANY,MEMBERTYPE=''TM'',MEMBERCODE FROM [OWNER] (NOLOCK)'
	END
	EXEC (@STRSQL)
END
-----------------------------------------------------------------------------

IF @MODE = 'TMINFO_DET' AND @SEGMENT = 'FUTURES'
BEGIN
	SET @STRSQL = 'SELECT ISNULL(COUNT(1),0) AS TMCOUNT FROM FOTMINFO'
	EXEC (@STRSQL)
END
-----------------------------------------------------------------------------

IF @MODE = 'TRDATE_STAT'
BEGIN
	SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)

	IF (SELECT COUNT(1)  FROM V2_BUSINESS_PROCESS (NOLOCK)
		WHERE BUSINESS_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59') > 0
	BEGIN
		IF (SELECT COUNT(1)  FROM V2_BUSINESS_PROCESS (NOLOCK)
		WHERE OPEN_CLOSE = 1 AND BUSINESS_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59') = 0
		BEGIN
			SELECT 'OPEN' AS TRDATE_STAT, ERRMSG =''
		END
		ELSE
		BEGIN
			SELECT 'CLOSED' AS TRDATE_STAT, ERRMSG ='CANNOT PROCEED. BUSINESS DATE ' +  @SAUDA_DATE + ' IS CLOSED'
		END
	END
	ELSE
	BEGIN
		SELECT 'OPEN' AS TRDATE_STAT, ERRMSG =''
	END
END
/*------------------------------------------ END OF THE PROC ------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_IMPORT_TRADE_FILE
-- --------------------------------------------------


CREATE PROC [DBO].[CLS_IMPORT_TRADE_FILE] 
(
	@SESSIONID VARCHAR(30),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@IMPORTMODE INT ,
	@FILETYPE VARCHAR(20)
) AS

/*
	@IMPORTMODE : 1 - NORMAL / 2 - BULK IMPORT
	@FILETYPE   : FTP
*/

	TRUNCATE TABLE FOFTTRADE_3_IMP
	TRUNCATE TABLE FOFTTRADE

	IF @FILETYPE  ='FTP'
	BEGIN
		IF @IMPORTMODE=1
		BEGIN
			INSERT INTO FOFTTRADE_3_IMP
			SELECT
				TRADE_NO  = DBO.PIECE(FILE_DATA,',',1),
				TRADEDATE  = DBO.PIECE(FILE_DATA,',',2),
				ACTIVITYTYPE  = DBO.PIECE(FILE_DATA,',',3),
				MARKETTYPE  = DBO.PIECE(FILE_DATA,',',4),
				INST_TYPE  = DBO.PIECE(FILE_DATA,',',5),
				SYMBOL  = DBO.PIECE(FILE_DATA,',',6),
				EXPIRYDATE  = LEFT(CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',7)),11) + ' 23:59',
				STRIKE_PRICE  = DBO.PIECE(FILE_DATA,',',8),
				OPTION_TYPE  = DBO.PIECE(FILE_DATA,',',9),
				C_U_FLAG  = DBO.PIECE(FILE_DATA,',',10),
				B_BROKERCODE  = DBO.PIECE(FILE_DATA,',',11),
				S_BROKERCODE  = DBO.PIECE(FILE_DATA,',',12),
				PRICE  = DBO.PIECE(FILE_DATA,',',13),
				ACTIVITYTIME  = DBO.PIECE(FILE_DATA,',',14),
				TRADEVOLUME  = DBO.PIECE(FILE_DATA,',',15),
				TOKEN_NO  = DBO.PIECE(FILE_DATA,',',16),
				BRANCH_ID  = DBO.PIECE(FILE_DATA,',',17),
				B_CMCODE  = DBO.PIECE(FILE_DATA,',',18),
				S_CMCODE  = DBO.PIECE(FILE_DATA,',',19),
				SELL_BRANCH  = DBO.PIECE(FILE_DATA,',',20),
				B_PARTICIPANTCODE  = DBO.PIECE(FILE_DATA,',',21),
				B_CONFIRMATION  = DBO.PIECE(FILE_DATA,',',22),
				S_PARTICIPANTCODE  = DBO.PIECE(FILE_DATA,',',23),
				S_CONFIRMATION  = DBO.PIECE(FILE_DATA,',',24),
				B_O_C_FLAG  = DBO.PIECE(FILE_DATA,',',25),
				S_O_C_FLAG  = DBO.PIECE(FILE_DATA,',',26),
				B_OLD_PARTICIPANTCODE  = DBO.PIECE(FILE_DATA,',',27),
				B_OLD_CMCODE  = DBO.PIECE(FILE_DATA,',',28),
				S_OLD_PARTICIPANTCODE  = DBO.PIECE(FILE_DATA,',',29),
				S_OLD_CMCODE  = DBO.PIECE(FILE_DATA,',',30),
				B_TRADER  = DBO.PIECE(FILE_DATA,',',31),
				S_TRADER  = DBO.PIECE(FILE_DATA,',',32),
				B_ORDER_NO  = DBO.PIECE(FILE_DATA,',',33),
				S_ORDER_NO  = DBO.PIECE(FILE_DATA,',',34),
				B_PARTY_CODE  = DBO.PIECE(FILE_DATA,',',35),
				S_PARTY_CODE  = DBO.PIECE(FILE_DATA,',',36),
				B_REMARK  = DBO.PIECE(FILE_DATA,',',37),
				S_REMARK  = DBO.PIECE(FILE_DATA,',',38),
				B_TRADEQTY  = DBO.PIECE(FILE_DATA,',',39),
				S_TRADEQTY  = DBO.PIECE(FILE_DATA,',',40),
				B_PRO_CLI  = DBO.PIECE(FILE_DATA,',',41),
				S_PRO_CLI  = DBO.PIECE(FILE_DATA,',',42),
				CONTROLFLAG  = DBO.PIECE(FILE_DATA,',',43),
				ORDERTIME  = DBO.PIECE(FILE_DATA,',',44)
			FROM CLASSFILEUPD
			WHERE
				SESSION_ID= @SESSIONID
				AND  DBO.PIECE(FILE_DATA,',',1) <> ''
		END
		ELSE
		BEGIN
			INSERT INTO FOFTTRADE_3_IMP
			SELECT
				TRADE_NO  = DBO.PIECE(FILEDATA,',',1),
				TRADEDATE  = DBO.PIECE(FILEDATA,',',2),
				ACTIVITYTYPE  = DBO.PIECE(FILEDATA,',',3),
				MARKETTYPE  = DBO.PIECE(FILEDATA,',',4),
				INST_TYPE  = DBO.PIECE(FILEDATA,',',5),
				SYMBOL  = DBO.PIECE(FILEDATA,',',6),
				EXPIRYDATE  = LEFT(CONVERT(DATETIME,DBO.PIECE(FILEDATA,',',7)),11) + ' 23:59',
				STRIKE_PRICE  = DBO.PIECE(FILEDATA,',',8),
				OPTION_TYPE  = DBO.PIECE(FILEDATA,',',9),
				C_U_FLAG  = DBO.PIECE(FILEDATA,',',10),
				B_BROKERCODE  = DBO.PIECE(FILEDATA,',',11),
				S_BROKERCODE  = DBO.PIECE(FILEDATA,',',12),
				PRICE  = DBO.PIECE(FILEDATA,',',13),
				ACTIVITYTIME  = DBO.PIECE(FILEDATA,',',14),
				TRADEVOLUME  = DBO.PIECE(FILEDATA,',',15),
				TOKEN_NO  = DBO.PIECE(FILEDATA,',',16),
				BRANCH_ID  = DBO.PIECE(FILEDATA,',',17),
				B_CMCODE  = DBO.PIECE(FILEDATA,',',18),
				S_CMCODE  = DBO.PIECE(FILEDATA,',',19),
				SELL_BRANCH  = DBO.PIECE(FILEDATA,',',20),
				B_PARTICIPANTCODE  = DBO.PIECE(FILEDATA,',',21),
				B_CONFIRMATION  = DBO.PIECE(FILEDATA,',',22),
				S_PARTICIPANTCODE  = DBO.PIECE(FILEDATA,',',23),
				S_CONFIRMATION  = DBO.PIECE(FILEDATA,',',24),
				B_O_C_FLAG  = DBO.PIECE(FILEDATA,',',25),
				S_O_C_FLAG  = DBO.PIECE(FILEDATA,',',26),
				B_OLD_PARTICIPANTCODE  = DBO.PIECE(FILEDATA,',',27),
				B_OLD_CMCODE  = DBO.PIECE(FILEDATA,',',28),
				S_OLD_PARTICIPANTCODE  = DBO.PIECE(FILEDATA,',',29),
				S_OLD_CMCODE  = DBO.PIECE(FILEDATA,',',30),
				B_TRADER  = DBO.PIECE(FILEDATA,',',31),
				S_TRADER  = DBO.PIECE(FILEDATA,',',32),
				B_ORDER_NO  = DBO.PIECE(FILEDATA,',',33),
				S_ORDER_NO  = DBO.PIECE(FILEDATA,',',34),
				B_PARTY_CODE  = DBO.PIECE(FILEDATA,',',35),
				S_PARTY_CODE  = DBO.PIECE(FILEDATA,',',36),
				B_REMARK  = DBO.PIECE(FILEDATA,',',37),
				S_REMARK  = DBO.PIECE(FILEDATA,',',38),
				B_TRADEQTY  = DBO.PIECE(FILEDATA,',',39),
				S_TRADEQTY  = DBO.PIECE(FILEDATA,',',40),
				B_PRO_CLI  = DBO.PIECE(FILEDATA,',',41),
				S_PRO_CLI  = DBO.PIECE(FILEDATA,',',42),
				CONTROLFLAG  = DBO.PIECE(FILEDATA,',',43),
				ORDERTIME  = DBO.PIECE(FILEDATA,',',44)
		FROM CLASSFILEUPD_BULK
			WHERE
				SPID= @SESSIONID
				AND  DBO.PIECE(FILEDATA,',',1) <> ''
		END	
		

		TRUNCATE TABLE FOFTTRADE

		INSERT INTO FOFTTRADE   
		(TRADE_NO,STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
		SEC_NAME,BOOKTYPE,BOOKTYPENAME,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,  
		PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,  
		MARKETTYPE,C_U_FLAG,SETTFLAG,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)  

		SELECT 
				RIGHT(TRADE_NO,8)*1 TRADE_NO,ACTIVITYTYPE STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,
				OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,  
				'' SEC_NAME,MARKETTYPE BOOKTYPE,'' BOOKTYPENAME,USER_ID=S_TRADER,
				BRANCH_ID=S_PARTY_CODE,
				SELL_BUY = 2,
				TRADEQTY=TRADEVOLUME,PRICE,PRO_CLI =CASE WHEN S_PRO_CLI ='C' THEN 1 ELSE 2 END,  
				PARTY_CODE = S_PARTY_CODE,
				PARTICIPANTCODE = (CASE WHEN S_CONFIRMATION = 'Y' THEN S_PARTICIPANTCODE ELSE S_BROKERCODE END),  
				C_U_FLAG  ,
				ACTIVITYTIME,LAST_MOD_TIME=ACTIVITYTIME,
				ORDER_NO = S_ORDER_NO , RIGHT(ORDERTIME,8),  
				MARKETTYPE=CONTROLFLAG,S_O_C_FLAG,0 SETTFLAG,S_BROKERCODE MEMBERCODE,S_PARTY_CODE TMPARTYCODE,
				0 RESERVED1,2 RESERVED2,'' RESERVED3,'' RESERVED4, 
				RESERVED5 = CASE WHEN S_CONFIRMATION = 'Y' THEN 'Y' ELSE 'N' END
		FROM FOFTTRADE_3_IMP
		WHERE ISNULL(S_ORDER_NO,'') <> '' 

		INSERT INTO FOFTTRADE   
		(TRADE_NO,STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
		SEC_NAME,BOOKTYPE,BOOKTYPENAME,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,  
		PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,  
		MARKETTYPE,C_U_FLAG,SETTFLAG,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)  

		SELECT 
				RIGHT(TRADE_NO,7)*1 TRADE_NO,ACTIVITYTYPE STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,
				OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,  
				'' SEC_NAME,MARKETTYPE BOOKTYPE,'' BOOKTYPENAME,USER_ID=B_TRADER,
				BRANCH_ID=B_PARTY_CODE,
				SELL_BUY = 1,
				TRADEQTY=TRADEVOLUME,PRICE,PRO_CLI =CASE WHEN B_PRO_CLI ='C' THEN 1 ELSE 2 END,  
				PARTY_CODE = B_PARTY_CODE,
				PARTICIPANTCODE = (CASE WHEN B_CONFIRMATION = 'Y' THEN B_PARTICIPANTCODE ELSE B_BROKERCODE END),  
				C_U_FLAG  ,
				ACTIVITYTIME,LAST_MOD_TIME=ACTIVITYTIME,
				ORDER_NO = B_ORDER_NO ,RIGHT(ORDERTIME,8),  
				MARKETTYPE=CONTROLFLAG,B_O_C_FLAG,0 SETTFLAG,B_BROKERCODE MEMBERCODE,B_PARTY_CODE TMPARTYCODE,
				0 RESERVED1,2 RESERVED2,'' RESERVED3,'' RESERVED4,
				RESERVED5 = CASE WHEN B_CONFIRMATION = 'Y' THEN 'Y' ELSE 'N' END
		FROM FOFTTRADE_3_IMP
		WHERE ISNULL(B_ORDER_NO,'') <> '' 
	END


	EXEC FODUPRECSETTCHECK
	
	IF (SELECT COUNT(1) FROM FOTRADE) > 0
	BEGIN
		SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)
		INSERT INTO FOSTAT_TRD
		SELECT ACTIONCODE	 = 'I10',SYSDATE = @SAUDA_DATE,FILEDATE = @SAUDA_DATE,COM_DATE = LEFT(GETDATE(),11)
	END
	
	/*---------------------------------------------------------------- END OF THE PROC --------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_IMPORT_TRADE_FILE_CONFIRM
-- --------------------------------------------------



CREATE  PROC CLS_IMPORT_TRADE_FILE_CONFIRM
(	
	@SAUDA_DATE VARCHAR(11)
) AS 

DECLARE @ERR_CD AS INT
DECLARE @ERR_DESC AS VARCHAR(200)

SET @ERR_CD  = 0
SET @ERR_DESC = ''

SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)

IF (SELECT COUNT(1) FROM FOSTAT_TRD WHERE SYSDATE = @SAUDA_DATE AND ACTIONCODE = 'I50')=0
BEGIN
	SET @ERR_CD = -1
	SET @ERR_DESC = 'PLEASE CLEAR THE ERROR CORRECTED FIRST'
	SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
	RETURN
END

EXEC FOREARRANGETRDFLAG

EXEC FOTRD_CLIENTMASTER

INSERT INTO FOSTAT_TRD
SELECT ACTIONCODE	 = 'I60',SYSDATE = @SAUDA_DATE,FILEDATE = @SAUDA_DATE,COM_DATE = LEFT(GETDATE(),11)

SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]

/*------------------------------------------- END OF THE PROC ---------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_IMPORT_TRADE_FILE_CONTRACT
-- --------------------------------------------------


CREATE  PROC CLS_IMPORT_TRADE_FILE_CONTRACT
(	
	@SAUDA_DATE VARCHAR(11),
	@USERNAME VARCHAR(30)
) AS 

DECLARE @ERR_CD AS INT
DECLARE @ERR_DESC AS VARCHAR(200)

SET @ERR_CD  = 0
SET @ERR_DESC = ''

SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)

IF (SELECT COUNT(1) FROM FOSTAT_TRD WHERE SYSDATE = @SAUDA_DATE AND ACTIONCODE = 'I60')=0
BEGIN
	SET @ERR_CD = -1
	SET @ERR_DESC = 'PLEASE COMPLETE THE CONFIRM TRADE FIRST'
	SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
	RETURN
END

DECLARE @TRDCOUNT BIGINT
DECLARE @CONFCOUNT BIGINT
DECLARE @TRDQTY BIGINT
DECLARE @CONFQTY BIGINT
DECLARE @TRDAMT MONEY
DECLARE @CONFAMT MONEY

SELECT @CONFQTY=ISNULL(SUM(TRADEQTY),0),@CONFAMT=ISNULL(SUM(TRADEQTY*PRICE),0),@CONFCOUNT=COUNT(1) FROM FOCONFIRMVIEW 
SELECT @TRDQTY=ISNULL(SUM(TRADEQTY),0),@TRDAMT=ISNULL(SUM(TRADEQTY*PRICE),0),@TRDCOUNT=COUNT(1) FROM FOTRADE  
 
IF @TRDQTY <> @CONFQTY OR @TRDCOUNT <> @CONFCOUNT OR @TRDAMT <> @CONFAMT
BEGIN
	SET @ERR_CD = -1
	SET @ERR_DESC = 'STILL SOME ERROS IN MASTERS . HENCE THE BELOW TRADE AND CONFIRMVIEW IS NOT MATCHING'
	SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
	
	SELECT 'TRADE COUNT ' +  CONVERT(VARCHAR,@TRDCOUNT) AS [TRADE] , 'CONFIRM TRADE COUNT ' +  CONVERT(VARCHAR,@CONFCOUNT) AS [CONFIRM TRADE] 
	UNION ALL
	SELECT 'TRADE QTY ' +  CONVERT(VARCHAR,@TRDQTY) AS [TRADE] , 'CONFIRM TRADE QTY ' +  CONVERT(VARCHAR,@CONFQTY) AS [CONFIRM TRADE] 
	UNION ALL
	SELECT 'TRADE AMT ' +  CONVERT(VARCHAR,@TRDAMT) AS [TRADE] , 'CONFIRM TRADE AMT ' +  CONVERT(VARCHAR,@CONFAMT) AS [CONFIRM TRADE] 
	
	RETURN	
END

IF (SELECT ISNULL(STYLE,0) FROM FOOWNER) =1
BEGIN
	IF (SELECT COUNT(1) FROM CONTGEN,FOTRADE WHERE ACTIVITYTIME >= START_DATE AND ACTIVITYTIME <= END_DATE)=0
	BEGIN
		SET @ERR_CD = -1
		SET @ERR_DESC = 'PLEASE ENTER THE CONTRACT NO IN THE TABLE FOR THE CURRENT YEAR'
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
		RETURN
	END
END

EXEC FOGENCONTRACT @USERNAME

EXEC CLS_IMPORT_TRADE_FILE_PROCESS @MODE ='RESET_TRD'

SET @ERR_DESC = ''

SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]

/*------------------------------------------- END OF THE PROC ---------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_IMPORT_TRADE_FILE_PROCESS
-- --------------------------------------------------



CREATE PROC CLS_IMPORT_TRADE_FILE_PROCESS
(	@MODE VARCHAR(20),
	@SAUDA_DATE VARCHAR(11)='',
	@SESSIONID VARCHAR(30)='',
	@IMPORTMODE INT=0	
) AS 

/*
	@MODE : RESET_TRD - TO RESET THE TRADE
	@MODE : TRDCOUNT_GET - TO GET THE TRADE REC COUNTS
	@MODE : NEXTSTEP_GET - TO GET THE IMP TRD PROCESS NEXT STEP
	@MODE : ERRTRD_GET - TO GET THE ERROR TRADE LIST
	@MODE : CHECK_ERR - TO CHECK THE TRADE ERROS
*/
/*
TRADE PROCESS STEP - ACTION CODES
I10 - TRADE FILE IMPORTED
I50 - ERROR CORRECTED CHECKED
I60 - TRADE CONFIRMED
I70 - CONCTRACT GENERATED
*/
-----------------------------------------------------------------------------------------
DECLARE @ERR_CD AS INT
DECLARE @ERR_DESC AS VARCHAR(200)

SET @ERR_CD  = 0
SET @ERR_DESC = ''

IF @MODE = 'RESET_TRD'
BEGIN	
	TRUNCATE TABLE FOFTTRADE
	TRUNCATE TABLE FOTRADE
	TRUNCATE TABLE FOSTAT_TRD
END
-----------------------------------------------------------------------------------------

IF @MODE = 'TRDCOUNT_GET'
BEGIN	
	DECLARE @TRADE_DATE VARCHAR(11)

	IF (SELECT COUNT(1) FROM FOTRADE) >0
	BEGIN
		SELECT TOP 1 @TRADE_DATE = CONVERT(VARCHAR,ACTIVITYTIME,103) FROM FOTRADE
		IF @TRADE_DATE <> @SAUDA_DATE
		BEGIN
			IF @SESSIONID=''
			BEGIN
				SELECT ROW_COUNT = 0, IMPORT_COUNT= 0, PROCEED_COUNT= COUNT(1),
				ERRMSG = @TRADE_DATE
				FROM FOTRADE
			END
			ELSE
			BEGIN
				SELECT ROW_COUNT = 0, IMPORT_COUNT= 0, PROCEED_COUNT= 0, 
				ERRMSG = 'ERROR - TRADE DATE IN THE FILE ' + @TRADE_DATE + ' IS NOT MACHING THE ENTERED DATE'
				RETURN
			END
		END
	END
	SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)

	IF @IMPORTMODE  = 1 -- NORMAL IMPORT
	BEGIN
		SELECT ROW_COUNT = MAX(ROW_COUNT), IMPORT_COUNT= MAX(IMPORT_COUNT), PROCEED_COUNT= MAX(PROCEED_COUNT), ERRMSG = ''
		FROM
		(
			SELECT COUNT(1) AS ROW_COUNT, 0 AS IMPORT_COUNT, 0 AS PROCEED_COUNT FROM CLASSFILEUPD WHERE SESSION_ID = @SESSIONID
			UNION ALL
			SELECT 0 AS ROW_COUNT ,COUNT(1) AS IMPORT_COUNT, 0 AS PROCEED_COUNT FROM FOFTTRADE WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
			UNION ALL
			SELECT 0 AS ROW_COUNT , 0 AS IMPORT_COUNT, COUNT(1) AS PROCEED_COUNT FROM FOTRADE WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
		) A
	END
	ELSE
	BEGIN
		SELECT ROW_COUNT = MAX(ROW_COUNT), IMPORT_COUNT= MAX(IMPORT_COUNT), PROCEED_COUNT= MAX(PROCEED_COUNT), ERRMSG = ''
		FROM
		(
			SELECT COUNT(1) AS ROW_COUNT, 0 AS IMPORT_COUNT, 0 AS PROCEED_COUNT FROM CLASSFILEUPD_BULK WHERE SPID = @SESSIONID
			UNION ALL
			SELECT 0 AS ROW_COUNT ,COUNT(1) AS IMPORT_COUNT, 0 AS PROCEED_COUNT FROM FOFTTRADE WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
			UNION ALL
			SELECT 0 AS ROW_COUNT , 0 AS IMPORT_COUNT, COUNT(1) AS PROCEED_COUNT FROM FOTRADE WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
		) A
	END

END
-----------------------------------------------------------------------------------------

IF @MODE = 'NEXTSTEP_GET'
BEGIN	
	SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)

	IF (SELECT COUNT(1) FROM FOSTAT_TRD WHERE SYSDATE = @SAUDA_DATE )=0
	BEGIN
		SELECT CURR_STEP='', NEXT_STEP = 'START_IMP'
		RETURN
	END

	SELECT 
			CURR_STEP = CASE 
							WHEN LAST_STEP='I10' THEN 'START_IMP'
							WHEN LAST_STEP='I50' THEN 'ERROR_CORR'
							WHEN LAST_STEP='I60' THEN 'CONFIRM_TRD'
						ELSE 'CONTRACT_TRD'
						END,

			NEXT_STEP = CASE 
							WHEN LAST_STEP='I10' THEN 'ERROR_CORR'
							WHEN LAST_STEP='I50' THEN 'CONFIRM_TRD'
							WHEN LAST_STEP='I60' THEN 'CONTRACT_TRD'
						ELSE 'RESET_TRD'
						END
	FROM
	(
		SELECT LAST_STEP = MAX(ACTIONCODE) FROM FOSTAT_TRD 
		WHERE SYSDATE = @SAUDA_DATE
	) A
END
-----------------------------------------------------------------------------------------

IF @MODE = 'ERRTRD_GET'
BEGIN

	SET @ERR_CD = -1
	SET @ERR_DESC = 'ERROR TRADE LIST. PLEASE VERIFY'
	SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]

	SELECT PARTY_CODE AS [PARTY CODE],TRADE_NO AS [TRADE NO],ORDER_NO AS [ORDER NO],[STATUS],
	[CONTRACT] = INST_TYPE + ' ' + SYMBOL + ' ' + LEFT(EXPIRYDATE,11) + ' ' + CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + OPTION_TYPE
	FROM FOFTTRADE  
	WHERE STATUS IN (12,17)
	AND ORDER_NO NOT IN ( SELECT ORDER_NO FROM FOTRADE)
	ORDER BY 1,2,3,4,5
	
	RETURN
END
-----------------------------------------------------------------------------------------------------
IF @MODE = 'CHECK_ERR'
BEGIN
	SET @SAUDA_DATE = LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)
	
	IF(SELECT COUNT(1) FROM FOTRADE ) = 0
	BEGIN
		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. NO RECORD TO PROCESS'
		
		TRUNCATE TABLE FOFTTRADE
		TRUNCATE TABLE FOTRADE
		TRUNCATE TABLE FOSTAT_TRD
		
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
		RETURN
	END

	IF(SELECT COUNT(1) FROM (SELECT  DISTINCT LEFT(ACTIVITYTIME,11) AS SDATE FROM FOTRADE) TRD) > 1
	BEGIN
		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. DUPLICATE TRADE DATES FOUND IN THE FILE'
		
		TRUNCATE TABLE FOFTTRADE
		TRUNCATE TABLE FOTRADE
		TRUNCATE TABLE FOSTAT_TRD
		
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
		RETURN
	END

	IF (SELECT MEMBERTYPE FROM FOOWNER) = 'CM'
	BEGIN
		UPDATE FOTRADE SET RESERVED2='0'
		UPDATE FOTRADE SET PARTY_CODE= CLIENT2.PARTY_CODE,RESERVED2='2' FROM CLIENT2 WHERE CLIENT2.BANKID =FOTRADE.PARTICIPANTCODE
		UPDATE FOTRADE SET PARTY_CODE=FOTMINFO.PARTY_CODE,RESERVED2='2' FROM FOTMINFO WHERE FOTMINFO.TM_CODE=FOTRADE.MEMBERCODE AND FOTRADE.RESERVED2='0'
	END


	UPDATE FOTRADE SET FOTRADE.PARTY_CODE = TERMPARTY.PARTY_CODE FROM TERMPARTY WHERE TERMPARTY.USERID = FOTRADE.USER_ID 
	AND FOTRADE.PRO_CLI = PROCLI 

	IF (SELECT COUNT(1) FROM FOTRADE WHERE NOT EXISTS (SELECT PARTY_CODE FROM CLIENT2 (NOLOCK) WHERE  CLIENT2.PARTY_CODE = FOTRADE.PARTY_CODE))> 1
	BEGIN

		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. MISSING CLIENT CODE FOUND IN THE FILE'
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]

		SELECT DISTINCT PARTY_CODE AS [PARTY CODE],USER_ID AS [TERMIAL ID],ISNULL(PARTICIPANTCODE,'') AS [PARTICIPANT CODE],
		MEMBERCODE AS [MEMBER CODE]
		FROM FOTRADE WHERE NOT EXISTS (SELECT PARTY_CODE FROM CLIENT2 (NOLOCK) WHERE  CLIENT2.PARTY_CODE = FOTRADE.PARTY_CODE)
			
		RETURN
	END

	IF (SELECT COUNT(1) FROM FOTRADE WHERE NOT EXISTS (SELECT SYMBOL FROM FOSCRIP2 (NOLOCK) 
													WHERE  FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE
													AND FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE
													AND FOSCRIP2.SYMBOL = FOTRADE.SYMBOL
													AND FOSCRIP2.EXPIRYDATE = FOTRADE.EXPIRYDATE
													AND FOSCRIP2.STRIKE_PRICE = FOTRADE.STRIKE_PRICE
													AND FOSCRIP2.OPTION_TYPE = FOTRADE.OPTION_TYPE))> 1
	BEGIN

		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. MISSING SCRIPTS FOUND IN THE FILE'
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
		
		SELECT DISTINCT INST_TYPE AS [INST TYPE],SYMBOL, LEFT(EXPIRYDATE,11) AS [EXPIRY DATE],
		STRIKE_PRICE AS [STRIKE PRICE], OPTION_TYPE AS [OPTION TYPE]
		FROM FOTRADE WHERE NOT EXISTS (SELECT SYMBOL FROM FOSCRIP2 (NOLOCK) 
													WHERE  FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE
													AND FOSCRIP2.INST_TYPE = FOTRADE.INST_TYPE
													AND FOSCRIP2.SYMBOL = FOTRADE.SYMBOL
													AND FOSCRIP2.EXPIRYDATE = FOTRADE.EXPIRYDATE
													AND FOSCRIP2.STRIKE_PRICE = FOTRADE.STRIKE_PRICE
													AND FOSCRIP2.OPTION_TYPE = FOTRADE.OPTION_TYPE)
		RETURN
	END

	EXEC FOTRD_CLIENTMASTER

	SELECT FOTRADE.* INTO #FOERRTRADE 
	FROM FOTRADE (NOLOCK), FOOWNER (NOLOCK) WHERE EXISTS (SELECT PARTY_CODE FROM CLIENT2 (NOLOCK)
	WHERE CLIENT2.PARTY_CODE = FOTRADE.PARTY_CODE AND CLIENT2.BANKID <> FOTRADE.PARTICIPANTCODE)
	AND ISNULL(PARTICIPANTCODE,'') <> ''
	AND PARTICIPANTCODE <> FOOWNER.MEMBERCODE

	INSERT INTO FOERRTRADE      
	SELECT * FROM #FOERRTRADE

	IF (((SELECT COUNT(1) FROM #FOERRTRADE) > 0) OR ((SELECT COUNT(1) FROM FOTRD_CLIENT2 (NOLOCK), CLIENT5 (NOLOCK) 
												WHERE FOTRD_CLIENT2.CL_CODE = CLIENT5.CL_CODE
												AND CLIENT5.INACTIVEFROM <= GETDATE())>0))
	BEGIN

		SET @ERR_CD = -1
		SET @ERR_DESC = 'CANNOT PROCEED. WRONG CLIENT CODE FOUND IN THE FILE'
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]


		SELECT PARTY_CODE,'IN ACTIVE' FROM FOTRD_CLIENT2 (NOLOCK), CLIENT5 (NOLOCK) WHERE FOTRD_CLIENT2.CL_CODE = CLIENT5.CL_CODE
		AND CLIENT5.INACTIVEFROM <= GETDATE()

		/*UNION ALL

		SELECT C.PARTY_CODE,'EXPIRED SEBI REG' FROM 
		FOTRD_CLIENT2 (NOLOCK), CLIENT_DETAILS_VIEW C (NOLOCK) WHERE FOTRD_CLIENT2.CL_CODE = C.CL_CODE
		AND ISNULL(C.SEBI_REGN_NO,'') <> '' AND C.SEBI_EXP_DATE <= GETDATE()*/

		UNION ALL

		SELECT DISTINCT PARTY_CODE,'WRONG CP CODE' FROM #FOERRTRADE 
		
		RETURN
	END

	EXEC FOTRD_SCRIPMASTER


	DECLARE @TRDCOUNT BIGINT
	DECLARE @CONFCOUNT BIGINT
	DECLARE @TRDQTY BIGINT
	DECLARE @CONFQTY BIGINT
	DECLARE @TRDAMT MONEY
	DECLARE @CONFAMT MONEY

	SELECT @CONFQTY=ISNULL(SUM(TRADEQTY),0),@CONFAMT=ISNULL(SUM(TRADEQTY*PRICE),0),@CONFCOUNT=COUNT(1) FROM FOCONFIRMVIEW 
	SELECT @TRDQTY=ISNULL(SUM(TRADEQTY),0),@TRDAMT=ISNULL(SUM(TRADEQTY*PRICE),0),@TRDCOUNT=COUNT(1) FROM FOTRADE  
	 
	IF @TRDQTY <> @CONFQTY OR @TRDCOUNT <> @CONFCOUNT OR @TRDAMT <> @CONFAMT
	BEGIN
		SET @ERR_CD = -1
		SET @ERR_DESC = 'STILL SOME ERROS IN MASTERS . HENCE THE BELOW TRADE AND CONFIRMVIEW IS NOT MATCHING'
		SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
		
		SELECT 'TRADE COUNT ' +  CONVERT(VARCHAR,@TRDCOUNT) AS [TRADE] , 'CONFIRM TRADE COUNT ' +  CONVERT(VARCHAR,@CONFCOUNT) AS [CONFIRM TRADE] 
		UNION ALL
		SELECT 'TRADE QTY ' +  CONVERT(VARCHAR,@TRDQTY) AS [TRADE] , 'CONFIRM TRADE QTY ' +  CONVERT(VARCHAR,@CONFQTY) AS [CONFIRM TRADE] 
		UNION ALL
		SELECT 'TRADE AMT ' +  CONVERT(VARCHAR,@TRDAMT) AS [TRADE] , 'CONFIRM TRADE AMT ' +  CONVERT(VARCHAR,@CONFAMT) AS [CONFIRM TRADE] 
		
		RETURN	
	END

	INSERT INTO FOSTAT_TRD
	SELECT ACTIONCODE	 = 'I50',SYSDATE = @SAUDA_DATE,FILEDATE = @SAUDA_DATE,COM_DATE = LEFT(GETDATE(),11)

	SELECT @ERR_CD AS [ERR_CD],@ERR_DESC AS [ERR_DESC]
END
/*------------------------------------------ END OF THE PROC ------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MARGIN_RPT
-- --------------------------------------------------

--EXEC CLS_MARGIN_RPT '01/01/2000','10/10/2014','','','BROKER','BROKER'

CREATE  PROC [DBO].[CLS_MARGIN_RPT]
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@FROMPARTY VARCHAR(20),
	@TOPARTY VARCHAR (20), 
	@STATUSID VARCHAR(15),  
	@STATUSNAME VARCHAR(25)
)  AS


SET @DATEFROM = LEFT(CONVERT(DATETIME,@DATEFROM,103),11)
SET @DATETO = LEFT(CONVERT(DATETIME,@DATETO,103),11)


IF @TOPARTY =''
SET @TOPARTY ='ZZZZZZZ'


IF (SELECT COUNT(1) FROM PRADNYA.DBO.HISTORY_TBL_CLIENTMARGIN_NSEFO (NOLOCK)
WHERE MARGINDATE  BETWEEN @DATEFROM  AND  @DATETO + ' 23:59:00' ) > 0
BEGIN
SELECT
		CLIENT2.PARTY_CODE,
		PARTY_NAME = CLIENT1.LONG_NAME,		
		MARGIN_DATE = CONVERT(VARCHAR,MARGINDATE,103),
		BILL_AMOUNT = BILLAMOUNT ,
		LEDGER_AMOUNT = LEDGERAMOUNT ,      
		NET_CASH_AVAILABLE = BILLAMOUNT + LEDGERAMOUNT,
		COLLATERAL_AVAILABLE = CASH_COLL + NONCASH_COLL,
		REPORTED_MRG_COLLATERAL = ISNULL(F.FINALAMOUNT,0),
		INITIALMARGIN = INITIALMARGIN, 
		MTMMARGIN = MTMMARGIN,
		ADDMARGIN = ADDMARGIN,
		FREE_COLLATERALS = ((CASH_COLL + NONCASH_COLL)- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)),
		NET_AMOUNT = ((CASH_COLL + NONCASH_COLL)- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)) +  (BILLAMOUNT + LEDGERAMOUNT),
		FREE_COLLATERALS_REPORTING = (ISNULL(F.FINALAMOUNT,(CASH_COLL + NONCASH_COLL))- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)),
		NET_AMOUNT_REPORTING = (ISNULL(F.FINALAMOUNT,(CASH_COLL + NONCASH_COLL))- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)) +  (BILLAMOUNT + LEDGERAMOUNT)
	FROM
		CLIENT1 (NOLOCK) ,  CLIENT2 (NOLOCK),
		PRADNYA.DBO.HISTORY_TBL_CLIENTMARGIN_NSEFO FO (NOLOCK)
		LEFT OUTER JOIN
		(
			SELECT EFFDATE,PARTY_CODE, FINALAMOUNT = SUM(FINALAMOUNT) FROM 
			TBL_COLLATERAL_MARGIN (NOLOCK) 
			WHERE EFFDATE BETWEEN @DATEFROM AND @DATETO + ' 23:59:00' 
			AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
			GROUP BY EFFDATE,PARTY_CODE
		) F
		ON (MARGINDATE = EFFDATE AND F.PARTY_CODE = FO.PARTY_CODE)
	WHERE
		MARGINDATE BETWEEN @DATEFROM AND @DATETO + ' 23:59:00' 
		AND FO.PARTY_CODE = CLIENT2.PARTY_CODE
		AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
		AND CLIENT2.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY   
		AND @STATUSNAME = 
			(CASE 
				WHEN @STATUSID = 'BRANCH' THEN FO.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER' THEN FO.SUB_BROKER
				WHEN @STATUSID = 'TRADER' THEN FO.TRADER
				WHEN @STATUSID = 'FAMILY' THEN FO.FAMILY
				WHEN @STATUSID = 'AREA' THEN AREA
				WHEN @STATUSID = 'REGION' THEN REGION
				WHEN @STATUSID = 'CLIENT' THEN FO.PARTY_CODE
				ELSE 
			'BROKER'
			END)      
	ORDER BY 1,2
END
ELSE
BEGIN
	SELECT
		CLIENT2.PARTY_CODE,
		PARTY_NAME = CLIENT1.LONG_NAME,		
		MARGIN_DATE = CONVERT(VARCHAR,MARGINDATE,103),
		BILL_AMOUNT = BILLAMOUNT ,
		LEDGER_AMOUNT = LEDGERAMOUNT ,      
		NET_CASH_AVAILABLE = BILLAMOUNT + LEDGERAMOUNT,
		COLLATERAL_AVAILABLE = CASH_COLL + NONCASH_COLL,
		REPORTED_MRG_COLLATERAL = ISNULL(F.FINALAMOUNT,0),
		INITIALMARGIN = INITIALMARGIN, 
		MTMMARGIN = MTMMARGIN,
		ADDMARGIN = ADDMARGIN,
		FREE_COLLATERALS = ((CASH_COLL + NONCASH_COLL)- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)),
		NET_AMOUNT = ((CASH_COLL + NONCASH_COLL)- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)) +  (BILLAMOUNT + LEDGERAMOUNT),
		FREE_COLLATERALS_REPORTING = (ISNULL(F.FINALAMOUNT,(CASH_COLL + NONCASH_COLL))- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)),
		NET_AMOUNT_REPORTING = (ISNULL(F.FINALAMOUNT,(CASH_COLL + NONCASH_COLL))- (INITIALMARGIN+MTMMARGIN+ADDMARGIN)) +  (BILLAMOUNT + LEDGERAMOUNT)
	FROM
		CLIENT1 (NOLOCK) ,  CLIENT2 (NOLOCK),
		TBL_CLIENTMARGIN FO (NOLOCK)
		LEFT OUTER JOIN
		(
			SELECT EFFDATE,PARTY_CODE, FINALAMOUNT = SUM(FINALAMOUNT) FROM 
			TBL_COLLATERAL_MARGIN (NOLOCK) 
			WHERE EFFDATE BETWEEN @DATEFROM AND @DATETO + ' 23:59:00' 
			AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
			GROUP BY EFFDATE,PARTY_CODE
		) F
		ON (MARGINDATE = EFFDATE AND F.PARTY_CODE = FO.PARTY_CODE)
	WHERE
		MARGINDATE BETWEEN @DATEFROM AND @DATETO + ' 23:59:00' 
		AND FO.PARTY_CODE = CLIENT2.PARTY_CODE
		AND CLIENT1.CL_CODE = CLIENT2.CL_CODE
		AND CLIENT2.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY   
		AND @STATUSNAME = 
			(CASE 
				WHEN @STATUSID = 'BRANCH' THEN FO.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER' THEN FO.SUB_BROKER
				WHEN @STATUSID = 'TRADER' THEN FO.TRADER
				WHEN @STATUSID = 'FAMILY' THEN FO.FAMILY
				WHEN @STATUSID = 'AREA' THEN AREA
				WHEN @STATUSID = 'REGION' THEN REGION
				WHEN @STATUSID = 'CLIENT' THEN FO.PARTY_CODE
				ELSE 
			'BROKER'
			END)      
	ORDER BY 1,2
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_MARGIN_RPT_COLLATERAL
-- --------------------------------------------------



/*
EXEC CLS_MARGIN_RPT_COLLATERAL '18/04/2013','A001','COLL'
CLS_MARGIN_RPT_COLLATERAL EXEC '02/02/2009','0A1411','MRG'
*/

CREATE  PROC [DBO].[CLS_MARGIN_RPT_COLLATERAL]
(
	@MARGINDATE VARCHAR(11),
	@PARTYCODE VARCHAR (20), 
	@REPORT_FOR VARCHAR(10)
)  AS


/*
	@REPORT_FOR : COLL - COLLATEAL ACTUAL  / MRG - MARGIN REPORTED
*/

SET @MARGINDATE = LEFT(CONVERT(DATETIME,@MARGINDATE,103),11)


IF @REPORT_FOR ='COLL'
BEGIN

	SELECT 
		PARTICULARS = CASE WHEN CASH_NCASH = 'N' THEN SCRIP_CD + '-' + SERIES ELSE 'FD/BG -' + FD_BG_NO END,
		RATE  = CL_RATE,QTY ,HAIRCUT,
		CASH = CASE WHEN CASH_NCASH <> 'N' THEN FINALAMOUNT ELSE 0 END,
		NONCASH = CASE WHEN CASH_NCASH = 'N' THEN FINALAMOUNT ELSE 0 END,
		RPT_TYPE=1
	FROM MSAJAG..COLLATERALDETAILS WITH(NOLOCK)
	WHERE EFFDATE = @MARGINDATE
	AND EXCHANGE = (SELECT  TOP 1 EXCHANGE FROM FOGLOBALS (NOLOCK))
	AND SEGMENT = 'FUTURES'	
	AND PARTY_CODE = @PARTYCODE	
	

	UNION ALL

	SELECT 
		PARTICULARS = 'TOTAL :',
		RATE = 0,QTY=ISNULL(SUM(QTY),0) ,HAIRCUT=0,
		CASH = ISNULL(SUM(CASE WHEN CASH_NCASH <> 'N' THEN FINALAMOUNT ELSE 0 END),0),
		NONCASH = ISNULL(SUM(CASE WHEN CASH_NCASH = 'N' THEN FINALAMOUNT ELSE 0 END),0),
		RPT_TYPE=2
	FROM MSAJAG..COLLATERALDETAILS WITH(NOLOCK)
	WHERE EFFDATE = @MARGINDATE
	AND EXCHANGE = (SELECT  TOP 1 EXCHANGE FROM FOGLOBALS (NOLOCK))
	AND SEGMENT = 'FUTURES'	
	AND PARTY_CODE = @PARTYCODE
	
	ORDER BY RPT_TYPE , PARTICULARS,5 DESC
	
END

ELSE
BEGIN

	SELECT 
		PARTICULARS = CASE WHEN CASH_NCASH = 'N' THEN SCRIP_CD + '-' + SERIES ELSE 'FD/BG -' + FD_BG_NO END,
		RATE  = CL_RATE,QTY ,HAIRCUT,
		CASH = CASE WHEN CASH_NCASH <> 'N' THEN FINALAMOUNT ELSE 0 END,
		NONCASH = CASE WHEN CASH_NCASH = 'N' THEN FINALAMOUNT ELSE 0 END,
		RPT_TYPE=1
	FROM TBL_COLLATERAL_MARGIN WITH(NOLOCK)
	WHERE EFFDATE = @MARGINDATE

	AND PARTY_CODE = @PARTYCODE

	UNION ALL

	SELECT 
		PARTICULARS = 'TOTAL :',
		RATE = 0,QTY=ISNULL(SUM(QTY),0) ,HAIRCUT=0,
		CASH = ISNULL(SUM(CASE WHEN CASH_NCASH <> 'N' THEN FINALAMOUNT ELSE 0 END),0),
		NONCASH = ISNULL(SUM(CASE WHEN CASH_NCASH = 'N' THEN FINALAMOUNT ELSE 0 END),0),
		RPT_TYPE=2
	FROM TBL_COLLATERAL_MARGIN WITH(NOLOCK)
	WHERE EFFDATE = @MARGINDATE
	AND PARTY_CODE = @PARTYCODE
	
	ORDER BY RPT_TYPE ,PARTICULARS, 5 DESC

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_NETPOSITION_RPT
-- --------------------------------------------------

/*
EXEC CLS_NETPOSITION_RPT '01/01/2000','10/10/2014','','','','','BROKER','BROKER',1,'PARTY','','','',0,'STRIKE'
EXEC CLS_NETPOSITION_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',2,'PARTY','','','',0,'STRIKE'
EXEC CLS_NETPOSITION_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',3,'PARTY','','','',0,'STRIKE'

EXEC CLS_NETPOSITION_RPT '26/09/2014','26/09/2014','10100044','10100044','','','BROKER','BROKER',1,'SCRIP','','','',0,'STRIKE'
EXEC CLS_NETPOSITION_RPT '26/09/2014','26/09/2014','10100044','10100044','','','BROKER','BROKER',2,'SCRIP','','','',0,'STRIKE'
EXEC CLS_NETPOSITION_RPT '26/09/2014','26/09/2014','10100044','10100044','','','BROKER','BROKER',3,'SCRIP','','','',0,'BOTH'
*/

CREATE PROC [DBO].[CLS_NETPOSITION_RPT]
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@FROMPARTY VARCHAR(20),
	@TOPARTY VARCHAR (20), 
	@FROMSCRIP VARCHAR(20),
	@TOSCRIP VARCHAR (20), 	
	@STATUSID VARCHAR(15),  
	@STATUSNAME VARCHAR(25),
	@REPORTTYPE INT=1,
	@REPORT_BY VARCHAR(10)='PARTY',
	@INST_TYPE VARCHAR(7) ='',
	@EXPIRYDATE VARCHAR(11) ='',
	@OPTION_TYPE VARCHAR(2) ='',
	@STRIKE_PRICE MONEY = 0,
	@REPORTBY VARCHAR(10) = 'PRICE'
	
)  AS


/*
	@REPORTTYPE = 1 : PARTY / SCRIP WISE SUMMARY
	@REPORTTYPE = 2 : PARTY + SCRIP / SCRIP + PARTY
	@REPORTTYPE = 3 : PARTY + SCRIP + SAUDA_DATE / SCRIP + PARTY + SAUDA_DATE 
	
	@REPORT_BY : PARTY / SCRIP

*/

SET @DATEFROM = LEFT(CONVERT(DATETIME,@DATEFROM,103),11)
SET @DATETO = LEFT(CONVERT(DATETIME,@DATETO,103),11)


IF @TOPARTY =''
SET @TOPARTY ='ZZZZZZZ'

IF @TOSCRIP =''
SET @TOSCRIP ='ZZZZZZZ'

SELECT 
	SAUDA_DATE= CONVERT(VARCHAR,SAUDA_DATE,103),
	PARTY_CODE, PARTY_NAME = MAX(LEFT(PARTY_NAME,20)),
	SYMBOL, 
	INST_TYPE, 
	EXPIRYDATE = CONVERT(VARCHAR,EXPIRYDATE,103), STRIKE_PRICE, OPTION_TYPE, 
	PQTY = SUM(PQTY),
	SQTY = SUM(SQTY),	
	PAMT = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN SUM(PRATE*PQTY)
		WHEN @REPORTBY = 'STRIKE'	THEN SUM(CASE WHEN LEFT(INST_TYPE,3)='OPT' THEN (STRIKE_PRICE*PQTY) ELSE (PRATE*PQTY) END)
		WHEN @REPORTBY = 'BOTH'		THEN SUM((STRIKE_PRICE+PRATE)*PQTY)
		WHEN @REPORTBY = 'EXCHG'	THEN SUM((STRIKE_PRICE+PRATE)*PQTY)
		ELSE SUM(PRATE*PQTY)
	END), 
	SAMT = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN SUM(SRATE*SQTY)
		WHEN @REPORTBY = 'STRIKE'	THEN SUM(CASE WHEN LEFT(INST_TYPE,3)='OPT' THEN (STRIKE_PRICE*SQTY) ELSE (SRATE*SQTY) END)
		WHEN @REPORTBY = 'BOTH'		THEN SUM((STRIKE_PRICE+SRATE)*SQTY)
		WHEN @REPORTBY = 'EXCHG'	THEN SUM((STRIKE_PRICE+SRATE)*SQTY)
		ELSE SUM(SRATE*SQTY)
	END), 
	NETQTY = SUM(PQTY) - SUM(SQTY), 
	NETVALUE = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN (SUM(PRATE*PQTY)-SUM(SRATE*SQTY))
		WHEN @REPORTBY = 'STRIKE'	THEN (SUM(CASE WHEN LEFT(INST_TYPE,3)='OPT' THEN (STRIKE_PRICE*PQTY) ELSE (PRATE*PQTY) END)-SUM(CASE WHEN LEFT(INST_TYPE,3)='OPT' THEN (STRIKE_PRICE*SQTY) ELSE (SRATE*SQTY) END))
		WHEN @REPORTBY = 'BOTH'		THEN (SUM((STRIKE_PRICE+PRATE)*PQTY)-SUM((STRIKE_PRICE+SRATE)*SQTY))
		WHEN @REPORTBY = 'EXCHG'	THEN (SUM((STRIKE_PRICE+PRATE)*PQTY)-SUM((STRIKE_PRICE+SRATE)*SQTY))
		ELSE (SUM(PRATE*PQTY)-SUM(SRATE*SQTY))
	END),
	AVGPRICE = (CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 THEN SUM(((PQTY*PRATE) - (SQTY*SRATE)) )/ (SUM(PQTY) - SUM(SQTY)) ELSE 0 END),  
	NETOPENVALUE = SUM((PQTY - SQTY)*CL_RATE),
	CLOSEPRICE = (CASE WHEN SUM(PQTY+SQTY) <> 0 THEN  ABS(SUM((PQTY + SQTY)*CL_RATE) / SUM(PQTY + SQTY)) ELSE 0 END ),
	PAMT_NEW = SUM(PRATE*PQTY),
	SAMT_NEW = SUM(SRATE*SQTY)
INTO #NETPOSITION
FROM FOBILLVALAN (NOLOCK), FOOWNER (NOLOCK)
WHERE
	SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59' 
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	AND SYMBOL BETWEEN @FROMSCRIP AND @TOSCRIP
	AND MEMBERCODE = PARTICIPANTCODE
	AND INST_TYPE = CASE WHEN @INST_TYPE = '' THEN INST_TYPE ELSE @INST_TYPE END
	AND LEFT(EXPIRYDATE,11) = CASE WHEN @EXPIRYDATE = '' THEN LEFT(EXPIRYDATE,11) ELSE LEFT(CONVERT(DATETIME,@EXPIRYDATE,103),11)  END
	AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '' THEN OPTION_TYPE ELSE @OPTION_TYPE END
	AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
	AND @STATUSNAME = 		
	(CASE
		WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE
		WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
		WHEN @STATUSID = 'TRADER' THEN TRADER
		WHEN @STATUSID = 'FAMILY' THEN FAMILY
		WHEN @STATUSID = 'AREA' THEN AREA
		WHEN @STATUSID = 'REGION' THEN REGION
		WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE 
		ELSE 'BROKER' 
	END)
GROUP BY CONVERT(VARCHAR,SAUDA_DATE,103),PARTY_CODE ,SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE  


ALTER TABLE #NETPOSITION ADD SRNO INT IDENTITY(1,1)

IF @REPORTTYPE = 1  -- SUMMARY
BEGIN
	IF @REPORT_BY = 'PARTY'
	BEGIN

		SELECT 
		PARTY_CODE AS CLIENT_CODE,PARTY_NAME AS CLIENT_NAME,
		SYMBOL = '',INST_TYPE= '',EXPIRYDATE= '',STRIKE_PRICE= '',OPTION_TYPE= '',
		PQTY = SUM(PQTY ),SQTY = SUM(SQTY),
		PAMT = CONVERT(NUMERIC(18,2),SUM(PAMT)),
		SAMT = CONVERT(NUMERIC(18,2),SUM(SAMT)),
		NETQTY = SUM(NETQTY),
		NETVALUE = CONVERT(NUMERIC(18,2),SUM(NETVALUE)),
		AVGPRICE = 0,
		NETOPENVALUE = CONVERT(NUMERIC(18,2),SUM(NETOPENVALUE)),
		CLOSEPRICE = 0
		FROM
		(
			SELECT 
			PARTY_CODE ,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
			PQTY = SUM(PQTY ),SQTY = SUM(SQTY),
			PAMT = SUM(PAMT),
			SAMT = SUM(SAMT),
			NETQTY = SUM(NETQTY),
			NETVALUE = SUM(NETVALUE),
			NETOPENVALUE = SUM(NETOPENVALUE),
			PAMT_NEW = SUM(PAMT_NEW),
			SAMT_NEW = SUM(SAMT_NEW)
			FROM #NETPOSITION
			GROUP BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
			HAVING SUM(PQTY-SQTY)<>0
		) A
		GROUP BY PARTY_CODE,PARTY_NAME
		ORDER BY PARTY_CODE,PARTY_NAME
	
		
	END
	ELSE
	BEGIN
		
		
		SELECT 
		SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
		PQTY = SUM(PQTY ),SQTY = SUM(SQTY),
		PAMT = CONVERT(NUMERIC(18,2),SUM(PAMT)),
		SAMT = CONVERT(NUMERIC(18,2),SUM(SAMT)),NETQTY = SUM(NETQTY),
		NETVALUE = CONVERT(NUMERIC(18,2),SUM(NETVALUE)),
		AVGPRICE = CONVERT(NUMERIC(18,2),CASE WHEN SUM(PAMT_NEW)>SUM(SAMT_NEW) THEN SUM(PAMT_NEW)/SUM(PQTY) ELSE CASE WHEN SUM(SQTY)>0 THEN SUM(SAMT_NEW)/SUM(SQTY) ELSE 0 END END),
		NETOPENVALUE = CONVERT(NUMERIC(18,2),SUM(NETOPENVALUE)),
		CLOSEPRICE = CONVERT(NUMERIC(18,2),CLOSEPRICE)
		FROM
		(
			SELECT 
			PARTY_CODE ,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
			PQTY = SUM(PQTY ),SQTY = SUM(SQTY),PAMT = SUM(PAMT),
			SAMT = SUM(SAMT),NETQTY = SUM(NETQTY),
			NETVALUE = SUM(NETVALUE),
			NETOPENVALUE = SUM(NETOPENVALUE),
			PAMT_NEW = SUM(PAMT_NEW),
			SAMT_NEW = SUM(SAMT_NEW),
			CLOSEPRICE
			FROM #NETPOSITION
			GROUP BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CLOSEPRICE
		HAVING SUM(PQTY-SQTY)<>0
		) A
		GROUP BY INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CLOSEPRICE
		ORDER BY SYMBOL,INST_TYPE,CONVERT(DATETIME,EXPIRYDATE,103),STRIKE_PRICE,OPTION_TYPE
	
	END
END

IF @REPORTTYPE = 2  -- DETAILS
BEGIN
		
		SELECT 
		--SRNO = MAX(SRNO),
		PARTY_CODE AS CLIENT_CODE,PARTY_NAME AS CLIENT_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
		PQTY = SUM(PQTY ),SQTY = SUM(SQTY),
		PAMT = CONVERT(NUMERIC(18,4),SUM(PAMT)),
		SAMT = CONVERT(NUMERIC(18,4),SUM(SAMT)),NETQTY = SUM(NETQTY),
		NETVALUE = CONVERT(NUMERIC(18,4),SUM(NETVALUE)),
		AVGPRICE = CONVERT(NUMERIC(18,2),CASE WHEN SUM(PAMT_NEW)>SUM(SAMT_NEW) THEN SUM(PAMT_NEW)/SUM(PQTY) ELSE CASE WHEN SUM(SQTY)>0 THEN SUM(SAMT_NEW)/SUM(SQTY) ELSE 0 END END),
		NETOPENVALUE = CONVERT(NUMERIC(18,4),SUM(NETOPENVALUE)),
		CLOSEPRICE = CONVERT(NUMERIC(18,2),CASE WHEN @DATEFROM = @DATETO THEN CLOSEPRICE ELSE 0 END)
		FROM #NETPOSITION
		GROUP BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CASE WHEN @DATEFROM = @DATETO THEN CLOSEPRICE ELSE 0 END
		HAVING SUM(PQTY-SQTY)<>0
		ORDER BY (CASE WHEN @REPORT_BY = 'PARTY' THEN PARTY_CODE ELSE SYMBOL END),(CASE WHEN @REPORT_BY = 'PARTY' THEN SYMBOL ELSE PARTY_CODE END),INST_TYPE,CONVERT(DATETIME,EXPIRYDATE,103),STRIKE_PRICE,OPTION_TYPE
END

IF @REPORTTYPE = 3  -- FURTHER DETAILS
BEGIN
		SELECT 
		--SRNO = MAX(SRNO),
		SAUDA_DATE,PARTY_CODE AS CLIENT_CODE ,PARTY_NAME AS CLIENT_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
		PQTY = SUM(PQTY ),SQTY = SUM(SQTY),
		PAMT = CONVERT(NUMERIC(18,4),SUM(PAMT)),
		SAMT = CONVERT(NUMERIC(18,4),SUM(SAMT)),NETQTY = SUM(NETQTY),
		NETVALUE = CONVERT(NUMERIC(18,4),SUM(NETVALUE)),
		AVGPRICE = CONVERT(NUMERIC(18,2),CASE WHEN SUM(PAMT_NEW)>SUM(SAMT_NEW) THEN SUM(PAMT_NEW)/SUM(PQTY) ELSE CASE WHEN SUM(SQTY)>0 THEN SUM(SAMT_NEW)/SUM(SQTY) ELSE 0 END END),
		NETOPENVALUE = CONVERT(NUMERIC(18,4),SUM(NETOPENVALUE)),
		CLOSEPRICE = CONVERT(NUMERIC(18,2),CLOSEPRICE)
		FROM #NETPOSITION
		GROUP BY SAUDA_DATE,PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CLOSEPRICE
		HAVING SUM(PQTY-SQTY)<>0
		ORDER BY (CASE WHEN @REPORT_BY = 'PARTY' THEN PARTY_CODE ELSE SYMBOL END),(CASE WHEN @REPORT_BY = 'PARTY' THEN SYMBOL ELSE PARTY_CODE END),CONVERT(DATETIME,SAUDA_DATE,103)
END


DROP TABLE #NETPOSITION

/*------------------------------------------ END OF THE PROC -----------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PARTYDETAILS_RPT
-- --------------------------------------------------


-- EXEC CLS_PARTYDETAILS_RPT '0A141'

CREATE PROCEDURE [DBO].[CLS_PARTYDETAILS_RPT]     
(    
	@PARTYCODE AS VARCHAR(20)    
)       
AS  
   
/*
	RECORD SET 1 - BASIC INFO
	RECORD SET 2 - TRD & DEL BROK FOR EQ / FUT & OPT FOR F&O
	RECORD SET 3 - TRD & DEL VBB BROK EQ / FUT & OPT FOR F&O
	RECORD SET 4 - DP DETAILS - PAYIN A/C 
	RECORD SET 5 - DP DETAILS - PAYOUT A/C 
	
*/
    

------------------------------------------------------------------------------------------------------------------------------
DECLARE @SEGMENT VARCHAR(20)
SELECT TOP 1 @SEGMENT= SEGMENT FROM PRADNYA.DBO.MULTICOMPANY  WITH(NOLOCK) WHERE SHAREDB = DB_NAME()

IF @SEGMENT = 'CAPITAL'
BEGIN

	    
	SELECT 
		CL2.PARTY_CODE,
		CL1.LONG_NAME,CL1.SHORT_NAME,CL1.L_ADDRESS1,CL1.L_ADDRESS2, CL1.L_ADDRESS3,     
		CL1.L_CITY,CL1.L_STATE,CL1.L_NATION,CL1.L_ZIP,CL1.FAX,CL1.RES_PHONE1, RES_PHONE2, OFF_PHONE1, OFF_PHONE2, CL1.EMAIL,      
		CL1.BRANCH_CD,CL1.CL_TYPE,CL1.CL_STATUS,CL1.FAMILY,CL1.SUB_BROKER,CL1.MOBILE_PAGER,CL1.PAN_GIR_NO,CL1.TRADER,      
		S1.NAME,B1.BRANCH,    
		
		TURNOVER_TAX =  (CASE WHEN ISNULL(CT.TURNOVER_TAX,CL2.TURNOVER_TAX)=0 THEN 'N' ELSE 'Y' END),
		SEBI_TURN_TAX =  (CASE WHEN ISNULL(CT.SEBITURN_TAX,CL2.SEBI_TURN_TAX)=0 THEN 'N' ELSE 'Y' END),
		STT_CHARGES  =  (CASE WHEN ISNULL(CT.INSURANCE_CHRG,CL2.INSURANCE_CHRG)=0 THEN 'N' ELSE 'Y' END),
		OTHER_CHRG  =  (CASE WHEN ISNULL(CT.OTHER_CHRG,CL2.OTHER_CHRG)=0 THEN 'N' ELSE 'Y' END),
		STAMP_DUTY  =  (CASE WHEN ISNULL(CT.BROKER_NOTE,CL2.BROKERNOTE)=0 THEN 'N' ELSE 'Y' END),
		
		ROUNDING_STYLE
			 = CASE WHEN CT.PARTY_CODE IS NULL THEN '' ELSE CONVERT(VARCHAR,ROUND_TO) + ' DECIMAL ' + 
				( CASE WHEN ( ROFIG =0 AND ERRNUM=0.5 AND NOZERO=1) THEN 'ACTUAL'  ELSE 
				( CASE WHEN ( ROFIG =1 AND ERRNUM < 0 AND ERRNUM <> -2.5 AND  NOZERO=0) THEN 'NEXT 1P' ELSE 
				( CASE WHEN ( ROFIG =5 AND ERRNUM < 0 AND ERRNUM <> -2.5 AND  NOZERO=0) THEN 'NEXT 5P' ELSE 
				( CASE WHEN ( ROFIG =-1 AND ERRNUM > 0 AND ERRNUM <> 2.5 AND  NOZERO=0) THEN 'PREV 1P' ELSE 
				( CASE WHEN ( ROFIG =-5 AND ERRNUM > 0 AND ERRNUM <> 2.5 AND  NOZERO=0) THEN 'PREV 5P' ELSE 
				( CASE WHEN ( ROFIG =5  AND  ERRNUM=-2.5 AND  NOZERO=0) THEN 'BANKERS'  END )END )END )END )END )END )
			END,
				
		SERVICE_CHRG = (CASE WHEN CL2.SERVICE_CHRG=0 THEN 'EXCLUSIVE'      
						WHEN CL2.SERVICE_CHRG=1 THEN 'INCL IN BROK'      
						WHEN CL2.SERVICE_CHRG=2 THEN 'INCLUSIVE'      
						END),      

		BROK_SCHEME = (CASE WHEN CL2.BROK_SCHEME=0 THEN 'DEFAULT'      
							WHEN CL2.BROK_SCHEME=1 THEN 'MAX LOGIC (F/S) - BUY SIDE'      
							WHEN CL2.BROK_SCHEME=2 THEN 'MAX RATE'    
							WHEN CL2.BROK_SCHEME=3 THEN 'MAX LOGIC (F/S) - SELL SIDE'      
							WHEN CL2.BROK_SCHEME=4 THEN 'FLAT BROKERAGE DEFAULT'      
							WHEN CL2.BROK_SCHEME=5 THEN 'FLAT BROKERAGE (MAX LOGIC) - BUY SIDE'      
							WHEN CL2.BROK_SCHEME=6 THEN 'FLAT BROKERAGE (MAX LOGIC) - SELL SIDE'      
							END) ,
		CONTRACT_STYLE = (CASE WHEN CL2.INSCONT='S' THEN 'SCRIPWISE'      
							WHEN CL2.INSCONT='O' THEN 'ORDERWISE'      
							ELSE 'NORMAL' END) ,
		PARTICIPANT = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.BANKID   ELSE  '' END) ,
		CUSTODIAN = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.CLTDPNO ELSE  '' END) ,
		CONTRACT_PRINT = (CASE WHEN CL2.PRINTF=0 THEN 'PRINT' ELSE 'DONT PRINT' END) ,        
		PRINTING  = (CASE WHEN CL2.PRINTF =0 THEN 'DETAIL BILL AND CONTRACT'      
					WHEN CL2.PRINTF =1 THEN 'DONT PRINT BILL AND CONTRACT'      
					WHEN CL2.PRINTF =2 THEN 'SUMMARISED CONTRACT AND DETAIL BILL'      
					WHEN CL2.PRINTF =3 THEN 'SUMMARISED BILL AND DETAIL CONTRACT'      
					WHEN CL2.PRINTF =4 THEN 'BOTH SUMMARISED'      
					END) ,
		ACTIVEFROM= CONVERT(VARCHAR,C5.ACTIVEFROM,103),
		INACTIVEFROM= CONVERT(VARCHAR,C5.INACTIVEFROM,103),  
		C5.INTRODUCER,
		PAYLOCATION = CL1.GL_CODE,
		SEBI_NO = FD_CODE,
		MAPINID = ISNULL(MAPIDID,''),
		UCC_CODE = ISNULL(UCC_CODE,''),
		BIRTHDATE = (CASE WHEN LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) = 'JAN  1 1900' THEN '' ELSE LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) END),
		BROK_ROUNDING_STYLE = 'MARKETRATE: ' + CONVERT(VARCHAR,ISNULL(MARKETRATE,'')) +', BROKERAGE: '+ CONVERT(VARCHAR,ISNULL(BROKERAGE,'')) +' NETRATE: '+ CONVERT(VARCHAR,ISNULL(NETRATE,''))  
	FROM CLIENT2 CL2 (NOLOCK)
		LEFT OUTER JOIN MSAJAG.DBO.UCC_CLIENT UC WITH (NOLOCK) ON (CL2.PARTY_CODE = UC.PARTY_CODE)
		LEFT OUTER JOIN CLIENTTAXES_NEW CT (NOLOCK) ON (CT.PARTY_CODE = CL2.PARTY_CODE AND GETDATE() BETWEEN FROMDATE AND TODATE
														AND TRANS_CAT = 'TRD' )
		LEFT OUTER JOIN INSTCLIENT_TBL I (NOLOCK) ON (I.PARTYCODE = CL2.PARTY_CODE),  
		CLIENT1 CL1,
		CLIENT5 C5 (NOLOCK),    
		SUBBROKERS S1 (NOLOCK),
		BRANCH B1 (NOLOCK)
	WHERE CL1.CL_CODE = CL2.CL_CODE      
	AND C5.CL_CODE = CL1.CL_CODE
	AND S1.SUB_BROKER = CL1.SUB_BROKER      
	AND CL2.PARTY_CODE = @PARTYCODE    
	AND B1.BRANCH_CODE = CL1.BRANCH_CD    
	  
	--------------------------------------------------------------------------------------------------------------------------------------------------
	SELECT 
		BROKERAGE = 'TRADING BROKERAGE',
		TABLE_NAME,SRNO,VALUE,DAY_BUY,DAY_SELL,SETT_BUY,SETT_SELL,DELIVERY
	FROM
	(
		SELECT TABLE_NO FROM CLIENTBROK_SCHEME (NOLOCK)
		WHERE PARTY_CODE = @PARTYCODE AND TRADE_TYPE = 'NRM' AND SCHEME_TYPE = 'TRD' AND GETDATE() BETWEEN FROM_DATE AND TO_DATE
	) A, CLS_BROKTABLE_VIEW B
	WHERE A.TABLE_NO = B.TABLE_NO

	UNION ALL

	SELECT 
		BROKERAGE = 'DELIVERY BROKERAGE',
		TABLE_NAME,SRNO,VALUE,DAY_BUY,DAY_SELL,SETT_BUY,SETT_SELL,DELIVERY
	FROM
	(
		SELECT TABLE_NO FROM CLIENTBROK_SCHEME (NOLOCK)
		WHERE PARTY_CODE = @PARTYCODE AND TRADE_TYPE = 'NRM' AND SCHEME_TYPE = 'DEL' AND GETDATE() BETWEEN FROM_DATE AND TO_DATE
	) A, CLS_BROKTABLE_VIEW B
	WHERE A.TABLE_NO = B.TABLE_NO

	ORDER BY 1,2,3
END
ELSE
BEGIN


	    
	SELECT 
		CL2.PARTY_CODE,
		CL1.LONG_NAME,CL1.SHORT_NAME,CL1.L_ADDRESS1,CL1.L_ADDRESS2, CL1.L_ADDRESS3,     
		CL1.L_CITY,CL1.L_STATE,CL1.L_NATION,CL1.L_ZIP,CL1.FAX,CL1.RES_PHONE1, RES_PHONE2, OFF_PHONE1, OFF_PHONE2, CL1.EMAIL,      
		CL1.BRANCH_CD,CL1.CL_TYPE,CL1.CL_STATUS,CL1.FAMILY,CL1.SUB_BROKER,CL1.MOBILE_PAGER,CL1.PAN_GIR_NO,CL1.TRADER,      
		S1.NAME,B1.BRANCH,    
		
		TURNOVER_TAX =  (CASE WHEN ISNULL(CT.FUT_TURNOVER_TAX,CL2.TURNOVER_TAX)=0 THEN 'N' ELSE 'Y' END),
		SEBI_TURN_TAX =  (CASE WHEN ISNULL(CT.FUT_SEBITURN_TAX,CL2.SEBI_TURN_TAX)=0 THEN 'N' ELSE 'Y' END),
		STT_CHARGES  =  (CASE WHEN ISNULL(CT.FUT_INSURANCE_CHRG,CL2.INSURANCE_CHRG)=0 THEN 'N' ELSE 'Y' END),
		OTHER_CHRG  =  (CASE WHEN ISNULL(CT.FUT_OTHER_CHRG,CL2.OTHER_CHRG)=0 THEN 'N' ELSE 'Y' END),
		STAMP_DUTY  =  (CASE WHEN ISNULL(CT.FUT_BROKER_NOTE,CL2.BROKERNOTE)=0 THEN 'N' ELSE 'Y' END),
		
		ROUNDING_STYLE
			 = CASE WHEN CT.PARTY_CODE IS NULL THEN '' ELSE CONVERT(VARCHAR,ROUND_TO) + ' DECIMAL ' + 
				( CASE WHEN ( ROFIG =0 AND ERRNUM=0.5 AND NOZERO=1) THEN 'ACTUAL'  ELSE 
				( CASE WHEN ( ROFIG =1 AND ERRNUM < 0 AND ERRNUM <> -2.5 AND  NOZERO=0) THEN 'NEXT 1P' ELSE 
				( CASE WHEN ( ROFIG =5 AND ERRNUM < 0 AND ERRNUM <> -2.5 AND  NOZERO=0) THEN 'NEXT 5P' ELSE 
				( CASE WHEN ( ROFIG =-1 AND ERRNUM > 0 AND ERRNUM <> 2.5 AND  NOZERO=0) THEN 'PREV 1P' ELSE 
				( CASE WHEN ( ROFIG =-5 AND ERRNUM > 0 AND ERRNUM <> 2.5 AND  NOZERO=0) THEN 'PREV 5P' ELSE 
				( CASE WHEN ( ROFIG =5  AND  ERRNUM=-2.5 AND  NOZERO=0) THEN 'BANKERS'  END )END )END )END )END )END )
			END,
				
		SERVICE_CHRG = (CASE WHEN CL2.SERVICE_CHRG=0 THEN 'EXCLUSIVE'      
						WHEN CL2.SERVICE_CHRG=1 THEN 'INCL IN BROK'      
						WHEN CL2.SERVICE_CHRG=2 THEN 'INCLUSIVE'      
						END),      

		BROK_SCHEME = (CASE WHEN CL2.BROK_SCHEME=0 THEN 'DEFAULT'      
							WHEN CL2.BROK_SCHEME=1 THEN 'MAX LOGIC (F/S) - BUY SIDE'      
							WHEN CL2.BROK_SCHEME=2 THEN 'MAX RATE'    
							WHEN CL2.BROK_SCHEME=3 THEN 'MAX LOGIC (F/S) - SELL SIDE'      
							WHEN CL2.BROK_SCHEME=4 THEN 'FLAT BROKERAGE DEFAULT'      
							WHEN CL2.BROK_SCHEME=5 THEN 'FLAT BROKERAGE (MAX LOGIC) - BUY SIDE'      
							WHEN CL2.BROK_SCHEME=6 THEN 'FLAT BROKERAGE (MAX LOGIC) - SELL SIDE'      
							END) ,
		CONTRACT_STYLE = (CASE WHEN CL2.INSCONT='S' THEN 'SCRIPWISE'      
							WHEN CL2.INSCONT='O' THEN 'ORDERWISE'      
							ELSE 'NORMAL' END) ,
		PARTICIPANT = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.BANKID   ELSE  '' END) ,
		CUSTODIAN = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.CLTDPNO ELSE  '' END) ,
		CONTRACT_PRINT = (CASE WHEN CL2.PRINTF=0 THEN 'PRINT' ELSE 'DONT PRINT' END) ,        
		PRINTING  = (CASE WHEN CL2.PRINTF =0 THEN 'DETAIL BILL AND CONTRACT'      
					WHEN CL2.PRINTF =1 THEN 'DONT PRINT BILL AND CONTRACT'      
					WHEN CL2.PRINTF =2 THEN 'SUMMARISED CONTRACT AND DETAIL BILL'      
					WHEN CL2.PRINTF =3 THEN 'SUMMARISED BILL AND DETAIL CONTRACT'      
					WHEN CL2.PRINTF =4 THEN 'BOTH SUMMARISED'      
					END) ,
		ACTIVEFROM= CONVERT(VARCHAR,C5.ACTIVEFROM,103),
		INACTIVEFROM= CONVERT(VARCHAR,C5.INACTIVEFROM,103),  
		C5.INTRODUCER,
		PAYLOCATION = CL1.GL_CODE,
		SEBI_NO = FD_CODE,
		MAPINID = ISNULL(MAPIDID,''),
		UCC_CODE = ISNULL(UCC_CODE,''),
		BIRTHDATE = (CASE WHEN LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) = 'JAN  1 1900' THEN '' ELSE LEFT(CONVERT(VARCHAR,C5.BIRTHDATE,109),11) END),
		BROK_ROUNDING_STYLE = 'MARKETRATE: ' + CONVERT(VARCHAR,ISNULL(MARKETRATE,'')) +', BROKERAGE: '+ CONVERT(VARCHAR,ISNULL(BROKERAGE,'')) +' NETRATE: '+ CONVERT(VARCHAR,ISNULL(NETRATE,''))  
	FROM CLIENT2 CL2 (NOLOCK)
		LEFT OUTER JOIN MSAJAG.DBO.UCC_CLIENT UC WITH (NOLOCK) ON (CL2.PARTY_CODE = UC.PARTY_CODE)
		LEFT OUTER JOIN FOCLIENTTAXES CT (NOLOCK) ON (CT.PARTY_CODE = CL2.PARTY_CODE AND GETDATE() BETWEEN DATE_FROM AND DATE_TO)
		LEFT OUTER JOIN INSTCLIENT_TBL I (NOLOCK) ON (I.PARTYCODE = CL2.PARTY_CODE),  
		CLIENT1 CL1,
		CLIENT5 C5 (NOLOCK),    
		SUBBROKERS S1 (NOLOCK),
		BRANCH B1 (NOLOCK)
	WHERE CL1.CL_CODE = CL2.CL_CODE      
	AND C5.CL_CODE = CL1.CL_CODE
	AND S1.SUB_BROKER = CL1.SUB_BROKER      
	AND CL2.PARTY_CODE = @PARTYCODE    
	AND B1.BRANCH_CODE = CL1.BRANCH_CD    
	  	
	---------------------------------------------------------------------------------------------------------------------------------
	SELECT 
		BROKERAGE = 'FUTURE BROKERAGE',
		TABLE_NAME,SRNO,VALUE,DAY_BUY,DAY_SELL,SETT_BUY,SETT_SELL,DELIVERY
	FROM
	(
		SELECT TABLE_NO=FUT_BROKTABLE FROM FOCLIENTBROKSCHEME (NOLOCK)
		WHERE PARTY_CODE = @PARTYCODE AND GETDATE() BETWEEN DATE_FROM AND DATE_TO
	) A, CLS_BROKTABLE_VIEW B
	WHERE A.TABLE_NO = B.TABLE_NO

	UNION ALL

	SELECT 
		BROKERAGE = 'OPTION BROKERAGE',
		TABLE_NAME,SRNO,VALUE,DAY_BUY,DAY_SELL,SETT_BUY,SETT_SELL,DELIVERY
	FROM
	(
		SELECT TABLE_NO=OPT_BROKTABLE FROM FOCLIENTBROKSCHEME (NOLOCK)
		WHERE PARTY_CODE = @PARTYCODE AND GETDATE() BETWEEN DATE_FROM AND DATE_TO
	) A, CLS_BROKTABLE_VIEW B
	WHERE A.TABLE_NO = B.TABLE_NO

	ORDER BY 1,2,3

END

--------------------------------------------------------------------------------------------------------------------------------
SELECT 
	BROKERAGE = CASE 
			WHEN SP_TRD_TYPE='TRD' THEN 'TRADING' 
			WHEN SP_TRD_TYPE='DEL' THEN 'DELIVERY' 
			END + 
			CASE WHEN @SEGMENT = 'CAPITAL' THEN '' ELSE '' END
			+' VOLUME BASED BROKERAGE' ,
	SCHEMEDT = LEFT(SP_DATE_FROM,11) + ' -  ' + LEFT(SP_DATE_TO,11),
	SCHEMEID = SP_SCHEME_ID,
	SCHEMEDESC = ISNULL(SM_SCHEME_DESC,''),
	SCHEMETYPE = CASE 
			WHEN SP_TRD_TYPE='TRD' THEN 'NORMAL TRADE' 
			WHEN SP_TRD_TYPE='DEL' THEN 'DELIVERY TRADE' 
			END,
	SYMBOL = SP_SCRIP , 
	COMPUTATIONTYPE = CASE SP_BROK_COMPUTETYPE WHEN  'I' THEN 'INCREMENTAL' ELSE 'VARIABLE' END,
	BROKCOMPUTEON = CASE WHEN SP_BROK_COMPUTEON ='T' THEN 'TURNOVER' ELSE
				CASE WHEN SP_BROK_COMPUTEON ='Q' THEN 'QUANTITY' ELSE
				CASE WHEN SP_BROK_COMPUTEON ='L' THEN 'LOT SIZE' ELSE
				'VALUE OF LOT' END END END ,
	COMPUTATIONLEVEL = CASE WHEN SP_COMPUTATION_LEVEL ='T' THEN 'TRADES' ELSE
				CASE WHEN SP_COMPUTATION_LEVEL ='O' THEN 'ORDER' ELSE
				CASE WHEN SP_COMPUTATION_LEVEL ='S' THEN 'SCRIP' ELSE
					'CONTRACT' END END END,
	SCHEME = CASE WHEN SP_SCHEME_TYPE=0 THEN 'DEFAULT' ELSE
			 CASE WHEN SP_SCHEME_TYPE=1 THEN 'MAX LOGIC BS FL' ELSE 
			'MAX LOGIC SS FL' END END,
	VALUERANGE = CONVERT(VARCHAR,SP_VALUE_FROM) + ' - ' + CASE WHEN SP_VALUE_TO = -1 THEN 'UN LIMIT' ELSE
		CONVERT(VARCHAR,SP_VALUE_TO) END,
	BROK = 'BUY ' + CONVERT(VARCHAR,SP_BUY_BROK) + CASE WHEN SP_BUY_BROK_TYPE ='V' THEN ' VALUE' ELSE ' PERC' END  +
		' SELL ' + CONVERT(VARCHAR,SP_SELL_BROK) + CASE WHEN SP_SELL_BROK_TYPE ='V' THEN ' VALUE' ELSE ' PERC' END,

	SCRORD = CASE WHEN SP_SCRIP='ALL' THEN 1 ELSE 2 END,
	RCOUNT = 1
FROM SCHEME_MAPPING MP LEFT OUTER JOIN SCHEME_MASTER MS ON (SM_SCHEME_ID = SP_SCHEME_ID)
WHERE SP_PARTY_CODE = @PARTYCODE
AND GETDATE() BETWEEN SP_DATE_FROM AND SP_DATE_TO
ORDER BY 1,3,SCRORD

----------------------------------------------------------------------------------------------------------------------

SELECT 
	DP_DETAILS = 'PAY IN ACCOUNT',
	DEPOSITORY  = BANKTYPE,
	DP_ID =DPID,
	DP_NAME = BANKNAME,
	ACCOUNT_NO = CLTDPNO,
	POA_STATUS = CASE WHEN DEF = 1 THEN 'RECEIVED' ELSE 'NOT RECEIVED' END
FROM MULTICLTID M (NOLOCK),BANK B (NOLOCK)
WHERE  B.BANKID = M.DPID AND PARTY_CODE= @PARTYCODE AND M.DPTYPE = B.BANKTYPE

----------------------------------------------------------------------------------------------------------------------

SELECT 
	DP_DETAILS = 'PAY OUT ACCOUNT',
	DEPOSITORY  = BANKTYPE,
	DP_ID =B.BANKID,
	DP_NAME = BANKNAME,
	ACCOUNT_NO = CLTDPID
FROM CLIENT4 M (NOLOCK),BANK B (NOLOCK)
WHERE  B.BANKID = M.BANKID AND PARTY_CODE= @PARTYCODE AND  B.BANKTYPE = M.DEPOSITORY

----------------------------------------------------------------------------------------------------------------------

	CREATE TABLE  #MULTIBANKID
	(
		[CLTCODE] [VARCHAR](20),
		[BANKID] [VARCHAR](16),
		[ACCNO] [VARCHAR](20),
		[ACCTYPE] [VARCHAR](7)
	) 

	DECLARE @ACCOUNTDB VARCHAR(50)
	DECLARE @STRSQL VARCHAR(1000)
	
	SELECT TOP 1 @ACCOUNTDB= ACCOUNTDB FROM PRADNYA.DBO.MULTICOMPANY  WITH(NOLOCK)  WHERE SHAREDB = DB_NAME()
	
	SET @STRSQL = 'INSERT INTO #MULTIBANKID SELECT CLTCODE,BANKID,ACCNO,ACCTYPE FROM ' + @ACCOUNTDB + '.DBO.MULTIBANKID (NOLOCK) WHERE CLTCODE ='''+ @PARTYCODE +''''
	EXEC (@STRSQL)


	 SELECT 
	  BANK_DETAILS = 'BANK DETAILS',  
	  BANKNAME = ISNULL(P.BANK_NAME,''),      
	  BRANCH = ISNULL(P.BRANCH_NAME,''),      
	  ACNUM = ISNULL(C.ACCNO,''),      
	  ACTYPE = (CASE WHEN ISNULL(C.ACCTYPE,'')  = 'SAVING' OR ISNULL(C.ACCTYPE,'')  = 'SB' THEN 'SAVING'     
							   WHEN ISNULL(C.ACCTYPE,'')  = 'CURRENT' OR ISNULL(C.ACCTYPE,'')  = 'CA' THEN 'CURRENT'     
							   WHEN ISNULL(C.ACCTYPE,'')  = 'OD' THEN 'OVER DRAFT'     
							   ELSE 'OTHER'    
					  END)
	 FROM      
	  #MULTIBANKID C      
	   JOIN POBANK P (NOLOCK)      
	   ON (P.BANKID = C.BANKID)      
	 WHERE      
	  C.CLTCODE = @PARTYCODE    
	 ORDER BY       
	  BANKNAME 
	  
	  DROP TABLE #MULTIBANKID

/*--------------------------------------------------END OF THE PROC ---------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PARTYDETDAILYNEW
-- --------------------------------------------------
CREATE  PROCEDURE [DBO].[CLS_PARTYDETDAILYNEW]    
 (    
 @STATUSID VARCHAR(25),    
 @STATUSNAME VARCHAR(25),    
 @FPARTY VARCHAR(20),    
 @TPARTY VARCHAR(20),    
 @SAUDA VARCHAR(11),    
 @BRANCHCD VARCHAR(16) ='%',  
 @DIGIFLAG INT = 0  
 )    
   
 AS    
  
 IF @BRANCHCD ='' BEGIN SET @BRANCHCD ='%' END    
 IF @TPARTY ='' BEGIN SET @TPARTY ='ZZZZZZZZZZ' END 
 
 DECLARE @SAUDADATE VARCHAR(11)
 SET  @SAUDADATE=@SAUDA
 
IF LEN(@SAUDA) = 10 AND CHARINDEX('/',@SAUDA) > 0    
SET @SAUDA=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SAUDA,103),109)    
    
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
 
 SELECT     
      
  [CLIENT CODE]=C2.CL_CODE,  
  [CLIENT NAME]=C1.LONG_NAME, 
  [TRADE DATE] =  @SAUDADATE, 
  C2.EXCHANGE,    
  C2.TRAN_CAT,    
  C1.EMAIL,    
  C1.RES_PHONE1,    
  C1.SHORT_NAME,    
  C1.L_ADDRESS1,    
  C1.L_ADDRESS2,    
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_ZIP,    
  C1.FAMILY,    
  C1.BRANCH_CD,
  C2.PARTY_CODE,     
  TRADER = ISNULL(C1.TRADER,''),  
  C1.PAN_GIR_NO    
 FROM    
  CLIENT1 C1 (NOLOCK),    
  CLIENT2 C2 (NOLOCK),    
  (    
   SELECT    
    DISTINCT PARTY_CODE = FOPDD_PARTY_CODE FROM FO_POS_DETAILS_DAS (NOLOCK)    
   WHERE     
    FOPDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'    
    AND FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
    AND ((FOPDD_OPENING_PQTY+FOPDD_TODAY_PQTY)-(FOPDD_OPENING_SQTY+FOPDD_TODAY_SQTY)) <> 0  
   
   UNION  
     
   SELECT    
    DISTINCT PARTY_CODE = FOTDD_PARTY_CODE FROM FO_TRADE_DETAILS_DAS  (NOLOCK)    
   WHERE     
    FOTDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'    
    AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
  ) F,  
  CLIENT_PRINT_SETTINGS CP (NOLOCK)  
 WHERE    
  F.PARTY_CODE = C2.PARTY_CODE         
  AND C1.CL_CODE = C2.CL_CODE    
  AND C1.BRANCH_CD LIKE @BRANCHCD    
  AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY    
  AND C2.PRINTF = CP.PRINT_FLAG  
  AND CP.VALID_REPORT LIKE (CASE   
      WHEN @DIGIFLAG = 0 THEN '%'   
      WHEN @DIGIFLAG = 1 THEN '%CONTRACT%'   
      WHEN @DIGIFLAG = 2 THEN '%DIGITAL%'   
      ELSE CP.VALID_REPORT   
      END)  
  AND @STATUSNAME =(CASE     
            WHEN @STATUSID = 'BRANCH'     
            THEN C1.BRANCH_CD     
            WHEN @STATUSID = 'SUBBROKER'     
            THEN C1.SUB_BROKER     
            WHEN @STATUSID = 'TRADER'     
            THEN C1.TRADER     
            WHEN @STATUSID = 'FAMILY'     
            THEN C1.FAMILY     
            WHEN @STATUSID = 'AREA'     
            THEN C1.AREA     
            WHEN @STATUSID = 'REGION'     
            THEN C1.REGION     
            WHEN @STATUSID = 'CLIENT'     
            THEN C2.PARTY_CODE     
            ELSE 'BROKER'   
     END)  
 ORDER BY   
  C2.PARTY_CODE
   
   
  /*
 
 SELECT     
  DISTINCT  
  [CLIENT CODE] = FOTDD_PARTY_CODE,
  [CLIENT NAME] = '', 
  [TRADE DATE] = CONVERT(VARCHAR, FOTDD_SAUDA_DATE, 103),
  EXCHANGE = '',    
  TRAN_CAT = '',    
  EMAIL = '',    
  RES_PHONE1 = '',    
  SHORT_NAME = '',    
  L_ADDRESS1 = '',    
  L_ADDRESS2 = '',    
  L_ADDRESS3 = '',    
  L_CITY = '',    
  L_ZIP = '',    
  FAMILY = '',    
  BRANCH_CD = '',     
  TRADER = '',  
  PAN_GIR_NO = '',
  PARTY_CODE = FOTDD_PARTY_CODE      
 FROM    
  FO_TRADE_DETAILS_DAS (NOLOCK)  
 WHERE   
  FOTDD_SAUDA_DATE LIKE @SAUDA +'%'  
  AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
 ORDER BY   
  FOTDD_PARTY_CODE  
  
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PARTYDETDAILYNEW_SUMMARY
-- --------------------------------------------------
CREATE  PROCEDURE [DBO].[CLS_PARTYDETDAILYNEW_SUMMARY]    
 (    
 @STATUSID VARCHAR(25),    
 @STATUSNAME VARCHAR(25),    
 @FPARTY VARCHAR(20),    
 @TPARTY VARCHAR(20),    
 @SAUDA VARCHAR(11),    
 @BRANCHCD VARCHAR(16) ='%',  
 @DIGIFLAG INT = 0  
 )    
   
 AS    
  
 IF @BRANCHCD ='' BEGIN SET @BRANCHCD ='%' END    
 IF @TPARTY ='' BEGIN SET @TPARTY ='ZZZZZZZZZZ' END 
 
 DECLARE @SAUDADATE VARCHAR(11)
 SET  @SAUDADATE=@SAUDA
 
IF LEN(@SAUDA) = 10 AND CHARINDEX('/',@SAUDA) > 0    
SET @SAUDA=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @SAUDA,103),109)    
    
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
 
 SELECT     
      
  [CLIENT CODE]=C2.CL_CODE,  
  [CLIENT NAME]=C1.LONG_NAME, 
  [TRADE DATE] =  @SAUDADATE 
 /* C2.EXCHANGE,    
  C2.TRAN_CAT,    
  C1.EMAIL,    
  C1.RES_PHONE1,    
  C1.SHORT_NAME,    
  C1.L_ADDRESS1,    
  C1.L_ADDRESS2,    
  C1.L_ADDRESS3,    
  C1.L_CITY,    
  C1.L_ZIP,    
  C1.FAMILY,    
  C1.BRANCH_CD,
  C2.PARTY_CODE,     
  TRADER = ISNULL(C1.TRADER,''),  
  C1.PAN_GIR_NO */   
 FROM    
  CLIENT1 C1 (NOLOCK),    
  CLIENT2 C2 (NOLOCK),    
  (    
   SELECT    
    DISTINCT PARTY_CODE = FOPDD_PARTY_CODE FROM FO_POS_DETAILS_DAS (NOLOCK)    
   WHERE     
    FOPDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'    
    AND FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
    AND ((FOPDD_OPENING_PQTY+FOPDD_TODAY_PQTY)-(FOPDD_OPENING_SQTY+FOPDD_TODAY_SQTY)) <> 0  
   
   UNION  
     
   SELECT    
    DISTINCT PARTY_CODE = FOTDD_PARTY_CODE FROM FO_TRADE_DETAILS_DAS  (NOLOCK)    
   WHERE     
    FOTDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'    
    AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
  ) F
  ,  CLIENT_PRINT_SETTINGS CP (NOLOCK)  
 WHERE    
  F.PARTY_CODE = C2.PARTY_CODE         
  AND C1.CL_CODE = C2.CL_CODE    
  AND C1.BRANCH_CD LIKE @BRANCHCD    
  AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY    
  AND C2.PRINTF = CP.PRINT_FLAG  
  AND CP.VALID_REPORT LIKE (CASE   
      WHEN @DIGIFLAG = 0 THEN '%'   
      WHEN @DIGIFLAG = 1 THEN '%CONTRACT%'   
      WHEN @DIGIFLAG = 2 THEN '%DIGITAL%'   
      ELSE CP.VALID_REPORT   
      END) 
  AND @STATUSNAME =(CASE     
            WHEN @STATUSID = 'BRANCH'     
            THEN C1.BRANCH_CD     
            WHEN @STATUSID = 'SUBBROKER'     
            THEN C1.SUB_BROKER     
            WHEN @STATUSID = 'TRADER'     
            THEN C1.TRADER     
            WHEN @STATUSID = 'FAMILY'     
            THEN C1.FAMILY     
            WHEN @STATUSID = 'AREA'     
            THEN C1.AREA     
            WHEN @STATUSID = 'REGION'     
            THEN C1.REGION     
            WHEN @STATUSID = 'CLIENT'     
            THEN C2.PARTY_CODE     
            ELSE 'BROKER'   
     END)  
 ORDER BY   
  C2.PARTY_CODE
   
   
  
 /*
 SELECT     
  DISTINCT  
  [CLIENT CODE] = FOTDD_PARTY_CODE,
  [CLIENT NAME] = '', 
  [TRADE DATE] = @SAUDADATE 
  /*,
  EXCHANGE = '',    
  TRAN_CAT = '',    
  EMAIL = '',    
  RES_PHONE1 = '',    
  SHORT_NAME = '',    
  L_ADDRESS1 = '',    
  L_ADDRESS2 = '',    
  L_ADDRESS3 = '',    
  L_CITY = '',    
  L_ZIP = '',    
  FAMILY = '',    
  BRANCH_CD = '',     
  TRADER = '',  
  PAN_GIR_NO = '',
  PARTY_CODE = FOTDD_PARTY_CODE*/      
 FROM    
  FO_TRADE_DETAILS_DAS (NOLOCK)  
 WHERE   
  FOTDD_SAUDA_DATE LIKE @SAUDA +'%'  
  AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
 ORDER BY   
  FOTDD_PARTY_CODE 
  */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_PR_VALIDATEFILE
-- --------------------------------------------------


CREATE PROCEDURE [DBO].[CLS_PR_VALIDATEFILE] 
(
	@FILETYPE VARCHAR(12),
	@FILEPATHNAME VARCHAR(400),
	@SAUDA_DATE VARCHAR(11)
) AS

DECLARE @FILENAME VARCHAR(100)
DECLARE @INTSTAT INT
DECLARE @STRRET VARCHAR(200)
DECLARE @EXCHANGECODE VARCHAR(3)
DECLARE @INTDATEVAL INT

IF  CHARINDEX('\',@FILEPATHNAME) > 0
BEGIN
	SET @FILENAME = REVERSE(LEFT(REVERSE(@FILEPATHNAME),CHARINDEX('\',REVERSE(@FILEPATHNAME))-1))
END
ELSE
BEGIN
	SET @FILENAME = @FILEPATHNAME
END

SET @INTSTAT = 0
SET @STRRET  = ''
SET @INTDATEVAL = 0

SELECT @EXCHANGECODE = UPPER(EXCHANGE)  FROM FOGLOBALS (NOLOCK)


IF @FILETYPE ='F_CN01'
BEGIN
		IF LEFT(@FILENAME,6) <> 'BFX_CO' OR LEFT(@FILENAME,10) <> 'BFX_SPD_CO'
		BEGIN
			SET @INTSTAT = 1
			SET @STRRET  = 'INVALID CONTRACT FILE SELECTED'
		END
END

IF @FILETYPE ='CLOSING'
BEGIN
	IF RIGHT(@FILENAME,6) <> 'BFX_MS' 
	BEGIN
		SET @INTSTAT = 1
		SET @STRRET  = 'INVALID CLOSING FILE SELECTED'
	END

END


IF @FILETYPE ='MARGIN'
BEGIN
	IF LEFT(@FILENAME,6) <> 'BFX_MG'
	BEGIN
		SET @INTSTAT = 1
		SET @STRRET  = 'INVALID MARGIN FILE SELECTED'
	END
	SET @INTDATEVAL = 1
END


IF @FILETYPE ='POSITION'
BEGIN

	IF LEFT(@FILENAME,6) <> 'BFX_PO'
	BEGIN
		SET @INTSTAT = 1
		SET @STRRET  = 'INVALID POSITION FILE SELECTED'
	END
	SET @INTDATEVAL = 1
END



IF @INTDATEVAL = 1 AND @INTSTAT = 0
BEGIN
	DECLARE @FILEDATE_V VARCHAR(12)
	DECLARE @FILEDATE VARCHAR(12)
	SET @FILENAME = REPLACE(@FILENAME,'-01.CSV','.CSV')
	SET @FILEDATE_V = SUBSTRING(@FILENAME,LEN(@FILENAME)-11,8)
	
	
	IF LEN(@FILEDATE_V) <> 8
	BEGIN
		SET @INTSTAT = 1
		SET @STRRET = 'WRONG FILE NAME'		
	END	 
	ELSE
	BEGIN
		IF @FILEDATE_V <> CONVERT(VARCHAR,CONVERT(DATETIME,@SAUDA_DATE),112)
		BEGIN
			SET @INTSTAT = 1	
			SET @STRRET = 'FILE DATE AND ENTER SELECT DATE IS DIFFERENT'			
		END
	END
END	

SELECT @INTSTAT AS INTSTAT,@STRRET AS STRRET

/*-------------------------------------- END OF THE PROC ---------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_PROC_FO_NEWCLIENTSUMMARY
-- --------------------------------------------------



CREATE PROC [dbo].[CLS_RPT_PROC_FO_NEWCLIENTSUMMARY]
	(
	@STATUSID		VARCHAR(20),
	@STATUSNAME		VARCHAR(25),
	@FROMDATE		VARCHAR(11),
	@FROMPARTY		VARCHAR(20),
	@TOPARTY		VARCHAR(20),
	@RATE_FLAG		VARCHAR(10),
	@NETPOS_FLAG	INT = 0,
	@BILL_FLAG		INT = 0,
	@EXCHANGE		VARCHAR(3),
	@SEGMENT 		VARCHAR(10),
	@RPT_TYPE		INT = 0
	)
	
	AS	
	
	/*
	EXEC CLS_RPT_PROC_FO_NEWCLIENTSUMMARY 'BROKER','BROKER','DEC  2 2010','','ZZZZZZZZZ','PRICE',1,1,'NSE','FUTURES',0
	*/
	
	IF LEN(@FROMDATE) = 10 AND CHARINDEX('/', @FROMDATE) > 0
	BEGIN
		SET @FROMDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE, 103), 109)
	END
	
	IF @TOPARTY = ''
	BEGIN
		SET @TOPARTY = 'ZZZZZZZZZZZ'
	END
	
	CREATE TABLE #CLIENTSUMMARY
		(
		CLIENT_CODE	VARCHAR(20),
		CLIENT_NAME	VARCHAR(100),
		CLIENT_TYPE	VARCHAR(5),
		EMAIL		VARCHAR(100),
		L_ADDRESS1	VARCHAR(100), 
		L_ADDRESS2	VARCHAR(100), 
		L_ADDRESS3	VARCHAR(100),  
		L_CITY		VARCHAR(50),
		L_ZIP		VARCHAR(20),
		PAN_GIR_NO	VARCHAR(20),
		OFF_PHONE1	VARCHAR(50),
		OFF_PHONE2	VARCHAR(50),
		BRANCH_CODE VARCHAR(20),
		SUB_BROKER	VARCHAR(20),
		DAILYMTOMSETTLEMENT			MONEY,
		FINALFUTURESSETTLEMENT		MONEY,
		PREMIUMSETTLEMENT			MONEY,
		OPTIONSEXERCISEASSIGNMENT	MONEY,
		BROKANDMISC					MONEY,
		CLEARINGCHARGES				MONEY,

		MARGINDATE	VARCHAR(11),
		LEDBALANCE	MONEY,
		PAYREC		MONEY,
		MINLEDBAL	MONEY,
		MINMARGIN	MONEY,      
		MARGIN		MONEY,
		AVLCOLL		MONEY,
		SPANMAR		MONEY,
		VARMARGIN	MONEY,
		TOTCASH		MONEY,
		TOTCOLLNONCASH MONEY,      
		TOTNONCASH	MONEY,
		TOTCOLL		MONEY,
		EFFCOLL		MONEY,
		SPREADMARGIN	MONEY, 
		NONSPREADMARGIN	MONEY,
		MTOMMARGIN		MONEY,
		EFFNONCASH		MONEY,

		INST_TYPE		VARCHAR(6), 
		SYMBOL			VARCHAR(25), 
		EXPIRYDATE		VARCHAR(11),
		STRIKE_PRICE	MONEY, 
		OPTION_TYPE		VARCHAR(2), 
		OPENPOSITION	MONEY,
		PROFITORLOSS	MONEY,

		S_SPANMARGIN	MONEY,
		S_PREMIUM		MONEY,
		S_ADDMARGINPERC MONEY,
		S_TOTALMARGIN	MONEY,
		E_MARGINPERC	MONEY,
		E_MARGINAMT		MONEY,
		
		REC_TYPE		INT
		)
	
	SELECT	* INTO #FOBILLVALAN
	FROM	FOBILLVALAN (NOLOCK)
	WHERE	SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' 
			AND ISNULL(PARTY_CODE,'') BETWEEN @FROMPARTY AND @TOPARTY
		

	INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,CLIENT_NAME,CLIENT_TYPE,EMAIL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,PAN_GIR_NO,OFF_PHONE1,OFF_PHONE2,BRANCH_CODE,SUB_BROKER,DAILYMTOMSETTLEMENT,FINALFUTURESSETTLEMENT,PREMIUMSETTLEMENT,OPTIONSEXERCISEASSIGNMENT,BROKANDMISC,CLEARINGCHARGES,REC_TYPE)
	SELECT 
		CLIENT_CODE = F.PARTY_CODE, 
		PARTY_NAME = C1.LONG_NAME,
		CLIENT_TYPE,
		EMAIL = C1.EMAIL,
		L_ADDRESS1 = C1.L_ADDRESS1, 
		L_ADDRESS2 = C1.L_ADDRESS2, 
		L_ADDRESS3 = C1.L_ADDRESS3,  
		L_CITY = C1.L_CITY,
		L_ZIP = C1.L_ZIP, 
		PAN_GIR_NO = C1.PAN_GIR_NO, 
		OFF_PHONE1 = C1.OFF_PHONE1,
		OFF_PHONE2 = C1.OFF_PHONE2,
		BRANCH_CODE = F.BRANCH_CODE,
		SUB_BROKER = F.SUB_BROKER,		 
		DAILYMTOMSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT
			ELSE 0
		END),
		FINALFUTURESSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		PREMIUMSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		OPTIONSEXERCISEASSIGNMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		BROKANDMISC = (
		CASE
			WHEN @RATE_FLAG = 'PRICE' THEN -(SUM(PBROKAMT + SBROKAMT) + SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG))
			WHEN @RATE_FLAG = 'NETRATE' THEN -(SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG))
			ELSE 0
		END),
		CLEARINGCHARGES = -(SUM(CL_CHRG) - SUM(EXCL_CHRG)),
		REC_TYPE = 1
	FROM 
		#FOBILLVALAN F (NOLOCK),
		CLIENT1 C1 (NOLOCK)
	WHERE
		F.PARTY_CODE = C1.CL_CODE  
		--AND ISNULL(PARTY_CODE,'') BETWEEN @FROMPARTY AND @TOPARTY
		--AND SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' 
		AND @STATUSID = (
		CASE 			
			WHEN @STATUSNAME = 'BRANCH'		THEN F.BRANCH_CODE			
			WHEN @STATUSNAME = 'SUBBROKER'	THEN F.SUB_BROKER			
			WHEN @STATUSNAME = 'TRADER'		THEN F.TRADER			
			WHEN @STATUSNAME = 'FAMILY'		THEN F.FAMILY			
			WHEN @STATUSNAME = 'AREA'		THEN F.AREA			
			WHEN @STATUSNAME = 'REGION'		THEN F.REGION			
			WHEN @STATUSNAME = 'CLIENT'		THEN F.PARTY_CODE			
			ELSE 'BROKER'		
		END)    
	GROUP BY 
		F.PARTY_CODE, 
		C1.LONG_NAME,
		CLIENT_TYPE,
		C1.EMAIL,
		C1.L_ADDRESS1, 
		C1.L_ADDRESS2, 
		C1.L_ADDRESS3,  
		C1.L_CITY,
		C1.L_ZIP, 
		C1.PAN_GIR_NO, 
		C1.OFF_PHONE1,
		C1.OFF_PHONE2,
		F.BRANCH_CODE,
		F.SUB_BROKER
	ORDER BY 
		F.PARTY_CODE, 
		PARTY_NAME, 
		CLIENT_TYPE
		


	CREATE TABLE #CL_LEDGER
		(
		CLIENT_CODE		VARCHAR(20),
		OPENBALANCE   	MONEY,
		LEDBALANCE   	MONEY,
		PAYREC       	MONEY,    
		MINLEDBAL   	MONEY,    
		MINMARGIN   	MONEY,    
		MARGIN			MONEY,    
		AVLCOLL      	MONEY,    
		SPANMAR      	MONEY,    
		VARMARGIN		MONEY,    
		TOTCASH     	MONEY,    
		TOTNONCASH		MONEY,    
		TOTCOLL  		MONEY,    
		EFFCOLL    		MONEY,    
		SPREADMARGIN 	MONEY,    
		NONSPREADMARGIN MONEY,    
		MTOMMARGIN 		MONEY,    
		MARGINPER 		MONEY,
		EFFNONCASH		MONEY  
		)

	INSERT	INTO #CL_LEDGER 
	SELECT	DISTINCT CLIENT_CODE,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	FROM	#CLIENTSUMMARY
	    
	/* LEDGER BALANCE */    
	UPDATE	#CL_LEDGER
	SET		LEDBALANCE = ISNULL(A.LEDBALANCE,0)
	FROM	(
			SELECT CLTCODE, LEDBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTFO.DBO.LEDGER L (NOLOCK), ACCOUNTFO.DBO.PARAMETER P (NOLOCK)
			WHERE VDT < @FROMDATE AND VDT >= SDTCUR AND VDT<= LDTCUR    
			AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY 
			AND @FROMDATE BETWEEN SDTCUR AND LDTCUR
			GROUP BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
		    
	/* OPEN BALANCE */    
	UPDATE	#CL_LEDGER
	SET		OPENBALANCE = ISNULL(A.OPENBALANCE,0)
	FROM	(
			SELECT CLTCODE, OPENBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTFO.DBO.LEDGER L (NOLOCK)
			WHERE VDT BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND VTYP = 18 AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
			GROUP BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
	    
	/* PAYMENT RECEIVED FOR THE DAY */    
	UPDATE	#CL_LEDGER
	SET		PAYREC = ISNULL(A.PAYREC,0)
	FROM	(
			SELECT CLTCODE, PAYREC = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTFO.DBO.LEDGER L (NOLOCK) 
			WHERE VDT BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' 
			AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
			AND VTYP NOT IN (15,18)
			GROUP  BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
	    
	/* MARGIN AMOUNT */    
	UPDATE	#CL_LEDGER
	SET		MARGIN = ISNULL(A.MARGIN,0)
	FROM	(
			SELECT PARTY_CODE, MARGIN = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END),0)    
			FROM ACCOUNTFO.DBO.MARGINLEDGER L (NOLOCK), ACCOUNTFO.DBO.PARAMETER P (NOLOCK)  
			WHERE VDT <= @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT 
			AND VDT < @FROMDATE AND VDT >= SDTCUR AND CURYEAR = 1
			GROUP BY PARTY_CODE     
			) A
	WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	    
	/* SPAN AND VAR MARGIN */    
	/*IF (SELECT COUNT(1) FROM FOMARGIN_SPAN WHERE MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59') > 0 OR  (SELECT COUNT(1) FROM FOMARGIN_EXP_DETAILS (NOLOCK) WHERE SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59') > 0
	BEGIN
		UPDATE	#CL_LEDGER
		SET		SPANMAR = ISNULL(A.SPANMAR,0),
				SPREADMARGIN = ISNULL(A.SPREADMARGIN,0)			
		FROM	(
				SELECT 
					PARTY_CODE,
					SPANMAR = -ISNULL(SUM(TOTALMARGIN),0) ,  
					SPREADMARGIN = -ISNULL(SUM(TOTALMARGIN),0)
				FROM 
					FOMARGIN_SPAN (NOLOCK)
				WHERE 
					MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				GROUP BY PARTY_CODE	
				) A
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE

				
		UPDATE	#CL_LEDGER
		SET		VARMARGIN = ISNULL(A.VARMARGIN,0),
				MTOMMARGIN = ISNULL(A.MTOMMARGIN,0)			
		FROM	(
				SELECT 
					PARTY_CODE,
					VARMARGIN = -ISNULL(SUM(MARGINAMT),0) ,  
					MTOMMARGIN = -ISNULL(SUM(MARGINAMT),0)
				FROM 
					FOMARGIN_EXP_DETAILS (NOLOCK)
				WHERE 
					SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				GROUP BY PARTY_CODE		
				) A	
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE

	END*/
	--ELSE
	--BEGIN
		UPDATE	#CL_LEDGER
		SET		SPANMAR = ISNULL(A.SPANMAR,0),
				VARMARGIN = ISNULL(A.VARMARGIN,0),
				SPREADMARGIN = ISNULL(A.SPREADMARGIN,0),
				NONSPREADMARGIN = ISNULL(A.NONSPREADMARGIN,0),
				MTOMMARGIN = ISNULL(A.MTOMMARGIN,0)
		FROM	(
				SELECT 
					PARTY_CODE,
					SPANMAR = -ISNULL(SUM(INTIAL_MARGIN),0) , 
					VARMARGIN = -ISNULL(SUM(EXTREME_LOSS_MARGIN),0) , 
					SPREADMARGIN = -ISNULL(SUM(INTIAL_MARGIN),0), 
					NONSPREADMARGIN = -ISNULL(SUM(INTIAL_MARGIN),0),
					MTOMMARGIN = -ISNULL(SUM(EXTREME_LOSS_MARGIN),0) 
				FROM 
					FOMARGINNEW (NOLOCK)
				WHERE 
					MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' 
					AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
					AND CLIENT_TYPE <> 'TM'     
				GROUP BY
					PARTY_CODE							
				) A
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	--END 

	/* COLLATERAL DETAILS */    
	UPDATE	#CL_LEDGER
	SET		TOTCASH = ISNULL(A.TOTCASH,0),
			TOTNONCASH = ISNULL(A.TOTNONCASH,0),
			TOTCOLL = ISNULL(A.TOTCOLL,0),
			EFFCOLL = ISNULL(A.EFFCOLL,0),
			AVLCOLL = ISNULL(A.AVLCOLL,0),
			EFFNONCASH = ISNULL(A.EFFNONCASH,0)
	FROM	(			
			SELECT 
				PARTY_CODE,
				TOTCASH = ISNULL(SUM(CASH),0), 
				TOTNONCASH = ISNULL(SUM(NONCASH),0), 
				TOTCOLL = ISNULL(SUM(CASH),0) + ISNULL(SUM(NONCASH),0),     
				EFFCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), 
				AVLCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), 
				EFFNONCASH = ISNULL(SUM(ACTUALNONCASH),0)
			FROM 
				MSAJAG.DBO.COLLATERAL (NOLOCK)
			WHERE 
				PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				AND TRANS_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
				AND EXCHANGE = @EXCHANGE    
				AND SEGMENT = @SEGMENT     
			GROUP BY
				PARTY_CODE	
			) A	
	WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	 

	UPDATE	#CL_LEDGER
	SET		MARGINPER = 100,
			LEDBALANCE = LEDBALANCE + OPENBALANCE
	     

	--INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,MARGINDATE,LEDBALANCE,PAYREC,MINLEDBAL,MINMARGIN,MARGIN,AVLCOLL,SPANMAR,VARMARGIN,TOTCASH, TOTCOLLNONCASH,TOTNONCASH,TOTCOLL,EFFCOLL,SPREADMARGIN,NONSPREADMARGIN,MTOMMARGIN,EFFNONCASH,REC_TYPE)
	--SELECT       
			--CLIENT_CODE,

	UPDATE	#CLIENTSUMMARY
	SET		MARGINDATE = @FROMDATE,       
			LEDBALANCE = C.LEDBALANCE,
			PAYREC = C.PAYREC,
			MINLEDBAL = C.MINLEDBAL,
			MINMARGIN = (C.SPREADMARGIN + C.NONSPREADMARGIN + C.VARMARGIN),
			MARGIN = C.MARGIN,
			AVLCOLL = C.AVLCOLL,
			SPANMAR = C.SPANMAR,
			VARMARGIN = C.VARMARGIN,
			TOTCASH = C.TOTCASH,
			TOTCOLLNONCASH = C.TOTNONCASH,      
			TOTNONCASH = C.TOTNONCASH,
			TOTCOLL = C.TOTCOLL,
			EFFCOLL = (
			CASE 
				WHEN C.LEDBALANCE + C.PAYREC + C.TOTCASH > ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100) THEN 
					CASE 
						WHEN (C.TOTNONCASH > C.LEDBALANCE + C.PAYREC + C.TOTCASH) THEN C.LEDBALANCE + C.TOTCASH      
						ELSE C.TOTNONCASH       
					END      
				ELSE      
					CASE 
						WHEN C.TOTNONCASH > ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100) THEN ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100)
						ELSE C.TOTNONCASH       
					END       
			END) + C.TOTCASH,
			SPREADMARGIN = C.SPREADMARGIN, 
			NONSPREADMARGIN = C.NONSPREADMARGIN,
			MTOMMARGIN = C.MTOMMARGIN,
			EFFNONCASH = C.EFFNONCASH
			--REC_TYPE = 2
	FROM	#CL_LEDGER C
	WHERE	--(LEDBALANCE+PAYREC+MINLEDBAL+SPREADMARGIN+NONSPREADMARGIN+VARMARGIN+MARGIN+AVLCOLL+SPANMAR+TOTCASH+TOTNONCASH+TOTCOLL+MTOMMARGIN+EFFNONCASH) <> 0
			C.CLIENT_CODE = #CLIENTSUMMARY.CLIENT_CODE
			AND REC_TYPE = 1


	IF @RPT_TYPE = 0
	BEGIN
		SELECT	CLIENT_CODE,
				CLIENT_NAME,
				CLIENT_TYPE,
				NET_BILL_AMOUNT = CONVERT(VARCHAR,ROUND(SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES),2)),
				NET_SETT_AMOUNT = CONVERT(VARCHAR,ROUND(SUM(ISNULL(LEDBALANCE,0)+ISNULL(PAYREC,0)+ISNULL(MINLEDBAL,0))
									+(CASE WHEN @BILL_FLAG = 1 THEN SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES) ELSE 0 END),2)),
				NET_REC_PAYABLE = CONVERT(VARCHAR,ROUND(SUM(ISNULL(LEDBALANCE,0)+ISNULL(PAYREC,0)+ISNULL(MINLEDBAL,0))
									+(CASE WHEN @BILL_FLAG = 1 THEN SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES-ISNULL(NONSPREADMARGIN,0)) ELSE 0 END)
									+ SUM(ISNULL(AVLCOLL,0)+ISNULL(SPANMAR,0)+ISNULL(VARMARGIN,0)),2))
		FROM	#CLIENTSUMMARY
		GROUP BY
				CLIENT_CODE,
				CLIENT_NAME,
				CLIENT_TYPE
		ORDER BY
				CLIENT_CODE		
		RETURN		
	END
	

	IF @NETPOS_FLAG = 1
	BEGIN
		INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,OPENPOSITION,PROFITORLOSS,REC_TYPE)
		SELECT
			CLIENT_CODE=PARTY_CODE,
			INST_TYPE, SYMBOL, 
			EXPIRYDATE = LEFT(EXPIRYDATE,11), 
			STRIKE_PRICE, 
			OPTION_TYPE, 
			OPENPOSITION = SUM(PQTY-SQTY),
			PROFITORLOSS = SUM(SBILLAMT-PBILLAMT) - (SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)),
			REC_TYPE = 2
		FROM
			#FOBILLVALAN (NOLOCK)
		GROUP BY
			PARTY_CODE,INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE			
		HAVING SUM(PQTY-SQTY) <> 0
	END
		

	/*
	INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,SYMBOL,S_SPANMARGIN,S_PREMIUM,S_ADDMARGINPERC,S_TOTALMARGIN,E_MARGINPERC,E_MARGINAMT,REC_TYPE)
	SELECT
		CLIENT_CODE = ISNULL(S_PARTY_CODE,E_PARTY_CODE),
		--PARTYNAME = ISNULL(S_PARTYNAME,E_PARTYNAME),
		SYMBOL = ISNULL(S_SYMBOL,E_SYMBOL),
		S_SPANMARGIN =ISNULL(S_SPANMARGIN,0),
		S_PREMIUM = ISNULL(S_PREMIUM,0),
		S_ADDMARGINPERC = ISNULL(S_ADDMARGINPERC,0),
		S_TOTALMARGIN = ISNULL(S_TOTALMARGIN,0),
		E_MARGINPERC = ISNULL(E_MARGINPERC,0),
		E_MARGINAMT = ISNULL(E_MARGINAMT,0),
		REC_TYPE = 3
	FROM 
		(
		SELECT
			S_PARTY_CODE = FOMARGIN_SPAN.PARTY_CODE,
			--S_PARTYNAME = LONG_NAME,
			S_SYMBOL = REPLACE(FOMARGIN_SPAN.SYMBOL,'&AMP;','&'),
			S_SPANMARGIN = SPANMARGIN,
			S_PREMIUM = PREMIUM,
			S_ADDMARGINPERC = PMARGINRATE,
			S_TOTALMARGIN = TOTALMARGIN
		FROM
			FOMARGIN_SPAN (NOLOCK) 
		WHERE
			MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND FOMARGIN_SPAN.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND FOMARGIN_SPAN.CL_TYPE ='CL'
			AND EXISTS (SELECT DISTINCT CLIENT_CODE FROM #CLIENTSUMMARY C 
			WHERE C.CLIENT_CODE = FOMARGIN_SPAN.PARTY_CODE)
		) FOMRG

	FULL OUTER JOIN 
		(
		SELECT
			E_PARTY_CODE = FOMARGIN_EXP_DETAILS.PARTY_CODE,
			--E_PARTYNAME = LONG_NAME,
			E_SYMBOL = SYMBOL,
			E_MARGINPERC = MARGIN_PERC,
			E_MARGINAMT = MARGINAMT
		FROM
			FOMARGIN_EXP_DETAILS (NOLOCK)
		WHERE
			SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND FOMARGIN_EXP_DETAILS.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND EXISTS (SELECT DISTINCT CLIENT_CODE FROM #CLIENTSUMMARY C 
			WHERE C.CLIENT_CODE = FOMARGIN_EXP_DETAILS.PARTY_CODE)
		) EXPMRG
		ON (E_PARTY_CODE = S_PARTY_CODE AND E_SYMBOL = S_SYMBOL)
	ORDER BY 1,3
	*/
	
	SELECT * FROM #CLIENTSUMMARY
	ORDER BY CLIENT_CODE, REC_TYPE
	
	DROP TABLE #FOBILLVALAN
	DROP TABLE #CLIENTSUMMARY
	DROP TABLE #CL_LEDGER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_RPT_PROC_FO_NEWCLIENTSUMMARY_bak_23022016
-- --------------------------------------------------


CREATE PROC [DBO].[CLS_RPT_PROC_FO_NEWCLIENTSUMMARY]
	(
	@STATUSID		VARCHAR(20),
	@STATUSNAME		VARCHAR(25),
	@FROMDATE		VARCHAR(11),
	@FROMPARTY		VARCHAR(20),
	@TOPARTY		VARCHAR(20),
	@RATE_FLAG		VARCHAR(10),
	@NETPOS_FLAG	INT = 0,
	@BILL_FLAG		INT = 0,
	@EXCHANGE		VARCHAR(3),
	@SEGMENT 		VARCHAR(10),
	@RPT_TYPE		INT = 0
	)
	
	AS	
	
	/*
	EXEC CLS_RPT_PROC_FO_NEWCLIENTSUMMARY 'BROKER','BROKER','DEC  2 2010','','ZZZZZZZZZ','PRICE',1,1,'NSE','FUTURES',0
	*/
	
	IF LEN(@FROMDATE) = 10 AND CHARINDEX('/', @FROMDATE) > 0
	BEGIN
		SET @FROMDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE, 103), 109)
	END
	
	IF @TOPARTY = ''
	BEGIN
		SET @TOPARTY = 'ZZZZZZZZZZZ'
	END
	
	CREATE TABLE #CLIENTSUMMARY
		(
		CLIENT_CODE	VARCHAR(20),
		CLIENT_NAME	VARCHAR(100),
		CLIENT_TYPE	VARCHAR(5),
		EMAIL		VARCHAR(100),
		L_ADDRESS1	VARCHAR(100), 
		L_ADDRESS2	VARCHAR(100), 
		L_ADDRESS3	VARCHAR(100),  
		L_CITY		VARCHAR(50),
		L_ZIP		VARCHAR(20),
		PAN_GIR_NO	VARCHAR(20),
		OFF_PHONE1	VARCHAR(50),
		OFF_PHONE2	VARCHAR(50),
		BRANCH_CODE VARCHAR(20),
		SUB_BROKER	VARCHAR(20),
		DAILYMTOMSETTLEMENT			MONEY,
		FINALFUTURESSETTLEMENT		MONEY,
		PREMIUMSETTLEMENT			MONEY,
		OPTIONSEXERCISEASSIGNMENT	MONEY,
		BROKANDMISC					MONEY,
		CLEARINGCHARGES				MONEY,

		MARGINDATE	VARCHAR(11),
		LEDBALANCE	MONEY,
		PAYREC		MONEY,
		MINLEDBAL	MONEY,
		MINMARGIN	MONEY,      
		MARGIN		MONEY,
		AVLCOLL		MONEY,
		SPANMAR		MONEY,
		VARMARGIN	MONEY,
		TOTCASH		MONEY,
		TOTCOLLNONCASH MONEY,      
		TOTNONCASH	MONEY,
		TOTCOLL		MONEY,
		EFFCOLL		MONEY,
		SPREADMARGIN	MONEY, 
		NONSPREADMARGIN	MONEY,
		MTOMMARGIN		MONEY,
		EFFNONCASH		MONEY,

		INST_TYPE		VARCHAR(6), 
		SYMBOL			VARCHAR(25), 
		EXPIRYDATE		VARCHAR(11),
		STRIKE_PRICE	MONEY, 
		OPTION_TYPE		VARCHAR(2), 
		OPENPOSITION	MONEY,
		PROFITORLOSS	MONEY,

		S_SPANMARGIN	MONEY,
		S_PREMIUM		MONEY,
		S_ADDMARGINPERC MONEY,
		S_TOTALMARGIN	MONEY,
		E_MARGINPERC	MONEY,
		E_MARGINAMT		MONEY,
		
		REC_TYPE		INT
		)
	
	SELECT	* INTO #FOBILLVALAN
	FROM	FOBILLVALAN (NOLOCK)
	WHERE	SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' 
			AND ISNULL(PARTY_CODE,'') BETWEEN @FROMPARTY AND @TOPARTY
		

	INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,CLIENT_NAME,CLIENT_TYPE,EMAIL,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_ZIP,PAN_GIR_NO,OFF_PHONE1,OFF_PHONE2,BRANCH_CODE,SUB_BROKER,DAILYMTOMSETTLEMENT,FINALFUTURESSETTLEMENT,PREMIUMSETTLEMENT,OPTIONSEXERCISEASSIGNMENT,BROKANDMISC,CLEARINGCHARGES,REC_TYPE)
	SELECT 
		CLIENT_CODE = F.PARTY_CODE, 
		PARTY_NAME = C1.LONG_NAME,
		CLIENT_TYPE,
		EMAIL = C1.EMAIL,
		L_ADDRESS1 = C1.L_ADDRESS1, 
		L_ADDRESS2 = C1.L_ADDRESS2, 
		L_ADDRESS3 = C1.L_ADDRESS3,  
		L_CITY = C1.L_CITY,
		L_ZIP = C1.L_ZIP, 
		PAN_GIR_NO = C1.PAN_GIR_NO, 
		OFF_PHONE1 = C1.OFF_PHONE1,
		OFF_PHONE2 = C1.OFF_PHONE2,
		BRANCH_CODE = F.BRANCH_CODE,
		SUB_BROKER = F.SUB_BROKER,		 
		DAILYMTOMSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT
			ELSE 0
		END),
		FINALFUTURESSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'FUT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		PREMIUMSETTLEMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART <> 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		OPTIONSEXERCISEASSIGNMENT = SUM(
		CASE 
			WHEN @RATE_FLAG = 'PRICE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT 
			WHEN @RATE_FLAG = 'NETRATE' AND (AUCTIONPART = 'EA' AND LEFT(INST_TYPE,3) = 'OPT' AND TRADETYPE = 'BT') THEN  SBILLAMT - PBILLAMT
			ELSE 0 
		END),
		BROKANDMISC = (
		CASE
			WHEN @RATE_FLAG = 'PRICE' THEN -(SUM(PBROKAMT + SBROKAMT) + SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG))
			WHEN @RATE_FLAG = 'NETRATE' THEN -(SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG))
			ELSE 0
		END),
		CLEARINGCHARGES = -(SUM(CL_CHRG) - SUM(EXCL_CHRG)),
		REC_TYPE = 1
	FROM 
		#FOBILLVALAN F (NOLOCK),
		CLIENT1 C1 (NOLOCK)
	WHERE
		F.PARTY_CODE = C1.CL_CODE  
		--AND ISNULL(PARTY_CODE,'') BETWEEN @FROMPARTY AND @TOPARTY
		--AND SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' 
		AND @STATUSID = (
		CASE 			
			WHEN @STATUSNAME = 'BRANCH'		THEN F.BRANCH_CODE			
			WHEN @STATUSNAME = 'SUBBROKER'	THEN F.SUB_BROKER			
			WHEN @STATUSNAME = 'TRADER'		THEN F.TRADER			
			WHEN @STATUSNAME = 'FAMILY'		THEN F.FAMILY			
			WHEN @STATUSNAME = 'AREA'		THEN F.AREA			
			WHEN @STATUSNAME = 'REGION'		THEN F.REGION			
			WHEN @STATUSNAME = 'CLIENT'		THEN F.PARTY_CODE			
			ELSE 'BROKER'		
		END)    
	GROUP BY 
		F.PARTY_CODE, 
		C1.LONG_NAME,
		CLIENT_TYPE,
		C1.EMAIL,
		C1.L_ADDRESS1, 
		C1.L_ADDRESS2, 
		C1.L_ADDRESS3,  
		C1.L_CITY,
		C1.L_ZIP, 
		C1.PAN_GIR_NO, 
		C1.OFF_PHONE1,
		C1.OFF_PHONE2,
		F.BRANCH_CODE,
		F.SUB_BROKER
	ORDER BY 
		F.PARTY_CODE, 
		PARTY_NAME, 
		CLIENT_TYPE
		


	CREATE TABLE #CL_LEDGER
		(
		CLIENT_CODE		VARCHAR(20),
		OPENBALANCE   	MONEY,
		LEDBALANCE   	MONEY,
		PAYREC       	MONEY,    
		MINLEDBAL   	MONEY,    
		MINMARGIN   	MONEY,    
		MARGIN			MONEY,    
		AVLCOLL      	MONEY,    
		SPANMAR      	MONEY,    
		VARMARGIN		MONEY,    
		TOTCASH     	MONEY,    
		TOTNONCASH		MONEY,    
		TOTCOLL  		MONEY,    
		EFFCOLL    		MONEY,    
		SPREADMARGIN 	MONEY,    
		NONSPREADMARGIN MONEY,    
		MTOMMARGIN 		MONEY,    
		MARGINPER 		MONEY,
		EFFNONCASH		MONEY  
		)

	INSERT	INTO #CL_LEDGER 
	SELECT	DISTINCT CLIENT_CODE,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	FROM	#CLIENTSUMMARY
	    
	/* LEDGER BALANCE */    
	UPDATE	#CL_LEDGER
	SET		LEDBALANCE = ISNULL(A.LEDBALANCE,0)
	FROM	(
			SELECT CLTCODE, LEDBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTFO.DBO.LEDGER L (NOLOCK), ACCOUNTFO.DBO.PARAMETER P (NOLOCK)
			WHERE VDT < @FROMDATE AND VDT >= SDTCUR AND VDT<= LDTCUR    
			AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY 
			AND @FROMDATE BETWEEN SDTCUR AND LDTCUR
			GROUP BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
		    
	/* OPEN BALANCE */    
	UPDATE	#CL_LEDGER
	SET		OPENBALANCE = ISNULL(A.OPENBALANCE,0)
	FROM	(
			SELECT CLTCODE, OPENBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTFO.DBO.LEDGER L (NOLOCK)
			WHERE VDT BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND VTYP = 18 AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
			GROUP BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
	    
	/* PAYMENT RECEIVED FOR THE DAY */    
	UPDATE	#CL_LEDGER
	SET		PAYREC = ISNULL(A.PAYREC,0)
	FROM	(
			SELECT CLTCODE, PAYREC = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)    
			FROM ACCOUNTFO.DBO.LEDGER L (NOLOCK) 
			WHERE VDT BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59' 
			AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
			AND VTYP NOT IN (15,18)
			GROUP  BY CLTCODE
			) A
	WHERE A.CLTCODE = #CL_LEDGER.CLIENT_CODE
	    
	/* MARGIN AMOUNT */    
	UPDATE	#CL_LEDGER
	SET		MARGIN = ISNULL(A.MARGIN,0)
	FROM	(
			SELECT PARTY_CODE, MARGIN = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END),0)    
			FROM ACCOUNTFO.DBO.MARGINLEDGER L (NOLOCK), ACCOUNTFO.DBO.PARAMETER P (NOLOCK)  
			WHERE VDT <= @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT 
			AND VDT < @FROMDATE AND VDT >= SDTCUR AND CURYEAR = 1
			GROUP BY PARTY_CODE     
			) A
	WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	    
	/* SPAN AND VAR MARGIN */    
	/*IF (SELECT COUNT(1) FROM FOMARGIN_SPAN WHERE MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59') > 0 OR  (SELECT COUNT(1) FROM FOMARGIN_EXP_DETAILS (NOLOCK) WHERE SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59') > 0
	BEGIN
		UPDATE	#CL_LEDGER
		SET		SPANMAR = ISNULL(A.SPANMAR,0),
				SPREADMARGIN = ISNULL(A.SPREADMARGIN,0)			
		FROM	(
				SELECT 
					PARTY_CODE,
					SPANMAR = -ISNULL(SUM(TOTALMARGIN),0) ,  
					SPREADMARGIN = -ISNULL(SUM(TOTALMARGIN),0)
				FROM 
					FOMARGIN_SPAN (NOLOCK)
				WHERE 
					MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				GROUP BY PARTY_CODE	
				) A
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE

				
		UPDATE	#CL_LEDGER
		SET		VARMARGIN = ISNULL(A.VARMARGIN,0),
				MTOMMARGIN = ISNULL(A.MTOMMARGIN,0)			
		FROM	(
				SELECT 
					PARTY_CODE,
					VARMARGIN = -ISNULL(SUM(MARGINAMT),0) ,  
					MTOMMARGIN = -ISNULL(SUM(MARGINAMT),0)
				FROM 
					FOMARGIN_EXP_DETAILS (NOLOCK)
				WHERE 
					SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				GROUP BY PARTY_CODE		
				) A	
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE

	END*/
	--ELSE
	--BEGIN
		UPDATE	#CL_LEDGER
		SET		SPANMAR = ISNULL(A.SPANMAR,0),
				VARMARGIN = ISNULL(A.VARMARGIN,0),
				SPREADMARGIN = ISNULL(A.SPREADMARGIN,0),
				NONSPREADMARGIN = ISNULL(A.NONSPREADMARGIN,0),
				MTOMMARGIN = ISNULL(A.MTOMMARGIN,0)
		FROM	(
				SELECT 
					PARTY_CODE,
					SPANMAR = -ISNULL(SUM(INTIAL_MARGIN),0) , 
					VARMARGIN = -ISNULL(SUM(EXTREME_LOSS_MARGIN),0) , 
					SPREADMARGIN = -ISNULL(SUM(INTIAL_MARGIN),0), 
					NONSPREADMARGIN = -ISNULL(SUM(INTIAL_MARGIN),0),
					MTOMMARGIN = -ISNULL(SUM(EXTREME_LOSS_MARGIN),0) 
				FROM 
					FOMARGINNEW (NOLOCK)
				WHERE 
					MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59' 
					AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY 
					AND CLIENT_TYPE <> 'TM'     
				GROUP BY
					PARTY_CODE							
				) A
		WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	--END 

	/* COLLATERAL DETAILS */    
	UPDATE	#CL_LEDGER
	SET		TOTCASH = ISNULL(A.TOTCASH,0),
			TOTNONCASH = ISNULL(A.TOTNONCASH,0),
			TOTCOLL = ISNULL(A.TOTCOLL,0),
			EFFCOLL = ISNULL(A.EFFCOLL,0),
			AVLCOLL = ISNULL(A.AVLCOLL,0),
			EFFNONCASH = ISNULL(A.EFFNONCASH,0)
	FROM	(			
			SELECT 
				PARTY_CODE,
				TOTCASH = ISNULL(SUM(CASH),0), 
				TOTNONCASH = ISNULL(SUM(NONCASH),0), 
				TOTCOLL = ISNULL(SUM(CASH),0) + ISNULL(SUM(NONCASH),0),     
				EFFCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), 
				AVLCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), 
				EFFNONCASH = ISNULL(SUM(ACTUALNONCASH),0)
			FROM 
				MSAJAG.DBO.COLLATERAL (NOLOCK)
			WHERE 
				PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
				AND TRANS_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
				AND EXCHANGE = @EXCHANGE    
				AND SEGMENT = @SEGMENT     
			GROUP BY
				PARTY_CODE	
			) A	
	WHERE A.PARTY_CODE = #CL_LEDGER.CLIENT_CODE
	 

	UPDATE	#CL_LEDGER
	SET		MARGINPER = 100,
			LEDBALANCE = LEDBALANCE + OPENBALANCE
	     

	--INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,MARGINDATE,LEDBALANCE,PAYREC,MINLEDBAL,MINMARGIN,MARGIN,AVLCOLL,SPANMAR,VARMARGIN,TOTCASH, TOTCOLLNONCASH,TOTNONCASH,TOTCOLL,EFFCOLL,SPREADMARGIN,NONSPREADMARGIN,MTOMMARGIN,EFFNONCASH,REC_TYPE)
	--SELECT       
			--CLIENT_CODE,

	UPDATE	#CLIENTSUMMARY
	SET		MARGINDATE = @FROMDATE,       
			LEDBALANCE = C.LEDBALANCE,
			PAYREC = C.PAYREC,
			MINLEDBAL = C.MINLEDBAL,
			MINMARGIN = (C.SPREADMARGIN + C.NONSPREADMARGIN + C.VARMARGIN),
			MARGIN = C.MARGIN,
			AVLCOLL = C.AVLCOLL,
			SPANMAR = C.SPANMAR,
			VARMARGIN = C.VARMARGIN,
			TOTCASH = C.TOTCASH,
			TOTCOLLNONCASH = C.TOTNONCASH,      
			TOTNONCASH = C.TOTNONCASH,
			TOTCOLL = C.TOTCOLL,
			EFFCOLL = (
			CASE 
				WHEN C.LEDBALANCE + C.PAYREC + C.TOTCASH > ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100) THEN 
					CASE 
						WHEN (C.TOTNONCASH > C.LEDBALANCE + C.PAYREC + C.TOTCASH) THEN C.LEDBALANCE + C.TOTCASH      
						ELSE C.TOTNONCASH       
					END      
				ELSE      
					CASE 
						WHEN C.TOTNONCASH > ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100) THEN ABS((C.SPREADMARGIN+C.VARMARGIN)*C.MARGINPER/100)
						ELSE C.TOTNONCASH       
					END       
			END) + C.TOTCASH,
			SPREADMARGIN = C.SPREADMARGIN, 
			NONSPREADMARGIN = C.NONSPREADMARGIN,
			MTOMMARGIN = C.MTOMMARGIN,
			EFFNONCASH = C.EFFNONCASH
			--REC_TYPE = 2
	FROM	#CL_LEDGER C
	WHERE	--(LEDBALANCE+PAYREC+MINLEDBAL+SPREADMARGIN+NONSPREADMARGIN+VARMARGIN+MARGIN+AVLCOLL+SPANMAR+TOTCASH+TOTNONCASH+TOTCOLL+MTOMMARGIN+EFFNONCASH) <> 0
			C.CLIENT_CODE = #CLIENTSUMMARY.CLIENT_CODE
			AND REC_TYPE = 1


	IF @RPT_TYPE = 0
	BEGIN
		SELECT	CLIENT_CODE,
				CLIENT_NAME,
				CLIENT_TYPE,
				NET_BILL_AMOUNT = CONVERT(VARCHAR,ROUND(SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES),2)),
				NET_SETT_AMOUNT = CONVERT(VARCHAR,ROUND(SUM(ISNULL(LEDBALANCE,0)+ISNULL(PAYREC,0)+ISNULL(MINLEDBAL,0))
									+(CASE WHEN @BILL_FLAG = 1 THEN SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES) ELSE 0 END),2)),
				NET_REC_PAYABLE = CONVERT(VARCHAR,ROUND(SUM(ISNULL(LEDBALANCE,0)+ISNULL(PAYREC,0)+ISNULL(MINLEDBAL,0))
									+(CASE WHEN @BILL_FLAG = 1 THEN SUM(DAILYMTOMSETTLEMENT+FINALFUTURESSETTLEMENT+PREMIUMSETTLEMENT+OPTIONSEXERCISEASSIGNMENT+BROKANDMISC+CLEARINGCHARGES-ISNULL(NONSPREADMARGIN,0)) ELSE 0 END)
									+ SUM(ISNULL(AVLCOLL,0)+ISNULL(SPANMAR,0)+ISNULL(VARMARGIN,0)),2))
		FROM	#CLIENTSUMMARY
		GROUP BY
				CLIENT_CODE,
				CLIENT_NAME,
				CLIENT_TYPE
		ORDER BY
				CLIENT_CODE		
		RETURN		
	END
	

	IF @NETPOS_FLAG = 1
	BEGIN
		INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,OPENPOSITION,PROFITORLOSS,REC_TYPE)
		SELECT
			CLIENT_CODE=PARTY_CODE,
			INST_TYPE, SYMBOL, 
			EXPIRYDATE = LEFT(EXPIRYDATE,11), 
			STRIKE_PRICE, 
			OPTION_TYPE, 
			OPENPOSITION = SUM(PQTY-SQTY),
			PROFITORLOSS = SUM(SBILLAMT-PBILLAMT) - (SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)),
			REC_TYPE = 2
		FROM
			#FOBILLVALAN (NOLOCK)
		GROUP BY
			PARTY_CODE,INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE			
		HAVING SUM(PQTY-SQTY) <> 0
	END
		

	/*
	INSERT INTO #CLIENTSUMMARY (CLIENT_CODE,SYMBOL,S_SPANMARGIN,S_PREMIUM,S_ADDMARGINPERC,S_TOTALMARGIN,E_MARGINPERC,E_MARGINAMT,REC_TYPE)
	SELECT
		CLIENT_CODE = ISNULL(S_PARTY_CODE,E_PARTY_CODE),
		--PARTYNAME = ISNULL(S_PARTYNAME,E_PARTYNAME),
		SYMBOL = ISNULL(S_SYMBOL,E_SYMBOL),
		S_SPANMARGIN =ISNULL(S_SPANMARGIN,0),
		S_PREMIUM = ISNULL(S_PREMIUM,0),
		S_ADDMARGINPERC = ISNULL(S_ADDMARGINPERC,0),
		S_TOTALMARGIN = ISNULL(S_TOTALMARGIN,0),
		E_MARGINPERC = ISNULL(E_MARGINPERC,0),
		E_MARGINAMT = ISNULL(E_MARGINAMT,0),
		REC_TYPE = 3
	FROM 
		(
		SELECT
			S_PARTY_CODE = FOMARGIN_SPAN.PARTY_CODE,
			--S_PARTYNAME = LONG_NAME,
			S_SYMBOL = REPLACE(FOMARGIN_SPAN.SYMBOL,'&AMP;','&'),
			S_SPANMARGIN = SPANMARGIN,
			S_PREMIUM = PREMIUM,
			S_ADDMARGINPERC = PMARGINRATE,
			S_TOTALMARGIN = TOTALMARGIN
		FROM
			FOMARGIN_SPAN (NOLOCK) 
		WHERE
			MDATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND FOMARGIN_SPAN.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND FOMARGIN_SPAN.CL_TYPE ='CL'
			AND EXISTS (SELECT DISTINCT CLIENT_CODE FROM #CLIENTSUMMARY C 
			WHERE C.CLIENT_CODE = FOMARGIN_SPAN.PARTY_CODE)
		) FOMRG

	FULL OUTER JOIN 
		(
		SELECT
			E_PARTY_CODE = FOMARGIN_EXP_DETAILS.PARTY_CODE,
			--E_PARTYNAME = LONG_NAME,
			E_SYMBOL = SYMBOL,
			E_MARGINPERC = MARGIN_PERC,
			E_MARGINAMT = MARGINAMT
		FROM
			FOMARGIN_EXP_DETAILS (NOLOCK)
		WHERE
			SAUDA_DATE BETWEEN @FROMDATE AND @FROMDATE + ' 23:59:59'
			AND FOMARGIN_EXP_DETAILS.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND EXISTS (SELECT DISTINCT CLIENT_CODE FROM #CLIENTSUMMARY C 
			WHERE C.CLIENT_CODE = FOMARGIN_EXP_DETAILS.PARTY_CODE)
		) EXPMRG
		ON (E_PARTY_CODE = S_PARTY_CODE AND E_SYMBOL = S_SYMBOL)
	ORDER BY 1,3
	*/
	
	SELECT * FROM #CLIENTSUMMARY
	ORDER BY CLIENT_CODE, REC_TYPE
	
	DROP TABLE #FOBILLVALAN
	DROP TABLE #CLIENTSUMMARY
	DROP TABLE #CL_LEDGER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_SAUDA_SUMMARY_RPT
-- --------------------------------------------------
CREATE PROC [DBO].[CLS_SAUDA_SUMMARY_RPT]
(
	@DATEFROM VARCHAR(11),
	@DATETO VARCHAR(11),
	@FROMPARTY VARCHAR(20),
	@TOPARTY VARCHAR (20), 
	@FROMSCRIP VARCHAR(20),
	@TOSCRIP VARCHAR (20), 		
	@STATUSID VARCHAR(15),  
	@STATUSNAME VARCHAR(25),
	@REPORTTYPE INT=1,
	@REPORT_BY VARCHAR(10)='PARTY',
	@INST_TYPE VARCHAR(7) ='',
	@EXPIRYDATE VARCHAR(11) ='',
	@OPTION_TYPE VARCHAR(2) ='',
	@STRIKE_PRICE MONEY =0
)  AS

/*
	@REPORTTYPE = 1 : PARTY / SCRIP WISE SUMMARY
	@REPORTTYPE = 2 : PARTY + SCRIP / SCRIP + PARTY
	@REPORTTYPE = 3 : PARTY + SCRIP + SAUDA_DATE / SCRIP + PARTY + SAUDA_DATE 
	
	@REPORT_BY : PARTY / SCRIP

*/

/*SET @DATEFROM = LEFT(CONVERT(DATETIME,@DATEFROM,103),11)
SET @DATETO = LEFT(CONVERT(DATETIME,@DATETO,103),11)*/

  IF LEN(@DATEFROM) = 10 AND CHARINDEX('/',@DATEFROM) > 0    
  SET @DATEFROM=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @DATEFROM,103),109)
  
  IF LEN(@DATETO) = 10 AND CHARINDEX('/',@DATETO) > 0    
  SET @DATETO=CONVERT(VARCHAR (11), CONVERT(DATETIME,  @DATETO,103),109) 




IF @TOPARTY =''
SET @TOPARTY ='ZZZZZZZ'

IF @TOSCRIP =''
SET @TOSCRIP ='ZZZZZZZ'

DECLARE @OPENDATE VARCHAR(11)
SELECT @OPENDATE= CONVERT(VARCHAR,MIN(SAUDA_DATE),109) FROM FOBILLVALAN  (NOLOCK) WHERE SAUDA_DATE >=  @DATEFROM 



SELECT 
	SAUDA_DATE= CONVERT(VARCHAR,SAUDA_DATE,103),
	PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME,
	SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS  EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE,	
	(SUM(CASE WHEN CONVERT(VARCHAR,SAUDA_DATE,103) = @OPENDATE AND TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) AS OPENQTY,
	TRADETYPE, 	
	(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) AS PQTY, 
	(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) AS SQTY, 
	(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) AS PAMT, 	 	
	(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) / 
	SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) ELSE 0 END) AS PRATE,	
	(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END)) AS SAMT,	
	(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) / 
	SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) AS SRATE,	
	SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) AS NETQTY,	
	(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END)) AS NETAMT,	
	(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) THEN 
	SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*PRATE)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) WHEN  
	SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*SRATE)/
	SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) ELSE 0 END)AS AVGPRICE,	
	(SUM(CASE WHEN SAUDA_DATE =@OPENDATE AND  TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) - 
	(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) AS CLOSEQTY,	
	(CASE WHEN SUM(PQTY+SQTY) <> 0 THEN  ABS(SUM((PQTY + SQTY)*CL_RATE) / SUM(PQTY + SQTY))
	ELSE 0 END )AS CLOSEPRICE 		
INTO #SAUDA_SUMMARY	
FROM FOBILLVALAN (NOLOCK)
WHERE
	SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59' 
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	AND SYMBOL BETWEEN @FROMSCRIP AND @TOSCRIP
	AND PQTY +SQTY > 0 
	AND INST_TYPE = CASE WHEN @INST_TYPE = '' THEN INST_TYPE ELSE @INST_TYPE END
	AND EXPIRYDATE = CASE WHEN @EXPIRYDATE = '' THEN EXPIRYDATE ELSE LEFT(CONVERT(DATETIME,@EXPIRYDATE,103),11) + ' 23:59' END
	AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '' THEN OPTION_TYPE ELSE @OPTION_TYPE END
	AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END
	AND 'BROKER' = 		
	(CASE
		WHEN 'BROKER' = 'BRANCH' THEN BRANCH_CODE
		WHEN 'BROKER' = 'SUBBROKER' THEN SUB_BROKER
		WHEN 'BROKER' = 'TRADER' THEN TRADER
		WHEN 'BROKER' = 'FAMILY' THEN FAMILY
		WHEN 'BROKER' = 'AREA' THEN AREA
		WHEN 'BROKER' = 'REGION' THEN REGION
		WHEN 'BROKER' = 'CLIENT' THEN PARTY_CODE 
		ELSE 'BROKER' 
	END)
GROUP BY CONVERT(VARCHAR,SAUDA_DATE,103),PARTY_CODE ,SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE,TRADETYPE  

IF @REPORTTYPE = 1  -- SUMMARY
BEGIN
	IF @REPORT_BY = 'PARTY'
	BEGIN
		SELECT SAUDA_DATE='',CLIENT_CODE=PARTY_CODE ,CLIENT_NAME=PARTY_NAME ,INST_TYPE='',SYMBOL='',EXP_DATE='',STRIKE_PRICE=0,OPTION_TYPE='',
		OPENQTY	= SUM(OPENQTY),PQTY = SUM(PQTY),SQTY = SUM(SQTY),
		PAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(PAMT),2)),
		PRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)),
		--CONVERT(NUMERIC(18,2),ROUND(SUM(PAMT)/SUM(CASE WHEN PQTY>0 THEN PQTY ELSE 1 END),2)),
		SAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(SAMT),2)),
		--SRATE = CONVERT(NUMERIC(18,2),ROUND(SUM(SAMT)/SUM(CASE WHEN SQTY>0 THEN SQTY ELSE 1 END),2)),
        SRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)),
	    NETQTY = SUM(NETQTY),
		NETAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(NETAMT),2)), 
	    AVGPRICE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) 
		THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*CASE WHEN STRIKE_PRICE > 0  THEN STRIKE_PRICE ELSE PRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) 
		WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0
		THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE ELSE SRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)
		ELSE 0 END)),
		CLOSEQTY = SUM(CLOSEQTY)--,CLOSEPRICE = 0	
		FROM #SAUDA_SUMMARY
		GROUP BY PARTY_CODE,PARTY_NAME
		ORDER BY 1,2,3,4,5
	END
	ELSE
	BEGIN
		SELECT SAUDA_DATE='',CLIENT_CODE='',CLIENT_NAME='',SYMBOL,INST_TYPE,EXP_DATE = EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
		OPENQTY	= SUM(OPENQTY),PQTY = SUM(PQTY),SQTY = SUM(SQTY),
		PAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(PAMT),2)),
		--PRATE = CONVERT(NUMERIC(18,2),ROUND(SUM(PAMT)/SUM(CASE WHEN PQTY>0 THEN PQTY ELSE 1 END),2)),
		PRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)),
		SAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(SAMT),2)) ,
		SRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)),
		--CONVERT(NUMERIC(18,2),ROUND(SUM(SAMT)/SUM(CASE WHEN SQTY>0 THEN SQTY ELSE 1 END),2)),
		NETQTY = SUM(NETQTY),
		NETAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(NETAMT),2)) ,
		AVGPRICE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) 
		THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*CASE WHEN STRIKE_PRICE > 0  THEN STRIKE_PRICE ELSE PRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) 
		WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0
		THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE ELSE SRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)
		ELSE 0 END)),
		CLOSEQTY = SUM(CLOSEQTY)--,CLOSEPRICE =0
		FROM #SAUDA_SUMMARY
		GROUP BY INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
		ORDER BY 1,2,3,4,5
	END
END

IF @REPORTTYPE = 2  -- DETAILS
BEGIN
		SELECT SAUDA_DATE='',CLIENT_CODE=PARTY_CODE,CLIENT_NAME=PARTY_NAME,SYMBOL,INST_TYPE,EXP_DATE = EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
		OPENQTY	= SUM(OPENQTY),PQTY = SUM(PQTY),SQTY = SUM(SQTY),
		PAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(PAMT),2)),
		PRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)),
		SAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(SAMT),2)) ,
		SRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)),
		
		NETQTY = SUM(NETQTY),
		NETAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(NETAMT),2)),
		AVGPRICE =  CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) 
		THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*CASE WHEN STRIKE_PRICE > 0  THEN STRIKE_PRICE ELSE PRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) 
		WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0
		THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE ELSE SRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)
		ELSE 0 END)),
		CLOSEQTY = SUM(CLOSEQTY),
		CLOSEPRICE = CASE WHEN @DATEFROM = @DATETO THEN CLOSEPRICE ELSE 0 END
		FROM #SAUDA_SUMMARY
		GROUP BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CASE WHEN @DATEFROM = @DATETO THEN CLOSEPRICE ELSE 0 END
		HAVING SUM(PQTY+SQTY)<>0
		ORDER BY 1,2,3,4,5
END

IF @REPORTTYPE = 3  -- FURTHER DETAILS
BEGIN
		SELECT SAUDA_DATE,CLIENT_CODE=PARTY_CODE,CLIENT_NAME=PARTY_NAME,SYMBOL,INST_TYPE,EXP_DATE = EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
		OPENQTY	= SUM(OPENQTY),PQTY = SUM(PQTY),SQTY = SUM(SQTY),
		PRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)),
		SAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(SAMT),2)) ,
		SRATE = CONVERT(NUMERIC(18,2),(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 
		THEN (SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN 
			(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) ELSE 
		(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) / SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)),
		NETQTY = SUM(NETQTY),
		NETAMT = CONVERT(NUMERIC(18,2),ROUND(SUM(NETAMT),2)),
		AVGPRICE = CONVERT(NUMERIC(18,2),CASE WHEN SUM(PAMT)>SUM(SAMT) THEN SUM(PAMT)/SUM(PQTY) ELSE CASE WHEN SUM(SQTY)>0 THEN SUM(SAMT)/SUM(SQTY) ELSE 0 END END),
		CLOSEQTY = SUM(CLOSEQTY),
		CLOSEPRICE
		FROM #SAUDA_SUMMARY
		GROUP BY SAUDA_DATE,PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,CLOSEPRICE
		HAVING SUM(PQTY+SQTY)<>0
		ORDER BY 1,2,3,4,5
END


DROP TABLE #SAUDA_SUMMARY

/*----------------------------------- END OF THE PROC -------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_STTANNEXURE
-- --------------------------------------------------

CREATE PROC [DBO].[CLS_STTANNEXURE]
	(  
	@FROMDATE	VARCHAR(11),   
	@TODATE		VARCHAR(11),
	@FROMPARTY	VARCHAR(20),   
	@TOPARTY	VARCHAR(20),
	@STATUSID	VARCHAR(15),   
	@STATUSNAME VARCHAR(25),
	@OUT_FLAG	VARCHAR(1) = 'D',
	@RPT_TYPE	INT = 0,
	@CONTRACTNO	VARCHAR(10) = ''
	)  

	AS  
  
	/*
	EXEC DBO.[CLS_STTANNEXURE] @FROMDATE='24/05/2011',@TODATE='24/05/2011',@FROMPARTY='0A143',@TOPARTY='0A143',@STATUSID='BROKER',@STATUSNAME='BROKER',@OUT_FLAG='D',@RPT_TYPE=1,@CONTRACTNO='0000001'
	EXEC [CLS_STTANNEXURE] '01/01/2010','31/12/2014','','ZZZZZZZ','BROKER','BROKER'
	EXEC .[CLS_STTANNEXURE] @FROMDATE='22/07/2011',@TODATE='22/07/2014',@FROMPARTY='',@TOPARTY='',@STATUSID='BROKER',@STATUSNAME='BROKER',@OUT_FLAG='D'
	*/
	
	SET @FROMDATE = LEFT(CONVERT(DATETIME,@FROMDATE,103),11)
	SET @TODATE = LEFT(CONVERT(DATETIME,@TODATE,103),11)
	
	IF @TOPARTY = ''
	BEGIN
		SET @TOPARTY = 'ZZZZZZZZZZZZ'
	END

	SELECT	*,
	STRIKE_PRICE=0.00,OPTION_TYPE ='',
	ORD_FLAG=1 
	INTO	#STT_CLIENTDETAIL
	FROM	STT_CLIENTDETAIL (NOLOCK)
	WHERE	PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND	SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
			AND CONTRACTNO = (CASE WHEN @CONTRACTNO = '' THEN CONTRACTNO ELSE @CONTRACTNO END)
			AND	SQTYTRD > 0 
			AND	LEN(LTRIM(RTRIM(CONTRACTNO))) > 0
			AND	TOTALSTT > 0

	CREATE INDEX [INDXSTT] ON #STT_CLIENTDETAIL ([PARTY_CODE],[SAUDA_DATE],[CONTRACTNO])
	
	SELECT	PARTY_CODE, COMPANY, ADDR1, ADDR2, CITY, ZIP, PHONE, COMP_FAX = O.FAX, COMP_EMAIL = O.EMAIL, 
			EXCHANGECODE ='BSE', --ISNULL(EXCHANGECODE, 'NSE'),
			MEMBERCODE,
			LONG_NAME, PAN_GIR_NO,BRANCH_CD, SUB_BROKER, L_ADDRESS1,L_ADDRESS2, L_ADDRESS3, L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,EMAIL=C1.EMAIL,
			MAPIDID = CONVERT(VARCHAR(20),'')
	INTO	#CLIENTMASTER
	FROM	CLIENT1 C1 (NOLOCK),
			CLIENT2 C2 (NOLOCK),
			OWNER O (NOLOCK)		
	WHERE	C1.CL_CODE = C2.CL_CODE
			AND	EXISTS (SELECT DISTINCT PARTY_CODE FROM #STT_CLIENTDETAIL S WHERE S.PARTY_CODE = C2.PARTY_CODE)
			AND	C2.INSURANCE_CHRG = 1 
			AND @STATUSNAME = (
			CASE
				WHEN @STATUSID = 'BRANCH'	THEN C1.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER'THEN C1.SUB_BROKER
				WHEN @STATUSID = 'TRADER'	THEN C1.TRADER
				WHEN @STATUSID = 'FAMILY'	THEN C1.FAMILY
				WHEN @STATUSID = 'AREA'		THEN C1.AREA
				WHEN @STATUSID = 'REGION'	THEN C1.REGION
				WHEN @STATUSID = 'CLIENT'	THEN C2.PARTY_CODE
				ELSE 'BROKER'
			END)

	CREATE INDEX [INDXCLIENT] ON #CLIENTMASTER ([PARTY_CODE])

	IF @RPT_TYPE = 0
	BEGIN
		
		SELECT
			CLIENT_CODE = LTRIM(RTRIM(S.PARTY_CODE)),
			CLIENT_NAME = ISNULL(LONG_NAME,''),
			TRADE_DATE = CONVERT(VARCHAR(11),SAUDA_DATE,103),
			CONTRACT_NO = CONTRACTNO,
			TOTAL_STT = CONVERT(NUMERIC(18,2),ROUND(SUM(TOTALSTT),2)),
			ORD_DATE = CONVERT(VARCHAR(11),SAUDA_DATE,112)
		FROM
			#STT_CLIENTDETAIL S,
			#CLIENTMASTER C
		WHERE
			S.PARTY_CODE = C.PARTY_CODE
		GROUP BY
			LTRIM(RTRIM(S.PARTY_CODE)),
			ISNULL(LONG_NAME,''),
			CONVERT(VARCHAR(11),SAUDA_DATE,103),
			CONVERT(VARCHAR(11),SAUDA_DATE,112),
			CONTRACTNO
		ORDER BY
			LTRIM(RTRIM(S.PARTY_CODE)),	
			CONVERT(VARCHAR(11),SAUDA_DATE,112),
			CONTRACT_NO
			
	END
	ELSE
	BEGIN

		UPDATE	#CLIENTMASTER
		SET		MAPIDID = ISNULL(U.MAPIDID, '')
		FROM	UCC_CLIENT U (NOLOCK)
		WHERE	U.PARTY_CODE = #CLIENTMASTER.PARTY_CODE		
		
		/*
		ALTER TABLE #STT_CLIENTDETAIL_NEW
		ALTER COLUMN TRADE_DATE VARCHAR(11)	

		UPDATE #STT_CLIENTDETAIL	
		SET  SAUDA_DATE = (CASE WHEN ORD_FLAG=1 THEN CONVERT(VARCHAR,'TOTAL') ELSE CONVERT(VARCHAR,CONVERT(DATETIME,SAUDA_DATE, 109),103) END)
		*/		

		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
		SELECT  
			TRADE_DATE = CONVERT(VARCHAR(11),SAUDA_DATE,103),
			CONTRACT_NO = CONTRACTNO,
			SCRIP_CODE = PRODUCT_CODE + ' ' + SERIES_CODE + ' ' + LEFT(EXPIRYDATE,11) + ' ' + CAST(CAST(STRIKE_PRICE AS NUMERIC(18,2)) AS VARCHAR) + ' ' + OPTION_TYPE ,
			TRD_SELL_QTY = CONVERT(NUMERIC(18,2),ROUND(SQTYTRD,2)), 
			TRD_SELL_PRICE = CONVERT(NUMERIC(18,2),ROUND(TRDPRICE,2)), 
			TRD_SELL_AMOUNT = CONVERT(NUMERIC(18,2),ROUND(SAMTTRD,2)), 
			TRD_SELL_STT = CONVERT(NUMERIC(18,2),ROUND(SSTTTRD,2)), 
			TOTAL_STT = CONVERT(NUMERIC(18,2),ROUND(TOTALSTT,2)),
			CLIENT_CODE = LTRIM(RTRIM(S.PARTY_CODE)),
			CLIENT_NAME = ISNULL(LONG_NAME,''),
			PAN_GIR_NO,
			L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,
			MAPIDID,BRANCH_CD,SUB_BROKER, COMPANY, COMP_ADDRES1 = ADDR1, COMP_ADDRES2 = ADDR2, 
			COMP_CITY = CITY, COMP_ZIP = ZIP, COMP_PHONE = PHONE, COMP_FAX, 
			COMP_EMAIL, EXCHANGECODE, MEMBERCODE,
			ORDDATE = CONVERT(VARCHAR,SAUDA_DATE,112),
			ORD_FLAG
		INTO
			#STT_CLIENTDETAIL_NEW
		FROM  
			#STT_CLIENTDETAIL S (NOLOCK),
			#CLIENTMASTER C (NOLOCK)
		WHERE  
			S.PARTY_CODE = C.PARTY_CODE 


		INSERT INTO #STT_CLIENTDETAIL_NEW
		SELECT
			TRADE_DATE = 'TOTAL',
			CONTRACT_NO = '',
			SCRIP_CODE = '',
			TRD_SELL_QTY = 0, 
			TRD_SELL_PRICE = 0, 
			TRD_SELL_AMOUNT = 0, 
			TRD_SELL_STT = 0, 
			TOTAL_STT = CONVERT(NUMERIC(18,2),ROUND(SUM(TOTAL_STT),2)),
			CLIENT_CODE = LTRIM(RTRIM(CLIENT_CODE)), 
			CLIENT_NAME = '',
			PAN_GIR_NO,
			L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,
			MAPIDID,BRANCH_CD,SUB_BROKER, COMPANY, COMP_ADDRES1, COMP_ADDRES2, 
			COMP_CITY, COMP_ZIP, COMP_PHONE, COMP_FAX,
			COMP_EMAIL, EXCHANGECODE, MEMBERCODE,
			ORDDATE = '',
			ORD_FLAG=2
		FROM	
			#STT_CLIENTDETAIL_NEW
		GROUP BY	
				LTRIM(RTRIM(CLIENT_CODE)),
				PAN_GIR_NO,
				L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,
				MAPIDID,BRANCH_CD,SUB_BROKER, COMPANY, COMP_ADDRES1, COMP_ADDRES2, 
				COMP_CITY, COMP_ZIP, COMP_PHONE, COMP_FAX,
				COMP_EMAIL,  EXCHANGECODE, MEMBERCODE

		IF @OUT_FLAG NOT IN ('P','D')
		BEGIN
  			ALTER TABLE #STT_CLIENTDETAIL_NEW
			ALTER COLUMN CONTRACT_NO VARCHAR(100)	

  			/*
  			ALTER TABLE #STT_CLIENTDETAIL_NEW
			ALTER COLUMN SCRIP_CODE VARCHAR(100)	
			*/	

  			INSERT INTO #STT_CLIENTDETAIL_NEW
			SELECT
				DISTINCT
				TRADE_DATE = LTRIM(RTRIM(CLIENT_CODE)),
				CONTRACT_NO = ISNULL(CLIENT_NAME,''),
				SCRIP_CODE = '',
				TRD_SELL_QTY = 0, 
				TRD_SELL_PRICE = 0, 
				TRD_SELL_AMOUNT = 0, 
				TRD_SELL_STT = 0, 
				TOTAL_STT = 0,
				CLIENT_CODE = LTRIM(RTRIM(CLIENT_CODE)), 
				CLIENT_NAME = ISNULL(CLIENT_NAME,''),
				PAN_GIR_NO,
				L_ADDRESS1,L_ADDRESS2,L_CITY,L_STATE,L_NATION,L_ZIP,RES_PHONE1,RES_PHONE2,
				MAPIDID,BRANCH_CD,SUB_BROKER, COMPANY, COMP_ADDRES1, COMP_ADDRES2, 
				COMP_CITY, COMP_ZIP, COMP_PHONE, COMP_FAX,
				COMP_EMAIL,  EXCHANGECODE, MEMBERCODE,
				ORDDATE = 'HEADER',
				ORD_FLAG=0
			FROM	
				#STT_CLIENTDETAIL_NEW
			WHERE 
				TRADE_DATE <> 'TOTAL'
		END	
			
		SELECT *,REPORT_PERIOD = @FROMDATE + ' - ' + @TODATE FROM #STT_CLIENTDETAIL_NEW
		ORDER BY  
			CLIENT_CODE, 
			ORD_FLAG ASC,
			CONTRACT_NO, 
			ORDDATE, 
			SCRIP_CODE
		
		DROP TABLE #STT_CLIENTDETAIL_NEW
		
	END	

	DROP TABLE #STT_CLIENTDETAIL
	DROP TABLE #CLIENTMASTER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLS_TURNOVER_RPT
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
/*  
EXEC CLS_TURNOVER_RPT '01/01/2010','10/10/2014','','','','','BROKER','BROKER',1,'PARTY','','','',0,'STRIKE'
EXEC CLS_TURNOVER_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',2,'PARTY','','','',0,'STRIKE'
EXEC CLS_TURNOVER_RPT '01/01/2010','10/10/2014','','','','','BROKER','BROKER',3,'PARTY','','','',0,'STRIKE'
  
EXEC CLS_TURNOVER_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',1,'SCRIP','','','',0,'STRIKE'
EXEC CLS_TURNOVER_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',2,'SCRIP','','','',0,'STRIKE'
EXEC CLS_TURNOVER_RPT '01/01/2012','10/10/2014','','','','','BROKER','BROKER',3,'SCRIP','','','',0,'STRIKE'
*/  
  
CREATE PROC [DBO].[CLS_TURNOVER_RPT]
(  
 @DATEFROM VARCHAR(11),  
 @DATETO VARCHAR(11),  
 @FROMPARTY VARCHAR(20),  
 @TOPARTY VARCHAR (20),   
 @FROMSCRIP VARCHAR(20),  
 @TOSCRIP VARCHAR (20),    
 @STATUSID VARCHAR(15),    
 @STATUSNAME VARCHAR(25),  
 @REPORTTYPE INT=1,  
 @REPORT_BY VARCHAR(10)='PARTY',  
 @INST_TYPE VARCHAR(7) ='',  
 @EXPIRYDATE VARCHAR(11) ='',  
 @OPTION_TYPE VARCHAR(2) ='',  
 @STRIKE_PRICE MONEY =0,
 @REPORTBY VARCHAR(10) = 'PRICE'   
 )  AS  
  
/*  
 @REPORTTYPE = 1 : PARTY / SCRIP WISE SUMMARY  
 @REPORTTYPE = 2 : PARTY + SCRIP / SCRIP + PARTY  
 @REPORTTYPE = 3 : PARTY + SCRIP + SAUDA_DATE / SCRIP + PARTY + SAUDA_DATE   
   
 @REPORT_BY : PARTY / SCRIP  
  
*/  
  
  
SET @DATEFROM = LEFT(CONVERT(DATETIME,@DATEFROM,103),11)  
SET @DATETO = LEFT(CONVERT(DATETIME,@DATETO,103),11)  
  
  
IF @TOPARTY =''  
SET @TOPARTY ='ZZZZZZZ'  
  
IF @TOSCRIP =''  
SET @TOSCRIP ='ZZZZZZZ'  
  
SELECT   
	SAUDA_DATE= CONVERT(VARCHAR,SAUDA_DATE,103),  
	PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME,  
	SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE,   
	FUTURESTRADEDVALUE = SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END),
	OPTIONSTRADEDVALUE = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*PRATE)+(SQTY*SRATE))) ELSE 0 END)
		WHEN @REPORTBY = 'STRIKE'	THEN SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*STRIKE_PRICE)+(SQTY*STRIKE_PRICE))) ELSE 0 END)
		WHEN @REPORTBY = 'BOTH'		THEN SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*(STRIKE_PRICE+PRATE))+(SQTY*(STRIKE_PRICE+SRATE)))) ELSE 0 END)
		WHEN @REPORTBY = 'EXCHG'	THEN SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*PRATE)+(SQTY*SRATE))) ELSE 0 END)
		ELSE SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' THEN (((PQTY*PRATE)+(SQTY*SRATE))) ELSE 0 END)
	END), 
	EXCERCISEVALUE = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*SRATE) ELSE 0 END)
		WHEN @REPORTBY = 'STRIKE'	THEN SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*STRIKE_PRICE) ELSE 0 END)
		WHEN @REPORTBY = 'BOTH'		THEN SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*(STRIKE_PRICE+SRATE)) ELSE 0 END)
		WHEN @REPORTBY = 'EXCHG'	THEN SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*STRIKE_PRICE) ELSE 0 END)
		ELSE SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN (SQTY*SRATE) ELSE 0 END)
	END),	
	ASSIGNMENTVALUE = 0,
	CLOSEOUTVALUE = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
		WHEN @REPORTBY = 'STRIKE'	THEN SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
		WHEN @REPORTBY = 'BOTH'		THEN SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
		WHEN @REPORTBY = 'EXCHG'	THEN SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
		ELSE SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)
	END),
	TOTAL = (
	CASE
		WHEN @REPORTBY = 'PRICE'	THEN (SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' ) THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END))
		WHEN @REPORTBY = 'STRIKE'	THEN (SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' ) THEN ISNULL(STRIKE_PRICE*PQTY + STRIKE_PRICE*SQTY,0) ELSE 0 END))
		WHEN @REPORTBY = 'BOTH'		THEN (SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' ) THEN ISNULL(STRIKE_PRICE*PQTY + STRIKE_PRICE*SQTY,0) ELSE 0 END))
		WHEN @REPORTBY = 'EXCHG'	THEN (SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
										+ (SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') THEN ISNULL(STRIKE_PRICE*PQTY + STRIKE_PRICE*SQTY,0) ELSE 0 END))
		ELSE (SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA') THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END)) 
			+ (SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' ) THEN ISNULL(PRATE*PQTY + SRATE*SQTY,0) ELSE 0 END))
	END),
	BROKERAGE = SUM(PBROKAMT + SBROKAMT),  
	FUT_BROKERAGE = SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN (PBROKAMT + SBROKAMT) ELSE 0 END),
	OPT_BROKERAGE = SUM(CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN (PBROKAMT + SBROKAMT) ELSE 0 END),
	SERVICETAX = SUM(SERVICE_TAX-EXSER_TAX), 
	INS_CHRG = SUM(INS_CHRG), 
	TURNOVERTAX = SUM(TURN_TAX),  
	FUT_TURNOVERTAX = SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN (TURN_TAX) ELSE 0 END),  
	OPT_TURNOVERTAX = SUM(CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN (TURN_TAX) ELSE 0 END),  
	SEBITAX = SUM(SEBI_TAX),
	STAMPDUTY = SUM(BROKER_NOTE),
	OTHERCHARGES = SUM(OTHER_CHRG)  
INTO #TURNOVER  
FROM FOBILLVALAN (NOLOCK)  
WHERE  
 SAUDA_DATE BETWEEN @DATEFROM AND @DATETO + ' 23:59'   
 AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY  
 AND SYMBOL BETWEEN @FROMSCRIP AND @TOSCRIP  
 AND INST_TYPE = CASE WHEN @INST_TYPE = '' THEN INST_TYPE ELSE @INST_TYPE END  
 AND EXPIRYDATE = CASE WHEN @EXPIRYDATE = '' THEN EXPIRYDATE ELSE LEFT(CONVERT(DATETIME,@EXPIRYDATE,103),11) + ' 23:59' END  
 AND OPTION_TYPE = CASE WHEN @OPTION_TYPE = '' THEN OPTION_TYPE ELSE @OPTION_TYPE END  
 AND STRIKE_PRICE = CASE WHEN @STRIKE_PRICE = 0 THEN STRIKE_PRICE ELSE @STRIKE_PRICE END  
 AND TRADETYPE = 'BT'  
 AND 'BROKER' =     
 (CASE  
  WHEN 'BROKER' = 'BRANCH' THEN BRANCH_CODE  
  WHEN 'BROKER' = 'SUBBROKER' THEN SUB_BROKER  
  WHEN 'BROKER' = 'TRADER' THEN TRADER  
  WHEN 'BROKER' = 'FAMILY' THEN FAMILY  
  WHEN 'BROKER' = 'AREA' THEN AREA  
  WHEN 'BROKER' = 'REGION' THEN REGION  
  WHEN 'BROKER' = 'CLIENT' THEN PARTY_CODE   
  ELSE 'BROKER'   
 END)  
GROUP BY CONVERT(VARCHAR,SAUDA_DATE,103),PARTY_CODE ,SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE    
ALTER TABLE #TURNOVER  
ADD SRNO INT IDENTITY(1,1)  
IF @REPORTTYPE = 1  -- SUMMARY  
BEGIN  
 IF @REPORT_BY = 'PARTY'  
 BEGIN  
  SELECT SRNO = MAX(SRNO),SAUDA_DATE='',PARTY_CODE,PARTY_NAME,INST_TYPE='',SYMBOL='',EXPIRYDATE='',STRIKE_PRICE=0,OPTION_TYPE='',  
  FUTURESTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(FUTURESTRADEDVALUE)),OPTIONSTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(OPTIONSTRADEDVALUE)),  
  EXCERCISEVALUE = CONVERT(NUMERIC(18,2),SUM(EXCERCISEVALUE)),ASSIGNMENTVALUE = CONVERT(NUMERIC(18,2),SUM(ASSIGNMENTVALUE)),  
  CLOSEOUTVALUE = CONVERT(NUMERIC(18,2),SUM(CLOSEOUTVALUE)),TOTAL = CONVERT(NUMERIC(18,2),SUM(TOTAL)),BROKERAGE = CONVERT(NUMERIC(18,2),SUM(BROKERAGE)),  
  FUT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(FUT_BROKERAGE)),OPT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(OPT_BROKERAGE)),  
  SERVICETAX = CONVERT(NUMERIC(18,2),SUM(SERVICETAX)),STT = CONVERT(NUMERIC(18,2),SUM(INS_CHRG)),TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(TURNOVERTAX)),  
  FUT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(FUT_TURNOVERTAX)),OPT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(OPT_TURNOVERTAX)),  
  SEBITAX = CONVERT(NUMERIC(18,2),SUM(SEBITAX)),STAMPDUTY = CONVERT(NUMERIC(18,2),SUM(STAMPDUTY)),OTHERCHARGES = CONVERT(NUMERIC(18,2),SUM(OTHERCHARGES))  
  FROM #TURNOVER  
  GROUP BY PARTY_CODE,PARTY_NAME  
  --ORDER BY 1,2,3,4,5  
  ORDER BY PARTY_CODE,PARTY_NAME  
 END  
 ELSE  
 BEGIN  
  SELECT SRNO = MAX(SRNO),SAUDA_DATE='',PARTY_CODE='',PARTY_NAME='',INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
  FUTURESTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(FUTURESTRADEDVALUE)),OPTIONSTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(OPTIONSTRADEDVALUE)),  
  EXCERCISEVALUE = CONVERT(NUMERIC(18,2),SUM(EXCERCISEVALUE)),ASSIGNMENTVALUE = CONVERT(NUMERIC(18,2),SUM(ASSIGNMENTVALUE)),  
  CLOSEOUTVALUE = CONVERT(NUMERIC(18,2),SUM(CLOSEOUTVALUE)),TOTAL = CONVERT(NUMERIC(18,2),SUM(TOTAL)),BROKERAGE = CONVERT(NUMERIC(18,2),SUM(BROKERAGE)),  
  FUT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(FUT_BROKERAGE)),OPT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(OPT_BROKERAGE)),  
  SERVICETAX = CONVERT(NUMERIC(18,2),SUM(SERVICETAX)),STT = CONVERT(NUMERIC(18,2),SUM(INS_CHRG)),TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(TURNOVERTAX)),  
  FUT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(FUT_TURNOVERTAX)),OPT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(OPT_TURNOVERTAX)),  
  SEBITAX = CONVERT(NUMERIC(18,2),SUM(SEBITAX)),STAMPDUTY = CONVERT(NUMERIC(18,2),SUM(STAMPDUTY)),OTHERCHARGES = CONVERT(NUMERIC(18,2),SUM(OTHERCHARGES))  
  FROM #TURNOVER  
  GROUP BY INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE  
  ORDER BY INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE  
 END  
END  
  
IF @REPORTTYPE = 2  -- DETAILS  
BEGIN  
  SELECT SRNO = MAX(SRNO),SAUDA_DATE='',PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
  FUTURESTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(FUTURESTRADEDVALUE)),OPTIONSTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(OPTIONSTRADEDVALUE)),  
  EXCERCISEVALUE = CONVERT(NUMERIC(18,2),SUM(EXCERCISEVALUE)),ASSIGNMENTVALUE = CONVERT(NUMERIC(18,2),SUM(ASSIGNMENTVALUE)),  
  CLOSEOUTVALUE = CONVERT(NUMERIC(18,2),SUM(CLOSEOUTVALUE)),TOTAL = CONVERT(NUMERIC(18,2),SUM(TOTAL)),BROKERAGE = CONVERT(NUMERIC(18,2),SUM(BROKERAGE)),  
  FUT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(FUT_BROKERAGE)),OPT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(OPT_BROKERAGE)),  
  SERVICETAX = CONVERT(NUMERIC(18,2),SUM(SERVICETAX)),STT = CONVERT(NUMERIC(18,2),SUM(INS_CHRG)),TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(TURNOVERTAX)),  
  FUT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(FUT_TURNOVERTAX)),OPT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(OPT_TURNOVERTAX)),  
  SEBITAX = CONVERT(NUMERIC(18,2),SUM(SEBITAX)),STAMPDUTY = CONVERT(NUMERIC(18,2),SUM(STAMPDUTY)),OTHERCHARGES = CONVERT(NUMERIC(18,2),SUM(OTHERCHARGES))  
  FROM #TURNOVER  
  GROUP BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE  
  ORDER BY 3,4,5 ,6
  --ORDER BY INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE,PARTY_CODE,PARTY_NAME  
END  
  
IF @REPORTTYPE = 3  -- FURTHER DETAILS  
BEGIN  
  SELECT SRNO = MAX(SRNO),SAUDA_DATE,PARTY_CODE,PARTY_NAME,INST_TYPE = LTRIM(RTRIM(INST_TYPE)),SYMBOL = LTRIM(RTRIM(SYMBOL)),EXPIRYDATE=LTRIM(RTRIM(EXPIRYDATE)),STRIKE_PRICE=LTRIM(RTRIM(STRIKE_PRICE)),OPTION_TYPE=LTRIM(RTRIM(OPTION_TYPE)),  
  FUTURESTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(FUTURESTRADEDVALUE)),OPTIONSTRADEDVALUE = CONVERT(NUMERIC(18,2),SUM(OPTIONSTRADEDVALUE)),  
  EXCERCISEVALUE = CONVERT(NUMERIC(18,2),SUM(EXCERCISEVALUE)),ASSIGNMENTVALUE = CONVERT(NUMERIC(18,2),SUM(ASSIGNMENTVALUE)),  
  CLOSEOUTVALUE = CONVERT(NUMERIC(18,2),SUM(CLOSEOUTVALUE)),TOTAL = CONVERT(NUMERIC(18,2),SUM(TOTAL)),BROKERAGE = CONVERT(NUMERIC(18,2),SUM(BROKERAGE)),  
  FUT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(FUT_BROKERAGE)),OPT_BROKERAGE = CONVERT(NUMERIC(18,2),SUM(OPT_BROKERAGE)),  
  SERVICETAX = CONVERT(NUMERIC(18,2),SUM(SERVICETAX)),STT = CONVERT(NUMERIC(18,2),SUM(INS_CHRG)),TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(TURNOVERTAX)),  
  FUT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(FUT_TURNOVERTAX)),OPT_TURNOVERTAX = CONVERT(NUMERIC(18,2),SUM(OPT_TURNOVERTAX)),  
  SEBITAX = CONVERT(NUMERIC(18,2),SUM(SEBITAX)),STAMPDUTY = CONVERT(NUMERIC(18,2),SUM(STAMPDUTY)),OTHERCHARGES = CONVERT(NUMERIC(18,2),SUM(OTHERCHARGES))  
  FROM #TURNOVER  
  GROUP BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE  
  --ORDER BY 1,2,3,4,5  
  ORDER BY PARTY_CODE,PARTY_NAME,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SAUDA_DATE
END  
  
  
DROP TABLE #TURNOVER  
  
/*------------------------------------------ END OF THE PROC -----------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CONSOLE_LOG
-- --------------------------------------------------
CREATE PROC [dbo].[CONSOLE_LOG] 
(
	@PARTY_CODE VARCHAR (10) ,
	@NEW_PARTY_CODE VARCHAR (10) ,
	@SAUDA_DATE VARCHAR(11) ,
	@INST_TYPE VARCHAR (6)  ,
	@SYMBOL VARCHAR (12)  ,
	@EXPIRYDATE VARCHAR(11)  ,
	@STRIKE_PRICE MONEY  ,
	@OPTION_TYPE VARCHAR (2)  ,
	@ORDER_NO VARCHAR (20)  ,
	@TRADE_NO VARCHAR (20)  ,
	@SELL_BUY VARCHAR (1)  ,
	@CONTRACT_NO VARCHAR (20)  ,
	@NEW_CONTRACT_NO VARCHAR (20)  ,
	@BROKERAGE NUMERIC(36, 12)  ,
	@NEW_BROKERAGE NUMERIC(36, 12)  ,
	@MARKET_RATE NUMERIC(36, 12)  ,
	@NEW_MARKET_RATE NUMERIC(36, 12)  ,
	@NET_RATE NUMERIC(36, 12)  ,
	@NEW_NET_RATE NUMERIC(36, 12)  ,
	@QTY BIGINT  ,
	@NEW_QTY BIGINT  ,
	@ROUNDTO INT  ,
	@PARTICIPANT_CODE VARCHAR (20)  ,
	@NEW_PARTICIPANT_CODE VARCHAR (20)  ,
	@USERNAME VARCHAR (25)  ,
	@MODULE VARCHAR (50)  ,
	@CALLED_FROM VARCHAR (100)  
)
AS
IF @SAUDA_DATE <>'' AND PATINDEX('%/%',@SAUDA_DATE) >0
BEGIN
	SELECT @SAUDA_DATE= LEFT(CONVERT(DATETIME,@SAUDA_DATE,103),11)
END

IF @EXPIRYDATE <> ''  AND PATINDEX('%/%',@EXPIRYDATE) >0
BEGIN
	SELECT @EXPIRYDATE=LEFT(CONVERT(DATETIME,@EXPIRYDATE,103),11)
END
IF @EXPIRYDATE = '%'  SET @EXPIRYDATE = ''

INSERT INTO INST_LOG VALUES 
(
	@PARTY_CODE,@NEW_PARTY_CODE,@SAUDA_DATE,@INST_TYPE,@SYMBOL,@EXPIRYDATE,@STRIKE_PRICE,@OPTION_TYPE,
	@ORDER_NO,@TRADE_NO,@SELL_BUY,@CONTRACT_NO,@NEW_CONTRACT_NO,@BROKERAGE,@NEW_BROKERAGE,@MARKET_RATE,
	@NEW_MARKET_RATE,@NET_RATE,@NEW_NET_RATE,@QTY,@NEW_QTY,@ROUNDTO,@PARTICIPANT_CODE,@NEW_PARTICIPANT_CODE,
	@USERNAME,@MODULE,@CALLED_FROM,GETDATE(),'','',''
)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CONSOLIDATETRANS
-- --------------------------------------------------

CREATE PROC [dbo].[CONSOLIDATETRANS]  
(  
 @FORMDATA VARCHAR(MAX),  
 @AFTERBEFORE VARCHAR(1),  
 @STATUSNAME VARCHAR(50),  
 @MODULE VARCHAR(100)  
)  
AS  
  
/*---------------------------------------------------------------------------  
 PROC NAME   : CONSOLIDATETRANS  
 PROJECT     : .NET NSEFO CONSOLIDATION  
 DESCRIPTION : CALLING FOR THE TRADE/FOSETTLEMENT BEFORE & AFTER CONTRACT  
      CONSOLIDATION  
BEGIN TRAN  
EXEC CONSOLIDATETRANS ',0000066,0A141,,ACC,FUTSTK,29/06/2006,0,,13/06/2006,0,2,1,698.7000,698.77,698.77,|,0000066,0A141,,ACC,FUTSTK,29/06/2006,0,,13/06/2006,0,2,2,710.6600,710.66,710.66,|', 'Y', 'ASHOOKE/BROKER', '/FC.INTERFACE/INNERREPORT.ASPX'  
SELECT * FROM FOSETTLEMENT WHERE PARTY_CODE = '0A141' AND SAUDA_DATE LIKE 'JUN 13 2006%' AND SYMBOL = 'ACC'  
AND INST_TYPE = 'FUTSTK' AND EXPIRYDATE LIKE 'JUN 29 2006%' AND RESERVED1 = 1 AND SELL_BUY = 1  
BEGIN TRAN  
UPDATE  FOSETTLEMENT SET  DUMMY1 = 1, PRICE = 1123 WHERE  SAUDA_DATE LIKE 'JUN 13 2006%'  AND PARTY_CODE = '0A141'  AND SYMBOL = 'ACC'  AND INST_TYPE = 'FUTSTK'  AND EXPIRYDATE LIKE 'JUN 29 2006%'  AND STRIKE_PRICE = 0.0000  AND OPTION_TYPE = ''  AND SELL



  
_BUY = 2  AND CONTRACTNO = '0000066'  AND PARTICIPANTCODE =  CASE WHEN '' <> '' THEN '' ELSE PARTICIPANTCODE END  AND USER_ID = CASE WHEN '' <> '' THEN '' ELSE USER_ID END  AND ORDER_NO = CASE WHEN '' <> '' THEN '' ELSE ORDER_NO END  AND TRADE_NO = CASE W



  
HEN '' <> '' THEN '' ELSE TRADE_NO END   
  
  
  
UPDATE  FOSETTLEMENT SET  DUMMY1 = 1, PRICE = 123   
WHERE  SAUDA_DATE LIKE 'JUN 13 2006%'    
AND PARTY_CODE = '0A141'    
AND SYMBOL = 'ACC'    
AND INST_TYPE = 'FUTSTK'    
AND EXPIRYDATE LIKE 'JUN 29 2006%'    
AND STRIKE_PRICE = 0.0000    
AND OPTION_TYPE = ''    
AND SELL_BUY = 1    
AND CONTRACTNO = '0000066'    
AND PARTICIPANTCODE =  CASE WHEN '' <> '' THEN '' ELSE PARTICIPANTCODE END  AND USER_ID = CASE WHEN '' <> '' THEN '' ELSE USER_ID END  AND ORDER_NO = CASE WHEN '' <> '' THEN '' ELSE ORDER_NO END  AND TRADE_NO = CASE WHEN '' <> '' THEN '' ELSE TRADE_NO END



  
   
AND RESERVED1 = 1  
ROLLBACK  
  
------------------------------------------------------------------------------*/  
  
DECLARE  
  @CONTRACTNO VARCHAR(7),  
  @PARTYCODE VARCHAR(10),  
  @PARTICIPANT VARCHAR(30),  
  @TERMID VARCHAR(30),  
  @SYMBOL VARCHAR(10),  
  @OPTIONTYPE VARCHAR(3),  
  @SAUDADATE VARCHAR(11),  
  @EXPIRYDATE VARCHAR(11),  
  @INSTYPE VARCHAR(6),  
  @ORDERNO VARCHAR(16),  
  @TRADENO VARCHAR(14),  
  @STRIKEPRICE NUMERIC(18, 4),  
  @SELLBUY VARCHAR(1),  
  @MKTRATE NUMERIC(18, 4),  
  @NEWNETRATE NUMERIC(18, 4),  
  @OLDNETRATE NUMERIC(18, 4),  
  @RECORD VARCHAR(2000),  
  @RECNO INT,  
  @OPTION VARCHAR(1), /*0 - TO CONSOLIDATION , 1 - UN CONSOLIDATION*/  
  @LEVEL INT,  
  @QUERY VARCHAR(8000),
  @BROKERAGESTT CURSOR  
  
--EXEC CONSOLIDATETRANS ',,FIR001,,ABB,FUTSTK,25/11/2010,0,,15/11/2010,0,2,2,853.5000,0,0,0,DBNKRCTCRVFD,''|', 'N', 'HEMANTT/BROKER', '/FC.INTERFACE/INNERREPORT.ASPX'  


CREATE TABLE #BROKERAGE_STT_CALC
	(
		SAUDA_DATE VARCHAR(11),
		PARTY_CODE VARCHAR(10)
	)

SET @RECNO = 1  
  
WHILE 1 = 1  
  BEGIN  
   SET @RECORD = .DBO.PIECE(@FORMDATA, '|', @RECNO)  
   IF @RECORD IS NOT NULL AND @RECORD <> ''  
   BEGIN    
  SET @LEVEL = CONVERT(INT, LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 12))))  
  SET @CONTRACTNO = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 2)))  
  SET @PARTYCODE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 3)))  
  SET @TERMID = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 4)))  
  IF @TERMID = '%' BEGIN SET @TERMID = '' END  
  SET @SYMBOL = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 5)))  
  SET @INSTYPE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 6)))  
  SET @EXPIRYDATE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 7)))  
  SET @EXPIRYDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EXPIRYDATE, 103), 109)  
  SET @STRIKEPRICE = CONVERT(NUMERIC(18, 4), LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 8))))  
  SET @OPTIONTYPE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 9)))  
  SET @SAUDADATE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 10)))  
  SET @SAUDADATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDADATE, 103), 109)  
  SET @OPTION = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 11)))  
  SET @SELLBUY = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 13)))  
    
  DELETE CHARGES_DETAIL  
  WHERE CD_SAUDA_DATE BETWEEN @SAUDADATE AND @SAUDADATE + ' 23:59'   
  AND CD_CONTRACT_NO = @CONTRACTNO       
  AND CD_PARTY_CODE =@PARTYCODE   
  AND CD_TRADE_NO ='' AND CD_STATUS = 'E'   
  
  
  IF @LEVEL = 3 OR @LEVEL = 4  
   BEGIN  
    SET @ORDERNO = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 8)))  
    IF @ORDERNO = '%' BEGIN SET @ORDERNO = '' END  
   END  
  ELSE  
   BEGIN  
    SET @ORDERNO = ''  
   END  
  
  IF @LEVEL = 4  
   BEGIN  
    SET @TRADENO = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 9)))  
    IF @TRADENO = '%' BEGIN SET @TRADENO = '' END  
   END  
  ELSE  
   BEGIN  
    SET @TRADENO = ''  
   END  
      
  IF @OPTION = '0'  
  BEGIN  
   SET @MKTRATE = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 14)))  
   SET @NEWNETRATE = CONVERT(NUMERIC(18, 4), LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 15))))  
   SET @OLDNETRATE = CONVERT(NUMERIC(18, 4), LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 16))))  
   SET @PARTICIPANT = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 17)))  
  END  
  IF @OPTION = '1'  
  BEGIN  
   SET @PARTICIPANT = LTRIM(RTRIM(.DBO.PIECE(@RECORD, ',', 14)))  
  END   

  -- PRINT @OPTION  
  IF @OPTION = '0'  
  BEGIN  
   IF @AFTERBEFORE = 'Y'  
    BEGIN  



     IF @NEWNETRATE <> @OLDNETRATE  
      BEGIN  
       EXEC CALCULATE_BROKERAGE  @RECORD  
      END  
     ELSE  
     BEGIN  
      -- PRINT 'CAME HERE'  
      UPDATE  
       FOSETTLEMENT  
      SET  
       DUMMY1 = 1, PRICE = @MKTRATE  
       WHERE  
       SAUDA_DATE LIKE @SAUDADATE + '%'  
       AND PARTY_CODE = @PARTYCODE  
       AND SYMBOL = @SYMBOL  
       AND INST_TYPE = @INSTYPE  
       AND EXPIRYDATE LIKE @EXPIRYDATE + '%'  
       AND STRIKE_PRICE = @STRIKEPRICE  
       AND OPTION_TYPE = @OPTIONTYPE  
       AND SELL_BUY = @SELLBUY  
       AND CONTRACTNO = @CONTRACTNO  
       AND PARTICIPANTCODE = CASE WHEN @PARTICIPANT <> '' THEN @PARTICIPANT ELSE PARTICIPANTCODE END  
       AND USER_ID = CASE WHEN @TERMID <> '' THEN @TERMID ELSE USER_ID END  
       AND ORDER_NO = CASE WHEN @ORDERNO <> '' THEN @ORDERNO ELSE ORDER_NO END  
       AND TRADE_NO = CASE WHEN @TRADENO <> '' THEN @TRADENO ELSE TRADE_NO END  
       AND RESERVED1 = 1  
     END  
		INSERT INTO #BROKERAGE_STT_CALC(SAUDA_DATE,PARTY_CODE)VALUES(@SAUDADATE,@PARTYCODE)
 
    END  
   ELSE  
   BEGIN  
    UPDATE  
     FOTRADE  
    SET  
     PRICE = @MKTRATE,  
     RESERVED4 = '1'  
    WHERE  
     PARTY_CODE = @PARTYCODE  
     AND SYMBOL = @SYMBOL  
     AND INST_TYPE = @INSTYPE  
     AND EXPIRYDATE LIKE @EXPIRYDATE + '%'  
     AND STRIKE_PRICE = @STRIKEPRICE  
     AND OPTION_TYPE = @OPTIONTYPE  
     AND SELL_BUY =  @SELLBUY  
     AND PARTICIPANTCODE = CASE WHEN @PARTICIPANT <> '' THEN @PARTICIPANT ELSE PARTICIPANTCODE END  
     AND USER_ID = CASE WHEN @TERMID <> '' THEN @TERMID ELSE USER_ID END  
     AND ORDER_NO = CASE WHEN @ORDERNO <> '' THEN @ORDERNO ELSE ORDER_NO END  
     AND TRADE_NO = CASE WHEN @TRADENO <> '' THEN @TRADENO ELSE TRADE_NO END  
     --PRINT @EXPIRYDATE  
   END  
  END  
  ELSE  
  IF @AFTERBEFORE = 'Y'  
  BEGIN  
   UPDATE  
    FOSETTLEMENT  
   SET  
    DUMMY1 = 0, PRICE = DUMMY2, STATUS = 11  
   WHERE  
    SAUDA_DATE LIKE @SAUDADATE + '%'  
    AND PARTY_CODE = @PARTYCODE  
    AND SYMBOL = @SYMBOL  
    AND INST_TYPE = @INSTYPE  
    AND EXPIRYDATE LIKE @EXPIRYDATE + '%'  
    AND STRIKE_PRICE = @STRIKEPRICE  
    AND OPTION_TYPE = @OPTIONTYPE  
    AND SELL_BUY =  @SELLBUY  
    AND CONTRACTNO =  @CONTRACTNO  
    AND PARTICIPANTCODE = CASE WHEN @PARTICIPANT <> '' THEN @PARTICIPANT ELSE PARTICIPANTCODE END  
    AND USER_ID = CASE WHEN @TERMID <> '' THEN @TERMID ELSE USER_ID END  
    AND ORDER_NO = CASE WHEN @ORDERNO <> '' THEN @ORDERNO ELSE ORDER_NO END  
    AND TRADE_NO = CASE WHEN @TRADENO <> '' THEN @TRADENO ELSE TRADE_NO END  
    AND RESERVED1 = 1  
  END  
  
  ELSE  
   BEGIN  
    UPDATE  
     FOTRADE  
    SET  
     RESERVED4 = '',  
     PRICE = RESERVED1  
    WHERE  
     PARTY_CODE = @PARTYCODE  
     AND SYMBOL = @SYMBOL  
     AND INST_TYPE = @INSTYPE  
     AND EXPIRYDATE LIKE @EXPIRYDATE + '%'  
     AND STRIKE_PRICE = @STRIKEPRICE  
     AND OPTION_TYPE = @OPTIONTYPE  
     AND SELL_BUY =  @SELLBUY  
     AND PARTICIPANTCODE = CASE WHEN @PARTICIPANT <> '' THEN @PARTICIPANT ELSE PARTICIPANTCODE END  
     AND USER_ID = CASE WHEN @TERMID <> '' THEN @TERMID ELSE USER_ID END  
     AND ORDER_NO = CASE WHEN @ORDERNO <> '' THEN @ORDERNO ELSE ORDER_NO END  
     AND TRADE_NO = CASE WHEN @TRADENO <> '' THEN @TRADENO ELSE TRADE_NO END  
   END  
  
  
  SET @RECNO = @RECNO + 1  
  
  INSERT INTO INST_LOG  
  (  
   PARTY_CODE, NEW_PARTY_CODE, SAUDA_DATE,INST_TYPE,  
   SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE, ORDER_NO, TRADE_NO, SELL_BUY, CONTRACT_NO, NEW_CONTRACT_NO,  
   BROKERAGE, NEW_BROKERAGE, MARKET_RATE, NEW_MARKET_RATE, NET_RATE,  
   NEW_NET_RATE, QTY, NEW_QTY, PARTICIPANT_CODE, NEW_PARTICIPANT_CODE,  
   USERNAME, MODULE, CALLED_FROM, TIMESTAMP, EXTRAFIELD3, EXTRAFIELD4,  
   EXTRAFIELD5  
  )  
  SELECT  
   PARTY_CODE = ISNULL(@PARTYCODE, ''),  
   NEW_PARTY_CODE = ISNULL(@PARTYCODE, ''),  
   SAUDA_DATE = @SAUDADATE, 
   INST_TYPE =  ISNULL(@INSTYPE, ''), 
   SYMBOL = ISNULL(@SYMBOL, ''), 
   EXPIRYDATE = ISNULL(@EXPIRYDATE, ''), 
   STRIKE_PRICE= ISNULL(@STRIKEPRICE, ''), 
   OPTION_TYPE= ISNULL(@OPTIONTYPE, ''), 
   ORDER_NO = '',  
   TRADE_NO = '',  
   SELL_BUY = ISNULL(@SELLBUY, ''),  
   CONTRACT_NO = ISNULL(@CONTRACTNO, ''),  
   NEW_CONTRACT_NO = ISNULL(@CONTRACTNO, ''),  
   BROKERAGE = 0,  
   NEW_BROKERAGE = 0,  
   MARKET_RATE = ISNULL(@MKTRATE, 0),  
   NEW_MARKET_RATE = ISNULL(@MKTRATE, 0),  
   NET_RATE = ISNULL(@OLDNETRATE, 0),  
   NEW_NET_RATE = ISNULL(@NEWNETRATE, 0),  
   QTY = 0,  
   NEW_QTY = 0,  
   PARTICIPANT_CODE = ISNULL(@PARTICIPANT, ''),  
   NEW_PARTICIPANT_CODE = '',  
   USERNAME = @STATUSNAME,  
   MODULE = @MODULE,  
   CALLED_FROM = 'CONSOLIDATETRANS_SP',  
   TIMESTAMP = GETDATE(),  
   EXTRAFIELD3 = '',  
   EXTRAFIELD4 = '',  
   EXTRAFIELD5 = ''  
 END  
   ELSE  
    BEGIN  
     BREAK  
    END  
  END  

SET @BROKERAGESTT = CURSOR FOR SELECT DISTINCT SAUDA_DATE,PARTY_CODE FROM #BROKERAGE_STT_CALC
OPEN @BROKERAGESTT
FETCH NEXT FROM @BROKERAGESTT INTO @SAUDADATE,@PARTYCODE
WHILE @@FETCH_STATUS = 0
	BEGIN
		EXEC PROC_TRADE_TRANSFER_RECAL @SAUDADATE, @PARTYCODE, '', '', '', 0, '' 
		EXEC STT_CHARGES_FINAL @SAUDADATE, @PARTYCODE, @PARTYCODE, @STATUSNAME  
		FETCH NEXT FROM @BROKERAGESTT INTO @SAUDADATE,@PARTYCODE
	END
CLOSE @BROKERAGESTT
DEALLOCATE @BROKERAGESTT

DROP TABLE #BROKERAGE_STT_CALC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATE_CLASS_USER
-- --------------------------------------------------
CREATE PROC [dbo].[CREATE_CLASS_USER]  
(
 @FLDAUTO VARCHAR(50),	  
 @USERNAME VARCHAR(25),  
 @PASSWORD VARCHAR(50),  
 @FIRSTNAME VARCHAR(25),  
 @MIDDLENAME VARCHAR(25),  
 @LASTNAME VARCHAR(25),  
 @SEX  VARCHAR(8),  
 @ADD1  VARCHAR(100),  
 @MAILADD2 VARCHAR(100),  
 @PHONE1  VARCHAR(10),  
 @PHONE2  VARCHAR(10),   
 @CATEGORY VARCHAR(10),  
 @ADMIN_AUTO INT,  
 @STNAME  VARCHAR(50),  
 @ADMIN_NAME VARCHAR(30),  
 @IPADD  VARCHAR(20),  
 @PWDEXPIRYDAYS SMALLINT,  
 @USERSTATUS SMALLINT,  
 @ATTEMPTCOUNT SMALLINT,  
 @MAXATTEMPTCOUNT SMALLINT,  
 @ACCESSLEVEL CHAR(1),  
 @LOGINSTATUS SMALLINT,
 @FIRSTLOGIN CHAR(1),	
 @USERIPADDRESS VARCHAR(2000),
 @USERTYPE VARCHAR(25), 	
 @EXCHANGE VARCHAR(3),
 @SEGMENT VARCHAR(20),
 @CREATION_FLAG VARCHAR(3), --ALL OR SINGLE SEGMENT
 @ACTION_FLAG VARCHAR(20), -- EDIT OR REGISTER 
 @FLD_MAC_ID VARCHAR(200)
)  
  
AS
DECLARE   
 @@EDIT_FLAG  CHAR(1),  
 @@NEWDATE  VARCHAR(11), 
 @@EXPDATE  VARCHAR(11), 	 
 @@FLDLOG_DATA VARCHAR(8000),  
 @@FLDAUTO  INT,  
 @@FLDAUTO_NEW INT,
 @@FLDADMINAUTO INT,	
 @@ERROR_COUNT BIGINT,  
 @MESSAGE  VARCHAR(200),
 @MOB_ACCESS SMALLINT,
 @RESULT VARCHAR(MAX)


BEGIN TRAN   
/*SELECT TOP 1 FLDUSERNAME = '12',FLDFIRSTNAME = '54',RESULT = 'PRADNYA & USER CONTROL MASTER NOT POPULATED PROPERLY!',EXCHANGE = '54', SEGMENT = '54'
FROM TBLPRADNYAUSERS
ROLLBACK 
RETURN	*/

SET @@NEWDATE = CONVERT(VARCHAR,GETDATE(),109)  
SET @@EXPDATE = CONVERT(VARCHAR,GETDATE() + @PWDEXPIRYDAYS,109)  
/*SELECT 
	@MOB_ACCESS = MOB_ACCESS 
FROM 
	PRADNYA.DBO.ADMIN_INFO*/

IF UPPER(@ACTION_FLAG) = 'EDIT' 
 BEGIN
	SET @@EDIT_FLAG = 'E' 
	SET @@FLDLOG_DATA = '' 
 END
ELSE
 IF UPPER(@ACTION_FLAG) = 'REGISTER' 
  BEGIN
	SET @@EDIT_FLAG = 'A' 
	SET @@FLDLOG_DATA = 'ADDENTRY' 
  END	
ELSE
 IF UPPER(@ACTION_FLAG) = 'DELETE'
  BEGIN
	SET @@EDIT_FLAG = 'D' 
	SET @@FLDLOG_DATA = ''   
  END 

--BEGIN TRY
	IF UPPER(@ACTION_FLAG) = 'EDIT' 
     BEGIN
		
		SELECT @@FLDAUTO = FLDAUTO, @@FLDADMINAUTO = FLDADMINAUTO FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = @USERNAME
	
		SELECT   
		 @@ERROR_COUNT = COUNT(FLDUSERNAME)
		FROM     
		 TBLPRADNYAUSERS (NOLOCK)   
		WHERE  
		 FLDUSERNAME = @USERNAME 
		
		IF @@ERROR_COUNT <> 0    
		BEGIN 
		
		SELECT 
			@@FLDLOG_DATA = FLDPASSWORD +'~'+ 
			CASE WHEN FLDFIRSTNAME = '' THEN '$' ELSE FLDFIRSTNAME END +'~'+
			CASE WHEN FLDMIDDLENAME = '' THEN '$' ELSE FLDMIDDLENAME END +'~'+
			CASE WHEN FLDLASTNAME = '' THEN '$' ELSE FLDLASTNAME END +'~'+
			CASE WHEN FLDSEX = '' THEN '$' ELSE FLDSEX END +'~'+
			CASE WHEN FLDADDRESS1 = '' THEN '$' ELSE FLDADDRESS1 END +'~'+
			CASE WHEN FLDADDRESS2 = '' THEN '$' ELSE FLDADDRESS2 END  +'~'+
			CASE WHEN FLDPHONE1 = '' THEN '$' ELSE FLDPHONE1 END +'~'+
			CASE WHEN FLDPHONE2 = '' THEN '$' ELSE FLDPHONE2 END +'~'+
			CASE WHEN CONVERT(VARCHAR,FLDCATEGORY) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDCATEGORY) END+'~'+
			CASE WHEN CONVERT(VARCHAR,PWD_EXPIRY_DATE) = '' THEN '$' ELSE CONVERT(VARCHAR,PWD_EXPIRY_DATE) END +'~'+ 
			CASE WHEN CONVERT(VARCHAR,FLDATTEMPTCNT) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDATTEMPTCNT) END +'~'+
			CASE WHEN CONVERT(VARCHAR,FLDSTATUS) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDSTATUS) END +'~'+
			CASE WHEN CONVERT(VARCHAR,FLDLOGINFLAG) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDLOGINFLAG) END +'~'+
			CASE WHEN FLDACCESSLVL = '' THEN '$' ELSE FLDACCESSLVL END +'~'+
			CASE WHEN FLDIPADD  = '' THEN '$' ELSE FLDIPADD END+'~'+
			CASE WHEN CONVERT(VARCHAR,FLDTIMEOUT) = '' THEN '$' ELSE FLDFIRSTLOGIN END +'~'+
			CASE WHEN FLDFIRSTLOGIN = '' THEN '$' ELSE FLDFIRSTLOGIN END +'~'+ 
			CASE WHEN CONVERT(VARCHAR,FLDFORCELOGOUT) = '' THEN '$' ELSE CONVERT(VARCHAR,FLDFORCELOGOUT) END +'~'+
			CASE WHEN FLD_MAC_ID = '' THEN '$' ELSE FLD_MAC_ID END
		FROM 
			TBLPRADNYAUSERS TP, TBLUSERCONTROLMASTER TU 
		WHERE 
			TP.FLDAUTO = FLDUSERID
			AND FLDUSERNAME = @USERNAME 
		
		-- CLASS USER LOG TABLE ------------------------------  
		INSERT INTO   
		TBLPRADNYAUSERS_LOG  
		(  
		FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2,  
		FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, EDIT_FLAG, CREATED_BY, CREATED_ON, MACHINEIP, FLDLOG_DATA  
		)  
		SELECT  
			FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1,  
			FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, @@NEWDATE, @@EDIT_FLAG, @ADMIN_NAME, @@NEWDATE, @IPADD, @@FLDLOG_DATA  
		FROM   
			TBLPRADNYAUSERS  
		WHERE   
			FLDUSERNAME =@USERNAME  

		INSERT INTO   
			TBLUSERCONTROLMASTER_JRNL   
		SELECT   
			*,@@FLDADMINAUTO,@@NEWDATE   
		FROM   
			TBLUSERCONTROLMASTER  
		WHERE   
			FLDUSERID = @FLDAUTO  
		
		UPDATE 
			TBLPRADNYAUSERS 
		SET 
			FLDUSERNAME = @USERNAME, FLDPASSWORD = @PASSWORD, FLDFIRSTNAME = @FIRSTNAME, FLDMIDDLENAME = @MIDDLENAME,
			FLDLASTNAME = @LASTNAME, FLDSEX = @SEX,	FLDADDRESS1 = @ADD1, FLDADDRESS2 = @MAILADD2, FLDPHONE1 = @PHONE1,
			FLDPHONE2 = @PHONE2, FLDCATEGORY = @CATEGORY, FLDSTNAME = @STNAME, PWD_EXPIRY_DATE = @@EXPDATE, EDIT_FLAG = @@EDIT_FLAG 
		WHERE 
			FLDAUTO = @FLDAUTO
		
		
		UPDATE 
			TBLUSERCONTROLMASTER
		SET
			FLDPWDEXPIRY = @PWDEXPIRYDAYS, FLDMAXATTEMPT = @MAXATTEMPTCOUNT, FLDATTEMPTCNT = @ATTEMPTCOUNT, FLDSTATUS = @USERSTATUS,
			FLDLOGINFLAG = @LOGINSTATUS, FLDACCESSLVL = @ACCESSLEVEL, FLDIPADD = @USERIPADDRESS, FLDFIRSTLOGIN = @FIRSTLOGIN, FLD_MAC_ID = @FLD_MAC_ID
		WHERE 
			FLDUSERID = @FLDAUTO

		SET @RESULT = 'EDITED SUCCESSFULLY'
	  	
		IF @@ERROR = 0
		 BEGIN
			INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
			SELECT @USERNAME,@FIRSTNAME, @RESULT ,'',''
		 END
		END
 		ELSE
		 BEGIN
			SET @MESSAGE = 'USER DOST NOT EXIST IN SYSTEM!'    
			INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
			SELECT @USERNAME,@FIRSTNAME, @MESSAGE ,'','' 
		 END 
	 END
   	ELSE	
	 BEGIN
		SELECT   
		 @@ERROR_COUNT = COUNT(FLDUSERNAME)
		FROM     
		 TBLPRADNYAUSERS (NOLOCK)   
		WHERE  
		 FLDUSERNAME =@USERNAME 
		
		IF @@ERROR_COUNT = 0    
		 BEGIN   
				--MAIN CLASS USER TABLE------------------------------  
			INSERT INTO   
			 TBLPRADNYAUSERS  
			(  
			 FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, 
			 FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE,EDIT_FLAG, CREATED_BY, MODIFIED_BY  
			)  
			VALUES  
			(  
			 @USERNAME, @PASSWORD, @FIRSTNAME, @MIDDLENAME, @LASTNAME, @SEX, @ADD1, @MAILADD2, @PHONE1, @PHONE2, @CATEGORY,   
			 @ADMIN_AUTO, @STNAME, @@EXPDATE, @@EDIT_FLAG, @ADMIN_NAME, @ADMIN_NAME   
			)  
		  
			-- CLASS USER LOG TABLE ------------------------------  
			INSERT INTO   
			 TBLPRADNYAUSERS_LOG  
			(  
			 FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2,  
			 FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, EDIT_FLAG, CREATED_BY, CREATED_ON, MACHINEIP, FLDLOG_DATA  
			)  
			SELECT  
			 FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1,  
			 FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, @@NEWDATE, @@EDIT_FLAG, @ADMIN_NAME, @@NEWDATE, @IPADD, @@FLDLOG_DATA  
			FROM   
			 TBLPRADNYAUSERS  
			WHERE   
			 FLDUSERNAME =@USERNAME  
		 
		 
			SELECT @@FLDAUTO_NEW = FLDAUTO FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = @USERNAME
			
			-- USER CONTROL MASTER TABLE -----------------------------  
			INSERT INTO TBLUSERCONTROLMASTER 
				(
				FLDUSERID,
				FLDPWDEXPIRY,
				FLDMAXATTEMPT,
				FLDATTEMPTCNT,
				FLDSTATUS,
				FLDLOGINFLAG,
				FLDACCESSLVL,
				FLDIPADD,
				FLDTIMEOUT,
				FLDFIRSTLOGIN,
				FLDFORCELOGOUT,
				FLD_MAC_ID
				)  
			SELECT   
				A.FLDAUTO, 
				@PWDEXPIRYDAYS, 
				@MAXATTEMPTCOUNT,
				@ATTEMPTCOUNT, 
				@USERSTATUS, 
				0, 
				@ACCESSLEVEL, 
				@USERIPADDRESS, 
				B.FLDTIMEOUT,  
				B.FLDFIRSTLOGIN, 
				B.FLDFORCELOGOUT, 
				@FLD_MAC_ID  
			FROM   
				TBLPRADNYAUSERS A LEFT OUTER JOIN TBLUSERCONTROLMASTER X  
			ON   
				(A.FLDAUTO = X.FLDUSERID), TBLUSERCONTROLGLOBALS B  
			WHERE   
				B.FLDCATEGORYID = A.FLDCATEGORY  
				AND ISNULL(A.FLDAUTO,0) = @@FLDAUTO_NEW  
		   
			--LOG USER CONTROL MASTER TABLE -----------------------------  
			  
			INSERT INTO   
			 TBLUSERCONTROLMASTER_JRNL   
			SELECT   
			 *,@@FLDADMINAUTO,@@NEWDATE   
			FROM   
			 TBLUSERCONTROLMASTER  
			WHERE   
			 FLDUSERID = @FLDAUTO  
		  
			--FOR MOBILE USER 
			/*IF @MOB_ACCESS = 1 AND @USERTYPE = 'CLIENT'
			  BEGIN
				INSERT INTO PRADNYA.DBO.USER_INFO (CLIENTID,USERNAME,LASTNAME,MAILID,STATUS_FLAG,EXCHANGE,SEGMENT,LOGIN_FLAG)
				SELECT 
					FLDUSERNAME, FLDFIRSTNAME, FLDLASTNAME, FLDADDRESS2, 1, EXCHANGE = @EXCHANGE+'', SEGMENT = '|'+@SEGMENT, LOGIN_FLAG = 0 
				FROM 
					TBLPRADNYAUSERS 
				WHERE
					 FLDUSERNAME = @USERNAME  
			  END */  		
			
			SET @RESULT = 'CREATED SUCCESSFULLY..'
	  	
			IF @@ERROR = 0
			 BEGIN
				SELECT  
					FLDUSERNAME, FLDFIRSTNAME, RESULT = @RESULT, EXCHANGE='', SEGMENT = '' INTO #RES 
				FROM 
					TBLPRADNYAUSERS TP, TBLUSERCONTROLMASTER TU
				WHERE
					 FLDUSERNAME = @USERNAME 
					 AND TP.FLDAUTO = TU.FLDUSERID
				
				IF @@ROWCOUNT = 0 
				 BEGIN
					ROLLBACK TRAN
					INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
					SELECT FLDUSERNAME = '',FLDFIRSTNAME = '',RESULT = 'PRADNYA & USER CONTROL MASTER NOT POPULATED PROPERLY!',EXCHANGE = '', SEGMENT = ''
					RETURN	
				 END
				ELSE
				 BEGIN
					INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
					SELECT * FROM #RES
				 END	
			 END 
		  END
		ELSE 
		 BEGIN
			SET @MESSAGE = 'USER ALREADY EXIST IN SYSTEM!'
			INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)    
			SELECT @USERNAME,'', @MESSAGE ,'','' 
		 END 
	END			
/*END TRY
BEGIN CATCH
	SELECT 
        ERROR_MESSAGE() AS MESSAGE;
		ROLLBACK
END CATCH*/
IF @@ERROR = 0
 BEGIN
	COMMIT TRAN
 END
ELSE
 BEGIN
	ROLLBACK TRAN	
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATE_CLASS_USER_ALL
-- --------------------------------------------------
CREATE PROC [dbo].[CREATE_CLASS_USER_ALL]
(
	 @FLDAUTO		VARCHAR(50),	  
	 @USERNAME		VARCHAR(25),  
	 @PASSWORD		VARCHAR(50),  
	 @FIRSTNAME		VARCHAR(25),  
	 @MIDDLENAME	VARCHAR(25),  
	 @LASTNAME		VARCHAR(25),  
	 @SEX			VARCHAR(8),  
	 @ADD1			VARCHAR(100),  
	 @MAILADD2		VARCHAR(100),  
	 @PHONE1		VARCHAR(10),  
	 @PHONE2		VARCHAR(10),   
	 @CATEGORY		VARCHAR(10),  
	 @ADMIN_AUTO	INT,  
	 @STNAME		VARCHAR(50),  
	 @ADMIN_NAME	VARCHAR(30),  
	 @IPADD			VARCHAR(20),  
	 @PWDEXPIRYDAYS SMALLINT,  
	 @USERSTATUS	SMALLINT,  
	 @ATTEMPTCOUNT	SMALLINT,  
	 @MAXATTEMPTCOUNT SMALLINT,  
	 @ACCESSLEVEL	CHAR(1),  
	 @LOGINSTATUS	SMALLINT,
	 @FIRSTLOGIN	CHAR(1),	
	 @USERIPADDRESS VARCHAR(2000),
	 @USERTYPE		VARCHAR(25), 	
	 @EXCHANGE		VARCHAR(3),
	 @SEGMENT		VARCHAR(20),
	 @EXCSEG		VARCHAR(MAX),
	 @CREATION_FLAG VARCHAR(10), --ALL OR SINGLE SEGMENT
	 @ACTION_FLAG	VARCHAR(20), -- EDIT OR REGISTER 
	 @FLD_MAC_ID	VARCHAR(200)	
)

AS
/*
BEGIN TRAN
[CREATE_CLASS_USER_ALL]  '80662',  'AJAY',  'A8EE7FDD1FA67206',  'AJAY',  'N',  'SENGAR',  'MALE',  'MUMBAI',  'A@C.C',  '46454',  '',  '400',  '2',  'BROKER',  'ADMINISTRATOR',  '10.11.12.74',  '30',  2,  0,  6,  'F',  0,  'N',  '10.11.12.74',  'BROKER',  
'NSE',  'CAPITAL',  '',  'MULTI',  'EDIT',
'10.11.12.74'  

ROLLBACK	
SELECT FLDAUTO_ADMIN FROM [MTSRVR06\DEV].NSEFO.DBO.TBLADMIN WHERE FLDNAME = 'BROKER' 
INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) 
SELECT * FROM NSEFO..TBLPRADNYAUSERS WHERE FLDUSERNAME = 'AJAY'
EXECUTE CREATE_CLASS_USER_ALL  '',  'ALL',  'B5A07E53E1EF805D',  'BHRT',  'BHRT',  'BHRT',  'MALE',  'MUM',  'A@C.N',  '9898989898',  '9989889898',  '388',  '2',  'BROKER',  'ADMINISTRATOR',  '10.11.12.74',  '31',  2,  0,  6,  'F',  0,  'Y',  '',  'BROKER',  'NSE',  'CAPITAL',  'BSE~CAPITAL,NSE~CAPITAL,BSE~FUTURES,NSE~FUTURES,',  'CHOOSE',  'REGISTER',  '' 
*/
BEGIN TRY
 CREATE TABLE [DBO].[#DBNAME]  
 (  
	SHAREDB VARCHAR(50),
	SHARESERVER VARCHAR(50),
	EXCHANGE VARCHAR(6),   
	SEGMENT VARCHAR(10)
 ) ON [PRIMARY]  

 CREATE TABLE [DBO].[#RESULT]  
 (  
	UNAME VARCHAR(50),
	FIRSTNAME VARCHAR(50),
	EXCHANGE VARCHAR(6),   
	SEGMENT VARCHAR(10),
	RESULT VARCHAR(MAX)
 ) ON [PRIMARY]

 CREATE TABLE [DBO].#ADMIN_AUTO
 (
	ADMIN_AUTO INT	
 ) ON [PRIMARY]

 CREATE TABLE [DBO].#MKCK
 (
	MKCKFLAG INT	
 )
	
 CREATE TABLE [DBO].#CATEGORY
 (
	CATEGORY VARCHAR(50),
	CATEGORYCODE INT
 ) ON [PRIMARY]
 CREATE TABLE [DBO].#PRADNYA
 (
	FLDAUTO	INT,
	FLDADMINAUTO INT
 )

DECLARE  
 @@SHAREDB VARCHAR(20),	  
 @@SHARESVR VARCHAR(20),  
 @@EXCHANGE VARCHAR(15),  
 @@SEGMENT VARCHAR(15),  
 @@ORDERFLAG VARCHAR(1),  
 @@SQL VARCHAR(5000),
 @@DB VARCHAR(MAX),
 @@SEGORD TINYINT,
 @@FLDNAME VARCHAR(30),	
 @@CATFLAG INT,	  
 @@CATNAME VARCHAR(50),
 @@MKCKFLAG INT,
 @@FLDAUTO	INT,
 @@FLDADMINAUTO INT,	 	
 @@MAINREC AS CURSOR  
 

	SELECT @@FLDNAME = FLDNAME FROM TBLADMIN WHERE FLDAUTO_ADMIN = @ADMIN_AUTO
	SELECT @@CATNAME = FLDCATEGORYNAME FROM TBLCATEGORY WHERE FLDCATEGORYCODE = @CATEGORY
	
	SET @@DB = " INSERT INTO #DBNAME "   
	SET @@DB = @@DB + " SELECT "
	SET @@DB = @@DB + "		SHAREDB, SHARESERVER, EXCHANGE, SEGMENT "
	SET @@DB = @@DB + " FROM "
	SET @@DB = @@DB + "		PRADNYA.DBO.MULTICOMPANY (NOLOCK) "
	SET @@DB = @@DB + " WHERE "
	SET @@DB = @@DB + " 	PRIMARYSERVER = 1 "
	IF UPPER(@CREATION_FLAG) = 'CHOOSE'
	 BEGIN	
		SET @@DB = @@DB + "		AND EXCHANGE+'~'+SEGMENT IN ('" + REPLACE(@EXCSEG,',',''',''') + "')  "
	 END
	ELSE
	 IF UPPER(@CREATION_FLAG) = 'SIN'
	  BEGIN	
		SET @@DB = @@DB + "		AND EXCHANGE+'~'+SEGMENT IN ( '"+@EXCHANGE+"' +'~'+ '"+@SEGMENT+"' ) "
      END 
	 		
	SET @@DB = @@DB + " ORDER BY "
	SET @@DB = @@DB + "		EXCHANGE "  

	PRINT @@DB
	EXEC(@@DB)  

	SET @@MAINREC = CURSOR FOR  
	
	SELECT SHAREDB, SHARESERVER, EXCHANGE, SEGMENT FROM #DBNAME  
	SET @@SEGORD = 1  
	
	OPEN @@MAINREC  
	FETCH NEXT FROM @@MAINREC INTO @@SHAREDB, @@SHARESVR, @@EXCHANGE, @@SEGMENT  
		WHILE @@FETCH_STATUS = 0  
		BEGIN 
			IF @@SHARESVR <> @@SERVERNAME 
				BEGIN
					
					SET @@SQL = " INSERT INTO #ADMIN_AUTO SELECT FLDAUTO_ADMIN FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLADMIN WHERE FLDNAME = '"+ @@FLDNAME +"' "
					SET @@SQL = @@SQL + " INSERT INTO #CATEGORY SELECT FLDCATEGORYNAME,FLDCATEGORYCODE FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLCATEGORY WHERE FLDCATEGORYNAME = '"+ @@CATNAME + "' "
					SET @@SQL = @@SQL + " INSERT INTO #MKCK SELECT MKCKFLAG FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLGLOBALPARAMS "
					SET @@SQL = @@SQL + " INSERT INTO #PRADNYA SELECT FLDAUTO, FLDADMINAUTO FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+@USERNAME+"' "
				END
			 ELSE
				BEGIN	
					SET @@SQL = " INSERT INTO #ADMIN_AUTO SELECT FLDAUTO_ADMIN FROM " + @@SHAREDB + ".DBO.TBLADMIN WHERE FLDNAME = '"+ @@FLDNAME +"' "
					SET @@SQL = @@SQL + " INSERT INTO #CATEGORY SELECT FLDCATEGORYNAME,FLDCATEGORYCODE FROM " + @@SHAREDB + ".DBO.TBLCATEGORY WHERE FLDCATEGORYNAME = '"+ @@CATNAME +"' "
					SET @@SQL = @@SQL + " INSERT INTO #MKCK SELECT MKCKFLAG FROM " + @@SHAREDB + ".DBO.TBLGLOBALPARAMS "
					SET @@SQL = @@SQL + " INSERT INTO #PRADNYA SELECT FLDAUTO, FLDADMINAUTO FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+@USERNAME+"' "
				END
		
			PRINT @@SQL	
			EXEC(@@SQL)

			SELECT @@MKCKFLAG = MKCKFLAG FROM #MKCK
			--SELECT @@FLDAUTO = FLDAUTO, @@FLDADMINAUTO = FLDADMINAUTO FROM #PRADNYA	 				
			SELECT @CATEGORY = CATEGORYCODE FROM #CATEGORY 
			SELECT @ADMIN_AUTO = ADMIN_AUTO FROM #ADMIN_AUTO
			
						
			IF @@ROWCOUNT = 0 
			 BEGIN
				INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) VALUES('','','ADMINISTRATOR IS NOT AVAILABLE IN THIS EXCH - SEG','','')
			 END
			ELSE
			 IF (SELECT COUNT(1) FROM #CATEGORY ) = 0
				BEGIN
					INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) VALUES('','','USER CATEGORY IS NOT AVAILABLE IN THIS EXCH - SEG','','')		
				END			
			ELSE
			 BEGIN	
			 --SET @@SQL = " INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT) "
			 IF @@SHARESVR <> @@SERVERNAME 
				BEGIN
					SET @@SQL = @@SQL + " EXEC " + @@SHARESVR + "." + @@SHAREDB + ".DBO.CREATE_CLASS_USER "
				END
			 ELSE
				BEGIN	
					SET @@SQL = @@SQL + " EXEC " + @@SHAREDB + ".DBO.CREATE_CLASS_USER "
				END
			SET @@SQL = @@SQL + "  '" + @FLDAUTO + "' "
			SET @@SQL = @@SQL + ", '" + @USERNAME + "' "
			SET @@SQL = @@SQL + ", '" + @PASSWORD + "' "
			SET @@SQL = @@SQL + ", '" + @FIRSTNAME + "' "
			SET @@SQL = @@SQL + ", '" + @MIDDLENAME + "' "
			SET @@SQL = @@SQL + ", '" + @LASTNAME + "' "
			SET @@SQL = @@SQL + ", '" + @SEX + "' "
			SET @@SQL = @@SQL + ", '" + @ADD1 + "' "
			SET @@SQL = @@SQL + ", '" + @MAILADD2 + "' "
			SET @@SQL = @@SQL + ", '" + @PHONE1 + "' "
			SET @@SQL = @@SQL + ", '" + @PHONE2 + "' "
			SET @@SQL = @@SQL + ", '" + @CATEGORY + "' "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@ADMIN_AUTO) + " "
			SET @@SQL = @@SQL + ", '" + @STNAME + "' "
			SET @@SQL = @@SQL + ", '" + @ADMIN_NAME + "' "
			SET @@SQL = @@SQL + ", '" + @IPADD + "' "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@PWDEXPIRYDAYS) + " "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,CASE WHEN @@MKCKFLAG = 0 THEN 0 ELSE @USERSTATUS END) + " "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@ATTEMPTCOUNT) + " "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@MAXATTEMPTCOUNT) + " "
			SET @@SQL = @@SQL + ", '" + @ACCESSLEVEL + "' "
			SET @@SQL = @@SQL + ",  " + CONVERT(VARCHAR,@LOGINSTATUS) + " "
			SET @@SQL = @@SQL + ", '" + @FIRSTLOGIN + "' "
			SET @@SQL = @@SQL + ", '" + @USERIPADDRESS + "' "
			SET @@SQL = @@SQL + ", '" + @USERTYPE + "' "
			SET @@SQL = @@SQL + ", '" + @EXCHANGE + "' " 
			SET @@SQL = @@SQL + ", '" + @SEGMENT + "' " 
			SET @@SQL = @@SQL + ", '" + @CREATION_FLAG + "' " 
			SET @@SQL = @@SQL + ", '" + @ACTION_FLAG + "' " 
			SET @@SQL = @@SQL + ", '" + @FLD_MAC_ID + "' " 
			PRINT (@@SQL)
			EXEC(@@SQL)
		   END	

			UPDATE 
				#RESULT
			SET 
				EXCHANGE = @@EXCHANGE,
				SEGMENT = @@SEGMENT
			WHERE 
				EXCHANGE = '' AND SEGMENT = ''
			
			TRUNCATE TABLE #ADMIN_AUTO
			TRUNCATE TABLE #MKCK
			TRUNCATE TABLE #CATEGORY		
	SET @@SEGORD = @@SEGORD + 1  
	FETCH NEXT FROM @@MAINREC INTO @@SHAREDB, @@SHARESVR, @@EXCHANGE, @@SEGMENT
	END 

	SELECT * FROM #RESULT
	TRUNCATE TABLE #DBNAME  
	DROP TABLE #DBNAME
END TRY
BEGIN CATCH
	INSERT INTO #RESULT (UNAME,FIRSTNAME,RESULT, EXCHANGE, SEGMENT)
	SELECT '','',
        ERROR_MESSAGE() AS MESSAGE,'','';
        
        SELECT * FROM #RESULT
		ROLLBACK
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CREATEMENU
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CREATEMENU]   
(  
 @FLDREPORTNAME VARCHAR (35),  
 @FLDPATH VARCHAR (500)  
)  AS
  
SET @FLDPATH = UPPER(REPLACE(@FLDPATH,'\','/'))  
   
IF (SELECT COUNT(1) FROM TBLREPORTS (NOLOCK) WHERE FLDPATH =@FLDPATH) = 0  
BEGIN  
 DECLARE @INTMNUGRP INT  
 DECLARE @INTREPORTGRP INT  
   
 SET @INTMNUGRP = 7  
 SET @INTREPORTGRP = 0  
   
 SELECT @INTMNUGRP = FLDMENUCODE FROM TBLMENUHEAD (NOLOCK) WHERE FLDMENUNAME ='UTILITIES'  
 SELECT @INTREPORTGRP = MAX(FLDREPORTGRP) FROM TBLREPORTGRP (NOLOCK) WHERE FLDMENUGRP = @INTMNUGRP  
 SELECT TOP 1 @INTREPORTGRP= FLDREPORTGRP FROM TBLREPORTGRP (NOLOCK) WHERE FLDMENUGRP = @INTMNUGRP AND FLDGRPNAME LIKE '%UTILITIES%'  
   
 INSERT INTO TBLREPORTS  
 SELECT   
  FLDREPORTNAME=@FLDREPORTNAME,  
  FLDPATH=@FLDPATH,  
  FLDTARGET= LOWER('FRA') +'T' + LOWER('OPIC'),  
  FLDDESC =@FLDREPORTNAME,  
  FLDREPORTGRP=@INTREPORTGRP,  
  FLDMENUGRP=@INTMNUGRP,  
  FLDSTATUS='A'+ LOWER('LL'),  
  FLDORDER=0  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DELETE_CLASS_USER_ALL
-- --------------------------------------------------
CREATE PROC [dbo].[DELETE_CLASS_USER_ALL]
(
	@UNAME		VARCHAR(30),
	@EXCSEG		VARCHAR(MAX),
	@IPADD		VARCHAR(20),
	@ADMIN_NAME VARCHAR(50)    

)
AS
/*
SELECT * FROM TBLPRADNYAUSERS
SELECT * FROM TBLUSERCONTROLMASTER_JRNL
MXM~FUTURES,NMC~FUTURES,NSE~CAPITAL,
EXEC DELETE_CLASS_USER_ALL 'ASASD', 'BCM~FUTURES,BSE~CAPITAL,NSE~CAPITAL,NXM~FUTURES,', '10.11.12.74', 'ADMINISTRATOR'
SP_HELPTEXT ADMIN_DELUSER
INSERT INTO #USER_AUTO 
SELECT FLDAUTO FROM [MTSRVR06\DEV].MCDXCDSPCM.DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = 'DS' 
*/
DECLARE  
 @@SHAREDB VARCHAR(20),
 @@SHARESVR VARCHAR(20),  
 @@EXCHANGE VARCHAR(15),  
 @@SEGMENT VARCHAR(15),  
 @@SQL VARCHAR(MAX),
 @@DB VARCHAR(MAX),
 @@SEGORD TINYINT,
 @@FLDAUTO INT,
 @ADMINID INT,
 @GLOBALDATE DATETIME,  
 @@MAINREC AS CURSOR  

 CREATE TABLE [DBO].[#DBNAME]  
 (  
	SHAREDB VARCHAR(50),
	SHARESERVER VARCHAR(50),
	EXCHANGE VARCHAR(6),   
	SEGMENT VARCHAR(10)
 ) ON [PRIMARY]  

 CREATE TABLE [DBO].#USER_AUTO
 (
	FLDAUTO INT	
 ) ON [PRIMARY]

 CREATE TABLE [DBO].#RESULT
 (
	UNAME VARCHAR(30),
	EXCHANGE VARCHAR(6),   
	SEGMENT VARCHAR(10),
	MSG VARCHAR(100)	
 )	
	SET @GLOBALDATE = GETDATE()  

	SET @@DB = " INSERT INTO #DBNAME "   
	SET @@DB = @@DB + " SELECT "
	SET @@DB = @@DB + "		SHAREDB, SHARESERVER, EXCHANGE, SEGMENT "
	SET @@DB = @@DB + " FROM "
	SET @@DB = @@DB + "		PRADNYA.DBO.MULTICOMPANY (NOLOCK) "
	SET @@DB = @@DB + " WHERE "
	SET @@DB = @@DB + " 	PRIMARYSERVER = 1 "
	SET @@DB = @@DB + "		AND EXCHANGE+'~'+SEGMENT IN ('" + REPLACE(@EXCSEG,',',''',''') + "')  "
	SET @@DB = @@DB + " ORDER BY "
	SET @@DB = @@DB + "		EXCHANGE "  
	PRINT @@DB
	EXEC(@@DB) 

	SET @@MAINREC = CURSOR FOR  
	SELECT SHAREDB, SHARESERVER, EXCHANGE, SEGMENT FROM #DBNAME  

	SET @@SEGORD = 1  
	
	OPEN @@MAINREC  
	FETCH NEXT FROM @@MAINREC INTO @@SHAREDB, @@SHARESVR, @@EXCHANGE, @@SEGMENT  
		WHILE @@FETCH_STATUS = 0  
		BEGIN 
			IF @@SHARESVR <> @@SERVERNAME 
				BEGIN
				
					SET @@SQL = " INSERT INTO #USER_AUTO SELECT FLDAUTO FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+ @UNAME +"' "
					EXEC(@@SQL)

					SELECT @@FLDAUTO = FLDAUTO FROM #USER_AUTO	
					
					SET @@SQL = " INSERT INTO " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS_LOG(FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, EDIT_FLAG, CREATED_BY, CREATED_ON, MACHINEIP, FLDLOG_DATA)  "
					SET @@SQL = @@SQL + " SELECT "
					SET @@SQL = @@SQL + " 	FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, 'D', '"+@ADMIN_NAME+"', '"+CONVERT(VARCHAR(11),@GLOBALDATE)+"', '"+@IPADD+"', 'DELETEENTRY' "
			  		SET @@SQL = @@SQL + " FROM "
					SET @@SQL = @@SQL + " 	" + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS  "
					SET @@SQL = @@SQL + "  WHERE  "
					SET @@SQL = @@SQL + " 	FLDAUTO = "+CONVERT(VARCHAR,@@FLDAUTO)+" "
					
					SET @@SQL = @@SQL + " INSERT INTO " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER_JRNL(FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, FLDSTATUS, FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT, FLDUPDTBY, FLDUPDTDT)  "
					SET @@SQL = @@SQL + " SELECT   "
					SET @@SQL = @@SQL + " 	  FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, FLDSTATUS, FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT, '"+@IPADD+"', '"+CONVERT(VARCHAR(11),@GLOBALDATE)+"' "
					SET @@SQL = @@SQL + " FROM   "
					SET @@SQL = @@SQL + "   " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER TBC  "
					SET @@SQL = @@SQL + " WHERE   "
					SET @@SQL = @@SQL + "   FLDUSERID = "+CONVERT(VARCHAR,@@FLDAUTO)+" "
    
					SET @@SQL = @@SQL + " DELETE FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDAUTO = "+ CONVERT(VARCHAR,@@FLDAUTO) +" "
					SET @@SQL = @@SQL + " DELETE FROM " + @@SHARESVR + "." + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER WHERE FLDUSERID = "+ CONVERT(VARCHAR,@@FLDAUTO) +" "
				END
			 ELSE
				BEGIN
					SET @@SQL = " INSERT INTO #USER_AUTO SELECT FLDAUTO FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDUSERNAME = '"+ @UNAME +"' "	
					EXEC(@@SQL)

					SELECT @@FLDAUTO = FLDAUTO FROM #USER_AUTO

					SET @@SQL = " INSERT INTO " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS_LOG(FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, EDIT_FLAG, CREATED_BY, CREATED_ON, MACHINEIP, FLDLOG_DATA)  "
					SET @@SQL = @@SQL + " SELECT "
					SET @@SQL = @@SQL + " 	FLDAUTO, FLDUSERNAME, FLDPASSWORD, FLDFIRSTNAME, FLDMIDDLENAME, FLDLASTNAME, FLDSEX, FLDADDRESS1, FLDADDRESS2, FLDPHONE1, FLDPHONE2, FLDCATEGORY, FLDADMINAUTO, FLDSTNAME, PWD_EXPIRY_DATE, 'D', '"+@ADMIN_NAME+"', '"+CONVERT(VARCHAR(11),@GLOBALDATE)+"', '"+@IPADD+"', 'DELETEENTRY' "
			  		SET @@SQL = @@SQL + " FROM   "
					SET @@SQL = @@SQL + " 	" + @@SHAREDB + ".DBO.TBLPRADNYAUSERS  "
					SET @@SQL = @@SQL + "  WHERE   "
					SET @@SQL = @@SQL + " 	FLDAUTO = "+CONVERT(VARCHAR,@@FLDAUTO)+" "

					SET @@SQL = @@SQL + " INSERT INTO " + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER_JRNL(FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, FLDSTATUS, FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT, FLDUPDTBY, FLDUPDTDT)  "
					SET @@SQL = @@SQL + " SELECT   "
					SET @@SQL = @@SQL + " 	  FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, FLDSTATUS, FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT, '"+@IPADD+"', '"+CONVERT(VARCHAR(11),@GLOBALDATE)+"' "
					SET @@SQL = @@SQL + " FROM   "
					SET @@SQL = @@SQL + "   " + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER   "
					SET @@SQL = @@SQL + " WHERE   "
					SET @@SQL = @@SQL + "   FLDUSERID = "+CONVERT(VARCHAR,@@FLDAUTO)+" "

					SET @@SQL = @@SQL + " DELETE FROM " + @@SHAREDB + ".DBO.TBLPRADNYAUSERS WHERE FLDAUTO = "+ CONVERT(VARCHAR,@@FLDAUTO) +" "
					SET @@SQL = @@SQL + " DELETE FROM " + @@SHAREDB + ".DBO.TBLUSERCONTROLMASTER WHERE FLDUSERID = "+ CONVERT(VARCHAR,@@FLDAUTO) +" "
				END
			--PRINT @@SQL	
			EXEC(@@SQL)
			IF @@ERROR = 0
			BEGIN
				INSERT INTO #RESULT VALUES (@UNAME,@@EXCHANGE,@@SEGMENT,'DELETED SUCCESSFULLY')
			END	

 SET @@SEGORD = @@SEGORD + 1  
	FETCH NEXT FROM @@MAINREC INTO @@SHAREDB, @@SHARESVR, @@EXCHANGE, @@SEGMENT
	END 

IF @@ERROR = 0
 BEGIN
	SELECT * FROM #RESULT
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EMAIL_GETPARTY_NSEFO
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[EMAIL_GETPARTY_NSEFO]  
  
@REPORTFLAG VARCHAR (50),  
@PARTYFROM VARCHAR(50),  
@PARTYTO VARCHAR (50),  
@REPORTDATE VARCHAR(20),  
@SETTTYPE VARCHAR (20),  
@DATEFROM VARCHAR (20),  
@DATETO VARCHAR (20),  
@SETTNO VARCHAR (20)  
  
AS  
IF @REPORTFLAG='CONFIRMATION'  
BEGIN/*CONFIRMATION REPORT*/  
 SELECT DISTINCT S.PARTY_CODE,EMAIL FROM FOSETTLEMENT S,CLIENT1 C1, CLIENT2 C2, EMAIL_PARTYREPORT E  
  WHERE C1.CL_CODE = C2.CL_CODE AND S.PARTY_CODE = C2.PARTY_CODE AND E.EMAIL_PARTY_CODE = S.PARTY_CODE 
  AND SAUDA_DATE LIKE @REPORTDATE + '%' 
  AND S.PARTY_CODE >= @PARTYFROM  
  AND S.PARTY_CODE <= @PARTYTO ORDER BY S.PARTY_CODE  
END/*CONFIRMATION REPORT*/  
ELSE  
BEGIN  
 IF @REPORTFLAG='BILL'  
 BEGIN/*BILL REPORT*/  
  SELECT DISTINCT S.PARTY_CODE,EMAIL FROM FOACCBILL S,CLIENT1 C1, CLIENT2 C2, EMAIL_PARTYREPORT E  
   WHERE C1.CL_CODE = C2.CL_CODE AND S.PARTY_CODE = C2.PARTY_CODE AND E.EMAIL_PARTY_CODE = S.PARTY_CODE AND CONVERT(VARCHAR,BILLDATE,106) = @REPORTDATE  
   AND S.PARTY_CODE >= @PARTYFROM AND S.PARTY_CODE <= @PARTYTO ORDER BY S.PARTY_CODE  
 END/*BILL REPORT*/  
 ELSE  
 BEGIN  
  IF @REPORTFLAG='NETPOSITION'  
  BEGIN/*NET POS REPORT*/  
   SELECT DISTINCT C2.PARTY_CODE,EMAIL FROM CLIENT1 C1, CLIENT2 C2,EMAIL_PARTYREPORT E  
    WHERE C1.CL_CODE = C2.CL_CODE AND E.EMAIL_PARTY_CODE = C2.PARTY_CODE AND C2.PARTY_CODE >= @PARTYFROM AND C2.PARTY_CODE <= @PARTYTO ORDER BY C2.PARTY_CODE    
  END/*NET POS REPORT*/  
  ELSE  
  BEGIN  
   IF @REPORTFLAG='CLIENTSUMMARY'  
   BEGIN/*CLIENT SUMMARY*/  
    SELECT DISTINCT C2.PARTY_CODE,EMAIL FROM CLIENT1 C1, CLIENT2 C2,EMAIL_PARTYREPORT E  
     WHERE C1.CL_CODE = C2.CL_CODE AND E.EMAIL_PARTY_CODE = C2.PARTY_CODE AND C2.PARTY_CODE >= @PARTYFROM AND C2.PARTY_CODE <= @PARTYTO ORDER BY C2.PARTY_CODE    
   END/*CLIENT SUMMARY*/  
   ELSE  
   BEGIN  
    IF @REPORTFLAG='LEDGER'  
    BEGIN/*LEDGER*/  
     SELECT DISTINCT C2.PARTY_CODE,EMAIL FROM CLIENT1 C1, CLIENT2 C2,EMAIL_PARTYREPORT E, ACCOUNTCURBFO.DBO.LEDGER L  
      WHERE C1.CL_CODE = C2.CL_CODE AND E.EMAIL_PARTY_CODE = C2.PARTY_CODE AND C2.PARTY_CODE >= @PARTYFROM AND C2.PARTY_CODE <= @PARTYTO   
      AND L.CLTCODE = C2.PARTY_CODE AND L.VAMT > 0   
      ORDER BY C2.PARTY_CODE    
    END/*LEDGER*/  
    ELSE  
    BEGIN  
     IF @REPORTFLAG='CLIENTMARGIN'  
     BEGIN/*CLIENT MARGIN*/  
      SELECT DISTINCT C2.PARTY_CODE,EMAIL FROM CLIENT1 C1, CLIENT2 C2,EMAIL_PARTYREPORT E  
       WHERE C1.CL_CODE = C2.CL_CODE AND E.EMAIL_PARTY_CODE = C2.PARTY_CODE AND C2.PARTY_CODE >= @PARTYFROM AND C2.PARTY_CODE <= @PARTYTO ORDER BY C2.PARTY_CODE    
     END/*CLIENT MARGIN*/  
     ELSE  
     BEGIN  
      BEGIN/*DEFAULT*/  
       SELECT DISTINCT C2.PARTY_CODE,EMAIL FROM CLIENT1 C1, CLIENT2 C2,EMAIL_PARTYREPORT E  
        WHERE C1.CL_CODE = C2.CL_CODE AND E.EMAIL_PARTY_CODE = C2.PARTY_CODE AND C2.PARTY_CODE >= @PARTYFROM AND C2.PARTY_CODE <= @PARTYTO ORDER BY C2.PARTY_CODE    
      END/*DEFAULT*/  
     END  
    END  
   END  
  END  
 END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EXASIGNFILLFOEXERCISEALLOCATION
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[EXASIGNFILLFOEXERCISEALLOCATION]  
(  
 @TRANSFERPOS AS CHAR(1)='N',  
 @POSDATE AS VARCHAR(11),  
 @INTMODE INT = 0
) AS  
  
  
 DECLARE @MEMBERTYPE VARCHAR(4)  
  
 SELECT @MEMBERTYPE = MEMBERTYPE FROM FOOWNER  
  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
 SET NOCOUNT ON  
  
  
 TRUNCATE TABLE FOEXALLOCTRADE  
  
 IF @TRANSFERPOS = 'Y'  
 BEGIN  
  INSERT INTO FOEXALLOCTRADE (  
   FOEATRD_TRADE_NO,FOEATRD_STATUS,FOEATRD_INST_TYPE,  
   FOEATRD_SYMBOL,FOEATRD_EXPIRYDATE,FOEATRD_STRIKE_PRICE,FOEATRD_OPTION_TYPE,  
   FOEATRD_SEC_NAME,FOEATRD_MARKETTYPE,FOEATRD_USER_ID,FOEATRD_SELL_BUY,FOEATRD_TRADEQTY,  
   FOEATRD_PRICE,FOEATRD_PRO_CLI,FOEATRD_PARTY_CODE,FOEATRD_O_C_FLAG,FOEATRD_C_U_FLAG,  
   FOEATRD_ACTIVITYTIME,FOEATRD_ORDER_NO,FOEATRD_SETTFLAG,FOEATRD_CL_RATE)  
  SELECT   
   FOEATRD_TRADE_NO,FOEATRD_STATUS,FOEATRD_INST_TYPE,  
   FOEATRD_SYMBOL,FOEATRD_EXPIRYDATE,FOEATRD_STRIKE_PRICE,FOEATRD_OPTION_TYPE,  
   FOEATRD_SEC_NAME,FOEATRD_MARKETTYPE,FOEATRD_USER_ID,FOEATRD_SELL_BUY,FOEATRD_TRADEQTY,  
   FOEATRD_PRICE,FOEATRD_PRO_CLI,FOEATRD_PARTY_CODE,FOEATRD_O_C_FLAG,FOEATRD_C_U_FLAG,  
  FOEATRD_ACTIVITYTIME,FOEATRD_ORDER_NO,FOEATRD_SETTFLAG,FOEATRD_CL_RATE  
  FROM   
   FOEXALLOCTRADEHIST (NOLOCK)   
  WHERE   
   FOEATRD_ACTIVITYTIME BETWEEN @POSDATE AND @POSDATE + ' 23:59'  
 END  
 ELSE  
 BEGIN  
  
  CREATE TABLE [DBO].[#FOEXERCISEALLOCATION] (  
   [FOEA_TABLE_NO] [VARCHAR] (16) DEFAULT('') ,  
   [FOEA_POSITION_DATE] [DATETIME]  ,  
   [FOEA_DESC] [VARCHAR] (50) DEFAULT('') ,  
   [FOEA_SEGMENT_IND] [VARCHAR] (5) DEFAULT('') ,  
   [FOEA_SETT_TYPE] [VARCHAR] (2) DEFAULT('') ,  
   [FOEA_CM_CODE] [VARCHAR] (13) DEFAULT('') ,  
   [FOEA_MEM_TYPE] [VARCHAR] (1) DEFAULT('') ,  
   [FOEA_TM_CODE] [VARCHAR] (13) DEFAULT('') ,  
   [FOEA_ACC_TYPE] [VARCHAR] (2) DEFAULT('') ,  
   [FOEA_PARTY_CODE] [VARCHAR] (15) DEFAULT('') ,  
   [FOEA_INST_TYPE] [VARCHAR] (6) DEFAULT('') ,  
   [FOEA_SYMBOL] [VARCHAR] (12) DEFAULT('') ,  
   [FOEA_EXPIRYDATE] [DATETIME] ,  
   [FOEA_STRIKE_PRICE] [MONEY] DEFAULT(0) ,  
   [FOEA_OPTION_TYPE] [VARCHAR] (2) DEFAULT('') ,  
   [FOEA_COR_ACT_LEVEL] [INT] DEFAULT(0) ,  
   [FOEA_PREEXALL_LONGQTY] NUMERIC (36,0) DEFAULT(0) ,  
   [FOEA_PREEXALL_SHORTQTY] NUMERIC (36,0) DEFAULT(0) ,  
   [FOEA_EXERCISE_QTY] NUMERIC (36,0) DEFAULT(0) ,  
   [FOEA_ALLOC_QTY] NUMERIC (36,0) DEFAULT(0) ,  
   [FOEA_POSTEXALL_LONGQTY] NUMERIC (36,0) DEFAULT(0) ,  
   [FOEA_POSTEXALL_SHORTQTY] NUMERIC (36,0) DEFAULT(0) ,  
   [FOEA_BROUGHT_FORWARD_LONG_QUANTITY] NUMERIC (36,0) DEFAULT(0) ,  
   [FOEA_BROUGHT_FORWARD_LONG_VALUE] NUMERIC (36,12) DEFAULT(0) ,  
   [FOEA_BROUGHT_FORWARD_SHORT_QUANTITY] NUMERIC (36,0) DEFAULT(0) ,  
   [FOEA_BROUGHT_FORWARD_SHORT_VALUE] NUMERIC (36,12) DEFAULT(0) ,  
   [FOEA_DAY_BUY_OPEN_QUANTITY] NUMERIC (36,0) DEFAULT(0) ,  
   [FOEA_DAY_BUY_OPEN_VALUE] NUMERIC (36,12) DEFAULT(0) ,  
   [FOEA_DAY_SELL_OPEN_QUANTITY] NUMERIC (36,0) DEFAULT(0) ,  
   [FOEA_DAY_SELL_OPEN_VALUE] NUMERIC (36,12) DEFAULT(0) ,  
   [FOEA_PREEXALL_LONGVALUE] NUMERIC (36,12) DEFAULT(0) ,  
   [FOEA_PREEXALL_SHORTVALUE] NUMERIC (36,12) DEFAULT(0) ,  
   [FOEA_POSTEXALL_LONGVALUE] NUMERIC (36,12) DEFAULT(0) ,  
   [FOEA_POSTEXALL_SHORTVALUE] NUMERIC (36,12) DEFAULT(0) ,  
   [FOEA_SETTLEMENTPRICE] NUMERIC (36,12) DEFAULT(0) ,  
   [FOEA_NETPREMIUM] NUMERIC (36,12) DEFAULT(0) ,  
   [FOEA_DAILY_MTM_SETTLEMENT_VALUE] NUMERIC (36,12) DEFAULT(0) ,  
   [FOEA_FUTURES_FINAL_SETTLEMENT_VALUE] NUMERIC (36,12) DEFAULT(0) ,  
   [FOEA_EXERCISED_ASSIGNED_VALUE] NUMERIC (36,12) DEFAULT(0),  
   EXPDT VARCHAR(11) DEFAULT(''),  
   SEC_NAME VARCHAR(50) DEFAULT(''),  
   TRDQTY NUMERIC(36,0) DEFAULT(0),  
   SELLBUY INT DEFAULT(0),  
   PRICE NUMERIC (36,12) DEFAULT(0),  
   PROCLI INT DEFAULT(0),  
   OPCLFLAG  CHAR(1) DEFAULT('C'),  
   UNCOVER CHAR(1) DEFAULT('C'),  
   SETTFLAG INT DEFAULT(0),  
   TRADENO VARCHAR(20) DEFAULT('') ,  
   ORDERNO VARCHAR(20) DEFAULT('') ,  
   FOSETTLEMENT VARCHAR(15) DEFAULT('') ,  
   VALIDPARTY CHAR(1) DEFAULT('N'),  
   IDCOL INT IDENTITY  
  )  
  IF @INTMODE = 0 /*PS03/0S04 BASED*/  
  BEGIN  
   INSERT INTO #FOEXERCISEALLOCATION(  
   FOEA_POSITION_DATE,FOEA_SEGMENT_IND,FOEA_SETT_TYPE,FOEA_CM_CODE,FOEA_MEM_TYPE,FOEA_TM_CODE,FOEA_ACC_TYPE,FOEA_PARTY_CODE,FOEA_INST_TYPE,  
   FOEA_SYMBOL,FOEA_EXPIRYDATE,FOEA_STRIKE_PRICE,FOEA_OPTION_TYPE,FOEA_COR_ACT_LEVEL,FOEA_PREEXALL_LONGQTY,FOEA_PREEXALL_SHORTQTY,  
   FOEA_EXERCISE_QTY,FOEA_ALLOC_QTY,FOEA_POSTEXALL_LONGQTY,FOEA_POSTEXALL_SHORTQTY,EXPDT,FOEA_SETTLEMENTPRICE,SEC_NAME,TRDQTY,  
   SELLBUY,PRICE,PROCLI,OPCLFLAG,UNCOVER,SETTFLAG  
   )  
       
   SELECT  
    FOEA_POSITION_DATE,  
    FOEA_SEGMENT_IND='F',  
    FOEA_SETT_TYPE='F',  
    FOEA_CM_CODE,  
    FOEA_MEM_TYPE='T',  
    FOEA_TM_CODE,  
    FOEA_ACC_TYPE,  
    FOEA_PARTY_CODE=CASE WHEN @MEMBERTYPE ='CM' THEN FOEA_TM_CODE ELSE FOEA_PARTY_CODE END,  
    FOEA_INST_TYPE,  
    FOEA_SYMBOL,  
    FOEA_EXPIRYDATE,  
    FOEA_STRIKE_PRICE,  
    FOEA_OPTION_TYPE,  
    FOEA_COR_ACT_LEVEL=0,  
    FOEA_PREEXALL_LONGQTY=SUM(FOEA_PREEXALL_LONGQTY),  
    FOEA_PREEXALL_SHORTQTY=SUM(FOEA_PREEXALL_SHORTQTY),  
    FOEA_EXERCISE_QTY=SUM(FOEA_EXERCISE_QTY),  
    FOEA_ALLOC_QTY=SUM(FOEA_ALLOC_QTY),  
    FOEA_POSTEXALL_LONGQTY=SUM(FOEA_POSTEXALL_LONGQTY),  
    FOEA_POSTEXALL_SHORTQTY=SUM(FOEA_POSTEXALL_SHORTQTY),  
    EXPDT=LEFT(CONVERT(VARCHAR,FOEA_EXPIRYDATE,109),11),  
    FOEA_SETTLEMENTPRICE,  
    SEC_NAME=CONVERT(VARCHAR(50),  RTRIM(FOEA_INST_TYPE)+' '+RTRIM(FOEA_SYMBOL)+' '+  
    LTRIM(RTRIM(CONVERT(CHAR, FOEA_STRIKE_PRICE)))+RTRIM(FOEA_OPTION_TYPE) ),  
    TRDQTY = FOEA_ALLOC_QTY,     
    SELLBUY = 1,    
    PRICE = CASE WHEN LEFT(FOEA_OPTION_TYPE, 1) = 'C' THEN  (FOEA_SETTLEMENTPRICE-FOEA_STRIKE_PRICE)  
         WHEN LEFT(FOEA_OPTION_TYPE, 1) = 'P' THEN  (FOEA_STRIKE_PRICE-FOEA_SETTLEMENTPRICE)  
        ELSE 0  
        END,      
    PROCLI = CASE WHEN FOEA_ACC_TYPE = 'P' THEN 2 ELSE 1 END,  
    OPCLFLAG = 'C',  
    UNCOVER = 'C',  
    SETTFLAG = 2  
   FROM FOEXERCISEALLOCATION  (NOLOCK)  
   WHERE FOEA_POSITION_DATE BETWEEN @POSDATE AND @POSDATE + ' 23:59'  
   AND LEFT(FOEA_INST_TYPE,3) = 'OPT'  
   AND FOEA_ALLOC_QTY > 0  
   GROUP BY FOEA_POSITION_DATE,  
    FOEA_CM_CODE,  
    FOEA_TM_CODE,  
    FOEA_ACC_TYPE,  
    FOEA_PARTY_CODE,  
   FOEA_ALLOC_QTY,  
    FOEA_INST_TYPE,  
    FOEA_SYMBOL,  
    FOEA_EXPIRYDATE,  
    FOEA_STRIKE_PRICE,  
    FOEA_OPTION_TYPE,  
    LEFT(CONVERT(VARCHAR,FOEA_EXPIRYDATE,109),11),  
    FOEA_SETTLEMENTPRICE,  
   CONVERT(VARCHAR(50),  RTRIM(FOEA_INST_TYPE)+' '+RTRIM(FOEA_SYMBOL)+' '+  
   LTRIM(RTRIM(CONVERT(CHAR, FOEA_STRIKE_PRICE)))+RTRIM(FOEA_OPTION_TYPE) ),  
   CASE WHEN LEFT(FOEA_OPTION_TYPE, 1) = 'C' THEN  (FOEA_SETTLEMENTPRICE-FOEA_STRIKE_PRICE)  
   WHEN LEFT(FOEA_OPTION_TYPE, 1) = 'P' THEN  (FOEA_STRIKE_PRICE-FOEA_SETTLEMENTPRICE)  
   ELSE 0  END  
  
  
   INSERT INTO #FOEXERCISEALLOCATION(  
   FOEA_POSITION_DATE,FOEA_SEGMENT_IND,FOEA_SETT_TYPE,FOEA_CM_CODE,FOEA_MEM_TYPE,FOEA_TM_CODE,FOEA_ACC_TYPE,FOEA_PARTY_CODE,  
   FOEA_INST_TYPE,FOEA_SYMBOL,FOEA_EXPIRYDATE,FOEA_STRIKE_PRICE,FOEA_OPTION_TYPE,FOEA_COR_ACT_LEVEL,FOEA_PREEXALL_LONGQTY,  
   FOEA_PREEXALL_SHORTQTY,FOEA_EXERCISE_QTY,FOEA_ALLOC_QTY,FOEA_POSTEXALL_LONGQTY,FOEA_POSTEXALL_SHORTQTY,EXPDT,  
   FOEA_SETTLEMENTPRICE,SEC_NAME,TRDQTY,SELLBUY,PRICE,PROCLI,OPCLFLAG,UNCOVER,SETTFLAG)  
    
   SELECT  
    FOEA_POSITION_DATE,  
    FOEA_SEGMENT_IND='F',  
    FOEA_SETT_TYPE='F',  
    FOEA_CM_CODE,  
    FOEA_MEM_TYPE='T',  
    FOEA_TM_CODE,  
    FOEA_ACC_TYPE,  
    FOEA_PARTY_CODE=CASE WHEN @MEMBERTYPE ='CM' THEN FOEA_TM_CODE ELSE FOEA_PARTY_CODE END,  
    FOEA_INST_TYPE,  
    FOEA_SYMBOL,  
    FOEA_EXPIRYDATE,  
    FOEA_STRIKE_PRICE,  
    FOEA_OPTION_TYPE,  
    FOEA_COR_ACT_LEVEL=0,  
    FOEA_PREEXALL_LONGQTY=SUM(FOEA_PREEXALL_LONGQTY),  
    FOEA_PREEXALL_SHORTQTY=SUM(FOEA_PREEXALL_SHORTQTY),  
    FOEA_EXERCISE_QTY=SUM(FOEA_EXERCISE_QTY),  
    FOEA_ALLOC_QTY=SUM(FOEA_ALLOC_QTY),  
    FOEA_POSTEXALL_LONGQTY=SUM(FOEA_POSTEXALL_LONGQTY),  
    FOEA_POSTEXALL_SHORTQTY=SUM(FOEA_POSTEXALL_SHORTQTY),  
    EXPDT=LEFT(CONVERT(VARCHAR,FOEA_EXPIRYDATE,109),11),  
    FOEA_SETTLEMENTPRICE,  
    SEC_NAME=CONVERT(VARCHAR(50),  RTRIM(FOEA_INST_TYPE)+' '+RTRIM(FOEA_SYMBOL)+' '+  
       LTRIM(RTRIM(CONVERT(CHAR, FOEA_STRIKE_PRICE)))+RTRIM(FOEA_OPTION_TYPE) ),  
    TRDQTY = FOEA_EXERCISE_QTY,     
    SELLBUY = 2,    
    PRICE = CASE WHEN LEFT(FOEA_OPTION_TYPE, 1) = 'C' THEN  (FOEA_SETTLEMENTPRICE-FOEA_STRIKE_PRICE)  
         WHEN LEFT(FOEA_OPTION_TYPE, 1) = 'P' THEN  (FOEA_STRIKE_PRICE-FOEA_SETTLEMENTPRICE)  
        ELSE 0  
        END,     
    PROCLI = CASE WHEN FOEA_ACC_TYPE = 'P' THEN 2 ELSE 1 END,  
    OPCLFLAG = 'C',  
    UNCOVER = 'C',  
    SETTFLAG = 3  
   FROM FOEXERCISEALLOCATION  (NOLOCK)  
   WHERE FOEA_POSITION_DATE BETWEEN @POSDATE AND @POSDATE + ' 23:59'  
   AND LEFT(FOEA_INST_TYPE,3) = 'OPT'  
   AND FOEA_EXERCISE_QTY > 0  
   GROUP BY FOEA_POSITION_DATE,  
    FOEA_CM_CODE,  
    FOEA_TM_CODE,  
    FOEA_ACC_TYPE,  
    FOEA_PARTY_CODE,  
   FOEA_EXERCISE_QTY,  
    FOEA_INST_TYPE,  
    FOEA_SYMBOL,  
    FOEA_EXPIRYDATE,  
    FOEA_STRIKE_PRICE,  
    FOEA_OPTION_TYPE,  
    LEFT(CONVERT(VARCHAR,FOEA_EXPIRYDATE,109),11),  
    FOEA_SETTLEMENTPRICE,  
   CONVERT(VARCHAR(50),  RTRIM(FOEA_INST_TYPE)+' '+RTRIM(FOEA_SYMBOL)+' '+LTRIM(RTRIM(CONVERT(CHAR, FOEA_STRIKE_PRICE)))+RTRIM(FOEA_OPTION_TYPE) ),  
   CASE WHEN LEFT(FOEA_OPTION_TYPE, 1) = 'C' THEN  (FOEA_SETTLEMENTPRICE-FOEA_STRIKE_PRICE)  
     WHEN LEFT(FOEA_OPTION_TYPE, 1) = 'P' THEN  (FOEA_STRIKE_PRICE-FOEA_SETTLEMENTPRICE)  
    ELSE 0  END  
  END  
  ELSE  
  BEGIN  
   INSERT INTO #FOEXERCISEALLOCATION(  
   FOEA_POSITION_DATE,FOEA_SEGMENT_IND,FOEA_SETT_TYPE,FOEA_CM_CODE,FOEA_MEM_TYPE,FOEA_TM_CODE,FOEA_ACC_TYPE,  
   FOEA_PARTY_CODE,FOEA_INST_TYPE,FOEA_SYMBOL,FOEA_EXPIRYDATE,FOEA_STRIKE_PRICE,FOEA_OPTION_TYPE,FOEA_COR_ACT_LEVEL,  
   FOEA_PREEXALL_LONGQTY,FOEA_PREEXALL_SHORTQTY,FOEA_EXERCISE_QTY,FOEA_ALLOC_QTY,FOEA_POSTEXALL_LONGQTY,FOEA_POSTEXALL_SHORTQTY,  
   EXPDT,FOEA_SETTLEMENTPRICE,SEC_NAME,TRDQTY,SELLBUY,PRICE,PROCLI,OPCLFLAG,UNCOVER,SETTFLAG)  
  
   SELECT  
    FOEA_POSITION_DATE=EX_ASG_DATE,  
    FOEA_SEGMENT_IND=MARKET_TYPE,  
    FOEA_SETT_TYPE=SETTLEMENT_TYPE,  
    FOEA_CM_CODE=CM_CODE,  
    FOEA_MEM_TYPE=MEMBER_TYPE,  
    FOEA_TM_CODE=TM_CODE,  
    FOEA_ACC_TYPE=ACCOUNT_TYPE,  
    FOEA_PARTY_CODE=PARTY_CODE,  
    FOEA_INST_TYPE=INST_TYPE,  
    FOEA_SYMBOL=SYMBOL,  
    FOEA_EXPIRYDATE=EXPIRYDATE,  
    FOEA_STRIKE_PRICE=STRIKE_PRICE,  
    FOEA_OPTION_TYPE=OPTION_TYPE,  
    FOEA_COR_ACT_LEVEL=CA_LEVEL,  
    FOEA_PREEXALL_LONGQTY=0,  
    FOEA_PREEXALL_SHORTQTY=0,  
    FOEA_EXERCISE_QTY=0,  
    FOEA_ALLOC_QTY=VALID_EXERCISE_QTY,  
    FOEA_POSTEXALL_LONGQTY=0,  
    FOEA_POSTEXALL_SHORTQTY=0,  
    EXPDT=LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),  
    FOEA_SETTLEMENTPRICE=SETTLEMENT_PRICE,  
    SEC_NAME=CONVERT(VARCHAR(50),  RTRIM(INST_TYPE)+' '+RTRIM(SYMBOL)+' '+  
      LTRIM(RTRIM(CONVERT(CHAR, STRIKE_PRICE)))+RTRIM(OPTION_TYPE) ),  
    TRDQTY = VALID_EXERCISE_QTY,     
    SELLBUY = 1,    
    PRICE = CASE WHEN LEFT(OPTION_TYPE, 1) = 'C' THEN  (SETTLEMENT_PRICE-STRIKE_PRICE)  
         WHEN LEFT(OPTION_TYPE, 1) = 'P' THEN  (STRIKE_PRICE-SETTLEMENT_PRICE)  
        ELSE 0  
        END,     
    PROCLI = CASE WHEN ACCOUNT_TYPE = 'P' THEN 2 ELSE 1 END,  
    OPCLFLAG = 'C',  
    UNCOVER = 'C',  
    SETTFLAG = 2  
   FROM FOEXALLOCPOSITION  (NOLOCK)  
   WHERE EX_ASG_DATE = @POSDATE  
   AND FILE_TYPE ='A'  
  
  
   INSERT INTO #FOEXERCISEALLOCATION(  
   FOEA_POSITION_DATE,FOEA_SEGMENT_IND,FOEA_SETT_TYPE,FOEA_CM_CODE,FOEA_MEM_TYPE,FOEA_TM_CODE,FOEA_ACC_TYPE,  
   FOEA_PARTY_CODE,FOEA_INST_TYPE,FOEA_SYMBOL,FOEA_EXPIRYDATE,FOEA_STRIKE_PRICE,FOEA_OPTION_TYPE,  
   FOEA_COR_ACT_LEVEL,FOEA_PREEXALL_LONGQTY,FOEA_PREEXALL_SHORTQTY,FOEA_EXERCISE_QTY,FOEA_ALLOC_QTY,  
   FOEA_POSTEXALL_LONGQTY,FOEA_POSTEXALL_SHORTQTY,EXPDT,FOEA_SETTLEMENTPRICE,SEC_NAME,  
   TRDQTY,SELLBUY,PRICE,PROCLI,OPCLFLAG,UNCOVER,SETTFLAG)  
   SELECT  
    FOEA_POSITION_DATE=EX_ASG_DATE,  
    FOEA_SEGMENT_IND=MARKET_TYPE,  
    FOEA_SETT_TYPE=SETTLEMENT_TYPE,  
    FOEA_CM_CODE=CM_CODE,  
    FOEA_MEM_TYPE=MEMBER_TYPE,  
    FOEA_TM_CODE=TM_CODE,  
    FOEA_ACC_TYPE=ACCOUNT_TYPE,  
    FOEA_PARTY_CODE=PARTY_CODE,  
    FOEA_INST_TYPE=INST_TYPE,  
    FOEA_SYMBOL=SYMBOL,  
    FOEA_EXPIRYDATE=EXPIRYDATE,  
    FOEA_STRIKE_PRICE=STRIKE_PRICE,  
    FOEA_OPTION_TYPE=OPTION_TYPE,  
    FOEA_COR_ACT_LEVEL=CA_LEVEL,  
    FOEA_PREEXALL_LONGQTY=0,  
    FOEA_PREEXALL_SHORTQTY=0,  
    FOEA_EXERCISE_QTY=0,  
    FOEA_ALLOC_QTY=VALID_EXERCISE_QTY,  
    FOEA_POSTEXALL_LONGQTY=0,  
    FOEA_POSTEXALL_SHORTQTY=0,  
    EXPDT=LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),  
    FOEA_SETTLEMENTPRICE=SETTLEMENT_PRICE,  
    SEC_NAME=CONVERT(VARCHAR(50),  RTRIM(INST_TYPE)+' '+RTRIM(SYMBOL)+' '+  
     LTRIM(RTRIM(CONVERT(CHAR, STRIKE_PRICE)))+RTRIM(OPTION_TYPE) ),  
    TRDQTY = VALID_EXERCISE_QTY,     
    SELLBUY = 2,    
    PRICE = CASE WHEN LEFT(OPTION_TYPE, 1) = 'C' THEN  (SETTLEMENT_PRICE-STRIKE_PRICE)  
         WHEN LEFT(OPTION_TYPE, 1) = 'P' THEN  (STRIKE_PRICE-SETTLEMENT_PRICE)  
        ELSE 0  
        END,     
    PROCLI = CASE WHEN ACCOUNT_TYPE = 'P' THEN 2 ELSE 1 END,  
    OPCLFLAG = 'C',  
    UNCOVER = 'C',  
    SETTFLAG = 3  
   FROM FOEXALLOCPOSITION  (NOLOCK)  
   WHERE EX_ASG_DATE = @POSDATE  
   AND FILE_TYPE ='E'  
  END  
  

  IF (SELECT UPPER(MEMBERTYPE) FROM FOOWNER) ='CM'  
  BEGIN  
  
   UPDATE #FOEXERCISEALLOCATION SET FOEA_PARTY_CODE = FOTMINFO.PARTY_CODE   
   FROM  FOTMINFO (NOLOCK) WHERE FOTMINFO.TM_CODE = #FOEXERCISEALLOCATION.FOEA_PARTY_CODE  
  
   UPDATE #FOEXERCISEALLOCATION SET FOEA_PARTY_CODE = C2.PARTY_CODE   
   FROM  CLIENT2 C2 (NOLOCK) WHERE C2.BANKID = #FOEXERCISEALLOCATION.FOEA_PARTY_CODE  
   AND FOEA_PARTY_CODE NOT IN (SELECT PARTY_CODE FROM FOTMINFO (NOLOCK))  
  END  

 
  UPDATE #FOEXERCISEALLOCATION SET SEC_NAME = B.SEC_NAME ,TRDQTY = TRDQTY * C_REGULAR_LOT 
  FROM #FOEXERCISEALLOCATION A, FOSCRIP2 B  
   WHERE B.INST_TYPE = FOEA_INST_TYPE  
   AND B.SYMBOL = FOEA_SYMBOL  
   AND CONVERT(CHAR(11),B.EXPIRYDATE, 109) = CONVERT(CHAR(11),EXPDT,109)  
   AND B.STRIKE_PRICE = FOEA_STRIKE_PRICE  
   AND B.OPTION_TYPE = FOEA_OPTION_TYPE  
   
  UPDATE #FOEXERCISEALLOCATION SET  
   TRADENO = 'EA-'+RTRIM(CONVERT(CHAR, IDCOL)),  
   ORDERNO = '50000000000' + RTRIM(CONVERT(CHAR, IDCOL))  
   
   
   
  UPDATE #FOEXERCISEALLOCATION SET VALIDPARTY = 'Y' FROM #FOEXERCISEALLOCATION A, CLIENT2 B (NOLOCK)  
  WHERE A.FOEA_PARTY_CODE = B.PARTY_CODE  
   
  INSERT INTO FOEXALLOCTRADE(  
   FOEATRD_TRADE_NO,  
   FOEATRD_STATUS,  
   FOEATRD_INST_TYPE,  
   FOEATRD_SYMBOL,  
   FOEATRD_EXPIRYDATE,  
   FOEATRD_STRIKE_PRICE,  
   FOEATRD_OPTION_TYPE,  
   FOEATRD_SEC_NAME,  
   FOEATRD_MARKETTYPE,  
   FOEATRD_USER_ID,  
   FOEATRD_SELL_BUY,  
   FOEATRD_TRADEQTY,  
   FOEATRD_PRICE,  
   FOEATRD_PRO_CLI,  
   FOEATRD_PARTY_CODE,  
   FOEATRD_O_C_FLAG,  
   FOEATRD_C_U_FLAG,  
   FOEATRD_ACTIVITYTIME,  
   FOEATRD_ORDER_NO,  
   FOEATRD_SETTFLAG,  
   FOEATRD_CL_RATE)  
  SELECT  
   FOEATRD_TRADE_NO = TRADENO,  
   FOEATRD_STATUS = '99',  
   FOEATRD_INST_TYPE = FOEA_INST_TYPE,  
   FOEATRD_SYMBOL = FOEA_SYMBOL,  
   FOEATRD_EXPIRYDATE = FOEA_EXPIRYDATE,  
   FOEATRD_STRIKE_PRICE = FOEA_STRIKE_PRICE,  
   FOEATRD_OPTION_TYPE = FOEA_OPTION_TYPE,  
   FOEATRD_SEC_NAME = SEC_NAME,  
   FOEATRD_MARKETTYPE = '1',  
   FOEATRD_USER_ID = '1',  
   FOEATRD_SELL_BUY = SELLBUY,  
   FOEATRD_TRADEQTY = TRDQTY,  
   FOEATRD_PRICE = PRICE,  
   FOEATRD_PRO_CLI = PROCLI,  
   FOEATRD_PARTY_CODE = FOEA_PARTY_CODE,  
   FOEATRD_O_C_FLAG = OPCLFLAG,  
   FOEATRD_C_U_FLAG = UNCOVER,  
   FOEATRD_ACTIVITYTIME = CONVERT(CHAR(11),FOEA_POSITION_DATE,109),  
   FOEATRD_ORDER_NO = ORDERNO,  
   FOEATRD_SETTFLAG = SETTFLAG,  
   FOEATRD_CL_RATE = FOEA_SETTLEMENTPRICE  
  FROM #FOEXERCISEALLOCATION  
 END  
  
 TRUNCATE TABLE EXALLOC_NETPOSITION  
   
 INSERT INTO EXALLOC_NETPOSITION(  
  PARTY_CODE,  
  INST_TYPE,  
  SYMBOL,  
  EXPIRYDATE,  
  STRIKE_PRICE,  
  OPTION_TYPE,  
  PQTY,  
  SQTY  
  )  
 SELECT  
  A.PARTY_CODE,  
  A.INST_TYPE,  
  A.SYMBOL,  
  A.EXPIRYDATE,  
  A.STRIKE_PRICE,  
  A.OPTION_TYPE,  
  PQTY = SUM(CASE WHEN A.SELL_BUY = 1 THEN ISNULL((A.TRADEQTY),0) ELSE 0 END),  
  SQTY = SUM(CASE WHEN A.SELL_BUY = 2 THEN ISNULL((A.TRADEQTY),0) ELSE 0 END)  
 FROM FOSETTLEMENT A (NOLOCK),(  
  SELECT DISTINCT  
   FOEATRD_INST_TYPE,  
   FOEATRD_SYMBOL,  
   FOEATRD_EXPIRYDATE,  
   FOEATRD_STRIKE_PRICE,  
   FOEATRD_OPTION_TYPE  
  FROM FOEXALLOCTRADE (NOLOCK)) B  
 WHERE  
  A.AUCTIONPART <> 'EA'  
  AND LEFT(A.INST_TYPE,3) = 'OPT'  
  AND A.INST_TYPE = B.FOEATRD_INST_TYPE  
  AND A.SYMBOL = B.FOEATRD_SYMBOL  
  AND CONVERT(CHAR(11),A.EXPIRYDATE,109) = CONVERT(CHAR(11),B.FOEATRD_EXPIRYDATE,109)  
  AND A.STRIKE_PRICE = B.FOEATRD_STRIKE_PRICE  
  AND A.OPTION_TYPE = B.FOEATRD_OPTION_TYPE  
 GROUP BY  
  A.PARTY_CODE,  
  A.INST_TYPE,  
  A.SYMBOL,  
  A.EXPIRYDATE,  
  A.STRIKE_PRICE,  
  A.OPTION_TYPE  
   

        
 UPDATE FOEXALLOCTRADE SET FOEATRD_EXPIRYDATE = LEFT(FOEATRD_EXPIRYDATE,11) + ' 23:59'  
  
 SET NOCOUNT OFF  
  
  
  SELECT   DISTINCT A.FOEATRD_PARTY_CODE,  
                    A.FOEATRD_INST_TYPE,  
                    A.FOEATRD_SYMBOL,  
                    CONVERT(CHAR(11),A.FOEATRD_EXPIRYDATE,109) AS FOEATRD_EXPIRYDATE,  
                    A.FOEATRD_STRIKE_PRICE,  
                    A.FOEATRD_OPTION_TYPE,  
                    A.FOEATRD_SELL_BUY,  
                    SUM(A.FOEATRD_TRADEQTY) AS FOEATRD_TRADEQTY,  
                    LEFT(CONVERT(VARCHAR,A.FOEATRD_EXPIRYDATE,109),11) AS EXPDATE,  
                    A.FOEATRD_PRICE,  
                    FOEATRD_CL_RATE,  
                    PQTY = ISNULL(SUM(ISNULL(B.PQTY,0)),0),  
                    SQTY = ISNULL(SUM(ISNULL(B.SQTY,0)),0),  
                    NETQTY = ISNULL(SUM(ISNULL(B.PQTY,0)),0) - ISNULL(SUM(ISNULL(B.SQTY,0)),0),  
                    KEYCOLUMN = RTRIM(A.FOEATRD_PARTY_CODE) + '|' + RTRIM(A.FOEATRD_INST_TYPE) + '|' + RTRIM(A.FOEATRD_SYMBOL) + '|' +  
                     RTRIM(CONVERT(CHAR(11),A.FOEATRD_EXPIRYDATE,109)) + '|' + LTRIM(RTRIM(CONVERT(CHAR,A.FOEATRD_STRIKE_PRICE))) + '|' +  
                     RTRIM(A.FOEATRD_OPTION_TYPE) + '|' + RTRIM(CONVERT(CHAR,A.FOEATRD_SELL_BUY)),   
                    EXPIRYDATE = A.FOEATRD_EXPIRYDATE   
  FROM     FOEXALLOCTRADE A (NOLOCK)  
           LEFT JOIN EXALLOC_NETPOSITION B  
             ON A.FOEATRD_PARTY_CODE = B.PARTY_CODE  
                AND A.FOEATRD_INST_TYPE = B.INST_TYPE  
                AND A.FOEATRD_SYMBOL = B.SYMBOL  
                AND A.FOEATRD_STRIKE_PRICE = B.STRIKE_PRICE  
                AND A.FOEATRD_OPTION_TYPE = B.OPTION_TYPE  
                AND CONVERT(CHAR(11),A.FOEATRD_EXPIRYDATE,109) = CONVERT(CHAR(11),B.EXPIRYDATE,109)  
  WHERE    A.FOEATRD_TRADEQTY <> 0  
  GROUP BY A.FOEATRD_PARTY_CODE,A.FOEATRD_INST_TYPE,A.FOEATRD_SYMBOL,A.FOEATRD_EXPIRYDATE,  
           A.FOEATRD_STRIKE_PRICE,A.FOEATRD_OPTION_TYPE,A.FOEATRD_SELL_BUY,A.FOEATRD_PRICE,  
           A.FOEATRD_CL_RATE  
  ORDER BY A.FOEATRD_INST_TYPE,  
           A.FOEATRD_SYMBOL,  
           16, --A.FOEATRD_EXPIRYDATE  
           A.FOEATRD_STRIKE_PRICE,  
           A.FOEATRD_OPTION_TYPE,  
           A.FOEATRD_SELL_BUY,  
           A.FOEATRD_PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FETCH_GST_INVOICE
-- --------------------------------------------------


create  PROC [dbo].[FETCH_GST_INVOICE] 
(
	@FORTHEDAY	VARCHAR(11),
	@EXCHANGE	VARCHAR(3),
	@SEGMENT	VARCHAR(7)
)
AS

SELECT INVOICE_DATE = CONVERT(DATETIME, LEFT(SAUDA_DATE,11)),EXCHANGE=@EXCHANGE, SEGMENT=@SEGMENT, RECORDFOR='SETTLEMENT',
SUBRECORDFOR=CONVERT(VARCHAR(20),'CONTRACT'),INV_DESC = CONVERT(VARCHAR(500),'TOWORDS BROKERAGE AND CHARGES AGAINST THE TRADES EXECUTION'),
SETT_NO='', SETT_TYPE='', PARTY_CODE, CONTRACTNO, INT_REF_NO = CONVERT(VARCHAR(50), @EXCHANGE + '_' + @SEGMENT + '_' + CONTRACTNO),
TAXABLE_AMT = SUM(PBROKAMT+SBROKAMT)
			+ SUM(CASE WHEN TURNOVER_AC = 1 THEN TURN_TAX ELSE 0 END)
			+ SUM(CASE WHEN SEBI_TURN_AC = 1 THEN SEBI_TAX ELSE 0 END)
			+ SUM(CASE WHEN BROKER_NOTE_AC = 1 THEN BROKER_NOTE ELSE 0 END)
			+ SUM(CASE WHEN OTHER_CHRG_AC = 1 THEN OTHER_CHRG ELSE 0 END)
			+ SUM(CASE WHEN INSURANCE_CHRG_AC = 1 THEN INS_CHRG ELSE 0 END),
TAX_AMT = SUM(C.SERVICE_TAX),
INVOICE_TYPE = CONVERT(VARCHAR(20),'DEBIT'),
INVOICE_SUBTYPE = CONVERT(VARCHAR(20),''),
INVOICE_CATEGORY = CONVERT(VARCHAR(20),''),
REV_INT_REF_NO = CONVERT(VARCHAR(50),''),
LOCATION_CODE = CONVERT(VARCHAR(50),''),
SOURCESTATE=CONVERT(VARCHAR(50),''),
TARGETSTATE=CONVERT(VARCHAR(50),''),
STATE_CODE=CONVERT(VARCHAR(2),''),
INV_NO=CONVERT(VARCHAR(50),''),
SACCODE=CONVERT(VARCHAR(50),''),
SAC_DESC=CONVERT(VARCHAR(500),''),
BRANCH_CODE = CONVERT(VARCHAR(10),''),
IGST_RATE = CONVERT(NUMERIC(18,4),0),
IGST_AMOUNT = CONVERT(NUMERIC(18,4),0),
CGST_RATE = CONVERT(NUMERIC(18,4),0),
CGST_AMOUNT = CONVERT(NUMERIC(18,4),0),
SGST_RATE = CONVERT(NUMERIC(18,4),0),
SGST_AMOUNT = CONVERT(NUMERIC(18,4),0)
INTO #DATA 
FROM FOBILLVALAN C, FOGLOBALS G, FOOWNER O
WHERE  SAUDA_DATE BETWEEN @FORTHEDAY AND @FORTHEDAY + ' 23:59:59'
AND SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT
AND C.SERVICE_TAX > 0 AND TRADETYPE = 'BT'
GROUP BY PARTY_CODE, CONTRACTNO, LEFT(SAUDA_DATE,11)

SELECT * FROM #DATA

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FILELISTPROC
-- --------------------------------------------------
CREATE  PROC [dbo].[FILELISTPROC] (@FILEPATH VARCHAR(100) )      
AS       
    
DECLARE @NEWFILEPATH VARCHAR(100)    
    
SET @NEWFILEPATH = REPLACE(@FILEPATH, '*.TXT', '*.*')    
CREATE TABLE #FILELIST       
( FILENAMELIST VARCHAR(100))      
INSERT INTO #FILELIST       
EXEC MASTER.DBO.XP_CMDSHELL @NEWFILEPATH      

SELECT * FROM #FILELIST

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FO_GETSECNAME
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[FO_GETSECNAME]

@INST AS VARCHAR(6),
@SYMBOL AS VARCHAR(12),
@EXPDT AS VARCHAR(20),
@STRIKEPR AS MONEY,
@OPTTYPE AS VARCHAR(2)

AS

SELECT SEC_NAME FROM FOSCRIP2
WHERE INST_TYPE = @INST
AND SYMBOL = @SYMBOL
AND EXPIRYDATE LIKE @EXPDT+'%'
AND STRIKE_PRICE = @STRIKEPR
AND OPTION_TYPE = @OPTTYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FO_POST_EXERCISEALLOCATION
-- --------------------------------------------------

CREATE  PROC [dbo].[FO_POST_EXERCISEALLOCATION] 
(
	@BILLDATE VARCHAR(11),
	@USERNAME VARCHAR(20) =''
 )
AS 

DELETE FROM FOEXALLOCSETTLEMENT 
WHERE
	SAUDA_DATE BETWEEN @BILLDATE  AND @BILLDATE  + ' 23:59'
	AND LEFT(INST_TYPE,3) = 'OPT' AND AUCTIONPART = 'EA' AND PRICE <> 0 
	 

INSERT INTO FOEXALLOCSETTLEMENT
SELECT 
	CONTRACTNO='0',BILLNO=1,TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,
	OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART='EA',MARKETTYPE,SERIES='0',ORDER_NO,PRICE,
	SAUDA_DATE=ACTIVITYTIME,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,
	BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,BILLFLAG=0,
	SETT_NO=0,NBROKAPP=0,NSERTAX=0,N_NETRATE=0,SETT_TYPE='F',CL_RATE,
	PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2
FROM FOEXALLOCCONFIRMVIEW

--EXEC FOGENCONTRACT_EXALLOC @BILLDATE


DELETE FROM FOSETTLEMENT 
WHERE 
	SAUDA_DATE BETWEEN @BILLDATE  AND @BILLDATE  + ' 23:59'
	AND LEFT(INST_TYPE,3) = 'OPT' AND AUCTIONPART = 'EA' AND PRICE <> 0 


INSERT INTO FOSETTLEMENT
(
	CONTRACTNO,BILLNO,TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
	USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,SAUDA_DATE,
	TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,
	BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,
	TRADE_AMOUNT,BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,PARTICIPANTCODE,
	STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2
)
SELECT 
	CONTRACTNO,BILLNO,TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
	USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,SAUDA_DATE,
	TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,
	BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,
	TRADE_AMOUNT,BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,PARTICIPANTCODE,
	STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2
FROM FOEXALLOCSETTLEMENT
WHERE SAUDA_DATE BETWEEN @BILLDATE AND @BILLDATE + ' 23:59'


DELETE FROM FOEXALLOCTRADEHIST WHERE FOEATRD_ACTIVITYTIME BETWEEN @BILLDATE AND @BILLDATE + ' 23:59'

INSERT INTO FOEXALLOCTRADEHIST 
(
	FOEATRD_TRADE_NO,FOEATRD_STATUS,FOEATRD_INST_TYPE,
	FOEATRD_SYMBOL,FOEATRD_EXPIRYDATE,FOEATRD_STRIKE_PRICE,FOEATRD_OPTION_TYPE,FOEATRD_SEC_NAME,
	FOEATRD_MARKETTYPE,FOEATRD_USER_ID,FOEATRD_SELL_BUY,FOEATRD_TRADEQTY,FOEATRD_PRICE,
	FOEATRD_PRO_CLI,FOEATRD_PARTY_CODE,FOEATRD_O_C_FLAG,FOEATRD_C_U_FLAG,FOEATRD_ACTIVITYTIME,
	FOEATRD_ORDER_NO,FOEATRD_SETTFLAG,FOEATRD_CL_RATE
)
SELECT 
	FOEATRD_TRADE_NO,FOEATRD_STATUS,FOEATRD_INST_TYPE,
	FOEATRD_SYMBOL,FOEATRD_EXPIRYDATE,FOEATRD_STRIKE_PRICE,FOEATRD_OPTION_TYPE,FOEATRD_SEC_NAME,
	FOEATRD_MARKETTYPE,FOEATRD_USER_ID,FOEATRD_SELL_BUY,FOEATRD_TRADEQTY,FOEATRD_PRICE,
	FOEATRD_PRO_CLI,FOEATRD_PARTY_CODE,FOEATRD_O_C_FLAG,FOEATRD_C_U_FLAG,FOEATRD_ACTIVITYTIME,
	FOEATRD_ORDER_NO,FOEATRD_SETTFLAG,FOEATRD_CL_RATE
FROM FOEXALLOCTRADE 

DELETE FROM FOEXALLOCTRADE

EXEC V2_PROCESS_STATUS_LOG_UPD @BILLDATE,'CHKEXALC','',@USERNAME,''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FO_SETTPRICEINSERT
-- --------------------------------------------------

CREATE PROC [dbo].[FO_SETTPRICEINSERT]
(
	@CLDATE	VARCHAR(11)
)
AS

UPDATE FOCLOSING_MTM SET EXPIRYDATE = LEFT(EXPIRYDATE,11) + ' 23:59',
OPTION_TYPE = ISNULL(OPTION_TYPE,'')
WHERE TRADE_DATE = @CLDATE

UPDATE FOCLOSING SET CL_RATE = C.CL_RATE
FROM FOCLOSING_MTM C
WHERE FOCLOSING.TRADE_DATE = @CLDATE 
AND C.TRADE_DATE = @CLDATE 
AND C.INST_TYPE = FOCLOSING.INST_TYPE 
AND C.SYMBOL = FOCLOSING.SYMBOL 
AND C.EXPIRYDATE = FOCLOSING.EXPIRYDATE 
AND C.STRIKE_PRICE = FOCLOSING.STRIKE_PRICE 
AND C.OPTION_TYPE = FOCLOSING.OPTION_TYPE  

INSERT INTO FOCLOSING
SELECT TRADE_DATE,MARKET_TYPE='0',INST_TYPE,SYMBOL,
EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,RESERVED=0,PRV_CL_RATE=0,OPEN_PRICE=0,HIGH_PRICE=0,LOW_PRICE=0,CL_RATE,
TOTAL_TRD_QTY=0,TOTAL_TRD_VALUE=0,OPEN_INTEREST,CHANGE_INOPEN_INTEREST=0,
POPULATED_BY=UPLOAD_BY,
POPULATED_ON=UPLOAD_ON
FROM FOCLOSING_MTM C
WHERE TRADE_DATE = @CLDATE
AND SERIES_ID NOT IN (SELECT SERIES_ID FROM FOCLOSING
					 WHERE FOCLOSING.TRADE_DATE = @CLDATE 
					 AND C.INST_TYPE = FOCLOSING.INST_TYPE 
					AND C.SYMBOL = FOCLOSING.SYMBOL 
					AND C.EXPIRYDATE = FOCLOSING.EXPIRYDATE 
					AND C.STRIKE_PRICE = FOCLOSING.STRIKE_PRICE 
					AND C.OPTION_TYPE = FOCLOSING.OPTION_TYPE  )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FO_SETTPRICEUPLOAD
-- --------------------------------------------------

CREATE PROC [dbo].[FO_SETTPRICEUPLOAD] 
(
	@CLDATE	VARCHAR(11),
	@FILENAME	VARCHAR(200)
)
AS
DECLARE @STRSQL  VARCHAR(500)

SELECT TRADE_DATE, SERIES_ID=SYMBOL, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, 
CL_RATE, OPEN_INTEREST,FILLER1,FILLER2,FILLER3,FILLER4
INTO #FOCLOSING_MTM 
FROM FOCLOSING_MTM
WHERE 1 = 2 

SET @STRSQL = LOWER('BULK INSERT #FOCLOSING_MTM FROM ''' + @FILENAME  + '''  WITH ( FIELDTERMINATOR = '','', ROWTERMINATOR = ''\n'' )' )     
EXEC(@STRSQL)  

DELETE FROM FOCLOSING_MTM WHERE TRADE_DATE = @CLDATE

INSERT INTO FOCLOSING_MTM
SELECT TRADE_DATE, SERIES_ID=SYMBOL, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, 
		CL_RATE, OPEN_INTEREST, 
       FILLER1=ISNULL(FILLER1,''),FILLER2=ISNULL(FILLER2,''),FILLER3=ISNULL(FILLER3,''),FILLER4=ISNULL(FILLER4,''), GETDATE(), ''
FROM #FOCLOSING_MTM

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOAFTERCONSETTOFFFLAG
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[FOAFTERCONSETTOFFFLAG] 
@ADATE VARCHAR(11),
@APARTY_CODE VARCHAR(20),
@AINST_TYPE VARCHAR(20), 
@ASYMBOL VARCHAR(20),
@AEXPIRYDATE DATETIME,
@ASTRIKE_PRICE MONEY,
@AOPTION_TYPE VARCHAR(20)


AS 

SELECT @AEXPIRYDATE= LEFT(CONVERT(DATETIME,@AEXPIRYDATE,103),11)
 DECLARE 
 @@FOSETTLOOP AS CURSOR,
 @@TRADE_NO VARCHAR(14),
 @@TODAYQTY NUMERIC(9),
 @@LTRADE_NO VARCHAR(14),
 @@LQTY NUMERIC(9), 
 @@PDIFF NUMERIC(9),

/* T PREFIX STANDS FOR TODAY AND P STANDS FOR PREVIOUS */

 @@TPOSCUR CURSOR,
 @@TPARTY_CODE VARCHAR(20),
 @@TNETQTY NUMERIC(9),
 @@TINST_TYPE VARCHAR(20), 
 @@TSYMBOL VARCHAR(20),
 @@TEXPIRYDATE DATETIME,
 @@TSTRIKE_PRICE MONEY,
 @@TOPTION_TYPE VARCHAR(20),

 
 @@PPOSCUR CURSOR,
 @@PPARTY_CODE VARCHAR(20),
 @@PNETQTY NUMERIC(9),
 @@PINST_TYPE VARCHAR(20), 
 @@PSYMBOL VARCHAR(20),
 @@PEXPIRYDATE DATETIME,
 @@PSTRIKE_PRICE MONEY,
 @@POPTION_TYPE VARCHAR(20),

 @@DIFFQTY  NUMERIC(9),
 
 @@PYES AS CHAR(2) 

UPDATE FOSETTLEMENT SET SETTFLAG = '8' FROM FOSETTLEMENT  WHERE SAUDA_DATE LIKE @ADATE + '%' 
AND FOSETTLEMENT.PARTY_CODE = @APARTY_CODE AND 
FOSETTLEMENT.INST_TYPE = @AINST_TYPE AND FOSETTLEMENT.SYMBOL = @ASYMBOL
AND FOSETTLEMENT.EXPIRYDATE = @AEXPIRYDATE + ' 23:59:00' 
AND FOSETTLEMENT.OPTION_TYPE = @AOPTION_TYPE 
AND FOSETTLEMENT.STRIKE_PRICE = @ASTRIKE_PRICE
AND SELL_BUY = 1 AND SETTFLAG = '4'

UPDATE FOSETTLEMENT SET SETTFLAG = '9' FROM FOSETTLEMENT  WHERE SAUDA_DATE LIKE @ADATE + '%' 
AND FOSETTLEMENT.PARTY_CODE = @APARTY_CODE AND 
FOSETTLEMENT.INST_TYPE = @AINST_TYPE AND FOSETTLEMENT.SYMBOL = @ASYMBOL
AND FOSETTLEMENT.EXPIRYDATE = @AEXPIRYDATE + ' 23:59:00' 
AND FOSETTLEMENT.OPTION_TYPE = @AOPTION_TYPE 
AND FOSETTLEMENT.STRIKE_PRICE = @ASTRIKE_PRICE
AND SELL_BUY = 2 AND SETTFLAG = '5'

SELECT @@PYES = 'F'

SET @@TPOSCUR = CURSOR FOR

/* THE VIEW BBGFOSETTBFVIEW SELECTS ONLY THOSE CLIENTS WHOSE BROK_SCHEME = 20 '*/

SELECT PARTY_CODE, INST_TYPE, SYMBOL,EXPIRYDATE,NETQTY = SUM(PQTY - SQTY),  /* SELL_BUY = (CASE WHEN SUM(PQTY - SQTY) < 0 THEN '2' ELSE '1' END),   PQTY,SQTY, */ STRIKE_PRICE,OPTION_TYPE  
FROM BBGFOSETTBFVIEW WHERE EXPIRYDATE >= @ADATE + ' 23:59:00'
AND SAUDA_DATE LIKE @ADATE + '%' AND SETTFLAG IN(8,9) 
AND PARTY_CODE = @APARTY_CODE 
AND SYMBOL = @ASYMBOL 
AND INST_TYPE = @AINST_TYPE 
AND OPTION_TYPE = @AOPTION_TYPE
AND EXPIRYDATE =@AEXPIRYDATE + ' 23:59:00' 
GROUP BY PARTY_CODE, INST_TYPE, SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
ORDER BY PARTY_CODE ,INST_TYPE,SYMBOL 

OPEN @@TPOSCUR
FETCH NEXT FROM @@TPOSCUR INTO @@TPARTY_CODE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TNETQTY,@@TSTRIKE_PRICE,@@TOPTION_TYPE

IF @@FETCH_STATUS = 0   
BEGIN
     WHILE @@FETCH_STATUS = 0 
     BEGIN
          SET @@PPOSCUR = CURSOR FOR
 
          SELECT PARTY_CODE, NETQTY = (SUM(PQTY - SQTY)),INST_TYPE, SYMBOL,EXPIRYDATE, STRIKE_PRICE,OPTION_TYPE   
          FROM BBGFOSETTBFVIEW WHERE  
          EXPIRYDATE >= @ADATE +  ' 23:59:59'
          AND PARTY_CODE = @@TPARTY_CODE AND SAUDA_DATE < CONVERT(SMALLDATETIME,@ADATE + ' 00:00:00') AND EXPIRYDATE >= @ADATE + ' 23:59:59'
          AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL AND EXPIRYDATE = @@TEXPIRYDATE
          AND STRIKE_PRICE = @@TSTRIKE_PRICE AND OPTION_TYPE = @@TOPTION_TYPE
          GROUP BY PARTY_CODE, INST_TYPE, SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
       
          OPEN @@PPOSCUR
          FETCH NEXT FROM @@PPOSCUR INTO @@PPARTY_CODE, @@PNETQTY,@@PINST_TYPE ,@@PSYMBOL,@@PEXPIRYDATE,@@PSTRIKE_PRICE,@@POPTION_TYPE                
   
          IF @@FETCH_STATUS = 0
                   
          WHILE @@FETCH_STATUS = 0 
                BEGIN
                                
                     IF  ABS(@@PNETQTY) <  ABS(@@TNETQTY)
                     BEGIN
                          SELECT @@DIFFQTY = ABS(@@PNETQTY)
                     END
                     IF  ABS(@@PNETQTY) >  ABS(@@TNETQTY)
                     BEGIN
                          SELECT @@DIFFQTY = ABS(@@TNETQTY)
                     END
 
                     IF ((@@PNETQTY + @@TNETQTY ) = 0 )   
                     BEGIN
                           IF @@TNETQTY > 0 
                           BEGIN
                                UPDATE FOSETTLEMENT SET SETTFLAG = '6' 
                                WHERE
                                EXPIRYDATE >= @ADATE +  ' 23:59:59'
                                AND PARTY_CODE = @@TPARTY_CODE AND SAUDA_DATE LIKE @ADATE +'%'  AND EXPIRYDATE >= @ADATE + ' 23:59:59'
                                AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL 
                                AND EXPIRYDATE = @@TEXPIRYDATE
                                AND STRIKE_PRICE = @@TSTRIKE_PRICE 
                                AND OPTION_TYPE = @@TOPTION_TYPE
                                AND SETTFLAG IN(8)
                           END 
                           
                           IF @@TNETQTY < 0 
                           BEGIN
                                UPDATE FOSETTLEMENT SET SETTFLAG = '6' 
                                WHERE
                                EXPIRYDATE >= @ADATE +  ' 23:59:59'
                                AND PARTY_CODE = @@TPARTY_CODE AND SAUDA_DATE LIKE @ADATE +'%'  AND EXPIRYDATE >= @ADATE + ' 23:59:59'
                                AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL 
                                AND EXPIRYDATE = @@TEXPIRYDATE
                                AND STRIKE_PRICE = @@TSTRIKE_PRICE 
                                AND OPTION_TYPE = @@TOPTION_TYPE
                                AND SETTFLAG IN(9)
                           END
                     END 


                     /* IF POSITION TILL YESTERDAY AND POSITION FOR TODAY ARE + THEN */ 
                     IF ( (@@PNETQTY >= 0 ) AND (@@TNETQTY > 0))   
                     BEGIN
                          UPDATE FOSETTLEMENT SET SETTFLAG = '8' 
                          WHERE
                                EXPIRYDATE >= @ADATE +  ' 23:59:59'
                                AND PARTY_CODE = @@TPARTY_CODE AND SAUDA_DATE LIKE @ADATE +'%'  AND EXPIRYDATE >= @ADATE + ' 23:59:59'
                                AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL 
                                AND EXPIRYDATE = @@TEXPIRYDATE
                                AND STRIKE_PRICE = @@TSTRIKE_PRICE 
                                AND OPTION_TYPE = @@TOPTION_TYPE
                                AND SETTFLAG IN(8)
                     END 

                     /* IF POSITION TILL YESTERDAY AND POSITION FOR TODAY ARE - THEN */
                     IF ( (@@PNETQTY <= 0 ) AND (@@TNETQTY < 0))   
                     BEGIN
                         UPDATE FOSETTLEMENT SET SETTFLAG = '9' 
                         WHERE
                                EXPIRYDATE >= @ADATE +  ' 23:59:59'
                                AND PARTY_CODE = @@TPARTY_CODE AND SAUDA_DATE LIKE @ADATE +'%'  AND EXPIRYDATE >= @ADATE + ' 23:59:59'
                                AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL 
                                AND EXPIRYDATE = @@TEXPIRYDATE
                                AND STRIKE_PRICE = @@TSTRIKE_PRICE 
                                AND OPTION_TYPE = @@TOPTION_TYPE
                                AND SETTFLAG IN(9)
                     END   

                     /* NOW WE WILL TAKE THE CASE WHERE CUMULATIVE POSITION TILL YESTERDAY IS + AND TODAYS IS NEGATIVE */  
                     IF ( (@@PNETQTY > 0 ) AND (@@TNETQTY < 0))   
                     BEGIN
                          /* IF POSITION TILL YESTERDAY IS GREATER THAN ABSOLUTE OF TODAY OR EQUAL THEN THE SETTSETTOFF WILL APPLY */  
                          IF (@@PNETQTY) >= ABS(@@TNETQTY)
                          BEGIN 
                                UPDATE FOSETTLEMENT SET SETTFLAG = '7' 
                                WHERE
                                     EXPIRYDATE >= @ADATE +  ' 23:59:59'
                                     AND PARTY_CODE = @@TPARTY_CODE AND SAUDA_DATE LIKE @ADATE +'%'  AND EXPIRYDATE >= @ADATE + ' 23:59:59'
                                     AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL 
                                     AND EXPIRYDATE = @@TEXPIRYDATE
                                     AND STRIKE_PRICE = @@TSTRIKE_PRICE 
                                     AND OPTION_TYPE = @@TOPTION_TYPE
                                     AND SETTFLAG IN(9)

                           END

                          IF ((@@PNETQTY) < ABS(@@TNETQTY)) 
                          BEGIN
                               EXEC FOAFTERSETTARRANGE @@TPARTY_CODE,@@TOPTION_TYPE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TSTRIKE_PRICE,@ADATE,@@DIFFQTY,'S'
                          END
  
                          
                     END 

                     
                     IF ( (@@PNETQTY < 0 ) AND (@@TNETQTY > 0))   
                     BEGIN
                          IF ABS(@@PNETQTY) >= (@@TNETQTY)
                          BEGIN 
                             UPDATE FOSETTLEMENT SET SETTFLAG = '6' 
                             WHERE
                                  EXPIRYDATE >= @ADATE +  ' 23:59:59'
                                  AND PARTY_CODE = @@TPARTY_CODE AND SAUDA_DATE LIKE @ADATE +'%'  AND EXPIRYDATE >= @ADATE + ' 23:59:59'
                                  AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL 
                                  AND EXPIRYDATE = @@TEXPIRYDATE
                                  AND STRIKE_PRICE = @@TSTRIKE_PRICE 
                                  AND OPTION_TYPE = @@TOPTION_TYPE
                                  AND SETTFLAG IN(8)
                          END

                          IF ABS(@@PNETQTY) < ABS(@@TNETQTY) 
                          BEGIN
                               EXEC FOAFTERSETTARRANGE @@TPARTY_CODE,@@TOPTION_TYPE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TSTRIKE_PRICE,@ADATE,@@DIFFQTY,'B'
                          END
   
                     END 
                      
                     FETCH NEXT FROM @@PPOSCUR INTO @@PPARTY_CODE, @@PNETQTY,@@PINST_TYPE ,@@PSYMBOL,@@PEXPIRYDATE,@@PSTRIKE_PRICE,@@POPTION_TYPE
                           
                END

     FETCH NEXT FROM @@TPOSCUR INTO @@TPARTY_CODE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TNETQTY,@@TSTRIKE_PRICE,@@TOPTION_TYPE
     END  
END
IF @@PYES = 'T'
BEGIN 
     CLOSE @@PPOSCUR
END
CLOSE @@TPOSCUR

IF @@PYES = 'T'
BEGIN 
     DEALLOCATE @@PPOSCUR
END

DEALLOCATE @@TPOSCUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOAFTERSETTARRANGE
-- --------------------------------------------------
/* FINAL AS ON JAN 22 2002   7:45  P.M  */

/* DROP PROCEDURE FOAFTERSETTARRANGE */

CREATE PROCEDURE [dbo].[FOAFTERSETTARRANGE]
@PARTY_CODE VARCHAR(10),
@OPTION_TYPE VARCHAR(2),
@INST_TYPE VARCHAR(6),
@SYMBOL VARCHAR(12),
@EXPIRYDATE VARCHAR(11),
@STRIKE_PRICE MONEY,
@TDATE VARCHAR(11),
@DIFFQTY NUMERIC(9),
@SELL_BUY CHAR(2)

AS 
DECLARE 
 @@TRADE_NO VARCHAR(14),
 @@PQTY NUMERIC(9), 
 @@SQTY NUMERIC(9),
 @@LTRADE_NO VARCHAR(14),
 @@LQTY NUMERIC(9), 
 @@PDIFF NUMERIC(9),
 @@FLAG CURSOR,
 @@LOOP CURSOR



 IF @SELL_BUY = 'B' 
 BEGIN 
      SELECT @@PDIFF = ABS(@DIFFQTY)
      SET @@LOOP  = CURSOR FOR 
      SELECT TRADE_NO,TRADEQTY FROM FOSETTLEMENT 
      WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
      AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE 
      AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   AND SELL_BUY = 1 
      AND SETTFLAG IN (4,8)
      ORDER BY TRADEQTY DESC
      OPEN @@LOOP
      FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
     
      WHILE @@PDIFF > 0       
      BEGIN
           IF @@PDIFF >= @@LQTY  
           BEGIN
                UPDATE FOSETTLEMENT SET SETTFLAG = 6   
                WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
                AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
                AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  AND SETTFLAG IN (4,8)
                SELECT @@PDIFF = @@PDIFF - @@LQTY
           END    
           ELSE IF @@PDIFF < @@LQTY 
           BEGIN
                INSERT INTO FOSETTLEMENT SELECT CONTRACTNO,BILLNO,'U'+TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,
                STRIKE_PRICE,OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,@@PDIFF,AUCTIONPART,MARKETTYPE,SERIES,
                ORDER_NO,PRICE,SAUDA_DATE,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,
                SELL_BUY,6,BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,
                SERVICE_TAX,@@PDIFF*PRICE,BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE
                ,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2
                 FROM FOSETTLEMENT WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
                 AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
                 AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY    
 
                UPDATE FOSETTLEMENT SET SETTFLAG = 8,TRADEQTY = @@LQTY - @@PDIFF,TRADE_AMOUNT = (@@LQTY - @@PDIFF)*PRICE    
                WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
                AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
                AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY 
                SELECT @@PDIFF = 0   
             END 
             FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY
        END
        CLOSE @@LOOP
  END
      ELSE 
      BEGIN 
            SELECT @@PDIFF = ABS(@DIFFQTY)
           SET @@LOOP  = CURSOR FOR 
           SELECT TRADE_NO,TRADEQTY FROM FOSETTLEMENT 
           WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
           AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE 
           AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   AND SELL_BUY = 2 
           AND SETTFLAG IN (5,9)
           ORDER BY TRADEQTY DESC
           OPEN @@LOOP
           FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
           WHILE @@PDIFF > 0       
           BEGIN
                IF @@PDIFF >= @@LQTY  
                BEGIN
                     UPDATE FOSETTLEMENT SET SETTFLAG = 7   
                     WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
                     AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
                     AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  AND SETTFLAG IN (4,8)
                     SELECT @@PDIFF = @@PDIFF - @@LQTY
                END    
                ELSE IF @@PDIFF < @@LQTY 
                BEGIN
                     INSERT INTO FOSETTLEMENT SELECT CONTRACTNO,BILLNO,'S'+TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL,
                     SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,@@PDIFF,
                     AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,SAUDA_DATE,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,
                     DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,7,BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,
                     TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,@@PDIFF*PRICE,BILLFLAG,SETT_NO,
                     NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE
                     ,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2
                      FROM FOSETTLEMENT WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
                      AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
                      AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY    
 
                      UPDATE FOSETTLEMENT SET SETTFLAG = 9,TRADEQTY = @@LQTY - @@PDIFF,TRADE_AMOUNT = (@@LQTY - @@PDIFF)*PRICE    
                      WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
                      AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
                      AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY 
                      SELECT @@PDIFF = 0   
                 END 
                 FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY
           END
           CLOSE @@LOOP
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOBILLGENERATE
-- --------------------------------------------------
CREATE PROC [dbo].[FOBILLGENERATE] 
	(
	@SAUDA_DATE VARCHAR(11),
	@USERNAME VARCHAR(50) =''
	) AS

DECLARE  @@MATURITYDATE VARCHAR(17)        


SELECT TOP 1 @@MATURITYDATE = LEFT(CONVERT(VARCHAR,MATURITYDATE,109),11) + ' 23:59'
FROM FOSCRIP2 (NOLOCK) WHERE  LEFT(CONVERT(VARCHAR,MATURITYDATE,109),11) = @SAUDA_DATE    
        
IF @@MATURITYDATE IS NOT NULL         
BEGIN        
 	EXEC FOREARRANGEBILLFLAG @@MATURITYDATE  
	EXEC CALCULATE_STAMP_DUTY @SAUDA_DATE
END

UPDATE 
	V2_BUSINESS_PROCESS 
SET 
	BILLING = BILLING + 1 ,
	LASTUPDATEDATE = GETDATE()

WHERE 
	LEFT(BUSINESS_DATE,11) = @SAUDA_DATE


INSERT INTO V2_PROCESS_STATUS_LOG 
( 
	EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,
	FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP
)
SELECT
	EXCHANGE=(SELECT TOP 1 EXCHANGE FROM FOTAXES),
	SEGMENT='FUTURES',
	BUSINESSDATE=@SAUDA_DATE,
	PROCESSID = 'BILLGEN',
	PROCESSNAME = 'BILL GENERATION',
	FILENAME='',
	START_END_FLAG=1,
	PROCESSDATE=GETDATE(),
	PROCESSBY=@USERNAME,
	MACHINEIP=''

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FODAILYCONFFSHEET
-- --------------------------------------------------
CREATE PROC [dbo].[FODAILYCONFFSHEET]
@SDATE VARCHAR(11),  
@PARTY VARCHAR(10)  
AS  
  
  
SELECT PARTY_CODE,INST_TYPE,SYMBOL,EXPDATE,EXPIRYDATE,TRADE_NO,PQTY,SQTY ,PAMT,SAMT,SAUDA_DATE,NETRATE,  
CHARGES,BROKERAGE,SERVICE_TAX,BROKER_NOTE,TURN_TAX,SEBI_TAX,YEXP,MEXP,DEXP ,
STIME = CONVERT(VARCHAR,SAUDA_DATE,108),OTHER_CHRG
FROM FODAILYCONFFSHEETVIEW  
WHERE   
SAUDA_DATE >= @SDATE   AND  
SAUDA_DATE < @SDATE + ' 23:59:00'  
AND PARTY_CODE LIKE @PARTY    
ORDER BY PARTY_CODE,INST_TYPE,SYMBOL,YEXP,MEXP,DEXP,TRADE_NO,SAUDA_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FODAILYCONFOPSHEET
-- --------------------------------------------------
CREATE PROC [dbo].[FODAILYCONFOPSHEET]
@SDATE VARCHAR(11),
@PARTY VARCHAR(10)
AS

SELECT RTRIM(LTRIM(PARTY_CODE)) AS PARTY_CODE,RTRIM(LTRIM(INST_TYPE)) AS INST_TYPE,
RTRIM(LTRIM(SYMBOL)) AS SYMBOL,EXPDATE,EXPIRYDATE,TRADE_NO,PQTY,SQTY,
PAMT,SAMT,SAUDA_DATE,NETRATE,
CHARGES,BROKERAGE,SERVICE_TAX,BROKER_NOTE,TURN_TAX,SEBI_TAX,STRIKE_PRICE,
RTRIM(LTRIM(OPTION_TYPE)) AS OPTION_TYPE,YEXP,MEXP,DEXP,OTHER_CHRG
FROM FODAILYCONFOPSHEETVIEW
WHERE 
SAUDA_DATE >=  @SDATE  AND 
SAUDA_DATE < @SDATE + ' 23:59:00' AND
PARTY_CODE LIKE @PARTY 
ORDER BY PARTY_CODE,INST_TYPE,SYMBOL,YEXP,MEXP,DEXP,STRIKE_PRICE,OPTION_TYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FODAILYEXER
-- --------------------------------------------------
--EXEC FODAILYEXER '20 APR 2006','0000000000' 

CREATE PROC [dbo].[FODAILYEXER] 
	(
	@SAUDA VARCHAR(11),
	@PARTY VARCHAR(10)
	) 

	AS

SELECT 
	CONTRACTNO,
	BILLNO,
	TRADE_NO=PRADNYA.DBO.REPLACETRADENO(TRADE_NO),
	PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	SEC_NAME,
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE,
	TRADEQTY=SUM(TRADEQTY),
	AUCTIONPART,
	MARKETTYPE,
	SERIES,
	ORDER_NO,
	PRICE,
	SAUDA_DATE,
	SELL_BUY,
	BROKAPPLIED=SUM(TRADEQTY*BROKAPPLIED)/SUM(TRADEQTY),
	NETRATE=PRICE,
	AMOUNT=SUM(AMOUNT),
	INS_CHRG=SUM(INS_CHRG),
	TURN_TAX=SUM(TURN_TAX),
	OTHER_CHRG=SUM(OTHER_CHRG),
	SEBI_TAX=SUM(SEBI_TAX),
	BROKER_CHRG=SUM(BROKER_CHRG),
	SERVICE_TAX=SUM(SERVICE_TAX),
	TRADE_AMOUNT=SUM(TRADE_AMOUNT),
	SETT_NO,
	NBROKAPP=0,
	NSERTAX=0,
	N_NETRATE=0,
	SETT_TYPE,
	BILLFLAG=0,
	CL_RATE,
	PARTICIPANTCODE,
	STATUS,
	RESERVED1,
	RESERVED2,
	TOTALBROK=CONVERT(NUMERIC(36, 12),0),
	TOTALSER=CONVERT(NUMERIC(36, 12),0),
	BOOKTYPE,
	INSTRUMENT
INTO
	#FOSETTLEMENT 
FROM
	FOSETTLEMENT                  
WHERE
	CONVERT(VARCHAR,SAUDA_DATE,106) = @SAUDA        
	AND PARTY_CODE = @PARTY
	AND LEFT(INST_TYPE,3) = 'OPT'
	AND TRADEQTY > 0       
	AND AUCTIONPART ='EA'
GROUP BY
	CONTRACTNO,BILLNO,PRADNYA.DBO.REPLACETRADENO(TRADE_NO),
	PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
	AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,SAUDA_DATE,SELL_BUY,
	SETT_NO,SETT_TYPE,CL_RATE,PARTICIPANTCODE,STATUS,RESERVED1,RESERVED2,
	BOOKTYPE,
	INSTRUMENT

ORDER BY
	PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, SAUDA_DATE                  


SELECT
	PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	EXPDATE,
	STRIKE_PRICE,
	OPTION_TYPE,
	PQTY,
	PAMT,
	SQTY,
	SAMT,
	NETRATE,
	CHARGES,
	BROKERAGE,
	SERVICE_TAX,
	BROKER_NOTE,
	TURN_TAX,
	SEBI_TAX,
	YEXP,
	MEXP,
	DEXP,
	OTHER_CHRG
FROM 
(
	SELECT 
		S.PARTY_CODE,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE = LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),
		EXPDATE = CONVERT(VARCHAR,EXPIRYDATE,103),
		S.SAUDA_DATE,
		STRIKE_PRICE,
		OPTION_TYPE,
		PQTY=(CASE WHEN SELL_BUY=1 THEN SUM(TRADEQTY) ELSE 0 END),
		PAMT=(CASE WHEN SELL_BUY=1 THEN SUM(TRADEQTY*PRICE * BOOKTYPE/INSTRUMENT) ELSE 0 END),
		SQTY=(CASE WHEN SELL_BUY=2 THEN SUM(TRADEQTY) ELSE 0 END),
		SAMT=(CASE WHEN SELL_BUY=2 THEN SUM(TRADEQTY*PRICE * BOOKTYPE/INSTRUMENT) ELSE 0 END),
		YEAR(EXPIRYDATE)AS YEXP,MONTH(EXPIRYDATE)AS MEXP,DAY(EXPIRYDATE)AS DEXP,PRICE AS NETRATE,
		CHARGES=
			  SUM(BROKAPPLIED*TRADEQTY * BOOKTYPE/INSTRUMENT) 
			  + (CASE WHEN C2.SERVICE_CHRG <> 2 
				  THEN SUM(SERVICE_TAX)
				  ELSE 0 
		             END)
			  + (CASE WHEN C2.OTHER_CHRG = 1 
				  THEN SUM(S.OTHER_CHRG)
				  ELSE 0 
		             END)
			  + (CASE WHEN TURNOVER_TAX = 1 
				  THEN SUM(TURN_TAX)		
				  ELSE 0 
		             END)	 
			  + (CASE WHEN SEBI_TURN_TAX = 1 
				  THEN SUM(SEBI_TAX)		
				  ELSE 0 
		             END)		
			  + (CASE WHEN BROKERNOTE = 1 
				  THEN SUM(BROKER_CHRG)
				  ELSE 0 
		             END) ,
		BROKERAGE=SUM(BROKAPPLIED*TRADEQTY * BOOKTYPE/INSTRUMENT),
		SERVICE_TAX=(CASE WHEN C2.SERVICE_CHRG <> 2 
				  THEN SUM(SERVICE_TAX)
				  ELSE 0 
			     END ),
		BROKER_NOTE=(CASE WHEN BROKERNOTE = 1 
				  THEN SUM(BROKER_CHRG)
				  ELSE 0 
		             END),
		TURN_TAX=(CASE WHEN TURNOVER_TAX = 1 
				  THEN SUM(TURN_TAX)		
				  ELSE 0 
		             END),
		SEBI_TAX=(CASE WHEN SEBI_TURN_TAX = 1 
				  THEN SUM(SEBI_TAX)		
				  ELSE 0 
		             END),
		OTHER_CHRG = (CASE WHEN C2.OTHER_CHRG = 1 
				  THEN SUM(S.OTHER_CHRG)		
				  ELSE 0 
		             END)
	FROM 
		#FOSETTLEMENT S,
		CLIENT2 C2
	WHERE 
		INST_TYPE LIKE 'OPT%'
		AND AUCTIONPART = 'EA'
		AND S.PARTY_CODE = C2.PARTY_CODE
	GROUP BY 
		S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,
		S.STRIKE_PRICE,S.OPTION_TYPE,S.SELL_BUY,PRICE,C2.SERVICE_CHRG,
		TURNOVER_TAX,SEBI_TURN_TAX,INSURANCE_CHRG,BROKERNOTE,S.SAUDA_DATE,
		C2.OTHER_CHRG
	)
	FODAILYEXERVIEW
	WHERE 
		SAUDA_DATE >=  @SAUDA 
		AND SAUDA_DATE < @SAUDA + ' 23:59:00'
		AND PARTY_CODE LIKE @PARTY 
	ORDER BY 
		PARTY_CODE,INST_TYPE,SYMBOL,YEXP,MEXP,DEXP,OPTION_TYPE ,STRIKE_PRICE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FODAILYSUMSHEET
-- --------------------------------------------------
CREATE PROC [dbo].[FODAILYSUMSHEET]  
@SDATE VARCHAR(11),  
@PARTY VARCHAR(10)  
AS  
  
SELECT 
	SUM(PQTY)AS PQTY,
	SUM(SQTY)AS SQTY,
	PAMT=SUM(PQTY*NETRATE),
	SAMT=SUM(SQTY*NETRATE),  
	CHARGES = SUM(CHARGES),
	PARTY_CODE = LTRIM(RTRIM(PARTY_CODE)),
	F.INST_TYPE,
	F.SYMBOL,
	CONVERT(VARCHAR,F.EXPIRYDATE,106)AS EXPDATE,
	CONVERT(VARCHAR,F.EXPIRYDATE,103)AS EXPIRYDATE,
	FLAG,
	LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) AS SAUDA_DATE,
	YEAR(F.EXPIRYDATE),
	MONTH(F.EXPIRYDATE),
	DAY(F.EXPIRYDATE)
FROM 
	FODAILY F, FOSCRIP2 F2 
WHERE   
	F.INST_TYPE = F2.INST_TYPE
	AND F.SYMBOL = F2.SYMBOL
	AND LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,103),11) = LEFT(CONVERT(VARCHAR,F2.EXPIRYDATE,103),11)
	AND F.OPTION_TYPE = F2.OPTION_TYPE
	AND F.STRIKE_PRICE = F2.STRIKE_PRICE	
	AND SAUDA_DATE = @SDATE + ' 23:59:00'
	AND PARTY_CODE LIKE @PARTY 
	AND F.INST_TYPE LIKE 'FUT%'  
GROUP BY 
	PARTY_CODE,
	F.INST_TYPE,
	F.SYMBOL,
	F.EXPIRYDATE,FLAG,
	SAUDA_DATE
ORDER BY 
	PARTY_CODE,
	F.INST_TYPE,
	F.SYMBOL,
	YEAR(F.EXPIRYDATE),
	MONTH(F.EXPIRYDATE),
	DAY(F.EXPIRYDATE),
	F.EXPIRYDATE,
	FLAG,
	SAUDA_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FODUPRECSETTCHECK
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[FODUPRECSETTCHECK] AS

UPDATE FOFTTRADE SET OPTION_TYPE ='' WHERE STRIKE_PRICE = 0
UPDATE FOFTTRADE SET EXPIRYDATE = LEFT(EXPIRYDATE,11) + ' 23:59'

UPDATE FOFTTRADE SET PARTICIPANTCODE = MEMBERCODE WHERE PRO_CLI <> 3


DELETE FOFTTRADE FROM FOTRADEMISSING WHERE  
FOTRADEMISSING.TRADE_NO = FOFTTRADE.TRADE_NO AND   
FOTRADEMISSING.ORDER_NO = FOFTTRADE.ORDER_NO AND   
FOTRADEMISSING.INST_TYPE = FOFTTRADE.INST_TYPE AND   
FOTRADEMISSING.SYMBOL = FOFTTRADE.SYMBOL AND   
FOTRADEMISSING.EXPIRYDATE = FOFTTRADE.EXPIRYDATE AND   
FOTRADEMISSING.STRIKE_PRICE = FOFTTRADE.STRIKE_PRICE AND   
FOTRADEMISSING.OPTION_TYPE = FOFTTRADE.OPTION_TYPE    

INSERT INTO FOTRADE
SELECT TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SEC_NAME='',BOOKTYPE=0,BOOKTYPENAME=0,MARKETTYPE,
USER_ID,BRANCH_ID=PARTY_CODE,SELL_BUY,TRADEQTY,PRICE,PRO_CLI=PRO_CLI,PARTY_CODE,
PARTICIPANTCODE=PARTICIPANTCODE,O_C_FLAG=0,C_U_FLAG=0,ACTIVITYTIME,
ACTIVITYTIME,ORDER_NO,OPP_BROKER_ID,
SETTFLAG=0,MEMBERCODE,TMPARTYCODE=PARTY_CODE,RESERVED1=PRICE,RESERVED2=2,RESERVED3=0,RESERVED4=0,RESERVED5=''
FROM FOFTTRADE WHERE NOT EXISTS 
           (         
             SELECT TM.TRADE_NO FROM FOTRADE TM      
             WHERE FOFTTRADE.ACTIVITYTIME = TM.ACTIVITYTIME        
             AND FOFTTRADE.TRADE_NO = TM.TRADE_NO         
             AND FOFTTRADE.ORDER_NO = TM.ORDER_NO          
             AND FOFTTRADE.INST_TYPE=TM.INST_TYPE          
             AND FOFTTRADE.SYMBOL=TM.SYMBOL          
             AND FOFTTRADE.EXPIRYDATE=TM.EXPIRYDATE          
             AND FOFTTRADE.STRIKE_PRICE=TM.STRIKE_PRICE        
             AND FOFTTRADE.OPTION_TYPE =TM.OPTION_TYPE                  
             AND FOFTTRADE.TRADEQTY = TM.TRADEQTY          
             AND FOFTTRADE.PRICE = TM.PRICE          
           )      
    
  
UPDATE FOTRADE SET PARTY_CODE = NEWPARTY_CODE FROM PARTYMAPPING  
WHERE PARTY_CODE = OLDPARTY_CODE   
          
UPDATE FOTRADE SET TRADEQTY = TRADEQTY*C_REGULAR_LOT,
FOTRADE.RESERVED5 = C_REGULAR_LOT
FROM FOSCRIP2 
WHERE FOTRADE.INST_TYPE = FOSCRIP2.INST_TYPE AND
FOTRADE.INST_TYPE = FOSCRIP2.INST_TYPE AND
FOTRADE.SYMBOL = FOSCRIP2.SYMBOL AND
FOTRADE.EXPIRYDATE = FOSCRIP2.EXPIRYDATE AND
FOTRADE.OPTION_TYPE = FOSCRIP2.OPTION_TYPE AND
FOTRADE.STRIKE_PRICE = FOSCRIP2.STRIKE_PRICE
AND FOTRADE.RESERVED5 <> C_REGULAR_LOT

DELETE FOTRADE FROM FOSETTLEMENT S WHERE 
FOTRADE.ACTIVITYTIME = S.SAUDA_DATE 
AND FOTRADE.TRADE_NO = PRADNYA.DBO.REPLACETRADENO(S.TRADE_NO)
AND FOTRADE.ORDER_NO = S.ORDER_NO          
AND FOTRADE.INST_TYPE=S.INST_TYPE          
AND FOTRADE.SYMBOL=S.SYMBOL          
AND FOTRADE.EXPIRYDATE=S.EXPIRYDATE          
AND FOTRADE.STRIKE_PRICE=S.STRIKE_PRICE        
AND FOTRADE.OPTION_TYPE =S.OPTION_TYPE   
AND FOTRADE.SELL_BUY = S.SELL_BUY


IF (SELECT MEMBERTYPE FROM FOOWNER) = 'CM'
BEGIN

	UPDATE FOTRADE SET PARTY_CODE= FOTMINFO.PARTY_CODE 
	FROM FOTMINFO WHERE FOTMINFO.TM_CODE=FOTRADE.MEMBERCODE

	UPDATE FOTRADE SET PARTY_CODE= CLIENT2.PARTY_CODE
	FROM CLIENT2 WHERE CLIENT2.BANKID = FOTRADE.PARTICIPANTCODE AND 
	MEMBERCODE NOT IN (SELECT TM_CODE FROM FOTMINFO)

END


TRUNCATE TABLE FOFTTRADE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOFUTMATDAILY
-- --------------------------------------------------
CREATE  PROC [dbo].[FOFUTMATDAILY]  
@SDATE VARCHAR(11),  
@PARTY VARCHAR(10),  
@SYMBOL VARCHAR(15)  
AS  

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
  
SELECT CHARGES=(CASE WHEN BILLFLAG > 3 THEN SUM(S.NBROKAPP*TRADEQTY*BOOKTYPE/INSTRUMENT)   
   + (CASE WHEN C2.SERVICE_CHRG <> 2   
    THEN SUM(S.NSERTAX)  
    ELSE 0   
             END)  
   ELSE 0 END),  
BROKERAGE=(CASE WHEN BILLFLAG > 3 THEN SUM(S.NBROKAPP*TRADEQTY*BOOKTYPE/INSTRUMENT) ELSE 0 END),  
SERVICE_TAX=(CASE WHEN BILLFLAG > 3 THEN (CASE WHEN C2.SERVICE_CHRG <> 2   
    THEN SUM(S.NSERTAX)  
    ELSE 0   
      END ) ELSE 0 END),  
BROKER_NOTE=0,  
TURN_TAX=0,  
SEBI_TAX=0  
FROM FOSETTLEMENT S , CLIENT2 C2  
WHERE S.PARTY_CODE LIKE @PARTY + '%'  
AND S.INST_TYPE LIKE 'FUT%'   
AND S.SYMBOL LIKE @SYMBOL + '%'  
AND S.PARTY_CODE = C2.PARTY_CODE  
AND LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11) = @SDATE  
AND NBROKAPP <> 0  
GROUP BY  S.BILLFLAG,C2.SERVICE_CHRG

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOGENBILLNO
-- --------------------------------------------------
CREATE  PROC [dbo].[FOGENBILLNO] (@BILLDATE VARCHAR(11)) AS  
DECLARE @@BILLFLAG INT,  
@@PARTY_CODE VARCHAR(10),  
@@BILLNO INT,  
@@BILLCUR CURSOR  

  
UPDATE FOACCBILL SET BILL_NO = 0 WHERE BILLDATE LIKE @BILLDATE + '%'    
    
TRUNCATE TABLE BILLNO     
INSERT INTO BILLNO     
SELECT DISTINCT PARTY_CODE FROM FOACCBILL     
WHERE PARTY_CODE NOT IN ( SELECT ACCODE FROM VALANACCOUNT )    
AND BILLDATE LIKE @BILLDATE + '%'    
ORDER BY PARTY_CODE    
    
UPDATE FOACCBILL SET BILL_NO = B.BILL_NO    
FROM BILLNO B    
WHERE BILLDATE LIKE @BILLDATE + '%'    
AND B.PARTY_CODE = FOACCBILL.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOGENCONTRACT
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[FOGENCONTRACT]   ( @UNAME VARCHAR(50)='')            
AS               
DECLARE                   
 @@INTCOUNT INT,      
 @@MEMBERCODE VARCHAR(15),      
 @@SAUDA_DATE VARCHAR(11),                  
 @@STYLE INT,      
 @@CONTNO INT,      
 @@PARTYCONT CURSOR,      
 @PARTY_CODE VARCHAR(10),      
 @OPTION_TYPE VARCHAR(2),      
 @INST_TYPE VARCHAR(6),          
 @SYMBOL VARCHAR(12),          
 @EXPIRYDATE VARCHAR(11),          
 @STRIKE_PRICE MONEY,          
 @TDATE VARCHAR(11)          
     
  SELECT TOP 1  @@SAUDA_DATE = LEFT(CONVERT(VARCHAR,ACTIVITYTIME,109),11) FROM  FOTRADE                   
    
  SELECT DISTINCT PARTY_CODE, OPTION_TYPE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE         
  INTO #FOSETT FROM FOSETTLEMENT WITH(NOLOCK)        
  WHERE SAUDA_DATE BETWEEN @@SAUDA_DATE AND @@SAUDA_DATE + ' 23:59' AND AUCTIONPART <> 'CA'        
  AND TRADEQTY > 0      
                  
                    
  SELECT @@MEMBERCODE=MEMBERCODE,@@STYLE=ISNULL(STYLE,0) FROM FOOWNER                  
                    

           
  TRUNCATE TABLE BBGFOSETTLEMENT                  
                  
  /*TAKING TRADES FORM FOCONFIRMVIEW*/                    
  INSERT INTO BBGFOSETTLEMENT                  
    SELECT '0000000',BILLNO = C_REGULAR_LOT, TRADE_NO, PARTY_CODE,                  
    INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,USER_ID ,PRO_CLI,O_C_FLAG,C_U_FLAG,      
    TRADEQTY,      
    AUCTIONPART,MARKETTYPE,0, ORDER_NO,PRICE,                  
    ACTIVITYTIME,TABLE_NO,LINE_NO,VAL_PERC, NORMAL ,DAY_PUC, DAY_SALES,                  
    SETT_PURCH, SETT_SALES, SELL_BUY,SETTFLAG, BROKAPPLIED,NETRATE,                  
    AMOUNT, INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX, BROKER_CHRG,SERVICE_TAX,                  
    TRADE_AMOUNT , 1 ,RESERVED4,                  
    0 ,0 ,0, 'F',0                  
    ,PARTICIPANTCODE,STATUS,CPID =  CASE WHEN PATINDEX('%:%',OPP_BROKER_ID)>0 THEN RIGHT(OPP_BROKER_ID,8) ELSE '0' END,    
    INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1=0,DUMMY2=RESERVED1,                  
    RESERVED1=(CASE WHEN PARTICIPANTCODE IS NOT NULL AND (PARTICIPANTCODE  IN       
    (SELECT MEMBERCODE FROM FOOWNER) OR PARTICIPANTCODE = 'NCIT' OR  PARTICIPANTCODE ='') THEN 0       
    WHEN PARTICIPANTCODE IS NULL THEN 0                  
    ELSE 1 END),RESERVED2                  
  FROM FOCONFIRMVIEW                    
                    
  SELECT @@INTCOUNT = COUNT(PARTY_CODE) FROM FOSETTLEMENT WHERE SAUDA_DATE BETWEEN @@SAUDA_DATE AND @@SAUDA_DATE + ' 23:59'   AND CONVERT(INT,CONTRACTNO) <> 0                  
  /*INTRA DAY TRADES*/                  
  IF @@INTCOUNT > 0                   
   BEGIN                  
                  
 /*TAKING DATA TO TMP TABLE FOR UPDATING CONTRACT NUMBER*/                  
 SELECT DISTINCT I.PARTY_CODE,I.CONTRACTNO,I.ORDER_NO,I.INST_TYPE,I.SYMBOL,I.EXPIRYDATE,I.STRIKE_PRICE,I.OPTION_TYPE,INSCONT,SELL_BUY      
 INTO #FOSETTLEMENT                  
 FROM FOSETTLEMENT I, FOTRD_CLIENT2 C2                   
 WHERE I.SAUDA_DATE BETWEEN @@SAUDA_DATE AND @@SAUDA_DATE + ' 23:59'                   
 AND I.PARTY_CODE = C2.PARTY_CODE                   
 AND CONVERT(INT,I.CONTRACTNO) <> 0          
 AND I.DUMMY1 <> 1  
 AND TRADEQTY > 0 
 ORDER BY I.PARTY_CODE,I.INST_TYPE,I.SYMBOL,I.EXPIRYDATE,I.STRIKE_PRICE,I.OPTION_TYPE,I.ORDER_NO,I.CONTRACTNO,SELL_BUY      
       

 /*CONTRACT NUMBERING STYLE - SCRIPT WISE*/                
  UPDATE BBGFOSETTLEMENT SET CONTRACTNO = T.CONTRACTNO FROM BBGFOSETTLEMENT B,#FOSETTLEMENT T                
  WHERE B.PARTY_CODE = T.PARTY_CODE AND B.INST_TYPE=T.INST_TYPE AND B.SYMBOL=T.SYMBOL AND                
  B.EXPIRYDATE = T.EXPIRYDATE AND B.STRIKE_PRICE=T.STRIKE_PRICE AND B.OPTION_TYPE=T.OPTION_TYPE                
  AND B.SELL_BUY = T.SELL_BUY    
  AND ISNULL(T.INSCONT,'') <> 'O'    
  AND B.CONTRACTNO = '0000000'  
       
  /*CONTRACT NUMBERING STYLE - PARTY WISE*/   
     UPDATE BBGFOSETTLEMENT SET CONTRACTNO = P.CONTRACTNO FROM #FOSETTLEMENT P                
     WHERE BBGFOSETTLEMENT.PARTY_CODE = P.PARTY_CODE                
     AND ISNULL(P.INSCONT,'') NOT IN ('O','S')  
     AND BBGFOSETTLEMENT.CONTRACTNO = '0000000'  
     AND NOT EXISTS (SELECT SYMBOL FROM FOSETTLEMENT T (NOLOCK)  
          WHERE T.SAUDA_DATE BETWEEN @@SAUDA_DATE AND @@SAUDA_DATE + ' 23:59'  
          AND BBGFOSETTLEMENT.PARTY_CODE = T.PARTY_CODE  
          AND BBGFOSETTLEMENT.INST_TYPE = T.INST_TYPE  
          AND BBGFOSETTLEMENT.SYMBOL = T.SYMBOL  
          AND BBGFOSETTLEMENT.EXPIRYDATE = T.EXPIRYDATE  
          AND BBGFOSETTLEMENT.STRIKE_PRICE = T.STRIKE_PRICE  
          AND BBGFOSETTLEMENT.OPTION_TYPE = T.OPTION_TYPE    
          AND T.DUMMY1 = 1  
          AND BBGFOSETTLEMENT.SYMBOL = T.SYMBOL)  
  
      
  /*CONTRACT NUMBERING STYLE - ORDER WISE*/   
  UPDATE BBGFOSETTLEMENT SET CONTRACTNO = T.CONTRACTNO FROM BBGFOSETTLEMENT B,#FOSETTLEMENT T                
  WHERE B.PARTY_CODE = T.PARTY_CODE  AND B.ORDER_NO = T.ORDER_NO                
  AND T.INSCONT = 'O'                
  AND B.CONTRACTNO = '0000000' 
    
   END      
                    
  /*GETTING THE MAX CONTRACT NUMBER*/                  
  SET @@CONTNO = 1        
  IF @@STYLE = 1                   
   BEGIN                  
       SELECT @@CONTNO=ISNULL(CONVERT(INT,CONTRACTNO),0) FROM CONTGEN  WHERE @@SAUDA_DATE BETWEEN START_DATE AND END_DATE                       
   END                  
  ELSE                  
   BEGIN                  
       SELECT @@CONTNO = ISNULL(MAX(CONVERT(INT,CONTRACTNO)),0) FROM FOSETTLEMENT WITH(NOLOCK)                  
       WHERE SAUDA_DATE BETWEEN @@SAUDA_DATE AND @@SAUDA_DATE + ' 23:59' AND CONVERT(INT,CONTRACTNO) <> 0                  
   END                  
                    
TRUNCATE TABLE FOTRD_CONTRACTNO                  
          
/*TAKING DATA TO TMP TABLE FOR UPDATING CONTRACT NUMBERING STYLE - PARTY WISE*/                  
INSERT  INTO FOTRD_CONTRACTNO                  
SELECT DISTINCT BBGFOSETTLEMENT.PARTY_CODE,'','','','',0,'',0,INSCONT        
FROM BBGFOSETTLEMENT, FOTRD_CLIENT2 CLIENT2, FOTRD_CLIENT1 CLIENT1                   
WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE             
AND ISNULL(INSCONT,'') NOT IN ('O','S')    
AND BBGFOSETTLEMENT.CONTRACTNO = '0000000'          
AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'                  
ORDER BY BBGFOSETTLEMENT.PARTY_CODE                   
            
      
/*TAKING DATA TO TMP TABLE FOR UPDATING CONTRACT NUMBERING STYLE - ORDER WISE*/                  
INSERT  INTO FOTRD_CONTRACTNO                  
SELECT DISTINCT BBGFOSETTLEMENT.PARTY_CODE,BBGFOSETTLEMENT.ORDER_NO,'','','',0,'',0,INSCONT       
FROM BBGFOSETTLEMENT, FOTRD_CLIENT2 CLIENT2, FOTRD_CLIENT1 CLIENT1                  
WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE                  
AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO'                  
AND INSCONT  =  'O'  
AND BBGFOSETTLEMENT.CONTRACTNO = '0000000'                  
ORDER BY BBGFOSETTLEMENT.PARTY_CODE,BBGFOSETTLEMENT.ORDER_NO                    
            
      
/*TAKING DATA TO TMP TABLE FOR UPDATING CONTRACT NUMBERING STYLE - SCRIP WISE*/                  
INSERT  INTO FOTRD_CONTRACTNO                  
SELECT DISTINCT BBGFOSETTLEMENT.PARTY_CODE,'',BBGFOSETTLEMENT.INST_TYPE,BBGFOSETTLEMENT.SYMBOL,BBGFOSETTLEMENT.EXPIRYDATE,      
BBGFOSETTLEMENT.STRIKE_PRICE,BBGFOSETTLEMENT.OPTION_TYPE,BBGFOSETTLEMENT.SELL_BUY,INSCONT      
FROM BBGFOSETTLEMENT, FOTRD_CLIENT2 CLIENT2, FOTRD_CLIENT1 CLIENT1                  
WHERE CONVERT(INT,CONTRACTNO) = 0  AND BBGFOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE AND INSCONT =  'S'                  
AND CLIENT1.CL_CODE = CLIENT2.CL_CODE AND CLIENT1.CL_TYPE <> 'PRO' 
AND BBGFOSETTLEMENT.CONTRACTNO = '0000000'                   
ORDER BY BBGFOSETTLEMENT.PARTY_CODE,BBGFOSETTLEMENT.INST_TYPE,BBGFOSETTLEMENT.SYMBOL,BBGFOSETTLEMENT.EXPIRYDATE,      
BBGFOSETTLEMENT.STRIKE_PRICE,BBGFOSETTLEMENT.OPTION_TYPE,BBGFOSETTLEMENT.SELL_BUY                   
            
/*CONTRACT NUMBERING STYLE - PARTY WISE*/                  
UPDATE BBGFOSETTLEMENT SET CONTRACTNO=STUFF('0000000', 8 - LEN(@@CONTNO+SNO), LEN(@@CONTNO+SNO), @@CONTNO+SNO)                  
FROM BBGFOSETTLEMENT B, FOTRD_CONTRACTNO T                  
WHERE B.PARTY_CODE = T.PARTY_CODE  
AND B.CONTRACTNO = '0000000'                 
AND ISNULL(T.INSCONT,'') NOT IN ('O','S')            
      
          
/*CONTRACT NUMBERING STYLE - ORDER WISE*/                  
UPDATE BBGFOSETTLEMENT SET CONTRACTNO=STUFF('0000000', 8 - LEN(@@CONTNO+SNO), LEN(@@CONTNO+SNO), @@CONTNO+SNO)                  
FROM BBGFOSETTLEMENT B, FOTRD_CONTRACTNO T                  
WHERE B.PARTY_CODE = T.PARTY_CODE  AND B.ORDER_NO = T.ORDER_NO                  
AND T.INSCONT = 'O'  
AND B.CONTRACTNO = '0000000'                 
      
         
/*CONTRACT NUMBERING STYLE - SCRIP WISE*/                  
UPDATE BBGFOSETTLEMENT SET CONTRACTNO=STUFF('0000000', 8 - LEN(@@CONTNO+SNO), LEN(@@CONTNO+SNO), @@CONTNO+SNO)                  
FROM BBGFOSETTLEMENT B, FOTRD_CONTRACTNO T       
WHERE B.PARTY_CODE = T.PARTY_CODE  AND B.INST_TYPE=T.INST_TYPE AND B.SYMBOL=T.SYMBOL AND                  
B.EXPIRYDATE = T.EXPIRYDATE AND B.STRIKE_PRICE=T.STRIKE_PRICE AND B.OPTION_TYPE=T.OPTION_TYPE                  
AND B.SELL_BUY = T.SELL_BUY      
AND T.INSCONT = 'S'    
AND B.CONTRACTNO = '0000000'               
          
/*GETTING LAST USED MAX CONTRACT NUMBER*/                  
SELECT @@CONTNO = @@CONTNO + ISNULL(MAX(SNO),0) FROM FOTRD_CONTRACTNO                  
            
UPDATE FOOWNER SET CONTNO = @@CONTNO                   
            
IF @@STYLE = 1                 
BEGIN                   
 UPDATE CONTGEN SET CONTRACTNO = @@CONTNO WHERE @@SAUDA_DATE BETWEEN START_DATE AND END_DATE                   
END                  
            
      
SET @@PARTYCONT = CURSOR FOR                     
 SELECT DISTINCT PARTY_CODE, OPTION_TYPE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, LEFT(SAUDA_DATE,11)          
 FROM BBGFOSETTLEMENT B WITH(NOLOCK) WHERE SAUDA_DATE BETWEEN @@SAUDA_DATE AND @@SAUDA_DATE + ' 23:59' AND AUCTIONPART <> 'CA'        
 AND PARTY_CODE IN ( SELECT S.PARTY_CODE FROM #FOSETT S      
 WHERE B.PARTY_CODE = S.PARTY_CODE      
 AND B.OPTION_TYPE = S.OPTION_TYPE      
 AND B.INST_TYPE = S.INST_TYPE      
 AND B.SYMBOL  = S.SYMBOL      
 AND B.EXPIRYDATE = S.EXPIRYDATE      
 AND B.STRIKE_PRICE = S.STRIKE_PRICE )      
 OPEN @@PARTYCONT           
FETCH NEXT FROM @@PARTYCONT INTO @PARTY_CODE, @OPTION_TYPE, @INST_TYPE, @SYMBOL, @EXPIRYDATE, @STRIKE_PRICE, @TDATE          
       
INSERT INTO FOSETTLEMENT SELECT * FROM BBGFOSETTLEMENT                  
      
WHILE @@FETCH_STATUS = 0           
BEGIN          
 EXEC FOREARRANGEAFTERCONTFLAG @PARTY_CODE, @OPTION_TYPE, @INST_TYPE, @SYMBOL, @EXPIRYDATE, @STRIKE_PRICE, @TDATE          
FETCH NEXT FROM @@PARTYCONT INTO @PARTY_CODE, @OPTION_TYPE, @INST_TYPE, @SYMBOL, @EXPIRYDATE, @STRIKE_PRICE, @TDATE          
END                    
      
CLOSE @@PARTYCONT          
DEALLOCATE @@PARTYCONT          
      
/*CLEANING TMP FILE*/                    
TRUNCATE TABLE  FOTRADE       
    
   
EXEC V2_PROCESS_STATUS_LOG_UPD @@SAUDA_DATE,'IMPTRD','',@UNAME,''    
    
      
/*--------------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOIMPTRDSELPARTY
-- --------------------------------------------------
CREATE PROC [dbo].[FOIMPTRDSELPARTY]
AS

SELECT DISTINCT FT.PARTY_CODE,FT.PARTICIPANTCODE,FT.MEMBERCODE 
FROM FOTRADE FT WHERE NOT EXISTS 
( SELECT C2.PARTY_CODE FROM CLIENT2 C2 WHERE FT.PARTY_CODE=C2.PARTY_CODE)
OR FT.PARTY_CODE IS NULL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOIMPTRDSPCHG
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.FOIMPTRDSPCHG    SCRIPT DATE: 09/10/2001 6:27:19 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOIMPTRDSPCHG    SCRIPT DATE: 09/07/2001 10:36:03 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOIMPTRDSPCHG    SCRIPT DATE: 9/7/01 5:07:19 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOIMPTRDSPCHG    SCRIPT DATE: 9/7/2001 4:10:03 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOIMPTRDSPCHG    SCRIPT DATE: 08/10/2001 4:53:39 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.FOIMPTRDSPCHG    SCRIPT DATE: 8/7/01 4:29:05 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOIMPTRDSPCHG    SCRIPT DATE: 7/25/01 10:05:57 PM ******/



/****** OBJECT:  STORED PROCEDURE DBO.FOIMPTRDSPCHG    SCRIPT DATE: 6/30/01 11:51:34 AM ******/



/****** OBJECT:  STORED PROCEDURE DBO.FOIMPTRDSPCHG    SCRIPT DATE: 5/26/01 4:17:00 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.FOIMPTRDSPCHG    SCRIPT DATE: 3/17/01 9:55:51 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOIMPTRDSPCHG    SCRIPT DATE: 3/21/01 12:50:07 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOIMPTRDSPCHG    SCRIPT DATE: 20-MAR-01 11:38:50 PM ******/


/*FINAL SQL - 07 FEB 2001 */
/*RANJEET CHOUDHARY*/
/*USED IN NSEFO SEGMENT*/

CREATE PROC  [dbo].[FOIMPTRDSPCHG] 
 (@PARTYCODE VARCHAR(7),
  @USERID INT
  )

 AS
 /*USED IN NSE FO */ 
 /*CONTROL NAME :FOIMPORTTRADE MODULE NAME :CMDPSAVE_CLICK()*/
 /*TABLE USED :WRITE ONLY FOTRADE*/
 /*FUNCTION:THIS USED TO MISSING CLIENT I.E THE CLIENTS PARTYCODE PRSERNT IN THE FOTRADE TABLE BUT NOT IN CLIENT2 TABLE*/            
 /*WRITTEN BY :RANJEET CHOUDHARY */

 UPDATE FOTRADE SET PARTY_CODE = @PARTYCODE
 WHERE USER_ID =@USERID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOMARGIN_DETAIL_UPD
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[FOMARGIN_DETAIL_UPD] 
(
	@MDATE VARCHAR(11), 
	@@SESSION_ID VARCHAR(20)
)AS

BEGIN TRAN

CREATE TABLE #FOMARGIN_DETAIL
(
	REC_TYPE INT,
	CM_ID VARCHAR(12),
	TM_ID VARCHAR(12),
	PRO_CLI CHAR(1),
	PARTY_CODE VARCHAR(10),
	INST_TYPE VARCHAR(7),
	SYMBOL VARCHAR(12),
	EXPIRYDATE VARCHAR(20),
	STRIKE_PRICE VARCHAR(20),
	OPTION_TYPE VARCHAR(2),
	INT_MARGIN VARCHAR(20),
	SPL_BUY_MARGIN VARCHAR(20),
	SPL_SELL_MARGIN VARCHAR(20),
	SPECIAL_MARGIN VARCHAR(20),
	ADD_BUY_MARGIN VARCHAR(20),
	ADD_SELL_MARGIN VARCHAR(20),
	ADDITIONAL_MARGIN VARCHAR(20),
	TENDER_MARGIN VARCHAR(20),
	DELIVERY_MARGIN VARCHAR(20),
	SPREADMARGIN_BENEFIT VARCHAR(20),
	DELIVERY_MARGIN_EXEMPTION VARCHAR(20),
	EARLY_PAYIN_BENEFIT VARCHAR(20),
	ACTUAL_MARGIN_LEVIED VARCHAR(20),
	RESERVED1 VARCHAR(20),
	RESERVED2 VARCHAR(12),
	NET_BUY_PREMIUM VARCHAR(20)
)

INSERT INTO #FOMARGIN_DETAIL
(REC_TYPE,CM_ID,TM_ID,INT_MARGIN,SPECIAL_MARGIN,ADDITIONAL_MARGIN,TENDER_MARGIN,DELIVERY_MARGIN,SPREADMARGIN_BENEFIT,
DELIVERY_MARGIN_EXEMPTION,EARLY_PAYIN_BENEFIT,ACTUAL_MARGIN_LEVIED,RESERVED1,NET_BUY_PREMIUM)
SELECT
	REC_TYPE = DBO.PIECE(FILE_DATA,',',1),
	CM_ID = DBO.PIECE(FILE_DATA,',',3),
	TM_ID = DBO.PIECE(FILE_DATA,',',4),
	INT_MARGIN = DBO.PIECE(FILE_DATA,',',7),
	SPECIAL_MARGIN = DBO.PIECE(FILE_DATA,',',8),
	ADDITIONAL_MARGIN = DBO.PIECE(FILE_DATA,',',9),
	TENDER_MARGIN = DBO.PIECE(FILE_DATA,',',10),
	DELIVERY_MARGIN = DBO.PIECE(FILE_DATA,',',11),
	SPREADMARGIN_BENEFIT = DBO.PIECE(FILE_DATA,',',12),
	DELIVERY_MARGIN_EXEMPTION = DBO.PIECE(FILE_DATA,',',13),
	EARLY_PAYIN_BENEFIT = DBO.PIECE(FILE_DATA,',',14),
	ACTUAL_MARGIN_LEVIED = DBO.PIECE(FILE_DATA,',',15),
	RESERVED1= DBO.PIECE(FILE_DATA,',',16),
	NET_BUY_PREMIUM= DBO.PIECE(FILE_DATA,',',17)
FROM CLASSFILEUPD WHERE LEFT(FILE_DATA,2) = '10' AND SESSION_ID = @@SESSION_ID

INSERT INTO #FOMARGIN_DETAIL
(REC_TYPE,TM_ID,INT_MARGIN,SPECIAL_MARGIN,ADDITIONAL_MARGIN,TENDER_MARGIN,DELIVERY_MARGIN,DELIVERY_MARGIN_EXEMPTION)
SELECT 
	REC_TYPE = DBO.PIECE(FILE_DATA,',',1),
	TM_ID = DBO.PIECE(FILE_DATA,',',2),
	INT_MARGIN = DBO.PIECE(FILE_DATA,',',3),
	SPECIAL_MARGIN = DBO.PIECE(FILE_DATA,',',4),
	ADDITIONAL_MARGIN = DBO.PIECE(FILE_DATA,',',5),
	TENDER_MARGIN = DBO.PIECE(FILE_DATA,',',6),
	DELIVERY_MARGIN = DBO.PIECE(FILE_DATA,',',7),
	DELIVERY_MARGIN_EXEMPTION = DBO.PIECE(FILE_DATA,',',8)
FROM CLASSFILEUPD WHERE LEFT(FILE_DATA,2) = '20' AND SESSION_ID = @@SESSION_ID


INSERT INTO #FOMARGIN_DETAIL
(REC_TYPE,TM_ID,PRO_CLI,PARTY_CODE,INT_MARGIN,SPECIAL_MARGIN,ADDITIONAL_MARGIN,TENDER_MARGIN,DELIVERY_MARGIN,
SPREADMARGIN_BENEFIT,DELIVERY_MARGIN_EXEMPTION,EARLY_PAYIN_BENEFIT,ACTUAL_MARGIN_LEVIED,RESERVED1,RESERVED2,NET_BUY_PREMIUM)
SELECT 
	REC_TYPE = DBO.PIECE(FILE_DATA,',',1),
	TM_ID = DBO.PIECE(FILE_DATA,',',2),
	PRO_CLI = DBO.PIECE(FILE_DATA,',',3),
	PARTY_CODE = DBO.PIECE(FILE_DATA,',',4),
	INT_MARGIN = DBO.PIECE(FILE_DATA,',',5),
	SPECIAL_MARGIN = DBO.PIECE(FILE_DATA,',',6),
	ADDITIONAL_MARGIN = DBO.PIECE(FILE_DATA,',',7),
	TENDER_MARGIN = DBO.PIECE(FILE_DATA,',',8),
	DELIVERY_MARGIN = DBO.PIECE(FILE_DATA,',',9),
	SPREADMARGIN_BENEFIT = DBO.PIECE(FILE_DATA,',',10),
	DELIVERY_MARGIN_EXEMPTION = DBO.PIECE(FILE_DATA,',',11),
	EARLY_PAYIN_BENEFIT = DBO.PIECE(FILE_DATA,',',12),
	ACTUAL_MARGIN_LEVIED = DBO.PIECE(FILE_DATA,',',13),
	RESERVED1= DBO.PIECE(FILE_DATA,',',14),
	RESERVED2= DBO.PIECE(FILE_DATA,',',15),
	NET_BUY_PREMIUM= DBO.PIECE(FILE_DATA,',',16)

FROM CLASSFILEUPD WHERE LEFT(FILE_DATA,2) = '30' AND SESSION_ID = @@SESSION_ID


DECLARE @NPOS INT
SET @NPOS = 0
IF (SELECT MEMBERTYPE FROM FOOWNER (NOLOCK)) ='CM'
BEGIN
	SET @NPOS = 2
END

INSERT INTO #FOMARGIN_DETAIL
(REC_TYPE,CM_ID,TM_ID,PRO_CLI,PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,INT_MARGIN,SPL_BUY_MARGIN,SPL_SELL_MARGIN,
ADD_BUY_MARGIN,ADD_SELL_MARGIN,TENDER_MARGIN,DELIVERY_MARGIN,DELIVERY_MARGIN_EXEMPTION,EARLY_PAYIN_BENEFIT,
RESERVED1,RESERVED2,NET_BUY_PREMIUM)
SELECT
	REC_TYPE = DBO.PIECE(FILE_DATA,',',1),
	CM_ID = DBO.PIECE(FILE_DATA,',',3),
	TM_ID = DBO.PIECE(FILE_DATA,',',4),
	PRO_CLI = DBO.PIECE(FILE_DATA,',',2 + @NPOS),
	PARTY_CODE = DBO.PIECE(FILE_DATA,',',3 + @NPOS),
	INST_TYPE = DBO.PIECE(FILE_DATA,',',4 + @NPOS),
	SYMBOL = DBO.PIECE(FILE_DATA,',',5 + @NPOS),
	EXPIRYDATE = DBO.PIECE(FILE_DATA,',',6 + @NPOS),
	STRIKE_PRICE = DBO.PIECE(FILE_DATA,',',7 + @NPOS),
	OPTION_TYPE = DBO.PIECE(FILE_DATA,',',8 + @NPOS),
	INT_MARGIN = DBO.PIECE(FILE_DATA,',',9 + @NPOS),
	SPL_BUY_MARGIN = DBO.PIECE(FILE_DATA,',',10 + @NPOS),
	SPL_SELL_MARGIN = DBO.PIECE(FILE_DATA,',',11 + @NPOS),
	ADD_BUY_MARGIN = DBO.PIECE(FILE_DATA,',',12 + @NPOS),
	ADD_SELL_MARGIN = DBO.PIECE(FILE_DATA,',',13 + @NPOS),
	TENDER_MARGIN = DBO.PIECE(FILE_DATA,',',14 + @NPOS),
	DELIVERY_MARGIN = DBO.PIECE(FILE_DATA,',',15 + @NPOS),
	DELIVERY_MARGIN_EXEMPTION = DBO.PIECE(FILE_DATA,',',16 + @NPOS),
	EARLY_PAYIN_BENEFIT = DBO.PIECE(FILE_DATA,',',17 + @NPOS),
	RESERVED1= DBO.PIECE(FILE_DATA,',',18 + @NPOS),
	RESERVED2= DBO.PIECE(FILE_DATA,',',19 + @NPOS),
	NET_BUY_PREMIUM= DBO.PIECE(FILE_DATA,',',20)

FROM CLASSFILEUPD WHERE LEFT(FILE_DATA,2) = '40' AND SESSION_ID = @@SESSION_ID

UPDATE #FOMARGIN_DETAIL  SET 
STRIKE_PRICE = CASE WHEN ISNULL(STRIKE_PRICE,'')='' THEN '0' ELSE STRIKE_PRICE END,
INT_MARGIN = CASE WHEN ISNULL(INT_MARGIN,'')='' THEN '0' ELSE INT_MARGIN END,
SPL_BUY_MARGIN = CASE WHEN ISNULL(SPL_BUY_MARGIN,'')='' THEN '0' ELSE SPL_BUY_MARGIN END,
SPL_SELL_MARGIN = CASE WHEN ISNULL(SPL_SELL_MARGIN,'')='' THEN '0' ELSE SPL_SELL_MARGIN END,
SPECIAL_MARGIN = CASE WHEN ISNULL(SPECIAL_MARGIN,'')='' THEN '0' ELSE SPECIAL_MARGIN END,
ADD_BUY_MARGIN = CASE WHEN ISNULL(ADD_BUY_MARGIN,'')='' THEN '0' ELSE ADD_BUY_MARGIN END,
ADD_SELL_MARGIN = CASE WHEN ISNULL(ADD_SELL_MARGIN,'')='' THEN '0' ELSE ADD_SELL_MARGIN END,
ADDITIONAL_MARGIN = CASE WHEN ISNULL(ADDITIONAL_MARGIN,'')='' THEN '0' ELSE ADDITIONAL_MARGIN END,
TENDER_MARGIN = CASE WHEN ISNULL(TENDER_MARGIN,'')='' THEN '0' ELSE TENDER_MARGIN END,
DELIVERY_MARGIN = CASE WHEN ISNULL(DELIVERY_MARGIN,'')='' THEN '0' ELSE DELIVERY_MARGIN END,
SPREADMARGIN_BENEFIT = CASE WHEN ISNULL(SPREADMARGIN_BENEFIT,'')='' THEN '0' ELSE SPREADMARGIN_BENEFIT END,
DELIVERY_MARGIN_EXEMPTION = CASE WHEN ISNULL(DELIVERY_MARGIN_EXEMPTION,'')='' THEN '0' ELSE DELIVERY_MARGIN_EXEMPTION END,
EARLY_PAYIN_BENEFIT = CASE WHEN ISNULL(EARLY_PAYIN_BENEFIT,'')='' THEN '0' ELSE EARLY_PAYIN_BENEFIT END,
ACTUAL_MARGIN_LEVIED = CASE WHEN ISNULL(ACTUAL_MARGIN_LEVIED,'')='' THEN '0' ELSE ACTUAL_MARGIN_LEVIED END,
RESERVED1 = CASE WHEN ISNULL(RESERVED1,'')='' THEN '0' ELSE RESERVED1 END,
NET_BUY_PREMIUM = CASE WHEN ISNULL(NET_BUY_PREMIUM,'')='' THEN '0' ELSE NET_BUY_PREMIUM END


DELETE  FROM FOMARGIN_DETAIL WHERE MDATE = @MDATE

INSERT INTO FOMARGIN_DETAIL
SELECT @MDATE,*,GETDATE() FROM #FOMARGIN_DETAIL

DROP TABLE #FOMARGIN_DETAIL

COMMIT TRAN
/*----------------------------------- END OF THE PROC -----------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOMARGIN_REPORT_STAT_UPD
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[FOMARGIN_REPORT_STAT_UPD] 
(
	@FILEDATE VARCHAR(11),
	@USERID VARCHAR(20),
	@SESSIONID VARCHAR(30),
	@MODE INT
) AS

DECLARE @SYSTEMDATE DATETIME
DECLARE @INT_COMPUTATION_ON INT

SET @SYSTEMDATE = GETDATE()

IF @MODE = 1
BEGIN

	TRUNCATE TABLE FOMARGIN_REPORT_STAT_IMP

	INSERT INTO FOMARGIN_REPORT_STAT_IMP
	SELECT 
		MARGIN_DATE =   CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',1),3),
		PARTY_CODE =   DBO.PIECE(FILE_DATA,',',2),
		SPAN_MARGIN =   DBO.PIECE(FILE_DATA,',',3),
		EXTREME_LOSS_MARGIN =   DBO.PIECE(FILE_DATA,',',4),
		NET_PREMIUM =   DBO.PIECE(FILE_DATA,',',5),
		MTM =   DBO.PIECE(FILE_DATA,',',6),
		FINALDAY_MTM =   DBO.PIECE(FILE_DATA,',',7),
		TOTAL_MARGIN =   DBO.PIECE(FILE_DATA,',',8),
		CLIENT_TYPE =   DBO.PIECE(FILE_DATA,',',9),
		MRG_UPLOADED_ON =   CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',10),3),
		REPORTED_MARGIN =   DBO.PIECE(FILE_DATA,',',11),
		SHORTAGE =   DBO.PIECE(FILE_DATA,',',12),
		PENALTY_CODE =   DBO.PIECE(FILE_DATA,',',13),
		PENALTY_AMT =   DBO.PIECE(FILE_DATA,',',14)
	FROM CLASSFILEUPD
	WHERE
		SESSION_ID= @SESSIONID
		
	IF (SELECT MEMBERTYPE FROM FOOWNER) ='CM'
	BEGIN

		
	   UPDATE FOMARGIN_REPORT_STAT_IMP SET PARTY_CODE = FOTMINFO.PARTY_CODE   
	   FROM  FOTMINFO (NOLOCK) WHERE FOTMINFO.PARTY_CODE = FOMARGIN_REPORT_STAT_IMP.PARTY_CODE  
	  
	   UPDATE FOMARGIN_REPORT_STAT_IMP SET PARTY_CODE = C2.PARTY_CODE   
	   FROM  CLIENT2 C2 (NOLOCK) WHERE C2.BANKID = FOMARGIN_REPORT_STAT_IMP.PARTY_CODE  
	   AND FOMARGIN_REPORT_STAT_IMP.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM FOTMINFO (NOLOCK))  
		
		SELECT 
				MARGIN_DATE,
				PARTY_CODE,
				SPAN_MARGIN = SUM(SPAN_MARGIN),
				EXTREME_LOSS_MARGIN = SUM(EXTREME_LOSS_MARGIN),
				NET_PREMIUM = SUM(NET_PREMIUM),
				MTM = SUM(MTM),
				FINALDAY_MTM = SUM(FINALDAY_MTM),
				TOTAL_MARGIN = SUM(TOTAL_MARGIN),
				CLIENT_TYPE,
				MRG_UPLOADED_ON = MAX(MRG_UPLOADED_ON),
				REPORTED_MARGIN = SUM(REPORTED_MARGIN),
				SHORTAGE = SUM(SHORTAGE),
				PENALTY_CODE,
				PENALTY_AMT = SUM(PENALTY_AMT)
		
		INTO #FOMARGIN_REPORT_STAT_IMP
		FROM FOMARGIN_REPORT_STAT_IMP
		GROUP BY MARGIN_DATE,PARTY_CODE,CLIENT_TYPE,PENALTY_CODE

		TRUNCATE TABLE FOMARGIN_REPORT_STAT_IMP
		INSERT INTO FOMARGIN_REPORT_STAT_IMP
		SELECT * FROM #FOMARGIN_REPORT_STAT_IMP

	END
		

	DELETE CLASSFILEUPD
	WHERE SESSION_ID= @SESSIONID
END
ELSE
BEGIN

	UPDATE FOMARGIN_REPORT_STAT_IMP SET PARTY_CODE = NEWPARTY_CODE 
	FROM PARTYMAPPING (NOLOCK)
	WHERE FOMARGIN_REPORT_STAT_IMP.PARTY_CODE = OLDPARTY_CODE 

	DELETE FOMARGIN_REPORT_STAT WHERE MARGIN_DATE = @FILEDATE

	INSERT INTO FOMARGIN_REPORT_STAT
	SELECT *, @USERID, @SYSTEMDATE
	FROM FOMARGIN_REPORT_STAT_IMP

END

/*------------------------------ END OF PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOMARGINNEW_CALC_GET
-- --------------------------------------------------



--FOMARGINNEW_CALC_GET 'DEC  2 2013'

CREATE PROC [dbo].[FOMARGINNEW_CALC_GET]     
(    
 @MARGINDATE VARCHAR(11),    
 @INTACCOPT INT = 3,    
 @INTCOLLOPT INT = 3,    
 @UNAME VARCHAR(20) ='',  
 @INTBILLOPT INT  = 2
)    
AS    
    
/*-----------------------------------------------------------------    
 FETCHING DATA TO MARGIN REPORTING FILE    
 PARAMETER     
  1. MARGIN DATE    
  2. ACCOPT 1- WITH OUT VALIDATION    
     2- WITH COLLATERAL    
     3- WITH COLLATERAL & LEDGER BALANCE    
  3. COLL OPT 1- BEFORE HAIRCUT    
       2- AFTER HAIRCUT    
       3- AFTER CASH COMPOSITION    
-------------------------------------------------------------------*/    
    
    
    
DECLARE @SDTCUR AS VARCHAR(11)    
SELECT @SDTCUR = SDTCUR FROM ACCOUNTCURBFO.DBO.PARAMETER WHERE @MARGINDATE BETWEEN SDTCUR AND LDTCUR    
    
 CREATE TABLE [#COLLATERAL]       
 (      
 [PARTYCODE] [VARCHAR] (12) ,      
 [ORIGINALCOLLATERAL] [MONEY],      
 [HAIRCUTCOLLATERAL] [MONEY],      
 [EFFCOLL] [MONEY]      
 )      
     
  
  
  

SELECT * INTO #FOMARGINNEW   
FROM FOMARGINNEW WHERE  MDATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59'     
   
INSERT INTO #COLLATERAL   
SELECT   
 PARTY_CODE= PARENTCODE,  
 SUM(ISNULL(CASH+NONCASH,0)),      
 SUM(ISNULL(ACTUALCASH+ACTUALNONCASH,0)),  
 SUM(ISNULL(CASH+NONCASH,0))  
FROM   
 MSAJAG.DBO.COLLATERAL C (NOLOCK),   
 CLIENT2_VIEW (NOLOCK)  
WHERE  
 C.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE  
 AND C.EXCHANGE = (SELECT  TOP 1 EXCHANGE FROM FOGLOBALS (NOLOCK))  
 AND SEGMENT LIKE 'FUT%'  
 AND TRANS_DATE BETWEEN @MARGINDATE  AND @MARGINDATE + ' 23:59'  
 AND EXISTS (SELECT PARTY_CODE FROM  #FOMARGINNEW F (NOLOCK)  
    WHERE F.PARTY_CODE = PARENTCODE)  
GROUP BY PARENTCODE    
  
CREATE TABLE [#CLOSEBAL]   
(  
 [PARTY_CODE] [VARCHAR] (12) ,  
 [VAMT] [MONEY]  
)  
  
IF @INTBILLOPT = 2 -- WITH OUT BILL  
BEGIN  
 INSERT INTO #CLOSEBAL  
 SELECT           
  CLTCODE,          
  SUM(VAMT) LEDBAL          
  FROM          
  (          
 SELECT           
  CLTCODE,          
  SUM( CASE WHEN DRCR ='C' THEN VAMT ELSE - VAMT END) VAMT          
 FROM          
  ACCOUNTCURBFO.DBO.LEDGER  (NOLOCK)          
 WHERE          
  VDT >=  @SDTCUR            
  AND VDT <= @MARGINDATE + ' 23:59'    
  AND VTYP <> '15'    
 GROUP BY CLTCODE          
  
 UNION           
  
 SELECT           
  CLTCODE,           
  SUM( CASE WHEN DRCR ='C' THEN VAMT ELSE - VAMT END) VAMT          
 FROM     
  ACCOUNTCURBFO.DBO.LEDGER  (NOLOCK)          
 WHERE           
  VDT >=  @SDTCUR            
  AND VDT < @MARGINDATE      
  AND VTYP='15'    
  AND VDT < (SELECT LEFT(MAX(SEC_PAYIN),11) FROM MSAJAG.DBO.SETT_MST WHERE SEC_PAYIN <= @MARGINDATE + ' 23:59')    
 GROUP BY CLTCODE    
  ) CLOSEBAL          
  GROUP BY          
  CLTCODE     
END  
ELSE  
BEGIN  
 INSERT INTO #CLOSEBAL  
 SELECT  
  CLTCODE,  
  SUM( CASE WHEN DRCR ='C' THEN VAMT ELSE - VAMT END) VAMT          
 FROM          
  ACCOUNTCURBFO.DBO.LEDGER  (NOLOCK)          
 WHERE          
  VDT >=  @SDTCUR            
  AND VDT <= @MARGINDATE + ' 23:59'    
 GROUP BY CLTCODE      
END  
    
SELECT    
MDATE= CONVERT(VARCHAR,MDATE,106),  
CLIENT_TYPE,
PARTY_CODE,
INTIAL_MARGIN,
NET_BUY_PREMIUM,
EXTREME_LOSS_MARGIN,
TOTAL_MARGIN,
 NET_MARGIN= CASE     
  WHEN @INTACCOPT = 1    
  THEN ISNULL(TOTAL_MARGIN,0)    
  ELSE CASE    
   WHEN @INTACCOPT = 2 THEN    
    CASE    
     WHEN @INTCOLLOPT = 1    
     THEN ISNULL(ORIGINALCOLLATERAL,0)    
     ELSE CASE    
      WHEN @INTCOLLOPT = 2    
      THEN ISNULL(HAIRCUTCOLLATERAL,0)    
      ELSE ISNULL(EFFCOLL,0)    
      END    
     END         
   ELSE    
    CASE    
     WHEN @INTCOLLOPT = 1    
     THEN ISNULL(ORIGINALCOLLATERAL,0) + ISNULL(LEDBAL,0)    
     ELSE CASE    
      WHEN @INTCOLLOPT = 2    
      THEN ISNULL(HAIRCUTCOLLATERAL,0) + ISNULL(LEDBAL,0)    
      ELSE ISNULL(EFFCOLL,0) + ISNULL(LEDBAL,0)    
      END    
     END     
   END    
  END    
 INTO #FOSHORTMARGIN    
 FROM    
 #FOMARGINNEW (NOLOCK)    
 LEFT OUTER JOIN    
 #COLLATERAL COLL    
 ON (PARTYCODE = PARTY_CODE)   
 LEFT OUTER JOIN    
 (  
 SELECT   
  CLTCODE = PARENTCODE,   
  LEDBAL = SUM(VAMT)  
 FROM   
  #CLOSEBAL (NOLOCK),   
  CLIENT2_VIEW (NOLOCK)  
 WHERE   
  #CLOSEBAL.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE  
 GROUP BY   
  PARENTCODE  
 ) LEDBAL    
 ON (CLTCODE = PARTY_CODE)    
    
WHERE     
 MDATE BETWEEN @MARGINDATE AND @MARGINDATE + ' 23:59'    
    
IF (SELECT MEMBERTYPE FROM FOOWNER) = 'CM'    
BEGIN    
      
 UPDATE #FOSHORTMARGIN SET PARTY_CODE = CLIENT2.BANKID      
 FROM CLIENT2 WHERE #FOSHORTMARGIN.PARTY_CODE = CLIENT2.PARTY_CODE      
 AND CLIENT2.BANKID <> ''      
    
 UPDATE #FOSHORTMARGIN SET PARTY_CODE = FOTMINFO.TM_CODE      
 FROM FOTMINFO WHERE  #FOSHORTMARGIN.PARTY_CODE = FOTMINFO.PARTY_CODE    
 AND FOTMINFO.PARTY_CODE NOT IN (SELECT BANKID FROM CLIENT2 (NOLOCK) WHERE CLIENT2.BANKID <> '')    
    
END    
  
UPDATE #FOSHORTMARGIN SET PARTY_CODE = OLDPARTY_CODE  
FROM PARTYMAPPING WHERE #FOSHORTMARGIN.PARTY_CODE = NEWPARTY_CODE  
    
EXEC V2_PROCESS_STATUS_LOG_UPD @MARGINDATE,'MRGFILE','',@UNAME,''    
  
SELECT 
	MDATE= CONVERT(VARCHAR,CONVERT(DATETIME,@MARGINDATE),3),PARTY_CODE,
	INTIAL_MARGIN = CASE WHEN INTIAL_MARGIN = 0 THEN '0.00' ELSE CONVERT(VARCHAR,INTIAL_MARGIN) END,
	NET_BUY_PREMIUM = CASE WHEN NET_BUY_PREMIUM =0 THEN '0.00' ELSE CONVERT(VARCHAR,NET_BUY_PREMIUM) END,
	EXTREME_LOSS_MARGIN = CASE WHEN EXTREME_LOSS_MARGIN =0 THEN '0.00' ELSE CONVERT(VARCHAR,EXTREME_LOSS_MARGIN) END,
	TOTAL_MARGIN = CASE WHEN TOTAL_MARGIN =0 THEN  '0.00' ELSE CONVERT(VARCHAR,TOTAL_MARGIN) END,
	CLIENT_TYPE,
	NET_MARGIN  = CASE WHEN NET_MARGIN  =0 THEN '0.00' ELSE CONVERT(VARCHAR,NET_MARGIN) END
FROM #FOSHORTMARGIN
  
DROP TABLE #FOMARGINNEW  

EXEC CLIENTMARGIN_UPD @MARGINDATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOMG13GENERATESHORTFILE
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.FOMG13GENERATESHORTFILE    SCRIPT DATE: 10/17/2002 6:31:21 PM ******/
CREATE PROC [dbo].[FOMG13GENERATESHORTFILE]
(@CLIENTTYPE AS VARCHAR(10),
 @FILEDATE AS VARCHAR(11),
 @BATCH_NO AS VARCHAR(10),
@REFNO AS INT)
AS 
IF @CLIENTTYPE='EXCHANGE'
BEGIN 
SELECT 0,FILEDATE,BATCH_NO,REFNO,EXCHSLAB,PARTY_CODE,MARGINREQUIREMENT,MARGINREPORTED,EXCHSHORT,EXCHSHORTAGEPERCENTAGE,EXCHPENALTY FROM FOMG13SHORTAGE
WHERE FILEDATE LIKE @FILEDATE+'%'
AND  BATCH_NO LIKE @BATCH_NO
AND REFNO=@REFNO
GROUP BY FILEDATE,BATCH_NO,REFNO,EXCHSLAB,PARTY_CODE,MARGINREQUIREMENT,MARGINREPORTED,EXCHSHORT,EXCHSHORTAGEPERCENTAGE,EXCHPENALTY
UNION
SELECT 1,FILEDATE,BATCH_NO,REFNO,EXCHSLAB,'SUBTOTAL',SUM(MARGINREQUIREMENT),SUM(MARGINREPORTED),SUM(EXCHSHORT),0,SUM(EXCHPENALTY) AS QTYSUM
FROM FOMG13SHORTAGE
WHERE FILEDATE LIKE @FILEDATE+'%'
AND  BATCH_NO LIKE @BATCH_NO
AND REFNO=@REFNO
GROUP BY FILEDATE,BATCH_NO,REFNO,EXCHSLAB
UNION
SELECT 2,FILEDATE,BATCH_NO,REFNO,99999,'GRANDTOTAL',SUM(MARGINREQUIREMENT),SUM(MARGINREPORTED),SUM(EXCHSHORT),0,SUM(EXCHPENALTY) AS QTYSUM
FROM FOMG13SHORTAGE
WHERE FILEDATE LIKE @FILEDATE+'%'
AND  BATCH_NO LIKE @BATCH_NO
AND REFNO=@REFNO
GROUP BY FILEDATE,BATCH_NO,REFNO
ORDER BY EXCHSLAB,1,PARTY_CODE,EXCHPENALTY
END
ELSE IF  @CLIENTTYPE='BROKER'
BEGIN 

SELECT 0,FILEDATE,BATCH_NO,REFNO,BRKSLAB,PARTY_CODE,MARGINREQUIREMENT,MARGINAVAILABLE,BRKSHORT,BRKSHORTAGEPERCENTAGE,BRKPENALTY FROM FOMG13SHORTAGE
WHERE FILEDATE LIKE @FILEDATE+'%'
AND  BATCH_NO LIKE @BATCH_NO
AND REFNO=@REFNO
GROUP BY FILEDATE,BATCH_NO,REFNO,BRKSLAB,PARTY_CODE,MARGINREQUIREMENT,MARGINAVAILABLE,BRKSHORT,BRKSHORTAGEPERCENTAGE,BRKPENALTY
UNION
SELECT 1,FILEDATE,BATCH_NO,REFNO,BRKSLAB,'SUBTOTAL',SUM(MARGINREQUIREMENT),SUM(MARGINAVAILABLE),SUM(BRKSHORT),0,SUM(BRKPENALTY) AS QTYSUM
FROM FOMG13SHORTAGE
WHERE FILEDATE LIKE @FILEDATE+'%'
AND  BATCH_NO LIKE @BATCH_NO
AND REFNO=@REFNO
GROUP BY FILEDATE,BATCH_NO,REFNO,BRKSLAB
UNION
SELECT 2,FILEDATE,BATCH_NO,REFNO,99999,'GRANDTOTAL',SUM(MARGINREQUIREMENT),SUM(MARGINAVAILABLE),SUM(BRKSHORT),0,SUM(BRKPENALTY) AS QTYSUM
FROM FOMG13SHORTAGE
WHERE FILEDATE LIKE @FILEDATE+'%'
AND  BATCH_NO LIKE @BATCH_NO
AND REFNO=@REFNO
GROUP BY FILEDATE,BATCH_NO,REFNO
ORDER BY BRKSLAB,1,PARTY_CODE,BRKPENALTY
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOMISSINGSCRIP
-- --------------------------------------------------
CREATE PROC [dbo].[FOMISSINGSCRIP] AS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOOPENPOSGENRATE
-- --------------------------------------------------
CREATE PROC [dbo].[FOOPENPOSGENRATE]   
(@SDATE VARCHAR(11)) AS   
  
SELECT PARTY_CODE,S.INST_TYPE,S.SYMBOL,EXPIRYDATE=LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11),S.STRIKE_PRICE,S.OPTION_TYPE,  
       PQTY=SUM(S.PQTY), SQTY=SUM(S.SQTY),  
       NQTY=SUM(S.PQTY)-SUM(S.SQTY),  
       NETRATE = (CASE WHEN S.INST_TYPE LIKE 'OPT%' THEN   
     ISNULL(( SELECT FOCLOSING.CL_RATE FROM FOCLOSING  
                   WHERE FOCLOSING.TRADE_DATE = (SELECT MAX(TRADE_DATE) FROM FOCLOSING  
   WHERE TRADE_DATE <=  @SDATE + ' 23:59:00')   
                 AND FOCLOSING.INST_TYPE = S.INST_TYPE  
                   AND FOCLOSING.SYMBOL=S.SYMBOL                                      
                   AND FOCLOSING.EXPIRYDATE = S.EXPIRYDATE  
                   AND FOCLOSING.STRIKE_PRICE=S.STRIKE_PRICE  
                   AND FOCLOSING.OPTION_TYPE=S.OPTION_TYPE ),0)  
  ELSE   
   ISNULL(( SELECT FOCLOSING_BILLREPORT.CL_RATE FROM FOCLOSING_BILLREPORT  
                   WHERE FOCLOSING_BILLREPORT.TRADE_DATE = (SELECT MAX(TRADE_DATE) FROM FOCLOSING_BILLREPORT  
   WHERE TRADE_DATE <=  @SDATE + ' 23:59:00')  
               AND FOCLOSING_BILLREPORT.INST_TYPE = S.INST_TYPE  
                   AND FOCLOSING_BILLREPORT.SYMBOL=S.SYMBOL                                      
                   AND FOCLOSING_BILLREPORT.EXPIRYDATE = S.EXPIRYDATE  
                   AND FOCLOSING_BILLREPORT.STRIKE_PRICE=S.STRIKE_PRICE  
                   AND FOCLOSING_BILLREPORT.OPTION_TYPE=S.OPTION_TYPE ),0)  
  END),  
SAUDA_DATE = @SDATE  
FROM FONETPOSVIEW S   
WHERE S.SAUDA_DATE <= @SDATE +' 23:59:00' 
AND S.MATURITYDATE >@SDATE+' 23:59' 
GROUP BY PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE  
ORDER BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOREARRANGEAFTERCONTFLAG
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[FOREARRANGEAFTERCONTFLAG] 

@PARTY_CODE VARCHAR(10),
@OPTION_TYPE VARCHAR(2),
@INST_TYPE VARCHAR(6),
@SYMBOL VARCHAR(12),
@EXPIRYDATE VARCHAR(11),
@STRIKE_PRICE MONEY,
@TDATE VARCHAR(11)


AS 

DECLARE 
 @@TRADE_NO VARCHAR(14),
 @@PQTY NUMERIC(9), 
 @@SQTY NUMERIC(9),
 @@LTRADE_NO VARCHAR(14),
 @@LQTY NUMERIC(9), 
 @@PDIFF NUMERIC(9),
 @@FLAG CURSOR,
 @@LOOP CURSOR,
 @@BROKSCHEME VARCHAR(3)
 
	UPDATE FOSETTLEMENT SET SETTFLAG = (CASE WHEN S.SELL_BUY = 1 THEN 2
						ELSE 3 END )
	FROM FOSETTLEMENT S,FOCURSORCONTSALE B 
	WHERE B.PARTY_CODE = S.PARTY_CODE	
	AND B.SAUDA_DATE = LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) 
        	AND B.OPTION_TYPE = B.OPTION_TYPE
	AND B.INST_TYPE = B.INST_TYPE
	AND B.SYMBOL = S.SYMBOL
	AND LEFT(CONVERT(VARCHAR,B.EXPIRYDATE,109),11) = @EXPIRYDATE
	AND B.STRIKE_PRICE = B.STRIKE_PRICE
	AND  B.SQTY <> 0 AND B.PQTY <>  0 
	AND S.PARTY_CODE = @PARTY_CODE
	AND S.OPTION_TYPE = @OPTION_TYPE
	AND S.INST_TYPE = @INST_TYPE
	AND S.SYMBOL = @SYMBOL
	AND LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11) = @EXPIRYDATE
	AND S.STRIKE_PRICE = @STRIKE_PRICE
	AND LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) = @TDATE   
	
	UPDATE FOSETTLEMENT SET SETTFLAG = 4 FROM FOSETTLEMENT S,FOCURSORCONTSALE B 
	WHERE B.PARTY_CODE = S.PARTY_CODE	
	AND B.SAUDA_DATE = LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) 
        	AND B.OPTION_TYPE = S.OPTION_TYPE
	AND B.INST_TYPE = S.INST_TYPE
	AND B.SYMBOL = S.SYMBOL
	AND LEFT(CONVERT(VARCHAR,B.EXPIRYDATE,109),11) = @EXPIRYDATE
	AND B.STRIKE_PRICE = S.STRIKE_PRICE
	AND  B.SQTY = 0 AND B.PQTY >  0 
	AND S.PARTY_CODE = @PARTY_CODE
	AND S.OPTION_TYPE = @OPTION_TYPE
	AND S.INST_TYPE = @INST_TYPE
	AND S.SYMBOL = @SYMBOL
	AND LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11) = @EXPIRYDATE
	AND S.STRIKE_PRICE = @STRIKE_PRICE
	AND LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) = @TDATE   


	UPDATE FOSETTLEMENT SET SETTFLAG = 5 FROM FOSETTLEMENT S,FOCURSORCONTSALE B 
	WHERE B.PARTY_CODE = S.PARTY_CODE	
	AND B.SAUDA_DATE = LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) 
        	AND B.OPTION_TYPE = S.OPTION_TYPE
	AND B.INST_TYPE = S.INST_TYPE
	AND B.SYMBOL = S.SYMBOL
	AND LEFT(CONVERT(VARCHAR,B.EXPIRYDATE,109),11) = @EXPIRYDATE
	AND B.STRIKE_PRICE = S.STRIKE_PRICE
	AND  B.SQTY > 0 AND B.PQTY =  0 
	AND S.PARTY_CODE = @PARTY_CODE
	AND S.OPTION_TYPE = @OPTION_TYPE
	AND S.INST_TYPE = @INST_TYPE
	AND S.SYMBOL = @SYMBOL
	AND LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11) = @EXPIRYDATE
	AND S.STRIKE_PRICE = @STRIKE_PRICE
	AND LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) = @TDATE   

SET @@FLAG = CURSOR FOR
	 SELECT PQTY,SQTY FROM FOCURSORCONTUNEQUALSALEPUR
	 WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE
	 AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
	 AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE
	 AND STRIKE_PRICE = @STRIKE_PRICE
	 AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
	 AND PQTY <> 0 AND  SQTY <> 0 AND ISNULL(PQTY,0) <> ISNULL(SQTY,0)
	 GROUP BY PQTY,SQTY
OPEN @@FLAG
FETCH NEXT FROM @@FLAG INTO @@PQTY,@@SQTY

IF @@FETCH_STATUS = 0 	
	BEGIN
		WHILE @@FETCH_STATUS = 0 
		BEGIN
			IF @@PQTY > @@SQTY 
		        	BEGIN 
				SELECT @@PDIFF = @@PQTY - @@SQTY 
				  /*FIND A TRADE WHOSE TRADEQTY = THE DIFF IN PATY AND SQTY AND UPDATE IT WITH SETFLAG = 4 */	
				SET @@LOOP  = CURSOR FOR 
					SELECT TRADE_NO,TRADEQTY FROM FOSETTLEMENT 
					WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
					AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					AND SELL_BUY = 1 AND TRADEQTY = @@PDIFF 
				 OPEN @@LOOP
				 FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
				 IF @@FETCH_STATUS = 0 
				 BEGIN 
					UPDATE FOSETTLEMENT SET SETTFLAG = 4   
					WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
					AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  

				CLOSE @@LOOP
				DEALLOCATE @@LOOP 
			  	END
			  	ELSE IF @@FETCH_STATUS <> 0  
			 	BEGIN 
					CLOSE @@LOOP
				   	DEALLOCATE @@LOOP  
				   	SET @@LOOP  = CURSOR FOR 
						SELECT TRADE_NO,TRADEQTY FROM FOSETTLEMENT 
					   	WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
		   			        	AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE 
						AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   AND SELL_BUY = 1 
						ORDER BY TRADEQTY DESC
				   	OPEN @@LOOP
				  	FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
				  	WHILE @@PDIFF > 0       
				  	BEGIN
						IF @@PDIFF >= @@LQTY 	
	                                        BEGIN
					     		UPDATE FOSETTLEMENT SET SETTFLAG = 4   
							WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
					   		AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					   		AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  

					     		SELECT @@PDIFF = @@PDIFF - @@LQTY
						END    
					        ELSE IF @@PDIFF < @@LQTY 
			    			BEGIN
							
							INSERT INTO FOSETTLEMENT SELECT CONTRACTNO,BILLNO,'B'+TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,
							OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,@@PDIFF,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,SAUDA_DATE,TABLE_NO,LINE_NO,
							VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,4,BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,OTHER_CHRG,
							SEBI_TAX,BROKER_CHRG,SERVICE_TAX,@@PDIFF*PRICE,BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE
							,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2
				    			FROM FOSETTLEMENT WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
							AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
							AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY   	
	     						
 
				     		        	UPDATE FOSETTLEMENT SET SETTFLAG = 2,TRADEQTY = @@LQTY - @@PDIFF,TRADE_AMOUNT = (@@LQTY - @@PDIFF)*PRICE    
				    		        	WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
					   		AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					   		AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY 

							SELECT @@PDIFF = 0   
						END 
			    			FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY
			   		END
		   			CLOSE @@LOOP
				END    
 			END
			ELSE IF @@PQTY < @@SQTY
			BEGIN 
				SELECT @@PDIFF = @@SQTY - @@PQTY

 				SET @@LOOP  = CURSOR FOR 
				SELECT TRADE_NO,TRADEQTY FROM FOSETTLEMENT 
        	     	        		WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
				AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
				AND SELL_BUY = 2 AND TRADEQTY = @@PDIFF 
 				
				OPEN @@LOOP
			  	 FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
			 	 IF @@FETCH_STATUS = 0 
				 BEGIN
 				 	UPDATE FOSETTLEMENT SET SETTFLAG = 5  
  				  	WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
					AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY 
			 		
					CLOSE @@LOOP
				 	DEALLOCATE @@LOOP 
			  	END
				ELSE IF @@FETCH_STATUS <> 0  
			 	BEGIN 
					CLOSE @@LOOP
				   	DEALLOCATE @@LOOP  

				   	SET @@LOOP  = CURSOR FOR 
				    	SELECT TRADE_NO,TRADEQTY FROM FOSETTLEMENT 
					WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
		   			AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					AND SELL_BUY = 2 
					ORDER BY TRADEQTY DESC

				   	OPEN @@LOOP
					FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
				  	WHILE @@PDIFF > 0       
				   	BEGIN
						IF @@PDIFF >= @@LQTY 
						BEGIN
							UPDATE FOSETTLEMENT SET SETTFLAG = 5   
						    	WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
							AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
							AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  
						     	
							SELECT @@PDIFF = @@PDIFF - @@LQTY
					   	 END    
					    	ELSE IF @@PDIFF < @@LQTY 
					    	BEGIN	
							
							INSERT INTO FOSETTLEMENT SELECT CONTRACTNO,BILLNO,'B'+TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,
							OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,@@PDIFF,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,SAUDA_DATE,TABLE_NO,LINE_NO,
							VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,5,BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,OTHER_CHRG,
							SEBI_TAX,BROKER_CHRG,SERVICE_TAX,@@PDIFF*PRICE,BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE	
							,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2
						     	FROM FOSETTLEMENT WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
							AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
							AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY   	
	     						
						     	UPDATE FOSETTLEMENT SET SETTFLAG = 3,TRADEQTY = @@LQTY - @@PDIFF,TRADE_AMOUNT = (@@LQTY - @@PDIFF)*PRICE    
				    		        	WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
					   		AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE AND LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @TDATE   
					   		AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY 

     						    	SELECT @@PDIFF = 0   
					   	 END 
					    	FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY
				   	END
 				  	CLOSE @@LOOP
				  END	
			 END 
			 FETCH NEXT FROM @@FLAG INTO @@PQTY,@@SQTY
		END 
		CLOSE @@FLAG
		DEALLOCATE @@FLAG
	END

 SELECT @@BROKSCHEME = BROK_SCHEME FROM CLIENT2  WHERE CLIENT2.PARTY_CODE = @PARTY_CODE 
SELECT @@BROKSCHEME , @TDATE,@PARTY_CODE,@INST_TYPE,@SYMBOL,@EXPIRYDATE,@STRIKE_PRICE,@OPTION_TYPE
IF @@BROKSCHEME IN ('20','21','22','23','24','25','26','27','28','29','30')
BEGIN
	EXEC FOAFTERCONSETTOFFFLAG @TDATE,@PARTY_CODE,@INST_TYPE,@SYMBOL,@EXPIRYDATE,@STRIKE_PRICE,@OPTION_TYPE
	EXEC UPBROKSETT @TDATE,@PARTY_CODE,@OPTION_TYPE,@INST_TYPE,@SYMBOL,@EXPIRYDATE,@STRIKE_PRICE
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOREARRANGEBILLFLAG
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[FOREARRANGEBILLFLAG]

(@EXPIRYDATE DATETIME) 

AS 

DECLARE  
@@EXPDATE VARCHAR(11),  
@@SELFOTRADE CURSOR,  
@@MYPKEY  INT,  
@@OPTION_TYPE VARCHAR(2),  
@@INST_TYPE VARCHAR(6),  
@@SYMBOL VARCHAR(12),  
@@STRIKE_PRICE MONEY,  
@@SECNAME VARCHAR(20),  
@@EXPIRYDATE SMALLDATETIME,  
@@MYSETTNO INT,  
@@PARTICIPANTCODE VARCHAR(15),  
@@BRANCHID VARCHAR(10),  
@@ACTIVITYTIME SMALLDATETIME,  
@@SELLBUY INT,  
@@PROCLI INT,  
@@PRICE MONEY,  
@@PARTYCODE VARCHAR(10),  
@@MEMBERCODE VARCHAR(6),  
@@TRADEQTY AS INT,  
@@GETEXPIRYDATE AS CURSOR,  
@@TEMPEXPIRYDATE AS SMALLDATETIME,  
@@TEMPSAUDADATE AS VARCHAR(11) ,
@@INSTRUMENT MONEY,
@@BOOKTYPE MONEY
  
SET @@MEMBERCODE = (SELECT LTRIM(RTRIM(ISNULL(MEMBERCODE,''))) FROM FOOWNER)  

  
SET @@GETEXPIRYDATE=CURSOR FOR SELECT DISTINCT LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11), LEFT(CONVERT(VARCHAR,MATURITYDATE,109),11) FROM FOSCRIP2 WHERE MATURITYDATE=@EXPIRYDATE --AND  INST_TYPE LIKE 'FUT%'   
OPEN @@GETEXPIRYDATE  
FETCH NEXT FROM @@GETEXPIRYDATE INTO @@TEMPEXPIRYDATE,@@TEMPSAUDADATE  
SELECT @@TEMPEXPIRYDATE,@@TEMPSAUDADATE  
  
WHILE @@FETCH_STATUS=0 AND @@TEMPEXPIRYDATE=@@TEMPEXPIRYDATE AND @@TEMPSAUDADATE=@@TEMPSAUDADATE  
  
 BEGIN  
		SET @EXPIRYDATE=''  
		SET @EXPIRYDATE=@@TEMPEXPIRYDATE  
		
		SET @@EXPDATE = (SELECT LEFT(CONVERT(VARCHAR,@EXPIRYDATE,109),11))  
		SET @@MYPKEY = 0  
		
		TRUNCATE TABLE FOSETTLEMENTEXPIRY    
		
		
		INSERT INTO FOSETTLEMENTEXPIRY 
		SELECT * FROM FOSETTLEMENT (NOLOCK) WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE  AND @@TEMPSAUDADATE +' 23:59' 
		AND EXPIRYDATE BETWEEN @@EXPDATE AND @@EXPDATE + ' 23:59'
		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))
		
		DELETE FROM FOSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE  AND @@TEMPSAUDADATE +' 23:59' 
		AND EXPIRYDATE BETWEEN @@EXPDATE AND @@EXPDATE + ' 23:59' 
		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))

		TRUNCATE TABLE FOTRADE   
		
		SELECT 
			INST_TYPE,
			SYMBOL,
			STRIKE_PRICE,
			OPTION_TYPE,
			CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, 
			CL_RATE 
		INTO
			#FOCLOSING
		FROM 
			FOCLOSING (NOLOCK) 
		WHERE 
			TRADE_DATE  BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59'
			AND EXPIRYDATE BETWEEN  @@EXPDATE AND @@EXPDATE + ' 23:59'


		CREATE TABLE #FOTRADE
		(
			[INTSRNO] [INT] IDENTITY NOT NULL  ,
			[STATUS] [VARCHAR] (3)  ,
			[INST_TYPE] [VARCHAR] (6)  ,
			[SYMBOL] [VARCHAR] (12)  ,
			[EXPIRYDATE] [SMALLDATETIME] NULL ,
			[STRIKE_PRICE] [MONEY] NULL ,
			[OPTION_TYPE] [VARCHAR] (2)  ,
			[SEC_NAME] [VARCHAR] (25)  ,
			[BOOKTYPE] [INT]   ,
			[BOOKTYPENAME] [INT]   ,
			[MARKETTYPE] [VARCHAR] (2)  ,
			[USER_ID] [INT] NULL ,
			[BRANCH_ID] [VARCHAR] (15)  ,
			[SELL_BUY] [INT] NULL ,
			[TRADEQTY] [INT] NULL ,
			[PRICE] [MONEY] NULL ,
			[PRO_CLI] [INT] NULL ,
			[PARTY_CODE] [VARCHAR] (10)  ,
			[PARTICIPANTCODE] [VARCHAR] (50)  ,
			[O_C_FLAG] [VARCHAR] (5)  ,
			[C_U_FLAG] [VARCHAR] (7)  ,
			[ACTIVITYTIME] [DATETIME] NULL ,
			[LAST_MOD_TIME] [DATETIME] NULL ,
			[ORDER_NO] [VARCHAR] (15)  ,
			[OPP_BROKER_ID] [VARCHAR] (5)  ,
			[SETTFLAG] [INT] NULL ,
			[MEMBERCODE] [VARCHAR] (10)  ,
			[TMPARTYCODE] [VARCHAR] (10)  ,
			[RESERVED1] [VARCHAR] (10)  ,
			[RESERVED2] [VARCHAR] (10)  ,
			[RESERVED3] [VARCHAR] (10)  ,
			[RESERVED4] [VARCHAR] (10)  ,
			[RESERVED5] [VARCHAR] (10) 
		)

		INSERT INTO #FOTRADE 
		(
			STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SEC_NAME,BOOKTYPE,
			BOOKTYPENAME,MARKETTYPE,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,PARTY_CODE,
			PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,OPP_BROKER_ID,SETTFLAG,
			MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5
		)
		SELECT 
			'11',E.INST_TYPE,E.SYMBOL,E.EXPIRYDATE,E.STRIKE_PRICE,E.OPTION_TYPE,E.INST_TYPE+E.SYMBOL,
			1,1,1,999,'1', 		
			SBFLAG = (CASE WHEN SUM(PQTY-SQTY) > 0 THEN 2 ELSE 1 END), 
			NETQTY= ABS(SUM(PQTY-SQTY)),  
			PRICE = CASE LEFT(E.INST_TYPE,3) WHEN 'FUT' THEN ISNULL(#FOCLOSING.CL_RATE,0) ELSE 0 END,
			PRO_CLI = (CASE WHEN LTRIM(RTRIM(PARTY_CODE))=@@MEMBERCODE THEN '2' ELSE '1' END),
			PARTY_CODE,PARTICIPANTCODE=@@MEMBERCODE,'10','COVER',@@TEMPSAUDADATE,@@TEMPSAUDADATE,
			'NIL',0,@@MEMBERCODE,BRANCHID=PARTY_CODE,0,2,'','',''	
		FROM 
		(
			SELECT S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.STRIKE_PRICE,S.OPTION_TYPE,
			SEC_NAME=LEFT(S.INST_TYPE,3)+S.SYMBOL+LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11),S.EXPIRYDATE,  
			PQTY = SUM( CASE WHEN SELL_BUY = 1 THEN S.TRADEQTY ELSE 0 END ),  
			SQTY = SUM( CASE WHEN SELL_BUY = 2 THEN S.TRADEQTY ELSE 0 END )
			FROM FOSETTLEMENT S  (NOLOCK) 
			WHERE  
			S.RESERVED1 <> '1'  AND 
			S.EXPIRYDATE BETWEEN  @@EXPDATE AND @@EXPDATE + ' 23:59'  
			AND SAUDA_DATE > 'JAN  1 1900'
			AND SAUDA_DATE <= @@TEMPSAUDADATE + ' 23:59'
			GROUP BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.STRIKE_PRICE,S.OPTION_TYPE,S.EXPIRYDATE  
		) E 
		LEFT OUTER JOIN 
		#FOCLOSING
		ON 
		(
			#FOCLOSING.INST_TYPE = E.INST_TYPE 
			AND #FOCLOSING.SYMBOL=E.SYMBOL   
			AND #FOCLOSING.STRIKE_PRICE=E.STRIKE_PRICE 
			AND #FOCLOSING.OPTION_TYPE =E.OPTION_TYPE   
			AND #FOCLOSING.EXPIRYDATE = CONVERT(VARCHAR,E.EXPIRYDATE,103)  
		),  
		FOSCRIP2 F  
		WHERE 
			E.EXPIRYDATE BETWEEN  @@EXPDATE AND @@EXPDATE +' 23:59'  
			AND E.INST_TYPE=F.INST_TYPE  
			AND E.SYMBOL=F.SYMBOL  
			AND E.EXPIRYDATE=F.EXPIRYDATE  
			AND F.MATURITYDATE BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59'
			AND E.STRIKE_PRICE = F.STRIKE_PRICE
			AND E.OPTION_TYPE = F.OPTION_TYPE
		GROUP BY PARTY_CODE,E.INST_TYPE,E.SYMBOL,E.EXPIRYDATE,E.OPTION_TYPE,E.STRIKE_PRICE,
		#FOCLOSING.CL_RATE
		HAVING SUM(PQTY - SQTY)  <> 0  	

		INSERT INTO FOTRADE
		SELECT 	
			TRADENO=9000000000 + INTSRNO,
			STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SEC_NAME,BOOKTYPE,
			BOOKTYPENAME,MARKETTYPE,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,PARTY_CODE,
			PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,
			ORDERNO=999999990000000 +INTSRNO, OPP_BROKER_ID,SETTFLAG,
			MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5
		FROM 	#FOTRADE

		DROP TABLE #FOTRADE

		UPDATE FOTRADE SET SETTFLAG = SELL_BUY + 3

		DECLARE  @@TDATE AS VARCHAR(11)
		SET @@TDATE = (SELECT LEFT(CONVERT(VARCHAR,MAX(ACTIVITYTIME)),11) FROM FOTRADE)
		DECLARE @@COUNT INT
		
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
		SELECT @@COUNT = COUNT(1) FROM FOTRADE (NOLOCK), CLIENT2 (NOLOCK)
		WHERE FOTRADE.PARTY_CODE = CLIENT2.PARTY_CODE
		AND CLIENT2.BROK_SCHEME IN ('20','21','22','23','24','25','26','27','28','29','30')  
		
		IF @@COUNT > 0
		BEGIN 
			EXEC FOTRDSETTOFFFLAG @@TDATE   
		END
		
		EXEC FOTRD_CLIENTMASTER 
		
		TRUNCATE TABLE BBGFOSETTLEMENT    
		
		INSERT INTO BBGFOSETTLEMENT SELECT '0000000',C_REGULAR_LOT,TRADE_NO, PARTY_CODE,  
		INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,USER_ID ,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,  
		AUCTIONPART=CASE LEFT(INST_TYPE,3) WHEN 'OPT' THEN 'CA' ELSE 'EA' END,MARKETTYPE,0, ORDER_NO,PRICE,  
		@@TEMPSAUDADATE,FOCONFIRMVIEW_EXPIRY.TABLE_NO,LINE_NO,VAL_PERC, NORMAL ,DAY_PUC, DAY_SALES,  
		SETT_PURCH, SETT_SALES, SELL_BUY,SETTFLAG,   
		BROKAPPLIED ,  
		NETRATE ,  
		AMOUNT,  
		INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX, BROKER_CHRG,  
		SERVICE_TAX,  
		TRADE_AMOUNT , 1 ,'0',  
		NBROKAPP = 0,  
		NSERTAX = 0,  
		0, 'F',0,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1=0,DUMMY2=PRICE,  
		RESERVED1=(CASE WHEN PARTICIPANTCODE IS NOT NULL AND (PARTICIPANTCODE  IN (F.MEMBERCODE) OR PARTICIPANTCODE = 'NCIT') THEN 0  
		WHEN PARTICIPANTCODE IS NULL THEN 0  
		ELSE 1 END),RESERVED2  
		FROM FOCONFIRMVIEW_EXPIRY,FOOWNER F  
		
		INSERT INTO BBGFOSETTLEMENT SELECT '0000000',C_REGULAR_LOT,TRADE_NO,PARTY_CODE,
		FOTRADE.INST_TYPE,FOTRADE.SYMBOL,FOTRADE.SEC_NAME,FOTRADE.EXPIRYDATE,FOTRADE.STRIKE_PRICE,
		FOTRADE.OPTION_TYPE,USER_ID,  
		PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,CASE LEFT(FOTRADE.INST_TYPE,3) WHEN 'OPT' THEN 'CA' ELSE 'EA' END,MARKETTYPE,0,
		ORDER_NO,PRICE,@@TEMPSAUDADATE,TABLE_NO=0,LINE_NO = 0,'V',  
		NORMAL=0,DAY_PUC=0,DAY_SALES=0,SETT_PURCH=0,SETT_SALES=0,SELL_BUY,SETTFLAG=0,BROKAPPLIED=0,NETRATE=PRICE,  
		AMOUNT=PRICE*TRADEQTY,  
		INS_CHRG=0,  
		TURN_TAX=0,  
		OTHER_CHRG=0,  
		SEBI_TAX=0,  
		BROKER_CHRG=0,  
		SERVICE_TAX=0,  
		TRADE_AMOUNT=PRICE*TRADEQTY,  
		1,'0',0,0,0,'F',0,PARTICIPANTCODE,STATUS,CPID='0',INSTRUMENT=1,BOOKTYPE=1,TMPARTYCODE,TMARK='0',  
		SCHEME=0,DUMMY1=0,DUMMY2=PRICE,  
		RESERVED1=(CASE WHEN PARTICIPANTCODE IS NOT NULL AND (PARTICIPANTCODE  IN
		(SELECT MEMBERCODE FROM FOOWNER) OR PARTICIPANTCODE = 'NCIT') THEN 0  
		WHEN PARTICIPANTCODE IS NULL THEN 0  
		ELSE 1 END),RESERVED2  
		FROM FOTRADE, FOSCRIP2
		WHERE 
		FOTRADE.INST_TYPE = FOSCRIP2.INST_TYPE
		AND FOTRADE.SYMBOL = FOSCRIP2.SYMBOL
		AND CONVERT(VARCHAR,FOTRADE.EXPIRYDATE,103) = CONVERT(VARCHAR,FOSCRIP2.EXPIRYDATE,103)
		AND FOTRADE.STRIKE_PRICE = FOSCRIP2.STRIKE_PRICE
		AND FOTRADE.OPTION_TYPE = FOSCRIP2.OPTION_TYPE
		AND FOTRADE.TRADE_NO NOT IN (SELECT DISTINCT TRADE_NO FROM FOCONFIRMVIEW_EXPIRY)  

                INSERT INTO FOSETTLEMENT 
				SELECT 
                CONTRACTNO,BILLNO,TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,
                OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,SERIES,
                ORDER_NO,PRICE,SAUDA_DATE,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,
                SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,AMOUNT,
                INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,
                TRADE_AMOUNT,BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,
                SETT_TYPE,CL_RATE,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,
                BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2
                FROM FOSETTLEMENTEXPIRY

		TRUNCATE TABLE FOSETTLEMENTEXPIRY    
		
		EXEC BBGDIRECTFOGENCONTRACT_EXPIRY  
		
		UPDATE BBGFOSETTLEMENT SET SETTFLAG = CASE WHEN SELL_BUY =1 THEN  4 ELSE 5 END 
		UPDATE BBGFOSETTLEMENT SET CONTRACTNO =0 WHERE INST_TYPE LIKE 'OPT%' AND AUCTIONPART ='CA'
		
		INSERT INTO FOEXPIRYBACKUP SELECT *,GETDATE() FROM FOSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE  AND @@TEMPSAUDADATE +' 23:59'
		AND EXPIRYDATE BETWEEN @@EXPDATE AND @@EXPDATE + ' 23:59'
		AND (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%' OR AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%')
		
		DELETE FROM FOSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE  AND @@TEMPSAUDADATE +' 23:59'
		AND EXPIRYDATE BETWEEN @@EXPDATE AND @@EXPDATE + ' 23:59' 
		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))		
		
		DELETE FROM FOEXPIRYSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE  AND @@TEMPSAUDADATE +' 23:59'
		AND EXPIRYDATE BETWEEN @@EXPDATE AND @@EXPDATE + ' 23:59'
		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))
		
		
		INSERT INTO FOEXPIRYSETTLEMENT 
		SELECT * FROM BBGFOSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE  AND @@TEMPSAUDADATE +' 23:59'
		AND EXPIRYDATE BETWEEN @@EXPDATE AND @@EXPDATE + ' 23:59' 
		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))
		
		INSERT INTO FOSETTLEMENT 
		SELECT * FROM BBGFOSETTLEMENT WHERE SAUDA_DATE BETWEEN @@TEMPSAUDADATE  AND @@TEMPSAUDADATE +' 23:59'
		AND EXPIRYDATE BETWEEN @@EXPDATE AND @@EXPDATE + ' 23:59'
		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))
		
		IF (SELECT ISNULL(MEMBERTYPE,'') FROM FOOWNER) = 'CM'  
		BEGIN  
        		DELETE FROM FOTMCLCHRG WHERE ORDERNO LIKE '99999999%' AND SAUDA_DATE BETWEEN @@TEMPSAUDADATE  
			AND @@TEMPSAUDADATE +' 23:59' AND DUMMY2 IN ('EA','CA')
        		
        		INSERT INTO FOTMCLCHRG SELECT PARTY_CODE,ORDER_NO,SAUDA_DATE,CLEARINGCHARGES = (BROKAPPLIED*TRADEQTY),DUMMY1='0',
        		DUMMY2=CASE LEFT(INST_TYPE,3) WHEN 'OPT' THEN 'CA' ELSE 'EA' END,TRADE_NO,SELL_BUY  
        		FROM BBGFOSETTLEMENT  
        		WHERE ORDER_NO LIKE '99999999%' AND SAUDA_DATE BETWEEN @@TEMPSAUDADATE AND @@TEMPSAUDADATE + ' 23:59'
        		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))
        		
        		UPDATE FOEXPIRYSETTLEMENT SET NBROKAPP = 0,NSERTAX = 0,BROKAPPLIED = 0,SERVICE_TAX = 0 
			WHERE EXPIRYDATE BETWEEN @@EXPDATE  AND @@EXPDATE + ' 23:59'
        		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))

        		UPDATE FOSETTLEMENT SET NBROKAPP = 0,NSERTAX = 0,BROKAPPLIED = 0,SERVICE_TAX = 0 
			WHERE EXPIRYDATE BETWEEN @@EXPDATE  AND @@EXPDATE + ' 23:59'
        		AND ((AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') OR (AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'))
		END  

       		UPDATE FOSETTLEMENT SET NBROKAPP = 0,NSERTAX = 0,BROKAPPLIED = 0,SERVICE_TAX = 0,
                INS_CHRG=0,TURN_TAX=0,OTHER_CHRG=0,SEBI_TAX=0,BROKER_CHRG=0,NETRATE = 0
                WHERE EXPIRYDATE BETWEEN @@EXPDATE  AND @@EXPDATE + ' 23:59' AND AUCTIONPART = 'CA' AND INST_TYPE LIKE 'OPT%'	

		TRUNCATE TABLE BBGFOSETTLEMENT    
		TRUNCATE TABLE FOTRADE   
		TRUNCATE TABLE FOFTTRADE
		DROP TABLE #FOCLOSING

		EXEC PR_CHARGES_DETAIL @@TEMPSAUDADATE,@@TEMPSAUDADATE,'',''
		
		FETCH NEXT FROM @@GETEXPIRYDATE INTO @@TEMPEXPIRYDATE,@@TEMPSAUDADATE  
   END         
  
CLOSE @@GETEXPIRYDATE  
DEALLOCATE @@GETEXPIRYDATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOREARRANGETRDFLAG
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[FOREARRANGETRDFLAG]  
    
AS     
 DECLARE     
 @@LTRADE_NO VARCHAR(14),    
 @@LQTY NUMERIC(9),     
 @@PDIFF NUMERIC(9),      
 @@FLAG CURSOR,    
 @@LOOP CURSOR,  
 @@TPARTY_CODE VARCHAR(20),    
 @@TINST_TYPE VARCHAR(20),     
 @@TSYMBOL VARCHAR(20),    
 @@TEXPIRYDATE DATETIME,    
 @@TSTRIKE_PRICE MONEY,    
 @@TOPTION_TYPE VARCHAR(20),  
 @@TPQTY NUMERIC(9),  
 @@TSQTY NUMERIC(9),  
 @@SAUDA_DATE VARCHAR(11)  
  
 EXEC FOTRD_CLIENTMASTER 

 SELECT TOP 1 @@SAUDA_DATE = LEFT(ACTIVITYTIME,11) FROM FOTRADE  
    
 UPDATE FOTRADE SET SETTFLAG = '1' FROM FOTRADE ,FOTRD_CLIENT2 CLIENT2   WHERE     
 CLIENT2.TRAN_CAT = 'DEL'   AND CLIENT2.PARTY_CODE = FOTRADE.PARTY_CODE   
   
 UPDATE FOTRADE SET SETTFLAG =   
  (CASE WHEN SELL_BUY=1 THEN '2' ELSE '3' END)   
 FROM FOTRD_CLIENT2 CLIENT2, FOTRADE  WHERE     
 FOTRADE.PARTY_CODE = CLIENT2.PARTY_CODE AND CLIENT2.TRAN_CAT = 'TRD'    
   
   
 SELECT S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE ,  
 PQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),0),      
 SQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),0)  
 INTO #TRADE  
 FROM FOTRADE S WITH(INDEX(PARTYCODE)) ,FOTRD_CLIENT2 C WHERE S.PARTY_CODE = C.PARTY_CODE AND C.TRAN_CAT = 'TRD'     
 GROUP BY S.PARTY_CODE, INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE    
 HAVING ( SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) = 0 AND SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0)      
 OR (SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) = 0 AND SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 )      
  
   
 UPDATE FOTRADE SET SETTFLAG = (CASE WHEN PQTY = 0 THEN 5 ELSE 4 END)      
 FROM FOTRADE T, #TRADE T1       
 WHERE T.PARTY_CODE = T1.PARTY_CODE      
 AND T.INST_TYPE = T1.INST_TYPE  
 AND T.SYMBOL = T1.SYMBOL  
 AND T.EXPIRYDATE = T1.EXPIRYDATE  
 AND T.OPTION_TYPE = T1.OPTION_TYPE  
 AND T.STRIKE_PRICE = T1.STRIKE_PRICE  
   
  
 SELECT S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE ,  
 PQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),0),      
 SQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),0)  
 INTO #TRADENEW  
 FROM FOTRADE S WITH(INDEX(PARTYCODE)) WHERE SETTFLAG IN (2,3)  
 GROUP BY S.PARTY_CODE, INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE    
  
  
   
 SET @@FLAG = CURSOR FOR   
   SELECT S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE, PQTY, SQTY  
   FROM #TRADENEW S  
   ORDER BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE  
  
 OPEN @@FLAG      
 FETCH NEXT FROM @@FLAG INTO @@TPARTY_CODE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TSTRIKE_PRICE,@@TOPTION_TYPE,@@TPQTY,@@TSQTY      
      
 WHILE ( (@@FETCH_STATUS = 0)  )      
 BEGIN      
      IF  @@TSQTY = 0      
      BEGIN      
			UPDATE FOTRADE SET SETTFLAG = 4      
			WHERE PARTY_CODE = @@TPARTY_CODE       
			AND INST_TYPE = @@TINST_TYPE  
			AND SYMBOL = @@TSYMBOL  
			AND EXPIRYDATE = @@TEXPIRYDATE  
			AND OPTION_TYPE = @@TOPTION_TYPE  
			AND STRIKE_PRICE = @@TSTRIKE_PRICE  
			AND SELL_BUY = 1       
       END      
       IF  @@TPQTY = 0      
       BEGIN      
           UPDATE FOTRADE SET SETTFLAG = 5  
           WHERE PARTY_CODE = @@TPARTY_CODE       
           AND INST_TYPE = @@TINST_TYPE  
           AND SYMBOL = @@TSYMBOL  
           AND EXPIRYDATE = @@TEXPIRYDATE  
           AND OPTION_TYPE = @@TOPTION_TYPE  
           AND STRIKE_PRICE = @@TSTRIKE_PRICE  
           AND SELL_BUY = 2  
        END      
      
         IF  ( (@@TPQTY > @@TSQTY) AND (@@TSQTY > 0 ))       
         BEGIN       
              SELECT @@PDIFF = @@TPQTY - @@TSQTY      
  
              SET @@LOOP  = CURSOR FOR       
              SELECT TRADE_NO,TRADEQTY FROM FOTRADE   
              WHERE PARTY_CODE = @@TPARTY_CODE       
              AND INST_TYPE = @@TINST_TYPE  
              AND SYMBOL = @@TSYMBOL  
              AND EXPIRYDATE = @@TEXPIRYDATE  
              AND OPTION_TYPE = @@TOPTION_TYPE  
              AND STRIKE_PRICE = @@TSTRIKE_PRICE  
              AND SELL_BUY = 1   
              ORDER BY PRICE DESC        
              OPEN @@LOOP      
  
              FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY      
              WHILE ( @@FETCH_STATUS = 0 ) AND (@@PDIFF > 0)       
              BEGIN      
                   IF @@PDIFF >= @@LQTY       
                   BEGIN      
  
						UPDATE FOTRADE SET SETTFLAG = 4         
						WHERE PARTY_CODE = @@TPARTY_CODE       
						AND INST_TYPE = @@TINST_TYPE  
						AND SYMBOL = @@TSYMBOL  
						AND EXPIRYDATE = @@TEXPIRYDATE  
						AND OPTION_TYPE = @@TOPTION_TYPE  
						AND STRIKE_PRICE = @@TSTRIKE_PRICE  
						AND SELL_BUY = 1       
						AND TRADE_NO = @@LTRADE_NO       
						AND TRADEQTY = @@LQTY       
   
                        SELECT @@PDIFF = @@PDIFF - @@LQTY      
                   END  
                   ELSE IF @@PDIFF < @@LQTY       
                   BEGIN      
						INSERT INTO FOTRADE SELECT 'T' + TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,   
						SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE, USER_ID,BRANCH_ID,SELL_BUY,@@PDIFF,PRICE,PRO_CLI,PARTY_CODE,    
						PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,4,MEMBERCODE,  
						TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5     
						FROM FOTRADE  
						WHERE PARTY_CODE = @@TPARTY_CODE       
						AND INST_TYPE = @@TINST_TYPE  
						AND SYMBOL = @@TSYMBOL  
						AND EXPIRYDATE = @@TEXPIRYDATE  
						AND OPTION_TYPE = @@TOPTION_TYPE  
						AND STRIKE_PRICE = @@TSTRIKE_PRICE  
						AND SELL_BUY = 1       
						AND TRADE_NO = @@LTRADE_NO       
						AND TRADEQTY = @@LQTY                        
  
						UPDATE FOTRADE SET SETTFLAG = 2,TRADEQTY = @@LQTY - @@PDIFF          
						WHERE PARTY_CODE = @@TPARTY_CODE       
						AND INST_TYPE = @@TINST_TYPE  
						AND SYMBOL = @@TSYMBOL  
						AND EXPIRYDATE = @@TEXPIRYDATE  
						AND OPTION_TYPE = @@TOPTION_TYPE  
						AND STRIKE_PRICE = @@TSTRIKE_PRICE  
						AND SELL_BUY = 1       
						AND TRADE_NO = @@LTRADE_NO       
						AND TRADEQTY = @@LQTY      
  
                        SELECT @@PDIFF = 0         
                  END      
                    IF @@PDIFF = 0       
                    BREAK      
                    FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY      
                 END      
                 CLOSE @@LOOP       
          END        
                
          IF  ( (@@TPQTY < @@TSQTY) AND (@@TPQTY > 0 ))       
          BEGIN       
			  SELECT @@PDIFF = @@TSQTY - @@TPQTY      
  
              SET @@LOOP  = CURSOR FOR  
              SELECT TRADE_NO,TRADEQTY FROM FOTRADE   
              WHERE PARTY_CODE = @@TPARTY_CODE       
              AND INST_TYPE = @@TINST_TYPE  
              AND SYMBOL = @@TSYMBOL  
              AND EXPIRYDATE = @@TEXPIRYDATE  
              AND OPTION_TYPE = @@TOPTION_TYPE  
              AND STRIKE_PRICE = @@TSTRIKE_PRICE  
              AND SELL_BUY = 2  
              ORDER BY PRICE DESC        
              OPEN @@LOOP      
  
              FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY      
              WHILE ( @@FETCH_STATUS = 0 ) AND (@@PDIFF > 0)       
              BEGIN      
                   IF @@PDIFF >= @@LQTY       
                   BEGIN      
  
						UPDATE FOTRADE SET SETTFLAG = 5  
						WHERE PARTY_CODE = @@TPARTY_CODE       
						AND INST_TYPE = @@TINST_TYPE  
						AND SYMBOL = @@TSYMBOL  
						AND EXPIRYDATE = @@TEXPIRYDATE  
						AND OPTION_TYPE = @@TOPTION_TYPE  
						AND STRIKE_PRICE = @@TSTRIKE_PRICE  
						AND SELL_BUY = 2  
						AND TRADE_NO = @@LTRADE_NO       
						AND TRADEQTY = @@LQTY        

                        SELECT @@PDIFF = @@PDIFF - @@LQTY      
                   END          
                   ELSE IF @@PDIFF < @@LQTY       
                   BEGIN      
  
						INSERT INTO FOTRADE SELECT 'T' + TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,   
						SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE, USER_ID,BRANCH_ID,SELL_BUY,@@PDIFF,PRICE,PRO_CLI,PARTY_CODE,    
						PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,5,MEMBERCODE,  
						TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5     
						FROM FOTRADE  
						WHERE PARTY_CODE = @@TPARTY_CODE       
						AND INST_TYPE = @@TINST_TYPE  
						AND SYMBOL = @@TSYMBOL  
						AND EXPIRYDATE = @@TEXPIRYDATE  
						AND OPTION_TYPE = @@TOPTION_TYPE  
						AND STRIKE_PRICE = @@TSTRIKE_PRICE  
						AND SELL_BUY = 2       
						AND TRADE_NO = @@LTRADE_NO       
						AND TRADEQTY = @@LQTY                        
  
						UPDATE FOTRADE SET SETTFLAG = 3,TRADEQTY = @@LQTY - @@PDIFF          
						WHERE PARTY_CODE = @@TPARTY_CODE       
						AND INST_TYPE = @@TINST_TYPE  
						AND SYMBOL = @@TSYMBOL  
						AND EXPIRYDATE = @@TEXPIRYDATE  
						AND OPTION_TYPE = @@TOPTION_TYPE  
						AND STRIKE_PRICE = @@TSTRIKE_PRICE  
						AND SELL_BUY = 2  
						AND TRADE_NO = @@LTRADE_NO       
						AND TRADEQTY = @@LQTY      
  
                        SELECT @@PDIFF = 0         
                    END      
                    IF @@PDIFF = 0       
                    BREAK      
                    FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY      
               END      
               CLOSE @@LOOP        
  
            END      
  FETCH NEXT FROM @@FLAG INTO @@TPARTY_CODE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TSTRIKE_PRICE,@@TOPTION_TYPE,@@TPQTY,@@TSQTY      
END      
CLOSE @@FLAG      
DEALLOCATE @@FLAG  

EXEC FOTRD_CLIENTMASTER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOSCRIPWISEBROKERAGE
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[FOSCRIPWISEBROKERAGE]       
(       
 @SAUDA_DATE VARCHAR(11),        
 @FROMPARTY VARCHAR(10),        
 @TOPARTY VARCHAR(10),            
@INST_TYPE       VARCHAR(6)='%',            
@SYMBOL          VARCHAR(12)='%',            
@EXPIRY_DATE     VARCHAR(11)='%',            
@STRIKE_PRICE    MONEY     = 0 ,        
@OPTION_TYPE     VARCHAR(2)  ='%' ,        
@CONTRACTNO      VARCHAR(7) ='%'        
)      
AS        
      
 SELECT        
  ROUND_TO,ROFIG,ERRNUM,NOZERO,PARTY_CODE       
 INTO #FOCLIENTTAXES       
 FROM FOCLIENTTAXES (NOLOCK)      
 WHERE       
  @SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO      
  AND PARTY_CODE >= @FROMPARTY          
  AND PARTY_CODE <= @TOPARTY          
      
 SELECT PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,PQTY=SUM(PQTY),SQTY=SUM(SQTY),PRATE=SUM(PRATE),SRATE=SUM(SRATE),      
 OPTION_TYPE,STRIKE_PRICE        
 INTO #FOSETT1      
 FROM         
         (        
         SELECT T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.SEC_NAME,T1.EXPIRYDATE,T1.SELL_BUY,        
         PQTY = (CASE WHEN SELL_BUY = 1 THEN SUM(TRADEQTY) ELSE 0 END ),        
         SQTY = (CASE WHEN SELL_BUY = 2 THEN SUM(TRADEQTY) ELSE 0 END ),        
    PRATE = (CASE WHEN ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),0) > 0           
           THEN ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE ELSE 0 END),0) /           
                ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),0)          
           ELSE 0           
      END),          
    SRATE = (CASE WHEN ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),0) > 0           
           THEN ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE ELSE 0 END),0) /           
                       ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),0)          
                  ELSE 0           
             END),      
         OPTION_TYPE,STRIKE_PRICE        
         FROM FOSETTLEMENT T1  (NOLOCK)      
         WHERE T1.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'        
         AND T1.PARTY_CODE >= @FROMPARTY          
         AND T1.PARTY_CODE <= @TOPARTY          
         AND T1.STATUS <>  'E'
         AND TRADEQTY > 0
		 AND T1.CONTRACTNO = CASE WHEN @CONTRACTNO ='%' THEN T1.CONTRACTNO ELSE @CONTRACTNO END        
		 AND T1.INST_TYPE = CASE WHEN @INST_TYPE ='%' THEN T1.INST_TYPE ELSE @INST_TYPE END            
		 AND T1.SYMBOL = CASE WHEN @SYMBOL ='%' THEN T1.SYMBOL ELSE @SYMBOL  END             
		 AND T1.EXPIRYDATE LIKE @EXPIRY_DATE + '%'            
		 AND T1.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN T1.STRIKE_PRICE ELSE @STRIKE_PRICE END)            
		 AND T1.OPTION_TYPE = CASE WHEN @OPTION_TYPE ='%' THEN T1.OPTION_TYPE ELSE @OPTION_TYPE END                    
         GROUP BY T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.SEC_NAME,T1.EXPIRYDATE,T1.SELL_BUY,        
         OPTION_TYPE,STRIKE_PRICE        
 )        
 FOSETTSALE        
 GROUP BY PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE        
       
 SELECT       
  CONTRACTNO,BILLNO,TRADE_NO,FF.PARTY_CODE,FF.INST_TYPE,FF.SYMBOL,FF.SEC_NAME,FF.EXPIRYDATE,FF.STRIKE_PRICE,        
         FF.OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,FF.SERIES,ORDER_NO,PRICE,        
         SAUDA_DATE,FF.TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,        
         BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,FF.OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,        
         BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,        
         MPRICE = (CASE WHEN C2.DUMMY1 = 0         
                 THEN PRICE         
                 ELSE        
              (CASE WHEN C2.DUMMY1 = 1         
             THEN (CASE WHEN FF.STRIKE_PRICE = 0 THEN FF.PRICE ELSE FF.STRIKE_PRICE END )        
 ELSE FF.STRIKE_PRICE + PRICE          
               END)        
            END) ,         
         MULTIPLIER = ( CASE WHEN ( C2.BROK_SCHEME = 4 OR C2.BROK_SCHEME = 5 )         
           THEN (CEILING(CONVERT(NUMERIC(19,2),TRADEQTY) / CONVERT(NUMERIC(19,2),C_REGULAR_LOT))/        
                         (CASE WHEN TRADEQTY = 0 THEN 1 ELSE TRADEQTY END))        
           ELSE  1        
                END),        
         TAXPRICE = (CASE WHEN TAXESFLAG = 0         
                 THEN PRICE         
                 ELSE        
              (CASE WHEN TAXESFLAG = 1         
             THEN (CASE WHEN FF.STRIKE_PRICE = 0 THEN FF.PRICE ELSE FF.STRIKE_PRICE END )        
                           ELSE FF.STRIKE_PRICE + PRICE        
               END)        
            END) ,        
         FF.RESERVED1,FF.DUMMY1,STATUS        
 INTO #FOSETT2      
 FROM        
   FOSETTLEMENT FF  (NOLOCK), CLIENT2 C2  (NOLOCK), FOSCRIP2 S2  (NOLOCK),FOOWNER  (NOLOCK)        
 WHERE C2.PARTY_CODE = FF.PARTY_CODE         
         AND FF.INST_TYPE = S2.INST_TYPE         
         AND FF.SYMBOL = S2.SYMBOL              
         AND FF.EXPIRYDATE = S2.EXPIRYDATE        
         AND FF.OPTION_TYPE = S2.OPTION_TYPE         
         AND FF.STRIKE_PRICE = S2.STRIKE_PRICE        
         AND FF.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'            
         AND FF.PARTY_CODE >= @FROMPARTY          
         AND FF.PARTY_CODE <= @TOPARTY 
	 AND FF.CONTRACTNO = CASE WHEN @CONTRACTNO ='%' THEN FF.CONTRACTNO ELSE @CONTRACTNO END        
	 AND FF.INST_TYPE = CASE WHEN @INST_TYPE ='%' THEN FF.INST_TYPE ELSE @INST_TYPE END            
	 AND FF.SYMBOL = CASE WHEN @SYMBOL ='%' THEN FF.SYMBOL ELSE @SYMBOL  END             
	 AND FF.EXPIRYDATE LIKE @EXPIRY_DATE + '%'            
	 AND FF.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN FF.STRIKE_PRICE ELSE @STRIKE_PRICE END)            
	 AND FF.OPTION_TYPE = CASE WHEN @OPTION_TYPE ='%' THEN FF.OPTION_TYPE ELSE @OPTION_TYPE END                     
         AND FF.STATUS <>  'E'          
      AND TRADEQTY > 0
        
 UPDATE FOSETTLEMENT SET           
        TABLE_NO = BROKTABLE.TABLE_NO,LINE_NO = BROKTABLE.LINE_NO,          
        VAL_PERC = BROKTABLE.VAL_PERC,NORMAL = BROKTABLE.NORMAL,DAY_PUC = BROKTABLE.DAY_PUC,DAY_SALES = BROKTABLE.DAY_SALES,          
        SETT_PURCH = BROKTABLE.SETT_PURCH, SETT_SALES = BROKTABLE.SETT_SALES,          
             
 BROKAPPLIED =       
  (  CASE            
    WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)          
                            THEN           
    ((FLOOR(( BROKTABLE.NORMAL*F.MULTIPLIER * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /            
    (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  /           
    POWER(10,#FOCLIENTTAXES.ROUND_TO))          
                       WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)          
                            THEN           
    ((FLOOR(( BROKTABLE.NORMAL*F.MULTIPLIER * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /            
    (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  /           
    POWER(10,#FOCLIENTTAXES.ROUND_TO))          
                       WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)          
                             THEN            
    ((FLOOR ( (((BROKTABLE.NORMAL*F.MULTIPLIER /100 ) * F.MPRICE)  * POWER(10,#FOCLIENTTAXES.ROUND_TO) + #FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /         
    (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  / POWER(10,#FOCLIENTTAXES.ROUND_TO))          
     WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)          
                           THEN           
    ((FLOOR(( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /            
    (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  /           
    POWER(10,#FOCLIENTTAXES.ROUND_TO))          
                    WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )           
                          THEN           
    ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER))  * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /            
    (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  /           
    POWER(10,#FOCLIENTTAXES.ROUND_TO))          
                    WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' )           
                           THEN           
    ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /            
    (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  /           
    POWER(10,#FOCLIENTTAXES.ROUND_TO))          
                 WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )          
                           THEN           
    ((FLOOR(( BROKTABLE.DAY_SALES*F.MULTIPLIER * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /            
   (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  /           
    POWER(10,#FOCLIENTTAXES.ROUND_TO))          
                WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )          
    THEN         
    ((FLOOR(( ((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /            
    (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  /           
    POWER(10,#FOCLIENTTAXES.ROUND_TO))          
              WHEN ( FOSETTLEMENT.SETTFLAG IN (4,6,8)  AND BROKTABLE.VAL_PERC ='V' )          
                           THEN           
    ((FLOOR(( BROKTABLE.SETT_PURCH*F.MULTIPLIER * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /            
    (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  /           
    POWER(10,#FOCLIENTTAXES.ROUND_TO))          
         WHEN ( FOSETTLEMENT.SETTFLAG IN (4,6,8)  AND BROKTABLE.VAL_PERC ='P' )          
             THEN           
    ((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /            
    (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  /           
    POWER(10,#FOCLIENTTAXES.ROUND_TO))          
           WHEN ( FOSETTLEMENT.SETTFLAG IN (5,7,9) AND BROKTABLE.VAL_PERC ='V' )          
                  THEN           
    ((FLOOR(( BROKTABLE.SETT_SALES*F.MULTIPLIER * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /            
    (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  /           
    POWER(10,#FOCLIENTTAXES.ROUND_TO))          
                       WHEN ( FOSETTLEMENT.SETTFLAG IN (5,7,9)  AND BROKTABLE.VAL_PERC ='P' )          
                           THEN           
    ((FLOOR(( ((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /            
    (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  /           
    POWER(10,#FOCLIENTTAXES.ROUND_TO))          
    ELSE  0          
    END   ),         
 NETRATE =       
  (  CASE            
         WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)          
              THEN           
         (FOSETTLEMENT.PRICE) + ((FLOOR((  (( BROKTABLE.NORMAL*F.MULTIPLIER)) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /(#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) *         
      (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  / POWER(10,#FOCLIENTTAXES.ROUND_TO))          
      WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)          
                 THEN           
                            (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.NORMAL*F.MULTIPLIER )) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /         
      (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  /  POWER(10,#FOCLIENTTAXES.ROUND_TO))          
      WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)          
                  THEN           
                       (FOSETTLEMENT.PRICE)+ ((FLOOR(( (((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE)) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /        
      (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  / POWER(10,#FOCLIENTTAXES.ROUND_TO))          
      WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)          
               THEN           
                             (FOSETTLEMENT.PRICE) -  ((FLOOR((  ( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /         
      (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  / POWER(10,#FOCLIENTTAXES.ROUND_TO))          
      WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )           
              THEN           
                   (FOSETTLEMENT.PRICE) + ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER  )) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /          
      (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  / POWER(10,#FOCLIENTTAXES.ROUND_TO))          
      WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' )           
              THEN           
                   (FOSETTLEMENT.PRICE) + ((FLOOR(( (((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /         
      (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  / POWER(10,#FOCLIENTTAXES.ROUND_TO))          
      WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )          
               THEN           
                   (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.DAY_SALES*F.MULTIPLIER)) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /          
      (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  / POWER(10,#FOCLIENTTAXES.ROUND_TO))          
      WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )          
              THEN           
                  (FOSETTLEMENT.PRICE) - ((FLOOR((  (((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /          
      (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  / POWER(10,#FOCLIENTTAXES.ROUND_TO))          
    WHEN ( FOSETTLEMENT.SETTFLAG IN (4,6,8)  AND BROKTABLE.VAL_PERC ='V' )          
               THEN           
                          (FOSETTLEMENT.PRICE) + ((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER  )) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /         
      (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  / POWER(10,#FOCLIENTTAXES.ROUND_TO))          
      WHEN ( FOSETTLEMENT.SETTFLAG IN (4,6,8)  AND BROKTABLE.VAL_PERC ='P' )          
                THEN           
                     (FOSETTLEMENT.PRICE) + ((FLOOR(( ( (( BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /          
      (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  / POWER(10,#FOCLIENTTAXES.ROUND_TO))          
      WHEN ( FOSETTLEMENT.SETTFLAG IN (5,7,9) AND BROKTABLE.VAL_PERC ='V' )          
                THEN           
                   (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /         
      (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  / POWER(10,#FOCLIENTTAXES.ROUND_TO))          
      WHEN ( FOSETTLEMENT.SETTFLAG IN (5,7,9) AND BROKTABLE.VAL_PERC ='P' )          
               THEN           
                   (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /          
      (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) )  /  POWER(10,#FOCLIENTTAXES.ROUND_TO))          
         ELSE  0           
               END           
                ),          
       
 SERVICE_TAX =  (CASE            
         WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V')          
              THEN           
                  ((FLOOR((           
                         (((((FLOOR((( BROKTABLE.NORMAL*F.MULTIPLIER)  * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) / (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) /

  
    
          
                                       POWER(10,#FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /          
                                       (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) / POWER(10,#FOCLIENTTAXES.ROUND_TO))              
         WHEN (FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P')          
              THEN           
                       ((FLOOR((           
                                    (((((FLOOR((   ((BROKTABLE.NORMAL*F.MULTIPLIER /100 ) * F.MPRICE) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /        
                      (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) /          
                                           POWER(10,#FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /          
                                           (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) / POWER(10,#FOCLIENTTAXES.ROUND_TO))          
         WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )           
              THEN            
                        ((FLOOR((           
                                     (((((FLOOR(( (BROKTABLE.DAY_PUC*F.MULTIPLIER) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) / (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES

  
    
.NOZERO) ) /          
                                             POWER(10,#FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /          
                  (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) / POWER(10,#FOCLIENTTAXES.ROUND_TO))              
         WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' )           
              THEN           
                        ((FLOOR((           
                                     (((((FLOOR((( (BROKTABLE.DAY_PUC*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /         
                       (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) /          
                                             POWER(10,#FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /          
                                              (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) / POWER(10,#FOCLIENTTAXES.ROUND_TO))              
         WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )          
              THEN           
                        ((FLOOR((           
                                     (((((FLOOR((( BROKTABLE.DAY_SALES*F.MULTIPLIER ) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) / (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) /          
                                             POWER(10,#FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /          
                                              (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) / POWER(10,#FOCLIENTTAXES.ROUND_TO))              
         WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )          
              THEN           
                        ((FLOOR((           
                                     (((((FLOOR((( (BROKTABLE.DAY_SALES*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /                            (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) /                                        
                                         POWER(10,#FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100) 
                                       *   POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /          
                                              (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) / POWER(10,#FOCLIENTTAXES.ROUND_TO))              
         WHEN ( FOSETTLEMENT.SETTFLAG IN (4,6,8)  AND BROKTABLE.VAL_PERC ='V' )          
              THEN            
                        ((FLOOR((           
                                     (((((FLOOR((( BROKTABLE.SETT_PURCH*F.MULTIPLIER)  * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) / (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) /          
                                             POWER(10,#FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /                              

  
                      (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) / POWER(10,#FOCLIENTTAXES.ROUND_TO))              
                               WHEN ( FOSETTLEMENT.SETTFLAG IN (4,6,8)  AND BROKTABLE.VAL_PERC ='P' )          
              THEN           
                        ((FLOOR((           
                                     (((((FLOOR((( (BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) / (#FOCLIENTTAXES.ROFIG +                            #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) /     
                                                                                   POWER(10,#FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /          
                                              (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) / POWER(10,#FOCLIENTTAXES.ROUND_TO))         
         
         WHEN ( FOSETTLEMENT.SETTFLAG IN (5,7,9) AND BROKTABLE.VAL_PERC ='V' )          
              THEN             
                        ((FLOOR((           
                                   (((((FLOOR((( BROKTABLE.SETT_SALES*F.MULTIPLIER)  * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) / (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) *                                 
                                     (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) /          
                        POWER(10,#FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /          
                       (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) / POWER(10,#FOCLIENTTAXES.ROUND_TO))              
           WHEN ( FOSETTLEMENT.SETTFLAG IN (5,7,9) AND BROKTABLE.VAL_PERC ='P' )          
             THEN            
            ((FLOOR((           
                (((((FLOOR((( (BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) / (#FOCLIENTTAXES.ROFIG +         
                  #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) /          
                        POWER(10,#FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,#FOCLIENTTAXES.ROUND_TO)+#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.ERRNUM ) /          
                        (#FOCLIENTTAXES.ROFIG + #FOCLIENTTAXES.NOZERO)) * (#FOCLIENTTAXES.ROFIG +#FOCLIENTTAXES.NOZERO) ) / POWER(10,#FOCLIENTTAXES.ROUND_TO))              
      ELSE  0           
        END  ) ,          
 TRADE_AMOUNT = FOSETTLEMENT.TRADEQTY * FOSETTLEMENT.PRICE          
 FROM       
  BROKTABLE (NOLOCK),       
  FOSETTLEMENT WITH(ROWLOCK) ,      
  FOTAXES (NOLOCK) ,      
  CLIENT1 (NOLOCK) ,      
  CLIENT2 (NOLOCK) ,      
  FOGLOBALS (NOLOCK) ,        
         #FOSETT1 S (NOLOCK) ,        
  #FOSETT2 F (NOLOCK) ,       
  FOSCRIPBROKERAGE B (NOLOCK) ,      
  #FOCLIENTTAXES (NOLOCK)      
 WHERE       
   #FOCLIENTTAXES.PARTY_CODE = FOSETTLEMENT.PARTY_CODE AND       
   FOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE AND        
   CLIENT1.CL_CODE=CLIENT2.CL_CODE AND      
   FOSETTLEMENT.PARTY_CODE = S.PARTY_CODE AND          
   FOSETTLEMENT.INST_TYPE=S.INST_TYPE AND            
   FOSETTLEMENT.SYMBOL=S.SYMBOL AND          
   FOSETTLEMENT.EXPIRYDATE=S.EXPIRYDATE  AND          
   FOSETTLEMENT.STRIKE_PRICE = S.STRIKE_PRICE AND            
   FOSETTLEMENT.OPTION_TYPE = S.OPTION_TYPE         
   AND FOSETTLEMENT.INST_TYPE = B.INST_TYPE   
   AND FOSETTLEMENT.PARTY_CODE = B.PARTY_CODE          
   AND FOSETTLEMENT.SYMBOL = B.SYMBOL          
   AND FOSETTLEMENT.INST_TYPE = B.INST_TYPE          
   AND BROKTABLE.TABLE_NO = B.TABLE_NO          
   AND FOSETTLEMENT.SAUDA_DATE BETWEEN B.FROM_DATE AND B.TO_DATE  AND        
   FOSETTLEMENT.PARTY_CODE = F.PARTY_CODE AND          
   FOSETTLEMENT.INST_TYPE=F.INST_TYPE AND            
   FOSETTLEMENT.SYMBOL=F.SYMBOL AND          
   FOSETTLEMENT.EXPIRYDATE=F.EXPIRYDATE  AND          
   FOSETTLEMENT.STRIKE_PRICE = F.STRIKE_PRICE AND                          
   FOSETTLEMENT.OPTION_TYPE = F.OPTION_TYPE AND                            
   FOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE AND          
   FOSETTLEMENT.TRADE_NO = F.TRADE_NO AND           
   FOSETTLEMENT.ORDER_NO = F.ORDER_NO AND          
   FOSETTLEMENT.SELL_BUY = F.SELL_BUY AND           
   FOSETTLEMENT.SAUDA_DATE  BETWEEN YEAR_START_DT AND YEAR_END_DT AND          
   BROKTABLE.LINE_NO =  ( CASE WHEN (B.BROK_SCHEME = 1 OR B.BROK_SCHEME = 5 OR B.BROK_SCHEME = 22) THEN               
                  (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE          
                         BROKTABLE.TABLE_NO = B.TABLE_NO               
                        AND TRD_DEL = ( CASE WHEN S.PQTY >= S.SQTY           
              THEN ( CASE WHEN ( FOSETTLEMENT.SELL_BUY = 1 )           
                     THEN 'F'            
                     ELSE 'S'          
                  END )          
                 ELSE          
                 ( CASE WHEN ( FOSETTLEMENT.SELL_BUY = 2 )           
                     THEN 'F'            
                     ELSE 'S'          
                  END )               
              END )          
                AND FOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE              
                AND F.MPRICE <= BROKTABLE.UPPER_LIM)                     
                WHEN (B.BROK_SCHEME = 3 OR B.BROK_SCHEME = 6 OR B.BROK_SCHEME = 23 ) THEN               
                  (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE          
                   BROKTABLE.TABLE_NO = B.TABLE_NO                                  
                   AND TRD_DEL = ( CASE WHEN S.PQTY > S.SQTY           
            THEN ( CASE WHEN ( FOSETTLEMENT.SELL_BUY = 1 )           
                     THEN 'F'            
     ELSE 'S'          
                  END )          
                 ELSE          
                 ( CASE WHEN ( FOSETTLEMENT.SELL_BUY = 2 )           
                     THEN 'F'            
                     ELSE 'S'          
                  END )               
              END )         
        AND FOSETTLEMENT.PARTY_CODE =  CLIENT2.PARTY_CODE              
        AND F.MPRICE <= BROKTABLE.UPPER_LIM)       
 WHEN (B.BROK_SCHEME = 2 ) THEN               
                  (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE          
                   BROKTABLE.TABLE_NO = B.TABLE_NO                                  
                   AND TRD_DEL = (CASE WHEN S.PQTY = S.SQTY       
           THEN (CASE WHEN S.PRATE >= S.SRATE       
        THEN (CASE WHEN ( FOSETTLEMENT.SELL_BUY = 1 )           
                                 THEN 'F'            
                              ELSE 'S'          
                                   END)          
                             ELSE (CASE WHEN ( FOSETTLEMENT.SELL_BUY = 2 )           
                                     THEN 'F'            
                                     ELSE 'S'          
                                    END)           
          END)      
           ELSE (CASE WHEN S.PQTY > S.SQTY           
                      THEN (CASE WHEN ( FOSETTLEMENT.SELL_BUY = 1 )           
                                 THEN 'F'            
                              ELSE 'S'          
                                   END)          
                             ELSE (CASE WHEN ( FOSETTLEMENT.SELL_BUY = 2 )           
                                     THEN 'F'            
                                     ELSE 'S'          
                                    END)               
                       END)         
      END)      
        AND FOSETTLEMENT.PARTY_CODE =  CLIENT2.PARTY_CODE              
        AND F.MPRICE <= BROKTABLE.UPPER_LIM)           
         ELSE           
                                        (  SELECT MIN(LINE_NO) FROM BROKTABLE           
                                           WHERE F.MPRICE <= BROKTABLE.UPPER_LIM           
                      AND BROKTABLE.TABLE_NO = B.TABLE_NO /*AND LINE_NO = 0*/ )          
        END )          
  AND FOTAXES.TRANS_CAT = (CASE WHEN CL_TYPE = 'PRO' THEN 'PRO' ELSE CLIENT2.TRAN_CAT END )          
  AND FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'            
  AND FOSETTLEMENT.PARTY_CODE >= @FROMPARTY          
  AND FOSETTLEMENT.PARTY_CODE <= @TOPARTY
 AND FOSETTLEMENT.CONTRACTNO = CASE WHEN @CONTRACTNO ='%' THEN FOSETTLEMENT.CONTRACTNO ELSE @CONTRACTNO END        
 AND FOSETTLEMENT.INST_TYPE = CASE WHEN @INST_TYPE ='%' THEN FOSETTLEMENT.INST_TYPE ELSE @INST_TYPE END            
 AND FOSETTLEMENT.SYMBOL = CASE WHEN @SYMBOL ='%' THEN FOSETTLEMENT.SYMBOL ELSE @SYMBOL  END             
 AND FOSETTLEMENT.EXPIRYDATE LIKE @EXPIRY_DATE + '%'            
 AND FOSETTLEMENT.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN FOSETTLEMENT.STRIKE_PRICE ELSE @STRIKE_PRICE END)            
 AND FOSETTLEMENT.OPTION_TYPE = CASE WHEN @OPTION_TYPE ='%' THEN FOSETTLEMENT.OPTION_TYPE ELSE @OPTION_TYPE END                      
  AND FOSETTLEMENT.STATUS <>  'E' 
  AND TRADEQTY > 0         
  AND LEFT(FOSETTLEMENT.INST_TYPE,3) = FOTAXES.INST_TYPE        
  AND FOSETTLEMENT.SAUDA_DATE BETWEEN FOTAXES.FROM_DATE AND FOTAXES.TO_DATE        
  AND FOSETTLEMENT.SAUDA_DATE BETWEEN FOGLOBALS.YEAR_START_DT AND FOGLOBALS.YEAR_END_DT        
      
DROP TABLE #FOCLIENTTAXES      
DROP TABLE #FOSETT1      
DROP TABLE #FOSETT2

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOSETTBROKEDITUP
-- --------------------------------------------------
CREATE   PROCEDURE [dbo].[FOSETTBROKEDITUP]
(
	@OPTION_TYPE VARCHAR(2),
	@INST_TYPE VARCHAR(6),
	@SYMBOL VARCHAR(12),
	@SAUDA_DATE VARCHAR(11),
	@STRIKE_PRICE NUMERIC(9),
	@PARTY_CODE VARCHAR(10),
	@TRADE_NO VARCHAR(14),
	@ORDER_NO VARCHAR(20),
	@CONTRACTNO VARCHAR(14) ,
	@PRICE NUMERIC(36, 12),
	@BROK NUMERIC(36, 12),
	@VAL_PERC VARCHAR(1),
	@SELL_BUY INT,
	@NETRATE NUMERIC(36, 12), 
	@EXPIRYDATE VARCHAR(11),
	@FLAG INT ,
	@STATUSID VARCHAR(50) ='BROKER',
	@STRMODULE VARCHAR(50) =''
)
AS
IF @FLAG = 1 
BEGIN 
		UPDATE FOSETTLEMENT SET
			BROKAPPLIED = (  CASE  
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)
			THEN 
				@BROK 
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)
			THEN 
				@BROK 
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)
			THEN  
				((FLOOR ( (((@BROK*F.MULTIPLIER /100 ) * F.MPRICE)  * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + 
				BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  /POWER(10,BROKTABLE.ROUND_TO))
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)
			THEN 
				((FLOOR(( ((@BROK*F.MULTIPLIER /100 )* F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + 
				BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
			WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' ) 
			THEN 
				@BROK 
			WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' ) 
			THEN 
				((FLOOR(( ((@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /(BROKTABLE.ROFIG + 
				BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
			WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )
			THEN 
				@BROK 
			WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )
			THEN         
				((FLOOR(( ((@BROK*F.MULTIPLIER/ 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + 
				BROKTABLE.ERRNUM ) /(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
			WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )
			THEN 
				@BROK 
			WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )
			THEN 
				((FLOOR(( ((@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + 
				BROKTABLE.ERRNUM ) /(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
			WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='V' )
			THEN 
				@BROK 
			WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='P' )
			THEN 
				((FLOOR(( ((@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + 
				BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
			ELSE  0 
		END 
		),
	
		NETRATE = (  CASE  
				WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)
				THEN 
					(FOSETTLEMENT.PRICE) + @BROK  
				WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)
				THEN 
					(FOSETTLEMENT.PRICE) - @BROK 
				WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)
				THEN 
					(FOSETTLEMENT.PRICE)+ ((FLOOR(( (((@BROK*F.MULTIPLIER /100 )* F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + 
					BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
				WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)
				THEN 
					(FOSETTLEMENT.PRICE) -  ((FLOOR((  ( ((@BROK*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + 
					BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
				WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' ) 
				THEN 
					(FOSETTLEMENT.PRICE) + @BROK  
				WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' ) 
				THEN 
					(FOSETTLEMENT.PRICE) + ((FLOOR(( (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
					BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
				WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )
				THEN 
					(FOSETTLEMENT.PRICE) - @BROK  
				WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )
				THEN 
					(FOSETTLEMENT.PRICE) - ((FLOOR((  (((@BROK*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
					BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
				WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )
				THEN
					(FOSETTLEMENT.PRICE) + @BROK  
				WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )
				THEN 
					(FOSETTLEMENT.PRICE) + ((FLOOR(( ( (( @BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + 
					BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
				WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='V' )
				THEN 
					FOSETTLEMENT.PRICE - @BROK
				WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='P' )
				THEN 
					(FOSETTLEMENT.PRICE) -  ((FLOOR((  (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
					BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  /  POWER(10,BROKTABLE.ROUND_TO))
				ELSE  0 
			END 
			),
		AMOUNT = 
				( CASE  
				WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)
				THEN 
					FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE + @BROK) 
				WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)
				THEN 
					FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE - @BROK) 
				WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)
				THEN 
					FOSETTLEMENT.TRADEQTY  * ((FOSETTLEMENT.PRICE) + ((FLOOR(( (((@BROK*F.MULTIPLIER/100 )* F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
					BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
				WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)
				THEN 
					FOSETTLEMENT.TRADEQTY * ((FOSETTLEMENT.PRICE) -  ((FLOOR((  ( ((@BROK*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,BROKTABLE.ROUND_TO)+
					BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
				WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' ) 
				THEN 
					FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE + @BROK) 
				WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' ) 
				THEN 
					FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
					BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
				WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )
				THEN 
					FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE - @BROK) 
				WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )
				THEN 
					FOSETTLEMENT.TRADEQTY * (  (FOSETTLEMENT.PRICE) - ((FLOOR((  (((@BROK*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
					BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
				WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )
				THEN 
					FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE + @BROK) 
				WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )
				THEN 
					FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( ( (( @BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
					BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
				WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='V' )
				THEN 
					FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE - @BROK) 
				WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='P' )
				THEN 
					FOSETTLEMENT.TRADEQTY  * (  (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
					BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  /  POWER(10,BROKTABLE.ROUND_TO)))
				ELSE  0 
			END 
			) ,

		INS_CHRG  = 0,  
		
		OTHER_CHRG  =  ((FLOOR(( ((FOTAXES.OTHER_CHRG *(F.TAXPRICE ) * FOSETTLEMENT.TRADEQTY )/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /   
					(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO)),  
		
		
		SEBI_TAX =     ((FLOOR(( ((FOTAXES.SEBITURN_TAX *(F.TAXPRICE ) * FOSETTLEMENT.TRADEQTY )/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /   
					(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO)),  
		
		
		TURN_TAX  =   ((FLOOR(( ((FOTAXES.TURNOVER_TAX *(F.TAXPRICE ) * FOSETTLEMENT.TRADEQTY )/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /   
					(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO)),  
		
				
		BROKER_CHRG =  0, 
	
		SERVICE_TAX =  CASE WHEN CLIENT2.SERVICE_CHRG = 1 AND  CLIENT2.SERTAXMETHOD = 1 THEN 0 ELSE
				(CASE  
						WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V')
						THEN 
							ROUND(@BROK * FOSETTLEMENT.TRADEQTY  * FOGLOBALS.SERVICE_TAX / 100,4)
						WHEN (FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P')
						THEN 
							((FLOOR(( 
							(((((FLOOR((   ((@BROK*F.MULTIPLIER /100 ) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG +
							BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
							POWER(10,BROKTABLE.ROUND_TO))) * FOSETTLEMENT.TRADEQTY  *  FOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO)+
							BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
							(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))
						WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' ) 
						THEN  
							ROUND(@BROK * FOSETTLEMENT.TRADEQTY  * FOGLOBALS.SERVICE_TAX / 100,4)
						WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' ) 
						THEN 
							((FLOOR(( 
							(((((FLOOR((( (@BROK*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG +
							BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
							POWER(10,BROKTABLE.ROUND_TO))) * FOSETTLEMENT.TRADEQTY  *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+
							BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
							(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
						WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )
						THEN 
							ROUND(@BROK * FOSETTLEMENT.TRADEQTY  * FOGLOBALS.SERVICE_TAX / 100,4)
						WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )
						THEN 
							((FLOOR(( 
							(((((FLOOR((( (@BROK*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + 
							BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
							POWER(10,BROKTABLE.ROUND_TO))) * FOSETTLEMENT.TRADEQTY  *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+
							BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
							(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
						WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )
						THEN  
							ROUND(@BROK * FOSETTLEMENT.TRADEQTY  * FOGLOBALS.SERVICE_TAX / 100,4)
						WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )
						THEN 
							((FLOOR(( 
							(((((FLOOR((( (@BROK*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG +
							BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
							POWER(10,BROKTABLE.ROUND_TO))) * FOSETTLEMENT.TRADEQTY  *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+
							BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
							(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
						WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='V' )
						THEN   
							ROUND(@BROK * FOSETTLEMENT.TRADEQTY  * FOGLOBALS.SERVICE_TAX / 100,4)
						WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='P' )
						THEN  
							((FLOOR(( 
							(((((FLOOR((( (@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + 
							BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
							POWER(10,BROKTABLE.ROUND_TO))) * FOSETTLEMENT.TRADEQTY  *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+
							BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
							(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
						ELSE  0 
					END 
					) END,
			TRADE_AMOUNT = FOSETTLEMENT.TRADEQTY * FOSETTLEMENT.PRICE,							
			STATUS = 'E'
			FROM
				FOSETTLEMENT,
				BROKTABLE,
				FOTAXES,
				CLIENT2,
				CLIENT1,
				FOGLOBALS,
			      ( SELECT CONTRACTNO,BILLNO,TRADE_NO,F.PARTY_CODE,F.INST_TYPE,F.SYMBOL,F.SEC_NAME,F.EXPIRYDATE,F.STRIKE_PRICE,F.OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,F.SERIES,ORDER_NO,PRICE,SAUDA_DATE,F.TABLE_NO,LINE_NO,
			      VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,F.OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,  
						MPRICE = (CASE WHEN C2.DUMMY1 = 0   
						        THEN PRICE   
						        ELSE  
						     (CASE WHEN C2.DUMMY1 = 1   
						    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )       
						                  ELSE F.STRIKE_PRICE + PRICE    
						      END)  
						   END) ,   
						MULTIPLIER = 1, 
						TAXPRICE = (CASE WHEN TAXESFLAG = 0   
						        THEN PRICE   
						        ELSE  
						     (CASE WHEN TAXESFLAG = 1   
						    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )       
						                  ELSE F.STRIKE_PRICE + PRICE    
						      END)  
						   END) ,  
						F.RESERVED1,F.DUMMY1,STATUS  
						FROM FOSETTLEMENT F, CLIENT2 C2, FOOWNER  
						WHERE C2.PARTY_CODE = F.PARTY_CODE   
						AND F.SAUDA_DATE LIKE @SAUDA_DATE + '%'  
						AND F.PARTY_CODE LIKE @PARTY_CODE  
						AND F.INST_TYPE LIKE @INST_TYPE  
						AND F.SYMBOL LIKE @SYMBOL  
						AND F.EXPIRYDATE LIKE @EXPIRYDATE + '%'  
						AND F.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN F.STRIKE_PRICE ELSE @STRIKE_PRICE END)  
						AND F.OPTION_TYPE LIKE @OPTION_TYPE
			       ) F /* FOSETTVIEW */ 
			WHERE 
			LEFT(CONVERT(VARCHAR,FOSETTLEMENT.SAUDA_DATE,109),11) = @SAUDA_DATE AND
			FOSETTLEMENT.OPTION_TYPE = @OPTION_TYPE 
			AND FOSETTLEMENT.INST_TYPE = @INST_TYPE
			AND FOSETTLEMENT.SYMBOL = @SYMBOL  
			AND LEFT(CONVERT(VARCHAR,FOSETTLEMENT.EXPIRYDATE,109),11) = @EXPIRYDATE 
			AND FOSETTLEMENT.STRIKE_PRICE = @STRIKE_PRICE                 
			AND FOSETTLEMENT.PARTY_CODE = @PARTY_CODE 
			AND FOSETTLEMENT.TRADE_NO LIKE @TRADE_NO
			AND FOSETTLEMENT.ORDER_NO LIKE @ORDER_NO 
			AND FOSETTLEMENT.CONTRACTNO = @CONTRACTNO
			AND CLIENT2.PARTY_CODE = @PARTY_CODE 
			AND FOSETTLEMENT.SELL_BUY = @SELL_BUY
			AND FOTAXES.TRANS_CAT = (CASE WHEN CL_TYPE = 'PRO' THEN 'PRO' ELSE CLIENT2.TRAN_CAT END )
			AND CLIENT2.CL_CODE = CLIENT1.CL_CODE
			AND FOSETTLEMENT.PARTY_CODE = F.PARTY_CODE AND
			FOSETTLEMENT.INST_TYPE=F.INST_TYPE AND  
			FOSETTLEMENT.SYMBOL=F.SYMBOL AND
			FOSETTLEMENT.EXPIRYDATE=F.EXPIRYDATE  AND
			FOSETTLEMENT.STRIKE_PRICE = F.STRIKE_PRICE AND                
			FOSETTLEMENT.SEC_NAME = F.SEC_NAME AND                        
			FOSETTLEMENT.OPTION_TYPE = F.OPTION_TYPE AND                  
			FOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE AND
			FOSETTLEMENT.TRADE_NO = F.TRADE_NO AND 
			FOSETTLEMENT.ORDER_NO = F.ORDER_NO AND
			FOSETTLEMENT.SELL_BUY = F.SELL_BUY   AND
			YEAR_START_DT <= FOSETTLEMENT.SAUDA_DATE AND
			YEAR_END_DT >= FOSETTLEMENT.SAUDA_DATE  AND
			FOSETTLEMENT.SAUDA_DATE >= FOTAXES.FROM_DATE AND
			FOSETTLEMENT.SAUDA_DATE <= FOTAXES.TO_DATE 
			AND BROKTABLE.TABLE_NO = ( SELECT DISTINCT TABLE_NO FROM BROKTABLE WHERE TABLE_NO = 
						(CASE WHEN LEFT(F.INST_TYPE,3) = 'FUT'  
						THEN CLIENT2.STD_RATE
						ELSE CLIENT2.BROK2_TABLENO
						END)) AND 
			BROKTABLE.LINE_NO = 1   
END
IF @FLAG = 2 
BEGIN
		UPDATE FOSETTLEMENT SET
		BROKAPPLIED = (  CASE  
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)
			THEN 
				@BROK
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)
			THEN 
				@BROK
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)
			THEN  
				((FLOOR ( (((@BROK*F.MULTIPLIER /100 ) * F.MPRICE)  * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + 
				BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  /POWER(10,BROKTABLE.ROUND_TO))
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)
			THEN 
				((FLOOR(( ((@BROK*F.MULTIPLIER /100 )* F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG +
				 BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
			WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' ) 
			THEN 
				@BROK
			WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' ) 
			THEN 
				((FLOOR(( ((@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + 
				BROKTABLE.ERRNUM ) /(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
			WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )
			THEN 
				@BROK
			WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )
			THEN         
				((FLOOR(( ((@BROK*F.MULTIPLIER/ 100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + 
				BROKTABLE.ERRNUM ) /(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
				WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )
			THEN 
				@BROK
			WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )
			THEN 
				((FLOOR(( ((@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+
				BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
			WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='V' )
			THEN 
				@BROK
			WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='P' )
			THEN 
				((FLOOR(( ((@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+
				BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
			ELSE  0 
			END 
		),

		NETRATE = (  CASE  
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)
			THEN 
				FOSETTLEMENT.PRICE + @BROK
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)
			THEN 
				FOSETTLEMENT.PRICE - @BROK
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)
			THEN 
				(FOSETTLEMENT.PRICE)+ ((FLOOR(( (((@BROK*F.MULTIPLIER /100 )* F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG +
				 BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)
			THEN 
				(FOSETTLEMENT.PRICE) -  ((FLOOR((  ( ((@BROK*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + 
				BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
			WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' ) 
			THEN 
				FOSETTLEMENT.PRICE + @BROK
			WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' ) 
			THEN 
				(FOSETTLEMENT.PRICE) + ((FLOOR(( (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
				BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
			WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )
			THEN 
				FOSETTLEMENT.PRICE - @BROK
			WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )
			THEN 
				(FOSETTLEMENT.PRICE) - ((FLOOR((  (((@BROK*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
				BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
			WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )
			THEN 
				FOSETTLEMENT.PRICE + @BROK
			WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )
			THEN 
				(FOSETTLEMENT.PRICE) + ((FLOOR(( ( (( @BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + 
				BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
			WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='V' )
			THEN 
				FOSETTLEMENT.PRICE - @BROK
			WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='P' )
			THEN 
				(FOSETTLEMENT.PRICE) -  ((FLOOR((  (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
				BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  /  POWER(10,BROKTABLE.ROUND_TO))
			ELSE  0 
			END 
		),
		AMOUNT = 
			(  CASE  
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)
			THEN 
				FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE + @BROK)
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)
			THEN 
				FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE - @BROK)
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)
			THEN 
				FOSETTLEMENT.TRADEQTY  * ((FOSETTLEMENT.PRICE) + ((FLOOR(( (((@BROK*F.MULTIPLIER/100 )* F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
				BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
			WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)
			THEN 
				FOSETTLEMENT.TRADEQTY * ((FOSETTLEMENT.PRICE) -  ((FLOOR((  ( ((@BROK*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,BROKTABLE.ROUND_TO)+
				BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
			WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' ) 
			THEN 
				FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE + @BROK)
			WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' ) 
			THEN 
				FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
				BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
			WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )
			THEN 
				FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE - @BROK)
			WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )
			THEN 
				FOSETTLEMENT.TRADEQTY * (  (FOSETTLEMENT.PRICE) - ((FLOOR((  (((@BROK*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
				BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))
			WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )
			THEN 
				FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE + @BROK)
			WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )
			THEN 
				FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( ( (( @BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
				BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO)))			
			WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='V' )
			THEN 
				FOSETTLEMENT.TRADEQTY * (FOSETTLEMENT.PRICE - @BROK)
			WHEN ( FOSETTLEMENT.SETTFLAG =5  AND @VAL_PERC ='P' )
			THEN 
				FOSETTLEMENT.TRADEQTY  * (  (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((@BROK*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+
				BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  /  POWER(10,BROKTABLE.ROUND_TO)))
			ELSE  0 
			END 
		),
		INS_CHRG  = 0,  
		
		OTHER_CHRG  =   ((FLOOR(( ((FOTAXES.OTHER_CHRG *(F.TAXPRICE ) * FOSETTLEMENT.TRADEQTY )/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /   
					(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO)),
		
		SEBI_TAX =     ((FLOOR(( ((FOTAXES.SEBITURN_TAX *(F.TAXPRICE ) * FOSETTLEMENT.TRADEQTY )/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /   
					(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO)),  
		
		
		TURN_TAX  =  ((FLOOR(( ((FOTAXES.TURNOVER_TAX *(F.TAXPRICE ) * FOSETTLEMENT.TRADEQTY )/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /   
					(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO)),
		
		BROKER_CHRG =  0, 
	
		SERVICE_TAX =  CASE WHEN CLIENT2.SERVICE_CHRG = 1 AND  CLIENT2.SERTAXMETHOD = 1 THEN 0 ELSE
				(CASE  
				WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='V')
				THEN 
					ROUND(@BROK * FOSETTLEMENT.TRADEQTY  * FOGLOBALS.SERVICE_TAX / 100,4)
				WHEN (FOSETTLEMENT.SETTFLAG = 1 AND @VAL_PERC ='P')
				THEN 
					((FLOOR(( 
					(((((FLOOR((   ((@BROK*F.MULTIPLIER /100 ) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + 
					BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
					POWER(10,BROKTABLE.ROUND_TO))) * FOSETTLEMENT.TRADEQTY  * FOGLOBALS.SERVICE_TAX) / 100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
					(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))
				WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='V' ) 
				THEN  
					ROUND(@BROK * FOSETTLEMENT.TRADEQTY  * FOGLOBALS.SERVICE_TAX / 100,4)
				WHEN (FOSETTLEMENT.SETTFLAG = 2  AND @VAL_PERC ='P' ) 
				THEN 
					((FLOOR(( 
					(((((FLOOR((( (@BROK*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + 
					BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
					POWER(10,BROKTABLE.ROUND_TO))) * FOSETTLEMENT.TRADEQTY  * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
					(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
				WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='V' )
				THEN 
					ROUND(@BROK * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX / 100,4)
				WHEN (FOSETTLEMENT.SETTFLAG = 3  AND @VAL_PERC ='P' )
				THEN 
					((FLOOR(( 
					(((((FLOOR((( (@BROK*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + 
					BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
					POWER(10,BROKTABLE.ROUND_TO))) * FOSETTLEMENT.TRADEQTY  * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
					(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
				WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='V' )
				THEN  
					ROUND(@BROK * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX / 100,4)
				WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND @VAL_PERC ='P' )
				THEN 
					((FLOOR(( 
					(((((FLOOR((( (@BROK*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG +
					BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
					POWER(10,BROKTABLE.ROUND_TO))) * FOSETTLEMENT.TRADEQTY  * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
					(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
				WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='V' )
				THEN   
					ROUND(@BROK * FOSETTLEMENT.TRADEQTY * FOGLOBALS.SERVICE_TAX / 100,4)
				WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND @VAL_PERC ='P' )
				THEN  
					((FLOOR(( 
					(((((FLOOR((( (@BROK*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG +
					BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
					POWER(10,BROKTABLE.ROUND_TO))) * FOSETTLEMENT.TRADEQTY  * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
					(BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO))    
				ELSE  0 
				END 
			) END,
			TRADE_AMOUNT = FOSETTLEMENT.TRADEQTY * FOSETTLEMENT.PRICE,
			STATUS = 'E'
			FROM
				BROKTABLE,
				FOTAXES,
				CLIENT2,
				CLIENT1 ,
				FOGLOBALS,
			      ( SELECT CONTRACTNO,BILLNO,TRADE_NO,F.PARTY_CODE,F.INST_TYPE,F.SYMBOL,F.SEC_NAME,F.EXPIRYDATE,F.STRIKE_PRICE,F.OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,F.SERIES,ORDER_NO,PRICE,SAUDA_DATE,
			      F.TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,F.OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,BILLFLAG,SETT_NO,NBROKAPP,
			      NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,  
						MPRICE = (CASE WHEN C2.DUMMY1 = 0   
						        THEN PRICE   
						        ELSE  
						     (CASE WHEN C2.DUMMY1 = 1   
						    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )       
						                  ELSE F.STRIKE_PRICE + PRICE    
						      END)  
						   END) ,   
						MULTIPLIER = 1, 
						TAXPRICE = (CASE WHEN TAXESFLAG = 0   
						        THEN PRICE   
						        ELSE  
						     (CASE WHEN TAXESFLAG = 1   
						    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )       
						                  ELSE F.STRIKE_PRICE + PRICE    
						      END)  
						   END) ,  
						F.RESERVED1,F.DUMMY1,STATUS  
						FROM FOSETTLEMENT F, CLIENT2 C2, FOOWNER  
						WHERE C2.PARTY_CODE = F.PARTY_CODE   
						AND F.SAUDA_DATE LIKE @SAUDA_DATE + '%'  
						AND F.PARTY_CODE LIKE @PARTY_CODE  
						AND F.INST_TYPE LIKE @INST_TYPE  
						AND F.SYMBOL LIKE @SYMBOL  
						AND F.EXPIRYDATE LIKE @EXPIRYDATE + '%'  
						AND F.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN F.STRIKE_PRICE ELSE @STRIKE_PRICE END)  
						AND F.OPTION_TYPE LIKE @OPTION_TYPE
			       ) F /* FOSETTVIEW */ 
			WHERE 
				LEFT(CONVERT(VARCHAR,FOSETTLEMENT.SAUDA_DATE,109),11) = @SAUDA_DATE AND
				FOSETTLEMENT.OPTION_TYPE = @OPTION_TYPE 
				AND FOSETTLEMENT.INST_TYPE = @INST_TYPE
				AND FOSETTLEMENT.SYMBOL = @SYMBOL  
				AND LEFT(CONVERT(VARCHAR,FOSETTLEMENT.EXPIRYDATE,109),11) = @EXPIRYDATE  
				AND FOSETTLEMENT.STRIKE_PRICE = @STRIKE_PRICE                 
				AND FOSETTLEMENT.PARTY_CODE = @PARTY_CODE 
				AND FOSETTLEMENT.TRADE_NO LIKE @TRADE_NO
				AND FOSETTLEMENT.ORDER_NO LIKE @ORDER_NO 
				AND FOSETTLEMENT.CONTRACTNO = @CONTRACTNO
				AND FOSETTLEMENT.PRICE = @PRICE 
				AND CLIENT2.PARTY_CODE = @PARTY_CODE 
				AND FOTAXES.TRANS_CAT = (CASE WHEN CL_TYPE = 'PRO' THEN 'PRO' ELSE CLIENT2.TRAN_CAT END )
				AND CLIENT2.CL_CODE = CLIENT1.CL_CODE
				AND BROKTABLE.TABLE_NO = ( SELECT DISTINCT TABLE_NO FROM BROKTABLE 
											WHERE TABLE_NO = (CASE WHEN LEFT(F.INST_TYPE,3) = 'FUT'  
											THEN CLIENT2.STD_RATE
											ELSE CLIENT2.BROK2_TABLENO
											END))
				AND	FOSETTLEMENT.PARTY_CODE = F.PARTY_CODE AND
				FOSETTLEMENT.INST_TYPE=F.INST_TYPE AND  
				FOSETTLEMENT.SYMBOL=F.SYMBOL AND
				FOSETTLEMENT.EXPIRYDATE=F.EXPIRYDATE  AND
				FOSETTLEMENT.STRIKE_PRICE = F.STRIKE_PRICE AND                
				FOSETTLEMENT.SEC_NAME = F.SEC_NAME AND                        
				FOSETTLEMENT.OPTION_TYPE = F.OPTION_TYPE AND                  
				FOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE AND
				FOSETTLEMENT.TRADE_NO = F.TRADE_NO AND 
				FOSETTLEMENT.ORDER_NO = F.ORDER_NO AND
				FOSETTLEMENT.SELL_BUY = F.SELL_BUY   
				AND BROKTABLE.LINE_NO =  1 
				AND FOSETTLEMENT.SAUDA_DATE >= FOTAXES.FROM_DATE
				AND FOSETTLEMENT.SAUDA_DATE <= FOTAXES.TO_DATE 
END    
ELSE IF @FLAG = 3
BEGIN
		UPDATE FOSETTLEMENT SET 
		NETRATE = @NETRATE, N_NETRATE =@NETRATE,
		BROKAPPLIED = ABS(@NETRATE - F.MPRICE), NBROKAPP = ABS(@NETRATE - F.MPRICE),
		SERVICE_TAX = CASE WHEN CLIENT2.SERVICE_CHRG = 1 AND  CLIENT2.SERTAXMETHOD = 1 THEN 0 ELSE
				ROUND(FOSETTLEMENT.TRADEQTY*ABS(@NETRATE - F.MPRICE)*FOGLOBALS.SERVICE_TAX/100,BROKTABLE.ROUND_TO) END, 
		NSERTAX = ROUND(FOSETTLEMENT.TRADEQTY*ABS(@NETRATE - F.MPRICE)*FOGLOBALS.SERVICE_TAX/100,BROKTABLE.ROUND_TO),
		AMOUNT = ROUND(@NETRATE*FOSETTLEMENT.TRADEQTY,BROKTABLE.ROUND_TO) , STATUS = 'E'
		FROM 
			CLIENT2,
			FOGLOBALS,
			BROKTABLE,
		      ( SELECT CONTRACTNO,BILLNO,TRADE_NO,F.PARTY_CODE,F.INST_TYPE,F.SYMBOL,F.SEC_NAME,F.EXPIRYDATE,F.STRIKE_PRICE,F.OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,F.SERIES,ORDER_NO,
		      PRICE,SAUDA_DATE,F.TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,F.OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,
		      TRADE_AMOUNT,BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,  
					MPRICE = (CASE WHEN C2.DUMMY1 = 0   
					        THEN PRICE   
					        ELSE  
					     (CASE WHEN C2.DUMMY1 = 1   
					    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )       
					                  ELSE F.STRIKE_PRICE + PRICE    
					      END)  
					   END) ,   
					MULTIPLIER = 1, 
					TAXPRICE = (CASE WHEN TAXESFLAG = 0   
					        THEN PRICE   
					        ELSE  
					     (CASE WHEN TAXESFLAG = 1   
					    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )       
					                  ELSE F.STRIKE_PRICE + PRICE    
					      END)  
					   END) ,  
					F.RESERVED1,F.DUMMY1,STATUS  
					FROM FOSETTLEMENT F, CLIENT2 C2, FOOWNER  
					WHERE C2.PARTY_CODE = F.PARTY_CODE   
					AND F.SAUDA_DATE LIKE @SAUDA_DATE + '%'  
					AND F.PARTY_CODE LIKE @PARTY_CODE  
					AND F.INST_TYPE LIKE @INST_TYPE  
					AND F.SYMBOL LIKE @SYMBOL  
					AND F.EXPIRYDATE LIKE @EXPIRYDATE + '%'  
					AND F.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN F.STRIKE_PRICE ELSE @STRIKE_PRICE END)  
					AND F.OPTION_TYPE LIKE @OPTION_TYPE
		       ) F /* FOSETTVIEW */ 
		WHERE  
			LEFT(CONVERT(VARCHAR,FOSETTLEMENT.SAUDA_DATE,109),11) = @SAUDA_DATE AND
			FOSETTLEMENT.OPTION_TYPE = @OPTION_TYPE 
			AND FOSETTLEMENT.INST_TYPE = @INST_TYPE
			AND FOSETTLEMENT.SYMBOL = @SYMBOL  
			AND LEFT(CONVERT(VARCHAR,FOSETTLEMENT.EXPIRYDATE,109),11) = @EXPIRYDATE  
			AND FOSETTLEMENT.STRIKE_PRICE = @STRIKE_PRICE                 
			AND FOSETTLEMENT.PARTY_CODE = @PARTY_CODE 
			AND FOSETTLEMENT.TRADE_NO LIKE @TRADE_NO
			AND FOSETTLEMENT.ORDER_NO LIKE @ORDER_NO 
			AND FOSETTLEMENT.CONTRACTNO = @CONTRACTNO
			AND CLIENT2.PARTY_CODE = @PARTY_CODE
			AND BROKTABLE.TABLE_NO = ( SELECT DISTINCT TABLE_NO FROM BROKTABLE
										WHERE TABLE_NO = (CASE WHEN LEFT(F.INST_TYPE,3) = 'FUT'  
																THEN CLIENT2.STD_RATE
																ELSE CLIENT2.BROK2_TABLENO
																END))
			AND FOSETTLEMENT.PARTY_CODE = F.PARTY_CODE AND
			FOSETTLEMENT.INST_TYPE=F.INST_TYPE AND  
			FOSETTLEMENT.SYMBOL=F.SYMBOL AND
			FOSETTLEMENT.EXPIRYDATE=F.EXPIRYDATE  AND
			FOSETTLEMENT.STRIKE_PRICE = F.STRIKE_PRICE AND                
			FOSETTLEMENT.SEC_NAME = F.SEC_NAME AND                        
			FOSETTLEMENT.OPTION_TYPE = F.OPTION_TYPE AND                  
			FOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE AND
			FOSETTLEMENT.TRADE_NO = F.TRADE_NO AND 
			FOSETTLEMENT.ORDER_NO = F.ORDER_NO AND
			FOSETTLEMENT.SELL_BUY = F.SELL_BUY   
			AND FOSETTLEMENT.SELL_BUY = @SELL_BUY
			AND BROKTABLE.LINE_NO = 1
			AND YEAR_START_DT <= FOSETTLEMENT.SAUDA_DATE
			AND YEAR_END_DT >= FOSETTLEMENT.SAUDA_DATE  
END  
ELSE IF @FLAG =4
BEGIN
		UPDATE FOSETTLEMENT SET 
		NETRATE = @NETRATE, N_NETRATE =@NETRATE,
		BROKAPPLIED = ABS(@NETRATE - F.MPRICE), NBROKAPP = ABS(@NETRATE - F.MPRICE),
		SERVICE_TAX = CASE WHEN CLIENT2.SERVICE_CHRG = 1 AND  CLIENT2.SERTAXMETHOD = 1 THEN 0 ELSE
			ROUND(FOSETTLEMENT.TRADEQTY*ABS(@NETRATE - F.MPRICE)*FOGLOBALS.SERVICE_TAX/100,BROKTABLE.ROUND_TO) END,
		NSERTAX = ROUND(FOSETTLEMENT.TRADEQTY*ABS(@NETRATE - F.MPRICE)*FOGLOBALS.SERVICE_TAX/100,BROKTABLE.ROUND_TO),
		AMOUNT = ROUND(@NETRATE*FOSETTLEMENT.TRADEQTY,BROKTABLE.ROUND_TO) , STATUS = 'E'
		FROM
			CLIENT2,
			FOGLOBALS,
			BROKTABLE,
			FOSETTLEMENT,
		      ( SELECT CONTRACTNO,BILLNO,TRADE_NO,F.PARTY_CODE,F.INST_TYPE,F.SYMBOL,F.SEC_NAME,F.EXPIRYDATE,F.STRIKE_PRICE,F.OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,F.SERIES,
		      ORDER_NO,PRICE,SAUDA_DATE,F.TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,F.OTHER_CHRG,SEBI_TAX,BROKER_CHRG,
		      SERVICE_TAX,TRADE_AMOUNT,BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,  
					MPRICE = (CASE WHEN C2.DUMMY1 = 0   
					        THEN PRICE   
					        ELSE  
					     (CASE WHEN C2.DUMMY1 = 1   
					    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )       
					                  ELSE F.STRIKE_PRICE + PRICE    
					      END)  
					   END) ,   
					MULTIPLIER = 1, 
					TAXPRICE = (CASE WHEN TAXESFLAG = 0   
					        THEN PRICE   
					        ELSE  
					     (CASE WHEN TAXESFLAG = 1   
					    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )       
					                  ELSE F.STRIKE_PRICE + PRICE    
					      END)  
					   END) ,  
					F.RESERVED1,F.DUMMY1,STATUS  
					FROM FOSETTLEMENT F, CLIENT2 C2, FOOWNER  
					WHERE C2.PARTY_CODE = F.PARTY_CODE   
					AND F.SAUDA_DATE LIKE @SAUDA_DATE + '%'  
					AND F.PARTY_CODE LIKE @PARTY_CODE  
					AND F.INST_TYPE LIKE @INST_TYPE  
					AND F.SYMBOL LIKE @SYMBOL  
					AND F.EXPIRYDATE LIKE @EXPIRYDATE + '%'  
					AND F.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN F.STRIKE_PRICE ELSE @STRIKE_PRICE END)  
					AND F.OPTION_TYPE LIKE @OPTION_TYPE
		       ) F /* FOSETTVIEW */ 
		WHERE 
		LEFT(CONVERT(VARCHAR,FOSETTLEMENT.SAUDA_DATE,109),11) = @SAUDA_DATE AND
		FOSETTLEMENT.OPTION_TYPE = @OPTION_TYPE 
		AND FOSETTLEMENT.INST_TYPE = @INST_TYPE
		AND FOSETTLEMENT.SYMBOL = @SYMBOL  
		AND LEFT(CONVERT(VARCHAR,FOSETTLEMENT.EXPIRYDATE,109),11) = @EXPIRYDATE  
		AND FOSETTLEMENT.STRIKE_PRICE = @STRIKE_PRICE                 
		AND FOSETTLEMENT.PARTY_CODE = @PARTY_CODE 
		AND FOSETTLEMENT.TRADE_NO LIKE @TRADE_NO
		AND FOSETTLEMENT.ORDER_NO LIKE @ORDER_NO 
		AND FOSETTLEMENT.CONTRACTNO = @CONTRACTNO
		AND FOSETTLEMENT.PRICE = @PRICE 
		AND CLIENT2.PARTY_CODE = @PARTY_CODE
		AND BROKTABLE.TABLE_NO = ( SELECT DISTINCT TABLE_NO FROM BROKTABLE 
					WHERE TABLE_NO = (CASE WHEN LEFT(F.INST_TYPE,3) = 'FUT'  
					THEN CLIENT2.STD_RATE
					ELSE CLIENT2.BROK2_TABLENO
					END))
		AND FOSETTLEMENT.PARTY_CODE = F.PARTY_CODE AND
		FOSETTLEMENT.INST_TYPE=F.INST_TYPE AND  
		FOSETTLEMENT.SYMBOL=F.SYMBOL AND
		FOSETTLEMENT.EXPIRYDATE=F.EXPIRYDATE  AND
		FOSETTLEMENT.STRIKE_PRICE = F.STRIKE_PRICE AND                
		FOSETTLEMENT.SEC_NAME = F.SEC_NAME AND                        
		FOSETTLEMENT.OPTION_TYPE = F.OPTION_TYPE AND                  
		FOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE AND
		FOSETTLEMENT.TRADE_NO = F.TRADE_NO AND 
		FOSETTLEMENT.ORDER_NO = F.ORDER_NO AND
		FOSETTLEMENT.SELL_BUY = F.SELL_BUY   
		AND FOSETTLEMENT.SELL_BUY = @SELL_BUY
		AND BROKTABLE.LINE_NO = 1 
		AND YEAR_START_DT <= FOSETTLEMENT.SAUDA_DATE
		AND YEAR_END_DT >= FOSETTLEMENT.SAUDA_DATE  
END



IF @@ERROR = 0  
BEGIN
IF @STRMODULE<>''
BEGIN
	EXEC CONSOLE_LOG  @PARTY_CODE,'',@SAUDA_DATE,@INST_TYPE,@SYMBOL,@EXPIRYDATE,@STRIKE_PRICE,@OPTION_TYPE,
	@ORDER_NO,@TRADE_NO,@SELL_BUY,@CONTRACTNO,'',@BROK,0,@PRICE,0,@NETRATE,0,0,0,0,'','',@STATUSID,@STRMODULE,'RECAL BROK'
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTRD_CLIENTMASTER
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[FOTRD_CLIENTMASTER]  
AS 


DECLARE @SAUDADATE VARCHAR(11)   
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
TRUNCATE TABLE FOTRD_CLIENT1   
TRUNCATE TABLE FOTRD_CLIENT2   
TRUNCATE TABLE FOTRD_BROKTABLE  
TRUNCATE TABLE FOTRD_CLIENTTAXES
TRUNCATE TABLE FOTRD_CLIENTBROKSCHEME

SELECT TOP 1 @SAUDADATE = LEFT(ACTIVITYTIME,11) FROM FOTRADE

SELECT DISTINCT PARTY_CODE INTO #TRADE FROM FOTRADE  
  
INSERT INTO FOTRD_CLIENT2    
SELECT 
	CL_CODE,EXCHANGE,TRAN_CAT,SCRIP_CAT,PARTY_CODE,TABLE_NO,SUB_TABLENO,MARGIN,
	TURNOVER_TAX,SEBI_TURN_TAX,INSURANCE_CHRG,SERVICE_CHRG,STD_RATE,P_TO_P,
	EXPOSURE_LIM,DEMAT_TABLENO,BANKID,CLTDPNO,PRINTF,ALBMDELCHRG,ALBMDELIVERY,
	ALBMCF_TABLENO,MF_TABLENO,SB_TABLENO,BROK1_TABLENO,BROK2_TABLENO,BROK3_TABLENO,
	BROKERNOTE,OTHER_CHRG,BROK_SCHEME,CONTCHARGE,MINCONTAMT,ADDLEDGERBAL,DUMMY1,DUMMY2,
	INSCONT,SERTAXMETHOD,DUMMY6,DUMMY7,DUMMY8,DUMMY9,DUMMY10
FROM CLIENT2 C2 WITH(NOLOCK)  
WHERE C2.PARTY_CODE IN ( SELECT PARTY_CODE FROM #TRADE)  
  
INSERT INTO FOTRD_CLIENT1    
SELECT * FROM CLIENT1 C1 WITH(NOLOCK) WHERE CL_CODE IN (SELECT CL_CODE FROM FOTRD_CLIENT2 C2)    
  
INSERT INTO FOTRD_CLIENTBROKSCHEME
SELECT  PARTY_CODE,DATE_FROM,DATE_TO,FUT_BROKTABLE,OPT_BROKTABLE,FUT_EXP_BROKTABLE,
	OPT_EXC_BROKTABLE,COMM_DEL_BROKTABLE,BROK_SCHEME,OPT_BROK_COMPUTEON
FROM 
	FOCLIENTBROKSCHEME
WHERE
	@SAUDADATE BETWEEN DATE_FROM AND DATE_TO
	AND PARTY_CODE IN ( SELECT PARTY_CODE FROM #TRADE)  


INSERT INTO FOTRD_BROKTABLE  
SELECT * FROM BROKTABLE WHERE TABLE_NO IN ( SELECT DISTINCT FUT_BROKTABLE FROM FOTRD_CLIENTBROKSCHEME )  
  
INSERT INTO FOTRD_BROKTABLE  
SELECT * FROM BROKTABLE WHERE TABLE_NO IN ( SELECT DISTINCT OPT_BROKTABLE FROM FOTRD_CLIENTBROKSCHEME )   
AND TABLE_NO NOT IN (SELECT DISTINCT FUT_BROKTABLE FROM FOTRD_CLIENTBROKSCHEME)  


INSERT INTO FOTRD_CLIENTTAXES
SELECT 	
	PARTY_CODE,DATE_FROM,DATE_TO,FUT_INSURANCE_CHRG,FUT_TURNOVER_TAX,FUT_OTHER_CHRG,
	FUT_SEBITURN_TAX,FUT_BROKER_NOTE,OPT_INSURANCE_CHRG,OPT_TURNOVER_TAX,OPT_OTHER_CHRG,
	OPT_SEBITURN_TAX,OPT_BROKER_NOTE,ROUND_TO,ROFIG,ERRNUM,NOZERO
FROM
	FOCLIENTTAXES
WHERE
	@SAUDADATE BETWEEN DATE_FROM AND DATE_TO
	AND PARTY_CODE IN ( SELECT PARTY_CODE FROM #TRADE)  


UPDATE
	FOTRADE
SET
	RESERVED4 = 
	CASE 
		WHEN BROK_SCHEME IN (1,5,21,25) THEN
			CASE 
                            WHEN ((S.PQTY >= S.SQTY)
                                  AND SETTFLAG IN (1,2,3,4,
                                                   5)) THEN (CASE 
                                                               WHEN (FOTRADE.SELL_BUY = 1) THEN 'F'
                                                               ELSE 'S'
                                                             END)
                            WHEN SETTFLAG IN (6,7) THEN 'S'
                            WHEN SETTFLAG IN (8,9) THEN 'F'
                            WHEN ((S.PQTY < S.SQTY)
                                  AND SETTFLAG IN (1,2,3,4,
                                                   5)) THEN (CASE 
                                                               WHEN (FOTRADE.SELL_BUY = 2) THEN 'F'
                                                               ELSE 'S'
                                                             END)
                            WHEN SETTFLAG IN (6,7) THEN 'S'
                            WHEN SETTFLAG IN (8,9) THEN 'F'
                            WHEN SETTFLAG = 0 THEN 'F'
                          END
		WHEN BROK_SCHEME = 2 THEN 
			CASE 
	                         WHEN S.PQTY = S.SQTY THEN (CASE 
	                                                      WHEN S.PRATE > = S.SRATE THEN (CASE 
	                                                                                       WHEN FOTRADE.SELL_BUY = 1 THEN 'F'
	                                                                                       ELSE 'S'
	                      END)
	                  ELSE (CASE 
	                                                              WHEN (FOTRADE.SELL_BUY = 2) THEN 'F'
	                                                              ELSE 'S'
	                                                            END)
	                                                    END)
	                         ELSE (CASE 
	                                 WHEN S.PQTY > = S.SQTY THEN (CASE 
	                                                                WHEN (FOTRADE.SELL_BUY = 1) THEN 'F'
	                                                                ELSE 'S'
	                                                              END)
	                                 ELSE (CASE 
	                                         WHEN (FOTRADE.SELL_BUY = 2) THEN 'F'
	                                         ELSE 'S'
	                                       END)
	                               END)
	                       END
		WHEN BROK_SCHEME IN (3,6,23,26) THEN
			CASE 
                                    WHEN ((S.PQTY > S.SQTY)
                                          AND SETTFLAG IN (1,2,3,4,
                                                           5)) THEN (CASE 
                                                                       WHEN (FOTRADE.SELL_BUY = 1) THEN 'F'
                                                                       ELSE 'S'
                                                                     END)
                                    WHEN SETTFLAG IN (6,7) THEN 'S'
                                    WHEN SETTFLAG IN (8,9) THEN 'F'
                                    WHEN ((S.PQTY <= S.SQTY)
                                          AND SETTFLAG IN (1,2,3,4,
                                                           5)) THEN (CASE 
                                                                       WHEN (FOTRADE.SELL_BUY = 2) THEN 'F'
                                                                       ELSE 'S'
                                                                     END)
                                    WHEN SETTFLAG IN (6,7) THEN 'S'
                                    WHEN SETTFLAG IN (8,9) THEN 'F'
                                    WHEN SETTFLAG = 0 THEN 'F'
                                  END
		ELSE
			'T'
		END
FROM
	(
	SELECT 
		PARTY_CODE,INST_TYPE,SYMBOL,
		EXPIRYDATE,STRIKE_PRICE ,OPTION_TYPE,  
		PQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),0),  
		SQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),0),
		PRATE = (CASE WHEN ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),0) > 0   
			      THEN ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE ELSE 0 END),0) /   
			           ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),0)  
			      ELSE 0   
			 END),  
		SRATE = (CASE WHEN ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),0) > 0   
			      THEN ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE ELSE 0 END),0) /   
		                   ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),0)  
		              ELSE 0   
		         END)
	FROM
		FOTRADE 
	GROUP BY 
		PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,
		STRIKE_PRICE  ,OPTION_TYPE
	) S,
	FOTRD_CLIENTTAXES FOCLIENTTAXES,
	FOTRD_CLIENTBROKSCHEME FOCLIENTBROKSCHEME
WHERE 	
	FOTRADE.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE AND 
	FOTRADE.ACTIVITYTIME BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO AND
	FOTRADE.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE AND 
	FOTRADE.ACTIVITYTIME BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO AND
	FOTRADE.PARTY_CODE = S.PARTY_CODE AND
	FOTRADE.INST_TYPE=S.INST_TYPE AND  
	FOTRADE.SYMBOL=S.SYMBOL AND
	FOTRADE.EXPIRYDATE=S.EXPIRYDATE AND
	FOTRADE.STRIKE_PRICE = S.STRIKE_PRICE AND                 
	FOTRADE.OPTION_TYPE = S.OPTION_TYPE

EXEC FOTRD_SCRIPMASTER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTRD_SCRIPMASTER
-- --------------------------------------------------
CREATE PROC [dbo].[FOTRD_SCRIPMASTER] AS    
SET NOCOUNT ON   
  
SELECT DISTINCT EXPIRYDATE
INTO #TRADE11 FROM FOTRADE  
  
TRUNCATE TABLE FOTRD_FOSCRIP2    
  
INSERT INTO FOTRD_FOSCRIP2    
SELECT INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,MATURITYDATE,C_REGULAR_LOT
FROM FOSCRIP2 S2 (NOLOCK)
WHERE EXISTS (SELECT EXPIRYDATE FROM #TRADE11 WHERE #TRADE11.EXPIRYDATE = S2.EXPIRYDATE)

DROP TABLE #TRADE11

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTRDCONTRACT
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[FOTRDCONTRACT]

AS 
 DECLARE 
 @@FOSETTLOOP AS CURSOR,
 @@TRADE_NO VARCHAR(14),
 @@TODAYQTY NUMERIC(9),
 @@LTRADE_NO VARCHAR(14),
 @@LQTY NUMERIC(9), 
 @@PDIFF NUMERIC(9),

 @@TDATE AS VARCHAR(11), 
/* T PREFIX STANDS FOR TODAY AND P STANDS FOR PREVIOUS */

 @@TPOSCUR CURSOR,
 @@TPARTY_CODE VARCHAR(20),
 @@TNETQTY NUMERIC(9),
 @@TINST_TYPE VARCHAR(20), 
 @@TSYMBOL VARCHAR(20),
 @@TEXPIRYDATE DATETIME,
 @@TSTRIKE_PRICE MONEY,
 @@TOPTION_TYPE VARCHAR(20),

 
 @@PPOSCUR CURSOR,
 @@PPARTY_CODE VARCHAR(20),
 @@PNETQTY NUMERIC(9),
 @@PINST_TYPE VARCHAR(20), 
 @@PSYMBOL VARCHAR(20),
 @@PEXPIRYDATE DATETIME,
 @@PSTRIKE_PRICE MONEY,
 @@POPTION_TYPE VARCHAR(20),

 @@DIFFQTY  NUMERIC(9)


UPDATE FOTRADE SET SETTFLAG = '1' FROM FOTRADE,CLIENT2 WHERE 
FOTRADE.PARTY_CODE = CLIENT2.PARTY_CODE AND CLIENT2.TRAN_CAT = 'DEL' 

UPDATE FOTRADE SET SETTFLAG = '2' FROM FOTRADE,CLIENT2 WHERE 
FOTRADE.PARTY_CODE = CLIENT2.PARTY_CODE AND  SELL_BUY = 1 AND CLIENT2.TRAN_CAT = 'TRD' 


UPDATE FOTRADE  SET SETTFLAG = '3' FROM FOTRADE , CLIENT2 WHERE 
FOTRADE.PARTY_CODE = CLIENT2.PARTY_CODE AND   CLIENT2.TRAN_CAT = 'TRD'  AND SELL_BUY = 2 

SET @@TPOSCUR = CURSOR FOR
SELECT TRDVW.PARTY_CODE, TRDVW.INST_TYPE, TRDVW.SYMBOL, TRDVW.EXPIRYDATE,
		NETQTY = SUM(TRDVW.PQTY - TRDVW.SQTY),  /* SELL_BUY = (CASE WHEN SUM(PQTY - SQTY) < 0 THEN '2' ELSE '1' END),   PQTY,SQTY, */ 
		TRDVW.STRIKE_PRICE,TRDVW.OPTION_TYPE  
FROM 
	FOTRDIMPBFVIEW TRDVW
JOIN
	(
		SELECT DISTINCT X.PARTY_CODE 
		FROM 
		(
			SELECT DISTINCT CLIENT2.PARTY_CODE, CLIENT2.STD_RATE FROM CLIENT2, FOTRADE 
			WHERE FOTRADE.PARTY_CODE = CLIENT2.PARTY_CODE
		) X
		JOIN
		BROKTABLE B
		ON (B.TABLE_NO = X.STD_RATE)
		WHERE 
		(
			DAY_PUC <> 0 OR
			DAY_SALES <> 0 OR
			SETT_PURCH <> 0 OR
			SETT_SALES <> 0
		)
	) PCODES
ON 
	(TRDVW.PARTY_CODE = PCODES.PARTY_CODE)
GROUP BY TRDVW.PARTY_CODE, TRDVW.INST_TYPE, TRDVW.SYMBOL, TRDVW.EXPIRYDATE, TRDVW.STRIKE_PRICE, TRDVW.OPTION_TYPE
ORDER BY TRDVW.PARTY_CODE ,TRDVW.INST_TYPE, TRDVW.SYMBOL 

OPEN @@TPOSCUR
FETCH NEXT FROM @@TPOSCUR INTO @@TPARTY_CODE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TNETQTY,@@TSTRIKE_PRICE,@@TOPTION_TYPE

IF @@FETCH_STATUS = 0   
BEGIN
     WHILE @@FETCH_STATUS = 0 
     BEGIN
    
           IF (@@TNETQTY  = 0 )   
           BEGIN

                UPDATE FOTRADE SET SETTFLAG = '2' 
                WHERE
                PARTY_CODE = @@TPARTY_CODE  
                AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL 
                AND EXPIRYDATE = @@TEXPIRYDATE
                AND STRIKE_PRICE = @@TSTRIKE_PRICE 
                AND OPTION_TYPE = @@TOPTION_TYPE
                AND SELL_BUY = 1

        
 
                UPDATE FOTRADE SET SETTFLAG = '3' 
                WHERE
                     PARTY_CODE = @@TPARTY_CODE 
                     AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL 
                     AND EXPIRYDATE = @@TEXPIRYDATE
                     AND STRIKE_PRICE = @@TSTRIKE_PRICE 
                     AND OPTION_TYPE = @@TOPTION_TYPE
                     AND SELL_BUY = 2
           END 

           IF (@@TNETQTY < 0 )  
           BEGIN
                EXEC FOTRDIMPFLAGARRANGE @@TPARTY_CODE,@@TOPTION_TYPE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TSTRIKE_PRICE,@@TNETQTY,'S'
           END
           IF (@@TNETQTY > 0 )  
           BEGIN
                EXEC FOTRDIMPFLAGARRANGE @@TPARTY_CODE,@@TOPTION_TYPE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TSTRIKE_PRICE,@@TNETQTY,'B'
           END 
           FETCH NEXT FROM @@TPOSCUR INTO @@TPARTY_CODE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TNETQTY,@@TSTRIKE_PRICE,@@TOPTION_TYPE
     END
       
END

CLOSE @@TPOSCUR

DEALLOCATE @@TPOSCUR

SET @@TDATE = (SELECT LEFT(CONVERT(VARCHAR,MAX(ACTIVITYTIME)),11) FROM FOTRADE)
DECLARE @@COUNT INT

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SELECT @@COUNT = COUNT(1) FROM FOTRADE (NOLOCK), CLIENT2 (NOLOCK)
WHERE FOTRADE.PARTY_CODE = CLIENT2.PARTY_CODE
AND CLIENT2.BROK_SCHEME IN ('20','21','22','23','24','25','26','27','28','29','30')  

IF @@COUNT > 0
BEGIN 
	EXEC FOTRDSETTOFFFLAG @@TDATE   
END


EXEC FOTRD_CLIENTMASTER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTRDIMPFLAGARRANGE
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[FOTRDIMPFLAGARRANGE] 
@PARTY_CODE VARCHAR(10),
@OPTION_TYPE VARCHAR(2),
@INST_TYPE VARCHAR(6),
@SYMBOL VARCHAR(12),
@EXPIRYDATE VARCHAR(11),
@STRIKE_PRICE MONEY,
@DIFFQTY NUMERIC(9),
@SELL_BUY CHAR(2)

AS 
DECLARE 
 @@TRADE_NO VARCHAR(14),
 @@PQTY NUMERIC(9), 
 @@SQTY NUMERIC(9),
 @@LTRADE_NO VARCHAR(14),
 @@LQTY NUMERIC(9), 
 @@PDIFF NUMERIC(9),
 @@FLAG CURSOR,
 @@LOOP CURSOR



 IF @SELL_BUY = 'B' 
 BEGIN 
      SELECT @@PDIFF = ABS(@DIFFQTY)


      SET @@LOOP  = CURSOR FOR 
      SELECT TRADE_NO,TRADEQTY FROM FOTRADE 
      WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
      AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE 
      AND SELL_BUY = 1 
      
      ORDER BY TRADEQTY DESC
      OPEN @@LOOP
      FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
     


      WHILE @@PDIFF > 0       
      BEGIN
           IF @@PDIFF >= @@LQTY  
           BEGIN
                UPDATE FOTRADE SET SETTFLAG = 4   
                WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
                AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE  
                AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  
                SELECT @@PDIFF = @@PDIFF - @@LQTY
           END    
           ELSE IF @@PDIFF < @@LQTY 
           BEGIN
                INSERT INTO FOTRADE SELECT 'T' + TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
                SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE, USER_ID,BRANCH_ID,SELL_BUY,@@PDIFF,PRICE,PRO_CLI,PARTY_CODE,
                PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,4,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5 

                 FROM FOTRADE WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
                 AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE    
                 AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY    
 
                UPDATE FOTRADE SET SETTFLAG = 2,TRADEQTY = @@LQTY - @@PDIFF    
                WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
                AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE  
                AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY 
                SELECT @@PDIFF = 0   
             END 
             FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY
        END
        CLOSE @@LOOP
  END
      ELSE 
      BEGIN 
           SELECT @@PDIFF = ABS(@DIFFQTY)
           SET @@LOOP  = CURSOR FOR 
           SELECT TRADE_NO,TRADEQTY FROM FOTRADE 
           WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
           AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE 
           AND SELL_BUY = 2 
           ORDER BY TRADEQTY DESC
           OPEN @@LOOP
           FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY     
           WHILE @@PDIFF > 0       
           BEGIN
                IF @@PDIFF >= @@LQTY  
                BEGIN
                     UPDATE FOTRADE SET SETTFLAG = 5   
                     WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
                     AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE   
                     AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  
                     SELECT @@PDIFF = @@PDIFF - @@LQTY
                END    
                ELSE IF @@PDIFF < @@LQTY 
                BEGIN
                     INSERT INTO FOTRADE SELECT 'T' + TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
                     SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE, USER_ID,BRANCH_ID,SELL_BUY,@@PDIFF,PRICE,PRO_CLI,PARTY_CODE,
                      PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,5,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5  
                      FROM FOTRADE WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
                      AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE 
                      AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY    
 
                      UPDATE FOTRADE SET SETTFLAG = 3,TRADEQTY = @@LQTY - @@PDIFF    
                      WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL
                      AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE 
                      AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY 
                      SELECT @@PDIFF = 0   
                 END 
                 FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY
           END
           CLOSE @@LOOP
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTRDMISSCRIP
-- --------------------------------------------------
CREATE PROC [dbo].[FOTRDMISSCRIP] AS 
SELECT DISTINCT INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,SEC_NAME 
FROM FOTRADE WHERE EXPIRYDATE NOT IN ( SELECT EXPIRYDATE FROM FOSCRIP2 WHERE 
FOSCRIP2.INST_TYPE=FOTRADE.INST_TYPE AND
FOSCRIP2.SYMBOL=FOTRADE.SYMBOL AND
FOSCRIP2.EXPIRYDATE=FOTRADE.EXPIRYDATE AND
FOSCRIP2.OPTION_TYPE = FOTRADE.OPTION_TYPE AND
FOSCRIP2.STRIKE_PRICE=FOTRADE.STRIKE_PRICE)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTRDSELALL
-- --------------------------------------------------
CREATE PROC [dbo].[FOTRDSELALL] AS
SELECT * FROM FOTRADE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTRDSELSM
-- --------------------------------------------------
CREATE PROC [dbo].[FOTRDSELSM] AS
SELECT INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,USER_ID,
       PARTY_CODE FROM FOTRADE WHERE FOTRADE.PARTY_CODE 
         NOT IN (SELECT DISTINCT PARTY_CODE FROM CLIENT2)
         OR FOTRADE.EXPIRYDATE NOT IN (SELECT EXPIRYDATE FROM FOSCRIP2
                                       WHERE FOSCRIP2.INST_TYPE=FOTRADE.INST_TYPE AND
                                       FOSCRIP2.SYMBOL=FOTRADE.SYMBOL  AND 
                                       FOSCRIP2.OPTION_TYPE = FOTRADE.OPTION_TYPE AND
                                       FOSCRIP2.STRIKE_PRICE = FOTRADE.STRIKE_PRICE AND
                                       FOSCRIP2.EXPIRYDATE = FOTRADE.EXPIRYDATE
                                        )

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTRDSELTRDQTYCONFIRM
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYCONFIRM    SCRIPT DATE: 09/10/2001 6:27:20 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYCONFIRM    SCRIPT DATE: 09/07/2001 10:36:06 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYCONFIRM    SCRIPT DATE: 9/7/01 5:07:23 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYCONFIRM    SCRIPT DATE: 9/7/2001 4:10:05 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYCONFIRM    SCRIPT DATE: 08/10/2001 4:53:41 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYCONFIRM    SCRIPT DATE: 8/7/01 4:29:06 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYCONFIRM    SCRIPT DATE: 7/25/01 10:05:59 PM ******/



/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYCONFIRM    SCRIPT DATE: 6/30/01 11:51:36 AM ******/



/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYCONFIRM    SCRIPT DATE: 5/26/01 4:17:01 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYCONFIRM    SCRIPT DATE: 3/17/01 9:55:52 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYCONFIRM    SCRIPT DATE: 3/21/01 12:50:08 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYCONFIRM    SCRIPT DATE: 20-MAR-01 11:38:51 PM ******/

/*FINAL SQL - 07 FEB 2001 */
/*RANJEET CHOUDHARY*/
/*USED IN NSEFO SEGMENT*/


CREATE PROC [dbo].[FOTRDSELTRDQTYCONFIRM] AS
  /*USED IN NSE FO */ 
 /*CONTROL NAME :FOIMPORTTRADE MODULE NAME :CMDERRCORRECT_CLICK()*/
 /*VIEW USED :FCOCONFIRMVIEW*/
 /*FUNCTION:THIS IS USED TO SELECT TRDQTY AND AMT FROM FORCONFIRMVIEW */            
 /*WRITTEN BY :RANJEET CHOUDHARY */
 SELECT ISNULL(SUM(TRADEQTY),0),ISNULL(SUM(TRADEQTY*PRICE),0) FROM FOCONFIRMVIEW

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTRDSELTRDQTYTRADE
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYTRADE    SCRIPT DATE: 09/10/2001 6:27:20 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYTRADE    SCRIPT DATE: 09/07/2001 10:36:06 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYTRADE    SCRIPT DATE: 9/7/01 5:07:23 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYTRADE    SCRIPT DATE: 9/7/2001 4:10:05 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYTRADE    SCRIPT DATE: 08/10/2001 4:53:41 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYTRADE    SCRIPT DATE: 8/7/01 4:29:06 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYTRADE    SCRIPT DATE: 7/25/01 10:05:59 PM ******/



/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYTRADE    SCRIPT DATE: 6/30/01 11:51:36 AM ******/



/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYTRADE    SCRIPT DATE: 5/26/01 4:17:01 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYTRADE    SCRIPT DATE: 3/17/01 9:55:52 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYTRADE    SCRIPT DATE: 3/21/01 12:50:08 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.FOTRDSELTRDQTYTRADE    SCRIPT DATE: 20-MAR-01 11:38:51 PM ******/

/*FINAL SQL - 07 FEB 2001 */
/*RANJEET CHOUDHARY*/
/*USED IN NSEFO SEGMENT*/

CREATE PROC [dbo].[FOTRDSELTRDQTYTRADE] AS
  /*USED IN NSE FO */ 
 /*CONTROL NAME :FOIMPORTTRADE MODULE NAME :CMDERRCORRECT_CLICK()*/
 /*VIEW USED :FOTRADE*/
 /*FUNCTION:THIS IS USED TO SELECT TRDQTY AND AMT FROM FOTRADE */            
 /*WRITTEN BY :RANJEET CHOUDHARY */
SELECT ISNULL(SUM(TRADEQTY),0),ISNULL(SUM(TRADEQTY*PRICE),0) FROM FOTRADE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTRDSETTFLAGARRANGE
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[FOTRDSETTFLAGARRANGE]   
@PARTY_CODE VARCHAR(10),  
@OPTION_TYPE VARCHAR(2),  
@INST_TYPE VARCHAR(6),  
@SYMBOL VARCHAR(12),  
@EXPIRYDATE VARCHAR(11),  
@STRIKE_PRICE MONEY,  
@TDATE VARCHAR(11),  
@DIFFQTY NUMERIC(9),  
@SELL_BUY CHAR(2)  
  
AS   
DECLARE   
 @@TRADE_NO VARCHAR(14),  
 @@PQTY NUMERIC(9),   
 @@SQTY NUMERIC(9),  
 @@LTRADE_NO VARCHAR(14),  
 @@LQTY NUMERIC(9),   
 @@PDIFF NUMERIC(9),  
 @@FLAG CURSOR,  
 @@LOOP CURSOR  
  
  
 IF @SELL_BUY = 'B'   
 BEGIN   
      SELECT @@PDIFF = ABS(@DIFFQTY)  
      SET @@LOOP  = CURSOR FOR   
      SELECT TRADE_NO,TRADEQTY FROM FOTRADE   
      WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL  
      AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE   
      AND SELL_BUY = 1   
      AND SETTFLAG IN (4,8)    
      ORDER BY TRADEQTY DESC  
      OPEN @@LOOP  
      FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY       
       
      WHILE @@PDIFF > 0         
      BEGIN  
           IF @@PDIFF >= @@LQTY    
           BEGIN  
                UPDATE FOTRADE SET SETTFLAG = 6     
                WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL  
                AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE     
                AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  AND SETTFLAG IN (4,8)  
                SELECT @@PDIFF = @@PDIFF - @@LQTY  
           END      
           ELSE IF @@PDIFF < @@LQTY   
           BEGIN  
                INSERT INTO FOTRADE SELECT 'T' + TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
                SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE, USER_ID,BRANCH_ID,SELL_BUY,@@PDIFF,PRICE,PRO_CLI,PARTY_CODE,  
                PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,6,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5   
                  
                FROM FOTRADE WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL  
                AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE     
                AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY      
   
                UPDATE FOTRADE SET SETTFLAG = 8,TRADEQTY = @@LQTY - @@PDIFF      
                WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL  
                AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE   
                AND SELL_BUY = 1 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY
                SELECT @@PDIFF = 0     
             END   
             FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY  
        END  
        CLOSE @@LOOP  
  END  
      ELSE   
      BEGIN   
           SELECT @@PDIFF = ABS(@DIFFQTY)  
           SET @@LOOP  = CURSOR FOR   
           SELECT TRADE_NO,TRADEQTY FROM FOTRADE   
           WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL  
           AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE   
           AND SELL_BUY = 2   
         AND SETTFLAG IN (5,9)   
           ORDER BY TRADEQTY DESC  
           OPEN @@LOOP  
           FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY       
           WHILE @@PDIFF > 0         
           BEGIN  
                IF @@PDIFF >= @@LQTY    
                BEGIN  
       UPDATE FOTRADE SET SETTFLAG = 7     
                     WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL  
                     AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE   
                     AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY  AND SETTFLAG IN (4,8)  
                     SELECT @@PDIFF = @@PDIFF - @@LQTY  
                END      
                ELSE IF @@PDIFF < @@LQTY   
                BEGIN  
                     INSERT INTO FOTRADE SELECT 'T'+TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
                     SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE, USER_ID,BRANCH_ID,SELL_BUY,@@PDIFF,PRICE,PRO_CLI,PARTY_CODE,  
                     PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,7,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5   
                     FROM FOTRADE WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL  
                     AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE     
                     AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY      
   
                      UPDATE FOTRADE SET SETTFLAG = 9,TRADEQTY = @@LQTY - @@PDIFF     
                      WHERE PARTY_CODE = @PARTY_CODE AND OPTION_TYPE = @OPTION_TYPE AND INST_TYPE = @INST_TYPE AND SYMBOL = @SYMBOL  
                      AND LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) = @EXPIRYDATE AND STRIKE_PRICE = @STRIKE_PRICE    
                      AND SELL_BUY = 2 AND TRADE_NO = @@LTRADE_NO AND TRADEQTY = @@LQTY   
    SELECT @@PDIFF,@@LQTY,'UPPILIKRISHNAN'  
                      SELECT @@PDIFF = 0     
         
                 END   
                 FETCH NEXT FROM @@LOOP INTO @@LTRADE_NO,@@LQTY  
           END  
           CLOSE @@LOOP  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTRDSETTOFFFLAG
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[FOTRDSETTOFFFLAG] 
@TDATE VARCHAR(11)
AS 
 DECLARE 
 @@FOSETTLOOP AS CURSOR,
 @@TRADE_NO VARCHAR(14),
 @@TODAYQTY NUMERIC(9),
 @@LTRADE_NO VARCHAR(14),
 @@LQTY NUMERIC(9), 
 @@PDIFF NUMERIC(9),


 @@TPOSCUR CURSOR,
 @@TPARTY_CODE VARCHAR(20),
 @@TNETQTY NUMERIC(9),
 @@TINST_TYPE VARCHAR(20), 
 @@TSYMBOL VARCHAR(20),
 @@TEXPIRYDATE VARCHAR(11),
 @@TSTRIKE_PRICE MONEY,
 @@TOPTION_TYPE VARCHAR(20),

 
 @@PPOSCUR CURSOR,
 @@PPARTY_CODE VARCHAR(20),
 @@PNETQTY NUMERIC(9),
 @@PINST_TYPE VARCHAR(20), 
 @@PSYMBOL VARCHAR(20),
 @@PEXPIRYDATE DATETIME,
 @@PSTRIKE_PRICE MONEY,
 @@POPTION_TYPE VARCHAR(20),
 @@DIFFQTY  NUMERIC(9)

UPDATE FOTRADE SET SETTFLAG = '8' FROM FOTRADE,CLIENT2 
WHERE FOTRADE.PARTY_CODE = CLIENT2.PARTY_CODE AND CLIENT2.BROK_SCHEME IN ('20','21','22','23','24','25','26','27','28','29','30')  
AND SELL_BUY = 1 AND SETTFLAG = '4'

UPDATE FOTRADE  SET SETTFLAG = '9' FROM FOTRADE , CLIENT2 
WHERE FOTRADE.PARTY_CODE = CLIENT2.PARTY_CODE AND CLIENT2.BROK_SCHEME IN ('20','21','22','23','24','25','26','27','28','29','30') 
AND SELL_BUY = 2 AND SETTFLAG = '5'



SET @@TPOSCUR = CURSOR FOR


SELECT PARTY_CODE, INST_TYPE, SYMBOL,EXPIRYDATE=LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),NETQTY = SUM(PQTY - SQTY),  /* SELL_BUY = (CASE WHEN SUM(PQTY - SQTY) < 0 THEN '2' ELSE '1' END),   PQTY,SQTY, */ STRIKE_PRICE,OPTION_TYPE  
FROM FOTRDSETTBFVIEW WHERE EXPIRYDATE >= @TDATE + ' 23:59:00'
AND SETTFLAG IN(8,9) 
GROUP BY PARTY_CODE, INST_TYPE, SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
ORDER BY PARTY_CODE ,INST_TYPE,SYMBOL 

OPEN @@TPOSCUR
FETCH NEXT FROM @@TPOSCUR INTO @@TPARTY_CODE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TNETQTY,@@TSTRIKE_PRICE,@@TOPTION_TYPE

IF @@FETCH_STATUS = 0   
BEGIN
     WHILE @@FETCH_STATUS = 0 
     BEGIN

          SET @@PPOSCUR = CURSOR FOR
 
          SELECT PARTY_CODE, NETQTY = (SUM(PQTY - SQTY)),INST_TYPE, SYMBOL,EXPIRYDATE, STRIKE_PRICE,OPTION_TYPE   
          FROM BBGFOSETTBFVIEW WHERE  
          EXPIRYDATE >= @TDATE +  ' 23:59:59'
          AND PARTY_CODE = @@TPARTY_CODE AND SAUDA_DATE < CONVERT(SMALLDATETIME,@TDATE + ' 00:00:00') AND EXPIRYDATE >= @TDATE + ' 23:59:59'
          AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL AND EXPIRYDATE LIKE @@TEXPIRYDATE +'%'
          AND STRIKE_PRICE = @@TSTRIKE_PRICE AND OPTION_TYPE = @@TOPTION_TYPE
          GROUP BY PARTY_CODE, INST_TYPE, SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
    
          OPEN @@PPOSCUR
          FETCH NEXT FROM @@PPOSCUR INTO @@PPARTY_CODE, @@PNETQTY,@@PINST_TYPE ,@@PSYMBOL,@@PEXPIRYDATE,@@PSTRIKE_PRICE,@@POPTION_TYPE                
   
          IF @@FETCH_STATUS = 0
          WHILE @@FETCH_STATUS = 0 
                BEGIN
                   
                     IF  ABS(@@PNETQTY) <  ABS(@@TNETQTY)
                     BEGIN
                          SELECT @@DIFFQTY = ABS(@@PNETQTY)
                     END
                     IF  ABS(@@PNETQTY) >  ABS(@@TNETQTY)
                     BEGIN
                          SELECT @@DIFFQTY = ABS(@@TNETQTY)
                     END
 
                     IF ((@@PNETQTY + @@TNETQTY ) = 0 )   
                     BEGIN
                           IF @@TNETQTY > 0 
   			 BEGIN
                                UPDATE FOTRADE SET SETTFLAG = '6' 
                                WHERE
                                EXPIRYDATE >= @TDATE +  ' 23:59:59'
                                AND PARTY_CODE = @@TPARTY_CODE  AND EXPIRYDATE >= @TDATE + ' 23:59:59'
                                AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL 
                                AND EXPIRYDATE LIKE @@TEXPIRYDATE +'%'
                                AND STRIKE_PRICE = @@TSTRIKE_PRICE 
                                AND OPTION_TYPE = @@TOPTION_TYPE
                                AND SETTFLAG IN(8)
                           END 
                           
                           IF @@TNETQTY < 0 
                           BEGIN
                                UPDATE FOTRADE SET SETTFLAG = '7' 
                                WHERE
                                EXPIRYDATE >= @TDATE +  ' 23:59:59'
                                AND PARTY_CODE = @@TPARTY_CODE AND EXPIRYDATE >= @TDATE + ' 23:59:59'
                                AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL 
                                AND EXPIRYDATE LIKE @@TEXPIRYDATE +'%'
                                AND STRIKE_PRICE = @@TSTRIKE_PRICE 
                                AND OPTION_TYPE = @@TOPTION_TYPE
                                AND SETTFLAG IN(9)
                           END
                     END 


                     /* IF POSITION TILL YESTERDAY AND POSITION FOR TODAY ARE + THEN */ 
                     IF ( (@@PNETQTY >= 0 ) AND (@@TNETQTY > 0))   
                     BEGIN
                          UPDATE FOTRADE SET SETTFLAG = '8' 
                          WHERE
                                EXPIRYDATE >= @TDATE +  ' 23:59:59'
                                AND PARTY_CODE = @@TPARTY_CODE AND EXPIRYDATE >= @TDATE + ' 23:59:59'
                                AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL 
                                AND EXPIRYDATE LIKE @@TEXPIRYDATE +'%'
                                AND STRIKE_PRICE = @@TSTRIKE_PRICE 
                                AND OPTION_TYPE = @@TOPTION_TYPE
                                AND SETTFLAG IN(8)
                     END 

                     /* IF POSITION TILL YESTERDAY AND POSITION FOR TODAY ARE - THEN */
                     IF ( (@@PNETQTY <= 0 ) AND (@@TNETQTY < 0))   
                     BEGIN
  
		        UPDATE FOTRADE SET SETTFLAG = '9' 
                         WHERE
                                EXPIRYDATE >= @TDATE +  ' 23:59:59'
                                AND PARTY_CODE = @@TPARTY_CODE AND EXPIRYDATE >= @TDATE + ' 23:59:59'
                                AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL 
                                AND EXPIRYDATE LIKE @@TEXPIRYDATE +'%'
                                AND STRIKE_PRICE = @@TSTRIKE_PRICE 
                                AND OPTION_TYPE = @@TOPTION_TYPE
                                AND SETTFLAG IN(9)
                     END   

                     IF ( (@@PNETQTY > 0 ) AND (@@TNETQTY < 0))   
                     BEGIN
                          IF (@@PNETQTY) >= ABS(@@TNETQTY)
                          BEGIN 
			  UPDATE FOTRADE SET SETTFLAG = '7' 
 				 WHERE
                                     EXPIRYDATE >= @TDATE +  ' 23:59:59'
                                     AND PARTY_CODE = @@TPARTY_CODE AND EXPIRYDATE >= @TDATE + ' 23:59:59'
                                     AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL 
                                     AND EXPIRYDATE LIKE @@TEXPIRYDATE +'%'
                                     AND STRIKE_PRICE = @@TSTRIKE_PRICE 
                                     AND OPTION_TYPE = @@TOPTION_TYPE
                                     AND SETTFLAG IN(9)

                           END
  
                          IF ((@@PNETQTY) < ABS(@@TNETQTY)) 
                          BEGIN
                               EXEC FOTRDSETTFLAGARRANGE @@TPARTY_CODE,@@TOPTION_TYPE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TSTRIKE_PRICE,@TDATE,@@DIFFQTY,'S'
                          END
 
                          
                     END 

                     
                     IF ( (@@PNETQTY < 0 ) AND (@@TNETQTY > 0))   
                     BEGIN
                         IF ABS(@@PNETQTY) >= (@@TNETQTY)
                          BEGIN 
                             UPDATE FOTRADE SET SETTFLAG = '6' 
                             WHERE
                                  EXPIRYDATE >= @TDATE +  ' 23:59:59'
                                  AND PARTY_CODE = @@TPARTY_CODE AND EXPIRYDATE >= @TDATE + ' 23:59:59'
                                  AND INST_TYPE = @@TINST_TYPE AND SYMBOL = @@TSYMBOL 
                                  AND EXPIRYDATE LIKE @@TEXPIRYDATE +'%'
                                  AND STRIKE_PRICE = @@TSTRIKE_PRICE 
                                  AND OPTION_TYPE = @@TOPTION_TYPE
                                  AND SETTFLAG IN(8)
                          END

                          IF ABS(@@PNETQTY) < ABS(@@TNETQTY) 
  			  BEGIN
                                EXEC FOTRDSETTFLAGARRANGE @@TPARTY_CODE,@@TOPTION_TYPE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TSTRIKE_PRICE,@TDATE,@@DIFFQTY,'B'
                          END
  
                     END 
                      
                     FETCH NEXT FROM @@PPOSCUR INTO @@PPARTY_CODE, @@PNETQTY,@@PINST_TYPE ,@@PSYMBOL,@@PEXPIRYDATE,@@PSTRIKE_PRICE,@@POPTION_TYPE
                           
                END
			

CLOSE @@PPOSCUR
DEALLOCATE @@PPOSCUR
                
     FETCH NEXT FROM @@TPOSCUR INTO @@TPARTY_CODE,@@TINST_TYPE,@@TSYMBOL,@@TEXPIRYDATE,@@TNETQTY,@@TSTRIKE_PRICE,@@TOPTION_TYPE
     END
CLOSE @@TPOSCUR
DEALLOCATE @@TPOSCUR
       
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOTRDUPDEXPDT
-- --------------------------------------------------
CREATE PROC [dbo].[FOTRDUPDEXPDT] AS

  UPDATE FOTRADE SET
  EXPIRYDATE = SUBSTRING(CONVERT(VARCHAR,EXPIRYDATE,109),1,11)+ ' ' + '23:59:00'
  WHERE CONVERT(VARCHAR,EXPIRYDATE,108) = '00:00:00'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOVALANGENERATE
-- --------------------------------------------------




CREATE PROC [dbo].[FOVALANGENERATE]   
(  
 @SAUDA_DATE VARCHAR(11),  
 @USERNAME VARCHAR(50) =''  
) AS   
  
DECLARE           
@@START_DATE DATETIME,          
@@EXPIRYDATE DATETIME,          
@@SETT_NO VARCHAR(12),          
@@SETT_TYPE VARCHAR(2),          
          
@@BILLNO INT,          
@@FROMPARTY VARCHAR(10),          
@@TOPARTY VARCHAR(10),          
          
@@ACNAME VARCHAR(50),          
@@ACCODE VARCHAR(10),          
@@OPPCODE VARCHAR(10),          
@@REVCODE VARCHAR(10),          
@@DUMMYOPPCODE VARCHAR(10),          
@@DUMMYREVCODE VARCHAR(10),  
        
@@MATURITYDATE VARCHAR(17),    
@@EXPDATE VARCHAR(11),  
          
@@CLRHSGPARTY VARCHAR(10) ,          
@@BRKRELPARTY VARCHAR(10) ,          
@@SERTAXPARTY VARCHAR(10) ,          
@@CESSTAXPARTY VARCHAR(10) ,          
@@EDUCESSTAXPARTY VARCHAR(10) ,          
@@OPTEXEPARTY VARCHAR(10) ,          
@@RNDOFFPARTY VARCHAR(10) ,          
@@CARFORPARTY VARCHAR(10) ,          
@@SERTAXPAYPARTY VARCHAR(10) ,          
@@CESSTAXPAYPARTY VARCHAR(10),          
@@EDUCESSTAXPAYPARTY VARCHAR(10),          
@@INSSERTAXPARTY VARCHAR(10) ,          
@@INSSEBITAXPARTY VARCHAR(10) ,          
@@INSTURNTAXPARTY VARCHAR(10) ,          
@@INSBRKNOTEPARTY VARCHAR(10) ,          
@@REMACCPARTY VARCHAR(10) ,          
@@SEBITAXPARTY VARCHAR(10) ,          
@@TURNTAXPARTY VARCHAR(10) ,          
@@BRKNOTEPARTY VARCHAR(10) ,          
@@REVCLRHSGPARTY VARCHAR(10) ,           
@@CONCLRHSGPARTY VARCHAR(10) ,          
@@CLRPREPARTY VARCHAR(10) ,          
@@CLRCHRGPARTY VARCHAR(10) ,          
@@REVCLRCHRGPARTY VARCHAR(10) ,          
@@INSCHRGPARTY VARCHAR(10),          
@@OTHERSPARTY VARCHAR(10),          
@@DUMMYBRANCH_CD VARCHAR(10),          
@@BRANCH_CD VARCHAR(10),          
@@SELL_BUY INT,          
@@MTOM NUMERIC(36,12),          
@@PREMIUM NUMERIC(36,12),          
@@EXEASSIGN NUMERIC(36,12),          
@@BROKERAGE NUMERIC(36,12),          
@@SERVICE_TAX NUMERIC(36,12),          
@@CESS_TAX NUMERIC(36,12),          
@@EDUCESS_TAX NUMERIC(36,12),          
@@TSERVICE_TAX NUMERIC(36,12),            
@@TCESS_TAX NUMERIC(36,12),            
@@TEDUCESS_TAX NUMERIC(36,12),            
@@TBROKERAGE NUMERIC(36,12),        
@@EXSERVICE_TAX NUMERIC(36,12),          
@@TURN_TAX NUMERIC(36,12),          
@@SEBI_TAX NUMERIC(36,12),          
@@BROKER_CHRG NUMERIC(36,12),          
@@CL_CHRG NUMERIC(36,12),          
@@EXCL_CHRG NUMERIC(36,12),          
@@DIFFAMT NUMERIC(36,12),          
@@TRDAMT  NUMERIC(36,12),          
@@DELAMT  NUMERIC(36,12),          
@@OPPAMT  NUMERIC(36,12),          
@@REVAMT  NUMERIC(36,12),          
@@ACCAMT  NUMERIC(36,12),          
@@CALSERAMT  NUMERIC(36,12),          
@@INSCHRG NUMERIC(36,12),          
@@OTHERCHARGES NUMERIC(36,12),          
@@TEXSERVICE_TAX NUMERIC(36,12),          
@@TEXCESS_TAX NUMERIC(36,12),          
@@TEXEDUCESS_TAX NUMERIC(36,12),          
          
@@NETMTOM NUMERIC(36,12),          
@@NETPREMIUM NUMERIC(36,12),          
@@NETEXEASSIGN NUMERIC(36,12),          
@@NETBROKERAGE NUMERIC(36,12),          
@@NETSERVICE_TAX NUMERIC(36,12),          
@@NETCESS_TAX NUMERIC(36,12),            
@@NETEDUCESS_TAX NUMERIC(36,12),            
@@NETEXCESS_TAX NUMERIC(36,12),            
@@NETEXEDUCESS_TAX NUMERIC(36,12),            
@@NETEXSERVICE_TAX NUMERIC(36,12),          
@@NETTURN_TAX NUMERIC(36,12),          
@@NETSEBI_TAX NUMERIC(36,12),          
@@NETBROKER_CHRG NUMERIC(36,12),          
@@NETCL_CHRG NUMERIC(36,12),          
@@NETEXCL_CHRG NUMERIC(36,12),          
@@NETDIFFAMT NUMERIC(36,12),          
@@GROSSDIFFAMT NUMERIC(36,12),          
@@NETTRDAMT  NUMERIC(36,12),          
@@NETDELAMT  NUMERIC(36,12),          
@@NETINSCHRG NUMERIC(36,12),          
@@NETOTHERCHARGES NUMERIC(36,12),          
          
@@TRDSTDUTY NUMERIC(36,12),          
@@DELSTDUTY NUMERIC(36,12),          
@@STDUTY NUMERIC(36,12),          
@@TRDTTDUTY NUMERIC(36,12),          
@@DELTTDUTY NUMERIC(36,12),          
@@TTDUTY NUMERIC(36,12),          
@@TRANS_CAT VARCHAR(3),          
@@SERVICE_CHRG NUMERIC(36,12),          
@@CESS_CHRG NUMERIC(36,12),          
@@EDUCESS_CHRG NUMERIC(36,12),          
   
@@SUB_BROKER VARCHAR(10),          
@@COM_PER NUMERIC(36,12),        
@@BROKSHARE NUMERIC(36,12),          
@@NETBROKSHARE NUMERIC(36,12),          
@@GROSSBROKSHARE NUMERIC(36,12),          
          
@@SETMSTCUR CURSOR,          
@@VALANACCCUR CURSOR,          
@@VALANAMTCUR CURSOR          
          
SELECT @@NETMTOM = 0           
SELECT @@NETPREMIUM = 0           
SELECT @@NETEXEASSIGN = 0           
SELECT @@NETBROKERAGE = 0           
SELECT @@NETSERVICE_TAX = 0           
SELECT @@NETCESS_TAX = 0             
SELECT @@NETEDUCESS_TAX = 0             
SELECT @@TBROKERAGE = 0         
SELECT @@TSERVICE_TAX = 0            
SELECT @@TCESS_TAX = 0            
SELECT @@TEDUCESS_TAX = 0            
SELECT @@TEXSERVICE_TAX = 0            
SELECT @@TEXCESS_TAX = 0          
SELECT @@TEXEDUCESS_TAX = 0          
SELECT @@NETEXSERVICE_TAX = 0           
SELECT @@NETEXCESS_TAX = 0             
SELECT @@NETEXEDUCESS_TAX = 0             
SELECT @@NETTURN_TAX = 0           
SELECT @@NETSEBI_TAX = 0           
SELECT @@NETBROKER_CHRG = 0           
SELECT @@NETCL_CHRG = 0           
SELECT @@NETEXCL_CHRG = 0           
SELECT @@NETDIFFAMT = 0           
SELECT @@GROSSDIFFAMT = 0           
SELECT @@NETTRDAMT  = 0           
SELECT @@NETDELAMT  = 0          
SELECT @@NETINSCHRG  = 0          
SELECT @@NETOTHERCHARGES = 0    
          
SET @@SETMSTCUR = CURSOR FOR            
SELECT SERVICE_TAX, CESS_TAX,EDUCESS_TAX FROM FOGLOBALS  WHERE @SAUDA_DATE >= YEAR_START_DT AND @SAUDA_DATE <=  YEAR_END_DT           
OPEN @@SETMSTCUR             
FETCH NEXT FROM @@SETMSTCUR INTO @@SERVICE_CHRG, @@CESS_CHRG, @@EDUCESS_CHRG            
CLOSE @@SETMSTCUR            
DEALLOCATE @@SETMSTCUR            


SELECT TOP 1 @@MATURITYDATE = LEFT(CONVERT(VARCHAR,MATURITYDATE,109),11) + ' 23:59',
@@EXPDATE = LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11)             
FROM FOSCRIP2 WHERE  LEFT(CONVERT(VARCHAR,MATURITYDATE,109),11) LIKE @SAUDA_DATE + '%'



IF @@MATURITYDATE IS NOT NULL             
BEGIN            
  EXEC FOREARRANGEBILLFLAG @@MATURITYDATE       
 EXEC CALCULATE_STAMP_DUTY @SAUDA_DATE    
END    

EXEC PROC_TURN_TAX_UPDATE_ADNL @SAUDA_DATE,'','ZZZZZZZZZZ'    
EXEC FOVALANPOP @SAUDA_DATE,'','ZZZZZZZZZZ'          
          
DELETE FROM FOACCBILL WHERE BILLDATE   BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'  
          
  
SELECT @@START_DATE = LEFT(ISNULL(MAX(SEC_PAYIN),@SAUDA_DATE),11) FROM          
(SELECT TOP 1 SEC_PAYIN FROM MSAJAG.DBO.SETT_MST (NOLOCK)           
WHERE SEC_PAYIN  > @SAUDA_DATE           
AND SETT_TYPE = 'N' order by SEC_PAYIN) S  
  
SET @@SETT_NO = ''  
SET @@SETT_TYPE = ''  
SET @@EXPIRYDATE = @@START_DATE  
  
/* START OF PARTY BILL AMOUNT */          
          
INSERT INTO FOACCBILL            
          
SELECT  
 PARTY_CODE,BILLNO=0,          
 SELL_BUY =   
  (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 1 ELSE 2 END),   
 SETT_NO, SETT_TYPE, SAUDA_DATE, START_DATE, END_DATE, SEC_PAYIN, SEC_PAYOUT,   
 AMOUNT =  ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),   
 D1, D2, D3, D4, BRANCH_CODE, NARR  
 FROM (  
  SELECT PARTY_CODE,          
   SELL_BUY = (CASE WHEN SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE           
     THEN SBILLAMT - PBILLAMT - (SERVICE_TAX - EXSER_TAX + TURN_TAX +   
       INS_CHRG + OTHER_CHRG + SEBI_TAX + BROKER_NOTE + CL_CHRG-EXCL_CHRG)           
     ELSE -1 END ) > 0           
     THEN 2          
     ELSE 1          
     END),          
 SETT_NO=@@SETT_NO,SETT_TYPE=@@SETT_TYPE,SAUDA_DATE,START_DATE=SAUDA_DATE,  
 END_DATE=SAUDA_DATE,SEC_PAYIN=SAUDA_DATE,SEC_PAYOUT=SAUDA_DATE,          
 AMOUNT = ROUND(ABS(SUM(CASE WHEN PARTICIPANTCODE = MEMBERCODE           
    THEN SBILLAMT - PBILLAMT - (SERVICE_TAX - EXSER_TAX + TURN_TAX +   
     INS_CHRG + SEBI_TAX + OTHER_CHRG + BROKER_NOTE + CL_CHRG-EXCL_CHRG)          
    ELSE SBILLAMT + PBILLAMT + (SERVICE_TAX - EXSER_TAX + INS_CHRG + OTHER_CHRG +  
      TURN_TAX + SEBI_TAX + BROKER_NOTE + CL_CHRG-EXCL_CHRG)           
    END)),2) ,          
 D1=0,D2=0,D3=0,D4=0, BRANCH_CODE, NARR='BILL POSTED'  
FROM  
 FOBILLVALAN_TEMP , FOOWNER WHERE SAUDA_DATE  BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'  
GROUP BY  
 BRANCH_CODE,PARTY_CODE,SAUDA_DATE, PARTICIPANTCODE ,BILLNO ) A  
GROUP BY  
 PARTY_CODE, SETT_NO, SETT_TYPE, SAUDA_DATE, START_DATE, END_DATE,  
 SEC_PAYIN, SEC_PAYOUT, D1, D2, D3, D4, BRANCH_CODE, NARR  
          
  
  
/* END OF PARTY BILL AMOUNT */          
          
SET @@VALANACCCUR = CURSOR FOR          
 SELECT ACNAME,ACCODE FROM VALANACCOUNT V WHERE EFFDATE = (SELECT MAX(EFFDATE) FROM VALANACCOUNT A          
 WHERE A.EFFDATE <= @SAUDA_DATE AND V.ACNAME = A.ACNAME) ORDER BY ACNAME          
OPEN @@VALANACCCUR          
FETCH NEXT FROM @@VALANACCCUR INTO @@ACNAME,@@ACCODE          
WHILE @@FETCH_STATUS = 0           
BEGIN          
 IF @@ACNAME = 'CLEARING HOUSE'            
  SELECT @@CLRHSGPARTY = @@ACCODE          
 IF @@ACNAME = 'BROKERAGE REALISED'            
  SELECT @@BRKRELPARTY = @@ACCODE      
 IF @@ACNAME = 'SERVICE TAX'            
  SELECT @@SERTAXPARTY = @@ACCODE          
 IF @@ACNAME = 'CESS TAX'              
   SELECT @@CESSTAXPARTY = @@ACCODE            
 IF @@ACNAME = 'EDU CESS TAX'              
   SELECT @@EDUCESSTAXPARTY = @@ACCODE            
 IF @@ACNAME = 'OPTION EXERCISE'            
  SELECT @@OPTEXEPARTY = @@ACCODE          
 IF @@ACNAME = 'ROUNDING OFF'            
  SELECT @@RNDOFFPARTY = @@ACCODE          
 IF @@ACNAME = 'CARRY FORWARD CHARGE'            
  SELECT @@CARFORPARTY = @@ACCODE          
 IF @@ACNAME = 'SERVICE TAX PAYABLE'            
  SELECT @@SERTAXPAYPARTY = @@ACCODE          
 IF @@ACNAME = 'INCLUSIVE SERVICE TAX'            
  SELECT @@INSSERTAXPARTY = @@ACCODE          
 IF @@ACNAME = 'INCLUSIVE SEBI TAX'            
  SELECT @@INSSEBITAXPARTY = @@ACCODE          
 IF @@ACNAME = 'INCLUSIVE TURN TAX'            
  SELECT @@INSTURNTAXPARTY = @@ACCODE          
 IF @@ACNAME = 'INCLUSIVE STAMP TAX'            
  SELECT @@INSBRKNOTEPARTY = @@ACCODE          
 IF @@ACNAME = 'REMISSOR ACCOUNT'            
  SELECT @@REMACCPARTY = @@ACCODE          
 IF @@ACNAME = 'SEBI TAX'            
  SELECT @@SEBITAXPARTY = @@ACCODE          
 IF @@ACNAME = 'CESS TAX PAYABLE'              
   SELECT @@CESSTAXPAYPARTY = @@ACCODE            
 IF @@ACNAME = 'EDU CESS TAX PAYABLE'              
   SELECT @@EDUCESSTAXPAYPARTY = @@ACCODE            
 IF @@ACNAME = 'TURN OVER TAX'            
  SELECT @@TURNTAXPARTY = @@ACCODE          
 IF @@ACNAME = 'STAMP DUTY'            
  SELECT @@BRKNOTEPARTY = @@ACCODE          
 IF @@ACNAME = 'REVERSE CLRG HOUSE'            
  SELECT @@REVCLRHSGPARTY = @@ACCODE           
 IF @@ACNAME = 'CONS. CLRG HOUSE'            
  SELECT @@CONCLRHSGPARTY = @@ACCODE          
 IF @@ACNAME = 'CLEARING CHARGES'            
  SELECT @@CLRCHRGPARTY = @@ACCODE          
 IF @@ACNAME = 'REVERSE CLEARING CHARGES'            
  SELECT @@REVCLRCHRGPARTY = @@ACCODE          
 IF @@ACNAME = 'CLEARING PREMIUM ACCOUNT'            
  SELECT @@CLRPREPARTY = @@ACCODE          
 IF @@ACNAME = 'SECURITY TRANSACTION TAX'            
  SELECT @@INSCHRGPARTY = @@ACCODE          
 IF @@ACNAME = 'OTHER CHARGES'            
  SELECT @@OTHERSPARTY = @@ACCODE          
          
  --PRINT @@ACNAME          
          
 FETCH NEXT FROM @@VALANACCCUR INTO @@ACNAME,@@ACCODE          
END          
CLOSE @@VALANACCCUR          
DEALLOCATE @@VALANACCCUR          
          
/* EXCHANGE AND LEVIS BRANCH WISE OBLIGATION AMOUNT */          
SET @@VALANAMTCUR = CURSOR FOR           
SELECT BRANCH_CODE,          
 MTOM      = ISNULL(SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' AND PARTICIPANTCODE = MEMBERCODE AND SYMBOL <> 'BROKERAGE'  
        THEN SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT           
        ELSE 0           
          END),0),          
 PREMIUM   = ISNULL(SUM(CASE WHEN LEFT(INST_TYPE,3) = 'OPT' AND AUCTIONPART <> 'EA' AND TRADETYPE = 'BT' AND PARTICIPANTCODE = MEMBERCODE  AND SYMBOL <> 'BROKERAGE'       
THEN SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT           
        ELSE 0           
          END),0),          
 EXEASSIGN = ISNULL(SUM(CASE WHEN  LEFT(INST_TYPE,3) = 'OPT' AND AUCTIONPART = 'EA' AND TRADETYPE = 'BT' AND PARTICIPANTCODE = MEMBERCODE  AND SYMBOL <> 'BROKERAGE'        
        THEN SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT           
        ELSE 0           
END),0),          
 BROKERAGE = SUM(SBROKAMT + PBROKAMT),  
 SERVICE_TAX = SUM(FOBILLVALAN_TEMP.SERVICE_TAX),  
 EXSERVICE_TAX=SUM(EXSER_TAX),          
 TURN_TAX=SUM(TURN_TAX),SEBI_TAX=SUM(SEBI_TAX), INS_CHRG=SUM( INS_CHRG), OTHER_CHRG = SUM(FOBILLVALAN_TEMP.OTHER_CHRG),    
 BROKER_CHRG=SUM(BROKER_NOTE),CL_CHRG = SUM(CL_CHRG),EXCL_CHRG = SUM(EXCL_CHRG)           
 FROM  
 FOBILLVALAN_TEMP, FOOWNER, CLIENT1, CLIENT2, FOGLOBALS  
 WHERE  
 SAUDA_DATE  BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'  
 AND CLIENT1.CL_CODE = CLIENT2.CL_CODE  
 AND CLIENT2.PARTY_CODE = FOBILLVALAN_TEMP.PARTY_CODE  
 AND SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT  
 GROUP BY BRANCH_CODE          
 ORDER BY BRANCH_CODE          
  
OPEN @@VALANAMTCUR           
FETCH NEXT FROM @@VALANAMTCUR INTO @@BRANCH_CD,@@MTOM,@@PREMIUM,@@EXEASSIGN,@@BROKERAGE,@@SERVICE_TAX,          
                @@EXSERVICE_TAX,@@TURN_TAX,@@SEBI_TAX,@@INSCHRG,@@OTHERCHARGES,@@BROKER_CHRG,@@CL_CHRG,@@EXCL_CHRG          
WHILE @@FETCH_STATUS = 0           
BEGIN           
 SELECT @@NETMTOM = @@NETMTOM + @@MTOM          
 SELECT @@NETPREMIUM = @@NETPREMIUM + @@PREMIUM          
 SELECT @@NETEXEASSIGN = @@NETEXEASSIGN + @@EXEASSIGN           
 SELECT @@NETTURN_TAX = @@NETTURN_TAX + @@TURN_TAX          
 SELECT @@NETSEBI_TAX = @@NETSEBI_TAX + @@SEBI_TAX          
 SELECT @@NETBROKER_CHRG = @@NETBROKER_CHRG + @@BROKER_CHRG           
 SELECT @@NETCL_CHRG = @@NETCL_CHRG + @@CL_CHRG          
 SELECT @@NETEXCL_CHRG = @@NETEXCL_CHRG + @@EXCL_CHRG          
 SELECT @@NETINSCHRG  = @@NETINSCHRG + @@INSCHRG          
 SELECT @@NETOTHERCHARGES = @@NETOTHERCHARGES + @@OTHERCHARGES    
 SELECT @@TSERVICE_TAX =  @@SERVICE_TAX            
 SELECT @@TEXSERVICE_TAX =  @@EXSERVICE_TAX             
   
 if (@@CESS_Chrg+@@EDUCESS_Chrg) > 0                   
 BEGIN  
 SELECT @@TCESS_TAX = @@SERVICE_TAX - ROUND(( @@SERVICE_TAX * 100 ) / ( 100 + (@@CESS_CHRG+@@EDUCESS_CHRG) ),2)            
 SELECT @@TEDUCESS_TAX = ROUND(@@TCESS_TAX*@@EDUCESS_CHRG/(@@CESS_CHRG+@@EDUCESS_CHRG),2)            
 END  
 ELSE  
 BEGIN  
 Select @@TCESS_Tax = 0  
 Select @@TEDUCESS_Tax = 0  
 END  
  
 SELECT @@TCESS_TAX = @@TCESS_TAX - @@TEDUCESS_TAX           
 SELECT @@TSERVICE_TAX = @@SERVICE_TAX - @@TCESS_TAX - @@TEDUCESS_TAX         
    
                   
 if (@@CESS_Chrg+@@EDUCESS_Chrg) > 0                   
 BEGIN     
                
 SELECT @@TEXCESS_TAX = @@TEXSERVICE_TAX - ROUND(( @@TEXSERVICE_TAX * 100 ) / ( 100 + (@@CESS_CHRG+@@EDUCESS_CHRG)),2)              
 SELECT @@TEXEDUCESS_TAX = ROUND(@@TEXCESS_TAX*@@EDUCESS_CHRG/(@@CESS_CHRG+@@EDUCESS_CHRG),2)            
  END  
 ELSE  
 BEGIN    
  Select @@TExCESS_Tax = 0  
  Select @@TExEDUCESS_Tax = 0  
 END  
  
  
 SELECT @@TEXCESS_TAX = @@TEXCESS_TAX - @@TEXEDUCESS_TAX           
 SELECT @@TEXSERVICE_TAX = @@TEXSERVICE_TAX - @@TEXCESS_TAX - @@TEXEDUCESS_TAX   
  
 SELECT @@NETCESS_TAX = @@NETCESS_TAX + @@TCESS_TAX            
 SELECT @@NETEDUCESS_TAX = @@NETEDUCESS_TAX + @@TEDUCESS_TAX            
 SELECT @@NETEXCESS_TAX = @@NETEXCESS_TAX + @@TEXCESS_TAX             
 SELECT @@NETEXEDUCESS_TAX = @@NETEXEDUCESS_TAX + @@TEXEDUCESS_TAX             
          
 SELECT @@NETEXSERVICE_TAX = @@NETEXSERVICE_TAX + @@TEXSERVICE_TAX            
 SELECT @@NETSERVICE_TAX = @@NETSERVICE_TAX + @@TSERVICE_TAX          
 SELECT @@TBROKERAGE = @@BROKERAGE        
 SELECT @@NETBROKERAGE = @@NETBROKERAGE + @@TBROKERAGE          
           
                   
          
          
 IF @@MTOM > 0           
  SELECT @@SELL_BUY = 1            
 ELSE          
  SELECT @@SELL_BUY = 2         
            
 INSERT INTO FOACCBILL VALUES ( @@CLRHSGPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(ABS(@@MTOM),2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')           
              
 IF @@PREMIUM > 0           
  SELECT @@SELL_BUY = 1            
 ELSE          
  SELECT @@SELL_BUY = 2          
            
 INSERT INTO FOACCBILL VALUES ( @@CLRPREPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(ABS(@@PREMIUM),2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
          
 IF @@EXEASSIGN > 0           
  SELECT @@SELL_BUY = 1            
 ELSE          
  SELECT @@SELL_BUY = 2          
            
 INSERT INTO FOACCBILL VALUES ( @@OPTEXEPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(ABS(@@EXEASSIGN),2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
          
 INSERT INTO FOACCBILL VALUES ( @@BRKRELPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@TBROKERAGE,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')           
        
          
          
 INSERT INTO FOACCBILL VALUES ( @@SERTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@TSERVICE_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
          
            
 INSERT INTO FOACCBILL VALUES (@@INSSERTAXPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@TEXSERVICE_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
          
          
 IF ROUND(@@TCESS_TAX,2) <> 0           
 BEGIN          
   INSERT INTO FOACCBILL VALUES (@@CESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@TCESS_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
 END          
  
 IF ROUND(@@TEDUCESS_TAX,2) <> 0           
 BEGIN          
   INSERT INTO FOACCBILL VALUES (@@EDUCESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@TEDUCESS_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
 END          
          
          
  IF ROUND(@@TEXCESS_TAX,2) <> 0          
   BEGIN          
    INSERT INTO FOACCBILL VALUES (@@CESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@TEXCESS_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
  END          
          
  IF ROUND(@@TEXEDUCESS_TAX,2) <> 0          
   BEGIN          
    INSERT INTO FOACCBILL VALUES (@@EDUCESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@TEXEDUCESS_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
  END          
  
          
 INSERT INTO FOACCBILL VALUES ( @@TURNTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@TURN_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')   
      
INSERT INTO FOACCBILL VALUES ( @@SEBITAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@SEBI_TAX,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
          
 INSERT INTO FOACCBILL VALUES ( @@BRKNOTEPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@BROKER_CHRG,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
          
 INSERT INTO FOACCBILL VALUES ( @@CLRCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@CL_CHRG,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
            
 INSERT INTO FOACCBILL VALUES ( @@REVCLRCHRGPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@EXCL_CHRG,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
          
 INSERT INTO FOACCBILL VALUES ( @@INSCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@INSCHRG,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
          
 INSERT INTO FOACCBILL VALUES ( @@OTHERSPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@OTHERCHARGES,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
        
          
 FETCH NEXT FROM @@VALANAMTCUR INTO @@BRANCH_CD,@@MTOM,@@PREMIUM,@@EXEASSIGN,@@BROKERAGE,@@SERVICE_TAX,          
                      @@EXSERVICE_TAX,@@TURN_TAX,@@SEBI_TAX,@@INSCHRG,@@OTHERCHARGES,@@BROKER_CHRG,@@CL_CHRG,@@EXCL_CHRG          
          
END          
CLOSE @@VALANAMTCUR          
DEALLOCATE @@VALANAMTCUR          
          
SELECT @@NETBROKSHARE = 0          
SELECT @@GROSSBROKSHARE = 0          
          
SET @@VALANAMTCUR = CURSOR FOR          
SELECT SB.SUB_BROKER,COM_PERC, BRANCH_CD, BROKERAGE = SUM(PBROKAMT+SBROKAMT)*COM_PERC/100          
FROM FOBILLVALAN_TEMP S, CLIENT2 C2,CLIENT1 C1,SUBBROKERS SB          
WHERE S.PARTY_CODE = C2.PARTY_CODE AND C1.CL_CODE = C2.CL_CODE           
AND C1.SUB_BROKER = SB.SUB_BROKER           
AND SB.COM_PERC > 0           
AND S.SAUDA_DATE  BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'  
GROUP BY SB.SUB_BROKER,COM_PERC,BRANCH_CD          
ORDER BY SB.SUB_BROKER,BRANCH_CD          
OPEN @@VALANAMTCUR           
FETCH NEXT FROM @@VALANAMTCUR INTO @@SUB_BROKER,@@COM_PER,@@BRANCH_CD,@@BROKSHARE          
WHILE @@FETCH_STATUS = 0            
BEGIN          
 SELECT @@DUMMYBRANCH_CD = @@BRANCH_CD          
 WHILE @@DUMMYBRANCH_CD = @@BRANCH_CD AND @@FETCH_STATUS = 0            
 BEGIN          
  SELECT @@NETBROKSHARE = @@NETBROKSHARE + @@BROKSHARE          
  SELECT @@GROSSBROKSHARE = @@GROSSBROKSHARE + @@BROKSHARE          
          
  INSERT INTO FOACCBILL VALUES ( @@SUB_BROKER,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
               ROUND(@@BROKSHARE,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')          
             
  FETCH NEXT FROM @@VALANAMTCUR INTO @@SUB_BROKER,@@COM_PER,@@BRANCH_CD ,@@BROKSHARE         
 END          
/*      
 INSERT INTO FOACCBILL VALUES ( @@REMACCPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
       ROUND(@@NETBROKSHARE,2),0,0,0,0,@@BRANCH_CD,'BILL POSTED')     
*/      
 SELECT @@NETBROKSHARE = 0          
END          
          
SET @@VALANAMTCUR = CURSOR FOR          
 SELECT AMOUNT = ISNULL(SUM(AMOUNT),0),BRANCHCD,SELL_BUY FROM FOACCBILL WHERE           
 BILLDATE  BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'  
 AND BRANCHCD <> 'ZZZ'          
 GROUP BY BRANCHCD,SELL_BUY           
 ORDER BY BRANCHCD,SELL_BUY          
OPEN @@VALANAMTCUR           
FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@BRANCH_CD,@@SELL_BUY          
WHILE @@FETCH_STATUS = 0            
BEGIN          
 SELECT @@DUMMYBRANCH_CD = @@BRANCH_CD          
 SELECT @@NETDIFFAMT = 0          
 WHILE @@DUMMYBRANCH_CD = @@BRANCH_CD AND @@FETCH_STATUS = 0         
BEGIN          
  IF @@SELL_BUY = 1           
  BEGIN          
  SELECT @@NETDIFFAMT = @@NETDIFFAMT + @@DIFFAMT          
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT + @@DIFFAMT          
  END           
  ELSE          
  BEGIN                                  
   SELECT @@NETDIFFAMT = @@NETDIFFAMT - @@DIFFAMT           
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT - @@DIFFAMT         
END      
  FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@BRANCH_CD,@@SELL_BUY            
 END          
 IF @@NETDIFFAMT > 0           
  INSERT INTO FOACCBILL VALUES ( @@RNDOFFPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(ABS(@@NETDIFFAMT),2),0,0,0,0,@@DUMMYBRANCH_CD,'BILL POSTED')          
 ELSE IF @@NETDIFFAMT < 0           
  INSERT INTO FOACCBILL VALUES ( @@RNDOFFPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(ABS(@@NETDIFFAMT),2),0,0,0,0,@@DUMMYBRANCH_CD,'BILL POSTED')          
           
END          
CLOSE @@VALANAMTCUR          
DEALLOCATE @@VALANAMTCUR          
          
 IF @@NETMTOM > 0           
  SELECT @@SELL_BUY = 1            
 ELSE          
  SELECT @@SELL_BUY = 2          
            
 INSERT INTO FOACCBILL VALUES ( @@CLRHSGPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(ABS(@@NETMTOM),2),0,0,0,0,'ZZZ','BILL POSTED')           
              
 IF @@NETPREMIUM > 0           
  SELECT @@SELL_BUY = 1            
 ELSE          
  SELECT @@SELL_BUY = 2          
            
 INSERT INTO FOACCBILL VALUES ( @@CLRPREPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(ABS(@@NETPREMIUM),2),0,0,0,0,'ZZZ','BILL POSTED')          
          
 IF @@NETEXEASSIGN > 0           
  SELECT @@SELL_BUY = 1            
 ELSE          
  SELECT @@SELL_BUY = 2          
            
 INSERT INTO FOACCBILL VALUES ( @@OPTEXEPARTY,0,@@SELL_BUY,@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(ABS(@@NETEXEASSIGN),2),0,0,0,0,'ZZZ','BILL POSTED')          
          
 INSERT INTO FOACCBILL VALUES ( @@BRKRELPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@NETBROKERAGE,2),0,0,0,0,'ZZZ','BILL POSTED')          
          
 INSERT INTO FOACCBILL VALUES ( @@SERTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@NETSERVICE_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          
          
 IF ROUND(@@NETCESS_TAX,2) <> 0           
  BEGIN          
   INSERT INTO FOACCBILL VALUES ( @@CESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@NETCESS_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          
  END          
  
 IF ROUND(@@NETEDUCESS_TAX,2) <> 0           
  BEGIN          
   INSERT INTO FOACCBILL VALUES ( @@EDUCESSTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@NETEDUCESS_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          
  END          
  
 IF ROUND(@@NETEXCESS_TAX,2) <> 0           
  BEGIN          
   INSERT INTO FOACCBILL VALUES ( @@CESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@NETEXCESS_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          
  END          
          
  
 IF ROUND(@@NETEXEDUCESS_TAX,2) <> 0           
  BEGIN          
   INSERT INTO FOACCBILL VALUES ( @@EDUCESSTAXPAYPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@NETEXEDUCESS_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          
  END          
          
            
 INSERT INTO FOACCBILL VALUES ( @@INSSERTAXPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@NETEXSERVICE_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          
          
 INSERT INTO FOACCBILL VALUES ( @@TURNTAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@NETTURN_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          
           
 INSERT INTO FOACCBILL VALUES ( @@SEBITAXPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@NETSEBI_TAX,2),0,0,0,0,'ZZZ','BILL POSTED')          
          
 INSERT INTO FOACCBILL VALUES ( @@BRKNOTEPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@NETBROKER_CHRG,2),0,0,0,0,'ZZZ','BILL POSTED')          
          
 INSERT INTO FOACCBILL VALUES ( @@CLRCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,    
         ROUND(@@NETCL_CHRG,2),0,0,0,0,'ZZZ','BILL POSTED')          
            
 INSERT INTO FOACCBILL VALUES ( @@REVCLRCHRGPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@NETEXCL_CHRG,2),0,0,0,0,'ZZZ','BILL POSTED')          
/*          
 INSERT INTO FOACCBILL VALUES ( @@REMACCPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@GROSSBROKSHARE,2),0,0,0,0,'ZZZ','BILL POSTED')         
*/          
 INSERT INTO FOACCBILL VALUES ( @@INSCHRGPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@NETINSCHRG,2),0,0,0,0,'ZZZ','BILL POSTED')          
          
 INSERT INTO FOACCBILL VALUES ( @@OTHERSPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(@@NETOTHERCHARGES,2),0,0,0,0,'ZZZ','BILL POSTED')          
          
SELECT @@OPPAMT = 0          
          
SET @@VALANAMTCUR = CURSOR FOR          
 SELECT OPPCODE,REVCODE,ACCODE FROM VALANACCOUNT WHERE REVERSED = 1           
 AND EFFDATE = (SELECT MIN(EFFDATE) FROM VALANACCOUNT          
 WHERE EFFDATE <= @SAUDA_DATE ) ORDER BY OPPCODE,REVCODE          
OPEN @@VALANAMTCUR           
FETCH NEXT FROM @@VALANAMTCUR INTO @@OPPCODE,@@REVCODE,@@ACCODE           
WHILE @@FETCH_STATUS =  0          
BEGIN          
 SELECT @@DUMMYOPPCODE = @@OPPCODE          
 WHILE @@DUMMYOPPCODE = @@OPPCODE AND @@FETCH_STATUS =  0          
 BEGIN          
  SELECT @@REVAMT = 0          
  SELECT @@DUMMYREVCODE = @@REVCODE          
  WHILE @@DUMMYREVCODE = @@REVCODE AND @@DUMMYOPPCODE = @@OPPCODE AND @@FETCH_STATUS =  0          
  BEGIN          
   SET @@VALANACCCUR = CURSOR FOR          
    SELECT AMOUNT,SELL_BUY FROM FOACCBILL WHERE BILLDATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'  
    AND PARTY_CODE = @@ACCODE AND BRANCHCD = 'ZZZ'          
   OPEN @@VALANACCCUR           
   FETCH NEXT FROM @@VALANACCCUR INTO @@ACCAMT,@@SELL_BUY          
          
   IF @@FETCH_STATUS =  0          
   BEGIN          
    IF @@SELL_BUY = 1           
    BEGIN          
     SELECT @@REVAMT = @@REVAMT + @@ACCAMT          
     SELECT @@OPPAMT = @@OPPAMT + @@ACCAMT          
    END          
    ELSE          
    BEGIN          
     SELECT @@REVAMT = @@REVAMT - @@ACCAMT          
     SELECT @@OPPAMT = @@OPPAMT - @@ACCAMT          
    END          
   END        
   ELSE          
   CLOSE @@VALANACCCUR          
  DEALLOCATE @@VALANACCCUR          
   FETCH NEXT FROM @@VALANAMTCUR INTO @@OPPCODE,@@REVCODE,@@ACCODE           
  END          
  IF @@REVAMT > 0           
   INSERT INTO FOACCBILL VALUES ( @@DUMMYREVCODE,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
          ROUND(ABS(@@REVAMT),2),0,0,0,0,'ZZZ','BILL POSTED')          
  ELSE          
   INSERT INTO FOACCBILL VALUES ( @@DUMMYREVCODE,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
   ROUND(ABS(@@REVAMT),2),0,0,0,0,'ZZZ','BILL POSTED')          
 END           
 IF @@OPPAMT > 0          
  INSERT INTO FOACCBILL VALUES ( @@DUMMYOPPCODE,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(ABS(@@OPPAMT),2),0,0,0,0,'ZZZ','BILL POSTED')            
 ELSE          
  INSERT INTO FOACCBILL VALUES ( @@DUMMYOPPCODE,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
         ROUND(ABS(@@OPPAMT),2),0,0,0,0,'ZZZ','BILL POSTED')          
END          
CLOSE @@VALANAMTCUR          
DEALLOCATE @@VALANAMTCUR          
          
SELECT @@GROSSDIFFAMT = 0          
          
SET @@VALANAMTCUR = CURSOR FOR          
          
SELECT AMOUNT = ISNULL(SUM(AMOUNT),0),SELL_BUY FROM FOACCBILL A,ACCOUNTCURBFO.DBO.ACMAST M           
WHERE BILLDATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'  
AND A.PARTY_CODE = M.CLTCODE AND (BRANCHCD = 'ZZZ' OR ACCAT = 4 )          
GROUP BY SELL_BUY          
          
OPEN @@VALANAMTCUR           
FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@SELL_BUY          
WHILE @@FETCH_STATUS = 0            
BEGIN    
 BEGIN    
  IF @@SELL_BUY = 1           
  BEGIN            
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT + @@DIFFAMT          
  END           
  ELSE          
  BEGIN                              
   SELECT @@GROSSDIFFAMT = @@GROSSDIFFAMT - @@DIFFAMT                   
  END          
  FETCH NEXT FROM @@VALANAMTCUR INTO @@DIFFAMT,@@SELL_BUY          
 END          
END          
CLOSE @@VALANAMTCUR          
DEALLOCATE @@VALANAMTCUR          
          
          
IF @@GROSSDIFFAMT > 0           
 INSERT INTO FOACCBILL VALUES ( @@RNDOFFPARTY,0,'2',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
        ROUND(ABS(@@GROSSDIFFAMT),2),0,0,0,0,'ZZZ','BILL POSTED')          
ELSE           
 INSERT INTO FOACCBILL VALUES ( @@RNDOFFPARTY,0,'1',@@SETT_NO,@@SETT_TYPE,@SAUDA_DATE,@@START_DATE,@@EXPIRYDATE,@@EXPIRYDATE,@@EXPIRYDATE,          
        ROUND(ABS(@@GROSSDIFFAMT),2),0,0,0,0,'ZZZ','BILL POSTED')          
          
            
DELETE FROM FOACCBILL WHERE AMOUNT = 0 AND BILLDATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'  
          
EXEC FOGENBILLNO @SAUDA_DATE         
      
      
              
             
DELETE FROM FOBILLVALAN WHERE SAUDA_DATE  BETWEEN @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'  
                  
INSERT INTO FOBILLVALAN                   
SELECT * FROM FOBILLVALAN_TEMP                  
  
  
TRUNCATE TABLE FOBILLVALAN_TEMP  
  
  
/*------------------------- PROCESS CONTROLER PLUG IN --------------------------------*/  
UPDATE   
 V2_BUSINESS_PROCESS   
SET   
 BILLING = BILLING + 1 ,  
 LASTUPDATEDATE = GETDATE()  
  
WHERE   
 LEFT(BUSINESS_DATE,11) = @SAUDA_DATE  
  
  
INSERT INTO V2_PROCESS_STATUS_LOG   
(   
 EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,  
 FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP  
)  
SELECT  
 EXCHANGE=(SELECT TOP 1 EXCHANGE FROM FOTAXES),  
 SEGMENT='FUTURES',  
 BUSINESSDATE=@SAUDA_DATE,  
 PROCESSID = 'VALANGEN',  
 PROCESSNAME = 'VALAN GENERATION',  
 FILENAME='',  
 START_END_FLAG=1,  
 PROCESSDATE=GETDATE(),  
 PROCESSBY=@USERNAME,  
 MACHINEIP=''  
  
/*------------------------- PROCESS CONTROLER PLUG IN --------------------------------*/  
  
  EXEC VALAN_ADDITIONAL_PROCESS @Sauda_Date 
  EXEC VALANGENERATE_CLCHRG @SAUDA_DATE
  EXEC VALAN_GST_BILLPOST @SAUDA_DATE
  EXEC VALAN_INTEROP @SAUDA_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.FOVALANPOP
-- --------------------------------------------------

CREATE PROC [dbo].[FOVALANPOP](
           @SDATE  VARCHAR(11),
           @FPARTY VARCHAR(12)='',
           @TPARTY VARCHAR(12)='ZZZZZZZZZ')
AS

  DECLARE  @MDATE           VARCHAR(11),
           @INTCLOSINGCOUNT INT
  
  DECLARE  @CHKPARTY DATETIME,
           @CHKDATE  INT
                     
  SELECT @INTCLOSINGCOUNT = COUNT(* )
  FROM   FOCLOSING (NOLOCK)
  WHERE  TRADE_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
                                                
  IF @INTCLOSINGCOUNT = 0
    BEGIN
      SELECT @INTCLOSINGCOUNT = COUNT(1)
      FROM   FOSETTLEMENT (NOLOCK)
      WHERE  SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
    END
    
  IF @INTCLOSINGCOUNT > 0
    BEGIN
    
    /*------------------------------------------------- 
		FOSETTLEMNT - MARKETTYPE =0 : ACTIVE  TRADES
		FOSETTLEMNT - MARKETTYPE =1 : PASSIVE  TRADES		
    ---------------------------------------------------*/
    IF CONVERT(DATETIME,@SDATE) >= 'DEC  1 2014'
    BEGIN
		UPDATE FOSETTLEMENT SET TURN_TAX =0 WHERE SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
		AND MARKETTYPE ='1'  -- NO TURN TAX FOR PASSIVE TRADES
    END
    
		EXEC CALCULATESTAMPDUTY @SDATE

      SELECT @INTCLOSINGCOUNT = SUM(INSURANCE_CHRG_AC + TURNOVER_AC + SEBI_TURN_AC + BROKER_NOTE_AC + OTHER_CHRG_AC)
      FROM   FOGLOBALS (NOLOCK)
      WHERE  @SDATE BETWEEN YEAR_START_DT AND YEAR_END_DT
                                              
      IF @INTCLOSINGCOUNT > 0
        BEGIN
          /*---------------------------------------------------------------------------------------*/
          UPDATE FOSETTLEMENT
          SET    SERVICE_TAX = ((TRADEQTY * BROKAPPLIED ) + (CASE 
                      WHEN G.INSURANCE_CHRG_AC = 1
                           AND C2.INSURANCE_CHRG = 1 THEN FOSETTLEMENT.INS_CHRG
                      ELSE 0
                    END) + (CASE 
                              WHEN G.TURNOVER_AC = 1
                                   AND C2.TURNOVER_TAX = 1 THEN FOSETTLEMENT.TURN_TAX
                              ELSE 0
                            END) + (CASE 
                      WHEN G.SEBI_TURN_AC = 1
                           AND C2.SEBI_TURN_TAX = 1 THEN FOSETTLEMENT.SEBI_TAX
                      ELSE 0
                    END) + (CASE 
                      WHEN G.BROKER_NOTE_AC = 1
                           AND C2.BROKERNOTE = 1 THEN FOSETTLEMENT.BROKER_CHRG
                      ELSE 0
                    END) + (CASE 
                      WHEN G.OTHER_CHRG_AC = 1
                           AND C2.OTHER_CHRG = 1 THEN FOSETTLEMENT.OTHER_CHRG
                      ELSE 0
                    END)) * G.SERVICE_TAX / 100
 	 FROM   FOGLOBALS G,
                 CLIENT2 C2
          WHERE  SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
                 AND SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT
                 AND FOSETTLEMENT.PARTY_CODE = C2.PARTY_CODE
                 AND SERVICE_CHRG + SERVICE_CHRG + SERTAXMETHOD <> 3
        END
      

      SELECT *
      INTO     #FOSCRIP2
      FROM     FOSCRIP2 (NOLOCK)
      WHERE    FOSCRIP2.MATURITYDATE >= @SDATE
      ORDER BY INST_TYPE,
               SYMBOL,
               STRIKE_PRICE,
               OPTION_TYPE,
               EXPIRYDATE
               
      SELECT @MDATE = ISNULL(MIN(EXPIRYDATE),@SDATE)
      FROM   #FOSCRIP2
             
      SELECT *
      INTO   #FOCLOSING
      FROM   FOCLOSING (NOLOCK)
      WHERE  FOCLOSING.TRADE_DATE = (SELECT MAX(TRADE_DATE)
                                     FROM   FOCLOSING
                                     WHERE  FOCLOSING.TRADE_DATE < @SDATE)
                                    
      SELECT *
      INTO   #FOCLOSINGTODAY
      FROM   FOCLOSING (NOLOCK)
      WHERE  FOCLOSING.TRADE_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
                                                
      SELECT CONTRACTNO,
             BILLNO,
             TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO),
             PARTY_CODE,
             INST_TYPE,
             SYMBOL,
             SEC_NAME,
             EXPIRYDATE,
             STRIKE_PRICE,
             OPTION_TYPE,
             TRADEQTY = SUM(TRADEQTY),
             AUCTIONPART,
             MARKETTYPE,
             SERIES,
             ORDER_NO,
             PRICE,
             SAUDA_DATE,
        SELL_BUY,
   BROKAPPLIED = SUM(TRADEQTY * BROKAPPLIED) / SUM(TRADEQTY),
             NETRATE = SUM(TRADEQTY * NETRATE) / SUM(TRADEQTY),
             AMOUNT = SUM(AMOUNT),
             INS_CHRG = SUM(INS_CHRG),
             TURN_TAX = SUM(TURN_TAX),
             OTHER_CHRG = SUM(OTHER_CHRG),
             SEBI_TAX = SUM(SEBI_TAX),
             BROKER_CHRG = SUM(BROKER_CHRG),
             SERVICE_TAX = SUM(SERVICE_TAX),
             TRADE_AMOUNT = SUM(TRADE_AMOUNT),
             SETT_NO,
             NBROKAPP = 0,
             NSERTAX = 0,
             N_NETRATE = 0,
             SETT_TYPE,
             BILLFLAG = 0,
             CL_RATE,
             PARTICIPANTCODE,
             STATUS,
             RESERVED1,
             RESERVED2,
             TOTALBROK = CONVERT(NUMERIC(36, 12),0),
             TOTALSER = CONVERT(NUMERIC(36, 12),0)
      INTO     #FOSETTLEMENT
      FROM     FOSETTLEMENT (NOLOCK)
      WHERE    EXPIRYDATE >= @MDATE
               AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY
               AND TRADEQTY > 0
      GROUP BY CONTRACTNO,BILLNO,PRADNYA.DBO.REPLACETRADENO(TRADE_NO),PARTY_CODE,
               INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,
               STRIKE_PRICE,OPTION_TYPE,AUCTIONPART,MARKETTYPE,
               SERIES,ORDER_NO,PRICE,SAUDA_DATE,
               SELL_BUY,SETT_NO,SETT_TYPE,CL_RATE,
               PARTICIPANTCODE,STATUS,RESERVED1,RESERVED2
      ORDER BY PARTY_CODE,
               INST_TYPE,
               SYMBOL,
               EXPIRYDATE,
               STRIKE_PRICE,
               OPTION_TYPE,
               SAUDA_DATE
               
      UPDATE #FOSETTLEMENT
      SET    TOTALBROK = CD_TOT_BROK,
             TOTALSER = SERVICE_TAX + CD_TOT_SERTAX
      FROM   CHARGES_DETAIL (NOLOCK)
      WHERE  LEFT(CD_SAUDA_DATE,11) = @SDATE
             AND LEFT(CD_SAUDA_DATE,11) = LEFT(SAUDA_DATE,11)
             AND CD_PARTY_CODE = PARTY_CODE
             AND CD_INST_TYPE = INST_TYPE
             AND CD_SYMBOL = SYMBOL
             AND CD_EXPIRY_DATE = EXPIRYDATE
             AND CD_STRIKE_PRICE = STRIKE_PRICE
             AND CD_OPTION_TYPE = OPTION_TYPE
             AND CD_TRADE_NO = TRADE_NO
                               
      SELECT *
      INTO   #FOTMCLCHRG
      FROM   FOTMCLCHRG (NOLOCK)
      WHERE  SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
             AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY
                                                
      SELECT *
      INTO   #CLIENT2
      FROM   CLIENT2 (NOLOCK)
      WHERE  PARTY_CODE IN (SELECT DISTINCT PARTY_CODE
                            FROM   #FOSETTLEMENT)
                           
      SELECT *
      INTO   #CLIENT1
      FROM   CLIENT1 (NOLOCK)
      WHERE  CL_CODE IN (SELECT CL_CODE
                         FROM   #CLIENT2)
                        
      CREATE CLUSTERED INDEX [IDXSYMBOL] ON [DBO].[#CLIENT2] (
            [PARTY_CODE],
            [CL_CODE])
      
      CREATE CLUSTERED INDEX [IDXSYMBOL] ON [DBO].[#CLIENT1] (
            [CL_CODE])
      
    
      
      TRUNCATE TABLE FOBILLVALAN_TEMP
      
      /* BROUGHT FORWARD TRADES */
      INSERT INTO FOBILLVALAN_TEMP
      SELECT   S.PARTY_CODE,
               LONG_NAME = SHORT_NAME,
               CLIENT_TYPE = CL_TYPE,
               BILLNO,
               0 CONTRACTNO,
               S.INST_TYPE,
               S.SYMBOL,
               S.EXPIRYDATE,
				S.OPTION_TYPE,
           S.STRIKE_PRICE,
               ''           

                           AUCTIONPART,
               F.MATURITYDATE,
               SAUDA_DATE = @SDATE + ' 23:59',
               ISIN = '',
               PQTY = SUM(CASE 
                            WHEN SELL_BUY = 1 THEN S.TRADEQTY
                            ELSE 0
    END),
    SQTY = SUM(CASE 
              WHEN SELL_BUY = 2 THEN S.TRADEQTY
                            ELSE 0
                          END),
PRATE = ROUND((CASE 
                                WHEN SUM(CASE 
                                           WHEN SELL_BUY = 1 THEN S.TRADEQTY
                                           ELSE 0
                                         END) > 0 THEN SUM(CASE 
                                                             WHEN SELL_BUY = 1 THEN CONVERT(NUMERIC(36, 12),S.TRADEQTY * PRICE)
                                                             ELSE 0
                                                           END) / SUM(CASE 
                                                                        WHEN SELL_BUY = 1 THEN CONVERT(NUMERIC(36, 12),S.TRADEQTY)
                                                                        ELSE 0
                                                                      END)
                                ELSE 0
                              END),12),
               SRATE = ROUND((CASE 
                                WHEN SUM(CASE 
                                           WHEN SELL_BUY = 2 THEN S.TRADEQTY
                                           ELSE 0
                                         END) > 0 THEN SUM(CASE 
                                                             WHEN SELL_BUY = 2 THEN CONVERT(NUMERIC(36, 12),S.TRADEQTY * PRICE)
                                                             ELSE 0
                                                           END) / SUM(CASE 
                                                                        WHEN SELL_BUY = 2 THEN CONVERT(NUMERIC(36, 12),S.TRADEQTY)
                                                                        ELSE 0
                                                                      END)
                                ELSE 0
                              END),12),
               PAMT = ROUND(SUM(CASE 
                                  WHEN SELL_BUY = 1 THEN (S.TRADEQTY * NETRATE ) + (CASE 
                                                                                                             WHEN C2.SERVICE_CHRG = 1 THEN SERVICE_TAX
                                                                                                             ELSE 0
                                                                                                           END)
                                  ELSE 0
                                END),12),
               SAMT = ROUND(SUM(CASE 
                                  WHEN SELL_BUY = 2 THEN (S.TRADEQTY * NETRATE ) + (CASE 
                                                                                                             WHEN C2.SERVICE_CHRG = 1 THEN SERVICE_TAX
                                                                                                             ELSE 0
                                                                                                           END)
                                  ELSE 0
                                END),12),
               PBROKAMT = 0,
               SBROKAMT = 0,
               PBILLAMT = 0,
               SBILLAMT = 0,
       CL_RATE = 0,
             CL_CHRG = 0,
               EXCL_CHRG = 0,
               SERVICE_TAX = 0,
               EXSER_TAX = 0,
               INEXSERFLAG = SERVICE_CHRG,
               SEBI_TAX = 0,
     TURN_TAX = 0,
               BROKER_NOTE = 0,
               INS_CHRG = 0,
               OTHER_CHRG = 0,
               TRADETYPE = 'BF',
               PARTICIPANTCODE = MEMBERCODE,
               TERMINAL_ID = '',
               FAMILY,
               FAMILYNAME = '',
               TRADER,
               BRANCH_CODE = BRANCH_CD,
               SUB_BROKER,
               STATUSNAME = '',
      EXCHANGE = 'MFO',
               SEGMENT = 'FUTURE',
               MEMBERTYPE,
             COMPANYNAME = '',
               REGION,
               UPDATEDATE = LEFT(CONVERT(VARCHAR,GETDATE(),109),11),
      EMAIL = C1.EMAIL,
           DUMMY2 = '',
               DUMMY3 = '',
               DUMMY4 = 0,
               DUMMY5 = 0,
               CMCLOSING = 0,
               TRACK = '',
               C1.AREA
      FROM     #FOSCRIP2 F,
               #FOSETTLEMENT S,
               FOOWNER,
               #CLIENT1 C1,
               #CLIENT2 C2
      WHERE    SAUDA_DATE < @SDATE
               AND F.INST_TYPE = S.INST_TYPE
               AND F.SYMBOL = S.SYMBOL
               AND CONVERT(VARCHAR,S.EXPIRYDATE,103) = CONVERT(VARCHAR,F.EXPIRYDATE,103)
               AND F.STRIKE_PRICE = S.STRIKE_PRICE
               AND F.OPTION_TYPE = S.OPTION_TYPE
               AND F.MATURITYDATE >= @SDATE
               AND S.PARTY_CODE = C2.PARTY_CODE
               AND C2.CL_CODE = C1.CL_CODE
               AND S.RESERVED1 <> 1
      GROUP BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,F.MATURITYDATE,
               S.STRIKE_PRICE,S.OPTION_TYPE,S.EXPIRYDATE,SHORT_NAME,
               CL_TYPE,BILLNO,SERVICE_CHRG,PARTICIPANTCODE,
               FAMILY,TRADER,BRANCH_CD,SUB_BROKER,
               MEMBERTYPE,MEMBERCODE,DUMMY8,DUMMY9,
               DUMMY10,C1.EMAIL,C1.AREA,REGION
      
      
      /* TODAYS TRADE */
      INSERT INTO FOBILLVALAN_TEMP
      SELECT   S.PARTY_CODE,
               LONG_NAME = SHORT_NAME,
               CLIENT_TYPE = CL_TYPE,
               BILLNO,
               CONTRACTNO,
               S.INST_TYPE,
               S.SYMBOL,
               S.EXPIRYDATE,
               S.OPTION_TYPE,
               S.STRIKE_PRICE,
               S.AUCTIONPART,
               F.MATURITYDATE,
               SAUDA_DATE = @SDATE + ' 23:59',
               ISIN = '',
               PQTY = SUM(CASE 
                            WHEN SELL_BUY = 1 THEN S.TRADEQTY
                            ELSE 0
                          END),
               SQTY = SUM(CASE 
                            WHEN SELL_BUY = 2 THEN S.TRADEQTY
                            ELSE 0
                          END),
               PRATE = ROUND((CASE 
                                WHEN SUM(CASE 
                                           WHEN SELL_BUY = 1 THEN S.TRADEQTY
                                           ELSE 0
                                         END) > 0 THEN SUM(CASE 
                                                             WHEN SELL_BUY = 1 THEN CONVERT(NUMERIC(36, 12),S.TRADEQTY * PRICE)
                                                             ELSE 0
                                                           END) / SUM(CASE 
                                 WHEN SELL_BUY = 1 THEN CONVERT(NUMERIC(36, 12),S.TRADEQTY)
                                               ELSE 0
                                                                      END)
                    ELSE 0
                              END),12),
               SRATE = ROUND((CASE 
                                WHEN SUM(CASE 
                                           WHEN SELL_BUY = 2 THEN S.TRADEQTY
                                           ELSE 0
                                         END) > 0 THEN SUM(CASE 
                                                             WHEN SELL_BUY = 2 THEN CONVERT(NUMERIC(36, 12),S.TRADEQTY * PRICE)
                                 ELSE 0
                                                           END) / SUM(CASE 
                                                                        WHEN SELL_BUY = 2 THEN CONVERT(NUMERIC(36, 12),S.TRADEQTY)
                                                                        ELSE 0
                    END)
                                ELSE 0
                              END),12),
               PAMT = ROUND(SUM(CASE 
                                  WHEN SELL_BUY = 1 THEN (S.TRADEQTY * (PRICE + BROKAPPLIED) )
                                  ELSE 0
                                END),12),
               SAMT = ROUND(SUM(CASE 
                  WHEN SELL_BUY = 2 THEN (S.TRADEQTY * (PRICE - BROKAPPLIED) )
                                  ELSE 0
                                END),12),
               PBROKAMT = ROUND(SUM(CASE 
                                      WHEN SELL_BUY = 1 THEN (S.TRADEQTY * BROKAPPLIED )
                                      ELSE 0
                                    END),12),
               SBROKAMT = ROUND(SUM(CASE 
                                      WHEN SELL_BUY = 2 THEN (S.TRADEQTY * BROKAPPLIED )
                                      ELSE 0
                                    END),12),
               PBILLAMT = ROUND(SUM(CASE 
                                      WHEN SELL_BUY = 1 THEN (S.TRADEQTY * (PRICE + BROKAPPLIED) )
                                      ELSE 0
                                    END),12),
               SBILLAMT = ROUND(SUM(CASE 
                                      WHEN SELL_BUY = 2 THEN (S.TRADEQTY * (PRICE - BROKAPPLIED) )
                                      ELSE 0
                                    END),12),
               CL_RATE = 0,
               CL_CHRG = 0,
               EXCL_CHRG = 0,
               SERVICE_TAX = SUM(SERVICE_TAX),
               EXSER_TAX = (CASE 
                              WHEN C2.SERVICE_CHRG = 2 THEN SUM(SERVICE_TAX)
                              ELSE 0
                            END),
               INEXSERFLAG = SERVICE_CHRG,
               SEBI_TAX = (CASE 
                             WHEN SEBI_TURN_TAX = 1 THEN SUM(SEBI_TAX)
                             ELSE 0
                           END),
               TURN_TAX = (CASE 
                             WHEN C2.TURNOVER_TAX = 1 THEN SUM(TURN_TAX)
                             ELSE 0
                           END),
               BROKER_NOTE = (CASE 
                                WHEN BROKERNOTE = 1 THEN SUM(BROKER_CHRG)
                                ELSE 0
                              END),
               INS_CHRG = (CASE 
                             WHEN C2.INSURANCE_CHRG = 1 THEN SUM(INS_CHRG)
                             ELSE 0
                           END),
               OTHER_CHRG = (CASE 
                               WHEN C2.OTHER_CHRG = 1 THEN SUM(S.OTHER_CHRG)
   ELSE 0
   END),
               TRADETYPE = 'BT',
               PARTICIPANTCODE = (CASE 
                                    WHEN S.RESERVED1 = 1 THEN PARTICIPANTCODE
                                    ELSE MEMBERCODE
                                  END),
               TERMINAL_ID = '',
               FAMILY,
               FAMILYNAME = '',
               TRADER,
               BRANCH_CODE = BRANCH_CD,
               SUB_BROKER,
               STATUSNAME = '',
               EXCHANGE = 'MFO',
               SEGMENT = 'FUTURE',
               MEMBERTYPE,
               COMPANYNAME = '',
               REGION,
               UPDATEDATE = LEFT(CONVERT(VARCHAR,GETDATE(),109),11),
               EMAIL = C1.EMAIL,
               DUMMY2 = '',
               DUMMY3 = '',
               DUMMY4 = 0,
               DUMMY5 = 0,
               CMCLOSING = 0,
               TRACK = '',
               C1.AREA
      FROM     #FOSCRIP2 F,
               #FOSETTLEMENT S,
               FOOWNER,
               #CLIENT1 C1,
               #CLIENT2 C2
      WHERE    SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
               AND F.INST_TYPE = S.INST_TYPE
               AND F.SYMBOL = S.SYMBOL
               AND CONVERT(VARCHAR,S.EXPIRYDATE,103) = CONVERT(VARCHAR,F.EXPIRYDATE,103)
               AND F.STRIKE_PRICE = S.STRIKE_PRICE
               AND F.OPTION_TYPE = S.OPTION_TYPE
               AND F.MATURITYDATE >= @SDATE
               AND S.PARTY_CODE = C2.PARTY_CODE
               AND C2.CL_CODE = C1.CL_CODE
               AND TRADEQTY > 0
      GROUP BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,F.MATURITYDATE,
      S.STRIKE_PRICE,S.OPTION_TYPE,S.EXPIRYDATE,SHORT_NAME,
               CL_TYPE,BILLNO,CONTRACTNO,AUCTIONPART,
               SERVICE_CHRG,PARTICIPANTCODE,FAMILY,TRADER,
               BRANCH_CD,SUB_BROKER,MEMBERTYPE,SEBI_TURN_TAX,
               C2.TURNOVER_TAX,BROKERNOTE,MEMBERCODE,RESERVED1,
               DUMMY8,DUMMY9,DUMMY10,C1.EMAIL,
               C2.INSURANCE_CHRG,C2.OTHER_CHRG,C1.AREA,REGION
               
      /*VOLUMN BASED BROK*/
      INSERT INTO FOBILLVALAN_TEMP
      SELECT   PARTY_CODE = CD_PARTY_CODE,
               LONG_NAME = SHORT_NAME,
               CLIENT_TYPE = CL_TYPE,
               BILLNO = 0,
               CONTRACTNO = CD_CONTRACT_NO,
               INST_TYPE = CD_INST_TYPE,
               SYMBOL = CD_SYMBOL,
               EXPIRYDATE = CD_EXPIRY_DATE,
               OPTION_TYPE = CD_OPTION_TYPE,
               STRIKE_PRICE = CD_STRIKE_PRICE,
               AUCTIONPART = CD_AUCTIONPART,
               ISNULL(F.MATURITYDATE,'1900-01-01'),
               SAUDA_DATE = CD_SAUDA_DATE + ' 23:59',
               ISIN = '',
               PQTY = 0,
               SQTY = 0,
               PRATE = 0,
               SRATE = 0,
               PAMT = 0,
               SAMT = 0,
               PBROKAMT = SUM(CD_TOT_BUYBROK),
               SBROKAMT = SUM(CD_TOT_SELLBROK),
               PBILLAMT = SUM(CD_TOT_BUYBROK + CD_TOT_SELLBROK),
               SBILLAMT = SUM(0),
               CL_RATE = 0,
               CL_CHRG = 0,
               EXCL_CHRG = 0,
               SERVICE_TAX = SUM(CD_TOT_SERTAX),
               EXSER_TAX = (CASE 
                              WHEN C2.SERVICE_CHRG = 2 THEN SUM(CD_TOT_SERTAX)
                              ELSE 0
                            END),
               INEXSERFLAG = SERVICE_CHRG,
               SEBI_TAX = 0,
               TURN_TAX = 0,
               BROKER_CHRG = 0,
               INS_CHRG = 0,
               OTHER_CHRG = 0,
               TRADETYPE = 'BT',
               PARTICIPANTCODE = MEMBERCODE,
               TERMINAL_ID = '',
               FAMILY,
               FAMILYNAME = '',
               TRADER,
               BRANCH_CODE = BRANCH_CD,
               SUB_BROKER,
				STATUSNAME = 'BRK',
               EXCHANGE = 'MFO',
               SEGMENT = 'FUTURE',
               MEMBERTYPE,
               COMPANYNAME = '',
               REGION,
               UPDATEDATE = LEFT(CONVERT(VARCHAR,GETDATE(),109),11),
               EMAIL = C1.EMAIL,
        DUMMY2 = '',
               DUMMY3 = '',
               DUMMY4 = 0,
               DUMMY5 = 0,
               CMCLOSING = 0,
               TRACK = '',
               C1.AREA
      FROM     CHARGES_DETAIL S
               LEFT OUTER JOIN #FOSCRIP2 F
                 ON (F.INST_TYPE = S.CD_INST_TYPE
                     AND F.SYMBOL = S.CD_SYMBOL
                     AND CONVERT(VARCHAR,F.EXPIRYDATE,103) = CONVERT(VARCHAR,S.CD_EXPIRY_DATE,103)
                     AND F.STRIKE_PRICE = S.CD_STRIKE_PRICE
                     AND F.OPTION_TYPE = S.CD_OPTION_TYPE),
               CLIENT1 C1,
               CLIENT2 C2,
               FOOWNER
      WHERE    S.CD_SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
               AND S.CD_PARTY_CODE = C2.PARTY_CODE
    AND C1.CL_CODE = C2.CL_CODE
      GROUP BY CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_INST_TYPE,
               CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,
               CD_AUCTIONPART,C1.AREA,C1.SHORT_NAME,C1.CL_TYPE,
               F.MATURITYDATE,C2.SERVICE_CHRG,C1.FAMILY,C1.TRADER,
               C1.BRANCH_CD,C1.SUB_BROKER,FOOWNER.MEMBERTYPE,C1.REGION,
               C1.EMAIL,MEMBERCODE

	 UPDATE FOBILLVALAN_TEMP 
	 SET PARTICIPANTCODE = F.PARTICIPANTCODE
	 FROM
	 (
		SELECT CONTRACTNO,PARTICIPANTCODE FROM
		FOSETTLEMENT (NOLOCK) WHERE 
		SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
		AND RESERVED1=1
		AND TRADEQTY > 0
	 ) F
	 WHERE F.CONTRACTNO = FOBILLVALAN_TEMP.CONTRACTNO
	 AND PQTY + SQTY =0
	 AND STATUSNAME = 'BRK'
                                  
      UPDATE FOBILLVALAN_TEMP
      SET    SYMBOL = F.SYMBOL,
             INST_TYPE = F.INST_TYPE,
             EXPIRYDATE = F.EXPIRYDATE,
             STRIKE_PRICE = F.STRIKE_PRICE,
             OPTION_TYPE = F.OPTION_TYPE,
             MATURITYDATE = F.MATURITYDATE
      FROM   #FOSCRIP2 F
      WHERE  FOBILLVALAN_TEMP.SYMBOL = ''
             AND F.SYMBOL = 'BROKERAGE'



                            
      /* TODAYS TRADE */
      IF (SELECT ISNULL(COUNT(PARTY_CODE),0)
          FROM   #FOTMCLCHRG) > 0
        BEGIN
        
          UPDATE FOBILLVALAN_TEMP
          SET    CL_CHRG = ISNULL((SELECT CLEARINGCHARGES
                                   FROM   (SELECT   S.PARTY_CODE,
                                                    S.INST_TYPE,
                                                    S.SYMBOL,
                                                    S.OPTION_TYPE,
                                                    S.STRIKE_PRICE,
                                                    S.EXPIRYDATE,
                                                    CLEARINGCHARGES = ISNULL(SUM(CLEARINGCHARGES),0)
                                           FROM     #FOTMCLCHRG C,
                                                    #FOSETTLEMENT S
                                           WHERE    S.PARTY_CODE = C.PARTY_CODE
                                                    AND C.ORDERNO = S.ORDER_NO
                                                    AND C.TRADE_NO = S.TRADE_NO
                                                    AND C.SELL_BUY = S.SELL_BUY
                                                    AND LEFT(CONVERT(VARCHAR,S.SAUDA_DATE,109),11) = LEFT(CONVERT(VARCHAR,C.SAUDA_DATE,109),11)
                                                    AND S.SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
                                           GROUP BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.OPTION_TYPE,
                                                    S.STRIKE_PRICE,S.EXPIRYDATE) S
			WHERE  S.INST_TYPE = FOBILLVALAN_TEMP.INST_TYPE
			AND S.SYMBOL = FOBILLVALAN_TEMP.SYMBOL
			AND S.OPTION_TYPE = FOBILLVALAN_TEMP.OPTION_TYPE
			AND S.STRIKE_PRICE = FOBILLVALAN_TEMP.STRIKE_PRICE
			AND S.EXPIRYDATE = FOBILLVALAN_TEMP.EXPIRYDATE
			AND FOBILLVALAN_TEMP.PARTY_CODE = S.PARTY_CODE),
                      0)
          WHERE  FOBILLVALAN_TEMP.TRADETYPE = 'BT'
                 AND FOBILLVALAN_TEMP.SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
                                                                             
          UPDATE FOBILLVALAN_TEMP
          SET    EXCL_CHRG = CL_CHRG
          FROM   FOOWNER
          WHERE  (CLRGCHG = 1
                  AND CHMCLCHRG = 1)
                  OR (CLRGCHG = 4
                      AND CHMCLCHRG = 1)
                  OR (CLRGCHG = 2
                      AND CHMCLCHRG = 0)
                  OR (CLRGCHG = 0
                      AND CHMCLCHRG = 0)
                     AND FOBILLVALAN_TEMP.TRADETYPE = 'BT'
                     AND FOBILLVALAN_TEMP.SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
        END
        
      UPDATE FOBILLVALAN_TEMP
      SET    PBILLAMT = PQTY * FOCLOSING.CL_RATE ,
             SBILLAMT = SQTY * FOCLOSING.CL_RATE ,
             PAMT = PQTY * FOCLOSING.CL_RATE ,
             SAMT = SQTY * FOCLOSING.CL_RATE 
      FROM   #FOCLOSING FOCLOSING
      WHERE  FOCLOSING.INST_TYPE = FOBILLVALAN_TEMP.INST_TYPE
             AND FOCLOSING.SYMBOL = FOBILLVALAN_TEMP.SYMBOL
             AND CONVERT(VARCHAR,FOCLOSING.EXPIRYDATE,103) = CONVERT(VARCHAR,FOBILLVALAN_TEMP.EXPIRYDATE,103)
             AND FOCLOSING.STRIKE_PRICE = FOBILLVALAN_TEMP.STRIKE_PRICE
             AND FOCLOSING.OPTION_TYPE = FOBILLVALAN_TEMP.OPTION_TYPE
             AND FOBILLVALAN_TEMP.TRADETYPE = 'BF'
             AND FOBILLVALAN_TEMP.SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
             AND FOBILLVALAN_TEMP.INST_TYPE LIKE 'FUT%'
                                                 
      UPDATE FOBILLVALAN_TEMP
      SET    CL_RATE = FOCLOSING.CL_RATE,
             CMCLOSING = FOCLOSING.CL_RATE
      FROM   #FOCLOSINGTODAY FOCLOSING
      WHERE  FOCLOSING.INST_TYPE = FOBILLVALAN_TEMP.INST_TYPE
             AND FOCLOSING.SYMBOL = FOBILLVALAN_TEMP.SYMBOL
             AND CONVERT(VARCHAR,FOCLOSING.EXPIRYDATE,103) = CONVERT(VARCHAR,FOBILLVALAN_TEMP.EXPIRYDATE,103)
             AND FOCLOSING.STRIKE_PRICE = FOBILLVALAN_TEMP.STRIKE_PRICE
             AND FOCLOSING.OPTION_TYPE = FOBILLVALAN_TEMP.OPTION_TYPE
             AND FOBILLVALAN_TEMP.SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
                                                                         
      UPDATE FOBILLVALAN_TEMP
      SET    CMCLOSING = FOCLOSING.CL_RATE
      FROM   FOCLOSING
      WHERE  TRADE_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
             AND FOCLOSING.SYMBOL = FOBILLVALAN_TEMP.SYMBOL
             AND CONVERT(VARCHAR,FOCLOSING.EXPIRYDATE,103) = CONVERT(VARCHAR,FOBILLVALAN_TEMP.EXPIRYDATE,103)
             AND FOBILLVALAN_TEMP.SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
           AND FOBILLVALAN_TEMP.INST_TYPE LIKE 'OPT%'
             AND FOCLOSING.INST_TYPE LIKE 'FUT%'
                                          
		UPDATE FOBILLVALAN_TEMP
		SET    PBILLAMT = (CASE 
		WHEN PARTICIPANTCODE = MEMBERCODE THEN (CASE 
										 WHEN PBILLAMT - PQTY * CL_RATE  + SQTY *
												 CL_RATE  - SBILLAMT > 0 THEN PBILLAMT - PQTY * CL_RATE + SQTY * CL_RATE  - SBILLAMT
												 ELSE 0
											   END)
		ELSE PBROKAMT
		END),
		SBILLAMT = (CASE 
		WHEN PARTICIPANTCODE = MEMBERCODE THEN (CASE 
												 WHEN PBILLAMT - PQTY * CL_RATE  + SQTY * CL_RATE 
												  - SBILLAMT < 0 THEN ABS(PBILLAMT - PQTY * CL_RATE + SQTY * CL_RATE  - SBILLAMT)
												 ELSE 0
											   END)
		ELSE SBROKAMT
								 END)
			  FROM   FOOWNER
			  WHERE  SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
             AND INST_TYPE LIKE 'FUT%'
                                
      UPDATE FOBILLVALAN_TEMP
      SET    PBILLAMT = PBROKAMT,
             SBILLAMT = SBROKAMT
      FROM   FOOWNER
      WHERE  SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'
             AND INST_TYPE LIKE 'OPT%'
             AND PARTICIPANTCODE <> MEMBERCODE
                                    
      UPDATE FOBILLVALAN_TEMP
      SET    FAMILYNAME = SHORT_NAME
      FROM   CLIENT1 C1,
             CLIENT2 C2
      WHERE  C1.CL_CODE = C2.CL_CODE
             AND C2.PARTY_CODE = FOBILLVALAN_TEMP.FAMILY
                                 
      DELETE FROM FOBILLVALAN
      WHERE       SAUDA_DATE BETWEEN @SDATE AND @SDATE + ' 23:59'

	           
      INSERT INTO FOBILLVALAN
      SELECT *
      FROM   FOBILLVALAN_TEMP
             
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_IDUSER_LIST
-- --------------------------------------------------
CREATE PROC [dbo].[GET_IDUSER_LIST]  
(  
 @IDUSER VARCHAR(30)  
)  
  
AS  
  
SET @IDUSER = UPPER(@IDUSER)  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
IF @IDUSER = 'BRANCH'  
 BEGIN  
  SELECT DISTINCT BRANCH_CODE, BRANCH = UPPER(BRANCH) FROM BRANCH (NOLOCK) ORDER BY BRANCH  
 END  
ELSE IF @IDUSER = 'SUBBROKER'  
 BEGIN   
  SELECT DISTINCT SUB_BROKER, NAME = UPPER(NAME) FROM SUBBROKERS (NOLOCK) WHERE SUB_BROKER <> '' AND NAME <> '' ORDER BY NAME   
 END  
ELSE IF @IDUSER = 'TRADER'  
 BEGIN  
 SELECT DISTINCT SHORT_NAME,LONG_NAME FROM BRANCHES (NOLOCK) WHERE SHORT_NAME <> '' AND LONG_NAME <> '' ORDER BY LONG_NAME   
 END  
ELSE IF @IDUSER = 'AREA'  
 BEGIN  
  SELECT DISTINCT AREACODE,DESCRIPTION FROM AREA (NOLOCK) ORDER BY DESCRIPTION  
 END   
ELSE IF @IDUSER = 'REGION'  
 BEGIN  
  SELECT DISTINCT REGIONCODE,DESCRIPTION FROM REGION (NOLOCK) ORDER BY DESCRIPTION  
 END  
ELSE IF @IDUSER = 'FAMILY'  
 BEGIN  
  SELECT DISTINCT FAMILY, FAMILY AS DESCRIPTION FROM MSAJAG.DBO.CLIENT_DETAILS (NOLOCK) WHERE FAMILY <> '' AND FAMILY <> CL_CODE ORDER BY DESCRIPTION  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_PWD_EXPIRY
-- --------------------------------------------------
CREATE PROC [dbo].[GET_PWD_EXPIRY]
(
  @UNAME VARCHAR(100)
)
AS
SELECT LTRIM(RTRIM(T.FLDFIRSTNAME)) AS FIRSTNAME,   
 CASE WHEN DATEDIFF (DD, GETDATE(), T.PWD_EXPIRY_DATE) = 2  THEN  'THE DAY AFTER TOMORROW'  
 ELSE  
 	CASE WHEN  DATEDIFF (DD, GETDATE(), T.PWD_EXPIRY_DATE) = 1  THEN  'TOMORROW'  
 ELSE  
	CASE WHEN  DATEDIFF (DD, GETDATE(), T.PWD_EXPIRY_DATE) = 0  THEN  '<U>TODAY</U>'  
 ELSE  
	'ON ' + LEFT(CONVERT(VARCHAR, T.PWD_EXPIRY_DATE, 109), 11)  
END 
END 
END  
 AS PWD_EXPIRY_DATE  
 FROM  
	TBLPRADNYAUSERS T, TBLADMIN A 
 WHERE  
	T.FLDADMINAUTO = A.FLDAUTO_ADMIN  
	AND T.FLDUSERNAME = @UNAME 
	AND GETDATE() <= T.PWD_EXPIRY_DATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_USER_CATEGORY
-- --------------------------------------------------
CREATE PROC [dbo].[GET_USER_CATEGORY]
(
  @FLDCATEGORY INT
)
AS
SELECT FLDCATEGORYNAME FROM TBLCATEGORY WHERE FLDCATEGORYCODE = @FLDCATEGORY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_USER_EDIT
-- --------------------------------------------------
CREATE PROC [dbo].[GET_USER_EDIT]
(
	@UID	VARCHAR(25),
	@UNAME	VARCHAR(25),
	@CAT	VARCHAR(15),
	@ADMIN_ID INT 
)			
/*
	SELECT * FROM TBLPRADNYAUSERS WHERE FLDCATEGORY = 0
	EXEC GET_USER_EDIT '','', '','2' 
*/
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
	(SELECT 
		UPPER(T.FLDUSERNAME) AS FLDUSERNAME, 
		UPPER(T.FLDFIRSTNAME) AS FLDFIRSTNAME, 
		UPPER(T.FLDLASTNAME) AS FLDLASTNAME, 
		T.FLDPHONE1, 
		T.FLDPHONE2, 
		T.FLDAUTO, 
		UPPER(C.FLDCATEGORYNAME) AS FLDCATEGORYNAME 
	FROM  
		TBLPRADNYAUSERS T,TBLCATEGORY C  
	WHERE 
		T.FLDCATEGORY = C.FLDCATEGORYCODE  
		AND  T.FLDADMINAUTO = @ADMIN_ID    
		AND T.FLDUSERNAME LIKE @UID + '%' 
		AND FLDUSERNAME LIKE @UNAME + '%' 
		AND FLDCATEGORY LIKE @CAT +'%' 
	)
	UNION ALL
	(
	SELECT 
		UPPER(FLDUSERNAME),
		UPPER(FLDFIRSTNAME),
		UPPER(FLDLASTNAME),
		FLDPHONE1,
		FLDPHONE2,
		FLDAUTO, 
		FLDCATEGORYNAME = '0'
	FROM 
		TBLPRADNYAUSERS T  
	WHERE 
		FLDADMINAUTO = @ADMIN_ID AND FLDCATEGORY = '0'  
		AND T.FLDUSERNAME LIKE  @UID + '%' 
		AND FLDUSERNAME LIKE @UNAME + '%' 
	)
	ORDER BY 7,1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_USER_FOREDIT
-- --------------------------------------------------
CREATE PROC [dbo].[GET_USER_FOREDIT]
(
	@FLDAUTO INT
)
AS
/*
GET_USER_FOREDIT 81848
SELECT * FROM TBLUSERCONTROLMASTER WHERE FLDUSERID = 81848
*/
SELECT 
	T.FLDAUTO,
	FLDUSERNAME,
	FLDPASSWORD,
	FLDFIRSTNAME,
	FLDMIDDLENAME,
	FLDLASTNAME,
	FLDSEX,
	FLDADDRESS1,
	FLDADDRESS2,
	FLDPHONE1,	
	FLDPHONE2,	
	FLDCATEGORY,
	FLDADMINAUTO,
	FLDSTNAME,
	PWD_EXPIRY_DATE,
	TB.FLDPWDEXPIRY,
	TB.FLDMAXATTEMPT,
	TB.FLDATTEMPTCNT,
	TB.FLDSTATUS,
	TB.FLDLOGINFLAG,
	TB.FLDACCESSLVL,
	TB.FLDIPADD,
	TB.FLDFIRSTLOGIN,
	TB.FLDFORCELOGOUT,
	FLD_MAC_ID
FROM 
	TBLPRADNYAUSERS T, TBLUSERCONTROLMASTER TB
WHERE
	T.FLDAUTO = @FLDAUTO  
	AND T.FLDAUTO = FLDUSERID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETDT
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.GETDT    SCRIPT DATE: 09/10/2001 6:27:20 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.GETDT    SCRIPT DATE: 09/07/2001 10:36:07 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.GETDT    SCRIPT DATE: 9/7/01 5:07:23 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.GETDT    SCRIPT DATE: 9/7/2001 4:10:06 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.GETDT    SCRIPT DATE: 08/10/2001 4:53:42 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.GETDT    SCRIPT DATE: 8/7/01 4:29:06 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.GETDT    SCRIPT DATE: 7/25/01 10:05:59 PM ******/



/****** OBJECT:  STORED PROCEDURE DBO.GETDT    SCRIPT DATE: 6/30/01 11:51:37 AM ******/



/****** OBJECT:  STORED PROCEDURE DBO.GETDT    SCRIPT DATE: 5/26/01 4:17:01 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.GETDT    SCRIPT DATE: 3/17/01 9:55:52 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.GETDT    SCRIPT DATE: 3/21/01 12:50:09 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.GETDT    SCRIPT DATE: 20-MAR-01 11:38:51 PM ******/


/*FINAL SQL - 07 FEB 2001 */
/*RANJEET CHOUDHARY*/
/*USED IN NSEFO SEGMENT*/

CREATE PROC [dbo].[GETDT] AS
 /*USED IN NSE FO */ 
 /*CONTROL NAME :FOCLOSING MODULE NAME :CMDENTERRATES_CLICK()*/
 /*FUNCTION:THIS IS USED GET SERVER SIDE DATE*/
 /*WRITTEN BY :RANJEET CHOUDHARY */ 
 SELECT GETDATE()

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETPROCESS
-- --------------------------------------------------
CREATE PROC [dbo].[GETPROCESS] AS
DECLARE @PROCESSIDCUR CURSOR
DECLARE @PROCESSID  INT

SET @PROCESSIDCUR = CURSOR FOR SELECT SPID FROM  MASTER.DBO.SYSPROCESSES
  
OPEN @PROCESSIDCUR  
FETCH NEXT FROM @PROCESSIDCUR INTO @PROCESSID
WHILE @@FETCH_STATUS = 0   
   BEGIN  
			PRINT  @PROCESSID
		 DBCC INPUTBUFFER(@PROCESSID) WITH NO_INFOMSGS
		FETCH NEXT FROM @PROCESSIDCUR INTO @PROCESSID
		END  
CLOSE @PROCESSIDCUR  
DEALLOCATE @PROCESSIDCUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.HTTP_REQUEST
-- --------------------------------------------------


/*
declare  @myurl varchar(max), @myoutput varchar(max)
set @myurl ='http://10.228.50.11:8081/rnd/test.asp'

exec HTTP_REQUEST @myurl, @myoutput

print @myoutput


*/

create PROCEDURE [dbo].[HTTP_REQUEST]
( 
@URI varchar(max), 
@response varchar(8000) OUT
)
AS

DECLARE
@xhr INT
,@result INT
,@httpStatus INT
,@msg VARCHAR(255)


EXEC @result = sp_OACreate 'MSXML2.XMLHttp.5.0', @xhr OUT

IF @result <> 0 BEGIN RAISERROR('sp_OACreate on MSXML2.XMLHttp.5.0 failed', 16,1) RETURN 
END

EXEC @result = sp_OAMethod @xhr, 'open', NULL, 'GET', @URI, false
IF @result <>0 BEGIN RAISERROR('sp_OAMethod Open failed', 16,1) RETURN 
END

EXEC @result = sp_OAMethod @xhr, SEND, NULL, ''
IF @result <>0 BEGIN RAISERROR('sp_OAMethod SEND failed', 16,1) RETURN 
END

EXEC @result = sp_OAGetProperty @xhr, 'status', @httpStatus OUT

IF @result <>0 
    BEGIN RAISERROR('sp_OAMethod read status failed', 16,1) RETURN 
    END

IF @httpStatus <> 200 BEGIN RAISERROR('sp_OAMethod http status bad', 16,1) RETURN 
END

EXEC @result = sp_OAGetProperty @xhr, 'responseText', @response OUT
IF @result <>0 BEGIN RAISERROR('sp_OAMethod read response failed', 16,1) RETURN 
END

EXEC @result = sp_OADestroy @xhr

RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.INDEX_GETINDEXNAME
-- --------------------------------------------------
CREATE PROC [dbo].[INDEX_GETINDEXNAME] AS  
DECLARE @TABLENAME VARCHAR(100),  
@CURTBL CURSOR,  
@SQL VARCHAR(150)  
  
CREATE TABLE #TBL_INDEX  
(SNO INT IDENTITY (1, 1) NOT NULL,  
 INDEXNAME VARCHAR(100) NOT NULL,  
 TABLENAME VARCHAR(100) NOT NULL)  
  
SET @CURTBL = CURSOR FOR  
SELECT NAME FROM SYSOBJECTS   
WHERE XTYPE = 'U'  
ORDER BY NAME   
OPEN @CURTBL  
FETCH NEXT FROM  @CURTBL INTO @TABLENAME  
WHILE @@FETCH_STATUS = 0   
BEGIN  
 INSERT INTO #TBL_INDEX  

      SELECT I.NAME, TABLENAME=@TABLENAME
      FROM (DBO.SYSINDEXES I INNER JOIN
         DBO.SYSFILEGROUPS S ON
         I.GROUPID = S.GROUPID )
      WHERE ID = OBJECT_ID(@TABLENAME) AND I.INDID > 0 AND I.INDID < 255 AND
      (INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISSTATISTICS') <> 1) AND
      (INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISAUTOSTATISTICS') <> 1) AND
      (INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISHYPOTHETICAL') <> 1) 

   
 FETCH NEXT FROM  @CURTBL INTO @TABLENAME  
END  
CLOSE @CURTBL  
DEALLOCATE @CURTBL  
  
SELECT * FROM #TBL_INDEX  
ORDER BY TABLENAME, INDEXNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PCREATEBOUSERS
-- --------------------------------------------------
CREATE   PROC [dbo].[PCREATEBOUSERS]  
(  
	 @UPDTFLAG VARCHAR(1),  
	 @PARTICIPANT VARCHAR(10),  
	 @CATEGORYNAME VARCHAR(20),  
	 @USERID VARCHAR(20),  
	 @PASSWORD VARCHAR(15),  
	 @FIRSTNAME VARCHAR(50),  
	 @MIDDLENAME VARCHAR(25),  
	 @LASTNAME VARCHAR(25),
	 @EDITADDBY VARCHAR(25)  
)  
  
AS  
  
DECLARE @@ADMINCOUNT INT  
DECLARE @@CONTROLCOUNT INT  
DECLARE @@USERCOUNT INT  
DECLARE @@CATEGORYCODE INT  
DECLARE @@USERLOGINID INT  
DECLARE @@ADMINAUTO INT  
  
IF @UPDTFLAG = 'I'  
BEGIN  
  
 SELECT @@ADMINCOUNT = COUNT(1) FROM TBLADMIN WHERE FLDNAME = @PARTICIPANT   
   
 IF @@ADMINCOUNT >0  
 BEGIN  
  
	 SELECT @@ADMINCOUNT = COUNT(1) FROM TBLCATEGORY WHERE FLDCATEGORYNAME = @CATEGORYNAME     
	IF @@ADMINCOUNT >0  
	BEGIN  

		  SELECT @@USERCOUNT = COUNT(1) FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = @USERID    
		  IF @@USERCOUNT = 0  
		  BEGIN    
		  
		   SELECT @@CATEGORYCODE = FLDCATEGORYCODE FROM TBLCATEGORY WHERE FLDCATEGORYNAME = @CATEGORYNAME  
		 
		   SELECT @@ADMINAUTO = FLDAUTO_ADMIN FROM TBLADMIN WHERE FLDNAME = @PARTICIPANT  
		  
		    
		   INSERT INTO TBLPRADNYAUSERS  
		   (FLDUSERNAME,FLDPASSWORD,FLDFIRSTNAME,FLDMIDDLENAME,FLDLASTNAME,FLDSEX,FLDADDRESS1,FLDADDRESS2,FLDPHONE1,FLDPHONE2,FLDCATEGORY,FLDADMINAUTO,FLDSTNAME,PWD_EXPIRY_DATE,EDIT_FLAG,CREATED_BY,MODIFIED_BY)  
		   VALUES  
		   (@USERID, @PASSWORD, LEFT(@FIRSTNAME,50), LEFT(@MIDDLENAME,25), LEFT(@LASTNAME, 50), 'MALE',  
		   '','','','', @@CATEGORYCODE, @@ADMINAUTO, @USERID, 'DEC 31 2049','A',@EDITADDBY,@EDITADDBY)  
		     
		   SELECT @@USERLOGINID = FLDAUTO FROM TBLPRADNYAUSERS WHERE FLDUSERNAME = @USERID  
		     
		   INSERT INTO TBLUSERCONTROLMASTER  
		   (FLDUSERID,FLDPWDEXPIRY,FLDMAXATTEMPT,FLDATTEMPTCNT,FLDSTATUS,FLDLOGINFLAG,FLDACCESSLVL,FLDIPADD,FLDTIMEOUT,FLDFIRSTLOGIN,FLDFORCELOGOUT)  
		   VALUES  
		   (@@USERLOGINID, 365, 100, 0, 0, 0, 'F', '', 30, 'N', 0)  
	END
  END  
 END  
   
END  
ELSE  
BEGIN  
 UPDATE TBLADMIN  
 SET FLDPASSWORD = @PASSWORD  
 WHERE FLDNAME = @PARTICIPANT  
  
 UPDATE TBLPRADNYAUSERS  
 SET FLDPASSWORD  = @PASSWORD  
 WHERE FLDUSERNAME = @USERID  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.POP_CONTRACTDATA
-- --------------------------------------------------
  
CREATE PROC [dbo].[POP_CONTRACTDATA]  
(    
 @SAUDA_DATE VARCHAR(11),  
 @USERNAME VARCHAR(11)='',  
 @STRMODE VARCHAR(10) ='POPULATE',  
 @FNOBILL_FLAG INT = 0  -- 1 : CONTRACT CUM BILL , 0 - CONTRACT ONLY  
)  
  
AS     
  
IF @STRMODE = 'POPULATE'  
BEGIN  
  
 /* ------------------------------------------------------------------------  
      TAKING FILTERD TRADES TO TEMPORARY TABLE  
 ---------------------------------------------------------------------------*/  
  
 CREATE TABLE #FOSETTLEMENT  
 (  
  CONTRACTNO VARCHAR(14),  
  ORDER_NO VARCHAR(20),  
  CPID VARCHAR(10),  
  TRADE_NO VARCHAR(15),  
  SAUDA_DATE DATETIME,  
  PARTY_CODE VARCHAR(10),  
  INST_TYPE VARCHAR(6),  
  SYMBOL VARCHAR(12),  
  EXPIRYDATE DATETIME,  
  STRIKE_PRICE [NUMERIC] (36,18),  
  OPTION_TYPE VARCHAR(2),  
  AUCTIONPART VARCHAR(2),  
  SELL_BUY INT,  
  TRADEQTY INT,  
  PRICE [NUMERIC] (36,18),  
  BROKAPPLIED [NUMERIC] (36,18),  
  NETRATE [NUMERIC] (36,18),  
  AMOUNT [NUMERIC] (36,18),  
  SERVICE_TAX [NUMERIC] (36,18),  
  BROKER_CHRG [NUMERIC] (36,18),  
  TURN_TAX [NUMERIC] (36,18),  
  SEBI_TAX [NUMERIC] (36,18),  
  OTHER_CHRG [NUMERIC] (36,18),  
  INS_CHRG [NUMERIC] (36,18),  
  ORDFLG INT,  
  TOTALBROK [NUMERIC] (36,18),  
  CONT_USER_ID VARCHAR(20)  
 )  
  
 SELECT * INTO #FOSETTLEMENT_1 FROM #FOSETTLEMENT  
  
 CREATE INDEX [IDXPARTY] ON [DBO].[#FOSETTLEMENT_1] ([PARTY_CODE])     
  
 INSERT INTO #FOSETTLEMENT  
 SELECT   
  CONTRACTNO,ORDER_NO,CPID,TRADE_NO,SAUDA_DATE,PARTY_CODE,  
  INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,AUCTIONPART,  
  SELL_BUY,TRADEQTY,PRICE,BROKAPPLIED,NETRATE,AMOUNT,  
  SERVICE_TAX,BROKER_CHRG,TURN_TAX,SEBI_TAX,OTHER_CHRG,  
  INS_CHRG,ORDFLG=RESERVED1,TOTALBROK=BROKAPPLIED*TRADEQTY,  
  CONT_USER_ID = [USER_ID]  
 FROM FOSETTLEMENT   (NOLOCK)                
 WHERE   
  SAUDA_DATE >= @SAUDA_DATE AND   
  SAUDA_DATE <= @SAUDA_DATE +' 23:59' AND   
  AUCTIONPART <> 'CA' AND  
  TRADEQTY > 0  AND   
  PRICE > 0   
  
 UPDATE #FOSETTLEMENT SET TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO)   
 WHERE UPPER(LEFT(TRADE_NO,1)) BETWEEN 'A' AND 'Z'   
  
 UPDATE #FOSETTLEMENT SET CPID = (CASE WHEN CPID = 'NIL' OR CPID   = '0' THEN '' ELSE RIGHT(CPID,8) END)  
  
 INSERT INTO #FOSETTLEMENT_1  
 SELECT   
  CONTRACTNO,ORDER_NO,CPID ,TRADE_NO,SAUDA_DATE,  
  PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,  
  OPTION_TYPE,AUCTIONPART,SELL_BUY,  
  TRADEQTY = SUM(TRADEQTY),  
  PRICE = SUM(TRADEQTY*PRICE)/ SUM(TRADEQTY),  
  BROKAPPLIED = SUM(BROKAPPLIED),  
  NETRATE= SUM(NETRATE*TRADEQTY)/ SUM(TRADEQTY),  
  AMOUNT = SUM(AMOUNT),  
  SERVICE_TAX = SUM(SERVICE_TAX),  
  BROKER_CHRG = SUM(BROKER_CHRG),  
  TURN_TAX = SUM(TURN_TAX),  
  SEBI_TAX = SUM(SEBI_TAX),  
  OTHER_CHRG = SUM(OTHER_CHRG),  
  INS_CHRG = SUM(INS_CHRG),  
  ORDFLG,  
  TOTALBROK=SUM(TOTALBROK),  
  CONT_USER_ID  
 FROM  #FOSETTLEMENT  
 GROUP BY  
 CONTRACTNO,ORDER_NO,CPID,TRADE_NO,SAUDA_DATE,PARTY_CODE,INST_TYPE,  
 SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,AUCTIONPART,  
 SELL_BUY,CONT_USER_ID,ORDFLG  
  
 /* ------------------------------------------------------------------------  
         VBB UPDATE  
 ---------------------------------------------------------------------------*/  
 UPDATE     
  #FOSETTLEMENT_1    
 SET    
  TOTALBROK = CD_TOT_BUYBROK + CD_TOT_SELLBROK,  
  BROKAPPLIED = CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYBROK /CD_TOT_BUYQTY ELSE CD_TOT_SELLBROK/CD_TOT_SELLQTY END    
      + (CASE WHEN SERVICE_CHRG = 1 THEN     
         CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END    
      ELSE 0 END),    
  SERVICE_TAX = SERVICE_TAX + (CASE WHEN SERVICE_CHRG = 0 THEN     
       CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END    
       ELSE 0 END)  
 FROM    
  CHARGES_DETAIL (NOLOCK), CLIENT2 (NOLOCK)  
 WHERE    
  CLIENT2.PARTY_CODE = #FOSETTLEMENT_1.PARTY_CODE  
  AND CD_SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE +' 23:59'    
  AND CD_PARTY_CODE = #FOSETTLEMENT_1.PARTY_CODE     
  AND CD_INST_TYPE = INST_TYPE  
  AND CD_SYMBOL = SYMBOL    
  AND CD_EXPIRY_DATE = EXPIRYDATE    
  AND CD_OPTION_TYPE = OPTION_TYPE    
  AND CD_STRIKE_PRICE = STRIKE_PRICE    
  AND CD_TRADE_NO = TRADE_NO    
  AND CD_ORDER_NO = ORDER_NO    
  
 UPDATE #FOSETTLEMENT_1    
 SET NETRATE = PRICE + CASE WHEN SELL_BUY =1  THEN BROKAPPLIED ELSE - BROKAPPLIED END  
 WHERE BROKAPPLIED <> 0 AND NETRATE = PRICE  
  
    
 INSERT INTO #FOSETTLEMENT_1  
 SELECT    
  CD_CONTRACT_NO,  
  CD_ORDER_NO,     
  CPID = '',     
  CD_TRADE_NO,     
  CONVERT(VARCHAR,CD_SAUDA_DATE,103) AS SAUDA_DATE,     
  CD_PARTY_CODE,    
  CD_INST_TYPE,     
  CD_SYMBOL= (CASE WHEN CD_SYMBOL = '' THEN 'CONT BROK' ELSE CD_SYMBOL END),     
  EXPIRYDATE = (CASE WHEN CD_SYMBOL = '' THEN '' ELSE   
       LEFT(CONVERT(VARCHAR,CD_EXPIRY_DATE,106),11) END)  ,     
  STRIKE_PRICE = ISNULL(CD_STRIKE_PRICE,0),     
  CD_OPTION_TYPE,  
  CD_AUCTIONPART,  
  SELL_BUY = CASE WHEN CD_TOT_BUYBROK > 0 THEN 1 ELSE 2 END,  
  TRADEQTY = 0,  
  PRICE = 0,  
  BROKAPPLIED = CD_TOT_BUYBROK + CD_TOT_SELLBROK  
      + (CASE WHEN SERVICE_CHRG = 1 THEN     
      CD_TOT_BUYSERTAX + CD_TOT_SELLSERTAX  ELSE 0 END),  
  NETRATE= 0,  
  AMOUNT = 0,  
  SERVICE_TAX = (CASE WHEN SERVICE_CHRG = 0 THEN     
      CD_TOT_BUYSERTAX + CD_TOT_SELLSERTAX  ELSE 0 END),  
  BROKER_CHRG = 0,  
  TURN_TAX = 0,  
  SEBI_TAX = 0,  
  OTHER_CHRG = 0,  
  INS_CHRG = 0,  
  ORDFLG = 0,  
  TOTALBROK = CD_TOT_BUYBROK + CD_TOT_SELLBROK ,  
  CONT_USER_ID =''  
 FROM  
  CHARGES_DETAIL F (NOLOCK), CLIENT2 (NOLOCK)  
 WHERE  
  PARTY_CODE = CD_PARTY_CODE  
  AND CD_SAUDA_DATE >= @SAUDA_DATE  
  AND CD_SAUDA_DATE <= @SAUDA_DATE + ' 23:59:59'  
  AND CD_TRADE_NO = ''    
  AND CD_TOT_BUYBROK + CD_TOT_SELLBROK > 0      
  AND CD_PARTY_CODE IN   
  (  
   SELECT   
    DISTINCT PARTY_CODE   
   FROM  
    #FOSETTLEMENT (NOLOCK)  
  )  
  
  
 /* ------------------------------------------------------------------------  
      TAKING FILTERD CLIENT DETAILS TO  TABLE  
 ---------------------------------------------------------------------------*/  
  
 DELETE CONTRACT_MASTER   
 WHERE  
  TRADE_DATE >= @SAUDA_DATE AND   
  TRADE_DATE <= @SAUDA_DATE +' 23:59'  
  
 INSERT INTO  CONTRACT_MASTER  
 SELECT    
 @SAUDA_DATE,  
 C2.PARTY_CODE,C1.LONG_NAME, C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3,   
 C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.BRANCH_CD , C1.SUB_BROKER, C1.TRADER,  
 C1.AREA,C1.REGION,C1.FAMILY, C1.PAN_GIR_NO, C1.OFF_PHONE1, C1.OFF_PHONE2,   
 PRINTF, MAPIDID, UCC_CODE,C2.SERVICE_CHRG, BROKERNOTE, TURNOVER_TAX,   
 SEBI_TURN_TAX, C2.OTHER_CHRG, INSURANCE_CHRG,SEBI_NO = FD_CODE,  
 PARTICIPANTCODE = bankid,CL_TYPE,CL_STATUS  
 FROM  CLIENT1 C1 WITH ( NOLOCK ) ,   
 CLIENT2 C2 WITH ( NOLOCK )   
 LEFT OUTER JOIN UCC_CLIENT UC WITH ( NOLOCK )   
 ON C2.PARTY_CODE = UC.PARTY_CODE   
 WHERE  C2.CL_CODE = C1.CL_CODE     
 AND EXISTS (SELECT PARTY_CODE FROM #FOSETTLEMENT WHERE #FOSETTLEMENT.PARTY_CODE =  C2.PARTY_CODE)  
  
 /* ------------------------------------------------------------------------  
    TAKING CONTRACT DATA TO THE FINAL TEMP TABLE (NON SUMMARISED)  
 ---------------------------------------------------------------------------*/  
  
  
 CREATE TABLE [#CONTRACT_DATA_FO]  
 (  
  [CONTRACTNO] [varchar](14) NULL,  
  [ORDER_NO] [varchar](20) NULL,  
  [ORDER_TIME] [varchar](10) NULL,  
  [TRADE_NO] [varchar](15) NULL,  
  [TRADETIME] [varchar](10) NULL,  
  [SAUDA_DATE] [datetime] NULL,  
  [PARTY_CODE] [varchar](10) NULL,  
  [INST_TYPE] [varchar](6) NULL,  
  [SYMBOL] [varchar](12) NULL,  
  [EXPIRYDATE] [datetime] NULL,  
  [STRIKE_PRICE] [NUMERIC] (36,18) NULL,  
  [OPTION_TYPE] [varchar](2) NULL,  
  [AUCTIONPART] [varchar](2) NULL,  
  [PQTY] [int] NULL,  
  [SQTY] [int] NULL,  
  [PRATE] [NUMERIC] (36,18) NULL,  
  [SRATE] [NUMERIC] (36,18) NULL,  
  [PBROK] [NUMERIC] (36,18) NULL,  
  [SBROK] [NUMERIC] (36,18) NULL,  
  [PNETRATE] [NUMERIC] (36,18) NULL,  
  [SNETRATE] [NUMERIC] (36,18) NULL,  
  [AMOUNT] [NUMERIC] (36,18) NULL,  
  [PAMT] [NUMERIC] (36,18) NULL,  
  [SAMT] [NUMERIC] (36,18) NULL,  
  [SELL_BUY] [int] NULL,  
  [PSERVICE_TAX] [NUMERIC] (36,18) NULL,  
  [SSERVICE_TAX] [NUMERIC] (36,18) NULL,  
  [BROKER_CHRG] [NUMERIC] (36,18) NULL,  
  [TURN_TAX] [NUMERIC] (36,18) NULL,  
  [SEBI_TAX] [NUMERIC] (36,18) NULL,  
  [OTHER_CHRG] [NUMERIC] (36,18) NULL,  
  [INS_CHRG] [NUMERIC] (36,18) NULL,  
  [SERVICE_TAX] [NUMERIC] (36,18) NULL,  
  [NSERTAX] [NUMERIC] (36,18) NULL,  
  [BROKERAGE] [NUMERIC] (36,18) NULL,  
  [ORDFLG] [int] NULL,  
  [CONT_CL_RATE] [NUMERIC] (36,18),  
  [CONT_USER_ID] [varchar] (20),  
  [CONT_REMARK_ID] [varchar] (1),  
  [CONT_REMARK_DESC] [varchar] (200)  
 )   
  
  
 CREATE NONCLUSTERED INDEX [idxDt] ON #CONTRACT_DATA_FO  
 (  
  [SAUDA_DATE] ASC,  
  [PARTY_CODE] ASC,  
  [INST_TYPE] ASC,  
  [SYMBOL] ASC,  
  [EXPIRYDATE] ASC,  
  [STRIKE_PRICE] ASC,  
  [OPTION_TYPE] ASC,  
  [AUCTIONPART] ASC  
 )  
  
 INSERT INTO #CONTRACT_DATA_FO  
 SELECT    
   CONTRACTNO,     
   ORDER_NO,     
   ORDER_TIME=CPID,     
   TRADE_NO,     
   LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,     
   @SAUDA_DATE,     
   F.PARTY_CODE,     
   INST_TYPE,     
   SYMBOL,     
   EXPIRYDATE,     
   ISNULL(STRIKE_PRICE,0) STRIKE_PRICE,   
   OPTION_TYPE,     
   AUCTIONPART ,   
   PQTY = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN TRADEQTY     
     ELSE 0 END),     
   SQTY = (     
   CASE     
     WHEN SELL_BUY = 2     
     THEN TRADEQTY     
     ELSE 0 END),     
   PRATE = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN ISNULL(PRICE,0)     
     ELSE 0 END),     
   SRATE = (     
   CASE     
     WHEN SELL_BUY = 2     
     THEN ISNULL(PRICE,0)     
     ELSE 0 END),     
   PBROK =(     
   CASE     
     WHEN SELL_BUY = 1     
     THEN ISNULL((BROKAPPLIED + (     
     CASE     
       WHEN C.SERVICE_CHRG=1     
       THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)     
       ELSE 0 END )),0)     
     ELSE 0 END),     
   SBROK =(     
   CASE     
     WHEN SELL_BUY = 2     
     THEN ISNULL((BROKAPPLIED + (     
     CASE     
    WHEN C.SERVICE_CHRG=1     
       THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)     
       ELSE 0 END )),0)     
     ELSE 0 END),     
   PNETRATE = (     
   CASE     
     WHEN SELL_BUY =1     
     THEN ISNULL(NETRATE + (     
     CASE     
       WHEN C.SERVICE_CHRG = 1     
       THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)     
       ELSE 0 END),0)     
     ELSE 0 END),     
   SNETRATE = (     
   CASE     
     WHEN SELL_BUY =2     
     THEN ISNULL(NETRATE - (     
     CASE     
       WHEN C.SERVICE_CHRG = 1     
       THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)     
       ELSE 0 END),0)     
     ELSE 0 END),     
   ISNULL(AMOUNT,0) AMOUNT ,     
   PAMT=(     
   CASE     
     WHEN SELL_BUY = 1     
     THEN ((TRADEQTY * PRICE) + TOTALBROK) + (     
     CASE     
       WHEN C.SERVICE_CHRG = 1     
       THEN ISNULL((F.SERVICE_TAX),0)     
  
       ELSE (     
       CASE     
         WHEN C.SERVICE_CHRG = 0     
         THEN 0     
         ELSE (     
         CASE     
           WHEN C.SERVICE_CHRG = 2     
           THEN 0     
           ELSE 0 END) END ) END )     
     ELSE 0 END),     
   SAMT=(     
   CASE     
     WHEN SELL_BUY = 2     
     THEN ((TRADEQTY * PRICE) - TOTALBROK) - (     
     CASE     
       WHEN C.SERVICE_CHRG = 1     
       THEN ISNULL((F.SERVICE_TAX),0)     
       ELSE (     
     CASE    
         WHEN C.SERVICE_CHRG = 0     
         THEN 0     
         ELSE (     
         CASE     
           WHEN C.SERVICE_CHRG = 2     
           THEN 0     
           ELSE 0 END ) END ) END)     
     ELSE 0 END),     
   SELL_BUY,     
   PSERVICE_TAX= (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN (     
     CASE     
       WHEN C.SERVICE_CHRG=0     
       THEN (F.SERVICE_TAX)     
       ELSE (     
       CASE     
         WHEN C.SERVICE_CHRG=1     
         THEN 0     
         ELSE (     
         CASE     
           WHEN C.SERVICE_CHRG=2     
           THEN 0 END) END) END)     
     ELSE 0 END),     
   SSERVICE_TAX= (     
     CASE     
     WHEN SELL_BUY = 2     
     THEN (     
     CASE     
       WHEN C.SERVICE_CHRG=0     
       THEN (F.SERVICE_TAX)     
       ELSE (     
       CASE     
         WHEN C.SERVICE_CHRG=1     
         THEN 0     
         ELSE (     
         CASE     
           WHEN C.SERVICE_CHRG=2     
           THEN 0 END) END) END)     
     ELSE 0 END),     
   BROKER_CHRG = (     
   CASE     
     WHEN BROKERNOTE = 1     
     THEN BROKER_CHRG     
     ELSE 0 END ),     
   TURN_TAX = (     
   CASE     
     WHEN TURNOVER_TAX = 1     
     THEN TURN_TAX     
     ELSE 0 END),     
   SEBI_TAX = (     
   CASE     
     WHEN SEBI_TURN_TAX = 1     
     THEN SEBI_TAX     
     ELSE 0 END),     
   OTHER_CHRG = (     
   CASE     
     WHEN C.OTHER_CHRG = 1     
     THEN F.OTHER_CHRG     
     ELSE 0 END) ,     
   INS_CHRG = (     
   CASE     
     WHEN INSURANCE_CHRG = 1     
     THEN INS_CHRG     
     ELSE 0 END ),     
   SERVICE_TAX = (     
   CASE     
     WHEN SERVICE_CHRG = 0     
     THEN SERVICE_TAX     
     ELSE 0 END ),     
   NSERTAX= (     
   CASE     
     WHEN SERVICE_CHRG = 0     
     THEN SERVICE_TAX    
     ELSE 0 END ),     
   BROKERAGE = TOTALBROK,  
   ORDFLG,  
   CONT_CL_RATE = 0,  
   CONT_USER_ID,  
   CONT_REMARK_ID = '',  
   CONT_REMARK_DESC = ''  
 FROM    #FOSETTLEMENT_1 F, CONTRACT_MASTER C  
 WHERE            
   C.PARTY_CODE = F.PARTY_CODE  
   AND LEFT(SAUDA_DATE,11) = LEFT(TRADE_DATE,11)  
   AND PRINTF <> '3'  
  
 /* ------------------------------------------------------------------------  
    TAKING CONTRACT DATA TO THE FINAL TABLE (SUMMARISED)  
 ---------------------------------------------------------------------------*/  
  
  
 INSERT INTO #CONTRACT_DATA_FO  
 SELECT    
   CONTRACTNO,     
   ORDER_NO='000000000000000',     
   ORDER_TIME      = '',  
   TRADE_NO        ='0000000',  
   TRADETIME       ='00:00:00',  
   @SAUDA_DATE,  
   F.PARTY_CODE,  
   INST_TYPE,  
   SYMBOL,  
   EXPIRYDATE,  
   STRIKE_PRICE,  
   OPTION_TYPE,  
   AUCTIONPART,  
   PQTY = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN SUM(TRADEQTY)  
     ELSE 0 END),     
   SQTY = (     
   CASE     
     WHEN SELL_BUY = 2     
     THEN SUM(TRADEQTY)  
     ELSE 0 END),     
   PRATE = (     
   CASE     
     WHEN SELL_BUY = 1     
   THEN SUM(ISNULL(TRADEQTY*PRICE,0))/SUM(TRADEQTY)  
     ELSE 0 END),     
   SRATE = (     
   CASE     
     WHEN SELL_BUY = 2     
     THEN SUM(ISNULL(TRADEQTY*PRICE,0))/SUM(TRADEQTY)  
     ELSE 0 END),     
   PBROK =(     
   CASE     
     WHEN SELL_BUY = 1    
     THEN SUM(BROKAPPLIED*TRADEQTY)/SUM(TRADEQTY) + (     
     SUM(CASE     
    WHEN C.SERVICE_CHRG=1    
       THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)     
       ELSE 0 END ))  
     ELSE 0 END),      
   SBROK =(     
   CASE     
     WHEN SELL_BUY = 2     
     THEN SUM(BROKAPPLIED*TRADEQTY)/SUM(TRADEQTY) + (     
     SUM(CASE     
    WHEN C.SERVICE_CHRG=1    
       THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)     
       ELSE 0 END ))  
     ELSE 0 END),     
   PNETRATE = (     
   CASE     
     WHEN SELL_BUY =1     
     THEN SUM(ISNULL(NETRATE + (     
     CASE     
       WHEN C.SERVICE_CHRG = 1     
       THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)     
       ELSE 0 END),0))/SUM(TRADEQTY)     
     ELSE 0 END),     
   SNETRATE = (     
   CASE     
     WHEN SELL_BUY =2     
     THEN SUM(ISNULL(NETRATE - (     
     CASE     
       WHEN C.SERVICE_CHRG = 1     
       THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)     
       ELSE 0 END),0))/SUM(TRADEQTY)  
     ELSE 0 END),     
   AMOUNT = SUM(ISNULL(AMOUNT,0)),     
   PAMT= SUM(     
   CASE     
     WHEN SELL_BUY = 1     
     THEN ((TRADEQTY * PRICE) + TOTALBROK) + (     
     CASE     
       WHEN C.SERVICE_CHRG = 1     
       THEN ISNULL((F.SERVICE_TAX),0)     
  
       ELSE (     
       CASE     
         WHEN C.SERVICE_CHRG = 0     
         THEN 0     
         ELSE (     
         CASE     
           WHEN C.SERVICE_CHRG = 2     
           THEN 0     
           ELSE 0 END) END ) END )     
     ELSE 0 END),     
   SAMT= SUM(     
   CASE     
     WHEN SELL_BUY = 2     
     THEN((TRADEQTY * PRICE) - TOTALBROK) - (     
     CASE     
       WHEN C.SERVICE_CHRG = 1     
       THEN ISNULL((F.SERVICE_TAX),0)     
       ELSE (     
       CASE              WHEN C.SERVICE_CHRG = 0     
         THEN 0     
         ELSE (     
         CASE     
           WHEN C.SERVICE_CHRG = 2     
           THEN 0     
           ELSE 0 END ) END ) END)     
     ELSE 0 END),     
   SELL_BUY,     
   PSERVICE_TAX= SUM(     
   CASE     
     WHEN SELL_BUY = 1     
     THEN (     
     CASE     
       WHEN C.SERVICE_CHRG=0     
       THEN (F.SERVICE_TAX)     
       ELSE (     
       CASE     
         WHEN C.SERVICE_CHRG=1     
         THEN 0     
         ELSE (     
         CASE     
           WHEN C.SERVICE_CHRG=2     
           THEN 0 END) END) END)     
     ELSE 0 END),     
   SSERVICE_TAX= SUM(     
     CASE     
     WHEN SELL_BUY = 2     
     THEN (     
     CASE    
       WHEN C.SERVICE_CHRG=0     
       THEN (F.SERVICE_TAX)     
       ELSE (     
       CASE     
         WHEN C.SERVICE_CHRG=1     
         THEN 0     
         ELSE (     
         CASE     
           WHEN C.SERVICE_CHRG=2     
           THEN 0 END) END) END)     
     ELSE 0 END),     
   BROKER_CHRG = SUM(     
   CASE     
     WHEN BROKERNOTE = 1     
     THEN BROKER_CHRG     
     ELSE 0 END ),     
   TURN_TAX = SUM(     
   CASE     
     WHEN TURNOVER_TAX = 1     
     THEN TURN_TAX     
     ELSE 0 END),     
   SEBI_TAX = SUM(     
   CASE     
     WHEN SEBI_TURN_TAX = 1     
     THEN SEBI_TAX     
     ELSE 0 END),     
   OTHER_CHRG = SUM(     
   CASE     
     WHEN C.OTHER_CHRG = 1     
     THEN F.OTHER_CHRG     
     ELSE 0 END) ,     
   INS_CHRG = SUM(     
   CASE     
     WHEN INSURANCE_CHRG = 1     
     THEN INS_CHRG     
     ELSE 0 END ),     
   SERVICE_TAX = SUM(     
   CASE     
     WHEN SERVICE_CHRG = 0     
     THEN SERVICE_TAX     
     ELSE 0 END ),     
   NSERTAX= SUM(     
   CASE     
     WHEN SERVICE_CHRG = 0     
     THEN SERVICE_TAX    
     ELSE 0 END ),     
   BROKERAGE = SUM(TOTALBROK),  
   ORDFLG,  
   CONT_CL_RATE = 0,  
   CONT_USER_ID ='',  
   CONT_REMARK_ID = '',  
   CONT_REMARK_DESC = ''  
 FROM  
   #FOSETTLEMENT_1 F,CONTRACT_MASTER C  
 WHERE            
   C.PARTY_CODE = F.PARTY_CODE     
   AND LEFT(SAUDA_DATE,11) = LEFT(TRADE_DATE,11)  
   AND PRINTF = '3'  
 GROUP BY   
   CONTRACTNO,     
   F.PARTY_CODE,  
   INST_TYPE,  
   SYMBOL,  
   EXPIRYDATE,  
   STRIKE_PRICE,  
   OPTION_TYPE,  
   AUCTIONPART,  
   SELL_BUY,  
   ORDFLG    
  
 UPDATE #CONTRACT_DATA_FO SET CONT_CL_RATE = C.CL_RATE  
 FROM FOCLOSING C (NOLOCK)  
 WHERE C.TRADE_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'  
 AND #CONTRACT_DATA_FO.INST_TYPE  = C.INST_TYPE  
 AND #CONTRACT_DATA_FO.SYMBOL  = C.SYMBOL  
 AND #CONTRACT_DATA_FO.EXPIRYDATE  = C.EXPIRYDATE  
 AND #CONTRACT_DATA_FO.STRIKE_PRICE  = C.STRIKE_PRICE  
 AND #CONTRACT_DATA_FO.OPTION_TYPE  = C.OPTION_TYPE  
 AND LEFT(#CONTRACT_DATA_FO.INST_TYPE,3) = 'FUT'  
     
 IF (SELECT COUNT(1) FROM SYS.TABLES WHERE NAME='TBL_CONTRACT_TERMINAL_MAPPING') > 0   
 BEGIN  
  UPDATE #CONTRACT_DATA_FO SET CONT_REMARK_ID = ISNULL(T.REMARK_ID,''), CONT_REMARK_DESC = ISNULL(T.REMARK_DESC,'')   
  FROM TBL_CONTRACT_TERMINAL_MAPPING T WITH (NOLOCK)   
  WHERE CONT_USER_ID = T.TERMINAL_ID  
  AND ISNULL(T.TERMINAL_ID,'') <> ''   
  AND @SAUDA_DATE BETWEEN CONVERT(DATETIME,CONVERT(VARCHAR,FROM_DATE,103),103) AND END_DATE   
  
  UPDATE #CONTRACT_DATA_FO SET CONT_REMARK_ID = ISNULL(T.REMARK_ID,''), CONT_REMARK_DESC = ISNULL(T.REMARK_DESC,'')   
  FROM TBL_CONTRACT_TERMINAL_MAPPING T WITH (NOLOCK)   
  WHERE #CONTRACT_DATA_FO.ORDER_NO = T.ORDER_NO  
  AND ISNULL(T.ORDER_NO,'') <> ''  
  AND @SAUDA_DATE BETWEEN CONVERT(DATETIME,CONVERT(VARCHAR,FROM_DATE,103),103) AND END_DATE   
 END  
  
  
 UPDATE #CONTRACT_DATA_FO     
 SET ORDER_NO = F.ORDER_NO,    
 TRADE_NO = F.TRADE_NO,    
 ORDER_TIME = F.CPID,    
 TRADETIME = LEFT(CONVERT(VARCHAR,F.SAUDA_DATE,108),11)    
 FROM #FOSETTLEMENT_1 F    
 WHERE LEFT(#CONTRACT_DATA_FO.SAUDA_DATE,11) = LEFT(F.SAUDA_DATE,11)    
 AND #CONTRACT_DATA_FO.PARTY_CODE = F.PARTY_CODE    
 AND #CONTRACT_DATA_FO.INST_TYPE = F.INST_TYPE    
 AND #CONTRACT_DATA_FO.SYMBOL = F.SYMBOL    
 AND #CONTRACT_DATA_FO.EXPIRYDATE = F.EXPIRYDATE    
 AND #CONTRACT_DATA_FO.STRIKE_PRICE = F.STRIKE_PRICE    
 AND #CONTRACT_DATA_FO.OPTION_TYPE = F.OPTION_TYPE    
 AND #CONTRACT_DATA_FO.AUCTIONPART = F.AUCTIONPART    
 AND #CONTRACT_DATA_FO.SELL_BUY = F.SELL_BUY    
 AND #CONTRACT_DATA_FO.ORDER_NO = '000000000000000'    
 AND F.SAUDA_DATE = (SELECT SAUDA_DATE=MIN(SAUDA_DATE)    
   FROM #FOSETTLEMENT_1 F1    
   WHERE F1.PARTY_CODE = F.PARTY_CODE    
   AND F1.INST_TYPE = F.INST_TYPE    
   AND F1.SYMBOL = F.SYMBOL    
   AND F1.EXPIRYDATE = F.EXPIRYDATE    
   AND F1.STRIKE_PRICE = F.STRIKE_PRICE    
   AND F1.OPTION_TYPE = F.OPTION_TYPE    
   AND F1.AUCTIONPART = F.AUCTIONPART    
   AND F1.SELL_BUY = F.SELL_BUY)        
  
  
    
 DELETE CONTRACT_DATA  
 WHERE  
  SAUDA_DATE >= @SAUDA_DATE AND   
  SAUDA_DATE <= @SAUDA_DATE +' 23:59'  
  
 INSERT INTO CONTRACT_DATA  
 SELECT CONTRACTNO,ORDER_NO,ORDER_TIME,TRADE_NO,TRADETIME,SAUDA_DATE,PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
 AUCTIONPART,QTY=PQTY+SQTY,PQTY,SQTY,PRICE=PRATE+SRATE,PRATE,SRATE,PBROK,SBROK,PNETRATE,SNETRATE,NETAMOUNT=AMOUNT,AMOUNT,PAMT,  
 SAMT,SELL_BUY,PSERVICE_TAX,SSERVICE_TAX,  
 BROKER_CHRG,TURN_TAX,SEBI_TAX,OTHER_CHRG,INS_CHRG,SERVICE_TAX,NSERTAX,BROKERAGE,ORDFLG,PRICEUNIT='',QTY_UNIT='',CONT_CL_RATE,CONT_USER_ID,  
 CONT_REMARK_ID,CONT_REMARK_DESC,'',''  
 FROM #CONTRACT_DATA_FO  
  
 DROP TABLE #CONTRACT_DATA_FO  
  
 /* ------------------------------------------------------------------------  
    TAKING CONTRACT DATA TO THE FINAL ARCHIVAL TABLE (SUMMARISED)  
 ---------------------------------------------------------------------------*/  
  
 DELETE CONTRACT_DATA_DET  
 WHERE  
  SAUDA_DATE >= @SAUDA_DATE AND   
  SAUDA_DATE <= @SAUDA_DATE +' 23:59'  
    
 INSERT INTO CONTRACT_DATA_DET  
 SELECT    
   CONTRACTNO,     
   ORDER_NO,     
   ORDER_TIME=CPID,     
   TRADE_NO,     
   LEFT(CONVERT(VARCHAR,SAUDA_DATE,108),11) AS TRADETIME,     
   @SAUDA_DATE,     
   F.PARTY_CODE,     
   INST_TYPE,     
   SYMBOL,     
   LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,     
   ISNULL(STRIKE_PRICE,0) STRIKE_PRICE,     
   OPTION_TYPE,  
   AUCTIONPART ,  
   QTY = TRADEQTY,  
   PQTY = (     
    CASE     
     WHEN SELL_BUY = 1     
     THEN TRADEQTY     
     ELSE 0 END),     
   SQTY = (     
   CASE     
     WHEN SELL_BUY = 2     
     THEN TRADEQTY     
     ELSE 0 END),   
   PRICE ,    
   PRATE = (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN ISNULL(PRICE,0)     
     ELSE 0 END),     
   SRATE = (     
   CASE     
     WHEN SELL_BUY = 2     
     THEN ISNULL(PRICE,0)     
     ELSE 0 END),     
   PBROK =(     
   CASE     
     WHEN SELL_BUY = 1     
     THEN ISNULL((BROKAPPLIED + (     
     CASE     
       WHEN C.SERVICE_CHRG=1     
       THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)     
       ELSE 0 END )),0)     
     ELSE 0 END),     
   SBROK =(     
   CASE     
     WHEN SELL_BUY = 2     
     THEN ISNULL((BROKAPPLIED + (     
     CASE     
    WHEN C.SERVICE_CHRG=1     
       THEN ISNULL(F.SERVICE_TAX/TRADEQTY,0)     
       ELSE 0 END )),0)     
     ELSE 0 END),     
   PNETRATE = (     
   CASE     
     WHEN SELL_BUY =1     
     THEN ISNULL(NETRATE + (     
     CASE     
       WHEN C.SERVICE_CHRG = 1     
       THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)     
       ELSE 0 END),0)     
     ELSE 0 END),     
   SNETRATE = (     
   CASE     
     WHEN SELL_BUY =2     
     THEN ISNULL(NETRATE - (     
     CASE     
       WHEN C.SERVICE_CHRG = 1     
       THEN ISNULL((F.SERVICE_TAX/TRADEQTY),0)     
       ELSE 0 END),0)     
     ELSE 0 END),     
   NETAMOUNT = AMOUNT,  
   ISNULL(AMOUNT,0) AMOUNT ,     
   PAMT=(     
   CASE       
     WHEN SELL_BUY = 1     
     THEN ((TRADEQTY * PRICE) + TOTALBROK) + (     
     CASE     
       WHEN C.SERVICE_CHRG = 1     
       THEN ISNULL((F.SERVICE_TAX),0)     
  
       ELSE (     
       CASE     
         WHEN C.SERVICE_CHRG = 0     
    THEN 0     
         ELSE (     
         CASE     
           WHEN C.SERVICE_CHRG = 2     
           THEN 0     
           ELSE 0 END) END ) END )     
     ELSE 0 END),     
   SAMT=(     
   CASE     
     WHEN SELL_BUY = 2     
     THEN ((TRADEQTY * PRICE) - TOTALBROK) - (     
     CASE     
       WHEN C.SERVICE_CHRG = 1   
       THEN ISNULL((F.SERVICE_TAX),0)     
       ELSE (     
       CASE     
         WHEN C.SERVICE_CHRG = 0     
         THEN 0     
         ELSE (     
         CASE     
           WHEN C.SERVICE_CHRG = 2     
           THEN 0     
           ELSE 0 END ) END ) END)     
     ELSE 0 END),     
   SELL_BUY,     
   PSERVICE_TAX= (     
   CASE     
     WHEN SELL_BUY = 1     
     THEN (     
     CASE     
       WHEN C.SERVICE_CHRG=0     
       THEN (F.SERVICE_TAX)     
       ELSE (     
       CASE     
         WHEN C.SERVICE_CHRG=1     
         THEN 0     
         ELSE (     
         CASE     
    WHEN C.SERVICE_CHRG=2     
 THEN 0 END) END) END)     
     ELSE 0 END),     
   SSERVICE_TAX= (     
     CASE     
     WHEN SELL_BUY = 2     
     THEN (     
     CASE     
       WHEN C.SERVICE_CHRG=0     
       THEN (F.SERVICE_TAX)     
       ELSE (     
       CASE     
         WHEN C.SERVICE_CHRG=1     
         THEN 0     
         ELSE (     
         CASE     
           WHEN C.SERVICE_CHRG=2     
           THEN 0 END) END) END)     
     ELSE 0 END),     
   BROKER_CHRG = (     
   CASE     
     WHEN BROKERNOTE = 1     
     THEN BROKER_CHRG     
     ELSE 0 END ),     
   TURN_TAX = (     
   CASE     
     WHEN TURNOVER_TAX = 1     
     THEN TURN_TAX     
     ELSE 0 END),     
   SEBI_TAX = (     
   CASE     
     WHEN SEBI_TURN_TAX = 1     
     THEN SEBI_TAX     
     ELSE 0 END),     
   OTHER_CHRG = (     
   CASE     
     WHEN C.OTHER_CHRG = 1     
     THEN F.OTHER_CHRG     
     ELSE 0 END) ,     
   INS_CHRG = (     
   CASE     
     WHEN INSURANCE_CHRG = 1     
     THEN INS_CHRG     
     ELSE 0 END ),     
   SERVICE_TAX = (     
   CASE     
     WHEN SERVICE_CHRG = 0     
     THEN SERVICE_TAX     
     ELSE 0 END ),     
   NSERTAX= (     
   CASE     
     WHEN SERVICE_CHRG = 0     
     THEN SERVICE_TAX    
     ELSE 0 END ),     
   BROKERAGE = TOTALBROK,     
   ORDFLG,'',''  
 FROM    #FOSETTLEMENT_1 F, CONTRACT_MASTER C  
 WHERE            
   C.PARTY_CODE = F.PARTY_CODE  
   AND LEFT(SAUDA_DATE,11) = LEFT(TRADE_DATE,11)  
   AND PRINTF = '3'  
  
 /* ------------------------------------------------------------------------  
      CLEANING TEMPORARY TABLES  
 ---------------------------------------------------------------------------*/  
  
 DROP TABLE #FOSETTLEMENT  
 DROP TABLE #FOSETTLEMENT_1  
  
  
 /* ------------------------------------------------------------------------  
   UPDATING PROCESS TRACKER  
 ---------------------------------------------------------------------------*/  
  
  UPDATE   
   V2_BUSINESS_PROCESS   
  SET   
   CONTRACT = CONTRACT + 1 ,  
   LASTUPDATEDATE = GETDATE()     
  WHERE   
   LEFT(BUSINESS_DATE,11) = @SAUDA_DATE  
  
  INSERT INTO V2_PROCESS_STATUS_LOG   
  (   
   EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,  
   FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP  
  )  
  SELECT  
   EXCHANGE=(SELECT TOP 1 EXCHANGE FROM FOTAXES),  
   SEGMENT='FUTURES',  
   BUSINESSDATE=@SAUDA_DATE,  
   PROCESSID = 'CONTRACT',  
   PROCESSNAME = 'CONTRACT POPUP',  
   FILENAME='',  
   START_END_FLAG=1,  
   PROCESSDATE=GETDATE(),  
   PROCESSBY=@USERNAME,  
   MACHINEIP=''     
END  
IF @STRMODE = 'FETCH'  
BEGIN  
 DECLARE @EXCHANGECODE VARCHAR(3)  
 SELECT  TOP 1 @EXCHANGECODE= EXCHANGE FROM FOGLOBALS (NOLOCK)  
  
 IF @FNOBILL_FLAG = 1   -- CONTRACT CUM BILL ENABLED  
 BEGIN  
   
   SELECT   
    CONTRACTNO,  
    CONTRACTNO_NEW = CONTRACTNO,  
    SAUDA_DATE,  
    SETT_NO = '',  
    SETT_TYPE = '',  
    SETT_DATE = '',  
    EXCHANGE = @EXCHANGECODE ,  
    SEGMENT = 'FUTURES',  
    ORDER_NO = '',  
    ORDER_TIME = '',  
    TRADE_NO = '',  
    TRADE_TIME='',  
    SCRIPNAME = (CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ',''))   
        ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' '   
        + CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE)  END),  
    QTY=ABS(SUM(PQTY-SQTY)),  
    TMARK= '0',  
    SELL_BUY=(CASE WHEN SUM(PQTY-SQTY) > 0 THEN 1 ELSE 2 END),  
    MARKETRATE = (CASE WHEN SUM(PQTY-SQTY) <> 0 THEN SUM(PAMT+SAMT)/SUM(PQTY+SQTY) ELSE 0 END),  
    MARKETAMT = SUM(PAMT+SAMT),  
    BROKERAGE = SUM(PBROKAMT-SBROKAMT),  
    SERVICE_TAX = SUM(SERVICE_TAX),  
    INS_CHRG = SUM(INS_CHRG),  
    NETAMOUNT = SUM(SBILLAMT-PBILLAMT),  
    SEBI_TAX = SUM(SEBI_TAX),  
    TURN_TAX = SUM(TURN_TAX),  
    BROKER_CHRG = SUM(BROKER_NOTE),  
    OTHER_CHRG = SUM(D.OTHER_CHRG),  
    NETAMOUNTALL= 0,  
    BROK  = (CASE WHEN SUM(PQTY-SQTY) <> 0 THEN SUM(PBROKAMT-SBROKAMT)/SUM(PQTY-SQTY) ELSE 0 END),  
    NETRATE = 0,  
    CL_RATE = (CASE WHEN SUM(PQTY-SQTY) <> 0 THEN  ABS(SUM((PQTY-SQTY)*CL_RATE) / SUM(PQTY-SQTY)) ELSE 0 END),   
    BROKERSEBIREGNO = O.BROKERSEBIREGNO,  
    MEMBERCODE = O.MEMBERCODE,  
    CINNO = O.CIN,  
    SETTTYPE_DESC='',  
    BFCF_FLAG = 'BF_'+LEFT(INST_TYPE,1),   
    CONTRACT_HEADER_DET = '',   
    REMARK = '',   
    COMPANYNAME = O.COMPANY, USER_ID='',   
    REMARK_ID = '',   
    REMARK_DESC = '',   
    NETOBLIGATION = 0,  
    M.BRANCH_CD,   
    M.SUB_BROKER,   
    M.TRADER,   
    M.AREA,   
    M.REGION,   
    M.FAMILY,   
    PARTY_CODE= D.PARTY_CODE,  
    PARTYNAME = LONG_NAME,  
    M.L_ADDRESS1,  
    M.L_ADDRESS2,  
    M.L_ADDRESS3,  
    M.L_STATE,  
    M.L_CITY,  
    M.L_ZIP,  
    M.OFF_PHONE1,  
    M.OFF_PHONE2,  
    M.PAN_GIR_NO,  
    MAPIDID = '',  
    UCC_CODE= '',  
    SEBI_NO = FD_CODE,  
    PARTICIPANT_CODE = BANKID,  
    M.CL_TYPE,  
    SERVICE_CHRG,  
    PRINTF,M.CL_STATUS  
  
   FROM   
    FOBILLVALAN D WITH (NOLOCK),  
    DBO.CLIENT1 M WITH (NOLOCK),  
    DBO.FOOWNER O WITH (NOLOCK),  
    DBO.CLIENT2 C2 WITH (NOLOCK)  
  WHERE  
   M.CL_CODE = C2.PARTY_CODE  
   AND M.CL_CODE = D.PARTY_CODE  
   AND M.CL_TYPE <> 'INS'  
   AND LEFT(INST_TYPE,3) = 'FUT'   
   AND D.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'  
   AND TRADETYPE = 'BF'      
  GROUP BY   
   CONTRACTNO, SAUDA_DATE, M.BRANCH_CD,  M.SUB_BROKER,   
   M.TRADER, M.AREA,  M.REGION,  M.FAMILY,  D.PARTY_CODE,  
   LONG_NAME, M.L_ADDRESS1, M.L_ADDRESS2, M.L_ADDRESS3, M.L_STATE,  
   M.L_CITY, M.L_ZIP, M.OFF_PHONE1, M.OFF_PHONE2, M.PAN_GIR_NO,  
   FD_CODE, BANKID, M.CL_TYPE, SERVICE_CHRG, PRINTF,   
   CASE   
   WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ',''))   
   ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' '   
   + CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE)   
   END,LEFT(INST_TYPE,1),  
   O.BROKERSEBIREGNO,O.MEMBERCODE,O.CIN,BRANCH_CD,M.SUB_BROKER,O.COMPANY,M.CL_STATUS    
   HAVING SUM(PQTY-SQTY) <> 0   
   
  UNION ALL  
    
  SELECT   
    CONTRACTNO,  
    CONTRACTNO_NEW = CONTRACTNO,  
    SAUDA_DATE,  
    SETT_NO = '',  
    SETT_TYPE = '',  
    SETT_DATE = '',  
    EXCHANGE = @EXCHANGECODE ,  
    SEGMENT = 'FUTURES',  
    ORDER_NO,  
    ORDER_TIME,  
    TRADE_NO,  
    TRADE_TIME=TRADETIME,  
    SCRIPNAME = (  
    CASE   
    WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ',''))   
    ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' '   
    + CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE)   
    END),  
    QTY =PQTY+SQTY,  
    TMARK = ORDFLG,  
    SELL_BUY ,  
    MARKETRATE = PRATE+SRATE,  
    MARKETAMT = ((PRATE + SRATE)*(PQTY+SQTY)),  
    BROKERAGE,  
    SERVICE_TAX,  
    INS_CHRG,  
    NETAMOUNT = CASE WHEN LEFT(INST_TYPE,3) = 'FUT'   
       THEN (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT) END)   
       ELSE (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT)END) END ,  
    SEBI_TAX,  
    TURN_TAX,  
    BROKER_CHRG,  
    D.OTHER_CHRG,  
    NETAMOUNTALL = (CASE WHEN SELL_BUY = 1  
       THEN -(PAMT+NSERTAX+INS_CHRG+SEBI_TAX+TURN_TAX+BROKER_CHRG+D.OTHER_CHRG)  
       ELSE (SAMT-NSERTAX-INS_CHRG-SEBI_TAX-TURN_TAX-BROKER_CHRG-D.OTHER_CHRG)  
       END),  
    BROK = (PBROK+SBROK),  
    NETRATE = (CASE WHEN SELL_BUY = 1  THEN (CASE WHEN PQTY >0 THEN PAMT/PQTY ELSE 0 END)   
      ELSE (CASE WHEN SQTY >0 THEN SAMT/SQTY ELSE 0 END) END),  
    CL_RATE = CONT_CL_RATE,   
    BROKERSEBIREGNO = O.BROKERSEBIREGNO,MEMBERCODE=O.MEMBERCODE,CINNO=O.CIN,SETTTYPE_DESC='', BFCF_FLAG = 'BT_' +LEFT(INST_TYPE,1),   
    CONTRACT_HEADER_DET = '', REMARK = '',   
    COMPANYNAME = O.COMPANY, [USER_ID]=CONT_USER_ID,   
    REMARK_ID = CONT_REMARK_ID,  REMARK_DESC = CONT_REMARK_DESC,   
    NETOBLIGATION = 0,   
    M.BRANCH_CD,  M.SUBBROKER,  M.TRADER,  M.AREA,   
    M.REGION,  M.FAMILY,  PARTY_CODE= D.PARTY_CODE,  
    M.PARTYNAME, M.L_ADDRESS1, M.L_ADDRESS2, M.L_ADDRESS3,  
    M.L_STATE, M.L_CITY, M.L_ZIP, M.OFF_PHONE1, M.OFF_PHONE2,  
    M.PAN_GIR_NO, M.MAPIDID, M.UCC_CODE, M.SEBI_NO,  
    PARTICIPANT_CODE = '',  
    CL_TYPE,  
    M.SERVICE_CHRG,  
    M.PRINTF,CL_STATUS  
  FROM   
   CONTRACT_DATA D WITH (NOLOCK),  
   CONTRACT_MASTER M WITH (NOLOCK),  
   DBO.FOOWNER O WITH (NOLOCK)  
  WHERE  
   M.TRADE_DATE  = D.SAUDA_DATE  
   AND M.PARTY_CODE = D.PARTY_CODE  
   AND D.SAUDA_DATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'  
  ORDER BY  
   SAUDA_DATE,D.PARTY_CODE  
 END  
 ELSE  
 BEGIN  
  SELECT   
    CONTRACTNO,  
    CONTRACTNO_NEW = CONTRACTNO,  
    SAUDA_DATE,  
    SETT_NO = '',  
    SETT_TYPE = '',  
    SETT_DATE = '',  
    EXCHANGE = @EXCHANGECODE ,  
    SEGMENT = 'FUTURES',  
    ORDER_NO,  
    ORDER_TIME,  
    TRADE_NO,  
    TRADE_TIME=TRADETIME,  
    SCRIPNAME = (  
    CASE   
    WHEN LEFT(INST_TYPE,3) = 'FUT' THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ',''))   
    ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,EXPIRYDATE,6),' ','')) + ' '   
    + CONVERT(VARCHAR,STRIKE_PRICE) + ' ' + RTRIM(OPTION_TYPE)   
    END),  
    QTY =PQTY+SQTY,  
    TMARK = ORDFLG,  
    SELL_BUY ,  
    MARKETRATE = PRATE+SRATE,  
    MARKETAMT = ((PRATE + SRATE)*(PQTY+SQTY)),  
    BROKERAGE,  
    SERVICE_TAX,  
    INS_CHRG,  
    NETAMOUNT = CASE WHEN LEFT(INST_TYPE,3) = 'FUT'   
       THEN (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT) END)   
       ELSE (CASE WHEN SELL_BUY = 1 THEN -(PAMT) ELSE (SAMT)END) END ,  
    SEBI_TAX,  
    TURN_TAX,  
    BROKER_CHRG,  
    D.OTHER_CHRG,  
    NETAMOUNTALL = (CASE WHEN SELL_BUY = 1  
       THEN -(PAMT+NSERTAX+INS_CHRG+SEBI_TAX+TURN_TAX+BROKER_CHRG+D.OTHER_CHRG)  
       ELSE (SAMT-NSERTAX-INS_CHRG-SEBI_TAX-TURN_TAX-BROKER_CHRG-D.OTHER_CHRG)  
       END),  
    BROK = (PBROK+SBROK),  
    NETRATE = (CASE WHEN SELL_BUY = 1  THEN (CASE WHEN PQTY >0 THEN PAMT/PQTY ELSE 0 END)   
      ELSE (CASE WHEN SQTY >0 THEN SAMT/SQTY ELSE 0 END) END),  
    CL_RATE = CONT_CL_RATE,   
    BROKERSEBIREGNO = O.BROKERSEBIREGNO,MEMBERCODE=O.MEMBERCODE,CINNO=O.CIN,SETTTYPE_DESC='', BFCF_FLAG = 'BT_' +LEFT(INST_TYPE,1),   
    CONTRACT_HEADER_DET = '', REMARK = '',   
    COMPANYNAME = O.COMPANY, [USER_ID]=CONT_USER_ID,   
    REMARK_ID = CONT_REMARK_ID,  REMARK_DESC = CONT_REMARK_DESC,   
    NETOBLIGATION = 0,   
    M.BRANCH_CD,  M.SUBBROKER,  M.TRADER,  M.AREA,   
    M.REGION,  M.FAMILY,  PARTY_CODE= D.PARTY_CODE,  
    M.PARTYNAME, M.L_ADDRESS1, M.L_ADDRESS2, M.L_ADDRESS3,  
    M.L_STATE, M.L_CITY, M.L_ZIP, M.OFF_PHONE1, M.OFF_PHONE2,  
    M.PAN_GIR_NO, M.MAPIDID, M.UCC_CODE, M.SEBI_NO,  
    PARTICIPANT_CODE = '',  
    CL_TYPE,  
    M.SERVICE_CHRG,  
    M.PRINTF,CL_STATUS   
  FROM   
   CONTRACT_DATA D WITH (NOLOCK),  
   CONTRACT_MASTER M WITH (NOLOCK),  
   DBO.FOOWNER O WITH (NOLOCK)  
  WHERE  
   M.TRADE_DATE  = D.SAUDA_DATE  
   AND M.PARTY_CODE = D.PARTY_CODE  
   AND D.SAUDA_DATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'  
  ORDER BY  
   SAUDA_DATE,D.PARTY_CODE  
 END  
END  
/* ------------------------------------------------------------------------  
        END OF PROCEDURE  
---------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_BSECURFOMARGIN_PENALTY_POST
-- --------------------------------------------------



CREATE  PROCEDURE [dbo].[PR_BSECURFOMARGIN_PENALTY_POST]  
(  
 @MARGIN_DATE VARCHAR(11),  
 @POSTINGFLAG INT,  
 @LEDGERVNO VARCHAR(12),  
 @LEDGERVT VARCHAR(11),  
 @UNAME VARCHAR(20),  
 @LEDGERDT VARCHAR(11)  
)  
AS  
  
DECLARE @GLCODE VARCHAR(10)  
SELECT @GLCODE = ACCODE FROM VALANACCOUNT (NOLOCK) WHERE ACNAME ='MARGIN_SHORTAGE_PENALTY'  
  
IF ISNULL(@GLCODE,'') =''  
BEGIN  
  RAISERROR('GL CODE FOR - MARGIN_SHORTAGE_PENALTY IS NOT AVAILABLE', 16, 1)  
  RETURN  
END  
  
BEGIN TRAN  
  
IF @POSTINGFLAG = 1  
BEGIN  
 DELETE ACCOUNTCURBFO.DBO.LEDGER WHERE VDT BETWEEN @LEDGERVT AND @LEDGERVT + ' 23:59'  
 AND VTYP = '8' AND BOOKTYPE ='01'  
 AND VNO = @LEDGERVNO  
  
 DELETE ACCOUNTCURBFO.DBO.LEDGER2 WHERE VTYPE = '8' AND BOOKTYPE ='01'  
 AND VNO = @LEDGERVNO  
  
 DELETE ACCOUNTCURBFO.DBO.LEDGER3 WHERE VTYP = '8' AND BOOKTYPE ='01'  
 AND VNO = @LEDGERVNO  

 DELETE ACCOUNTCURBFO.DBO.LEDGER WHERE VDT BETWEEN @LEDGERVT AND @LEDGERVT + ' 23:59'  
 AND VTYP = '8' AND BOOKTYPE ='01'  
 AND VNO IN (SELECT LEDGER_VNO FROM ACCOUNTCURBFO.DBO.FOMARGIN_PENALTY_POST_STAT_DETAIL WHERE MARGIN_DATE = @MARGIN_DATE)  
  
 DELETE ACCOUNTCURBFO.DBO.LEDGER2 WHERE VTYPE = '8' AND BOOKTYPE ='01'  
 AND VNO IN (SELECT LEDGER_VNO FROM ACCOUNTCURBFO.DBO.FOMARGIN_PENALTY_POST_STAT_DETAIL WHERE MARGIN_DATE = @MARGIN_DATE)  
  
 DELETE ACCOUNTCURBFO.DBO.LEDGER3 WHERE VTYP = '8' AND BOOKTYPE ='01'  
 AND VNO IN (SELECT LEDGER_VNO FROM ACCOUNTCURBFO.DBO.FOMARGIN_PENALTY_POST_STAT_DETAIL WHERE MARGIN_DATE = @MARGIN_DATE)  
END  
  
UPDATE FOMARGIN_PENALTY_POST_STAT SET POST_FLAG =0 WHERE MARGIN_DATE = @MARGIN_DATE  
  
EXEC ACCOUNTCURBFO.DBO.CURBFOMARGIN_PENALTY_POST @UNAME,8,'01',@MARGIN_DATE,@GLCODE,@LEDGERVNO,@LEDGERDT  
  
COMMIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_CHARGES_DETAIL
-- --------------------------------------------------



CREATE PROCEDURE [dbo].[PR_CHARGES_DETAIL]       
(      
	 @SAUDA_DATE_FROM VARCHAR(11),      
	 @SAUDA_DATE_TO VARCHAR(11) = @SAUDA_DATE_FROM ,      
	 @PARTY_FROM VARCHAR(10)='',      
	 @PARTY_TO VARCHAR(10) ='ZZZZZZZ'  ,  
	 @USERNAME VARCHAR(50) = '' 
) AS
  
  
DECLARE @SEBI_PER NUMERIC(18, 4)  
DECLARE @ROUNDFLAG VARCHAR(1)

SET @SEBI_PER = 2.5  
SET @ROUNDFLAG = 'N'
  
/*  
	 PROCEDURE NAME  : PR_CHARGES_DETAIL  
	 DESCRIPTION : COMPUTE VOLUMN (VALUE/QUANTITY/LOT SIZE)  
	 TABLES USING  :   
	 1. SCHEME_MASTER - SCHEME DEFINITION MASTER TABLE   
	 2. SCHEME_MAPPING - SCHEME MAPPING TO END CLIENT   
	 3. CONTRACT_ROUNDING - CLIENT'S CONTRACT LEVEL ROUNDINGS  
	 4. CHARGES_DETAIL - KEEPING COMPUTED BROKERAGE  
	 
OPTIONAL PARAMETTERS (CALLING FROM EDIT BROK)
	1. CONTRACT NUMBER
	2. BROK TYPE = P BROK PERCENTAGE / V BROK VALUE /L TOTAL BROKERAGE FOR THE CONTRACT(LUMP SUM BROKERAGE)
	3. BROK TYPE = T - NON VBB CLIENT - CONTRACT LEVEL LUMP SUM BROKERAGE
	4. BROK AMOUNT
*/  
  
/*---------------------------------------------------------------------------------------------------------------  
    CREATING TEMP TABLE FOR PROCESS  
----------------------------------------------------------------------------------------------------------------*/  
  
--BEGIN TRANSACTION  
  
  
IF @PARTY_TO='' BEGIN SET @PARTY_TO ='ZZZZZ' END  
 
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 
  
UPDATE  
	FOSETTLEMENT  
SET  
 	BILLNO = C_REGULAR_LOT   
FROM  
 	FOSCRIP2  
WHERE   
	SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59:59' AND  
	PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO AND    
	FOSCRIP2.INST_TYPE = FOSETTLEMENT.INST_TYPE AND   
	FOSCRIP2.SYMBOL = FOSETTLEMENT.SYMBOL AND   
	FOSCRIP2.EXPIRYDATE = FOSETTLEMENT.EXPIRYDATE AND   
	FOSCRIP2.STRIKE_PRICE = FOSETTLEMENT.STRIKE_PRICE AND   
	FOSCRIP2.OPTION_TYPE = FOSETTLEMENT.OPTION_TYPE AND  
	FOSETTLEMENT.BILLNO <> C_REGULAR_LOT  

	

TRUNCATE TABLE  VBB_CHARGES_DETAIL_TEMP  
TRUNCATE TABLE  VBB_CHARGES_DETAIL_TEMP1  
TRUNCATE TABLE  VBB_CHARGES_DETAIL_FINAL  
TRUNCATE TABLE  VBB_FOSETTLEMENT  
TRUNCATE TABLE  TRD_FOSETTLEMENT
TRUNCATE TABLE  TRD_SCHEME_MAPPING
TRUNCATE TABLE  TRD_CONTRACT_ROUNDING   

  
/* MODIFIED THE IN CONDITION TO EXISTS AND CHANGED UNION ALL TO UNION */  
  INSERT INTO VBB_FOSETTLEMENT  
  SELECT BILLNO,  
         TRADE_NO,  
         PARTY_CODE,  
         INST_TYPE,  
         SYMBOL,  
         EXPIRYDATE,  
         STRIKE_PRICE,  
         OPTION_TYPE,  
         TRADEQTY,  
         AUCTIONPART,  
         ORDER_NO,  
         PRICE,  
         SAUDA_DATE,  
         SELL_BUY,  
         CONTRACTNO,  
         INS_CHRG,  
         TURN_TAX,  
         OTHER_CHRG,  
         SEBI_TAX,  
         BROKER_CHRG,  
         STATUS,  
         BROKAPPLIED,  
         SERVICE_TAX  
  FROM   FOSETTLEMENT F (NOLOCK)  
  WHERE  SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO + ' 23:59:59'  
         AND PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO  
         AND AUCTIONPART <> 'CA'  
         AND TRADEQTY > 0  
		 
/* POPULATE TRD TABLES FOR BROKERAGE MAPPING AND ROUNDING */  

  SELECT DISTINCT PARTY_CODE, ROUND_TO, ROFIG, ERRNUM, NOZERO INTO #FOCLTAXES
  FROM   FOCLIENTTAXES M (NOLOCK)  
  WHERE  @SAUDA_DATE_FROM BETWEEN DATE_FROM AND DATE_TO
         AND EXISTS (SELECT DISTINCT PARTY_CODE  
                     FROM   VBB_FOSETTLEMENT S  
                     WHERE  M.PARTY_CODE = S.PARTY_CODE) 
  CREATE CLUSTERED INDEX [IDXDT] ON [DBO].[#FOCLTAXES] ([PARTY_CODE])

  
  UPDATE #FOCLTAXES SET ROUND_TO = 4, ROFIG =0  ,  ERRNUM=0.5 ,  NOZERO=1
  WHERE ROUND_TO = 0

  INSERT INTO #FOCLTAXES
  SELECT PARTY_CODE,4,0,0.5,1 FROM CLIENT2 (NOLOCK)
  WHERE PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO 
  AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM #FOCLTAXES (NOLOCK))


	INSERT INTO TRD_SCHEME_MAPPING  
	SELECT *  
	FROM SCHEME_MAPPING M (NOLOCK)  
	WHERE  @SAUDA_DATE_FROM  BETWEEN SP_DATE_FROM AND SP_DATE_TO  
	 AND EXISTS (SELECT DISTINCT PARTY_CODE  
				 FROM   VBB_FOSETTLEMENT S  
	WHERE  M.SP_PARTY_CODE = S.PARTY_CODE)  


 INSERT INTO TRD_CONTRACT_ROUNDING  
  SELECT *  
  FROM   CONTRACT_ROUNDING M (NOLOCK)  
  WHERE  @SAUDA_DATE_FROM  BETWEEN  CR_DATE_FROM AND CR_DATE_TO  
         AND EXISTS (SELECT DISTINCT PARTY_CODE  
                     FROM   VBB_FOSETTLEMENT S  
                     WHERE  M.CR_PARTY_CODE = S.PARTY_CODE)  


  
/* DELETE RECORDS FROM TEMPORARY VBB SETTLEMENT TABLE FOR CLIENT WHERE VBB IS NOT DEFINED */  
  
  DELETE FROM VBB_FOSETTLEMENT  
  WHERE       NOT EXISTS (SELECT DISTINCT PARTY_CODE  
                          FROM   (SELECT PARTY_CODE = SP_PARTY_CODE  
                                  FROM   TRD_SCHEME_MAPPING  
                                  WHERE  SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO  
                                  UNION   
                                  SELECT PARTY_CODE = CR_PARTY_CODE  
               FROM  TRD_CONTRACT_ROUNDING  
                                  WHERE  SAUDA_DATE BETWEEN CR_DATE_FROM AND CR_DATE_TO) A  
                  WHERE  A.PARTY_CODE = VBB_FOSETTLEMENT.PARTY_CODE)  
  
 
/*---------------------------------------------------------------------------------------------------------------  
    FETCHING DATA FOR FLAT VALUE BASED BROKERAGE  
----------------------------------------------------------------------------------------------------------------*/  
  
		SELECT     
		    T_SAUDADATE = CONVERT(VARCHAR,SAUDA_DATE,103),    
		    T_PARTY_CODE = PARTY_CODE,    
		    T_INST_TYPE = INST_TYPE,    
		    T_SYMBOL = SYMBOL,    
		    T_EXPIRYDATE = EXPIRYDATE,    
		    T_OPTION_TYPE = OPTION_TYPE,    
		    T_STRIKE_PRICE = STRIKE_PRICE,    
		    T_AUCTIONPART = AUCTIONPART,
		    TOT_BUYQTY = SUM(CASE WHEN SELL_BUY = 1     
		       THEN    
		        (TRADEQTY )    
		       ELSE    
		        0    
		       END),    
		    TOT_SELLQTY = SUM(CASE WHEN SELL_BUY = 2    
		       THEN    
		        (TRADEQTY )    
		       ELSE    
		        0    
		       END),  
		    TOT_BUYTURNOVER = SUM(CASE WHEN SELL_BUY = 1     
		       THEN    
		        (TRADEQTY * PRICE)    
		       ELSE    
		        0    
		       END),    
		    TOT_SELLTURNOVER = SUM(CASE WHEN SELL_BUY = 2    
		       THEN    
		        (TRADEQTY * PRICE)    
		       ELSE    
		        0    
		       END)
		INTO #VBB_FOSETTLEMENT
		FROM    
			VBB_FOSETTLEMENT   
		GROUP BY    
			CONVERT(VARCHAR,SAUDA_DATE,103),PARTY_CODE,INST_TYPE,SYMBOL,
			EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,AUCTIONPART  
  
		SELECT     
			 TRADE_NO=PRADNYA.DBO.REPLACETRADENO(TRADE_NO),ORDER_NO,F.PARTY_CODE,CONTRACTNO,SELL_BUY,    
			 INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,    
			 TRADEQTY,LOTSIZE = CONVERT(BIGINT,BILLNO),    
			 SAUDA_DATE=LEFT(SAUDA_DATE,11),PRICE,       
			 SP_PARTY_CODE,SP_COMPUTATION_LEVEL,SP_INST_TYPE,SP_SCRIP,SP_SCHEME_ID,SP_TRD_TYPE,    
			 SP_SCHEME_TYPE,SP_MULTIPLIER,SP_BUY_BROK,SP_SELL_BROK,SP_RES_MULTIPLIER,    
			 SP_RES_BUY_BROK,SP_RES_SELL_BROK,SP_VALUE_FROM,SP_VALUE_TO,SP_BROK_COMPUTEON,    
			 SP_BROK_COMPUTETYPE,SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,    
			 SP_BUY_BROK_TYPE,SP_SELL_BROK_TYPE,AUCTIONPART,    
			 INS_CHRG = (INS_CHRG),    
			 TURN_TAX = (TURN_TAX),     
			 OTHER_CHRG = (F.OTHER_CHRG),    
			 SEBI_TAX = (SEBI_TAX),    
			 BROKER_CHRG = (BROKER_CHRG),    
			 BUY_TURNOVER =     
				  CASE WHEN SELL_BUY = 1 THEN    
					CASE WHEN SP_BROK_COMPUTEON = 'T'     
					THEN TRADEQTY* CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE ELSE    
					  CASE WHEN SP_TURNOVERON = 'PRICE' THEN PRICE     
					  WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
					  ELSE PRICE + STRIKE_PRICE END END    
					WHEN SP_BROK_COMPUTEON = 'Q'    
					 THEN TRADEQTY    
					WHEN SP_BROK_COMPUTEON = 'L'    
					 THEN TRADEQTY / CONVERT(BIGINT,BILLNO)    
					ELSE (CASE WHEN LEFT(INST_TYPE, 3) = 'FUT' THEN PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)    
					  ELSE CASE WHEN SP_TURNOVERON = 'PRICE'  THEN PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)    
					   WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)    
					   ELSE (PRICE + STRIKE_PRICE)*TRADEQTY*CONVERT(BIGINT,BILLNO) END END)  
					END    
				  ELSE 0 END,    
			 SELL_TURNOVER =    
				  CASE WHEN SELL_BUY = 2 THEN    
				   CASE WHEN SP_BROK_COMPUTEON = 'T'     
				   THEN TRADEQTY* CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE ELSE    
					 CASE WHEN SP_TURNOVERON = 'PRICE' THEN PRICE     
					 WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
					 ELSE PRICE + STRIKE_PRICE END END    
				   WHEN SP_BROK_COMPUTEON = 'Q'    
					THEN TRADEQTY    
				   WHEN SP_BROK_COMPUTEON = 'L'    
					 THEN TRADEQTY / CONVERT(BIGINT,BILLNO)    
					ELSE (CASE WHEN LEFT(INST_TYPE, 3) = 'FUT' THEN PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)    
					  ELSE CASE WHEN SP_TURNOVERON = 'PRICE' THEN PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)    
					   WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)    
					   ELSE (PRICE + STRIKE_PRICE)*TRADEQTY*CONVERT(BIGINT,BILLNO) END END)  
				   END    
				  ELSE 0 END,    
			 TOTAL_TURNOVER =    
				  CASE WHEN SP_BROK_COMPUTEON = 'T'     
				   THEN TRADEQTY* CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE ELSE    
					 CASE WHEN SP_TURNOVERON = 'PRICE' THEN PRICE     
					 WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
					 ELSE PRICE + STRIKE_PRICE END END    
				   WHEN SP_BROK_COMPUTEON = 'Q'    
					THEN TRADEQTY    
				   WHEN SP_BROK_COMPUTEON = 'L'    
					 THEN TRADEQTY / CONVERT(BIGINT,BILLNO)    
					ELSE (CASE WHEN LEFT(INST_TYPE, 3) = 'FUT' THEN PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)    
					  ELSE CASE WHEN SP_TURNOVERON = 'PRICE'  THEN PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)    
					   WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)    
					   ELSE (PRICE + STRIKE_PRICE)*TRADEQTY*CONVERT(BIGINT,BILLNO) END END)  
				  END,  
			  
			 BUY_TURNOVER_PREM =     
				  CASE WHEN SELL_BUY = 1 THEN    
					CASE WHEN SP_BROK_COMPUTEON = 'T'     
					THEN TRADEQTY* CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE ELSE    
					  CASE WHEN SP_TURNOVERON = 'PRICE' THEN PRICE  
					  WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
					  ELSE PRICE + STRIKE_PRICE END END    
					WHEN SP_BROK_COMPUTEON = 'Q'    
					 THEN TRADEQTY    
					WHEN SP_BROK_COMPUTEON = 'L'    
					 THEN TRADEQTY / CONVERT(BIGINT,BILLNO)    
					ELSE PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)  
					END    
				  ELSE 0 END,    
			 SELL_TURNOVER_PREM =    
				  CASE WHEN SELL_BUY = 2 THEN    
				   CASE WHEN SP_BROK_COMPUTEON = 'T'     
				   THEN TRADEQTY* CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE ELSE    
					 CASE WHEN SP_TURNOVERON = 'PRICE' THEN PRICE     
					 WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
					 ELSE PRICE + STRIKE_PRICE END END    
				   WHEN SP_BROK_COMPUTEON = 'Q'    
					THEN TRADEQTY    
				   WHEN SP_BROK_COMPUTEON = 'L'    
					 THEN TRADEQTY / CONVERT(BIGINT,BILLNO)    
					ELSE PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)  
				   END    
				  ELSE 0 END,    
			 TOTAL_TURNOVER_PREM =    
				  CASE WHEN SP_BROK_COMPUTEON = 'T'     
				   THEN TRADEQTY* CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE ELSE    
					 CASE WHEN SP_TURNOVERON = 'PRICE' THEN PRICE     
					 WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE    
					 ELSE PRICE + STRIKE_PRICE END END       WHEN SP_BROK_COMPUTEON = 'Q'    
					THEN TRADEQTY    
				   WHEN SP_BROK_COMPUTEON = 'L'    
					 THEN TRADEQTY / CONVERT(BIGINT,BILLNO)    
					ELSE PRICE*TRADEQTY*CONVERT(BIGINT,BILLNO)  
				  END, 
			 TOT_BUYTURNOVER,    
			 TOT_SELLTURNOVER ,  
			 TOT_BUYTURNOVER_PREM = TOT_BUYTURNOVER,    
			 TOT_SELLTURNOVER_PREM = TOT_SELLTURNOVER ,  
			 TOT_BUYQTY,    
			 TOT_SELLQTY,
			 ROUND_TO,
			 ROFIG, 
			 ERRNUM, 
			 NOZERO     
		INTO #VBB_FOSETTLEMENT1 
		FROM    
			VBB_FOSETTLEMENT F (NOLOCK),    
			#VBB_FOSETTLEMENT FS,    
			TRD_SCHEME_MAPPING S, #FOCLTAXES T  
		WHERE    
			CONVERT(VARCHAR,F.SAUDA_DATE,103) = T_SAUDADATE    
			AND F.PARTY_CODE = T_PARTY_CODE    
			AND F.INST_TYPE = T_INST_TYPE    
			AND F.SYMBOL = T_SYMBOL    
			AND CONVERT(VARCHAR,F.EXPIRYDATE,103) = CONVERT(VARCHAR,T_EXPIRYDATE,103)    
			AND F.OPTION_TYPE = T_OPTION_TYPE    
			AND F.STRIKE_PRICE = T_STRIKE_PRICE    
			AND F.AUCTIONPART = T_AUCTIONPART  
			AND SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
			AND F.PARTY_CODE = SP_PARTY_CODE    
			AND LEFT(INST_TYPE,3) = SP_INST_TYPE    
			AND SYMBOL =  CASE WHEN SP_SCRIP = 'ALL' THEN SYMBOL ELSE SP_SCRIP END    
			AND  1 = CASE    
			WHEN SP_SCRIP = 'ALL' AND SYMBOL NOT IN     
			( 
				SELECT SP_SCRIP FROM TRD_SCHEME_MAPPING S    
				WHERE SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO    
				AND F.PARTY_CODE = SP_PARTY_CODE    
				AND LEFT(INST_TYPE,3) = SP_INST_TYPE    
			)     
			THEN 1       
			ELSE CASE WHEN SP_SCRIP = 'ALL' THEN 0 ELSE 1  END END    
			AND SP_TRD_TYPE = CASE WHEN AUCTIONPART ='' THEN 'TRD' ELSE 'DEL' END    
			AND AUCTIONPART <> 'CA'    
			AND TRADEQTY > 0     
			AND SP_BROK_COMPUTETYPE = 'V'    
			AND T.PARTY_CODE = F.PARTY_CODE

			 /*INTRA DAY SQUIRED OFF WITHIN OPT NORM + OPT EX / FUT NORM + FUT EXP*/   
			SELECT PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
			INTO #CLIENT_TRD
			FROM 
			(
				SELECT PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,AUCTIONPART
				FROM VBB_FOSETTLEMENT
				GROUP BY PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,AUCTIONPART
			) TRD
			GROUP BY PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
			HAVING COUNT(1) > 1

			UPDATE #VBB_FOSETTLEMENT1 SET 
				SP_BUY_BROK = SP_SELL_BROK,
				SP_SELL_BROK = SP_BUY_BROK,
				SP_BUY_BROK_TYPE = SP_SELL_BROK_TYPE,  
				SP_SELL_BROK_TYPE = SP_BUY_BROK_TYPE  				
			FROM 
				#CLIENT_TRD
			WHERE
				#CLIENT_TRD.PARTY_CODE = #VBB_FOSETTLEMENT1.PARTY_CODE
				AND #CLIENT_TRD.INST_TYPE = #VBB_FOSETTLEMENT1.INST_TYPE
				AND #CLIENT_TRD.SYMBOL = #VBB_FOSETTLEMENT1.SYMBOL
				AND #CLIENT_TRD.EXPIRYDATE = #VBB_FOSETTLEMENT1.EXPIRYDATE
				AND #CLIENT_TRD.STRIKE_PRICE = #VBB_FOSETTLEMENT1.STRIKE_PRICE
				AND #CLIENT_TRD.OPTION_TYPE = #VBB_FOSETTLEMENT1.OPTION_TYPE
				AND #VBB_FOSETTLEMENT1.AUCTIONPART = 'EA'
				AND #VBB_FOSETTLEMENT1.SP_SCHEME_TYPE <> 0		
			/*----------------------------------------------------------------------------*/
		
			SELECT 
				   PARTY_CODE, 
				   SAUDA_DATE, 
				   CONTRACTNO, 
				   TRADE_NO = (CASE 
								 WHEN SP_COMPUTATION_LEVEL = 'T' 
								 THEN TRADE_NO 
								 ELSE '' 
							   END), 
				   ORDER_NO = (CASE 
								 WHEN SP_COMPUTATION_LEVEL IN ('T','O') 
								 THEN ORDER_NO 
								 ELSE '' 
							   END), 
				   INST_TYPE = (CASE 
								  WHEN SP_COMPUTATION_LEVEL <> 'C' 
								  THEN INST_TYPE 
								  ELSE LEFT(INST_TYPE,3) 
								END), 
				   SYMBOL = (CASE 
							   WHEN SP_COMPUTATION_LEVEL <> 'C' 
							   THEN SYMBOL 
							   ELSE '' 
							 END), 
				   EXPIRYDATE = (CASE 
								   WHEN SP_COMPUTATION_LEVEL <> 'C' 
								   THEN EXPIRYDATE 
								   ELSE '' 
								 END), 
				   OPTION_TYPE = (CASE 
									WHEN SP_COMPUTATION_LEVEL <> 'C' 
									THEN OPTION_TYPE 
									ELSE '' 
								  END), 
				   STRIKE_PRICE = (CASE 
									 WHEN SP_COMPUTATION_LEVEL <> 'C' 
									 THEN STRIKE_PRICE 
									 ELSE 0 
								   END), 
				   AUCTIONPART, 
				   MARKETLOT = SUM(LOTSIZE * TRADEQTY) / SUM(TRADEQTY), 
				   SP_COMPUTATION_LEVEL, 
				   SP_BROK_COMPUTEON, 
				   SP_BROK_COMPUTETYPE, 
				   SP_SCHEME_TYPE, 
				   SP_SCHEME_ID, 
				   BUYRATE = (CASE 
								WHEN SUM(CASE 
										   WHEN SELL_BUY = 1 
										   THEN TRADEQTY 
										   ELSE 0 
										 END) > 0 
								THEN SUM(CASE 
										   WHEN SELL_BUY = 1 
										   THEN TRADEQTY * PRICE 
										   ELSE 0 
										 END) / SUM(CASE 
													  WHEN SELL_BUY = 1 
													  THEN TRADEQTY 
													  ELSE 0 
													END) 
								ELSE 0 
							  END), 
				   SELLRATE = (CASE 
								 WHEN SUM(CASE 
											WHEN SELL_BUY = 2 
											THEN TRADEQTY 
											ELSE 0 
										  END) > 0 
								 THEN SUM(CASE 
											WHEN SELL_BUY = 2 
											THEN TRADEQTY * PRICE 
											ELSE 0 
										  END) / SUM(CASE 
													   WHEN SELL_BUY = 2 
													   THEN TRADEQTY 
													   ELSE 0 
													 END) 
								 ELSE 0 
							   END), 
				   BUY_QTY = SUM(CASE 
								   WHEN SELL_BUY = 1 
								   THEN TRADEQTY 
								   ELSE 0 
								 END), 
				   SELL_QTY = SUM(CASE 
									WHEN SELL_BUY = 2 
									THEN TRADEQTY 
									ELSE 0 
								  END), 
				   TOTALQTY = SUM(TRADEQTY), 
				   TOTALTURNOVER = SUM(TOTAL_TURNOVER), 
				   BUY_TURNOVER = SUM(BUY_TURNOVER), 
				   RND_BUY_TURNOVER = PRADNYA.DBO.ROUNDEDTURNOVER_NEW(SUM(BUY_TURNOVER),SP_MULTIPLIER,@ROUNDFLAG), 
				   SELL_TURNOVER = SUM(SELL_TURNOVER), 
				   RND_SELL_TURNOVER = PRADNYA.DBO.ROUNDEDTURNOVER_NEW(SUM(SELL_TURNOVER),SP_MULTIPLIER,@ROUNDFLAG), 
				   RND_TURNOVER = PRADNYA.DBO.ROUNDEDTURNOVER_NEW(SUM(TOTAL_TURNOVER),SP_MULTIPLIER,@ROUNDFLAG), 
				   TOTALLOT = (CASE 
								 WHEN SP_BROK_COMPUTEON = 'T' 
								 THEN CONVERT(BIGINT,PRADNYA.DBO.ROUNDEDTURNOVER_NEW(SUM(TOTAL_TURNOVER),SP_MULTIPLIER,@ROUNDFLAG) / SP_MULTIPLIER) 
								 WHEN SP_BROK_COMPUTEON = 'Q' 
								 THEN CONVERT(BIGINT,PRADNYA.DBO.ROUNDEDTURNOVER_NEW(SUM(TRADEQTY),SP_MULTIPLIER,@ROUNDFLAG) / SP_MULTIPLIER) 
								 WHEN SP_BROK_COMPUTEON = 'L' 
								 THEN CONVERT(BIGINT,PRADNYA.DBO.ROUNDEDTURNOVER_NEW(SUM(TRADEQTY),(SP_MULTIPLIER * SUM(LOTSIZE * TRADEQTY) / SUM(TRADEQTY)), 
																					 @ROUNDFLAG) / (SP_MULTIPLIER * SUM(LOTSIZE * TRADEQTY) / SUM(TRADEQTY))) 
								 ELSE SUM(LOTSIZE * TRADEQTY) / SUM(TRADEQTY) 
							   END), 
				   TOTALTURNOVER_RES = 0, 
				   RND_TURNOVER_RES = 0, 
				   TOTALLOT_RES = 0, 
			       
				   BUYBROKERAGE_LEG =     
					   CASE  WHEN SP_SCHEME_TYPE > 0 AND SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY ELSE 0 END) > 0    
						THEN CASE     
						 WHEN     
						  (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END) > 
									SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END) 
									AND SP_SCHEME_TYPE <> 0)    
							 OR    
						  (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END) > 
									SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END) 
									AND SP_SCHEME_TYPE <> 0)    
						 THEN  'F'    
						 ELSE  'S'    
						 END          
						ELSE ''    
						END,    
						
				   BUYBROKERAGE = CASE WHEN SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY ELSE 0 END) > 0 THEN	
						((FLOOR(((CASE 
							WHEN SP_SCHEME_TYPE = 0 
								THEN (PRADNYA.DBO.ROUNDEDTURNOVER_NEW((CASE 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P' 
									THEN (CASE 
										WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 
										THEN SUM(BUY_TURNOVER) / SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) 
										ELSE 0 
										END) 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'V' 
									THEN 1 
									ELSE SUM(BUY_TURNOVER) 
									END),SP_MULTIPLIER,@ROUNDFLAG) / SP_MULTIPLIER * (CASE	WHEN SP_BUY_BROK_TYPE = 'P' 
															THEN SP_BUY_BROK / 100 
															ELSE SP_BUY_BROK 
															END)
								) 
									WHEN (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END
								) >= SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END
								) AND SP_SCHEME_TYPE = 1)     
									 OR (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END
								) < SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END
								) AND SP_SCHEME_TYPE = 3)
								THEN (PRADNYA.DBO.ROUNDEDTURNOVER_NEW((CASE 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P' 
									THEN (CASE 
										WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 
										THEN SUM(BUY_TURNOVER) / SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) 
										ELSE 0	END) 
									WHEN SP_BROK_COMPUTEON = 'V'AND SP_BUY_BROK_TYPE = 'V' 
									THEN 1 
								ELSE SUM(BUY_TURNOVER) 
								END),SP_MULTIPLIER,@ROUNDFLAG) / SP_MULTIPLIER * (CASE WHEN SP_BUY_BROK_TYPE = 'P' THEN SP_BUY_BROK / 100 ELSE SP_BUY_BROK END)) 
			                                 
							ELSE (PRADNYA.DBO.ROUNDEDTURNOVER_NEW((CASE 
								WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P' 
								THEN (CASE 
									WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 
									THEN SUM(BUY_TURNOVER) / SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) 
									ELSE 0 
									END) 
								WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V' 
								THEN 1 
								ELSE SUM(BUY_TURNOVER) 
								END),SP_MULTIPLIER,@ROUNDFLAG) / SP_MULTIPLIER * (CASE 
														WHEN SP_SELL_BROK_TYPE = 'P' 
														THEN SP_SELL_BROK / 100 
														ELSE SP_SELL_BROK 
														END)
								) 
                               				END) * POWER(10,ROUND_TO) + ROFIG + ERRNUM) / (ROFIG + NOZERO)) * (ROFIG + NOZERO)) / POWER(10,ROUND_TO)) ELSE 0 END, 
				SELLBROKERAGE_LEG =     
					   CASE  WHEN SP_SCHEME_TYPE > 0 AND SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY ELSE 0 END) > 0    
						THEN CASE     
						 WHEN     
						  (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END) >
								SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END) 
								AND SP_SCHEME_TYPE <> 0)    
							 OR    
						  (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END) > 
								SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END) 
								AND SP_SCHEME_TYPE <> 0)    
						 THEN  'F'    
						 ELSE  'S'    
						 END          
						ELSE ''    
						END,    

				   SELLBROKERAGE = CASE WHEN SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY ELSE 0 END) > 0 THEN
						((FLOOR(((CASE 
							WHEN SP_SCHEME_TYPE = 0 
							THEN (PRADNYA.DBO.ROUNDEDTURNOVER_NEW((CASE 
								WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P' 
								THEN (CASE 
									WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 
									THEN SUM(SELL_TURNOVER) / SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) 
									ELSE 0 
									END) 
								WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V' 
								THEN 1 
								ELSE SUM(SELL_TURNOVER) 
								END),SP_MULTIPLIER,@ROUNDFLAG) / SP_MULTIPLIER * (CASE 
														WHEN SP_SELL_BROK_TYPE = 'P' 
														THEN SP_SELL_BROK / 100 
														ELSE SP_SELL_BROK 
														END)
								) 

								 WHEN (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END
							) >= SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END
							) AND SP_SCHEME_TYPE = 1)     
								  OR (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER END
							) > SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER END
							) AND SP_SCHEME_TYPE = 3) 
								THEN (PRADNYA.DBO.ROUNDEDTURNOVER_NEW((CASE 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P' 
									THEN (CASE 
										WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 
										THEN SUM(SELL_TURNOVER) / SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) 
										ELSE 0 
										END) 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V' 
									THEN 1 
									ELSE SUM(SELL_TURNOVER) 
									END),SP_MULTIPLIER,@ROUNDFLAG) / SP_MULTIPLIER * (CASE 
															WHEN SP_SELL_BROK_TYPE = 'P' 
															THEN SP_SELL_BROK / 100 
															ELSE SP_SELL_BROK 
															END)
									) 
									
									ELSE (PRADNYA.DBO.ROUNDEDTURNOVER_NEW((CASE 
										WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P' 
										THEN (CASE 
											WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 
											THEN SUM(SELL_TURNOVER) / SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) 
											ELSE 0 
											END) 
										WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'V' 
										THEN 1 
										ELSE SUM(SELL_TURNOVER) 
										END),SP_MULTIPLIER,@ROUNDFLAG) / SP_MULTIPLIER * (CASE 
																WHEN SP_BUY_BROK_TYPE = 'P' 
																THEN SP_BUY_BROK / 100 
																ELSE SP_BUY_BROK 
																END)
										) 
                                 					END) * POWER(10,ROUND_TO) + ROFIG + ERRNUM) / (ROFIG + NOZERO)) * (ROFIG + NOZERO)) / POWER(10,ROUND_TO)) ELSE 0 END, 

				BUYBROKERAGE_PREM = CASE WHEN SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY ELSE 0 END) > 0 THEN
						((FLOOR(((CASE 
								WHEN SP_SCHEME_TYPE = 0 
								THEN (PRADNYA.DBO.ROUNDEDTURNOVER_NEW((CASE 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P' 
									THEN (CASE 
										WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 
										THEN SUM(BUY_TURNOVER_PREM) / SUM(CASE 	WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) 
										ELSE 0 
										END) 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'V' 
									THEN 1 
									ELSE SUM(BUY_TURNOVER) 
									END),SP_MULTIPLIER,@ROUNDFLAG) / SP_MULTIPLIER * (CASE 
													WHEN SP_BUY_BROK_TYPE = 'P' 
													THEN (CASE WHEN SP_BUY_BROK > 0 THEN @SEBI_PER ELSE SP_BUY_BROK END) / 100 ELSE SP_BUY_BROK END)) 

									 WHEN (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER_PREM END
								) >= SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER_PREM END
								) AND SP_SCHEME_TYPE = 1)     
									  OR (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER_PREM END
								) < SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER_PREM END
								) AND SP_SCHEME_TYPE = 3) 
								THEN (PRADNYA.DBO.ROUNDEDTURNOVER_NEW((CASE 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P' 
									THEN (CASE 
										WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 
										THEN SUM(BUY_TURNOVER) / SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) 
										ELSE 0 
										END) 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'V' 
									THEN 1 
									ELSE SUM(BUY_TURNOVER_PREM) 
									END),SP_MULTIPLIER,@ROUNDFLAG) / SP_MULTIPLIER * (CASE 
												WHEN SP_BUY_BROK_TYPE = 'P'
												THEN (CASE WHEN SP_BUY_BROK > 0 THEN @SEBI_PER ELSE SP_BUY_BROK END) / 100 ELSE SP_BUY_BROK END)) 

								ELSE (PRADNYA.DBO.ROUNDEDTURNOVER_NEW((CASE 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P' 
									THEN (CASE 
										WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 
										THEN SUM(BUY_TURNOVER_PREM) / SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY 	ELSE 0 	END) 
										ELSE 0 
										END) 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V' 
									THEN 1 
									ELSE SUM(BUY_TURNOVER_PREM) 
									END),SP_MULTIPLIER,@ROUNDFLAG) / SP_MULTIPLIER * (CASE 
														WHEN SP_SELL_BROK_TYPE = 'P' 
														THEN (CASE WHEN SP_SELL_BROK > 0 THEN @SEBI_PER ELSE SP_SELL_BROK END) / 100 ELSE SP_SELL_BROK END))
			 
												 END) * POWER(10,ROUND_TO) + ROFIG + ERRNUM) / (ROFIG + NOZERO)) * (ROFIG + NOZERO)) / POWER(10,ROUND_TO)) ELSE 0 END, 

				 SELLBROKERAGE_PREM = CASE WHEN SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY ELSE 0 END) > 0 THEN
							((FLOOR(((CASE 
								WHEN SP_SCHEME_TYPE = 0 
									THEN (PRADNYA.DBO.ROUNDEDTURNOVER_NEW((CASE 
										WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P' 
										THEN (CASE 
											WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 
											THEN SUM(SELL_TURNOVER_PREM) / SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) 
										ELSE 0 
										END) 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V' 
									THEN 1 
									ELSE SUM(SELL_TURNOVER_PREM) 
									END),SP_MULTIPLIER,@ROUNDFLAG) / SP_MULTIPLIER * (CASE 
														WHEN SP_SELL_BROK_TYPE = 'P' 
														THEN (CASE WHEN SP_SELL_BROK > 0 THEN @SEBI_PER ELSE SP_SELL_BROK END) / 100 ELSE SP_SELL_BROK END)
									) 
												
								 WHEN (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER_PREM END
							) >= SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER_PREM END
							) AND SP_SCHEME_TYPE = 1)     
								  OR (SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_BUYQTY ELSE TOT_BUYTURNOVER_PREM END
							) < SUM(CASE WHEN SP_BROK_COMPUTEON = 'V' AND TOT_BUYQTY <> TOT_SELLQTY THEN TOT_SELLQTY ELSE TOT_SELLTURNOVER_PREM END
							) AND SP_SCHEME_TYPE = 3)    

								THEN (PRADNYA.DBO.ROUNDEDTURNOVER_NEW((CASE 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'P' 
									THEN (CASE 
										WHEN SUM(CASE WHEN SELL_BUY = 2	THEN TRADEQTY ELSE 0 END) > 0 
										THEN SUM(SELL_TURNOVER_PREM) / SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 	END) 
										ELSE 0 
										END) 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_SELL_BROK_TYPE = 'V' 
									THEN 1 
									ELSE SUM(SELL_TURNOVER_PREM) 
									END),SP_MULTIPLIER,@ROUNDFLAG) / SP_MULTIPLIER * (CASE 
														WHEN SP_SELL_BROK_TYPE = 'P' 
														THEN (CASE WHEN SP_SELL_BROK > 0 THEN @SEBI_PER ELSE SP_SELL_BROK END) / 100 ELSE SP_SELL_BROK END)

								) 

								ELSE (PRADNYA.DBO.ROUNDEDTURNOVER_NEW((CASE 
								WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'P' 
								THEN (CASE 
									WHEN SUM(CASE 
										WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 
										THEN SUM(SELL_TURNOVER_PREM) / SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 	END) 
										ELSE 0 
										END) 
									WHEN SP_BROK_COMPUTEON = 'V' AND SP_BUY_BROK_TYPE = 'V' 
									THEN 1 
									ELSE SUM(SELL_TURNOVER_PREM) 
									END),SP_MULTIPLIER,@ROUNDFLAG) / SP_MULTIPLIER * (CASE 
														WHEN SP_BUY_BROK_TYPE = 'P' 
														THEN (CASE WHEN SP_BUY_BROK > 0 THEN @SEBI_PER ELSE SP_BUY_BROK END) / 100 ELSE SP_BUY_BROK END)
									) 
								END) * POWER(10,ROUND_TO) + ROFIG + ERRNUM) / (ROFIG + NOZERO)) * (ROFIG + NOZERO)) / POWER(10,ROUND_TO)) ELSE 0 END, 
				 TOTALBROKERAGE = 0,  
				 CD_TOT_SERTAX = 0 ,    
				 CD_TOT_STT = SUM(INS_CHRG),    
				 CD_TOT_TURN_TAX = SUM(TURN_TAX),    
				 CD_TOT_OTHER_CHRG = SUM(OTHER_CHRG) ,    
				 CD_TOT_SEBI_TAX = SUM(SEBI_TAX) ,    
				 CD_TOT_STAMPDUTY = SUM(BROKER_CHRG) ,    
				 CD_EXCH_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0     
					THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE ELSE 0 END) /     
					 SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)    
				   ELSE 0     
				   END),    
				 CD_EXCH_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0     
				 THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE ELSE 0 END) /     
					 SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)    
					ELSE 0     
					END),    
				 SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT
	 
	 
	 
	 
	 INTO #VBB_FOSETTLEMENT2	    
	 FROM     
		#VBB_FOSETTLEMENT1 FOSETT 
	 GROUP BY     
		 PARTY_CODE,    
		 SAUDA_DATE,    
		 CONTRACTNO,    
		 (CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),    
		 (CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),    
		 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN INST_TYPE ELSE LEFT(INST_TYPE,3) END),    
		 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SYMBOL ELSE '' END),    
		 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),    
		 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN OPTION_TYPE ELSE '' END),    
		 (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN STRIKE_PRICE ELSE 0 END),    
		 SP_MULTIPLIER,SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_SCHEME_TYPE,    
		 SP_BROK_COMPUTETYPE,SP_VALUE_FROM,SP_VALUE_TO,SP_SCHEME_ID,    
		 SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,       
		 SP_SELL_BROK, SP_BUY_BROK, SP_BUY_BROK_TYPE, SP_SELL_BROK_TYPE,    
		 AUCTIONPART, ROUND_TO, ROFIG, ERRNUM, NOZERO         
		 HAVING     
		 (CASE     
			  WHEN SP_BROK_COMPUTEON = 'T' THEN SUM(TRADEQTY*PRICE)       
			  WHEN SP_BROK_COMPUTEON = 'Q' THEN SUM(TRADEQTY)       
			  WHEN SP_BROK_COMPUTEON = 'L' THEN SUM(TRADEQTY/LOTSIZE)     
			  ELSE (SUM(TRADEQTY*PRICE)/SUM(TRADEQTY))*SUM(TRADEQTY*LOTSIZE)/SUM(TRADEQTY)    
		 END) > SP_VALUE_FROM       
		 AND       
		 (CASE    
			  WHEN SP_BROK_COMPUTEON = 'T' THEN SUM(TRADEQTY*PRICE)       
			  WHEN SP_BROK_COMPUTEON = 'Q' THEN SUM(TRADEQTY)       
			  WHEN SP_BROK_COMPUTEON = 'L' THEN SUM(TRADEQTY/LOTSIZE)      
			  ELSE (SUM(TRADEQTY*PRICE)/SUM(TRADEQTY))*SUM(TRADEQTY*LOTSIZE)/SUM(TRADEQTY)    
		 END)    
		  <=     
		    (CASE WHEN SP_VALUE_TO = -1     
		     THEN (CASE WHEN SP_BROK_COMPUTEON = 'T' THEN SUM(TRADEQTY*PRICE)       
			      WHEN SP_BROK_COMPUTEON = 'Q' THEN SUM(TRADEQTY)       
			      WHEN SP_BROK_COMPUTEON = 'L' THEN SUM(TRADEQTY/LOTSIZE)     
			      ELSE (SUM(TRADEQTY*PRICE)/SUM(TRADEQTY))*SUM(TRADEQTY*LOTSIZE)/SUM(TRADEQTY)    
		     END)    
		    ELSE SP_VALUE_TO    
		    END)    
		    
				    
		UPDATE #VBB_FOSETTLEMENT2 SET 
			BUYBROKERAGE_LEG = CASE WHEN BUYBROKERAGE_LEG ='F' THEN 'S' ELSE BUYBROKERAGE_LEG END,
			SELLBROKERAGE_LEG = CASE WHEN SELLBROKERAGE_LEG ='F' THEN 'S' ELSE SELLBROKERAGE_LEG END
		FROM 
			#CLIENT_TRD
		WHERE
			#CLIENT_TRD.PARTY_CODE = #VBB_FOSETTLEMENT2.PARTY_CODE
			AND #CLIENT_TRD.INST_TYPE = #VBB_FOSETTLEMENT2.INST_TYPE
			AND #CLIENT_TRD.SYMBOL = #VBB_FOSETTLEMENT2.SYMBOL
			AND #CLIENT_TRD.EXPIRYDATE = #VBB_FOSETTLEMENT2.EXPIRYDATE
			AND #CLIENT_TRD.STRIKE_PRICE = #VBB_FOSETTLEMENT2.STRIKE_PRICE
			AND #CLIENT_TRD.OPTION_TYPE = #VBB_FOSETTLEMENT2.OPTION_TYPE
			AND #VBB_FOSETTLEMENT2.AUCTIONPART = 'EA'
			AND #VBB_FOSETTLEMENT2.SP_SCHEME_TYPE <> 0 
		 
		 DROP TABLE #CLIENT_TRD
	
       
     
INSERT INTO VBB_CHARGES_DETAIL_TEMP  
(  
	 CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,CD_INST_TYPE,CD_SYMBOL,  
	 CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,CD_MARKETLOT,CD_SCHEME_ID,  
	 CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,  
	 CD_TOT_BUYQTY,CD_TOT_SELLQTY,CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER,CD_TOT_BUYTURNOVER_ROUNDED,  
	 CD_TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED,  
	 CD_TOT_LOT,CD_TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED,  
	 CD_TOT_RES_LOT,CD_TOT_BUYBROK,CD_TOT_SELLBROK,CD_TOT_BROK,  
	 CD_TOT_SERTAX,CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,  
	 CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT  
)  
  
SELECT    
  PARTY_CODE,SAUDA_DATE,CONTRACTNO,TRADE_NO,ORDER_NO,INST_TYPE,SYMBOL,    
  EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,AUCTIONPART,MARKETLOT,SP_SCHEME_ID,    
  SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_BROK_COMPUTETYPE,    
  BUYRATE,SELLRATE,    
  BUY_QTY, SELL_QTY,     
  BUY_TURNOVER=(CASE WHEN SP_BROK_COMPUTEON = 'V' THEN BUY_TURNOVER/TOTALLOT ELSE BUY_TURNOVER END), 
  SELL_TURNOVER=(CASE WHEN SP_BROK_COMPUTEON = 'V' THEN SELL_TURNOVER/TOTALLOT ELSE SELL_TURNOVER END), 
 RND_BUY_TURNOVER=ROUND((CASE WHEN SP_BROK_COMPUTEON = 'V' THEN RND_BUY_TURNOVER/TOTALLOT ELSE RND_BUY_TURNOVER END),4),     
  RND_SELL_TURNOVER=ROUND((CASE WHEN SP_BROK_COMPUTEON = 'V' THEN RND_SELL_TURNOVER/TOTALLOT ELSE RND_SELL_TURNOVER END),4),     
  TOTALTURNOVER=(CASE WHEN SP_BROK_COMPUTEON = 'V' THEN TOTALTURNOVER/TOTALLOT ELSE TOTALTURNOVER END),     
  RND_TURNOVER=ROUND((CASE WHEN SP_BROK_COMPUTEON = 'V' THEN RND_TURNOVER/TOTALLOT ELSE RND_TURNOVER END),4),    
  TOTALLOT=(CASE WHEN SP_BROK_COMPUTEON = 'V' THEN (BUY_QTY+SELL_QTY)/TOTALLOT ELSE TOTALLOT END),    
  TOTALTURNOVER_RES,RND_TURNOVER_RES,TOTALLOT_RES,    
  BUYBROKERAGE = (CASE 
                         WHEN SP_BROK_COMPUTEON = 'V' 
                         THEN (CASE 
                                 WHEN BUYBROKERAGE > 0 
                                 THEN   CASE WHEN SP_SCHEME_TYPE > 0 AND BUYBROKERAGE_LEG = 'S' THEN
					       (CASE 
                                                 WHEN BUYBROKERAGE_PREM < BUYBROKERAGE 
                                                 THEN BUYBROKERAGE_PREM 
                                                 ELSE BUYBROKERAGE 
                                               END)
					ELSE
					(CASE 
                         WHEN SP_MAX_BROKAMT = -1 
                         THEN (CASE 
                                 WHEN SP_MIN_BROKAMT <> 0 
                                 THEN PRADNYA.DBO.FNMAX(SP_MIN_BROKAMT,(CASE 
                                                          WHEN BUYBROKERAGE_PREM < BUYBROKERAGE 
                                                          THEN BUYBROKERAGE_PREM 
                                                          ELSE BUYBROKERAGE 
                                                        END))
                                 ELSE (CASE 
                                         WHEN BUYBROKERAGE_PREM < BUYBROKERAGE 
                                         THEN BUYBROKERAGE_PREM 
                                         ELSE BUYBROKERAGE 
                                       END) 
                               END) 
                         ELSE PRADNYA.DBO.FNMIN(SP_MAX_BROKAMT,(CASE 
                                                                  WHEN SP_MIN_BROKAMT <> 0 
                                                                  THEN PRADNYA.DBO.FNMAX(SP_MIN_BROKAMT,(CASE 
                                                                                       WHEN BUYBROKERAGE_PREM < BUYBROKERAGE 
                                                                                       THEN BUYBROKERAGE_PREM 
                          ELSE BUYBROKERAGE 
                                       END)) 
                                                        ELSE (CASE 
                                         WHEN BUYBROKERAGE_PREM < BUYBROKERAGE 
                                                                          THEN BUYBROKERAGE_PREM 
                              ELSE BUYBROKERAGE 
                                                                        END) 
                END)) 
                       END)
				      END  
                                 ELSE 0 
                               END) * BUY_QTY / TOTALLOT 
                         ELSE (CASE 
                                 WHEN BUYBROKERAGE_PREM < BUYBROKERAGE 
                                 THEN BUYBROKERAGE_PREM 
                                 ELSE BUYBROKERAGE 
                               END) 
                       END), 

  SELLBROKERAGE = (CASE 
               WHEN SP_BROK_COMPUTEON = 'V' 
       THEN (CASE 
					WHEN SELLBROKERAGE > 0 
                                  THEN  CASE WHEN SP_SCHEME_TYPE > 0  AND SELLBROKERAGE_LEG = 'S' THEN
							(CASE 
                                                          WHEN SELLBROKERAGE_PREM < SELLBROKERAGE 
                                                          THEN SELLBROKERAGE_PREM 
                                                          ELSE SELLBROKERAGE 
                                                        END)
					ELSE
					(CASE 
                      WHEN SP_MAX_BROKAMT = -1 
                      THEN (CASE 
                              WHEN SP_MIN_BROKAMT <> 0 
                              THEN PRADNYA.DBO.FNMAX(SP_MIN_BROKAMT,(CASE 
                                                                       WHEN SELLBROKERAGE_PREM < SELLBROKERAGE 
                                                                       THEN SELLBROKERAGE_PREM 
                                                                       ELSE SELLBROKERAGE 
                                                                     END)) 
                              ELSE (CASE 
                                      WHEN SELLBROKERAGE_PREM < SELLBROKERAGE 
                                      THEN SELLBROKERAGE_PREM 
                                      ELSE SELLBROKERAGE 
                                    END) 
                            END) 
                      ELSE PRADNYA.DBO.FNMIN(SP_MAX_BROKAMT,(CASE 
                                                               WHEN SP_MIN_BROKAMT <> 0 
                                                               THEN PRADNYA.DBO.FNMAX(SP_MIN_BROKAMT,(CASE 
                                                                    WHEN SELLBROKERAGE_PREM < SELLBROKERAGE 
                                                                    THEN SELLBROKERAGE_PREM 
                                                                    ELSE SELLBROKERAGE 
                                                                  END)) 
                                                               ELSE (CASE 
                                                                       WHEN SELLBROKERAGE_PREM < SELLBROKERAGE 
                                                                       THEN SELLBROKERAGE_PREM 
                                                                       ELSE SELLBROKERAGE 
                                                                     END) 
                                                             END)) 
                    END) 
                                       END 
                                  ELSE 0 
                                END) * SELL_QTY / TOTALLOT 
                          ELSE (CASE 
                                  WHEN SELLBROKERAGE_PREM < SELLBROKERAGE 
                                  THEN SELLBROKERAGE_PREM 
               ELSE SELLBROKERAGE 
END) 
                        END), 

TOTALBROKERAGE = CASE 
                          WHEN SP_BROK_COMPUTEON = 'V' 
                          THEN 0 
                          ELSE (CASE 
                                  WHEN ((CASE 
						WHEN BUYBROKERAGE_PREM < BUYBROKERAGE 
       THEN BUYBROKERAGE_PREM 
                                           ELSE BUYBROKERAGE 
       END) + (CASE 
                                                   WHEN SELLBROKERAGE_PREM < SELLBROKERAGE 
                                                   THEN SELLBROKERAGE_PREM 
                                                   ELSE SELLBROKERAGE 
                                                 END)) > 0 
                                  THEN (CASE 
                                          WHEN SP_MAX_BROKAMT = -1 
                THEN (CASE 
          WHEN SP_MIN_BROKAMT <> 0 
     THEN PRADNYA.DBO.FNMAX(SP_MIN_BROKAMT,((CASE 
                                                                                WHEN BUYBROKERAGE_PREM < BUYBROKERAGE 
                                                                                THEN BUYBROKERAGE_PREM 
                                                                                ELSE BUYBROKERAGE 
                                                                              END) + (CASE 
                                                                                        WHEN SELLBROKERAGE_PREM < SELLBROKERAGE 
                                                                                        THEN SELLBROKERAGE_PREM 
                                                                                        ELSE SELLBROKERAGE 
                                                                                      END))) 
                                                  ELSE ((CASE 
                                                           WHEN BUYBROKERAGE_PREM < BUYBROKERAGE 
                                                           THEN BUYBROKERAGE_PREM 
                                                           ELSE BUYBROKERAGE 
                                                         END) + (CASE 
                                                                   WHEN SELLBROKERAGE_PREM < SELLBROKERAGE 
                                                                   THEN SELLBROKERAGE_PREM 
                                                                   ELSE SELLBROKERAGE 
                                                                 END)) 
                                                END) 
                                          ELSE PRADNYA.DBO.FNMIN(SP_MAX_BROKAMT,(CASE 
                                                                                   WHEN SP_MIN_BROKAMT <> 0 
                                                                                   THEN PRADNYA.DBO.FNMAX(SP_MIN_BROKAMT,((CASE 
                                                                                                                             WHEN BUYBROKERAGE_PREM < BUYBROKERAGE 
                                                                                                                             THEN BUYBROKERAGE_PREM 
                                                                                                                             ELSE BUYBROKERAGE 
                                                                                                                           END) + (CASE 
                                                                                                                                     WHEN SELLBROKERAGE_PREM < SELLBROKERAGE 
                                      THEN SELLBROKERAGE_PREM 
                                                              ELSE SELLBROKERAGE 
                              END))) 
                                                                                   ELSE ((CASE 
              WHEN BUYBROKERAGE_PREM < BUYBROKERAGE 
        THEN BUYBROKERAGE_PREM 
                              ELSE BUYBROKERAGE 
                                                                                          END) + (CASE 
                                                                                                    WHEN SELLBROKERAGE_PREM < SELLBROKERAGE 
                                                                                                    THEN SELLBROKERAGE_PREM 
                  ELSE SELLBROKERAGE 
                      END)) 
                           END)) 
                                        END) 
                                  ELSE 0 
                                END) 
                        END  ,  
	 CD_TOT_SERTAX = 0,CD_TOT_STT,CD_TOT_TURN_TAX,    
	 CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,CD_EXCH_BUYRATE,    
	 CD_EXCH_SELLRATE,SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT  
FROM    
	#VBB_FOSETTLEMENT2 FOSETTCHRG   
	
	

  
UPDATE   
  VBB_CHARGES_DETAIL_TEMP  
SET  
  CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0  
WHERE  
  CD_TOT_BROK <> CD_TOT_SELLBROK + CD_TOT_BUYBROK  
  AND CD_TOT_SELLBROK > CD_TOT_BUYBROK  
  AND CD_COMPUTATIONON <> 'V'  
  
  
UPDATE   
  VBB_CHARGES_DETAIL_TEMP  
SET  
  CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0  
WHERE  
  CD_TOT_BROK <> CD_TOT_SELLBROK + CD_TOT_BUYBROK  
  AND CD_TOT_BUYBROK > CD_TOT_SELLBROK   
  AND CD_COMPUTATIONON <> 'V'  
  
UPDATE   
  VBB_CHARGES_DETAIL_TEMP  
SET  
  CD_TOT_BROK =CD_TOT_SELLBROK+ CD_TOT_BUYBROK  
WHERE    CD_COMPUTATIONON = 'V'  
  
  
/*---------------------------------------------------------------------------------------------------------------  
    FETCHING DATA FOR INCREMENTAL VALUE BASED BROKERAGE  
----------------------------------------------------------------------------------------------------------------*/  
  
IF (SELECT ISNULL(COUNT(1),0) FROM TRD_SCHEME_MAPPING      
WHERE SP_BROK_COMPUTETYPE = 'I') > 0       
BEGIN    
 DECLARE @SETTCUR CURSOR,  
  @PARTY_CODE VARCHAR(10),  
  @SAUDA_DATE VARCHAR(11),  
  @CONTRACTNO VARCHAR(14),  
  @TRADE_NO VARCHAR(15),  
  @ORDER_NO VARCHAR(20),  
  @INST_TYPE VARCHAR(6),  
  @SYMBOL VARCHAR(12),  
  @EXPIRYDATE DATETIME,  
  @OPTION_TYPE VARCHAR(2),  
  @STRIKE_PRICE MONEY,  
  @AUCTIONPART VARCHAR(2),  
  @BUY_TURNOVER MONEY,  
  @SELL_TURNOVER MONEY,  
  @LOTSIZE BIGINT,  
  @BUYRATE MONEY,  
  @SELLRATE MONEY,  
  @BUYQTY BIGINT,  
  @SELLQTY BIGINT,  
  @TOT_STT MONEY,  
  @TOT_TURN_TAX MONEY,  
  @TOT_OTHER_CHRG MONEY,  
  @TOT_SEBI_TAX MONEY,  
  @TOT_STAMPDUTY MONEY,  
  @EXCH_BUYRATE MONEY,  
  @EXCH_SELLRATE MONEY,  
  @MIN_BROKAMT MONEY,  
  @MAX_BROKAMT MONEY,  
  @MIN_SCRIPAMT MONEY,  
  @MAX_SCRIPAMT MONEY,  
  @SP_COMPUTATIONLEVEL CHAR(1),  
  @SP_COMPUTATIONON CHAR(1),  
  @SP_COMPUTATIONTYPE CHAR(1),  
  @SCHEMEID INT  
   
 DECLARE @SCHEMECUR CURSOR,  
  @SP_COMPUTATION_LEVEL CHAR(1),  
  @SP_MULTIPLIER MONEY,  
  @SP_BUY_BROK_TYPE CHAR(1),  
  @SP_SELL_BROK_TYPE CHAR(1),  
  @SP_BUY_BROK NUMERIC (18,4),  
 @SP_SELL_BROK NUMERIC (18,4),  
 @SP_VALUE_FROM NUMERIC (18,4),  
  @SP_VALUE_TO NUMERIC (18,4),  
  @BUYFLAG BIGINT,  
  @SELLFLAG BIGINT,  
  @SP_SCHEME_TYPE INT  
   
 DECLARE   
  @NEWBUYTURNOVER MONEY,  
  @NEWBUYTURNOVERORG MONEY,  
  @NEWSELLTURNOVER MONEY,  
  @NEWSELLTURNOVERORG MONEY,  
  @BUYBROKERAGE MONEY,  
  @SELLBROKERAGE MONEY  
   
 DECLARE   
  @TOT_BUYTURNOVER MONEY,  
  @TOT_SELLTURNOVER MONEY  
   
 SET @SETTCUR = CURSOR FOR  
  SELECT   
  PARTY_CODE,  
  SAUDA_DATE,  
  CONTRACTNO,  
  TRADE_NO = (CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),  
  ORDER_NO = (CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),  
  INST_TYPE = (CASE WHEN SP_COMPUTATION_LEVEL = 'C' THEN LEFT(INST_TYPE,3) ELSE INST_TYPE END),  
 SYMBOL = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SYMBOL ELSE '' END),  
  EXPIRYDATE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),  
  OPTION_TYPE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN OPTION_TYPE ELSE '' END),  
  STRIKE_PRICE = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN STRIKE_PRICE ELSE 0 END),  
  AUCTIONPART = (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN AUCTIONPART ELSE '' END),  
  BUY_TURNOVER = SUM(BUY_TURNOVER),  
  SELL_TURNOVER = SUM(SELL_TURNOVER),  
  LOTSIZE=SUM(LOTSIZE*TRADEQTY)/SUM(TRADEQTY),  
  BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0   
    THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE ELSE 0 END) /   
     SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)  
    ELSE 0   
   END),  
  SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0   
    THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE ELSE 0 END) /   
     SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)  
    ELSE 0   
   END),  
  BUYQTY = SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),  
  SELLQTY = SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),  
  CD_TOT_STT = SUM(INS_CHRG),  
  CD_TOT_TURN_TAX = SUM(TURN_TAX),  
  CD_TOT_OTHER_CHRG = SUM(OTHER_CHRG) ,  
  CD_TOT_SEBI_TAX = SUM(SEBI_TAX) ,  
  CD_TOT_STAMPDUTY = SUM(BROKER_CHRG) ,  
  CD_EXCH_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0   
     THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE ELSE 0 END) /   
      SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)  
     ELSE 0   
     END),  
  CD_EXCH_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0   
     THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE ELSE 0 END) /   
      SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)  
      ELSE 0  
     END),  
  SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,  
  SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_COMPUTATIONTYPE,SP_SCHEME_ID,  
  TOT_BUYTURNOVER = SUM(TOT_BUYTURNOVER),  
  TOT_SELLTURNOVER = SUM(TOT_SELLTURNOVER)  
  FROM   
  (  
  SELECT   
   TRADE_NO=PRADNYA.DBO.REPLACETRADENO(TRADE_NO),ORDER_NO,F.PARTY_CODE,CONTRACTNO,SELL_BUY,  
   INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
   TRADEQTY,LOTSIZE = CONVERT(BIGINT,BILLNO),SAUDA_DATE=LEFT(SAUDA_DATE,11),PRICE,  
   BUY_TURNOVER = CASE WHEN SELL_BUY = 1 THEN  
      CASE WHEN SP_BROK_COMPUTEON = 'T'   
       THEN TRADEQTY*(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE ELSE  
       CASE WHEN SP_TURNOVERON = 'PRICE' THEN PRICE   
       WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE  
      ELSE PRICE + STRIKE_PRICE END END)  
      WHEN SP_BROK_COMPUTEON = 'Q'  
       THEN TRADEQTY  
      ELSE TRADEQTY / CONVERT(BIGINT,BILLNO)  
      END  
     ELSE 0 END,  
   SELL_TURNOVER = CASE WHEN SELL_BUY = 2 THEN  
      CASE WHEN SP_BROK_COMPUTEON = 'T'   
       THEN TRADEQTY*(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE ELSE  
       CASE WHEN SP_TURNOVERON = 'PRICE' THEN PRICE   
       WHEN SP_TURNOVERON = 'SPRICE' THEN STRIKE_PRICE  
       ELSE PRICE + STRIKE_PRICE END END)  
      WHEN SP_BROK_COMPUTEON = 'Q'  
       THEN TRADEQTY  
      ELSE TRADEQTY / CONVERT(BIGINT,BILLNO)  
      END  
     ELSE 0 END,  
   SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,  
   SP_COMPUTATIONTYPE = SP_BROK_COMPUTETYPE,SP_SCHEME_ID,  
   SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,  
   SP_MULTIPLIER,AUCTIONPART,  
   INS_CHRG = (INS_CHRG),  
   TURN_TAX = (TURN_TAX),   
   OTHER_CHRG = (F.OTHER_CHRG),  
   SEBI_TAX = (SEBI_TAX),  
   BROKER_CHRG = (BROKER_CHRG),  
   TOT_BUYTURNOVER,  
   TOT_SELLTURNOVER  
  FROM  
VBB_FOSETTLEMENT F,  
   (  
    SELECT   
     T_SAUDADATE = CONVERT(VARCHAR,SAUDA_DATE,103),  
     T_PARTY_CODE = PARTY_CODE,  
     T_INST_TYPE = INST_TYPE, 
   T_SYMBOL = SYMBOL,  
     T_EXPIRYDATE = EXPIRYDATE,  
     T_OPTION_TYPE = OPTION_TYPE,  
     T_STRIKE_PRICE = STRIKE_PRICE,  
   T_AUCTIONPART = AUCTIONPART,
     TOT_BUYTURNOVER = SUM(CASE WHEN SELL_BUY = 1   
        THEN  
         (TRADEQTY * PRICE)  
        ELSE  
         0  
        END),  
     TOT_SELLTURNOVER = SUM(CASE WHEN SELL_BUY = 2  
        THEN  
         (TRADEQTY * PRICE)  
        ELSE  
         0  
 END)  
  FROM  
     VBB_FOSETTLEMENT  
 WHERE   PARTY_CODE IN   
     (   
      SELECT 
       SP_PARTY_CODE  
      FROM  
 TRD_SCHEME_MAPPING   
   WHERE  
SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO  
       AND SP_BROK_COMPUTETYPE = 'I'  
     )  
    GROUP BY  
     CONVERT(VARCHAR,SAUDA_DATE,103),PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,  
     OPTION_TYPE,STRIKE_PRICE,AUCTIONPART  
   ) FS,  
   TRD_SCHEME_MAPPING S  
  WHERE  
   SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO  
   AND CONVERT(VARCHAR,F.SAUDA_DATE,103) = T_SAUDADATE  
   AND F.PARTY_CODE = T_PARTY_CODE  
   AND F.INST_TYPE = T_INST_TYPE  
   AND F.SYMBOL = T_SYMBOL  
   AND CONVERT(VARCHAR,F.EXPIRYDATE,103) = CONVERT(VARCHAR,T_EXPIRYDATE,103)  
   AND F.OPTION_TYPE = T_OPTION_TYPE  
   AND F.STRIKE_PRICE = T_STRIKE_PRICE  
   AND F.AUCTIONPART = T_AUCTIONPART
   AND F.PARTY_CODE = SP_PARTY_CODE  
   AND LEFT(INST_TYPE,3) = SP_INST_TYPE  
   AND SYMBOL =  CASE WHEN SP_SCRIP = 'ALL' THEN SYMBOL ELSE SP_SCRIP END  
   AND  1 = CASE  
    WHEN SP_SCRIP = 'ALL' AND SYMBOL NOT IN   
    (   
     SELECT SP_SCRIP FROM TRD_SCHEME_MAPPING S  
     WHERE SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO  
     AND F.PARTY_CODE = SP_PARTY_CODE  
     AND LEFT(INST_TYPE,3) = SP_INST_TYPE  
    )   
    THEN 1     
    ELSE CASE WHEN SP_SCRIP = 'ALL' THEN 0 ELSE 1  END END  
  AND SP_TRD_TYPE = CASE WHEN AUCTIONPART =''  
     THEN 'TRD' ELSE 'DEL' END  
  AND SP_BROK_COMPUTETYPE = 'I'  
  AND SP_VALUE_FROM = (SELECT MIN(SP_VALUE_FROM) FROM   
     TRD_SCHEME_MAPPING T  
     WHERE SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO  
     AND F.PARTY_CODE = SP_PARTY_CODE  
     AND LEFT(INST_TYPE,3) = SP_INST_TYPE
     
     AND SP_TRD_TYPE = CASE WHEN AUCTIONPART ='' THEN 'TRD' ELSE 'DEL' END
	 AND S.SP_VALUE_FROM >= T.SP_VALUE_FROM
     )  
  ) FOSETT  
    
  GROUP BY   
  PARTY_CODE,  
  SAUDA_DATE,  
  CONTRACTNO,  
  (CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN TRADE_NO ELSE '' END),  
  (CASE WHEN SP_COMPUTATION_LEVEL IN ('T', 'O') THEN ORDER_NO ELSE '' END),  
  (CASE WHEN SP_COMPUTATION_LEVEL = 'C' THEN LEFT(INST_TYPE,3) ELSE INST_TYPE END),  
  (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN SYMBOL ELSE '' END),  
  (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN EXPIRYDATE ELSE '' END),  
  (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN OPTION_TYPE ELSE '' END),  
(CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN STRIKE_PRICE ELSE 0 END),  
  (CASE WHEN SP_COMPUTATION_LEVEL <> 'C' THEN AUCTIONPART ELSE '' END),  
  AUCTIONPART,SP_MIN_BROKAMT,SP_MAX_BROKAMT,SP_MIN_SCRIPAMT,SP_MAX_SCRIPAMT,  
  SP_COMPUTATION_LEVEL,SP_BROK_COMPUTEON,SP_COMPUTATIONTYPE,SP_SCHEME_ID  
   
 OPEN @SETTCUR  
  FETCH NEXT FROM @SETTCUR INTO @PARTY_CODE,@SAUDA_DATE,@CONTRACTNO,@TRADE_NO,@ORDER_NO,@INST_TYPE,@SYMBOL,@EXPIRYDATE,  
  @OPTION_TYPE,@STRIKE_PRICE,@AUCTIONPART,@BUY_TURNOVER,@SELL_TURNOVER,@LOTSIZE,@BUYRATE,@SELLRATE,@BUYQTY,  
  @SELLQTY,@TOT_STT,@TOT_TURN_TAX,@TOT_OTHER_CHRG,@TOT_SEBI_TAX,@TOT_STAMPDUTY,@EXCH_BUYRATE,@EXCH_SELLRATE,  
  @MIN_BROKAMT,@MAX_BROKAMT,@MIN_SCRIPAMT,@MAX_SCRIPAMT,@SP_COMPUTATIONLEVEL,@SP_COMPUTATIONON,  
  @SP_COMPUTATIONTYPE,@SCHEMEID,@TOT_BUYTURNOVER,@TOT_SELLTURNOVER  
   
  WHILE @@FETCH_STATUS = 0   
  BEGIN     
   SELECT @BUYFLAG = 0   
   SELECT @SELLFLAG = 0   
   
/*-----------------------------------------------------------------------------------------------------------*/  
   SET @SCHEMECUR = CURSOR FOR  
   SELECT  
SP_COMPUTATION_LEVEL,  
    SP_MULTIPLIER,  
    SP_BUY_BROK_TYPE,  
    SP_SELL_BROK_TYPE,  
    SP_BUY_BROK,  
    SP_SELL_BROK,  
   SP_VALUE_FROM,  
    SP_VALUE_TO,  
    SP_SCHEME_TYPE  
   FROM  
    TRD_SCHEME_MAPPING  
   WHERE  
    @SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO  
    AND SP_PARTY_CODE = @PARTY_CODE    
    AND SP_INST_TYPE = LEFT(@INST_TYPE,3)  
    AND @SYMBOL =  CASE WHEN SP_SCRIP = 'ALL' THEN @SYMBOL ELSE SP_SCRIP END  
    AND  1 = CASE  
     WHEN SP_SCRIP = 'ALL' AND @SYMBOL NOT IN   
     (   
     SELECT SP_SCRIP FROM TRD_SCHEME_MAPPING S 
 WHERE @SAUDA_DATE BETWEEN SP_DATE_FROM AND SP_DATE_TO  
      AND SP_PARTY_CODE = @PARTY_CODE    
      AND SP_INST_TYPE = LEFT(@INST_TYPE,3)    
     )   
     THEN 1     
     ELSE CASE WHEN SP_SCRIP = 'ALL' THEN 0 ELSE 1  END END    
    AND SP_TRD_TYPE = CASE WHEN @AUCTIONPART =''  
      THEN 'TRD' ELSE 'DEL' END  
    AND SP_BROK_COMPUTETYPE = 'I'  
   ORDER BY SP_VALUE_FROM  
   
   OPEN @SCHEMECUR  
   FETCH NEXT FROM   
    @SCHEMECUR INTO @SP_COMPUTATION_LEVEL,@SP_MULTIPLIER,@SP_BUY_BROK_TYPE,@SP_SELL_BROK_TYPE,  
    @SP_BUY_BROK,@SP_SELL_BROK,@SP_VALUE_FROM,@SP_VALUE_TO,@SP_SCHEME_TYPE  
   
    SET @NEWBUYTURNOVER = @BUY_TURNOVER   
    SET @NEWSELLTURNOVER = @SELL_TURNOVER   
    SET @NEWBUYTURNOVERORG = 0   
    SET @NEWSELLTURNOVERORG = 0   
    SET @BUYBROKERAGE = 0  
    SET @SELLBROKERAGE = 0  
   
   WHILE @@FETCH_STATUS = 0 AND (@NEWBUYTURNOVER > 0 OR @NEWSELLTURNOVER > 0)       
   BEGIN  
   
   /*--------------------------------------------------------------------*/  
   SET @BUYBROKERAGE = 0  
   SET @SELLBROKERAGE = 0  
   IF @NEWBUYTURNOVER > 0   
   BEGIN  
    IF @BUY_TURNOVER >= @SP_VALUE_TO AND @SP_VALUE_TO > -1  
    BEGIN   
     SET @NEWBUYTURNOVER = (@SP_VALUE_TO - @SP_VALUE_FROM)/CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END  
     SET @NEWBUYTURNOVERORG = @NEWBUYTURNOVER * CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END  
    END  
    ELSE   
    BEGIN  
     SET @NEWBUYTURNOVER = @BUY_TURNOVER - @SP_VALUE_FROM  
     IF @NEWBUYTURNOVER < 0  SET @NEWBUYTURNOVER = 0   
     SET @NEWBUYTURNOVERORG  = @NEWBUYTURNOVER    
     SELECT @NEWBUYTURNOVER = PRADNYA.DBO.ROUNDEDTURNOVER_NEW(@NEWBUYTURNOVER,@SP_MULTIPLIER,@ROUNDFLAG)  
     SELECT @NEWBUYTURNOVER = @NEWBUYTURNOVER / CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END  
     SELECT @BUYFLAG = 1  
    END  
    IF @NEWBUYTURNOVER > 0   
    BEGIN   
     SELECT @BUYBROKERAGE =   
      CASE WHEN @SP_SCHEME_TYPE = 0 THEN  
      CASE WHEN @SP_BUY_BROK_TYPE ='P'  
      THEN @NEWBUYTURNOVER * @SP_BUY_BROK  /100  
      ELSE @NEWBUYTURNOVER * @SP_BUY_BROK END  
      ELSE  
       CASE WHEN (@TOT_BUYTURNOVER >= @TOT_SELLTURNOVER AND @SP_SCHEME_TYPE=1)  
      OR   (@TOT_BUYTURNOVER >= @TOT_SELLTURNOVER AND @SP_SCHEME_TYPE=3)  
       THEN  
        CASE WHEN @SP_BUY_BROK_TYPE ='P'     
        THEN @NEWBUYTURNOVER * @SP_BUY_BROK  /100  
        ELSE @NEWBUYTURNOVER * @SP_BUY_BROK END  
       ELSE  
        CASE WHEN @SP_SELL_BROK_TYPE ='P'  
        THEN @NEWBUYTURNOVER * @SP_SELL_BROK  /100  
        ELSE @NEWBUYTURNOVER * @SP_SELL_BROK END  
       END  
      END  
    END    
    ELSE   
     SELECT @BUYBROKERAGE = 0  
    END  
   
    IF @NEWSELLTURNOVER > 0   
    BEGIN  
     IF @SELL_TURNOVER >= @SP_VALUE_TO AND @SP_VALUE_TO > -1  
     BEGIN   
      SET @NEWSELLTURNOVER = (@SP_VALUE_TO - @SP_VALUE_FROM)/CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END  
      SET @NEWSELLTURNOVERORG = @NEWSELLTURNOVER * CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END  
     END  
     ELSE   
     BEGIN  
      SET @NEWSELLTURNOVER = @SELL_TURNOVER - @SP_VALUE_FROM  
      IF @NEWSELLTURNOVER < 0 SET @NEWSELLTURNOVER = 0    
      SET @NEWSELLTURNOVERORG  = @NEWSELLTURNOVER     
      SELECT @NEWSELLTURNOVER = PRADNYA.DBO.ROUNDEDTURNOVER_NEW(@NEWSELLTURNOVER,@SP_MULTIPLIER,@ROUNDFLAG)  
      SELECT @NEWSELLTURNOVER = @NEWSELLTURNOVER / CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END  
      SELECT @SELLFLAG = 1  
     END  
     IF @NEWSELLTURNOVER > 0  
     BEGIN    
      SELECT @SELLBROKERAGE =   
       CASE WHEN @SP_SCHEME_TYPE = 0 THEN  
        CASE WHEN @SP_SELL_BROK_TYPE ='P'  
        THEN @NEWSELLTURNOVER * @SP_SELL_BROK  /100  
       ELSE @NEWSELLTURNOVER * @SP_SELL_BROK END  
       ELSE  
   CASE WHEN (@TOT_BUYTURNOVER >= @TOT_SELLTURNOVER AND @SP_SCHEME_TYPE=1)  
        OR   (@TOT_BUYTURNOVER >= @TOT_SELLTURNOVER AND @SP_SCHEME_TYPE=3)  
        THEN  
         CASE WHEN @SP_SELL_BROK_TYPE ='P'  
         THEN @NEWSELLTURNOVER * @SP_SELL_BROK  /100  
         ELSE @NEWSELLTURNOVER * @SP_SELL_BROK END  
        ELSE  
         CASE WHEN @SP_BUY_BROK_TYPE ='P'  
         THEN @NEWSELLTURNOVER * @SP_BUY_BROK  /100  
         ELSE @NEWSELLTURNOVER * @SP_BUY_BROK END  
        END  
       END  
     END  
    ELSE  
     SELECT @SELLBROKERAGE = 0     
    END  
   
   INSERT INTO VBB_CHARGES_DETAIL_TEMP1   
   (  
    CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,  
    CD_INST_TYPE,CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,  
    CD_AUCTIONPART,CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,  
    CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,  
    CD_TOT_BUYQTY,CD_TOT_SELLQTY,CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER,  
    CD_TOT_BUYTURNOVER_ROUNDED,CD_TOT_SELLTURNOVER_ROUNDED,  
    CD_TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED,  
    CD_TOT_LOT,CD_TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED,  
    CD_TOT_RES_LOT,CD_TOT_BUYBROK,CD_TOT_SELLBROK,CD_TOT_BROK,CD_TOT_SERTAX,  
    CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,  
    CD_TOT_STAMPDUTY,CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,  
    CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT  
   )  
   VALUES   
   (  
    @PARTY_CODE,@SAUDA_DATE,@CONTRACTNO,@TRADE_NO,@ORDER_NO,  
    @INST_TYPE,@SYMBOL,@EXPIRYDATE,@OPTION_TYPE,  
    @STRIKE_PRICE,@AUCTIONPART,@LOTSIZE,@SCHEMEID,  
    @SP_COMPUTATIONLEVEL,@SP_COMPUTATIONON,@SP_COMPUTATIONTYPE,@BUYRATE,@SELLRATE,  
    @BUYQTY,@SELLQTY,@NEWBUYTURNOVERORG,@NEWSELLTURNOVERORG,  
    (@NEWBUYTURNOVER*CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END),  
    (@NEWSELLTURNOVER*CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END),0,0,  
    (@BUYQTY+@SELLQTY)/CASE WHEN @SP_MULTIPLIER = 0 THEN 1 ELSE @SP_MULTIPLIER END ,0,0,0,  
    @BUYBROKERAGE,@SELLBROKERAGE,0,0,  
    @TOT_STT,@TOT_TURN_TAX,@TOT_OTHER_CHRG,@TOT_SEBI_TAX,@TOT_STAMPDUTY,  
    @EXCH_BUYRATE,@EXCH_SELLRATE,  
    @MIN_BROKAMT,@MAX_BROKAMT,@MIN_SCRIPAMT,@MAX_SCRIPAMT  
   )   
     
   IF @SP_VALUE_TO = -1     
   BEGIN    
    SELECT @NEWBUYTURNOVER = 0     
    SELECT @NEWSELLTURNOVER = 0    
   END     
   /*--------------------------------------------------------------------*/  
   FETCH NEXT FROM   
   @SCHEMECUR INTO @SP_COMPUTATION_LEVEL,@SP_MULTIPLIER,@SP_BUY_BROK_TYPE,@SP_SELL_BROK_TYPE,  
   @SP_BUY_BROK,@SP_SELL_BROK,@SP_VALUE_FROM,@SP_VALUE_TO,@SP_SCHEME_TYPE  
  END  
  CLOSE @SCHEMECUR  
  DEALLOCATE @SCHEMECUR  
   /*-----------------------------------------------------------------------------------------------------------*/  
  FETCH NEXT FROM @SETTCUR INTO @PARTY_CODE,@SAUDA_DATE,@CONTRACTNO,@TRADE_NO,@ORDER_NO,@INST_TYPE,@SYMBOL,@EXPIRYDATE,  
  @OPTION_TYPE,@STRIKE_PRICE,@AUCTIONPART,@BUY_TURNOVER,@SELL_TURNOVER,@LOTSIZE,@BUYRATE,@SELLRATE,@BUYQTY,  
  @SELLQTY,@TOT_STT,@TOT_TURN_TAX,@TOT_OTHER_CHRG,@TOT_SEBI_TAX,@TOT_STAMPDUTY,@EXCH_BUYRATE,@EXCH_SELLRATE,  
  @MIN_BROKAMT,@MAX_BROKAMT,@MIN_SCRIPAMT,@MAX_SCRIPAMT,@SP_COMPUTATIONLEVEL,@SP_COMPUTATIONON,  
  @SP_COMPUTATIONTYPE,@SCHEMEID,@TOT_BUYTURNOVER,@TOT_SELLTURNOVER  
   
 END  
 CLOSE @SETTCUR  
 DEALLOCATE @SETTCUR 
   
 INSERT INTO VBB_CHARGES_DETAIL_TEMP  
  (  
  CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,CD_INST_TYPE,CD_SYMBOL,  
  CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,CD_MARKETLOT,CD_SCHEME_ID,  
  CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,  
  CD_TOT_BUYQTY,CD_TOT_SELLQTY,CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER,CD_TOT_BUYTURNOVER_ROUNDED,  
  CD_TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED,  
  CD_TOT_LOT,CD_TOT_RES_TURNOVER,CD_TOT_RES_TURNOVER_ROUNDED,  
  CD_TOT_RES_LOT,CD_TOT_BUYBROK,CD_TOT_SELLBROK,CD_TOT_BROK,  
  CD_TOT_SERTAX,  
  CD_TOT_STT,CD_TOT_TURN_TAX,  
  CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,  
  CD_MIN_BROKAMT,CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT  
  )  
 SELECT   
  CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,CD_INST_TYPE,  
  CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,  
  CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,  
  CD_BUYRATE,CD_SELLRATE,CD_TOT_BUYQTY,CD_TOT_SELLQTY,  
  CD_TOT_BUYTURNOVER,  
  CD_TOT_SELLTURNOVER,  
  CD_TOT_BUYTURNOVER_ROUNDED,  
  CD_TOT_SELLTURNOVER_ROUNDED,  
  CD_TOT_TURNOVER=CD_TOT_BUYTURNOVER+CD_TOT_SELLTURNOVER,  
  CD_TOT_TURNOVER_ROUNDED=CD_TOT_BUYTURNOVER_ROUNDED+CD_TOT_SELLTURNOVER_ROUNDED,  
  CD_TOT_LOT,  
  CD_TOT_RES_TURNOVER=0,  
  CD_TOT_RES_TURNOVER_ROUNDED=0,  
  CD_TOT_RES_LOT,  
  CD_TOT_BUYBROK=(CASE WHEN CD_TOT_BUYBROK > 0   
     THEN (CASE WHEN CD_MAX_BROKAMT = - 1   
     THEN (CASE WHEN CD_MIN_BROKAMT <> 0   
      THEN PRADNYA.DBO.FNMAX(CD_MIN_BROKAMT,CD_TOT_BUYBROK)   
      ELSE CD_TOT_BUYBROK  
      END)  
     ELSE PRADNYA.DBO.FNMIN(CD_MAX_BROKAMT,  
      (CASE WHEN CD_MIN_BROKAMT <> 0   
      THEN PRADNYA.DBO.FNMAX(CD_MIN_BROKAMT,CD_TOT_BUYBROK)   
      ELSE CD_TOT_BUYBROK  
      END))  
     END)  
    ELSE 0   
    END),  
  CD_TOT_SELLBROK=(CASE WHEN CD_TOT_SELLBROK > 0   
     THEN (CASE WHEN CD_MAX_BROKAMT = - 1   
     THEN (CASE WHEN CD_MIN_BROKAMT <> 0   
      THEN PRADNYA.DBO.FNMAX(CD_MIN_BROKAMT,CD_TOT_SELLBROK)   
      ELSE CD_TOT_SELLBROK  
      END)  
     ELSE PRADNYA.DBO.FNMIN(CD_MAX_BROKAMT,  
      (CASE WHEN CD_MIN_BROKAMT <> 0   
      THEN PRADNYA.DBO.FNMAX(CD_MIN_BROKAMT,CD_TOT_SELLBROK)   
      ELSE CD_TOT_SELLBROK  
      END))  
     END)  
    ELSE 0   
    END),  
  CD_TOT_BROK=(CASE WHEN CD_TOT_BROK > 0   
    THEN (CASE WHEN CD_MAX_BROKAMT = - 1   
    THEN (CASE WHEN CD_MIN_BROKAMT <> 0   
     THEN PRADNYA.DBO.FNMAX(CD_MIN_BROKAMT,CD_TOT_BROK)   
     ELSE CD_TOT_BROK  
     END)  
    ELSE PRADNYA.DBO.FNMIN(CD_MAX_BROKAMT,  
     (CASE WHEN CD_MIN_BROKAMT <> 0   
     THEN PRADNYA.DBO.FNMAX(CD_MIN_BROKAMT,CD_TOT_BROK)   
     ELSE CD_TOT_BROK  
     END))  
    END)  
   ELSE 0   
   END),       
  CD_TOT_SERTAX=0,  
  CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY,  
  CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,CD_MAX_BROKAMT,  
  CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT  
 FROM  
 (  
  SELECT   
  CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,CD_INST_TYPE,  
  CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,CD_MARKETLOT,  
  CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,  
  CD_TOT_BUYQTY= CD_TOT_BUYQTY,  
  CD_TOT_SELLQTY= CD_TOT_SELLQTY,  
  CD_TOT_BUYTURNOVER=SUM(CD_TOT_BUYTURNOVER),  
  CD_TOT_BUYTURNOVER_ROUNDED=SUM(CD_TOT_BUYTURNOVER_ROUNDED),  
  CD_TOT_SELLTURNOVER=SUM(CD_TOT_SELLTURNOVER),  
  CD_TOT_SELLTURNOVER_ROUNDED=SUM(CD_TOT_SELLTURNOVER_ROUNDED),  
  CD_TOT_LOT,  
  CD_TOT_RES_TURNOVER=SUM(CD_TOT_RES_TURNOVER),  
  CD_TOT_RES_TURNOVER_ROUNDED=SUM(CD_TOT_RES_TURNOVER_ROUNDED),  
  CD_TOT_RES_LOT,  
  CD_TOT_BUYBROK=SUM(CD_TOT_BUYBROK),  
  CD_TOT_SELLBROK=SUM(CD_TOT_SELLBROK),  
  CD_TOT_BROK=SUM(CD_TOT_BUYBROK+CD_TOT_SELLBROK),  
  CD_TOT_SERTAX = 0 ,  
  CD_TOT_STT=(CD_TOT_STT), 
  CD_TOT_TURN_TAX=(CD_TOT_TURN_TAX),  
  CD_TOT_OTHER_CHRG=(CD_TOT_OTHER_CHRG),  
  CD_TOT_SEBI_TAX=(CD_TOT_SEBI_TAX),  
  CD_TOT_STAMPDUTY=(CD_TOT_STAMPDUTY),  
  CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,  
  CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT  
  FROM   
  VBB_CHARGES_DETAIL_TEMP1  
  GROUP BY  
  CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,CD_INST_TYPE,  
CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,CD_MARKETLOT,  
  CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,CD_SELLRATE,  
  CD_TOT_LOT,CD_TOT_RES_LOT,CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,CD_MIN_BROKAMT,  
  CD_MAX_BROKAMT,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT, CD_TOT_BUYQTY, CD_TOT_SELLQTY,  
  CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,CD_TOT_STAMPDUTY  
 )FOSETTCHRG  
END  
UPDATE   
 VBB_CHARGES_DETAIL_TEMP  
SET  
 CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0  
WHERE  
 CD_TOT_SELLBROK > CD_TOT_BUYBROK  
 AND CD_TOT_BROK <>  (CD_TOT_SELLBROK+CD_TOT_BUYBROK)  
  
UPDATE   
 VBB_CHARGES_DETAIL_TEMP  
SET  
 CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0  
WHERE  
 CD_TOT_BUYBROK >= CD_TOT_SELLBROK   
 AND CD_TOT_BROK <>  (CD_TOT_SELLBROK+CD_TOT_BUYBROK)  
  
/*---------------------------------------------------------------------------------------------------------------  
    TAKING DATA FOR SCRIP LEVEL + CONTRACT LEVEL ROUNDING  
----------------------------------------------------------------------------------------------------------------*/  
  
IF (SELECT ISNULL(COUNT(1),0) FROM TRD_SCHEME_MAPPING      
WHERE SP_MIN_SCRIPAMT+SP_MAX_SCRIPAMT <> -1) > 0       
BEGIN    
  /*SCRIP LEVEL ROUNDING*/  
  INSERT INTO VBB_CHARGES_DETAIL_FINAL  
  SELECT   
  CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,  
  CD_TRADE_NO='',  
  CD_ORDER_NO='',  
  CD_INST_TYPE,CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,  
  CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,  
  CD_BUYRATE = CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_BUYRATE*CD_TOT_BUYQTY)/SUM(CD_TOT_BUYQTY) ELSE 0 END,  
  CD_SELLRATE = CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_SELLRATE*CD_TOT_SELLQTY)/SUM(CD_TOT_SELLQTY) ELSE 0 END,  
  CD_TOT_BUYQTY = SUM(CD_TOT_BUYQTY),  
  CD_TOT_SELLQTY = SUM(CD_TOT_SELLQTY),  
  CD_TOT_BUYTURNOVER = SUM(CD_TOT_BUYTURNOVER),  
  CD_TOT_SELLTURNOVER = SUM(CD_TOT_SELLTURNOVER),  
  CD_TOT_BUYTURNOVER_ROUNDED = SUM(CD_TOT_BUYTURNOVER_ROUNDED),  
  CD_TOT_SELLTURNOVER_ROUNDED = SUM(CD_TOT_SELLTURNOVER_ROUNDED),  
  CD_TOT_TURNOVER=SUM(CD_TOT_TURNOVER),  
  CD_TOT_TURNOVER_ROUNDED=SUM(CD_TOT_TURNOVER_ROUNDED),  
  CD_TOT_LOT=SUM(CD_TOT_LOT),  
  CD_TOT_RES_TURNOVER=1,  
  CD_TOT_RES_TURNOVER_ROUNDED=SUM(CD_TOT_RES_TURNOVER_ROUNDED),  
  CD_TOT_RES_LOT=SUM(CD_TOT_RES_LOT),  
  CD_TOT_BUYBROK = SUM(CD_TOT_BUYBROK),  
  CD_TOT_SELLBROK =SUM(CD_TOT_SELLBROK),  
  CD_TOT_BROK = (CASE WHEN SUM(CD_TOT_BROK) > 0   
     THEN (CASE WHEN CD_MAX_SCRIPAMT = - 1   
      THEN (CASE WHEN CD_MIN_SCRIPAMT <> 0   
      THEN PRADNYA.DBO.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))   
      ELSE SUM(CD_TOT_BROK)  
      END)  
     ELSE PRADNYA.DBO.FNMIN(CD_MAX_SCRIPAMT,  
      (CASE WHEN CD_MIN_SCRIPAMT <> 0   
      THEN PRADNYA.DBO.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))   
      ELSE SUM(CD_TOT_BROK)  
      END))  
     END)  
    ELSE 0   
    END),  
  CD_TOT_SERTAX=0,  
  CD_TOT_STT=SUM(CD_TOT_STT),  
  CD_TOT_TURN_TAX=SUM(CD_TOT_TURN_TAX),  
  CD_TOT_OTHER_CHRG=SUM(CD_TOT_OTHER_CHRG),  
  CD_TOT_SEBI_TAX=SUM(CD_TOT_SEBI_TAX),  
  CD_TOT_STAMPDUTY=SUM(CD_TOT_STAMPDUTY),  
  CD_EXCH_BUYRATE=CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_EXCH_BUYRATE*CD_TOT_BUYQTY) / SUM(CD_TOT_BUYQTY) ELSE 0 END ,  
  CD_EXCH_SELLRATE =CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_EXCH_SELLRATE*CD_TOT_SELLQTY) / SUM(CD_TOT_SELLQTY) ELSE 0 END ,  
  0,0,CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT  
  FROM   
   VBB_CHARGES_DETAIL_TEMP  
  WHERE  
   CD_COMPUTATIONLEVEL NOT IN ('C','S')  
  GROUP BY  
  CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,  
  CD_INST_TYPE,CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,  
  CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,  
  CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT  
  HAVING    
 SUM(CD_TOT_BROK) <> (CASE WHEN SUM(CD_TOT_BROK) > 0   
     THEN (CASE WHEN CD_MAX_SCRIPAMT = - 1   
      THEN (CASE WHEN CD_MIN_SCRIPAMT <> 0   
       THEN PRADNYA.DBO.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))   
       ELSE SUM(CD_TOT_BROK)  
       END)  
      ELSE PRADNYA.DBO.FNMIN(CD_MAX_SCRIPAMT,  
       (CASE WHEN CD_MIN_SCRIPAMT <> 0   
       THEN PRADNYA.DBO.FNMAX(CD_MIN_SCRIPAMT,SUM(CD_TOT_BROK))   
       ELSE SUM(CD_TOT_BROK)  
       END))  
      END)  
     ELSE 0   
     END)  
   
 UPDATE   
  VBB_CHARGES_DETAIL_FINAL  
 SET  
  CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0  
 WHERE  
  CD_TOT_SELLBROK > CD_TOT_BUYBROK  
   
 UPDATE   
  VBB_CHARGES_DETAIL_FINAL  
 SET  
  CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0  
 WHERE  
  CD_TOT_BUYBROK >= CD_TOT_SELLBROK   
   
   
 DELETE   
  VBB_CHARGES_DETAIL_TEMP   
 FROM   
  VBB_CHARGES_DETAIL_FINAL  
 WHERE  
  CONVERT(VARCHAR,VBB_CHARGES_DETAIL_TEMP.CD_SAUDA_DATE,103) = CONVERT(VARCHAR,VBB_CHARGES_DETAIL_FINAL.CD_SAUDA_DATE,103)  
  AND VBB_CHARGES_DETAIL_TEMP.CD_PARTY_CODE = VBB_CHARGES_DETAIL_FINAL.CD_PARTY_CODE  
  AND VBB_CHARGES_DETAIL_TEMP.CD_CONTRACT_NO = VBB_CHARGES_DETAIL_FINAL.CD_CONTRACT_NO  
  AND VBB_CHARGES_DETAIL_TEMP.CD_SYMBOL = VBB_CHARGES_DETAIL_FINAL.CD_SYMBOL  
  AND CONVERT(VARCHAR,VBB_CHARGES_DETAIL_TEMP.CD_EXPIRY_DATE,103) = CONVERT(VARCHAR,VBB_CHARGES_DETAIL_FINAL.CD_EXPIRY_DATE,103)  
  AND VBB_CHARGES_DETAIL_TEMP.CD_OPTION_TYPE = VBB_CHARGES_DETAIL_FINAL.CD_OPTION_TYPE  
  AND VBB_CHARGES_DETAIL_TEMP.CD_STRIKE_PRICE = VBB_CHARGES_DETAIL_FINAL.CD_STRIKE_PRICE  
  AND  VBB_CHARGES_DETAIL_TEMP.CD_AUCTIONPART = VBB_CHARGES_DETAIL_FINAL.CD_AUCTIONPART  
   
END  
  
/*CONTRACT LEVEL ROUNDING*/  
IF (SELECT ISNULL(COUNT(1),0) FROM TRD_CONTRACT_ROUNDING) > 0       
BEGIN    
  
  INSERT INTO VBB_CHARGES_DETAIL_TEMP  
  SELECT  
  CD_PARTY_CODE=F.PARTY_CODE,  
  CD_SAUDA_DATE=LEFT(SAUDA_DATE,11),  
  CD_CONTRACT_NO=CONTRACTNO,  
  CD_TRADE_NO=TRADE_NO,  
  CD_ORDER_NO=ORDER_NO,  
  CD_INST_TYPE= INST_TYPE,  
  CD_SYMBOL=SYMBOL,  
  CD_EXPIRY_DATE=EXPIRYDATE,  
  CD_OPTION_TYPE=OPTION_TYPE,  
  CD_STRIKE_PRICE=STRIKE_PRICE,  
  CD_AUCTIONPART=AUCTIONPART,  
  CD_MARKETLOT=CONVERT(BIGINT,BILLNO),  
  CD_SCHEME_ID=0,  
  CD_COMPUTATIONLEVEL='X',  
  CD_COMPUTATIONON='',  
  CD_COMPUTATIONTYPE='',  
  CD_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0   
    THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE ELSE 0 END) /   
     SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)  
    ELSE 0   
    END),  
  CD_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0   
    THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE ELSE 0 END) / 
     SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)  
   ELSE 0   
    END),  
  CD_TOT_BUYQTY = SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY ELSE 0 END),  
  CD_TOT_SELLQTY = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY ELSE 0 END),  
  CD_TOT_BUYTURNOVER = SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY*PRICE ELSE 0 END),  
  CD_TOT_SELLTURNOVER = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY*PRICE ELSE 0 END),  
  CD_TOT_BUYTURNOVER_ROUNDED = SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY*PRICE ELSE 0 END),  
  CD_TOT_SELLTURNOVER_ROUNDED = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY*PRICE ELSE 0 END),  
  CD_TOT_TURNOVER=SUM(TRADEQTY*PRICE),  
  CD_TOT_TURNOVER_ROUNDED=SUM(TRADEQTY*PRICE),  
  CD_TOT_LOT=0,  
  CD_TOT_RES_TURNOVER=0,  
  CD_TOT_RES_TURNOVER_ROUNDED=0,  
  CD_TOT_RES_LOT=0,  
  CD_TOT_BUYBROK =  SUM(CASE WHEN SELL_BUY=1 THEN TRADEQTY * BROKAPPLIED ELSE 0 END ),  
  CD_TOT_SELLBROK = SUM(CASE WHEN SELL_BUY=2 THEN TRADEQTY * BROKAPPLIED ELSE 0 END ),  
  CD_TOT_BROK = SUM(TRADEQTY*BROKAPPLIED),  
  CD_TOT_SERTAX=SUM(SERVICE_TAX),  
  CD_TOT_STT=SUM(INS_CHRG),  
  CD_TOT_TURN_TAX=SUM(TURN_TAX),  
  CD_TOT_OTHER_CHRG=SUM(F.OTHER_CHRG),  
  CD_TOT_SEBI_TAX=SUM(SEBI_TAX), 
  CD_TOT_STAMPDUTY=SUM(BROKER_CHRG),   
  CD_EXCH_BUYRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0   
    THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE ELSE 0 END) /   
     SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)  
    ELSE 0   
    END),  
  CD_EXCH_SELLRATE = (CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0   
    THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE ELSE 0 END) /   
     SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)  
    ELSE 0   
    END),  
  0,0,0,0  
  FROM  
  VBB_FOSETTLEMENT F  
  WHERE   
  EXISTS (  
    SELECT CR_PARTY_CODE FROM TRD_CONTRACT_ROUNDING C   
    WHERE SAUDA_DATE BETWEEN CR_DATE_FROM AND CR_DATE_TO AND F.PARTY_CODE = C.CR_PARTY_CODE)   
  AND NOT EXISTS   
  (  
  SELECT F.PARTY_CODE FROM VBB_CHARGES_DETAIL_TEMP  
  WHERE      
   CONVERT(VARCHAR,CD_SAUDA_DATE,103) = CONVERT(VARCHAR,SAUDA_DATE,103)   
   AND CD_PARTY_CODE = F.PARTY_CODE  
   AND CD_INST_TYPE = INST_TYPE  
   AND CD_SYMBOL = SYMBOL  
   AND CONVERT(VARCHAR,CD_EXPIRY_DATE,103) = CONVERT(VARCHAR,EXPIRYDATE,103)  
   AND CD_STRIKE_PRICE = STRIKE_PRICE  
   AND CD_OPTION_TYPE = OPTION_TYPE  
   AND CD_AUCTIONPART = AUCTIONPART  
  )   
  GROUP BY  
  LEFT(SAUDA_DATE,11),       
  F.PARTY_CODE,  
  INST_TYPE,  
  SYMBOL,  
  EXPIRYDATE,  
  STRIKE_PRICE,  
  OPTION_TYPE,  
  AUCTIONPART,  
  CONTRACTNO,  
  ORDER_NO,  
  TRADE_NO,  
  CONVERT(BIGINT,BILLNO)  
   
  INSERT INTO VBB_CHARGES_DETAIL_FINAL   
  SELECT  
  CD_PARTY_CODE,CD_SAUDA_DATE,  
  CD_CONTRACT_NO=0,  
  CD_TRADE_NO='',CD_ORDER_NO='',  
  CD_INST_TYPE= 'FUTOPT',  
  CD_SYMBOL='BROKERAGE',  
  CD_EXPIRY_DATE='DEC 31 2049 23:59',  
  CD_OPTION_TYPE='',CD_STRIKE_PRICE=0,CD_AUCTIONPART='',CD_MARKETLOT=0,  
  CD_SCHEME_ID=0,CD_COMPUTATIONLEVEL='C',CD_COMPUTATIONON='',CD_COMPUTATIONTYPE='',  
  CD_BUYRATE = 0,  
  CD_SELLRATE = 0,  
  CD_TOT_BUYQTY = 0,  
  CD_TOT_SELLQTY = 0,  
  CD_TOT_BUYTURNOVER = 0,  
  CD_TOT_SELLTURNOVER = 0,  
  CD_TOT_BUYTURNOVER_ROUNDED = 0,  
  CD_TOT_SELLTURNOVER_ROUNDED = 0,  
  CD_TOT_TURNOVER=0,  
  CD_TOT_TURNOVER_ROUNDED=0,  
  CD_TOT_LOT=0,  
  CD_TOT_RES_TURNOVER=0,  
  CD_TOT_RES_TURNOVER_ROUNDED=0,  
  CD_TOT_RES_LOT=0,  
  CD_TOT_BUYBROK = SUM(CD_TOT_BUYBROK),  
  CD_TOT_SELLBROK = SUM(CD_TOT_SELLBROK),  
  CD_TOT_BROK = CASE WHEN CR_MAX_CONTRACTAMT = - 1   
    THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0   
     THEN PRADNYA.DBO.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))  
     ELSE SUM(CD_TOT_BROK)  
     END)  
    ELSE PRADNYA.DBO.FNMIN(CR_MAX_CONTRACTAMT,  
     (CASE WHEN CR_MIN_CONTRACTAMT <> 0   
     THEN PRADNYA.DBO.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))  
     ELSE SUM(CD_TOT_BROK)  
END))  
    END,  
  CD_TOT_SERTAX=0,  
  CD_TOT_STT=0,  
 CD_TOT_TURN_TAX=0,  
  CD_TOT_OTHER_CHRG=0,  
  CD_TOT_SEBI_TAX=0,  
  CD_TOT_STAMPDUTY=0,  
  CD_EXCH_BUYRATE=0 ,  
  CD_EXCH_SELLRATE =0,  
  0,0,0,0  
 FROM  
  VBB_CHARGES_DETAIL_TEMP  LEFT OUTER JOIN TRD_CONTRACT_ROUNDING   
  ON (CR_PARTY_CODE = CD_PARTY_CODE   
   AND CD_SAUDA_DATE BETWEEN CR_DATE_FROM AND CR_DATE_TO)    
 GROUP BY  
  CD_PARTY_CODE,CR_MIN_CONTRACTAMT,  
  CR_MAX_CONTRACTAMT,CD_SAUDA_DATE  
HAVING   
  SUM(CD_TOT_BROK) > CASE WHEN CR_MAX_CONTRACTAMT = - 1   
   THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0   
    THEN PRADNYA.DBO.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))  
    ELSE SUM(CD_TOT_BROK)  
    END)  
   ELSE PRADNYA.DBO.FNMIN(CR_MAX_CONTRACTAMT,  
    (CASE WHEN CR_MIN_CONTRACTAMT <> 0   
    THEN PRADNYA.DBO.FNMAX(CR_MIN_CONTRACTAMT,SUM(CD_TOT_BROK))  
    ELSE SUM(CD_TOT_BROK)  
    END))  
   END   
   

 INSERT INTO VBB_CHARGES_DETAIL_FINAL   
 SELECT  
  CD_PARTY_CODE,CD_SAUDA_DATE,  
  CD_CONTRACT_NO=0,  
  CD_TRADE_NO='',CD_ORDER_NO='',  
  CD_INST_TYPE= 'FUTOPT',  
  CD_SYMBOL='BROKERAGE',  
  CD_EXPIRY_DATE='DEC 31 2049 23:59',  
  CD_OPTION_TYPE='',CD_STRIKE_PRICE=0,CD_AUCTIONPART='',CD_MARKETLOT=0,  
  CD_SCHEME_ID=0,CD_COMPUTATIONLEVEL='C',CD_COMPUTATIONON='',CD_COMPUTATIONTYPE='',  
  CD_BUYRATE = 0,  
  CD_SELLRATE = 0,  
  CD_TOT_BUYQTY = 0,  
  CD_TOT_SELLQTY = 0,  
  CD_TOT_BUYTURNOVER = 0,  
  CD_TOT_SELLTURNOVER = 0,  
  CD_TOT_BUYTURNOVER_ROUNDED = 0,  
  CD_TOT_SELLTURNOVER_ROUNDED = 0,  
  CD_TOT_TURNOVER=0,  
  CD_TOT_TURNOVER_ROUNDED=0,  
  CD_TOT_LOT=0,  
  CD_TOT_RES_TURNOVER=0,  
  CD_TOT_RES_TURNOVER_ROUNDED=0,  
  CD_TOT_RES_LOT=1,  
  CD_TOT_BUYBROK = SUM(CD_TOT_BUYBROK),  
  CD_TOT_SELLBROK = SUM(CD_TOT_SELLBROK),  
  CD_TOT_BROK = CASE WHEN CR_MAX_CONTRACTAMT = - 1   
    THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0   
     THEN PRADNYA.DBO.FNMAX(PRADNYA.DBO.FNMIN(SUM(CD_TOT_TURNOVER)*@SEBI_PER/100, CR_MIN_CONTRACTAMT),SUM(CD_TOT_BROK))  
     ELSE SUM(CD_TOT_BROK)  
     END)  
    ELSE PRADNYA.DBO.FNMIN(CR_MAX_CONTRACTAMT,  
     (CASE WHEN CR_MIN_CONTRACTAMT <> 0   
     THEN PRADNYA.DBO.FNMAX(PRADNYA.DBO.FNMIN(SUM(CD_TOT_TURNOVER)*@SEBI_PER/100, CR_MIN_CONTRACTAMT),SUM(CD_TOT_BROK))  
     ELSE SUM(CD_TOT_BROK)  
     END))  
    END,  
  CD_TOT_SERTAX=0,  
  CD_TOT_STT=0,  
  CD_TOT_TURN_TAX=0,  
  CD_TOT_OTHER_CHRG=0,  
  CD_TOT_SEBI_TAX=0,  
  CD_TOT_STAMPDUTY=0,  
  CD_EXCH_BUYRATE=0 ,  
  CD_EXCH_SELLRATE =0,  
  0,0,0,0  
  FROM  
  VBB_CHARGES_DETAIL_TEMP  LEFT OUTER JOIN TRD_CONTRACT_ROUNDING   
  ON (CR_PARTY_CODE = CD_PARTY_CODE   
   AND CD_SAUDA_DATE BETWEEN CR_DATE_FROM AND CR_DATE_TO)  
   AND CD_PARTY_CODE NOT IN (SELECT CD_PARTY_CODE FROM VBB_CHARGES_DETAIL_FINAL )  
 GROUP BY     
  CD_PARTY_CODE,CR_MIN_CONTRACTAMT,  
  CR_MAX_CONTRACTAMT,CD_SAUDA_DATE  
 HAVING   
  SUM(CD_TOT_BROK) < CASE WHEN CR_MAX_CONTRACTAMT = - 1   
   THEN (CASE WHEN CR_MIN_CONTRACTAMT <> 0   
    THEN PRADNYA.DBO.FNMAX(PRADNYA.DBO.FNMIN(SUM(CD_TOT_TURNOVER)*@SEBI_PER/100, CR_MIN_CONTRACTAMT),SUM(CD_TOT_BROK))  
    ELSE SUM(CD_TOT_BROK)  
    END)  
   ELSE PRADNYA.DBO.FNMIN(CR_MAX_CONTRACTAMT,  
    (CASE WHEN CR_MIN_CONTRACTAMT <> 0   
    THEN PRADNYA.DBO.FNMAX(PRADNYA.DBO.FNMIN(SUM(CD_TOT_TURNOVER)*@SEBI_PER/100, CR_MIN_CONTRACTAMT),SUM(CD_TOT_BROK))  
    ELSE SUM(CD_TOT_BROK)  
    END))  
   END  
   
UPDATE VBB_CHARGES_DETAIL_TEMP SET CD_COMPUTATIONLEVEL  = 'X'
FROM   
  VBB_CHARGES_DETAIL_FINAL  F
 WHERE  
  VBB_CHARGES_DETAIL_TEMP.CD_PARTY_CODE = F.CD_PARTY_CODE    
  AND F.CD_TOT_BROK < F.CD_TOT_BUYBROK + F.CD_TOT_SELLBROK
  AND F.CD_SYMBOL ='BROKERAGE'
  
 UPDATE   
  VBB_CHARGES_DETAIL_TEMP SET CD_TOT_BUYBROK = 0, CD_TOT_SELLBROK =0, CD_TOT_BROK = 0   
 FROM   
  VBB_CHARGES_DETAIL_FINAL  
 WHERE  
  VBB_CHARGES_DETAIL_TEMP.CD_PARTY_CODE = VBB_CHARGES_DETAIL_FINAL.CD_PARTY_CODE    
  AND VBB_CHARGES_DETAIL_TEMP.CD_COMPUTATIONLEVEL  = 'X' 
  
   DELETE  
  VBB_CHARGES_DETAIL_TEMP  
 WHERE  
  CD_COMPUTATIONLEVEL  = 'X'  
  AND CD_PARTY_CODE NOT IN (SELECT CD_PARTY_CODE FROM VBB_CHARGES_DETAIL_FINAL )  
    
 UPDATE  
  VBB_CHARGES_DETAIL_TEMP  
 SET  
  CD_COMPUTATIONLEVEL = 'C'  
 WHERE  
  CD_COMPUTATIONLEVEL  = 'X'  
   
 UPDATE   
  VBB_CHARGES_DETAIL_FINAL  
 SET  
  CD_TOT_BROK = CD_TOT_BROK - (CD_TOT_SELLBROK + CD_TOT_BUYBROK)  
 WHERE  CD_TOT_BROK > (CD_TOT_SELLBROK + CD_TOT_BUYBROK) 
      
 UPDATE   
  VBB_CHARGES_DETAIL_FINAL  
 SET  
  CD_TOT_SELLBROK=CD_TOT_BROK , CD_TOT_BUYBROK=0  
 WHERE  
  CD_TOT_SELLBROK > CD_TOT_BUYBROK  
   
 UPDATE   
  VBB_CHARGES_DETAIL_FINAL  
 SET  
  CD_TOT_BUYBROK=CD_TOT_BROK , CD_TOT_SELLBROK=0  
 WHERE  
  CD_TOT_BUYBROK >= CD_TOT_SELLBROK  
   
 DELETE FROM VBB_CHARGES_DETAIL_TEMP 
 WHERE CD_PARTY_CODE IN (SELECT CD_PARTY_CODE FROM VBB_CHARGES_DETAIL_FINAL)
	AND CD_TOT_RES_TURNOVER = 1	


 UPDATE VBB_CHARGES_DETAIL_FINAL SET CD_COMPUTATIONLEVEL='C' WHERE CD_COMPUTATIONLEVEL='X'
 
 INSERT INTO VBB_CHARGES_DETAIL_TEMP SELECT * FROM VBB_CHARGES_DETAIL_FINAL  
   
END  
  
/*FINAL OUTPUT*/  
  
TRUNCATE TABLE VBB_CHARGES_DETAIL   
  
INSERT INTO VBB_CHARGES_DETAIL   
SELECT   
	CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO, 
	CD_INST_TYPE=  (CASE WHEN CD_COMPUTATIONLEVEL <> 'C' THEN CD_INST_TYPE ELSE '' END), 
	CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,  
	CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,  
	CD_BUYRATE = CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_BUYRATE*CD_TOT_BUYQTY)/SUM(CD_TOT_BUYQTY) ELSE 0 END,  
	CD_SELLRATE = CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_SELLRATE*CD_TOT_SELLQTY)/SUM(CD_TOT_SELLQTY) ELSE 0 END,  
	CD_TOT_BUYQTY = SUM(CD_TOT_BUYQTY),  
	CD_TOT_SELLQTY = SUM(CD_TOT_SELLQTY),  
	CD_TOT_BUYTURNOVER = SUM(CD_TOT_BUYTURNOVER),  
	CD_TOT_SELLTURNOVER = SUM(CD_TOT_SELLTURNOVER),  
	CD_TOT_BUYTURNOVER_ROUNDED = SUM(CD_TOT_BUYTURNOVER_ROUNDED),  
	CD_TOT_SELLTURNOVER_ROUNDED = SUM(CD_TOT_SELLTURNOVER_ROUNDED),  
	CD_TOT_TURNOVER=SUM(CD_TOT_TURNOVER),  
	CD_TOT_TURNOVER_ROUNDED=SUM(CD_TOT_TURNOVER_ROUNDED),  
	CD_TOT_LOT=SUM(CD_TOT_LOT),  
	CD_TOT_RES_TURNOVER=SUM(CD_TOT_RES_TURNOVER),  
	CD_TOT_RES_TURNOVER_ROUNDED=SUM(CD_TOT_RES_TURNOVER_ROUNDED),  
	CD_TOT_RES_LOT=SUM(CD_TOT_RES_LOT),  
	CD_TOT_BUYBROK =  SUM(CD_TOT_BUYBROK),  
	CD_TOT_SELLBROK = SUM(CD_TOT_SELLBROK),  
	CD_TOT_BROK = SUM(CD_TOT_BROK),  
	CD_TOT_BUYSERTAX= SUM(CD_TOT_BUYBROK * SERVICE_TAX/100 ),  
	CD_TOT_SELLSERTAX= SUM(CD_TOT_SELLBROK * SERVICE_TAX/100 ),  
	CD_TOT_SERTAX= SUM(CD_TOT_BROK * SERVICE_TAX/100 ),  
	CD_TOT_STT=SUM(CD_TOT_STT),  
	CD_TOT_TURN_TAX=SUM(CD_TOT_TURN_TAX),  
	CD_TOT_OTHER_CHRG=SUM(CD_TOT_OTHER_CHRG),  
	CD_TOT_SEBI_TAX=SUM(CD_TOT_SEBI_TAX),  
	CD_TOT_STAMPDUTY=SUM(CD_TOT_STAMPDUTY),  
	CD_EXCH_BUYRATE=CASE WHEN SUM(CD_TOT_BUYQTY) >0 THEN SUM(CD_EXCH_BUYRATE*CD_TOT_BUYQTY) / SUM(CD_TOT_BUYQTY) ELSE 0 END ,  
	CD_EXCH_SELLRATE =CASE WHEN SUM(CD_TOT_SELLQTY) >0 THEN SUM(CD_EXCH_SELLRATE*CD_TOT_SELLQTY) / SUM(CD_TOT_SELLQTY) ELSE 0 END  
FROM   
	VBB_CHARGES_DETAIL_TEMP , FOGLOBALS  
WHERE   
	CD_SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT  
GROUP BY  
	CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,  
	(CASE WHEN CD_COMPUTATIONLEVEL <> 'C' THEN CD_INST_TYPE ELSE '' END),      
	CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,CD_AUCTIONPART,  
	CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,  
	CD_MIN_SCRIPAMT,CD_MAX_SCRIPAMT,SERVICE_TAX  
  
/*---------------------------------------------------------------------------------------------------------------  
   KEEPING DUMMY CONTRACT DESCRIPTOR AT THE MASTER  
----------------------------------------------------------------------------------------------------------------*/  
DECLARE @INTCOUNT BIGINT,  
 @INTMAXCOUNT INT  
SET @INTCOUNT = 0  
  
  
IF (SELECT COUNT(1) FROM FOSCRIP2 WHERE INST_TYPE ='FUTOPT' AND SYMBOL ='BROKERAGE'  
 AND EXPIRYDATE =  'DEC 31 2049 23:59' ) =0   
BEGIN  
  
	INSERT INTO FOSCRIP2 (INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
	MATURITYDATE,C_REGULAR_LOT)  
	VALUES ('FUTOPT','BROKERAGE','BROKERAGE','DEC 31 2049 23:59',0,'','DEC 31 2049 23:59',1)  
END  
  


UPDATE  
	VBB_CHARGES_DETAIL  
SET  
	CD_EXPIRY_DATE = LEFT(CD_EXPIRY_DATE,11) + ' 23:59'  
  
UPDATE  
	VBB_CHARGES_DETAIL  
SET  
	CD_TOT_BUYSERTAX=0,CD_TOT_SELLSERTAX=0,CD_TOT_SERTAX=0  
FROM  
	CLIENT1, CLIENT2  
WHERE  
	CLIENT1.CL_CODE = CLIENT2.CL_CODE  
	AND PARTY_CODE = CD_PARTY_CODE  
	AND SERVICE_CHRG = 1 AND SERTAXMETHOD = 1  


 UPDATE   
  VBB_CHARGES_DETAIL  
 SET  
  CD_TOT_BROK = (CD_TOT_SELLBROK + CD_TOT_BUYBROK)  
     
  
UPDATE   
	FOSETTLEMENT  
SET  
	BROKAPPLIED = 0,  
	SERVICE_TAX = 0,  
	NETRATE = PRICE  
FROM  
	VBB_CHARGES_DETAIL   
WHERE  
	LEFT(CD_SAUDA_DATE,11) = LEFT(SAUDA_DATE,11)  
	AND CD_PARTY_CODE = PARTY_CODE  
	AND CD_TRADE_NO = PRADNYA.DBO.REPLACETRADENO (TRADE_NO)
	AND CD_ORDER_NO = ORDER_NO
	AND CD_INST_TYPE = INST_TYPE  
	AND CD_SYMBOL = SYMBOL  
	AND CD_EXPIRY_DATE = EXPIRYDATE  
	AND CD_STRIKE_PRICE = STRIKE_PRICE  
	AND CD_OPTION_TYPE = OPTION_TYPE  
	AND CD_AUCTIONPART = AUCTIONPART  
	AND AUCTIONPART <> 'CA'  
	AND SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59'  
	AND PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO 
 
UPDATE   
	FOSETTLEMENT  
SET  
	BROKAPPLIED = 0,  
	SERVICE_TAX = 0,  
	NETRATE = PRICE  
FROM  
	VBB_CHARGES_DETAIL   
WHERE  
	LEFT(CD_SAUDA_DATE,11) = LEFT(SAUDA_DATE,11)  
	AND CD_PARTY_CODE = PARTY_CODE  
	AND SAUDA_DATE BETWEEN @SAUDA_DATE_FROM AND @SAUDA_DATE_TO +' 23:59'  
	AND PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO  
	AND CD_COMPUTATIONLEVEL ='C'  
	AND CD_TOT_RES_LOT=0
  

  
DELETE FROM CHARGES_DETAIL   
WHERE  
	CD_SAUDA_DATE >= @SAUDA_DATE_FROM    
	AND CD_SAUDA_DATE <= @SAUDA_DATE_TO + ' 23:59:59'  
	AND CD_PARTY_CODE >= @PARTY_FROM  
	AND CD_PARTY_CODE <= @PARTY_TO  
  
UPDATE VBB_CHARGES_DETAIL 
SET
	CD_TOT_BUYSERTAX=0,  
	CD_TOT_SELLSERTAX=0,  
	CD_TOT_SERTAX =0 
FROM
	CLIENT2 C2  
WHERE  
	CD_SAUDA_DATE >= @SAUDA_DATE_FROM      
	AND CD_SAUDA_DATE <= @SAUDA_DATE_TO + ' 23:59:59'    
	AND CD_PARTY_CODE >= @PARTY_FROM    
	AND CD_PARTY_CODE <= @PARTY_TO    
	AND C2.PARTY_CODE=CD_PARTY_CODE   
	AND SERVICE_CHRG=1 AND SERTAXMETHOD=1  
	
UPDATE 
	VBB_CHARGES_DETAIL 
SET 
	CD_TOT_BUYSERTAX=0,  
	CD_TOT_SELLSERTAX=0,  
	CD_TOT_SERTAX =0 
FROM 
	CLIENT2 C2 (NOLOCK),CLIENT1 C1 (NOLOCK)  
WHERE    
	C1.CL_CODE = C2.CL_CODE  
	AND CD_SAUDA_DATE >= @SAUDA_DATE_FROM      
	AND CD_SAUDA_DATE <= @SAUDA_DATE_TO + ' 23:59:59'    
	AND CD_PARTY_CODE >= @PARTY_FROM    
	AND CD_PARTY_CODE <= @PARTY_TO    
	AND C2.PARTY_CODE=CD_PARTY_CODE   
	AND L_STATE =  'JAMMU AND KASHMIR'  
  
  
INSERT INTO CHARGES_DETAIL   
SELECT   
	CD_PARTY_CODE,CD_SAUDA_DATE,CD_CONTRACT_NO,CD_TRADE_NO,CD_ORDER_NO,CD_INST_TYPE,CD_SYMBOL,CD_EXPIRY_DATE,CD_OPTION_TYPE,CD_STRIKE_PRICE,  
	CD_AUCTIONPART,CD_MARKETLOT,CD_SCHEME_ID,CD_COMPUTATIONLEVEL,CD_COMPUTATIONON,CD_COMPUTATIONTYPE,CD_BUYRATE,  
	CD_SELLRATE,CD_TOT_BUYQTY,CD_TOT_SELLQTY,CD_TOT_BUYTURNOVER,CD_TOT_SELLTURNOVER,CD_TOT_BUYTURNOVER_ROUNDED,  
	CD_TOT_SELLTURNOVER_ROUNDED,CD_TOT_TURNOVER,CD_TOT_TURNOVER_ROUNDED,CD_TOT_LOT,CD_TOT_RES_TURNOVER,  
	CD_TOT_RES_TURNOVER_ROUNDED,CD_TOT_RES_LOT,CD_TOT_BUYBROK,CD_TOT_SELLBROK,CD_TOT_BROK,CD_TOT_BUYSERTAX,  
	CD_TOT_SELLSERTAX,CD_TOT_SERTAX,CD_TOT_STT,CD_TOT_TURN_TAX,CD_TOT_OTHER_CHRG,CD_TOT_SEBI_TAX,  
	CD_TOT_STAMPDUTY,CD_EXCH_BUYRATE,CD_EXCH_SELLRATE,GETDATE()
FROM   
	VBB_CHARGES_DETAIL   

  

EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE_FROM,'VBB','',@USERNAME,''
  

--COMMIT TRANSACTION  
  

/*---------------------------------------------------------------------------------------------------------------  
     END OF PROCEDURE  
----------------------------------------------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_COMMONSCRIPCDODE_UPD
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[PR_COMMONSCRIPCDODE_UPD]
	(
	@USERNAME VARCHAR(20)	= '',
	@SESSION_ID VARCHAR(30)	= '',
	@FILE_TYPE VARCHAR(20)	= ''
	) 

	AS  

	IF @SESSION_ID <> ''
	BEGIN 
		UPDATE COMMONSCRIPCODE_IMP SET
			I_ISIN			= (CASE WHEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',2))) <> '' THEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',2))) ELSE I_ISIN END),
			I_REUTERCODE	= (CASE WHEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',3))) <> '' THEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',3))) ELSE I_REUTERCODE END),
			I_BLOOMBERGCODE	= (CASE WHEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',4))) <> '' THEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',4))) ELSE I_BLOOMBERGCODE END),
			I_SEDOLCODE		= (CASE WHEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',5))) <> '' THEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',5))) ELSE I_SEDOLCODE END),
			I_CUSIPCODE		= (CASE WHEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',6))) <> '' THEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',6))) ELSE I_CUSIPCODE END),
			I_SCRIP_NAME 	= (CASE WHEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',7))) <> '' THEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',7))) ELSE I_SCRIP_NAME END),
			I_BSECODE		= (CASE WHEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',8))) <> '' THEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',8))) ELSE I_BSECODE END),
			I_MERRYLCODE	= (CASE WHEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',9))) <> '' THEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',9))) ELSE I_MERRYLCODE END),
			I_MDSCODE		= (CASE WHEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',10))) <> '' THEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',10))) ELSE I_MDSCODE END),
			I_IDBI_SCRIP	= (CASE WHEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',11))) <> '' THEN LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',11))) ELSE I_IDBI_SCRIP END)
		FROM 	CLASSFILEUPD (NOLOCK) 
		WHERE  	SESSION_ID = @SESSION_ID
		AND 	LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',1))) = COMMONSCRIPCODE_IMP.I_SYMBOL


		INSERT INTO COMMONSCRIPCODE_IMP
		SELECT 
			SYMBOL		= LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',1))),
			ISIN		= LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',2))),
			RICBASIC	= LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',3))),
			BLOOMBERG 	= LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',4))),
			SEDOL		= LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',5))),
			CUSIP		= LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',6))),
			SCRIP_NAME 	= LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',7))),
			BSECODE		= LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',8))),
			MERRYLCODE	= LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',9))),
			MDSCODE		= LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',10))),
			IDBI_SCRIP	= LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',11)))
		FROM 	CLASSFILEUPD (NOLOCK) 
		WHERE  	SESSION_ID = @SESSION_ID
		AND 	LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',1))) NOT IN (SELECT I_SYMBOL FROM COMMONSCRIPCODE_IMP (NOLOCK))
		AND 	LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',1))) <> 'SYMBOL'
		AND 	LTRIM(RTRIM(MSAJAG.DBO.PIECE(FILE_DATA,',',3))) <> 'RICBASIC'
	END

	DELETE COMMONSCRIPCODE_IMP WHERE  
		(
			I_REUTERCODE IS NULL 
			AND I_BLOOMBERGCODE IS NULL 
			AND I_SEDOLCODE IS NULL 
			AND I_CUSIPCODE IS NULL
		)  
		OR I_SYMBOL IS NULL OR I_SYMBOL = ''  
   

	INSERT INTO SCRIP_CODES    
	(SYMBOL,ISIN,RICBASIC,BLOOMBERG,SEDOL,CUSIP,SCRIP_NAME,BSECODE,MERRYLCODE,MDSCODE,IDBI_SCRIP)
		SELECT I_SYMBOL,I_ISIN,I_REUTERCODE,I_BLOOMBERGCODE,I_SEDOLCODE,I_CUSIPCODE,I_SCRIP_NAME,I_BSECODE,I_MERRYLCODE,I_MDSCODE,I_IDBI_SCRIP
		FROM COMMONSCRIPCODE_IMP (NOLOCK)  
		WHERE I_SYMBOL NOT IN (SELECT SYMBOL FROM SCRIP_CODES (NOLOCK))  
   

	UPDATE SCRIP_CODES   
	SET   
		ISIN		= (CASE WHEN ISNULL(I_ISIN,'')			= '' THEN ISIN			ELSE ISNULL(I_ISIN,'')			END),
		RICBASIC	= (CASE WHEN ISNULL(I_REUTERCODE,'')	= '' THEN RICBASIC		ELSE ISNULL(I_REUTERCODE,'')	END),   
		BLOOMBERG	= (CASE WHEN ISNULL(I_BLOOMBERGCODE,'') = '' THEN BLOOMBERG		ELSE ISNULL(I_BLOOMBERGCODE,'') END),   
		SEDOL		= (CASE WHEN ISNULL(I_SEDOLCODE,'')		= '' THEN SEDOL			ELSE ISNULL(I_SEDOLCODE,'')		END),   
		CUSIP		= (CASE WHEN ISNULL(I_CUSIPCODE,'')		= '' THEN CUSIP			ELSE ISNULL(I_CUSIPCODE,'')		END),
		SCRIP_NAME	= (CASE WHEN ISNULL(I_SCRIP_NAME,'')	= '' THEN SCRIP_NAME	ELSE ISNULL(I_SCRIP_NAME,'')	END),
		BSECODE		= (CASE WHEN ISNULL(I_BSECODE,'')		= '' THEN BSECODE		ELSE ISNULL(I_BSECODE,'')		END),
		MERRYLCODE	= (CASE WHEN ISNULL(I_MERRYLCODE,'')	= '' THEN MERRYLCODE	ELSE ISNULL(I_MERRYLCODE,'')	END),
		MDSCODE		= (CASE WHEN ISNULL(I_MDSCODE,'')		= '' THEN MDSCODE		ELSE ISNULL(I_MDSCODE,'')		END),
		IDBI_SCRIP	= (CASE WHEN ISNULL(I_IDBI_SCRIP,'')	= '' THEN IDBI_SCRIP	ELSE ISNULL(I_IDBI_SCRIP,'')	END)
	FROM   
		COMMONSCRIPCODE_IMP  (NOLOCK)  
	WHERE   
		SYMBOL = I_SYMBOL  

	SELECT 'DATA UPLOADED SUCCESSFULLY'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_COMPUTE_BSECURFO_MARGIN_PENALTY
-- --------------------------------------------------

CREATE  PROCEDURE [dbo].[PR_COMPUTE_BSECURFO_MARGIN_PENALTY]      
(      
 @MARGIN_DATE VARCHAR(11),      
 @USERID VARCHAR(20)      
)      
AS      
      
DECLARE @SYSTEMDATE DATETIME      
      
SET @SYSTEMDATE = GETDATE()      
DECLARE @SERVICE_TAX NUMERIC(18,4)  
SELECT @SERVICE_TAX = 0  
  
--SELECT @SERVICE_TAX = SERVICE_TAX FROM FOGLOBALS   
--WHERE @MARGIN_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT  
  
--SET @SERVICE_TAX = (CASE WHEN CONVERT(DATETIME,@MARGIN_DATE)   
--BETWEEN CONVERT(DATETIME, 'JUN 22 2017') AND CONVERT(DATETIME, 'JUL  1 2017')  
-- THEN 18 ELSE @SERVICE_TAX END)  
   
   
            
      
CREATE TABLE #FOMARGIN_PENALTY      
(      
 PARTY_CODE VARCHAR(10),      
 REPORTED_MARGIN MONEY,      
 SHORTAGE MONEY,      
 PENALTY_PERC NUMERIC (12,6),      
 PENALTY_AMT MONEY,      
 DAYS_3_COUNT INT,      
 MONTH_5_COUNT INT,                            
 SERVICE_TAX MONEY       
)      
      
INSERT INTO #FOMARGIN_PENALTY      
SELECT PARTY_CODE,ABS(REPORTED_MARGIN),ABS(SHORTAGE),0,0,0,0    ,0   
FROM FOMARGIN_REPORT_STAT (NOLOCK)      
WHERE MARGIN_DATE = @MARGIN_DATE      
AND SHORTAGE < 0    
  
  
      
IF (SELECT COUNT(1) FROM #FOMARGIN_PENALTY) = 0      
BEGIN      
 RETURN      
END      
      
BEGIN TRAN      
       
/*IDENTIFYING THE CONSECUTIVE 3 DAYS SHORTAGE PARTY*/      
UPDATE #FOMARGIN_PENALTY SET DAYS_3_COUNT = 1      
 FROM (    
  SELECT PARTY_CODE,NCOUNT=COUNT(MARGIN_DATE) FROM FOMARGIN_PENALTY    
  WHERE     
  MARGIN_DATE IN (    
    SELECT TOP 3 MARGIN_DATE FROM FOMARGIN_PENALTY_POST_STAT     
    WHERE MARGIN_DATE < @MARGIN_DATE ORDER BY MARGIN_DATE DESC    
   )    
  GROUP BY PARTY_CODE HAVING COUNT(MARGIN_DATE) = 3    
 ) M      
 WHERE M.PARTY_CODE = #FOMARGIN_PENALTY.PARTY_CODE      
      
/*IDENTIFYING THE MONTHLY 5 TIMES SHORTAGE PARTY*/      
UPDATE #FOMARGIN_PENALTY SET MONTH_5_COUNT = NCOUNT + 1     
FROM (      
 SELECT PARTY_CODE,NCOUNT = COUNT(1) FROM FOMARGIN_PENALTY (NOLOCK)       
 WHERE MONTH(MARGIN_DATE) = MONTH(CONVERT(DATETIME,@MARGIN_DATE))  
 AND YEAR(MARGIN_DATE) = YEAR(CONVERT(DATETIME,@MARGIN_DATE))      
 AND MARGIN_DATE < @MARGIN_DATE    
 GROUP BY PARTY_CODE      
 ) M      
WHERE M.PARTY_CODE = #FOMARGIN_PENALTY.PARTY_CODE      
      
/*APPLYING THE PENALTY PERCENTAGE*/      
UPDATE #FOMARGIN_PENALTY       
 SET PENALTY_PERC = DAYS_3_PERC      
FROM       
 FOMARGIN_PENALTY_MST (NOLOCK)      
WHERE      
 @MARGIN_DATE BETWEEN FROM_DATE AND TO_DATE      
 AND SHORTAGE BETWEEN SHORTAGE_VALUE_FROM AND SHORTAGE_VALUE_TO      
 AND DAYS_3_COUNT <> 0      
      
UPDATE #FOMARGIN_PENALTY       
 SET PENALTY_PERC = MONTH_5_PERC      
FROM       
 FOMARGIN_PENALTY_MST (NOLOCK)      
WHERE      
 @MARGIN_DATE BETWEEN FROM_DATE AND TO_DATE      
 AND SHORTAGE BETWEEN SHORTAGE_VALUE_FROM AND SHORTAGE_VALUE_TO      
 AND DAYS_3_COUNT = 0      
 AND MONTH_5_COUNT > 5       
      
UPDATE #FOMARGIN_PENALTY     
 SET PENALTY_PERC = 1    
WHERE SHORTAGE > ((REPORTED_MARGIN + SHORTAGE)*10/100)    
 AND PENALTY_PERC = 0    
    
UPDATE #FOMARGIN_PENALTY     
 SET PENALTY_PERC = SHORTAGE_PERC    
FROM     
 FOMARGIN_PENALTY_MST (NOLOCK)    
WHERE    
 @MARGIN_DATE BETWEEN FROM_DATE AND TO_DATE    
 AND SHORTAGE BETWEEN SHORTAGE_VALUE_FROM AND SHORTAGE_VALUE_TO    
 AND PENALTY_PERC = 0    
       
/*COMPUTING THE PENALTY*/      
UPDATE #FOMARGIN_PENALTY        
SET PENALTY_AMT = SHORTAGE * PENALTY_PERC / 100      
UPDATE #FOMARGIN_PENALTY                                      
SET PENALTY_AMT = CEILING(CAST(PENALTY_AMT AS DECIMAL(10,3)) * 100.00) / 100.00              
  
 UPDATE #FOMARGIN_PENALTY            
SET SERVICE_TAX = ROUND(PENALTY_AMT * F.SERVICE_TAX / 100,4)  
FROM   
 CLIENT2 C2 (NOLOCK),  
 FOGLOBALS F (NOLOCK)  
WHERE  
 C2.PARTY_CODE = #FOMARGIN_PENALTY.PARTY_CODE  
 AND SERVICE_CHRG = 0  
 AND LEFT(GETDATE(),11) BETWEEN YEAR_START_DT AND YEAR_END_DT  
   
      
/*POLULATING THE FINAL VALUE TO THE TABLE*/      
DELETE FOMARGIN_PENALTY WHERE MARGIN_DATE = @MARGIN_DATE      
      
INSERT INTO FOMARGIN_PENALTY    
SELECT       
 @MARGIN_DATE,PARTY_CODE,SHORTAGE,      
 PENALTY_PERC,PENALTY_AMT,DAYS_3_COUNT,      
 MONTH_5_COUNT,0,      
 UPDATED_BY = @USERID,      
 UPDATED_ON = @SYSTEMDATE,                           
 SERVICE_TAX                    
FROM #FOMARGIN_PENALTY      
      
IF (SELECT COUNT(1) FROM FOMARGIN_PENALTY_POST_STAT (NOLOCK)      
WHERE MARGIN_DATE = @MARGIN_DATE) = 0      
BEGIN      
 INSERT INTO FOMARGIN_PENALTY_POST_STAT VALUES( @MARGIN_DATE,0,'','')      
END      
      
DROP TABLE #FOMARGIN_PENALTY      
      
COMMIT TRAN      
      
/*--------------------------- END OF PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_COMPUTE_MARGIN_PENALTY
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[PR_COMPUTE_MARGIN_PENALTY]  
(  
	@MARGIN_DATE VARCHAR(11),  
	@USERID VARCHAR(20)  
)  
AS  
  
DECLARE @SYSTEMDATE DATETIME  
  
SET @SYSTEMDATE = GETDATE()  
  
CREATE TABLE #FOMARGIN_PENALTY  
(  
	PARTY_CODE VARCHAR(10),  
	REPORTED_MARGIN MONEY,  
	SHORTAGE MONEY,  
	PENALTY_PERC NUMERIC (12,6),  
	PENALTY_AMT MONEY,  
	DAYS_3_COUNT INT,  
	MONTH_5_COUNT INT  
)  
  
INSERT INTO #FOMARGIN_PENALTY  
SELECT PARTY_CODE,ABS(REPORTED_MARGIN),ABS(SHORTAGE),0,0,0,0  
FROM FOMARGIN_REPORT_STAT (NOLOCK)  
WHERE MARGIN_DATE = @MARGIN_DATE  
AND SHORTAGE < 0  
  
IF (SELECT COUNT(1) FROM #FOMARGIN_PENALTY) = 0  
BEGIN  
	RETURN  
END  
  
BEGIN TRAN  
   
/*IDENTIFYING THE CONSECUTIVE 3 DAYS SHORTAGE PARTY*/  
UPDATE #FOMARGIN_PENALTY SET DAYS_3_COUNT = 1  
 FROM (
		SELECT PARTY_CODE,NCOUNT=COUNT(MARGIN_DATE) FROM FOMARGIN_PENALTY (NOLOCK)  
		WHERE 
		MARGIN_DATE IN (
						SELECT TOP 3 LEFT(TRADE_DATE,11)
						FROM (
							SELECT DISTINCT TRADE_DATE FROM FOCLOSING (NOLOCK)    
							WHERE TRADE_DATE >  DATEADD(M ,-1, CONVERT(DATETIME,@MARGIN_DATE)) 
							AND TRADE_DATE < @MARGIN_DATE 
						) T
						ORDER BY TRADE_DATE DESC  
			)
		GROUP BY PARTY_CODE HAVING COUNT(MARGIN_DATE) = 3
	) M  
WHERE M.PARTY_CODE = #FOMARGIN_PENALTY.PARTY_CODE  
  
/*IDENTIFYING THE MONTHLY 5 TIMES SHORTAGE PARTY*/  
UPDATE #FOMARGIN_PENALTY SET MONTH_5_COUNT = NCOUNT + 1 
FROM (  
		SELECT PARTY_CODE,NCOUNT = COUNT(1) FROM FOMARGIN_PENALTY (NOLOCK)   
		WHERE MONTH(MARGIN_DATE) = MONTH(CONVERT(DATETIME,@MARGIN_DATE)) 
		AND  YEAR(MARGIN_DATE) = YEAR(CONVERT(DATETIME,@MARGIN_DATE))  
		AND MARGIN_DATE < @MARGIN_DATE
		GROUP BY PARTY_CODE  
 ) M  
WHERE M.PARTY_CODE = #FOMARGIN_PENALTY.PARTY_CODE  
  
/*APPLYING THE PENALTY PERCENTAGE*/  
UPDATE #FOMARGIN_PENALTY   
	SET PENALTY_PERC = DAYS_3_PERC  
FROM   
	FOMARGIN_PENALTY_MST (NOLOCK)  
WHERE  
	@MARGIN_DATE BETWEEN FROM_DATE AND TO_DATE  
	AND SHORTAGE BETWEEN SHORTAGE_VALUE_FROM AND SHORTAGE_VALUE_TO  
	AND DAYS_3_COUNT <> 0  
  
UPDATE #FOMARGIN_PENALTY   
	SET PENALTY_PERC = MONTH_5_PERC  
FROM   
	FOMARGIN_PENALTY_MST (NOLOCK)  
WHERE  
	@MARGIN_DATE BETWEEN FROM_DATE AND TO_DATE  
	AND SHORTAGE BETWEEN SHORTAGE_VALUE_FROM AND SHORTAGE_VALUE_TO  
	AND DAYS_3_COUNT = 0  
	AND MONTH_5_COUNT > 5   

UPDATE #FOMARGIN_PENALTY 
	SET PENALTY_PERC = 1
WHERE SHORTAGE > ((REPORTED_MARGIN + SHORTAGE)*10/100)
	AND PENALTY_PERC = 0

UPDATE #FOMARGIN_PENALTY 
	SET PENALTY_PERC = SHORTAGE_PERC
FROM 
	FOMARGIN_PENALTY_MST (NOLOCK)
WHERE
	@MARGIN_DATE BETWEEN FROM_DATE AND TO_DATE
	AND SHORTAGE BETWEEN SHORTAGE_VALUE_FROM AND SHORTAGE_VALUE_TO
	AND PENALTY_PERC = 0
   
/*COMPUTING THE PENALTY*/  
UPDATE #FOMARGIN_PENALTY    
SET PENALTY_AMT = ROUND(SHORTAGE * PENALTY_PERC / 100,2)
  
/*POLULATING THE FINAL VALUE TO THE TABLE*/  
DELETE FOMARGIN_PENALTY WHERE MARGIN_DATE = @MARGIN_DATE  
  
INSERT INTO FOMARGIN_PENALTY  
SELECT   
	@MARGIN_DATE,PARTY_CODE,SHORTAGE,  
	PENALTY_PERC,PENALTY_AMT,DAYS_3_COUNT,  
	MONTH_5_COUNT,0,  
	UPDATED_BY = @USERID,  
	UPDATED_ON = @SYSTEMDATE  
FROM #FOMARGIN_PENALTY  
  
IF (SELECT COUNT(1) FROM FOMARGIN_PENALTY_POST_STAT (NOLOCK)  
WHERE MARGIN_DATE = @MARGIN_DATE) = 0  
BEGIN  
	INSERT INTO FOMARGIN_PENALTY_POST_STAT VALUES( @MARGIN_DATE,0,'','')  
END  
  
DROP TABLE #FOMARGIN_PENALTY  
  
COMMIT TRAN  
  
/*--------------------------- END OF PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_COLLATERAL_DETAILS_DAS_GET
-- --------------------------------------------------


CREATE PROC [dbo].[PR_FO_COLLATERAL_DETAILS_DAS_GET]
	(
 	@SDATE VARCHAR(11),
	@PARTYCODE VARCHAR(15),
	@TOCODE VARCHAR(15) = '',
	@DISPLAY VARCHAR(1) = ''
	)

	AS
	IF @TOCODE = ''
		BEGIN
			SET @TOCODE = @PARTYCODE
		END
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	IF @DISPLAY <> ''
		BEGIN
			SELECT 
				PARTY_CODE=C.PARTY_CODE,
				EXCHANGE = 'MFO',
				SEGMENT = 'FUTURES',
				QTY=SUM(QTY),
				FINALAMOUNT=SUM(FINALAMOUNT)
			FROM
				MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK),
				CLIENT2_VIEW (NOLOCK)
			WHERE
				CL_CODE = C.PARTY_CODE
				AND C.EXCHANGE = 'MFO'
				AND C.SEGMENT = 'FUTURES'
				AND EFFDATE BETWEEN @SDATE AND @SDATE
				AND C.PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			GROUP BY 
				C.PARTY_CODE
			ORDER BY
				C.PARTY_CODE
		END
	ELSE
		BEGIN
			SELECT 
				PARTY_CODE=C.PARTY_CODE,
				EXCHANGE = 'MFO',
				SEGMENT = 'FUTURES',
				SCRIP_CD =(
				CASE 
					WHEN COLL_TYPE IN ('FD','BG') 
						THEN COLL_TYPE +'-'+ FD_BG_NO
					WHEN COLL_TYPE = 'SEC'
						THEN SCRIP_CD
					ELSE COLL_TYPE
				END),
				EXPIRYDATE = (
				CASE WHEN COLL_TYPE IN ('FD','BG') 
					THEN CONVERT(VARCHAR,MATURITY_DATE,11)
					ELSE ''
				END),	
				QTY=SUM(QTY),
				CL_RATE,
				VAKUATIONPER = MAX(100 - HAIRCUT),
				FINALAMOUNT=SUM(FINALAMOUNT),
				CASH_NCASH,
				SERIES = ISNULL(SERIES,'')
			INTO
				#COLLDETAILS
			FROM
				MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK),
				CLIENT2_VIEW (NOLOCK)
			WHERE
				CL_CODE = C.PARTY_CODE
				AND C.EXCHANGE = 'MFO'
				AND C.SEGMENT = 'FUTURES'
				AND EFFDATE BETWEEN @SDATE AND @SDATE
				AND C.PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			GROUP BY 
				C.PARTY_CODE,SCRIP_CD,CL_RATE,CASH_NCASH,ISNULL(SERIES,''),
				(
				CASE WHEN COLL_TYPE IN ('FD','BG') 
					THEN CONVERT(VARCHAR,MATURITY_DATE,11)
					ELSE ''
				END),
				(
				CASE 
					WHEN COLL_TYPE IN ('FD','BG') 
						THEN COLL_TYPE +'-'+ FD_BG_NO
					WHEN COLL_TYPE = 'SEC'
						THEN SCRIP_CD
					ELSE COLL_TYPE
				END)				
			ORDER BY
				CASH_NCASH,
				PARTY_CODE,
				SCRIP_CD


			UPDATE 
				#COLLDETAILS
				SET SCRIP_CD = S2.SCRIP_CD
			FROM 
				BSEDB.DBO.SCRIP2 S2,
				BSEDB.DBO.SCRIP2 S1
			WHERE 
				S1.CO_CODE = S2.CO_CODE
				AND S1.SERIES = S2.SERIES
				AND #COLLDETAILS.SCRIP_CD = S2.BSECODE
				AND #COLLDETAILS.SERIES = 'BSE'
				

			SELECT *
			FROM #COLLDETAILS C
			ORDER BY PARTY_CODE,CASH_NCASH, SCRIP_CD
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_DASDATAGEN
-- --------------------------------------------------
--EXEC PR_FO_DASDATAGEN 'MAR  9 2007','00','ZZ','BACK-END'  
  
CREATE PROCEDURE [dbo].[PR_FO_DASDATAGEN]  
(  
@FDATE DATETIME,  
@FPARTY VARCHAR(50),  
@TPARTY VARCHAR(50),  
@STATUSNAME VARCHAR(20)  
)  

AS  

DECLARE 
@STARTTIME VARCHAR(20), 
@ENDTIME VARCHAR(20) 

SELECT @STARTTIME = CONVERT(VARCHAR,GETDATE(),109)

EXEC PR_FO_TRADE_DETAILS_DAS_UP @FDATE,@FPARTY,@TPARTY,@STATUSNAME   
  
EXEC PR_FO_OPEN_POSITION_DAS_UP @FDATE,@FPARTY,@TPARTY,@STATUSNAME   
  
EXEC PR_LEDGER_DETAILS_DAS_GET @FDATE,@FPARTY,@TPARTY,@STATUSNAME   

SELECT @ENDTIME = CONVERT(VARCHAR,GETDATE(),109)

SELECT @STARTTIME, @ENDTIME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_LEDGER_DETAILS_DAS_UP
-- --------------------------------------------------

CREATE  PROCEDURE [dbo].[PR_FO_LEDGER_DETAILS_DAS_UP]                 
(                
    @FDATE VARCHAR(11),                 
    @PARTYCODE VARCHAR(10),
	@TOCODE VARCHAR(10) = '',
	@DISPLAY VARCHAR(1) = ''
)
       
        
AS                

IF @TOCODE = ''
	BEGIN
		SET @TOCODE = @PARTYCODE
	END
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF @DISPLAY <> ''
	BEGIN
		SELECT
			LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,
			LEDDD_CLOSING_BAL = SUM(LEDDD_CLOSING_BAL),
			MARGINAMT = SUM((LEDDD_CASH_MARGIN + LEDDD_NONCASH_COLL_HC) - (LEDDD_INIT_EXPO_MARGIN + LEDDD_ADD_MARGIN))
		FROM
			LEDGER_DETAILS_DAS (NOLOCK)
		WHERE
			LEDDD_SAUDA_DATE LIKE @FDATE +'%'
			AND LEDDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
		GROUP BY
			LEDDD_PARTY_CODE
	END
ELSE
	BEGIN
		SELECT
			LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,
			LEDDD_SAUDA_DATE = @FDATE,
			LEDDD_OPENING_BAL = SUM(LEDDD_OPENING_BAL),
			LEDDD_CHQ_REC = SUM(LEDDD_CHQ_REC),
			LEDDD_CHQ_PAY = SUM(LEDDD_CHQ_PAY),
			LEDDD_JV_ENTRY = SUM(LEDDD_JV_ENTRY),
			LEDDD_CLOSING_BAL = SUM(LEDDD_CLOSING_BAL),
			LEDDD_CASH_MARGIN = SUM(LEDDD_CASH_MARGIN),
			LEDDD_OPENING_INIT_MARGIN = SUM(LEDDD_OPENING_INIT_MARGIN),
			LEDDD_MRG_REC = SUM(LEDDD_MRG_REC),
			LEDDD_MRG_REPAY = SUM(LEDDD_MRG_REPAY),
			LEDDD_MRG_JV_ENTRY = SUM(LEDDD_MRG_JV_ENTRY),
			LEDDD_CLOSING_INIT_MARGIN = SUM(LEDDD_CLOSING_INIT_MARGIN),
			LEDDD_NONCASH_COLL_HC = SUM(LEDDD_NONCASH_COLL_HC),
			LEDDD_INIT_EXPO_MARGIN = SUM(LEDDD_INIT_EXPO_MARGIN),
			LEDDD_CREATED_BY = 'BACK-END',
			LEDDD_CREATED_DT = GETDATE(),
			LEDDD_ADD_MARGIN = SUM(LEDDD_ADD_MARGIN),
			LEDDD_FT_D = SUM(LEDDD_FT_D),
			LEDDD_FT_C = SUM(LEDDD_FT_C),
			LEDDD_MRG_FT = SUM(LEDDD_MRG_FT),
			LEDDD_RUNNINGBAL = SUM(LEDDD_RUNNINGBAL),
			LEDDD_CASH_COLL_HC = SUM(LEDDD_CASH_COLL_HC)
		FROM
			LEDGER_DETAILS_DAS (NOLOCK)
		WHERE
			LEDDD_SAUDA_DATE BETWEEN @FDATE AND @FDATE + ' 23:59:59'
			AND LEDDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
		GROUP BY
			LEDDD_PARTY_CODE
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_OPEN_POSITION_DAS_GET
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[PR_FO_OPEN_POSITION_DAS_GET]
(            
    @SDATE VARCHAR(11),             
    @PARTYCODE VARCHAR(10),
	@TOCODE VARCHAR(10) = '',
	@DISPLAY VARCHAR(1) = '',
	@BLOCK VARCHAR(2) = ''
)            
            
AS            

IF @TOCODE = ''
	BEGIN
		SET @TOCODE = @PARTYCODE
	END
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
  
IF @DISPLAY <> ''
	BEGIN
		SELECT             
			FOPDD_PARTY_CODE,
			FOPDD_CLOSING_PQTY = SUM(FOPDD_CLOSING_PQTY),
			FOPDD_CLOSING_SQTY = SUM(FOPDD_CLOSING_SQTY),
			FOPDD_INST_TYPE
		FROM             
			FO_POS_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOPDD_SAUDA_DATE LIKE @SDATE +'%'             
			AND FOPDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			--AND (CHARINDEX(LEFT(FOPDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
			AND (@BLOCK=CASE WHEN CHARINDEX(LEFT(FOPDD_INST_TYPE,3),'FUT')>0 THEN '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+4) ELSE '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+3) END OR @BLOCK='')
		GROUP BY
			FOPDD_PARTY_CODE,
			FOPDD_INST_TYPE
		ORDER BY             
			FOPDD_PARTY_CODE,
			FOPDD_INST_TYPE
	END
ELSE
	BEGIN
		PRINT @BLOCK
		SELECT             
			FOPDD_PARTY_CODE,             
			FOPDD_INST_TYPE,             
			FOPDD_SYMBOL,             
			FOPDD_STRIKE_PRICE,             
			FOPDD_OPTION_TYPE,     
			FOPDD_INTFLAG=ISNULL(FOPDD_INTFLAG,'IN'),            
			FOPDD_EXPIRYDATE = LEFT(FOPDD_EXPIRYDATE,11),             
			FOPDD_SEC_NAME,             
			FOPDD_OPENING_PQTY = SUM(FOPDD_OPENING_PQTY),   
			FOPDD_OPENING_SQTY = SUM(FOPDD_OPENING_SQTY),   
			FOPDD_TODAY_PQTY = SUM(FOPDD_TODAY_PQTY),   
			FOPDD_TODAY_SQTY = SUM(FOPDD_TODAY_SQTY),   
			FOPDD_EXERCISEDQTY = SUM(FOPDD_EXERCISEDQTY) ,   
			FOPDD_ASSIGNEDQTY = SUM(FOPDD_ASSIGNEDQTY),   
			FOPDD_INS_PQTY = SUM(FOPDD_INS_PQTY),   
			FOPDD_INS_SQTY = SUM(FOPDD_INS_SQTY),   
			FOPDD_CLOSING_PQTY = SUM(FOPDD_CLOSING_PQTY),   
			FOPDD_CLOSING_SQTY = SUM(FOPDD_CLOSING_SQTY),   
			FOPDD_EXPQTY = SUM(FOPDD_EXPQTY),   
			FOPDD_AUTOCORPQTY = SUM(FOPDD_AUTOCORPQTY),   
			FOPDD_LONGVALUE = SUM(FOPDD_LONGVALUE),   
			FOPDD_SHORTVALUE = SUM(FOPDD_SHORTVALUE),   
			FOPDD_CLOSINGPRICE= MAX(FOPDD_CLOSINGPRICE) ,           
			FOPDD_STLMNTPRICE=MAX(FOPDD_STLMNTPRICE)  ,            
			FOPDD_FLAG         ,          
			FOPDD_SAUDA_DATE   ,     FOPDD_CREATED_BY   ,          
			FOPDD_CREATED_DT = LEFT(FOPDD_CREATED_DT,11)             
		FROM             
			FO_POS_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOPDD_SAUDA_DATE LIKE @SDATE +'%'             
			AND FOPDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			--AND (CHARINDEX(LEFT(FOPDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
			AND (@BLOCK=CASE WHEN CHARINDEX(LEFT(FOPDD_INST_TYPE,3),'FUT')>0 THEN '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+4) ELSE '0'+CONVERT(VARCHAR(2),CONVERT(INT,LEFT(FOPDD_FLAG,2))+3) END OR @BLOCK='')
		GROUP BY
			FOPDD_PARTY_CODE,             
			FOPDD_INST_TYPE,             
			FOPDD_SYMBOL,             
			FOPDD_STRIKE_PRICE,             
			FOPDD_OPTION_TYPE,     
			ISNULL(FOPDD_INTFLAG,'IN'),            
			LEFT(FOPDD_EXPIRYDATE,11),             
			FOPDD_SEC_NAME,             
			FOPDD_FLAG         ,          
			FOPDD_SAUDA_DATE   ,     
			FOPDD_CREATED_BY   ,          
			LEFT(FOPDD_CREATED_DT,11)
		ORDER BY             
			FOPDD_PARTY_CODE,             
			FOPDD_FLAG,               
			FOPDD_INST_TYPE,             
			FOPDD_SYMBOL,             
			FOPDD_STRIKE_PRICE,             
			FOPDD_OPTION_TYPE ,           
			FOPDD_EXPIRYDATE   
	END
	SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_OPEN_POSITION_DAS_UP
-- --------------------------------------------------

--EXEC [PR_FO_OPEN_POSITION_DAS_UP] 'JAN  6 2009','0','ZZZZZZ',''
  

CREATE  PROCEDURE [dbo].[PR_FO_OPEN_POSITION_DAS_UP]                             
(                              
    @SDATE VARCHAR(11),                               
    @FPARTY VARCHAR(10),                               
    @TPARTY VARCHAR(10),                               
    @UNAME VARCHAR(10)                               
)                              
                              
AS                              
                              
/*=========================================================================================================                              
PROCEDURE NAME: PR_FO_TRADE_DETAILS_DAS_UP                              
PROCEDURE DESC: PROCEDURE TO POPULATE NSEFO TRADE DETAILS TO BE DISPLAYED IN DAS REPORT.                              
  OPEN POS SP'S ARE                          
  01--SP_HELPTEXT FODAILYOPENPOSITION                          
  02--SP_HELPTEXT FODAILYCFPOSITION                          
  03--SP_HELPTEXT FODAILYOPENPOSITION                          
  04--SP_HELPTEXT FODAILYCFPOSITION                          
  
/*  
EXEC DKM_PR_FO_OPEN_POSITION_DAS_UP_INI 'MAR 28 2007','1851732','1851732',''  
PR_FO_OPEN_POSITION_DAS_UP 'JUN 13 2006','0','ZZZZZZZZZZ',''      
*/  
=========================================================================================================*/                              
                              
SET NOCOUNT ON                              
                              
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                              
                              
    DELETE                               
    FROM                               
       FO_POS_DETAILS_DAS                               
    WHERE                               
        FOPDD_SAUDA_DATE LIKE @SDATE + '%'                               
        AND FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY                                 
                              
                              
/*=========================================================================================================                              
    01 - FODAILYOPENPOSITION - FUT                          
=========================================================================================================*/                              
                                 
INSERT
INTO
FO_POS_DETAILS_DAS
SELECT                               
 FOPDD_PARTY_CODE = PARTY_CODE,   
 FOPDD_INST_TYPE  = INST_TYPE,   
 FOPDD_SYMBOL  = SYMBOL,   
 FOPDD_STRIKE_PRICE = STRIKE_PRICE,   
 FOPDD_OPTION_TYPE = OPTION_TYPE,   
 FOPDD_INTFLAG  = '',                            
 FOPDD_EXPIRYDATE = LEFT(EXPIRYDATE,11),   
 FOPDD_SEC_NAME  = LTRIM(RTRIM(SYMBOL)) + LTRIM(RTRIM(INST_TYPE)) + LEFT(EXPIRYDATE,11) + (CASE WHEN MAX(AUCTIONPART) = 'CA' THEN ' *' ELSE '' END),                          
 FOPDD_OPENING_PQTY = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'   
     THEN PQTY-SQTY ELSE 0 END)) > 0 THEN   
     (SUM(CASE WHEN TRADETYPE = 'BF' THEN   
     PQTY-SQTY ELSE 0 END)) ELSE 0 END,  
 FOPDD_OPENING_SQTY  = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF' THEN   
     PQTY-SQTY ELSE 0 END)) < 0 THEN   
     ABS(SUM(CASE WHEN TRADETYPE = 'BF' THEN   
     PQTY-SQTY ELSE 0 END)) ELSE 0 END,  
 FOPDD_TODAY_PQTY = (SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)),  
 FOPDD_TODAY_SQTY = (SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)),  
 FOPDD_EXERCISEDQTY = (SUM(CASE WHEN TRADETYPE = 'BT' AND LEFT(INST_TYPE,3)='OPT' AND AUCTIONPART ='EA'  
      THEN SQTY ELSE 0 END)),  
 FOPDD_ASSIGNEDQTY = (SUM(CASE WHEN TRADETYPE = 'BT' AND LEFT(INST_TYPE,3)='OPT' AND AUCTIONPART ='EA'  
      THEN PQTY ELSE 0 END)),  
 FOPDD_INS_PQTY  = (SUM(CASE WHEN TRADETYPE = 'BT' AND CLIENT_TYPE = 'INS' THEN PQTY ELSE 0 END)),  
 FOPDD_INS_PQTY  = (SUM(CASE WHEN TRADETYPE = 'BT' AND CLIENT_TYPE = 'INS' THEN SQTY ELSE 0 END)),  
 FOPDD_CLOSING_PQTY  = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) > 0 THEN  
     (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) ELSE 0 END,   
 FOPDD_CLOSING_SQTY  = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) < 0 THEN  
     ABS((SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END))) ELSE 0 END,   
 FOPDD_EXPQTY  = SUM(CASE WHEN TRADETYPE = 'BT' AND LEFT(INST_TYPE,3)='FUT'   
     AND AUCTIONPART ='EA' THEN ABS(SQTY-PQTY) ELSE 0 END),  
 FOPDD_AUTOCORPQTY = SUM(CASE WHEN TRADETYPE = 'BT' AND AUCTIONPART ='CA'    
     AND LEFT(MATURITYDATE,11) <> @SDATE THEN ABS(SQTY-PQTY) ELSE 0 END),  
 FOPDD_LONGVALUE  = (CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) > 0 THEN  
     (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) ELSE 0 END) * CL_RATE,  
 FOPDD_SHORTVALUE  = (CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) < 0 THEN  
     ABS((SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END))) ELSE 0 END) * CL_RATE,   
/*  
 FOPDD_LONGVALUE  = SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END),  
 FOPDD_SHORTVALUE  = SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END),   
*/  
 FOPDD_CLOSINGPRICE  = CL_RATE,  
 FOPDD_STLMNTPRICE  = CL_RATE,   
/* FOPDD_STLMNTPRICE  = ABS((CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) -   
     SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 THEN   
     ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) -   
     (SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END))) /   
     (SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) -   
     SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)), */  
 FOPDD_FLAG         = '01' ,                          
 FOPDD_SAUDA_DATE   = @SDATE ,                  
 FOPDD_CREATED_BY   = @UNAME,                  
 FOPDD_CREATED_DT   = GETDATE()                             
FROM  
 FOBILLVALAN (NOLOCK)  
WHERE   
 LEFT(SAUDA_DATE,11) = @SDATE   
 AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
 AND LEFT(INST_TYPE,3) = 'FUT'  
 AND (PQTY-SQTY) <> 0  
GROUP BY  
 PARTY_CODE,   
 INST_TYPE,   
 SYMBOL,   
 EXPIRYDATE,  
 STRIKE_PRICE,  
 OPTION_TYPE,  
 CL_RATE  

ORDER BY   
 PARTY_CODE,   
 INST_TYPE,   
 SYMBOL,   
 EXPIRYDATE,  
 STRIKE_PRICE,  
 OPTION_TYPE  


INSERT
INTO
FO_POS_DETAILS_DAS
SELECT                               
 FOPDD_PARTY_CODE = PARTY_CODE,   
 FOPDD_INST_TYPE  = INST_TYPE,   
 FOPDD_SYMBOL  = SYMBOL,   
 FOPDD_STRIKE_PRICE = STRIKE_PRICE,   
 FOPDD_OPTION_TYPE = OPTION_TYPE,   
 FOPDD_INTFLAG  = '',                            
 FOPDD_EXPIRYDATE = LEFT(EXPIRYDATE,11),   
 FOPDD_SEC_NAME  = LTRIM(RTRIM(SYMBOL)) + LTRIM(RTRIM(INST_TYPE)) + LEFT(EXPIRYDATE,11) + (CASE WHEN MAX(AUCTIONPART) ='CA' THEN ' *' ELSE '' END),  
 FOPDD_OPENING_PQTY  = 0,  
 FOPDD_OPENING_SQTY  = 0,  
 FOPDD_TODAY_PQTY = 0,  
 FOPDD_TODAY_SQTY = 0,  
 FOPDD_EXERCISEDQTY = 0,  
 FOPDD_ASSIGNEDQTY = 0,  
 FOPDD_INS_PQTY  = 0,  
 FOPDD_INS_PQTY  = 0,  
 FOPDD_CLOSING_PQTY  = CASE WHEN SUM(PQTY-SQTY) > 0 THEN SUM(PQTY-SQTY) ELSE 0 END,   
 FOPDD_CLOSING_SQTY  = CASE WHEN SUM(PQTY-SQTY) < 0 THEN ABS(SUM(PQTY-SQTY)) ELSE 0 END,   
 FOPDD_EXPQTY  = 0,  
 FOPDD_AUTOCORPQTY = SUM(PQTY-SQTY),  
 FOPDD_LONGVALUE  = 0 ,  
 FOPDD_SHORTVALUE  = 0,
 FOPDD_CLOSINGPRICE  = CL_RATE,  
 FOPDD_STLMNTPRICE  = CL_RATE,   
 FOPDD_FLAG         = '01' ,                          
 FOPDD_SAUDA_DATE   = @SDATE ,                  
 FOPDD_CREATED_BY   = @UNAME,                  
 FOPDD_CREATED_DT   = GETDATE()                             
FROM  
 --FOBILLVALAN_ADJ_VIEW (NOLOCK)  
 FOBILLVALAN (NOLOCK)
WHERE   
 LEFT(SAUDA_DATE,11) = @SDATE
 AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY    
 AND LEFT(INST_TYPE,3) = 'FUT'  
 AND EXCHANGE = ''
GROUP BY  
 PARTY_CODE,   
 INST_TYPE,   
 SYMBOL,   
 EXPIRYDATE,  
 STRIKE_PRICE,  
 OPTION_TYPE,  
 CL_RATE  

ORDER BY   
 PARTY_CODE,   
 INST_TYPE,   
 SYMBOL,   
 EXPIRYDATE,  
 STRIKE_PRICE,  
 OPTION_TYPE  
  
                             
/*=========================================================================================================                              
    03 - FODAILYOPENPOSITION - OPT                           
=========================================================================================================*/                              
                              
INSERT                               
INTO                               
FO_POS_DETAILS_DAS                               
SELECT                               
 FOPDD_PARTY_CODE = PARTY_CODE,   
 FOPDD_INST_TYPE  = INST_TYPE,   
 FOPDD_SYMBOL  = SYMBOL,   
 FOPDD_STRIKE_PRICE = STRIKE_PRICE,   
 FOPDD_OPTION_TYPE = OPTION_TYPE,   
 FLAG   ='',  
 FOPDD_EXPIRYDATE = LEFT(EXPIRYDATE,11),   
 FOPDD_SEC_NAME      = LTRIM(RTRIM(SYMBOL)) + LTRIM(RTRIM(INST_TYPE)) + LEFT(EXPIRYDATE,11) + (CASE WHEN MAX(AUCTIONPART) ='CA' THEN ' *' ELSE '' END),                          
 FOPDD_OPENING_PQTY = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'   
     THEN PQTY-SQTY ELSE 0 END)) > 0 THEN   
     (SUM(CASE WHEN TRADETYPE = 'BF' THEN   
     PQTY-SQTY ELSE 0 END)) ELSE 0 END,  
 FOPDD_OPENING_SQTY  = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF' THEN   
     PQTY-SQTY ELSE 0 END)) < 0 THEN   
     ABS(SUM(CASE WHEN TRADETYPE = 'BF' THEN   
     PQTY-SQTY ELSE 0 END)) ELSE 0 END,  
 FOPDD_TODAY_PQTY = (SUM(CASE WHEN TRADETYPE = 'BT' AND AUCTIONPART = '' THEN PQTY ELSE 0 END)),  
 FOPDD_TODAY_SQTY = (SUM(CASE WHEN TRADETYPE = 'BT' AND AUCTIONPART = '' THEN SQTY ELSE 0 END)),  
 FOPDD_EXERCISEDQTY = (SUM(CASE WHEN TRADETYPE = 'BT' AND LEFT(INST_TYPE,3)='OPT' AND AUCTIONPART ='EA'  
      THEN SQTY ELSE 0 END)),  
 FOPDD_ASSIGNEDQTY = (SUM(CASE WHEN TRADETYPE = 'BT' AND LEFT(INST_TYPE,3)='OPT' AND AUCTIONPART ='EA'  
      THEN PQTY ELSE 0 END)),  
 FOPDD_INS_PQTY  = (SUM(CASE WHEN TRADETYPE = 'BT' AND CLIENT_TYPE = 'INS' THEN PQTY ELSE 0 END)),  
 FOPDD_INS_PQTY  = (SUM(CASE WHEN TRADETYPE = 'BT' AND CLIENT_TYPE = 'INS' THEN SQTY ELSE 0 END)),  
 FOPDD_CLOSING_PQTY  = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) > 0 THEN  
     (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) ELSE 0 END,   
 FOPDD_CLOSING_SQTY  = CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) < 0 THEN  
     ABS((SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END))) ELSE 0 END,   
 FOPDD_EXPQTY  = SUM(CASE WHEN TRADETYPE = 'BT' AND LEFT(INST_TYPE,3)='OPT'   
     AND AUCTIONPART ='CA' THEN ABS(SQTY-PQTY) ELSE 0 END),  
 FOPDD_AUTOCORPQTY = SUM(CASE WHEN TRADETYPE = 'BT' AND AUCTIONPART = 'CA'    
     AND LEFT(MATURITYDATE,11) <> @SDATE THEN ABS(SQTY-PQTY) ELSE 0 END),  
 FOPDD_LONGVALUE  = (CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) > 0 THEN  
     (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) ELSE 0 END) * CL_RATE,   
 FOPDD_SHORTVALUE  = (CASE WHEN (SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END)) < 0 THEN  
     ABS((SUM(CASE WHEN TRADETYPE = 'BF'  
     THEN PQTY-SQTY ELSE 0 END)) + (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN PQTY ELSE 0 END)) - (SUM(CASE WHEN TRADETYPE = 'BT'   
     THEN SQTY ELSE 0 END))) ELSE 0 END) * CL_RATE,   
/*  
 FOPDD_LONGVALUE  = SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END),  
 FOPDD_SHORTVALUE  = SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END),  
*/   
 FOPDD_CLOSINGPRICE  = CL_RATE,  
 FOPDD_STLMNTPRICE  = CL_RATE,   
/* FOPDD_STLMNTPRICE  = ABS((CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) -   
     SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) <> 0 THEN   
     ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) -   
     (SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END))) /   
     (SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) -        SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)), */  
 FOPDD_FLAG         = '03' ,                          
 FOPDD_SAUDA_DATE   = @SDATE ,                  
 FOPDD_CREATED_BY   = @UNAME,                  
 FOPDD_CREATED_DT   = GETDATE()                             
FROM  
 FOBILLVALAN (NOLOCK)  
WHERE   
 LEFT(SAUDA_DATE,11) = @SDATE   
 AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
 AND LEFT(INST_TYPE,3) = 'OPT'  
GROUP BY  
 PARTY_CODE,   
 INST_TYPE,   
 SYMBOL,   
 EXPIRYDATE,  
 STRIKE_PRICE,  
 OPTION_TYPE,   
 CL_RATE   

ORDER BY   
 PARTY_CODE,   
 INST_TYPE,   
 SYMBOL,   
 EXPIRYDATE,  
 STRIKE_PRICE,  
 OPTION_TYPE  
                                  

INSERT                               
INTO                               
FO_POS_DETAILS_DAS                               
SELECT                               
 FOPDD_PARTY_CODE = PARTY_CODE,   
 FOPDD_INST_TYPE  = INST_TYPE,   
 FOPDD_SYMBOL  = SYMBOL,   
 FOPDD_STRIKE_PRICE = STRIKE_PRICE,   
 FOPDD_OPTION_TYPE = OPTION_TYPE,   
 FLAG   = 'XX',  
 FOPDD_EXPIRYDATE = LEFT(EXPIRYDATE,11),   
 FOPDD_SEC_NAME   = LTRIM(RTRIM(SYMBOL)) + LTRIM(RTRIM(INST_TYPE)) + LEFT(EXPIRYDATE,11) + (CASE WHEN MAX(AUCTIONPART) ='CA' THEN ' *' ELSE '' END),                          
 FOPDD_OPENING_PQTY = 0,  
 FOPDD_OPENING_SQTY = 0,  
 FOPDD_TODAY_PQTY = 0,  
 FOPDD_TODAY_SQTY = 0,  
 FOPDD_EXERCISEDQTY = 0,  
 FOPDD_ASSIGNEDQTY = 0,  
 FOPDD_INS_PQTY  = 0,  
 FOPDD_INS_PQTY  = 0,  
 FOPDD_CLOSING_PQTY  = CASE WHEN SUM(PQTY-SQTY) > 0 THEN SUM(PQTY-SQTY) ELSE 0 END,   
 FOPDD_CLOSING_SQTY  = CASE WHEN SUM(PQTY-SQTY) < 0 THEN ABS(SUM(PQTY-SQTY)) ELSE 0 END,   
 FOPDD_EXPQTY  = 0,  
 FOPDD_AUTOCORPQTY = SUM(PQTY-SQTY),  
 FOPDD_LONGVALUE  = 0,   
 FOPDD_SHORTVALUE  = 0,   
 FOPDD_CLOSINGPRICE = 0,  
 FOPDD_STLMNTPRICE  = 0,   
 FOPDD_FLAG         = '03' ,                          
 FOPDD_SAUDA_DATE   = @SDATE ,                  
 FOPDD_CREATED_BY   = @UNAME,                  
 FOPDD_CREATED_DT   = GETDATE()                             
FROM  
 --FOBILLVALAN_ADJ_VIEW (NOLOCK) 
 FOBILLVALAN (NOLOCK) 
WHERE   
 LEFT(SAUDA_DATE,11) = @SDATE   
 AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
 AND LEFT(INST_TYPE,3) = 'OPT'
 AND EXCHANGE = ''  
GROUP BY  
 PARTY_CODE,   
 INST_TYPE,   
 SYMBOL,   
 EXPIRYDATE,  
 STRIKE_PRICE,  
 OPTION_TYPE,   
 CL_RATE   

ORDER BY   
 PARTY_CODE,   
 INST_TYPE,   
 SYMBOL,   
 EXPIRYDATE,  
 STRIKE_PRICE,  
 OPTION_TYPE  

    
UPDATE  FO_POS_DETAILS_DAS  
 SET FOPDD_CLOSINGPRICE = ISNULL(CL_RATE,FOPDD_CLOSINGPRICE)  
FROM  
 CLOSING C  
WHERE  
 LEFT(FO_POS_DETAILS_DAS.FOPDD_SAUDA_DATE,11) = LEFT(C.SYSDATE,11)  
 AND FO_POS_DETAILS_DAS.FOPDD_SYMBOL = C.SCRIP_CD  
    AND FO_POS_DETAILS_DAS.FOPDD_SAUDA_DATE LIKE @SDATE + '%'                               
    AND FO_POS_DETAILS_DAS.FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY 
	AND FOPDD_INTFLAG <> 'XX'                                
  
UPDATE  FO_POS_DETAILS_DAS  
 SET FOPDD_CLOSINGPRICE = ISNULL(CL_RATE,FOPDD_CLOSINGPRICE)  
FROM  
 --FOCLOSINGDETAIL C  
 FOCLOSING C (NOLOCK)
WHERE  
 LEFT(FO_POS_DETAILS_DAS.FOPDD_SAUDA_DATE,11) = LEFT(C.TRADE_DATE,11)  
 AND FO_POS_DETAILS_DAS.FOPDD_INST_TYPE = C.INST_TYPE  
 AND FO_POS_DETAILS_DAS.FOPDD_SYMBOL = C.SYMBOL  
 AND LEFT(FO_POS_DETAILS_DAS.FOPDD_EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)  
 AND FO_POS_DETAILS_DAS.FOPDD_STRIKE_PRICE = C.STRIKE_PRICE  
 AND FO_POS_DETAILS_DAS.FOPDD_OPTION_TYPE = C.OPTION_TYPE  
    AND FO_POS_DETAILS_DAS.FOPDD_SAUDA_DATE LIKE @SDATE + '%'                               
    AND FO_POS_DETAILS_DAS.FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY                                 
 AND FO_POS_DETAILS_DAS.FOPDD_INST_TYPE LIKE '%IDX' 
AND FOPDD_INTFLAG <> 'XX' 

 
UPDATE  FO_POS_DETAILS_DAS  
 SET FOPDD_INTFLAG =  
 (CASE WHEN FOPDD_OPTION_TYPE LIKE 'C%' AND (FOPDD_CLOSING_PQTY - FOPDD_CLOSING_SQTY) > 0 THEN  
  (CASE WHEN FOPDD_STRIKE_PRICE < FOPDD_CLOSINGPRICE THEN  
   'IN'  
  ELSE  
   CASE WHEN FOPDD_STRIKE_PRICE = FOPDD_CLOSINGPRICE THEN  
    'AT'  
   ELSE  
    'OUT'  
   END  
  END)  
 ELSE  
  CASE WHEN FOPDD_OPTION_TYPE LIKE 'C%' AND (FOPDD_CLOSING_PQTY - FOPDD_CLOSING_SQTY) < 0 THEN  
   (CASE WHEN FOPDD_STRIKE_PRICE > FOPDD_CLOSINGPRICE THEN              
     'IN'  
   ELSE  
    CASE WHEN FOPDD_STRIKE_PRICE = FOPDD_CLOSINGPRICE THEN  
  'AT'                                  
    ELSE                                  
  'OUT'                                  
    END                                   
   END)                                   
  ELSE                                  
   CASE WHEN  FOPDD_OPTION_TYPE LIKE 'P%' AND (FOPDD_CLOSING_PQTY - FOPDD_CLOSING_SQTY) > 0 THEN  
    (CASE WHEN FOPDD_STRIKE_PRICE > FOPDD_CLOSINGPRICE THEN               
  'IN'                                  
    ELSE                                  
  CASE WHEN FOPDD_STRIKE_PRICE = FOPDD_CLOSINGPRICE THEN                                  
   'AT'                                  
  ELSE                                  
   'OUT'                                  
  END                                  
    END)                                   
   ELSE                                  
    CASE WHEN FOPDD_OPTION_TYPE LIKE 'P%' AND (FOPDD_CLOSING_PQTY - FOPDD_CLOSING_SQTY) < 0 THEN                                
  (CASE WHEN FOPDD_STRIKE_PRICE < FOPDD_CLOSINGPRICE THEN                           
   'IN'                                  
   ELSE                                  
    CASE WHEN FOPDD_STRIKE_PRICE = FOPDD_CLOSINGPRICE THEN                                  
     'AT' 
    ELSE            
     'OUT'                                  
    END                                   
  END)                                  
    END                                  
   END                                    
  END                                   
 END)   
  
WHERE  
 FOPDD_FLAG         = '03'  
        AND FO_POS_DETAILS_DAS.FOPDD_SAUDA_DATE LIKE @SDATE + '%'                               
        AND FO_POS_DETAILS_DAS.FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY     
 AND LEFT(FO_POS_DETAILS_DAS.FOPDD_INST_TYPE,3) = 'OPT'  

  
UPDATE  FO_POS_DETAILS_DAS  
 SET FOPDD_INTFLAG = 'IN'
WHERE 
	FOPDD_FLAG         = '03'  
	AND FO_POS_DETAILS_DAS.FOPDD_SAUDA_DATE LIKE @SDATE + '%'                               
	AND FO_POS_DETAILS_DAS.FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY  
	AND FOPDD_INTFLAG <> 'XX'  
  
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_TRADE_DETAILS_DAS_GET
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[PR_FO_TRADE_DETAILS_DAS_GET]             
(            
    @SDATE VARCHAR(11),             
    @PARTYCODE VARCHAR(10),
	@TOCODE VARCHAR(10) = '',
	@DISPLAY VARCHAR(1) = '',
	@BLOCK VARCHAR(2) = ''
)            

AS            

IF @TOCODE = ''
	BEGIN
		SET @TOCODE = @PARTYCODE
	END
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF @DISPLAY <> ''
	BEGIN
		SELECT             
			FOTDD_PARTY_CODE,             
			FOTDD_PQTY = SUM(FOTDD_PQTY),
			FOTDD_SQTY = SUM(FOTDD_SQTY),
			FOTDD_PAMT = SUM(FOTDD_PAMT),
			FOTDD_SAMT = SUM(FOTDD_SAMT),
			TRADE_TYPE = RIGHT(FOTDD_FLAG,2),
			FOTDD_INST_TYPE
		FROM             
			FO_TRADE_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOTDD_SAUDA_DATE LIKE @SDATE +'%'             
			AND FOTDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			AND (CHARINDEX(LEFT(FOTDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
		GROUP BY
			FOTDD_PARTY_CODE,
			RIGHT(FOTDD_FLAG,2),   
		    FOTDD_INST_TYPE
		ORDER BY             
			FOTDD_PARTY_CODE ,
			RIGHT(FOTDD_FLAG,2)
	END
ELSE
	BEGIN
		SELECT             
			FOTDD_PARTY_CODE,             
			FOTDD_INST_TYPE,             
			FOTDD_SYMBOL,             
			FOTDD_STRIKE_PRICE,             
			FOTDD_OPTION_TYPE,             
			FOTDD_EXPIRY_DATE = LEFT(FOTDD_EXPIRY_DATE,11),             
			FOTDD_SEC_NAME,             
			FOTDD_TRADEQTY,             
			FOTDD_VALUE,             
			FOTDD_PRICE,             
			FOTDD_PQTY,             
			FOTDD_SQTY,             
			FOTDD_PAMT,             
			FOTDD_SAMT,             
			FOTDD_NETRATE,             
			FOTDD_CFPPRICE,             
			FOTDD_CFSPRICE,             
			FOTDD_SETTPRICE,             
			FOTDD_SAUDA_DATE = LEFT(FOTDD_SAUDA_DATE,11),             
			FOTDD_PNETRATE,             
			FOTDD_SNETRATE,             
			FOTDD_CHARGES,             
			FOTDD_BROKERAGE,             
			FOTDD_SERVICE_TAX,             
			FOTDD_BROKER_NOTE,             
			FOTDD_TURN_TAX,             
			FOTDD_SEBI_TAX,             
			FOTDD_CONTRACTNO,             
			FOTDD_PCOMM,             
			FOTDD_SCOMM,             
			FOTDD_INS_CHRG,             
			FOTDD_FLAG = LEFT(FOTDD_FLAG,2),     
			TRADE_TYPE = RIGHT(FOTDD_FLAG,2),     
			FOTDD_O_C_FLAG,             
			FOTDD_AUCTIONPART,             
			FOTDD_CREATED_BY,             
			FOTDD_CREATED_DT = LEFT(FOTDD_CREATED_DT,11)--,
			--CONTRACTDESCRIPTOR =  FOTDD_INST_TYPE + ' ' + FOTDD_SYMBOL + ' ' + FOTDD_OPTION_TYPE + ' ' + CONVERT(VARCHAR, FOTDD_STRIKE_PRICE) + ' ' + CONVERT(VARCHAR(11), FOTDD_EXPIRY_DATE, 109)
		FROM             
			FO_TRADE_DETAILS_DAS   (NOLOCK)          
		WHERE             
			FOTDD_SAUDA_DATE LIKE @SDATE +'%'             
			AND FOTDD_PARTY_CODE BETWEEN @PARTYCODE AND @TOCODE
			AND (CHARINDEX(LEFT(FOTDD_FLAG, 2), @BLOCK) > 0 OR @BLOCK = '')
		ORDER BY             
			FOTDD_PARTY_CODE,           
			LEFT(FOTDD_FLAG,2),           
			FOTDD_INST_TYPE,           
			FOTDD_SYMBOL,           
			FOTDD_STRIKE_PRICE,           
			FOTDD_OPTION_TYPE,           
			FOTDD_EXPIRY_DATE,     
			TRADE_TYPE
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FO_TRADE_DETAILS_DAS_UP
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[PR_FO_TRADE_DETAILS_DAS_UP]             
(            
    @SDATE VARCHAR(11),             
    @FPARTY VARCHAR(10),             
    @TPARTY VARCHAR(10),             
    @UNAME VARCHAR(10)             
)            
            
AS            
            
/*=========================================================================================================            
PROCEDURE NAME: PR_FO_TRADE_DETAILS_DAS_UP            
PROCEDURE DESC: PROCEDURE TO POPULATE NSEFO TRADE DETAILS TO BE DISPLAYED IN DAS REPORT.            
PROCEDURE SUMMARY:             
    01-TRADES CONFIRMATION - FUTURES            
    02-TRADES CONFIRMATION - OPTIONS            
    03-EXERCISE/ASSIGNMENT OF POSITIONS            
    MARK TO MARKET STATEMENT            
        04-TRADETYPE       = 'BF'            
        05-TRADETYPE       = 'BT'            
        06-CARRY FORWARD RECORDS            
    07-CORPORATE ACTION ADJUSTMENTS OF POSITIONS            
      
EXEC PR_FO_TRADE_DETAILS_DAS_UP             
    @SDATE = 'MAY 27 2005',             
    @FPARTY = '0',             
    @TPARTY = 'ZZZ',             
    @UNAME = 'BACKEND'      
=========================================================================================================*/            
            
DECLARE             
    @MEMBERCODE AS VARCHAR(12)              
            
SET NOCOUNT ON            
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED            
            
    DELETE             
    FROM             
        FO_TRADE_DETAILS_DAS             
    WHERE             
        FOTDD_SAUDA_DATE LIKE @SDATE + '%'             
        AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY               
            
            
/*=========================================================================================================            
    01-TRADES CONFIRMATION - FUTURES            
=========================================================================================================*/            
            
SELECT             
    PARTY_CODE,             
    INST_TYPE,             
    SYMBOL,             
    EXPDATE,             
    PQTY,             
    SQTY,             
    PAMT,             
    SAMT,             
    PNETRATE,             
    SNETRATE,             
    CHARGES,             
    BROKERAGE,             
    SERVICE_TAX,             
    BROKER_NOTE,             
    TURN_TAX,             
    SEBI_TAX,             
    CONTRACTNO,             
    PCOMM,             
    SCOMM,             
    INS_CHRG             
INTO             
    #FODAILYCONFIRM             
FROM             
    (             
    SELECT             
        S.PARTY_CODE,             
        INST_TYPE,             
        SYMBOL,             
        EXPDATE = LEFT(EXPIRYDATE, 11),             
        PQTY,             
        SQTY,             
        PAMT     = CASE WHEN PAMT>0 THEN PAMT-PBROKAMT ELSE 0 END,             
        SAMT     = CASE WHEN SAMT>0 THEN SAMT+SBROKAMT ELSE 0 END,             
        PNETRATE = PRATE,             
        SNETRATE = SRATE,             
        PCOMM    =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0             
                    THEN (PBROKAMT) + SERVICE_TAX             
                    ELSE (PBROKAMT) END             
                ELSE PBROKAMT END               
        )            
        ,             
        SCOMM =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0      
                    THEN (SBROKAMT) + SERVICE_TAX    
                    ELSE (SBROKAMT) END             
                ELSE SBROKAMT END               
        )            
     ,             
        CHARGES = (PBROKAMT+SBROKAMT) +             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG <> 2             
                THEN (SERVICE_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN TURNOVER_TAX = 1             
                THEN (TURN_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
               WHEN SEBI_TURN_TAX = 1             
                THEN (SEBI_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN BROKERNOTE = 1             
                THEN (BROKER_NOTE)             
                ELSE 0 END               
        )            
        ,             
        BROKERAGE =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0             
                    THEN (PBROKAMT+SBROKAMT) + SERVICE_TAX             
                    ELSE (PBROKAMT+SBROKAMT) END             
              ELSE PBROKAMT+SBROKAMT END               
        )            
        ,             
        SERVICE_TAX =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 0             
                THEN (SERVICE_TAX)             
                ELSE 0 END             
        )            
        ,             
        BROKER_NOTE =             
       (               
            CASE             
                WHEN BROKERNOTE = 1             
                THEN (BROKER_NOTE)             
                ELSE 0 END               
        )            
        ,             
        TURN_TAX =             
        (               
            CASE             
                WHEN TURNOVER_TAX = 1             
                THEN ( TURN_TAX)             
                ELSE 0 END               
        )            
        ,             
        SEBI_TAX =             
        (               
            CASE             
                WHEN SEBI_TURN_TAX = 1             
                THEN (SEBI_TAX)             
                ELSE 0 END               
        )            
        ,             
        CONTRACTNO,             
        INS_CHRG =             
        (               
            CASE             
                WHEN INSURANCE_CHRG = 1             
                THEN INS_CHRG             
                ELSE 0 END             
        )             
    FROM             
        FOBILLVALAN S WITH(NOLOCK)            
        ,             
        CLIENT2 C2 WITH(NOLOCK)             
    WHERE             
        SAUDA_DATE LIKE @SDATE + '%'             
        AND C2.PARTY_CODE = S.PARTY_CODE             
        AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY               
        AND LEFT(INST_TYPE, 3) = 'FUT'             
        AND TRADETYPE          = 'BT'             
	AND AUCTIONPART <> 'CA'
	--AND S.AUCTIONPART NOT IN ('EA', 'CA')

   UNION ALL

   SELECT             
        S.PARTY_CODE,             
        INST_TYPE,             
        SYMBOL,             
        EXPDATE = LEFT(EXPIRYDATE, 11),             
        PQTY=CASE WHEN SELL_BUY=1 THEN TRADEQTY ELSE 0 END,             
        SQTY=CASE WHEN SELL_BUY=2 THEN TRADEQTY ELSE 0 END,             
        PAMT     = CASE WHEN SELL_BUY=1 THEN TRADEQTY * PRICE ELSE 0 END,             
        SAMT     = CASE WHEN SELL_BUY=2 THEN TRADEQTY * PRICE ELSE 0 END,             
        PNETRATE = CASE WHEN SELL_BUY=1 THEN NETRATE ELSE 0 END,             
        SNETRATE = CASE WHEN SELL_BUY=2 THEN NETRATE ELSE 0 END,             
        PCOMM    =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0             
                    THEN (CASE WHEN SELL_BUY=1 THEN TRADEQTY * BROKAPPLIED ELSE 0 END) + SERVICE_TAX             
                    ELSE (CASE WHEN SELL_BUY=1 THEN TRADEQTY * BROKAPPLIED ELSE 0 END) END             
                ELSE (CASE WHEN SELL_BUY=1 THEN TRADEQTY * BROKAPPLIED ELSE 0 END) END               
        )            
        ,             
        SCOMM =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0             
                    THEN (CASE WHEN SELL_BUY=2 THEN TRADEQTY * BROKAPPLIED ELSE 0 END) + SERVICE_TAX             
                    ELSE (CASE WHEN SELL_BUY=2 THEN TRADEQTY * BROKAPPLIED ELSE 0 END) END             
                ELSE (CASE WHEN SELL_BUY=2 THEN TRADEQTY * BROKAPPLIED ELSE 0 END) END               
        )            
     	,             
        CHARGES = (TRADEQTY * BROKAPPLIED ) +             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG <> 2             
                THEN (SERVICE_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN TURNOVER_TAX = 1             
                THEN (TURN_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
               WHEN SEBI_TURN_TAX = 1             
                THEN (SEBI_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN BROKERNOTE = 1             
                THEN (BROKER_CHRG)             
                ELSE 0 END               
        )            
        ,             
        BROKERAGE =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0             
                    THEN (TRADEQTY * BROKAPPLIED ) + SERVICE_TAX             
                    ELSE (TRADEQTY * BROKAPPLIED ) END             
              ELSE TRADEQTY * BROKAPPLIED  END               
        )            
        ,             
        SERVICE_TAX =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 0             
                THEN (SERVICE_TAX)             
                ELSE 0 END             
        )            
        ,             
        BROKER_NOTE =             
       (               
            CASE             
                WHEN BROKERNOTE = 1             
                THEN (BROKER_CHRG)             
                ELSE 0 END               
        )            
        ,             
        TURN_TAX =             
        (               
            CASE             
                WHEN TURNOVER_TAX = 1             
                THEN ( TURN_TAX)             
          ELSE 0 END               
        )  
        ,             
        SEBI_TAX =             
        (               
            CASE             
                WHEN SEBI_TURN_TAX = 1             
                THEN (SEBI_TAX)             
                ELSE 0 END               
        )            
        ,             
        CONTRACTNO,             
        INS_CHRG =             
        (               
            CASE             
                WHEN INSURANCE_CHRG = 1             
                THEN INS_CHRG             
                ELSE 0 END             
        )             
    FROM             
        FOSETTLEMENT S WITH(NOLOCK)            
        ,             
        CLIENT2 C2 WITH(NOLOCK)             
    WHERE             
        SAUDA_DATE LIKE @SDATE + '%'             
        AND C2.PARTY_CODE = S.PARTY_CODE             
        AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY               
        AND LEFT(INST_TYPE, 3) = 'FUT'             
	AND AUCTIONPART = 'CA'
	AND O_C_FLAG <> 'C'


    ) S               
              
              
    INSERT             
    INTO             
        FO_TRADE_DETAILS_DAS             
    SELECT             
        FOTDD_PARTY_CODE = PARTY_CODE,             
        FOTDD_INST_TYPE = INST_TYPE,             
        FOTDD_SYMBOL = SYMBOL,             
        FOTDD_STRIKE_PRICE = 0,             
        FOTDD_OPTION_TYPE = '',             
        FOTDD_EXPIRY_DATE = EXPDATE,             
        FOTDD_SEC_NAME = '',             
        FOTDD_TRADEQTY = 0,             
        FOTDD_VALUE = 0,             
        FOTDD_PRICE = 0,             
        FOTDD_PQTY = SUM(PQTY),             
        FOTDD_SQTY = SUM(SQTY),             
        FOTDD_PAMT = SUM(PAMT),             
        FOTDD_SAMT = SUM(SAMT),             
        FOTDD_NETRATE = 0,             
        FOTDD_CFPPRICE = 0,            
        FOTDD_CFSPRICE = 0,             
        FOTDD_SETTPRICE = 0,             
        FOTDD_SAUDA_DATE = @SDATE,             
        FOTDD_PNETRATE =             
        (            
            CASE             
            WHEN SUM(PQTY) > 0             
            THEN SUM(PAMT)/SUM(PQTY)             
            ELSE 0 END             
        ),             
        FOTDD_SNETRATE =             
        (            
            CASE             
            WHEN SUM(SQTY) > 0             
            THEN SUM(SAMT)/SUM(SQTY)             
            ELSE 0 END             
        ),             
        FOTDD_CHARGES = SUM(CHARGES),             
        FOTDD_BROKERAGE = SUM(BROKERAGE),             
        FOTDD_SERVICE_TAX = SUM(SERVICE_TAX),             
        FOTDD_BROKER_NOTE = SUM(BROKER_NOTE),             
        FOTDD_TURN_TAX = SUM(TURN_TAX),             
        FOTDD_SEBI_TAX = SUM(SEBI_TAX),             
        FOTDD_CONTRACTNO = CONTRACTNO,             
       FOTDD_PCOMM = SUM(PCOMM),             
        FOTDD_SCOMM = SUM(SCOMM),             
        FOTDD_INS_CHRG = SUM(INS_CHRG),             
        FOTDD_FLAG = '01',             
        FOTDD_O_C_FLAG = '',             
        FOTDD_AUCTIONPART = '',             
        FOTDD_CREATED_BY = @UNAME,             
        FOTDD_CREATED_DT = GETDATE()             
    FROM             
        #FODAILYCONFIRM WITH(NOLOCK)             
    GROUP BY             
        PARTY_CODE,             
        INST_TYPE,             
        SYMBOL,             
        EXPDATE,             
        CONTRACTNO             
--    ORDER BY PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, SAUDA_DATE               
              
            
/*=========================================================================================================            
    02-TRADES CONFIRMATION - OPTIONS            
=========================================================================================================*/    
            
SELECT             
    PARTY_CODE,             
    INST_TYPE,             
    SYMBOL,             
    EXPDATE,             
    PQTY,             
    SQTY,             
    PAMT,             
    SAMT,             
    PNETRATE,             
    SNETRATE,             
    CHARGES,             
    BROKERAGE,             
    SERVICE_TAX,             
    BROKER_NOTE,             
    TURN_TAX,             
    SEBI_TAX,         STRIKE_PRICE,             
    OPTION_TYPE,             
    CONTRACTNO,             
    PCOMM,             
    SCOMM,             
    INS_CHRG             
INTO             
    #FODAILYCONFIRM_OPT             
FROM             
    (             
    SELECT             
        S.PARTY_CODE,             
        INST_TYPE,             
        SYMBOL,             
        EXPDATE = LEFT(EXPIRYDATE, 11),             
        PQTY,             
        SQTY,             
        PAMT     = PQTY* PRATE,             
        SAMT     = SQTY* SRATE,             
        PNETRATE = PRATE,             
        SNETRATE = SRATE,             
        PCOMM    =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0             
                    THEN (PBROKAMT) + SERVICE_TAX             
                    ELSE (PBROKAMT) END             
                ELSE PBROKAMT END               
        )            
        ,             
        SCOMM =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0             
                    THEN (SBROKAMT) + SERVICE_TAX             
                    ELSE (SBROKAMT) END             
                ELSE SBROKAMT END               
        )            
        ,             
        CHARGES = (PBROKAMT+SBROKAMT) +             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG <> 2             
                THEN (SERVICE_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN TURNOVER_TAX = 1             
                THEN (TURN_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN SEBI_TURN_TAX = 1             
                THEN (SEBI_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN BROKERNOTE = 1             
                THEN (BROKER_NOTE)             
                ELSE 0 END               
        )            
        ,             
        BROKERAGE =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG = 1             
                THEN             
                CASE             
                    WHEN C2.SERTAXMETHOD = 0             
                    THEN (PBROKAMT+SBROKAMT) + SERVICE_TAX             
                    ELSE (PBROKAMT+SBROKAMT) END             
                ELSE PBROKAMT+SBROKAMT END               
        )            
        ,             
        SERVICE_TAX =                 (               
            CASE             
                WHEN C2.SERVICE_CHRG = 0             
                THEN (SERVICE_TAX)             
                ELSE 0 END             
        )            
        ,             
 BROKER_NOTE =           
        (               
            CASE             
                WHEN BROKERNOTE = 1             
                THEN (BROKER_NOTE)             
                ELSE 0 END               
        )            
        ,             
        TURN_TAX =             
        (               
            CASE             
                WHEN TURNOVER_TAX = 1             
                THEN ( TURN_TAX)             
                ELSE 0 END               
        )            
        ,             
        SEBI_TAX =             
        (               
            CASE             
                WHEN SEBI_TURN_TAX = 1             
                THEN (SEBI_TAX)             
                ELSE 0 END               
        )            
        ,             
        INS_CHRG =             
        (               
     CASE             
                WHEN INSURANCE_CHRG = 1             
                THEN INS_CHRG             
                ELSE 0 END             
        )            
        ,             
        CONTRACTNO,             
        STRIKE_PRICE,             
        OPTION_TYPE             
    FROM             
        FOBILLVALAN S WITH(NOLOCK),             
        CLIENT2 C2 WITH(NOLOCK)             
    WHERE             
        SAUDA_DATE LIKE @SDATE + '%'             
        AND C2.PARTY_CODE = S.PARTY_CODE             
        AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY               
        AND LEFT(INST_TYPE, 3) = 'OPT'             
        AND S.AUCTIONPART NOT IN ('EA', 'CA')             
        AND TRADETYPE = 'BT'             
    ) F              
            
    INSERT             
    INTO             
        FO_TRADE_DETAILS_DAS             
    SELECT             
        FOTDD_PARTY_CODE = PARTY_CODE,             
        FOTDD_INST_TYPE = INST_TYPE,             
        FOTDD_SYMBOL = SYMBOL,             
        FOTDD_STRIKE_PRICE = STRIKE_PRICE,             
        FOTDD_OPTION_TYPE = OPTION_TYPE,             
        FOTDD_EXPIRY_DATE = EXPDATE,             
        FOTDD_SEC_NAME = '',             
        FOTDD_TRADEQTY = 0,             
        FOTDD_VALUE = 0,             
        FOTDD_PRICE = 0,         
        FOTDD_PQTY = SUM(PQTY),             
        FOTDD_SQTY = SUM(SQTY),             
        FOTDD_PAMT = SUM(PAMT),             
        FOTDD_SAMT = SUM(SAMT),             
        FOTDD_NETRATE = 0,             
        FOTDD_CFPPRICE = 0,            
        FOTDD_CFSPRICE = 0,             
        FOTDD_SETTPRICE = 0,             
        FOTDD_SAUDA_DATE = @SDATE,             
        FOTDD_PNETRATE =             
        (            
            CASE             
            WHEN SUM(PQTY) > 0             
            THEN SUM(PAMT)/SUM(PQTY)             
            ELSE 0 END             
        ),             
        FOTDD_SNETRATE =             
        (            
            CASE             
            WHEN SUM(SQTY) > 0             
            THEN SUM(SAMT)/SUM(SQTY)             
            ELSE 0 END             
        ),             
        FOTDD_CHARGES = SUM(CHARGES),             
        FOTDD_BROKERAGE = SUM(BROKERAGE),             
        FOTDD_SERVICE_TAX = SUM(SERVICE_TAX),             
        FOTDD_BROKER_NOTE = SUM(BROKER_NOTE),             
        FOTDD_TURN_TAX = SUM(TURN_TAX),             
        FOTDD_SEBI_TAX = SUM(SEBI_TAX),             
        FOTDD_CONTRACTNO = CONTRACTNO,             
        FOTDD_PCOMM = SUM(PCOMM),             
        FOTDD_SCOMM = SUM(SCOMM),             
        FOTDD_INS_CHRG = SUM(INS_CHRG),             
        FOTDD_FLAG = '02',             
        FOTDD_O_C_FLAG = '',             
        FOTDD_AUCTIONPART = '',             
        FOTDD_CREATED_BY = @UNAME,             
        FOTDD_CREATED_DT = GETDATE()             
    FROM  
#FODAILYCONFIRM_OPT    
    GROUP BY         
        PARTY_CODE,             
        INST_TYPE,             
        SYMBOL,             
        EXPDATE,             
        CONTRACTNO,             
        OPTION_TYPE,             
        STRIKE_PRICE             
--    ORDER BY PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, SAUDA_DATE              
            
            
/*=========================================================================================================            
    03-EXERCISE/ASSIGNMENT OF POSITIONS            
=========================================================================================================*/            

    SELECT
        S.PARTY_CODE,             
        INST_TYPE,             
        SYMBOL,             
        EXPDATE = LEFT(EXPIRYDATE, 11),             
        STRIKE_PRICE,             
        OPTION_TYPE,             
        PQTY =             
        (               
            CASE             
                WHEN SELL_BUY = 1             
                THEN SUM(TRADEQTY)             
                ELSE 0 END               
        )            
        ,             
        PAMT =             
        (               
            CASE             
                WHEN SELL_BUY = 1             
                THEN SUM(TRADEQTY*PRICE)             
                ELSE 0 END               
        )            
        ,             
        SQTY =             
        (               
            CASE             
                WHEN SELL_BUY = 2             
                THEN SUM(TRADEQTY)             
                ELSE 0 END               
        )            
        ,             
        SAMT =             
        (               
            CASE     
                WHEN SELL_BUY = 2             
                THEN SUM(TRADEQTY*PRICE)             
                ELSE 0 END               
        )            
        ,             
        NETRATE   = PRICE,             
        SETTPRICE = MAX(CL_RATE),             
		CHARGES   = SUM(BROKAPPLIED*TRADEQTY) +             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG <> 2             
                THEN SUM(SERVICE_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN TURNOVER_TAX = 1             
                THEN SUM(TURN_TAX)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN SEBI_TURN_TAX = 1             
                THEN SUM(SEBI_TAX)             
                ELSE 0 END               
        )             
        +             
        (              
            CASE             
                WHEN BROKERNOTE = 1             
                THEN SUM(BROKER_CHRG)             
                ELSE 0 END               
        )             
        +             
        (               
            CASE             
                WHEN INSURANCE_CHRG = 1             
                THEN SUM(INS_CHRG)             
                ELSE 0 END             
        )            
        ,             
        BROKERAGE   = SUM(BROKAPPLIED*TRADEQTY),
        SERVICE_TAX =             
        (               
            CASE             
                WHEN C2.SERVICE_CHRG <> 2             
                THEN SUM(SERVICE_TAX)             
                ELSE 0 END             
        )            
        ,             
        BROKER_NOTE =             
        (               
            CASE             
                WHEN BROKERNOTE = 1             
                THEN SUM(BROKER_CHRG)             
                ELSE 0 END 
        )            
        ,             
        TURN_TAX =             
        (               
            CASE             
                WHEN TURNOVER_TAX = 1             
                THEN SUM(TURN_TAX)             
                ELSE 0 END               
        )            
        ,             
        SEBI_TAX =             
        (               
            CASE             
                WHEN SEBI_TURN_TAX = 1             
                THEN SUM(SEBI_TAX)             
                ELSE 0 END               
        )            
        ,             
        INS_CHRG =             
        (               
            CASE             
                WHEN INSURANCE_CHRG = 1             
                THEN SUM(INS_CHRG)             
                ELSE 0 END             
        )            
        ,             
        PRICE,
		TRADE_NO,
		ORDER_NO,
		SERVICE_CHRG=C2.SERVICE_CHRG,
		SELL_BUY,
		SAUDA_DATE = LEFT(SAUDA_DATE,11)
    INTO
		#EXERCISE
	FROM
        FOSETTLEMENT S WITH(NOLOCK),             
        CLIENT2 C2 WITH(NOLOCK)             
    WHERE             
        SAUDA_DATE LIKE @SDATE + '%'             
        AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY               
        AND S.PARTY_CODE       = C2.PARTY_CODE             
        AND LEFT(INST_TYPE, 3) = 'OPT'             
        AND AUCTIONPART        = 'EA'             
    GROUP BY             
        S.PARTY_CODE,             
        S.INST_TYPE,             
        S.SYMBOL,             
        S.EXPIRYDATE,             
        S.STRIKE_PRICE,             
        S.OPTION_TYPE,             
        S.SELL_BUY,             
        PRICE,             
        C2.SERVICE_CHRG,
        TURNOVER_TAX,             
        SEBI_TURN_TAX,             
        INSURANCE_CHRG,             
        BROKERNOTE,
		TRADE_NO,
		ORDER_NO,
		LEFT(SAUDA_DATE,11)

	UPDATE 
		#EXERCISE
	SET 
		CHARGES		= CHARGES
					+ (CASE WHEN SELL_BUY = 1 THEN CD_TOT_BUYBROK ELSE CD_TOT_SELLBROK END)
					+ (CASE WHEN SERVICE_CHRG = 0 THEN 
							CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END
							ELSE 0 END),
		BROKERAGE   = BROKERAGE
					+ (CASE WHEN SELL_BUY = 1 THEN CD_TOT_BUYBROK ELSE CD_TOT_SELLBROK END)
					+ (CASE WHEN SERVICE_CHRG = 1 THEN 
							CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END
							ELSE 0 END),
		SERVICE_TAX = SERVICE_TAX
					+ (CASE WHEN SERVICE_CHRG = 0 THEN 
							CASE WHEN SELL_BUY =1 THEN CD_TOT_BUYSERTAX ELSE CD_TOT_SELLSERTAX END					
							ELSE 0 END)
	FROM
		CHARGES_DETAIL C (NOLOCK)
	WHERE
		LEFT(CD_SAUDA_DATE,11) = LEFT(SAUDA_DATE,11)        
		AND CD_PARTY_CODE = #EXERCISE.PARTY_CODE        
		AND CD_INST_TYPE = INST_TYPE        
		AND CD_SYMBOL = SYMBOL        
		AND LEFT(CD_EXPIRY_DATE,11) = LEFT(EXPDATE,11)
		AND CD_OPTION_TYPE = OPTION_TYPE        
		AND CD_STRIKE_PRICE = STRIKE_PRICE
		AND CD_TRADE_NO = TRADE_NO
		AND CD_ORDER_NO = ORDER_NO
		AND CD_AUCTIONPART = 'EA'
		

            
INSERT             
INTO             
    FO_TRADE_DETAILS_DAS             
SELECT             
    FOTDD_PARTY_CODE   = PARTY_CODE,             
    FOTDD_INST_TYPE    = INST_TYPE,             
    FOTDD_SYMBOL       = SYMBOL,             
    FOTDD_STRIKE_PRICE = STRIKE_PRICE,             
    FOTDD_OPTION_TYPE  = OPTION_TYPE,             
    FOTDD_EXPIRY_DATE  = EXPDATE,             
    FOTDD_SEC_NAME     = '',             
    FOTDD_TRADEQTY     = 0,             
    FOTDD_VALUE        = 0,             
    FOTDD_PRICE        = PRICE,             
    FOTDD_PQTY         = PQTY,             
    FOTDD_SQTY         = SQTY,             
    FOTDD_PAMT         = PAMT,             
    FOTDD_SAMT         = SAMT,             
    FOTDD_NETRATE      = NETRATE,             
    FOTDD_CFPPRICE     = 0,             
    FOTDD_CFSPRICE     = 0,             
    FOTDD_SETTPRICE    = SETTPRICE,             
    FOTDD_SAUDA_DATE   = @SDATE,             
    FOTDD_PNETRATE     = 0,             
    FOTDD_SNETRATE     = 0,             
    FOTDD_CHARGES      = CHARGES,             
    FOTDD_BROKERAGE    = BROKERAGE,             
    FOTDD_SERVICE_TAX  = SERVICE_TAX,             
    FOTDD_BROKER_NOTE  = BROKER_NOTE,             
    FOTDD_TURN_TAX     = TURN_TAX,             
    FOTDD_SEBI_TAX     = SEBI_TAX,             
    FOTDD_CONTRACTNO   = '',             
    FOTDD_PCOMM        = 0,             
    FOTDD_SCOMM        = 0,             
    FOTDD_INS_CHRG     = INS_CHRG,             
    FOTDD_FLAG         = '03',             
    FOTDD_O_C_FLAG     = '',             
    FOTDD_AUCTIONPART  = '',             
    FOTDD_CREATED_BY   = @UNAME,             
    FOTDD_CREATED_DT   = GETDATE()             
FROM             
    (             
    SELECT
        PARTY_CODE,
        INST_TYPE,
        SYMBOL,
        EXPDATE,
        STRIKE_PRICE,
        OPTION_TYPE,
        PQTY = SUM(PQTY),
        PAMT = SUM(PAMT),             
        SQTY = SUM(SQTY),
        SAMT = SUM(SAMT),
        NETRATE,
        SETTPRICE,
		CHARGES = SUM(CHARGES),
        BROKERAGE = SUM(BROKERAGE),
        SERVICE_TAX = SUM(SERVICE_TAX),
        BROKER_NOTE = SUM(BROKER_NOTE),
        TURN_TAX = SUM(TURN_TAX),
        SEBI_TAX = SUM(SEBI_TAX),
        INS_CHRG = SUM(INS_CHRG),
        PRICE,
		SELL_BUY
	FROM
        #EXERCISE S WITH(NOLOCK)          
    GROUP BY             
        PARTY_CODE,
        INST_TYPE,
        SYMBOL,
        EXPDATE,
        STRIKE_PRICE,
        OPTION_TYPE,
        NETRATE,
        SETTPRICE,
        PRICE,
		SELL_BUY
    ) F              
--    ORDER BY PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE               
           
/*=========================================================================================================         
    MARK TO MARKET STATEMENT            
    04-TRADETYPE      = 'BF'            
    05-TRADETYPE       = 'BT'            
    06-CARRY FORWARD RECORDS          
=========================================================================================================*/            
            
    SET @MEMBERCODE = (SELECT MEMBERCODE FROM FOOWNER)              
              
    INSERT             
    INTO             
        FO_TRADE_DETAILS_DAS             
    SELECT             
        FOTDD_PARTY_CODE = PARTY_CODE,             
        FOTDD_INST_TYPE = INST_TYPE,            
        FOTDD_SYMBOL = SYMBOL,             
        FOTDD_STRIKE_PRICE = 0,             
        FOTDD_OPTION_TYPE = '',             
        FOTDD_EXPIRY_DATE = EXPDATE,             
        FOTDD_SEC_NAME = '',             
        FOTDD_TRADEQTY = 0,             
        FOTDD_VALUE = 0,             
        FOTDD_PRICE = 0,             
        FOTDD_PQTY = PQTY,             
        FOTDD_SQTY = SQTY,             
        FOTDD_PAMT = PAMT,             
        FOTDD_SAMT = SAMT,             
        FOTDD_NETRATE = 0,             
        FOTDD_CFPPRICE = CFPPRICE,            
        FOTDD_CFSPRICE = CFSPRICE,             
        FOTDD_SETTPRICE = SETTPRICE,             
        FOTDD_SAUDA_DATE = @SDATE,             
        FOTDD_PNETRATE = 0,             
        FOTDD_SNETRATE = 0,             
        FOTDD_CHARGES = CHARGES,             
        FOTDD_BROKERAGE = 0,             
        FOTDD_SERVICE_TAX = 0,             
        FOTDD_BROKER_NOTE = 0,             
        FOTDD_TURN_TAX = 0,             
        FOTDD_SEBI_TAX = 0,             
        FOTDD_CONTRACTNO = '',             
        FOTDD_PCOMM = 0,             
        FOTDD_SCOMM = 0,             
        FOTDD_INS_CHRG = 0,             
        FOTDD_FLAG = LEFT(FLAG,4),             
        FOTDD_O_C_FLAG = '',             
 FOTDD_AUCTIONPART = '',             
        FOTDD_CREATED_BY = @UNAME,             
        FOTDD_CREATED_DT = GETDATE()             
    FROM             
    (             
    SELECT             
        PQTY =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) > 0             
            THEN SUM(PQTY-SQTY)             
            ELSE 0 END            
        )            
        ,             
        SQTY =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) < 0             
	    THEN ABS(SUM(PQTY-SQTY))             
            ELSE 0 END            
        )            
        ,             
        PAMT =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) > 0             
            THEN SUM(PAMT-SAMT)             
            ELSE 0 END            
        )            
        ,             
        SAMT =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) < 0             
            THEN ABS(SUM(PAMT-SAMT))             
            ELSE 0 END            
        )            
        ,             
        CHARGES = (SUM(SERVICE_TAX) - SUM(EXSER_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)),             
        PARTY_CODE,             
        INST_TYPE,             
        SYMBOL,             
        EXPDATE    = LEFT(EXPIRYDATE, 11),             
        FLAG       = '04' + TRADETYPE,             
        CFPPRICE =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) > 0             
            THEN SUM(PAMT-SAMT)/ABS(SUM(PQTY-SQTY))             
            ELSE 0 END             
        )            
        ,             
        CFSPRICE =             
 	(            
        CASE             
            WHEN SUM(PQTY-SQTY) < 0             
            THEN ABS(SUM(PAMT-SAMT))/ABS(SUM(PQTY-SQTY))             
         ELSE 0 END             
        )            
        ,             
        SETTPRICE = MAX(CL_RATE)              
    FROM             
        FOBILLVALAN             
    WHERE             
        PARTY_CODE BETWEEN @FPARTY AND @TPARTY            
        AND SAUDA_DATE LIKE @SDATE+'%'             
        AND LEFT(INST_TYPE,3) = 'FUT'             
        AND TRADETYPE       = 'BF'             
        AND PARTICIPANTCODE = @MEMBERCODE             
    GROUP BY             
        PARTY_CODE,             
        INST_TYPE,      
        SYMBOL,             
        LEFT(EXPIRYDATE, 11),             
        TRADETYPE             
                
    UNION ALL             
                
    SELECT             
        PQTY    = SUM(PQTY),             
        SQTY    = SUM(SQTY),             
        PAMT    = SUM(CASE WHEN PAMT>0 THEN PAMT-PBROKAMT ELSE 0 END),             
        SAMT    = SUM(CASE WHEN SAMT>0 THEN SAMT+SBROKAMT ELSE 0 END),             
        CHARGES = (SUM(SERVICE_TAX) - SUM(EXSER_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)),             
        PARTY_CODE,             
        INST_TYPE,             
        SYMBOL,             
        EXPDATE    = LEFT(EXPIRYDATE, 11),             
        FLAG       = '04'+ TRADETYPE,                  
        CFPPRICE = MAX(PRATE),             
        CFSPRICE = MAX(SRATE),             
        SETTPRICE = MAX(CL_RATE)              
    FROM             
        FOBILLVALAN             
    WHERE             
        PARTY_CODE BETWEEN @FPARTY AND @TPARTY            
        AND SAUDA_DATE LIKE @SDATE+'%'             
        AND LEFT(INST_TYPE,3) = 'FUT'             
        AND TRADETYPE       = 'BT'             
        AND PARTICIPANTCODE = @MEMBERCODE             
    GROUP BY             
        PARTY_CODE,             
    INST_TYPE,             
        SYMBOL,             
        LEFT(EXPIRYDATE, 11),             
        TRADETYPE             
                
    UNION ALL             
                
    SELECT             
        PQTY =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) < 0             
            THEN ABS(SUM(PQTY-SQTY))             
            ELSE 0 END            
        )            
        ,             
        SQTY =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) > 0             
            THEN ABS(SUM(PQTY-SQTY))             
            ELSE 0 END            
        )            
        ,             
        PAMT =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) < 0             
            THEN ABS(SUM((PQTY-SQTY)*CL_RATE))             
            ELSE 0 END            
        )            
        ,             
        SAMT =             
        (            
        CASE             
            WHEN SUM(PQTY-SQTY) > 0             
            THEN ABS(SUM(((PQTY)-(SQTY))*CL_RATE))             
            ELSE 0 END            
        )            
        ,             
        CHARGES = 0,             
        PARTY_CODE,             
        INST_TYPE,             
        SYMBOL,             
        EXPDATE    = LEFT(EXPIRYDATE, 11),             
        FLAG       = '04' + 'CF',             
        CFPPRICE  = 0,             
        CFSPRICE  = 0,             
        SETTPRICE = MAX(CL_RATE)             
    FROM             
        FOBILLVALAN             
    WHERE             
        PARTY_CODE BETWEEN @FPARTY AND @TPARTY            
        AND SAUDA_DATE LIKE @SDATE+'%'             
        AND LEFT(INST_TYPE,3) = 'FUT'             
        AND PARTICIPANTCODE = @MEMBERCODE             
    GROUP BY             
        PARTY_CODE,             
        INST_TYPE,             
        SYMBOL,      
   LEFT(EXPIRYDATE, 11)             
    HAVING      
        SUM(PQTY-SQTY) <> 0             
    ) T             
    WHERE             
    PQTY+SQTY > 0             
    --ORDER BY INST_TYPE, PARTY_CODE, SYMBOL, EXPIRYDATE, FLAG                
            
            
/*=========================================================================================================            
    07-CORPORATE ACTION ADJUSTMENTS OF POSITIONS            
=========================================================================================================*/            
            
    INSERT             
    INTO             
        FO_TRADE_DETAILS_DAS             
    SELECT             
        FOTDD_PARTY_CODE = PARTY_CODE,             
        FOTDD_INST_TYPE = INST_TYPE,             
        FOTDD_SYMBOL = SYMBOL,             
        FOTDD_STRIKE_PRICE = STRIKE_PRICE,             
        FOTDD_OPTION_TYPE = OPTION_TYPE,             
        FOTDD_EXPIRY_DATE = EXPIRYDATE,             
        FOTDD_SEC_NAME = SYMBOL + '-' + INST_TYPE,             
        FOTDD_TRADEQTY = TRADEQTY,             
        FOTDD_VALUE = NETRATE*TRADEQTY,             
        FOTDD_PRICE = PRICE,             
        FOTDD_PQTY = 0,             
        FOTDD_SQTY = 0,             
        FOTDD_PAMT = 0,             
        FOTDD_SAMT = 0,             
        FOTDD_NETRATE = 0,             
        FOTDD_CFPPRICE = 0,            
        FOTDD_CFSPRICE = 0,             
        FOTDD_SETTPRICE = 0,             
        FOTDD_SAUDA_DATE = @SDATE,             
        FOTDD_PNETRATE = 0,             
        FOTDD_SNETRATE = 0,             
        FOTDD_CHARGES = 0,             
        FOTDD_BROKERAGE = 0,             
        FOTDD_SERVICE_TAX = 0,             
        FOTDD_BROKER_NOTE = 0,             
        FOTDD_TURN_TAX = 0,     
        FOTDD_SEBI_TAX = 0,             
        FOTDD_CONTRACTNO = 0,             
        FOTDD_PCOMM = 0,             
        FOTDD_SCOMM = 0,             
        FOTDD_INS_CHRG = 0,             
        FOTDD_FLAG = '07',             
        FOTDD_O_C_FLAG = O_C_FLAG,             
        FOTDD_AUCTIONPART = AUCTIONPART,             
        FOTDD_CREATED_BY = @UNAME,             
        FOTDD_CREATED_DT = GETDATE()             
    FROM             
        FOSETTCORPACT WITH(NOLOCK)            
    WHERE             
        SAUDA_DATE LIKE @SDATE +'%'             
        AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY            
        AND AUCTIONPART = 'CA'             
--    ORDER BY O_C_FLAG, SYMBOL, EXPIRYDATE, OPTION_TYPE              
            
    DROP TABLE #FODAILYCONFIRM            
    DROP TABLE #FODAILYCONFIRM_OPT            
    
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FOCORPACTADJUSTMENT
-- --------------------------------------------------

/*------------------------------------------------------------------------------------------------------------  
PROGRAM NAME : PR_FOCORPACTADJUSTMENT  
DESCRIPTION  : SQL SCRIPTS FOR NSEFO CORPORATE ACTION ADJUSTMENTS  
 @MODE  = 'FILL'  - FETCH THE POSITIONS TO TEMP TABLE FOCORPACTPOSITION FROM ADJUSTED / EXISTING CSV FILE  
 @MODE  = 'CHECK' - GETTING NO OF RECORDS UPDATED AND NEXT TRADE DATE  
 @MODE  = 'MATCH' - CHECKING EXCHANGE POSITIONS WITH BACKOFFICE PARTY LEVEL POSITIONS  
 @MODE  = 'GET' - COMPUTING ADJUSTMENT FACTOR FROM EXISTING / ADJUSTED CSV FILES  
 @MODE  = 'FETCH' - FETCHING THE OLD & ADJUSTED POSITION SUMMARY FOR DISPLAY  
 @MODE  = 'UPDATE1' - POPULATING THE FINAL RECORDS AT FOSETTLEMENT - POSITION METHOD  
 @MODE  = 'UPDATE2' - POPULATING THE FINAL RECORDS AT FOSETTLEMENT - RATIO METHOD  
 @MODE  = 'UPDATE3' - CHANGE OF SYMBOL  
--------------------------------------------------------------------------------------------------------------*/  

CREATE PROC [dbo].[PR_FOCORPACTADJUSTMENT]   
(  
 @FILEDATE VARCHAR(11),  
 @TRADETYPE VARCHAR(2),  
 @MODE VARCHAR(10),  
 @SYMBOL VARCHAR(12),  
 @OLDLOTSIZE INT = 1,  
 @NEWLOTSIZE INT = 1,  
 @ADJFACTOR1 NUMERIC(18,8) = 1,  
 @ADJFACTOR2 NUMERIC(18,8) = 1,  
 @ROUNDING INT = 1,  
 @SAUDA_DATE VARCHAR(11) ='',  
 @SYMBOLNEW VARCHAR(12) ='',
 @DUMPINMYTABLE VARCHAR(1) = ''
) AS  
  
DECLARE @INTVBBSTAT BIGINT  
DECLARE @INTBFQTY BIGINT  -- EXISTING POSITION  
DECLARE @INTBTQTY BIGINT  -- ADJUSTED POSITION  
DECLARE @INTBFVAL MONEY  -- EXISTING VALUE  
DECLARE @INTBTVAL MONEY  -- ADJUSTED VALUE  
DECLARE @1ADJFACTOR NUMERIC (18,8)  
DECLARE @2ADJFACTOR NUMERIC (18,8)   
DECLARE @CORPACTTYPE VARCHAR(20)  
DECLARE @C_REGULAR_LOT INT   
DECLARE @MEMBERTYPE VARCHAR(15)  
DECLARE @MEMBERCODE VARCHAR(10)
DECLARE @STRRETURNFLAG INT  
DECLARE @STRRETURNMSG VARCHAR(200)  
  
  
IF @MODE = 'FILL'  
 BEGIN  
  /*------------------------------------------------------------------------------------------  
     FETCH THE POSITIONS TO TEMP TABLE FOCORPACTPOSITION FROM ADJUSTED / EXISTING CSV FILE  
    TRADETYPE = 'BF'  - EXISTING POSITIONS  
    TRADETYPE = 'BT'  - ADJUSTED NEW POSITIONS  
  --------------------------------------------------------------------------------------------*/  
  SELECT @MEMBERTYPE = UPPER(RTRIM(LTRIM(MEMBERTYPE))), @MEMBERCODE = MEMBERCODE FROM FOOWNER  
  
  DELETE FOCORPACTPOSITION WHERE TRADE_DATE LIKE @FILEDATE + '%'  AND TRADETYPE = @TRADETYPE   
  IF @MEMBERTYPE = 'TM'
  BEGIN
	DELETE FOCORPACTPOSITION_IMP WHERE TRAD_MEM_CODE <> @MEMBERCODE 
  END
     
    
	IF @TRADETYPE = 'BF'  
		BEGIN     
			IF @MEMBERTYPE = 'CM'   
				BEGIN       
					UPDATE FOCORPACTPOSITION_IMP SET PARTY_CODE = CLIENT2.PARTY_CODE  
					FROM CLIENT2 WHERE FOCORPACTPOSITION_IMP.TRAD_MEM_CODE = CLIENT2.BANKID  
					AND CLIENT2.BANKID <> ''  
					AND (BF_LNG_QTY <> 0  OR BF_SHORT_QTY <> 0)  

					UPDATE FOCORPACTPOSITION_IMP SET PARTY_CODE = FOTMINFO.PARTY_CODE  
					FROM FOTMINFO WHERE  FOCORPACTPOSITION_IMP.TRAD_MEM_CODE = FOTMINFO.TM_CODE  
					AND (BF_LNG_QTY <> 0  OR BF_SHORT_QTY <> 0)  
				END  

			INSERT INTO FOCORPACTPOSITION  
			SELECT TRADE_DATE,PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
			BF_LNG_QTY,BF_LNG_VAL,BF_SHORT_QTY,BF_SHORT_VAL, @TRADETYPE ,GETDATE()  
			FROM FOCORPACTPOSITION_IMP WHERE (BF_LNG_QTY > 0  OR BF_SHORT_QTY > 0)  
		END  
	ELSE  
		BEGIN  
			IF @MEMBERTYPE = 'CM'   
				BEGIN       
					UPDATE FOCORPACTPOSITION_IMP SET PARTY_CODE = CLIENT2.PARTY_CODE  
					FROM CLIENT2 WHERE FOCORPACTPOSITION_IMP.TRAD_MEM_CODE = CLIENT2.BANKID  
					AND CLIENT2.BANKID <> ''  
					AND (BUY_OPEN_QTY <> 0  OR SELL_OPEN_QTY <> 0)  

					UPDATE FOCORPACTPOSITION_IMP SET PARTY_CODE = FOTMINFO.PARTY_CODE  
					FROM FOTMINFO WHERE  FOCORPACTPOSITION_IMP.TRAD_MEM_CODE = FOTMINFO.TM_CODE  
					AND (BUY_OPEN_QTY <> 0  OR SELL_OPEN_QTY <> 0)  
				END  


			INSERT INTO FOCORPACTPOSITION  
			SELECT TRADE_DATE,PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
			BUY_OPEN_QTY,BUY_OPEN_VAL,SELL_OPEN_QTY,SELL_OPEN_VAL, @TRADETYPE ,GETDATE()  
			FROM FOCORPACTPOSITION_IMP WHERE (BUY_OPEN_QTY > 0  OR SELL_OPEN_QTY > 0)  
		END   
END  
ELSE IF @MODE = 'CHECK'  
 BEGIN  
  SELECT   
   TOP 1 TRADE_DATE AS FILEDATE,   
   DATEADD(D,1,TRADE_DATE) AS TRADEDATE ,   
   SYMBOL   
  INTO #FOCORPACTPOSITION_IMP  
  FROM   
   FOCORPACTPOSITION_IMP  
   
  CREATE TABLE #MYTABLE (NEXTTDAY DATETIME)   
  DECLARE  @DBSERVER VARCHAR(20),@STRSQL VARCHAR(400)  
   
  SELECT   
   TOP 1 @DBSERVER = DEFAULTDBSERVER   
  FROM   
   PRADNYA.DBO.MULTICOMPANY   
  WHERE   
   EXCHANGE ='NSE' AND SEGMENT ='FUTURES'  
   
  SET @STRSQL = 'SELECT '  
  SET @STRSQL = @STRSQL + 'MIN(START_DATE) '  
  SET @STRSQL = @STRSQL + 'FROM '  
  SET @STRSQL = @STRSQL + @DBSERVER + '.MSAJAG.DBO.SETT_MST'  
  SET @STRSQL = @STRSQL + ' WHERE '  
  SET @STRSQL = @STRSQL + 'START_DATE > (SELECT LEFT(MIN(TRADE_DATE),11) FROM FOCORPACTPOSITION_IMP) '   
  SET @STRSQL = @STRSQL + 'AND SETT_TYPE =''N'''  
   
  INSERT INTO #MYTABLE (NEXTTDAY) EXEC (@STRSQL)  
   
  IF (SELECT COUNT(1) FROM #MYTABLE WHERE NEXTTDAY IS NOT NULL) >0   
   BEGIN  
    UPDATE #FOCORPACTPOSITION_IMP SET TRADEDATE = NEXTTDAY FROM #MYTABLE  
   END  
  DROP TABLE #MYTABLE  
  IF @DUMPINMYTABLE = 'Y'
	BEGIN
		INSERT INTO #DUMP (FDATE, TRADEDATE, FILEDATE, SYMBOL)
		SELECT
			CONVERT(VARCHAR,FILEDATE,103) AS FILEDATE,  
			CONVERT(VARCHAR,TRADEDATE,103) AS TRADE_DATE,  
			LEFT(FILEDATE,11) AS FILEDATE109,   
			SYMBOL  
		FROM  
			#FOCORPACTPOSITION_IMP
	END
  SELECT   
    CONVERT(VARCHAR,FILEDATE,103) AS FILEDATE,  
    CONVERT(VARCHAR,TRADEDATE,103) AS TRADE_DATE,  
    LEFT(FILEDATE,11) AS FILEDATE109,   
    SYMBOL  
  FROM  
   #FOCORPACTPOSITION_IMP  
  
     
  
 END  
ELSE IF @MODE = 'MATCH'  
 BEGIN  
  /*-------------------------------------------------------------------------------------  
  CHECKING EXCHANGE POSITIONS WITH BACKOFFICE PARTY LEVEL POSITIONS  
                IF THE PARTY WISE POSTIONS ARE MATCHING SYSTEM WILL ALLOW TO PROCEED WITH DIRECT   
   ADJUSTED POSTION METHOD ELSE RATIO METHOD WILL BE PROCEED  
  ---------------------------------------------------------------------------------------*/  
  SELECT COUNT(1) FROM   
   (  
   SELECT  
    BO_PARTY_CODE = PARTY_CODE,  
    BO_INST_TYPE = INST_TYPE,  
    BO_SYMBOL = SYMBOL,  
    BO_EXPIRYDATE = CONVERT(VARCHAR,EXPIRYDATE,103),  
    BO_OPTION_TYPE = OPTION_TYPE,  
    BO_STRIKE_PRICE = STRIKE_PRICE,  
    BO_PQTY = CASE WHEN SUM(PQTY-SQTY) > 0 THEN SUM(PQTY-SQTY) ELSE 0 END,  
    BO_SQTY = CASE WHEN SUM(PQTY-SQTY) < 0 THEN SUM(PQTY-SQTY) ELSE 0 END  
   FROM  
    FOBILLVALAN  
   WHERE  
    SAUDA_DATE  LIKE @FILEDATE + '%'  
    AND SYMBOL = @SYMBOL  
    /*AND 1 = CASE WHEN LEFT(INST_TYPE,3) ='FUT' AND AUCTIONPART ='' THEN 1  
     ELSE CASE WHEN LEFT(INST_TYPE,3) ='OPT'   
      AND (AUCTIONPART ='' OR AUCTIONPART='EA') THEN 1  
     ELSE 2 END END*/  
    AND LEFT(EXPIRYDATE,11) <> LEFT(SAUDA_DATE,11)  
   GROUP BY  
    PARTY_CODE,  
    INST_TYPE,  
    SYMBOL,  
    CONVERT(VARCHAR,EXPIRYDATE,103),  
    OPTION_TYPE,  
    STRIKE_PRICE  
   HAVING  
    SUM(PQTY-SQTY) <> 0  
   ) BO_POS   
    
   FULL OUTER JOIN  
    
   (  
   SELECT   
    EX_PARTY_CODE = PARTY_CODE,  
    EX_INST_TYPE = INST_TYPE,  
    EX_SYMBOL = SYMBOL,  
    EX_EXPIRYDATE = CONVERT(VARCHAR,EXPIRYDATE,103),  
    EX_OPTION_TYPE = OPTION_TYPE,  
    EX_STRIKE_PRICE = STRIKE_PRICE,  
    BUY_OPEN_QTY = CASE WHEN SUM(BUY_OPEN_QTY-SELL_OPEN_QTY) > 0 THEN  SUM(BUY_OPEN_QTY-SELL_OPEN_QTY) ELSE 0 END,  
    SELL_OPEN_QTY = CASE WHEN SUM(BUY_OPEN_QTY-SELL_OPEN_QTY)< 0 THEN  SUM(BUY_OPEN_QTY-SELL_OPEN_QTY) ELSE 0 END  
   FROM  
    FOCORPACTPOSITION  
   WHERE  
    TRADE_DATE LIKE @FILEDATE + '%'  
    AND SYMBOL = @SYMBOL  
    AND TRADETYPE ='BF'  
   GROUP BY  
    PARTY_CODE,  
    INST_TYPE,  
    SYMBOL,  
    CONVERT(VARCHAR,EXPIRYDATE,103),  
    OPTION_TYPE,  
    STRIKE_PRICE  
   HAVING SUM(BUY_OPEN_QTY-SELL_OPEN_QTY) <> 0  
   ) EX_POS  
    
  ON    
   (  
    EX_PARTY_CODE = BO_PARTY_CODE AND  
    EX_INST_TYPE = BO_INST_TYPE AND  
    EX_SYMBOL = BO_SYMBOL AND  
    EX_EXPIRYDATE = BO_EXPIRYDATE AND  
    BO_OPTION_TYPE = CASE WHEN LEFT(BO_INST_TYPE,3)='FUT' THEN '' ELSE EX_OPTION_TYPE END AND  
    EX_STRIKE_PRICE = BO_STRIKE_PRICE AND  
    BUY_OPEN_QTY = BO_PQTY AND  
    SELL_OPEN_QTY = BO_SQTY  
   )  
  WHERE BO_PARTY_CODE IS NULL OR EX_PARTY_CODE IS NULL    
 END  
ELSE IF @MODE = 'GET'  
 BEGIN  
  /*--------------------------------------------------------------------------------------------------  
   COMPUTING ADJUSTMENT FACTOR FROM EXISTING / ADJUSTED CSV FILES  
  ----------------------------------------------------------------------------------------------------*/  
  SET @INTBFQTY = 0  
  SET @INTBTQTY = 0  
  SET @INTBFVAL = 0   
  SET @INTBTVAL = 0   
  
  SELECT  
   @INTBFQTY  = SUM(BUY_OPEN_QTY+SELL_OPEN_QTY),   
   @INTBFVAL  = SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN (BUY_OPEN_VAL+SELL_OPEN_VAL) ELSE 0 END)  
  FROM  
   FOCORPACTPOSITION  
  WHERE  
   TRADE_DATE LIKE @FILEDATE + '%'  
   AND TRADETYPE = 'BF'  
   AND SYMBOL = @SYMBOL  
  
  SELECT  
   @INTBTQTY  = SUM(BUY_OPEN_QTY+SELL_OPEN_QTY),  
   @INTBTVAL  = SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN (BUY_OPEN_VAL+SELL_OPEN_VAL) ELSE 0 END)  
  FROM  
   FOCORPACTPOSITION  
  WHERE  
   TRADE_DATE LIKE @FILEDATE + '%'  
   AND TRADETYPE = 'BT'  
   AND SYMBOL = @SYMBOL  
  
  SET @INTBFQTY = CONVERT(NUMERIC(18,8),ISNULL(@INTBFQTY,0))  
  SET @INTBTQTY = CONVERT(NUMERIC(18,8),ISNULL(@INTBTQTY,0))  
  SET @INTBFVAL = CONVERT(NUMERIC(18,4),ISNULL(@INTBFVAL,0))  
  SET @INTBTVAL = CONVERT(NUMERIC(18,4),ISNULL(@INTBTVAL,0))  
  
  
  
  IF  @INTBTQTY =0 OR  @INTBFQTY = 0   
   BEGIN  
    SET @CORPACTTYPE = ''  
    SET @1ADJFACTOR = 0  
    SET @2ADJFACTOR = 0  
   END  
  ELSE IF  @INTBTQTY > @INTBFQTY   
   BEGIN  
    SET @CORPACTTYPE = 'BONUS/SPLIT'  
    SET @1ADJFACTOR = CONVERT(NUMERIC(18,8),CONVERT(NUMERIC(18,8),@INTBTQTY)/CONVERT(NUMERIC(18,6),@INTBFQTY))  
    SET @2ADJFACTOR = 1
   END  
  ELSE IF  @INTBTQTY = @INTBFQTY  
   BEGIN
    SET @CORPACTTYPE = 'DIVIDENT'  
    SET @1ADJFACTOR = 1  
    SET @2ADJFACTOR = 1 
   END  
  SELECT @CORPACTTYPE, @1ADJFACTOR ,@2ADJFACTOR  
 END  
ELSE IF @MODE = 'FETCH'  
 BEGIN  
  /*-----------------------------------------------------------------------------------  
    FETCHING THE OLD & ADJUSTED POSITION SUMMARY FOR DISPLAY  
  -------------------------------------------------------------------------------------*/  
  
  
  
   SELECT  
    @C_REGULAR_LOT = C_REGULAR_LOT  
   FROM  
    (  
    SELECT  TOP 1   
     INST_TYPE,  
     SYMBOL,  
     EXPIRYDATE,  
     STRIKE_PRICE,  
     OPTION_TYPE  
    FROM  
     FOCORPACTPOSITION  
    WHERE  
     TRADE_DATE LIKE  @FILEDATE + '%'  
     AND TRADETYPE = @TRADETYPE  
     AND SYMBOL = @SYMBOL  
     AND LEFT(INST_TYPE,3) = 'OPT'  
    ) CORPACT,  
    FOSCRIP2  
   WHERE  
    FOSCRIP2.INST_TYPE = CORPACT.INST_TYPE  
    AND FOSCRIP2.SYMBOL = CORPACT.SYMBOL  
    AND CONVERT(VARCHAR,FOSCRIP2.EXPIRYDATE,103) = CONVERT(VARCHAR,CORPACT.EXPIRYDATE,103)  
    AND FOSCRIP2.STRIKE_PRICE = CORPACT.STRIKE_PRICE  
    AND FOSCRIP2.OPTION_TYPE = CORPACT.OPTION_TYPE  
  SET @C_REGULAR_LOT = ISNULL(@C_REGULAR_LOT,0)  
  
  SELECT  CONTRACT = INST_TYPE + ' ' + SYMBOL + ' ' + LEFT(EXPIRYDATE,11)+CONVERT(VARCHAR,STRIKE_PRICE)+OPTION_TYPE,  
   PQTY = ABS(SUM(BUY_OPEN_QTY)),  
   SQTY = ABS(SUM(SELL_OPEN_QTY)),  
   NETPVAL = ABS(SUM(BUY_OPEN_VAL)),  
   NETSVAL = ABS(SUM(SELL_OPEN_VAL)),  
   LEFT(EXPIRYDATE,11),LEFT(INST_TYPE,3),  
   C_REGULAR_LOT = @C_REGULAR_LOT  
  FROM  
   FOCORPACTPOSITION  
  WHERE  
   TRADE_DATE LIKE @FILEDATE + '%'  
   AND TRADETYPE = @TRADETYPE  
   AND SYMBOL = @SYMBOL  
  GROUP BY  
   INST_TYPE , SYMBOL , EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE  
  HAVING SUM(BUY_OPEN_QTY-SELL_OPEN_QTY) <> 0  
  ORDER BY  
   LEFT(EXPIRYDATE,11),LEFT(INST_TYPE,3)  
 END  
  
ELSE IF (@MODE = 'UPDATE1' OR  @MODE = 'UPDATE2')  
 BEGIN  
 /*-------------------------------------------------------------------------------------------------------  
POPULATING THE OLD POSITIONS (WITH RATE) & ADJUSTED POSITIONS (WITH RATE) TO RESERVE TABLE FOSETTCORPACT  
 AUTO POPULATING SCRIP MASTER (FOSCRIP2) FOR MISSING OPTION CONTRACTS WITH NEW LOT SIZE, IF MISSING  
 FINAL POSITION IS POPULATING TO FOSETTLEMENT (WITH AN AUCTIONPART = 'CA' )  
 TWO METHODS AS POSITION METHOD AND RATIO METHOD ARE USING FOR POPULATING FINAL ADJUSTED POSTION  
 CONTRAT MASTER FUTURES FOR IS UPDATING WITH THE NEW LOT SIZE   
 FOSETTLEMENT BILLNO ( SCRIP LOT SIZE ) WILL BE UPDATING ONLY FOR VBB  
 --------------------------------------------------------------------------------------------------------*/  
  /*--------------------------------------------------------  
    UPDATING CONTRACT MASTER FOR MISSING SCRIPT  (ONLY OPT)  
  ---------------------------------------------------------
  DECLARE        
   @@SELFOTRADE CURSOR,        
   @@MYPKEY  INT,        
   @@OPTION_TYPE VARCHAR(2),        
   @@INST_TYPE VARCHAR(6),        
   @@SYMBOL VARCHAR(12),        
   @@STRIKE_PRICE MONEY,        
   @@SECNAME VARCHAR(20),        
   @@EXPIRYDATE SMALLDATETIME,        
   @@MYSETTNO INT  
        
  SELECT @@MYSETTNO = ISNULL(MAX(SETT_NO),0) FROM FOSETT_MST  
  SELECT @@MYPKEY = ISNULL( MAX(P_KEY),0) FROM FOSCRIP2  
  SET @@SELFOTRADE = CURSOR FOR  
  SELECT   
   DISTINCT INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,ISNULL(STRIKE_PRICE,0)         
  FROM  
   FOCORPACTPOSITION   
  WHERE   
   TRADE_DATE LIKE  @FILEDATE + '%'  
   AND SYMBOL = @SYMBOL  
   AND SELL_OPEN_QTY + BUY_OPEN_QTY > 0  
   AND SYMBOL NOT IN ( SELECT SYMBOL FROM FOSCRIP2 WHERE         
   FOSCRIP2.INST_TYPE=FOCORPACTPOSITION.INST_TYPE AND        
   FOSCRIP2.SYMBOL=FOCORPACTPOSITION.SYMBOL AND        
   CONVERT(VARCHAR,FOSCRIP2.EXPIRYDATE,103)=CONVERT(VARCHAR,FOCORPACTPOSITION.EXPIRYDATE,103) AND        
   FOSCRIP2.OPTION_TYPE = FOCORPACTPOSITION.OPTION_TYPE  AND  
   FOSCRIP2.STRIKE_PRICE = FOCORPACTPOSITION.STRIKE_PRICE ) AND   
   LEFT(INST_TYPE,3) = 'OPT'  
  
          
  OPEN @@SELFOTRADE  
  FETCH NEXT FROM @@SELFOTRADE INTO @@INST_TYPE,@@SYMBOL,@@EXPIRYDATE,@@OPTION_TYPE,@@STRIKE_PRICE  
         
  WHILE @@FETCH_STATUS = 0         
  BEGIN             
   SET @@MYPKEY = @@MYPKEY + 1  
   SET @@MYSETTNO = @@MYSETTNO + 1  
   SET @@EXPIRYDATE = (LEFT(CONVERT(VARCHAR,@@EXPIRYDATE,109),11)) + ' 23:59:00'  
   SET @@SECNAME = @SYMBOL + UPPER(LEFT(CONVERT(VARCHAR,@@EXPIRYDATE,109),3)) + '  ' + LEFT(@@INST_TYPE,3)  
    
   INSERT INTO FOSCRIP2 VALUES  
     (@@MYPKEY + 1,@@INST_TYPE,@@SYMBOL,@@SECNAME,@@EXPIRYDATE,@@STRIKE_PRICE,@@OPTION_TYPE,        
     @FILEDATE,@@EXPIRYDATE,'O',0,@NEWLOTSIZE,@@EXPIRYDATE,'',@@SYMBOL,'',@@EXPIRYDATE,  
     @@STRIKE_PRICE,'',0)        
          
   INSERT INTO FOSCRIP1 VALUES  
     (@@INST_TYPE, @@SYMBOL,@@EXPIRYDATE,@@STRIKE_PRICE,@@OPTION_TYPE)  
          
   INSERT INTO FOSETT_MST VALUES  
     ('NSEFO','O',@@MYSETTNO,@@INST_TYPE,@@SYMBOL,@FILEDATE,@@EXPIRYDATE,  
     @@STRIKE_PRICE,@@OPTION_TYPE,'JAN  1 1990 00:00','JAN  1 1990 00:00',  
     'JAN  1 1990 00:00','JAN  1 1990 00:00','O','N',@@EXPIRYDATE)        
    
  FETCH NEXT FROM @@SELFOTRADE INTO @@INST_TYPE,@@SYMBOL,@@EXPIRYDATE,@@OPTION_TYPE,@@STRIKE_PRICE  
  END  
  DEALLOCATE @@SELFOTRADE    
  -----------------------------------------------------------------------------------------  
     UPDATE CONTRACT MASTER ENDS HERE  
  ------------------------------------------------------------------------------------------*/  
  
  SELECT @INTVBBSTAT = COUNT(1) FROM CHARGES_DETAIL WHERE CD_SAUDA_DATE > DATEADD(D,-10,@FILEDATE)  
  SET @INTVBBSTAT = ISNULL(@INTVBBSTAT,0)  
  
  
  DELETE  
   FOSETTCORPACT  
  WHERE  
   SAUDA_DATE LIKE @SAUDA_DATE + '%'  
   AND SYMBOL = @SYMBOL  
  
  DELETE  
   FOSETTLEMENT  
 WHERE  
   SAUDA_DATE LIKE @SAUDA_DATE + '%'  
   AND SYMBOL = @SYMBOL  
   AND AUCTIONPART = 'CA'  
  
    
  IF @MODE = 'UPDATE1'  
   BEGIN  
   /*POSITION BASED METHOD*/  
   INSERT INTO FOSETTCORPACT  
   SELECT   
    CONTRACTNO = '0',  
    BILLNO = CASE WHEN @INTVBBSTAT > 0 THEN @OLDLOTSIZE ELSE 0 END ,  
    TRADE_NO ='0',  
    PARTY_CODE,  
    INST_TYPE,  
    SYMBOL,  
    SEC_NAME = SYMBOL+UPPER(LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),3))+'  '+LEFT(INST_TYPE,3),  
    EXPIRYDATE = LEFT(EXPIRYDATE,11) + ' 23:59',  
    STRIKE_PRICE = CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN 0 ELSE STRIKE_PRICE END,  
    OPTION_TYPE = CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN '' ELSE OPTION_TYPE END,  
    USER_ID = '0',  
    PRO_CLI = '1',  
    O_C_FLAG = 'C',  
    C_U_FLAG = '',  
    TRADEQTY = CASE WHEN SELL_OPEN_QTY > 0 THEN SELL_OPEN_QTY ELSE BUY_OPEN_QTY END,  
    AUCTIONPART = 'CA',  
    MARKETTYPE = 1,  
    SERIES = 0,  
    ORDER_NO = '0',  
    PRICE = CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN  
     ABS(CASE   
     WHEN SELL_OPEN_QTY > 0   
     THEN SELL_OPEN_VAL / SELL_OPEN_QTY   
     ELSE BUY_OPEN_VAL / BUY_OPEN_QTY   
     END)  
     ELSE 0 END,  
    SAUDA_DATE = @SAUDA_DATE + ' 8:00 PM',  
    TABLE_NO = '0',  
    LINE_NO ='0',  
    VAL_PERC ='P',  
    NORMAL = 0,  
    DAY_PUC = 0,  
    DAY_SALES = 0,  
    SETT_PURCH = 0,  
    SETT_SALES = 0,  
    SELL_BUY = CASE WHEN SELL_OPEN_QTY > 0 THEN 1 ELSE 2 END,  
    SETTFLAG =  CASE WHEN SELL_OPEN_QTY > 0 THEN 4 ELSE 5 END,  
    BROKAPPLIED = 0,  
    NETRATE = 0,  
    AMOUNT = 0,  
    INS_CHRG = 0,  
    TURN_TAX = 0,  
    OTHER_CHRG = 0,  
    SEBI_TAX = 0,  
    BROKER_CHRG = 0,  
    SERVICE_TAX = 0,  
    TRADE_AMOUNT = 0,  
    BILLFLAG = 0,  
    SETT_NO = 0,  
    NBROKAPP = 0,  
    NSERTAX = 0,  
    N_NETRATE = 0,  
    SETT_TYPE = 0,  
    CL_RATE = 0,  
    PARTICIPANTCODE=MEMBERCODE,  
    STATUS = 'A',  
    CPID = '0',  
    INSTRUMENT = 0,  
    BOOKTYPE = 0,  
    BRANCH_ID = CASE WHEN MEMBERTYPE ='TM' THEN '' ELSE PARTY_CODE END,  
    TMARK = 0,  
    SCHEME = 0,  
    DUMMY1 = 0,  
    DUMMY2 = 0,   
    RESERVED1 = 0,  
    RESERVED2 = 0  
   FROM  
    FOCORPACTPOSITION S, FOOWNER  
   WHERE  
    TRADE_DATE LIKE  @FILEDATE + '%'  
    AND SYMBOL = @SYMBOL  
    AND TRADETYPE = 'BF'  
    AND SELL_OPEN_QTY + BUY_OPEN_QTY > 0  
     
   INSERT INTO FOSETTCORPACT  
   SELECT   
    CONTRACTNO = '0',  
    BILLNO = CASE WHEN @INTVBBSTAT > 0 THEN @NEWLOTSIZE ELSE 0 END,  
    TRADE_NO ='0',  
    PARTY_CODE,  
    INST_TYPE,  
    SYMBOL,  
    SEC_NAME = SYMBOL+UPPER(LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),3))+'  '+LEFT(INST_TYPE,3),  
    EXPIRYDATE = LEFT(EXPIRYDATE,11) + ' 23:59',  
    STRIKE_PRICE = CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN 0 ELSE STRIKE_PRICE END,  
    OPTION_TYPE = CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN '' ELSE OPTION_TYPE END,  
    USER_ID = '0',  
    PRO_CLI = '1',  
    O_C_FLAG = 'O',  
    C_U_FLAG = '',  
    TRADEQTY = CASE WHEN SELL_OPEN_QTY > 0 THEN SELL_OPEN_QTY ELSE BUY_OPEN_QTY END,  
    AUCTIONPART = 'CA',  
    MARKETTYPE = 1,  
    SERIES = 0,  
    ORDER_NO = '0',  
    PRICE = CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN  
     ABS(CASE   
     WHEN SELL_OPEN_QTY > 0   
     THEN SELL_OPEN_VAL / SELL_OPEN_QTY   
     ELSE BUY_OPEN_VAL / BUY_OPEN_QTY   
     END)  
     ELSE 0 END,  
    SAUDA_DATE = @SAUDA_DATE + ' 8:00 PM',  
    TABLE_NO = '0',  
    LINE_NO ='0',  
    VAL_PERC ='V',  
    NORMAL = 0,  
    DAY_PUC = 0,  
    DAY_SALES = 0,  
    SETT_PURCH = 0,  
    SETT_SALES = 0,  
    SELL_BUY = CASE WHEN SELL_OPEN_QTY > 0 THEN 2 ELSE 1 END,  
    SETTFLAG =  CASE WHEN SELL_OPEN_QTY > 0 THEN 5 ELSE 4 END,  
    BROKAPPLIED = 0,  
    NETRATE = 0,  
    AMOUNT = 0,  
    INS_CHRG = 0,  
    TURN_TAX = 0,  
    OTHER_CHRG = 0,  
    SEBI_TAX = 0,  
    BROKER_CHRG = 0,  
    SERVICE_TAX = 0,  
    TRADE_AMOUNT = (BUY_OPEN_VAL + SELL_OPEN_VAL),  
    BILLFLAG = 0,  
    SETT_NO = 0,  
    NBROKAPP = 0,  
    NSERTAX = 0,  
    N_NETRATE = 0,  
    SETT_TYPE = 0,  
    CL_RATE = 0,  
    PARTICIPANTCODE=MEMBERCODE,  
    STATUS = 'M',  
    CPID = '0',  
    INSTRUMENT = 0,  
    BOOKTYPE = 0,  
    BRANCH_ID = CASE WHEN MEMBERTYPE ='TM' THEN '' ELSE PARTY_CODE END,  
    TMARK = 0,  
    SCHEME = 0,  
    DUMMY1 = 0,  
    DUMMY2 = 0,   
    RESERVED1 = 0,  
    RESERVED2 = 0  
   FROM  
    FOCORPACTPOSITION S, FOOWNER  
   WHERE  
    TRADE_DATE LIKE  @FILEDATE + '%'  
    AND SYMBOL = @SYMBOL  
    AND TRADETYPE = 'BT'  
    AND SELL_OPEN_QTY + BUY_OPEN_QTY > 0  
     
   UPDATE  
    FOSETTCORPACT   
   SET   
    PRICE = FOCLOSING.CL_RATE   
   FROM  
    FOCLOSING   
   WHERE  
    TRADE_DATE LIKE @FILEDATE + '%'  
    AND FOSETTCORPACT.SAUDA_DATE LIKE @SAUDA_DATE +'%'  
    AND FOCLOSING.INST_TYPE = FOSETTCORPACT.INST_TYPE  
    AND FOCLOSING.SYMBOL = FOSETTCORPACT.SYMBOL  
    AND CONVERT(VARCHAR,FOCLOSING.EXPIRYDATE,103) = CONVERT(VARCHAR,FOSETTCORPACT.EXPIRYDATE,103)  
    AND FOCLOSING.INST_TYPE LIKE 'FUT%'  
    AND FOSETTCORPACT.SYMBOL = @SYMBOL  
    AND STATUS = 'A'   
    
    UPDATE  
     FOSETTCORPACT   
    SET   
     TRADE_AMOUNT = (TRADEQTY*PRICE),
     BOOKTYPE = 1,
     INSTRUMENT = 1
    WHERE  
     SAUDA_DATE LIKE @SAUDA_DATE + '%'  
     AND INST_TYPE LIKE 'FUT%'  
     AND SYMBOL = @SYMBOL
     AND STATUS = 'A'      
  
   SELECT @ADJFACTOR1 = BTQTY/BFQTY  
   FROM  
   (  
      SELECT    
        BFQTY  = SUM(BUY_OPEN_QTY+SELL_OPEN_QTY)  
      FROM    
        FOCORPACTPOSITION    
      WHERE    
        TRADE_DATE LIKE @FILEDATE + '%'    
        AND TRADETYPE = 'BF'    
        AND SYMBOL = @SYMBOL  
    ) BFTRAD,  
   (   
      SELECT    
        BTQTY  = SUM(BUY_OPEN_QTY+SELL_OPEN_QTY)  
      FROM    
        FOCORPACTPOSITION    
      WHERE    
        TRADE_DATE LIKE @FILEDATE + '%'    
        AND TRADETYPE = 'BT'    
        AND SYMBOL = @SYMBOL  
   ) BTTRAD  
    
   END  
  ELSE  
   BEGIN  
    /*RATIO BASED METHOD*/  
    INSERT INTO FOSETTCORPACT  
    SELECT   
     '0',CASE WHEN @INTVBBSTAT > 0 THEN @OLDLOTSIZE ELSE 0 END,'0',PARTY_CODE,INST_TYPE,@SYMBOL,  
     @SYMBOL+UPPER(LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),3))+'  '+LEFT(INST_TYPE,3),EXPIRYDATE,  
     STRIKE_PRICE,OPTION_TYPE,'0','1','C','',  
     TRADEQTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END)),  
     'CA',1,0,'0',0,@SAUDA_DATE + ' 8:00 PM','0','0','P',0,0,0,0,0,  
     SELL_BUY = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 2 ELSE 1 END),  
     SETTFLAG = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 5 ELSE 4 END),  
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,      
     PARTICIPANTCODE,'A','0',0,0,  
     BRANCH_ID = CASE WHEN MEMBERTYPE ='TM' THEN '' ELSE BRANCH_ID END ,0,0,0,0,0,0      
    FROM  
     FOSETTLEMENT , FOOWNER  
    WHERE  
     SAUDA_DATE <= @FILEDATE + ' 23:59'  
     AND EXPIRYDATE >= @FILEDATE + ' 23:59:59'  
     AND SYMBOL = @SYMBOL  
     AND RESERVED1 <> 1  
    GROUP BY  
     PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
     PARTICIPANTCODE, CASE WHEN MEMBERTYPE ='TM' THEN '' ELSE BRANCH_ID END  
    HAVING   
     SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) <> 0  
      
    INSERT INTO FOSETTCORPACT  
    SELECT   
     '0',CASE WHEN @INTVBBSTAT > 0 THEN @NEWLOTSIZE ELSE 0 END,'0',PARTY_CODE,INST_TYPE,@SYMBOL,  
     @SYMBOL+UPPER(LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),3))+'  '+LEFT(INST_TYPE,3),EXPIRYDATE,  
     ((FLOOR(((STRIKE_PRICE * @ADJFACTOR2/@ADJFACTOR1)*POWER(10,2) + 5 + -2.5 )/(5 + 0))*(5+0))/POWER(10,2)),  
     OPTION_TYPE,'0','1','O','',  
     TRADEQTY = ABS(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END)* @NEWLOTSIZE/@OLDLOTSIZE),  
     'CA',1,0,'0',0,@SAUDA_DATE + ' 8:00 AM','0','0','V',0,0,0,0,0,  
     SELL_BUY = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 1 ELSE 2 END),  
     SETTFLAG = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 4 ELSE 5 END),  
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,      
     PARTICIPANTCODE,'M','0',0,0,  
     BRANCH_ID = CASE WHEN MEMBERTYPE ='TM' THEN '' ELSE BRANCH_ID END,0,0,0,0,0,0      
    FROM  
     FOSETTLEMENT,FOOWNER  
    WHERE  
     SAUDA_DATE <= @FILEDATE + ' 23:59'  
     AND EXPIRYDATE >= @FILEDATE + ' 23:59:59'  
     AND SYMBOL = @SYMBOL  
     AND RESERVED1 <> 1  
    GROUP BY  
     PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
     PARTICIPANTCODE, CASE WHEN MEMBERTYPE ='TM' THEN '' ELSE BRANCH_ID END  
    HAVING  
     SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) <> 0  
  
    UPDATE  
     FOSETTCORPACT   
    SET   
     PRICE = (CASE WHEN STATUS = 'A' THEN CL.CL_RATE ELSE ROUND(CL.CL_RATE*@ADJFACTOR2/@ADJFACTOR1,@ROUNDING) END),  
     DUMMY2= (CASE WHEN STATUS = 'A' THEN CL.CL_RATE ELSE ROUND(CL.CL_RATE*@ADJFACTOR2/@ADJFACTOR1,@ROUNDING) END),  
     NETRATE=(CASE WHEN STATUS = 'A' THEN CL.CL_RATE ELSE ROUND(CL.CL_RATE*@ADJFACTOR2/@ADJFACTOR1,@ROUNDING) END)
    FROM  
     FOCLOSING CL  
    WHERE  
     CL.TRADE_DATE LIKE @FILEDATE + '%'  
     AND CL.SYMBOL = FOSETTCORPACT.SYMBOL  
     AND CONVERT(VARCHAR,CL.EXPIRYDATE,103) = CONVERT(VARCHAR,FOSETTCORPACT.EXPIRYDATE,103)  
     AND CL.INST_TYPE = FOSETTCORPACT.INST_TYPE  
     AND CL.INST_TYPE LIKE 'FUT%'  
     AND SAUDA_DATE LIKE @SAUDA_DATE + '%'  
     AND FOSETTCORPACT.SYMBOL = @SYMBOL
	 AND STATUS = 'A' 

	UPDATE FOSETTCORPACT SET PRICE = F.PRICE
	FROM ( SELECT SYMBOL, EXPIRYDATE, 
	AMOUNT=SUM(CASE WHEN O_C_FLAG = 'C' THEN TRADEQTY*PRICE ELSE 0 END),
	QTY = SUM(CASE WHEN O_C_FLAG = 'C' THEN 0 ELSE TRADEQTY END),
	PRICE = SUM(CASE WHEN O_C_FLAG = 'C' THEN TRADEQTY*PRICE ELSE 0 END) /
		  SUM(CASE WHEN O_C_FLAG = 'C' THEN 0 ELSE TRADEQTY END)         		  
	FROM FOSETTCORPACT
	WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%' 
	AND INST_TYPE LIKE 'FUT%'
	AND SYMBOL = @SYMBOL
	GROUP BY SYMBOL, EXPIRYDATE ) F
	WHERE FOSETTCORPACT.SAUDA_DATE LIKE @SAUDA_DATE + '%' 
	AND FOSETTCORPACT.SYMBOL = F.SYMBOL
	AND LEFT(FOSETTCORPACT.EXPIRYDATE,11) = LEFT(F.EXPIRYDATE,11)
	AND O_C_FLAG = 'O'
	AND INST_TYPE LIKE 'FUT%'
	
    UPDATE  
     FOSETTCORPACT   
    SET   
     TRADE_AMOUNT = (TRADEQTY*PRICE)
    WHERE  
     SAUDA_DATE LIKE @SAUDA_DATE + '%'  
     AND INST_TYPE LIKE 'FUT%'  
     AND SYMBOL = @SYMBOL

   END  
  
  /*------------------------------------------------------------------------  
     UPDATING LOT SIZE AT SCRIP MASTER  
  --------------------------------------------------------------------------*/  
  UPDATE  
   FOSCRIP2  
  SET  
   C_REGULAR_LOT = @NEWLOTSIZE  
  WHERE  
   SYMBOL = @SYMBOL AND INST_TYPE LIKE 'FUT%'  
   AND EXPIRYDATE > @FILEDATE + ' 23:59'  
  
  
  IF @INTVBBSTAT > 0   
   BEGIN  
    UPDATE  
     FOSETTCORPACT   
    SET   
     BILLNO = C_REGULAR_LOT  
    FROM  
     FOSCRIP2   
    WHERE  
     FOSCRIP2.INST_TYPE = FOSETTCORPACT.INST_TYPE  
     AND FOSCRIP2.SYMBOL = FOSETTCORPACT.SYMBOL  
     AND LEFT(FOSCRIP2.EXPIRYDATE,11) = LEFT(FOSETTCORPACT.EXPIRYDATE,11)
     AND FOSCRIP2.STRIKE_PRICE = FOSETTCORPACT.STRIKE_PRICE   
     AND FOSCRIP2.OPTION_TYPE = FOSETTCORPACT.OPTION_TYPE   
     AND SAUDA_DATE LIKE @SAUDA_DATE + '%'  
     AND FOSETTCORPACT.SYMBOL = @SYMBOL  
     AND STATUS = 'M'  
   END  
    
  UPDATE  
   FOSETTCORPACT   
  SET   
   NETRATE = PRICE,  
   DUMMY2 = PRICE,  
   STATUS = 'E'  
  WHERE  
   SAUDA_DATE LIKE @SAUDA_DATE + '%'  
   AND SYMBOL = @SYMBOL  
    
  /*------------------------------------------------------------------------  
     TAKING THE RECORDS TO FOSETTLEMENT  
  --------------------------------------------------------------------------*/  
  
  
  UPDATE   
   FOSETTCORPACT  
  SET  
   TRADEQTY = ABS(TRADEQTY) , BOOKTYPE=1,INSTRUMENT=1
  WHERE  
   SAUDA_DATE LIKE @SAUDA_DATE + '%'  
   AND SYMBOL = @SYMBOL  
   AND TRADEQTY < 0  
  
    UPDATE  
     FOSETTCORPACT   
    SET   
     BILLNO = C_REGULAR_LOT 
    FROM  
     FOSCRIP2 (NOLOCK)  
    WHERE  
     FOSCRIP2.INST_TYPE = FOSETTCORPACT.INST_TYPE  
     AND FOSCRIP2.SYMBOL = FOSETTCORPACT.SYMBOL  
     AND LEFT(FOSCRIP2.EXPIRYDATE,11) = LEFT(FOSETTCORPACT.EXPIRYDATE,11)
     AND FOSCRIP2.STRIKE_PRICE = FOSETTCORPACT.STRIKE_PRICE   
     AND FOSCRIP2.OPTION_TYPE = FOSETTCORPACT.OPTION_TYPE   
     AND SAUDA_DATE LIKE @SAUDA_DATE + '%'  
     AND FOSETTCORPACT.SYMBOL = @SYMBOL    
  
  DECLARE @AMTMATCH  NUMERIC (18,4)  
  DECLARE @TOTALLOT NUMERIC (18,4)    
  
  SELECT   
	@AMTMATCH = SUM(CASE WHEN O_C_FLAG='C' THEN TRADE_AMOUNT ELSE 0 END) - 
				SUM(CASE WHEN O_C_FLAG='O' THEN TRADE_AMOUNT ELSE 0 END),  
	@TOTALLOT = SUM(CASE WHEN O_C_FLAG='O' THEN TRADEQTY ELSE 0 END) / @NEWLOTSIZE  
  FROM  
   FOSETTCORPACT  
  WHERE  
   SAUDA_DATE LIKE @SAUDA_DATE + '%'  
   AND SYMBOL = @SYMBOL  
    
  SET @STRRETURNFLAG = 0    /*DEFAULT OUTPUT*/  
  SET @STRRETURNMSG = 'UPDATED SUCCESSFULLY'  
  
  IF @TOTALLOT <> ROUND(@TOTALLOT,0) /*NEW QTY CHECK*/  
   BEGIN  
    SET @STRRETURNFLAG = 1  
    SET @STRRETURNMSG = 'CANNOT PROCEED. POST CORP. ACT. NO. OF LOT IS NOT PROPER ' + CONVERT(VARCHAR,@TOTALLOT)  
   END  
  
  IF @STRRETURNFLAG=0  /*CROSS CHECK NEW VALUE WITH OLD VALUE. NOT TO PROCEED*/  
   BEGIN  
    IF @AMTMATCH > 100  
    BEGIN  
     SET @STRRETURNFLAG = 1  
     SET @STRRETURNMSG = 'CANNOT PROCEED. DIFFERENCE IN CORP. ACT. PREVIOUS & POST VALUE AS ' + CONVERT(VARCHAR,@AMTMATCH)  
    END  
   END  
   
  IF @STRRETURNFLAG=0  /*CROSS CHECK NEW VALUE WITH OLD VALUE. CAN PROCEED*/  
   BEGIN  
    IF @AMTMATCH > 0  
    BEGIN  
     SET @STRRETURNFLAG = 0  
     SET @STRRETURNMSG = 'DIFFERENCE IN CORP. ACT. PREVIOUS & POST VALUE AS ' + CONVERT(VARCHAR,@AMTMATCH)  
    END  
   END  
     
  
  
  IF @STRRETURNFLAG=0 /*IF PROCEEDING*/    
   BEGIN  
    
    INSERT INTO  
     FOSETTLEMENT  
    SELECT * FROM  
     FOSETTCORPACT  
    WHERE  
     SYMBOL = @SYMBOL  
     AND AUCTIONPART = 'CA'  
     AND SAUDA_DATE LIKE @SAUDA_DATE + '%'    
   END  
  
  INSERT INTO FOCORPACTADJUSTMENT_LOG   
  (  
   FILE_DATE,SAUDA_DATE,SYMBOL,METHOD,ADJFACTORQTY,ADJFACTORPRICE,  
   OLDLOTSIZE,NEWLOTSIZE,ROUNDING,CREATEDBY,CREATEDON,NEWSYMBOL  
  )  
  VALUES  
  (  
   @FILEDATE,@SAUDA_DATE, @SYMBOL,  
    CASE WHEN @MODE  = 'UPDATE1' THEN 'POS' ELSE 'RATIO' END  
    + CASE WHEN @STRRETURNFLAG = 1 THEN '-ERR' ELSE '' END,  
   @ADJFACTOR1,@ADJFACTOR2,@OLDLOTSIZE,@NEWLOTSIZE,@ROUNDING,HOST_NAME( ),GETDATE(),''  
  )   
    
  SELECT @STRRETURNFLAG,@STRRETURNMSG  
  
    
  /*------------------------------------------------------------------------  
     COMMITTING THE CHANGES  
  --------------------------------------------------------------------------*/  
 END  
ELSE IF (@MODE = 'UPDATE3' ) /*CHANGE OF SYMBOL*/  
 BEGIN  
    
  SELECT  
   @FILEDATE = LEFT(MAX(TRADE_DATE),11)  
  FROM  
   FOCLOSING   
  WHERE  
   TRADE_DATE < @SAUDA_DATE  
  
  DELETE  
   FROM FOSETTCORPACT   
  WHERE  
   SYMBOL IN (@SYMBOL, @SYMBOLNEW)  
   AND SAUDA_DATE >= @SAUDA_DATE  
   AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
  
  DELETE  
   FROM FOSETTLEMENT   
  WHERE  
   SYMBOL IN (@SYMBOL, @SYMBOLNEW)  
   AND SAUDA_DATE >= @SAUDA_DATE  
   AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
   AND AUCTIONPART = 'CA'  
  
   INSERT INTO FOSETTCORPACT  
   SELECT   
    '0',MAX(BILLNO),'0',PARTY_CODE,INST_TYPE,@SYMBOL,  
    @SYMBOL+UPPER(LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),3))+'  '+LEFT(INST_TYPE,3),  
    EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,'0','1','C','',  
    TRADEQTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END)),  
    'CA',1,0,'0',0,@SAUDA_DATE + ' 8:00 PM','0','0','P',0,0,0,0,0,  
    SELL_BUY = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 2 ELSE 1 END),  
    SETTFLAG = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 5 ELSE 4 END),  
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,      
    PARTICIPANTCODE,'A',0,0,0,'',0,0,0,0,0,0      
   FROM  
    FOSETTLEMENT  
   WHERE  
    SAUDA_DATE <= @FILEDATE + ' 23:59'  
    AND EXPIRYDATE >= @FILEDATE + ' 23:59:59'  
    AND SYMBOL = @SYMBOL  
    AND RESERVED1 <> 1  
   GROUP BY  
    PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,PARTICIPANTCODE  
   HAVING  
    SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) <> 0     
  
   INSERT INTO FOSETTCORPACT  
   SELECT   
    '0',MAX(BILLNO),'0',PARTY_CODE,INST_TYPE,@SYMBOLNEW,  
    @SYMBOLNEW+UPPER(LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),3))+'  '+LEFT(INST_TYPE,3),EXPIRYDATE,  
    STRIKE_PRICE,OPTION_TYPE,'0','1','O','',  
    TRADEQTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END)),  
    'CA',1,0,'0',0,@SAUDA_DATE + ' 8:00 AM','0','0','V',0,0,0,0,0,  
    SELL_BUY = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 1 ELSE 2 END),  
    SETTFLAG = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 4 ELSE 5 END),  
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,      
    PARTICIPANTCODE,'M',0,0,0,'',0,0,0,0,0,0      
   FROM  
    FOSETTLEMENT  
   WHERE  
    SAUDA_DATE <= @FILEDATE + ' 23:59'  
    AND EXPIRYDATE >= @FILEDATE + ' 23:59:59'  
    AND SYMBOL = @SYMBOL  
    AND RESERVED1 <> 1  
   GROUP BY  
    PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
    PARTICIPANTCODE  
   HAVING SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) <> 0  
  
   UPDATE  
    FOSETTCORPACT  
   SET   
    PRICE =  CL.CL_RATE,  
    DUMMY2=  CL.CL_RATE,  
    NETRATE= CL.CL_RATE  
   FROM  
    FOCLOSING CL  
   WHERE  
    CL.SYMBOL = @SYMBOL  
    AND FOSETTCORPACT.SYMBOL IN (@SYMBOL, @SYMBOLNEW)  
    AND LEFT(CL.EXPIRYDATE,11)  = LEFT(FOSETTCORPACT.EXPIRYDATE,11)  
    AND CL.INST_TYPE = FOSETTCORPACT.INST_TYPE  
    AND CL.INST_TYPE LIKE 'FUT%'  
    AND CL.TRADE_DATE LIKE @FILEDATE + '%'  
     
   UPDATE  
    FOSETTCORPACT  
   SET STATUS = 'E' ,
   BOOKTYPE=1,INSTRUMENT=1  
   WHERE  
    SYMBOL IN (@SYMBOL, @SYMBOLNEW)  
    AND AUCTIONPART = 'CA'  
    AND SAUDA_DATE >= @SAUDA_DATE  
    AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
     
   INSERT  
    INTO FOSETTLEMENT  
   SELECT * FROM   
    FOSETTCORPACT  
   WHERE  
    SYMBOL IN (@SYMBOL, @SYMBOLNEW)  
    AND AUCTIONPART = 'CA'  
    AND SAUDA_DATE >= @SAUDA_DATE  
    AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
  
   INSERT INTO FOCORPACTADJUSTMENT_LOG   
    (  
     FILE_DATE,SAUDA_DATE,SYMBOL,METHOD,ADJFACTORQTY,ADJFACTORPRICE,  
     OLDLOTSIZE,NEWLOTSIZE,ROUNDING,CREATEDBY,CREATEDON,NEWSYMBOL  
    )  
   VALUES   
    (  
     @FILEDATE,@SAUDA_DATE,@SYMBOL,'NAMECHANGE',1,1,1,1,1,HOST_NAME(),GETDATE(),  
     @SYMBOLNEW  
    )  
 END  
ELSE IF (@MODE = 'UPDATE4' ) /*DIVIDEND*/  
 BEGIN  

		DELETE FROM FOSETTCORPACT 
		WHERE SYMBOL = @SYMBOL
		AND SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'

		DELETE FROM FOSETTLEMENT 
		WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
		AND SYMBOL = @SYMBOL
		AND AUCTIONPART = 'CA'


		INSERT INTO FOSETTCORPACT
		SELECT 
		'0','0','0',PARTY_CODE,INST_TYPE,@SYMBOL,@SYMBOL+UPPER(LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),3))+'  '+LEFT(INST_TYPE,3),EXPIRYDATE,
		STRIKE_PRICE,OPTION_TYPE,'0','1','C','',
		TRADEQTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END)),
		'CA',1,0,'0',0,@SAUDA_DATE + ' 8:00 PM','0','0','V',0,0,0,0,0,
		SELL_BUY = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 2 ELSE 1 END),
		SETTFLAG = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 5 ELSE 4 END),
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,    
		PARTICIPANTCODE,'A',0,0,0,'',0,0,0,0,0,0    
		FROM FOSETTLEMENT
		WHERE SAUDA_DATE <= @SAUDA_DATE 
		AND EXPIRYDATE >= @SAUDA_DATE
		AND SYMBOL = @SYMBOL
		AND RESERVED1 <> 1
		GROUP BY PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,PARTICIPANTCODE
		HAVING SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) <> 0

		INSERT INTO FOSETTCORPACT
		SELECT 
		'0','0','0',PARTY_CODE,INST_TYPE,@SYMBOL,@SYMBOL+UPPER(LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),3))+'  '+LEFT(INST_TYPE,3),EXPIRYDATE,
		STRIKE_PRICE = CASE WHEN LEFT(INST_TYPE,3) ='OPT' THEN STRIKE_PRICE - @ADJFACTOR1 ELSE 0 END, OPTION_TYPE,'0','1','O','',
		TRADEQTY=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END)),
		'CA',1,0,'0',0,@SAUDA_DATE + ' 8:00 AM','0','0','V',0,0,0,0,0,
		SELL_BUY = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 1 ELSE 2 END),
		SETTFLAG = (CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) > 0 THEN 4 ELSE 5 END),
		0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,    
		PARTICIPANTCODE,'M',0,0,0,'',0,0,0,0,0,0    
		FROM FOSETTLEMENT
		WHERE SAUDA_DATE <= @SAUDA_DATE
		AND EXPIRYDATE >= @SAUDA_DATE
		AND SYMBOL = @SYMBOL
		AND RESERVED1 <> 1
		GROUP BY PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,PARTICIPANTCODE
		HAVING SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE -TRADEQTY END) <> 0

		UPDATE FOSETTCORPACT SET 
		PRICE = (CASE WHEN STATUS = 'A' THEN CL.CL_RATE ELSE ROUND(CL.CL_RATE-@ADJFACTOR1,4) END),
		DUMMY2= (CASE WHEN STATUS = 'A' THEN CL.CL_RATE ELSE ROUND(CL.CL_RATE-@ADJFACTOR1,4) END),
		NETRATE=(CASE WHEN STATUS = 'A' THEN CL.CL_RATE ELSE ROUND(CL.CL_RATE-@ADJFACTOR1,4) END)
		FROM FOCLOSING CL
		WHERE CL.SYMBOL = FOSETTCORPACT.SYMBOL
		AND LEFT(CL.EXPIRYDATE,11) = LEFT(FOSETTCORPACT.EXPIRYDATE,11)
		AND CL.INST_TYPE = FOSETTCORPACT.INST_TYPE
		AND LEFT(CL.INST_TYPE,3) = 'FUT'
		AND CL.TRADE_DATE = (SELECT MAX(TRADE_DATE) FROM FOCLOSING (NOLOCK)
						WHERE TRADE_DATE < @SAUDA_DATE AND LEFT(INST_TYPE,3) ='FUT' )

		UPDATE FOSETTCORPACT SET STATUS = 'E' 

		INSERT INTO FOSETTLEMENT
		SELECT * FROM FOSETTCORPACT
		WHERE SYMBOL = @SYMBOL
		AND SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'


		INSERT INTO FOCORPACTADJUSTMENT_LOG   
		(  
			FILE_DATE,SAUDA_DATE,SYMBOL,METHOD,ADJFACTORQTY,ADJFACTORPRICE,  
			OLDLOTSIZE,NEWLOTSIZE,ROUNDING,CREATEDBY,CREATEDON,NEWSYMBOL  
		)  
		VALUES (@FILEDATE,@SAUDA_DATE, @SYMBOL,'DIVIDEND',@ADJFACTOR1,@ADJFACTOR2,@OLDLOTSIZE,@NEWLOTSIZE,@ROUNDING,HOST_NAME( ),GETDATE(),'' )   

 
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_FOMARGIN_PENALTY_POST
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[PR_FOMARGIN_PENALTY_POST]
(
	@MARGIN_DATE VARCHAR(11),
	@POSTINGFLAG INT,
	@LEDGERVNO VARCHAR(12),
	@LEDGERVT VARCHAR(11),
	@UNAME VARCHAR(20),
	@LEDGERDT VARCHAR(11)
)
AS

DECLARE @GLCODE VARCHAR(10)
SELECT @GLCODE = ACCODE FROM VALANACCOUNT (NOLOCK) WHERE ACNAME ='MARGIN_SHORTAGE_PENALTY'

IF ISNULL(@GLCODE,'') =''
BEGIN
	 RAISERROR('GL CODE FOR - MARGIN_SHORTAGE_PENALTY IS NOT AVAILABLE', 16, 1)
	 RETURN
END

BEGIN TRAN

IF @POSTINGFLAG = 1
BEGIN
	DELETE ACCOUNTCURBFO.DBO.LEDGER WHERE VDT BETWEEN @LEDGERVT AND @LEDGERVT + ' 23:59'
	AND VTYP = '8' AND BOOKTYPE ='01'
	AND VNO = @LEDGERVNO

	DELETE ACCOUNTCURBFO.DBO.LEDGER2 WHERE VTYPE = '8' AND BOOKTYPE ='01'
	AND VNO = @LEDGERVNO

	DELETE ACCOUNTCURBFO.DBO.LEDGER3 WHERE VTYP = '8' AND BOOKTYPE ='01'
	AND VNO = @LEDGERVNO
END

UPDATE FOMARGIN_PENALTY_POST_STAT SET POST_FLAG =0 WHERE MARGIN_DATE = @MARGIN_DATE

EXEC ACCOUNTCURBFO.DBO.FOMARGIN_PENALTY_POST @UNAME,8,'01',@MARGIN_DATE,@GLCODE,@LEDGERVNO,@LEDGERDT

COMMIT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_IMPORT_CLOSING_FILE
-- --------------------------------------------------
CREATE PROC [dbo].[PR_IMPORT_CLOSING_FILE] 
(
	@SESSIONID VARCHAR(20),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT 
) AS

TRUNCATE TABLE FOCLOSING_IMP

IF @INTMODE=1
BEGIN

	INSERT INTO FOCLOSING_IMP
	SELECT
		TRADE_DATE = @SAUDA_DATE,
		MARKET_TYPE = DBO.PIECE(FILE_DATA,',',1),
		INST_TYPE = DBO.PIECE(FILE_DATA,',',2),
		SYMBOL = DBO.PIECE(FILE_DATA,',',3),
		EXPIRYDATE = LEFT(CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',4),103),11) + ' 23:59',
		STRIKE_PRICE = CASE WHEN DBO.PIECE(FILE_DATA,',',6) = '' THEN '0' ELSE DBO.PIECE(FILE_DATA,',',5) END,
		OPTION_TYPE = DBO.PIECE(FILE_DATA,',',6),
		RESERVED = 0,
		PRV_CL_RATE = DBO.PIECE(FILE_DATA,',',8),
		OPEN_PRICE = DBO.PIECE(FILE_DATA,',',9),
		HIGH_PRICE = DBO.PIECE(FILE_DATA,',',10),
		LOW_PRICE = DBO.PIECE(FILE_DATA,',',11),
		CL_RATE = DBO.PIECE(FILE_DATA,',',12),
		TOTAL_TRD_QTY = DBO.PIECE(FILE_DATA,',',13),
		TOTAL_TRD_VALUE = DBO.PIECE(FILE_DATA,',',14),
		OPEN_INTEREST = DBO.PIECE(FILE_DATA,',',15),
		CHANGEIN_OPEN_INTEREST = DBO.PIECE(FILE_DATA,',',16)
	FROM CLASSFILEUPD
	WHERE
		SESSION_ID= @SESSIONID
		AND DBO.PIECE(FILE_DATA,',',5) <> 'COM'
END
ELSE
BEGIN

	INSERT INTO FOCLOSING_IMP
	SELECT 	
		TRADE_DATE = @SAUDA_DATE,
		MARKET_TYPE = DBO.PIECE(FILEDATA,',',1),
		INST_TYPE = DBO.PIECE(FILEDATA,',',2),
		SYMBOL = DBO.PIECE(FILEDATA,',',3),
		EXPIRYDATE = LEFT(CONVERT(DATETIME,DBO.PIECE(FILEDATA,',',4),103),11) + ' 23:59',
		STRIKE_PRICE = CASE WHEN DBO.PIECE(FILEDATA,',',6) = '' THEN '0' ELSE DBO.PIECE(FILEDATA,',',5) END,
		OPTION_TYPE = DBO.PIECE(FILEDATA,',',6),
		RESERVED = 0,
		PRV_CL_RATE = DBO.PIECE(FILEDATA,',',8),
		OPEN_PRICE = DBO.PIECE(FILEDATA,',',9),
		HIGH_PRICE = DBO.PIECE(FILEDATA,',',10),
		LOW_PRICE = DBO.PIECE(FILEDATA,',',11),
		CL_RATE = DBO.PIECE(FILEDATA,',',12),
		TOTAL_TRD_QTY = DBO.PIECE(FILEDATA,',',13),
		TOTAL_TRD_VALUE = DBO.PIECE(FILEDATA,',',14),
		OPEN_INTEREST = DBO.PIECE(FILEDATA,',',15),
		CHANGEIN_OPEN_INTEREST = DBO.PIECE(FILEDATA,',',16)
	FROM CLASSFILEUPD_BULK
	WHERE
		SPID= @@SPID
		AND DBO.PIECE(FILEDATA,',',5) <> 'COM'
END

UPDATE FOCLOSING_IMP SET OPTION_TYPE ='' WHERE STRIKE_PRICE = 0

DELETE FOCLOSING WHERE TRADE_DATE = @SAUDA_DATE
			
			
INSERT INTO FOCLOSING
SELECT *,@UNAME,GETDATE() FROM FOCLOSING_IMP WHERE INST_TYPE <> 'COM'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_IMPORT_CONTRACT_FILE
-- --------------------------------------------------


CREATE PROC [dbo].[PR_IMPORT_CONTRACT_FILE] 
(
	@SESSIONID VARCHAR(20),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT 
) AS

TRUNCATE TABLE FOSCRIP_IMP

IF @INTMODE=1
BEGIN

	INSERT INTO FOSCRIP_IMP
	SELECT 	
		CONTRACT_ID = DBO.PIECE(FILE_DATA,',',1),
		TOCKEN_NO = DBO.PIECE(FILE_DATA,',',2),
		INST_TYPE = DBO.PIECE(FILE_DATA,',',3),
		SYMBOL = DBO.PIECE(FILE_DATA,',',4),
		FILLER1 = DBO.PIECE(FILE_DATA,',',5),
		FILLER2 = DBO.PIECE(FILE_DATA,',',6),
		EXPIRYDATE = DBO.PIECE(FILE_DATA,',',7),
		STRIKE_PRICE = DBO.PIECE(FILE_DATA,',',8),
		OPTION_TYPE = DBO.PIECE(FILE_DATA,',',9),
		PRECISION = DBO.PIECE(FILE_DATA,',',10),
		FILLER3 = DBO.PIECE(FILE_DATA,',',11),
		FILLER4 = DBO.PIECE(FILE_DATA,',',12),
		PARTITION_ID = DBO.PIECE(FILE_DATA,',',13),
		FILLER5 = DBO.PIECE(FILE_DATA,',',14),
		FILLER6 = DBO.PIECE(FILE_DATA,',',15),
		FILLER7 = DBO.PIECE(FILE_DATA,',',16),
		FILLER8 = DBO.PIECE(FILE_DATA,',',17),
		FILLER9 = DBO.PIECE(FILE_DATA,',',18),
		FILLER10 = DBO.PIECE(FILE_DATA,',',19),
		FILLER11 = DBO.PIECE(FILE_DATA,',',20),
		FILLER12 = DBO.PIECE(FILE_DATA,',',21),
		FILLER13 = DBO.PIECE(FILE_DATA,',',22),
		FILLER14 = DBO.PIECE(FILE_DATA,',',23),
		FILLER15 = DBO.PIECE(FILE_DATA,',',24),
		FILLER16 = DBO.PIECE(FILE_DATA,',',25),
		FILLER17 = DBO.PIECE(FILE_DATA,',',26),
		CONTRAT_STARTDATE = DBO.PIECE(FILE_DATA,',',27),
		SETTLEMENT_DATE = DBO.PIECE(FILE_DATA,',',28),
		PRODUCT_ID = DBO.PIECE(FILE_DATA,',',29),
		FILLER18 = DBO.PIECE(FILE_DATA,',',30),
		MIN_LOT_SIZE = DBO.PIECE(FILE_DATA,',',31),
		LOT_SIZE = DBO.PIECE(FILE_DATA,',',32),
		TICK_SIZE = DBO.PIECE(FILE_DATA,',',33),
		FILLER19 = DBO.PIECE(FILE_DATA,',',34),
		FILLER20 = DBO.PIECE(FILE_DATA,',',35),
		FILLER21 = DBO.PIECE(FILE_DATA,',',36),
		INSTRUMENT_ID = DBO.PIECE(FILE_DATA,',',37),
		FILLER22 = DBO.PIECE(FILE_DATA,',',38),
		FILLER23 = DBO.PIECE(FILE_DATA,',',39),
		FILLER24 = DBO.PIECE(FILE_DATA,',',40),
		FILLER25 = DBO.PIECE(FILE_DATA,',',41),
		FILLER26 = DBO.PIECE(FILE_DATA,',',42),
		FILLER27 = DBO.PIECE(FILE_DATA,',',43),
		FILLER28 = DBO.PIECE(FILE_DATA,',',44),
		FILLER29 = DBO.PIECE(FILE_DATA,',',45),
		FILLER30 = DBO.PIECE(FILE_DATA,',',46),
		FILLER31 = DBO.PIECE(FILE_DATA,',',47),
		FILLER32 = DBO.PIECE(FILE_DATA,',',48),
		EXERCISE_START_DATE = DBO.PIECE(FILE_DATA,',',49),
		EXERCISE_END_DATE = DBO.PIECE(FILE_DATA,',',50),
		FILLER33 = DBO.PIECE(FILE_DATA,',',51),
		QTY_MULTIPLIER = DBO.PIECE(FILE_DATA,',',52),
		FILLER34 = DBO.PIECE(FILE_DATA,',',53),
		INSTRUMENT_NAME = DBO.PIECE(FILE_DATA,',',54),
		FILLER35 = DBO.PIECE(FILE_DATA,',',55),
		FILLER36 = DBO.PIECE(FILE_DATA,',',56),
		FILLER37 = DBO.PIECE(FILE_DATA,',',57),
		UNDERLYING_MARKET = DBO.PIECE(FILE_DATA,',',58),
		FILLER38 = DBO.PIECE(FILE_DATA,',',59),
		CONTRACT_TYPE = DBO.PIECE(FILE_DATA,',',60),
		FILLER39 = DBO.PIECE(FILE_DATA,',',61),
		FILLER40 = DBO.PIECE(FILE_DATA,',',62),
		FILLER41 = DBO.PIECE(FILE_DATA,',',63),
		FILLER42 = DBO.PIECE(FILE_DATA,',',64),
		FILLER43 = DBO.PIECE(FILE_DATA,',',65),
		FILLER44 = DBO.PIECE(FILE_DATA,',',66),
		FILLER45 = DBO.PIECE(FILE_DATA,',',67),
		BASE_PRICE = DBO.PIECE(FILE_DATA,',',68),
		DELETE_FLAG = DBO.PIECE(FILE_DATA,',',69)
	FROM CLASSFILEUPD
	WHERE
		SESSION_ID= @SESSIONID
		AND DBO.PIECE(FILE_DATA,',',3) <> ''
END
ELSE
BEGIN

	INSERT INTO FOSCRIP_IMP
	SELECT 	
		CONTRACT_ID = DBO.PIECE(FILEDATA,',',1),
		TOCKEN_NO = DBO.PIECE(FILEDATA,',',2),
		INST_TYPE = DBO.PIECE(FILEDATA,',',3),
		SYMBOL = DBO.PIECE(FILEDATA,',',4),
		FILLER1 = DBO.PIECE(FILEDATA,',',5),
		FILLER2 = DBO.PIECE(FILEDATA,',',6),
		EXPIRYDATE = DBO.PIECE(FILEDATA,',',7),
		STRIKE_PRICE = DBO.PIECE(FILEDATA,',',8),
		OPTION_TYPE = DBO.PIECE(FILEDATA,',',9),
		PRECISION = DBO.PIECE(FILEDATA,',',10),
		FILLER3 = DBO.PIECE(FILEDATA,',',11),
		FILLER4 = DBO.PIECE(FILEDATA,',',12),
		PARTITION_ID = DBO.PIECE(FILEDATA,',',13),
		FILLER5 = DBO.PIECE(FILEDATA,',',14),
		FILLER6 = DBO.PIECE(FILEDATA,',',15),
		FILLER7 = DBO.PIECE(FILEDATA,',',16),
		FILLER8 = DBO.PIECE(FILEDATA,',',17),
		FILLER9 = DBO.PIECE(FILEDATA,',',18),
		FILLER10 = DBO.PIECE(FILEDATA,',',19),
		FILLER11 = DBO.PIECE(FILEDATA,',',20),
		FILLER12 = DBO.PIECE(FILEDATA,',',21),
		FILLER13 = DBO.PIECE(FILEDATA,',',22),
		FILLER14 = DBO.PIECE(FILEDATA,',',23),
		FILLER15 = DBO.PIECE(FILEDATA,',',24),
		FILLER16 = DBO.PIECE(FILEDATA,',',25),
		FILLER17 = DBO.PIECE(FILEDATA,',',26),
		CONTRAT_STARTDATE = DBO.PIECE(FILEDATA,',',27),
		SETTLEMENT_DATE = DBO.PIECE(FILEDATA,',',28),
		PRODUCT_ID = DBO.PIECE(FILEDATA,',',29),
		FILLER18 = DBO.PIECE(FILEDATA,',',30),
		MIN_LOT_SIZE = DBO.PIECE(FILEDATA,',',31),
		LOT_SIZE = DBO.PIECE(FILEDATA,',',32),
		TICK_SIZE = DBO.PIECE(FILEDATA,',',33),
		FILLER19 = DBO.PIECE(FILEDATA,',',34),
		FILLER20 = DBO.PIECE(FILEDATA,',',35),
		FILLER21 = DBO.PIECE(FILEDATA,',',36),
		INSTRUMENT_ID = DBO.PIECE(FILEDATA,',',37),
		FILLER22 = DBO.PIECE(FILEDATA,',',38),
		FILLER23 = DBO.PIECE(FILEDATA,',',39),
		FILLER24 = DBO.PIECE(FILEDATA,',',40),
		FILLER25 = DBO.PIECE(FILEDATA,',',41),
		FILLER26 = DBO.PIECE(FILEDATA,',',42),
		FILLER27 = DBO.PIECE(FILEDATA,',',43),
		FILLER28 = DBO.PIECE(FILEDATA,',',44),
		FILLER29 = DBO.PIECE(FILEDATA,',',45),
		FILLER30 = DBO.PIECE(FILEDATA,',',46),
		FILLER31 = DBO.PIECE(FILEDATA,',',47),
		FILLER32 = DBO.PIECE(FILEDATA,',',48),
		EXERCISE_START_DATE = DBO.PIECE(FILEDATA,',',49),
		EXERCISE_END_DATE = DBO.PIECE(FILEDATA,',',50),
		FILLER33 = DBO.PIECE(FILEDATA,',',51),
		QTY_MULTIPLIER = DBO.PIECE(FILEDATA,',',52),
		FILLER34 = DBO.PIECE(FILEDATA,',',53),
		INSTRUMENT_NAME = DBO.PIECE(FILEDATA,',',54),
		FILLER35 = DBO.PIECE(FILEDATA,',',55),
		FILLER36 = DBO.PIECE(FILEDATA,',',56),
		FILLER37 = DBO.PIECE(FILEDATA,',',57),
		UNDERLYING_MARKET = DBO.PIECE(FILEDATA,',',58),
		FILLER38 = DBO.PIECE(FILEDATA,',',59),
		CONTRACT_TYPE = DBO.PIECE(FILEDATA,',',60),
		FILLER39 = DBO.PIECE(FILEDATA,',',61),
		FILLER40 = DBO.PIECE(FILEDATA,',',62),
		FILLER41 = DBO.PIECE(FILEDATA,',',63),
		FILLER42 = DBO.PIECE(FILEDATA,',',64),
		FILLER43 = DBO.PIECE(FILEDATA,',',65),
		FILLER44 = DBO.PIECE(FILEDATA,',',66),
		FILLER45 = DBO.PIECE(FILEDATA,',',67),
		BASE_PRICE = DBO.PIECE(FILEDATA,',',68),
		DELETE_FLAG = DBO.PIECE(FILEDATA,',',69)
	FROM CLASSFILEUPD_BULK
	WHERE
		SPID= @@SPID
		AND DBO.PIECE(FILEDATA,',',3) <> ''
END

UPDATE FOSCRIP_IMP SET STRIKE_PRICE = STRIKE_PRICE / 10000000 ,
EXPIRYDATE=LEFT(CONVERT(DATETIME,EXPIRYDATE),11) + ' 23:59'

DELETE FOSCRIP2 FROM
	FOSCRIP_IMP
WHERE
	FOSCRIP_IMP.INST_TYPE = FOSCRIP2.INST_TYPE AND
	FOSCRIP_IMP.SYMBOL = FOSCRIP2.SYMBOL AND
	LEFT(CONVERT(DATETIME,FOSCRIP_IMP.EXPIRYDATE),11) = LEFT(FOSCRIP2.EXPIRYDATE,11) AND
	CONVERT(MONEY,FOSCRIP_IMP.STRIKE_PRICE) = FOSCRIP2.STRIKE_PRICE AND
	FOSCRIP_IMP.OPTION_TYPE = FOSCRIP2.OPTION_TYPE
	
DELETE CONTRACT_MST FROM
	FOSCRIP_IMP
WHERE
	FOSCRIP_IMP.INST_TYPE = CONTRACT_MST.INST_TYPE AND
	FOSCRIP_IMP.SYMBOL = CONTRACT_MST.SYMBOL AND
	FOSCRIP_IMP.EXPIRYDATE = CONTRACT_MST.EXPIRYDATE AND
	FOSCRIP_IMP.STRIKE_PRICE = CONTRACT_MST.STRIKE_PRICE AND
	FOSCRIP_IMP.OPTION_TYPE = CONTRACT_MST.OPTION_TYPE
	
DELETE FOSCRIP2 FROM
	FOSCRIP_IMP
WHERE
	FOSCRIP_IMP.INST_TYPE = FOSCRIP2.INST_TYPE AND
	FOSCRIP_IMP.SYMBOL = FOSCRIP2.SYMBOL AND
	FOSCRIP_IMP.EXPIRYDATE = FOSCRIP2.EXPIRYDATE AND
	FOSCRIP_IMP.STRIKE_PRICE = FOSCRIP2.STRIKE_PRICE AND
	FOSCRIP_IMP.OPTION_TYPE = FOSCRIP2.OPTION_TYPE
	
INSERT INTO CONTRACT_MST
SELECT *,@SESSIONID,GETDATE() FROM FOSCRIP_IMP

INSERT INTO FOSCRIP2
SELECT 
	INST_TYPE,
	SYMBOL,
	SEC_NAME= LEFT(INST_TYPE + SYMBOL + LEFT(EXPIRYDATE,11) + ' ' + OPTION_TYPE + CONVERT(VARCHAR,STRIKE_PRICE),25),
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE = CASE WHEN STRIKE_PRICE =0 THEN '' ELSE OPTION_TYPE END,
--	MATURITYDATE=LEFT(CONVERT(DATETIME,SETTLEMENT_DATE),11) + ' 23:59', Change on 10-10-2014
	MATURITYDATE=LEFT(CONVERT(DATETIME,EXERCISE_START_DATE),11) + ' 23:59',
	C_REGUKAR_LOT = QTY_MULTIPLIER
FROM FOSCRIP_IMP

/*------------------------------------------------------ END OF THE PROC -------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_IMPORT_FILE
-- --------------------------------------------------

CREATE PROC [dbo].[PR_IMPORT_FILE] 
(
	@FILETYPE VARCHAR(20),
	@SESSIONID VARCHAR(20),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT 
) AS 

IF @FILETYPE = 'CONTRACT MASTER'
BEGIN
	EXEC PR_IMPORT_CONTRACT_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @INTMODE 
	EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CNTMST','',@UNAME,''
END


IF @FILETYPE = 'TRADE'
BEGIN
	EXEC PR_IMPORT_TRADE_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @INTMODE 
END


IF @FILETYPE = 'CLOSING RATE'
BEGIN
	EXEC PR_IMPORT_CLOSING_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @INTMODE 
	EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CLOSING','',@UNAME,''
END


IF @FILETYPE = 'POSITION FILE'
BEGIN
	EXEC PR_IMPORT_POSITION_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @INTMODE 
	EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'POSIMP','',@UNAME,''
END



IF @FILETYPE = 'MARGIN FILE'
BEGIN
	EXEC PR_IMPORT_MARGIN_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @INTMODE 
	EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'MRGIMP','',@UNAME,''
END



IF @FILETYPE = 'STT FILE'
BEGIN
	EXEC PR_IMPORT_STT_FILE @SESSIONID, @UNAME, @SAUDA_DATE, @INTMODE 
	EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'CHKSTTIMP','',@UNAME,''
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_IMPORT_MARGIN_FILE
-- --------------------------------------------------


CREATE PROC [dbo].[PR_IMPORT_MARGIN_FILE] 
(
	@SESSIONID VARCHAR(20),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT
) AS


TRUNCATE TABLE FOMARGINNEW_IMP


IF @INTMODE=1
BEGIN

	INSERT INTO FOMARGINNEW_IMP
	SELECT  
		MDATE   = CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',1),3),
		CLIENT_TYPE = ISNULL( DBO.PIECE(FILE_DATA,',',7),''),
		PARTY_CODE   = DBO.PIECE(FILE_DATA,',',2),
		INTIAL_MARGIN   = DBO.PIECE(FILE_DATA,',',3),
		NET_BUY_PREMIUM   = DBO.PIECE(FILE_DATA,',',4),
		EXTREME_LOSS_MARGIN   = DBO.PIECE(FILE_DATA,',',5),
		TOTAL_MARGIN   = DBO.PIECE(FILE_DATA,',',6)
	FROM CLASSFILEUPD
	WHERE
		SESSION_ID= @SESSIONID	
		AND DBO.PIECE(FILE_DATA,',',1) <> ''

END
ELSE
BEGIN

	INSERT INTO FOMARGINNEW_IMP
	SELECT  
		MDATE   = CONVERT(DATETIME,DBO.PIECE(FILEDATA,',',1),3),
		CLIENT_TYPE = ISNULL( DBO.PIECE(FILEDATA,',',7),''),
		PARTY_CODE   = DBO.PIECE(FILEDATA,',',2),
		INTIAL_MARGIN   = DBO.PIECE(FILEDATA,',',3),
		NET_BUY_PREMIUM   = DBO.PIECE(FILEDATA,',',4),
		EXTREME_LOSS_MARGIN   = DBO.PIECE(FILEDATA,',',5),
		TOTAL_MARGIN   = DBO.PIECE(FILEDATA,',',6)
	FROM CLASSFILEUPD_BULK
		WHERE
			SPID= @@SPID	
			AND DBO.PIECE(FILEDATA,',',1) <> ''

END

IF (SELECT MEMBERTYPE FROM FOOWNER) ='CM'
BEGIN

	
   UPDATE FOMARGINNEW_IMP SET PARTY_CODE = FOTMINFO.PARTY_CODE   
   FROM  FOTMINFO (NOLOCK) WHERE FOTMINFO.PARTY_CODE = FOMARGINNEW_IMP.PARTY_CODE  
  
   UPDATE FOMARGINNEW_IMP SET PARTY_CODE = C2.PARTY_CODE   
   FROM  CLIENT2 C2 (NOLOCK) WHERE C2.BANKID = FOMARGINNEW_IMP.PARTY_CODE  
   AND FOMARGINNEW_IMP.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM FOTMINFO (NOLOCK))  
	
	SELECT 
		MDATE ,CLIENT_TYPE,PARTY_CODE,
		INTIAL_MARGIN   = SUM(INTIAL_MARGIN),
		NET_BUY_PREMIUM   = SUM(NET_BUY_PREMIUM),
		EXTREME_LOSS_MARGIN   = SUM(EXTREME_LOSS_MARGIN),
		TOTAL_MARGIN   = SUM(TOTAL_MARGIN)			
	INTO #FOMARGINNEW_IMP
	FROM FOMARGINNEW_IMP
	GROUP BY MDATE ,CLIENT_TYPE,PARTY_CODE

	TRUNCATE TABLE FOMARGINNEW_IMP
	INSERT INTO FOMARGINNEW_IMP
	SELECT * FROM #FOMARGINNEW_IMP

END


UPDATE FOMARGINNEW_IMP SET PARTY_CODE = NEWPARTY_CODE FROM PARTYMAPPING
WHERE PARTY_CODE = OLDPARTY_CODE

DELETE FOMARGINNEW
WHERE EXISTS (SELECT PARTY_CODE FROM FOMARGINNEW_IMP WHERE
		FOMARGINNEW_IMP.MDATE = FOMARGINNEW.MDATE) 
	
INSERT INTO FOMARGINNEW
SELECT *,@UNAME,GETDATE() FROM FOMARGINNEW_IMP


/*-------------------------------------------- END OF THE PROC ------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_IMPORT_POSITION_FILE
-- --------------------------------------------------
CREATE PROC [dbo].[PR_IMPORT_POSITION_FILE]   
(  
	 @SESSIONID VARCHAR(20),  
	 @UNAME VARCHAR(20),  
	 @SAUDA_DATE VARCHAR(11),  
	 @INTMODE INT   
) AS  
  
TRUNCATE TABLE FOEXERCISEALLOCATION_IMP  
  
IF @INTMODE=1  
BEGIN  
  
 INSERT INTO FOEXERCISEALLOCATION_IMP  
 SELECT  
		FOEA_POSITION_DATE = LEFT(CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',1)),11),
		FOEA_CM_CODE = DBO.PIECE(FILE_DATA,',',4),
		FOEA_TM_CODE = DBO.PIECE(FILE_DATA,',',6),
		FOEA_ACC_TYPE = DBO.PIECE(FILE_DATA,',',7),
		FOEA_PARTY_CODE = DBO.PIECE(FILE_DATA,',',8),
		FOEA_INST_TYPE = DBO.PIECE(FILE_DATA,',',9),
		FOEA_SYMBOL = DBO.PIECE(FILE_DATA,',',10),
		FOEA_EXPIRYDATE = LEFT(CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',11)),11) +' 23:59',
		FOEA_STRIKE_PRICE = DBO.PIECE(FILE_DATA,',',12),
		FOEA_OPTION_TYPE = DBO.PIECE(FILE_DATA,',',13),
		FOEA_BROUGHT_FORWARD_BUY_QUANTITY = DBO.PIECE(FILE_DATA,',',15),
		FOEA_BROUGHT_FORWARD_BUY_VALUE = DBO.PIECE(FILE_DATA,',',16),
		FOEA_BROUGHT_FORWARD_SELL_QUANTITY = DBO.PIECE(FILE_DATA,',',17),
		FOEA_BROUGHT_FORWARD_SELL_VALUE = DBO.PIECE(FILE_DATA,',',18),
		FOEA_DAY_BUY_QUANTITY = DBO.PIECE(FILE_DATA,',',19),
		FOEA_DAY_BUY_VALUE = DBO.PIECE(FILE_DATA,',',20),
		FOEA_DAY_SELL_QUANTITY = DBO.PIECE(FILE_DATA,',',21),
		FOEA_DAY_SELL_VALUE = DBO.PIECE(FILE_DATA,',',22),
		FOEA_PREEXALL_LONGQTY = DBO.PIECE(FILE_DATA,',',23),
		FOEA_PREEXALL_SHORTQTY = DBO.PIECE(FILE_DATA,',',25),
		FOEA_PREEXALL_LONGVALUE = DBO.PIECE(FILE_DATA,',',24),
		FOEA_PREEXALL_SHORTVALUE = DBO.PIECE(FILE_DATA,',',26),
		FOEA_EXERCISE_QTY = DBO.PIECE(FILE_DATA,',',27),
		FOEA_ALLOC_QTY = DBO.PIECE(FILE_DATA,',',28),
		FOEA_POSTEXALL_LONGQTY = DBO.PIECE(FILE_DATA,',',29),
		FOEA_POSTEXALL_SHORTQTY = DBO.PIECE(FILE_DATA,',',31),
		FOEA_POSTEXALL_LONGVALUE = DBO.PIECE(FILE_DATA,',',30),
		FOEA_POSTEXALL_SHORTVALUE = DBO.PIECE(FILE_DATA,',',32),
		FOEA_SETTLEMENTPRICE = DBO.PIECE(FILE_DATA,',',33),
		FOEA_NETPREMIUM = DBO.PIECE(FILE_DATA,',',34),
		FOEA_DAILY_MTM_SETTLEMENT_VALUE = DBO.PIECE(FILE_DATA,',',35),
		FOEA_FUTURES_FINAL_SETTLEMENT_VALUE = DBO.PIECE(FILE_DATA,',',36),
		FOEA_EXERCISED_ASSIGNED_VALUE = DBO.PIECE(FILE_DATA,',',37)

 FROM CLASSFILEUPD  
 WHERE  
  SESSION_ID= @SESSIONID  
END  
ELSE  
BEGIN  
  
 INSERT INTO FOEXERCISEALLOCATION_IMP  
 SELECT    
		FOEA_POSITION_DATE = LEFT(CONVERT(DATETIME,DBO.PIECE(FILEDATA,',',1)),11),
		FOEA_CM_CODE = DBO.PIECE(FILEDATA,',',4),
		FOEA_TM_CODE = DBO.PIECE(FILEDATA,',',6),
		FOEA_ACC_TYPE = DBO.PIECE(FILEDATA,',',7),
		FOEA_PARTY_CODE = DBO.PIECE(FILEDATA,',',8),
		FOEA_INST_TYPE = DBO.PIECE(FILEDATA,',',9),
		FOEA_SYMBOL = DBO.PIECE(FILEDATA,',',10),
		FOEA_EXPIRYDATE = LEFT(CONVERT(DATETIME,DBO.PIECE(FILEDATA,',',11)),11) +' 23:59',
		FOEA_STRIKE_PRICE = DBO.PIECE(FILEDATA,',',12),
		FOEA_OPTION_TYPE = DBO.PIECE(FILEDATA,',',13),
		FOEA_BROUGHT_FORWARD_BUY_QUANTITY = DBO.PIECE(FILEDATA,',',15),
		FOEA_BROUGHT_FORWARD_BUY_VALUE = DBO.PIECE(FILEDATA,',',16),
		FOEA_BROUGHT_FORWARD_SELL_QUANTITY = DBO.PIECE(FILEDATA,',',17),
		FOEA_BROUGHT_FORWARD_SELL_VALUE = DBO.PIECE(FILEDATA,',',18),
		FOEA_DAY_BUY_QUANTITY = DBO.PIECE(FILEDATA,',',19),
		FOEA_DAY_BUY_VALUE = DBO.PIECE(FILEDATA,',',20),
		FOEA_DAY_SELL_QUANTITY = DBO.PIECE(FILEDATA,',',21),
		FOEA_DAY_SELL_VALUE = DBO.PIECE(FILEDATA,',',22),
		FOEA_PREEXALL_LONGQTY = DBO.PIECE(FILEDATA,',',23),
		FOEA_PREEXALL_SHORTQTY = DBO.PIECE(FILEDATA,',',25),
		FOEA_PREEXALL_LONGVALUE = DBO.PIECE(FILEDATA,',',24),
		FOEA_PREEXALL_SHORTVALUE = DBO.PIECE(FILEDATA,',',26),
		FOEA_EXERCISE_QTY = DBO.PIECE(FILEDATA,',',27),
		FOEA_ALLOC_QTY = DBO.PIECE(FILEDATA,',',28),
		FOEA_POSTEXALL_LONGQTY = DBO.PIECE(FILEDATA,',',29),
		FOEA_POSTEXALL_SHORTQTY = DBO.PIECE(FILEDATA,',',31),
		FOEA_POSTEXALL_LONGVALUE = DBO.PIECE(FILEDATA,',',30),
		FOEA_POSTEXALL_SHORTVALUE = DBO.PIECE(FILEDATA,',',32),
		FOEA_SETTLEMENTPRICE = DBO.PIECE(FILEDATA,',',33),
		FOEA_NETPREMIUM = DBO.PIECE(FILEDATA,',',34),
		FOEA_DAILY_MTM_SETTLEMENT_VALUE = DBO.PIECE(FILEDATA,',',35),
		FOEA_FUTURES_FINAL_SETTLEMENT_VALUE = DBO.PIECE(FILEDATA,',',36),
		FOEA_EXERCISED_ASSIGNED_VALUE = DBO.PIECE(FILEDATA,',',37)
 FROM CLASSFILEUPD_BULK  
 WHERE  
  SPID= @@SPID  
END  
  
UPDATE FOEXERCISEALLOCATION_IMP SET FOEA_OPTION_TYPE = '' WHERE FOEA_STRIKE_PRICE = 0

DELETE FOEXERCISEALLOCATION 
FROM FOEXERCISEALLOCATION_IMP 
WHERE FOEXERCISEALLOCATION.FOEA_POSITION_DATE = @SAUDA_DATE AND
	FOEXERCISEALLOCATION_IMP.FOEA_INST_TYPE = FOEXERCISEALLOCATION.FOEA_INST_TYPE AND  
	FOEXERCISEALLOCATION_IMP.FOEA_SYMBOL = FOEXERCISEALLOCATION.FOEA_SYMBOL AND  
	FOEXERCISEALLOCATION_IMP.FOEA_EXPIRYDATE = FOEXERCISEALLOCATION.FOEA_EXPIRYDATE AND  
	FOEXERCISEALLOCATION_IMP.FOEA_STRIKE_PRICE = FOEXERCISEALLOCATION.FOEA_STRIKE_PRICE AND  
	FOEXERCISEALLOCATION_IMP.FOEA_OPTION_TYPE = FOEXERCISEALLOCATION.FOEA_OPTION_TYPE

DELETE FOCLOSING  
FROM FOEXERCISEALLOCATION_IMP 
WHERE FOCLOSING.TRADE_DATE = @SAUDA_DATE AND 
	FOEXERCISEALLOCATION_IMP.FOEA_INST_TYPE = FOCLOSING.INST_TYPE AND  
	FOEXERCISEALLOCATION_IMP.FOEA_SYMBOL = FOCLOSING.SYMBOL AND  
	FOEXERCISEALLOCATION_IMP.FOEA_EXPIRYDATE = FOCLOSING.EXPIRYDATE AND  
	FOEXERCISEALLOCATION_IMP.FOEA_STRIKE_PRICE = FOCLOSING.STRIKE_PRICE AND  
	FOEXERCISEALLOCATION_IMP.FOEA_OPTION_TYPE = FOCLOSING.OPTION_TYPE AND
	FOCLOSING.STRIKE_PRICE  = 0

INSERT INTO FOCLOSING  
SELECT DISTINCT 
	TRADE_DATE = FOEA_POSITION_DATE,
	MARKET_TYPE = 0,
	INST_TYPE= FOEA_INST_TYPE,
	SYMBOL = FOEA_SYMBOL,
	EXPIRYDATE = FOEA_EXPIRYDATE,
	STRIKE_PRICE = FOEA_STRIKE_PRICE,
	OPTION_TYPE = FOEA_OPTION_TYPE,
	RESERVED =0,
	PRV_CL_RATE = 0,
	OPEN_PRICE = 0,
	HIGH_PRICE = 0,
	LOW_PRICE = 0,
	CL_RATE = FOEA_SETTLEMENTPRICE,
	TOTAL_TRD_QTY = 0,
	TOTAL_TRD_VALUE = 0,
	OPEN_INTEREST = 0,
	CHANGEIN_OPEN_INTEREST = 0,
	POPULATED_BY = @UNAME,
	POPULATED_ON = GETDATE() 
FROM FOEXERCISEALLOCATION_IMP  WHERE FOEA_STRIKE_PRICE = 0
  

UPDATE FOEXERCISEALLOCATION_IMP SET FOEA_PARTY_CODE = NEWPARTY_CODE
FROM PARTYMAPPING
WHERE OLDPARTY_CODE = FOEXERCISEALLOCATION_IMP.FOEA_PARTY_CODE


IF (SELECT UPPER(MEMBERTYPE) FROM FOOWNER) ='CM'
BEGIN
	UPDATE FOEXERCISEALLOCATION_TEMP SET FOEA_TM_CODE = A.NEWPARTY_CODE FROM  PARTYMAPPING A WHERE A.OLDPARTY_CODE = FOEXERCISEALLOCATION_TEMP.FOEA_TM_CODE

	UPDATE FOEXERCISEALLOCATION_TEMP SET FOEA_PARTY_CODE= FOTMINFO.PARTY_CODE 
	FROM FOTMINFO WHERE FOTMINFO.TM_CODE=FOEA_TM_CODE

	UPDATE FOEXERCISEALLOCATION_TEMP SET FOEA_PARTY_CODE= CLIENT2.PARTY_CODE 
	FROM CLIENT2 WHERE CLIENT2.BANKID=FOEA_TM_CODE
END

   
INSERT INTO FOEXERCISEALLOCATION  
SELECT *,@UNAME,GETDATE() FROM FOEXERCISEALLOCATION_IMP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_IMPORT_STT_FILE
-- --------------------------------------------------

CREATE PROC [dbo].[PR_IMPORT_STT_FILE] 
(
	@SESSIONID VARCHAR(20),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT 
) AS

DECLARE @RECTYPE CHAR(2)
IF (SELECT MEMBERTYPE FROM FOOWNER) ='TM'
BEGIN
	SET @RECTYPE = '20'
END
ELSE
BEGIN
	SET @RECTYPE = '20'
END

CREATE TABLE #STT
(
	RECTYPE		VARCHAR(2),
	STT_DATE	VARCHAR(20),
	TM_CODE		VARCHAR(20),
	PARTY_CODE	VARCHAR(20),
	INST_TYPE	VARCHAR(6),
	SYMBOL		VARCHAR(12),
	EXPIRYDATE	VARCHAR(20),
	STRIKE_PRICE	VARCHAR(20),
	OPTION_TYPE		VARCHAR(2),
	SQTY	VARCHAR(20),
	SAMT	VARCHAR(20),
	TSAMT_FUT	VARCHAR(20),
	TSAMT_OPT	VARCHAR(20),
	STT_FUT	VARCHAR(20),
	STT_OPT	VARCHAR(20)
	)

IF @INTMODE=1
BEGIN

	INSERT INTO #STT
	SELECT
		RECTYPE = DBO.PIECE(FILE_DATA,',',1),
		STT_DATE = DBO.PIECE(FILE_DATA,',',2),
		TM_CODE = DBO.PIECE(FILE_DATA,',',3),
		PARTY_CODE = DBO.PIECE(FILE_DATA,',',4),
		INST_TYPE = DBO.PIECE(FILE_DATA,',',5),
		SYMBOL = DBO.PIECE(FILE_DATA,',',6),
		EXPIRYDATE = DBO.PIECE(FILE_DATA,',',7),
		STRIKE_PRICE = DBO.PIECE(FILE_DATA,',',8),
		OPTION_TYPE = DBO.PIECE(FILE_DATA,',',9),
		SQTY = DBO.PIECE(FILE_DATA,',',10),
		SAMT = DBO.PIECE(FILE_DATA,',',11),
		TSAMT_FUT = DBO.PIECE(FILE_DATA,',',12),
		TSAMT_OPT = DBO.PIECE(FILE_DATA,',',13),
		STT_FUT = DBO.PIECE(FILE_DATA,',',14),
		STT_OPT = DBO.PIECE(FILE_DATA,',',15)
	FROM CLASSFILEUPD
	WHERE
		SESSION_ID= @SESSIONID	
		AND DBO.PIECE(FILE_DATA,',',1) = '40'

	IF (SELECT MEMBERTYPE FROM FOOWNER) ='TM'
	BEGIN
		INSERT INTO #STT
		SELECT
			RECTYPE = DBO.PIECE(FILE_DATA,',',1),
			STT_DATE = DBO.PIECE(FILE_DATA,',',2),
			TM_CODE = DBO.PIECE(FILE_DATA,',',3),
			PARTY_CODE = DBO.PIECE(FILE_DATA,',',4),
			INST_TYPE = '',
			SYMBOL = '',
			EXPIRYDATE = '',
			STRIKE_PRICE = '',
			OPTION_TYPE = '',
			SQTY = 0,
			SAMT = 0,
			TSAMT_FUT = 0,
			TSAMT_OPT = 0,
			STT_FUT =  DBO.PIECE(FILE_DATA,',',5),
			STT_OPT = 0
		FROM CLASSFILEUPD
		WHERE
			SESSION_ID= @SESSIONID	
			AND DBO.PIECE(FILE_DATA,',',1) = @RECTYPE
	END
	ELSE
	BEGIN
		INSERT INTO #STT
		SELECT
			RECTYPE = DBO.PIECE(FILE_DATA,',',1),
			STT_DATE = DBO.PIECE(FILE_DATA,',',2),
			TM_CODE = DBO.PIECE(FILE_DATA,',',3),
			PARTY_CODE = '',
			INST_TYPE = '',
			SYMBOL = '',
			EXPIRYDATE = '',
			STRIKE_PRICE = '',
			OPTION_TYPE = '',
			SQTY = 0,
			SAMT = 0,
			TSAMT_FUT = 0,
			TSAMT_OPT = 0,
			STT_FUT =  DBO.PIECE(FILE_DATA,',',4),
			STT_OPT = 0
		FROM CLASSFILEUPD
		WHERE
			SESSION_ID= @SESSIONID	
			AND DBO.PIECE(FILE_DATA,',',1) = @RECTYPE
	END

END
ELSE
BEGIN

	INSERT INTO #STT
	SELECT 	
		RECTYPE = DBO.PIECE(FILEDATA,',',1),
		STT_DATE = DBO.PIECE(FILEDATA,',',2),
		TM_CODE = DBO.PIECE(FILEDATA,',',3),
		PARTY_CODE = DBO.PIECE(FILEDATA,',',4),
		INST_TYPE = DBO.PIECE(FILEDATA,',',5),
		SYMBOL = DBO.PIECE(FILEDATA,',',6),
		EXPIRYDATE = DBO.PIECE(FILEDATA,',',7),
		STRIKE_PRICE = DBO.PIECE(FILEDATA,',',8),
		OPTION_TYPE = DBO.PIECE(FILEDATA,',',9),
		SQTY = DBO.PIECE(FILEDATA,',',10),
		SAMT = DBO.PIECE(FILEDATA,',',11),
		TSAMT_FUT = DBO.PIECE(FILEDATA,',',12),
		TSAMT_OPT = DBO.PIECE(FILEDATA,',',13),
		STT_FUT = DBO.PIECE(FILEDATA,',',14),
		STT_OPT = DBO.PIECE(FILEDATA,',',15)
	FROM CLASSFILEUPD_BULK
	WHERE
		SPID= @@SPID
		AND DBO.PIECE(FILEDATA,',',1) = '40'

	IF (SELECT MEMBERTYPE FROM FOOWNER) ='TM'
	BEGIN
		INSERT INTO #STT
		SELECT
			RECTYPE = DBO.PIECE(FILEDATA,',',1),
			STT_DATE = DBO.PIECE(FILEDATA,',',2),
			TM_CODE = DBO.PIECE(FILEDATA,',',3),
			PARTY_CODE = DBO.PIECE(FILEDATA,',',4),
			INST_TYPE = '',
			SYMBOL = '',
			EXPIRYDATE = '',
			STRIKE_PRICE = '',
			OPTION_TYPE = '',
			SQTY = 0,
			SAMT = 0,
			TSAMT_FUT = 0,
			TSAMT_OPT = 0,
			STT_FUT =  DBO.PIECE(FILEDATA,',',5),
			STT_OPT = 0
		FROM CLASSFILEUPD_BULK
		WHERE
			SPID= @@SPID
			AND DBO.PIECE(FILEDATA,',',1) = @RECTYPE
	END
	ELSE
	BEGIN
		INSERT INTO #STT
		SELECT
			RECTYPE = DBO.PIECE(FILEDATA,',',1),
			STT_DATE = DBO.PIECE(FILEDATA,',',2),
			TM_CODE = DBO.PIECE(FILEDATA,',',3),
			PARTY_CODE = '',
			INST_TYPE = '',
			SYMBOL = '',
			EXPIRYDATE = '',
			STRIKE_PRICE = '',
			OPTION_TYPE = '',
			SQTY = 0,
			SAMT = 0,
			TSAMT_FUT = 0,
			TSAMT_OPT = 0,
			STT_FUT =  DBO.PIECE(FILEDATA,',',4),
			STT_OPT = 0
		FROM CLASSFILEUPD_BULK
		WHERE
			SPID= @@SPID
			AND DBO.PIECE(FILEDATA,',',1) = @RECTYPE
	END
		
END

UPDATE #STT SET PARTY_CODE = NEWPARTY_CODE
FROM PARTYMAPPING
WHERE OLDPARTY_CODE = #STT.PARTY_CODE


IF (SELECT MEMBERTYPE FROM FOOWNER) ='CM'
BEGIN
   UPDATE #STT SET PARTY_CODE = FOTMINFO.PARTY_CODE   
   FROM  FOTMINFO (NOLOCK) WHERE FOTMINFO.TM_CODE = #STT.TM_CODE  
  
   UPDATE #STT SET PARTY_CODE = C2.PARTY_CODE   
   FROM  CLIENT2 C2 (NOLOCK) WHERE C2.BANKID = #STT.TM_CODE  
   AND TM_CODE NOT IN (SELECT PARTY_CODE FROM FOTMINFO (NOLOCK))  
	
END

UPDATE #STT SET STRIKE_PRICE = '0' WHERE ISNULL(STRIKE_PRICE,'') = ''

DELETE STT_EXCHG WHERE STT_DATE = @SAUDA_DATE
			
INSERT INTO STT_EXCHG
SELECT 
	RECTYPE,
	STT_DATE,
	TM_CODE,
	PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	CONVERT(NUMERIC(18,4),ISNULL(STRIKE_PRICE,'0')),
	OPTION_TYPE,
	CA_LEVEL=0,
	CONVERT(NUMERIC(18,4),ISNULL(SQTY,'0')),
	CONVERT(NUMERIC(18,4),ISNULL(SAMT,'0')),
	CONVERT(NUMERIC(18,4),ISNULL(TSAMT_FUT,'0')),
	CONVERT(NUMERIC(18,4),ISNULL(TSAMT_OPT,'0')),
	CONVERT(NUMERIC(18,4),ISNULL(STT_FUT,'0')),
	CONVERT(NUMERIC(18,4),ISNULL(STT_OPT,'0')),
	TOTALSTT = 0,
	STT_FLAG = 0
FROM #STT

UPDATE STT_EXCHG SET TOTALSTT = STT_FUT+STT_OPT
WHERE STT_DATE = @SAUDA_DATE

DROP TABLE #STT

/*--------------------------- END OF THE PROC ------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_IMPORT_TRADE_FILE
-- --------------------------------------------------

CREATE PROC [dbo].[PR_IMPORT_TRADE_FILE] 
(
	@SESSIONID VARCHAR(20),
	@UNAME VARCHAR(20),
	@SAUDA_DATE VARCHAR(11),
	@INTMODE INT 
) AS

TRUNCATE TABLE FOFTTRADE_3_IMP

IF @INTMODE=1
BEGIN

	INSERT INTO FOFTTRADE_3_IMP
	SELECT 
		TRADE_NO  = DBO.PIECE(FILE_DATA,',',1),
		TRADEDATE  = DBO.PIECE(FILE_DATA,',',2),
		ACTIVITYTYPE  = DBO.PIECE(FILE_DATA,',',3),
		MARKETTYPE  = DBO.PIECE(FILE_DATA,',',4),
		INST_TYPE  = DBO.PIECE(FILE_DATA,',',5),
		SYMBOL  = DBO.PIECE(FILE_DATA,',',6),
		EXPIRYDATE  = LEFT(CONVERT(DATETIME,DBO.PIECE(FILE_DATA,',',7)),11) + ' 23:59',
		STRIKE_PRICE  = DBO.PIECE(FILE_DATA,',',8),
		OPTION_TYPE  = DBO.PIECE(FILE_DATA,',',9),
		C_U_FLAG  = DBO.PIECE(FILE_DATA,',',10),
		B_BROKERCODE  = DBO.PIECE(FILE_DATA,',',11),
		S_BROKERCODE  = DBO.PIECE(FILE_DATA,',',12),
		PRICE  = DBO.PIECE(FILE_DATA,',',13),
		ACTIVITYTIME  = DBO.PIECE(FILE_DATA,',',14),
		TRADEVOLUME  = DBO.PIECE(FILE_DATA,',',15),
		TOKEN_NO  = DBO.PIECE(FILE_DATA,',',16),
		BRANCH_ID  = DBO.PIECE(FILE_DATA,',',17),
		B_CMCODE  = DBO.PIECE(FILE_DATA,',',18),
		S_CMCODE  = DBO.PIECE(FILE_DATA,',',19),
		SELL_BRANCH  = DBO.PIECE(FILE_DATA,',',20),
		B_PARTICIPANTCODE  = DBO.PIECE(FILE_DATA,',',21),
		B_CONFIRMATION  = DBO.PIECE(FILE_DATA,',',22),
		S_PARTICIPANTCODE  = DBO.PIECE(FILE_DATA,',',23),
		S_CONFIRMATION  = DBO.PIECE(FILE_DATA,',',24),
		B_O_C_FLAG  = DBO.PIECE(FILE_DATA,',',25),
		S_O_C_FLAG  = DBO.PIECE(FILE_DATA,',',26),
		B_OLD_PARTICIPANTCODE  = DBO.PIECE(FILE_DATA,',',27),
		B_OLD_CMCODE  = DBO.PIECE(FILE_DATA,',',28),
		S_OLD_PARTICIPANTCODE  = DBO.PIECE(FILE_DATA,',',29),
		S_OLD_CMCODE  = DBO.PIECE(FILE_DATA,',',30),
		B_TRADER  = DBO.PIECE(FILE_DATA,',',31),
		S_TRADER  = DBO.PIECE(FILE_DATA,',',32),
		B_ORDER_NO  = DBO.PIECE(FILE_DATA,',',33),
		S_ORDER_NO  = DBO.PIECE(FILE_DATA,',',34),
		B_PARTY_CODE  = DBO.PIECE(FILE_DATA,',',35),
		S_PARTY_CODE  = DBO.PIECE(FILE_DATA,',',36),
		B_REMARK  = DBO.PIECE(FILE_DATA,',',37),
		S_REMARK  = DBO.PIECE(FILE_DATA,',',38),
		B_TRADEQTY  = DBO.PIECE(FILE_DATA,',',39),
		S_TRADEQTY  = DBO.PIECE(FILE_DATA,',',40),
		B_PRO_CLI  = DBO.PIECE(FILE_DATA,',',41),
		S_PRO_CLI  = DBO.PIECE(FILE_DATA,',',42),
		CONTROLFLAG  = DBO.PIECE(FILE_DATA,',',43),
		ORDERTIME  = DBO.PIECE(FILE_DATA,',',44)
	FROM CLASSFILEUPD
	WHERE
		SESSION_ID= @SESSIONID
		AND  DBO.PIECE(FILE_DATA,',',1) <> ''
END
ELSE
BEGIN

	INSERT INTO FOFTTRADE_3_IMP
	SELECT 	
		TRADE_NO  = DBO.PIECE(FILEDATA,',',1),
		TRADEDATE  = DBO.PIECE(FILEDATA,',',2),
		ACTIVITYTYPE  = DBO.PIECE(FILEDATA,',',3),
		MARKETTYPE  = DBO.PIECE(FILEDATA,',',4),
		INST_TYPE  = DBO.PIECE(FILEDATA,',',5),
		SYMBOL  = DBO.PIECE(FILEDATA,',',6),
		EXPIRYDATE  = LEFT(CONVERT(DATETIME,DBO.PIECE(FILEDATA,',',7)),11) + ' 23:59',
		STRIKE_PRICE  = DBO.PIECE(FILEDATA,',',8),
		OPTION_TYPE  = DBO.PIECE(FILEDATA,',',9),
		C_U_FLAG  = DBO.PIECE(FILEDATA,',',10),
		B_BROKERCODE  = DBO.PIECE(FILEDATA,',',11),
		S_BROKERCODE  = DBO.PIECE(FILEDATA,',',12),
		PRICE  = DBO.PIECE(FILEDATA,',',13),
		ACTIVITYTIME  = DBO.PIECE(FILEDATA,',',14),
		TRADEVOLUME  = DBO.PIECE(FILEDATA,',',15),
		TOKEN_NO  = DBO.PIECE(FILEDATA,',',16),
		BRANCH_ID  = DBO.PIECE(FILEDATA,',',17),
		B_CMCODE  = DBO.PIECE(FILEDATA,',',18),
		S_CMCODE  = DBO.PIECE(FILEDATA,',',19),
		SELL_BRANCH  = DBO.PIECE(FILEDATA,',',20),
		B_PARTICIPANTCODE  = DBO.PIECE(FILEDATA,',',21),
		B_CONFIRMATION  = DBO.PIECE(FILEDATA,',',22),
		S_PARTICIPANTCODE  = DBO.PIECE(FILEDATA,',',23),
		S_CONFIRMATION  = DBO.PIECE(FILEDATA,',',24),
		B_O_C_FLAG  = DBO.PIECE(FILEDATA,',',25),
		S_O_C_FLAG  = DBO.PIECE(FILEDATA,',',26),
		B_OLD_PARTICIPANTCODE  = DBO.PIECE(FILEDATA,',',27),
		B_OLD_CMCODE  = DBO.PIECE(FILEDATA,',',28),
		S_OLD_PARTICIPANTCODE  = DBO.PIECE(FILEDATA,',',29),
		S_OLD_CMCODE  = DBO.PIECE(FILEDATA,',',30),
		B_TRADER  = DBO.PIECE(FILEDATA,',',31),
		S_TRADER  = DBO.PIECE(FILEDATA,',',32),
		B_ORDER_NO  = DBO.PIECE(FILEDATA,',',33),
		S_ORDER_NO  = DBO.PIECE(FILEDATA,',',34),
		B_PARTY_CODE  = DBO.PIECE(FILEDATA,',',35),
		S_PARTY_CODE  = DBO.PIECE(FILEDATA,',',36),
		B_REMARK  = DBO.PIECE(FILEDATA,',',37),
		S_REMARK  = DBO.PIECE(FILEDATA,',',38),
		B_TRADEQTY  = DBO.PIECE(FILEDATA,',',39),
		S_TRADEQTY  = DBO.PIECE(FILEDATA,',',40),
		B_PRO_CLI  = DBO.PIECE(FILEDATA,',',41),
		S_PRO_CLI  = DBO.PIECE(FILEDATA,',',42),
		CONTROLFLAG  = DBO.PIECE(FILEDATA,',',43),
		ORDERTIME  = DBO.PIECE(FILEDATA,',',44)

	FROM CLASSFILEUPD_BULK
	WHERE
		SPID= @@SPID
		AND  DBO.PIECE(FILEDATA,',',1) <> ''
END


TRUNCATE TABLE FOFTTRADE

INSERT INTO FOFTTRADE   
(TRADE_NO,STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
SEC_NAME,BOOKTYPE,BOOKTYPENAME,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,  
PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,  
MARKETTYPE,C_U_FLAG,SETTFLAG,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)  

SELECT 
        RIGHT(TRADE_NO,8)*1 TRADE_NO,ACTIVITYTYPE STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,
        OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,  
        '' SEC_NAME,MARKETTYPE BOOKTYPE,'' BOOKTYPENAME,USER_ID=S_TRADER,
		BRANCH_ID=S_PARTY_CODE,
        SELL_BUY = 2,
        TRADEQTY=TRADEVOLUME,PRICE,PRO_CLI =CASE WHEN S_PRO_CLI ='C' THEN 1 ELSE 2 END,  
        PARTY_CODE = S_PARTY_CODE,
        PARTICIPANTCODE = (CASE WHEN S_CONFIRMATION = 'Y' THEN S_PARTICIPANTCODE ELSE S_BROKERCODE END),  
        C_U_FLAG  ,
        ACTIVITYTIME,LAST_MOD_TIME=ACTIVITYTIME,
        ORDER_NO = S_ORDER_NO , RIGHT(ORDERTIME,8),  
        MARKETTYPE=CONTROLFLAG,S_O_C_FLAG,0 SETTFLAG,S_BROKERCODE MEMBERCODE,S_PARTY_CODE TMPARTYCODE,
        0 RESERVED1,2 RESERVED2,'' RESERVED3,'' RESERVED4, 
        RESERVED5 = CASE WHEN S_CONFIRMATION = 'Y' THEN 'Y' ELSE 'N' END
FROM FOFTTRADE_3_IMP
WHERE ISNULL(S_ORDER_NO,'') <> '' 

INSERT INTO FOFTTRADE   
(TRADE_NO,STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
SEC_NAME,BOOKTYPE,BOOKTYPENAME,USER_ID,BRANCH_ID,SELL_BUY,TRADEQTY,PRICE,PRO_CLI,  
PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,  
MARKETTYPE,C_U_FLAG,SETTFLAG,MEMBERCODE,TMPARTYCODE,RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5)  

SELECT 
        RIGHT(TRADE_NO,7)*1 TRADE_NO,ACTIVITYTYPE STATUS,SYMBOL,INST_TYPE,EXPIRYDATE,STRIKE_PRICE,
        OPTION_TYPE=CASE WHEN OPTION_TYPE='FF' THEN '' ELSE OPTION_TYPE END,  
        '' SEC_NAME,MARKETTYPE BOOKTYPE,'' BOOKTYPENAME,USER_ID=B_TRADER,
		BRANCH_ID=B_PARTY_CODE,
        SELL_BUY = 1,
        TRADEQTY=TRADEVOLUME,PRICE,PRO_CLI =CASE WHEN B_PRO_CLI ='C' THEN 1 ELSE 2 END,  
        PARTY_CODE = B_PARTY_CODE,
        PARTICIPANTCODE = (CASE WHEN B_CONFIRMATION = 'Y' THEN B_PARTICIPANTCODE ELSE B_BROKERCODE END),  
        C_U_FLAG  ,
        ACTIVITYTIME,LAST_MOD_TIME=ACTIVITYTIME,
        ORDER_NO = B_ORDER_NO ,RIGHT(ORDERTIME,8),  
        MARKETTYPE=CONTROLFLAG,B_O_C_FLAG,0 SETTFLAG,B_BROKERCODE MEMBERCODE,B_PARTY_CODE TMPARTYCODE,
        0 RESERVED1,2 RESERVED2,'' RESERVED3,'' RESERVED4,
        RESERVED5 = CASE WHEN B_CONFIRMATION = 'Y' THEN 'Y' ELSE 'N' END
FROM FOFTTRADE_3_IMP
WHERE ISNULL(B_ORDER_NO,'') <> '' 

/*------------------------------ END OF THE PROC----------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_LEDGER_DETAILS_DAS_GET
-- --------------------------------------------------

-- PR_LEDGER_DETAILS_DAS_GET 'JAN 10 2014','','ZZZZ',''

CREATE    PROCEDURE [dbo].[PR_LEDGER_DETAILS_DAS_GET]                        
(                                                
 @FDATE VARCHAR(12),                                              
 @FPARTY VARCHAR(10),                                                 
 @TPARTY VARCHAR(10),                                              
 @UNAME  VARCHAR(10)                                               
)                                                
                                                
AS                                                
                                                
SET NOCOUNT ON                                                             
                        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                                                      
                                                      
    DELETE                                                       
    FROM                                                       
       LEDGER_DETAILS_DAS                                                       
    WHERE                                                       
        LEDDD_SAUDA_DATE LIKE @FDATE + '%'                                                       
        AND LEDDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY                                                         
                                
                                                
CREATE TABLE [DBO].[#LEDGER_DETAILS_DAS](                                                
 [LEDDD_PARTY_CODE] [VARCHAR](10) NOT NULL,                                              
 [LEDDD_SAUDA_DATE] DATETIME ,                                              
 [LEDDD_OPENING_BAL] [MONEY] NULL,                                                
 [LEDDD_CHQ_REC] [MONEY] NULL,                                                
 [LEDDD_CHQ_PAY] [MONEY] NULL,                                                
 [LEDDD_JV_ENTRY] [MONEY] NULL,                                                
 [LEDDD_CLOSING_BAL] [MONEY] NULL,                                                
 [LEDDD_CASH_MARGIN] [MONEY] NULL,                                                
 [LEDDD_OPENING_INIT_MARGIN] [NUMERIC] (18,4) NULL,                                                
 [LEDDD_MRG_REC] [MONEY] NULL,                      
 [LEDDD_MRG_REPAY] [MONEY] NULL,                      
 [LEDDD_MRG_JV_ENTRY] [MONEY] NULL,                                                
 [LEDDD_CLOSING_INIT_MARGIN] [NUMERIC] (18,4) NULL,                                                
 [LEDDD_NONCASH_COLL_HC] [MONEY] NULL,                                                
 [LEDDD_INIT_EXPO_MARGIN] [NUMERIC] (18,4) NULL,                                              
 [LEDDD_CREATED_BY] [VARCHAR] (10) NOT NULL,                                              
 [LEDDD_CREATED_DT] DATETIME,      
 [LEDDD_ADD_MARGIN] [NUMERIC] (18,4) NULL,                      
 [LEDDD_FT_D] [MONEY] NULL,      
 [LEDDD_FT_C] [MONEY] NULL,      
 [LEDDD_MRG_FT] [MONEY] NULL,      
 [LEDDD_RUNNINGBAL] [MONEY] NULL,
 [LEDDD_CASH_COLL_HC] [MONEY] NULL
) ON [PRIMARY]                      
                                                
/*====================================================================================                                                
 OPENING BALANCE - CLIENT CONTROL A/C                                                
====================================================================================*/                                                
          
IF (SELECT COUNT(1) FROM ACCOUNTCURBFO..PARAMETER WHERE @FDATE BETWEEN SDTCUR AND LDTCUR AND @FDATE = LEFT(SDTCUR,11)) > 0          
BEGIN           
INSERT INTO #LEDGER_DETAILS_DAS                                                 
SELECT                                                 
 LEDDD_PARTY_CODE = CLTCODE,                                               
 LEDDD_SAUDA_DATE = @FDATE,             
 LEDDD_OPENING_BAL = ISNULL(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),0),                                     
 LEDDD_CHQ_REC = 0,                                                
 LEDDD_CHQ_PAY = 0,                                              
 LEDDD_JV_ENTRY = 0,                                       
 LEDDD_CLOSING_BAL = 0,                                                
 LEDDD_CASH_MARGIN = 0,                                        
 LEDDD_OPENING_INIT_MARGIN = 0,                                                
 LEDDD_MRG_REC = 0,                                                
 LEDDD_MRG_REPAY = 0,                                                
 LEDDD_MRG_JV_ENTRY = 0,                                            
 LEDDD_CLOSING_INIT_MARGIN = 0,                                                
 LEDDD_NONCASH_COLL_HC = 0,                               
 LEDDD_INIT_EXPO_MARGIN = 0,                                                
 LEDDD_CREATED_BY = @UNAME,                 
 LEDDD_CREATED_DT = GETDATE(),                      
 LEDDD_ADD_MARGIN = 0,      
 LEDDD_FT_D = 0,                      
 LEDDD_FT_C = 0,                      
 LEDDD_MRG_FT = 0,                      
 LEDDD_RUNNINGBAL = 0,
 LEDDD_CASH_COLL_HC = 0
FROM                                                 
 ACCOUNTCURBFO..LEDGER L,                                                 
 ACCOUNTCURBFO..PARAMETER P                                                 
WHERE                                   
 CLTCODE BETWEEN @FPARTY AND @TPARTY                                                
 AND VDT LIKE @FDATE + '%'           
 AND @FDATE BETWEEN SDTCUR AND LDTCUR                                          
 AND VDT >= SDTCUR                                                 
 AND VDT <= LDTCUR           
 AND VTYP = 18           
GROUP BY                                                 
 CLTCODE                                      
END          
ELSE          
BEGIN          
INSERT INTO #LEDGER_DETAILS_DAS                                                 
SELECT                                                 
 LEDDD_PARTY_CODE = CLTCODE,                                               
 LEDDD_SAUDA_DATE = @FDATE,                                              
 LEDDD_OPENING_BAL = ISNULL(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),0),                                                
 LEDDD_CHQ_REC = 0,                                                
 LEDDD_CHQ_PAY = 0,                                                
 LEDDD_JV_ENTRY = 0,                                                
 LEDDD_CLOSING_BAL = 0,                                                
 LEDDD_CASH_MARGIN = 0,                                                
 LEDDD_OPENING_INIT_MARGIN = 0,                                                
 LEDDD_MRG_REC = 0,                                                
 LEDDD_MRG_REPAY = 0,                                                
 LEDDD_MRG_JV_ENTRY = 0,                                            
 LEDDD_CLOSING_INIT_MARGIN = 0,                                                
 LEDDD_NONCASH_COLL_HC = 0,                               
 LEDDD_INIT_EXPO_MARGIN = 0,                                                
 LEDDD_CREATED_BY = @UNAME,                 
 LEDDD_CREATED_DT = GETDATE(),                      
 LEDDD_ADD_MARGIN = 0,      
 LEDDD_FT_D = 0,                      
 LEDDD_FT_C = 0,                      
 LEDDD_MRG_FT = 0,                      
 LEDDD_RUNNINGBAL = 0,
 LEDDD_CASH_COLL_HC = 0

FROM                                                 
 ACCOUNTCURBFO..LEDGER L,                                                 
 ACCOUNTCURBFO..PARAMETER P                                                 
WHERE                                   
 CLTCODE BETWEEN @FPARTY AND @TPARTY                                                
 AND VDT < @FDATE          
 AND @FDATE BETWEEN SDTCUR AND LDTCUR                                
 AND VDT >= SDTCUR                     
 AND VDT <= LDTCUR                                                 
GROUP BY                                                 
 CLTCODE                                      
END          
                                                
/*====================================================================================                                                
 CHEQUE RECEIPTS DURING THE DAY                                              
 CHEQUE PAYMENTS DURING THE DAY                
 JOURNAL ENTRIES FOR THE DAY                                                
 MARGIN RECEIPTS DURING THE DAY                                                
 MARGIN REPAYMENT DURING THE DAY                                                
 MARGIN JOURNAL ENTRIES FOR THE DAY                                                
====================================================================================*/                                                
INSERT INTO #LEDGER_DETAILS_DAS                                               
SELECT                                        
 LEDDD_PARTY_CODE = CLTCODE,                                              
 LEDDD_SAUDA_DATE = @FDATE,                                            
 LEDDD_OPENING_BAL = 0,                                              
 ISNULL(SUM(LEDDD_CHQ_REC),0),                        
 ISNULL(SUM(LEDDD_CHQ_PAY),0),                        
 ISNULL(SUM(LEDDD_JV_ENTRY),0),                        
 LEDDD_CLOSING_BAL = 0,                                              
 LEDDD_CASH_MARGIN = 0,                                              
 LEDDD_OPENING_INIT_MARGIN = 0,                                              
 ISNULL(SUM(ML.LEDDD_MRG_REC),0),                                              
 ISNULL(SUM(ML.LEDDD_MRG_REPAY),0),                                              
 ISNULL(SUM(ML.LEDDD_MRG_JV_ENTRY),0),                                              
 LEDDD_CLOSING_INIT_MARGIN = 0 , --ISNULL(SUM(ML.LEDDD_MRG_REC),0) + ISNULL(SUM(ML.LEDDD_MRG_REPAY),0) + ISNULL(SUM(ML.LEDDD_MRG_JV_ENTRY),0),                                              
 LEDDD_NONCASH_COLL_HC = 0,                                              
 LEDDD_INIT_EXPO_MARGIN = 0,                                              
 LEDDD_CREATED_BY = @UNAME,                                            
 LEDDD_CREATED_DT = GETDATE(),                      
 LEDDD_ADD_MARGIN = 0,      
 LEDDD_FT_D = ISNULL(SUM(LEDDD_FT_D),0),                      
 LEDDD_FT_C = ISNULL(SUM(LEDDD_FT_C),0),                      
 LEDDD_MRG_FT = ISNULL(SUM(LEDDD_MRG_FT),0),                      
 LEDDD_RUNNINGBAL = 0,
 LEDDD_CASH_COLL_HC = 0

 FROM                                               
 (                        
 SELECT                         
  LEDDD_CHQ_REC = ISNULL(SUM(CASE WHEN VTYP = '2' THEN (CASE WHEN DRCR ='C' THEN VAMT ELSE -VAMT END) ELSE 0 END ),0) ,                                              
  LEDDD_CHQ_PAY = ISNULL(SUM(CASE WHEN VTYP = '3' THEN (CASE WHEN DRCR ='C' THEN VAMT ELSE -VAMT END) ELSE 0 END ),0),                                              
  LEDDD_JV_ENTRY = ISNULL(SUM(CASE WHEN VTYP IN ('8','24') THEN (CASE WHEN DRCR ='C' THEN VAMT ELSE -VAMT END) ELSE 0 END ),0),                      
  LEDDD_FT_D = ISNULL(SUM(CASE WHEN VTYP = '88' THEN (CASE WHEN DRCR ='D' THEN VAMT ELSE 0 END) ELSE 0 END ),0),                      
  LEDDD_FT_C = ISNULL(SUM(CASE WHEN VTYP = '88' THEN (CASE WHEN DRCR ='C' THEN VAMT ELSE 0 END) ELSE 0 END ),0),                      
  CLTCODE                         
 FROM                         
  ACCOUNTCURBFO..LEDGER (NOLOCK)             
 WHERE                                               
  CLTCODE BETWEEN @FPARTY AND @TPARTY                         
  AND VDT LIKE @FDATE+ '%'                         
 GROUP BY CLTCODE   
 ) L                         
 LEFT OUTER JOIN                              
(                        
    SELECT                             
 LEDDD_MRG_REC = ISNULL(SUM(CASE WHEN VTYP = 19 THEN (CASE WHEN DRCR ='C' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END),0),                               
 LEDDD_MRG_REPAY = ISNULL(SUM(CASE WHEN VTYP = 20 THEN (CASE WHEN DRCR ='C' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END),0),                               
 LEDDD_MRG_JV_ENTRY = ISNULL(SUM(CASE WHEN VTYP = 24 THEN (CASE WHEN DRCR ='C' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END),0),                      
 LEDDD_MRG_FT = ISNULL(SUM(CASE WHEN VTYP = 88 THEN (CASE WHEN DRCR ='C' THEN AMOUNT ELSE -AMOUNT END) ELSE 0 END ),0),                      
 PARTY_CODE                      
    FROM ACCOUNTCURBFO..MARGINLEDGER (NOLOCK) WHERE PARTY_CODE BETWEEN @FPARTY AND @TPARTY                         
  AND VDT LIKE @FDATE+ '%'                                              
  GROUP BY PARTY_CODE                          
) ML                             
ON                            
(                            
 CLTCODE = PARTY_CODE                             
)                            
GROUP BY CLTCODE                        
                                                
                                                
/*====================================================================================                                                
 CLOSING BALANCE - CLIENT CONTROL A/C (A)                                                
====================================================================================*/                                                
INSERT INTO #LEDGER_DETAILS_DAS                        
SELECT                                                 
 LEDDD_PARTY_CODE = CLTCODE,                                                
 LEDDD_SAUDA_DATE = @FDATE,                                              
 LEDDD_OPENING_BAL = 0,                                                
 LEDDD_CHQ_REC = 0,                                                
 LEDDD_CHQ_PAY = 0,                                                
 LEDDD_JV_ENTRY = 0,                                                
 LEDDD_CLOSING_BAL = ISNULL(SUM(CASE WHEN DRCR = 'C' THEN VAMT ELSE -VAMT END),0),                                                
 LEDDD_CASH_MARGIN = 0,                                                
 LEDDD_OPENING_INIT_MARGIN = 0,                                                
 LEDDD_MRG_REC = 0,                                                
 LEDDD_MRG_REPAY = 0,                                                
 LEDDD_MRG_JV_ENTRY = 0,                                           
 LEDDD_CLOSING_INIT_MARGIN = 0,                                                
 LEDDD_NONCASH_COLL_HC = 0,                                                
 LEDDD_INIT_EXPO_MARGIN = 0,                                                
 LEDDD_CREATED_BY = @UNAME,                                              
 LEDDD_CREATED_DT = GETDATE(),                      
 LEDDD_ADD_MARGIN = 0,      
 LEDDD_FT_D = 0,                      
 LEDDD_FT_C = 0,                      
 LEDDD_MRG_FT = 0,                      
 LEDDD_RUNNINGBAL = 0,
 LEDDD_CASH_COLL_HC = 0
                                                
FROM                                                 
 ACCOUNTCURBFO..LEDGER L,                                                 
 ACCOUNTCURBFO..PARAMETER P                                                 
WHERE                                                 
 CLTCODE BETWEEN @FPARTY AND @TPARTY                                                
 AND VDT <=  @FDATE  + ' 23:59:59'                                                 
--- AND VDT <= @FDATE  + '23:59:59'                                    
 AND @FDATE BETWEEN SDTCUR AND LDTCUR          
 AND VDT >= SDTCUR                 
 AND VDT <= LDTCUR                                                 
GROUP BY                                                 
 CLTCODE                              
       --SELECT * FROM MSAJAG..COLLATERAL   WHERE PARTY_CODE='A00033771'           
/*====================================================================================                                                
 CASH MARGIN                                                
 NON-CASH COLLATERAL VALUE (AFTER HAIR-CUT) (C)                                            
====================================================================================*/                                 
                                                
INSERT INTO #LEDGER_DETAILS_DAS                                                 
SELECT                                                 
 LEDDD_PARTY_CODE = PARTY_CODE,                                                
 LEDDD_SAUDA_DATE = @FDATE,                                              
 LEDDD_OPENING_BAL = 0,                                                
 LEDDD_CHQ_REC = 0,                                                
 LEDDD_CHQ_PAY = 0,                                                
 LEDDD_JV_ENTRY = 0,                                                
 LEDDD_CLOSING_BAL = 0,                                                
 LEDDD_CASH_MARGIN,                                                
 LEDDD_OPENING_INIT_MARGIN = 0,                                                
 LEDDD_MRG_REC = 0,                                                
 LEDDD_MRG_REPAY = 0,                                                
 LEDDD_MRG_JV_ENTRY = 0,                                                
 LEDDD_CLOSING_INIT_MARGIN = 0,                                                
 LEDDD_NONCASH_COLL_HC,                                                
 LEDDD_INIT_EXPO_MARGIN = 0,                                                
 LEDDD_CREATED_BY = @UNAME,                                              
 LEDDD_CREATED_DT = GETDATE(),                      
 LEDDD_ADD_MARGIN = 0,      
 LEDDD_FT_D = 0,                      
 LEDDD_FT_C = 0,                      
 LEDDD_MRG_FT = 0,                      
 LEDDD_RUNNINGBAL = 0,
 LEDDD_CASH_COLL_HC = 0                      
                                                
 FROM                                                 
 (                         
      SELECT                               
  LEDDD_CASH_MARGIN = ISNULL(SUM(ACTUALCASH),0),                               
  --LEDDD_NONCASH_COLL_HC = ISNULL(SUM(EFFECTIVECOLL-ACTUALCASH),0),                               
  LEDDD_NONCASH_COLL_HC = ISNULL(SUM(NONCASH),0),                               
  PARTY_CODE                               
  FROM MSAJAG.DBO.COLLATERAL (NOLOCK)                               
  WHERE TRANS_DATE >= @FDATE                                                
       --AND CONVERT(VARCHAR,TRANS_DATE) < @FDATE + '23:59:00'                                         
         AND TRANS_DATE LIKE @FDATE + '%'                                         
       AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY                                                 
       AND EXCHANGE = 'BSX' AND SEGMENT = 'FUTURES'                                          
  GROUP BY PARTY_CODE                               
 ) C                               

                                             
/*====================================================================================                                                
 CLOSING BALANCE - CLIENT CASH INITIAL MARGIN A/C (B)                                    
 OPENING BALANCE - CLIENT CASH INITIAL MARGIN A/C                                                
====================================================================================*/       
                          
INSERT INTO #LEDGER_DETAILS_DAS                                                 
SELECT                                                 
 LEDDD_PARTY_CODE = PARTY_CODE,                                                
 LEDDD_SAUDA_DATE = @FDATE,                                              
 LEDDD_OPENING_BAL = 0,                       
 LEDDD_CHQ_REC = 0,                                                
 LEDDD_CHQ_PAY = 0,                                                
 LEDDD_JV_ENTRY = 0,                                                
 LEDDD_CLOSING_BAL = 0,                                                
 LEDDD_CASH_MARGIN = 0,                                                
 LEDDD_OPENING_INIT_MARGIN = SUM(OPENAMT),                      
 LEDDD_MRG_REC = 0,                                                
 LEDDD_MRG_REPAY = 0,                                      
 LEDDD_MRG_JV_ENTRY = 0,                          
 LEDDD_CLOSING_INIT_MARGIN = SUM(LEDDD_OPENING_INIT_MARGIN),                                                
 LEDDD_NONCASH_COLL_HC = 0,                                                
 LEDDD_INIT_EXPO_MARGIN = 0,                                               
 LEDDD_CREATED_BY = @UNAME,                                           
 LEDDD_CREATED_DT = GETDATE(),                      
 LEDDD_ADD_MARGIN = 0,      
 LEDDD_FT_D = 0,                      
 LEDDD_FT_C = 0,                      
 LEDDD_MRG_FT = 0,                      
 LEDDD_RUNNINGBAL = 0,
 LEDDD_CASH_COLL_HC = 0                      
                         
FROM                                                 
 (                               
 SELECT LEDDD_OPENING_INIT_MARGIN = SUM(T.AMOUNT), OPENAMT = SUM(T.OPENAMT), PARTY_CODE                               
 FROM                               
 (                              
  SELECT PARTY_CODE,           
         ISNULL(CASE WHEN DRCR='D' THEN SUM(-AMOUNT) ELSE SUM(AMOUNT) END,0) AS AMOUNT,                      
         OPENAMT = SUM(ISNULL(CASE WHEN VDT < @FDATE           
                                   THEN (CASE WHEN DRCR='D'           
                                              THEN -AMOUNT           
                                              ELSE AMOUNT END )           
       ELSE 0 END,0 ))                               
  FROM   ACCOUNTCURBFO..MARGINLEDGER L (NOLOCK),                                               
         ACCOUNTCURBFO..PARAMETER P (NOLOCK)                              
  WHERE  PARTY_CODE BETWEEN @FPARTY AND @TPARTY           
         AND VDT < @FDATE  + ' 23:59:59'                            
         AND  @FDATE BETWEEN SDTCUR AND LDTCUR            
         AND VDT >= SDTCUR           
         AND VDT <= LDTCUR                      
  GROUP BY PARTY_CODE,DRCR                   
                    
  UNION                  
                  
  SELECT PARTY_CODE,            
         AMOUNT = 0 ,                      
         OPENAMT = SUM(ISNULL(CASE WHEN VDT <= @FDATE           
                                   THEN (CASE WHEN DRCR='D'           
                                              THEN -AMOUNT           
                                              ELSE AMOUNT END )           
                                   ELSE 0 END,0 ))                               
  FROM   ACCOUNTCURBFO..MARGINLEDGER L (NOLOCK),                                               
         ACCOUNTCURBFO..PARAMETER P (NOLOCK)                              
  WHERE  PARTY_CODE BETWEEN @FPARTY AND @TPARTY                   
         AND VDT LIKE @FDATE + '%'           
         AND VTYP = 18                              
         AND @FDATE BETWEEN SDTCUR AND LDTCUR           
         AND VDT >= SDTCUR           
         AND VDT <= LDTCUR                      
  GROUP BY PARTY_CODE,DRCR                  
            
  /*UNION              
            
  SELECT PARTY_CODE,   
         ISNULL(CASE WHEN DRCR='D'           
                     THEN SUM(-AMOUNT)           
                     ELSE SUM(AMOUNT) END,0) AS AMOUNT,                      
         OPENAMT = 0                            
  FROM   ACCOUNTCURBFO..MARGINLEDGER L (NOLOCK),                                               
         ACCOUNTCURBFO..PARAMETER P (NOLOCK)                              
  WHERE  PARTY_CODE BETWEEN @FPARTY AND @TPARTY             
         AND VDT < = @FDATE + '23:59:59'    
         AND @FDATE BETWEEN SDTCUR AND LDTCUR            
         AND VDT >= SDTCUR AND VDT <= LDTCUR                      
  GROUP BY PARTY_CODE,DRCR */          
 )T                               
                GROUP BY T.PARTY_CODE             
) F                                               
GROUP BY                                                 
 PARTY_CODE                               
                                                
/*====================================================================================                                                
        INITIAL AND EXPOSURE MARGIN FOR TODAY (D)                                                
====================================================================================*/                                                
INSERT INTO #LEDGER_DETAILS_DAS                                                 
SELECT                                                 
 LEDDD_PARTY_CODE = PARTY_CODE,                                                
 LEDDD_SAUDA_DATE = @FDATE,                                              
 LEDDD_OPENING_BAL = 0,                                                 
 LEDDD_CHQ_REC = 0,                                                
 LEDDD_CHQ_PAY = 0,                                                
 LEDDD_JV_ENTRY = 0,                                                
 LEDDD_CLOSING_BAL = 0,                                                
 LEDDD_CASH_MARGIN = 0,                                           
 LEDDD_OPENING_INIT_MARGIN = 0,                                   
 LEDDD_MRG_REC = 0,                                                
 LEDDD_MRG_REPAY = 0,                                                
 LEDDD_MRG_JV_ENTRY = 0,                                                
 LEDDD_CLOSING_INIT_MARGIN = 0,                                                 
 LEDDD_NONCASH_COLL_HC = 0,                                                
 LEDDD_INIT_EXPO_MARGIN,                               
 LEDDD_CREATED_BY = @UNAME,                                              
 LEDDD_CREATED_DT = GETDATE(),                                         
 LEDDD_ADD_MARGIN = 0,      
 LEDDD_FT_D = 0,                      
 LEDDD_FT_C = 0,                      
 LEDDD_MRG_FT = 0,                      
 LEDDD_RUNNINGBAL = 0,
 LEDDD_CASH_COLL_HC = 0                      
                      
FROM                                          
    (                                                
     	SELECT LEDDD_INIT_EXPO_MARGIN = ISNULL(SUM(INTIAL_MARGIN),0), PARTY_CODE                               
 	FROM FOMARGINNEW (NOLOCK) WHERE PARTY_CODE BETWEEN @FPARTY AND @TPARTY AND MDATE LIKE @FDATE + '%'                                                
      	GROUP BY PARTY_CODE                               
    ) F                              
                                                
                      
/*====================================================================================                                                
        RUNNING BALANCE                                                
====================================================================================*/                                     
                      
IF (SELECT COUNT(1) FROM MASTER..SYSDATABASES WHERE NAME = 'ACCCOMMON') > 0
BEGIN

INSERT INTO #LEDGER_DETAILS_DAS                                                 
SELECT                                                 
 LEDDD_PARTY_CODE = PARTY_CODE, 
 LEDDD_SAUDA_DATE = @FDATE,                                              
 LEDDD_OPENING_BAL = 0,                                                 
 LEDDD_CHQ_REC = 0,                                                
 LEDDD_CHQ_PAY = 0,                                                
 LEDDD_JV_ENTRY = 0,                                                
 LEDDD_CLOSING_BAL = 0,                                                
 LEDDD_CASH_MARGIN = 0,                                                
 LEDDD_OPENING_INIT_MARGIN = 0,                      
 LEDDD_MRG_REC = 0,                                       
 LEDDD_MRG_REPAY = 0,                                      
 LEDDD_MRG_JV_ENTRY = 0,                                                
 LEDDD_CLOSING_INIT_MARGIN = 0,                      
 LEDDD_NONCASH_COLL_HC = 0,                                                
 LEDDD_INIT_EXPO_MARGIN = 0,                                               
 LEDDD_CREATED_BY = @UNAME,                                              
 LEDDD_CREATED_DT = GETDATE(),                      
 LEDDD_ADD_MARGIN = 0,      
 LEDDD_FT_D = 0,                      
 LEDDD_FT_C = 0,                      
 LEDDD_MRG_FT = 0,                      
 LEDDD_RUNNINGBAL = SUM(LEDDD_RUNNINGBAL),
 LEDDD_CASH_COLL_HC = 0                      
                                                
FROM                                                 
 (                               
 SELECT LEDDD_RUNNINGBAL = SUM(AMOUNT), PARTY_CODE                               
 FROM                               
 (                      
	SELECT PARTY_CODE=CLTCODE, ISNULL(CASE WHEN DRCR='D' THEN SUM(-VAMT) ELSE SUM(VAMT) END,0) AS AMOUNT                               
	FROM ACCCOMMON..LEDGER L (NOLOCK),                                               
	ACCOUNTCURBFO..PARAMETER P (NOLOCK)                              
	WHERE CLTCODE BETWEEN @FPARTY AND @TPARTY AND VDT <= @FDATE + ' 23:59:59'                          
	AND @FDATE BETWEEN SDTCUR AND LDTCUR                       
	AND VDT >= SDTCUR AND VDT <= LDTCUR                                                   
	GROUP BY CLTCODE,DRCR                      
 ) T                      
 GROUP BY T.PARTY_CODE                      
) F                                               
GROUP BY         
 F.PARTY_CODE                      
                      
END      
      
      
/*====================================================================================                              
        ADITIONAL MARGIN (E)                              
====================================================================================*/                              
/*INSERT INTO #LEDGER_DETAILS_DAS                               
SELECT                               
 LEDDD_PARTY_CODE = PARTY_CODE,                              
 LEDDD_SAUDA_DATE = @FDATE,                            
 LEDDD_OPENING_BAL = 0,                               
 LEDDD_CHQ_REC = 0,                              
 LEDDD_CHQ_PAY = 0,                              
 LEDDD_JV_ENTRY = 0,                              
 LEDDD_CLOSING_BAL = 0,                              
 LEDDD_CASH_MARGIN = 0,                         
 LEDDD_OPENING_INIT_MARGIN = 0,                              
 LEDDD_MRG_REC = 0,                              
 LEDDD_MRG_REPAY = 0,                              
 LEDDD_MRG_JV_ENTRY = 0,                              
 LEDDD_CLOSING_INIT_MARGIN = 0,                               
 LEDDD_NONCASH_COLL_HC = 0,                              
 LEDDD_INIT_EXPO_MARGIN = 0,             
 LEDDD_CREATED_BY = @UNAME,                            
 LEDDD_CREATED_DT = GETDATE(),      
 LEDDD_ADD_MARGIN = LEDDD_ADD_MARGIN,      
 LEDDD_FT_D = 0,                      
 LEDDD_FT_C = 0,                      
 LEDDD_MRG_FT = 0,                      
 LEDDD_RUNNINGBAL = 0,
 LEDDD_CASH_COLL_HC = 0

FROM                               
    (                              
	SELECT LEDDD_ADD_MARGIN = ISNULL(SUM(ADDMARGIN),0),PARTY_CODE FROM FOMARGINNEW (NOLOCK)      
	WHERE PARTY_CODE BETWEEN @FPARTY AND @TPARTY AND MDATE LIKE @FDATE + '%'      
	GROUP BY PARTY_CODE      
    ) F  

*/    
                      

UPDATE #LEDGER_DETAILS_DAS
SET  LEDDD_CASH_COLL_HC = G.AMOUNT FROM
	( 
	SELECT AMOUNT=ISNULL(SUM(AMOUNT),0),PARTY_CODE 
	FROM MSAJAG.DBO.COLLATERALDETAILS
	WHERE EFFDATE LIKE @FDATE +'%'
		AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY
		AND CASH_NCASH = 'C'
		AND Coll_Type <> 'MARGIN'
		AND EXCHANGE ='BSX' AND SEGMENT ='FUTURES'
	GROUP BY PARTY_CODE
	) G
	WHERE #LEDGER_DETAILS_DAS.LEDDD_PARTY_CODE=G.PARTY_CODE                     

/*====================================================================================                                                
 FINAL SELECT                                                
====================================================================================*/                                                
/*                          
SELECT                                                 
 LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,                    
 LEDDD_SAUDA_DATE = @FDATE,                                              
 LEDDD_OPENING_BAL = SUM(LEDDD_OPENING_BAL),                                                
 LEDDD_CHQ_REC = SUM(LEDDD_CHQ_REC),                                                
 LEDDD_CHQ_PAY = SUM(LEDDD_CHQ_PAY),                                                
 LEDDD_JV_ENTRY = SUM(LEDDD_JV_ENTRY),                                                
 LEDDD_CLOSING_BAL = SUM(LEDDD_CLOSING_BAL),                                          
 LEDDD_CASH_MARGIN = SUM(LEDDD_CASH_MARGIN),                                   
 LEDDD_OPENING_INIT_MARGIN = SUM(LEDDD_OPENING_INIT_MARGIN),                                                
 LEDDD_MRG_REC = SUM(LEDDD_MRG_REC),                          
 LEDDD_MRG_REPAY = SUM(LEDDD_MRG_REPAY),                                                
 LEDDD_MRG_JV_ENTRY = SUM(LEDDD_MRG_JV_ENTRY),                                                
 LEDDD_CLOSING_INIT_MARGIN = SUM(LEDDD_CLOSING_INIT_MARGIN),                                                
 LEDDD_NONCASH_COLL_HC = SUM(LEDDD_NONCASH_COLL_HC),                                                
 LEDDD_INIT_EXPO_MARGIN = SUM(LEDDD_INIT_EXPO_MARGIN),                                              
 LEDDD_CREATED_BY = @UNAME,                                              
 LEDDD_CREATED_DT = GETDATE()                                                
 FROM                      
 #LEDGER_DETAILS_DAS                          
 GROUP BY LEDDD_PARTY_CODE                                  
*/                          
                                               
INSERT INTO LEDGER_DETAILS_DAS --SELECT * FROM #LEDGER_DETAILS_DAS                                              
SELECT                                                 
 LEDDD_PARTY_CODE = LEDDD_PARTY_CODE,                                                
 LEDDD_SAUDA_DATE = @FDATE,                                              
 LEDDD_OPENING_BAL = SUM(LEDDD_OPENING_BAL),                                                
 LEDDD_CHQ_REC = SUM(LEDDD_CHQ_REC),                                      
 LEDDD_CHQ_PAY = SUM(LEDDD_CHQ_PAY),                                                
 LEDDD_JV_ENTRY = SUM(LEDDD_JV_ENTRY),                                                
 LEDDD_CLOSING_BAL = SUM(LEDDD_CLOSING_BAL),                                                
 LEDDD_CASH_MARGIN = SUM(LEDDD_CASH_MARGIN),                                                
 LEDDD_OPENING_INIT_MARGIN = SUM(LEDDD_OPENING_INIT_MARGIN),                                                
 LEDDD_MRG_REC = SUM(LEDDD_MRG_REC),                                                
 LEDDD_MRG_REPAY = SUM(LEDDD_MRG_REPAY),                                                
 LEDDD_MRG_JV_ENTRY = SUM(LEDDD_MRG_JV_ENTRY),                                                
 LEDDD_CLOSING_INIT_MARGIN = SUM(LEDDD_CLOSING_INIT_MARGIN),                                                
 LEDDD_NONCASH_COLL_HC = SUM(LEDDD_NONCASH_COLL_HC),                                                
 LEDDD_INIT_EXPO_MARGIN = SUM(LEDDD_INIT_EXPO_MARGIN),                                              
 LEDDD_CREATED_BY = @UNAME, 
 LEDDD_CREATED_DT = GETDATE(),      
 LEDDD_ADD_MARGIN = SUM(LEDDD_ADD_MARGIN),                      
 LEDDD_FT_D = SUM(LEDDD_FT_D),                      
 LEDDD_FT_C = SUM(LEDDD_FT_C),                      
 LEDDD_MRG_FT = SUM(LEDDD_MRG_FT),                      
 LEDDD_RUNNINGBAL = SUM(LEDDD_RUNNINGBAL),
 LEDDD_CASH_COLL_HC = SUM(LEDDD_CASH_COLL_HC)
FROM                                               
 #LEDGER_DETAILS_DAS                                                
GROUP BY LEDDD_PARTY_CODE                                      
                                              
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_MATURITYDATE_UPD
-- --------------------------------------------------
CREATE PROC [dbo].[PR_MATURITYDATE_UPD] 
(
	@SAUDADATE VARCHAR(11),
	@SYMBOL VARCHAR(12),
	@OLDMATURITYDATE VARCHAR(11),
	@NEWMATURITYDATE VARCHAR(11)
)
AS

DELETE
	FOSETTLEMENT 
WHERE
	LEFT(SAUDA_DATE,11) = @SAUDADATE 
	AND SYMBOL = @SYMBOL
	AND LEFT(EXPIRYDATE,11)= @OLDMATURITYDATE
	AND LEFT(INST_TYPE,3) = 'FUT'
	AND AUCTIONPART = 'EA'

UPDATE
	FOSCRIP2
SET
	MATURITYDATE = @NEWMATURITYDATE + ' 23:59'
WHERE
	SYMBOL = @SYMBOL
	AND LEFT(MATURITYDATE,11) = @OLDMATURITYDATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_MULTIISIN_IMP
-- --------------------------------------------------
CREATE  PROC  [dbo].[PR_MULTIISIN_IMP] 
	(
		@FILENAME VARCHAR(200)
	) AS
DECLARE @STRSQL VARCHAR(1000)

TRUNCATE TABLE MULTIISIN_IMP

SET @STRSQL = 'BULK INSERT  MULTIISIN_IMP FROM ''' + @FILENAME  + '''  WITH ( FIELDTERMINATOR = ''~'', ROWTERMINATOR = ''\N'' )'
EXEC(@STRSQL)

--DELETE DELIVERY_MULTIISIN FROM MULTIISIN_IMP WHERE LEFT(LTRIM(RTRIM(MULTIISIN_IMP.ISIN)),12) = DELIVERY_MULTIISIN.ISIN

INSERT INTO DELIVERY_MULTIISIN
SELECT 
	INST_TYPE = 'FUTCOM',
	SYMBOL = LEFT(SUBSTRING(SECNAME,1,CASE WHEN CHARINDEX(' ', SECNAME,1) > 0 THEN CHARINDEX(' ', SECNAME,1) ELSE 12  END),12),
	ISIN=LEFT(LTRIM(RTRIM(ISIN)),12),
	PERC = 0,
	STATUS = 'P',
	EFFDATE = DATEADD(M,-2,GETDATE()) ,
	WAREHOUSE = LEFT(UPPER(LTRIM(RTRIM(CITY))),20),
	CREATEDBY = ' ',
	CREATEDON = GETDATE(),
	MODIFIEDBY = ' ',
	MODIFIEDON = ' ',
	REMARK = 'FILE IMP'
FROM 
	MULTIISIN_IMP
WHERE
	UPPER(LTRIM(RTRIM(COMMTYPE1))) = 'COMMODITY'  AND 
	UPPER(LTRIM(RTRIM(STATUS2))) = 'ACTIVE'
	AND LEFT(LTRIM(RTRIM(ISIN)),12) NOT IN (SELECT ISIN FROM DELIVERY_MULTIISIN)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_SQLTABLEREINDEX
-- --------------------------------------------------
CREATE  PROC [dbo].[PR_SQLTABLEREINDEX] (@TABLE_NAME AS VARCHAR(254) = '') AS
/*--------------------------------------------------------------------------------------------------------------------
PROGRAM NAME 	: PR_SQLTABLEREINDEX
DESC 		: SQL SCRIPTS TO 
				1. RE INDEX ALL THE TRANSACTION ORIENTED TABLES
				2. CHECKING INDEX KEY DUPLICATION 
TABLES USING 	: 1. SQLTABLEINDEX  - KEEPING THE FOLLOWING DETAILS
			A. TABLENAME
			B. INDEXNAME
			C. INDEXCOLUMN
		  2.  SQLTABLEREINDEX_LOG - KEEPING RE INDEX LOG 
					    AND INDEX DUPLICATION RECORD
LOGIC 		: 
			CHECKING THE AVAILABILITY OF THE REQUIRED INDEX 
				IF FOUND  --  RE INDEX & LOG TO SQLTABLEREINDEX_LOG WITH A REMARK AS 'REINDEX'
				ELSE   - CREATE & LOG TO SQLTABLEREINDEX_LOG WITH A REMARK AS 'NEWINDEX'
				
			CHECKING THE INDEX KEY DUPLICATION
				IF FOUND  -- LOG TO SQLTABLEREINDEX_LOG WITH A REMARK AS 'DUPLICATE'
PROGRAM BENEFIT : 
			1. STANDARD TABLE INDEX TO MAINTAIN
			2. RE CREATION OF INDEX FOR PERFORMANCE

----------------------------------------------------------------------------------------------------------------------*/



DECLARE 
	@TABLECUR CURSOR,
	@TABLENAME VARCHAR(20),
	@INDEXNAME VARCHAR(10),
	@INDEXCOLUMN VARCHAR(100),
	@INDEXCOLUMNCHK VARCHAR(100)
DECLARE 
	@TINDEXNAME VARCHAR(20),
	@TINDEXCOLUM VARCHAR(100),
	@STRSQL VARCHAR(200),
	@INDEXCURSOR CURSOR,
	@INDEXFLAG INT,
	@INDEXPRV VARCHAR(20),
	@INDEXCOLUMNPRV VARCHAR(100),
 	@INDEXTYPE VARCHAR(20)

SET NOCOUNT ON

SET @TABLECUR = CURSOR FOR
SELECT
	TABLENAME,
	INDEXNAME,
	INDEXCOLUMN,
	INDEXCOLUMNCHK = LTRIM(RTRIM(UPPER(REPLACE(INDEXCOLUMN,',',''))))
FROM
	SQLTABLEINDEX
WHERE
	1 = 1
	AND TABLENAME = (CASE WHEN ISNULL(@TABLE_NAME,'') <> '' THEN @TABLE_NAME ELSE TABLENAME END) 


OPEN @TABLECUR
FETCH NEXT FROM @TABLECUR INTO 	@TABLENAME,@INDEXNAME,@INDEXCOLUMN,@INDEXCOLUMNCHK
WHILE @@FETCH_STATUS = 0       
BEGIN      
	SET @INDEXFLAG  = 0
	SET @INDEXCOLUMNPRV = ''
	SET @INDEXPRV = ''
	SET @INDEXCURSOR = CURSOR FOR SELECT * FROM 
	(
		SELECT 
			I.NAME AS INDEXNAME,
			CASE WHEN (I.STATUS & 16)<> 0 THEN 'CLUSTERED' 
			ELSE 'NONCLUSTERED' END AS INDEXTYPE,
			UPPER(ISNULL(INDEX_COL(@TABLENAME, I.INDID,1 ),'')+ISNULL(INDEX_COL(@TABLENAME, I.INDID,2 ),'')
			+ISNULL(INDEX_COL(@TABLENAME, I.INDID,3 ),'')+ISNULL(INDEX_COL(@TABLENAME, I.INDID,4 ),'')
			+ISNULL(INDEX_COL(@TABLENAME, I.INDID,5 ),'')+ISNULL(INDEX_COL(@TABLENAME, I.INDID,6),'')
			+ISNULL(INDEX_COL(@TABLENAME, I.INDID,7 ),'')+ISNULL(INDEX_COL(@TABLENAME, I.INDID,8),'') ) AS INDEXCOLUMNS
		FROM 
			(DBO.SYSINDEXES I INNER JOIN DBO.SYSFILEGROUPS S ON I.GROUPID = S.GROUPID )
		WHERE 
			ID = OBJECT_ID(@TABLENAME) AND I.INDID > 0 AND I.INDID < 255 AND
			(INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISSTATISTICS') <> 1) AND
			(INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISAUTOSTATISTICS') <> 1) AND
			(INDEXPROPERTY(OBJECT_ID(@TABLENAME), I.NAME, N'ISHYPOTHETICAL') <> 1)
		 
	)TBLIDX  ORDER BY INDEXCOLUMNS
	OPEN @INDEXCURSOR
	FETCH NEXT FROM @INDEXCURSOR INTO @TINDEXNAME,@INDEXTYPE,@TINDEXCOLUM
	WHILE @@FETCH_STATUS = 0       
	BEGIN     
		IF @INDEXCOLUMNPRV = @TINDEXCOLUM
			BEGIN
				INSERT INTO SQLTABLEREINDEX_LOG VALUES 
				(@TABLENAME,@INDEXPRV,@TINDEXCOLUM,'DUPLICATE',@@SPID,GETDATE())	
			END 
		IF (@TINDEXCOLUM = @INDEXCOLUMNCHK OR @INDEXNAME = @TINDEXNAME) AND @INDEXFLAG =0
			BEGIN
				SET @INDEXFLAG  = 1
				SET @STRSQL = 'CREATE ' + @INDEXTYPE + ' INDEX ['+ @TINDEXNAME +'] ON [DBO].['+@TABLENAME+']('
				SET @STRSQL = @STRSQL + @INDEXCOLUMN + ')'
				SET @STRSQL = @STRSQL + ' WITH  DROP_EXISTING ON [PRIMARY]'
				EXEC (@STRSQL)
				INSERT INTO SQLTABLEREINDEX_LOG VALUES 
				(@TABLENAME,@TINDEXNAME,@INDEXCOLUMN,'REINDEX',@@SPID,GETDATE())
			END
		SET @INDEXPRV = @TINDEXNAME
		SET @INDEXCOLUMNPRV = @TINDEXCOLUM
		FETCH NEXT FROM @INDEXCURSOR INTO @TINDEXNAME,@INDEXTYPE,@TINDEXCOLUM
	END      
	CLOSE @INDEXCURSOR      
	DEALLOCATE @INDEXCURSOR
	IF @INDEXFLAG =0
		BEGIN
			SET @STRSQL = 'CREATE INDEX ['+ @INDEXNAME +'] ON [DBO].['+@TABLENAME+']('
			SET @STRSQL = @STRSQL + @INDEXCOLUMN + ')'
			EXEC (@STRSQL)
			INSERT INTO SQLTABLEREINDEX_LOG VALUES 
			(@TABLENAME,@INDEXNAME,@INDEXCOLUMN,'NEWINDEX',@@SPID,GETDATE())
		END
	FETCH NEXT FROM @TABLECUR INTO 	@TABLENAME,@INDEXNAME,@INDEXCOLUMN,@INDEXCOLUMNCHK
END
CLOSE @TABLECUR      
DEALLOCATE @TABLECUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_VALIDATE_CLIENT
-- --------------------------------------------------
  
  
CREATE PROC [dbo].[PR_VALIDATE_CLIENT] AS  
  
EXEC FOTRD_CLIENTMASTER  
  
SELECT FOTRADE.* INTO #FOERRTRADE   
FROM FOTRADE (NOLOCK), FOOWNER (NOLOCK) WHERE EXISTS (SELECT PARTY_CODE FROM CLIENT2 (NOLOCK)  
WHERE CLIENT2.PARTY_CODE = FOTRADE.PARTY_CODE AND CLIENT2.BANKID <> FOTRADE.PARTICIPANTCODE)  
AND ISNULL(PARTICIPANTCODE,'') <> ''  
AND PARTICIPANTCODE <> FOOWNER.MEMBERCODE  
  
INSERT INTO FOERRTRADE        
SELECT * FROM #FOERRTRADE  
  
SELECT PARTY_CODE,'IN ACTIVE' FROM FOTRD_CLIENT2 (NOLOCK), CLIENT5 (NOLOCK) WHERE FOTRD_CLIENT2.CL_CODE = CLIENT5.CL_CODE  
AND CLIENT5.INACTIVEFROM <= GETDATE()  
  
/*UNION ALL  
  
SELECT C.PARTY_CODE,'EXPIRED SEBI REG' FROM   
FOTRD_CLIENT2 (NOLOCK), CLIENT_DETAILS_VIEW C (NOLOCK) WHERE FOTRD_CLIENT2.CL_CODE = C.CL_CODE  
AND ISNULL(C.SEBI_REGN_NO,'') <> '' AND C.SEBI_EXP_DATE <= GETDATE()*/  
  
/*UNION ALL  
  
SELECT DISTINCT PARTY_CODE,'WRONG CP CODE' FROM #FOERRTRADE */

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_VALIDATEFILE
-- --------------------------------------------------


CREATE PROC [dbo].[PR_VALIDATEFILE]
(
	@FILETYPE VARCHAR(20),
	@FILENAME VARCHAR(100),
	@TRADEDATE VARCHAR(11)
) AS

DECLARE @INTRESULT INT
DECLARE @FILEDATE_V VARCHAR(12)
DECLARE @FILEDATE VARCHAR(12)
DECLARE @ERRDESC VARCHAR(20)

SET @INTRESULT = 1
SET @ERRDESC =''



IF @FILETYPE = 'CONTRACT MASTER'
BEGIN	
	IF LEFT(@FILENAME,6) <> 'BFX_CO'
	BEGIN
		SET @INTRESULT = 0	
		SET @ERRDESC = 'WRONG FILE TYPE'
	END
END

IF @FILETYPE = 'TRADE'
BEGIN	
	IF LEFT(@FILENAME,6) <> 'BFX_TR'
	BEGIN
		SET @INTRESULT = 0	
		SET @ERRDESC = 'WRONG FILE TYPE'
	END
END

IF @FILETYPE = 'CLOSING RATE'
BEGIN	
	IF LEFT(@FILENAME,6) <>  'BFX_MS'
	BEGIN
		SET @INTRESULT = 0	
		SET @ERRDESC = 'WRONG FILE TYPE'
	END
END


IF @FILETYPE = 'POSITION FILE'
BEGIN	
	IF LEFT(@FILENAME,6) <> 'BFX_PO'
	BEGIN
		SET @INTRESULT = 0	
		SET @ERRDESC = 'WRONG FILE TYPE'
	END
END


IF @FILETYPE = 'MARGIN FILE'
BEGIN	
	IF LEFT(@FILENAME,6) <> 'BFX_MG'
	BEGIN
		SET @INTRESULT = 0	
		SET @ERRDESC = 'WRONG FILE TYPE'
	END
END



IF @FILETYPE <> 'CONTRACT MASTER'
BEGIN
	IF @INTRESULT = 1
	BEGIN
		SET @FILEDATE_V = LEFT(RIGHT(@FILENAME,15),8)
		
		IF LEN(@FILEDATE_V) <> 8
		BEGIN
			SET @INTRESULT = 0
			SET @ERRDESC = 'WRONG FILE NAME'		
		END	 
		ELSE
		BEGIN
			IF @FILEDATE <> LEFT(CONVERT(DATETIME,@TRADEDATE),11)
			BEGIN
				SET @INTRESULT = 0	
				SET @ERRDESC = 'DATE MISMATCH'			
			END
		END
	END
END

SELECT @INTRESULT, @ERRDESC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PR_VALIDATEFILE_BKUP_19AUG2019
-- --------------------------------------------------


CREATE PROC [dbo].[PR_VALIDATEFILE_BKUP_19AUG2019]
(
	@FILETYPE VARCHAR(20),
	@FILENAME VARCHAR(100),
	@TRADEDATE VARCHAR(11)
) AS

DECLARE @INTRESULT INT
DECLARE @FILEDATE_V VARCHAR(12)
DECLARE @FILEDATE VARCHAR(12)
DECLARE @ERRDESC VARCHAR(20)

SET @INTRESULT = 1
SET @ERRDESC =''

-- Exec PR_VALIDATEFILE 'CONTRACT MASTER','BFX_CC_CO240419.csv','Jun 20 2019'


IF @FILETYPE = 'CONTRACT MASTER'
BEGIN	
	IF LEFT(@FILENAME,6) <> 'BFX_CC'
	BEGIN
		SET @INTRESULT = 0	
		SET @ERRDESC = 'WRONG FILE TYPE'
	END
END

IF @FILETYPE = 'TRADE'
BEGIN	
	IF LEFT(@FILENAME,6) <> 'BFX_TR'
	BEGIN
		SET @INTRESULT = 0	
		SET @ERRDESC = 'WRONG FILE TYPE'
	END
END

IF @FILETYPE = 'CLOSING RATE'
BEGIN	
	IF LEFT(@FILENAME,6) <>  'BFX_MS'
	BEGIN
		SET @INTRESULT = 0	
		SET @ERRDESC = 'WRONG FILE TYPE'
	END
END


IF @FILETYPE = 'POSITION FILE'
BEGIN	
	IF LEFT(@FILENAME,6) <> 'BFX_PO'
	BEGIN
		SET @INTRESULT = 0	
		SET @ERRDESC = 'WRONG FILE TYPE'
	END
END


IF @FILETYPE = 'MARGIN FILE'
BEGIN	
	IF LEFT(@FILENAME,6) <> 'BFX_MG'
	BEGIN
		SET @INTRESULT = 0	
		SET @ERRDESC = 'WRONG FILE TYPE'
	END
END



IF @FILETYPE <> 'CONTRACT MASTER'
BEGIN
	IF @INTRESULT = 1
	BEGIN
		SET @FILEDATE_V = LEFT(RIGHT(@FILENAME,15),8)
		
		IF LEN(@FILEDATE_V) <> 8
		BEGIN
			SET @INTRESULT = 0
			SET @ERRDESC = 'WRONG FILE NAME'		
		END	 
		ELSE
		BEGIN
			IF @FILEDATE <> LEFT(CONVERT(DATETIME,@TRADEDATE),11)
			BEGIN
				SET @INTRESULT = 0	
				SET @ERRDESC = 'DATE MISMATCH'			
			END
		END
	END
END

SELECT @INTRESULT, @ERRDESC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_ALLOCATIONMAPPING
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_ALLOCATIONMAPPING] (@USERNAME VARCHAR(20) = '') AS

UPDATE FOEXERCISEALLOCATION_TEMP SET FOEA_OPTION_TYPE = '' WHERE FOEA_OPTION_TYPE IS NULL


UPDATE FOEXERCISEALLOCATION_TEMP SET FOEA_PARTY_CODE = A.NEWPARTY_CODE FROM  PARTYMAPPING A WHERE A.OLDPARTY_CODE = FOEXERCISEALLOCATION_TEMP.FOEA_PARTY_CODE

/*----------------------------------- PROCESS CONTROLER PLUG IN ---------------------------------------*/
DECLARE @SAUDADATE VARCHAR(11)
SET @SAUDADATE = (SELECT TOP 1 LEFT(FOEA_POSITION_DATE,11)  FROM FOEXERCISEALLOCATION_TEMP)

IF (SELECT COUNT(1)  
  FROM   (SELECT TOP 1 BUSINESS_DATE  
          FROM   V2_BUSINESS_PROCESS  
          WHERE  LEFT(BUSINESS_DATE,11) = @SAUDADATE) A) = 0  
BEGIN    
	INSERT INTO V2_BUSINESS_PROCESS 
		(
			BUSINESS_DATE,IMPORT_TRADE,VBB,STT,BILLING,CONTRACT,
			POSTING,POSITIONFILE,MARGINFILE,MARGINRETURNFILE,CLIENTMARGINPOP,
			EXCHANGESTT,EXERCISEALLOCATION,OPEN_CLOSE,PROCESSDATE,
			PROCESSBY,LASTUPDATEDATE,LASTUPDATEBY,MACHINEIP
		)
	SELECT 	
		BUSINESS_DATE = @SAUDADATE,
		IMPORT_TRADE = 1,
		VBB = 1,
		STT = 1,
		BILLING = 0,
		CONTRACT = 0,
		POSTING = 0,
		POSITIONFILE = 1,
		MARGINFILE = 0,
		MARGINRETURNFILE = 0,
		CLIENTMARGINPOP = 0,
		EXCHANGESTT = 0,
		EXERCISEALLOCATION = 0,
		OPEN_CLOSE = 0,
		PROCESSDATE = GETDATE(),
		PROCESSBY =@USERNAME,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY ='',
		MACHINEIP =''
END
ELSE
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 
		POSITIONFILE = POSITIONFILE + 1 ,
		LASTUPDATEDATE = GETDATE()
	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @SAUDADATE
END

IF (SELECT COUNT(1)  
	FROM   (SELECT TOP 1 FOEA_POSITION_DATE  
        	  FROM   FOEXERCISEALLOCATION_TEMP  
	          WHERE  FOEA_EXERCISE_QTY+FOEA_ALLOC_QTY > 0) A) > 0 
	BEGIN
		UPDATE 
			V2_BUSINESS_PROCESS 
		SET 
			EXERCISEALLOCATION = -1 ,
			LASTUPDATEDATE = GETDATE()
		WHERE 
			LEFT(BUSINESS_DATE,11) = @SAUDADATE		
	END

INSERT INTO V2_PROCESS_STATUS_LOG 
( 
	EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,
	FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP
)
SELECT
	EXCHANGE=(SELECT TOP 1 EXCHANGE FROM FOTAXES),
	SEGMENT='FUTURES',
	BUSINESSDATE=@SAUDADATE,
	PROCESSID = 'POSIMP',
	PROCESSNAME='POSITION FILE IMPORT',
	FILENAME='',
	START_END_FLAG=1,
	PROCESSDATE=GETDATE(),
	PROCESSBY=@USERNAME,
	MACHINEIP=''

/*------------------------------------------------------------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_BULK_INS
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_BULK_INS] (@FILENAME VARCHAR(200), @PARSESTRING VARCHAR(2) = ',') AS 

DECLARE @STRSQL VARCHAR(500)


DELETE CLASSFILEUPD_BULK WHERE SPID = @@SPID

SET @STRSQL = 'BULK INSERT  CLASSFILEUPD_BULK_VIEW FROM ''' + @FILENAME  + '''  WITH ( FIELDTERMINATOR = ''' + @PARSESTRING + ''', ROWTERMINATOR = ''\N'' )'
EXEC(@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MARGIN_REPORTING
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_MARGIN_REPORTING]
(
           @SAUDA_DATE VARCHAR(11),
           @FROMPARTY  VARCHAR(10)='',
           @TOPARTY    VARCHAR(10)='ZZZZZZZZZZ'
)
AS

  DECLARE  @PREVDATE VARCHAR(11)
  DECLARE  @SDTCUR VARCHAR(11)
  DECLARE  @LDTCUR VARCHAR(11)
                     
  SELECT @PREVDATE = LEFT(MAX(TRADE_DATE),11)
  FROM   FOCLOSING
  WHERE  TRADE_DATE < @SAUDA_DATE

SELECT	@SDTCUR = LEFT(SDTCUR,11) ,
	@LDTCUR = LEFT(LDTCUR,11)
FROM	ACCOUNTCURBFO.DBO.PARAMETER P
WHERE	@SAUDA_DATE BETWEEN SDTCUR AND LDTCUR 

CREATE TABLE #MARGINREPORTING
(
	PARTY_CODE 	VARCHAR(12),
	PREV_CASH  	NUMERIC(18,4),
	PREV_FD  	NUMERIC(18,4),
	PREV_BG 	NUMERIC(18,4),
	PREV_SEC  	NUMERIC(18,4),
	PREV_VAR  	NUMERIC(18,4),
	CURR_CASH  	NUMERIC(18,4),
	CURR_FD  	NUMERIC(18,4),
	CURR_BG  	NUMERIC(18,4),
	CURR_SEC  	NUMERIC(18,4),
	MAR_ADJUST  	NUMERIC(18,4),
	MAR_STATUS  	NUMERIC(18,4)
)
 
 CREATE  INDEX [MINDX] ON [DBO].[#MARGINREPORTING] ( [PARTY_CODE])

  INSERT INTO   #MARGINREPORTING                     
  SELECT DISTINCT PARTY_CODE,
                  PREV_CASH = 0,
                  PREV_FD = 0,
                  PREV_BG = 0,
                  PREV_SEC = 0,
                  PREV_VAR = 0,
                  CURR_CASH = 0,
                  CURR_FD = 0,
                  CURR_BG = 0,
                  CURR_SEC = 0,
                  MAR_ADJUST = 0,
                  MAR_STATUS = 0
  FROM   FOMARGINNEW
  WHERE  MDATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'
         AND CLIENT_TYPE <> 'TM'

                        
  UPDATE #MARGINREPORTING
  SET    PREV_CASH = C.CASH,
         PREV_FD = C.FD,
         PREV_BG = C.BG,
         PREV_SEC = C.SEC
  FROM   (SELECT   PARTY_CODE=PARENTCODE,
                   FD = SUM(CASE 
                              WHEN COLL_TYPE = 'FD' THEN FINALAMOUNT
                              ELSE 0
                            END),
                   BG = SUM(CASE 
                              WHEN COLL_TYPE = 'BG' THEN FINALAMOUNT
                              ELSE 0
                            END),
                   SEC = SUM(CASE 
                               WHEN COLL_TYPE = 'SEC' THEN FINALAMOUNT
                               ELSE 0
                             END),
                   CASH = SUM(CASE 
                                WHEN COLL_TYPE = 'MARGIN' THEN FINALAMOUNT
                                ELSE 0
                              END)
          FROM     MSAJAG.DBO.COLLATERALDETAILS C, CLIENT2_VIEW (NOLOCK)
          WHERE    
		   C.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE
		   AND EFFDATE BETWEEN @PREVDATE  AND @PREVDATE + ' 23:59'
                   AND C.EXCHANGE = (SELECT EXCHANGE FROM FOGLOBALS)
                   AND C.SEGMENT = 'FUTURES'
          GROUP BY PARENTCODE) C
  WHERE  #MARGINREPORTING.PARTY_CODE = C.PARTY_CODE
                                       
  UPDATE #MARGINREPORTING
  SET    PREV_VAR = MARGIN
  FROM   (SELECT   PARTY_CODE,
                   MARGIN = SUM(TOTAL_MARGIN + EXTREME_LOSS_MARGIN)
       	  FROM     FOMARGINNEW
          WHERE    MDATE BETWEEN @PREVDATE  AND  @PREVDATE + ' 23:59'
                   AND CLIENT_TYPE <> 'TM'
                   AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
          GROUP BY PARTY_CODE) C
  WHERE  #MARGINREPORTING.PARTY_CODE = C.PARTY_CODE
                                      
                                      
  UPDATE #MARGINREPORTING
  SET    CURR_CASH = C.CASH - PREV_CASH,
         CURR_FD = C.FD - PREV_FD,
         CURR_BG = C.BG - PREV_BG,
         CURR_SEC = C.SEC - PREV_SEC
  FROM   (SELECT   PARTY_CODE=PARENTCODE,
                   FD = SUM(CASE 
                              WHEN COLL_TYPE = 'FD' THEN FINALAMOUNT
                              ELSE 0
                            END),
                   BG = SUM(CASE 
                              WHEN COLL_TYPE = 'BG' THEN FINALAMOUNT
                              ELSE 0
                            END),
          SEC = SUM(CASE 
                               WHEN COLL_TYPE = 'SEC' THEN FINALAMOUNT
                               ELSE 0
                             END),
                   CASH = SUM(CASE 
                                WHEN COLL_TYPE = 'MARGIN' THEN FINALAMOUNT
                                ELSE 0
                              END)
          FROM     MSAJAG.DBO.COLLATERALDETAILS C, CLIENT2_VIEW (NOLOCK)
          WHERE    C.PARTY_CODE = CLIENT2_VIEW.PARTY_CODE
		   AND EFFDATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'
                   AND C.EXCHANGE = (SELECT EXCHANGE FROM FOGLOBALS)
                   AND C.SEGMENT = 'FUTURES'
          GROUP BY PARENTCODE) C
  WHERE  #MARGINREPORTING.PARTY_CODE = C.PARTY_CODE

  UPDATE #MARGINREPORTING
  SET    PREV_CASH = PREV_CASH + LEDBAL
  FROM   (SELECT   CLTCODE=PARENTCODE,
                   LEDBAL = SUM(CASE 
                                  WHEN DRCR = 'C' THEN VAMT
                                  ELSE -VAMT
                                END)
          FROM  ACCOUNTCURBFO.DBO.LEDGER L, 
				CLIENT2_VIEW (NOLOCK),
				ACCOUNTCURBFO.DBO.PARAMETER P  
          WHERE    
		   CLTCODE = CLIENT2_VIEW.PARTY_CODE
		   AND VDT BETWEEN SDTCUR AND LDTCUR
		   AND @SAUDA_DATE BETWEEN SDTCUR AND LDTCUR
           AND VDT < @SAUDA_DATE
           AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
          GROUP BY PARENTCODE) L
  WHERE  L.CLTCODE = #MARGINREPORTING.PARTY_CODE
                    
  UPDATE #MARGINREPORTING
  SET    CURR_CASH = CURR_CASH + LEDBAL
  FROM   (SELECT   CLTCODE=PARENTCODE,
                   LEDBAL = SUM(CASE 
                                  WHEN DRCR = 'C' THEN VAMT
                                  ELSE -VAMT
                                END)
          FROM     ACCOUNTCURBFO.DBO.LEDGER L, CLIENT2_VIEW (NOLOCK)
          WHERE    CLTCODE = CLIENT2_VIEW.PARTY_CODE 
		   AND VDT >= @SDTCUR
                   AND VDT <= @LDTCUR + ' 23:59'
                   AND VDT BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'
                   AND CLTCODE BETWEEN @FROMPARTY AND @TOPARTY
          GROUP BY PARENTCODE) L
  WHERE  L.CLTCODE = #MARGINREPORTING.PARTY_CODE
  
                       
  UPDATE #MARGINREPORTING
  SET    MAR_ADJUST = MARGIN -PREV_VAR
  FROM   (SELECT   PARTY_CODE,
                   MARGIN = SUM(TOTAL_MARGIN + EXTREME_LOSS_MARGIN)
          FROM     FOMARGINNEW
          WHERE    MDATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'
                   AND CLIENT_TYPE <> 'TM'
                   AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
     GROUP BY PARTY_CODE) C
  WHERE  #MARGINREPORTING.PARTY_CODE = C.PARTY_CODE
                                       
  UPDATE #MARGINREPORTING
  SET    MAR_STATUS = PREV_CASH + PREV_FD + PREV_BG + PREV_SEC - PREV_VAR + 
	 CURR_CASH + CURR_FD + CURR_BG + CURR_SEC - MAR_ADJUST
                                                                                                                       
  DELETE FROM MARGIN_REPORTING
  WHERE       SAUDA_DATE = @SAUDA_DATE
              AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
                                                    
  INSERT INTO MARGIN_REPORTING
  SELECT @SAUDA_DATE,
         *,
         GETDATE()
  FROM   #MARGINREPORTING

  DROP TABLE #MARGINREPORTING

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_MARGINMAPPING
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_MARGINMAPPING] AS  
  
UPDATE FOMARGINNEW_IMP SET PARTY_CODE = A.NEWPARTY_CODE FROM  PARTYMAPPING  A WHERE A.OLDPARTY_CODE = FOMARGINNEW_IMP.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TRADE_TRANSFER_ISETL
-- --------------------------------------------------
CREATE   PROC [dbo].[PROC_TRADE_TRANSFER_ISETL] 
(            
	@SAUDA_DATE      VARCHAR(11),            
	@PARTYFROM       VARCHAR(10),             
	@PARTYTO         VARCHAR(10),            
	@INST_TYPE       VARCHAR(6) ,            
	@SYMBOL          VARCHAR(12),            
	@EXPIRY_DATE     VARCHAR(11),            
	@STRIKE_PRICE    MONEY      ,            
	@OPTION_TYPE     VARCHAR(2) ,             
	@SELL_BUY       INT        ,            
	@PARTICIPANTCODE VARCHAR(15),             
	@CONTRACTNO      VARCHAR(7) ,             
	@ORDER_NO    VARCHAR(20),            
	@TRADE_NO        VARCHAR(14),            
	@ACTUALQTY       INT        ,            
	@QTYTOTRANSFER   INT        ,
	@STATUSID	 VARCHAR(50) ='',
	@STRMODULE       VARCHAR(50) =''
) AS            
            
DECLARE             
@TRADECURSOR     CURSOR     ,            
@CONTRACTNOCUR   CURSOR     ,            
@QTYINTRADE      INT        ,            
@NEW_TRADE_NO    VARCHAR(14),            
@NEW_CONTRACTNO  VARCHAR(7) ,            
@BILLNO   INT        ,            
@STYLE           INT    ,            
@CLTYPE      VARCHAR(3) ,            
@CONTSTYLE       CHAR(1)            
            
SELECT @NEW_CONTRACTNO = 0             
/*          
SET @CONTRACTNOCUR = CURSOR FOR            
SELECT CONTRACTNO FROM FOSETTLEMENT             
WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'            
AND PARTY_CODE = @PARTYTO AND RESERVED1 = 0             
OPEN @CONTRACTNOCUR            
FETCH NEXT FROM @CONTRACTNOCUR INTO @NEW_CONTRACTNO            
CLOSE @CONTRACTNOCUR            
DEALLOCATE @CONTRACTNOCUR            
*/          
          
--IF @@FETCH_STATUS <> 0             
--BEGIN         
IF @STRMODULE <> ''
BEGIN   
	EXEC CONSOLE_LOG  @PARTYFROM,@PARTYTO,@SAUDA_DATE,@INST_TYPE,@SYMBOL,@EXPIRY_DATE,@STRIKE_PRICE,@OPTION_TYPE,
	@ORDER_NO,@TRADE_NO,@SELL_BUY,@CONTRACTNO,'',0,0,0,0,0,0,@ACTUALQTY,@QTYTOTRANSFER,0,@PARTICIPANTCODE,'',@STATUSID,@STRMODULE,'PROC_TRADE_TRANSFER_ISETL'
END

 SET @NEW_CONTRACTNO = 0            
  SELECT @CLTYPE = CL_TYPE,@CONTSTYLE=C2.INSCONT FROM CLIENT1 C1, CLIENT2 C2 WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = @PARTYTO            
  IF @CLTYPE <> 'PRO'             
  BEGIN                  
     IF @PARTYFROM <> @PARTYTO AND @CONTSTYLE = 'S'            
      BEGIN            
          SELECT TOP 1 @NEW_CONTRACTNO=ISNULL(CONTRACTNO,0) FROM FOSETTLEMENT 
			WHERE SAUDA_DATE LIKE @SAUDA_DATE  + '%' 
			AND PARTY_CODE = @PARTYTO              
			/*AND DUMMY1 = 0*/ 
			AND INST_TYPE = @INST_TYPE
			AND SYMBOL = @SYMBOL      
			AND EXPIRYDATE LIKE  @EXPIRY_DATE +'%'
			AND STRIKE_PRICE = @STRIKE_PRICE
			AND OPTION_TYPE =@OPTION_TYPE  			    
			AND RESERVED1 = 1 
			AND TRADEQTY <> 0  
			AND CONTRACTNO <> 0 
      END            
      IF @PARTYFROM <> @PARTYTO AND @CONTSTYLE = 'N'            
        BEGIN            
            SELECT TOP 1 @NEW_CONTRACTNO=ISNULL(CONTRACTNO,0) FROM FOSETTLEMENT WHERE PARTY_CODE = @PARTYTO              
             /*AND DUMMY1 = 0*/ AND RESERVED1 = 1 AND TRADEQTY <> 0  AND CONTRACTNO <> 0            
      			 AND SAUDA_DATE LIKE @SAUDA_DATE  + '%'  
        END            
  IF LEN(@NEW_CONTRACTNO) = 1      
   BEGIN           
          SELECT @NEW_CONTRACTNO = CONVERT(INT,CONTRACTNO) + 1  FROM CONTGEN             
                       WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE            
                   
          UPDATE CONTGEN SET CONTRACTNO = @NEW_CONTRACTNO             
                       WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE            
                   
          SELECT @NEW_CONTRACTNO = STUFF('0000000', 8 - LEN(@NEW_CONTRACTNO), LEN(@NEW_CONTRACTNO), @NEW_CONTRACTNO)                   
   END      
 END        
--END            
            
SELECT @BILLNO = 0             
            
IF @ACTUALQTY = @QTYTOTRANSFER             
BEGIN            
 INSERT INTO FOSETTLEMENT             
 SELECT @NEW_CONTRACTNO,BILLNO,LEFT('R'+TRADE_NO,14),@PARTYTO,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,            
        OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,            
        SAUDA_DATE,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,            
        BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,            
        BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,            
        BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2            
 FROM FOSETTLEMENT             
 WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'            
        AND PARTY_CODE = @PARTYFROM            
        AND INST_TYPE = @INST_TYPE            
        AND SYMBOL = @SYMBOL            
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'            
        AND STRIKE_PRICE = @STRIKE_PRICE            
        AND OPTION_TYPE = @OPTION_TYPE            
 AND RESERVED1 = 1             
        AND SELL_BUY = @SELL_BUY            
        AND PARTICIPANTCODE = @PARTICIPANTCODE            
        AND CONTRACTNO = @CONTRACTNO          
        AND ORDER_NO LIKE @ORDER_NO            
        AND TRADE_NO LIKE @TRADE_NO            
            
            
 UPDATE FOSETTLEMENT SET TRADEQTY = 0, PRICE = 0, NETRATE = 0, BROKAPPLIED = 0,             
 NBROKAPP = 0, N_NETRATE = 0, SERVICE_TAX = 0, NSERTAX = 0, AMOUNT = 0, TRADE_AMOUNT = 0,            
 INS_CHRG = 0, TURN_TAX = 0, OTHER_CHRG = 0, SEBI_TAX = 0, BROKER_CHRG = 0             
 WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'            
        AND PARTY_CODE = @PARTYFROM            
        AND INST_TYPE = @INST_TYPE            
        AND SYMBOL = @SYMBOL            
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'            
        AND STRIKE_PRICE = @STRIKE_PRICE            
        AND OPTION_TYPE = @OPTION_TYPE            
 AND RESERVED1 = 1             
        AND SELL_BUY = @SELL_BUY            
        AND PARTICIPANTCODE = @PARTICIPANTCODE            
        AND CONTRACTNO = @CONTRACTNO            
        AND ORDER_NO LIKE @ORDER_NO            
        AND TRADE_NO LIKE @TRADE_NO            
            
END            
ELSE            
BEGIN            
    SET @TRADECURSOR = CURSOR FOR            
        SELECT TRADEQTY, TRADE_NO FROM FOSETTLEMENT            
        WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'            
        AND PARTY_CODE = @PARTYFROM            
        AND INST_TYPE = @INST_TYPE            
        AND SYMBOL = @SYMBOL            
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'            
        AND STRIKE_PRICE = @STRIKE_PRICE            
        AND OPTION_TYPE = @OPTION_TYPE            
 AND RESERVED1 = 1             
        AND SELL_BUY = @SELL_BUY            
        AND PARTICIPANTCODE = @PARTICIPANTCODE            
        AND CONTRACTNO = @CONTRACTNO            
        AND ORDER_NO LIKE @ORDER_NO            
        AND TRADE_NO LIKE @TRADE_NO            
 ORDER BY TRADEQTY DESC             
            
        OPEN @TRADECURSOR             
        FETCH NEXT FROM @TRADECURSOR INTO @QTYINTRADE, @NEW_TRADE_NO            
 WHILE @@FETCH_STATUS = 0 AND @QTYTOTRANSFER > 0             
 BEGIN            
  IF @QTYTOTRANSFER >= @QTYINTRADE            
  BEGIN            
   INSERT INTO FOSETTLEMENT             
   SELECT @NEW_CONTRACTNO,BILLNO,LEFT('R'+TRADE_NO,14),@PARTYTO,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,            
          OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,            
          SAUDA_DATE,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,            
          BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,            
          BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,            
          BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2            
   FROM FOSETTLEMENT             
   WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'            
          AND PARTY_CODE = @PARTYFROM            
          AND INST_TYPE = @INST_TYPE            
          AND SYMBOL = @SYMBOL            
          AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'            
          AND STRIKE_PRICE = @STRIKE_PRICE            
          AND OPTION_TYPE = @OPTION_TYPE            
   AND RESERVED1 = 1             
          AND SELL_BUY = @SELL_BUY            
          AND PARTICIPANTCODE = @PARTICIPANTCODE            
          AND CONTRACTNO = @CONTRACTNO            
          AND ORDER_NO LIKE @ORDER_NO            
          AND TRADE_NO LIKE @NEW_TRADE_NO            
   AND TRADEQTY = @QTYINTRADE            
            
   UPDATE FOSETTLEMENT SET TRADEQTY = 0, PRICE = 0, NETRATE = 0, BROKAPPLIED = 0,             
   NBROKAPP = 0, N_NETRATE = 0, SERVICE_TAX = 0, NSERTAX = 0, AMOUNT = 0, TRADE_AMOUNT = 0,            
   INS_CHRG = 0, TURN_TAX = 0, OTHER_CHRG = 0, SEBI_TAX = 0, BROKER_CHRG = 0             
   WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'            
          AND PARTY_CODE = @PARTYFROM            
          AND INST_TYPE = @INST_TYPE            
          AND SYMBOL = @SYMBOL            
          AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'        
          AND STRIKE_PRICE = @STRIKE_PRICE            
          AND OPTION_TYPE = @OPTION_TYPE            
   AND RESERVED1 = 1             
          AND SELL_BUY = @SELL_BUY            
          AND PARTICIPANTCODE = @PARTICIPANTCODE            
          AND CONTRACTNO = @CONTRACTNO            
          AND ORDER_NO LIKE @ORDER_NO            
          AND TRADE_NO LIKE @NEW_TRADE_NO            
   AND TRADEQTY = @QTYINTRADE            
            
   SELECT @QTYTOTRANSFER = @QTYTOTRANSFER - @QTYINTRADE            
  END            
  ELSE            
  BEGIN            
   INSERT INTO FOSETTLEMENT             
   SELECT @NEW_CONTRACTNO,BILLNO,LEFT('R'+TRADE_NO,14),@PARTYTO,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,            
          OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,@QTYTOTRANSFER,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,            
          SAUDA_DATE,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,            
          BROKAPPLIED,NETRATE,@QTYTOTRANSFER*PRICE,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,            
          BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,            
          BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2            
   FROM FOSETTLEMENT             
   WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'            
          AND PARTY_CODE = @PARTYFROM            
          AND INST_TYPE = @INST_TYPE            
          AND SYMBOL = @SYMBOL            
          AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'            
          AND STRIKE_PRICE = @STRIKE_PRICE            
          AND OPTION_TYPE = @OPTION_TYPE            
   AND RESERVED1 = 1             
   AND SELL_BUY = @SELL_BUY            
          AND PARTICIPANTCODE = @PARTICIPANTCODE            
          AND CONTRACTNO = @CONTRACTNO            
          AND ORDER_NO LIKE @ORDER_NO            
          AND TRADE_NO LIKE @NEW_TRADE_NO            
   AND TRADEQTY = @QTYINTRADE            
            
   UPDATE FOSETTLEMENT SET TRADEQTY = TRADEQTY - @QTYTOTRANSFER, AMOUNT = (TRADEQTY - @QTYTOTRANSFER)*PRICE            
   WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'            
          AND PARTY_CODE = @PARTYFROM            
          AND INST_TYPE = @INST_TYPE            
          AND SYMBOL = @SYMBOL            
          AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'            
          AND STRIKE_PRICE = @STRIKE_PRICE            
          AND OPTION_TYPE = @OPTION_TYPE            
   AND RESERVED1 = 1             
          AND SELL_BUY = @SELL_BUY            
          AND PARTICIPANTCODE = @PARTICIPANTCODE            
          AND CONTRACTNO = @CONTRACTNO            
          AND ORDER_NO LIKE @ORDER_NO            
          AND TRADE_NO LIKE @NEW_TRADE_NO            
            
   SELECT @QTYTOTRANSFER = 0            
  END            
         FETCH NEXT FROM @TRADECURSOR INTO @QTYINTRADE, @NEW_TRADE_NO             
 END            
 CLOSE @TRADECURSOR            
 DEALLOCATE @TRADECURSOR            
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TRADE_TRANSFER_RECAL
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[PROC_TRADE_TRANSFER_RECAL]    
(
	@SAUDA_DATE VARCHAR(11),    
	@PARTY_CODE VARCHAR(10),    
	@INST_TYPE  VARCHAR(6) ,    
	@SYMBOL VARCHAR(12),    
	@EXPIRY_DATE VARCHAR(11),    
	@STRIKE_PRICE    MONEY ,    
	@OPTION_TYPE VARCHAR(2),
	@STATUSID	 VARCHAR(50) = 'BROKER',
	@STRMODULE       VARCHAR(50) = ''
)
  
AS    
  
IF @SYMBOL='' OR @SYMBOL = '%'    
BEGIN    
	SET @EXPIRY_DATE  = '%'
	SET @INST_TYPE = '%'
	SET @SYMBOL = '%'
	SET @STRIKE_PRICE = 0
	SET @OPTION_TYPE = '%'
END    


    SELECT PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,    
    PQTY=SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),    
    SQTY=SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),    

    PRATE=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END) > 0 
	    THEN SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY*PRICE ELSE 0 END) 
		/SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)
	    ELSE 0
       END),
    SRATE=(CASE WHEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END) > 0 
	    THEN SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY*PRICE ELSE 0 END) 
		/SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)
	    ELSE 0
       END),
    OPTION_TYPE,STRIKE_PRICE,AUCTIONPART  
	INTO #FOSETTLEMENT_1
    FROM FOSETTLEMENT F (NOLOCK) 
    WHERE F.SAUDA_DATE BETWEEN  @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'    
    AND F.PARTY_CODE = CASE WHEN @PARTY_CODE ='%' THEN F.PARTY_CODE ELSE @PARTY_CODE END     
    AND F.INST_TYPE = CASE WHEN @INST_TYPE ='%' THEN F.INST_TYPE ELSE @INST_TYPE END    
    AND F.SYMBOL = CASE WHEN @SYMBOL ='%' THEN F.SYMBOL ELSE @SYMBOL END    
    AND F.EXPIRYDATE LIKE @EXPIRY_DATE + '%'    
    AND F.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN F.STRIKE_PRICE ELSE @STRIKE_PRICE END)    
    AND F.OPTION_TYPE = CASE WHEN @OPTION_TYPE ='%' THEN F.OPTION_TYPE ELSE @OPTION_TYPE END  
    GROUP BY PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,AUCTIONPART
  
  
	SELECT CONTRACTNO,BILLNO,TRADE_NO,F.PARTY_CODE,F.INST_TYPE,F.SYMBOL,F.SEC_NAME,F.EXPIRYDATE,F.STRIKE_PRICE,F.OPTION_TYPE,
	USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,F.SERIES,ORDER_NO,PRICE,SAUDA_DATE,F.TABLE_NO,LINE_NO,VAL_PERC,
	NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,F.OTHER_CHRG,
	SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,    
	MPRICE = (CASE WHEN C2.DUMMY1 = 0
				 THEN PRICE
				 ELSE    
				   (CASE WHEN C2.DUMMY1 = 1
						 THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )    
						  ELSE F.STRIKE_PRICE + PRICE 
						  END)    
				 END) ,
	MULTIPLIER = 1,   
	TAXPRICE = (CASE WHEN TAXESFLAG = 0
				 THEN PRICE
				 ELSE    
				   (CASE WHEN TAXESFLAG = 1
						 THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )   
						 ELSE F.STRIKE_PRICE + PRICE 
						 END)    
				 END
				   ) ,
	F.RESERVED1,F.DUMMY1,STATUS
	INTO #FOSETTLEMENT_2  
	FROM FOSETTLEMENT F (NOLOCK), CLIENT2 C2 (NOLOCK), FOOWNER (NOLOCK)
	WHERE C2.PARTY_CODE = F.PARTY_CODE
	AND F.SAUDA_DATE BETWEEN  @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'    
	AND F.PARTY_CODE = CASE WHEN @PARTY_CODE ='%' THEN F.PARTY_CODE ELSE @PARTY_CODE END     
	AND F.INST_TYPE = CASE WHEN @INST_TYPE ='%' THEN F.INST_TYPE ELSE @INST_TYPE END    
	AND F.SYMBOL = CASE WHEN @SYMBOL ='%' THEN F.SYMBOL ELSE @SYMBOL END    
	AND F.EXPIRYDATE LIKE @EXPIRY_DATE + '%'    
	AND F.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN F.STRIKE_PRICE ELSE @STRIKE_PRICE END)    
	AND F.OPTION_TYPE = CASE WHEN @OPTION_TYPE ='%' THEN F.OPTION_TYPE ELSE @OPTION_TYPE END 
	AND F.TRADEQTY <> 0
  
UPDATE FOSETTLEMENT SET
 TABLE_NO = BROKTABLE.TABLE_NO,LINE_NO = BROKTABLE.LINE_NO,    
 VAL_PERC = BROKTABLE.VAL_PERC, NORMAL = BROKTABLE.NORMAL,DAY_PUC = BROKTABLE.DAY_PUC,DAY_SALES = BROKTABLE.DAY_SALES,    
 SETT_PURCH = BROKTABLE.SETT_PURCH, SETT_SALES = BROKTABLE.SETT_SALES,
 BROKAPPLIED =  
        (((CASE WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)    
        THEN ((FLOOR(( BROKTABLE.NORMAL*F.MULTIPLIER * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ))/POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)    
        THEN ((FLOOR(( BROKTABLE.NORMAL*F.MULTIPLIER * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ))/POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)    
        THEN ((FLOOR((((BROKTABLE.NORMAL*F.MULTIPLIER /100 ) * F.MPRICE)  * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)    
        THEN
         ((FLOOR(( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /
         POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )
        THEN
         ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /
         POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' )
        THEN
         ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /
         POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )    
        THEN
         ((FLOOR(( BROKTABLE.DAY_SALES*F.MULTIPLIER * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /
         POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )    
        THEN   
         ((FLOOR(( ((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /
         POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )    
        THEN
         ((FLOOR(( BROKTABLE.SETT_PURCH*F.MULTIPLIER * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /
         POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )    
        THEN
         ((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /
         POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )    
        THEN
         ((FLOOR(( BROKTABLE.SETT_SALES*F.MULTIPLIER * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /
         POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='P' )    
        THEN
         ((FLOOR(( ((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /
         POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN (FOSETTLEMENT.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='V' ) 
                                    THEN 
          ((FLOOR(( ((F.MULTIPLIER*BROKTABLE.SETT_PURCH))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
          POWER(10,FOCLIENTTAXES.ROUND_TO))
                              WHEN (FOSETTLEMENT.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='P' ) 
                                     THEN 
          ((FLOOR(( ((F.MULTIPLIER*BROKTABLE.SETT_PURCH/100) * (F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
          POWER(10,FOCLIENTTAXES.ROUND_TO))
                           
        WHEN (FOSETTLEMENT.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='V' )
                                     THEN 
          ((FLOOR(( F.MULTIPLIER*BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
          POWER(10,FOCLIENTTAXES.ROUND_TO))
                          WHEN (FOSETTLEMENT.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='P' )
                                     THEN 
          ((FLOOR(( ((F.MULTIPLIER*BROKTABLE.SETT_SALES/ 100) * (F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
          POWER(10,FOCLIENTTAXES.ROUND_TO))
                        WHEN ( FOSETTLEMENT.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='V' )
                                     THEN 
          ((FLOOR((F.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
          POWER(10,FOCLIENTTAXES.ROUND_TO))
                                 WHEN ( FOSETTLEMENT.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='P' )
                                THEN 
        ((FLOOR(( ((F.MULTIPLIER*BROKTABLE.SETT_PURCH/100) * (F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
          POWER(10,FOCLIENTTAXES.ROUND_TO))
                     WHEN ( FOSETTLEMENT.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='V' )
                                     THEN 
          ((FLOOR((F.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
          POWER(10,FOCLIENTTAXES.ROUND_TO))
                                 WHEN ( FOSETTLEMENT.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='P' )
                                     THEN 
          ((FLOOR(( ((F.MULTIPLIER*BROKTABLE.SETT_SALES/100) * (F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
          POWER(10,FOCLIENTTAXES.ROUND_TO))
        ELSE  0
        END
            ))), 
 NETRATE =
            (((  CASE
        WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)    
        THEN
         (FOSETTLEMENT.PRICE) + ((FLOOR((  (( BROKTABLE.NORMAL*F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+    
         FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)
        THEN
         (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.NORMAL*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG +    
         FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)    
        THEN
         (FOSETTLEMENT.PRICE)+ ((FLOOR(( (((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)    
        THEN
         (FOSETTLEMENT.PRICE) -  ((FLOOR((  ( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +
         FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )
        THEN
         (FOSETTLEMENT.PRICE) + ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER  )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   (FOCLIENTTAXES.ROFIG +    
         FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' )
        THEN
         (FOSETTLEMENT.PRICE) + ((FLOOR(( (((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /   
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +   FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )    
        THEN
         (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.DAY_SALES*F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +
         FOCLIENTTAXES.ERRNUM ) /   (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )    
        THEN
         (FOSETTLEMENT.PRICE) - ((FLOOR((  (((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +  
          FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )    
        THEN
         (FOSETTLEMENT.PRICE) + ((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER  )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )    
        THEN
         (FOSETTLEMENT.PRICE) + ((FLOOR(( ( (( BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +   
         FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO)) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ='V' )    
        THEN
         (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ='P' )    
        THEN
         (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO))    

        WHEN ( FOSETTLEMENT.SETTFLAG =8  AND BROKTABLE.VAL_PERC ='V' )    
        THEN
         (FOSETTLEMENT.PRICE) + ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG =8  AND BROKTABLE.VAL_PERC ='P' )    
        THEN
         (FOSETTLEMENT.PRICE) +  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO))    

        WHEN ( FOSETTLEMENT.SETTFLAG =9  AND BROKTABLE.VAL_PERC ='V' )    
        THEN
         (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG =9  AND BROKTABLE.VAL_PERC ='P' )    
        THEN
         (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO))    

        WHEN ( FOSETTLEMENT.SETTFLAG =6  AND BROKTABLE.VAL_PERC ='V' )    
        THEN
         (FOSETTLEMENT.PRICE) + ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG =6  AND BROKTABLE.VAL_PERC ='P' )    
        THEN
         (FOSETTLEMENT.PRICE) +  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO))    

   WHEN ( FOSETTLEMENT.SETTFLAG =7  AND BROKTABLE.VAL_PERC ='V' )    
        THEN
         (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
        WHEN ( FOSETTLEMENT.SETTFLAG =7  AND BROKTABLE.VAL_PERC ='P' )    
        THEN
         (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
         (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO))    

        ELSE  0
        END
            ) )),
 AMOUNT =
         (((  CASE
          WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 1)    
          THEN
           FOSETTLEMENT.TRADEQTY  *  ( (FOSETTLEMENT.PRICE) + ((FLOOR((  (( BROKTABLE.NORMAL*F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+  
           FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /(FOCLIENTTAXES.ROFIG +  FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))    
          WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTLEMENT.SELL_BUY = 2)    
          THEN
           FOSETTLEMENT.TRADEQTY * ((FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.NORMAL*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO)))    
          WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 1)    
          THEN
           FOSETTLEMENT.TRADEQTY  * ((FOSETTLEMENT.PRICE) + ((FLOOR(( (((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +
           FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))    
          WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTLEMENT.SELL_BUY = 2)    
          THEN
           FOSETTLEMENT.TRADEQTY * ((FOSETTLEMENT.PRICE) -  ((FLOOR((  ( ((BROKTABLE.NORMAL*F.MULTIPLIER /100 )* F.MPRICE))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +
           FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))    
          WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )
          THEN
           FOSETTLEMENT.TRADEQTY * ((FOSETTLEMENT.PRICE)+ ((FLOOR(( ((BROKTABLE.DAY_PUC*F.MULTIPLIER  )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))    
          WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' )
          THEN
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( (((BROKTABLE.DAY_PUC*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))    
          WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )    
          THEN
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.DAY_SALES*F.MULTIPLIER)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +
           FOCLIENTTAXES.ERRNUM ) /   (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))    
          WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )    
          THEN
           FOSETTLEMENT.TRADEQTY * (  (FOSETTLEMENT.PRICE) - ((FLOOR((  (((BROKTABLE.DAY_SALES*F.MULTIPLIER/ 100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+
           FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))    
          WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )    
          THEN
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( ((BROKTABLE.SETT_PURCH*F.MULTIPLIER  )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))    
          WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )    
          THEN
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( ( (( BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +
           FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)))    
          WHEN ( FOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ='V' )    
          THEN
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)) )    
          WHEN ( FOSETTLEMENT.SETTFLAG =5  AND BROKTABLE.VAL_PERC ='P' )    
          THEN
           FOSETTLEMENT.TRADEQTY  * (  (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO)))    

          WHEN ( FOSETTLEMENT.SETTFLAG =8  AND BROKTABLE.VAL_PERC ='P' )    
          THEN
           FOSETTLEMENT.TRADEQTY  * (  (FOSETTLEMENT.PRICE) +  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO)))    
          WHEN ( FOSETTLEMENT.SETTFLAG =9  AND BROKTABLE.VAL_PERC ='V' )    
          THEN
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)) )    
          WHEN ( FOSETTLEMENT.SETTFLAG =9  AND BROKTABLE.VAL_PERC ='P' )    
          THEN
     FOSETTLEMENT.TRADEQTY  * (  (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO)))    
          WHEN ( FOSETTLEMENT.SETTFLAG =6  AND BROKTABLE.VAL_PERC ='V' )    
          THEN
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) + ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)) )    
          WHEN ( FOSETTLEMENT.SETTFLAG =6  AND BROKTABLE.VAL_PERC ='P' )    
          THEN
           FOSETTLEMENT.TRADEQTY  * (  (FOSETTLEMENT.PRICE) +  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO)))    
          WHEN ( FOSETTLEMENT.SETTFLAG =7  AND BROKTABLE.VAL_PERC ='V' )    
          THEN
           FOSETTLEMENT.TRADEQTY * ( (FOSETTLEMENT.PRICE) - ((FLOOR(( (( BROKTABLE.SETT_SALES*F.MULTIPLIER )) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO)) )    
          WHEN ( FOSETTLEMENT.SETTFLAG =7  AND BROKTABLE.VAL_PERC ='P' )    
          THEN
           FOSETTLEMENT.TRADEQTY  * (  (FOSETTLEMENT.PRICE) -  ((FLOOR((  (((BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE)) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
           (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /  POWER(10,FOCLIENTTAXES.ROUND_TO)))    
          ELSE  0
          END
         )) ) ,    
  
INS_CHRG  = 0,  

TURN_TAX  =  
	((FLOOR(( ((CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FUT_TURNOVER_TAX ELSE OPT_TURNOVER_TAX END * 
	(CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FOSETTLEMENT.PRICE
	ELSE CASE WHEN FOTAXES.TURNOVER_TAX_ON='PRICE'  THEN  FOSETTLEMENT.PRICE
	ELSE CASE WHEN FOTAXES.TURNOVER_TAX_ON='SPRICE' THEN  (FOSETTLEMENT.STRIKE_PRICE +  FOSETTLEMENT.PRICE)
	ELSE (FOSETTLEMENT.STRIKE_PRICE +  FOSETTLEMENT.PRICE)  END END END) * FOSETTLEMENT.TRADEQTY)/100 ) * 
	POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
	(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /  
	POWER(10,FOCLIENTTAXES.ROUND_TO)),

OTHER_CHRG = 
	((FLOOR(( ((CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FUT_OTHER_CHRG ELSE OPT_OTHER_CHRG END  * 
	(CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN	FOSETTLEMENT.PRICE
	ELSE CASE WHEN FOTAXES.OTHER_CHRG_ON='PRICE'  THEN  FOSETTLEMENT.PRICE
	ELSE CASE WHEN FOTAXES.OTHER_CHRG_ON='SPRICE' THEN  FOSETTLEMENT.STRIKE_PRICE
	ELSE (FOSETTLEMENT.STRIKE_PRICE +  FOSETTLEMENT.PRICE)  END END END) * FOSETTLEMENT.TRADEQTY)/100 ) * 
	POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
	(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /  
	POWER(10,FOCLIENTTAXES.ROUND_TO)),

SEBI_TAX =     
	((FLOOR(( ((CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FUT_SEBITURN_TAX ELSE OPT_SEBITURN_TAX END  *
	(CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN	FOSETTLEMENT.PRICE
	ELSE CASE WHEN FOTAXES.SEBI_TAX_ON='PRICE'  THEN  FOSETTLEMENT.PRICE
	ELSE CASE WHEN FOTAXES.SEBI_TAX_ON='SPRICE' THEN  FOSETTLEMENT.STRIKE_PRICE
	ELSE (FOSETTLEMENT.STRIKE_PRICE +  FOSETTLEMENT.PRICE)  END END END) * FOSETTLEMENT.TRADEQTY)/100) * 
	POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
	(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / 
	POWER(10,FOCLIENTTAXES.ROUND_TO)),
		
BROKER_CHRG =  0,    
  
SERVICE_TAX =   
        CASE WHEN CLIENT2.SERVICE_CHRG = 1 AND CLIENT2.SERTAXMETHOD = 1 THEN 0 ELSE  
        (CASE 
         WHEN ( FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V')    
         THEN
          ((FLOOR((
          (((((FLOOR((( BROKTABLE.NORMAL*F.MULTIPLIER)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY * BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN (FOSETTLEMENT.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P')    
         THEN
          ((FLOOR((
          (((((FLOOR((   ((BROKTABLE.NORMAL*F.MULTIPLIER /100 ) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))    
         WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )
         THEN 
          ((FLOOR((
          (((((FLOOR(( (BROKTABLE.DAY_PUC*F.MULTIPLIER) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN (FOSETTLEMENT.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' )
         THEN
          ((FLOOR((
          (((((FLOOR((( (BROKTABLE.DAY_PUC*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG +
          FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )    
         THEN
          ((FLOOR((
          (((((FLOOR((( BROKTABLE.DAY_SALES*F.MULTIPLIER ) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN (FOSETTLEMENT.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )    
         THEN
          ((FLOOR((
       (((((FLOOR((( (BROKTABLE.DAY_SALES*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )    
         THEN 
          ((FLOOR((
          (((((FLOOR((( BROKTABLE.SETT_PURCH*F.MULTIPLIER)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /   
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT * FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN ( FOSETTLEMENT.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )    
         THEN
          ((FLOOR((
          (((((FLOOR((( (BROKTABLE.SETT_PURCH*F.MULTIPLIER/100) *  F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )    
         THEN  
          ((FLOOR((
          (((((FLOOR((( BROKTABLE.SETT_SALES*F.MULTIPLIER)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN ( FOSETTLEMENT.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='P' )    
         THEN 
          ((FLOOR((
          (((((FLOOR((( (BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   


         WHEN ( FOSETTLEMENT.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='V' )    
         THEN  
          ((FLOOR((
          (((((FLOOR((( BROKTABLE.SETT_SALES*F.MULTIPLIER)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN ( FOSETTLEMENT.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='P' )    
         THEN 
          ((FLOOR((
          (((((FLOOR((( (BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN ( FOSETTLEMENT.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='V' )    
         THEN  
          ((FLOOR((
          (((((FLOOR((( BROKTABLE.SETT_SALES*F.MULTIPLIER)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN ( FOSETTLEMENT.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='P' )    
         THEN 
          ((FLOOR((
          (((((FLOOR((( (BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN ( FOSETTLEMENT.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='V' )    
         THEN  
          ((FLOOR((
          (((((FLOOR((( BROKTABLE.SETT_SALES*F.MULTIPLIER)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN ( FOSETTLEMENT.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='P' )    
         THEN 
          ((FLOOR((
          (((((FLOOR((( (BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN ( FOSETTLEMENT.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='V' )    
         THEN  
          ((FLOOR((
          (((((FLOOR((( BROKTABLE.SETT_SALES*F.MULTIPLIER)  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   
         WHEN ( FOSETTLEMENT.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='P' )    
         THEN 
          ((FLOOR((
          (((((FLOOR((( (BROKTABLE.SETT_SALES*F.MULTIPLIER/100) * F.MPRICE) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /    
          POWER(10,FOCLIENTTAXES.ROUND_TO))) * FOSETTLEMENT.TRADEQTY *  BOOKTYPE  / INSTRUMENT *  FOGLOBALS.SERVICE_TAX) / 100)   *   POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
          (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / POWER(10,FOCLIENTTAXES.ROUND_TO))   

         ELSE  0
         END
        ) END,
TRADE_AMOUNT = FOSETTLEMENT.TRADEQTY * FOSETTLEMENT.PRICE 
 
FROM   
	BROKTABLE (NOLOCK),  
	FOSETTLEMENT WITH(ROWLOCK),  
	FOTAXES (NOLOCK),  
	CLIENT1 (NOLOCK),  
	CLIENT2 (NOLOCK),  
	FOGLOBALS (NOLOCK),    
	FOCLIENTTAXES (NOLOCK),
	FOCLIENTBROKSCHEME (NOLOCK),
	#FOSETTLEMENT_1 S, 
	#FOSETTLEMENT_2 F 
WHERE  
	FOSETTLEMENT.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE AND 
	FOSETTLEMENT.SAUDA_DATE BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO AND
	FOSETTLEMENT.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE AND 
	FOSETTLEMENT.SAUDA_DATE BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO AND
	

 FOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE  AND   
 CLIENT1.CL_CODE=CLIENT2.CL_CODE AND   
 FOSETTLEMENT.PARTY_CODE = S.PARTY_CODE AND    
 FOSETTLEMENT.INST_TYPE=S.INST_TYPE AND 
 FOSETTLEMENT.SYMBOL=S.SYMBOL AND    
 FOSETTLEMENT.EXPIRYDATE=S.EXPIRYDATE  AND    
 FOSETTLEMENT.STRIKE_PRICE = S.STRIKE_PRICE AND
 FOSETTLEMENT.OPTION_TYPE = S.OPTION_TYPE AND  
 FOSETTLEMENT.PARTY_CODE = F.PARTY_CODE AND    
 FOSETTLEMENT.INST_TYPE=F.INST_TYPE AND 
 FOSETTLEMENT.SYMBOL=F.SYMBOL AND    
 FOSETTLEMENT.AUCTIONPART = S.AUCTIONPART AND    
 FOSETTLEMENT.EXPIRYDATE=F.EXPIRYDATE  AND    
 FOSETTLEMENT.STRIKE_PRICE = F.STRIKE_PRICE AND
 FOSETTLEMENT.SEC_NAME = F.SEC_NAME AND   
 FOSETTLEMENT.OPTION_TYPE = F.OPTION_TYPE AND  
 FOSETTLEMENT.SAUDA_DATE = F.SAUDA_DATE AND    
 FOSETTLEMENT.TRADE_NO = F.TRADE_NO AND
 FOSETTLEMENT.ORDER_NO = F.ORDER_NO AND    
 FOSETTLEMENT.SELL_BUY = F.SELL_BUY AND 
 FOSETTLEMENT.TRADEQTY = F.TRADEQTY AND 
 BROKTABLE.TABLE_NO = ( 
    CASE 
        WHEN LEFT(F.INST_TYPE,3) = 'FUT' 
        THEN FUT_BROKTABLE 
        ELSE OPT_BROKTABLE 
    END 
    ) 
    AND BROKTABLE.LINE_NO = ( 
    CASE 
        WHEN FOCLIENTBROKSCHEME.BROK_SCHEME IN (1,5,21,25) 
        THEN 
        ( 
        SELECT 
            MIN(BROKTABLE.LINE_NO) 
        FROM BROKTABLE 
        WHERE BROKTABLE.TABLE_NO =( 
            CASE 
                WHEN LEFT(F.INST_TYPE,3) = 'FUT' 
                THEN FUT_BROKTABLE 
                ELSE OPT_BROKTABLE 
            END 
            ) 
            AND TRD_DEL = ( 
            CASE 
                WHEN ((S.PQTY >= S.SQTY) 
                AND FOSETTLEMENT.SETTFLAG IN (1,2,3,4,5)) 
                THEN ( 
                CASE 
                    WHEN ( FOSETTLEMENT.SELL_BUY = 1 ) 
                    THEN 'F' 
                    ELSE 'S' 
                END 
                ) 
                WHEN FOSETTLEMENT.SETTFLAG IN(6,7) 
                THEN 'S' 
                WHEN FOSETTLEMENT.SETTFLAG IN(8,9) 
                THEN 'F' 
                WHEN ((S.PQTY < S.SQTY) 
                AND FOSETTLEMENT.SETTFLAG IN (1,2,3,4,5)) 
       THEN ( 
                CASE 
                    WHEN ( FOSETTLEMENT.SELL_BUY = 2 ) 
                    THEN 'F' 
                    ELSE 'S' 
                END 
                ) 
                WHEN FOSETTLEMENT.SETTFLAG IN(6,7) 
                THEN 'S' 
               WHEN FOSETTLEMENT.SETTFLAG IN(8,9) 
                THEN 'F' 
                WHEN FOSETTLEMENT.SETTFLAG = 0 
      THEN 'F' 
            END 
            ) 
       AND FOSETTLEMENT.PARTY_CODE = S.PARTY_CODE 
            AND F.MPRICE <= BROKTABLE.UPPER_LIM 
        ) 
        WHEN FOCLIENTBROKSCHEME.BROK_SCHEME IN (3,6,23,26) 
        THEN 
        ( 
        SELECT 
            MIN(BROKTABLE.LINE_NO) 
        FROM BROKTABLE 
        WHERE BROKTABLE.TABLE_NO = ( 
            CASE 
                WHEN LEFT(F.INST_TYPE,3) = 'FUT' 
                THEN FUT_BROKTABLE 
                ELSE OPT_BROKTABLE 
            END 
            ) 
            AND TRD_DEL = ( 
            CASE 
                WHEN ((S.PQTY > S.SQTY) 
                AND FOSETTLEMENT.SETTFLAG IN (1,2,3,4,5)) 
                THEN ( 
                CASE 
                    WHEN ( FOSETTLEMENT.SELL_BUY = 1 ) 
                    THEN 'F' 
                    ELSE 'S' 
                END 
                ) 
                WHEN FOSETTLEMENT.SETTFLAG IN(6,7) 
                THEN 'S' 
                WHEN FOSETTLEMENT.SETTFLAG IN(8,9) 
                THEN 'F' 
                WHEN ((S.PQTY <= S.SQTY) 
                AND FOSETTLEMENT.SETTFLAG IN (1,2,3,4,5)) 
                THEN ( 
                CASE 
                    WHEN ( FOSETTLEMENT.SELL_BUY = 2 ) 
                    THEN 'F' 
                    ELSE 'S' 
                END 
                ) 
                WHEN FOSETTLEMENT.SETTFLAG IN(6,7) 
                THEN 'S' 
                WHEN FOSETTLEMENT.SETTFLAG IN(8,9) 
                THEN 'F' 
                WHEN FOSETTLEMENT.SETTFLAG = 0 
                THEN 'F' 
            END 
            ) 
            AND FOSETTLEMENT.PARTY_CODE = S.PARTY_CODE 
            AND F.MPRICE <= BROKTABLE.UPPER_LIM 
        ) 
	   WHEN FOCLIENTBROKSCHEME.BROK_SCHEME =2
			THEN
	        ( 
	        SELECT 
	            MIN(BROKTABLE.LINE_NO) 
	        FROM BROKTABLE 
	        WHERE BROKTABLE.TABLE_NO = ( 
	            CASE 
	                WHEN LEFT(F.INST_TYPE,3) = 'FUT' 
	                THEN FUT_BROKTABLE 
	                ELSE OPT_BROKTABLE 
	            END 
	            ) 
	            AND TRD_DEL = ( 
							CASE   WHEN S.PQTY = S.SQTY THEN (CASE 
	                                                      WHEN S.PRATE > = S.SRATE THEN (CASE 
	                                                                                       WHEN FOSETTLEMENT.SELL_BUY = 1 THEN 'F'
	                                                                                       ELSE 'S'
	                      END)
	                                           ELSE (CASE 
	                                                              WHEN (FOSETTLEMENT.SELL_BUY = 2) THEN 'F'
	                                                              ELSE 'S'
	                                                            END)
	                                                    END)
	                         ELSE (CASE 
	                                 WHEN S.PQTY > = S.SQTY THEN (CASE 
	                                                                WHEN (FOSETTLEMENT.SELL_BUY = 1) THEN 'F'
	                                                                ELSE 'S'
	                                                              END)
	                                 ELSE (CASE 
	                                         WHEN (FOSETTLEMENT.SELL_BUY = 2) THEN 'F'
	                                         ELSE 'S'
	                                       END)
	                               END)
	         END
	         ) 
	            AND FOSETTLEMENT.PARTY_CODE = S.PARTY_CODE 
	            AND F.MPRICE <= BROKTABLE.UPPER_LIM 
	        ) 
        ELSE 
        ( 
        SELECT 
            MIN(LINE_NO) 
        FROM BROKTABLE 
        WHERE F.MPRICE <= BROKTABLE.UPPER_LIM 
      AND BROKTABLE.TABLE_NO = ( 
            CASE 
                WHEN LEFT(F.INST_TYPE,3) = 'FUT' 
                THEN FUT_BROKTABLE 
              ELSE OPT_BROKTABLE 
            END 
            ) 
        ) 
    END 
    )  AND  
FOTAXES.TRANS_CAT = (CASE WHEN CL_TYPE = 'PRO' THEN 'PRO' ELSE CLIENT2.TRAN_CAT END )  AND    
FOSETTLEMENT.SAUDA_DATE BETWEEN  @SAUDA_DATE  AND @SAUDA_DATE + ' 23:59'  AND  
FOSETTLEMENT.STATUS <>  'E'  AND  
FOSETTLEMENT.PARTY_CODE = CASE WHEN @PARTY_CODE ='%' THEN FOSETTLEMENT.PARTY_CODE ELSE @PARTY_CODE END AND    
FOSETTLEMENT.INST_TYPE = CASE WHEN @INST_TYPE ='%' THEN FOSETTLEMENT.INST_TYPE ELSE @INST_TYPE END  AND   
FOSETTLEMENT.SYMBOL = CASE WHEN @SYMBOL ='%' THEN FOSETTLEMENT.SYMBOL ELSE @SYMBOL END AND  
FOSETTLEMENT.EXPIRYDATE LIKE @EXPIRY_DATE + '%'  AND   
FOSETTLEMENT.STRIKE_PRICE = (CASE WHEN @STRIKE_PRICE = 0 THEN FOSETTLEMENT.STRIKE_PRICE ELSE @STRIKE_PRICE END)  AND   
FOSETTLEMENT.OPTION_TYPE = CASE WHEN @OPTION_TYPE ='%' THEN FOSETTLEMENT.OPTION_TYPE ELSE @OPTION_TYPE END  AND  
FOSETTLEMENT.SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT AND   
FOSETTLEMENT.SAUDA_DATE BETWEEN FOTAXES.FROM_DATE AND FOTAXES.TO_DATE   
AND FOSETTLEMENT.TRADEQTY  <> 0
  

IF @@ERROR = 0  
BEGIN
IF @STRMODULE <> ''
BEGIN
	EXEC CONSOLE_LOG  @PARTY_CODE,'',@SAUDA_DATE,@INST_TYPE,@SYMBOL,@EXPIRY_DATE,@STRIKE_PRICE,@OPTION_TYPE,
	'','',0,'','',0,0,0,0,0,0,0,0,0,'','',@STATUSID,@STRMODULE,'RECAL BROK'
END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TRADE_TRANSFER_SETL
-- --------------------------------------------------
CREATE  PROC [dbo].[PROC_TRADE_TRANSFER_SETL] 
(
	@SAUDA_DATE      VARCHAR(11),
	@PARTYFROM       VARCHAR(10), 
	@PARTYTO         VARCHAR(10),
	@INST_TYPE       VARCHAR(6) ,
	@SYMBOL          VARCHAR(12),
	@EXPIRY_DATE     VARCHAR(11),
	@STRIKE_PRICE  	 MONEY      ,
	@OPTION_TYPE     VARCHAR(2) , 
	@SELL_BUY   	 INT        ,
	@PARTICIPANTCODE VARCHAR(15), 
	@CONTRACTNO      VARCHAR(7) , 
	@ORDER_NO	 VARCHAR(20),
	@TRADE_NO        VARCHAR(14),
	@ACTUALQTY       INT        ,
	@QTYTOTRANSFER   INT        ,
	@STATUSID	 VARCHAR(50) ='',
	@STRMODULE       VARCHAR(50) ='',
	@USERID 	VARCHAR(15) =''
) AS

DECLARE 
@TRADECURSOR     CURSOR     ,
@CONTRACTNOCUR   CURSOR     ,
@QTYINTRADE      INT        ,
@NEW_TRADE_NO    VARCHAR(14),
@NEW_CONTRACTNO  VARCHAR(7) ,
@BILLNO		 			 INT        ,
@STYLE           INT				,
@CLTYPE					 VARCHAR(3)

SELECT @NEW_CONTRACTNO = 0 
SET @CONTRACTNOCUR = CURSOR FOR
SELECT CONTRACTNO FROM FOSETTLEMENT 
WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
AND PARTY_CODE = @PARTYTO AND RESERVED1 = 0 
OPEN @CONTRACTNOCUR
FETCH NEXT FROM @CONTRACTNOCUR INTO @NEW_CONTRACTNO
CLOSE @CONTRACTNOCUR
DEALLOCATE @CONTRACTNOCUR

IF @STRMODULE <> ''
BEGIN
	EXEC CONSOLE_LOG  @PARTYFROM,@PARTYTO,@SAUDA_DATE,@INST_TYPE,@SYMBOL,@EXPIRY_DATE,@STRIKE_PRICE,@OPTION_TYPE,
	@ORDER_NO,@TRADE_NO,@SELL_BUY,@CONTRACTNO,'',0,0,0,0,0,0,@ACTUALQTY,@QTYTOTRANSFER,0,@PARTICIPANTCODE,'',@STATUSID,@STRMODULE,'PROC_TRADE_TRANSFER_SETL'
END

IF @@FETCH_STATUS <> 0 
BEGIN
	SET @NEW_CONTRACTNO = 0
 	SELECT @CLTYPE = CL_TYPE FROM CLIENT1 C1, CLIENT2 C2 WHERE C1.CL_CODE = C2.CL_CODE AND C2.PARTY_CODE = @PARTYTO
	IF @CLTYPE <> 'PRO'
		BEGIN
				SELECT @NEW_CONTRACTNO = CONVERT(INT,CONTRACTNO) + 1  FROM CONTGEN 
      		       WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE

				UPDATE CONTGEN SET CONTRACTNO = @NEW_CONTRACTNO 
                WHERE @SAUDA_DATE + ' 00:00:00' >= START_DATE AND @SAUDA_DATE + ' 00:00:00' <= END_DATE
		END
	SELECT @NEW_CONTRACTNO = STUFF('0000000', 8 - LEN(@NEW_CONTRACTNO), LEN(@NEW_CONTRACTNO), @NEW_CONTRACTNO)		
END

SELECT @BILLNO = 0 

IF @ACTUALQTY = @QTYTOTRANSFER 
BEGIN
	INSERT INTO FOSETTLEMENT 
	SELECT @NEW_CONTRACTNO,BILLNO,LEFT('R'+TRADE_NO,14),@PARTYTO,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,
        OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,
        SAUDA_DATE,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,
        BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,
        BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,
        BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2
	FROM FOSETTLEMENT 
	WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
        AND PARTY_CODE = @PARTYFROM
        AND INST_TYPE = @INST_TYPE
        AND SYMBOL = @SYMBOL
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND STRIKE_PRICE = @STRIKE_PRICE
        AND OPTION_TYPE = @OPTION_TYPE
	AND RESERVED1 = 0 
        AND SELL_BUY = @SELL_BUY
        AND PARTICIPANTCODE = @PARTICIPANTCODE
        AND CONTRACTNO = @CONTRACTNO
        AND ORDER_NO LIKE @ORDER_NO
        AND TRADE_NO LIKE @TRADE_NO


	UPDATE FOSETTLEMENT SET TRADEQTY = 0, PRICE = 0, NETRATE = 0, BROKAPPLIED = 0, 
	NBROKAPP = 0, N_NETRATE = 0, SERVICE_TAX = 0, NSERTAX = 0, AMOUNT = 0, TRADE_AMOUNT = 0,
	INS_CHRG = 0, TURN_TAX = 0, OTHER_CHRG = 0, SEBI_TAX = 0, BROKER_CHRG = 0 
	WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
        AND PARTY_CODE = @PARTYFROM
        AND INST_TYPE = @INST_TYPE
        AND SYMBOL = @SYMBOL
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND STRIKE_PRICE = @STRIKE_PRICE
        AND OPTION_TYPE = @OPTION_TYPE
	AND RESERVED1 = 0 
        AND SELL_BUY = @SELL_BUY
        AND PARTICIPANTCODE = @PARTICIPANTCODE
        AND CONTRACTNO = @CONTRACTNO
        AND ORDER_NO LIKE @ORDER_NO
        AND TRADE_NO LIKE @TRADE_NO

END
ELSE
BEGIN
        SET @TRADECURSOR = CURSOR FOR
        SELECT TRADEQTY, TRADE_NO FROM FOSETTLEMENT
        WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
        AND PARTY_CODE = @PARTYFROM
        AND INST_TYPE = @INST_TYPE
        AND SYMBOL = @SYMBOL
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND STRIKE_PRICE = @STRIKE_PRICE
        AND OPTION_TYPE = @OPTION_TYPE
	AND RESERVED1 = 0 
        AND SELL_BUY = @SELL_BUY
        AND PARTICIPANTCODE = @PARTICIPANTCODE
   AND CONTRACTNO = @CONTRACTNO
        AND ORDER_NO LIKE @ORDER_NO
        AND TRADE_NO LIKE @TRADE_NO
	ORDER BY TRADEQTY DESC 

        OPEN @TRADECURSOR 
        FETCH NEXT FROM @TRADECURSOR INTO @QTYINTRADE, @NEW_TRADE_NO
	WHILE @@FETCH_STATUS = 0 AND @QTYTOTRANSFER > 0 
	BEGIN
		IF @QTYTOTRANSFER >= @QTYINTRADE
		BEGIN
			INSERT INTO FOSETTLEMENT 
			SELECT @NEW_CONTRACTNO,BILLNO,LEFT('R'+TRADE_NO,14),@PARTYTO,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,
		        OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,
		        SAUDA_DATE,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,
		        BROKAPPLIED,NETRATE,AMOUNT,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,
		        BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,
		        BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2
			FROM FOSETTLEMENT 
			WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
		        AND PARTY_CODE = @PARTYFROM
		        AND INST_TYPE = @INST_TYPE
		        AND SYMBOL = @SYMBOL
		        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		        AND STRIKE_PRICE = @STRIKE_PRICE
		        AND OPTION_TYPE = @OPTION_TYPE
			AND RESERVED1 = 0 
		        AND SELL_BUY = @SELL_BUY
		        AND PARTICIPANTCODE = @PARTICIPANTCODE
		        AND CONTRACTNO = @CONTRACTNO
		        AND ORDER_NO LIKE @ORDER_NO
		        AND TRADE_NO LIKE @NEW_TRADE_NO
			AND TRADEQTY = @QTYINTRADE

			UPDATE FOSETTLEMENT SET TRADEQTY = 0, PRICE = 0, NETRATE = 0, BROKAPPLIED = 0, 
			NBROKAPP = 0, N_NETRATE = 0, SERVICE_TAX = 0, NSERTAX = 0, AMOUNT = 0, TRADE_AMOUNT = 0,
			INS_CHRG = 0, TURN_TAX = 0, OTHER_CHRG = 0, SEBI_TAX = 0, BROKER_CHRG = 0 
			WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
		        AND PARTY_CODE = @PARTYFROM
		        AND INST_TYPE = @INST_TYPE
		        AND SYMBOL = @SYMBOL
		        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		        AND STRIKE_PRICE = @STRIKE_PRICE
		        AND OPTION_TYPE = @OPTION_TYPE
			AND RESERVED1 = 0 
		        AND SELL_BUY = @SELL_BUY
	        	AND PARTICIPANTCODE = @PARTICIPANTCODE
		        AND CONTRACTNO = @CONTRACTNO
	        	AND ORDER_NO LIKE @ORDER_NO
		        AND TRADE_NO LIKE @NEW_TRADE_NO
			AND TRADEQTY = @QTYINTRADE

			SELECT @QTYTOTRANSFER = @QTYTOTRANSFER - @QTYINTRADE
		END
		ELSE
		BEGIN
			INSERT INTO FOSETTLEMENT 
			SELECT @NEW_CONTRACTNO,BILLNO,LEFT('R'+TRADE_NO,14),@PARTYTO,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,
		        OPTION_TYPE,USER_ID,PRO_CLI,O_C_FLAG,C_U_FLAG,@QTYTOTRANSFER,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,
		        SAUDA_DATE,TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,
		        BROKAPPLIED,NETRATE,@QTYTOTRANSFER*PRICE,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,
		        BILLFLAG,SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,
		        BOOKTYPE,BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2
			FROM FOSETTLEMENT 
			WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
		        AND PARTY_CODE = @PARTYFROM
		        AND INST_TYPE = @INST_TYPE
		        AND SYMBOL = @SYMBOL
		        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		        AND STRIKE_PRICE = @STRIKE_PRICE
		        AND OPTION_TYPE = @OPTION_TYPE
			AND RESERVED1 = 0 
		        AND SELL_BUY = @SELL_BUY
		        AND PARTICIPANTCODE = @PARTICIPANTCODE
		        AND CONTRACTNO = @CONTRACTNO
		        AND ORDER_NO LIKE @ORDER_NO
		        AND TRADE_NO LIKE @NEW_TRADE_NO
			AND TRADEQTY = @QTYINTRADE

			UPDATE FOSETTLEMENT SET TRADEQTY = TRADEQTY - @QTYTOTRANSFER, AMOUNT = (TRADEQTY - @QTYTOTRANSFER)*PRICE
			WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
		        AND PARTY_CODE = @PARTYFROM
		        AND INST_TYPE = @INST_TYPE
		        AND SYMBOL = @SYMBOL

		        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		        AND STRIKE_PRICE = @STRIKE_PRICE
		        AND OPTION_TYPE = @OPTION_TYPE
			AND RESERVED1 = 0 
		        AND SELL_BUY = @SELL_BUY
		        AND PARTICIPANTCODE = @PARTICIPANTCODE
		        AND CONTRACTNO = @CONTRACTNO
		        AND ORDER_NO LIKE @ORDER_NO
		        AND TRADE_NO LIKE @NEW_TRADE_NO

			SELECT @QTYTOTRANSFER = 0
		END
	        FETCH NEXT FROM @TRADECURSOR INTO @QTYINTRADE, @NEW_TRADE_NO	
	END
	CLOSE @TRADECURSOR
	DEALLOCATE @TRADECURSOR
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TRADE_TRANSFER_TRADE
-- --------------------------------------------------
CREATE PROC [dbo].[PROC_TRADE_TRANSFER_TRADE] 
(
	@SAUDA_DATE      VARCHAR(11), 
	@PARTYFROM       VARCHAR(10), 
	@PARTYTO         VARCHAR(10),
	@INST_TYPE       VARCHAR(6) ,
	@SYMBOL          VARCHAR(12),
	@EXPIRY_DATE     VARCHAR(11),
	@STRIKE_PRICE  	 MONEY      ,
	@OPTION_TYPE     VARCHAR(2) ,  
	@SELL_BUY   	 INT        ,
	@PARTICIPANTCODE VARCHAR(15), 
	@ORDER_NO	 VARCHAR(20),
	@TRADE_NO        VARCHAR(14),
	@ACTUALQTY       INT        ,
	@QTYTOTRANSFER   INT        ,
	@STATUSID	 VARCHAR(50),
	@STRMODULE       VARCHAR(50)
) AS

DECLARE 
@QTYINFOTRADE      INT        ,
@NEW_TRADE_NO    VARCHAR(14)

EXEC CONSOLE_LOG  @PARTYFROM,@PARTYTO,@SAUDA_DATE,@INST_TYPE,@SYMBOL,@EXPIRY_DATE,@STRIKE_PRICE,@OPTION_TYPE,
@ORDER_NO,@TRADE_NO,@SELL_BUY,'','',0,0,0,0,0,0,@ACTUALQTY,@QTYTOTRANSFER,0,@PARTICIPANTCODE,'',@STATUSID,@STRMODULE,'PROC_TRADE_TRANSFER_TRADE'

IF @ACTUALQTY = @QTYTOTRANSFER 
BEGIN
	UPDATE FOTRADE SET PARTY_CODE = @PARTYTO
	WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
        AND PARTY_CODE = @PARTYFROM
        AND INST_TYPE = @INST_TYPE
        AND SYMBOL = @SYMBOL
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND STRIKE_PRICE = @STRIKE_PRICE
        AND OPTION_TYPE = @OPTION_TYPE
        AND SELL_BUY = @SELL_BUY
        AND PARTICIPANTCODE = @PARTICIPANTCODE
        AND ORDER_NO LIKE @ORDER_NO
        AND TRADE_NO LIKE @TRADE_NO
END
ELSE
BEGIN
        DECLARE @FOTRADECURSOR     CURSOR     

	SET @FOTRADECURSOR = CURSOR FOR
        SELECT TRADEQTY, TRADE_NO FROM FOTRADE 
        WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
        AND PARTY_CODE = @PARTYFROM
        AND INST_TYPE = @INST_TYPE
        AND SYMBOL = @SYMBOL
        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
        AND STRIKE_PRICE = @STRIKE_PRICE
        AND OPTION_TYPE = @OPTION_TYPE
        AND SELL_BUY = @SELL_BUY
        AND PARTICIPANTCODE = @PARTICIPANTCODE
        AND ORDER_NO LIKE @ORDER_NO
        AND TRADE_NO LIKE @TRADE_NO
	ORDER BY TRADEQTY DESC 
        OPEN @FOTRADECURSOR 
        FETCH NEXT FROM @FOTRADECURSOR INTO @QTYINFOTRADE, @NEW_TRADE_NO
	WHILE @@FETCH_STATUS = 0 AND @QTYTOTRANSFER > 0 
	BEGIN
		IF @QTYTOTRANSFER >= @QTYINFOTRADE
		BEGIN
			UPDATE FOTRADE SET PARTY_CODE = @PARTYTO
			WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
		        AND PARTY_CODE = @PARTYFROM
		        AND INST_TYPE = @INST_TYPE
		        AND SYMBOL = @SYMBOL
		        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		        AND STRIKE_PRICE = @STRIKE_PRICE
		        AND OPTION_TYPE = @OPTION_TYPE
		        AND SELL_BUY = @SELL_BUY
		        AND PARTICIPANTCODE = @PARTICIPANTCODE
		        AND ORDER_NO LIKE @ORDER_NO
		        AND TRADE_NO LIKE @NEW_TRADE_NO

			SELECT @QTYTOTRANSFER = @QTYTOTRANSFER - @QTYINFOTRADE
		END
		ELSE
		BEGIN
			INSERT INTO FOTRADE
			SELECT 'T'+TRADE_NO,STATUS,INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SEC_NAME,BOOKTYPE,BOOKTYPENAME,
			MARKETTYPE,USER_ID,BRANCH_ID,SELL_BUY,@QTYTOTRANSFER,PRICE,PRO_CLI,@PARTYTO,PARTICIPANTCODE,O_C_FLAG,
			C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,ORDER_NO,OPP_BROKER_ID,SETTFLAG,MEMBERCODE,TMPARTYCODE,
			RESERVED1,RESERVED2,RESERVED3,RESERVED4,RESERVED5 FROM FOTRADE
			WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
		        AND PARTY_CODE = @PARTYFROM
		        AND INST_TYPE = @INST_TYPE
		        AND SYMBOL = @SYMBOL
		        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		        AND STRIKE_PRICE = @STRIKE_PRICE
		        AND OPTION_TYPE = @OPTION_TYPE
		        AND SELL_BUY = @SELL_BUY
		        AND PARTICIPANTCODE = @PARTICIPANTCODE
		        AND ORDER_NO LIKE @ORDER_NO
		        AND TRADE_NO LIKE @NEW_TRADE_NO

			UPDATE FOTRADE SET TRADEQTY = TRADEQTY - @QTYTOTRANSFER
			WHERE ACTIVITYTIME LIKE @SAUDA_DATE + '%'
		        AND PARTY_CODE = @PARTYFROM
		        AND INST_TYPE = @INST_TYPE
		        AND SYMBOL = @SYMBOL
		        AND EXPIRYDATE LIKE @EXPIRY_DATE + '%'
		        AND STRIKE_PRICE = @STRIKE_PRICE
		        AND OPTION_TYPE = @OPTION_TYPE
		        AND SELL_BUY = @SELL_BUY
		        AND PARTICIPANTCODE = @PARTICIPANTCODE
		        AND ORDER_NO LIKE @ORDER_NO
		        AND TRADE_NO LIKE @NEW_TRADE_NO

			SELECT @QTYTOTRANSFER = 0
		END
	        FETCH NEXT FROM @FOTRADECURSOR INTO @QTYINFOTRADE, @NEW_TRADE_NO	
	END
	CLOSE @FOTRADECURSOR
	DEALLOCATE @FOTRADECURSOR
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TURN_TAX_UPDATE_ADNL
-- --------------------------------------------------

CREATE PROC [dbo].[PROC_TURN_TAX_UPDATE_ADNL]
(                             
 @SAUDA_DATE VARCHAR(11),                 
 @FROMPARTY VARCHAR(10),                 
 @TOPARTY VARCHAR(10)                
)  

AS

-- EXEC PROC_TURN_TAX_UPDATE_ADNL 'D', 'OCT 16 2016', '0', 'ZZZZZZ'

SELECT SAUDA_DATE, PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, ORDER_NO, TRADE_NO, SRNO = MIN(SRNO), ORGTRADE_NO = MIN(TRADE_NO), TOTFLAG = 1,
TOTSRNO = 0, CHRGSRNO = 0
INTO #TOTTRADE
FROM (
		SELECT SAUDA_DATE=LEFT(SAUDA_DATE,11), 
				PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, ORDER_NO, TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO), SRNO = MIN(SRNO), ORGTRADE_NO = MIN(TRADE_NO)
		FROM FOSETTLEMENT
		WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
		AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND TRADEQTY > 0 AND PRICE > 0
		AND AUCTIONPART <> 'CA'
		GROUP BY LEFT(SAUDA_DATE,11), PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, ORDER_NO,TRADE_NO 
		) A 
GROUP BY SAUDA_DATE, PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, ORDER_NO, TRADE_NO
 
SELECT TRADE_NO_CNT = 1, T.SNO, FROM_LIMIT, TO_LIMIT INTO #TOT FROM TBL_TURNOVER_TAX T
WHERE @SAUDA_DATE BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE
AND T.REC_FOR = 'CLCHRG'
AND FROM_LIMIT = (SELECT MIN(FROM_LIMIT) FROM  TBL_TURNOVER_TAX T
WHERE @SAUDA_DATE BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE
AND T.REC_FOR = 'CLCHRG')

CREATE TABLE #CLTAX 
(
	PARTY_CODE	VARCHAR(10)
)

INSERT INTO #CLTAX
SELECT PARTY_CODE 
FROM FOCLIENTTAXES 
WHERE @SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO
AND FUT_TURNOVER_TAX <= 0 
AND EXISTS (SELECT PARTY_CODE FROM #TOTTRADE
			WHERE #TOTTRADE.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE)

UPDATE #TOTTRADE SET TOTFLAG = 0
FROM #CLTAX C
WHERE C.PARTY_CODE = #TOTTRADE.PARTY_CODE

TRUNCATE TABLE #CLTAX

INSERT INTO #CLTAX
SELECT PARTY_CODE 
FROM CLIENT2 WHERE EXISTS (SELECT PARTY_CODE FROM #TOTTRADE
				           WHERE #TOTTRADE.PARTY_CODE = CLIENT2.CL_CODE)
AND TURNOVER_TAX <= 0

UPDATE #TOTTRADE SET TOTFLAG = 0
FROM #CLTAX C
WHERE C.PARTY_CODE = #TOTTRADE.PARTY_CODE

UPDATE #TOTTRADE SET CHRGSRNO = #TOT.SNO
FROM #TOT

UPDATE FOSETTLEMENT SET TURN_TAX = TURN_TAX + CHARGE_TAX
FROM #TOT T, #TOTTRADE T1, TBL_TURNOVER_TAX B
WHERE FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
AND FOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
AND T.SNO = B.SNO
AND FOSETTLEMENT.SRNO = T1.SRNO 
AND TOTFLAG = 1

DROP TABLE #TOT
DROP TABLE #TOTTRADE
DROP TABLE #CLTAX

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_TURNTAX_EXCEPTION
-- --------------------------------------------------


CREATE PROC [dbo].[PROC_TURNTAX_EXCEPTION]        
(            
	@SAUDA_DATE VARCHAR(11),             
	@FromParty Varchar(10),             
	@ToParty Varchar(10)        
)
AS


DECLARE 
		@TOT_PER    NUMERIC(18, 6)
DECLARE @TOTAMT		NUMERIC(18, 4)

SET @TOTAMT = 0
SET @TOT_PER = -1

DELETE FROM TBL_TURNOVER_DATA WHERE SAUDA_DATE = @SAUDA_DATE

INSERT INTO TBL_TURNOVER_DATA
SELECT SAUDA_DATE=LEFT(SAUDA_DATE,11), TURNOVER = SUM(TRADEQTY*PRICE), GETDATE(), 'FUT'
FROM FOSETTLEMENT
WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
	 AND TRADEQTY > 0 AND AUCTIONPART NOT LIKE 'EA' AND AUCTIONPART NOT LIKE 'CA'
	 AND PRICE > 0 AND INST_TYPE LIKE 'FUT%'
	 AND Symbol NOT IN (SELECT SYMBOL FROM TURNTAX_EXCEPTION WHERE @SAUDA_DATE BETWEEN EFFDATE_FROM AND EFFDATE_TO 
	 AND Inst_Type LIKE 'FUT%')
GROUP BY LEFT(SAUDA_DATE,11)

INSERT INTO TBL_TURNOVER_DATA
SELECT SAUDA_DATE=LEFT(SAUDA_DATE,11), TURNOVER = SUM(TRADEQTY*PRICE), GETDATE(), 'OPT'
FROM FOSETTLEMENT
WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
	 AND TRADEQTY > 0 AND AUCTIONPART NOT LIKE 'EA' AND AUCTIONPART NOT LIKE 'CA'
	 AND PRICE > 0 AND INST_TYPE LIKE 'OPT%'
	 AND SYMBOL NOT IN (SELECT SYMBOL FROM TURNTAX_EXCEPTION WHERE @SAUDA_DATE BETWEEN EFFDATE_FROM AND EFFDATE_TO 
	 AND INST_TYPE LIKE 'OPT%')
GROUP BY LEFT(SAUDA_DATE,11)

SELECT @TOTAMT = (CASE WHEN ISNULL(SUM(TURNOVER_AMT),0) > 0 THEN ISNULL(SUM(TURNOVER_AMT),0) ELSE 1 END)
FROM TBL_TURNOVER_DATA WHERE SAUDA_DATE < @SAUDA_DATE
AND SAUDA_DATE >= CONVERT(DATETIME, CONVERT(VARCHAR,YEAR(CONVERT(DATETIME,@SAUDA_DATE))) + '-' + CONVERT(VARCHAR,MONTH(CONVERT(DATETIME,@SAUDA_DATE))) + '-' + '01')
AND INST_TYPE = 'FUT'

SELECT @TOT_PER = ISNULL(TOT_PER,-1) FROM TBL_TURN_OVER_SLAB
WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE
AND @TOTAMT > TOT_LOW_LIMIT AND @TOTAMT <= (CASE WHEN TOT_UP_LIMIT = -1 THEN @TOTAMT ELSE TOT_UP_LIMIT END)
AND INST_TYPE LIKE 'FUT%'

IF @TOT_PER > -1 
BEGIN
	UPDATE FOSETTLEMENT 
	SET TURN_TAX = (TRADEQTY*Price*@TOT_PER/100)
	WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
	 AND Party_Code BETWEEN @FromParty AND @ToParty 
	 AND TRADEQTY > 0 AND AUCTIONPART NOT LIKE 'EA' AND AUCTIONPART NOT LIKE 'CA'
	 AND PRICE > 0 AND INST_TYPE LIKE 'FUT%'
	 AND Symbol NOT IN (SELECT SYMBOL FROM TURNTAX_EXCEPTION WHERE @SAUDA_DATE BETWEEN EFFDATE_FROM AND EFFDATE_TO 
	 AND Inst_Type LIKE 'FUT%')
	 AND turn_tax > 0 
END

SET @TOTAMT = 0
SET @TOT_PER = -1

SELECT @TOTAMT = (CASE WHEN ISNULL(SUM(TURNOVER_AMT),0) > 0 THEN ISNULL(SUM(TURNOVER_AMT),0) ELSE 1 END)
FROM TBL_TURNOVER_DATA WHERE SAUDA_DATE < @SAUDA_DATE
AND SAUDA_DATE >= CONVERT(DATETIME, CONVERT(VARCHAR,YEAR(CONVERT(DATETIME,@SAUDA_DATE))) + '-' + CONVERT(VARCHAR,MONTH(CONVERT(DATETIME,@SAUDA_DATE))) + '-' + '01')
AND INST_TYPE = 'OPT'

SELECT @TOT_PER = ISNULL(TOT_PER,-1) FROM TBL_TURN_OVER_SLAB
WHERE @SAUDA_DATE BETWEEN FROMDATE AND TODATE
AND @TOTAMT > TOT_LOW_LIMIT AND @TOTAMT <= (CASE WHEN TOT_UP_LIMIT = -1 THEN @TOTAMT ELSE TOT_UP_LIMIT END)
AND INST_TYPE LIKE 'OPT%'

IF @TOT_PER > -1 
BEGIN
	UPDATE FOSETTLEMENT 
	SET TURN_TAX = (TRADEQTY*Price*@TOT_PER/100)
	WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'
	 AND Party_Code BETWEEN @FromParty AND @ToParty 
	 AND TRADEQTY > 0 AND AUCTIONPART NOT LIKE 'EA' AND AUCTIONPART NOT LIKE 'CA'
	 AND PRICE > 0 AND INST_TYPE LIKE 'OPT%'
	 AND Symbol NOT IN (SELECT SYMBOL FROM TURNTAX_EXCEPTION WHERE @SAUDA_DATE BETWEEN EFFDATE_FROM AND EFFDATE_TO 
	 AND Inst_Type LIKE 'OPT%')
	 AND turn_tax > 0 
END

  UPDATE FOSETTLEMENT  
  SET    TURN_TAX = PRICE * TRADEQTY * TAX_PERC / 100  
  FROM   TURNTAX_EXCEPTION  
  WHERE  SAUDA_DATE > @SAUDA_DATE  
         AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
         AND Party_Code BETWEEN @FromParty AND @ToParty 
         AND FOSETTLEMENT.SAUDA_DATE BETWEEN EFFDATE_FROM AND EFFDATE_TO  
         AND TURNTAX_EXCEPTION.INST_TYPE = FOSETTLEMENT.INST_TYPE  
         AND TURNTAX_EXCEPTION.SYMBOL = FOSETTLEMENT.SYMBOL  
      AND TURN_TAX > 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RECALCBROK
-- --------------------------------------------------

CREATE  PROC  [dbo].[RECALCBROK] 
(  
 @SAUDA_DATE VARCHAR (11),  
 @PARTYCODE AS VARCHAR(12),  
 @STATUSID VARCHAR(50)='',  
 @STRMODULE      VARCHAR(50)=''  
)  
  
AS      
  
IF @PARTYCODE=''  
 BEGIN  
  SET @PARTYCODE = '%'  
 END  
  
EXEC PROC_TRADE_TRANSFER_RECAL  @SAUDA_DATE,@PARTYCODE,'%','%','%',0,'%' ,@STATUSID,@STRMODULE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_accvdesc
-- --------------------------------------------------




/*this Procedure Gives Us The Discription For Supplied Vtype*/
CREATE Procedure 
[dbo].[Rpt_accvdesc] 
@Vtype Smallint
As
Select Vdesc From ACCOUNTCURBFO.Dbo.Vmast Where 
Vtype = @Vtype

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ADMIN_LOG
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_ADMIN_LOG]  
(  
 @LOGTYPE VARCHAR(20),  
 @DATEFROM VARCHAR(11),  
 @DATETO VARCHAR(11),  
 @REPORTORDER INT,  
 @TXTNAME VARCHAR(25)  
)  
AS  
  
/*  
POSSIBLE VALUES OF @LOGTYPE   
   
 MENURIGHTS  
 CATEGORY  
 ADMIN_USER  
 USERLOG  
  
*/  
  
IF @LOGTYPE ='MENURIGHTS'  
BEGIN  
 /*  
 VALID ORDER BY  
  1 - REPORT NAME + DATE  
  2 - CATEGORY + DATE  
 */  	
 SELECT   
  REPORTORDER =   
   CASE WHEN @REPORTORDER = 1 THEN REPORTNAME ELSE RIGHT(CATEGORYNAME,LEN(CATEGORYNAME)-1) END  
   + CONVERT(VARCHAR,YEAR(CREATEDON)) + CONVERT(VARCHAR,MONTH(CREATEDON)) + CONVERT(VARCHAR,DAY(CREATEDON)) +  CONVERT(VARCHAR,CREATEDON,108),  
  REPORTNAME,  
  LOGINCATEGORY,  
  CATEGORYNAME,  
  EDITFLAG =  ISNULL(CASE   
    WHEN EDIT_FLAG ='D' THEN 'CATEGORY DELETED'   
    WHEN EDIT_FLAG ='A' THEN 'CATEGORY ADDEDED'  
    WHEN EDIT_FLAG ='E' THEN  
    CASE WHEN LEFT(CATEGORYNAME,1) ='-'   
     THEN 'RIGHTS REMOVED'  
     ELSE 'RIGHTS ADDED'  
     END  
       END,'') ,  
  CREATEDBY,  
  CREATEDON =  CONVERT(VARCHAR,CREATEDON,109),  
  MACHINEIP  
 FROM  
 (  
  SELECT   
   REPORTNAME = TBLREPORTS.FLDREPORTNAME,  
   LOGINCATEGORY = TBLADMIN.FLDNAME,  
   CATEGORYNAME = LTRIM(RTRIM(DBO.FUN_GET_TBLREPORT (FLDCATEGORYCODE_OLD,FLDCATEGORYCODE_NEW))),  
   EDIT_FLAG,  
   CREATEDBY = CREATED_BY,  
   CREATEDON = CREATED_ON,  
   MACHINEIP = MACHINE_IP  
  FROM  
   TBLCATMENU_LOG (NOLOCK),  
   TBLREPORTS (NOLOCK),  
   TBLADMIN (NOLOCK)  
  WHERE  
   TBLADMIN.FLDAUTO_ADMIN = FLDADMINAUTO  
   AND TBLCATMENU_LOG.FLDREPORTCODE = TBLREPORTS.FLDREPORTCODE  
   AND TBLCATMENU_LOG.CREATED_ON BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
 ) TBLLOG  
 ORDER BY 1  
  
END  
  
IF @LOGTYPE ='CATEGORY'  
BEGIN  
 SELECT    
  REPORTORDER = FLDCATEGORYNAME +  
  + CONVERT(VARCHAR,YEAR(CREATED_ON)) + CONVERT(VARCHAR,MONTH(CREATED_ON)) + CONVERT(VARCHAR,DAY(CREATED_ON)) +  CONVERT(VARCHAR,CREATED_ON,108) ,  
  FLDCATEGORYNAME,  
  FLDDESC ,  
  EDIT_FLAG = CASE WHEN EDIT_FLAG ='A' THEN 'ADDED' ELSE 'DELETED' END,  
  CREATED_ON = CONVERT(VARCHAR,CREATED_ON,109),   
  CREATED_BY   
 FROM   
  TBLCATEGORY_LOG (NOLOCK)   
 WHERE   
  CREATED_ON  BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
  AND FLDCATEGORYNAME LIKE @TXTNAME+'%'  
 ORDER BY 1  
END  
  
IF @LOGTYPE ='REPORTLOG'  
BEGIN  
 SELECT   
  FLDREPORTNAME,FLDPATH,FLDTARGET,TB.FLDDESC,FLDGRPNAME,  
  FLDSTATUS,  
  EDIT_FLAG=  
   CASE   
    WHEN EDIT_FLAG='A' THEN 'ADDED'   
    WHEN EDIT_FLAG='I' THEN 'EDITED'  
    ELSE 'DELETED' END,  
  CREATED_ON = CONVERT(VARCHAR,CREATED_ON,109),   
  CREATED_BY   
 FROM   
  TBLREPORTS_LOG TB, TBLREPORTGRP TG  
 WHERE   
  TB.FLDREPORTGRP =TG.FLDREPORTGRP  
  AND TB.FLDMENUGRP = TG.FLDMENUGRP  
  AND CREATED_ON  BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
  AND FLDREPORTNAME LIKE @TXTNAME + '%'  
 ORDER BY 1  
END  
  
IF @LOGTYPE ='ADMIN_USER'  
BEGIN  
 /*  
 VALID ORDER BY  
  1 - USER NAME+ DATE  
  2 - EDIT FLAG  + DATE  
 */  
 SELECT   
	REPORTORDER = FLDNAME + CONVERT(VARCHAR,YEAR(CREATED_ON)) + CONVERT(VARCHAR,MONTH(CREATED_ON)) +   
    CONVERT(VARCHAR,DAY(CREATED_ON)) +  CONVERT(VARCHAR,CREATED_ON,108) +   
    CASE WHEN @REPORTORDER =1 THEN FLDNAME ELSE EDIT_FLAG END , 
	
  USERNAME=FLDNAME,FLDPASSWORD,COMPANY=FLDCOMPANY,  
  LOGINCATEGORY=FLDSTATUS,DESCRIPTION=FLDDESC,PASSWORD_EXP_DT = LEFT(PWD_EXPIRY_DATE,11),  
  MAXWRONGATTEMP_ALLOWD = FLDMAXATTEMPT,  
  USERSTATUS=CASE WHEN FLDUSERSTATUS =0 THEN 'ENABLED' ELSE 'DISABLED' END ,  
  ACCESSLVL= CASE WHEN FLDACCESSLVL ='F' THEN 'FREE ACCESS' ELSE 'LIMITED' END ,  
  IP_FILTER = FLDIPADD,  
  FIRST_LOGIN_FLAG= FLDFIRSTLOGIN,  
  EDIT_FLAG=  
   CASE   
    WHEN EDIT_FLAG='A' THEN 'ADDED'   
    WHEN EDIT_FLAG='I' THEN 'EDITED'  
    ELSE 'DELETED' END,  
  CREATED_BY,CREATED_ON = CONVERT(VARCHAR,CREATED_ON,109), MACHINEIP = ISNULL(MACHINEIP,'') , FLDLOG_DATA = ISNULL(FLDLOG_DATA,'')  
 FROM   
  TBLADMIN_LOG (NOLOCK)   
 WHERE  
   TBLADMIN_LOG.CREATED_ON BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
  AND FLDNAME LIKE @TXTNAME+'%'  
 ORDER BY 1  
  
END  
  
IF @LOGTYPE ='USERLOG'  
BEGIN  
 /*  
 VALID ORDER BY  
  1 - USER NAME+ DATE  
  2 - EDIT FLAG  + DATE  
  
 */  
 SELECT   
  REPORTORDER = FLDUSERNAME + CONVERT(VARCHAR,YEAR(CREATED_ON)) + CONVERT(VARCHAR,MONTH(CREATED_ON)) +   
    CONVERT(VARCHAR,DAY(CREATED_ON)) +  CONVERT(VARCHAR,CREATED_ON,108) +   
    CASE WHEN @REPORTORDER =1 THEN FLDUSERNAME ELSE EDIT_FLAG END ,  
  USERNAME=FLDUSERNAME,FLDPASSWORD,FLDFIRSTNAME,FLDMIDDLENAME,  
  FLDLASTNAME,FLDSEX,FLDADDRESS1,FLDADDRESS2, FLDPHONE1, FLDPHONE2,
  FLDCATEGORY,	
  PWDEXPIRYDAYS = ISNULL(B.FLDPWDEXPIRY,''),  
  PWDEXPIRY = ISNULL(B.FLDPWDEXPIRY,''),  
  MAXATTEMPT = ISNULL(B.FLDMAXATTEMPT,0),  
  USERSTATUSDB = CASE WHEN ISNULL(B.FLDSTATUS,0) =0 THEN 'ENABLED' WHEN B.FLDSTATUS = 1 THEN 'DISABLED' ELSE 'UNAUTHORISED' END ,   
  ATTEMPTCNT = ISNULL(B.FLDATTEMPTCNT,0),   
  LOGINFLAG = CASE WHEN ISNULL(B.FLDLOGINFLAG,0) = 0 THEN 'LOGGED OUT' ELSE 'LOGGED IN' END,   
  ACCESSLVL = CASE WHEN ISNULL(B.FLDACCESSLVL,'F') = 'F' THEN 'FREE ACCESS' ELSE 'LIMITED' END,   
  IPADD = ISNULL(B.FLDIPADD,''),   
  TIMEOUT = ISNULL(B.FLDTIMEOUT,0),   
  FIRSTLOGIN = CASE WHEN ISNULL(B.FLDFIRSTLOGIN,'N') = 'N' THEN 'NO' ELSE 'YES' END,   
  FORCELOGOUT = CASE WHEN ISNULL(B.FLDFORCELOGOUT,0) = 0 THEN 'ALLOW ACCESS' ELSE 'DO NOT ALLOW' END,   
  EDIT_FLAG=  
   CASE   
    WHEN EDIT_FLAG='A' THEN 'ADDED'   
    WHEN EDIT_FLAG='I' THEN 'EDITED'  
    ELSE 'DELETED' END,  
  CREATED_BY,CREATED_ON = CONVERT(VARCHAR,CREATED_ON,109), MACHINEIP = ISNULL(MACHINEIP,'') , FLDLOG_DATA = ISNULL(FLDLOG_DATA,'')   
 FROM   
  TBLPRADNYAUSERS_LOG A (NOLOCK)   
  LEFT OUTER JOIN TBLUSERCONTROLMASTER_JRNL B (NOLOCK) 
 ON   
  (B.FLDUSERID = A.FLDAUTO AND B.FLDUPDTDT = A.CREATED_ON)     
 WHERE  
   A.CREATED_ON BETWEEN @DATEFROM AND @DATETO + ' 23:59'  
  AND FLDUSERNAME LIKE @TXTNAME+'%'   
 ORDER BY 1  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_AREALISTING
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_AREALISTING]
	(
    @FROMAREACODE VARCHAR(15),
	@TOAREACODE VARCHAR(15),
	@FROMBRANCH VARCHAR(15),
	@TOBRANCH VARCHAR(15)
	)
	
AS
    IF @FROMAREACODE = '' BEGIN SET @FROMAREACODE = '0'  END
    IF @TOAREACODE = '' BEGIN SET @TOAREACODE = 'ZZZZZZ' END
    IF @FROMBRANCH = '' BEGIN SET @FROMBRANCH = '0'  END
    IF @TOBRANCH = '' BEGIN SET @TOBRANCH = 'ZZZZZZ' END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 
			AREACODE = UPPER(AREACODE),
			DESCRIPTION = UPPER(DESCRIPTION),
			BRANCH_CODE = UPPER(BRANCH_CODE)

FROM 
    AREA

WHERE
    AREACODE BETWEEN @FROMAREACODE AND @TOAREACODE
    AND BRANCH_CODE BETWEEN @FROMBRANCH AND @TOBRANCH
    

ORDER BY
		AREACODE,DESCRIPTION,BRANCH_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BANKDETAILS
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_BANKDETAILS] 
	( 
	@PARTYCODE VARCHAR(10) 
	)

	--EXEC RPT_BANKDETAILS 'O123'
	
	AS
	
	SET NOCOUNT ON 
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	SELECT 
		BANKNAME = ISNULL(P.BANK_NAME,''),
		BRANCH = ISNULL(P.BRANCH_NAME,''),
		ACNUM = ISNULL(C.CLTDPID,''),
		ACTYPE = ISNULL(C.DEPOSITORY,'')
	FROM
		CLIENT4 C (NOLOCK)
			JOIN POBANK P (NOLOCK)
			ON (P.BANKID = C.BANKID)
	WHERE
		C.DEPOSITORY NOT IN ('CDSL','NSDL')
		AND C.PARTY_CODE = @PARTYCODE

------
UNION
------


	SELECT 
		BANKNAME = ISNULL(P.BANK_NAME,''),
		BRANCH = ISNULL(P.BRANCH_NAME,''),
		ACNUM = ISNULL(C.ACCNO,''),
		ACTYPE = ISNULL(C.ACCTYPE,'')
	FROM
		ACCOUNTCURBFO.DBO.MULTIBANKID C (NOLOCK)
			JOIN POBANK P (NOLOCK)
			ON (P.BANKID = C.BANKID)
	WHERE
		C.CLTCODE = @PARTYCODE

	ORDER BY 
		BANKNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BRANCHLISTING
-- --------------------------------------------------
  
CREATE PROC [dbo].[RPT_BRANCHLISTING]  
 (  
 @FROMBRANCH VARCHAR(15),  
 @TOBRANCH VARCHAR(15),  
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25)  
 )  
   
 AS  
  
    IF @FROMBRANCH = '' BEGIN SET @FROMBRANCH = '0'  END  
    IF @TOBRANCH = '' BEGIN SET @TOBRANCH = 'ZZZZZZ' END  
  
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
 SELECT   
  BRANCHCODE  = UPPER(B.BRANCH_CODE),  
  BRANCHNAME  = UPPER(ISNULL(B.BRANCH,'')),  
  SUBBROKERCODE  = UPPER(ISNULL(S.SUB_BROKER,'')),  
  SUBBROKERNAME  = UPPER(ISNULL(S.NAME,'')),  
  TRADERCODE  = UPPER(ISNULL(B2.BRANCH_CD,'')),  
  TRADERNAME  = UPPER(ISNULL(B2.LONG_NAME,''))  
  
 FROM  
  BRANCH B (NOLOCK)  
   LEFT OUTER JOIN SUBBROKERS S (NOLOCK)  
   ON (B.BRANCH_CODE = S.BRANCH_CODE)  
     
   LEFT OUTER JOIN BRANCHES B2 (NOLOCK)  
   ON (B2.BRANCH_CD = B.BRANCH_CODE)  
  
 WHERE  
  B.BRANCH_CODE >= @FROMBRANCH   
  AND B.BRANCH_CODE <= @TOBRANCH  
                AND @STATUSNAME = (     
                 CASE   
                        WHEN @STATUSID = 'BRANCH'   
                        THEN B.BRANCH_CODE   
                        ELSE 'BROKER' END)   
  
 ORDER BY  
  B.BRANCH_CODE,  
  S.SUB_BROKER,  
  B2.BRANCH_CD

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BROKTABLE
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_BROKTABLE    SCRIPT DATE: 01/15/2005 1:28:10 PM ******/    
    
/****** OBJECT:  STORED PROCEDURE DBO.RPT_BROKTABLE    SCRIPT DATE: 12/16/2003 2:31:44 PM ******/    
    
    
    
/****** OBJECT:  STORED PROCEDURE DBO.RPT_BROKTABLE    SCRIPT DATE: 05/08/2002 12:35:08 PM ******/    
    
/****** OBJECT:  STORED PROCEDURE DBO.RPT_BROKTABLE    SCRIPT DATE: 01/14/2002 20:32:52 ******/    
    
/****** OBJECT:  STORED PROCEDURE DBO.RPT_BROKTABLE    SCRIPT DATE: 12/26/2001 1:23:16 PM ******/    
    
CREATE PROCEDURE [dbo].[RPT_BROKTABLE]    
    
@VALPERC AS VARCHAR(20),    
@VAL1 AS VARCHAR(20),    
@TRDDEL AS INT    
AS    
    
    
IF @VAL1 = '%'    
    
BEGIN    
    
    
IF @TRDDEL = 0     
    
BEGIN    
SELECT TABLE_NO,LINE_NO,TABLE_NAME,UPPER_LIM,VAL_PERC,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,NORMAL,ROUND_TO,    
TRD_DEL = (CASE WHEN TRD_DEL = 'T' THEN 'TRADING'     
  WHEN TRD_DEL = 'D' THEN 'DELIVERY'    
  WHEN TRD_DEL = 'F' THEN 'FIRST LEG'    
  WHEN TRD_DEL = 'S' THEN 'SECOND LEG'    
    END)    
FROM BROKTABLE    
WHERE TABLE_NO IN (SELECT DISTINCT TABLE_NO FROM BROKTABLE WHERE TRD_DEL IN ('T','S','F','D') AND VAL_PERC LIKE @VALPERC)      
ORDER BY TABLE_NO,LINE_NO,UPPER_LIM    
END    
    
    
IF @TRDDEL = 1    
    
BEGIN    
SELECT TABLE_NO,LINE_NO,TABLE_NAME,UPPER_LIM,VAL_PERC,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,NORMAL,ROUND_TO,    
TRD_DEL = (CASE WHEN TRD_DEL = 'T' THEN 'TRADING'     
  WHEN TRD_DEL = 'D' THEN 'DELIVERY'    
  WHEN TRD_DEL = 'F' THEN 'FIRST LEG'    
  WHEN TRD_DEL = 'S' THEN 'SECOND LEG'    
    END)    
FROM BROKTABLE    
WHERE  TABLE_NO IN (SELECT DISTINCT TABLE_NO FROM BROKTABLE WHERE TRD_DEL IN ('T','S','F') AND VAL_PERC LIKE @VALPERC)      
ORDER BY TABLE_NO,LINE_NO,UPPER_LIM    
END    
IF @TRDDEL = 2    
    
BEGIN    
SELECT TABLE_NO,LINE_NO,TABLE_NAME,UPPER_LIM,VAL_PERC,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,NORMAL,ROUND_TO,    
TRD_DEL = (CASE WHEN TRD_DEL = 'T' THEN 'TRADING'     
  WHEN TRD_DEL = 'D' THEN 'DELIVERY'    
  WHEN TRD_DEL = 'F' THEN 'FIRST LEG'    
  WHEN TRD_DEL = 'S' THEN 'SECOND LEG'    
    END)    
FROM BROKTABLE    
WHERE TABLE_NO IN (SELECT DISTINCT TABLE_NO FROM BROKTABLE WHERE TRD_DEL IN ('D') AND VAL_PERC LIKE @VALPERC)      
ORDER BY TABLE_NO,LINE_NO,UPPER_LIM    
END    
    
END    
    
    
    
IF @VAL1 <> '%'    
    
BEGIN    
    
    
IF @TRDDEL = 0     
    
BEGIN    
SELECT TABLE_NO,LINE_NO,TABLE_NAME,UPPER_LIM,VAL_PERC,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,NORMAL,ROUND_TO,    
TRD_DEL = (CASE WHEN TRD_DEL = 'T' THEN 'TRADING'     
  WHEN TRD_DEL = 'D' THEN 'DELIVERY'    
  WHEN TRD_DEL = 'F' THEN 'FIRST LEG'    
  WHEN TRD_DEL = 'S' THEN 'SECOND LEG'    
    END)    
FROM BROKTABLE    
WHERE TABLE_NO IN (SELECT DISTINCT TABLE_NO FROM BROKTABLE WHERE    
(DAY_PUC = CAST(@VAL1 AS NUMERIC(36, 12)) OR DAY_SALES = CAST(@VAL1 AS NUMERIC(36, 12)) OR SETT_PURCH = CAST(@VAL1 AS NUMERIC(36, 12)) OR SETT_SALES = CAST(@VAL1 AS NUMERIC(36, 12)) OR NORMAL = CAST(@VAL1 AS NUMERIC(36, 12)))    
AND TRD_DEL IN ('T','S','F','D') AND VAL_PERC LIKE @VALPERC)      
ORDER BY TABLE_NO,LINE_NO,UPPER_LIM    
END    
    
    
IF @TRDDEL = 1    
    
BEGIN    
SELECT TABLE_NO,LINE_NO,TABLE_NAME,UPPER_LIM,VAL_PERC,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,NORMAL,ROUND_TO,    
TRD_DEL = (CASE WHEN TRD_DEL = 'T' THEN 'TRADING'     
  WHEN TRD_DEL = 'D' THEN 'DELIVERY'    
  WHEN TRD_DEL = 'F' THEN 'FIRST LEG'    
  WHEN TRD_DEL = 'S' THEN 'SECOND LEG'    
    END)    
FROM BROKTABLE    
WHERE TABLE_NO IN (SELECT DISTINCT TABLE_NO FROM BROKTABLE WHERE    
 (DAY_PUC = CAST(@VAL1 AS NUMERIC(36, 12)) OR DAY_SALES = CAST(@VAL1 AS NUMERIC(36, 12)) OR SETT_PURCH = CAST(@VAL1 AS NUMERIC(36, 12)) OR SETT_SALES = CAST(@VAL1 AS NUMERIC(36, 12)) OR NORMAL = CAST(@VAL1 AS NUMERIC(36, 12)))    
AND TRD_DEL IN ('T','S','F') AND VAL_PERC LIKE @VALPERC)       
ORDER BY TABLE_NO,LINE_NO,UPPER_LIM    
END    
IF @TRDDEL = 2    
    
BEGIN    
SELECT TABLE_NO,LINE_NO,TABLE_NAME,UPPER_LIM,VAL_PERC,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,NORMAL,ROUND_TO,    
TRD_DEL = (CASE WHEN TRD_DEL = 'T' THEN 'TRADING'     
  WHEN TRD_DEL = 'D' THEN 'DELIVERY'    
  WHEN TRD_DEL = 'F' THEN 'FIRST LEG'    
  WHEN TRD_DEL = 'S' THEN 'SECOND LEG'    
    END)    
FROM BROKTABLE    
WHERE  TABLE_NO IN (SELECT DISTINCT TABLE_NO FROM BROKTABLE WHERE    
 (DAY_PUC = CAST(@VAL1 AS NUMERIC(36, 12)) OR DAY_SALES = CAST(@VAL1 AS NUMERIC(36, 12)) OR SETT_PURCH = CAST(@VAL1 AS NUMERIC(36, 12)) OR SETT_SALES = CAST(@VAL1 AS NUMERIC(36, 12)) OR NORMAL = CAST(@VAL1 AS NUMERIC(36, 12)))    
AND TRD_DEL IN ('D') AND VAL_PERC LIKE @VALPERC)      
ORDER BY TABLE_NO,LINE_NO,UPPER_LIM    
END    
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_BROKTABLEDETAILS
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_BROKTABLEDETAILS]

@TABNO AS INT

AS

SELECT TABLE_NO,UPPER_LIM,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,NORMAL,TRD_DEL,VAL_PERC,LINE_NO,TABLE_NAME,ROUND_TO,
ROFIG,ERRNUM,NOZERO,

RT = ( CASE WHEN ( ROFIG =0  AND  ERRNUM=0.5 AND  NOZERO=1) THEN 'ACTUAL'  ELSE 
      		( CASE WHEN ( ROFIG =1  AND  ERRNUM=-0.1 AND  NOZERO=0) THEN 'NEXT 1P' ELSE 
      			( CASE WHEN ( ROFIG =5  AND  ERRNUM=-0.1 AND  NOZERO=0) THEN 'NEXT 5P' ELSE
				( CASE WHEN ( ROFIG =-1  AND  ERRNUM=0.1 AND  NOZERO=0) THEN 'PREV 1P' ELSE
					( CASE WHEN ( ROFIG =-5  AND  ERRNUM=0.1 AND  NOZERO=0) THEN 'PREV 5P' ELSE 
						( CASE WHEN ( ROFIG =5  AND  ERRNUM=-2.5 AND  NOZERO=0) THEN 'BANKERS'
	
						END )END )END )END )END )END )
FROM BROKTABLE
WHERE TABLE_NO = @TABNO
ORDER BY TABLE_NO,LINE_NO,UPPER_LIM

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CLIENTLIST
-- --------------------------------------------------
CREATE   PROCEDURE [dbo].[RPT_CLIENTLIST]  
  
@ORDER_BY AS VARCHAR(9)  
  
AS  
  
IF @ORDER_BY='BRANCH'  
  
BEGIN  
  
SELECT DISTINCT C1.SHORT_NAME,C1.LONG_NAME,C1.RES_PHONE1,C1.OFF_PHONE1,C1.CL_CODE,C1.EMAIL,  
C1.BRANCH_CD,C1.FAMILY,C1.SUB_BROKER,C1.TRADER,  
C2.PARTY_CODE,C2.TURNOVER_TAX,C2.SEBI_TURN_TAX,INSURANCE_CHRG,BROKERNOTE,OTHER_CHRG,  
C3.BRANCH,C4.SHORT_NAME AS TRADER_NAME,C5.NAME,C5.COM_PERC,C1.PAN_GIR_NO,  
CONVERT(VARCHAR(11),ACTIVEFROM) AS ACTIVEFROM ,CONVERT(VARCHAR(11),INACTIVEFROM)   AS INACTIVEFROM,  
CL5.INTRODUCER,CL5.APPROVER   
FROM CLIENT1 C1 LEFT OUTER JOIN CLIENT5 CL5 ON ( CL5.CL_CODE = C1.CL_CODE )   
  
,CLIENT2 C2,BRANCH C3,BRANCHES C4,SUBBROKERS C5  
WHERE C1.CL_CODE=C2.CL_CODE AND  
C1.BRANCH_CD=C3.BRANCH_CODE AND  
C1.TRADER=C4.SHORT_NAME AND  
C1.SUB_BROKER=C5.SUB_BROKER AND  
C3.BRANCH_CODE=C4.BRANCH_CD  
  
ORDER BY C1.BRANCH_CD,C2.PARTY_CODE  
  
END  
  
  
IF @ORDER_BY='SUBBROKER'  
  
BEGIN  
  
SELECT DISTINCT C1.SHORT_NAME,C1.LONG_NAME,C1.RES_PHONE1,C1.OFF_PHONE1,C1.CL_CODE,C1.EMAIL,  
C1.BRANCH_CD,C1.FAMILY,C1.SUB_BROKER,C1.TRADER,  
C2.PARTY_CODE,C2.TURNOVER_TAX,C2.SEBI_TURN_TAX,INSURANCE_CHRG,BROKERNOTE,OTHER_CHRG,  
C3.BRANCH,C4.SHORT_NAME AS TRADER_NAME,C5.NAME,C5.COM_PERC,C1.PAN_GIR_NO,  
CONVERT(VARCHAR(11),ACTIVEFROM) AS ACTIVEFROM ,CONVERT(VARCHAR(11),INACTIVEFROM)   AS INACTIVEFROM,  
CL5.INTRODUCER,CL5.APPROVER   
FROM CLIENT1 C1 LEFT OUTER JOIN CLIENT5 CL5 ON ( CL5.CL_CODE = C1.CL_CODE )   
  
,CLIENT2 C2,BRANCH C3,BRANCHES C4,SUBBROKERS C5  
WHERE C1.CL_CODE=C2.CL_CODE AND  
C1.BRANCH_CD=C3.BRANCH_CODE AND  
C1.TRADER=C4.SHORT_NAME AND  
C1.SUB_BROKER=C5.SUB_BROKER AND  
C3.BRANCH_CODE=C4.BRANCH_CD  
  
ORDER BY C1.SUB_BROKER,C2.PARTY_CODE  
  
END  
  
IF @ORDER_BY='CLIENT'  
  
BEGIN  
SELECT DISTINCT C1.SHORT_NAME,C1.LONG_NAME,C1.RES_PHONE1,C1.OFF_PHONE1,C1.CL_CODE,C1.EMAIL,  
C1.BRANCH_CD,C1.FAMILY,C1.SUB_BROKER,C1.TRADER,  
C2.PARTY_CODE,C2.TURNOVER_TAX,C2.SEBI_TURN_TAX,INSURANCE_CHRG,BROKERNOTE,OTHER_CHRG,  
C3.BRANCH,C4.SHORT_NAME AS TRADER_NAME,C5.NAME,C5.COM_PERC,C1.PAN_GIR_NO,  
CONVERT(VARCHAR(11),ACTIVEFROM) AS ACTIVEFROM ,CONVERT(VARCHAR(11),INACTIVEFROM)   AS INACTIVEFROM,  
CL5.INTRODUCER,CL5.APPROVER   
FROM CLIENT1 C1 LEFT OUTER JOIN CLIENT5 CL5 ON ( CL5.CL_CODE = C1.CL_CODE )   
  
,CLIENT2 C2,BRANCH C3,BRANCHES C4,SUBBROKERS C5  
WHERE C1.CL_CODE=C2.CL_CODE AND  
C1.BRANCH_CD=C3.BRANCH_CODE AND  
C1.TRADER=C4.SHORT_NAME AND  
C1.SUB_BROKER=C5.SUB_BROKER AND  
C3.BRANCH_CODE=C4.BRANCH_CD  
  
ORDER BY C1.SHORT_NAME  
  
END  
  
IF @ORDER_BY='FAMILY'  
  
BEGIN  
SELECT DISTINCT C1.SHORT_NAME,C1.LONG_NAME,C1.RES_PHONE1,C1.OFF_PHONE1,C1.CL_CODE,C1.EMAIL,  
C1.BRANCH_CD,C1.FAMILY,C1.SUB_BROKER,C1.TRADER,  
C2.PARTY_CODE,C2.TURNOVER_TAX,C2.SEBI_TURN_TAX,INSURANCE_CHRG,BROKERNOTE,OTHER_CHRG,  
C3.BRANCH,C4.SHORT_NAME AS TRADER_NAME,C5.NAME,C5.COM_PERC,C1.PAN_GIR_NO,  
CONVERT(VARCHAR(11),ACTIVEFROM) AS ACTIVEFROM ,CONVERT(VARCHAR(11),INACTIVEFROM)   AS INACTIVEFROM,  
CL5.INTRODUCER,CL5.APPROVER   
FROM CLIENT1 C1 LEFT OUTER JOIN CLIENT5 CL5 ON ( CL5.CL_CODE = C1.CL_CODE )      
,CLIENT2 C2,BRANCH C3,BRANCHES C4,SUBBROKERS C5  
WHERE C1.CL_CODE=C2.CL_CODE AND  
C1.BRANCH_CD=C3.BRANCH_CODE AND  
C1.TRADER=C4.SHORT_NAME AND  
C1.SUB_BROKER=C5.SUB_BROKER AND  
C3.BRANCH_CODE=C4.BRANCH_CD  
  
ORDER BY C1.FAMILY  
  
END  
  
IF @ORDER_BY='ACTIVE'  
  
BEGIN  
SELECT DISTINCT C1.SHORT_NAME,C1.LONG_NAME,C1.RES_PHONE1,C1.OFF_PHONE1,C1.CL_CODE,C1.EMAIL,  
C1.BRANCH_CD,C1.FAMILY,C1.SUB_BROKER,C1.TRADER,  
C2.PARTY_CODE,C2.TURNOVER_TAX,C2.SEBI_TURN_TAX,INSURANCE_CHRG,BROKERNOTE,OTHER_CHRG,  
C3.BRANCH,C4.SHORT_NAME AS TRADER_NAME,C5.NAME,C5.COM_PERC,C1.PAN_GIR_NO,  
CONVERT(VARCHAR(11),ACTIVEFROM) AS ACTIVEFROM ,CONVERT(VARCHAR(11),INACTIVEFROM)   AS INACTIVEFROM,  
CL5.INTRODUCER,CL5.APPROVER   
FROM CLIENT1 C1 LEFT OUTER JOIN CLIENT5 CL5 ON ( CL5.CL_CODE = C1.CL_CODE )   
  
,CLIENT2 C2,BRANCH C3,BRANCHES C4,SUBBROKERS C5  
WHERE C1.CL_CODE=C2.CL_CODE AND  
C1.BRANCH_CD=C3.BRANCH_CODE AND  
C1.TRADER=C4.SHORT_NAME AND  
C1.SUB_BROKER=C5.SUB_BROKER AND  
C3.BRANCH_CODE=C4.BRANCH_CD  
  
ORDER BY ACTIVEFROM ASC  
  
END  
  
IF @ORDER_BY='INACTIVE'  
  
BEGIN  
SELECT DISTINCT C1.SHORT_NAME,C1.LONG_NAME,C1.RES_PHONE1,C1.OFF_PHONE1,C1.CL_CODE,C1.EMAIL,  
C1.BRANCH_CD,C1.FAMILY,C1.SUB_BROKER,C1.TRADER,  
C2.PARTY_CODE,C2.TURNOVER_TAX,C2.SEBI_TURN_TAX,INSURANCE_CHRG,BROKERNOTE,OTHER_CHRG,  
C3.BRANCH,C4.SHORT_NAME AS TRADER_NAME,C5.NAME,C5.COM_PERC,C1.PAN_GIR_NO,  
CONVERT(VARCHAR(11),ACTIVEFROM) AS ACTIVEFROM ,CONVERT(VARCHAR(11),INACTIVEFROM)   AS INACTIVEFROM ,  
CL5.INTRODUCER,CL5.APPROVER  
FROM CLIENT1 C1 LEFT OUTER JOIN CLIENT5 CL5 ON ( CL5.CL_CODE = C1.CL_CODE )   
  
,CLIENT2 C2,BRANCH C3,BRANCHES C4,SUBBROKERS C5  
WHERE C1.CL_CODE=C2.CL_CODE AND  
C1.BRANCH_CD=C3.BRANCH_CODE AND  
C1.TRADER=C4.SHORT_NAME AND  
C1.SUB_BROKER=C5.SUB_BROKER AND  
C3.BRANCH_CODE=C4.BRANCH_CD  
  
ORDER BY INACTIVEFROM ASC  
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CLIENTLIST_REPORT
-- --------------------------------------------------
--EXEC RPT_CLIENTLIST_REPORT 'APR  4 2008','JUN 11 2009','','BROKER','BROKER','','','BRANCH','','','%','A' 
CREATE PROCEDURE  [dbo].[RPT_CLIENTLIST_REPORT]  
(                
 @FROMDATE AS VARCHAR(11),  
 @TODATE AS VARCHAR(11),  
 @ORDER_BY AS VARCHAR(16),  
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),  
 @FROMPARTY VARCHAR(10),  
 @TOPARTY VARCHAR(10),  
 @FILTERVALUE VARCHAR(10),  
 @FROMCODE VARCHAR(10),  
 @TOCODE VARCHAR(10),  
 @FIELDINPUT VARCHAR(15),
 @CLTSTATUS CHAR(2)  
)  
AS  
  
DECLARE   
 @REGIONCODEFROM VARCHAR(10) ,  
 @REGIONCODETO VARCHAR(10) ,  
 @AREACODEFROM VARCHAR(10) ,  
 @AREACODETO VARCHAR(10) ,  
 @BRANCHFROM VARCHAR(10) ,  
 @BRANCHTO VARCHAR(10) ,  
 @SUBBROKERFROM VARCHAR(10) ,  
 @SUBBROKERTO VARCHAR(10) ,  
 @TRADERFROM VARCHAR(10) ,  
 @TRADERTO VARCHAR(10),  
 @SBUFROM VARCHAR(10),  
 @SBUTO VARCHAR(10),
 @ACTINACTDT VARCHAR(10),
 @FLDNAME VARCHAR(20)   
  
SET @REGIONCODEFROM =''  
SET @AREACODEFROM =''  
SET @BRANCHFROM =''  
SET @SUBBROKERFROM =''  
SET @TRADERFROM =''  
SET @SBUFROM =''  
  
SET @REGIONCODETO =  'ZZZZZZZZZZZZ'  
SET @AREACODETO = 'ZZZZZZZZZZZZZ'  
SET @BRANCHTO = 'ZZZZZZZZZZZZZ'  
SET @SUBBROKERTO = 'ZZZZZZZZZZZZZ'  
SET @TRADERTO = 'ZZZZZZZZZZZZZ'  
SET @SBUTO = 'ZZZZZZZZZZZZZZ'  
  
IF @FILTERVALUE = 'REGION' AND @TOCODE <> ''                  
 BEGIN                  
  SET @REGIONCODEFROM = @FROMCODE  
  SET @REGIONCODETO = @TOCODE                 
 END                  
IF @FILTERVALUE = 'AREA'    AND @TOCODE <> ''                   
 BEGIN                  
  SET @AREACODEFROM = @FROMCODE  
  SET @AREACODETO = @TOCODE                 
 END   
IF @FILTERVALUE = 'SUBBROKER'  AND @TOCODE <> ''                     
 BEGIN                  
  SET @SUBBROKERFROM = @FROMCODE  
  SET @SUBBROKERTO = @TOCODE                 
 END               
IF @FILTERVALUE = 'BRANCH'  AND @TOCODE <> ''                     
 BEGIN                  
  SET @BRANCHFROM = @FROMCODE  
  SET @BRANCHTO = @TOCODE                 
 END              
IF @FILTERVALUE = 'TRADER'   AND @TOCODE <> ''                    
 BEGIN                  
  SET @TRADERFROM = @FROMCODE  
  SET @TRADERTO = @TOCODE                 
 END           
  
IF @FILTERVALUE = 'SBU' AND @TOCODE <> ''                    
 BEGIN                  
  SET @SBUFROM = @FROMCODE  
  SET @SBUTO = @TOCODE                 
 END           
          
IF @TOPARTY = ''                  
BEGIN                  
 SET @TOPARTY = 'ZZZZZZZZZZZZZ'                  
END  

IF @CLTSTATUS = 'A'
 BEGIN 
  SET @FLDNAME  = 'ACTIVEFROM'
 END 

IF @CLTSTATUS = 'IN'
 BEGIN 
  SET @FLDNAME  = 'INACTIVEFROM'
 END 

                   
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
    
SELECT     
  
ORDERBY = (      
    CASE       
        WHEN @ORDER_BY = 'BRANCH'       
        THEN C1.BRANCH_CD       
        ELSE       
        CASE       
            WHEN @ORDER_BY = 'SUBBROKER'       
            THEN C1.SUB_BROKER       
            ELSE       
            CASE       
                WHEN @ORDER_BY = 'PARTYCODE'       
                THEN C2.PARTY_CODE       
                ELSE       
                CASE       
                    WHEN @ORDER_BY = 'CLIENT'       
                    THEN C1.SHORT_NAME       
                    ELSE       
                    CASE       
                        WHEN @ORDER_BY = 'FAMILY'       
                        THEN C1.FAMILY       
                        ELSE       
                        CASE       
                            WHEN @ORDER_BY = 'ACTIVE'       
                            THEN CONVERT(VARCHAR(11),ACTIVEFROM)       
                            ELSE       
                            CASE       
                                WHEN @ORDER_BY = 'INACTIVE'       
                                THEN CONVERT(VARCHAR(11),INACTIVEFROM)       
                            END       
                        END       
                    END       
                END       
            END       
        END       
    END       
    )    ,  
    C1.SHORT_NAME,     
    C1.LONG_NAME,     
    ISNULL(C1.RES_PHONE1,'-') AS RES_PHONE1,     
    ISNULL(C1.OFF_PHONE1,'-') AS OFF_PHONE1,     
    C1.CL_CODE,     
    ISNULL(C1.EMAIL,'-') AS EMAIL,     
    ISNULL(C1.BRANCH_CD,'-') AS BRANCH_CD,     
    ISNULL(C1.FAMILY,'-') AS FAMILY,     
    ISNULL(C1.SUB_BROKER,'-') AS SUB_BROKER,     
	ISNULL(C1.TRADER,'-') AS TRADER,     
    C2.PARTY_CODE,     
    C2.TURNOVER_TAX,     
    C2.SEBI_TURN_TAX,     
    INSURANCE_CHRG,    
    BROKERNOTE,     
    OTHER_CHRG,     
    ISNULL(C3.BRANCH,'-') AS BRANCH,     
    C4.SHORT_NAME AS TRADER_NAME,     
    C5.NAME,    
    C5.COM_PERC,     
	ISNULL(C1.PAN_GIR_NO,'-') AS PAN_GIR_NO,     
    ISNULL(CONVERT(VARCHAR(11),ACTIVEFROM),'-') AS ACTIVEFROM,     
    ISNULL(CONVERT(VARCHAR(11),INACTIVEFROM),'-') AS INACTIVEFROM,     
    INTRODUCER = ISNULL(CL5.INTRODUCER,'-'),     
    APPROVER = ISNULL(CL5.APPROVER,'-'),     
    ISNULL(C1.L_ADDRESS1,'-') AS L_ADDRESS1,     
    ISNULL(C1.L_ADDRESS2,'-') AS L_ADDRESS2,     
    ISNULL(CL41.CLTDPID,'-') AS ACCNO,     
    ISNULL(POBANKCODE,'-') AS POBANKCODE,     
    ISNULL(POBANKNAME,'-') AS POBANKNAME,     
    ISNULL(PAYMODE,'-') AS PAYMODE,     
    BANKID = ISNULL(CL4.BANKID,'-'),     
    CLIENTDPID=ISNULL(CL4.CLTDPID,'-'),     
    ISNULL(C1.L_ADDRESS3,'-') AS L_ADDRESS3,     
    ISNULL(C1.L_CITY,'-') AS L_CITY,     
    ISNULL(C1.L_STATE,'-') AS L_STATE,     
    ISNULL(C1.L_NATION,'-') AS L_NATION,     
    ISNULL(C1.L_ZIP,'-') AS L_ZIP,     
    ISNULL(C1.FAX,'-') AS FAX,     
    ISNULL(C1.MOBILE_PAGER,'-') AS MOBILE_PAGER,     
    CLBANKID=ISNULL(CL41.BANKID,'-'),     
    BANKNAME = ISNULL(B.BANK_NAME,'-')     
FROM CLIENT1 C1 (NOLOCK),     
    ( SELECT * FROM CLIENT5 (NOLOCK)  WHERE CASE WHEN @CLTSTATUS = '%' THEN ACTIVEFROM ELSE CASE WHEN @CLTSTATUS = 'A' THEN ACTIVEFROM ELSE INACTIVEFROM END END BETWEEN   
    @FROMDATE 
	 AND @TODATE + ' 23:59'

	OR
 CASE WHEN @CLTSTATUS = '%' THEN INACTIVEFROM ELSE CASE WHEN @CLTSTATUS = 'A' THEN ACTIVEFROM ELSE INACTIVEFROM END END BETWEEN   
    @FROMDATE 
	 AND @TODATE + ' 23:59'
			 ) CL5 ,   
    CLIENT2 C2 (NOLOCK)     
LEFT OUTER JOIN     
    CLIENT4 CL4     
    ON     
    (     
        CL4.PARTY_CODE = C2.PARTY_CODE     
        AND CL4.DEFDP = 1     
        AND CL4.DEPOSITORY IN ('CDSL','NSDL')    
    )     
LEFT OUTER JOIN     
    CLIENT4 CL41     
    ON     
    (     
        CL41.CL_CODE = C2.CL_CODE     
        AND CL41.DEPOSITORY NOT IN ('CDSL','NSDL')    
    )     
LEFT OUTER JOIN     
    POBANK B     
    ON     
    (    
        CONVERT(VARCHAR,B.BANKID)=CL41.BANKID    
    )    
    ,     
    BRANCH C3 (NOLOCK),     
    BRANCHES C4 (NOLOCK),     
    SUBBROKERS C5 (NOLOCK),     
    ACCOUNTCURBFO.DBO.ACMAST AM (NOLOCK)    
WHERE C1.CL_CODE=C2.CL_CODE     
    AND C1.BRANCH_CD=C3.BRANCH_CODE     
    AND C1.TRADER=C4.SHORT_NAME     
    AND C1.SUB_BROKER=C5.SUB_BROKER     
    AND C3.BRANCH_CODE=C4.BRANCH_CD     
    AND C2.PARTY_CODE >= @FROMPARTY     
    AND C2.PARTY_CODE <= @TOPARTY  
    AND AM.CLTCODE = C2.PARTY_CODE     
    AND CL5.CL_CODE = C1.CL_CODE     
    AND CL5.SYSTUMDATE BETWEEN   
    CASE   
 WHEN LEN(@FROMDATE) > 1  
 THEN @FROMDATE ELSE 'JAN  1 1900'   
 END  
    AND  
    CASE   
 WHEN LEN(@TODATE) > 1  
 THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59'   
        END  
    AND @STATUSNAME = (     
        CASE     
                WHEN @STATUSID = 'BRANCH'     
                THEN C1.BRANCH_CD     
                WHEN @STATUSID = 'SUBBROKER'     
                THEN C1.SUB_BROKER     
                WHEN @STATUSID = 'TRADER'     
                THEN C1.TRADER     
                WHEN @STATUSID = 'FAMILY'     
                THEN C1.FAMILY     
                WHEN @STATUSID = 'AREA'     
                THEN C1.AREA     
                WHEN @STATUSID = 'REGION'     
                THEN C1.REGION     
                WHEN @STATUSID = 'CLIENT'     
           THEN C2.PARTY_CODE     
                ELSE 'BROKER' END)   
 AND  C1.REGION BETWEEN @REGIONCODEFROM AND @REGIONCODETO  
 AND  C1.AREA BETWEEN @AREACODEFROM AND @AREACODETO  
 AND  C1.BRANCH_CD BETWEEN @BRANCHFROM AND @BRANCHTO  
 AND  C1.SUB_BROKER BETWEEN @SUBBROKERFROM AND @SUBBROKERTO  
 AND  C1.TRADER BETWEEN @TRADERFROM AND @TRADERTO  
 AND  C2.DUMMY8 BETWEEN @SBUFROM AND @SBUTO  
 AND  1 = (CASE   
	WHEN UPPER(@FIELDINPUT) = 'MAIL' THEN (CASE WHEN C1.EMAIL = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'PAN' THEN (CASE WHEN C1.PAN_GIR_NO = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'BANKNAME' THEN (CASE WHEN B.BANK_NAME = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'BRANCH' THEN (CASE WHEN B.BRANCH_NAME = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'TELR' THEN (CASE WHEN C1.RES_PHONE1 = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'TELO' THEN (CASE WHEN C1.OFF_PHONE1 = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'MOBILE' THEN (CASE WHEN C1.MOBILE_PAGER = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'FAX' THEN (CASE WHEN C1.FAX = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'ACCNO' THEN (CASE WHEN CL41.CLTDPID = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'DDPID' THEN (CASE WHEN CL4.CLTDPID = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'BDPID' THEN (CASE WHEN CL4.BANKID = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'ADD1' THEN (CASE WHEN C1.L_ADDRESS1 = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'ADD2' THEN (CASE WHEN C1.L_ADDRESS2 = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'ADD3' THEN (CASE WHEN C1.L_ADDRESS3 = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'CITY' THEN (CASE WHEN C1.L_CITY = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'STATE' THEN (CASE WHEN C1.L_STATE = '' THEN 1 ELSE 2 END)
	WHEN UPPER(@FIELDINPUT) = 'ZIP' THEN (CASE WHEN C1.L_ZIP = '' THEN 1 ELSE 2 END)
   ELSE 1  
  END)  
  
ORDER BY 1  

--SELECT TOP 100 * FROM CLIENT1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CLIENTMARGINREPORT
-- --------------------------------------------------


CREATE PROC [dbo].[RPT_CLIENTMARGINREPORT]    
	(    
	@MDATE VARCHAR(11),    
	@FROMBRANCH VARCHAR(15),    
	@TOBRANCH VARCHAR(15),    
	@FROMPARTY VARCHAR(15),    
	@TOPARTY VARCHAR(15),    
	@STATUSID VARCHAR(15),    
	@STATUSNAME VARCHAR(25),    
	@FROMSUBBROKER VARCHAR(15) = '',  
	@TOSUBBROKER VARCHAR(15) ='ZZZZZZZZ',
	@DCNFLAG INT = 0  
	)    
	
	AS    
    
	SET @DCNFLAG = CONVERT(NUMERIC,@DCNFLAG)

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
	SELECT  
		EXCHANGE = 'MFO',  
		SEGMENT = 'FUTURES',     
		MDT_FD = SUM(PREV_FD),     
		MDT_BG = SUM(PREV_BG),     
		MDT_SEC = SUM(PREV_SEC),     
		MDT_CASH= SUM(PREV_CASH),     
		MDT_TOTAL = SUM((PREV_FD+PREV_BG+PREV_SEC+PREV_CASH)),    
		MAR_UTILISED = SUM(PREV_VAR),    
		MDT1_FD = SUM(CURR_FD),    
		MDT1_BG = SUM(CURR_BG),    
		MDT1_SEC= SUM(CURR_SEC),    
		MDT1_CASH = SUM(CURR_CASH),    
		MDT1_TOTAL= SUM((CURR_FD+CURR_BG+CURR_SEC+CURR_CASH)),    
		MAR_ADJUSTMENT = SUM(MAR_ADJUST),    
		MAR_STATUS = SUM(MAR_STATUS),    
		/*MAR_UTILISED_EXC = SUM(PREV_VAR_EXC),    
		MAR_ADJUSTMENT_EXC = SUM(MAR_ADJUST_EXC),    
		MAR_STATUS_EXC = SUM(MAR_STATUS_EXC),*/
		MAR_UTILISED_EXC = 0,    
		MAR_ADJUSTMENT_EXC = 0,    
		MAR_STATUS_EXC = 0,
		
		M.PARTY_CODE,    
		C1.LONG_NAME,    
		C1.L_ADDRESS1,    
		C1.L_ADDRESS2,    
		C1.L_ADDRESS3,    
		C1.L_CITY,    
		C1.L_ZIP,    
		C1.L_STATE,    
		C1.L_NATION,    
		C1.EMAIL,    
		C1.PAN_GIR_NO,    
		C1.BRANCH_CD,    
		C1.SUB_BROKER    
	FROM    
		MARGIN_REPORTING M (NOLOCK),    
		CLIENT1 C1 (NOLOCK),
		CLIENT2 C2 (NOLOCK),
		CLIENT_PRINT_SETTINGS CP (NOLOCK)
	WHERE    
		M.PARTY_CODE = C2.PARTY_CODE    
		AND C1.CL_CODE = C2.CL_CODE    
		AND SAUDA_DATE LIKE @MDATE + '%'    
		AND M.PARTY_CODE >= @FROMPARTY    
		AND M.PARTY_CODE <= @TOPARTY    
		AND BRANCH_CD  >= @FROMBRANCH    
		AND BRANCH_CD  <= @TOBRANCH    
		AND SUB_BROKER >= @FROMSUBBROKER  
		AND SUB_BROKER <= @TOSUBBROKER  
		AND C2.PRINTF = CP.PRINT_FLAG
		AND CP.VALID_REPORT LIKE (CASE
						WHEN @DCNFLAG = 0 THEN '%'
						WHEN @DCNFLAG = 1 THEN '%CONTRACT%'
						WHEN @DCNFLAG = 2 THEN '%DIGITAL%'
						ELSE CP.VALID_REPORT
					END)
		AND @STATUSNAME = (CASE   
					WHEN @STATUSID = 'BRANCH'   
					THEN C1.BRANCH_CD   
					WHEN @STATUSID = 'SUBBROKER'   
					THEN C1.SUB_BROKER   
					WHEN @STATUSID = 'TRADER'   
					THEN C1.TRADER   
					WHEN @STATUSID = 'FAMILY'   
					THEN C1.FAMILY   
					WHEN @STATUSID = 'AREA'   
					THEN C1.AREA   
					WHEN @STATUSID = 'REGION'   
					THEN C1.REGION   
					WHEN @STATUSID = 'CLIENT'   
					THEN M.PARTY_CODE   
					ELSE 'BROKER' END)   
	
	GROUP BY    
		M.PARTY_CODE,    
		C1.LONG_NAME,    
		C1.L_ADDRESS1,    
		C1.L_ADDRESS2,    
		C1.L_ADDRESS3,    
		C1.L_CITY,    
		C1.L_ZIP,    
		C1.L_STATE,    
		C1.L_NATION,    
		C1.EMAIL,    
		C1.PAN_GIR_NO,    
		C1.BRANCH_CD,    
		C1.SUB_BROKER    
	
	ORDER BY    
		M.PARTY_CODE,    
		BRANCH_CD,    
		SUB_BROKER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CLIENTPERIOD_NEW
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_CLIENTPERIOD_NEW]    
@FROMDT DATETIME,     
@TODT DATETIME,    
@CLTCODE VARCHAR(10),    
@SORTBY VARCHAR(3),    
@STATUSNAME VARCHAR(25),    
@REPORTPARA VARCHAR(5)    
    
AS    
    
--*** RPT_CLIENTOPENBAL ***--    
IF @REPORTPARA='1' AND @SORTBY='VDT'     
 BEGIN    
  SELECT DRTOT=ISNULL((CASE DRCR WHEN 'D' THEN SUM(VAMT) END),0),     
  CRTOT=ISNULL((CASE DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTCURBFO.DBO.LEDGER     
  WHERE  VDT < @TODT     
  AND CLTCODE=@CLTCODE    
  GROUP BY DRCR     
 END     
ELSE IF @REPORTPARA='1'    
 BEGIN    
  SELECT DRTOT=ISNULL((CASE DRCR WHEN 'D' THEN SUM(VAMT) END),0),     
  CRTOT=ISNULL((CASE DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTCURBFO.DBO.LEDGER     
  WHERE  EDT < @TODT     
  AND CLTCODE=@CLTCODE    
  GROUP BY DRCR     
 END    
    
    
    
--*** RPT_CLIENTPERIODDRCR ***--    
IF @REPORTPARA='2' AND @SORTBY = 'VDT'     
 BEGIN    
  SELECT DRTOT=ISNULL((CASE DRCR WHEN 'D' THEN SUM(VAMT) END),0),     
  CRTOT=ISNULL((CASE DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTCURBFO.DBO.LEDGER     
  WHERE (VDT >=@FROMDT AND VDT <=@TODT + ' 23:59:59')    
  AND CLTCODE=@CLTCODE    
  GROUP BY DRCR     
 END     
ELSE IF @REPORTPARA='2'   
 BEGIN    
  SELECT DRTOT=ISNULL((CASE DRCR WHEN 'D' THEN SUM(VAMT) END),0),     
  CRTOT=ISNULL((CASE DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTCURBFO.DBO.LEDGER     
  WHERE (EDT >=@FROMDT AND EDT <=@TODT + ' 23:59:59')    
  AND CLTCODE=@CLTCODE    
  GROUP BY DRCR     
 END    
    
    
--*** RPT_CLIENTPERIODDRCRBR ***--    
IF @REPORTPARA='3' AND @SORTBY = 'VDT'     
 BEGIN    
  SELECT DRTOT=ISNULL((CASE L2.DRCR WHEN 'D' THEN SUM(CAMT) END),0),     
  CRTOT=ISNULL((CASE L2.DRCR WHEN 'C' THEN SUM(CAMT) END),0)     
  FROM  ACCOUNTCURBFO.DBO.LEDGER L,  ACCOUNTCURBFO.DBO.LEDGER2 L2,  ACCOUNTCURBFO.DBO.COSTMAST C ,  ACCOUNTCURBFO.DBO.CATEGORY CT    
  WHERE (VDT >=@FROMDT AND VDT <=@TODT + ' 23:59:59')    
  AND L2.CLTCODE=@CLTCODE    
   AND  C.COSTCODE=L2.COSTCODE AND     
  L2.VTYPE=L.VTYP AND    
  L2.VNO=L.VNO AND    
  L2.LNO=L.LNO AND    
  L2.BOOKTYPE=L.BOOKTYPE AND  CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  GROUP BY L2.DRCR     
 END     
ELSE IF @REPORTPARA='3'   
 BEGIN    
  SELECT DRTOT=ISNULL((CASE L2.DRCR WHEN 'D' THEN SUM(CAMT) END),0),     
  CRTOT=ISNULL((CASE L2.DRCR WHEN 'C' THEN SUM(CAMT) END),0)     
  FROM  ACCOUNTCURBFO.DBO.LEDGER L,  ACCOUNTCURBFO.DBO.LEDGER2 L2,  ACCOUNTCURBFO.DBO.COSTMAST C ,  ACCOUNTCURBFO.DBO.CATEGORY CT    
  WHERE (EDT >=@FROMDT AND EDT <=@TODT + ' 23:59:59')    
  AND L2.CLTCODE=@CLTCODE    
   AND  C.COSTCODE=L2.COSTCODE AND     
  L2.VTYPE=L.VTYP AND    
  L2.VNO=L.VNO AND    
  L2.LNO=L.LNO AND    
  L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  GROUP BY L2.DRCR     
 END    
    
    
--- *** RPT_DETAILPERIODLEDGER *** ---    
IF @REPORTPARA='4' AND @SORTBY='VDT'     
 BEGIN    
  SELECT  LEFT(CONVERT(VARCHAR,VDT,103),11), L.VTYP,VNO,LNO,DRCR,    
  DRAMT=ISNULL((CASE DRCR WHEN 'D' THEN VAMT END),0),     
  CRAMT=ISNULL((CASE DRCR WHEN 'C' THEN VAMT END),0), BALAMT,VDESC,    
  NAR=ISNULL(L.NARRATION,''),    
  EDT, EDTDIFF=DATEDIFF(D, L.EDT , GETDATE() ) ,DISPLAYVDT = LEFT(CONVERT(VARCHAR,VDT,109),11) ,BT.DESCRIPTION ,BT.BOOKTYPE    
  FROM ACCOUNTCURBFO.DBO. LEDGER L, ACCOUNTCURBFO.DBO.VMAST V , ACCOUNTCURBFO.DBO. BOOKTYPE BT     
  WHERE  L.VDT >= @FROMDT AND L.VDT<=@TODT + ' 23:59:59'    
  AND CLTCODE = @CLTCODE AND L.VTYP=V.VTYPE     
  AND L.VTYP <> '18'    
  AND L.VTYP = BT.VTYP    
  AND L.BOOKTYPE = BT.BOOKTYPE    
  ORDER BY L.VDT, DRCR,L.VTYP    
 END    
ELSE IF @REPORTPARA='4'    
 BEGIN    
  SELECT LEFT( CONVERT(VARCHAR,EDT,103),11),L.VTYP,VNO,LNO,DRCR,    
  DRAMT=ISNULL((CASE DRCR WHEN 'D' THEN VAMT END),0),     
  CRAMT=ISNULL((CASE DRCR WHEN 'C' THEN VAMT END),0), BALAMT,VDESC,    
  NAR=ISNULL(L.NARRATION,''),    
  EDT, EDTDIFF=DATEDIFF(D, L.EDT , GETDATE() )  ,BT.DESCRIPTION ,BT.BOOKTYPE    
  FROM ACCOUNTCURBFO.DBO. LEDGER L, ACCOUNTCURBFO.DBO.VMAST V , ACCOUNTCURBFO.DBO. BOOKTYPE BT    
  WHERE EDT >= @FROMDT AND EDT<=@TODT + ' 23:59:59'    
  AND CLTCODE=@CLTCODE AND L.VTYP=V.VTYPE     
  AND L.VTYP <> '18'    
  AND L.VTYP = BT.VTYP    
  AND L.BOOKTYPE = BT.BOOKTYPE    
  ORDER BY EDT, DRCR,L.VTYP    
    
END    
    
    
    
--- *** RPT_DETAILPERIODLEDGERBR *** ---    
IF @REPORTPARA='5' AND @SORTBY='VDT'     
 BEGIN    
  SELECT  LEFT(CONVERT(VARCHAR,VDT,103),11), L.VTYP,L.VNO,L.LNO,L.DRCR,    
  DRAMT=ISNULL((CASE L2.DRCR WHEN 'D' THEN CAMT END),0),     
  CRAMT=ISNULL((CASE L2.DRCR WHEN 'C' THEN CAMT END),0), BALAMT,VDESC,    
  NAR=ISNULL((SELECT L3.NARR FROM ACCOUNTCURBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L3.NARATNO=1) ,''),    
  EDT, EDTDIFF=DATEDIFF(D, L.EDT , GETDATE() ) ,DISPLAYVDT = LEFT(CONVERT(VARCHAR,VDT,109),11) ,BT.DESCRIPTION ,BT.BOOKTYPE    
  FROM ACCOUNTCURBFO.DBO.LEDGER L, ACCOUNTCURBFO.DBO.VMAST V , ACCOUNTCURBFO.DBO.BOOKTYPE BT ,ACCOUNTCURBFO.DBO.LEDGER2 L2, ACCOUNTCURBFO.DBO.COSTMAST C , ACCOUNTCURBFO.DBO.CATEGORY CT    
  WHERE  L.VDT >= @FROMDT AND L.VDT<=@TODT + ' 23:59:59'    
  AND L2.CLTCODE = @CLTCODE AND L.VTYP=V.VTYPE     
  AND L.VTYP <> '18'    
  AND L.VTYP = BT.VTYP    
  AND L.BOOKTYPE = BT.BOOKTYPE    
  AND  C.COSTCODE=L2.COSTCODE AND     
  L2.VTYPE=L.VTYP AND    
  L2.VNO=L.VNO AND    
  L2.LNO=L.LNO AND    
  L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  ORDER BY L.VDT, L2.DRCR,L.VTYP    
 END    
ELSE IF @REPORTPARA='5'   
 BEGIN    
  SELECT LEFT( CONVERT(VARCHAR,EDT,103),11),L.VTYP,L.VNO,L.LNO,L.DRCR,    
  DRAMT=ISNULL((CASE L2.DRCR WHEN 'D' THEN CAMT END),0),     
  CRAMT=ISNULL((CASE L2.DRCR WHEN 'C' THEN CAMT END),0), BALAMT,VDESC,    
  NAR=ISNULL((SELECT L3.NARR FROM ACCOUNTCURBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L3.NARATNO=1) ,''),    
  EDT, EDTDIFF=DATEDIFF(D, L.EDT , GETDATE() )  ,BT.DESCRIPTION ,BT.BOOKTYPE    
  FROM ACCOUNTCURBFO.DBO. LEDGER L, ACCOUNTCURBFO.DBO.VMAST V , ACCOUNTCURBFO.DBO. BOOKTYPE BT ,ACCOUNTCURBFO.DBO.LEDGER2 L2, ACCOUNTCURBFO.DBO.COSTMAST C , ACCOUNTCURBFO.DBO.CATEGORY CT    
  WHERE EDT >= @FROMDT AND EDT<=@TODT + ' 23:59:59'    
  AND L2.CLTCODE=@CLTCODE AND L.VTYP=V.VTYPE     
  AND L.VTYP <> '18'    
  AND L.VTYP = BT.VTYP    
  AND L.BOOKTYPE = BT.BOOKTYPE    
  AND  C.COSTCODE=L2.COSTCODE AND     
  L2.VTYPE=L.VTYP AND    
  L2.VNO=L.VNO AND    
  L2.LNO=L.LNO AND    
  L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  ORDER BY EDT, L2.DRCR,L.VTYP    
 END    
    
    
--- *** RPT_OPENBAL *** ---    
IF @REPORTPARA='6' AND @SORTBY='VDT'     
 BEGIN    
  SELECT DRTOTAL=ISNULL((CASE DRCR WHEN 'D' THEN SUM(VAMT) END),0),    
  CRTOTAL=ISNULL((CASE DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTCURBFO.DBO.LEDGER     
  WHERE VDT >= @FROMDT  AND VDT <=  @TODT  AND CLTCODE= @CLTCODE     
  GROUP BY DRCR     
 END     
ELSE IF @REPORTPARA='6'   
 BEGIN    
  SELECT DRTOTAL=ISNULL((CASE DRCR WHEN 'D' THEN SUM(VAMT) END),0),    
  CRTOTAL=ISNULL((CASE DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTCURBFO.DBO.LEDGER     
  WHERE EDT >= @FROMDT  AND EDT <= @TODT AND CLTCODE= @CLTCODE     
  GROUP BY DRCR     
 END     
    
    
--- *** RPT_OPENBALBR *** ---    
IF @REPORTPARA='7' AND @SORTBY='VDT'     
 BEGIN    
  SELECT DRTOTAL=ISNULL((CASE L.DRCR WHEN 'D' THEN SUM(VAMT) END),0),    
  CRTOTAL=ISNULL((CASE L.DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTCURBFO.DBO.LEDGER L, ACCOUNTCURBFO.DBO.LEDGER2 L2, ACCOUNTCURBFO.DBO.COSTMAST C , ACCOUNTCURBFO.DBO.CATEGORY CT     
  WHERE VDT >= @FROMDT  AND VDT <=  @TODT  AND L.CLTCODE= @CLTCODE     
  AND C.COSTCODE=L2.COSTCODE     
  AND L2.VTYPE=L.VTYP    
  AND L2.VNO=L.VNO    
  AND L2.LNO=L.LNO    
  AND L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  GROUP BY L.DRCR     
 END     
ELSE IF @REPORTPARA='7'   
 BEGIN    
  SELECT DRTOTAL=ISNULL((CASE L.DRCR WHEN 'D' THEN SUM(VAMT) END),0),    
  CRTOTAL=ISNULL((CASE L.DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTCURBFO.DBO.LEDGER L, ACCOUNTCURBFO.DBO.LEDGER2 L2, ACCOUNTCURBFO.DBO.COSTMAST C , ACCOUNTCURBFO.DBO.CATEGORY CT     
  WHERE EDT >= @FROMDT  AND EDT <= @TODT AND L.CLTCODE= @CLTCODE     
  AND C.COSTCODE=L2.COSTCODE     
  AND L2.VTYPE=L.VTYP    
  AND L2.VNO=L.VNO    
  AND L2.LNO=L.LNO    
  AND L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  GROUP BY L.DRCR     
 END     
    
    
    
--*** RPT_CLIENTOPENBALBR ***--    
IF @REPORTPARA='8' AND @SORTBY='VDT'     
 BEGIN    
  SELECT DRTOT=ISNULL((CASE L.DRCR WHEN 'D' THEN SUM(VAMT) END),0),     
  CRTOT=ISNULL((CASE L.DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTCURBFO.DBO.LEDGER L, ACCOUNTCURBFO.DBO.LEDGER2 L2, ACCOUNTCURBFO.DBO.COSTMAST C , ACCOUNTCURBFO.DBO.CATEGORY CT      
  WHERE L.VDT < @TODT     
  AND L.CLTCODE=@CLTCODE    
  AND C.COSTCODE=L2.COSTCODE     
  AND L2.VTYPE=L.VTYP    
  AND L2.VNO=L.VNO    
  AND L2.LNO=L.LNO    
  AND L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  GROUP BY L.DRCR     
 END     
ELSE IF @REPORTPARA='8'   
 BEGIN    
  SELECT DRTOT=ISNULL((CASE L.DRCR WHEN 'D' THEN SUM(VAMT) END),0),     
  CRTOT=ISNULL((CASE L.DRCR WHEN 'C' THEN SUM(VAMT) END),0)     
  FROM ACCOUNTCURBFO.DBO.LEDGER L, ACCOUNTCURBFO.DBO.LEDGER2 L2, ACCOUNTCURBFO.DBO.COSTMAST C , ACCOUNTCURBFO.DBO.CATEGORY CT     
  WHERE  L.EDT < @TODT     
  AND L.CLTCODE=@CLTCODE    
  AND C.COSTCODE=L2.COSTCODE     
  AND L2.VTYPE=L.VTYP    
  AND L2.VNO=L.VNO    
  AND L2.LNO=L.LNO    
  AND L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND CT.CATCODE=C.CATCODE    
  AND C.COSTNAME=@STATUSNAME    
  GROUP BY L.DRCR     
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_COMMISSIONREPORT
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_COMMISSIONREPORT]
@TYPE VARCHAR(10),
@FROMDT VARCHAR(15),
@TODT VARCHAR(15),
@FROMCD VARCHAR(10),
@TOCD VARCHAR(10)

AS

IF @TYPE = 'CLIENT'

BEGIN

SELECT F.PARTY_CODE,S.NAME,LEFT(CONVERT(VARCHAR,F.BILLDATE,109),11) AS BILLDATE,F.AMOUNT,
CRDR=(CASE WHEN F.SELL_BUY=1 THEN 'DR' ELSE 'CR' END),S.COM_PERC,
YEAR(BILLDATE),MONTH(BILLDATE),DAY(BILLDATE)
FROM FOACCBILL F,SUBBROKERS S
WHERE F.PARTY_CODE=S.SUB_BROKER AND F.AMOUNT<>0
AND F.BILLDATE >= @FROMDT 
AND F.BILLDATE <= @TODT+' 23:59:59'
AND F.PARTY_CODE >= @FROMCD
AND F.PARTY_CODE <= @TOCD
ORDER BY F.PARTY_CODE,YEAR(BILLDATE),MONTH(BILLDATE),DAY(BILLDATE)


END


IF @TYPE = 'DATE'

BEGIN

SELECT F.PARTY_CODE,S.NAME,LEFT(CONVERT(VARCHAR,F.BILLDATE,109),11) AS BILLDATE,F.AMOUNT,
CRDR=(CASE WHEN F.SELL_BUY=1 THEN 'DR' ELSE 'CR' END),S.COM_PERC,
YEAR(BILLDATE),MONTH(BILLDATE),DAY(BILLDATE)
FROM FOACCBILL F,SUBBROKERS S
WHERE F.PARTY_CODE=S.SUB_BROKER AND F.AMOUNT<>0
AND F.BILLDATE >= @FROMDT 
AND F.BILLDATE <= @TODT+' 23:59:59'
AND F.PARTY_CODE >= @FROMCD
AND F.PARTY_CODE <= @TOCD
ORDER BY YEAR(BILLDATE),MONTH(BILLDATE),DAY(BILLDATE),F.PARTY_CODE


END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CONPATH
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_CONPATH]  
  
@EXCH VARCHAR(3),  
@SEGMENT VARCHAR(20)  
  
AS  
  
SELECT CONPATH FROM ACCOUNTCURBFO.DBO.OWNER WHERE EXCHANGE=@EXCH AND SEGMENT LIKE LTRIM(@SEGMENT)+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CONTRACT_ANNEXTURE
-- --------------------------------------------------
 
CREATE PROC [dbo].[RPT_CONTRACT_ANNEXTURE]  
 (  
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),  
 @FROMDATE VARCHAR(11),  
 @TODATE VARCHAR(11),  
 @FROMBRANCH VARCHAR(15),  
 @TOBRANCH VARCHAR(15),  
 @FROMSUB_BROKER VARCHAR(10),  
 @TOSUB_BROKER VARCHAR(10),  
 @FROMPARTY VARCHAR(15),  
 @TOPARTY VARCHAR(15),  
 @SELECTIONTYPE VARCHAR(2),  
 @FROMFAMILY VARCHAR(15) = '',  
 @TOFAMILY VARCHAR(15) = 'ZZZZZZZZ',  
 @PRINTFLAG VARCHAR(10) = '',  
 @FORPDF VARCHAR(1) = 'N',  
 @FROMCONTRACT VARCHAR(15) ='',  
 @TOCONTRACT VARCHAR(15) = '999999999'  
 )  
  
 AS  
  
 -- EXEC [RPT_CONTRACT_ANNEXTURE] 'BROKER','BROKER','JAN  1 2010','DEC 29 2010','0','ZZZZZZ','0','ZZZZZZZ','0','ZZZZZZZ','I','','ZZZZZZZZZ',''  
  
 SET NOCOUNT ON  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
 IF LEN(@FROMDATE) = 10 AND CHARINDEX('/', @FROMDATE) > 0  
  BEGIN  
   SET @FROMDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @FROMDATE, 103), 109)  
  END  
 IF LEN(@TODATE) = 10 AND CHARINDEX('/', @TODATE) > 0  
  BEGIN  
   SET @TODATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @TODATE, 103), 109)  
  END  
 SELECT  
  PARTY_CODE,  
  C1.BRANCH_CD,  
  CL_TYPE,  
  C1.LONG_NAME,  
  BRANCH = ISNULL(BRANCH,''),  
  SUB_BROKER = ISNULL(SUB_BROKER,''),  
  PARENTCODE,  
  SERVICE_CHRG,  
  PRINTF,  
  L_ADDRESS1 = ISNULL(L_ADDRESS1,''),  
  L_ADDRESS2 = ISNULL(L_ADDRESS2,''),  
  L_ADDRESS3 = ISNULL(L_ADDRESS3,''),  
  L_CITY  = ISNULL(L_ADDRESS3,''),  
  L_ZIP  = ISNULL(L_ZIP,''),  
  PAN_GIR_NO = ISNULL(PAN_GIR_NO,'')  
 INTO  
  #CLIENTMASTER  
 FROM  
  CLIENT1 C1 WITH(NOLOCK)  
   LEFT OUTER JOIN  
   BRANCH ON (BRANCH_CODE = BRANCH_CD),  
  CLIENT2 C2 WITH(NOLOCK),  
  CLIENT_PRINT_SETTINGS CP WITH(NOLOCK)  
 WHERE  
  C1.CL_CODE = C2.CL_CODE  
  AND C2.PARTY_CODE >= @FROMPARTY  
  AND C2.PARTY_CODE <= @TOPARTY  
  AND BRANCH_CD >= @FROMBRANCH  
  AND BRANCH_CD <= @TOBRANCH  
  AND SUB_BROKER >= @FROMSUB_BROKER  
  AND SUB_BROKER <= @TOSUB_BROKER  
  AND C1.FAMILY >= @FROMFAMILY  
  AND C1.FAMILY <= @TOFAMILY  
  AND C2.PRINTF = CP.PRINT_FLAG   
--AND CP.VALID_REPORT LIKE '%'+ @PRINTFLAG +'%'  
  AND @STATUSNAME =  
   (CASE  
    WHEN @STATUSID = 'BRANCH'  
    THEN C1.BRANCH_CD  
    WHEN @STATUSID = 'SUBBROKER'  
    THEN C1.SUB_BROKER  
    WHEN @STATUSID = 'TRADER'  
    THEN C1.TRADER  
    WHEN @STATUSID = 'FAMILY'  
    THEN C1.FAMILY  
    WHEN @STATUSID = 'AREA'  
    THEN C1.AREA  
    WHEN @STATUSID = 'REGION'  
    THEN C1.REGION  
    WHEN @STATUSID = 'CLIENT'  
    THEN C2.PARTY_CODE  
   ELSE 'BROKER' END)  
  
 IF  (@SELECTIONTYPE = 'SN')  
 BEGIN  
  SELECT  
   CONTRACTNO = S.CONTRACTNO,  
   TRADEQTY = SUM(TRADEQTY),  
   ORGPRICE = SUM(TRADEQTY*DUMMY2)/SUM(TRADEQTY),  
   SELL_BUY = (CASE WHEN S.SELL_BUY = 1 THEN 'B' ELSE 'S' END),  
   INST_TYPE,  
   SYMBOL = S.SYMBOL,  
   EXPIRYDATE = LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),  
   STRIKE_PRICE = S.STRIKE_PRICE,  
   OPTION_TYPE = S.OPTION_TYPE,  
   PARTY_CODE = PARENTCODE     
  FROM  
   FOSETTLEMENT S WITH(NOLOCK),  
   #CLIENTMASTER C WITH(NOLOCK)  
  WHERE  
   S.PARTY_CODE = C.PARTY_CODE  
   AND SAUDA_DATE >= @FROMDATE  
   AND SAUDA_DATE <= @TODATE + ' 23:59'  
   AND C.PARTY_CODE >= @FROMPARTY  
   AND C.PARTY_CODE <= @TOPARTY  
   AND S.TRADEQTY > 0  
   AND S.AUCTIONPART <> 'CA'  
   AND RESERVED1 <> 1  
  GROUP BY  
   S.CONTRACTNO,  
   (CASE WHEN S.SELL_BUY = 1 THEN 'B' ELSE 'S' END),  
   INST_TYPE,  
   S.SYMBOL,  
   LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),  
   S.STRIKE_PRICE,  
   S.OPTION_TYPE,  
   PARENTCODE  
  
  /*-------*/  
  UNION  
  /*-------*/  
  
  SELECT  
   CONTRACTNO = S.CONTRACTNO,  
   TRADEQTY = SUM(TRADEQTY),  
   ORGPRICE = SUM(TRADEQTY*DUMMY2)/SUM(TRADEQTY),  
   SELL_BUY = (CASE WHEN S.SELL_BUY = 1 THEN 'B' ELSE 'S' END),  
   INST_TYPE,  
   SYMBOL = S.SYMBOL,  
   EXPIRYDATE = LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),  
   STRIKE_PRICE = S.STRIKE_PRICE,  
   OPTION_TYPE = S.OPTION_TYPE,  
   PARTY_CODE = PARENTCODE     
  FROM  
   PRADNYA.DBO.HISTORY_FOSETTLEMENT_NSEFO S WITH(NOLOCK),  
   #CLIENTMASTER C WITH(NOLOCK)  
  WHERE  
   S.PARTY_CODE = C.PARTY_CODE  
   AND SAUDA_DATE >= @FROMDATE  
   AND SAUDA_DATE <= @TODATE + ' 23:59'  
   AND C.PARTY_CODE >= @FROMPARTY  
   AND C.PARTY_CODE <= @TOPARTY  
   AND S.TRADEQTY > 0  
   AND S.AUCTIONPART <> 'CA'  
   AND RESERVED1 <> 1  
  GROUP BY  
   S.CONTRACTNO,  
   (CASE WHEN S.SELL_BUY = 1 THEN 'B' ELSE 'S' END),  
   INST_TYPE,  
   S.SYMBOL,  
   LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),  
   S.STRIKE_PRICE,  
   S.OPTION_TYPE,  
   PARENTCODE  
  ORDER BY  
   PARENTCODE,  
   CONTRACTNO,  
   SYMBOL,  
   INST_TYPE,  
   EXPIRYDATE,  
   STRIKE_PRICE,  
   OPTION_TYPE,  
   SELL_BUY  
     
 END  
  
 IF  (@SELECTIONTYPE = 'SI')  
 BEGIN  
  SELECT  
   CONTRACTNO = S.CONTRACTNO,  
   TRADEQTY = SUM(TRADEQTY),  
   ORGPRICE = SUM(TRADEQTY*DUMMY2)/SUM(TRADEQTY),  
   SELL_BUY = (CASE WHEN S.SELL_BUY = 1 THEN 'B' ELSE 'S' END),  
   INST_TYPE,  
   SYMBOL = S.SYMBOL,  
   EXPIRYDATE = LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),  
   STRIKE_PRICE = S.STRIKE_PRICE,  
   OPTION_TYPE = S.OPTION_TYPE,  
   PARTY_CODE = PARENTCODE     
  FROM  
   FOSETTLEMENT S WITH(NOLOCK),  
   #CLIENTMASTER C WITH(NOLOCK)  
  WHERE  
   S.PARTY_CODE = C.PARTY_CODE  
   AND SAUDA_DATE >= @FROMDATE  
   AND SAUDA_DATE <= @TODATE + ' 23:59'  
   AND C.PARTY_CODE >= @FROMPARTY  
   AND C.PARTY_CODE <= @TOPARTY  
   AND S.TRADEQTY > 0  
   AND S.AUCTIONPART <> 'CA'  
   AND RESERVED1 = 1  
  GROUP BY  
   S.CONTRACTNO,  
   (CASE WHEN S.SELL_BUY = 1 THEN 'B' ELSE 'S' END),  
   INST_TYPE,  
   S.SYMBOL,  
   LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),  
   S.STRIKE_PRICE,  
   S.OPTION_TYPE,  
   PARENTCODE  
  
  /*-------*/  
  UNION  
  /*-------*/  
  
  SELECT  
   CONTRACTNO = S.CONTRACTNO,  
   TRADEQTY = SUM(TRADEQTY),  
   ORGPRICE = SUM(TRADEQTY*DUMMY2)/SUM(TRADEQTY),  
   SELL_BUY = (CASE WHEN S.SELL_BUY = 1 THEN 'B' ELSE 'S' END),  
   INST_TYPE,  
   SYMBOL = S.SYMBOL,  
   EXPIRYDATE = LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),  
   STRIKE_PRICE = S.STRIKE_PRICE,  
   OPTION_TYPE = S.OPTION_TYPE,  
   PARTY_CODE = PARENTCODE  
  FROM  
   PRADNYA.DBO.HISTORY_FOSETTLEMENT_NSEFO S WITH(NOLOCK),  
   #CLIENTMASTER C WITH(NOLOCK)  
  WHERE  
   S.PARTY_CODE = C.PARTY_CODE  
   AND SAUDA_DATE >= @FROMDATE  
   AND SAUDA_DATE <= @TODATE + ' 23:59'  
   AND C.PARTY_CODE >= @FROMPARTY  
   AND C.PARTY_CODE <= @TOPARTY  
   AND S.TRADEQTY > 0  
   AND S.AUCTIONPART <> 'CA'  
   AND RESERVED1 = 1  
  GROUP BY  
   S.CONTRACTNO,  
   (CASE WHEN S.SELL_BUY = 1 THEN 'B' ELSE 'S' END),  
   INST_TYPE,  
   S.SYMBOL,  
   LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),  
   S.STRIKE_PRICE,  
   S.OPTION_TYPE,  
   PARENTCODE  
  ORDER BY  
   PARENTCODE,  
   CONTRACTNO,  
   SYMBOL,  
   INST_TYPE,  
   EXPIRYDATE,  
   STRIKE_PRICE,  
   OPTION_TYPE,  
   SELL_BUY  
     
 END  
  
  
 CREATE TABLE #CONT_ANNEX  
  (  
  DATEDETAILS  VARCHAR(11),  
  PARTY_CODE  VARCHAR(15),  
  CONTRACTNO  VARCHAR(20),  
  BRANCH_CD  VARCHAR(20),  
  CL_TYPE   VARCHAR(5),  
  MRATE   MONEY,  
  AMOUNT   MONEY,  
  ORGPRICE  MONEY,  
  ORGAMOUNT  MONEY,  
  PARTYNAME  VARCHAR(150),  
  PARTIPANTCODE VARCHAR(20),  
  ORDER_NO  VARCHAR(20),  
  ORDER_TIME  VARCHAR(10),  
  TRADE_NO  VARCHAR(20),  
  TRADE_TIME  VARCHAR(10),  
  TRADEQTY  INT,  
  INST_TYPE  VARCHAR(10),  
  SYMBOL   VARCHAR(15),  
  EXPIRYDATE  VARCHAR(15),  
  STRIKE_PRICE MONEY,  
  OPTION_TYPE  VARCHAR(10),  
  TRADEDATE  VARCHAR(20),  
  BRANCHNAME  VARCHAR(150),  
  SELL_BUY  VARCHAR(5),  
  PARENTCODE  VARCHAR(15),  
  BROKERAGE  MONEY,  
  SERVICE_CHRG INT,  
  L_ADDRESS1  VARCHAR(100),  
  L_ADDRESS2  VARCHAR(100),  
  L_ADDRESS3  VARCHAR(100),  
  L_CITY   VARCHAR(50),  
  L_ZIP   VARCHAR(20),  
  PAN_GIR_NO  VARCHAR(20)  
  )  
  
  
 IF  (@SELECTIONTYPE = 'N')  
 BEGIN  
PRINT 'MFOTEST'
  INSERT INTO #CONT_ANNEX  
  SELECT  
   DATEDETAILS = CONVERT(VARCHAR,SAUDA_DATE,112),  
   PARTY_CODE = S.PARTY_CODE,  
   CONTRACTNO = S.CONTRACTNO,  
   BRANCH_CD = C.BRANCH_CD,  
   CL_TYPE = CL_TYPE,  
   MRATE = PRICE,  
   AMOUNT = TRADEQTY*PRICE,  
   ORGPRICE = DUMMY2,  
   ORGAMOUNT = TRADEQTY*DUMMY2,  
   PARTYNAME = C.LONG_NAME,  
   PARTIPANTCODE = S.PARTICIPANTCODE,  
   ORDER_NO = S.ORDER_NO,  
   ORDER_TIME = (CASE     
       WHEN CPID = 'NIL' OR CPID   = '0'     
       THEN '        '     
       ELSE RIGHT(CPID,8) END),  
   TRADE_NO = S.TRADE_NO,  
   TRADE_TIME = CONVERT(VARCHAR,SAUDA_DATE,108),  
   TRADEQTY = S.TRADEQTY,  
   INST_TYPE,  
   SYMBOL = S.SYMBOL,  
   EXPIRYDATE= LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),  
   STRIKE_PRICE=S.STRIKE_PRICE,  
   OPTION_TYPE=S.OPTION_TYPE,  
   TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),  
   BRANCHNAME = ISNULL(BRANCH,''),  
   SELL_BUY = (CASE WHEN S.SELL_BUY = 1 THEN 'B' ELSE 'S' END),  
   PARENTCODE,  
   BROKERAGE = (BROKAPPLIED*TRADEQTY),  
   SERVICE_CHRG,  
   L_ADDRESS1,  
   L_ADDRESS2,  
   L_ADDRESS3,  
   L_CITY,  
   L_ZIP,  
   PAN_GIR_NO  
  FROM  
   FOSETTLEMENT S WITH(NOLOCK),  
   #CLIENTMASTER C WITH(NOLOCK)  
  WHERE  
   S.PARTY_CODE = C.PARTY_CODE  
   AND SAUDA_DATE >= @FROMDATE  
   AND SAUDA_DATE <= @TODATE + ' 23:59'  
   AND C.PARTY_CODE >= @FROMPARTY  
   AND C.PARTY_CODE <= @TOPARTY  
   AND CONTRACTNO BETWEEN @FROMCONTRACT AND @TOCONTRACT  
   AND S.TRADEQTY > 0  
   AND S.AUCTIONPART <> 'CA'  
   AND RESERVED1 <> 1  

 
  /*-------*/  
  --UNION  
  /*-------*/  
  
  INSERT INTO #CONT_ANNEX  
  SELECT  
   DATEDETAILS = CONVERT(VARCHAR,SAUDA_DATE,112),  
   PARTY_CODE = S.PARTY_CODE,  
   CONTRACTNO = S.CONTRACTNO,  
   BRANCH_CD = C.BRANCH_CD,  
   CL_TYPE= CL_TYPE,  
   MRATE = PRICE,  
   AMOUNT = TRADEQTY*PRICE,  
   ORGPRICE = DUMMY2,  
   ORGAMOUNT = TRADEQTY*DUMMY2,  
   PARTYNAME = C.LONG_NAME,  
   PARTIPANTCODE = S.PARTICIPANTCODE,  
   ORDER_NO= S.ORDER_NO,  
   ORDER_TIME = (CASE     
       WHEN CPID = 'NIL' OR CPID   = '0'     
       THEN '        '     
       ELSE RIGHT(CPID,8) END),  
   TRADE_NO = S.TRADE_NO,  
   TRADE_TIME = CONVERT(VARCHAR,SAUDA_DATE,108),  
   TRADEQTY = S.TRADEQTY,  
   INST_TYPE,  
   SYMBOL   = S.SYMBOL,  
   EXPIRYDATE= LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),  
   STRIKE_PRICE=S.STRIKE_PRICE,  
   OPTION_TYPE=S.OPTION_TYPE,  
   TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),  
   BRANCHNAME = ISNULL(BRANCH,''),  
   SELL_BUY =(CASE WHEN S.SELL_BUY = 1 THEN 'B' ELSE 'S' END),  
   PARENTCODE,  
   BROKERAGE = (BROKAPPLIED*TRADEQTY),  
   SERVICE_CHRG,  
   L_ADDRESS1,  
   L_ADDRESS2,  
   L_ADDRESS3,  
   L_CITY,  
   L_ZIP,  
   PAN_GIR_NO  
  FROM  
   PRADNYA.DBO.HISTORY_FOSETTLEMENT_NSEFO S WITH(NOLOCK),  
   #CLIENTMASTER C WITH(NOLOCK)  
  WHERE  
   S.PARTY_CODE = C.PARTY_CODE  
   AND SAUDA_DATE >= @FROMDATE  
   AND SAUDA_DATE <= @TODATE + ' 23:59'  
   AND C.PARTY_CODE >= @FROMPARTY  
   AND C.PARTY_CODE <= @TOPARTY  
   AND CONTRACTNO BETWEEN @FROMCONTRACT AND @TOCONTRACT  
   AND S.TRADEQTY > 0  
   AND S.AUCTIONPART <> 'CA'  
   AND RESERVED1 <> 1  
  ORDER BY  
   DATEDETAILS,  
   PARENTCODE,  
   PARTY_CODE,  
   CONTRACTNO,  
   SYMBOL,  
   INST_TYPE,  
   EXPIRYDATE,  
   STRIKE_PRICE,  
   OPTION_TYPE,  
   SELL_BUY  
 END  
  
  
 IF  (@SELECTIONTYPE = 'I')  
 BEGIN  
  INSERT INTO #CONT_ANNEX  
  SELECT  
   DATEDETAILS = CONVERT(VARCHAR,SAUDA_DATE,112),  
   PARTY_CODE = S.PARTY_CODE,  
   CONTRACTNO = S.CONTRACTNO,  
   BRANCH_CD=C.BRANCH_CD,  
   CL_TYPE= CL_TYPE,  
   MRATE = PRICE,  
   AMOUNT = TRADEQTY*PRICE,  
   ORGPRICE = DUMMY2,  
   ORGAMOUNT = TRADEQTY*DUMMY2,  
   PARTYNAME = C.LONG_NAME,  
   PARTIPANTCODE = S.PARTICIPANTCODE,  
   ORDER_NO= S.ORDER_NO,  
   ORDER_TIME = (CASE     
       WHEN CPID = 'NIL' OR CPID   = '0'     
       THEN '        '     
       ELSE RIGHT(CPID,8) END),  
   TRADE_NO = S.TRADE_NO,  
   TRADE_TIME = CONVERT(VARCHAR,SAUDA_DATE,108),  
   TRADEQTY = S.TRADEQTY,  
   INST_TYPE,  
   SYMBOL   = S.SYMBOL,  
   EXPIRYDATE= LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),  
   STRIKE_PRICE=S.STRIKE_PRICE,  
   OPTION_TYPE=S.OPTION_TYPE,  
   TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),  
   BRANCHNAME = ISNULL(BRANCH,''),  
   SELL_BUY = (CASE WHEN S.SELL_BUY = 1 THEN 'B' ELSE 'S' END),  
   PARENTCODE,  
   BROKERAGE = (BROKAPPLIED*TRADEQTY),  
   SERVICE_CHRG,  
   L_ADDRESS1,  
   L_ADDRESS2,  
   L_ADDRESS3,  
   L_CITY,  
   L_ZIP,  
   PAN_GIR_NO  
  FROM  
   FOSETTLEMENT S WITH(NOLOCK),  
   #CLIENTMASTER C WITH(NOLOCK)  
  WHERE  
   S.PARTY_CODE = C.PARTY_CODE  
   AND SAUDA_DATE >= @FROMDATE  
   AND SAUDA_DATE <= @TODATE + ' 23:59'  
   AND C.PARTY_CODE >= @FROMPARTY  
   AND C.PARTY_CODE <= @TOPARTY  
   AND CONTRACTNO BETWEEN @FROMCONTRACT AND @TOCONTRACT  
   AND S.TRADEQTY > 0  
   AND S.AUCTIONPART <> 'CA'  
   AND RESERVED1 = 1  
  
  
  /*-------*/  
  --UNION  
  /*-------*/  
  
  
  INSERT INTO #CONT_ANNEX  
  SELECT  
   DATEDETAILS = CONVERT(VARCHAR,SAUDA_DATE,112),  
   PARTY_CODE = S.PARTY_CODE,  
   CONTRACTNO = S.CONTRACTNO,  
   BRANCH_CD=C.BRANCH_CD,  
   CL_TYPE= CL_TYPE,  
   MRATE = PRICE,  
   AMOUNT = TRADEQTY*PRICE,  
   ORGPRICE = DUMMY2,  
   ORGAMOUNT = TRADEQTY*DUMMY2,  
   PARTYNAME = C.LONG_NAME,  
   PARTIPANTCODE = S.PARTICIPANTCODE,  
   ORDER_NO= S.ORDER_NO,  
   ORDER_TIME = (CASE     
       WHEN CPID = 'NIL' OR CPID   = '0'     
       THEN '        '     
       ELSE RIGHT(CPID,8) END),  
   TRADE_NO = S.TRADE_NO,  
   TRADE_TIME = CONVERT(VARCHAR,SAUDA_DATE,108),  
   TRADEQTY = S.TRADEQTY,  
   INST_TYPE,  
   SYMBOL   = S.SYMBOL,  
   EXPIRYDATE= LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11),  
   STRIKE_PRICE=S.STRIKE_PRICE,  
   OPTION_TYPE=S.OPTION_TYPE,  
   TRADEDATE = CONVERT(VARCHAR,SAUDA_DATE,103),  
   BRANCHNAME = ISNULL(BRANCH,''),  
   SELL_BUY = (CASE WHEN S.SELL_BUY = 1 THEN 'B' ELSE 'S' END),  
   PARENTCODE,  
   BROKERAGE = (BROKAPPLIED*TRADEQTY),  
   SERVICE_CHRG,  
   L_ADDRESS1,  
   L_ADDRESS2,  
   L_ADDRESS3,  
   L_CITY,  
   L_ZIP,  
   PAN_GIR_NO  
  FROM  
   PRADNYA.DBO.HISTORY_FOSETTLEMENT_NSEFO S WITH(NOLOCK),  
   #CLIENTMASTER C WITH(NOLOCK)  
  WHERE  
   S.PARTY_CODE = C.PARTY_CODE  
   AND SAUDA_DATE >= @FROMDATE  
   AND SAUDA_DATE <= @TODATE + ' 23:59'  
   AND C.PARTY_CODE >= @FROMPARTY  
   AND C.PARTY_CODE <= @TOPARTY  
   AND CONTRACTNO BETWEEN @FROMCONTRACT AND @TOCONTRACT  
   AND S.TRADEQTY > 0  
   AND S.AUCTIONPART <> 'CA'  
   AND RESERVED1 = 1  
  ORDER BY  
   DATEDETAILS,  
   PARENTCODE,  
   PARTY_CODE,  
   CONTRACTNO,  
   SYMBOL,  
   INST_TYPE,  
   EXPIRYDATE,  
   STRIKE_PRICE,  
   OPTION_TYPE,  
   SELL_BUY  
 END  
  
 /*  
 SELECT * INTO #CHARGES_DETAIL FROM CHARGES_DETAIL  
 WHERE  
  CD_SAUDA_DATE >= @FROMDATE  
  AND CD_SAUDA_DATE <= @TODATE + ' 23:59'  
  AND CD_PARTY_CODE >= @FROMPARTY  
  AND CD_PARTY_CODE <= @TOPARTY  
  
 UPDATE   
  #CHARGES_DETAIL  
 SET  
  CD_CONTRACT_NO = C1.CONTRACTNO  
 FROM   
  #CONT_ANNEX C1 (NOLOCK)  
 WHERE  
  C1.PARTY_CODE = CD_PARTY_CODE  
  AND C1.DATEDETAILS = CONVERT(VARCHAR,CD_SAUDA_DATE,112)  
  AND CD_INST_TYPE = INST_TYPE      
  AND CD_SYMBOL = SYMBOL        
  AND LEFT(CONVERT(VARCHAR,CD_EXPIRY_DATE,109),11) = EXPIRYDATE  
  AND CD_OPTION_TYPE = OPTION_TYPE        
  AND CD_STRIKE_PRICE = STRIKE_PRICE        
  AND C1.SELL_BUY = (CASE WHEN (CD_TOT_BUYBROK) > 0 THEN 'B' ELSE 'S' END )  
  AND C1.ORDER_NO = (CASE WHEN CD_ORDER_NO <> '' THEN CD_ORDER_NO ELSE C1.ORDER_NO END)  
  AND (CD_CONTRACT_NO = 0 OR CD_CONTRACT_NO = '')  
  
  
 UPDATE         
  #CONT_ANNEX        
 SET        
  BROKERAGE = (CASE WHEN SELL_BUY = 'B'   
      THEN CD_TOT_BUYBROK   
      ELSE CD_TOT_SELLBROK   
     END)  
     + (CASE WHEN CM.SERVICE_CHRG = 1 THEN   
       CASE WHEN SELL_BUY = 'B'   
        THEN CD_TOT_BUYSERTAX   
        ELSE CD_TOT_SELLSERTAX   
        END  
      ELSE 0 END)  
 FROM  
  #CHARGES_DETAIL C,   
  #CLIENTMASTER CM  
 WHERE        
  CM.PARTY_CODE = CD_PARTY_CODE  
  AND #CONT_ANNEX.PARTY_CODE = CD_PARTY_CODE  
  AND #CONT_ANNEX.DATEDETAILS = CONVERT(VARCHAR,CD_SAUDA_DATE,112)  
  AND CD_INST_TYPE = #CONT_ANNEX.INST_TYPE      
  AND CD_SYMBOL = #CONT_ANNEX.SYMBOL        
  AND LEFT(CONVERT(VARCHAR,CD_EXPIRY_DATE,109),11) = #CONT_ANNEX.EXPIRYDATE  
  AND CD_OPTION_TYPE = #CONT_ANNEX.OPTION_TYPE        
  AND CD_STRIKE_PRICE = #CONT_ANNEX.STRIKE_PRICE        
  AND CD_TRADE_NO = #CONT_ANNEX.TRADE_NO        
  AND CD_ORDER_NO = #CONT_ANNEX.ORDER_NO        
  
  
 IF (SELECT COUNT(1) FROM #CONT_ANNEX) > 0   
 BEGIN  
  INSERT INTO #CONT_ANNEX  
  SELECT  
   DATEDETAILS = CONVERT(VARCHAR,CD_SAUDA_DATE,112),  
   PARTY_CODE = S.CD_PARTY_CODE,  
   CONTRACTNO = S.CD_CONTRACT_NO,  
   BRANCH_CD = '',  
   CL_TYPE = '',  
   MRATE = 0,  
   AMOUNT = 0,  
   ORGPRICE = 0,  
   ORGAMOUNT = 0,  
   PARTYNAME = C.LONG_NAME,  
   PARTIPANTCODE = '',  
   ORDER_NO= S.CD_ORDER_NO,  
   TRADE_NO= S.CD_TRADE_NO,  
   TRADEQTY = 0,  
   INST_TYPE = S.CD_INST_TYPE,  
   SYMBOL   = S.CD_SYMBOL,  
   EXPIRYDATE= LEFT(CONVERT(VARCHAR,CD_EXPIRY_DATE,109),11),  
   STRIKE_PRICE=S.CD_STRIKE_PRICE,  
   OPTION_TYPE=S.CD_OPTION_TYPE,  
   TRADEDATE = CONVERT(VARCHAR,CD_SAUDA_DATE,103) +' '+ CONVERT(VARCHAR,CD_SAUDA_DATE,108),  
   BRANCHNAME = ISNULL(BRANCH,''),  
   SELL_BUY = (CASE WHEN CD_TOT_BUYBROK > 0 THEN 'B' ELSE 'S' END),  
   PARENTCODE,  
   BROKERAGE = (CASE WHEN CD_TOT_BUYBROK > 0   
       THEN CD_TOT_BUYBROK   
       ELSE CD_TOT_SELLBROK   
      END)  
      + (CASE WHEN SERVICE_CHRG = 1 THEN   
       CASE WHEN CD_TOT_BUYBROK > 0  
        THEN CD_TOT_BUYSERTAX   
        ELSE CD_TOT_SELLSERTAX   
        END  
      ELSE 0 END),  
   C.SERVICE_CHRG  
  FROM  
   #CHARGES_DETAIL S WITH(NOLOCK),  
   #CLIENTMASTER C WITH(NOLOCK)  
  WHERE  
   S.CD_PARTY_CODE = C.PARTY_CODE  
   AND CD_SAUDA_DATE >= @FROMDATE  
   AND CD_SAUDA_DATE <= @TODATE + ' 23:59'  
   AND CD_TRADE_NO = ''  
   AND (CD_TOT_BUYBROK + CD_TOT_SELLBROK) > 0  
 END  
 */  
  
 SELECT  
  DATEDETAILS,  
  PARTY_CODE,  
  CONTRACTNO,  
  BRANCH_CD,  
  CL_TYPE,  
  MRATE,  
  AMOUNT,  
  ORGPRICE,  
  ORGAMOUNT,  
  PARTYNAME,  
  PARTIPANTCODE,  
  ORDER_NO,  
  ORDER_TIME,  
  TRADE_NO,  
  TRADE_TIME,  
  INST_TYPE,  
  SYMBOL,  
  EXPIRYDATE,  
  STRIKE_PRICE,  
  OPTION_TYPE,  
  SCRIPNAME = (CASE         
      WHEN INST_TYPE LIKE 'FUT%'         
      THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11)             
      ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18,0)) AS VARCHAR)) + ' ' + RTRIM(OPTION_TYPE)            
     END),  
  TRADEQTY,  
  TRADEDATE,  
  BRANCHNAME,  
  SELL_BUY,  
  PARENTCODE,  
  BROKERAGE,  
  L_ADDRESS1,  
  L_ADDRESS2,  
  L_ADDRESS3,  
  L_CITY,  
  L_ZIP,  
  PAN_GIR_NO  
 FROM  
  #CONT_ANNEX  
 ORDER BY  
  DATEDETAILS,  
  CASE WHEN @FORPDF = 'N' THEN PARENTCODE ELSE PARTY_CODE END,  
  CASE WHEN @FORPDF = 'N' THEN PARTY_CODE ELSE PARENTCODE END,  
  CONTRACTNO,  
  SYMBOL,  
  INST_TYPE,  
  EXPIRYDATE,  
  STRIKE_PRICE,  
  OPTION_TYPE,  
  SELL_BUY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_CONTRACT_SUMMARY
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_CONTRACT_SUMMARY] (@DATEFROM VARCHAR(11),@DATETO VARCHAR(11),  @STATUSID VARCHAR(15),@STATUSNAME VARCHAR(25)) AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED 

SELECT 
    TRANSDATE = CONVERT(VARCHAR,SAUDA_DATE,103), 
    CONTRACTNO, 
    CLIENTCODE = S.PARTY_CODE, 
    CLIENTNAME = C1.LONG_NAME, 
    PURC_AMOUNT = SUM(
    CASE 
        WHEN SELL_BUY = 1 
        THEN NETRATE*TRADEQTY 
        ELSE 0 
    END
    )+SUM(
    CASE 
        WHEN C2.SERVICE_CHRG = 2 
        THEN 0 
        ELSE SERVICE_TAX 
    END
    ), 
    SALE_AMOUNT = SUM(
    CASE 
        WHEN SELL_BUY = 2 
        THEN NETRATE*TRADEQTY 
        ELSE 0 
    END
    )-SUM(
    CASE 
        WHEN C2.SERVICE_CHRG = 2 
        THEN 0 
        ELSE SERVICE_TAX 
    END
    ), 
    BROKERAGE = SUM(BROKAPPLIED*TRADEQTY), 
    STAMPDUTY = SUM(
    CASE 
        WHEN BROKERNOTE = 1 
        THEN BROKER_CHRG 
        ELSE 0 
    END
    ), 
    STT = SUM(
    CASE 
        WHEN INSURANCE_CHRG = 1 
        THEN INS_CHRG 
        ELSE 0 
    END
    ), 
    NETAMOUNT = (SUM(
    CASE 
        WHEN SELL_BUY = 1 
        THEN NETRATE*TRADEQTY 
        ELSE 0 
    END
    )+SUM(
    CASE 
        WHEN C2.SERVICE_CHRG = 2 
        THEN 0 
        ELSE SERVICE_TAX 
    END
    ) - SUM(
    CASE 
        WHEN SELL_BUY = 2 
        THEN NETRATE*TRADEQTY 
        ELSE 0 
    END
    )-SUM(
    CASE 
        WHEN C2.SERVICE_CHRG = 2 
        THEN 0 
        ELSE SERVICE_TAX 
    END
    )) + SUM(
    CASE 
        WHEN BROKERNOTE = 1 
        THEN BROKER_CHRG 
        ELSE 0 
    END
    ) + SUM(
    CASE 
        WHEN INSURANCE_CHRG = 1 
        THEN INS_CHRG 
        ELSE 0 
    END
    ) ,
MM=MONTH(SAUDA_DATE),YY=YEAR(SAUDA_DATE),DD=DAY(SAUDA_DATE)
FROM FOSETTLEMENT S WITH(NOLOCK),
    CLIENT1 C1 WITH(NOLOCK),
    CLIENT2 C2 WITH(NOLOCK) 
WHERE C2.PARTY_CODE = S.PARTY_CODE 
        AND C1.CL_CODE = C2.CL_CODE 
        AND SAUDA_DATE BETWEEN @DATEFROM AND @DATETO +' 23:59'
        AND @STATUSNAME = 
          (CASE 
                WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD
                WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER
                WHEN @STATUSID = 'TRADER' THEN C1.TRADER
                WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY
                WHEN @STATUSID = 'AREA' THEN C1.AREA
                WHEN @STATUSID = 'REGION' THEN C1.REGION
                WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE
          ELSE 
                'BROKER'
          END)
GROUP BY CONVERT(VARCHAR,SAUDA_DATE,103),
    MONTH(SAUDA_DATE),
    YEAR(SAUDA_DATE),
    DAY(SAUDA_DATE),
    CONTRACTNO,
    S.PARTY_CODE,
    C1.LONG_NAME 
ORDER BY 
    YY,MM,DD,
    CONTRACTNO,
    S.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_DAILYMARGINSTATEMENT
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_DAILYMARGINSTATEMENT]
	(    
	@MDATE VARCHAR(11),    
	@FROMPARTY VARCHAR(15),    
	@TOPARTY VARCHAR(15),    
	@FROMBRANCH VARCHAR(15)		= '',
	@TOBRANCH VARCHAR(15)		= 'ZZZZZZZZ',
	@FROMSUBBROKER VARCHAR(15)	= '',
	@TOSUBBROKER VARCHAR(15)	= 'ZZZZZZZZ',
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@WITHCOLL INT = 0,
	@DCNFLAG INT = 0
	)    
	
	AS    

	--EXEC RPT_DAILYMARGINSTATEMENT 'FEB  2 2009', '','ZZZZZZZZZZ','','ZZZZZZZZZ','','ZZZZZZZZZ','BROKER','BROKER'

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
	
	SELECT DISTINCT PARTY_CODE 
	INTO #MCLIENT
	FROM TBL_CLIENTMARGIN
	WHERE MARGINDATE BETWEEN @MDATE AND @MDATE + ' 23:59:59'
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY

	SELECT 
		PARTY_CODE = CL_CODE,
		PARTYNAME = LONG_NAME,
		L_ADDRESS1,
		L_ADDRESS2,
		L_ADDRESS3,
		L_CITY,
		L_ZIP,
		L_STATE,
		L_NATION,
		RES_PHONE = RES_PHONE1 + RES_PHONE2,
		OFF_PHONE = OFF_PHONE1 + OFF_PHONE2,
		EMAIL,
		PAN_GIR_NO,
		BRANCH_CD,
		SUB_BROKER,
		EXCHANGE = (SELECT TOP 1 EXCHANGE FROM FOGLOBALS (NOLOCK)),
		SEGMENT	 = 'FUTURES'
	INTO
		#CLIENTMASTER
	FROM
		CLIENT1 C1 (NOLOCK)
	WHERE
		CL_CODE BETWEEN @FROMPARTY AND @TOPARTY
		AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH
		AND SUB_BROKER BETWEEN @FROMSUBBROKER AND @TOSUBBROKER
		AND EXISTS (SELECT PARTY_CODE FROM #MCLIENT WHERE PARTY_CODE = CL_CODE)
		AND @STATUSNAME = (
		CASE   
			WHEN @STATUSID = 'BRANCH'   
			THEN C1.BRANCH_CD   
			WHEN @STATUSID = 'SUBBROKER'   
			THEN C1.SUB_BROKER   
			WHEN @STATUSID = 'TRADER'   
			THEN C1.TRADER   
			WHEN @STATUSID = 'FAMILY'   
			THEN C1.FAMILY   
			WHEN @STATUSID = 'AREA'   
			THEN C1.AREA   
			WHEN @STATUSID = 'REGION'   
			THEN C1.REGION   
			WHEN @STATUSID = 'CLIENT'   
			THEN CL_CODE   
			ELSE 'BROKER' 
		END)   	

	CREATE TABLE #MARGIN_DETAIL
		(
		PARTY_CODE			VARCHAR(15),
		MARGINDATE			DATETIME,
		LED_MARGIN_AMT		MONEY,
		NONCASH_AMT			MONEY,
		BGFD_AMT			MONEY,
		OTHER_MARGIN		MONEY,
		TOTAL_MARGIN_AVL	MONEY,
		INITIALMARGIN		MONEY,
		EXPOSURE_MARGIN		MONEY,
		TOTAL_MARGIN		MONEY,
		EXCESS_SHORTFALL	MONEY,
		ADD_MARGIN			MONEY,
		MARGIN_STATUS		MONEY,
		)


	INSERT INTO #MARGIN_DETAIL
	SELECT 
		PARTY_CODE		= T.PARTY_CODE,
		MARGINDATE		= LEFT(MARGINDATE,11),
		LED_MARGIN_AMT	= SUM(LEDGERAMOUNT),
		NONCASH_AMT		= SUM(NONCASH_COLL),
		BGFD_AMT		= 0,
		OTHER_MARGIN	= 0,
		TOTAL_MARGIN_AVL= 0,
		INITIALMARGIN	= SUM(INITIALMARGIN),
		EXPOSURE_MARGIN	= SUM(MTMMARGIN),
		TOTAL_MARGIN	= 0,
		EXCESS_SHORTFALL= 0,
		ADD_MARGIN		= SUM(ADDMARGIN),
		MARGIN_STATUS	= 0
	FROM
		TBL_CLIENTMARGIN T (NOLOCK),
		#CLIENTMASTER	 C (NOLOCK)
	WHERE 
		MARGINDATE BETWEEN @MDATE AND @MDATE + ' 23:59:59'
		AND T.PARTY_CODE = C.PARTY_CODE
	GROUP BY
		T.PARTY_CODE,
		LEFT(MARGINDATE,11)

	
	UPDATE 
		#MARGIN_DETAIL
	SET
		LED_MARGIN_AMT	= (LED_MARGIN_AMT + MARGIN),
		BGFD_AMT		= (FD + BG)
	FROM
		(
		SELECT 
			PARTY_CODE,
			MARGIN	= SUM(
					CASE 
						WHEN COLL_TYPE = 'MARGIN' THEN FINALAMOUNT
						ELSE 0
					END),
			FD		= SUM(
					CASE 
						WHEN COLL_TYPE = 'FD' THEN FINALAMOUNT
						ELSE 0
					END),
			BG		= SUM(
					CASE 
						WHEN COLL_TYPE = 'BG' THEN FINALAMOUNT
						ELSE 0
					END)
		FROM 
			MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK)
		WHERE 
			EXISTS (SELECT DISTINCT PARTY_CODE FROM #CLIENTMASTER WHERE #CLIENTMASTER.PARTY_CODE = C.PARTY_CODE)
			AND EFFDATE BETWEEN @MDATE AND @MDATE + ' 23:59:59'
			AND C.EXCHANGE = (SELECT TOP 1 EXCHANGE FROM FOGLOBALS (NOLOCK))
			AND C.SEGMENT = 'FUTURES'
		GROUP BY
			PARTY_CODE
		) COLL
	WHERE
		#MARGIN_DETAIL.PARTY_CODE = COLL.PARTY_CODE


	SELECT 
		PARTY_CODE		= M.PARTY_CODE,
		MARGINDATE		= CONVERT(VARCHAR,MARGINDATE,103),
		EXCHANGE,
		SEGMENT			= 'F&O',
		LED_MARGIN_AMT	= SUM(LED_MARGIN_AMT),
		NONCASH_AMT		= SUM(NONCASH_AMT),
		BGFD_AMT		= SUM(BGFD_AMT),
		OTHER_MARGIN	= 0,
		TOTAL_MARGIN_AVL= SUM(LED_MARGIN_AMT + NONCASH_AMT + BGFD_AMT),
		INITIALMARGIN	= SUM(INITIALMARGIN),
		EXPOSURE_MARGIN	= SUM(EXPOSURE_MARGIN),
		TOTAL_MARGIN	= SUM(INITIALMARGIN + EXPOSURE_MARGIN),
		EXCESS_SHORTFALL= (SUM(LED_MARGIN_AMT + NONCASH_AMT + BGFD_AMT) - SUM(INITIALMARGIN + EXPOSURE_MARGIN)),
		ADD_MARGIN		= SUM(ADD_MARGIN),
		MARGIN_STATUS	= (SUM(LED_MARGIN_AMT + NONCASH_AMT + BGFD_AMT) - SUM(INITIALMARGIN + EXPOSURE_MARGIN)) - SUM(ADD_MARGIN),
		PARTYNAME,
		L_ADDRESS1,
		L_ADDRESS2,
		L_ADDRESS3,
		L_CITY,
		L_ZIP,
		L_STATE,
		L_NATION,
		RES_PHONE,
		OFF_PHONE,
		EMAIL,
		PAN_GIR_NO,
		BRANCH_CD,
		SUB_BROKER,
		RPT_ORD	= '1DET',
		SCRIP_CD= CONVERT(VARCHAR(20),''),
		QTY	= CONVERT(NUMERIC(18,4),0),
		SEC_AMOUNT = CONVERT(NUMERIC(18,4),0),
		BGNO = CONVERT(VARCHAR(20),''),
		BG_AMOUNT = CONVERT(NUMERIC(18,4),0),
		BG_EXPIRYDATE = CONVERT(VARCHAR(11),''),
		FDRNO = CONVERT(VARCHAR(20),''),
		FDR_AMOUNT = CONVERT(NUMERIC(18,4),0),
		FDR_EXPIRYDATE = CONVERT(VARCHAR(11),'')
	INTO
		#FINAL_REPORT
	FROM 
		#MARGIN_DETAIL M (NOLOCK),
		#CLIENTMASTER  C (NOLOCK)
	WHERE
		M.PARTY_CODE = C.PARTY_CODE
	GROUP BY
		M.PARTY_CODE,
		CONVERT(VARCHAR,MARGINDATE,103),
		EXCHANGE,
		SEGMENT,
		PARTYNAME,
		L_ADDRESS1,
		L_ADDRESS2,
		L_ADDRESS3,
		L_CITY,
		L_ZIP,
		L_STATE,
		L_NATION,
		RES_PHONE,
		OFF_PHONE,
		EMAIL,
		PAN_GIR_NO,
		BRANCH_CD,
		SUB_BROKER
	/*HAVING 
		SUM(INITIALMARGIN + EXPOSURE_MARGIN) <> 0*/
	ORDER BY
		PARTY_CODE


	IF (@WITHCOLL = 1)
	BEGIN
		SELECT 
			PARTY_CODE,
			MARGINDATE,
			SCRIP_CD,
			QTY	= SUM(QTY),
			SEC_AMOUNT = SUM(SEC_AMOUNT),
			BGNO,
			BG_AMOUNT = SUM(BG_AMOUNT),
			BG_EXPIRYDATE,
			FDRNO,
			FDR_AMOUNT = SUM(FDR_AMOUNT),
			FDR_EXPIRYDATE,
			COLL_TYPE = '2' + UPPER(COLL_TYPE)
		INTO
			#COLL_DETAIL
		FROM
			(
			SELECT 
				PARTY_CODE,
				MARGINDATE = CONVERT(VARCHAR,EFFDATE,103),
				SCRIP_CD =(
				CASE 
					WHEN COLL_TYPE = 'SEC' 
					THEN SCRIP_CD ELSE '' 
				END),
				QTY	=(
				CASE 
					WHEN COLL_TYPE = 'SEC' 
					THEN QTY ELSE 0 
				END),
				SEC_AMOUNT =(
				CASE 
					WHEN COLL_TYPE = 'SEC' 
					THEN FINALAMOUNT ELSE 0 
				END),
				BGNO =(
				CASE 
					WHEN COLL_TYPE = 'BG' 
					THEN FD_BG_NO ELSE '' 
				END),
				BG_AMOUNT =(
				CASE 
					WHEN COLL_TYPE = 'BG' 
					THEN FINALAMOUNT ELSE 0 
				END),
				BG_EXPIRYDATE = (
				CASE 
					WHEN COLL_TYPE = 'BG' 
					THEN CONVERT(VARCHAR,MATURITY_DATE,103) ELSE '' 
				END),
				FDRNO =(
				CASE 
					WHEN COLL_TYPE = 'FD' 
					THEN FD_BG_NO ELSE '' 
				END),
				FDR_AMOUNT =(
				CASE 
					WHEN COLL_TYPE = 'FD' 
					THEN FINALAMOUNT ELSE 0 
				END),
				FDR_EXPIRYDATE = (
				CASE 
					WHEN COLL_TYPE = 'FD' 
					THEN CONVERT(VARCHAR,MATURITY_DATE,103) ELSE '' 
				END),
				COLL_TYPE
			FROM 
				MSAJAG.DBO.COLLATERALDETAILS C (NOLOCK)
			WHERE
				EXISTS (SELECT DISTINCT PARTY_CODE FROM #CLIENTMASTER WHERE #CLIENTMASTER.PARTY_CODE = C.PARTY_CODE)
				AND EFFDATE BETWEEN @MDATE AND @MDATE + ' 23:59:59'
				AND C.EXCHANGE = (SELECT TOP 1 EXCHANGE FROM FOGLOBALS (NOLOCK))
				AND C.SEGMENT = 'FUTURES'
			) COLL
		GROUP BY
			PARTY_CODE,
			MARGINDATE,
			SCRIP_CD,
			BGNO,
			BG_EXPIRYDATE,
			FDRNO,
			FDR_EXPIRYDATE,
			UPPER(COLL_TYPE)

		INSERT INTO #FINAL_REPORT
		SELECT
			PARTY_CODE		= M.PARTY_CODE,
			MARGINDATE,
			EXCHANGE,
			SEGMENT			= 'F&O',
			LED_MARGIN_AMT	= 0,
			NONCASH_AMT		= 0,
			BGFD_AMT		= 0,
			OTHER_MARGIN	= 0,
			TOTAL_MARGIN_AVL= 0,
			INITIALMARGIN	= 0,
			EXPOSURE_MARGIN	= 0,
			TOTAL_MARGIN	= 0,
			EXCESS_SHORTFALL= 0,
			ADD_MARGIN		= 0,
			MARGIN_STATUS	= 0,
			PARTYNAME,
			L_ADDRESS1,
			L_ADDRESS2,
			L_ADDRESS3,
			L_CITY,
			L_ZIP,
			L_STATE,
			L_NATION,
			RES_PHONE,
			OFF_PHONE,
			EMAIL,
			PAN_GIR_NO,
			BRANCH_CD,
			SUB_BROKER,
			RPT_ORD	= UPPER(COLL_TYPE),
			SCRIP_CD,
			QTY,
			SEC_AMOUNT,
			BGNO,
			BG_AMOUNT,
			BG_EXPIRYDATE,
			FDRNO,
			FDR_AMOUNT,
			FDR_EXPIRYDATE
		FROM
			#COLL_DETAIL   M (NOLOCK),
			#CLIENTMASTER  C (NOLOCK)
		WHERE
			M.PARTY_CODE = C.PARTY_CODE
			AND M.PARTY_CODE IN (SELECT DISTINCT PARTY_CODE FROM #FINAL_REPORT)
			AND EXISTS (SELECT DISTINCT PARTY_CODE FROM #FINAL_REPORT WHERE #FINAL_REPORT.PARTY_CODE = M.PARTY_CODE)
	END

	SELECT * FROM #FINAL_REPORT
	ORDER BY PARTY_CODE,RPT_ORD 	

	DROP TABLE #MARGIN_DETAIL
	DROP TABLE #MCLIENT
	DROP TABLE #CLIENTMASTER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_EDOPROCESS
-- --------------------------------------------------
CREATE     PROCEDURE [dbo].[RPT_EDOPROCESS]
	@FROMDATE AS VARCHAR(11),
	@TODATE AS VARCHAR(11),
	@RPTTYPE VARCHAR(10)
	AS
SET @FROMDATE = CONVERT(VARCHAR,@FROMDATE,109)             
SET @TODATE   = CONVERT(VARCHAR,@TODATE,109)   
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF (@RPTTYPE = 'SUMMARY')
BEGIN
	SELECT
		BUSINESS_DATE ,
		IMPORT_TRADE,
		VBB ,
		STT ,
		BILLING,
		CONTRACT,
		POSTING,
		POSITIONFILE,
		MARGINFILE, 
		MARGINRETURNFILE,
		CLIENTMARGINPOP,
		EXCHANGESTT,
		EXERCISEALLOCATION,
		OPEN_CLOSE,
		PROCESSDATE,
		PROCESSBY,
		LASTUPDATEDATE,
		LASTUPDATEBY, 
		MACHINEIP
	
	FROM
		V2_BUSINESS_PROCESS(NOLOCK)
	WHERE
	 PROCESSDATE >= @FROMDATE   
   	 AND   PROCESSDATE <= @TODATE + ' 23:59:59'     
 END
ELSE

IF (@RPTTYPE = 'DETAIL')
BEGIN
	SELECT
		SNO,
		EXCHANGE ,
		SEGMENT,
		BUSINESSDATE,
		PROCESSID,
		PROCESSNAME,
		FILENAME,
		START_END_FLAG,
		PROCESSDATE,
		PROCESSBY,
		MACHINEIP
	FROM
		V2_PROCESS_STATUS_LOG(NOLOCK)
	WHERE
	 PROCESSDATE >= @FROMDATE   
   	 AND   PROCESSDATE <= @TODATE + ' 23:59:59'  

 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_ERRORLOG
-- --------------------------------------------------
CREATE  PROCEDURE  [dbo].[RPT_ERRORLOG]          
@FROMDATE AS VARCHAR(11),
@TODATE AS VARCHAR(11)


AS    
SET @FROMDATE = CONVERT(VARCHAR,@FROMDATE,109)             
SET @TODATE = CONVERT(VARCHAR,@TODATE,109)     
          
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
  
SELECT   
	CNAME,
	MNAME,
	SNAME,
	ERRSTR,   
	ERRDATE = CONVERT(VARCHAR,ERRDATE,109) 
	    
FROM ERRORLOG(NOLOCK)  

WHERE  
	ERRDATE >= @FROMDATE  
   	AND ERRDATE <= @TODATE + ' 23:59:59'  
ORDER BY ERRDATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FAMILY
-- --------------------------------------------------
/* FAMILYWISE LEDGER */  
/* FINDS FAMILIES FROM CLIENT1 */  
CREATE PROCEDURE [dbo].[RPT_FAMILY]
@STATUSID VARCHAR(15),   
@STATUSNAME  VARCHAR(25)  
AS  
IF @STATUSID = 'BROKER'  
	BEGIN  
		SELECT DISTINCT FAMILY FROM CLIENT1  
		ORDER BY FAMILY  
	END  
IF @STATUSID = 'FAMILY'  
	BEGIN  
		SELECT DISTINCT FAMILY FROM CLIENT1  
		WHERE FAMILY = @STATUSNAME  
		ORDER BY FAMILY  
	END  
IF @STATUSID = 'BRANCH'
	BEGIN
		SELECT DISTINCT FAMILY FROM CLIENT1
		WHERE BRANCH_CD = @STATUSNAME
		ORDER BY FAMILY
	END
IF @STATUSID = 'SUBBROKER'
	BEGIN
		SELECT DISTINCT FAMILY FROM CLIENT1
		WHERE SUB_BROKER = @STATUSNAME
		ORDER BY FAMILY
	END
IF @STATUSID = 'TRADER'
	BEGIN
		SELECT DISTINCT FAMILY FROM CLIENT1
		WHERE TRADER = @STATUSNAME
		ORDER BY FAMILY
	END
ELSE
	BEGIN
		SELECT FAMILY FROM CLIENT1
		WHERE 1 = 0
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOBILLDETAILS
-- --------------------------------------------------
/*  
DROP PROCEDURE RPT_FOBILLDETAILS  
*/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOBILLDETAILS    SCRIPT DATE: 11/29/2001 1:51:56 PM ******/  
/*  
USED IN      : NSE FO  
REPORT NAME  : BILL REPORT  
FILE NAME    : BILL DETAILS  
TABLES USED  : FOSETTLEMENT, CLIENT1, CLIENT2  
FUNCTION     : RETURNS THE PERSONAL DETAILS OF THE CLIENT  
WRITTEN BY   : AMOLIKA PATIL   
*/  
CREATE PROCEDURE [dbo].[RPT_FOBILLDETAILS]  
@CODE VARCHAR(10)  
AS  
SELECT  C1.L_ADDRESS1,  
C1.L_ADDRESS2,C1.L_ADDRESS3, C1.L_CITY,C1.L_ZIP,C1.RES_PHONE1,C1.OFF_PHONE1  
FROM CLIENT1 C1,CLIENT2 C2  
WHERE C2.PARTY_CODE = @CODE  
AND C1.CL_CODE=C2.CL_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOBILLREPORT
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOBILLREPORT    SCRIPT DATE: 11/29/2001 1:51:56 PM ******/
/* RECENT  CHANGES DONE BY VAISHALI ON 17/07/2001 ADDED ORDER BY  YEAR(BILLDATE), MONTH(BILLDATE), DAY(BILLDATE) */
/* RECENT CHANGES DONE BY VAISHALI ON 10/07/2001 ADDED THE COND. AMOUNT <> 0*/
/*MODIFIED BY AMOLIKA ON 13TH APRIL'2001 : ADDED LIKE FOR PARTYCODE AND MATCHED CODE FROM FOACCBILL & 
  FOSETTLEMENT*/
/*
USED IN      : NSE FO
REPORT NAME  : BILL REPORT
FILE NAME    : BILLREPORT.ASP
TABLES USED  : FOACCBILL
FUNCTION     : RETURNS SELL_BUY, AMOUNT, BILLDATE 
WRITTEN BY   : AMOLIKA PATIL 
*/
CREATE PROCEDURE [dbo].[RPT_FOBILLREPORT]

@STATUSID VARCHAR(15),
@STATUSNAME VARCHAR(25),
@FCODE VARCHAR(10),
@TCODE VARCHAR(10),
@FDATE VARCHAR(12),
@TDATE VARCHAR(12)
AS

IF @STATUSID = 'BROKER'
BEGIN
	SELECT DISTINCT CONVERT(VARCHAR,BILLDATE,106) AS BILLDATE, A.AMOUNT , A.SELL_BUY, YEAR(BILLDATE), MONTH(BILLDATE), DAY(BILLDATE),
	A.PARTY_CODE,A.BILL_NO
	FROM FOACCBILL A, FOSETTLEMENT S
	WHERE BILLDATE BETWEEN @FDATE AND @TDATE + ' 23:59' 
	AND A.PARTY_CODE >= @FCODE AND A.PARTY_CODE <= @TCODE
	AND A.PARTY_CODE = S.PARTY_CODE AND A.AMOUNT <> 0
	ORDER BY A.PARTY_CODE, YEAR(BILLDATE), MONTH(BILLDATE), DAY(BILLDATE), BILL_NO
END 

IF @STATUSID = 'BRANCH'
BEGIN
	SELECT DISTINCT CONVERT(VARCHAR,BILLDATE,106) AS BILLDATE, A.AMOUNT , A.SELL_BUY, YEAR(BILLDATE), MONTH(BILLDATE), DAY(BILLDATE),
	A.PARTY_CODE,A.BILL_NO
	FROM FOACCBILL A, FOSETTLEMENT S , CLIENT1 C1, CLIENT2 C2, BRANCHES B
	WHERE BILLDATE BETWEEN @FDATE 
	AND @TDATE + ' 23:59' 
	AND A.PARTY_CODE >= @FCODE 
	AND A.PARTY_CODE <= @TCODE
	AND  S.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE 
	AND B.BRANCH_CD=@STATUSNAME
	AND B.SHORT_NAME=C1.TRADER
	AND A.PARTY_CODE = S.PARTY_CODE 
	AND A.AMOUNT <> 0 
	ORDER BY A.PARTY_CODE, YEAR(BILLDATE), MONTH(BILLDATE), DAY(BILLDATE), BILL_NO
END 

IF @STATUSID = 'SUBBROKER'
BEGIN
	SELECT DISTINCT CONVERT(VARCHAR,BILLDATE,106) AS BILLDATE, A.AMOUNT , A.SELL_BUY, YEAR(BILLDATE), MONTH(BILLDATE), DAY(BILLDATE),
	A.PARTY_CODE,A.BILL_NO
	FROM FOACCBILL A, FOSETTLEMENT S , CLIENT1 C1, CLIENT2 C2, SUBBROKERS SB
	WHERE BILLDATE BETWEEN @FDATE AND @TDATE + ' 23:59' 
	AND A.PARTY_CODE >= @FCODE 
	AND A.PARTY_CODE <= @TCODE
	AND  S.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE 
	AND LTRIM(RTRIM(SB.SUB_BROKER))=LTRIM(RTRIM(C1.SUB_BROKER))
	AND SB.SUB_BROKER=@STATUSNAME
	AND A.PARTY_CODE = S.PARTY_CODE 
	AND A.AMOUNT <> 0 
	ORDER BY A.PARTY_CODE, YEAR(BILLDATE), MONTH(BILLDATE), DAY(BILLDATE), BILL_NO
END

IF @STATUSID = 'CLIENT'
BEGIN
	SELECT DISTINCT CONVERT(VARCHAR,BILLDATE,106) AS BILLDATE, A.AMOUNT , A.SELL_BUY, YEAR(BILLDATE), MONTH(BILLDATE), DAY(BILLDATE),
	A.PARTY_CODE,A.BILL_NO
	FROM FOACCBILL A, FOSETTLEMENT S , CLIENT1 C1, CLIENT2 C2
	WHERE BILLDATE BETWEEN @FDATE AND @TDATE + ' 23:59' 
	AND A.PARTY_CODE >= @FCODE 
	AND A.PARTY_CODE <= @TCODE
	AND C2.PARTY_CODE= @STATUSNAME 
	AND A.PARTY_CODE = S.PARTY_CODE 
	AND  S.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE 	AND A.AMOUNT <> 0 AND S.RESERVED1 NOT IN ('1','3')
	ORDER BY A.PARTY_CODE, YEAR(BILLDATE), MONTH(BILLDATE), DAY(BILLDATE), BILL_NO
END


IF @STATUSID = 'TRADER'
BEGIN
	SELECT DISTINCT CONVERT(VARCHAR,BILLDATE,106) AS BILLDATE, A.AMOUNT , A.SELL_BUY, YEAR(BILLDATE), MONTH(BILLDATE), DAY(BILLDATE),
	A.PARTY_CODE,A.BILL_NO
	FROM FOACCBILL A, FOSETTLEMENT S , CLIENT1 C1, CLIENT2 C2
	WHERE BILLDATE BETWEEN @FDATE AND @TDATE + ' 23:59' 	AND A.PARTY_CODE >= @FCODE 
	AND A.PARTY_CODE <= @TCODE
	AND LTRIM(RTRIM(C1.TRADER))=@STATUSNAME
	AND  S.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE 
	AND A.PARTY_CODE = S.PARTY_CODE 
	AND A.AMOUNT <> 0
	ORDER BY A.PARTY_CODE, YEAR(BILLDATE), MONTH(BILLDATE), DAY(BILLDATE), BILL_NO
END

IF @STATUSID = 'FAMILY'
BEGIN
	SELECT DISTINCT CONVERT(VARCHAR,BILLDATE,106) AS BILLDATE, A.AMOUNT , A.SELL_BUY, YEAR(BILLDATE), MONTH(BILLDATE), DAY(BILLDATE),
	A.PARTY_CODE,A.BILL_NO
	FROM FOACCBILL A, FOSETTLEMENT S , CLIENT1 C1, CLIENT2 C2
	WHERE BILLDATE BETWEEN @FDATE AND @TDATE + ' 23:59' 
	AND A.PARTY_CODE >= @FCODE 
	AND A.PARTY_CODE <= @TCODE
	AND LTRIM(RTRIM(C1.FAMILY))=@STATUSNAME
	AND  S.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE 
	AND A.PARTY_CODE = S.PARTY_CODE 
	AND A.AMOUNT <> 0
	ORDER BY A.PARTY_CODE, YEAR(BILLDATE), MONTH(BILLDATE), DAY(BILLDATE), BILL_NO
END
/*
SELECT DISTINCT CONVERT(VARCHAR,BILLDATE,106) AS BILLDATE, A.AMOUNT , A.SELL_BUY, BILLDATE AS BILL,
A.PARTY_CODE,A.BILL_NO
FROM FOACCBILL A, FOSETTLEMENT S
WHERE BILLDATE BETWEEN @FDATE AND @TDATE + ' 23:59' 
AND A.PARTY_CODE LIKE LTRIM(@CODE)+'%'
AND A.PARTY_CODE = S.PARTY_CODE
ORDER BY A.PARTY_CODE, BILL,BILL_NO

SELECT DISTINCT CONVERT(VARCHAR,BILLDATE,106) AS BILLDATE, AMOUNT , SELL_BUY, BILLDATE AS BILL, PARTY_CODE
FROM FOACCBILL 
WHERE BILLDATE BETWEEN @FDATE AND @TDATE + ' 23:59' 
AND PARTY_CODE LIKE LTRIM(@CODE)+'%'
ORDER BY PARTY_CODE, BILL
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOCHECK
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOCHECK    SCRIPT DATE: 11/29/2001 1:51:56 PM ******/
/*
USED IN      : NSE FO
REPORT NAME  : BILL REPORT
FILE NAME    : BILLREPORT.ASP
TABLES USED  : FOSETTLEMENT
FUNCTION     : RETURNS DATA OF A PARTICULAR PARTYCODE & DATE
WRITTEN BY   : AMOLIKA PATIL 
*/
CREATE PROCEDURE [dbo].[RPT_FOCHECK]
@CODE VARCHAR(10),
@SDATE VARCHAR(12)
AS
SELECT * 
FROM FOSETTLEMENT 
WHERE PARTY_CODE = @CODE AND CONVERT(VARCHAR,SAUDA_DATE,106) = @SDATE AND RESERVED1 NOT IN ('1','3')

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOCLIENTDETAILBILL1
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_FOCLIENTDETAILBILL1]

@STATUSID VARCHAR(15),
@STATUSNAME VARCHAR(25),
@CODE VARCHAR(10),
@SDATE VARCHAR(12),
@TDATE VARCHAR(12)
AS

IF @STATUSID = 'BROKER'
BEGIN
	SELECT  PARTY_CODE ,BILLDATE =LEFT(CONVERT(VARCHAR,BILLDATE,106),11),
	CREDIT = SUM(CREDIT),
	DEBIT  = SUM(DEBIT) ,YY,DD,MM
	FROM RPT_FOCOLL
	WHERE PARTY_CODE LIKE LTRIM(@CODE)
	AND BILLDATE >= @SDATE AND BILLDATE <= @TDATE+ ' 23:59:59'
	GROUP BY PARTY_CODE,BILLDATE,YY,DD,MM
	ORDER BY PARTY_CODE,YY,MM,DD

END 

IF @STATUSID = 'BRANCH'
BEGIN
	SELECT  FO.PARTY_CODE,BILLDATE =LEFT(CONVERT(VARCHAR,BILLDATE,106),11),
	CREDIT = SUM(CREDIT),
	DEBIT  = SUM(DEBIT) ,YY,DD,MM
	FROM RPT_FOCOLL FO,CLIENT2 C2, CLIENT1 C1, BRANCHES B
	WHERE FO.PARTY_CODE = C2.PARTY_CODE AND 
	 B.SHORT_NAME = C1.TRADER AND
	 C1.CL_CODE = C2.CL_CODE AND
	 B.BRANCH_CD = @STATUSNAME AND
	FO.PARTY_CODE LIKE LTRIM(@CODE)
	AND BILLDATE >= @SDATE AND BILLDATE <= @TDATE+ ' 23:59:59'
	GROUP BY FO.PARTY_CODE,BILLDATE,YY,DD,MM
	ORDER BY FO.PARTY_CODE,YY,MM,DD
END 

IF @STATUSID = 'SUBBROKER'
BEGIN
	SELECT  FO.PARTY_CODE,BILLDATE =LEFT(CONVERT(VARCHAR,BILLDATE,106),11),
	CREDIT = SUM(CREDIT),
	DEBIT  = SUM(DEBIT) ,YY,DD,MM
	FROM RPT_FOCOLL FO,CLIENT2 C2, CLIENT1 C1, SUBBROKERS SB
	WHERE FO.PARTY_CODE = C2.PARTY_CODE AND 
	SB.SUB_BROKER = @STATUSNAME AND
	SB.SUB_BROKER = C1.SUB_BROKER AND
	C1.CL_CODE = C2.CL_CODE AND
	FO.PARTY_CODE LIKE LTRIM(@CODE)
	AND BILLDATE >= @SDATE AND BILLDATE <= @TDATE+ ' 23:59:59'
	GROUP BY FO.PARTY_CODE,BILLDATE,YY,DD,MM
	ORDER BY FO.PARTY_CODE,YY,MM,DD
END 

IF @STATUSID = 'TRADER'
BEGIN
	SELECT  FO.PARTY_CODE,BILLDATE =LEFT(CONVERT(VARCHAR,BILLDATE,106),11),
	CREDIT = SUM(CREDIT),
	DEBIT  = SUM(DEBIT) ,YY,DD,MM
	FROM RPT_FOCOLL FO,CLIENT2 C2, CLIENT1 C1
	WHERE FO.PARTY_CODE = C2.PARTY_CODE AND 
	C1.CL_CODE = C2.CL_CODE AND
	C1.TRADER  = @STATUSNAME AND
	FO.PARTY_CODE LIKE LTRIM(@CODE)
	AND BILLDATE >= @SDATE AND BILLDATE <= @TDATE+ ' 23:59:59'
	GROUP BY FO.PARTY_CODE,BILLDATE,YY,DD,MM
	ORDER BY FO.PARTY_CODE,YY,MM,DD
END 

IF @STATUSID = 'CLIENT'
BEGIN
	SELECT  FO.PARTY_CODE,BILLDATE =LEFT(CONVERT(VARCHAR,BILLDATE,106),11),
	CREDIT = SUM(CREDIT),
	DEBIT  = SUM(DEBIT) ,YY,DD,MM
	FROM RPT_FOCOLL FO,CLIENT2 C2, CLIENT1 C1
	WHERE FO.PARTY_CODE = C2.PARTY_CODE AND 
	C1.CL_CODE = C2.CL_CODE AND
	FO.PARTY_CODE = @STATUSNAME AND
	FO.PARTY_CODE LIKE LTRIM(@CODE)
	AND BILLDATE >= @SDATE AND BILLDATE <= @TDATE+ ' 23:59:59'
	GROUP BY FO.PARTY_CODE,BILLDATE,YY,DD,MM
	ORDER BY FO.PARTY_CODE,YY,MM,DD
END 

IF @STATUSID = 'FAMILY'
BEGIN
	SELECT  FO.PARTY_CODE,BILLDATE =LEFT(CONVERT(VARCHAR,BILLDATE,106),11),
	CREDIT = SUM(CREDIT),
	DEBIT  = SUM(DEBIT) ,YY,DD,MM
	FROM RPT_FOCOLL FO,CLIENT2 C2, CLIENT1 C1
	WHERE FO.PARTY_CODE = C2.PARTY_CODE AND 
	C1.CL_CODE = C2.CL_CODE AND
	C1.FAMILY  = @STATUSNAME AND
	FO.PARTY_CODE LIKE LTRIM(@CODE)
	AND  BILLDATE >= @SDATE AND BILLDATE <= @TDATE+ ' 23:59:59'
	GROUP BY FO.PARTY_CODE,BILLDATE,YY,DD,MM
	ORDER BY FO.PARTY_CODE,YY,MM,DD
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOCLOSINGDETAIL1
-- --------------------------------------------------
  
  
CREATE  PROCEDURE [dbo].[RPT_FOCLOSINGDETAIL1]  
  
 @TDATE VARCHAR(20),  
 @INSTRU_TYPE VARCHAR(4),  
 @SYM_FRM VARCHAR(12),  
 @SYM_TO VARCHAR(12),  
 @SRT_ODR VARCHAR(3)  
  
  
AS  
  
IF @SYM_TO= '' BEGIN SET @SYM_TO = 'ZZZZZZZZ' END  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
SELECT  
 REPORTORDER =   
   CASE   
    WHEN @SRT_ODR ='SYM'   
    THEN   
     SYMBOL + CONVERT(VARCHAR,EXPIRYDATE,112)  
    ELSE  
     CONVERT(VARCHAR,EXPIRYDATE,112) + SYMBOL  
   END,  
    TRADE_DATE= LEFT(TRADE_DATE,11),  
 EXPIRYDATE=LEFT(EXPIRYDATE,11),  
 INST_TYPE,  
 SYMBOL,  
 STRIKE_PRICE,  
 OPTION_TYPE,  
 CL_RATE  
FROM  
 FOCLOSING (NOLOCK)  
WHERE  
 SYMBOL BETWEEN @SYM_FRM AND @SYM_TO   
 AND  1 = CASE   
     WHEN @INSTRU_TYPE = 'BOTH'   
     THEN  
      1  
     ELSE   
      CASE WHEN @INSTRU_TYPE = 'FUT'   
       THEN   
        CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN 1 ELSE 2 END  
       ELSE  
        CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN 1 ELSE 2 END  
       END  
     END  
 AND LEFT(TRADE_DATE,11) = @TDATE   
ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOLISTCLIENT
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[RPT_FOLISTCLIENT]
@STATUSID VARCHAR(15),
@STATUSNAME VARCHAR(25)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @STATUSID='BROKER'
  BEGIN
    SELECT DISTINCT "<OPTION VALUE="+RTRIM(PARTY_CODE)+">"+RTRIM(PARTY_CODE)+"</OPTION>" , PARTY_CODE
    FROM CLIENT2
    ORDER BY PARTY_CODE
  END

IF @STATUSID='BRANCH'
  BEGIN
    SELECT DISTINCT "<OPTION VALUE="+RTRIM(PARTY_CODE)+">"+RTRIM(PARTY_CODE)+"</OPTION>" , PARTY_CODE
    FROM CLIENT2 C2, CLIENT1 C1, BRANCHES B
    WHERE C1.CL_CODE = C2.CL_CODE AND
	  LTRIM(RTRIM(B.SHORT_NAME)) = LTRIM(RTRIM(C1.TRADER)) AND	  
	  LTRIM(RTRIM(B.BRANCH_CD)) = LTRIM(RTRIM(@STATUSNAME))
    ORDER BY PARTY_CODE
  END 	

IF @STATUSID='SUBBROKER'
  BEGIN
    SELECT DISTINCT "<OPTION VALUE="+RTRIM(PARTY_CODE)+">"+RTRIM(PARTY_CODE)+"</OPTION>" , PARTY_CODE
    FROM CLIENT2 C2,CLIENT1 C1,SUBBROKERS SB
    WHERE  C1.CL_CODE = C2.CL_CODE AND
	  LTRIM(RTRIM(SB.SUB_BROKER)) = LTRIM(RTRIM(@STATUSNAME)) AND
	  LTRIM(RTRIM(SB.SUB_BROKER)) = LTRIM(RTRIM(C1.SUB_BROKER))
	  ORDER BY PARTY_CODE
  END 

IF @STATUSID='TRADER'
  BEGIN
    SELECT DISTINCT "<OPTION VALUE="+RTRIM(PARTY_CODE)+">"+RTRIM(PARTY_CODE)+"</OPTION>" , PARTY_CODE
    FROM CLIENT2 C2, CLIENT1 C1
    WHERE 
	C1.CL_CODE = C2.CL_CODE AND LTRIM(RTRIM(C1.TRADER))  = LTRIM(RTRIM(@STATUSNAME))  
    ORDER BY PARTY_CODE
  END	

IF @STATUSID='CLIENT'
  BEGIN
    SELECT DISTINCT "<OPTION VALUE="+RTRIM(PARTY_CODE)+">"+RTRIM(PARTY_CODE)+"</OPTION>" , PARTY_CODE
    FROM  CLIENT2 C2, CLIENT1 C1 
    WHERE  C1.CL_CODE=C2.CL_CODE AND
	 C2.PARTY_CODE=@STATUSNAME 
	ORDER BY PARTY_CODE
  END

IF @STATUSID='FAMILY'
  BEGIN
    SELECT DISTINCT "<OPTION VALUE="+RTRIM(PARTY_CODE)+">"+RTRIM(PARTY_CODE)+"</OPTION>" , PARTY_CODE
    FROM CLIENT2 C2, CLIENT1 C1
    WHERE C1.CL_CODE = C2.CL_CODE AND LTRIM(RTRIM(C1.FAMILY))  = LTRIM(RTRIM(@STATUSNAME))
    ORDER BY PARTY_CODE
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOMARGINDETAIL
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_FOMARGINDETAIL]
@CODE VARCHAR(10),
@SDATE VARCHAR(12)
AS


SELECT M.PARTY_CODE, M.INST_TYPE, M.SYMBOL, CONVERT(VARCHAR,M.EXPIRYDATE,106) AS EXPIRYDATE 
,SPREADQTY, NONSPREADQTY, SPREADMARGIN, NONSPREADMARGIN,ISNULL(SPREADMTH,0) AS SPREADMTH,TOTALQTY,CL_RATE
FROM FOMARGIN M
WHERE M.PARTY_CODE LIKE LTRIM(@CODE)+'%'
AND  LEFT(CONVERT(VARCHAR,M.MARGIN_DATE,109),11)  = @SDATE
ORDER BY INST_TYPE, SYMBOL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOMARGINDETAIL_NEW
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOMARGINDETAIL_NEW    SCRIPT DATE: 09/10/2001 6:27:30 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOMARGINDETAIL_NEW    SCRIPT DATE: 09/07/2001 10:36:24 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOMARGINDETAIL_NEW    SCRIPT DATE: 9/7/01 5:07:38 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOMARGINDETAIL_NEW    SCRIPT DATE: 9/7/2001 4:10:20 PM ******/
CREATE PROCEDURE [dbo].[RPT_FOMARGINDETAIL_NEW]

@STATUSID VARCHAR(15),
@STATUSNAME VARCHAR(25),
@CODE VARCHAR(10),
@SDATE VARCHAR(12),
@TDATE VARCHAR(12)
AS

IF @STATUSID = 'BROKER'
BEGIN

	SELECT SUM(M.PSPREADMARGIN) AS PMARGINAMOUNT,SUM(M.PTOTALMARGIN) AS TOTALMARGIN, PSPANMARGIN = ISNULL(PSPANMARGIN,0)
	FROM MARGINDETAILVIEW M
	WHERE M.PARTY_CODE LIKE LTRIM(RTRIM(@CODE))
	AND M.MDATE  >= @SDATE 
	AND M.MDATE <=  @TDATE + ' 23:59:00'
	GROUP BY M.PARTY_CODE, PSPANMARGIN
END 


IF @STATUSID = 'BRANCH'
BEGIN
	SELECT SUM(M.PSPREADMARGIN) AS PMARGINAMOUNT,SUM(M.PTOTALMARGIN) AS TOTALMARGIN, PSPANMARGIN = ISNULL(PSPANMARGIN,0)
	FROM MARGINDETAILVIEW M,  CLIENT1 C1, CLIENT2 C2, BRANCHES B
	WHERE M.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE  
	AND LTRIM(RTRIM(B.BRANCH_CD))=@STATUSNAME
	AND LTRIM(RTRIM(B.SHORT_NAME))=LTRIM(RTRIM(C1.TRADER))
	AND M.PARTY_CODE LIKE LTRIM(@CODE)
	AND M.MDATE  >= @SDATE 
	AND M.MDATE <=  @TDATE + ' 23:59:00'
	GROUP BY M.PARTY_CODE, PSPANMARGIN
END 

IF @STATUSID = 'SUBBROKER'
BEGIN
	SELECT SUM(M.PSPREADMARGIN) AS PMARGINAMOUNT,SUM(M.PTOTALMARGIN) AS TOTALMARGIN, PSPANMARGIN = ISNULL(PSPANMARGIN,0)
	FROM MARGINDETAILVIEW M,  CLIENT1 C1, CLIENT2 C2, SUBBROKERS  SB
	WHERE M.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE  
	AND LTRIM(RTRIM(SB.SUB_BROKER))=LTRIM(RTRIM(C1.SUB_BROKER))
	AND LTRIM(RTRIM(SB.SUB_BROKER))=LTRIM(RTRIM(@STATUSNAME))
	AND M.PARTY_CODE LIKE LTRIM(@CODE)
	AND M.MDATE  >= @SDATE 
	AND M.MDATE <=  @TDATE + ' 23:59:00'
	GROUP BY M.PARTY_CODE, PSPANMARGIN
END 

IF @STATUSID = 'TRADER'
BEGIN
	SELECT SUM(M.PSPREADMARGIN) AS PMARGINAMOUNT,SUM(M.PTOTALMARGIN) AS TOTALMARGIN, PSPANMARGIN = ISNULL(PSPANMARGIN,0)
	FROM MARGINDETAILVIEW M,  CLIENT1 C1, CLIENT2 C2 
	WHERE M.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE  
	AND LTRIM(RTRIM(C1.TRADER))=LTRIM(RTRIM(@STATUSNAME  ))
	AND M.PARTY_CODE LIKE LTRIM(@CODE)
	AND M.MDATE  >= @SDATE 
	AND M.MDATE <=  @TDATE + ' 23:59:00'
	GROUP BY M.PARTY_CODE, PSPANMARGIN
END 

IF @STATUSID = 'CLIENT'
BEGIN
	SELECT SUM(M.PSPREADMARGIN) AS PMARGINAMOUNT,SUM(M.PTOTALMARGIN) AS TOTALMARGIN, PSPANMARGIN = ISNULL(PSPANMARGIN,0)
	FROM MARGINDETAILVIEW M,  CLIENT1 C1, CLIENT2 C2 
	WHERE M.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE  
	AND C2.PARTY_CODE= @STATUSNAME
	AND M.PARTY_CODE LIKE LTRIM(@CODE)
	AND M.MDATE  >= @SDATE 
	AND M.MDATE <=  @TDATE + ' 23:59:00'
	GROUP BY M.PARTY_CODE, PSPANMARGIN
END 

IF @STATUSID = 'FAMILY'
BEGIN
	SELECT SUM(M.PSPREADMARGIN) AS PMARGINAMOUNT,SUM(M.PTOTALMARGIN) AS TOTALMARGIN, PSPANMARGIN = ISNULL(PSPANMARGIN,0)
	FROM MARGINDETAILVIEW M,  CLIENT1 C1, CLIENT2 C2 
	WHERE M.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE  
	AND LTRIM(RTRIM(C1.FAMILY))=LTRIM(RTRIM(@STATUSNAME))
	AND M.PARTY_CODE LIKE LTRIM(@CODE)
	AND M.MDATE  >= @SDATE 
	AND M.MDATE <=  @TDATE + ' 23:59:00'
	GROUP BY M.PARTY_CODE, PSPANMARGIN
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FONETPOSITION_SPAN
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[RPT_FONETPOSITION_SPAN]

@SDATE VARCHAR(12),
@PARTYCODE VARCHAR(10) ,
@SYMBOL VARCHAR(10)



AS
/*
SELECT PARTY_CODE,INST_TYPE,SYMBOL,LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,
SUM(PQTY) AS PQTY,
SUM(SQTY) AS SQTY, STRIKE_PRICE, OPTION_TYPE
FROM SPANNETPOSITION
WHERE EXPIRYDATE >= @SDATE
AND PARTY_CODE  LIKE LTRIM(@PARTYCODE) + '%'
AND SYMBOL LIKE LTRIM(@SYMBOL) + '%'
AND SAUDA_DATE < @SDATE + ' 23:59'
GROUP BY PARTY_CODE,SYMBOL,INST_TYPE,LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11), STRIKE_PRICE, OPTION_TYPE
ORDER BY PARTY_CODE,SYMBOL,INST_TYPE,LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11), STRIKE_PRICE, OPTION_TYPE
*/

SELECT PARTY_CODE,INST_TYPE,SYMBOL,LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11) AS EXPIRYDATE,
SUM(PQTY) AS PQTY,
SUM(SQTY) AS SQTY, STRIKE_PRICE, OPTION_TYPE
FROM  SPANNETPOSITION
WHERE EXPIRYDATE >= @SDATE + ' 23:59'
AND PARTY_CODE  LIKE LTRIM(@PARTYCODE) + '%'
AND SYMBOL LIKE LTRIM(@SYMBOL) + '%'
AND SAUDA_DATE < @SDATE + ' 23:59'
GROUP BY PARTY_CODE,SYMBOL,INST_TYPE,LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11), STRIKE_PRICE, OPTION_TYPE
ORDER BY PARTY_CODE,SYMBOL,INST_TYPE,LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11), STRIKE_PRICE, OPTION_TYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOSERIESWISEINFO1
-- --------------------------------------------------
 CREATE PROCEDURE [dbo].[RPT_FOSERIESWISEINFO1]    
  
@SDATE VARCHAR(20),   
@INSTRU_TYPE VARCHAR(4),  
@SYM_FRM VARCHAR(12),  
@SYM_TO VARCHAR(12)  
    
 AS     
  
 IF @SYM_TO= '' BEGIN SET @SYM_TO = 'ZZZZZZZZ' END  
  
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
    
SELECT   
     
     EXPIRYDATE = CONVERT(VARCHAR,EXPIRYDATE,106),    
     INST_TYPE,   
     SYMBOL,  
     STRIKE_PRICE,  
     OPTION_TYPE,   
     SEC_NAME,     
--   START_DATE = CONVERT(VARCHAR,STARTDATE,106),    
     MATURITYDATE = CONVERT(VARCHAR,MATURITYDATE,106),  
     EXPIRYDATE AS EXPDATE,    
     C_REGULAR_LOT  
       
  FROM   
       FOSCRIP2 (NOLOCK)    
  WHERE   
          SYMBOL BETWEEN @SYM_FRM AND @SYM_TO   
         AND  1 = CASE   
   WHEN @INSTRU_TYPE = 'BOTH'   
 THEN  
  1  
 ELSE   
  CASE WHEN @INSTRU_TYPE = 'FUT'   
   THEN   
    CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN 1 ELSE 2 END  
   ELSE  
    CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN 1 ELSE 2 END  
   END  
 END  
         AND LEFT(EXPIRYDATE,11) = @SDATE   
  ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOSETTNO
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 11/27/2001 11:58:51 AM ******/




/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 09/10/2001 6:27:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 09/07/2001 10:36:26 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 9/7/01 5:07:41 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 9/7/2001 4:10:23 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 08/10/01 4:38:31 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 7/25/01 10:06:10 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 7/18/2001 6:18:18 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 7/3/01 11:19:09 AM ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 5/11/01 12:09:00 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 5/7/2001 9:02:51 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 5/5/2001 2:43:39 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 5/5/2001 1:24:17 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 4/30/01 5:50:16 PM ******/
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSETTNO    SCRIPT DATE: 10/26/00 6:04:44 PM ******/
/*MODIFIED BY AMOLIKA ON 7TH FEB'2001: ADDED CONDITION FOR PARTYCODE & SDATE*/
CREATE PROCEDURE [dbo].[RPT_FOSETTNO]
@SETTNO VARCHAR(7),
@CODE VARCHAR(10),
@SDATE VARCHAR(12)
AS
/*SELECT DISTINCT LEFT(CONVERT(VARCHAR,L.VDT,109),11) AS VDT,L3.NARR 
FROM LEDGER3 L3 ,LEDGER L
WHERE L.VTYP = L3.VTYP
AND L.VNO = L3.VNO
AND NARR LIKE '%' + LTRIM(@SETTNO)+'%'
*/
SELECT DISTINCT LEFT(CONVERT(VARCHAR,L.VDT,109),11) AS VDT,L3.NARR 
FROM ACCOUNTCURBFO.DBO.LEDGER3 L3 ,ACCOUNTCURBFO.DBO.LEDGER L
WHERE L.VTYP = L3.VTYP
AND L.VNO = L3.VNO
AND NARR LIKE '%' + LTRIM(@SETTNO)+'%'
AND CLTCODE = @CODE
AND LEFT(CONVERT(VARCHAR,VDT,109),11) = @SDATE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOSPANCLLISTMARGIN
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANCLLISTMARGIN    SCRIPT DATE: 09/10/2001 6:27:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANCLLISTMARGIN    SCRIPT DATE: 09/07/2001 10:36:26 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANCLLISTMARGIN    SCRIPT DATE: 9/7/01 5:07:41 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANCLLISTMARGIN    SCRIPT DATE: 9/7/2001 4:10:23 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANCLLISTMARGIN    SCRIPT DATE: 08/10/2001 4:53:54 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANCLLISTMARGIN    SCRIPT DATE: 8/7/01 4:29:17 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANCLLISTMARGIN    SCRIPT DATE: 7/25/01 10:06:10 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOCLLISTMARGIN    SCRIPT DATE: 8/10/2001 6:40:48 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOCLLISTMARGIN    SCRIPT DATE: 7/3/01 11:19:05 AM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOCLLISTMARGIN    SCRIPT DATE: 5/11/01 12:08:55 PM ******/
CREATE PROCEDURE [dbo].[RPT_FOSPANCLLISTMARGIN]

@CLTYPE VARCHAR(3)

AS

SELECT DISTINCT "<OPTION VALUE="+RTRIM(S.PARTY_CODE)+">"+RTRIM(S.PARTY_CODE)+"</OPTION>" 
FROM FOSPANMARGINNEW S
WHERE CL_TYPE LIKE LTRIM(@CLTYPE)+'%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOSPANDETAIL_NEW
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANDETAIL_NEW    SCRIPT DATE: 09/10/2001 6:27:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANDETAIL_NEW    SCRIPT DATE: 09/07/2001 10:36:26 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANDETAIL_NEW    SCRIPT DATE: 9/7/01 5:07:41 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANDETAIL_NEW    SCRIPT DATE: 9/7/2001 4:10:23 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANDETAIL_NEW    SCRIPT DATE: 08/10/2001 4:53:54 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANDETAIL_NEW    SCRIPT DATE: 8/7/01 4:29:17 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANDETAIL_NEW    SCRIPT DATE: 7/25/01 10:06:10 PM ******/



/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANDETAIL_NEW    SCRIPT DATE: 7/18/2001 6:18:18 PM ******/

CREATE PROCEDURE [dbo].[RPT_FOSPANDETAIL_NEW]

@CODE VARCHAR(10),
@SDATE VARCHAR(12)

AS

SELECT  NEWSPANMARGIN = ISNULL(NEWSPANMARGIN,0)
FROM SPANDETAILVIEW M
WHERE M.PARTY_CODE LIKE LTRIM(@CODE)+'%'
AND CONVERT(VARCHAR,M.MDATE,106)  = @SDATE
GROUP BY M.PARTY_CODE, NEWSPANMARGIN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOSPANMARGIN
-- --------------------------------------------------
CREATE  PROC [dbo].[RPT_FOSPANMARGIN]
	(
		@SAUDA_DATE VARCHAR(11),
		@STATUSID VARCHAR(15),
		@STATUSNAME VARCHAR(25),
		@PARTYFROM VARCHAR(10),
		@PARTYTO VARCHAR(10)
	)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @PARTYTO ='' BEGIN SET @PARTYTO = 'ZZZZZZZZZZ' END

SELECT
	PARTY_CODE = ISNULL(S_PARTY_CODE,E_PARTY_CODE),
	PARTYNAME = ISNULL(S_PARTYNAME,E_PARTYNAME),
	SYMBOL = ISNULL(S_SYMBOL,E_SYMBOL),
	S_SPANMARGIN =ISNULL(S_SPANMARGIN,0),
	S_PREMIUM = ISNULL(S_PREMIUM,0),
	S_ADDMARGINPERC = ISNULL(S_ADDMARGINPERC,0),
	S_TOTALMARGIN = ISNULL(S_TOTALMARGIN,0),
	E_MARGINPERC = ISNULL(E_MARGINPERC,0),
	E_MARGINAMT = ISNULL(E_MARGINAMT,0)
FROM 

(
	SELECT
		S_PARTY_CODE = FOMARGIN_SPAN.PARTY_CODE,
		S_PARTYNAME = LONG_NAME,
		S_SYMBOL = FOMARGIN_SPAN.SYMBOL,
		S_SPANMARGIN = SPANMARGIN,
		S_PREMIUM = PREMIUM,
		S_ADDMARGINPERC = PMARGINRATE,
		S_TOTALMARGIN = TOTALMARGIN
	FROM
		FOMARGIN_SPAN,CLIENT1 , CLIENT2
	WHERE
		CLIENT1.CL_CODE = CLIENT2.CL_CODE
		AND CLIENT2.PARTY_CODE = FOMARGIN_SPAN.PARTY_CODE	
		AND FOMARGIN_SPAN.CL_TYPE ='CL'
		AND MDATE LIKE @SAUDA_DATE +'%'
		AND CLIENT2.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
		AND @STATUSNAME = 
		(CASE 
			WHEN @STATUSID = 'BRANCH' THEN CLIENT1.BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER' THEN CLIENT1.SUB_BROKER
			WHEN @STATUSID = 'TRADER' THEN CLIENT1.TRADER
			WHEN @STATUSID = 'FAMILY' THEN CLIENT1.FAMILY
			WHEN @STATUSID = 'AREA' THEN CLIENT1.AREA
			WHEN @STATUSID = 'REGION' THEN CLIENT1.REGION
			WHEN @STATUSID = 'CLIENT' THEN CLIENT2.PARTY_CODE
			ELSE 
		'BROKER'
		END)
) FOMRG

FULL OUTER JOIN 
(
	SELECT
		E_PARTY_CODE = FOMARGIN_EXP_DETAILS.PARTY_CODE,
		E_PARTYNAME = LONG_NAME,
		E_SYMBOL = SYMBOL,
		E_MARGINPERC = MARGIN_PERC,
		E_MARGINAMT = MARGINAMT
	
	FROM
		FOMARGIN_EXP_DETAILS,CLIENT1 , CLIENT2
	WHERE
		CLIENT1.CL_CODE = CLIENT2.CL_CODE
		AND CLIENT2.PARTY_CODE = FOMARGIN_EXP_DETAILS.PARTY_CODE
		AND SAUDA_DATE LIKE @SAUDA_DATE +'%'
		AND CLIENT2.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
		AND @STATUSNAME = 
		(CASE 
			WHEN @STATUSID = 'BRANCH' THEN CLIENT1.BRANCH_CD
			WHEN @STATUSID = 'SUBBROKER' THEN CLIENT1.SUB_BROKER
			WHEN @STATUSID = 'TRADER' THEN CLIENT1.TRADER
			WHEN @STATUSID = 'FAMILY' THEN CLIENT1.FAMILY
			WHEN @STATUSID = 'AREA' THEN CLIENT1.AREA
			WHEN @STATUSID = 'REGION' THEN CLIENT1.REGION
			WHEN @STATUSID = 'CLIENT' THEN CLIENT2.PARTY_CODE
			ELSE 
		'BROKER'
		END)
) EXPMRG
ON (E_PARTY_CODE = S_PARTY_CODE AND E_SYMBOL = S_SYMBOL)
ORDER BY 1,3

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOSPANMARGINDETAIL_NEW
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANMARGINDETAIL_NEW    SCRIPT DATE: 8/31/01 2:55:34 PM ******/
CREATE PROCEDURE [dbo].[RPT_FOSPANMARGINDETAIL_NEW]

@STATUSID VARCHAR(15),
@STATUSNAME VARCHAR(25),
@CODE VARCHAR(10),
@SDATE VARCHAR(12),
@TDATE VARCHAR(12)
AS

IF @STATUSID = 'BROKER'
BEGIN
	SELECT SUM(M.FINALTOTALMARGIN) AS FINALTOTALMARGIN,SUM(M.TOTALMARGIN) AS TOTALMARGIN, SPANMARGIN = ISNULL(SPANMARGIN,0)
	FROM SPANMARGINDETAILVIEW M
	WHERE M.PARTY_CODE LIKE LTRIM(@CODE)
	AND M.MDATE  BETWEEN @SDATE AND @TDATE
	GROUP BY M.PARTY_CODE, SPANMARGIN
END 


IF @STATUSID = 'BRANCH'
BEGIN
	SELECT SUM(M.FINALTOTALMARGIN) AS FINALTOTALMARGIN,SUM(M.TOTALMARGIN) AS TOTALMARGIN, SPANMARGIN = ISNULL(SPANMARGIN,0)
	FROM SPANMARGINDETAILVIEW M,  CLIENT1 C1, CLIENT2 C2, BRANCHES B
	WHERE M.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE  
	AND B.BRANCH_CD=@STATUSNAME
	AND B.SHORT_NAME=C1.TRADER
	AND M.PARTY_CODE LIKE LTRIM(@CODE)
	AND M.MDATE   BETWEEN @SDATE AND @TDATE
	GROUP BY M.PARTY_CODE, SPANMARGIN
END 

IF @STATUSID = 'SUBBROKER'
BEGIN
	SELECT SUM(M.FINALTOTALMARGIN) AS FINALTOTALMARGIN,SUM(M.TOTALMARGIN) AS TOTALMARGIN, SPANMARGIN = ISNULL(SPANMARGIN,0)
	FROM SPANMARGINDETAILVIEW M,  CLIENT1 C1, CLIENT2 C2, SUBBROKERS  SB
	WHERE M.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE  
	AND SB.SUB_BROKER=C1.SUB_BROKER
	AND SB.SUB_BROKER=@STATUSNAME
	AND M.PARTY_CODE LIKE LTRIM(@CODE)
	AND M.MDATE  BETWEEN @SDATE AND @TDATE
	GROUP BY M.PARTY_CODE, SPANMARGIN
END 

IF @STATUSID = 'TRADER'
BEGIN
	SELECT SUM(M.FINALTOTALMARGIN) AS FINALTOTALMARGIN,SUM(M.TOTALMARGIN) AS TOTALMARGIN, SPANMARGIN = ISNULL(SPANMARGIN,0)
	FROM SPANMARGINDETAILVIEW M,  CLIENT1 C1, CLIENT2 C2 
	WHERE M.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE  
	AND C1.TRADER=@STATUSNAME  
	AND M.PARTY_CODE LIKE LTRIM(@CODE)
	AND M.MDATE  BETWEEN @SDATE AND @TDATE
	GROUP BY M.PARTY_CODE, SPANMARGIN
END 

IF @STATUSID = 'CLIENT'
BEGIN
	SELECT SUM(M.FINALTOTALMARGIN) AS FINALTOTALMARGIN,SUM(M.TOTALMARGIN) AS TOTALMARGIN, SPANMARGIN = ISNULL(SPANMARGIN,0)
	FROM SPANMARGINDETAILVIEW M,  CLIENT1 C1, CLIENT2 C2 
	WHERE M.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE  
	AND C2.PARTY_CODE= @STATUSNAME
	AND M.PARTY_CODE LIKE LTRIM(@CODE)
	AND M.MDATE  BETWEEN @SDATE AND @TDATE
	GROUP BY M.PARTY_CODE, SPANMARGIN
END 

IF @STATUSID = 'FAMILY'
BEGIN
	SELECT SUM(M.FINALTOTALMARGIN) AS FINALTOTALMARGIN,SUM(M.TOTALMARGIN) AS TOTALMARGIN, SPANMARGIN = ISNULL(SPANMARGIN,0)
	FROM SPANMARGINDETAILVIEW M,  CLIENT1 C1, CLIENT2 C2 
	WHERE M.PARTY_CODE = C2.PARTY_CODE 
	AND C2.CL_CODE = C1.CL_CODE  
	AND C1.FAMILY=@STATUSNAME
	AND M.PARTY_CODE LIKE LTRIM(@CODE)
	AND M.MDATE  BETWEEN @SDATE AND @TDATE
	GROUP BY M.PARTY_CODE, SPANMARGIN
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOSPANMARGINNEW
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_FOSPANMARGINNEW]

@CODE VARCHAR(10),
@SDATE VARCHAR(12)

AS

SELECT  NEWSPANMARGIN = ISNULL(NEWSPANMARGIN,0)
FROM SPANDETAILVIEW M
WHERE M.PARTY_CODE LIKE LTRIM(@CODE)+'%'
AND CONVERT(VARCHAR,M.MDATE,106)  = @SDATE
GROUP BY M.PARTY_CODE, NEWSPANMARGIN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOSPANMEMBERMARGINNEW
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANMEMBERMARGINNEW    SCRIPT DATE: 09/10/2001 6:27:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANMEMBERMARGINNEW    SCRIPT DATE: 09/07/2001 10:36:26 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANMEMBERMARGINNEW    SCRIPT DATE: 9/7/01 5:07:41 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANMEMBERMARGINNEW    SCRIPT DATE: 9/7/2001 4:10:23 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANMEMBERMARGINNEW    SCRIPT DATE: 08/10/2001 4:53:54 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANMEMBERMARGINNEW    SCRIPT DATE: 8/7/01 4:29:17 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANMEMBERMARGINNEW    SCRIPT DATE: 7/25/01 10:06:10 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANMEMBERMARGINNEW    SCRIPT DATE: 8/10/2001 6:40:51 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANMEMBERMARGINNEW    SCRIPT DATE: 7/3/01 11:19:06 AM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANMEMBERMARGINNEW    SCRIPT DATE: 5/11/01 12:08:57 PM ******/
CREATE PROCEDURE [dbo].[RPT_FOSPANMEMBERMARGINNEW]

@SDATE VARCHAR(12)

AS

SELECT PARTY_CODE, TOTALMARGIN, CL_TYPE, SPANMARGIN
FROM FOSPANMARGINNEW
WHERE LEFT(CONVERT(VARCHAR,MDATE,109),11) = @SDATE
AND CL_TYPE = 'CL'
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOSPANOPTMEMBERMARGIN
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANOPTMEMBERMARGIN    SCRIPT DATE: 09/10/2001 6:27:31 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANOPTMEMBERMARGIN    SCRIPT DATE: 09/07/2001 10:36:26 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANOPTMEMBERMARGIN    SCRIPT DATE: 9/7/01 5:07:41 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANOPTMEMBERMARGIN    SCRIPT DATE: 9/7/2001 4:10:23 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANOPTMEMBERMARGIN    SCRIPT DATE: 08/10/2001 4:53:54 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANOPTMEMBERMARGIN    SCRIPT DATE: 8/7/01 4:29:17 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOSPANOPTMEMBERMARGIN    SCRIPT DATE: 7/25/01 10:06:10 PM ******/


/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOOPTMEMBERMARGIN    SCRIPT DATE: 8/10/2001 6:40:53 PM ******/

/****** OBJECT:  STORED PROCEDURE DBO.RPT_FOOPTMEMBERMARGIN    SCRIPT DATE: 7/3/01 11:19:08 AM ******/

CREATE PROCEDURE [dbo].[RPT_FOSPANOPTMEMBERMARGIN]

@SDATE VARCHAR(10)

AS

SELECT 
PQTY = ISNULL(SUM(S.PQTY),0),
SQTY = ISNULL(SUM(S.SQTY),0),
S.CL_RATE,
S.PARTY_CODE,S.INST_TYPE,S.SYMBOL, LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11) AS EXPIRYDATE ,S.STRIKE_PRICE,S.OPTION_TYPE,
SERVICE_TAX=(CASE  WHEN S.BILLFLAG > 3 THEN 
                            SUM( S.NSERTAX  )
                           ELSE
                               0 
               END),
BROK= (CASE  WHEN S.BILLFLAG > 3 THEN 
                           SUM(ABS(S.NBROKAPP))
                           ELSE
                               0 
               END)
FROM OPTIONEXALLOCVIEW S
WHERE S.EXPIRYDATE LIKE  @SDATE + '%'
AND S.OPTION_TYPE = 'CE'
AND S.STRIKE_PRICE< S.CL_RATE
/*AND S.PARTY_CODE = @PARTYCODE*/
GROUP BY PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE,S.BILLFLAG,S.CL_RATE

UNION ALL

SELECT 
PQTY = ISNULL(SUM(S.PQTY),0),
SQTY = ISNULL(SUM(S.SQTY),0),
S.CL_RATE,
S.PARTY_CODE,S.INST_TYPE,S.SYMBOL, LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11) AS EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE,
SERVICE_TAX=(CASE  WHEN S.BILLFLAG > 3 THEN 
                            SUM( S.NSERTAX  )
                           ELSE
                               0 
               END),
BROK= (CASE  WHEN S.BILLFLAG > 3 THEN 
                           SUM(ABS(S.NBROKAPP))
                           ELSE
                               0 
               END)
FROM OPTIONEXALLOCVIEW S
WHERE S.EXPIRYDATE LIKE @SDATE + '%'
AND S.OPTION_TYPE = 'PE'
AND S.STRIKE_PRICE > S.CL_RATE
/*AND S.PARTY_CODE = @PARTYCODE*/
GROUP BY PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE,S.BILLFLAG,S.CL_RATE
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FOTAXES_DETAILS
-- --------------------------------------------------
CREATE   PROC [dbo].[RPT_FOTAXES_DETAILS]

AS 

SELECT 
	FROMDATE = CONVERT(VARCHAR,FROM_DATE,112),
	FROM_DATE = LEFT(CONVERT(VARCHAR,FROM_DATE,109),11),
	TO_DATE = LEFT(CONVERT(VARCHAR,TO_DATE,109),11),
	TRANS_CAT,
	INSURANCE_CHRG = 0 + ' %',
	TURNOVER_TAX = CONVERT(VARCHAR,TURNOVER_TAX) ,
	OTHER_CHRG = CONVERT(VARCHAR,OTHER_CHRG) +' %',
	SEBITURN_TAX = CONVERT(VARCHAR,SEBITURN_TAX) +' %',
	BROKER_NOTE = CONVERT(VARCHAR,BROKER_NOTE) ,
	SERVICE_TAX = CONVERT(VARCHAR,SERVICE_TAX) +' %',
	CESS_TAX = CONVERT(VARCHAR,CESS_TAX) + ' %',
	EDUCESS_TAX = CONVERT(VARCHAR,EDUCESS_TAX) + ' %',
	CURTAXFLAG = CASE WHEN GETDATE() BETWEEN FROM_DATE AND TO_DATE THEN 1 ELSE 0 END
FROM 
        FOTAXES (NOLOCK) , FOGLOBALS
WHERE
	FROM_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT

ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_FTPARTYDETAILS
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_FTPARTYDETAILS    SCRIPT DATE: 10/17/02 1:53:08 PM ******/
CREATE    PROCEDURE [dbo].[RPT_FTPARTYDETAILS] 
  
@PARTYCODE AS VARCHAR(20)

    
AS 

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT CL2.CL_CODE,CL2.PARTY_CODE,CL2.DUMMY1,  
TURNOVER_TAX =  (CASE WHEN CL2.TURNOVER_TAX=0 THEN 'N'  
   WHEN CL2.TURNOVER_TAX=1 THEN 'Y'  
  END),  
SEBI_TURN_TAX =  (CASE WHEN CL2.SEBI_TURN_TAX=0 THEN 'N'  
   WHEN CL2.SEBI_TURN_TAX=1 THEN 'Y'  
  END),  
SERVICE_CHRG = (CASE WHEN CL2.SERVICE_CHRG=0 THEN 'EXCLUSIVE'  
   WHEN CL2.SERVICE_CHRG=1 THEN 'INCL IN BROK'  
   WHEN CL2.SERVICE_CHRG=2 THEN 'INCLUSIVE'  
  END),  
INSURANCE_CHRG = (CASE WHEN CL2.INSURANCE_CHRG=0 THEN 'N'  
   WHEN CL2.INSURANCE_CHRG =1 THEN 'Y'  
  END),  
OTHER_CHRG =(CASE WHEN CL2.OTHER_CHRG=0 THEN 'N'  
   WHEN CL2.OTHER_CHRG=1 THEN 'Y'  
  END),  
CL2.TABLE_NO,CL2.SUB_TABLENO,CL2.DEMAT_TABLENO,CL2.P_TO_P
,CL2.STD_RATE,CL2.DEMAT_TABLENO,CL2.ALBMDELCHRG,CL2.ALBMDELIVERY,CL2.ALBMCF_TABLENO,CL2.MF_TABLENO,CL2.SB_TABLENO, 
CL2.BROK1_TABLENO,CL2.BROK2_TABLENO,
BROK3_TABLE_NO= (CASE WHEN CL2.BROK3_TABLENO=0 THEN 'TREAT AS BROKERAGE'
WHEN CL2.BROK3_TABLENO=1 THEN 'TREAT AS CHARGES'	ELSE 'NOT SELECTED' END),
DUMMY1= (CASE WHEN CL2.DUMMY1=0 THEN 'PREMIUM'	WHEN CL2.DUMMY1=1 THEN 'STRIKE'
 WHEN CL2.DUMMY1=2 THEN 'STRIKE + PREMIUM' 
ELSE		 'NOT SELECTED'	END), CL2.DUMMY2 ,

BROKERNOTE= (CASE WHEN CL2.BROKERNOTE=0 THEN 'N'  
   WHEN CL2.BROKERNOTE=1 THEN 'Y'  
  END),  
BROK_SCHEME = (CASE WHEN CL2.BROK_SCHEME=0 THEN 'DEFAULT'  
   WHEN CL2.BROK_SCHEME=1 THEN 'MAX LOGIC (F/S) - BUY SIDE'  
  /* WHEN CL2.BROK_SCHEME=2 THEN 'MAX RATE'  */
   WHEN CL2.BROK_SCHEME=3 THEN 'MAX LOGIC (F/S) - SELL SIDE'  
   WHEN CL2.BROK_SCHEME=4 THEN 'FLAT BROKERAGE DEFAULT'  
   WHEN CL2.BROK_SCHEME=5 THEN 'FLAT BROKERAGE (MAX LOGIC) - BUY SIDE'  
   WHEN CL2.BROK_SCHEME=6 THEN 'FLAT BROKERAGE (MAX LOGIC) - SELL SIDE'  
  END),  
BROK3_TABLE_NO= (CASE WHEN CL2.BROK3_TABLENO=0 THEN 'TREAT AS BROKERAGE'  
   WHEN CL2.BROK3_TABLENO=1 THEN 'TREAT AS CHARGES'  
  ELSE  
   'NOT SELECTED'  
  END),  
DUMMY1= (CASE WHEN CL2.DUMMY1=0 THEN 'PREMIUM'  
   WHEN CL2.DUMMY1=1 THEN 'STRIKE'  
   WHEN CL2.DUMMY1=2 THEN 'STRIKE + PREMIUM'  
  ELSE  
   'NOT SELECTED'  
  END),  
CL2.DUMMY2,  
CL1.LONG_NAME,CL1.L_ADDRESS1,CL1.L_ADDRESS2, CL1.L_ADDRESS3, 
CL1.L_CITY,CL1.L_STATE,CL1.L_NATION,CL1.L_ZIP,CL1.FAX, RES_PHONE1, RES_PHONE2, OFF_PHONE1, OFF_PHONE2, CL1.EMAIL,  
CL1.BRANCH_CD,CL1.CL_TYPE,CL1.CL_STATUS,CL1.FAMILY,CL1.SUB_BROKER,CL1.MOBILE_PAGER,CL1.PAN_GIR_NO,CL1.TRADER,  
S1.NAME,B1.BRANCH  ,
CONTTYPE= (CASE WHEN CL2.INSCONT='S' THEN 'SCRIPWISE'  
   WHEN CL2.INSCONT='O' THEN 'ORDERWISE'  
   WHEN CL2.INSCONT='N' THEN 'NORMAL'  
  ELSE  
   'NOT AVAILABLE'  
  END),
PARTICIPANT = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.BANKID
 		ELSE  '' 
                            END) , 

CUSTODIAN = (CASE WHEN CL1.CL_TYPE='INS' THEN CL2.CLTDPNO
 		ELSE  '' 
                            END) , 

PRINTF = (CASE WHEN CL2.PRINTF=0 THEN 'PRINT'  
 		ELSE  
                'DONT PRINT'  
              END) ,

CONTPRT = (CASE WHEN CL2.PRINTF =0 THEN 'DETAIL BILL AND CONTRACT'  
   WHEN CL2.PRINTF =1 THEN 'DONT PRINT BILL AND CONTRACT'  
   WHEN CL2.PRINTF =2 THEN 'SUMMARISED CONTRACT AND DETAIL BILL'  
   WHEN CL2.PRINTF =3 THEN 'SUMMARISED BILL AND DETAIL CONTRACT'  
   WHEN CL2.PRINTF =4 THEN 'BOTH SUMMARISED'  
  END) ,
CONVERT(VARCHAR(11),C5.ACTIVEFROM) AS ACTIVEFROM ,  
INACTIVEFROM = (CASE WHEN CONVERT(VARCHAR(11),C5.INACTIVEFROM) ='JAN  1 1900' THEN 'N.A.'  
 		ELSE  
               CONVERT(VARCHAR(11),C5.INACTIVEFROM)
              END),
/*CONVERT(VARCHAR(11),C5.INACTIVEFROM)   AS INACTIVEFROM,*/
C5.INTRODUCER,C5.APPROVER ,

ISNULL(C5.PASSPORTDTL,'') AS PASSPORTDTL, ISNULL(C5.PASSPORTDATEOFISSUE,'') AS PASSPORTDATEOFISSUE,  ISNULL(C5.PASSPORTPLACEOFISSUE,'') AS PASSPORTPLACEOFISSUE,  ISNULL(C5.PASSPORTEXPDATE,'') AS PASSPORTEXPDATE,
ISNULL(C5.DRIVELICENDTL,'') AS DRIVELICENDTL, ISNULL(C5.LICENCENODATEOFISSUE,'') AS LICENCENODATEOFISSUE, ISNULL(C5.LICENCENOPLACEOFISSUE,'') AS LICENCENOPLACEOFISSUE, ISNULL(C5.DRIVEEXPDATE,'') AS DRIVEEXPDATE,
ISNULL(C5.RATIONCARDDTL,'') AS RATIONCARDDTL, ISNULL(C5.RATIONCARDDATEOFISSUE,'') AS RATIONCARDDATEOFISSUE, ISNULL(C5.RATIONCARDPLACEOFISSUE,'') AS RATIONCARDPLACEOFISSUE,
ISNULL(C5.VOTERSIDDTL,'') AS VOTERSIDDTL, ISNULL(C5.VOTERIDDATEOFISSUE,'') AS VOTERIDDATEOFISSUE, ISNULL(C5.VOTERIDPLACEOFISSUE,'') AS VOTERIDPLACEOFISSUE

FROM CLIENT2 CL2, CLIENT1 CL1 LEFT OUTER JOIN CLIENT5 C5 ON ( C5.CL_CODE = CL1.CL_CODE ) ,
SUBBROKERS S1,BRANCH B1
WHERE CL1.CL_CODE = CL2.CL_CODE  
AND S1.SUB_BROKER = CL1.SUB_BROKER  
AND CL2.PARTY_CODE =@PARTYCODE
AND B1.BRANCH_CODE = CL1.BRANCH_CD

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_HISTORYDATA
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_HISTORYDATA] 
(
	@SAUDA_DATEFROM VARCHAR(11),
	@SAUDA_DATETO VARCHAR(11),
	@EXPIRY_DATEFROM VARCHAR(11),
	@EXPIRY_DATETO VARCHAR(11),
	@FECHFOR VARCHAR(10)
)
AS


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @SAUDA_DATETO = '' BEGIN SET @SAUDA_DATETO = 'DEC 31 2049 23:59' END
IF @EXPIRY_DATETO = '' BEGIN SET @EXPIRY_DATETO = 'DEC 31 2049 23:59' END

IF @FECHFOR = 'CURRENT'
BEGIN
	SELECT 
		EXPIRYDATE = LEFT(EXPIRYDATE,11) , 
		TRADEDATEFROM = LEFT(MIN(SAUDA_DATE),11), 
		TRADEDATETO = LEFT(MAX(SAUDA_DATE),11),
		CONVERT(VARCHAR,EXPIRYDATE,112) 
	FROM 
		FOSETTLEMENT (NOLOCK)
	WHERE 
		SAUDA_DATE >= @SAUDA_DATEFROM
		AND SAUDA_DATE <= @SAUDA_DATETO + ' 23:59:59'
		AND EXPIRYDATE >= @EXPIRY_DATEFROM
		AND EXPIRYDATE <= @EXPIRY_DATETO + ' 23:59:59'
	GROUP BY 
		LEFT(EXPIRYDATE,11),CONVERT(VARCHAR,EXPIRYDATE,112)
	ORDER BY 
		CONVERT(VARCHAR,EXPIRYDATE,112)
	
END
ELSE
BEGIN
	SELECT 
		EXPIRYDATE = LEFT(EXPIRYDATE,11) , 
		TRADEDATEFROM = LEFT(MIN(SAUDA_DATE),11), 
		TRADEDATETO = LEFT(MAX(SAUDA_DATE),11),
		CONVERT(VARCHAR,EXPIRYDATE,112) 
	FROM 
		PRADNYA.DBO.DATAIN_HISTORY_FOSETTLEMENT_ACECOMM (NOLOCK)
	WHERE 
		SAUDA_DATE >= @SAUDA_DATEFROM
		AND SAUDA_DATE <= @SAUDA_DATETO +' 23:59:59'
		AND EXPIRYDATE >= @EXPIRY_DATEFROM
		AND EXPIRYDATE <= @EXPIRY_DATETO +' 23:59:59'
	GROUP BY 
		LEFT(EXPIRYDATE,11),CONVERT(VARCHAR,EXPIRYDATE,112)
	ORDER BY 
		CONVERT(VARCHAR,EXPIRYDATE,112)
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_INSTAVGREPORT_FO
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[RPT_INSTAVGREPORT_FO]
				@OFDATE  VARCHAR(11),
				@FPARTY  VARCHAR(10),
				@TPARTY  VARCHAR(10),
				@FSCRIP  VARCHAR(10),
				@TSCRIP  VARCHAR(10),
				@FFAMILY VARCHAR(10),
				@TFAMILY VARCHAR(10),
				@ORDERBY VARCHAR(1),
				@RPTBY	 INT = 0,
				@RPTSB	 INT = 0
              

  -- EXEC RPT_INSTAVGREPORT_FO 'SEP 30 2010','','ZZZZZ','','','','','0'


  AS

  IF @FPARTY = ''
    SET @FPARTY = '0000000000'
  
  IF @TPARTY = ''
    SET @TPARTY = 'ZZZZZZZZZZ'
                  
  IF @FSCRIP = ''
    SET @FSCRIP = '0000000000'
  
  IF @TSCRIP = ''
    SET @TSCRIP = 'ZZZZZZZZZZ'
                  
  IF @FFAMILY = ''
    SET @FFAMILY = '0000000000'
  
  IF @TFAMILY = ''
    SET @TFAMILY = 'ZZZZZZZZZZ'
                   
  SELECT SRNO,CONTRACTNO,BILLNO,TRADE_NO,PARTY_CODE,INST_TYPE,SYMBOL,SEC_NAME,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,
		USER_ID='',PRO_CLI,O_C_FLAG,C_U_FLAG,TRADEQTY,AUCTIONPART,MARKETTYPE,SERIES,ORDER_NO,PRICE,SAUDA_DATE,
		TABLE_NO,LINE_NO,VAL_PERC,NORMAL,DAY_PUC,DAY_SALES,SETT_PURCH,SETT_SALES,SELL_BUY,SETTFLAG,BROKAPPLIED,
		NETRATE,AMOUNT,INS_CHRG,TURN_TAX,OTHER_CHRG,SEBI_TAX,BROKER_CHRG,SERVICE_TAX,TRADE_AMOUNT,BILLFLAG,
		SETT_NO,NBROKAPP,NSERTAX,N_NETRATE,SETT_TYPE,CL_RATE,PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,
		BRANCH_ID,TMARK,SCHEME,DUMMY1,DUMMY2,RESERVED1,RESERVED2
  INTO   #FOSETTLEMENT_1
  FROM   FOSETTLEMENT
  WHERE  LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @OFDATE
         AND PARTY_CODE BETWEEN @FPARTY AND @TPARTY
         AND SYMBOL BETWEEN @FSCRIP AND @TSCRIP
         AND TRADEQTY > 0
		 AND DUMMY1 = (CASE 
							WHEN @RPTBY = 1 THEN 1
							WHEN @RPTBY = 2 THEN 0
							ELSE DUMMY1
						END)
		 AND SELL_BUY = (CASE
							WHEN @RPTSB = 0 THEN SELL_BUY 
							ELSE @RPTSB
						END)
							
                        
  SELECT S.*,
         TOTBROK = (TRADEQTY * BROKAPPLIED),
		 CONTRACTS = TRADEQTY,
		 PARENTCODE = C2.PARENTCODE,
		 PARENTNAME = CONVERT(VARCHAR(100),'')
  INTO   #FOSETTLEMENT
  FROM   #FOSETTLEMENT_1 S,
         CLIENT1 C1,
         CLIENT2 C2
  WHERE  S.PARTY_CODE = C2.PARTY_CODE
         AND C2.CL_CODE = C1.CL_CODE
         AND C1.FAMILY BETWEEN @FFAMILY AND @TFAMILY
         AND C1.CL_TYPE = 'INS'


  UPDATE #FOSETTLEMENT	
  SET	 PARENTNAME  = ISNULL(C1.LONG_NAME,'')
  FROM	 CLIENT1 C1 (NOLOCK)
  WHERE  C1.CL_CODE = #FOSETTLEMENT.PARENTCODE


  UPDATE #FOSETTLEMENT
  SET    BROKAPPLIED = CASE 
                         WHEN SELL_BUY = 1 THEN CD_TOT_BUYBROK / TRADEQTY
                         ELSE CD_TOT_SELLBROK / TRADEQTY
                       END + (CASE 
                                WHEN SERVICE_CHRG = 1 THEN CASE 
                                                             WHEN SELL_BUY = 1 THEN CD_TOT_BUYSERTAX / TRADEQTY
                                                             ELSE CD_TOT_SELLSERTAX / TRADEQTY
                                                           END
                                ELSE 0
                              END),
         SERVICE_TAX = SERVICE_TAX + (CASE 
                                        WHEN SERVICE_CHRG = 0 THEN CASE 
                                                                     WHEN SELL_BUY = 1 THEN CD_TOT_BUYSERTAX
                                                                     ELSE CD_TOT_SELLSERTAX
                                                                   END
                                        ELSE 0
                                      END),
         NSERTAX = (CASE 
                      WHEN SERVICE_CHRG = 0 THEN CASE 
                                                   WHEN SELL_BUY = 1 THEN CD_TOT_BUYSERTAX
                                                   ELSE CD_TOT_SELLSERTAX
                                                 END
                      ELSE 0
                    END),
         TOTBROK = CASE 
                     WHEN SELL_BUY = 1 THEN CD_TOT_BUYBROK
                     ELSE CD_TOT_SELLBROK
                   END + (CASE 
                            WHEN SERVICE_CHRG = 1 THEN CASE 
                                                         WHEN SELL_BUY = 1 THEN CD_TOT_BUYSERTAX
                                                    ELSE CD_TOT_SELLSERTAX
                                         END
                  ELSE 0
                          END)
  FROM   CHARGES_DETAIL,
         CLIENT2
  WHERE  CLIENT2.PARTY_CODE = CD_PARTY_CODE
         AND CONVERT(VARCHAR,CD_SAUDA_DATE,102) = CONVERT(VARCHAR,SAUDA_DATE,102)
         AND CD_PARTY_CODE = #FOSETTLEMENT.PARTY_CODE
         AND CD_INST_TYPE = INST_TYPE
         AND CD_SYMBOL = SYMBOL
         AND CONVERT(VARCHAR,CD_EXPIRY_DATE,106) = CONVERT(VARCHAR,EXPIRYDATE,106)
         AND CD_OPTION_TYPE = OPTION_TYPE
         AND CD_STRIKE_PRICE = STRIKE_PRICE
         AND CD_TRADE_NO = TRADE_NO
         AND CD_ORDER_NO = ORDER_NO


	UPDATE #FOSETTLEMENT
	SET    TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO)
	WHERE  UPPER(LEFT(TRADE_NO,1)) BETWEEN 'A' AND 'Z'
                                                 

	SELECT CONTRACTNO,SRNO=MIN(SRNO) 
	INTO #FOSETTLEMENT_2
	FROM #FOSETTLEMENT GROUP BY CONTRACTNO


	UPDATE #FOSETTLEMENT
	SET TOTBROK = CD_TOT_BROK,SERVICE_TAX = CD_TOT_SERTAX
	FROM CHARGES_DETAIL (NOLOCK),#FOSETTLEMENT_2
	WHERE CONVERT(VARCHAR,CD_SAUDA_DATE,102) = CONVERT(VARCHAR,SAUDA_DATE,102)
		AND #FOSETTLEMENT.PARTY_CODE = CD_PARTY_CODE
		AND #FOSETTLEMENT.CONTRACTNO = CD_CONTRACT_NO
		AND CD_TRADE_NO =''
		AND #FOSETTLEMENT_2.CONTRACTNO = #FOSETTLEMENT.CONTRACTNO
		AND #FOSETTLEMENT_2.SRNO = #FOSETTLEMENT.SRNO

	UPDATE #FOSETTLEMENT
	SET	CONTRACTS = (CASE 
						WHEN C_REGULAR_LOT > 0 THEN TRADEQTY / C_REGULAR_LOT
						ELSE 0
					END)
	FROM FOSCRIP2 F2 (NOLOCK)
	WHERE #FOSETTLEMENT.INST_TYPE = F2.INST_TYPE
		AND #FOSETTLEMENT.SYMBOL = F2.SYMBOL
		AND LEFT(#FOSETTLEMENT.EXPIRYDATE,11) = LEFT(F2.EXPIRYDATE,11)
		AND #FOSETTLEMENT.STRIKE_PRICE = F2.STRIKE_PRICE
		AND #FOSETTLEMENT.OPTION_TYPE = F2.OPTION_TYPE
                        
	SELECT   
			CASE @ORDERBY 
             WHEN '0' THEN S.CONTRACTNO
             WHEN '1' THEN S.PARTY_CODE
             WHEN '2' THEN S.SYMBOL
             WHEN '3' THEN C2.CLTDPNO
             ELSE ''
           END ORDER1,
           CASE @ORDERBY 
             WHEN '0' THEN C1.CL_TYPE
             WHEN '1' THEN S.SYMBOL
             WHEN '2' THEN S.PARTY_CODE
             WHEN '3' THEN S.SYMBOL
             ELSE ''
           END ORDER2,
           CASE @ORDERBY 
             WHEN '0' THEN S.PARTY_CODE
             WHEN '3' THEN S.PARTY_CODE
             ELSE CONVERT(VARCHAR,SELL_BUY)
           END ORDER3,
           CASE @ORDERBY 
             WHEN '0' THEN S.SYMBOL
             WHEN '3' THEN CONVERT(VARCHAR,SELL_BUY)
             ELSE S.CONTRACTNO
           END ORDER4,
           CASE @ORDERBY 
             WHEN '0' THEN CONVERT(VARCHAR,SELL_BUY)
             ELSE 'INS'
           END ORDER5,
           SERIES = S.INST_TYPE,
           SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),
           TRADEQTY = SUM(TRADEQTY),
           MKTRATE = (CASE ISNULL(IT.PRICE,4)
						WHEN 2 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(PRICE * TRADEQTY) / SUM(TRADEQTY),2)))
						WHEN 4 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(SUM(PRICE * TRADEQTY) / SUM(TRADEQTY),4)))
					END),
           MKTAMT = ROUND(SUM(PRICE * TRADEQTY),2),
           --BROK = SUM(BROKAPPLIED * TRADEQTY) / SUM(TRADEQTY),
           --BROK = SUM(TOTBROK) + SUM(CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX ELSE 0 END),
		   --BROK = SUM(TOTBROK)/SUM(TRADEQTY) + SUM(CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX/TRADEQTY ELSE 0 END),
		   BROK = (CASE ISNULL(FT.ROUND_TO,4) 
						WHEN 2 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(TOTBROK)/SUM(TRADEQTY) + SUM(CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX/TRADEQTY ELSE 0 END),2)))
						WHEN 4 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(SUM(TOTBROK)/SUM(TRADEQTY) + SUM(CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX/TRADEQTY ELSE 0 END),4)))
					END),
           NETRATE = (CASE ISNULL(IT.NETRATE,4)
						WHEN 2 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(
							SUM(CASE 
							   WHEN SELL_BUY = 1 THEN PRICE * TRADEQTY + TOTBROK
							   ELSE PRICE * TRADEQTY - TOTBROK
							END) / SUM(TRADEQTY),2)))
						WHEN 4 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(
							SUM(CASE 
							   WHEN SELL_BUY = 1 THEN PRICE * TRADEQTY + TOTBROK
							   ELSE PRICE * TRADEQTY - TOTBROK
							END) / SUM(TRADEQTY),4)))
					END),
           STT = SUM(CASE 
                       WHEN INSURANCE_CHRG = 1 THEN INS_CHRG
                       ELSE 0
                     END),
		   SERTAX = SUM(CASE WHEN SERVICE_CHRG = 0 THEN SERVICE_TAX ELSE 0 END),
		   SEBI_TAX = SUM(CASE WHEN SEBI_TURN_TAX = 1 THEN SEBI_TAX ELSE 0 END),
		   TURN_TAX = SUM(CASE WHEN TURNOVER_TAX = 1 THEN TURN_TAX ELSE 0 END),
		   OTHER_CHRG = SUM(CASE WHEN C2.OTHER_CHRG = 1 THEN S.OTHER_CHRG ELSE 0 END),
		   STAMP_CHRG = SUM(CASE WHEN BROKERNOTE = 1 THEN S.BROKER_CHRG ELSE 0 END),
           NETAMT = ROUND(SUM(CASE 
                                WHEN SELL_BUY = 1 THEN PRICE * TRADEQTY + TOTBROK + (CASE 
                                                                                       WHEN INSURANCE_CHRG = 1 THEN INS_CHRG
                                                                                       ELSE 0
                                                                                     END)
												  + (CASE WHEN SERVICE_CHRG <> 2 THEN SERVICE_TAX ELSE 0 END)
												  + (CASE WHEN SEBI_TURN_TAX = 1 THEN SEBI_TAX ELSE 0 END)
												  + (CASE WHEN TURNOVER_TAX = 1 THEN TURN_TAX ELSE 0 END)
												  + (CASE WHEN C2.OTHER_CHRG = 1 THEN S.OTHER_CHRG ELSE 0 END)
												  + (CASE WHEN BROKERNOTE = 1 THEN S.BROKER_CHRG ELSE 0 END)
                                ELSE PRICE * TRADEQTY - TOTBROK - (CASE 
                                                                     WHEN INSURANCE_CHRG = 1 THEN INS_CHRG
                                                                     ELSE 0
                                                                   END)
												  - (CASE WHEN SERVICE_CHRG <> 2 THEN SERVICE_TAX ELSE 0 END)
												  - (CASE WHEN SEBI_TURN_TAX = 1 THEN SEBI_TAX ELSE 0 END)
												  - (CASE WHEN TURNOVER_TAX = 1 THEN TURN_TAX ELSE 0 END)
												  - (CASE WHEN C2.OTHER_CHRG = 1 THEN S.OTHER_CHRG ELSE 0 END)
												  - (CASE WHEN BROKERNOTE = 1 THEN S.BROKER_CHRG ELSE 0 END)
                              END),2),
           AVGRATE = (CASE ISNULL(IT.PRICE,4)
						WHEN 2 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,2),ROUND(SUM(S.DUMMY2 * TRADEQTY) / SUM(TRADEQTY),2)))
						WHEN 4 THEN CONVERT(VARCHAR,CONVERT(NUMERIC(18,4),ROUND(SUM(S.DUMMY2 * TRADEQTY) / SUM(TRADEQTY),4)))
					END),
           AVGAMT = ROUND(SUM(S.DUMMY2 * TRADEQTY),2),
           BROKAMT = SUM(TOTBROK),-- + SUM(CASE WHEN SERVICE_CHRG = 1 THEN SERVICE_TAX ELSE 0 END),
           /*SCRIPNAME = S.SYMBOL + S.INST_TYPE + LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11) + (CASE 
                                                                                                WHEN S.STRIKE_PRICE = 0 THEN ''
                                                                                                ELSE CONVERT(CHAR,S.STRIKE_PRICE)
                                                                                              END) + S.OPTION_TYPE,*/
			SCRIPNAME = (CASE   
							WHEN S.INST_TYPE LIKE 'FUT%'   
							THEN RTRIM(S.INST_TYPE) + ' ' + RTRIM(S.SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,S.EXPIRYDATE,109),6),' ',''))
							ELSE RTRIM(S.INST_TYPE) + ' ' + RTRIM(S.SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,S.EXPIRYDATE,109),6),' ','')) + ' ' + RTRIM(CONVERT(VARCHAR,S.STRIKE_PRICE)) + ' ' + RTRIM(S.OPTION_TYPE)   
						END),
           USER_ID,
           SETT_NO = ' ',
           SETT_TYPE = ' ',
           C1.SHORT_NAME,
           C1.CL_TYPE,
           ISIN = ' ',
           STP_DATE = ' ',
           C_STATUS = ISNULL(ST.DUMMY1,'1'),
           PARTICIPANTCODE = C2.BANKID,
           CUSTODIANCODE = C2.CLTDPNO,
           CUSTODIANNAME = ISNULL(CU.SHORT_NAME,''),
           TRADETYPE = (CASE WHEN RESERVED1 = 1 THEN 'CON' ELSE 'REG' END), 
           S.CONTRACTNO,
		   TRD_PARTICIPANTCODE = S.PARTICIPANTCODE,
		   CLIENT_NAME = C1.LONG_NAME,
		   CONTRACTS = SUM(CONTRACTS),
			PARENTCODE = C2.PARENTCODE,
			PARENTNAME
  FROM     #FOSETTLEMENT S (NOLOCK)
           LEFT OUTER JOIN (SELECT DISTINCT CONTRACTNO,
                                            PARTY_CODE,
                                            SYMBOL,
                                            INST_TYPE,
                                            EXPIRYDATE,
                                            STRIKE_PRICE,
                                            OPTION_TYPE,
											PARTICIPANTCODE,
                                            DUMMY1
                            FROM   FOSETTLEMENT --WITH (INDEX (SAUDADATE ) ,NOLOCK)
                            WHERE  LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @OFDATE
                                   AND TRADEQTY <> 0
                                   AND DUMMY1 = 0) ST
             ON (ST.CONTRACTNO = S.CONTRACTNO
                 AND ST.PARTY_CODE = S.PARTY_CODE
                 AND ST.SYMBOL = S.SYMBOL
                 AND ST.INST_TYPE = S.INST_TYPE
                 AND ST.EXPIRYDATE = S.EXPIRYDATE
                 AND ST.STRIKE_PRICE = S.STRIKE_PRICE
                 AND ST.OPTION_TYPE = S.OPTION_TYPE
				 AND ST.PARTICIPANTCODE = S.PARTICIPANTCODE),
           CLIENT1 C1 (NOLOCK),
           CLIENT2 C2 (NOLOCK)
           LEFT OUTER JOIN CUSTODIAN CU
            ON (C2.CLTDPNO = CU.CUSTODIANCODE)
			LEFT OUTER JOIN FOCLIENTTAXES FT (NOLOCK)
			ON (C2.PARTY_CODE = FT.PARTY_CODE
			AND @OFDATE BETWEEN FT.DATE_FROM AND FT.DATE_TO)
			LEFT OUTER JOIN INSTCLIENT_TBL IT (NOLOCK)
			ON (C2.PARTY_CODE = IT.PARTYCODE)
  WHERE    LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) = @OFDATE
           AND S.PARTY_CODE BETWEEN @FPARTY AND @TPARTY
           AND S.SYMBOL BETWEEN @FSCRIP AND @TSCRIP
           AND S.PARTY_CODE = C2.PARTY_CODE
           AND C2.CL_CODE = C1.CL_CODE
           AND C1.FAMILY BETWEEN @FFAMILY AND @TFAMILY
           AND TRADEQTY <> 0
		   AND C1.CL_TYPE = 'INS'
  GROUP BY 
		S.SYMBOL,
		S.INST_TYPE,
		(CASE   
			WHEN S.INST_TYPE LIKE 'FUT%'   
			THEN RTRIM(S.INST_TYPE) + ' ' + RTRIM(S.SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,S.EXPIRYDATE,109),6),' ',''))
			ELSE RTRIM(S.INST_TYPE) + ' ' + RTRIM(S.SYMBOL) + ' ' + UPPER(REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,S.EXPIRYDATE,109),6),' ','')) + ' ' + RTRIM(CONVERT(VARCHAR,S.STRIKE_PRICE)) + ' ' + RTRIM(S.OPTION_TYPE)   
		END),
		S.PARTY_CODE,SELL_BUY,LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),
		USER_ID,C1.SHORT_NAME,C1.CL_TYPE,S.CONTRACTNO,
		INSURANCE_CHRG,ST.DUMMY1,C2.BANKID,C2.CLTDPNO,CU.SHORT_NAME, S.PARTICIPANTCODE, RESERVED1, C1.LONG_NAME,
		ISNULL(IT.PRICE,4), ISNULL(IT.NETRATE,4), ISNULL(FT.ROUND_TO,4),
		C2.PARENTCODE,
		PARENTNAME
  ORDER BY 
		1,2,3,4,5

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LEDGERBILLENTRY
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_LEDGERBILLENTRY    SCRIPT DATE: 01/15/2005 5:25:55 PM ******/    
    
/****** OBJECT:  STORED PROCEDURE DBO.RPT_LEDGERBILLENTRY    SCRIPT DATE: 12/16/2003 2:37:02 PM ******/    
    
    
    
    
/****** OBJECT:  STORED PROCEDURE DBO.RPT_LEDGERBILLENTRY    SCRIPT DATE: 2/17/01 5:19:50 PM ******/    
    
    
/****** OBJECT:  STORED PROCEDURE DBO.RPT_LEDGERBILLENTRY    SCRIPT DATE: 04/27/2001 4:32:44 PM ******/    
    
    
/*CHANGED BY MOUSAMI ON 12 DEC 2001     
    NOW SETTNOETC IS TAKEN FROM LEDGER3     
     INSTEAD OF LEDGER1 SO REMOVED BNKNAME COLUMN    
  */    
/*CHANGED BY MOUSAMI  ON 16 OCT  2001     
    ADDED HARDCODING AS L3.NARATNO=0    
    IN ELSE PART OF NARRATION.    
    IF LINE NO OF LEDGER AND LEDGER3 DOES NOT MATCH THEN  TAKE MAIN NARRATION     
    FOR MAIN NARRATION LINE NUMBER IS 0    
*/     
    
/*CHANGED BY MOUSAMI ON  AUG 2 2001     
    ADDED LEDGER3 JOIN SO THAT WE CAN GET NARRATION FROM LEDGER3 WHICH GIVES DETAILS ABOUT TO WHICH EXCHANGE A PARTICULAR BILL BELONGS TO     
*/    
    
/*SELECTS DETAILS OF BILL ENTRY FOR A CLIENT CODE FROM LEDGER */    
/*    
CHANGED BY MOUSAMI ON 01/03/2001    
ADDED HARDCODING FOR ACCOUNT DATABSE */    
     
CREATE PROCEDURE [dbo].[RPT_LEDGERBILLENTRY]    
@VTYP SMALLINT,     
@VNO VARCHAR(12),    
@LNO NUMERIC,    
@DRCR VARCHAR(1),    
@CLTCODE VARCHAR(10)    
AS    
    
    
SELECT   NARR=ISNULL((CASE WHEN (SELECT L3.NARR FROM ACCOUNTCURBFO.DBO.LEDGER3 L  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L.NARATNO = L3.NARATNO) IS  NOT NULL    
                 THEN (SELECT L3.NARR FROM ACCOUNTCURBFO.DBO.LEDGER3 L  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE  AND L.NARATNO = L3.NARATNO)     
                 ELSE (SELECT L3.NARR FROM ACCOUNTCURBFO.DBO.LEDGER3 L  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND  L3.NARATNO = 0 )     
                 END),'')    
FROM ACCOUNTCURBFO.DBO.LEDGER3 L3    
WHERE L3.VTYP = @VTYP  AND L3.VNO = @VNO    
AND L3.NARATNO = @LNO      
    
/* OLD    
SELECT BNKNAME, L.VTYP,L.VNO,L.LNO,L.DRCR, L.CLTCODE ,    
 NARR=ISNULL((CASE WHEN (SELECT L3.NARR FROM ACCOUNTCURBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L.LNO = L3.NARATNO) IS  NOT NULL    
                 THEN (SELECT L3.NARR FROM ACCOUNTCURBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE  AND L.LNO = L3.NARATNO)     
                 ELSE (SELECT L3.NARR FROM ACCOUNTCURBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND  L3.NARATNO = 0 )     
                 END),'')    
FROM ACCOUNTCURBFO.DBO.LEDGER L, ACCOUNTCURBFO.DBO.LEDGER1 L1    
WHERE L1.VTYP = @VTYP  AND L1.VNO = @VNO    
AND L1.LNO = @LNO  AND L1.DRCR = @DRCR    
AND L.VTYP='15' AND CLTCODE= @CLTCODE    
AND L.VTYP=L1.VTYP AND L.VNO = L1.VNO    
AND L.LNO = L1.LNO AND L.DRCR = L1.DRCR    
*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LISTCLIENT
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_LISTCLIENT] 
(      
	@STATUSID VARCHAR(15),      
	@STATUSNAME VARCHAR(25),      
	@PARTYCODE VARCHAR(15),      
	@TOPARTYCODE VARCHAR(15)      
) AS      

	SELECT
		PARTY_CODE
	FROM
		CLIENT1 (NOLOCK),
		CLIENT2 (NOLOCK)
	WHERE
		CLIENT1.CL_CODE = CLIENT2.CL_CODE
	        AND @STATUSNAME = (       
	        CASE       
	                WHEN @STATUSID = 'BRANCH'       
	                THEN BRANCH_CD       
	                WHEN @STATUSID = 'SUBBROKER'       
	                THEN SUB_BROKER       
	                WHEN @STATUSID = 'TRADER'       
	                THEN TRADER       
	                WHEN @STATUSID = 'FAMILY'       
	                THEN FAMILY       
	                WHEN @STATUSID = 'AREA'       
	                THEN AREA       
	                WHEN @STATUSID = 'REGION'       
	                THEN REGION       
	                WHEN @STATUSID = 'CLIENT'       
	  		THEN PARTY_CODE       
	                ELSE 'BROKER' END) 
		AND PARTY_CODE BETWEEN  @PARTYCODE AND @TOPARTYCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LISTCLIENTNAME
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[RPT_LISTCLIENTNAME]  
@STATUSID VARCHAR(15),  
@STATUSNAME VARCHAR(25),  
@PARTYNAME VARCHAR(50),  
@TOPARTYNAME VARCHAR(50)  
AS  
  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
  SELECT DISTINCT C2.PARTY_CODE, C1.LONG_NAME  
  FROM CLIENT1 C1 WITH(NOLOCK),   
       CLIENT2 C2 WITH(NOLOCK)   
  WHERE C2.CL_CODE = C1.CL_CODE   
        AND @STATUSNAME =   
                  (CASE   
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
                        WHEN @STATUSID = 'AREA' THEN C1.AREA  
                        WHEN @STATUSID = 'REGION' THEN C1.REGION  
                        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
                  ELSE   
                        'BROKER'  
                END)  
    AND C1.LONG_NAME BETWEEN LTRIM(RTRIM(@PARTYNAME))  AND LTRIM(RTRIM(@TOPARTYNAME))  
    ORDER BY C1.LONG_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LOGINACCESS
-- --------------------------------------------------
CREATE  PROCEDURE  [dbo].[RPT_LOGINACCESS]               
@FROMDATE AS VARCHAR(11),  
@TODATE AS VARCHAR(11),  
@REPORTTYPE VARCHAR(10),  
@SEARCHBY VARCHAR(10)  
  
  
AS      
SET @FROMDATE = CONVERT(VARCHAR,@FROMDATE,109)               
SET @TODATE = CONVERT(VARCHAR,@TODATE,109)       
            
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                  
    
IF @REPORTTYPE = 'SUCCESS'  
BEGIN   
 SELECT     
       
  L.USERID,     
  L.USERNAME,  
  C.FLDCATEGORYNAME,  
  L.STATUSNAME,  
  L.STATUSID,  
  L.IPADD,  
  L.ACTION,  
  ADDDT = CONVERT(VARCHAR,L.ADDDT,109)   
        
       
 FROM V2_LOGIN_LOG L(NOLOCK)    
    
       
 LEFT OUTER JOIN     
     TBLCATEGORY C(NOLOCK)       
     ON     
     (     
         L.CATEGORY = C.FLDCATEGORYCODE     
      )   
 WHERE    
  ADDDT >= @FROMDATE    
     AND ADDDT <= @TODATE + ' 23:59:59'    
  AND STATUSNAME = CASE WHEN @SEARCHBY ='ADMIN' THEN 'ADMIN' ELSE STATUSNAME END  
 ORDER BY ADDDT    
END  
ELSE  
BEGIN  
 SELECT LOGIN_ID,LOGIN_PWD,IPADD,ERR_TYPE,LOGIN_DT   
 FROM V2_LOGIN_ERR_LOG  
 WHERE LOGIN_DT BETWEEN @FROMDATE AND @TODATE + ' 23:59'  
 AND LOGIN_TYPE = @SEARCHBY  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LOGINCLIENT
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.RPT_LOGINCLIENT    SCRIPT DATE: 01/15/2005 5:25:57 PM ******/  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_LOGINCLIENT    SCRIPT DATE: 12/16/2003 2:37:02 PM ******/  
  
  
/****** OBJECT:  STORED PROCEDURE DBO.RPT_LOGINCLIENT    SCRIPT DATE: 10/17/02 1:53:09 PM ******/  
/*CREATED BY AMIT ON 06/08/2002 CLIENT DETAIL REPORT  */  
CREATE PROCEDURE [dbo].[RPT_LOGINCLIENT]   
@STATUSID VARCHAR(15),  
@STATUSNAME VARCHAR(25)  
AS  
IF @STATUSID='BROKER'  
  BEGIN  
    SELECT DISTINCT  PARTY_CODE  
    FROM CLIENT2  
    ORDER BY PARTY_CODE  
  END  
IF @STATUSID='BRANCH'  
  BEGIN  
    SELECT DISTINCT  C2.PARTY_CODE  
    FROM CLIENT2 C2, CLIENT1 C1, BRANCHES B  
    WHERE LTRIM(RTRIM(B.SHORT_NAME)) = LTRIM(RTRIM(C1.TRADER)) AND  
   C1.CL_CODE = C2.CL_CODE AND  
   LTRIM(RTRIM(B.BRANCH_CD)) = LTRIM(RTRIM(@STATUSNAME))   
    ORDER BY C2.PARTY_CODE  
  END    
IF @STATUSID='SUBBROKER'  
  BEGIN  
    SELECT DISTINCT  C2.PARTY_CODE  
    FROM CLIENT2 C2,CLIENT1 C1,SUBBROKERS SB  
    WHERE C1.CL_CODE = C2.CL_CODE AND  
   LTRIM(RTRIM(SB.SUB_BROKER)) = LTRIM(RTRIM(@STATUSNAME)) AND  
   LTRIM(RTRIM(SB.SUB_BROKER)) = LTRIM(RTRIM(C1.SUB_BROKER))    
   ORDER BY C2.PARTY_CODE  
  END   
IF @STATUSID='TRADER'  
  BEGIN  
    SELECT DISTINCT  C2.PARTY_CODE  
    FROM CLIENT2 C2, CLIENT1 C1  
    WHERE C1.CL_CODE = C2.CL_CODE AND LTRIM(RTRIM(C1.TRADER))  = LTRIM(RTRIM(@STATUSNAME))    
    ORDER BY C2.PARTY_CODE  
  END   
IF @STATUSID='CLIENT'  
  BEGIN  
    SELECT DISTINCT C2.PARTY_CODE  
    FROM CLIENT2 C2, CLIENT1 C1   
    WHERE C1.CL_CODE=C2.CL_CODE AND  
  C2.PARTY_CODE=@STATUSNAME   
 ORDER BY C2.PARTY_CODE  
  END  
IF @STATUSID='FAMILY'  
  BEGIN  
    SELECT DISTINCT C2.PARTY_CODE  
    FROM CLIENT2 C2, CLIENT1 C1  
    WHERE C1.CL_CODE = C2.CL_CODE AND LTRIM(RTRIM(C1.FAMILY))  = LTRIM(RTRIM(@STATUSNAME))  
    ORDER BY C2.PARTY_CODE  
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_LOGINCLIENTNAME
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_LOGINCLIENTNAME]  
@STATUSID VARCHAR(15),  
@STATUSNAME VARCHAR(25)  
  
AS  

  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
  SELECT DISTINCT C2.PARTY_CODE, C1.LONG_NAME  
  FROM CLIENT1 C1 WITH(NOLOCK),   
       CLIENT2 C2 WITH(NOLOCK)   
  WHERE C2.CL_CODE = C1.CL_CODE   
        AND @STATUSNAME =   
                  (CASE   
                        WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
                        WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
                        WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
                        WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
                        WHEN @STATUSID = 'AREA' THEN C1.AREA  
                        WHEN @STATUSID = 'REGION' THEN C1.REGION  
                        WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
                  ELSE   
                        'BROKER'  
                END)  
    --AND C1.LONG_NAME BETWEEN LTRIM(RTRIM(@PARTYNAME))  AND LTRIM(RTRIM(@TOPARTYNAME))  
    ORDER BY C1.LONG_NAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MARGIN_SHORTAGE_PENALTY
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_MARGIN_SHORTAGE_PENALTY]
(
	@STATUSID VARCHAR(15),      
	@STATUSNAME VARCHAR(25),
	@MARGIN_DATE_FROM VARCHAR(11),
	@MARGIN_DATE_TO VARCHAR(11),
	@PARTY_FROM VARCHAR(11),
	@PARTY_TO VARCHAR(11)
)
AS

IF @PARTY_TO = ''
BEGIN
	SET @PARTY_TO = 'ZZZZZZZZZ'
END

DECLARE @EXCHANGE VARCHAR(15)

SELECT TOP 1 @EXCHANGE = EXCHANGE +' - FUTURES' FROM FOGLOBALS (NOLOCK)

SELECT 
	MARGINDATE = CONVERT(VARCHAR,P.MARGIN_DATE,103),
	P.PARTY_CODE,LONG_NAME,SHORTAGE,PENALTY_PERC,PENALTY_AMT,
	DAYS_3_COUNT,MONTH_5_COUNT,
	SHORTAGE_COUNT = M.NCOUNT,
	LEDGER_POST_FLAG = CASE WHEN LEDGER_POST_FLAG = 0 THEN 'N' ELSE 'Y' END,
	MDAY = DAY(P.MARGIN_DATE),
	MMONTH = DAY(P.MARGIN_DATE),
	MYEAR = DAY(P.MARGIN_DATE),
	L_ADDRESS1 = ISNULL(L_ADDRESS1,''),
	L_ADDRESS2 = ISNULL(L_ADDRESS2,''),
	L_ADDRESS3 = ISNULL(L_ADDRESS3,''),
	L_CITY = ISNULL(L_CITY,''),
	L_ZIP = ISNULL(L_ZIP,''),
	L_STATE = ISNULL(L_STATE,''),
	L_NATION = ISNULL(L_NATION,''),
	PAN_GIR_NO = ISNULL(PAN_GIR_NO,''),
	EXCHANGE = @EXCHANGE	
FROM 
	FOMARGIN_PENALTY P (NOLOCK),
	CLIENT1 C1 (NOLOCK),
	CLIENT2 C2 (NOLOCK),
	FOMARGIN_PENALTY_POST_STAT L (NOLOCK),
	(
		SELECT PARTY_CODE, NCOUNT = COUNT(1) ,
		COUNTMONTH = MONTH(MARGIN_DATE)
		FROM FOMARGIN_PENALTY (NOLOCK) 
		WHERE MARGIN_DATE BETWEEN  LEFT(DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,MARGIN_DATE),0))+1,11) AND DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,MARGIN_DATE)+1,0))
		GROUP BY PARTY_CODE,MONTH(MARGIN_DATE)
	) M
WHERE 
	P.MARGIN_DATE = L.MARGIN_DATE
	AND COUNTMONTH = MONTH(P.MARGIN_DATE)
	AND P.PARTY_CODE = C2.PARTY_CODE
	AND C1.CL_CODE = C2.CL_CODE
	AND M.PARTY_CODE = P.PARTY_CODE
	AND L.MARGIN_DATE BETWEEN  @MARGIN_DATE_FROM AND @MARGIN_DATE_TO + ' 23:59'
	AND M.PARTY_CODE BETWEEN @PARTY_FROM AND @PARTY_TO
    AND @STATUSNAME = (       
    CASE       
            WHEN @STATUSID = 'BRANCH'       
            THEN C1.BRANCH_CD       
            WHEN @STATUSID = 'SUBBROKER'       
            THEN C1.SUB_BROKER       
            WHEN @STATUSID = 'TRADER'       
            THEN C1.TRADER       
            WHEN @STATUSID = 'FAMILY'       
            THEN C1.FAMILY       
            WHEN @STATUSID = 'AREA'       
            THEN C1.AREA       
            WHEN @STATUSID = 'REGION'       
            THEN C1.REGION       
            WHEN @STATUSID = 'CLIENT'       
			THEN C2.PARTY_CODE       
            ELSE 'BROKER' 
	END)       
ORDER BY 
	MDAY,MMONTH,MYEAR,
	PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MISSINGCLIENTINVBB
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_MISSINGCLIENTINVBB]
	(
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@FROMDATE VARCHAR(11),
	@FROMPARTY VARCHAR(15),
	@TOPARTY VARCHAR(15),
	@CLIENTTYPE VARCHAR(3),
	@FUTNRM INT,
	@FUTFINAL INT,
	@OPTNRM INT,
	@OPTFINAL INT
	)

	AS

	--EXEC RPT_MISSINGCLIENTINVBB 'BROKER','BROKER','JUN 12 2006','','ZZZZZZ','T',0,0,0,0

	IF @CLIENTTYPE = 'T'
	   BEGIN

		SET NOCOUNT ON
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
		SELECT 
			DISTINCT
			C2.PARTY_CODE,
			C1.LONG_NAME
		FROM
			CLIENT1 C1,
			CLIENT2 C2,
			CLIENT5 C5,
			FOSETTLEMENT S
		WHERE
			C1.CL_CODE = C2.CL_CODE
			AND C1.CL_CODE = C5.CL_CODE
			AND S.PARTY_CODE = C2.PARTY_CODE
			AND @STATUSNAME = (
			CASE
				WHEN @STATUSID = 'BRANCH'
				THEN C1.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER'
				THEN C1.SUB_BROKER
				WHEN @STATUSID = 'TRADER'
				THEN C1.TRADER
				WHEN @STATUSID = 'FAMILY'
				THEN C1.FAMILY
				WHEN @STATUSID = 'AREA'
				THEN C1.AREA
				WHEN @STATUSID = 'REGION'
				THEN C1.REGION
				WHEN @STATUSID = 'CLIENT'
				THEN C2.PARTY_CODE
				ELSE 'BROKER' END)
			
			AND C2.PARTY_CODE 
				NOT IN 
				(SELECT SP_PARTY_CODE 
					FROM SCHEME_MAPPING
					WHERE @FROMDATE BETWEEN 
					SP_DATE_FROM AND SP_DATE_TO
					AND (1 = (CASE WHEN SP_INST_TYPE = 'FUT' AND SP_TRD_TYPE = 'TRD' THEN @FUTNRM ELSE 0 END)
					OR 1 = (CASE WHEN SP_INST_TYPE = 'FUT' AND SP_TRD_TYPE = 'DEL' THEN @FUTFINAL ELSE 0 END)
					OR 1 = (CASE WHEN SP_INST_TYPE = 'OPT' AND SP_TRD_TYPE = 'TRD' THEN @OPTNRM ELSE 0 END)
					OR 1 = (CASE WHEN SP_INST_TYPE = 'OPT' AND SP_TRD_TYPE = 'DEL' THEN @OPTFINAL ELSE 0 END))
					)

			AND (1 = (CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'EA' THEN @FUTNRM ELSE 0 END)
			OR 1 = (CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' THEN @FUTFINAL ELSE 0 END)
			OR 1 = (CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'EA' THEN @OPTNRM ELSE 0 END)
			OR 1 = (CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART = 'EA' THEN @OPTFINAL ELSE 0 END))

			AND S.SAUDA_DATE LIKE @FROMDATE + '%'
			AND AUCTIONPART <> 'CA'

		ORDER BY
			C2.PARTY_CODE
	   END
	ELSE
	   BEGIN

		SET NOCOUNT ON
		SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
		SELECT 
			DISTINCT
			C2.PARTY_CODE,
			C1.LONG_NAME
		FROM
			CLIENT1 C1,
			CLIENT2 C2,
			CLIENT5 C5
		WHERE
			C1.CL_CODE = C2.CL_CODE
			AND C1.CL_CODE = C5.CL_CODE
			AND @STATUSNAME = (
			CASE
				WHEN @STATUSID = 'BRANCH'
				THEN C1.BRANCH_CD
				WHEN @STATUSID = 'SUBBROKER'
				THEN C1.SUB_BROKER
				WHEN @STATUSID = 'TRADER'
				THEN C1.TRADER
				WHEN @STATUSID = 'FAMILY'
				THEN C1.FAMILY
				WHEN @STATUSID = 'AREA'
				THEN C1.AREA
				WHEN @STATUSID = 'REGION'
				THEN C1.REGION
				WHEN @STATUSID = 'CLIENT'
				THEN C2.PARTY_CODE
				ELSE 'BROKER' END)
			AND C2.PARTY_CODE 
				NOT IN 
				(SELECT SP_PARTY_CODE 
					FROM SCHEME_MAPPING
					WHERE @FROMDATE BETWEEN 
					SP_DATE_FROM AND SP_DATE_TO)

			AND C5.ACTIVEFROM >=
				(CASE WHEN @CLIENTTYPE = 'A' 
					THEN @FROMDATE
					ELSE 'JAN  1 1900 23:59:59'
					END)

			AND C5.INACTIVEFROM <=
				(CASE WHEN @CLIENTTYPE = 'I' 
					THEN @FROMDATE
					ELSE 'DEC 31 2049 23:59:59'
					END)

		ORDER BY
			C2.PARTY_CODE
	   END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MULTIBANKID
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_MULTIBANKID]
(
	@PARTYFROM VARCHAR(20),  
	@PARTYTO VARCHAR(20),  
	@SORTBY VARCHAR(20)  
) 
AS  
IF @PARTYTO ='' BEGIN SET @PARTYTO ='ZZZZZZZ' END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
        
SELECT   
	STRORDER = CASE 
		WHEN @SORTBY= 1 THEN CLTCODE 
		WHEN @SORTBY= 2 THEN CHEQUENAME 
		WHEN @SORTBY= 3 THEN BANK_NAME 
		WHEN @SORTBY= 4 THEN BRANCH_NAME 
		END,

 	CLTCODE,
	CHEQUENAME,
	BANK_NAME,
	BRANCH_NAME,
	ACCTYPE,
	ACCNO,
	DEFAULTBANK = CASE WHEN DEFAULTBANK=1 THEN 'YES' ELSE '' END
FROM   
 	MULTIBANKID (NOLOCK) ,MSAJAG..POBANK P (NOLOCK)
WHERE   
	MULTIBANKID.BANKID=P.BANKID 
	AND CLTCODE BETWEEN @PARTYFROM AND @PARTYTO

ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_MULTIISIN
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_MULTIISIN]

	@SYM_FRM VARCHAR(12),
	@SYM_TO VARCHAR(12)

AS

IF @SYM_FRM = '' BEGIN SET @SYM_FRM = '0' END
IF @SYM_TO = '' BEGIN SET @SYM_TO = 'ZZZZZZZZ' END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT
  INST_TYPE,
  SYMBOL,
  ISIN,
  PERC,
  STATUS,
  EFFDATE = CONVERT(DATETIME,EFFDATE)
  

FROM 
   DELIVERY_MULTIISIN

WHERE
	SYMBOL BETWEEN @SYM_FRM AND @SYM_TO 

ORDER BY
   EFFDATE DESC,
   SYMBOL

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSEFO_STT_NEW
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[RPT_NSEFO_STT_NEW]      
 @DATEFROM VARCHAR(11),      
 @DATETO VARCHAR(20),      
 @PARTYFROM VARCHAR(10),      
 @PARTYTO VARCHAR(10),      
 @CONTNOFROM VARCHAR(15),      
 @CONTNOTO VARCHAR(15),        
 @STATUSID VARCHAR(15),        
 @STATUSNAME VARCHAR(25),      
 @STRBRANCH VARCHAR(12),        
 @STRBRANCHTO VARCHAR(12),        
 @STRSUBBROKFROM VARCHAR(12),        
 @STRSUBBROKTO VARCHAR(12),
 @RPTTYPE INT = 0	           
      
AS      
SET @DATEFROM = LTRIM(RTRIM(@DATEFROM)) + ' 00:00:00'        
SET @DATETO = LTRIM(RTRIM(@DATETO)) + ' 23:59:59'        
SET @PARTYFROM = LTRIM(RTRIM(@PARTYFROM))        
SET @PARTYTO = LTRIM(RTRIM(@PARTYTO))        
SET @CONTNOFROM = LTRIM(RTRIM(@CONTNOFROM))        
SET @CONTNOTO = LTRIM(RTRIM(@CONTNOTO))        
SET @STATUSID = LTRIM(RTRIM(@STATUSID))        
SET @STATUSNAME = LTRIM(RTRIM(@STATUSNAME))        
SET @STRBRANCH   = LTRIM(RTRIM(@STRBRANCH))        
SET @STRBRANCHTO   = LTRIM(RTRIM(@STRBRANCHTO))        
SET @STRSUBBROKFROM = LTRIM(RTRIM(@STRSUBBROKFROM))        
SET @STRSUBBROKTO = LTRIM(RTRIM(@STRSUBBROKTO))        
      
IF @PARTYTO =''    
        BEGIN    
                SET @PARTYTO = 'ZZZZZZZZZZZ'    
        END     
IF @CONTNOTO = ''    
        BEGIN    
                SET @CONTNOTO = '0'    
        END    
IF @CONTNOTO=''    
        BEGIN    
                SET @CONTNOTO = '99999999999'    
        END        
        
IF LEN(LTRIM(RTRIM(@STRBRANCHTO))) = ''         
BEGIN         
 SET @STRBRANCHTO = 'ZZZZZZZZZZZZ'         
END        
        
IF LEN(LTRIM(RTRIM(@STRSUBBROKTO))) = ''        
BEGIN         
 SET @STRSUBBROKTO = 'ZZZZZZZZZZZZ'         
END        
        
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED    
        
SELECT      
 COMPANY,ADDR1,ADDR2,CITY,ZIP,PHONE,'NSE' EXCHANGECODE,MEMBERCODE,          
 ST.PARTY_CODE,      
 C1.LONG_NAME,      
 C1.PAN_GIR_NO,      
 LEFT(ST.SAUDA_DATE,11) SAUDA_DATE,      
 ST.CONTRACTNO,      
 ISNULL(UC.MAPIDID,'') MAPIDID,      
 ST.INST_TYPE,      
 ST.OPTION_TYPE,      
 ST.SYMBOL,      
 LEFT(ST.EXPIRYDATE,11) EXPIRYDATE,      
 ST.STRIKE_PRICE,
 QTY = ST.SQTYTRD,
 ST.SAMTTRD,      
 ST.SSTTTRD,      
 ST.TOTALSTT,      
 BRANCH_CD,      
 SUB_BROKER,  
 L_ADDRESS1,  
 L_ADDRESS2,  
 L_ADDRESS3,  
 L_CITY,  
 L_STATE,  
 L_NATION,  
 L_ZIP,
 RECTYPE,
 ORDDATE = CONVERT(VARCHAR,SAUDA_DATE,112)  
INTO #STT        
FROM  
 FOOWNER (NOLOCK),  
 STT_CLIENTDETAIL ST (NOLOCK),   
 CLIENT1 C1 (NOLOCK),      
 CLIENT2 C2 LEFT OUTER JOIN UCC_CLIENT UC ON C2.PARTY_CODE = UC.PARTY_CODE      
WHERE       
    ST.PARTY_CODE = C2.PARTY_CODE       
    AND C1.CL_CODE = C2.CL_CODE      
    AND ST.SAUDA_DATE BETWEEN @DATEFROM  AND @DATETO  
    AND ST.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO      
    AND ST.CONTRACTNO >= @CONTNOFROM       
    AND ST.CONTRACTNO <= @CONTNOTO      
    AND C2.INSURANCE_CHRG = 1      
    AND BRANCH_CD >= @STRBRANCH AND  BRANCH_CD <= @STRBRANCHTO           
    AND SUB_BROKER >= @STRSUBBROKFROM  AND SUB_BROKER <= @STRSUBBROKTO          
    AND ST.TOTALSTT > 0      
    AND RECTYPE >= 30      
    AND @STATUSNAME = (     
        CASE     
                WHEN @STATUSID = 'BRANCH'     
                THEN C1.BRANCH_CD     
                WHEN @STATUSID = 'SUBBROKER'     
                THEN C1.SUB_BROKER     
                WHEN @STATUSID = 'TRADER'     
                THEN C1.TRADER     
                WHEN @STATUSID = 'FAMILY'     
                THEN C1.FAMILY     
                WHEN @STATUSID = 'AREA'     
                THEN C1.AREA     
                WHEN @STATUSID = 'REGION'     
                THEN C1.REGION     
                WHEN @STATUSID = 'CLIENT'     
          THEN C2.PARTY_CODE     
                ELSE 'BROKER' END)   
  
IF @RPTTYPE = 1
BEGIN
	SELECT
		COMPANY,
		ADDR1,
		ADDR2,
		CITY,
		ZIP,
		PHONE,
		EXCHANGECODE,
		MEMBERCODE,          
		PARTY_CODE,      
		LONG_NAME,      
		PAN_GIR_NO,      
		SAUDA_DATE,      
		CONTRACTNO,      
		MAPIDID,      
		INST_TYPE,      
		OPTION_TYPE,      
		SYMBOL,      
		EXPIRYDATE,      
		STRIKE_PRICE,
		QTY = SUM(QTY),
		SAMTTRD = SUM(SAMTTRD),      
		SSTTTRD = SUM(SSTTTRD),      
		TOTALSTT = SUM(TOTALSTT),      
		BRANCH_CD,      
		SUB_BROKER,  
		L_ADDRESS1,  
		L_ADDRESS2,  
		L_ADDRESS3,  
		L_CITY,  
		L_STATE,  
		L_NATION,  
		L_ZIP,
		RECTYPE,
		ORDDATE
	FROM
		#STT
	GROUP BY
		COMPANY,
		ADDR1,
		ADDR2,
		CITY,
		ZIP,
		PHONE,
		EXCHANGECODE,
		MEMBERCODE,          
		PARTY_CODE,      
		LONG_NAME,      
		PAN_GIR_NO,      
		SAUDA_DATE,      
		CONTRACTNO,      
		MAPIDID,      
		INST_TYPE,      
		OPTION_TYPE,      
		SYMBOL,      
		EXPIRYDATE,      
		STRIKE_PRICE,
		BRANCH_CD,      
		SUB_BROKER,  
		L_ADDRESS1,  
		L_ADDRESS2,  
		L_ADDRESS3,  
		L_CITY,  
		L_STATE,  
		L_NATION,  
		L_ZIP,
		RECTYPE,
		ORDDATE
	ORDER BY
		PARTY_CODE,ORDDATE,CONTRACTNO,SYMBOL,INST_TYPE,BRANCH_CD,SUB_BROKER

	DROP TABLE #STT  
END
ELSE
BEGIN
	SELECT SAUDA_DATE,PARTY_CODE,MAX(CONTRACTNO) AS CONTRACTNO INTO #CNO FROM #STT GROUP BY SAUDA_DATE,PARTY_CODE  
	UPDATE #STT SET CONTRACTNO = #CNO.CONTRACTNO FROM #CNO    
	WHERE #STT.SAUDA_DATE = #CNO.SAUDA_DATE AND #STT.PARTY_CODE = #CNO.PARTY_CODE  
	--SELECT * FROM #STT ORDER BY SAUDA_DATE,BRANCH_CD,SUB_BROKER,PARTY_CODE,CONTRACTNO    
	SELECT * FROM #STT ORDER BY PARTY_CODE,ORDDATE,CONTRACTNO,SYMBOL,INST_TYPE,BRANCH_CD,SUB_BROKER

	DROP TABLE #STT  
	DROP TABLE #CNO
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_OPENINGBAL_NEW
-- --------------------------------------------------
CREATE PROCEDURE  [dbo].[RPT_OPENINGBAL_NEW]    
@VDT VARCHAR(12),    
@PARTYCODE VARCHAR(10),    
@CLTYPE VARCHAR(3),    
@REPORTPARA VARCHAR(5)    
    
AS    
    
    
--*** RPT_OPENINGBAL ***--    
IF @REPORTPARA = '1'    
 BEGIN    
  SELECT VDT , VTYP,VNO,LNO,DRCR,    
  VAMT, BALAMT,VDESC,    
  NAR=ISNULL((CASE WHEN (SELECT L3.NARR FROM ACCOUNTCURBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L.LNO = L3.NARATNO) IS  NOT NULL    
                 THEN (SELECT L3.NARR FROM ACCOUNTCURBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE  AND L.LNO = L3.NARATNO)     
                 ELSE (SELECT L3.NARR FROM ACCOUNTCURBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L3.NARATNO=0 )     
                 END),''),    
  EDT, EDTDIFF=DATEDIFF(D, L.EDT , GETDATE() )     
  FROM ACCOUNTCURBFO.DBO. LEDGER L, ACCOUNTCURBFO.DBO.VMAST V    
  WHERE  VDT  LIKE  LTRIM(@VDT) + '%'  AND   VTYP='18'    
  AND CLTCODE = @PARTYCODE AND L.VTYP=V.VTYPE     
  ORDER BY VDT, DRCR,VTYP    
 END     
    
    
    
--*** RPT_OPENINGBALBR ***--    
IF @REPORTPARA = '2'    
 BEGIN    
  SELECT VDT , L.VTYP,L.VNO,L.LNO,L2.DRCR,    
  VAMT=CAMT, BALAMT,VDESC,    
  NAR=ISNULL((CASE WHEN (SELECT L3.NARR FROM  ACCOUNTCURBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L.LNO = L3.NARATNO) IS  NOT NULL    
                 THEN (SELECT L3.NARR FROM  ACCOUNTCURBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE  AND L.LNO = L3.NARATNO)     
                 ELSE (SELECT L3.NARR FROM  ACCOUNTCURBFO.DBO.LEDGER3 L3  WHERE L.VTYP = L3.VTYP AND L.VNO = L3.VNO AND L.BOOKTYPE = L3.BOOKTYPE AND L3.NARATNO=0 )     
                 END),''),    
  EDT, EDTDIFF=DATEDIFF(D, L.EDT , GETDATE() )     
  FROM  ACCOUNTCURBFO.DBO.LEDGER L,  ACCOUNTCURBFO.DBO.VMAST V,   ACCOUNTCURBFO.DBO.LEDGER2 L2,  ACCOUNTCURBFO.DBO.COSTMAST C ,  ACCOUNTCURBFO.DBO.CATEGORY CT    
  WHERE  VDT  LIKE  LTRIM(@VDT) + '%'  AND   VTYP='18'    
  AND L.CLTCODE = @PARTYCODE AND L.VTYP=V.VTYPE     
  AND L.VTYP=V.VTYPE AND    
  L2.VTYPE=L.VTYP AND    
  L2.VNO=L.VNO AND    
  L2.LNO=L.LNO AND    
  L2.BOOKTYPE=L.BOOKTYPE AND CT.CATEGORY='BRANCH'    
  AND C.COSTCODE=L2.COSTCODE     
  ORDER BY VDT, L2.DRCR,L.VTYP    
 END    
    
    
    
--*** RPT_FOMODCOLLATERAL2 ***--    
IF @REPORTPARA = '3' AND @CLTYPE = 'EXC'     
 BEGIN    
  SELECT C.PARTY_CODE, COLL_DATE= TRANS_DATE, CASH, NONCASH , CL_TYPE    
  FROM MSAJAG.DBO.COLLATERAL C, CLIENT1 C1, CLIENT2 C2    
  WHERE C.PARTY_CODE LIKE LTRIM(@PARTYCODE)+'%'     
  AND C.EXCHANGE = 'ACE'     
  AND C.SEGMENT = 'FUTURES'    
  AND C1.CL_TYPE = @CLTYPE    
  AND C1.CL_CODE = C2.CL_CODE    
  AND C.PARTY_CODE = C2.PARTY_CODE    
  AND LEFT(CONVERT(VARCHAR,TRANS_DATE,109),11) = @VDT    
 END     
ELSE IF @REPORTPARA = '3'   
 BEGIN    
  SELECT C.PARTY_CODE, COLL_DATE= TRANS_DATE , CASH, NONCASH , CL_TYPE    
  FROM MSAJAG.DBO.COLLATERAL C, CLIENT1 C1, CLIENT2 C2    
  WHERE C.PARTY_CODE LIKE LTRIM(@PARTYCODE)+'%'     
  AND C.EXCHANGE = 'ACE'     
  AND C.SEGMENT = 'FUTURES'    
  AND C1.CL_TYPE LIKE LTRIM(@CLTYPE)+'%'    
  AND C1.CL_TYPE <> 'EXC'    
  AND C1.CL_CODE = C2.CL_CODE    
  AND C.PARTY_CODE = C2.PARTY_CODE    
  AND LEFT(CONVERT(VARCHAR,TRANS_DATE,109),11) = @VDT    
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYDETDAILYNEW
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[RPT_PARTYDETDAILYNEW]
(
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@FPARTY VARCHAR(10),
	@TPARTY VARCHAR(10),
	@SAUDA VARCHAR(11),
	@BRANCHCD VARCHAR(10) ='%',
	@DIGIFLAG INT = 0  
)
AS

IF @BRANCHCD ='' BEGIN SET @BRANCHCD ='%' END
IF @TPARTY ='' BEGIN SET @TPARTY ='ZZZZZZZZZZ' END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 
	C2.PARTY_CODE,
	C2.CL_CODE,
	C2.EXCHANGE,
	C2.TRAN_CAT,
	C1.EMAIL,
	C1.RES_PHONE1,
	C1.SHORT_NAME,
	C1.L_ADDRESS1,
	C1.L_ADDRESS2,
	C1.L_ADDRESS3,
	C1.L_CITY,
	C1.L_ZIP,
	C1.FAMILY,
	C1.BRANCH_CD,
	C1.LONG_NAME,
	TRADER = ISNULL(C1.TRADER,''),
	PAN_GIR_NO
FROM
	CLIENT1 C1 (NOLOCK),
	CLIENT2 C2 (NOLOCK),
	(
		SELECT
			DISTINCT FOPDD_PARTY_CODE FROM FO_POS_DETAILS_DAS (NOLOCK)
		WHERE 
			FOPDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'
			AND FOPDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY
		
		UNION 
		
		SELECT
			DISTINCT FOTDD_PARTY_CODE FROM FO_TRADE_DETAILS_DAS  (NOLOCK)
		WHERE 
			FOTDD_SAUDA_DATE BETWEEN @SAUDA AND @SAUDA + ' 23:59'
			AND FOTDD_PARTY_CODE BETWEEN @FPARTY AND @TPARTY
	) F, 
	CLIENT_PRINT_SETTINGS CP (NOLOCK)  
WHERE
	F.FOPDD_PARTY_CODE = C2.PARTY_CODE     
	AND C1.CL_CODE = C2.CL_CODE
	AND C1.BRANCH_CD LIKE @BRANCHCD
	AND C2.PARTY_CODE BETWEEN @FPARTY AND @TPARTY
	AND C2.PRINTF = CP.PRINT_FLAG  
	AND CP.VALID_REPORT LIKE (
	CASE   
		WHEN @DIGIFLAG = 0 THEN '%'   
		WHEN @DIGIFLAG = 1 THEN '%CONTRACT%'   
		WHEN @DIGIFLAG = 2 THEN '%DIGITAL%'   
		ELSE CP.VALID_REPORT   
	END)
    AND @STATUSNAME = 
	( 
        CASE 
                WHEN @STATUSID = 'BRANCH' 
                THEN C1.BRANCH_CD 
                WHEN @STATUSID = 'SUBBROKER' 
                THEN C1.SUB_BROKER 
                WHEN @STATUSID = 'TRADER' 
                THEN C1.TRADER 
                WHEN @STATUSID = 'FAMILY' 
                THEN C1.FAMILY 
                WHEN @STATUSID = 'AREA' 
                THEN C1.AREA 
                WHEN @STATUSID = 'REGION' 
                THEN C1.REGION 
                WHEN @STATUSID = 'CLIENT' 
                THEN C2.PARTY_CODE 
                ELSE 'BROKER' END
	) 
ORDER BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PARTYMAPPING
-- --------------------------------------------------
CREATE    PROCEDURE [dbo].[RPT_PARTYMAPPING]
	@DATE VARCHAR(11),
	@ORDERTYPE VARCHAR(10),
	@RPTTYPE VARCHAR(10)

	AS
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF (@RPTTYPE = 'SUMMARY')
BEGIN
	SELECT
		RPTORDER = (CASE WHEN @ORDERTYPE = 'PARTY' 
				THEN PARTY_CODE
				ELSE CONTRACTNO
				END),	
		PARTY_CODE,
		CONTRACTNO,
		USER_ID,
		BRANCH_ID,
		SYMBOL,
		SELL_BUY,
		TRADEQTY = SUM(TRADEQTY),
		AVGRATE = SUM(PRICE * TRADEQTY)/SUM(TRADEQTY),
		INST_TYPE,
		STRIKE_PRICE,
		OPTION_TYPE,
		EXPIRYDATE = LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) 
	
	FROM
		FOSETTLEMENT  S (NOLOCK),
		CLIENT1 C1 (NOLOCK)
	WHERE 
		S.PARTY_CODE = C1.CL_CODE
		AND SAUDA_DATE LIKE @DATE +'%'
		AND TRADEQTY > 0
	
	GROUP BY
		PARTY_CODE,
		USER_ID,
		BRANCH_ID,
		CONTRACTNO,
		SYMBOL,
		SELL_BUY,
		INST_TYPE,
		STRIKE_PRICE,
		OPTION_TYPE,
		LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) 
		
	ORDER BY 
		CONTRACTNO, 
		PARTY_CODE,
		RPTORDER
	
END
ELSE
BEGIN
	SELECT
		RPTORDER = (CASE WHEN @ORDERTYPE = 'PARTY' 
				THEN PARTY_CODE
				ELSE CONTRACTNO
				END),	
		PARTY_CODE,
		CONTRACTNO,
		USER_ID,
		BRANCH_ID,
		SYMBOL,
		SELL_BUY,
		TRADEQTY = TRADEQTY,
		AVGRATE = PRICE,
		INST_TYPE,
		STRIKE_PRICE,
		OPTION_TYPE,
		EXPIRYDATE = LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) 
	
	FROM
		FOSETTLEMENT  S (NOLOCK),
		CLIENT1 C1 (NOLOCK)
	WHERE 
		S.PARTY_CODE = C1.CL_CODE
		AND SAUDA_DATE LIKE @DATE +'%'
		AND TRADEQTY > 0
	
	ORDER BY 
		CONTRACTNO, 
		PARTY_CODE,
		RPTORDER
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PODPBANK_DETAILS
-- --------------------------------------------------
CREATE  PROC [dbo].[RPT_PODPBANK_DETAILS]
	(
	@BANKTYPE VARCHAR(5)
	)

	AS

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	IF (@BANKTYPE = 'PO')
	BEGIN
		SELECT 
			DISTINCT 
			BANKID, 
			BANK_NAME, 
			BRANCH_NAME 
		FROM 
			POBANK (NOLOCK)
	END
	ELSE
	BEGIN
		SELECT 
			DISTINCT 
			BANKID, 
			BANKNAME, 
			BANKTYPE 
		FROM 
			BANK (NOLOCK)
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_CLIENT2_LOG
-- --------------------------------------------------
CREATE   PROCEDURE  
  
[dbo].[RPT_PROC_CLIENT2_LOG]  
  
@CL_CODE VARCHAR (10),  
@PARTY_CODE VARCHAR (10),  
  
@SCRIPT_NAME VARCHAR (500),  
@SESSION_ID VARCHAR (30),  
@LOCAL_ADDR VARCHAR (20),  
@REMOTE_ADDR VARCHAR (20),  
@REMOTE_HOST VARCHAR (50),  
--@REQUEST_METHOD VARCHAR (20),  
--@CONTENT_TYPE VARCHAR (50),  
--@CONTENT_LENGTH INT,  
@STATUS_NAME VARCHAR (50),  
@USER_NAME VARCHAR (100),  
--@MODULE VARCHAR (50),  
@ACTION VARCHAR (100)  
  
AS  
  
INSERT INTO  
 CLIENT2_LOG  
  SELECT  
   C2.CL_CODE,   
   C2.EXCHANGE,   
   C2.TRAN_CAT,   
   C2.SCRIP_CAT,   
   C2.PARTY_CODE,   
   C2.TABLE_NO,   
   C2.SUB_TABLENO,   
   C2.MARGIN,   
   C2.TURNOVER_TAX,   
   C2.SEBI_TURN_TAX,   
   C2.INSURANCE_CHRG,   
   C2.SERVICE_CHRG,   
   C2.STD_RATE,   
   C2.P_TO_P,   
   C2.EXPOSURE_LIM,   
   C2.DEMAT_TABLENO,   
   C2.BANKID,   
   C2.CLTDPNO,   
   C2.PRINTF,   
   C2.ALBMDELCHRG,   
   C2.ALBMDELIVERY,   
   C2.ALBMCF_TABLENO,   
   C2.MF_TABLENO,   
   C2.SB_TABLENO,   
   C2.BROK1_TABLENO,   
   C2.BROK2_TABLENO,   
   C2.BROK3_TABLENO,   
   C2.BROKERNOTE,   
   C2.OTHER_CHRG,   
   C2.BROK_SCHEME,   
   C2.CONTCHARGE,   
   C2.MINCONTAMT,   
   C2.ADDLEDGERBAL,   
   C2.DUMMY1,   
   C2.DUMMY2,   
   C2.INSCONT,   
   C2.SERTAXMETHOD,   
   C2.DUMMY6,   
   C2.DUMMY7,   
   C2.DUMMY8,   
   C2.DUMMY9,   
   C2.DUMMY10,   
   C5.ACTIVEFROM,   
   C5.INACTIVEFROM,   
   DPF.DEBITFLAG,   
   DPF.INTERFLAG,   
   @SCRIPT_NAME,   
   @SESSION_ID,   
   @LOCAL_ADDR,   
   @REMOTE_ADDR,   
   @REMOTE_HOST,   
--   @REQUEST_METHOD,   
--   @CONTENT_TYPE,   
--   @CONTENT_LENGTH,   
   @STATUS_NAME,   
   @USER_NAME,   
--   GETDATE(),   
   LEFT(CONVERT(VARCHAR, GETDATE(), 109), 50),   
--   @MODULE,   
   @ACTION   
  FROM  
   CLIENT2 C2, CLIENT5 C5, DELPARTYFLAG DPF  
  WHERE  
   C2.CL_CODE = C5.CL_CODE AND  
   C2.CL_CODE = DPF.PARTY_CODE AND  
   C2.CL_CODE = @CL_CODE AND   
   C2.PARTY_CODE = @PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWBILL
-- --------------------------------------------------
CREATE      PROC
[dbo].[RPT_PROC_FO_NEWBILL]

	@REPORTNAME VARCHAR(50),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@GROUPLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT
	@GROUPSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@ORDERLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@ORDERSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY

	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@WHATCODE VARCHAR(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FROMCODE VARCHAR(20),
	@TOCODE VARCHAR(20),

	@FROMPARTYCODE VARCHAR(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@TOPARTYCODE VARCHAR(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'

	@ONEORMANY VARCHAR(20),

	@INSTTYPE VARCHAR(20),		--]
	@OPTIONTYPE VARCHAR(20),	--]
	@STRIKEPRICE MONEY,		--]-->	PRIMARY SEARCH FIELDS.
	@EXPIRYDATE VARCHAR(11),	--]
	@SYMBOL VARCHAR(20),		--]

	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@EX_BILLTYPE VARCHAR(1),	--(SINGLE/MULTIPLE) - BILL						]
	@EX_AUCTIONPART VARCHAR(20),	--SAUDASUMMARY							]
	@EX_REPORTBY VARCHAR(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@EX_RATE VARCHAR(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@EX_MONEYTYPE VARCHAR(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@EX_POSITION VARCHAR (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS

	@WITHNETPOS VARCHAR(50),
	@DUMMY002 VARCHAR(50),
	@DUMMY003 VARCHAR(50),
	@DUMMY004 VARCHAR(50),
	@DUMMY005 VARCHAR(50),
	@DUMMY006 VARCHAR(50),
	@DUMMY007 VARCHAR(50),
	@DUMMY008 VARCHAR(50),
	@DUMMY009 VARCHAR(50),
	@DUMMY010 VARCHAR(50)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE

	@STRSELECT VARCHAR(8000),
	@STRSELECTTEMP VARCHAR(8000),
	@STRFROM VARCHAR(8000),
	@STRWHERE VARCHAR(8000),
	@STRGROUPBY VARCHAR(8000),
	@STRORDERBY VARCHAR(8000),
	@STRCOMPUTE VARCHAR(8000),
	@STRCOMPUTESUB VARCHAR(8000),

	@ISSUBLEVEL VARCHAR(3),
	@CODEID VARCHAR(20),
	@COMMA VARCHAR(1)

	SET @INSTTYPE = @INSTTYPE+"%" 
	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END
	--IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END
	
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END

	SET @STRSELECT = ''
	SET @STRSELECTTEMP = ''
	SET @STRFROM = ''

	SET @STRWHERE = ''
	SET @STRGROUPBY = ''
	SET @STRORDERBY = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTESUB = ''
	SET @ISSUBLEVEL = 'YES'

	IF (@REPORTNAME = 'BILL')
	BEGIN
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END
		
		SET @STRSELECT = @STRSELECT + "SELECT "
		SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "

		--@WHATCODE WILL ALWAYS BE 'CLIENT', AS THESE ARE THE DEFAULTS
		--PASSES FRM THE ASP PAGE.
		--THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP
		--STRUCTURE FOR ALL REPORTS
		IF ((@WHATCODE = 'CLIENT') AND (@ONEORMANY = 'SUMMARY'))
		BEGIN
			SET @STRSELECTTEMP = ''
			--@GROUPLEVEL/@SUBGROUPLEVEL WILL ALWAYS BE 'PARTY' AND 'CLIENT', AS THESE ARE THE DEFAULTS
			--PASSES FRM THE ASP PAGE.
			--THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP
			--STRUCTURE FOR ALL REPORTS
			--THE SUB LEVEL CONDITIONS, HOWEVER HAVE BEEN REMOVED.
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME, 25) AS PARTY_NAME, CLIENT_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "
			END

			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			SET @STRSELECTTEMP = ''

		END /*IF (@WHATCODE = 'CLIENT')*/

		--@EX_RATE AND @EX_REPORTBY WILL ALWAYS BE 'MKTRATE' AND 'PRICE', AS THESE ARE THE DEFAULTS
		--PASSES FRM THE ASP PAGE.
		--THE BELOW CONDITIONS CAN BE OMITTED, BUT R KEPT FOR THE SAKE OF A CONSISTANT SP
		--STRUCTURE FOR ALL REPORTS
		IF (@EX_RATE = 'MKTRATE')
		BEGIN
			IF (@EX_REPORTBY = 'PRICE')
			BEGIN
				--AMT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM((SBILLAMT - PBILLAMT) - ((SERVICE_TAX) + (TURN_TAX) + (SEBI_TAX) + (BROKER_NOTE) + "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " (INS_CHRG) + (OTHER_CHRG) + (CL_CHRG-EXCL_CHRG))) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ") /* AMT */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS BILLAMT "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
		END	/*IF (@EX_RATE = 'NETRATE')*/

		SET @STRFROM = @STRFROM + "FROM "
		SET @STRFROM = @STRFROM + "FOBILLVALAN (NOLOCK)"
	
		SET @STRWHERE = @STRWHERE + "WHERE "

		--SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "
		--SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "
		--IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END
		--SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "
		--SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "

		  IF (@FROMCODE = '' AND @TOCODE = '')      
		  BEGIN      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" + @CODEID + ",'') LIKE '%' AND "      
		  END      
		  ELSE      
		  BEGIN      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') >= '" + @FROMCODE + "' AND "      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') <= '" + @TOCODE + "' AND "      
		  END  

		IF (@FROMDATE = '' AND @TODATE = '')
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "
		END
		ELSE
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "
		END

		IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))
		BEGIN
			SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "
			SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "
		END

 /*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

/*END - LOGIN CONDITIONS*/


		SET @COMMA = ''


		SET @STRGROUPBY = @STRGROUPBY + @COMMA

		--AGAIN, THESE CONDITIONS CAN BE OMITTED, BUT R KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT	
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			--AGAIN, THIS CONDITION CAN BE OMITTED, BUT IS KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT	
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, LEFT(PARTY_NAME, 25), CLIENT_TYPE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE "
				--SET @COMMA = ', '
				--IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				--IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
				--IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END
			END
		END /*IF (@ONEORMANY = 'DETAIL')*/

		SET @STRORDERBY = @STRGROUPBY
		SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY
		SET @STRORDERBY = "ORDER BY " + @STRORDERBY

	END/*IF (@REPORTNAME = "NETPOSITION")*/


	PRINT 'REPORTNAME : ' + @REPORTNAME
	PRINT 'STATUSID : ' + @STATUSID
	PRINT 'STATUSNAME : ' + @STATUSNAME
	PRINT 'GROUPLEVEL : ' + @GROUPLEVEL
	PRINT 'GROUPSUBLEVEL : ' + @GROUPSUBLEVEL
	PRINT 'ORDERLEVEL : ' + @ORDERLEVEL
	PRINT 'ORDERSUBLEVEL : ' + @ORDERSUBLEVEL
	
	PRINT 'FROMDATE : ' + @FROMDATE
	PRINT 'TODATE : ' + @TODATE
	PRINT 'WHATCODE : ' + @WHATCODE
	PRINT 'FROMCODE : ' + @FROMCODE
	PRINT 'TOCODE : ' + @TOCODE
	
	PRINT 'INSTTYPE : ' + @INSTTYPE
	PRINT 'OPTIONTYPE : ' + @OPTIONTYPE
	PRINT 'STRIKEPRICE : ' + CONVERT(VARCHAR,@STRIKEPRICE)
	PRINT 'EXPIRYDATE : ' + @EXPIRYDATE
	PRINT 'SYMBOL : ' + @SYMBOL
	
	PRINT 'BILLTYPE : ' + @EX_BILLTYPE
	PRINT 'AUCTIONPART : ' + @EX_AUCTIONPART
	PRINT 'REPORTBY : ' + @EX_REPORTBY
	PRINT 'RATE : ' + @EX_RATE
	PRINT 'MONEYTYPE : ' + @EX_MONEYTYPE
	PRINT 'POSITION : ' + @EX_POSITION
	
	PRINT 'DUMMY001 : ' + @WITHNETPOS
	PRINT 'DUMMY002 : ' + @DUMMY002 

	PRINT 'DUMMY003 : ' + @DUMMY003
	PRINT 'DUMMY004 : ' + @DUMMY004
	PRINT 'DUMMY005 : ' + @DUMMY005
	PRINT 'DUMMY006 : ' + @DUMMY006
	PRINT 'DUMMY007 : ' + @DUMMY007
	PRINT 'DUMMY008 : ' + @DUMMY008
	PRINT 'DUMMY009 : ' + @DUMMY009
	PRINT 'DUMMY010 : ' + @DUMMY010

	PRINT '=============================================================================================='


	IF @STRCOMPUTESUB <> '' 
	BEGIN 
		SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB 
		SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB
	END

	IF (@ISSUBLEVEL = 'YES')
	BEGIN
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)
	END
	ELSE
	BEGIN
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)
	END

	PRINT @STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE

	PRINT @STRSELECT 
	PRINT @STRFROM
	PRINT @STRWHERE
	PRINT @STRGROUPBY
	PRINT @STRORDERBY
	PRINT @STRCOMPUTESUB
	PRINT @STRCOMPUTE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWBILLDETAIL
-- --------------------------------------------------
CREATE     PROC  
[dbo].[RPT_PROC_FO_NEWBILLDETAIL]  
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(50),  
 @FROMDATE VARCHAR(11),  
 @TODATE VARCHAR(11),  
 @FROMPARTYCODE VARCHAR(20),  
 @TOPARTYCODE VARCHAR(20),  
 @CLIENTTYPE VARCHAR (20),  
 @DUMMY001 VARCHAR(50),  
 @DUMMY002 VARCHAR(50),  
 @DUMMY003 VARCHAR(50),  
 @DUMMY004 VARCHAR(50),  
 @DUMMY005 VARCHAR(50),  
 @DUMMY006 VARCHAR(50),  
 @DUMMY007 VARCHAR(50),  
 @DUMMY008 VARCHAR(50),  
 @DUMMY009 VARCHAR(50),  
 @DUMMY010 VARCHAR(50)  
AS  

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


IF @CLIENTTYPE = '' BEGIN SET @CLIENTTYPE = '%' END  
IF @FROMPARTYCODE = '' BEGIN SET @FROMPARTYCODE = '%' END  
IF @TOPARTYCODE = '' BEGIN SET @TOPARTYCODE = '%' END  
IF (@FROMDATE = '' OR @TODATE = '')  
BEGIN   
 SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MIN(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN   
END  
IF (@FROMPARTYCODE = '' OR @TOPARTYCODE = '' OR @FROMPARTYCODE = '%' OR @TOPARTYCODE = '%')  
BEGIN   
 SELECT @FROMPARTYCODE = MIN(PARTY_CODE), @TOPARTYCODE = MAX(PARTY_CODE) FROM FOBILLVALAN   
END   
SELECT  
 LEFT(F.PARTY_NAME, 25) AS PARTY_NAME,  
 F.PARTY_CODE,   
 F.CLIENT_TYPE,   
 C1.L_ADDRESS1,   
 C1.L_ADDRESS2,  
  C1.L_ADDRESS3,      
  C1.L_CITY,     
  C1.L_STATE,     
  C1.L_NATION,     
  C1.L_ZIP,     
 C1.RES_PHONE1,  
 CASE WHEN LEN(C1.EMAIL) = 0 THEN '_' ELSE C1.EMAIL END AS EMAIL,  
 F.INST_TYPE,   
 F.SYMBOL,  
 CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,  
 F.STRIKE_PRICE,   
 CASE WHEN F.OPTION_TYPE = '' THEN '' ELSE F.OPTION_TYPE END AS OPTION_TYPE,  
 CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDADATE,  
 CL_RATE AS CLOSINGRATE,   

	CASE WHEN TRADETYPE = 'BF' 
	     THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) 
		       THEN CASE WHEN SUM(PQTY) > 0 
			         THEN SUM(PAMT)/SUM(PQTY) 
			         ELSE 0 
			    END 
		       ELSE 0 
		  END 
	     ELSE CASE WHEN SUM(PQTY) > 0 
		       THEN SUM((PRATE*PQTY+(PBROKAMT)))/SUM(PQTY) 
		       ELSE 0 
		  END 
	END AS PRATE,
	CASE WHEN TRADETYPE = 'BF' 
	     THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) 
	               THEN CASE WHEN SUM(SQTY) > 0 
				 THEN SUM(SAMT)/SUM(SQTY) 
				 ELSE 0 
			    END 
		       ELSE 0 
		  END 
	     ELSE CASE WHEN SUM(SQTY) > 0 
		       THEN SUM((SRATE*SQTY-(SBROKAMT)))/SUM(SQTY)
		       ELSE 0
		  END 
	END AS SRATE,

 CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN SUM(F.PQTY) - SUM(F.SQTY) ELSE 0 END ELSE SUM(F.PQTY) END AS PQTY,  
 CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN SUM(F.SQTY) - SUM(F.PQTY) ELSE 0 END ELSE SUM(F.SQTY) END AS SQTY,  
 CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END AS PBILLAMT,  
 CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END AS SBILLAMT,  
 SUM((F.PBILLAMT)) - SUM((F.SBILLAMT) ) AS DIFF,  
 SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) + (F.OTHER_CHRG)) ) AS CHRG_TOTAL,  
 SUM((F.PBILLAMT) + ((F.SERVICE_TAX - EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  ) AS FINALFIGURE,  
 SUM(((F.CL_CHRG - F.EXCL_CHRG)) ), /* CLEARING CHARGES */  
 SUM(((F.SERVICE_TAX - F.EXSER_TAX)) ), /* SERVICE TAX */  
 SUM(((F.SEBI_TAX)) ), /* SEBI TAX */  
 SUM(((F.TURN_TAX)) ), /* TURNOVER TAX */  
 SUM(((F.BROKER_NOTE)) ), /* STAMP DUTY */  
 SUM(((F.INS_CHRG)) ), /* INS CHARGES */  
 SUM(((F.OTHER_CHRG)) ), /* OTHERCHARGES */  
 CASE WHEN F.TRADETYPE = 'BF' THEN '<FONT STYLE="COLOR: #FF0000;">' + F.TRADETYPE + '</FONT>'   
               ELSE CASE WHEN AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%'   
           THEN '<FONT STYLE="COLOR:BLUE;">' + 'FF'  + '</FONT>'   
        ELSE CASE WHEN AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%'   
                                                     THEN '<FONT STYLE="COLOR:GREEN;">' + 'EA'  + '</FONT>'   
                           ELSE F.TRADETYPE   
                 END   
          END   
               END AS TRADETYPE,  
 F.TRADETYPE AS TRADETYPEPRINT  
FROM  
 FOBILLVALAN F (NOLOCK),   
 CLIENT1 C1 (NOLOCK),   
 CLIENT2 C2 (NOLOCK) 
WHERE  
	 C1.CL_CODE = C2.CL_CODE AND  
	 C2.PARTY_CODE = F.PARTY_CODE AND   
	 F.CLIENT_TYPE LIKE @CLIENTTYPE AND  
	 F.PARTY_CODE >= @FROMPARTYCODE AND  
	 F.PARTY_CODE <= @TOPARTYCODE AND  
	 F.SAUDA_DATE >= @FROMDATE + ' 00:00:00' AND  
	 F.SAUDA_DATE <= @TODATE + ' 23:59:59' AND  
	 F.TRADETYPE LIKE (CASE WHEN INST_TYPE LIKE 'OPT%' THEN 'BT' ELSE '%' END ) AND  
	@STATUSNAME = (CASE 	WHEN @STATUSID = 'BRANCH' THEN ISNULL(F.BRANCH_CODE,'')
				WHEN @STATUSID = 'SUBBROKER' THEN ISNULL(F.SUB_BROKER,'')
				WHEN @STATUSID = 'TRADER' THEN ISNULL(F.TRADER,'')
				WHEN @STATUSID = 'FAMILY' THEN ISNULL(F.FAMILY,'')
				WHEN @STATUSID = 'AREA' THEN ISNULL(F.AREA,'')
				WHEN @STATUSID = 'REGION' THEN ISNULL(F.REGION,'')
				WHEN @STATUSID = 'CLIENT' THEN ISNULL(F.PARTY_CODE,'')
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
			END)

GROUP BY   
 F.PARTY_CODE,   
 F.PARTY_NAME,   
 F.CLIENT_TYPE,   
 F.SYMBOL,   
 F.INST_TYPE,   
 F.EXPIRYDATE,   
 F.STRIKE_PRICE,   
 F.OPTION_TYPE,  
 C1.L_ADDRESS1,   
 C1.L_ADDRESS2,   
 F.TRADETYPE,   
 C1.RES_PHONE1,  
 F.SAUDA_DATE,  
 C1.EMAIL,  
 CL_RATE,  
 AUCTIONPART,  
  C1.L_ADDRESS3,      
  C1.L_CITY,     
  C1.L_STATE,     
  C1.L_NATION,     
  C1.L_ZIP  
  
HAVING CASE WHEN TRADETYPE = 'BF' THEN SUM(SQTY-PQTY) ELSE 1 END <> 0 

ORDER BY   
 F.PARTY_CODE,   
 F.PARTY_NAME,   
 F.CLIENT_TYPE,   
 F.SAUDA_DATE,  
 F.SYMBOL,   
 F.INST_TYPE,   
 F.EXPIRYDATE,   
 F.STRIKE_PRICE,   
 F.OPTION_TYPE,   
 F.TRADETYPE  
  
COMPUTE  
 SUM(CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END), /* PAMT */   
 SUM(CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END), /* SAMT */  
 SUM(SUM((F.PBILLAMT) ) - SUM((F.SBILLAMT) )),  /*DIFF = PAMT-SAMT*/  
 SUM(SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) + (F.OTHER_CHRG)) )), /* TOTAL OF CHARGES */  
 SUM(SUM((F.PBILLAMT) + ((F.SERVICE_TAX - EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  )), /* DIFF - TOTAL OF CHARGES */  
 SUM(SUM(((F.CL_CHRG - F.EXCL_CHRG)) )), /* TOTAL OF CLEARING CHARGES */  
 SUM(SUM(((F.SERVICE_TAX - F.EXSER_TAX)) )), /* TOTAL OF SERVICE TAX */  
 SUM(SUM(((F.SEBI_TAX)) )), /* TOTAL OF SEBI TAX */  
 SUM(SUM(((F.TURN_TAX)) )), /* TOTAL OF TURNOVER TAX */  
 SUM(SUM(((F.BROKER_NOTE)) )), /* TOTAL OF STAMP DUTY */  
 SUM(SUM(((F.INS_CHRG)) )), /* TOTAL OF INS CHARGES */  
 SUM(SUM(((F.OTHER_CHRG)) )) /* TOTAL OF OTHERCHARGES */  
 BY F.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWBILLDETAIL_NEW
-- --------------------------------------------------


CREATE   PROC  
[dbo].[RPT_PROC_FO_NEWBILLDETAIL_NEW]
 @STATUSID VARCHAR(20),  
 @STATUSNAME VARCHAR(50),
 @FROMDATE VARCHAR(11),
 @TODATE VARCHAR(11),
 @FROMPARTYCODE VARCHAR(20),
 @TOPARTYCODE VARCHAR(20),
 @CLIENTTYPE VARCHAR (20),
 @DUMMY001 VARCHAR(50),  
 @DUMMY002 VARCHAR(50),  
 @DUMMY003 VARCHAR(50),  
 @DUMMY004 VARCHAR(50),  
 @DUMMY005 VARCHAR(50),  
 @DUMMY006 VARCHAR(50),  
 @DUMMY007 VARCHAR(50),  
 @DUMMY008 VARCHAR(50),  
 @DUMMY009 VARCHAR(50),  
 @DUMMY010 VARCHAR(50)  

AS  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


IF @CLIENTTYPE = '' BEGIN SET @CLIENTTYPE = '%' END  
IF @FROMPARTYCODE = '' BEGIN SET @FROMPARTYCODE = '%' END  
IF @TOPARTYCODE = '' BEGIN SET @TOPARTYCODE = '%' END  
IF (@FROMDATE = '' OR @TODATE = '')  
BEGIN   
 SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MIN(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN   
END  
IF (@FROMPARTYCODE = '' OR @TOPARTYCODE = '' OR @FROMPARTYCODE = '%' OR @TOPARTYCODE = '%')  
BEGIN   
 SELECT @FROMPARTYCODE = MIN(PARTY_CODE), @TOPARTYCODE = MAX(PARTY_CODE) FROM FOBILLVALAN   
END   
SELECT  
 LEFT(F.PARTY_NAME, 25) AS PARTY_NAME,  
 F.PARTY_CODE,   
 F.CLIENT_TYPE,   
 C1.L_ADDRESS1,   
 C1.L_ADDRESS2,  
  C1.L_ADDRESS3,      
  C1.L_CITY,     
  C1.L_STATE,     
  C1.L_NATION,     
  C1.L_ZIP,     
 C1.RES_PHONE1,  
 CASE WHEN LEN(C1.EMAIL) = 0 THEN '_' ELSE C1.EMAIL END AS EMAIL,  
 F.INST_TYPE,   
 F.SYMBOL,  
 CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,  
 F.STRIKE_PRICE,   
 CASE WHEN F.OPTION_TYPE = '' THEN '' ELSE F.OPTION_TYPE END AS OPTION_TYPE,  
 CONVERT(VARCHAR, F.SAUDA_DATE, 103) AS SAUDADATE,  
 CL_RATE AS CLOSINGRATE,   

	CASE WHEN TRADETYPE = 'BF' 
	     THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) 
		       THEN CASE WHEN SUM(PQTY) > 0 
			         THEN SUM(PAMT)/SUM(PQTY) 
			         ELSE 0 
			    END 
		       ELSE 0 
		  END 
	     ELSE CASE WHEN SUM(PQTY) > 0 
		       THEN SUM((PRATE*PQTY+(PBROKAMT)))/SUM(PQTY) 
		       ELSE 0 
		  END 
	END AS PRATE,
	CASE WHEN TRADETYPE = 'BF' 
	     THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) 
	               THEN CASE WHEN SUM(SQTY) > 0 
				 THEN SUM(SAMT)/SUM(SQTY) 
				 ELSE 0 
			    END 
		       ELSE 0 
		  END 
	     ELSE CASE WHEN SUM(SQTY) > 0 
		       THEN SUM((SRATE*SQTY-(SBROKAMT)))/SUM(SQTY)
		       ELSE 0
		  END 
	END AS SRATE,

 CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN SUM(F.PQTY) - SUM(F.SQTY) ELSE 0 END ELSE SUM(F.PQTY) END AS PQTY,  
 CASE WHEN TRADETYPE = 'BF' THEN CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN SUM(F.SQTY) - SUM(F.PQTY) ELSE 0 END ELSE SUM(F.SQTY) END AS SQTY,  
 CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END AS PBILLAMT,  
 CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END AS SBILLAMT,  
 SUM((F.PBILLAMT)) - SUM((F.SBILLAMT) ) AS DIFF,  
 SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) + (F.OTHER_CHRG)) ) AS CHRG_TOTAL,  
 SUM((F.PBILLAMT) + ((F.SERVICE_TAX - EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  ) AS FINALFIGURE,  
 SUM(((F.CL_CHRG - F.EXCL_CHRG)) ), /* CLEARING CHARGES */  
 SUM(((F.SERVICE_TAX - F.EXSER_TAX)) ), /* SERVICE TAX */  
 SUM(((F.SEBI_TAX)) ), /* SEBI TAX */  
 SUM(((F.TURN_TAX)) ), /* TURNOVER TAX */  
 SUM(((F.BROKER_NOTE)) ), /* STAMP DUTY */  
 SUM(((F.INS_CHRG)) ), /* INS CHARGES */  
 SUM(((F.OTHER_CHRG)) ), /* OTHERCHARGES */  
 CASE WHEN F.TRADETYPE = 'BF' THEN '<FONT STYLE="COLOR: #FF0000;">' + F.TRADETYPE + '</FONT>'   
               ELSE CASE WHEN AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%'  
           THEN '<FONT STYLE="COLOR:BLUE;">' + 'FF'  + '</FONT>'   
        ELSE CASE WHEN AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%'   
                                                     THEN '<FONT STYLE="COLOR:GREEN;">' + 'EA'  + '</FONT>'   
                           ELSE F.TRADETYPE   
                 END   
          END   
               END AS TRADETYPE,  
 F.TRADETYPE AS TRADETYPEPRINT  
FROM  
 FOBILLVALAN F (NOLOCK),   
 CLIENT1 C1 (NOLOCK),   
 CLIENT2 C2 (NOLOCK) 
WHERE  
	 C1.CL_CODE = C2.CL_CODE AND  
	 C2.PARTY_CODE = F.PARTY_CODE AND   
	 F.CLIENT_TYPE LIKE @CLIENTTYPE AND  
	 F.PARTY_CODE >= @FROMPARTYCODE AND  
	 F.PARTY_CODE <= @TOPARTYCODE AND  
	 F.SAUDA_DATE >= @FROMDATE + ' 00:00:00' AND  
	 F.SAUDA_DATE <= @TODATE + ' 23:59:59' AND  
	 F.TRADETYPE LIKE (CASE WHEN INST_TYPE LIKE 'OPT%' THEN 'BT' ELSE '%' END ) AND  
	@STATUSNAME = (CASE 	WHEN @STATUSID = 'BRANCH' THEN ISNULL(F.BRANCH_CODE,'')
				WHEN @STATUSID = 'SUBBROKER' THEN ISNULL(F.SUB_BROKER,'')
				WHEN @STATUSID = 'TRADER' THEN ISNULL(F.TRADER,'')
				WHEN @STATUSID = 'FAMILY' THEN ISNULL(F.FAMILY,'')
				WHEN @STATUSID = 'AREA' THEN ISNULL(F.AREA,'')
				WHEN @STATUSID = 'REGION' THEN ISNULL(F.REGION,'')
				WHEN @STATUSID = 'CLIENT' THEN ISNULL(F.PARTY_CODE,'')
				WHEN @STATUSID = 'BROKER' THEN @STATUSNAME
			END)

GROUP BY   
 F.PARTY_CODE,   
 F.PARTY_NAME,   
 F.CLIENT_TYPE,   
 F.SYMBOL,   
 F.INST_TYPE,   
 F.EXPIRYDATE,   
 F.STRIKE_PRICE,   
 F.OPTION_TYPE,  
 C1.L_ADDRESS1,   
 C1.L_ADDRESS2,   
 F.TRADETYPE,   
 C1.RES_PHONE1,  
 F.SAUDA_DATE,  
 C1.EMAIL,  
 CL_RATE,  
 AUCTIONPART,  
  C1.L_ADDRESS3,      
  C1.L_CITY,     
  C1.L_STATE,     
  C1.L_NATION,     
  C1.L_ZIP  
  
HAVING CASE WHEN TRADETYPE = 'BF' THEN SUM(SQTY-PQTY) ELSE 1 END <> 0 

ORDER BY   
 F.PARTY_CODE,   
 F.PARTY_NAME,   
 F.CLIENT_TYPE,   
 F.SAUDA_DATE,  
 F.SYMBOL,   
 F.INST_TYPE,   
 F.EXPIRYDATE,   
 F.STRIKE_PRICE,   
 F.OPTION_TYPE,   
 F.TRADETYPE  
  
COMPUTE  
 SUM(CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END), /* PAMT */   
 SUM(CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END), /* SAMT */  
 SUM(SUM((F.PBILLAMT) ) - SUM((F.SBILLAMT) )),  /*DIFF = PAMT-SAMT*/  
 SUM(SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) + (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) + (F.OTHER_CHRG)) )), /* TOTAL OF CHARGES */  
 SUM(SUM((F.PBILLAMT) + ((F.SERVICE_TAX - EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) + (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) + (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  )), /* DIFF - TOTAL OF CHARGES */  
 SUM(SUM(((F.CL_CHRG - F.EXCL_CHRG)) )), /* TOTAL OF CLEARING CHARGES */  
 SUM(SUM(((F.SERVICE_TAX - F.EXSER_TAX)) )), /* TOTAL OF SERVICE TAX */  
 SUM(SUM(((F.SEBI_TAX)) )), /* TOTAL OF SEBI TAX */  
 SUM(SUM(((F.TURN_TAX)) )), /* TOTAL OF TURNOVER TAX */  
 SUM(SUM(((F.BROKER_NOTE)) )), /* TOTAL OF STAMP DUTY */  
 SUM(SUM(((F.INS_CHRG)) )), /* TOTAL OF INS CHARGES */  
 SUM(SUM(((F.OTHER_CHRG)) )) /* TOTAL OF OTHERCHARGES */  
 BY F.PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWCLIENTSUMMARY
-- --------------------------------------------------
CREATE PROC
[dbo].[RPT_PROC_FO_NEWCLIENTSUMMARY]
	@REPORTNAME VARCHAR(50),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@GROUPLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT
	@GROUPSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@ORDERLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@ORDERSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@WHATCODE VARCHAR(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FROMCODE VARCHAR(20),
	@TOCODE VARCHAR(20),
	@FROMPARTYCODE VARCHAR(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@TOPARTYCODE VARCHAR(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@ONEORMANY VARCHAR(20),
	@INSTTYPE VARCHAR(20),		--]
	@OPTIONTYPE VARCHAR(20),	--]
	@STRIKEPRICE MONEY,		--]-->	PRIMARY SEARCH FIELDS.
	@EXPIRYDATE VARCHAR(11),	--]
	@SYMBOL VARCHAR(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@EX_BILLTYPE VARCHAR(1),	--(SINGLE/MULTIPLE) - BILL						]
	@EX_AUCTIONPART VARCHAR(20),	--SAUDASUMMARY							]
	@EX_REPORTBY VARCHAR(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@EX_RATE VARCHAR(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@EX_MONEYTYPE VARCHAR(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@EX_POSITION VARCHAR (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@WITHNETPOS VARCHAR(50),
	@DUMMY002 VARCHAR(50),
	@DUMMY003 VARCHAR(50),
	@DUMMY004 VARCHAR(50),
	@DUMMY005 VARCHAR(50),
	@DUMMY006 VARCHAR(50),
	@DUMMY007 VARCHAR(50),
	@DUMMY008 VARCHAR(50),
	@DUMMY009 VARCHAR(50),
	@DUMMY010 VARCHAR(50)
AS


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE
	@STRSELECT VARCHAR(8000),
	@STRSELECTTEMP VARCHAR(8000),
	@STRFROM VARCHAR(8000),
	@STRWHERE VARCHAR(8000),
	@STRGROUPBY VARCHAR(8000),
	@STRORDERBY VARCHAR(8000),
	@STRCOMPUTE VARCHAR(8000),
	@STRCOMPUTESUB VARCHAR(8000),
	@ISSUBLEVEL VARCHAR(3),
	@CODEID VARCHAR(20),
	@COMMA VARCHAR(1)
	SET @INSTTYPE = @INSTTYPE+"%" 
	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END
	--IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END
	
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END
	SET @STRSELECT = ''
	SET @STRSELECTTEMP = ''
	SET @STRFROM = ''
	SET @STRWHERE = ''
	SET @STRGROUPBY = ''
	SET @STRORDERBY = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTESUB = ''
	SET @ISSUBLEVEL = 'NO'
	IF (@REPORTNAME = 'CLIENTSUMMARY')
	BEGIN
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END
		
		SET @STRSELECT = @STRSELECT + "SELECT "
		--@ONEORMANY AND @WHATCODE WILL ALWAYS BE 'SUMMARY' AND 'CLIENT', AS THESE ARE THE DEFAULTS
		--PASSES FRM THE ASP PAGE.
		--THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP
		--STRUCTURE FOR ALL REPORTS
		IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			SET @STRSELECTTEMP = ''
			--@GROUPLEVEL/@SUBGROUPLEVEL WILL ALWAYS BE 'PARTY' AND 'CLIENT', AS THESE ARE THE DEFAULTS
			--PASSES FRM THE ASP PAGE.
			--THE BELOW CONDITION CAN BE OMITTED, BUT IS KEPT FOR THE SAKE OF A CONSISTANT SP
			--STRUCTURE FOR ALL REPORTS
			--THE SUB LEVEL CONDITIONS, HOWEVER HAVE BEEN REMOVED.
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, PARTY_NAME AS PARTY_NAME, CLIENT_TYPE, EMAIL, "
			END
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			SET @STRSELECTTEMP = ''
		END /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))*/
		--@EX_RATE AND @EX_REPORTBY WILL ALWAYS BE 'MKTRATE' AND 'PRICE', AS THESE ARE THE DEFAULTS
		--PASSES FRM THE ASP PAGE.
		--THE BELOW CONDITIONS CAN BE OMITTED, BUT R KEPT FOR THE SAKE OF A CONSISTANT SP
		--STRUCTURE FOR ALL REPORTS
		IF (@EX_RATE = 'MKTRATE')
		BEGIN
			IF (@EX_REPORTBY = 'PRICE')
			BEGIN
				--DAILY MARK TO MARKET SETTLEMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'FUT%') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS DAILYMTOMSETTLEMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--FINAL FUTURES SETTLEMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS FINALFUTURESSETTLEMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--PREMIUM SETTLEMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%' AND TRADETYPE = 'BT') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PREMIUMSETTLEMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--OPTIONS EXERCISE/ASSIGNMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%' AND TRADETYPE = 'BT') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT + SBROKAMT + PBROKAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSEXERCISEASSIGNMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--BROKERAGE + ALL CHARGES EXCEPT CLEARING
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "-(SUM(PBROKAMT + SBROKAMT) + SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "+ SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS BROKANDMISC, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--CLEARING CHARGES
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "-(SUM(CL_CHRG) - SUM(EXCL_CHRG)) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLEARINGCHARGES "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
		END	/*IF (@EX_RATE = 'NETRATE')*/
		IF (@EX_RATE = 'NETRATE')
		BEGIN
			IF (@EX_REPORTBY = 'PRICE')
			BEGIN
				--DAILY MARK TO MARKET SETTLEMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'FUT%') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS DAILYMTOMSETTLEMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--FINAL FUTURES SETTLEMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS FINALFUTURESSETTLEMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--PREMIUM SETTLEMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%' AND TRADETYPE = 'BT') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PREMIUMSETTLEMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--OPTIONS EXERCISE/ASSIGNMENT
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%' AND TRADETYPE = 'BT') THEN "
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SBILLAMT - PBILLAMT ELSE 0 END) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSEXERCISEASSIGNMENT, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--BROKERAGE + ALL CHARGES EXCEPT CLEARING
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "-(SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "+ SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS BROKANDMISC, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--CLEARING CHARGES
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "-(SUM(CL_CHRG) - SUM(EXCL_CHRG)) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLEARINGCHARGES "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
		END	/*IF (@EX_RATE = 'NETRATE')*/
		SET @STRFROM = @STRFROM + "FROM "
		SET @STRFROM = @STRFROM + "FOBILLVALAN (NOLOCK)"
	
		SET @STRWHERE = @STRWHERE + "WHERE "
		--SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "
		--SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "
		--IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END
		--SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "
		--SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "
		  IF (@FROMCODE = '' AND @TOCODE = '')      
		  BEGIN      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" + @CODEID + ",'') LIKE '%' AND "      
		  END      
		  ELSE      
		  BEGIN      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') >= '" + @FROMCODE + "' AND "      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') <= '" + @TOCODE + "' AND "      
		  END  
		IF (@FROMDATE = '' AND @TODATE = '')
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "
		END
		ELSE
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "
		END
		IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))
		BEGIN
			SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "
			SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "
		END
 /*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

/*END - LOGIN CONDITIONS*/

		SET @COMMA = ''
		SET @STRGROUPBY = @STRGROUPBY + @COMMA
		--AGAIN, THESE CONDITIONS CAN BE OMITTED, BUT R KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT	
		IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			--AGAIN, THIS CONDITION CAN BE OMITTED, BUT IS KEPT FOR REASONS SPECIFIED IN AN EARLIER COMMENT	
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
				IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END
			END
		END /*IF (@ONEORMANY = 'DETAIL')*/
		SET @STRORDERBY = @STRGROUPBY
		SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY
		SET @STRORDERBY = "ORDER BY " + @STRORDERBY
	END/*IF (@REPORTNAME = "NETPOSITION")*/
	PRINT 'REPORTNAME : ' + @REPORTNAME
	PRINT 'STATUSID : ' + @STATUSID
	PRINT 'STATUSNAME : ' + @STATUSNAME
	PRINT 'GROUPLEVEL : ' + @GROUPLEVEL
	PRINT 'GROUPSUBLEVEL : ' + @GROUPSUBLEVEL
	PRINT 'ORDERLEVEL : ' + @ORDERLEVEL
	PRINT 'ORDERSUBLEVEL : ' + @ORDERSUBLEVEL
	
	PRINT 'FROMDATE : ' + @FROMDATE
	PRINT 'TODATE : ' + @TODATE
	PRINT 'WHATCODE : ' + @WHATCODE
	PRINT 'FROMCODE : ' + @FROMCODE
	PRINT 'TOCODE : ' + @TOCODE
	
	PRINT 'INSTTYPE : ' + @INSTTYPE
	PRINT 'OPTIONTYPE : ' + @OPTIONTYPE
	PRINT 'STRIKEPRICE : ' + CONVERT(VARCHAR,@STRIKEPRICE)
	PRINT 'EXPIRYDATE : ' + @EXPIRYDATE
	PRINT 'SYMBOL : ' + @SYMBOL
	
	PRINT 'BILLTYPE : ' + @EX_BILLTYPE
	PRINT 'AUCTIONPART : ' + @EX_AUCTIONPART
	PRINT 'REPORTBY : ' + @EX_REPORTBY
	PRINT 'RATE : ' + @EX_RATE
	PRINT 'MONEYTYPE : ' + @EX_MONEYTYPE
	PRINT 'POSITION : ' + @EX_POSITION
	
	PRINT 'DUMMY001 : ' + @WITHNETPOS
	PRINT 'DUMMY002 : ' + @DUMMY002 
	PRINT 'DUMMY003 : ' + @DUMMY003
	PRINT 'DUMMY004 : ' + @DUMMY004
	PRINT 'DUMMY005 : ' + @DUMMY005
	PRINT 'DUMMY006 : ' + @DUMMY006
	PRINT 'DUMMY007 : ' + @DUMMY007
	PRINT 'DUMMY008 : ' + @DUMMY008
	PRINT 'DUMMY009 : ' + @DUMMY009
	PRINT 'DUMMY010 : ' + @DUMMY010
	PRINT '=============================================================================================='
	IF @STRCOMPUTESUB <> '' 
	BEGIN 
		SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB 
		SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB
	END
	IF (@ISSUBLEVEL = 'YES')
	BEGIN
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)
	END
	ELSE
	BEGIN
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)
	END
	PRINT @STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE
	PRINT @STRSELECT 
	PRINT @STRFROM
	PRINT @STRWHERE
	PRINT @STRGROUPBY
	PRINT @STRORDERBY
	PRINT @STRCOMPUTESUB
	PRINT @STRCOMPUTE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWCLIENTSUMMARY_LEDGER
-- --------------------------------------------------

CREATE PROCEDURE [RPT_PROC_FO_NEWCLIENTSUMMARY_LEDGER]
	@PARTY_CODE [varchar](10),
	@RPTDATE [varchar](11),
	@EXCHANGE [varchar](3),
	@SEGMENT [varchar](10)
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
DECLARE       
@OPENBALANCE   MONEY,      
@LEDBALANCE   MONEY,      
@PAYREC       MONEY,      
@MINLEDBAL   MONEY,      
@MINMARGIN   MONEY,      
@MARGIN          MONEY,      
@AVLCOLL      MONEY,      
@SPANMAR      MONEY,      
@VARMARGIN       MONEY,      
@TOTCASH     MONEY,      
@TOTNONCASH      MONEY,      
@TOTCOLL  MONEY,      
@EFFCOLL    MONEY,      
@SPREADMARGIN MONEY,      
@NONSPREADMARGIN MONEY,      
@MTOMMARGIN MONEY,      
@MARGINPER MONEY,  
@EFFNONCASH	MONEY,
@DATACUR   CURSOR      
      
      
SET @LEDBALANCE   = 0       
SET @PAYREC       = 0       
SET @MINLEDBAL = 0      
SET @AVLCOLL      = 0       
SET @SPANMAR      = 0       
SET @VARMARGIN       = 0       
SET @TOTCASH       = 0       
SET @TOTNONCASH      = 0       
SET @TOTCOLL    = 0       
SET @EFFCOLL      = 0       
SET @MINMARGIN = 0      
SET @EFFNONCASH	= 0   
      
/* LEDGER BALANCE */      
SELECT @LEDBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)      
FROM ACCOUNTCURBFO..LEDGER L  (NOLOCK) , ACCOUNTCURBFO..PARAMETER P  (NOLOCK)      
WHERE VDT < @RPTDATE AND VDT >= SDTCUR AND VDT<= LDTCUR      
AND CLTCODE = @PARTY_CODE AND @RPTDATE BETWEEN SDTCUR AND LDTCUR       
      
/* OPEN BALANCE */      
SELECT @OPENBALANCE = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)      
FROM ACCOUNTCURBFO..LEDGER L    (NOLOCK)    
WHERE VDT LIKE @RPTDATE + '%' AND VTYP = 18 AND CLTCODE = @PARTY_CODE       
      
SELECT @LEDBALANCE = @LEDBALANCE + @OPENBALANCE      
      
/* PAYMENT RECEIVED FOR THE DAY */      
SELECT @PAYREC = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN VAMT ELSE -VAMT END),0)      
FROM ACCOUNTCURBFO..LEDGER L  (NOLOCK)  WHERE VDT LIKE @RPTDATE + '%' AND CLTCODE = @PARTY_CODE       
AND VTYP NOT IN (15,18)      
      
/* MARGIN AMOUNT */      
SELECT @MARGIN = ISNULL(SUM(CASE WHEN L.DRCR = 'C' THEN AMOUNT ELSE -AMOUNT END),0)      
FROM ACCOUNTCURBFO..MARGINLEDGER L  (NOLOCK) , ACCOUNTCURBFO..PARAMETER P  (NOLOCK)  WHERE VDT <= @RPTDATE + ' 23:59' AND PARTY_CODE = @PARTY_CODE       
AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND VDT < @RPTDATE AND VDT >= SDTCUR AND CURYEAR = 1       
      
/* SPAN AND VAR MARGIN */      
SELECT @SPANMAR = -ISNULL(SUM(TOTAL_MARGIN),0) , @VARMARGIN = -ISNULL(SUM(EXTREME_LOSS_MARGIN),0) , 
@SPREADMARGIN = -ISNULL(SUM(TOTAL_MARGIN),0)--, @NONSPREADMARGIN = -ISNULL(SUM(NONSPREADMARGIN),0)
,@MTOMMARGIN = -ISNULL(SUM(EXTREME_LOSS_MARGIN),0) FROM FOMARGINNEW       
WHERE MDATE LIKE @RPTDATE + '%' AND PARTY_CODE = @PARTY_CODE AND CLIENT_TYPE LIKE  'C%'       
      
/* COLLATERAL DETAILS */      
SELECT @TOTCASH = ISNULL(SUM(CASH),0), @TOTNONCASH = ISNULL(SUM(NONCASH),0), @TOTCOLL = ISNULL(SUM(CASH),0) + ISNULL(SUM(NONCASH),0),       
@EFFCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), @AVLCOLL = ISNULL(SUM(ACTUALCASH),0) + ISNULL(SUM(ACTUALNONCASH),0), 
@EFFNONCASH = ISNULL(SUM(ACTUALNONCASH),0)
FROM MSAJAG..COLLATERAL       
WHERE PARTY_CODE = @PARTY_CODE AND TRANS_DATE LIKE @RPTDATE + '%' AND EXCHANGE = @EXCHANGE      
AND SEGMENT = @SEGMENT       
      
SELECT @MARGINPER = 0  
  
/*  
SELECT @MARGINPER = MARGIN_PERCENT FROM FOMARGINPERCENT   
WHERE PARTY_CODE = @PARTY_CODE AND EFFECTIVE_DATEFROM =   
( SELECT MAX(EFFECTIVE_DATEFROM) FROM FOMARGINPERCENT   
WHERE PARTY_CODE = @PARTY_CODE AND EFFECTIVE_DATEFROM <= @RPTDATE )  
*/  
  
IF @MARGINPER = 0 OR @MARGINPER IS NULL        
 SELECT @MARGINPER = 100        
        
SELECT         
PARTY_CODE              = @PARTY_CODE,        
MARGINDATE                = @RPTDATE,         
LEDBALANCE  = @LEDBALANCE,        
PAYREC   = @PAYREC,        
MINLEDBAL         = @MINLEDBAL,        
MINMARGIN        = @SPREADMARGIN + ISNULL(@NONSPREADMARGIN,0) + @VARMARGIN,        
MARGIN              = @MARGIN,        
AVLCOLL  = @AVLCOLL,        
SPANMAR  = ISNULL(@SPANMAR,0),        
VARMARGIN   = 0,        
TOTCASH  = @TOTCASH,        
TOTCOLLNONCASH        = @TOTNONCASH,        
TOTNONCASH  = @TOTNONCASH,        
TOTCOLL  = @TOTCOLL,        
EFFCOLL  = CASE WHEN @LEDBALANCE + @PAYREC + @TOTCASH > ABS((@SPREADMARGIN+@VARMARGIN)*@MARGINPER/100)          
    THEN CASE WHEN @TOTNONCASH > @LEDBALANCE + @PAYREC + @TOTCASH        
          THEN @LEDBALANCE + @TOTCASH        
          ELSE @TOTNONCASH         
             END        
    ELSE        
            CASE WHEN @TOTNONCASH > ABS((@SPREADMARGIN+@VARMARGIN)*@MARGINPER/100)          
                     THEN ABS((@SPREADMARGIN+@VARMARGIN)*@MARGINPER/100)          
          ELSE @TOTNONCASH         
             END         
        END + @TOTCASH ,        
SPREADMARGIN  = ISNULL(@SPREADMARGIN,0),
NONSPREADMARGIN = ISNULL(@NONSPREADMARGIN,0),
MTOMMARGIN	= ISNULL(@MTOMMARGIN,0),
EFFNONCASH 	= ISNULL(@EFFNONCASH,0)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWCLIENTSUMMARY_NETPOS
-- --------------------------------------------------
CREATE  PROC
[dbo].[RPT_PROC_FO_NEWCLIENTSUMMARY_NETPOS]
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@SAUDADATE VARCHAR(11),
	@PARTYCODE VARCHAR(20),
	@DUMMY001 VARCHAR(50),
	@DUMMY002 VARCHAR(50),
	@DUMMY003 VARCHAR(50),
	@DUMMY004 VARCHAR(50),
	@DUMMY005 VARCHAR(50)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	SELECT
		INST_TYPE, SYMBOL, 
		LEFT(EXPIRYDATE,11) AS EXPIRYDATE, 
		STRIKE_PRICE, 
		OPTION_TYPE, 
		SUM(PQTY-SQTY) AS OPENPOSITION,
		SUM(SBILLAMT-PBILLAMT) - (SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG))  AS PROFITORLOSS
	FROM
		FOBILLVALAN (NOLOCK)
	WHERE
		PARTY_CODE = @PARTYCODE AND
		SAUDA_DATE LIKE @SAUDADATE + '%'
	GROUP BY
		INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE			
	HAVING SUM(PQTY-SQTY) <> 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWINTHEMONEY
-- --------------------------------------------------
CREATE   PROC
[dbo].[RPT_PROC_FO_NEWINTHEMONEY]
	@REPORTNAME VARCHAR(50),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@GROUPLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT
	@GROUPSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@ORDERLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@ORDERSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@WHATCODE VARCHAR(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FROMCODE VARCHAR(20),
	@TOCODE VARCHAR(20),
	@FROMPARTYCODE VARCHAR(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@TOPARTYCODE VARCHAR(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@ONEORMANY VARCHAR(20),
	@INSTTYPE VARCHAR(20),		--]
	@OPTIONTYPE VARCHAR(20),	--]
	@STRIKEPRICE MONEY,		--]-->	PRIMARY SEARCH FIELDS.
	@EXPIRYDATE VARCHAR(11),	--]
	@SYMBOL VARCHAR(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@EX_BILLTYPE VARCHAR(1),	--(SINGLE/MULTIPLE) - BILL						]
	@EX_AUCTIONPART VARCHAR(20),	--SAUDASUMMARY							]
	@EX_REPORTBY VARCHAR(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@EX_RATE VARCHAR(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@EX_MONEYTYPE VARCHAR(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@EX_POSITION VARCHAR (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@DUMMY001 VARCHAR(50),
	@DUMMY002 VARCHAR(50),
	@DUMMY003 VARCHAR(50),
	@DUMMY004 VARCHAR(50),
	@DUMMY005 VARCHAR(50),
	@DUMMY006 VARCHAR(50),
	@DUMMY007 VARCHAR(50),
	@DUMMY008 VARCHAR(50),
	@DUMMY009 VARCHAR(50),
	@DUMMY010 VARCHAR(50)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE
	@STRSELECT VARCHAR(8000),
	@STRSELECTTEMP VARCHAR(8000),
	@STRFROM VARCHAR(8000),
	@STRWHERE VARCHAR(8000),
	@STRGROUPBY VARCHAR(8000),
	@STRORDERBY VARCHAR(8000),
	@STRCOMPUTE VARCHAR(8000),
	@STRCOMPUTESUB VARCHAR(8000),
	@ISSUBLEVEL VARCHAR(3),
	@CODEID VARCHAR(20),
	@COMMA VARCHAR(1)
	SET @INSTTYPE = @INSTTYPE+"%" 
	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END
	--IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END
	
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END
	SET @STRSELECT = ''
	SET @STRSELECTTEMP = ''
	SET @STRFROM = ''
	SET @STRWHERE = ''
	SET @STRGROUPBY = ''
	SET @STRORDERBY = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTESUB = ''
	SET @ISSUBLEVEL = 'NO'
	IF (@FROMDATE = '' AND @TODATE = '')
	BEGIN 
		SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MIN(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN 
	END 
	IF (@REPORTNAME = 'INTHEMONEY')
	BEGIN
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END
		IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END
		IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END
		IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END
		IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END
		IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END
		
		SET @STRSELECT = @STRSELECT + "SELECT "
		SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "
		IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			SET @STRSELECTTEMP = ''
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "
				IF (@GROUPSUBLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'DATE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'INSTTYPE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "
				END
			END
			IF (@GROUPLEVEL = 'SCRIP')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
				IF (@GROUPSUBLEVEL = 'PARTY')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'DATE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'INSTTYPE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "
				END
			END
	
			IF (@GROUPLEVEL = 'DATE')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
				IF (@GROUPSUBLEVEL = 'PARTY')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'INSTTYPE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SAUDA_DATE "
				END
			END
	
			IF (@GROUPLEVEL = 'INSTTYPE')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
				IF (@GROUPSUBLEVEL = 'PARTY')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'DATE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "INST_TYPE "
				END
			END
	
			IF (@GROUPLEVEL = 'PSD')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "OPTION_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
				SET @ISSUBLEVEL = 'YES'
			END
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			SET @STRSELECTTEMP = ''
		END /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
		ELSE /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
		BEGIN /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
			IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, LEFT(PARTY_NAME,25) AS PARTY_NAME, CLIENT_TYPE, EMAIL, " END
			IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + "REGION, " END
			IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + "AREA, " END
			IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + "BRANCH_CODE, " END
			IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + "SUB_BROKER, " END
			IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + "TRADER, " END
			IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + "FAMILY, LEFT(FAMILYNAME,25) AS FAMILYNAME, " END
		END /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
		
		IF (@EX_RATE = 'MKTRATE')
		BEGIN
			--IF (@EX_REPORTBY = 'BOTH') ARE OMITED
			IF (@EX_REPORTBY = 'PRICE')
			BEGIN
				--PQTY
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(PQTY) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* P.QTY */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		
				--SQTY
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(SQTY) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* S.QTY */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--NETQTY
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NETQTY */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--CLOSING RATE
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CMCLOSING) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* CLOSING RATE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSINGRATE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--NET RATE
				--SET @STRSELECTTEMP = ''
				--SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(PRATE*PQTY) - SUM(SRATE*SQTY)) "
				--SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET RATE */ "	--FOR THE SUB TOTAL
				--SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETRATE, "
				--SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--NET RATE
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + " (ABS(SUM((CMCLOSING-STRIKE_PRICE)))) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* NET RATE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETRATE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--SETTLEMENT AMT.
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + " (ABS(SUM((CMCLOSING-STRIKE_PRICE))) * (SUM(PQTY) - SUM(SQTY))) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ") /* SETTLEMENT AMT. */ "	--FOR THE SUB TOTAL - LAST ONE W/O THE COMMA
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SETTLEMENTAMT "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
		END	/*IF (@EX_RATE = 'NETRATE')*/	
		SET @STRSELECTTEMP = ""
		
		SET @STRFROM = @STRFROM + "FROM "
		SET @STRFROM = @STRFROM + "FOBILLVALAN (NOLOCK)"
	
		SET @STRWHERE = @STRWHERE + "WHERE "
	
		/* MONEY TYPE OPTIONS */
		IF (@EX_MONEYTYPE = "I")
		BEGIN
			SET @STRWHERE = @STRWHERE + "CONVERT(MONEY, CMCLOSING) > CONVERT(MONEY, STRIKE_PRICE) AND "
		END
		IF (@EX_MONEYTYPE = "O")
		BEGIN
			SET @STRWHERE = @STRWHERE + "CONVERT(MONEY, CMCLOSING) < CONVERT(MONEY, STRIKE_PRICE) AND "
		END
		IF (@EX_MONEYTYPE = "A")
		BEGIN
			SET @STRWHERE = @STRWHERE + "CONVERT(MONEY, CMCLOSING) = CONVERT(MONEY, STRIKE_PRICE) AND "
		END
		/* END MONEY TYPE OPTIONS */
		/* POSITION TYPE OPTIONS */
		IF (@EX_POSITION = "L")
		BEGIN
			SET @STRWHERE = @STRWHERE + "PQTY > 0 AND SQTY = 0 AND "
		END
		IF (@EX_POSITION = "S")
		BEGIN
			SET @STRWHERE = @STRWHERE + "SQTY > 0 AND PQTY = 0 AND "
		END
		/* END POSITION TYPE OPTIONS */
		SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "
		SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "
		IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END
		SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "
		SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND /*EXPIRYDATE >= GETDATE() AND*/ "
		IF (@FROMCODE = '' AND @TOCODE = '')
		BEGIN
			SET @STRWHERE = @STRWHERE + " ISNULL('" + @CODEID + "','') LIKE '%' AND "
		END
		ELSE
		BEGIN
			SET @STRWHERE = @STRWHERE + " ISNULL('" + @CODEID + "','') >= '" + @FROMCODE + "' AND "
			SET @STRWHERE = @STRWHERE + " ISNULL('" + @CODEID + "','') <= '" + @TOCODE + "' AND "
		END
		IF (@FROMDATE = '' AND @TODATE = '')
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "
		END
		ELSE
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "
		END
		IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))
		BEGIN
			SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "
			SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "
		END
 /*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

/*END - LOGIN CONDITIONS*/

		SET @COMMA = ''
		SET @STRGROUPBY = @STRGROUPBY + @COMMA
		
		IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
				IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END
			END
			
			IF (@GROUPLEVEL = 'SCRIP')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END
				IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
				IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY /*+ @COMMA + "INST_TYPE "*/ END
			END
	
			IF (@GROUPLEVEL = 'DATE')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "SAUDA_DATE "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END
				IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END
			END
	
			IF (@GROUPLEVEL = 'INSTTYPE')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "INST_TYPE "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END
				IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
			END
	
			IF (@GROUPLEVEL = 'PSD')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL, SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, "
				SET @STRGROUPBY = @STRGROUPBY + "OPTION_TYPE, SAUDA_DATE "
			END
		END /*IF (@ONEORMANY = 'DETAIL')*/
		ELSE /*IF (@ONEORMANY = 'DETAIL')*/
		BEGIN /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/
			IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE, PARTY_NAME, CLIENT_TYPE, EMAIL " END
			IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + "AREA " END
			IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + "REGION " END
			IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + "BRANCH_CODE " END
			IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "SUB_BROKER " END
			IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "TRADER " END
			IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + "FAMILY, FAMILYNAME " END
		END /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/
		SET @STRORDERBY = @STRGROUPBY
		SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY + " HAVING SUM(PQTY) - SUM(SQTY) <> 0 "
		SET @STRORDERBY = "ORDER BY " + @STRORDERBY
	END/*IF (@REPORTNAME = "NETPOSITION")*/
	PRINT 'REPORTNAME : ' + @REPORTNAME
	PRINT 'STATUSID : ' + @STATUSID
	PRINT 'STATUSNAME : ' + @STATUSNAME
	PRINT 'GROUPLEVEL : ' + @GROUPLEVEL
	PRINT 'GROUPSUBLEVEL : ' + @GROUPSUBLEVEL
	PRINT 'ORDERLEVEL : ' + @ORDERLEVEL
	PRINT 'ORDERSUBLEVEL : ' + @ORDERSUBLEVEL
	
	PRINT 'FROMDATE : ' + @FROMDATE
	PRINT 'TODATE : ' + @TODATE
	PRINT 'WHATCODE : ' + @WHATCODE
	PRINT 'FROMCODE : ' + @FROMCODE
	PRINT 'TOCODE : ' + @TOCODE
	
	PRINT 'INSTTYPE : ' + @INSTTYPE
	PRINT 'OPTIONTYPE : ' + @OPTIONTYPE
	PRINT 'STRIKEPRICE : ' + CONVERT(VARCHAR,@STRIKEPRICE)
	PRINT 'EXPIRYDATE : ' + @EXPIRYDATE
	PRINT 'SYMBOL : ' + @SYMBOL
	
	PRINT 'BILLTYPE : ' + @EX_BILLTYPE
	PRINT 'AUCTIONPART : ' + @EX_AUCTIONPART
	PRINT 'REPORTBY : ' + @EX_REPORTBY
	PRINT 'RATE : ' + @EX_RATE
	PRINT 'MONEYTYPE : ' + @EX_MONEYTYPE
	PRINT 'POSITION : ' + @EX_POSITION
	
	PRINT 'DUMMY001 : ' + @DUMMY001
	PRINT 'DUMMY002 : ' + @DUMMY002
	PRINT 'DUMMY003 : ' + @DUMMY003
	PRINT 'DUMMY004 : ' + @DUMMY004
	PRINT 'DUMMY005 : ' + @DUMMY005
	PRINT 'DUMMY006 : ' + @DUMMY006
	PRINT 'DUMMY007 : ' + @DUMMY007
	PRINT 'DUMMY008 : ' + @DUMMY008
	PRINT 'DUMMY009 : ' + @DUMMY009
	PRINT 'DUMMY010 : ' + @DUMMY010
	PRINT '=============================================================================================='
	IF @STRCOMPUTESUB <> '' 
	BEGIN 
		SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB 
		SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB
	END
	IF (@ISSUBLEVEL = 'YES')
	BEGIN
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)
	END
	ELSE
	BEGIN
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)
	END
	PRINT @STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE
	PRINT @STRSELECT 
	PRINT @STRFROM
	PRINT @STRWHERE
	PRINT @STRGROUPBY
	PRINT @STRORDERBY
	PRINT @STRCOMPUTESUB
	PRINT @STRCOMPUTE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWM2M
-- --------------------------------------------------

CREATE PROC
RPT_PROC_FO_NEWM2M
	@REPORTNAME VARCHAR(50),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@GROUPLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT
	@GROUPSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@ORDERLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@ORDERSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@WHATCODE VARCHAR(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FROMCODE VARCHAR(20),
	@TOCODE VARCHAR(20),
	@FROMPARTYCODE VARCHAR(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@TOPARTYCODE VARCHAR(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@DISPDIFFONLY VARCHAR(10),
	@INSTTYPE VARCHAR(20),		--]
	@OPTIONTYPE VARCHAR(20),	--]
	@STRIKEPRICE MONEY,		--]-->	PRIMARY SEARCH FIELDS.
	@EXPIRYDATE VARCHAR(11),	--]
	@SYMBOL VARCHAR(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@EX_BILLTYPE VARCHAR(1),	--(SINGLE/MULTIPLE) - BILL						]
	@EX_AUCTIONPART VARCHAR(20),	--SAUDASUMMARY							]
	@EX_REPORTBY VARCHAR(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@EX_RATE VARCHAR(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@EX_MONEYTYPE VARCHAR(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@EX_POSITION VARCHAR (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@M2MTYPE VARCHAR(50),
	@M2MFOR VARCHAR(50),
	@DUMMY003 VARCHAR(50),
	@DUMMY004 VARCHAR(50),
	@DUMMY005 VARCHAR(50),
	@DUMMY006 VARCHAR(50),
	@DUMMY007 VARCHAR(50),
	@DUMMY008 VARCHAR(50),
	@DUMMY009 VARCHAR(50),
	@DUMMY010 VARCHAR(50)
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


DECLARE
        @MEMBERCODE VARCHAR(15)
	SELECT @MEMBERCODE = MEMBERCODE FROM FOOWNER 
	IF @TOCODE='' SET @TOCODE = 'ZZZ'

	IF @M2MFOR = 'SCRIP'
	BEGIN
		SELECT 
			INST_TYPE ,
			SYMBOL,
			EXPIRY_DATE,
			OPTION_TYPE,
			STRIKE_PRICE,	
			EMAIL='', 
			SAUDA_DATE = @FROMDATE ,
			M_EXE ,
			M_PREM ,
			M_DAILY ,
			F_EXE ,
			F_PREM ,
			F_DAILY ,
			DIFF_EXE ,
			DIFF_PREM ,
			DIFF_DAILY
		FROM
			(
			SELECT
				INST_TYPE = ISNULL(INST_TYPE,FOEA_INST_TYPE) ,
				SYMBOL = ISNULL(SYMBOL, FOEA_SYMBOL),
				EXPIRY_DATE = ISNULL(EXPIRYDATE,FOEA_EXPIRYDATE),
				OPTION_TYPE = ISNULL(OPTION_TYPE,FOEA_OPTION_TYPE),
				STRIKE_PRICE = ISNULL(STRIKE_PRICE,FOEA_STRIKE_PRICE),	
				M_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) ELSE 0 END ,
				M_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) ELSE 0 END ,
				M_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) ELSE 0 END,
				F_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE' )THEN ISNULL(F_EXE,0) ELSE 0 END ,
				F_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(F_PREM,0) ELSE 0 END ,
				F_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(F_DAILY,0) ELSE 0 END ,
				DIFF_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) - ISNULL(F_EXE,0) ELSE 0 END,
				DIFF_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) - ISNULL(F_PREM,0) ELSE 0 END,
				DIFF_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) - ISNULL(F_DAILY,0) ELSE 0 END
			FROM
				(
				SELECT 
					INST_TYPE ,
					SYMBOL,
					EXPIRYDATE = CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE,
					STRIKE_PRICE,	
					SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_EXE,
					SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_PREM, 
					SUM(CASE WHEN (INST_TYPE LIKE 'FUT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_DAILY
				FROM
					FOBILLVALAN
				WHERE	
					LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)=  @FROMDATE  AND
					PARTY_CODE BETWEEN @FROMCODE AND @TOCODE AND
					@STATUSNAME = 
					  (CASE 
					        WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE
					        WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
					        WHEN @STATUSID = 'TRADER' THEN TRADER
					        WHEN @STATUSID = 'FAMILY' THEN FAMILY
					        WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
					  ELSE 
					        'BROKER'
					  END) AND 
					INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) AND
					AUCTIONPART LIKE (CASE WHEN @M2MTYPE = 'EXE'  
						        THEN 'EA' 
						        ELSE '%'
					            END )
					AND PARTICIPANTCODE = @MEMBERCODE
				GROUP BY
					INST_TYPE , SYMBOL, CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE, STRIKE_PRICE
				) BILL
				FULL OUTER JOIN
				(
				SELECT
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					FOEA_EXPIRYDATE = CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					FOEA_OPTION_TYPE = CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE,	
					M_PREM=SUM(FOEA_NETPREMIUM),
					M_DAILY = SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE+FOEA_FUTURES_FINAL_SETTLEMENT_VALUE),
					M_EXE = SUM(FOEA_EXERCISED_ASSIGNED_VALUE)
				FROM
					FOEXERCISEALLOCATION
				WHERE
					FOEA_PARTY_CODE BETWEEN @FROMCODE AND  @TOCODE 
					AND LEFT(CONVERT(VARCHAR,FOEA_POSITION_DATE,109),11) = @FROMDATE  
					AND FOEA_INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) 
				GROUP BY 
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE
				) FOEA
				
				ON ( 
					FOEA_INST_TYPE = INST_TYPE AND 
					FOEA_SYMBOL = SYMBOL AND
					FOEA_EXPIRYDATE = EXPIRYDATE AND
					FOEA_OPTION_TYPE = OPTION_TYPE AND
					FOEA_STRIKE_PRICE = STRIKE_PRICE
				 )
			
			) RPT
		
		WHERE
			ABS(M_EXE) + ABS(M_PREM) + ABS(M_DAILY) + ABS(F_EXE) + ABS(F_PREM) + ABS(F_DAILY) > 0 
			AND CASE WHEN @DISPDIFFONLY ='DIFF' THEN 
				ABS(DIFF_EXE)+ABS(DIFF_PREM)+ABS(DIFF_DAILY)
			ELSE
				1
			END
			<> 0
		
		ORDER BY 
			INST_TYPE ,SYMBOL,EXPIRY_DATE,OPTION_TYPE,	STRIKE_PRICE
		COMPUTE
			SUM (M_EXE),
			SUM (M_PREM),
			SUM (M_DAILY),
			SUM (F_EXE),
			SUM (F_PREM),
			SUM (F_DAILY),
			SUM (DIFF_EXE),
			SUM (DIFF_PREM),
			SUM (DIFF_DAILY)
	END	/*IF @M2MFOR = 'SCRIP'*/
	IF @M2MFOR = 'PARTY'
	BEGIN
		SELECT 
			PARTY_CODE,
			PARTY_NAME,
			EMAIL='', 
			SAUDA_DATE = @FROMDATE ,
			M_EXE ,
			M_PREM ,
			M_DAILY ,
			F_EXE ,
			F_PREM ,
			F_DAILY ,
			DIFF_EXE ,
			DIFF_PREM ,
			DIFF_DAILY
		FROM
			(
			SELECT
				PARTY_CODE = ISNULL(PARTY_CODE,FOEA_PARTY_CODE),
				PARTY_NAME = ISNULL(PARTY_NAME,''),
				M_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) ELSE 0 END ,
				M_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) ELSE 0 END ,
				M_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) ELSE 0 END,
				F_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE' )THEN ISNULL(F_EXE,0) ELSE 0 END ,
				F_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(F_PREM,0) ELSE 0 END ,
				F_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(F_DAILY,0) ELSE 0 END ,
				DIFF_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) - ISNULL(F_EXE,0) ELSE 0 END,
				DIFF_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) - ISNULL(F_PREM,0) ELSE 0 END,
				DIFF_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) - ISNULL(F_DAILY,0) ELSE 0 END
			FROM
				(
				SELECT 
					PARTY_CODE,
					PARTY_NAME,
					SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_EXE,
					SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_PREM, 
					SUM(CASE WHEN (INST_TYPE LIKE 'FUT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_DAILY
				FROM
					FOBILLVALAN
				WHERE	
					LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)=  @FROMDATE  AND
					PARTY_CODE BETWEEN @FROMCODE AND @TOCODE AND
					@STATUSNAME = 
					  (CASE 
					        WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE
					        WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
					        WHEN @STATUSID = 'TRADER' THEN TRADER
					        WHEN @STATUSID = 'FAMILY' THEN FAMILY
					        WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
					  ELSE 
					        'BROKER'
					  END) AND 
					INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) AND
					AUCTIONPART LIKE (CASE WHEN @M2MTYPE = 'EXE'  
						        THEN 'EA' 
						        ELSE '%'
					            END )
					AND PARTICIPANTCODE = @MEMBERCODE
				GROUP BY
					PARTY_CODE,PARTY_NAME
				) BILL
				FULL OUTER JOIN
				(
				SELECT
					FOEA_PARTY_CODE,
					M_PREM=SUM(FOEA_NETPREMIUM),
					M_DAILY = SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE+FOEA_FUTURES_FINAL_SETTLEMENT_VALUE),
					M_EXE = SUM(FOEA_EXERCISED_ASSIGNED_VALUE)
				FROM
					FOEXERCISEALLOCATION
				WHERE
					FOEA_PARTY_CODE BETWEEN @FROMCODE AND  @TOCODE 
					AND LEFT(CONVERT(VARCHAR,FOEA_POSITION_DATE,109),11) = @FROMDATE  
					AND FOEA_INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) 
				GROUP BY FOEA_PARTY_CODE
				) FOEA
				
				ON ( FOEA_PARTY_CODE = PARTY_CODE )
			
			) RPT
		
		WHERE
			ABS(M_EXE) + ABS(M_PREM) + ABS(M_DAILY) + ABS(F_EXE) + ABS(F_PREM) + ABS(F_DAILY) > 0
			AND CASE WHEN @DISPDIFFONLY ='DIFF' THEN 
				ABS(DIFF_EXE)+ABS(DIFF_PREM)+ABS(DIFF_DAILY)
			ELSE
				1
			END
			<> 0
		
		ORDER BY 
			PARTY_CODE,PARTY_NAME
		COMPUTE
			SUM (M_EXE),
			SUM (M_PREM),
			SUM (M_DAILY),
			SUM (F_EXE),
			SUM (F_PREM),
			SUM (F_DAILY),
			SUM (DIFF_EXE),
			SUM (DIFF_PREM),
			SUM (DIFF_DAILY)

	END	/*IF @M2MFOR = 'PARTY'*/
	IF @M2MFOR = 'BOTH'
	BEGIN
		SELECT 
			PARTY_CODE,
			PARTY_NAME,
			INST_TYPE ,
			SYMBOL,
			EXPIRY_DATE,
			OPTION_TYPE,
			STRIKE_PRICE,	
			EMAIL='', 
			SAUDA_DATE = @FROMDATE ,
			M_EXE ,
			M_PREM ,
			M_DAILY ,
			F_EXE ,
			F_PREM ,
			F_DAILY ,
			DIFF_EXE ,
			DIFF_PREM ,
			DIFF_DAILY
		FROM
			(
			SELECT
				PARTY_CODE = ISNULL(PARTY_CODE,FOEA_PARTY_CODE),
				PARTY_NAME = ISNULL(PARTY_NAME,''),
				INST_TYPE = ISNULL(INST_TYPE,FOEA_INST_TYPE) ,
				SYMBOL = ISNULL(SYMBOL, FOEA_SYMBOL),
				EXPIRY_DATE = ISNULL(EXPIRYDATE,FOEA_EXPIRYDATE),
				OPTION_TYPE = ISNULL(OPTION_TYPE,FOEA_OPTION_TYPE),
				STRIKE_PRICE = ISNULL(STRIKE_PRICE,FOEA_STRIKE_PRICE),	
				M_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) ELSE 0 END ,
				M_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) ELSE 0 END ,
				M_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) ELSE 0 END,
				F_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE' )THEN ISNULL(F_EXE,0) ELSE 0 END ,
				F_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(F_PREM,0) ELSE 0 END ,
				F_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(F_DAILY,0) ELSE 0 END ,
				DIFF_EXE = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'EXE') THEN ISNULL(M_EXE,0) - ISNULL(F_EXE,0) ELSE 0 END,
				DIFF_PREM = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'PRE') THEN ISNULL(M_PREM,0) - ISNULL(F_PREM,0) ELSE 0 END,
				DIFF_DAILY = CASE WHEN (@M2MTYPE = 'ALL' OR @M2MTYPE = 'M2M') THEN ISNULL(M_DAILY,0) - ISNULL(F_DAILY,0) ELSE 0 END
			FROM
				(
				SELECT 
					PARTY_CODE,
					PARTY_NAME,
					INST_TYPE ,
					SYMBOL,
					EXPIRYDATE = CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE,
					STRIKE_PRICE,	
					SUM(CASE WHEN (AUCTIONPART = 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_EXE,
					SUM(CASE WHEN (AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'OPT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_PREM, 
					SUM(CASE WHEN (INST_TYPE LIKE 'FUT%') THEN SBILLAMT - PBILLAMT + (PBROKAMT + SBROKAMT) ELSE 0 END) AS F_DAILY
				FROM
					FOBILLVALAN
				WHERE	
					LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)=  @FROMDATE  AND
					PARTY_CODE BETWEEN @FROMCODE AND @TOCODE AND
					@STATUSNAME = 
					  (CASE 
					        WHEN @STATUSID = 'BRANCH' THEN BRANCH_CODE
					        WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
					        WHEN @STATUSID = 'TRADER' THEN TRADER
					        WHEN @STATUSID = 'FAMILY' THEN FAMILY
					        WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
					  ELSE 
					        'BROKER'
					  END) AND 
					INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) AND
					AUCTIONPART LIKE (CASE WHEN @M2MTYPE = 'EXE'  
						        THEN 'EA' 
						        ELSE '%'
					            END )
					AND PARTICIPANTCODE = @MEMBERCODE
				GROUP BY
					PARTY_CODE,PARTY_NAME,
					INST_TYPE , SYMBOL, CONVERT(VARCHAR,EXPIRYDATE,103),
					OPTION_TYPE, STRIKE_PRICE
				) BILL
				FULL OUTER JOIN
				(
				SELECT
					FOEA_PARTY_CODE,
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					FOEA_EXPIRYDATE = CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					FOEA_OPTION_TYPE = CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE,	
					M_PREM=SUM(FOEA_NETPREMIUM),
					M_DAILY = SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE+FOEA_FUTURES_FINAL_SETTLEMENT_VALUE),
					M_EXE = SUM(FOEA_EXERCISED_ASSIGNED_VALUE)
				FROM
					FOEXERCISEALLOCATION
				WHERE
					FOEA_PARTY_CODE BETWEEN @FROMCODE AND  @TOCODE 
					AND LEFT(CONVERT(VARCHAR,FOEA_POSITION_DATE,109),11) = @FROMDATE  
					AND FOEA_INST_TYPE LIKE (CASE WHEN @M2MTYPE = 'M2M'  
						        THEN 'FUT%' 
						        ELSE (CASE WHEN @M2MTYPE = 'ALL'  
							             THEN '%' 
								ELSE 'OPT%' 
							   END )
					            END ) 
				GROUP BY FOEA_PARTY_CODE,
					FOEA_INST_TYPE ,
					FOEA_SYMBOL,
					CONVERT(VARCHAR,FOEA_EXPIRYDATE,103),
					CASE WHEN FOEA_OPTION_TYPE ='FF' THEN '' ELSE FOEA_OPTION_TYPE END,
					FOEA_STRIKE_PRICE
				) FOEA
				
				ON ( 
					FOEA_PARTY_CODE = PARTY_CODE AND 
					FOEA_INST_TYPE = INST_TYPE AND 
					FOEA_SYMBOL = SYMBOL AND
					FOEA_EXPIRYDATE = EXPIRYDATE AND
					FOEA_OPTION_TYPE = OPTION_TYPE AND
					FOEA_STRIKE_PRICE = STRIKE_PRICE
				 )
			
			) RPT
		
		WHERE
			ABS(M_EXE) + ABS(M_PREM) + ABS(M_DAILY) + ABS(F_EXE) + ABS(F_PREM) + ABS(F_DAILY) > 0 
			AND CASE WHEN @DISPDIFFONLY ='DIFF' THEN 
				ABS(DIFF_EXE)+ABS(DIFF_PREM)+ABS(DIFF_DAILY)
			ELSE
				1
			END
			<> 0
		
		ORDER BY 
			PARTY_CODE,PARTY_NAME,INST_TYPE ,SYMBOL,EXPIRY_DATE,OPTION_TYPE,	STRIKE_PRICE
		COMPUTE
			SUM (M_EXE),
			SUM (M_PREM),
			SUM (M_DAILY),
			SUM (F_EXE),
			SUM (F_PREM),
			SUM (F_DAILY),
			SUM (DIFF_EXE),
			SUM (DIFF_PREM),
			SUM (DIFF_DAILY)

	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWNETPOSITION
-- --------------------------------------------------
CREATE   PROC [dbo].[RPT_PROC_FO_NEWNETPOSITION]
(
	 @REPORTNAME VARCHAR(50),    
	 @STATUSID VARCHAR(20),    
	 @STATUSNAME VARCHAR(50),    
	 @GROUPLEVEL VARCHAR(10), 	--FOR TOP LEVEL REPORT    
	 @GROUPSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS    
	 @ORDERLEVEL VARCHAR(10), 	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
	 @ORDERSUBLEVEL VARCHAR(10), 	--FOR SUBSEQUENT DBILLNORILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY    
	 @FROMDATE VARCHAR(11),    
	 @TODATE VARCHAR(11),    
	 @WHATCODE VARCHAR(20),  	--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT    
	 @FROMCODE VARCHAR(20),    
	 @TOCODE VARCHAR(20),    
	 @FROMPARTYCODE VARCHAR(20), 	--> FOR THE FROM AND TO PARTY CODES    
	 @TOPARTYCODE VARCHAR(20), 	--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'    
	 @ONEORMANY VARCHAR(20),    
	 @INSTTYPE VARCHAR(20),  
	 @OPTIONTYPE VARCHAR(20),
	 @STRIKEPRICE MONEY,  		--> PRIMARY SEARCH FIELDS.    
	 @EXPIRYDATE VARCHAR(11),
	 @SYMBOL VARCHAR(20), 
	 @EX_BILLTYPE VARCHAR(1), 	--> (SINGLE/MULTIPLE) - BILL
	 @EX_AUCTIONPART VARCHAR(20), 	--> SAUDASUMMARY 
	 @EX_REPORTBY VARCHAR(20), 	--> (MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC    
	 @EX_RATE VARCHAR(20),  	--> (PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS    
	 @EX_MONEYTYPE VARCHAR(1), 	--> (IN/AT/OUT) - IN THE MONEY   
	 @EX_POSITION VARCHAR (1), 	--> (LONG/SHORT) - IN THE MONEY  
	 @CMCLOSING VARCHAR (2)='', 	--> (LONG/SHORT) - IN THE MONEY 
	 @POSITIONAS VARCHAR(50), 	--ACTUAL/LOT  
	 --END REPORT SPECIFIC SEARCH FEILDS    
	 @DUMMY002 VARCHAR(1),    
	 @DUMMY003 VARCHAR(1),    
	 @DUMMY004 VARCHAR(1),    
	 @DUMMY005 VARCHAR(1),    
	 @DUMMY006 VARCHAR(1),    
	 @DUMMY007 VARCHAR(1),    
	 @DUMMY008 VARCHAR(1),    
	 @DUMMY009 VARCHAR(1),    
	 @DUMMY010 VARCHAR(1), 
	 @DUMMY011 VARCHAR(1)=''    
)
AS

IF @POSITIONAS = 'ACTUAL' 
BEGIN
	SET @POSITIONAS = 'LOT' 
END
ELSE
BEGIN
	SET @POSITIONAS = 'ACTUAL' 
END
DECLARE
	@STRSELECT VARCHAR(8000),
	@STRSELECTTEMP VARCHAR(8000),
	@STRFROM VARCHAR(8000),
	@STRWHERE VARCHAR(8000),
	@STRGROUPBY VARCHAR(8000),
	@STRORDERBY VARCHAR(8000),
	@STRCOMPUTE VARCHAR(8000),
	@STRCOMPUTESUB VARCHAR(8000),
	@ISSUBLEVEL VARCHAR(3),
	@CODEID VARCHAR(20),
	@COMMA VARCHAR(1)

	SET @INSTTYPE = @INSTTYPE+"%" 
	SET @STRSELECT = ''
	SET @STRSELECTTEMP = ''
	SET @STRFROM = ''
	SET @STRWHERE = ''
	SET @STRGROUPBY = ''
	SET @STRORDERBY = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTESUB = ''
	SET @ISSUBLEVEL = 'NO'

	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END	
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END
	IF @EX_REPORTBY = 'EXCHG' BEGIN SET @EX_REPORTBY = "BOTH" END
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

	IF (@FROMDATE = '' AND @TODATE = '')
	BEGIN 
		SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN 
	END 

	IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END    
	IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END    
	IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END    
	IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END    
	IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END    
	IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END    
	IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END 
	
	IF @CMCLOSING <> ''     
	BEGIN    
		SET @STRSELECT = @STRSELECT + "SELECT CMCLOSING, "     
	END    
	ELSE    
	BEGIN    
		SET @STRSELECT = @STRSELECT + "SELECT "     
	END    
	SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "    
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))    
	BEGIN    
		SET @STRSELECTTEMP = ''    
		IF (@GROUPLEVEL = 'PARTY')  
		BEGIN    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(FOBILLVALAN.EMAIL) EMAIL, "    
			/*IF (@GROUPSUBLEVEL = 'PARTY')    
			BEGIN    
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME,  MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(FOBILLVALAN.EMAIL) EMAIL ,"    
				SET @ISSUBLEVEL = 'YES'    
			END*/   
			IF (@GROUPSUBLEVEL = 'SCRIP')    
			BEGIN    
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE,MAX(BILLNO) AS BILLNO, "    
				SET @ISSUBLEVEL = 'YES'    
			END    		
			IF (@ISSUBLEVEL = 'YES')    
			BEGIN    
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "    
			END    
		END    
		IF (@GROUPLEVEL = 'SCRIP')    
		BEGIN    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, MAX(BILLNO) AS BILLNO, "    
			IF (@GROUPSUBLEVEL = 'PARTY')    
			BEGIN    
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME,  MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(FOBILLVALAN.EMAIL) EMAIL, "    
				SET @ISSUBLEVEL = 'YES'    
			END    
			IF (@ISSUBLEVEL = 'YES')    
			BEGIN    
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "    
			END    
		END    
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
		SET @STRSELECTTEMP = ''    
	END 
	ELSE
	BEGIN 
		IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME,  MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(FOBILLVALAN.EMAIL) EMAIL , " END    
		IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + " AREA, " END    
		IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + " REGION, " END    
		IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + " BRANCH_CODE, " END    
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + " SUB_BROKER, " END    
		IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + " TRADER, " END    
		IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + " FAMILY, MAX(LEFT(FAMILYNAME,25)) AS FAMILYNAME, " END    
	END 

	--PQTY
	SET @STRSELECTTEMP = ''
	IF  @POSITIONAS = 'ACTUAL'
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END) "
	END 
	ELSE
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(PQTY) "
	END 
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	--SQTY
	SET @STRSELECTTEMP = ''
	IF  @POSITIONAS = 'ACTUAL'
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END) "
	END
	ELSE
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(SQTY) "
	END 
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	IF (@EX_REPORTBY = 'STRIKE')
	BEGIN
		--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(PQTY*STRIKE_PRICE) "			
		SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE (PQTY*PRATE) END)) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SQTY*STRIKE_PRICE) "			
		SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE (SQTY*SRATE) END)) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--NETQTY - FOR THE NET POS REPORT
		SET @STRSELECTTEMP = ''
		IF @POSITIONAS = 'ACTUAL' 
		BEGIN
			SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END) - SUM(CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END) "
		END
		ELSE
		BEGIN
			SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(PQTY) - SUM(SQTY) "
		END
		
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--NET VALUE- FOR THE NET POS REPORT
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(PQTY*STRIKE_PRICE) "			
		SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE (PQTY*PRATE) END)) - "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SQTY*STRIKE_PRICE) "			

		SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE (SQTY*SRATE) END)) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--AVG. PRICE - FOR THE NET POS REPORT
		SET @STRSELECTTEMP = ''
		IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
			BEGIN
				IF (@EX_RATE = 'MKTRATE')
					BEGIN
						/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(((PQTY*PRATE) - (SQTY*SRATE)) )/ "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "*/
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) > SUM(SQTY) "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(PQTY*PRATE)/SUM(PQTY) "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "WHEN SUM(SQTY)  > 0"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(SQTY*SRATE)/SUM(SQTY) "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE 0 END)"
					END
				ELSE
					BEGIN
						/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM((PAMT - SAMT) )/ "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "*/
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) > SUM(SQTY) "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(PAMT)/SUM(PQTY) "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "WHEN SUM(SQTY)  > 0"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(SAMT)/SUM(SQTY) "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE 0 END)"
					END
			END
		ELSE
			BEGIN
				SET @STRSELECTTEMP = '0'
			END
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	END
	
	IF (@EX_RATE = 'MKTRATE')
	BEGIN
		--IF (@EX_REPORTBY = 'BOTH') ARE OMITED
		IF (@EX_REPORTBY = 'PRICE')
		BEGIN
			--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PRATE*PQTY)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(SRATE*SQTY)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NETQTY - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			IF @POSITIONAS = 'ACTUAL' 
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END) - SUM(CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END) "
			END
			ELSE
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(PQTY) - SUM(SQTY) "
			END
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NET VALUE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(PRATE*PQTY) - SUM(SRATE*SQTY)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--AVG. PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
				BEGIN
					/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(((PQTY*PRATE) - (SQTY*SRATE)) )/ "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "*/
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) > SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(PQTY*PRATE)/SUM(PQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "WHEN SUM(SQTY)  > 0"
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(SQTY*SRATE)/SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE 0 END)"
				END
			ELSE
				BEGIN
					SET @STRSELECTTEMP = '0'
				END
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		END
		IF (@EX_REPORTBY = 'BOTH')
		BEGIN
			--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM((STRIKE_PRICE+PRATE) *PQTY) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP

			--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM((STRIKE_PRICE+SRATE) *SQTY) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NETQTY - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			IF @POSITIONAS = 'ACTUAL' 
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END) - SUM(CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END) "
			END
			ELSE
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(PQTY) - SUM(SQTY) "
			END
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NET VALUE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM((STRIKE_PRICE+PRATE) *PQTY) - SUM((STRIKE_PRICE+SRATE) *SQTY)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--AVG. PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
				BEGIN
					/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(((PQTY*PRATE) - (SQTY*SRATE)) )/ "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "*/
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) > SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(PQTY*PRATE)/SUM(PQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "WHEN SUM(SQTY)  > 0"
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(SQTY*SRATE)/SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE 0 END)"
				END
			ELSE
				BEGIN
					SET @STRSELECTTEMP = '0'
				END
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		END
	END
	IF (@EX_RATE = 'NETRATE')
	BEGIN
		IF (@EX_REPORTBY = 'PRICE')
		BEGIN
			--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PAMT)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(SAMT)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			
			--NETQTY - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			IF @POSITIONAS = 'ACTUAL' 
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END) - SUM(CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END) "
			END
			ELSE
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(PQTY) - SUM(SQTY) "
			END
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NET VALUE- FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM(PAMT) - SUM(SAMT)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--AVG. PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
				BEGIN
					/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SUM((PAMT-SAMT) ))/ "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "*/
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) > SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(PAMT)/SUM(PQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "WHEN SUM(SQTY)  > 0"
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(SAMT)/SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE 0 END)"
				END
			ELSE
				BEGIN
					SET @STRSELECTTEMP = '0'
				END
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		END
		IF (@EX_REPORTBY = 'BOTH')
		BEGIN
			--PAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM((STRIKE_PRICE*PQTY)+PAMT) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP

			--SAMT - NETRATE + PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM((STRIKE_PRICE*SQTY)+SAMT) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NETQTY - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			IF @POSITIONAS = 'ACTUAL' 
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END) - SUM(CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END) "
			END
			ELSE
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(PQTY) - SUM(SQTY) "
			END
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--NET VALUE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + " (SUM((STRIKE_PRICE*PQTY)+PAMT) - SUM((STRIKE_PRICE*SQTY)+SAMT)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETVALUE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			--AVG. PRICE - FOR THE NET POS REPORT
			SET @STRSELECTTEMP = ''
			IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
				BEGIN
					/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) - SUM(SQTY) <> 0 "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM((PAMT - SAMT) )/ "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(PQTY) - SUM(SQTY)) ELSE 0 END) "*/
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(PQTY) > SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(PAMT)/SUM(PQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "WHEN SUM(SQTY)  > 0"
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN SUM(SAMT)/SUM(SQTY) "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE 0 END)"
				END
			ELSE
				BEGIN
					SET @STRSELECTTEMP = '0'
				END
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		END
	END	/*IF (@EX_RATE = 'NETRATE')*/		
	--NET OPEN VALUE (CL. PRICE)
	SET @STRSELECTTEMP = ''
	SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM((PQTY - SQTY)*CL_RATE)  "
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "	
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETOPENVALUE, "
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	--CL. PRICE
	SET @STRSELECTTEMP = ''
	IF (@GROUPSUBLEVEL = 'SCRIP' OR @GROUPLEVEL = 'SCRIP')
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + "  (CASE WHEN SUM(PQTY+SQTY) <> 0 THEN  ABS(SUM((PQTY + SQTY)*CL_RATE) / SUM(PQTY + SQTY)) ELSE 0 END )"
	END
	ELSE
	BEGIN
		SET @STRSELECTTEMP = '0'
	END
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ")  "	
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEPRICE "		
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	SET @STRSELECTTEMP = ""

	SET @STRFROM = @STRFROM + "FROM "
	SET @STRFROM = @STRFROM + "FOBILLVALAN (NOLOCK), FOOWNER (NOLOCK) "

	SET @STRWHERE = @STRWHERE + "WHERE MEMBERCODE = PARTICIPANTCODE AND "    	
	SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "
	SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "
	IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END
	SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "
	SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "
	IF (@FROMCODE = '' AND @TOCODE = '')
	BEGIN
		SET @STRWHERE = @STRWHERE + @CODEID + " LIKE '%' AND "
	END
	ELSE
	BEGIN
		SET @STRWHERE = @STRWHERE + @CODEID + " >= '" + @FROMCODE + "' AND "
		SET @STRWHERE = @STRWHERE + @CODEID + " <= '" + @TOCODE + "' AND "
	END
	IF (@FROMDATE = '' AND @TODATE = '')
	BEGIN
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "
	END
	ELSE
	BEGIN
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "
	END
	IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))
	BEGIN
		SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "
		SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "
	END
	/*LOGIN CONDITIONS*/
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

	SET @COMMA = ''    
	SET @STRGROUPBY = @STRGROUPBY + @COMMA    
	
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))    
	BEGIN    
		IF (@GROUPLEVEL = 'PARTY')    
		BEGIN    
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE  "    
			SET @COMMA = ', '    
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END    
		END    			
		IF (@GROUPLEVEL = 'SCRIP')    
		BEGIN    
			SET @STRGROUPBY = @STRGROUPBY + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "    
			SET @COMMA = ', '    
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END    
		END    
	END
	ELSE 
	BEGIN
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE  " END    
		IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + " AREA " END    
		IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + " REGION " END    
		IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + " BRANCH_CODE " END    
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + " SUB_BROKER " END    
		IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + " TRADER " END    
		IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + " FAMILY " END    
	END
	SET @STRORDERBY = @STRGROUPBY
	IF @CMCLOSING <> ''     
	BEGIN    
		SET @STRGROUPBY = @STRGROUPBY  + ",CMCLOSING "    
	END
	SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY + " HAVING SUM(PQTY - SQTY) <> 0 "
	SET @STRORDERBY = "ORDER BY " + @STRORDERBY
	
	IF @STRCOMPUTESUB <> '' 
	BEGIN 
		SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB 
		SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB
	END	
	IF LTRIM(RTRIM(@STRGROUPBY)) = 'GROUP BY'
	BEGIN
		SET @STRGROUPBY =''
	END
	
	IF (@ISSUBLEVEL = 'YES')    
	BEGIN    
		PRINT (@STRSELECT + @STRFROM + @STRWHERE +  @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)    
		EXEC (@STRSELECT + @STRFROM + @STRWHERE +  @STRGROUPBY + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)    
	END    
	ELSE    
	BEGIN    
		PRINT (@STRSELECT + @STRFROM + @STRWHERE +  @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)    
		EXEC (@STRSELECT + @STRFROM + @STRWHERE +  @STRGROUPBY + @STRORDERBY + @STRCOMPUTE)    
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWREPORTS
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_PROC_FO_NEWREPORTS]
(
	 @REPORTNAME VARCHAR(50),      
	 @STATUSID VARCHAR(20),      
	 @STATUSNAME VARCHAR(50),      
	 @GROUPLEVEL VARCHAR(10), 		--FOR TOP LEVEL REPORT      
	 @GROUPSUBLEVEL VARCHAR(10), 		--FOR SUBSEQUENT DRILL-DOWNS      
	 @ORDERLEVEL VARCHAR(10), 		--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY      
	 @ORDERSUBLEVEL VARCHAR(10), 		--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY      
	 @FROMDATE VARCHAR(11),      
	 @TODATE VARCHAR(11),      
	 @WHATCODE VARCHAR(20),  		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT      
	 @FROMCODE VARCHAR(20),      
	 @TOCODE VARCHAR(20),      
	 @FROMPARTYCODE VARCHAR(20), 		--]--> FOR THE FROM AND TO PARTY CODES      
	 @TOPARTYCODE VARCHAR(20), 		--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'      
	 @ONEORMANY VARCHAR(20),      
	 @INSTTYPE VARCHAR(20),  		--]      
	 @OPTIONTYPE VARCHAR(20), 		--]      
	 @STRIKEPRICE MONEY,  			--]--> PRIMARY SEARCH FIELDS.      
	 @EXPIRYDATE VARCHAR(11), 		--]      
	 @SYMBOL VARCHAR(20),  --]      
	 @EX_BILLTYPE VARCHAR(1), 		--(SINGLE/MULTIPLE) - BILL      ]      
	 @EX_AUCTIONPART VARCHAR(20), 		--SAUDASUMMARY       ]      
	 @EX_REPORTBY VARCHAR(20), 		--(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC      
	 @EX_RATE VARCHAR(20), 			--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS      
	 @EX_MONEYTYPE VARCHAR(1), 		--(IN/AT/OUT) - IN THE MONEY      ]      
	 @EX_POSITION VARCHAR (1), 		--(LONG/SHORT) - IN THE MONEY     ]      
	 --END REPORT SPECIFIC SEARCH FEILDS      
	 @DUMMY001 VARCHAR(50),      
	 @DUMMY002 VARCHAR(50),      
	 @DUMMY003 VARCHAR(50),      
	 @DUMMY004 VARCHAR(50),      
	 @DUMMY005 VARCHAR(50),      
	 @DUMMY006 VARCHAR(50),      
	 @DUMMY007 VARCHAR(50),      
	 @DUMMY008 VARCHAR(50),      
	 @DUMMY009 VARCHAR(50),      
	 @DUMMY010 VARCHAR(50)      
)
AS      

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


DECLARE      
	@STRSELECT VARCHAR(8000),      
	@STRSELECTTEMP VARCHAR(8000),      
	@STRSELECTAVRGRT VARCHAR(8000),      
	@STRSELECTCLOSEQTY VARCHAR(8000),      
	@STRFROM VARCHAR(8000),      
	@STRWHERE VARCHAR(8000),      
	@STRGROUPBY VARCHAR(8000),      
	@STRORDERBY VARCHAR(8000),      
	@STRCOMPUTE VARCHAR(8000),      
	@STRCOMPUTESUB VARCHAR(8000),      
	@STRHAVING VARCHAR(2000),      
	@ISSUBLEVEL VARCHAR(3),      
	@CODEID VARCHAR(20),      
	@COMMA VARCHAR(1)      
	SET @INSTTYPE = @INSTTYPE+"%"       
	SET @STRSELECT = ''      
	SET @STRSELECTTEMP = ''
	SET @STRSELECTAVRGRT = '' 
	SET @STRSELECTCLOSEQTY = ''     
	SET @STRFROM = ''      
	SET @STRWHERE = ''      
	SET @STRGROUPBY = ''      
	SET @STRORDERBY = ''      
	SET @STRCOMPUTE = ''      
	SET @STRCOMPUTESUB = ''      
	SET @ISSUBLEVEL = 'NO'      
	
	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END      
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END     
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END      
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END      
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END      
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END      

	IF @TODATE = ''      
	BEGIN       
		SELECT @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN (NOLOCK)
	END       
	
	SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MIN(SAUDA_DATE),109),11) FROM FOBILLVALAN (NOLOCK) WHERE SAUDA_DATE >=  @FROMDATE 

	IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END      
	IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END      
	IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END      
	IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END      
	IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END      
	IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END      
	IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END      
        
	SET @STRSELECT = @STRSELECT + "SELECT "      
	SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "      
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		IF (@GROUPLEVEL = 'PARTY')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, "      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      	
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "      
			END      
		END      
		IF (@GROUPLEVEL = 'SCRIP')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE,  MAX(EMAIL) AS EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "      
			END      
		END       
		IF (@GROUPLEVEL = 'DATE')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS  EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + " YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE) "      
			END      
		END             
		IF (@GROUPLEVEL = 'INSTTYPE')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE,  MAX(EMAIL) AS EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "INST_TYPE "      
			END
		END       
		IF (@GROUPLEVEL = 'PSD')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, SYMBOL, INST_TYPE, "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "OPTION_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
			SET @ISSUBLEVEL = 'YES'      
		END      
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		SET @STRSELECTTEMP = ''      
	END 
	ELSE
	BEGIN 
		IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, " END      
		IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + "AREA, " END      
		IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + "REGION, " END      
		IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + "BRANCH_CODE, " END      
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + "SUB_BROKER, " END      
		IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + "TRADER, " END      
		IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + "FAMILY, MAX(LEFT(FAMILYNAME,25)) AS FAMILYNAME, " END      
	END 
	--OPENQTY      
	SET @STRSELECTTEMP = ''      
	IF @GROUPLEVEL = 'DATE' OR @GROUPSUBLEVEL ='DATE'
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN  TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN SAUDA_DATE LIKE '" + @FROMDATE + "%' AND TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	END      
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPENQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
	
	--PQTY      
	SET @STRSELECTTEMP = ''      
	SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) "      
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
	
	--SQTY      
	SET @STRSELECTTEMP = ''      
	SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "      
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      

	IF (@EX_RATE = 'MKTRATE')      
	BEGIN      
		IF (@EX_REPORTBY = 'STRIKE')      
		BEGIN      
			--PAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      

		    --AVG. PRICE      
		    SET @STRSELECTTEMP = ''      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA' THEN (SQTY) ELSE 0 END) <> 0 "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + " THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) ) / "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
		    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
		    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP         
		END      
		IF (@EX_REPORTBY = 'EXCHG')      
		BEGIN      
			--PAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      

		    --AVG. PRICE      
		    SET @STRSELECTTEMP = ''      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + " THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) ) / "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
		    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
		    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP         
		END 	
		IF (@EX_REPORTBY = 'PRICE')      
		BEGIN      
			--PAMT - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      

		    --AVG. PRICE      
		    SET @STRSELECTTEMP = ''      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) - "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END))) / "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
		    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
		    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
		END      
		IF (@EX_REPORTBY = 'BOTH')      
		BEGIN      
			--PAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT'  THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
  
		    --AVG. PRICE      
		    SET @STRSELECTTEMP = ''      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
		    --SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PQTY*PRATE) ELSE 0 END) END)) - "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
		    --SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) ) / "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SQTY*SRATE) ELSE 0 END) END)) ) / "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
		    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
		    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP       
		END      
	END 
	IF (@EX_RATE = 'NETRATE')      
	BEGIN      
		IF (@EX_REPORTBY = 'STRIKE')      
		BEGIN      
			--PAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN ((PRATE*PQTY)+PBROKAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN ((PRATE*PQTY)+PBROKAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN ((PRATE*PQTY)+PBROKAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP   
   
		    --AVG. PRICE      
		    SET @STRSELECTTEMP = ''      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) ) / "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
		    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
		    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP  
     
		END      
		IF (@EX_REPORTBY = 'EXCHG')      
		BEGIN      
			--PAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN ((PRATE*PQTY)+PBROKAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN ((PRATE*PQTY)+PBROKAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN ((PRATE*PQTY)+PBROKAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP 
		     
		    --AVG. PRICE      
		    SET @STRSELECTTEMP = ''      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) ) / "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
		    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
		    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP       
		END  	
		IF (@EX_REPORTBY = 'PRICE')      
		BEGIN      
			--PAMT - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((PRATE*PQTY)+PBROKAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((PRATE*PQTY)+PBROKAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SAMT - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((PRATE*PQTY)+PBROKAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP 
     
		    --AVG. PRICE      
		    SET @STRSELECTTEMP = ''      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) - "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END))) / "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
		    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
		    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
		IF (@EX_REPORTBY = 'BOTH')      
		BEGIN      
			--PAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT'  THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
  
		    --AVG. PRICE      
		    SET @STRSELECTTEMP = ''      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END)) - "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END))) / "      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
		    SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* AVG. PRICE */ " --FOR THE SUB TOTAL      
		    SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
		    SET @STRSELECT = @STRSELECT + @STRSELECTTEMP        
		END      
	END

	--CLOSEQTY      
	SET @STRSELECTTEMP = ''      
	IF @GROUPLEVEL = 'DATE' OR @GROUPSUBLEVEL ='DATE'
	BEGIN      
		SET @STRSELECTCLOSEQTY = "(SUM(CASE WHEN   TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) + "       
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) - "      
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTCLOSEQTY =  "(SUM(CASE WHEN SAUDA_DATE LIKE '" + @FROMDATE + "%' AND  TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) + "       
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) - "      
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	END      
	SET @STRSELECTTEMP = @STRSELECTCLOSEQTY + "AS CLOSEQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
	SET @STRSELECTTEMP = ''  

   
	IF (@EX_RATE = 'NETRATE')      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		SET @STRSELECTTEMP = @STRSELECTTEMP +" SUM(SBILLAMT - PBILLAMT)  - (SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ")  "      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "      
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		SET @STRSELECTTEMP = @STRSELECTTEMP +" SUM(SBILLAMT - PBILLAMT + PBROKAMT + SBROKAMT) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ")  "      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "      
	END

	--PROFIT/LOSS      

	/*SET @STRSELECTTEMP = 'CONVERT (NUMERIC(18,4),' 
	SET @STRSELECTTEMP = @STRSELECTTEMP + @STRSELECTAVRGRT + ')* CONVERT(INT,'+  @STRSELECTCLOSEQTY  + ') '
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0)  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "      */
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP   
	SET @STRSELECTTEMP = ''   
     

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')  AND (@FROMDATE  = @TODATE )  
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + " CL_RATE = (CASE WHEN SUM(PQTY+SQTY) <> 0 THEN  ABS(SUM((PQTY + SQTY)*CL_RATE) / SUM(PQTY + SQTY)) ELSE 0 END ),0 "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + " CL_RATE = 0 ,0"       
	END      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
	SET @STRSELECTTEMP = ""      

	SET @STRFROM = @STRFROM + "FROM "      
	SET @STRFROM = @STRFROM + "FOBILLVALAN_VBB_VIEW (NOLOCK)"      
	
	SET @STRWHERE = @STRWHERE + "WHERE "       
	SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "      
	SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "      
	IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END      
	SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "      
	SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "      
	SET @STRWHERE = @STRWHERE + "AUCTIONPART LIKE '" + @EX_AUCTIONPART + "' AND  "      
	SET @STRWHERE = @STRWHERE + "PQTY +SQTY > 0 AND "        

	IF (@FROMCODE = '' AND @TOCODE = '')      
	BEGIN      
		SET @STRWHERE = @STRWHERE + " ISNULL(" + @CODEID + ",'') LIKE '%' AND "      
	END      
	ELSE      
	BEGIN      
		SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') >= '" + @FROMCODE + "' AND "      
		SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') <= '" + @TOCODE + "' AND "      
	END  
	IF (@FROMDATE = '' AND @TODATE = '')      
	BEGIN      
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "      
	END      
	ELSE      
	BEGIN      
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "      
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "      
	END      
	IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))      
	BEGIN      
		SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "      
		SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "      
	END      
        
	/*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

	/*END - LOGIN CONDITIONS*/
	
	SET @COMMA = ''      
	SET @STRGROUPBY = @STRGROUPBY + @COMMA      
	
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))      
	BEGIN      
		IF (@GROUPLEVEL = 'PARTY')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END      
		END      	
		IF (@GROUPLEVEL = 'SCRIP')      
		BEGIN      
			SET @STRGROUPBY =   + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY /*+ @COMMA + "INST_TYPE "*/ END      
		END      	
		IF (@GROUPLEVEL = 'DATE')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END      
		END      	
		IF (@GROUPLEVEL = 'INSTTYPE')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "INST_TYPE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
		END      	
		IF (@GROUPLEVEL = 'PSD')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE,SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, "      
			SET @STRGROUPBY = @STRGROUPBY + "OPTION_TYPE,YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE) ,SAUDA_DATE "      
		END      
	END 
	ELSE
	BEGIN 
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE " END      
		IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + "AREA " END      
		IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + "REGION " END      
		IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + "BRANCH_CODE " END      
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "SUB_BROKER " END      
		IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "TRADER " END      
		IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + "FAMILY " END      
	END 
	SET @STRORDERBY = @STRGROUPBY      
	SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY      
	SET @STRORDERBY = "ORDER BY " + @STRORDERBY      
       
	SET @STRHAVING = ' HAVING '       
	SET @STRHAVING = @STRHAVING + " SUM(CASE WHEN TRADETYPE ='BT' THEN PQTY ELSE 0 END) + SUM(CASE WHEN TRADETYPE ='BT' THEN SQTY ELSE 0 END) > 0"
    
	IF @STRCOMPUTESUB <> ''       
	BEGIN       
		SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB       
		SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB      
	END     
	SET @STRCOMPUTE = REPLACE(@STRCOMPUTE,'SUM()','SUM(0)')
	SET @STRCOMPUTESUB = REPLACE(@STRCOMPUTESUB,'SUM()','SUM(0)')


	IF (@ISSUBLEVEL = 'YES')      
	BEGIN      
		PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + /*@STRHAVING +*/ @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)      
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + /*@STRHAVING +*/ @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)      
	END      
	ELSE      
	BEGIN      
		PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + /*@STRHAVING +*/  @STRORDERBY + @STRCOMPUTE)     
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + /*@STRHAVING +*/  @STRORDERBY + @STRCOMPUTE)     
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWREPORTS_LOT
-- --------------------------------------------------
CREATE   PROCEDURE [dbo].[RPT_PROC_FO_NEWREPORTS_LOT]
(
	 @REPORTNAME VARCHAR(50),      
	 @STATUSID VARCHAR(20),      
	 @STATUSNAME VARCHAR(50),      
	 @GROUPLEVEL VARCHAR(10), 		--FOR TOP LEVEL REPORT      
	 @GROUPSUBLEVEL VARCHAR(10), 		--FOR SUBSEQUENT DRILL-DOWNS      
	 @ORDERLEVEL VARCHAR(10), 		--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY      
	 @ORDERSUBLEVEL VARCHAR(10), 		--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY      
	 @FROMDATE VARCHAR(11),      
	 @TODATE VARCHAR(11),      
	 @WHATCODE VARCHAR(20),  		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT      
	 @FROMCODE VARCHAR(20),      
	 @TOCODE VARCHAR(20),      
	 @FROMPARTYCODE VARCHAR(20), 		--]--> FOR THE FROM AND TO PARTY CODES      
	 @TOPARTYCODE VARCHAR(20), 		--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'      
	 @ONEORMANY VARCHAR(20),      
	 @INSTTYPE VARCHAR(20),  		--]      
	 @OPTIONTYPE VARCHAR(20), 		--]      
	 @STRIKEPRICE MONEY,  			--]--> PRIMARY SEARCH FIELDS.      
	 @EXPIRYDATE VARCHAR(11), 		--]      
	 @SYMBOL VARCHAR(20), 			 --]      
	 @EX_BILLTYPE VARCHAR(1), 		--(SINGLE/MULTIPLE) - BILL      ]      
	 @EX_AUCTIONPART VARCHAR(20), 		--SAUDASUMMARY       ]      
	 @EX_REPORTBY VARCHAR(20), 		--(MKT PRICE/NET RATE) - SAUDASUMMARY    ]--> REPORT SPECIFIC      
	 @EX_RATE VARCHAR(20), 			--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER  ]--> SEARCH FEILDS      
	 @EX_MONEYTYPE VARCHAR(1), 		--(IN/AT/OUT) - IN THE MONEY      ]      
	 @EX_POSITION VARCHAR (1), 		--(LONG/SHORT) - IN THE MONEY     ]      
	 --END REPORT SPECIFIC SEARCH FEILDS 
	 @POSITIONAS VARCHAR(50),  --ACTUAL/LOT       
	 @DUMMY001 VARCHAR(50),      
	 @DUMMY002 VARCHAR(50),      
	 @DUMMY003 VARCHAR(50),      
	 @DUMMY004 VARCHAR(50),      
	 @DUMMY005 VARCHAR(50),      
	 @DUMMY006 VARCHAR(50),      
	 @DUMMY007 VARCHAR(50),      
	 @DUMMY008 VARCHAR(50),      
	 @DUMMY009 VARCHAR(50),      
	 @DUMMY010 VARCHAR(50)      
)
AS 


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


DECLARE      
	@STRSELECT VARCHAR(8000),      
	@STRSELECTTEMP VARCHAR(8000),      
	@STRSELECTAVRGRT VARCHAR(8000),      
	@STRSELECTCLOSEQTY VARCHAR(8000),      
	@STRFROM VARCHAR(8000),      
	@STRWHERE VARCHAR(8000),      
	@STRGROUPBY VARCHAR(8000),      
	@STRORDERBY VARCHAR(8000),      
	@STRCOMPUTE VARCHAR(8000),      
	@STRCOMPUTESUB VARCHAR(8000),      
	@STRHAVING VARCHAR(2000),      
	@ISSUBLEVEL VARCHAR(3),      
	@CODEID VARCHAR(20),      
	@COMMA VARCHAR(1)      
	SET @INSTTYPE = @INSTTYPE+"%"       
	SET @STRSELECT = ''      
	SET @STRSELECTTEMP = ''
	SET @STRSELECTAVRGRT = '' 
	SET @STRSELECTCLOSEQTY = ''     
	SET @STRFROM = ''      
	SET @STRWHERE = ''      
	SET @STRGROUPBY = ''      
	SET @STRORDERBY = ''      
	SET @STRCOMPUTE = ''      
	SET @STRCOMPUTESUB = ''      
	SET @ISSUBLEVEL = 'NO'      
	
	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END      
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END     
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END      
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END      
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END      
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END      

	IF @TODATE = ''      
	BEGIN       
		SELECT @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN (NOLOCK)
	END
	     
	
	SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,ISNULL(MIN(SAUDA_DATE),@FROMDATE),109),11) FROM FOBILLVALAN  (NOLOCK) WHERE SAUDA_DATE >=  @FROMDATE 

	
	IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END      
	IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END      
	IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END      
	IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END      
	IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END      
	IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END      
	IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END      
        
	SET @STRSELECT = @STRSELECT + "SELECT "      
	SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "      
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		IF (@GROUPLEVEL = 'PARTY')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, "      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      	
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "      
			END      
		END      
		IF (@GROUPLEVEL = 'SCRIP')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE,  MAX(EMAIL) AS EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,112), EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "      
			END      
		END       
		IF (@GROUPLEVEL = 'DATE')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS  EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + " YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE) "      
			END      
		END             
		IF (@GROUPLEVEL = 'INSTTYPE')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "      
			IF (@GROUPSUBLEVEL = 'PARTY')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE,  MAX(EMAIL) AS EMAIL, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'SCRIP')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@GROUPSUBLEVEL = 'DATE')      
			BEGIN      
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
				SET @ISSUBLEVEL = 'YES'      
			END      
			IF (@ISSUBLEVEL = 'YES')      
			BEGIN      
				SET @STRCOMPUTESUB = @STRCOMPUTESUB + "INST_TYPE "      
			END
		END       
		IF (@GROUPLEVEL = 'PSD')      
		BEGIN      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, SYMBOL, INST_TYPE, "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "OPTION_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE,YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE), "      
			SET @ISSUBLEVEL = 'YES'      
		END      
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		SET @STRSELECTTEMP = ''      
	END 
	ELSE
	BEGIN 
		IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, MAX(LEFT(PARTY_NAME,20)) AS PARTY_NAME, MAX(CLIENT_TYPE) AS CLIENT_TYPE, MAX(EMAIL) AS EMAIL, " END      
		IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + "AREA, " END      
		IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + "REGION, " END      
		IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + "BRANCH_CODE, " END      
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + "SUB_BROKER, " END      
		IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + "TRADER, " END      
		IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + "FAMILY, MAX(LEFT(FAMILYNAME,25)) AS FAMILYNAME, " END      
	END 
	--OPENQTY  
	IF @POSITIONAS = 'ACTUAL'
	BEGIN    
	SET @STRSELECTTEMP = ''      
	IF @GROUPLEVEL = 'DATE' OR @GROUPSUBLEVEL ='DATE'
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN  TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN SAUDA_DATE LIKE '" + @FROMDATE + "%' AND TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	END      
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPENQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
	END

	IF @POSITIONAS = 'LOT'
	BEGIN    
	SET @STRSELECTTEMP = ''      
	IF @GROUPLEVEL = 'DATE' OR @GROUPSUBLEVEL ='DATE'
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN  TRADETYPE = 'BF' AND BILLNO>0 THEN (PQTY/BILLNO)-(SQTY/BILLNO) ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN SAUDA_DATE LIKE '" + @FROMDATE + "%' AND TRADETYPE = 'BF' AND BILLNO>0 THEN (PQTY/BILLNO)-(SQTY/BILLNO) ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	END      
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPENQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP    
	END
	
	
	--PQTY      
	
    IF @POSITIONAS ='ACTUAL'
	BEGIN 
	SET @STRSELECTTEMP = ''     
	SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) "      
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	END    
	
	--SQTY      
	
	IF @POSITIONAS ='ACTUAL'  
	BEGIN
	SET @STRSELECTTEMP = ''    
	SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "      
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP 
	END 

	
	--PLOT      
	
	IF @POSITIONAS = 'LOT'
	BEGIN
	SET @STRSELECTTEMP = '' 
	SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN (PQTY/BILLNO) ELSE PQTY END ELSE 0 END)) "          
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP 
	END   
	
	--SLOT      
	
	IF @POSITIONAS ='LOT'
	BEGIN 
	SET @STRSELECTTEMP = ''
	SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN (SQTY/BILLNO) ELSE SQTY END ELSE 0 END)) "          
	SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP 
	END     
   

	IF (@EX_RATE = 'MKTRATE')      
	BEGIN      
		IF (@EX_REPORTBY = 'STRIKE')      
		BEGIN      
			--PAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = '' 
			IF @POSITIONAS = 'ACTUAL'
			BEGIN 	     
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP 
			END
			--NETLOT      
			SET @STRSELECTTEMP = '' 
			IF @POSITIONAS = 'LOT'
			BEGIN
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0  THEN (PQTY/BILLNO) ELSE PQTY END ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN (SQTY/BILLNO) ELSE SQTY END ELSE 0 END)) "     
    
			--SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' AND BILLNO >0 THEN (PQTY/BILLNO) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' AND BILLNO >0 THEN (SQTY/BILLNO) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP 
			END          
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "    
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA' THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + " THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) " */

			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*CASE WHEN STRIKE_PRICE > 0  THEN STRIKE_PRICE ELSE PRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE ELSE SRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"     

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
		IF (@EX_REPORTBY = 'EXCHG')      
		BEGIN      
			--PAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''
			IF @POSITIONAS = 'ACTUAL' 
			BEGIN     
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
			--NETLOT      
			SET @STRSELECTTEMP = ''
			IF @POSITIONAS = 'LOT'
			BEGIN 
			--SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN (PQTY/BILLNO)  ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN (SQTY/BILLNO)  END ELSE 0 END)) "              
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' AND PQTY>0 THEN PQTY/BILLNO ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' AND SQTY>0 THEN SQTY/BILLNO ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END            
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + " THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "  
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      */

			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE ELSE PRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE ELSE SRATE END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END 	
		IF (@EX_REPORTBY = 'PRICE')      
		BEGIN      
			--PAMT - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - MKTRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY 
			IF @POSITIONAS = 'ACTUAL'
			BEGIN     
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
			--NETLOT 
			IF @POSITIONAS = 'LOT'
			BEGIN     
			SET @STRSELECTTEMP = ''  
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN (PQTY/BILLNO) ELSE PQTY END ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN (SQTY/BILLNO) ELSE SQTY END ELSE 0 END)) "      
       
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP 
			END       
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA' "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " ( THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END))) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      */
			/*
			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*PRATE)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*SRATE)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"*/

			SET @STRSELECTAVRGRT = ''      
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PRATE*PQTY) ELSE 0 END)) - "      
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SRATE*SQTY) ELSE 0 END))) "      
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "/SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
		IF (@EX_REPORTBY = 'BOTH')      
		BEGIN      
			--PAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT'  THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY 
			IF @POSITIONAS = 'ACTUAL'
			BEGIN     
			SET @STRSELECTTEMP = ''
			--SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "          
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END  
			IF @POSITIONAS = 'LOT'
			BEGIN     
			SET @STRSELECTTEMP = ''  
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN PQTY/BILLNO ELSE PQTY END ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN CASE WHEN BILLNO >0 THEN SQTY/BILLNO ELSE SQTY END ELSE 0 END)) "    
			--SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' AND BILNO > 0 THEN (PQTY/BILLNO) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' AND BILNO > 0  THEN (SQTY/BILLNO) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END     
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+PRATE)*PQTY) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE+SRATE)*SQTY) ELSE 0 END)) )/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "
			/*
			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END*(STRIKE_PRICE+PRATE))/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END*(STRIKE_PRICE+SRATE))/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"*/

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
	END 
	IF (@EX_RATE = 'NETRATE')      
	BEGIN      
		IF (@EX_REPORTBY = 'STRIKE')      
		BEGIN      
			--PAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "    
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "( THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      */

			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN STRIKE_PRICE>0 THEN STRIKE_PRICE*CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END ELSE PAMT END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE*CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END ELSE SAMT END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
		IF (@EX_REPORTBY = 'EXCHG')      
		BEGIN      
			--PAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--PRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SRATE - NETRATE + STRIKE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA' "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "( THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*PQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (STRIKE_PRICE*SQTY) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "ELSE "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) END)) ) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      */

			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN STRIKE_PRICE>0 THEN STRIKE_PRICE*CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END ELSE PAMT END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE*CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END ELSE SAMT END)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END  	
		IF (@EX_REPORTBY = 'PRICE')      
		BEGIN      
			--PAMT - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END)"      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SAMT - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - NETRATE + PRICE      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN"      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA' "
			SET @STRSELECTTEMP = @STRSELECTTEMP + " ( THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END))) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      */
	
			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(PAMT)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(SAMT)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"
			
			/*
			SET @STRSELECTAVRGRT = ''      
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "((SUM(CASE WHEN TRADETYPE = 'BT' THEN (PAMT) ELSE 0 END)) - "      
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (SAMT) ELSE 0 END))) "      
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "/SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)" 
			*/	

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
		IF (@EX_REPORTBY = 'BOTH')      
		BEGIN      
			--PAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--PRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT'  THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			
			--SAMT - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--SRATE - MKTRATE + BOTH      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) > 0 THEN "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END) "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "/ "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SRATE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETQTY      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETQTY, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--NETAMT      
			SET @STRSELECTTEMP = ''      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END)) "      
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), "       
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS NETAMT, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
			--AVG. PRICE      
			SET @STRSELECTTEMP = ''      
			/*SET @STRSELECTTEMP = @STRSELECTTEMP + "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT'  AND AUCTIONPART <> 'CA'  THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "( AND AUCTIONPART <> 'CA'  THEN (SQTY) ELSE 0 END) <> 0 "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*PQTY)+PAMT) ELSE 0 END)) - "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN ((STRIKE_PRICE*SQTY)+SAMT) ELSE 0 END))) / "      
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN (PQTY) ELSE 0 END) - SUM(CASE WHEN TRADETYPE = 'BT' THEN (SQTY) ELSE 0 END)) ELSE 0 END) "      */

			SET @STRSELECTAVRGRT = "(CASE WHEN SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) > SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN STRIKE_PRICE>0 THEN STRIKE_PRICE*CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END ELSE 0 END + PAMT)/SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "WHEN  SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)  > 0"
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "THEN SUM(CASE WHEN STRIKE_PRICE >0 THEN STRIKE_PRICE*CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END ELSE 0 END + SAMT)/SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END) "
			SET @STRSELECTAVRGRT = @STRSELECTAVRGRT + "ELSE 0 END)"

			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
			SET @STRSELECTTEMP = @STRSELECTAVRGRT + "AS AVGPRICE, "      
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
		END      
	END

	--CLOSEQTY
	IF @POSITIONAS = 'ACTUAL'
	BEGIN	      
	SET @STRSELECTTEMP = ''      
	SET @STRSELECTTEMP = ''      
	IF @GROUPLEVEL = 'DATE' OR @GROUPSUBLEVEL ='DATE'
	BEGIN      
		SET @STRSELECTCLOSEQTY = "(SUM(CASE WHEN   TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) + "       
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) - "      
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTCLOSEQTY =  "(SUM(CASE WHEN SAUDA_DATE LIKE '" + @FROMDATE + "%' AND  TRADETYPE = 'BF' THEN PQTY-SQTY ELSE 0 END)) + "       
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN PQTY ELSE 0 END)) - "      
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' THEN SQTY ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	END      
	SET @STRSELECTTEMP = @STRSELECTCLOSEQTY + "AS CLOSEQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
	SET @STRSELECTTEMP = ''
	END  

   --CLOSE LOT
	IF @POSITIONAS = 'LOT'
	BEGIN
	SET @STRSELECTTEMP = ''      
	SET @STRSELECTTEMP = ''      
	IF @GROUPLEVEL = 'DATE' OR @GROUPSUBLEVEL ='DATE'
	BEGIN      
		SET @STRSELECTCLOSEQTY = "(SUM(CASE WHEN   TRADETYPE = 'BF' AND BILLNO >0 THEN (PQTY/BILLNO)-(SQTY/BILLNO) ELSE 0 END)) + "       
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' AND BILLNO >0 THEN (PQTY/BILLNO) ELSE 0 END)) - "      
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' AND BILLNO >0 THEN (SQTY/BILLNO) ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0),  "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTCLOSEQTY =  "(SUM(CASE WHEN SAUDA_DATE LIKE '" + @FROMDATE + "%' AND  TRADETYPE = 'BF' AND BILLNO>0 THEN (PQTY/BILLNO)-(SQTY/BILLNO) ELSE 0 END)) + "       
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' AND BILLNO >0 THEN (PQTY/BILLNO) ELSE 0 END)) - "      
		SET @STRSELECTCLOSEQTY = @STRSELECTCLOSEQTY + "(SUM(CASE WHEN TRADETYPE = 'BT' AND BILLNO >0 THEN (SQTY/BILLNO) ELSE 0 END)) "       
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "),  "       
	END      
	SET @STRSELECTTEMP = @STRSELECTCLOSEQTY + "AS CLOSEQTY, "      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
	SET @STRSELECTTEMP = ''
	END  


	IF (@EX_RATE = 'NETRATE')      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		SET @STRSELECTTEMP = @STRSELECTTEMP +" SUM(SBILLAMT - PBILLAMT)  - (SUM(SERVICE_TAX) + SUM(TURN_TAX) + SUM(SEBI_TAX) + SUM(BROKER_NOTE) + SUM(INS_CHRG) + SUM(OTHER_CHRG)) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ")  "      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "      
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = ''      
		SET @STRSELECTTEMP = @STRSELECTTEMP +" SUM(SBILLAMT - PBILLAMT + PBROKAMT + SBROKAMT) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ")  "      
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS PROFITORLOSS, "      
	END

	--PROFIT/LOSS      
	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP   
	SET @STRSELECTTEMP = ''   
     

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')  AND (@FROMDATE  = @TODATE )  
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + " CL_RATE = (CASE WHEN SUM(PQTY+SQTY) <> 0 THEN  ABS(SUM((PQTY + SQTY)*CL_RATE) / SUM(PQTY + SQTY)) ELSE 0 END ),0 "       
	END      
	ELSE      
	BEGIN      
		SET @STRSELECTTEMP = @STRSELECTTEMP + " CL_RATE = 0,0 "       
	END      
	--SET @STRCOMPUTE = @STRCOMPUTE + "SUM(0)  "       

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')
	BEGIN
		SET @STRSELECTTEMP = @STRSELECTTEMP + " , EXPIRYORD = CONVERT(VARCHAR,EXPIRYDATE,112) "       
	END

	SET @STRSELECT = @STRSELECT + @STRSELECTTEMP      
	SET @STRSELECTTEMP = "" 


	

	SET @STRFROM = @STRFROM + " FROM "      
	SET @STRFROM = @STRFROM + " FOBILLVALAN (NOLOCK) " 

	--PRINT @STRFROM     
	
	SET @STRWHERE = @STRWHERE + "WHERE "       
	SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "      
	SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "      
	IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END      
	SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "      
	SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "      
	SET @STRWHERE = @STRWHERE + "AUCTIONPART LIKE '" + @EX_AUCTIONPART + "' AND  "      
	SET @STRWHERE = @STRWHERE + "PQTY +SQTY > 0 AND "        

	IF (@FROMCODE = '' AND @TOCODE = '')      
	BEGIN      
		SET @STRWHERE = @STRWHERE + " ISNULL(" + @CODEID + ",'') LIKE '%' AND "      
	END      
	ELSE      
	BEGIN      
		SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') >= '" + @FROMCODE + "' AND "      
		SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') <= '" + @TOCODE + "' AND "      
	END  
	IF (@FROMDATE = '' AND @TODATE = '')      
	BEGIN      
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "      
	END      
	ELSE      
	BEGIN      
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "      
		SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "      
	END      
	IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))      
	BEGIN      
		SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "      
		SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "      
	END      
        
	/*LOGIN CONDITIONS*/      	
	
	SET @STRWHERE = @STRWHERE + "'" + @STATUSNAME + "' = "
	SET @STRWHERE = @STRWHERE + "		(CASE "
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'BRANCH' THEN BRANCH_CODE"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'SUBBROKER' THEN SUB_BROKER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'TRADER' THEN TRADER"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'FAMILY' THEN FAMILY"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'AREA' THEN AREA"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'REGION' THEN REGION"
	SET @STRWHERE = @STRWHERE + "			WHEN '" + @STATUSID +"' = 'CLIENT' THEN PARTY_CODE"
	SET @STRWHERE = @STRWHERE + "			ELSE "
	SET @STRWHERE = @STRWHERE + "		'BROKER'"
	SET @STRWHERE = @STRWHERE + "		END)    "

	/*END - LOGIN CONDITIONS*/
	
	SET @COMMA = ''      
	SET @STRGROUPBY = @STRGROUPBY + @COMMA      
	
	IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))      
	BEGIN      
		IF (@GROUPLEVEL = 'PARTY')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END      
		END      	
		IF (@GROUPLEVEL = 'SCRIP')      
		BEGIN      
			SET @STRGROUPBY =   + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY /*+ @COMMA + "INST_TYPE "*/ END      
		END      	
		IF (@GROUPLEVEL = 'DATE')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END      
		END      	
		IF (@GROUPLEVEL = 'INSTTYPE')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "INST_TYPE "      
			SET @COMMA = ', '      
			IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END      
			IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END      
			IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE),SAUDA_DATE " END      
		END      	
		IF (@GROUPLEVEL = 'PSD')      
		BEGIN      
			SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE,SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, "      
			SET @STRGROUPBY = @STRGROUPBY + "OPTION_TYPE,YEAR(SAUDA_DATE),MONTH(SAUDA_DATE),DAY(SAUDA_DATE) ,SAUDA_DATE "      
		END      
	END 
	ELSE
	BEGIN 
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE " END      
		IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + "AREA " END      
		IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + "REGION " END      
		IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + "BRANCH_CODE " END      
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "SUB_BROKER " END      
		IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "TRADER " END      
		IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + "FAMILY " END      
	END 

	IF (@GROUPSUBLEVEL ='SCRIP' OR @GROUPLEVEL = 'SCRIP')
	BEGIN
		SET @STRGROUPBY = REPLACE(@STRGROUPBY," ","")

		IF (CHARINDEX('EXPIRYDATE',RTRIM(LTRIM(@STRGROUPBY))) > 0)
		BEGIN
			SET @STRGROUPBY = LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1) + "CONVERT(VARCHAR,EXPIRYDATE,112)," + RIGHT(@STRGROUPBY,LEN(@STRGROUPBY)-LEN(LEFT(@STRGROUPBY,CHARINDEX('EXPIRYDATE',@STRGROUPBY)-1))) + " "      
		END	
	END

	SET @STRORDERBY = @STRGROUPBY      
	SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY      
	SET @STRORDERBY = "ORDER BY " + @STRORDERBY      
       
	SET @STRHAVING = ' HAVING ' 
	
	IF @POSITIONAS = 'ACTUAL'
	BEGIN      
	SET @STRHAVING = @STRHAVING + " SUM(CASE WHEN TRADETYPE ='BT' THEN PQTY ELSE 0 END) + SUM(CASE WHEN TRADETYPE ='BT' THEN SQTY ELSE 0 END) > 0"
    END
	IF @POSITIONAS = 'LOT'
	BEGIN      
	SET @STRHAVING = @STRHAVING + " SUM(CASE WHEN TRADETYPE ='BT' AND BILLNO>0 THEN (PQTY/BILLNO) ELSE 0 END) + SUM(CASE WHEN TRADETYPE ='BT' AND BILLNO > 0 THEN (SQTY/BILLNO) ELSE 0 END) > 0"
    END
	 IF @STRCOMPUTESUB <> ''       
	 BEGIN       
		  SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB       
		  SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB      
	 END           

	SET @STRCOMPUTE = REPLACE(@STRCOMPUTE,'SUM()','SUM(0)')
	SET @STRCOMPUTESUB = REPLACE(@STRCOMPUTESUB,'SUM()','SUM(0)')
    

	--PRINT @STRSELECT + @STRFROM + @STRWHERE
	
	IF (@ISSUBLEVEL = 'YES')      
	BEGIN      
		PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)      
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING + @STRORDERBY + @STRCOMPUTESUB + @STRCOMPUTE)      
	END      
	ELSE      
	BEGIN      
		PRINT (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING +  @STRORDERBY + @STRCOMPUTE)     
		EXEC (@STRSELECT + @STRFROM + @STRWHERE + @STRGROUPBY + @STRHAVING +  @STRORDERBY + @STRCOMPUTE)     
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWREPORTSSEARCH
-- --------------------------------------------------
CREATE    PROC
[dbo].[RPT_PROC_FO_NEWREPORTSSEARCH]
@STATUSID VARCHAR (20),
@STATUSNAME VARCHAR (20),
@STRIDENTIFIER VARCHAR(20),
@STRSEARCHSTRING VARCHAR(50),
@STRREPORTFOR VARCHAR(25),
@STRFROMCODE VARCHAR(25),
@STRTOCODE VARCHAR(25),
@STRFROMPARTYCODE VARCHAR(25),
@STRTOPARTYCODE VARCHAR(25),
@STRFROMDATE VARCHAR(25),
@STRTODATE VARCHAR(25),
@STRINSTTYPE VARCHAR(25),
@STRSYMBOL VARCHAR(25),
@STREXPIRYDATE VARCHAR(25),
@STROPTIONTYPE VARCHAR(25),
@STRSTRIKEPRICE MONEY,
@STRAUCTIONPART VARCHAR(25),
@STRDUMMY001 VARCHAR(25),
@STRDUMMY002 VARCHAR(25),
@STRDUMMY003 VARCHAR(25),
@STRDUMMY004 VARCHAR(25),
@STRDUMMY005 VARCHAR(25),
@STRDUMMY006 VARCHAR(25),
@STRDUMMY007 VARCHAR(25),
@STRDUMMY008 VARCHAR(25),
@STRDUMMY009 VARCHAR(25),
@BLNFROMUPDATEPAGE VARCHAR(25)
AS
--EXEC RPT_PROC_FO_NEWREPORTSSEARCH 'BROKER', 'BROKER', 'INSTTYPE', '', 'CLIENT', '0', 'ZZZ', '', '', 'FEB 16 2006', 'FEB 16 2006', '', '', '', '', -1, '', '', '', '', '', '', '', '', '', '', 'FALSE'
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


DECLARE
	@STRSQL VARCHAR(8000),
	@STRWHATTOLIST VARCHAR(50)
	SET @STRINSTTYPE = @STRINSTTYPE+"%" 
	IF (@STRREPORTFOR = 'REGION')  BEGIN SET @STRWHATTOLIST = "REGION" END
	IF (@STRREPORTFOR = 'AREA')  BEGIN SET @STRWHATTOLIST = "AREA" END
	IF (@STRREPORTFOR = 'BRANCH')  BEGIN SET @STRWHATTOLIST = "BRANCH_CODE" END
	IF (@STRREPORTFOR = 'SUBBROKER')  BEGIN SET @STRWHATTOLIST = "SUB_BROKER" END
	IF (@STRREPORTFOR = 'TRADER')  BEGIN SET @STRWHATTOLIST = "TRADER" END
	IF (@STRREPORTFOR = 'FAMILY')  BEGIN SET @STRWHATTOLIST = "FAMILY" END
	IF (@STRREPORTFOR = 'CLIENT')  BEGIN SET @STRWHATTOLIST = "PARTY_CODE" END
	IF (@BLNFROMUPDATEPAGE = 'FALSE')
	BEGIN
		--FROM CODE
		IF (@STRIDENTIFIER = 'FROMCODE')
		BEGIN
			IF (@STRREPORTFOR = 'CLIENT')
			BEGIN
				SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE, PARTY_NAME FROM FOBILLVALAN  (NOLOCK) WHERE "
			END
			ELSE
			BEGIN
				SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM FOBILLVALAN  (NOLOCK) WHERE "
			END
			--SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM FOBILLVALAN  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + @STRWHATTOLIST + " LIKE '" + @STRSEARCHSTRING + "%' "
		
			IF @STRTOCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
		--TO CODE
		IF (@STRIDENTIFIER = 'TOCODE')
		BEGIN
			IF (@STRREPORTFOR = 'CLIENT')
			BEGIN
				SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE, PARTY_NAME FROM FOBILLVALAN  (NOLOCK) WHERE "
			END
			ELSE
			BEGIN
				SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM FOBILLVALAN  (NOLOCK) WHERE "
			END
			SET @STRSQL = @STRSQL + @STRWHATTOLIST + " LIKE '" + @STRSEARCHSTRING + "%' "
			IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
		--FROM DATE
		IF (@STRIDENTIFIER = 'FROMDATE')
		BEGIN
			--SET @STRWHATTOLIST = 'SAUDA_DATE'
			SET @STRSQL = "SELECT DISTINCT SAUDA_DATE, CONVERT(VARCHAR, SAUDA_DATE, 103) AS FROM_CODE FROM FOBILLVALAN  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + "SAUDA_DATE LIKE '" + @STRSEARCHSTRING + "%' "
		
			IF @STRTODATE <> '' BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
		
			IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
		
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--TO DATE
		IF (@STRIDENTIFIER = 'TODATE')
		BEGIN
			--SET @STRWHATTOLIST = 'SAUDA_DATE'
			SET @STRSQL = "SELECT DISTINCT SAUDA_DATE, CONVERT(VARCHAR, SAUDA_DATE, 103) AS FROM_CODE FROM FOBILLVALAN  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + "SAUDA_DATE LIKE '" + @STRSEARCHSTRING + "%' "
		
			IF @STRFROMDATE <> '' BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
	
			IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
	
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + "' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + "' " END
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--INSTTYPE
		IF (@STRIDENTIFIER = 'INSTTYPE')
		BEGIN
			--SET @STRWHATTOLIST = 'INST_TYPE'
			SET @STRSQL = "SELECT DISTINCT F2.INST_TYPE AS FROM_CODE FROM FOSCRIP2 F2  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + "F2.INST_TYPE LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			--IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--SYMBOL
		IF (@STRIDENTIFIER = 'SYMBOL')
		BEGIN
			--SET @STRWHATTOLIST = 'SYMBOL'
			SET @STRSQL = "SELECT DISTINCT F2.SYMBOL AS FROM_CODE FROM FOSCRIP2 F2  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + "F2.SYMBOL LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			--IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--EXPIRY DATE
		IF (@STRIDENTIFIER = 'EXPIRYDATE')
		BEGIN
			--SET @STRWHATTOLIST = 'EXPIRYDATE'
			SET @STRSQL = "SELECT DISTINCT CONVERT(VARCHAR, F2.EXPIRYDATE, 103) AS FROM_CODE FROM FOSCRIP2 F2  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + "F2.EXPIRYDATE LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			--IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE = '" + @STREXPIRYDATE + "' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--OPTION TYPE
		IF (@STRIDENTIFIER = 'OPTIONTYPE')
		BEGIN
			--SET @STRWHATTOLIST = 'OPTION_TYPE'
			SET @STRSQL = "SELECT DISTINCT F2.OPTION_TYPE AS FROM_CODE FROM FOSCRIP2 F2  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + "F2.OPTION_TYPE LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			--IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
	
		--STRIKE PRICE
		IF (@STRIDENTIFIER = 'STRIKEPRICE')
		BEGIN
			--SET @STRWHATTOLIST = 'STRIKE_PRICE'
			SET @STRSQL = "SELECT DISTINCT F2.STRIKE_PRICE AS FROM_CODE FROM FOSCRIP2 F2  (NOLOCK) WHERE "
			SET @STRSQL = @STRSQL + "CONVERT(VARCHAR, F2.STRIKE_PRICE) LIKE '" + @STRSEARCHSTRING + "%' "
		
			--IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
	
			--IF (@STRFROMCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
			--IF (@STRTOCODE <> '') BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
			
			--IF (@STRFROMDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE >= '" + @STRFROMDATE + " 00:00:00' " END
			--IF (@STRTODATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND SAUDA_DATE <= '" + @STRTODATE + " 23:59:59' " END
			IF (@STRINSTTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND INST_TYPE LIKE  '" + @STRINSTTYPE + "' " END
			IF (@STRSYMBOL <> '') BEGIN SET @STRSQL = @STRSQL + " AND SYMBOL = '" + @STRSYMBOL + "' " END
			IF (@STREXPIRYDATE <> '') BEGIN SET @STRSQL = @STRSQL + " AND EXPIRYDATE LIKE '" + @STREXPIRYDATE + "%' " END
			IF (@STROPTIONTYPE <> '') BEGIN SET @STRSQL = @STRSQL + " AND OPTION_TYPE = '" + @STROPTIONTYPE + "' " END
			--IF (@STRSTRIKEPRICE <> -1) BEGIN SET @STRSQL = @STRSQL + " AND STRIKE_PRICE = " + CONVERT(VARCHAR, @STRSTRIKEPRICE) + " " END
		END
		IF @STATUSID = 'BROKER'
		BEGIN
		  SET @STRSQL = @STRSQL + " AND 1=1 "
		END
		ELSE
		BEGIN
		  SET @STRSQL = @STRSQL + " AND ISNULL(AREA,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'AREA' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "  
		  SET @STRSQL = @STRSQL + "ISNULL(REGION,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'REGION' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "  
		  SET @STRSQL = @STRSQL + "ISNULL(BRANCH_CODE,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'BRANCH' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "  
		  SET @STRSQL = @STRSQL + "ISNULL(SUB_BROKER,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'SUBBROKER' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "  
		  SET @STRSQL = @STRSQL + "ISNULL(TRADER,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'TRADER' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "  
		  SET @STRSQL = @STRSQL + "ISNULL(FAMILY,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'FAMILY' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "  
		  SET @STRSQL = @STRSQL + "ISNULL(PARTY_CODE,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'CLIENT' THEN '" + @STATUSNAME + "' ELSE '%' END) "  
		END
		  /*END - LOGIN CONDITIONS*/  
	END --IF (@BLNFROMUPDATEPAGE = 'FALSE')
	ELSE --IF (@BLNFROMUPDATEPAGE = 'FALSE')
	BEGIN
		IF (@STRIDENTIFIER = 'FROMCODE')
		BEGIN
			SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM CLIENT2 WHERE "
			SET @STRSQL = @STRSQL + @STRWHATTOLIST + " LIKE '" + @STRSEARCHSTRING + "%' "
			IF @STRTOCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " <= '" + @STRTOCODE + "' " END
		END
		IF (@STRIDENTIFIER = 'TOCODE')
		BEGIN
			SET @STRSQL = "SELECT DISTINCT " + @STRWHATTOLIST + " AS FROM_CODE FROM CLIENT2 WHERE "
			SET @STRSQL = @STRSQL + @STRWHATTOLIST + " LIKE '" + @STRSEARCHSTRING + "%' "
			IF @STRFROMCODE <> '' BEGIN SET @STRSQL = @STRSQL + " AND " + @STRWHATTOLIST + " >= '" + @STRFROMCODE + "' " END
		END
	END --ELSE OF IF (@BLNFROMUPDATEPAGE = 'FALSE')
	SET @STRSQL = @STRSQL + "ORDER BY (1)"
	PRINT @STRIDENTIFIER + '-->IDENTIFIER'
	PRINT @STRSEARCHSTRING + '-->SEARCH STRING'
	PRINT @STRREPORTFOR + '-->REPORT FOR'
	PRINT @STRFROMCODE + '-->FROM CODE'
	PRINT @STRTOCODE + '-->TO CODE'
	PRINT @STRFROMPARTYCODE + '-->FROM PARTY CODE'
	PRINT @STRTOPARTYCODE + '-->TO PARTY CODE'
	PRINT @STRFROMDATE + '-->FROM DATE'
	PRINT @STRTODATE + '-->TO DATE'
	PRINT @STRINSTTYPE + '-->INST. TYPE'
	PRINT @STRSYMBOL + '-->SYMBOL'
	PRINT @STREXPIRYDATE + '-->EXPIRY DATE'
	PRINT @STROPTIONTYPE + '-->OPTION TYPE'
	PRINT CONVERT(VARCHAR, @STRSTRIKEPRICE) + '-->STRIKE PRICE'
	PRINT @STRAUCTIONPART + '-->AUC PART'
	PRINT @STRSQL
	EXEC(@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_PROC_FO_NEWTURNOVER
-- --------------------------------------------------
CREATE    PROC
[dbo].[RPT_PROC_FO_NEWTURNOVER]
	@REPORTNAME VARCHAR(50),
	@STATUSID VARCHAR(20),
	@STATUSNAME VARCHAR(50),
	@GROUPLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT
	@GROUPSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS
	@ORDERLEVEL VARCHAR(10),	--FOR TOP LEVEL REPORT - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@ORDERSUBLEVEL VARCHAR(10),	--FOR SUBSEQUENT DRILL-DOWNS - THIS VARIABLE MAY OR MAY NOT BE USED EVENTUALLY
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11),
	@WHATCODE VARCHAR(20),		--REGION/BROKER/BRANCH/SUBBROKER/TRADER/FAMILY/CLIENT
	@FROMCODE VARCHAR(20),
	@TOCODE VARCHAR(20),
	@FROMPARTYCODE VARCHAR(20),	--]--> FOR THE FROM AND TO PARTY CODES
	@TOPARTYCODE VARCHAR(20),	--]--> IF THE LEVEL IS ANYTHING OTHER THAN 'PARTY/CLIENT'
	@ONEORMANY VARCHAR(20),
	@INSTTYPE VARCHAR(20),		--]
	@OPTIONTYPE VARCHAR(20),	--]
	@STRIKEPRICE MONEY,		--]-->	PRIMARY SEARCH FIELDS.
	@EXPIRYDATE VARCHAR(11),	--]
	@SYMBOL VARCHAR(20),		--]
	--REPORT SPECIFIC SEARCH FEILDS
	--PLS DECALRE WITH PREFIX 'EX_' - (EX = EXTRA)				
	@EX_BILLTYPE VARCHAR(1),	--(SINGLE/MULTIPLE) - BILL						]
	@EX_AUCTIONPART VARCHAR(20),	--SAUDASUMMARY							]
	@EX_REPORTBY VARCHAR(20),	--(MKT PRICE/NET RATE) - SAUDASUMMARY				]-->	REPORT SPECIFIC
	@EX_RATE VARCHAR(20),		--(PREMIUM/BOTH/STRIKE) - SAUDASUMMARY, TURNOVER		]-->	SEARCH FEILDS
	@EX_MONEYTYPE VARCHAR(1),	--(IN/AT/OUT) - IN THE MONEY						]
	@EX_POSITION VARCHAR (1),	--(LONG/SHORT) - IN THE MONEY					]
	--END REPORT SPECIFIC SEARCH FEILDS
	@ULCLRATE VARCHAR(50),
	@CLTRANSACTIONS VARCHAR(50),
	@DUMMY003 VARCHAR(50),
	@DUMMY004 VARCHAR(50),
	@DUMMY005 VARCHAR(50),
	@DUMMY006 VARCHAR(50),
	@DUMMY007 VARCHAR(50),
	@DUMMY008 VARCHAR(50),
	@DUMMY009 VARCHAR(50),
	@DUMMY010 VARCHAR(50)
AS

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

DECLARE
	@STRSELECT VARCHAR(8000),
	@STRSELECTTEMP VARCHAR(8000),
	@STRFROM VARCHAR(8000),
	@STRWHERE VARCHAR(8000),
	@STRGROUPBY VARCHAR(8000),
	@STRORDERBY VARCHAR(8000),
	@STRCOMPUTE VARCHAR(8000),
	@STRCOMPUTESUB VARCHAR(8000),
	@ISSUBLEVEL VARCHAR(3),
	@CODEID VARCHAR(20),
	@COMMA VARCHAR(1)
	SET @INSTTYPE = @INSTTYPE+"%" 
	IF @OPTIONTYPE = '' BEGIN SET @OPTIONTYPE = "%" END
	--IF @STRIKEPRICE = '', -1 IS PASSED FROM THE ASP PAGE
	IF @EXPIRYDATE = '' BEGIN SET @EXPIRYDATE = "%" END
	IF @SYMBOL = '' BEGIN SET @SYMBOL = "%" END
	
	IF @EX_AUCTIONPART = '' BEGIN SET @EX_AUCTIONPART = "%" END
	IF @EX_REPORTBY = '' BEGIN SET @EX_REPORTBY = "%" END
	IF @EX_RATE = '' BEGIN SET @EX_RATE = "%" END
	SET @STRSELECT = ''
	SET @STRSELECTTEMP = ''
	SET @STRFROM = ''
	SET @STRWHERE = ''
	SET @STRGROUPBY = ''
	SET @STRORDERBY = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTE = ''
	SET @STRCOMPUTESUB = ''
	SET @ISSUBLEVEL = 'NO'
	IF (@FROMDATE = '' AND @TODATE = '')
	BEGIN 
		SELECT @FROMDATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11), @TODATE = LEFT(CONVERT(VARCHAR,MAX(SAUDA_DATE),109),11) FROM FOBILLVALAN (NOLOCK)
	END 
	IF (@REPORTNAME = 'TURNOVER')
	BEGIN
		IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @CODEID = 'PARTY_CODE' END
		IF (@WHATCODE = 'REGION') BEGIN SET @CODEID = 'REGION' END
		IF (@WHATCODE = 'AREA') BEGIN SET @CODEID = 'AREA' END
		IF (@WHATCODE = 'BRANCH') BEGIN SET @CODEID = 'BRANCH_CODE' END
		IF (@WHATCODE = 'SUBBROKER') BEGIN SET @CODEID = 'SUB_BROKER' END
		IF (@WHATCODE = 'TRADER') BEGIN SET @CODEID = 'TRADER' END
		IF (@WHATCODE = 'FAMILY') BEGIN SET @CODEID = 'FAMILY' END
		
		SET @STRSELECT = @STRSELECT + "SELECT "
		SET @STRCOMPUTE = @STRCOMPUTE + "COMPUTE "
		IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			SET @STRSELECTTEMP = ''
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME,MAX(CLIENT_TYPE) AS  CLIENT_TYPE, MAX(EMAIL) AS EMAIL, "
				IF (@GROUPSUBLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'DATE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'INSTTYPE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "PARTY_CODE "
				END
			END
			IF (@GROUPLEVEL = 'SCRIP')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
				IF (@GROUPSUBLEVEL = 'PARTY')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME,MAX(CLIENT_TYPE) AS  CLIENT_TYPE,MAX(EMAIL) EMAIL, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'DATE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'INSTTYPE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "
				END
			END
	
			IF (@GROUPLEVEL = 'DATE')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
				IF (@GROUPSUBLEVEL = 'PARTY')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME,MAX(CLIENT_TYPE) AS  CLIENT_TYPE,MAX(EMAIL) EMAIL, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'INSTTYPE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "SAUDA_DATE "
				END
			END
	
			IF (@GROUPLEVEL = 'INSTTYPE')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "INST_TYPE, "
				IF (@GROUPSUBLEVEL = 'PARTY')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME,MAX(CLIENT_TYPE) AS  CLIENT_TYPE,MAX(EMAIL) EMAIL, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'SCRIP')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@GROUPSUBLEVEL = 'DATE')
				BEGIN
					SET @STRSELECTTEMP = @STRSELECTTEMP + "CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
					SET @ISSUBLEVEL = 'YES'
				END
				IF (@ISSUBLEVEL = 'YES')
				BEGIN
					SET @STRCOMPUTESUB = @STRCOMPUTESUB + "INST_TYPE "
				END
			END
	
			IF (@GROUPLEVEL = 'PSD')
			BEGIN
				SET @STRSELECTTEMP = @STRSELECTTEMP + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME,MAX(CLIENT_TYPE) AS  CLIENT_TYPE, MAX(EMAIL), SYMBOL, INST_TYPE, CONVERT(VARCHAR,EXPIRYDATE,103) AS EXPIRYDATE, STRIKE_PRICE, "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "OPTION_TYPE, CONVERT(VARCHAR,SAUDA_DATE,103) AS SAUDA_DATE, "
				SET @ISSUBLEVEL = 'YES'
			END
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			SET @STRSELECTTEMP = ''
		END /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
		ELSE /*IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
		BEGIN /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
			IF (@WHATCODE = 'CLIENT') BEGIN SET @STRSELECT = @STRSELECT + "PARTY_CODE, MAX(LEFT(PARTY_NAME,25)) AS PARTY_NAME,MAX(CLIENT_TYPE) AS CLIENT_TYPE,MAX(EMAIL) EMAIL, " END
			IF (@WHATCODE = 'REGION') BEGIN SET @STRSELECT = @STRSELECT + "REGION, " END
			IF (@WHATCODE = 'AREA') BEGIN SET @STRSELECT = @STRSELECT + "AREA, " END
			IF (@WHATCODE = 'BRANCH') BEGIN SET @STRSELECT = @STRSELECT + "BRANCH_CODE, " END
			IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRSELECT = @STRSELECT + "SUB_BROKER, " END
			IF (@WHATCODE = 'TRADER') BEGIN SET @STRSELECT = @STRSELECT + "TRADER, " END
			IF (@WHATCODE = 'FAMILY') BEGIN SET @STRSELECT = @STRSELECT + "FAMILY, LEFT(FAMILYNAME,25) AS FAMILYNAME, " END
		END /*ELSE OF IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))*/
		
		IF (@EX_RATE = 'MKTRATE')
		BEGIN
			--FUTURES TRADED VALUE - MKTRATE - COMMON
			SET @STRSELECTTEMP = ''
			SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'EA'  AND AUCTIONPART <> 'CA' "
			SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (CASE WHEN PQTY+SQTY>0 THEN (PAMT-PBROKAMT+SAMT+SBROKAMT) ELSE 0 END) ELSE 0 END)) "
			SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
			SET @STRSELECTTEMP = @STRSELECTTEMP + "AS FUTURESTRADEDVALUE, "
			SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			IF (@EX_REPORTBY = 'STRIKE')
			BEGIN
				--OPTIONS TRADED AMT - MKTRATE + STRIKE
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ((PQTY+SQTY)*STRIKE_PRICE) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE
				IF (@ULCLRATE = 'EX')
				BEGIN
					SET @STRSELECTTEMP = ''
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE) ELSE 0 END)) "
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					SET @STRSELECTTEMP = '0 '
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				END
				ELSE /*OF IF (@ULCLRATE = 'EX')*/
				BEGIN
					--ASSIGNED AMT - ASG/BOTH + STRIKE
					IF (@ULCLRATE = 'ASG')
					BEGIN
						SET @STRSELECTTEMP = '0 '
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END
					ELSE /*OF IF (@ULCLRATE = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE
 
					BEGIN
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/
				END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (CASE WHEN PQTY+SQTY>0 THEN (PAMT-PBROKAMT+SAMT+SBROKAMT) ELSE 0 END) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA' ) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (CASE WHEN PQTY+SQTY>0 THEN (PAMT-PBROKAMT+SAMT+SBROKAMT) ELSE 0 END) ELSE 0 END)) + "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' ) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL((PQTY+SQTY)*STRIKE_PRICE,0) ELSE 0 END))  "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
			IF (@EX_REPORTBY = 'PRICE')
			BEGIN
				--OPTIONS TRADED AMT - MKTRATE + PRICE
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (((CASE WHEN PQTY+SQTY>0 THEN (PAMT-PBROKAMT+SAMT+SBROKAMT) ELSE 0 END))) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--EXCERCISE AMT - MKTRATE + EX/BOTH + PRICE
				IF (@ULCLRATE = 'EX')
				BEGIN
					SET @STRSELECTTEMP = ''
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*SRATE) ELSE 0 END)) "
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					SET @STRSELECTTEMP = '0 '
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				END
				ELSE /*OF IF (@ULCLRATE = 'EX')*/
				BEGIN
					--ASSIGNED AMT - ASG/BOTH + PRICE
					IF (@ULCLRATE = 'ASG')
					BEGIN
						SET @STRSELECTTEMP = '0 '
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*PRATE) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END
					ELSE /*OF IF (@ULCLRATE = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE
 
					BEGIN
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*SRATE) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*PRATE) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/
				END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (CASE WHEN PQTY+SQTY>0 THEN (PAMT-PBROKAMT+SAMT+SBROKAMT) ELSE 0 END) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA' ) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (CASE WHEN PQTY+SQTY>0 THEN (PAMT-PBROKAMT+SAMT+SBROKAMT) ELSE 0 END) ELSE 0 END)) + "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' ) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (CASE WHEN PQTY+SQTY>0 THEN (PAMT-PBROKAMT+SAMT+SBROKAMT) ELSE 0 END) ELSE 0 END))  "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
			IF (@EX_REPORTBY = 'BOTH')
			BEGIN
				--OPTIONS TRADED AMT - MKTRATE + BOTH
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (((PQTY+SQTY)*STRIKE_PRICE) + (CASE WHEN PQTY+SQTY>0 THEN (PAMT-PBROKAMT+SAMT+SBROKAMT) ELSE 0 END)) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--EXCERCISE AMT - MKTRATE + EX/BOTH + BOTH
				IF (@ULCLRATE = 'EX')
				BEGIN
					SET @STRSELECTTEMP = ''
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*(STRIKE_PRICE+SRATE)) ELSE 0 END)) "
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					SET @STRSELECTTEMP = '0 '
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				END
				ELSE /*OF IF (@ULCLRATE = 'EX')*/
				BEGIN
					--ASSIGNED AMT - ASG/BOTH + BOTH
					IF (@ULCLRATE = 'ASG')
					BEGIN
						SET @STRSELECTTEMP = '0 '
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*(STRIKE_PRICE+PRATE)) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END
					ELSE /*OF IF (@ULCLRATE = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE
 
					BEGIN
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*(STRIKE_PRICE+SRATE)) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*(STRIKE_PRICE+PRATE)) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/
				END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (CASE WHEN PQTY+SQTY>0 THEN (PAMT-PBROKAMT+SAMT+SBROKAMT) ELSE 0 END) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA' ) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (CASE WHEN PQTY+SQTY>0 THEN (PAMT-PBROKAMT+SAMT+SBROKAMT) ELSE 0 END) ELSE 0 END)) + "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' ) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL((PRATE+STRIKE_PRICE)*PQTY + (SRATE+STRIKE_PRICE)*SQTY,0) ELSE 0 END))  "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
			IF (@EX_REPORTBY = 'EXCHG')
			BEGIN
				--OPTIONS TRADED AMT - MKTRATE + BOTH
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (((CASE WHEN PQTY+SQTY>0 THEN (PAMT-PBROKAMT+SAMT+SBROKAMT) ELSE 0 END))) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* OPTIONS TRADED AMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS OPTIONSTRADEDVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				--EXCERCISE AMT - MKTRATE + EX/BOTH + BOTH
				IF (@ULCLRATE = 'EX')
				BEGIN
					SET @STRSELECTTEMP = ''
					SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
					SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE) ELSE 0 END)) "
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					SET @STRSELECTTEMP = '0 '
					SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
					SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
					SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				END
				ELSE /*OF IF (@ULCLRATE = 'EX')*/
				BEGIN
					--ASSIGNED AMT - ASG/BOTH + BOTH
					IF (@ULCLRATE = 'ASG')
					BEGIN
						SET @STRSELECTTEMP = '0 '
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
	
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END
					ELSE /*OF IF (@ULCLRATE = 'ASG')*/
					--CONTROL WILL BE PASSED HERE IF 'BOTH' IS CHOOSEN FOR THE U/L CL. RATE
 
					BEGIN
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (SQTY*STRIKE_PRICE) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* EXCERCISE AMT - MKTRATE + EX/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS EXCERCISEVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
						SET @STRSELECTTEMP = ''
						SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA')"
						SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (PQTY*STRIKE_PRICE) ELSE 0 END)) "
						SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* ASSIGNED AMT - ASG/BOTH + STRIKE */ "	--FOR THE SUB TOTAL
						SET @STRSELECTTEMP = @STRSELECTTEMP + "AS ASSIGNMENTVALUE, "
						SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
					END /*OF THE ELSE OF IF (@ULCLRATE = 'ASG')*/
				END /*OF THE ELSE OF IF (@ULCLRATE = 'EX')*/
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN INST_TYPE LIKE 'FUT%' AND AUCTIONPART = 'EA' AND AUCTIONPART <> 'CA' "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (CASE WHEN PQTY+SQTY>0 THEN (PAMT-PBROKAMT+SAMT+SBROKAMT) ELSE 0 END) ELSE 0 END)) "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLOSEOUTVALUE, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
				SET @STRSELECTTEMP = ''
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'FUT%' AND AUCTIONPART <> 'CA' ) "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (CASE WHEN PQTY+SQTY>0 THEN (PAMT-PBROKAMT+SAMT+SBROKAMT) ELSE 0 END) ELSE 0 END)) + "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART <> 'EA') "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN (CASE WHEN PQTY+SQTY>0 THEN (PAMT-PBROKAMT+SAMT+SBROKAMT) ELSE 0 END) ELSE 0 END)) + "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "(SUM(CASE WHEN (INST_TYPE LIKE 'OPT%' AND AUCTIONPART <> 'CA' AND AUCTIONPART = 'EA') "
				SET @STRSELECTTEMP = @STRSELECTTEMP + "THEN ISNULL(STRIKE_PRICE*PQTY + STRIKE_PRICE*SQTY,0) ELSE 0 END))  "
				SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* PAMT - MKTRATE + STRIKE */ "	--FOR THE SUB TOTAL
				SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TOTAL, "
				SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
			END
		END	/*IF (@EX_RATE = 'NETRATE')*/
		--BROKERAGE
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "ISNULL(SUM(PBROKAMT + SBROKAMT),0) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* BROKERAGE */ "	--FOR THE SUB TOTAL
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS BROKERAGE, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--SERVICE TAX
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "ISNULL(SUM(SERVICE_TAX- EXSER_TAX),0) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SERVICE TAX */ "	--FOR THE SUB TOTAL
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SERVICETAX, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--TURNOVER TAX
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(TURN_TAX) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* TURNOVER TAX */ "	--FOR THE SUB TOTAL
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS TURNOVERTAX, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--SEBI TAX
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(SEBI_TAX) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* SEBI TAX */ "	--FOR THE SUB TOTAL
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS SEBITAX, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--STAMP DUTY
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(BROKER_NOTE) "
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* STAMP DUTY */ "	--FOR THE SUB TOTAL
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS STAMPDUTY, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--CLEARING CHARGES
		SET @STRSELECTTEMP = ''
		--SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(CL_CHRG - EXCL_CHRG) "
		SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(OTHER_CHRG) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + "), /* CLEARING CHARGES */ "	--FOR THE SUB TOTAL
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS CLEARINGCHARGES, "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP
		--STT CHARGES
		SET @STRSELECTTEMP = ''
		SET @STRSELECTTEMP = @STRSELECTTEMP + "SUM(INS_CHRG) "      
		SET @STRCOMPUTE = @STRCOMPUTE + "SUM(" + @STRSELECTTEMP + ") /* STT CHARGES */ "	--FOR THE SUB TOTAL
		SET @STRSELECTTEMP = @STRSELECTTEMP + "AS INS_CHRG "
		SET @STRSELECT = @STRSELECT + @STRSELECTTEMP

		SET @STRFROM = @STRFROM + "FROM "
		SET @STRFROM = @STRFROM + "FOBILLVALAN (NOLOCK)"
	
		SET @STRWHERE = @STRWHERE + "WHERE "
		SET @STRWHERE = @STRWHERE + "TRADETYPE = 'BT' AND "
	
		SET @STRWHERE = @STRWHERE + "INST_TYPE LIKE '" + @INSTTYPE + "' AND "
		SET @STRWHERE = @STRWHERE + "OPTION_TYPE LIKE '" + @OPTIONTYPE + "' AND "
		IF (@STRIKEPRICE > -1) BEGIN SET @STRWHERE = @STRWHERE + "STRIKE_PRICE = " + CONVERT(VARCHAR,@STRIKEPRICE) + " AND " END
		SET @STRWHERE = @STRWHERE + "LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) LIKE '" + @EXPIRYDATE + "' AND "
		SET @STRWHERE = @STRWHERE + "SYMBOL LIKE '" + @SYMBOL + "' AND "
		  IF (@FROMCODE = '' AND @TOCODE = '')      
		  BEGIN      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" + @CODEID + ",'') LIKE '%' AND "      
		  END      
		  ELSE      
		  BEGIN      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') >= '" + @FROMCODE + "' AND "      
		   SET @STRWHERE = @STRWHERE + " ISNULL(" +@CODEID + ",'') <= '" + @TOCODE + "' AND "      
		  END      
		IF (@FROMDATE = '' AND @TODATE = '')
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE LIKE '%' AND "
		END
		ELSE
		BEGIN
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE >= '" + @FROMDATE + " 00:00:00' AND "
			SET @STRWHERE = @STRWHERE + "SAUDA_DATE <= '" + @TODATE + " 23:59:59' AND "
		END
		IF ((@FROMPARTYCODE <> '' AND @TOPARTYCODE <> ''))
		BEGIN
			SET @STRWHERE = @STRWHERE + "PARTY_CODE >= '" + @FROMPARTYCODE + "' AND "
			SET @STRWHERE = @STRWHERE + "PARTY_CODE <= '" + @TOPARTYCODE + "' AND "
		END
		  /*LOGIN CONDITIONS*/      
		IF @STATUSID = 'BROKER'
		BEGIN
		  SET @STRWHERE = @STRWHERE + "1=1 "
		END
		ELSE
		BEGIN
		  SET @STRWHERE = @STRWHERE + "ISNULL(AREA,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'AREA' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "      
		  SET @STRWHERE = @STRWHERE + "ISNULL(REGION,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'REGION' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "      
		  SET @STRWHERE = @STRWHERE + "ISNULL(BRANCH_CODE,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'BRANCH' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "      
		  SET @STRWHERE = @STRWHERE + "ISNULL(SUB_BROKER,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'SUBBROKER' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "      
		  SET @STRWHERE = @STRWHERE + "ISNULL(TRADER,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'TRADER' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "      
		  SET @STRWHERE = @STRWHERE + "ISNULL(FAMILY,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'FAMILY' THEN '" + @STATUSNAME + "' ELSE '%' END) AND "      
		  SET @STRWHERE = @STRWHERE + "ISNULL(PARTY_CODE,'') LIKE (CASE WHEN '" + @STATUSID + "' = 'CLIENT' THEN '" + @STATUSNAME + "' ELSE '%' END) "      
		END
		  /*END - LOGIN CONDITIONS*/      
		SET @COMMA = ''
		SET @STRGROUPBY = @STRGROUPBY + @COMMA
		
		IF ((@ONEORMANY = 'DETAIL') OR (@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT'))
		BEGIN
			IF (@GROUPLEVEL = 'PARTY')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
				IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END
			END
			
			IF (@GROUPLEVEL = 'SCRIP')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END
				IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
				IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY /*+ @COMMA + "INST_TYPE "*/ END
			END
	
			IF (@GROUPLEVEL = 'DATE')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "SAUDA_DATE "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END
				IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				IF (@GROUPSUBLEVEL = 'INSTTYPE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "INST_TYPE " END
			END
	
			IF (@GROUPLEVEL = 'INSTTYPE')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "INST_TYPE "
				SET @COMMA = ', '
				IF (@GROUPSUBLEVEL = 'PARTY') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "PARTY_CODE " END
				IF (@GROUPSUBLEVEL = 'SCRIP') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE " END
				IF (@GROUPSUBLEVEL = 'DATE') BEGIN SET @STRGROUPBY = @STRGROUPBY + @COMMA + "SAUDA_DATE " END
			END
	
			IF (@GROUPLEVEL = 'PSD')
			BEGIN
				SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE,  SYMBOL, INST_TYPE, EXPIRYDATE, STRIKE_PRICE, "
				SET @STRGROUPBY = @STRGROUPBY + "OPTION_TYPE, SAUDA_DATE "
			END
		END /*IF (@ONEORMANY = 'DETAIL')*/
		ELSE /*IF (@ONEORMANY = 'DETAIL')*/
		BEGIN /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/
			IF ((@WHATCODE = 'BROKER') OR (@WHATCODE = 'CLIENT')) BEGIN SET @STRGROUPBY = @STRGROUPBY + "PARTY_CODE " END
			IF (@WHATCODE = 'REGION') BEGIN SET @STRGROUPBY = @STRGROUPBY + "REGION " END
			IF (@WHATCODE = 'AREA') BEGIN SET @STRGROUPBY = @STRGROUPBY + "AREA " END
			IF (@WHATCODE = 'BRANCH') BEGIN SET @STRGROUPBY = @STRGROUPBY + "BRANCH_CODE " END
			IF (@WHATCODE = 'SUBBROKER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "SUB_BROKER " END
			IF (@WHATCODE = 'TRADER') BEGIN SET @STRGROUPBY = @STRGROUPBY + "TRADER " END
			IF (@WHATCODE = 'FAMILY') BEGIN SET @STRGROUPBY = @STRGROUPBY + "FAMILY, FAMILYNAME " END
		END /*ELSE OF IF (@ONEORMANY = 'DETAIL')*/
		SET @STRORDERBY = @STRGROUPBY
		SET @STRGROUPBY = "GROUP BY " + @STRGROUPBY
		SET @STRORDERBY = "ORDER BY " + @STRORDERBY
	END/*IF (@REPORTNAME = "NETPOSITION")*/
	IF @STRCOMPUTESUB <> '' 
	BEGIN 
		SET @STRCOMPUTESUB = "BY " + @STRCOMPUTESUB 
		SET @STRCOMPUTESUB = @STRCOMPUTE + @STRCOMPUTESUB
	END

	 IF (@ISSUBLEVEL = 'YES')      
	 BEGIN      
	  PRINT (@STRSELECT + @STRFROM + '  ' + @STRWHERE + '  ' + @STRGROUPBY + '  ' + @STRORDERBY + '  ' + @STRCOMPUTESUB + '  ' + @STRCOMPUTE)      
	  EXEC (@STRSELECT + @STRFROM + '  ' + @STRWHERE + '  ' + @STRGROUPBY + '  ' + @STRORDERBY + '  ' + @STRCOMPUTESUB + '  ' + @STRCOMPUTE)      
	 END      
	 ELSE      
	 BEGIN      
	  PRINT (@STRSELECT + @STRFROM + '  ' + @STRWHERE + '  ' +  @STRGROUPBY + '  ' + @STRORDERBY + '  ' + @STRCOMPUTE)      
	  EXEC (@STRSELECT + @STRFROM + '  ' + @STRWHERE + '  ' +  @STRGROUPBY + '  ' + @STRORDERBY + '  ' + @STRCOMPUTE)      
	 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_REGIONLISTING
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_REGIONLISTING]
	(
    	@FROMREGION VARCHAR(15),
	@TOREGION VARCHAR(15),
	@FROMBRANCH VARCHAR(15),
	@TOBRANCH VARCHAR(15)
	)
	
AS
    IF @FROMREGION = '' BEGIN SET @FROMREGION = '0'  END
    IF @TOREGION = '' BEGIN SET @TOREGION = 'ZZZZZZ' END
    IF @FROMBRANCH = '' BEGIN SET @FROMBRANCH = '0'  END
    IF @TOBRANCH = '' BEGIN SET @TOBRANCH = 'ZZZZZZ' END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 
			REGIONCODE = UPPER(REGIONCODE),
			DESCRIPTION = UPPER(DESCRIPTION),
			BRANCH_CODE = UPPER(BRANCH_CODE)

FROM 
    REGION

WHERE
    REGIONCODE BETWEEN @FROMREGION AND @TOREGION
    AND BRANCH_CODE BETWEEN @FROMBRANCH AND @TOBRANCH
    

ORDER BY
		REGIONCODE,DESCRIPTION,BRANCH_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_SBUMASTER
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_SBUMASTER] 
(
	@SBU_CODEFROM VARCHAR(10),
	@SBU_CODETO   VARCHAR(10)
	
)
AS
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
IF @SBU_CODEFROM = '' BEGIN SET @SBU_CODEFROM = '0' END
IF @SBU_CODETO = '' BEGIN SET @SBU_CODETO = 'ZZZ' END

BEGIN
	SELECT 
		SBU_CODE,SBU_NAME,SBU_ADDR1,SBU_ADDR2,SBU_ADDR3,SBU_STATE,SBU_CITY,SBU_ZIP,SBU_PHONE1,SBU_PHONE2,SBU_TYPE,SBU_PARTY_CODE  
	FROM 
		SBU_MASTER (NOLOCK)
	WHERE 
		SBU_CODE >= @SBU_CODEFROM
		AND SBU_CODE <= @SBU_CODETO
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_SPANSALEPUR
-- --------------------------------------------------
CREATE   PROCEDURE [dbo].[RPT_SPANSALEPUR]
@PARTYCODE VARCHAR(12),
@SDATE VARCHAR(10)
AS
SELECT DISTINCT  PARTY_CODE,SYMBOL,EXPIRYDATE,INST_TYPE,OPTION_TYPE,STRIKE_PRICE ,PQTY,SQTY FROM BBGSPANSALEPUR
WHERE  PQTY <> SQTY AND EXPIRYDATE >= @SDATE AND PARTY_CODE LIKE @PARTYCODE + '%'
GROUP BY PARTY_CODE,SYMBOL,EXPIRYDATE,INST_TYPE,OPTION_TYPE,STRIKE_PRICE,PQTY,SQTY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_STAMPDUTY_NEW
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_STAMPDUTY_NEW]   
(  
@START_DATE VARCHAR(11),   
@END_DATE VARCHAR(11)  
)  
   
    
AS      
  
SELECT    
 TOTAMT = SUM(TRADEQTY * PRICE ),     
 CL_TYPE,     
 L_STATE       
INTO  
 #STAMPDUTY    
FROM    
 FOSETTLEMENT,   
 CLIENT2,   
 CLIENT1  
WHERE    
 SAUDA_DATE >= @START_DATE   
 AND SAUDA_DATE <= @END_DATE + ' 23:59'      
 AND FOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE           
 AND CLIENT1.CL_CODE = CLIENT2.CL_CODE           
 AND AUCTIONPART NOT LIKE 'C%'   
 -- AND AUCTIONPART NOT LIKE 'E%'    
 AND TRADEQTY > 0          
GROUP BY    
 CL_TYPE,   
 L_STATE        
  
---------------------------------------------------------------------  
  
INSERT INTO #STAMPDUTY      
SELECT    
 TOTAMT = SUM(TRADEQTY * PRICE ),    
 CL_TYPE,    
 L_STATE       
FROM     
 PRADNYA.DBO.HISTORY_FOSETTLEMENT_ACECOMM,   
 CLIENT2,   
 CLIENT1     
WHERE  
 SAUDA_DATE >= @START_DATE   
 AND SAUDA_DATE <= @END_DATE + ' 23:59'      
 AND PRADNYA.DBO.HISTORY_FOSETTLEMENT_ACECOMM.PARTY_CODE = CLIENT2.PARTY_CODE           
 AND CLIENT1.CL_CODE = CLIENT2.CL_CODE           
 AND AUCTIONPART NOT LIKE 'C%'    
 --AND AUCTIONPART NOT LIKE 'E%'          
 AND TRADEQTY > 0          
GROUP BY    
 CL_TYPE,   
 L_STATE          
  
---------------------------------------------------------------------  
  
SELECT         
 TOTALAMT = CONVERT(NUMERIC(36, 12), SUM(TOTAMT)),      
 CL_TYPE, L_STATE      
INTO  
 #STAMPDUTY_REPORT      
FROM     
 #STAMPDUTY     
WHERE  
 L_STATE = 'MAHARASHTRA'      
GROUP BY    
 CL_TYPE,   
 L_STATE  
  
---------------------------------------------------------------------  
  
INSERT INTO #STAMPDUTY_REPORT      
SELECT         
 TOTALAMT = SUM(TOTAMT),      
 CL_TYPE,    
 L_STATE = FOOWNER.STATE      
FROM     
 #STAMPDUTY,   
 FOOWNER  
WHERE  
 NOT EXISTS (SELECT STATE FROM STATE_MASTER WHERE STATE = L_STATE )      
GROUP BY     
 CL_TYPE,   
 FOOWNER.STATE      
  
---------------------------------------------------------------------  
  
INSERT INTO #STAMPDUTY_REPORT      
SELECT         
 TOTALAMT = SUM(TOTAMT),      
 CL_TYPE,    
 L_STATE = 'OTHER'      
FROM  
 #STAMPDUTY    
WHERE  
 EXISTS (SELECT STATE FROM STATE_MASTER WHERE STATE = L_STATE)        
 AND L_STATE <> 'MAHARASHTRA'  
GROUP BY  
 CL_TYPE,   
 L_STATE      
      
---------------------------------------------------------------------  
  
SELECT       
 TOTTURN              = ISNULL(SUM(TOTALAMT),0),      
 TOTTURNOTHERSTATE    = ISNULL(SUM(CASE WHEN L_STATE <> 'MAHARASHTRA' THEN TOTALAMT ELSE 0 END),0),      
 TOTTURNMAHSTATE      = ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA' THEN TOTALAMT ELSE 0 END),0),      
 TOTSTAMPMAHSTATE     = ISNULL(SUM(CASE WHEN L_STATE = 'MAHARASHTRA'   
     THEN CEILING((TOTALAMT*0.001)/100)  
     ELSE 0 END),0),  
 TOTSTAMPOTHERSTATE   = ISNULL(SUM(CASE WHEN L_STATE <> 'MAHARASHTRA'   
     THEN CEILING((TOTALAMT*0.001)/100)  
     ELSE 0 END),0)  
FROM  
 #STAMPDUTY_REPORT      
      
DROP TABLE #STAMPDUTY_REPORT      
DROP TABLE #STAMPDUTY      
    
    
---------------------------------------------------------------------

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_STAMPDUTY_NEW_REPORT
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_STAMPDUTY_NEW_REPORT] (@START_DATE VARCHAR(11), @END_DATE VARCHAR(11), @STATE VARCHAR(50))      
  
	AS        

	SELECT        
	 TOTAMT = SUM(CASE  
	   WHEN AUCTIONPART = 'EA'   
	   THEN  
	   (CASE  
	   WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART = 'EA'     
			  THEN  
		TRADEQTY * STRIKE_PRICE
	   ELSE  
		TRADEQTY * PRICE   
	   END)   
	  ELSE 0  
	  END),   
	 TOTALAMT = SUM(CASE  
	   WHEN AUCTIONPART = ''   
	   THEN  
	   (CASE  
	   WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART = 'EA'     
			  THEN  
		TRADEQTY * STRIKE_PRICE    
	   ELSE  
		TRADEQTY * PRICE  
	   END)   
	  ELSE 0  
	  END),  
	 BROKCHRG = SUM(CASE  
		 WHEN   
		AUCTIONPART = 'EA'   
		THEN  
			(CASE WHEN BROKERNOTE = 1 THEN BROKER_CHRG ELSE 0 END)
		ELSE  
		0  
		END),   
	 BROKERCHRG = SUM(CASE  
		 WHEN   
		AUCTIONPART = ''   
		THEN  
			(CASE WHEN BROKERNOTE = 1 THEN BROKER_CHRG ELSE 0 END)     
		ELSE  
		0  
		END),  
	 ATSTAMP = CONVERT(NUMERIC(18,4),0),                
	 ADSTAMP = CONVERT(NUMERIC(18,4),0),  
	 CL_TYPE,         
	 L_STATE           
	INTO      
	 #STAMPDUTY        
	FROM        
	 FOSETTLEMENT, CLIENT2, CLIENT1           
	WHERE        
	 SAUDA_DATE >= @START_DATE AND SAUDA_DATE <= @END_DATE + ' 23:59'          
	 AND FOSETTLEMENT.PARTY_CODE = CLIENT2.PARTY_CODE               
	 AND CLIENT1.CL_CODE = CLIENT2.CL_CODE               
	 AND TRADEQTY > 0 AND PRICE > 0         
	 AND AUCTIONPART NOT LIKE 'C%'          
	 AND L_STATE LIKE @STATE 
	GROUP BY        
	 CL_TYPE, L_STATE            

	     
	INSERT INTO #STAMPDUTY          
	SELECT        
	 TOTAMT = SUM(CASE  
	   WHEN AUCTIONPART = 'EA'   
	   THEN  
	   (CASE  
	   WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART = 'EA'     
			  THEN  
		TRADEQTY * STRIKE_PRICE    
	   ELSE  
		TRADEQTY * PRICE  
	   END)   
	  ELSE 0  
	  END),   
	 TOTALAMT = SUM(CASE  
	   WHEN AUCTIONPART = ''   
	   THEN  
	   (CASE  
	   WHEN INST_TYPE LIKE 'OPT%' AND AUCTIONPART = 'EA'     
			  THEN  
		TRADEQTY * STRIKE_PRICE    
	   ELSE  
		TRADEQTY * PRICE  
	   END)   
	  ELSE 0  
	  END),   
	 BROKCHRG = SUM(CASE  
		 WHEN   
		AUCTIONPART = 'EA'   
		THEN  
			 (CASE WHEN BROKERNOTE = 1 THEN BROKER_CHRG ELSE 0 END)     
		ELSE  
		0  
		END),   
	   
	 BROKERCHRG = SUM(CASE  
		 WHEN   
		AUCTIONPART = ''   
		THEN  
			(CASE WHEN BROKERNOTE = 1 THEN BROKER_CHRG ELSE 0 END)      
		ELSE  
		0  
		END),  
	 ATSTAMP = CONVERT(NUMERIC(18,4),0),                
	 ADSTAMP = CONVERT(NUMERIC(18,4),0),  
	 CL_TYPE,        
	 L_STATE           
	FROM         
	 PRADNYA.DBO.HISTORY_FOSETTLEMENT_ACCCOMM, CLIENT2, CLIENT1         
	WHERE      
	 SAUDA_DATE >= @START_DATE AND SAUDA_DATE <= @END_DATE + ' 23:59'          
	 AND PRADNYA.DBO.HISTORY_FOSETTLEMENT_ACCCOMM.PARTY_CODE = CLIENT2.PARTY_CODE               
	 AND CLIENT1.CL_CODE = CLIENT2.CL_CODE               
	 AND TRADEQTY > 0 AND PRICE > 0                  
	 AND L_STATE LIKE @STATE  
	 AND AUCTIONPART NOT LIKE 'C%'          
	 AND BROKERNOTE = 1
	GROUP BY        
	 CL_TYPE, L_STATE     
	  
	  
	UPDATE #STAMPDUTY SET   
	ATSTAMP = (TOTALAMT * TRDSTAMPDUTY / 100),  
	ADSTAMP = (TOTAMT * DELSTAMPDUTY / 100)  
	FROM STATE_MASTER  
	WHERE L_STATE = STATE  
	  
	UPDATE #STAMPDUTY SET   
	ATSTAMP = (TOTALAMT * TRDSTAMPDUTY / 100),  
	ADSTAMP = (TOTAMT * DELSTAMPDUTY / 100)  
	FROM STATE_MASTER  
	WHERE STATE = 'MAHARASHTRA'  
	AND L_STATE NOT IN (SELECT STATE FROM STATE_MASTER)  
	    
	SELECT   
	L_STATE,    
	PRODELAMT = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE = 'PRO'   
		 THEN TOTAMT  
		 ELSE 0  
		   END)),  
	PROTRDAMT = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE = 'PRO'   
		 THEN TOTALAMT  
		 ELSE 0  
		   END)),  
	NRMTRDAMT = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE <> 'PRO'   
		 THEN TOTALAMT  
		 ELSE 0  
		   END)),  
	NRMDELAMT = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE <> 'PRO'   
		 THEN TOTAMT  
		 ELSE 0  
		   END)),  
	PROTRD = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE = 'PRO'  
		 THEN BROKERCHRG  
		 ELSE 0  
		   END)),  
	PRODEL = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE = 'PRO'   
		 THEN BROKCHRG  
		 ELSE 0  
		   END)),  
	NRMTRD = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE <> 'PRO'   
		 THEN BROKERCHRG  
		 ELSE 0  
		   END)),  
	NRMDEL = CONVERT(NUMERIC(18,4),   
			  SUM(CASE WHEN CL_TYPE <> 'PRO'   
		 THEN BROKCHRG  
		 ELSE 0  
		   END)),  
	PROTRD1 = CONVERT(NUMERIC(18,4),     
		SUM(CASE WHEN CL_TYPE = 'PRO'    
				 THEN ATSTAMP    
				 ELSE 0  
				END)),  
	PRODEL1 = CONVERT(NUMERIC(18,4),     
		SUM(CASE WHEN CL_TYPE = 'PRO'     
					   THEN ADSTAMP  
					  ELSE 0  
				 END)),      
	  
	NRMTRD1 = CONVERT(NUMERIC(18,4),     
		SUM(CASE WHEN CL_TYPE = 'PRO'     
					  THEN 0    
					  ELSE ATSTAMP  
				END)),  
	  
	NRMDEL1 = CONVERT(NUMERIC(18,4),     
		SUM(CASE WHEN CL_TYPE = 'PRO'     
					  THEN 0           
					  ELSE ADSTAMP       
				 END)),   
	TOTALAMT = CONVERT(NUMERIC(18,4), SUM(TOTAMT + TOTALAMT))    
	  
	INTO #STAMPDUTY_REPORT            
	FROM #STAMPDUTY      
	GROUP BY L_STATE   
	  
	SELECT EXCHANGE='MFO', SEGMENT='FUTURES',*,TOTALSTAMPDUTY = (PROTRD1+PRODEL1+NRMTRD1+NRMDEL1) FROM #STAMPDUTY_REPORT            
	ORDER BY L_STATE  
	  
	DROP TABLE #STAMPDUTY_REPORT        
	DROP TABLE #STAMPDUTY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_STT_MISMATCH
-- --------------------------------------------------



CREATE   PROC [dbo].[RPT_STT_MISMATCH] 
(
	@SAUDA_DATE VARCHAR(11),
	@FROMPARTY VARCHAR(10),
	@TOPARTY   VARCHAR(10),
	@FROMSCRIP VARCHAR(12),
	@TOSCRIP   VARCHAR(12),
	@INST_TYPE VARCHAR(6),
	@EXPIRY VARCHAR(11),
	@STKPRICE VARCHAR(18),
	@OPTTYPE VARCHAR(6),
	@DISFLAG VARCHAR(1), --'A - ALL, M -- MATCHED, U -- UNMATCHED
	@CHARGEFLAG VARCHAR(1), -- 'A -- ACTUAL, C -- CALCULATED,
	@REPBY VARCHAR(2) -- P - PARTY SUMMARY, S - SCRIP SUMMARY, PS -- PARTY SCRIP
)
AS

DECLARE @RECTYPE INT,
@COUNTER INT
SELECT @RECTYPE = (CASE WHEN @REPBY = 'P' THEN 20 ELSE 30 END),
@FROMSCRIP = (CASE WHEN @REPBY = 'P' THEN '' ELSE @FROMSCRIP END)

IF LEN(RTRIM(LTRIM(@SAUDA_DATE))) = 10
	BEGIN
		SET @SAUDA_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)
	END
IF LEN(RTRIM(LTRIM(@EXPIRY))) = 10
	BEGIN
		SET @EXPIRY = CONVERT(VARCHAR(11), CONVERT(DATETIME, @EXPIRY, 103), 109)
	END
-- EXEC RPT_STT_MISMATCH '18/02/2005', '0', 'ZZ', 'TISCO', 'TISCO', 'OPTSTK', '31/03/2005', '420.00', 'CA', 'A', 'A', 'PS'
-- EXEC RPT_STT_MISMATCH '18/02/2005', '0', 'ZZZZZ', '0', 'ZZZZZ', '%', '%', '%', '%', 'U', 'A', 'S' 
-- EXEC RPT_STT_MISMATCH '18/02/2005', '1611', '1611', '0', 'ZZZZZZ', '%', '%', '%', '%', 'U', 'A', 'PS' 
-- EXEC RPT_STT_MISMATCH '18/02/2005', '0', 'ZZZZZZ', 'NIFTY', 'NIFTY', 'OPTIDX', '24/02/2005', '2080', 'CE', 'U', 'A', 'PS' 
-- EXEC RPT_STT_MISMATCH '18/02/2005', '0', 'ZZ', '0', 'ZZZZZ', '%', '%', '%', '%', 'A', 'A', 'PS'
-- EXEC RPT_STT_MISMATCH '18/02/2005', '0', 'ZZZZZ', '0', 'ZZZZZ', 'A', 'C', 'S' 

SELECT
	SAUDA_DATE,
	BOPARTYCODE=PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE,
	BOSTT=SUM(TOTALSTT),
	EXPARTYCODE=CONVERT(VARCHAR(10),''),
	EXSTT=CONVERT(NUMERIC(18,4),0)
INTO
	#STT_CLT_1
FROM
	STT_CLIENTDETAIL
WHERE
	RECTYPE = @RECTYPE
	AND SAUDA_DATE LIKE @SAUDA_DATE + '%'
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	AND SYMBOL BETWEEN @FROMSCRIP AND @TOSCRIP
	AND INST_TYPE LIKE @INST_TYPE
	AND EXPIRYDATE LIKE @EXPIRY + '%'
	AND CONVERT(VARCHAR(18), STRIKE_PRICE) LIKE @STKPRICE + '%'
	AND OPTION_TYPE LIKE @OPTTYPE
GROUP BY
	SAUDA_DATE,
	PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE

IF @CHARGEFLAG = 'A' 
	BEGIN
		UPDATE
			#STT_CLT_1
		SET
			BOSTT = 0
		FROM
			FOCLIENTTAXES C
		WHERE
			C.PARTY_CODE = #STT_CLT_1.BOPARTYCODE
			AND SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO
			AND FUT_INSURANCE_CHRG = 0
			AND C.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	END

SELECT
	STT_DATE,
	EXPARTYCODE=PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE = (CASE WHEN LEFT(INST_TYPE,3) ='FUT' THEN '' ELSE OPTION_TYPE END),
	EXSTT=SUM(TOTALSTT)
INTO
	#STT_EXG
FROM
	STT_EXCHG
WHERE
	RECTYPE = @RECTYPE
	AND STT_DATE LIKE @SAUDA_DATE + '%'
	AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	AND SYMBOL BETWEEN @FROMSCRIP AND @TOSCRIP
	AND INST_TYPE LIKE @INST_TYPE
	AND EXPIRYDATE LIKE @EXPIRY + '%'
	AND CONVERT(VARCHAR(18), STRIKE_PRICE) LIKE @STKPRICE + '%'
	AND OPTION_TYPE LIKE @OPTTYPE
GROUP BY
	STT_DATE,
	PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	STRIKE_PRICE,
	(CASE WHEN LEFT(INST_TYPE,3) ='FUT' THEN '' ELSE OPTION_TYPE END)

/*========================================================
UPDATE ADDED TO HANDLE PARENTCODE 
========================================================*/  
UPDATE #STT_CLT_1  
SET    BOPARTYCODE = PARENTCODE 
FROM   CLIENT2 
WHERE  BOPARTYCODE = PARTY_CODE 

SELECT  SAUDA_DATE,  
        BOPARTYCODE,  
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE,
	BOSTT=SUM(BOSTT),
	EXPARTYCODE,
	EXSTT
INTO    #STT_CLT 
FROM    #STT_CLT_1 
GROUP BY SAUDA_DATE,  
        BOPARTYCODE,  
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE,
        EXPARTYCODE,  
        EXSTT  

/*========================================================
UPDATE ADDED TO HANDLE PARENTCODE 
========================================================*/  

UPDATE
	#STT_CLT
SET
	EXPARTYCODE = #STT_EXG.EXPARTYCODE,
	EXSTT = #STT_EXG.EXSTT
FROM
	#STT_EXG 
WHERE
	SAUDA_DATE = STT_DATE
	AND BOPARTYCODE = #STT_EXG.EXPARTYCODE 
	AND #STT_CLT.INST_TYPE = #STT_EXG.INST_TYPE
	AND #STT_CLT.SYMBOL = #STT_EXG.SYMBOL
	AND LEFT(#STT_CLT.EXPIRYDATE,11) = LEFT(#STT_EXG.EXPIRYDATE,11)
	AND #STT_CLT.STRIKE_PRICE = #STT_EXG.STRIKE_PRICE
	AND #STT_CLT.OPTION_TYPE = #STT_EXG.OPTION_TYPE

INSERT INTO
	#STT_CLT
SELECT
	STT_DATE,
	BOPARTYCODE = '',
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE,
	BOSTT = 0,
	EXPARTYCODE,
	EXSTT
FROM
	#STT_EXG
WHERE
	NOT EXISTS
		(
			SELECT
				BOPARTYCODE
			FROM
				#STT_CLT
			WHERE
				SAUDA_DATE = STT_DATE
				AND BOPARTYCODE = #STT_EXG.EXPARTYCODE
				AND #STT_CLT.INST_TYPE = #STT_EXG.INST_TYPE
				AND #STT_CLT.SYMBOL = #STT_EXG.SYMBOL
				AND LEFT(#STT_CLT.EXPIRYDATE,11) = LEFT(#STT_EXG.EXPIRYDATE,11)
				AND #STT_CLT.STRIKE_PRICE = #STT_EXG.STRIKE_PRICE
				AND #STT_CLT.OPTION_TYPE = #STT_EXG.OPTION_TYPE
		)

IF @REPBY = 'P' OR @REPBY = 'PS' 
	BEGIN
		IF @DISFLAG = 'A'
			BEGIN
				IF (SELECT COUNT(1) FROM #STT_CLT) > 0
					BEGIN
						SELECT
							SAUDA_DATE,
							BOPARTYCODE,
							INST_TYPE,
							SYMBOL,
							EXPIRYDATE = CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE,
							BOSTT,
							EXPARTYCODE,
							EXSTT,
							DIFF = (BOSTT - EXSTT)
						FROM
							#STT_CLT
						ORDER BY
							BOPARTYCODE,
							EXPARTYCODE,
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
						COMPUTE
							SUM(BOSTT),
							SUM(EXSTT),
							SUM(BOSTT - EXSTT)
					END
				ELSE
					BEGIN
						SELECT
							SAUDA_DATE,
							BOPARTYCODE,
							INST_TYPE,
							SYMBOL,
							EXPIRYDATE=CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE,
							BOSTT,
							EXPARTYCODE,
							EXSTT,
							DIFF = 0
						FROM
							#STT_CLT
						ORDER BY
							BOPARTYCODE,
							EXPARTYCODE,
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
					END
			END
		IF @DISFLAG = 'M'
			BEGIN
				IF (SELECT COUNT(1) FROM #STT_CLT WHERE BOSTT = EXSTT) > 0
					BEGIN
						SELECT
							SAUDA_DATE,
							BOPARTYCODE,
							INST_TYPE,
							SYMBOL,
							EXPIRYDATE=CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE,
							BOSTT,
							EXPARTYCODE,
							EXSTT,
							DIFF = (BOSTT - EXSTT)
						FROM
							#STT_CLT
						WHERE
							BOSTT = EXSTT
						ORDER BY
							BOPARTYCODE,
							EXPARTYCODE,
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
						COMPUTE
							SUM(BOSTT),
							SUM(EXSTT),
							SUM(BOSTT - EXSTT)
					END
				ELSE
					BEGIN
						SELECT
							SAUDA_DATE,
							BOPARTYCODE,
							INST_TYPE,
							SYMBOL,
							EXPIRYDATE=CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE,
							BOSTT,
							EXPARTYCODE,
							EXSTT,
							DIFF = 0
						FROM
							#STT_CLT
						WHERE
							BOSTT = EXSTT
						ORDER BY
							BOPARTYCODE,
							EXPARTYCODE,
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
					END
			END
		IF @DISFLAG = 'U'
			BEGIN
				IF (SELECT COUNT(1) FROM #STT_CLT WHERE BOSTT <> EXSTT) > 0
					BEGIN
						SELECT
							SAUDA_DATE,
							BOPARTYCODE,
							INST_TYPE,
							SYMBOL,
							EXPIRYDATE=CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE,
							BOSTT,
							EXPARTYCODE,
							EXSTT,
							DIFF = (BOSTT - EXSTT)
						FROM
							#STT_CLT
						WHERE
							BOSTT <> EXSTT
						ORDER BY
							BOPARTYCODE,
							EXPARTYCODE,
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
						COMPUTE
							SUM(BOSTT),
							SUM(EXSTT),
							SUM(BOSTT - EXSTT)
					END
				ELSE
					BEGIN
						SELECT
							SAUDA_DATE,
							BOPARTYCODE,
							INST_TYPE,
							SYMBOL,
							EXPIRYDATE=CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE,
							BOSTT,
							EXPARTYCODE,
							EXSTT,
							DIFF = 0
						FROM
							#STT_CLT
						WHERE
							BOSTT <> EXSTT
						ORDER BY
							BOPARTYCODE,
							EXPARTYCODE,
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
					END
			END
	END
ELSE
	BEGIN
		IF @DISFLAG = 'A'
			BEGIN
				IF (SELECT COUNT(1) FROM (SELECT 1 AS A FROM #STT_CLT GROUP BY SAUDA_DATE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE) A) > 0
					BEGIN
						SELECT
							SAUDA_DATE,
							INST_TYPE,
							SYMBOL,
							EXPIRYDATE=CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE,
							BOSTT=SUM(BOSTT),
							EXSTT=SUM(EXSTT),
							DIFF = ROUND(SUM(BOSTT),2) - ROUND(SUM(EXSTT),2)
						FROM
							#STT_CLT
						GROUP BY
							SAUDA_DATE,
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
						ORDER BY
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
						COMPUTE
							SUM(SUM(BOSTT)),
							SUM(SUM(EXSTT)),
							SUM(ROUND(SUM(BOSTT),2) - ROUND(SUM(EXSTT),2))
					END
				ELSE
					BEGIN
						SELECT
							SAUDA_DATE,
							INST_TYPE,
							SYMBOL,
							EXPIRYDATE=CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE,
							BOSTT=SUM(BOSTT),
							EXSTT=SUM(EXSTT),
							DIFF = ROUND(SUM(BOSTT),2) - ROUND(SUM(EXSTT),2)
						FROM
							#STT_CLT
						GROUP BY
							SAUDA_DATE,
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
						ORDER BY
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
					END
			END
		IF @DISFLAG = 'M'
			BEGIN
				IF (SELECT COUNT(1) FROM (SELECT 1 AS A FROM #STT_CLT GROUP BY SAUDA_DATE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE HAVING SUM(BOSTT) = SUM(EXSTT)) A) > 0
					BEGIN
						SELECT
							SAUDA_DATE,
							INST_TYPE,
							SYMBOL,
							EXPIRYDATE=CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE,
							BOSTT=SUM(BOSTT),
							EXSTT=SUM(EXSTT),
							DIFF = ROUND(SUM(BOSTT),2) - ROUND(SUM(EXSTT),2)
						FROM
							#STT_CLT
						GROUP BY
							SAUDA_DATE,
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
						HAVING
							ROUND(SUM(BOSTT),2) = ROUND(SUM(EXSTT),2)
						ORDER BY
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
						COMPUTE
							SUM(SUM(BOSTT)),
							SUM(SUM(EXSTT)),
							SUM(ROUND(SUM(BOSTT),2) - ROUND(SUM(EXSTT),2))
					END
				ELSE
					BEGIN
						SELECT
							SAUDA_DATE,
							INST_TYPE,
							SYMBOL,
							EXPIRYDATE=CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE,
							BOSTT=SUM(BOSTT),
							EXSTT=SUM(EXSTT),
							DIFF = ROUND(SUM(BOSTT),2) - ROUND(SUM(EXSTT),2)
						FROM
							#STT_CLT
						GROUP BY
							SAUDA_DATE,
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
						HAVING
							ROUND(SUM(BOSTT),2) = ROUND(SUM(EXSTT),2)
						ORDER BY
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
					END
			END
		IF @DISFLAG = 'U'
			BEGIN
				IF (SELECT COUNT(1) FROM (SELECT 1 AS A FROM #STT_CLT GROUP BY SAUDA_DATE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE HAVING SUM(BOSTT) <> SUM(EXSTT)) A) > 0
					BEGIN
						SELECT
							SAUDA_DATE,
							INST_TYPE,
							SYMBOL,
							EXPIRYDATE=CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE,
							BOSTT=SUM(BOSTT),
							EXSTT=SUM(EXSTT),
							DIFF = ROUND(SUM(BOSTT),2) - ROUND(SUM(EXSTT),2)
						FROM
							#STT_CLT
						GROUP BY
							SAUDA_DATE,
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
						HAVING
							ROUND(SUM(BOSTT),2) <> ROUND(SUM(EXSTT),2)
						ORDER BY
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
						COMPUTE
							SUM(SUM(BOSTT)),
							SUM(SUM(EXSTT)),
							SUM(ROUND(SUM(BOSTT),2) - ROUND(SUM(EXSTT),2))
					END
				ELSE
					BEGIN
						SELECT
							SAUDA_DATE,
							INST_TYPE,
							SYMBOL,
							EXPIRYDATE=CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE,
							BOSTT=SUM(BOSTT),
							EXSTT=SUM(EXSTT),
							DIFF = ROUND(SUM(BOSTT),2) - ROUND(SUM(EXSTT),2)
						FROM
							#STT_CLT
						GROUP BY
							SAUDA_DATE,
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
						HAVING
							ROUND(SUM(BOSTT),2) <> ROUND(SUM(EXSTT),2)
						ORDER BY
							INST_TYPE,
							SYMBOL,
							CONVERT(VARCHAR,EXPIRYDATE,103),
							STRIKE_PRICE,
							OPTION_TYPE
					END
			END
	END

DROP TABLE #STT_CLT
DROP TABLE #STT_EXG

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_TRADEDETAILS
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_TRADEDETAILS]
	(
	@FROMDATE	VARCHAR(11),
	@TODATE		VARCHAR(11),
	@SELLBUY	CHAR(1),
	@VALUE		MONEY = 0
	)

	AS

	-- RPT_TRADEDETAILS 'JAN  1 2000','DEC 31 2010','1',0

	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
	SELECT 
		COMPANY,
		MEMBERCODE,
		USER_ID,
		SYMBOL,
		EXPIRYDATE=LEFT(EXPIRYDATE,11),
		TRADETIME = CPID,
		TRADEDATE =LEFT(SAUDA_DATE,11),
		TRADENO = TRADE_NO,
		PRICE,
		TRADEQTY,
		VALUE = (TRADEQTY*PRICE*BOOKTYPE/INSTRUMENT),
		LONG_NAME = C1.LONG_NAME,
		PARTY_CODE = F.PARTY_CODE,
		ADDRESS = L_ADDRESS1+'  '+L_ADDRESS2+' '+L_ADDRESS3+' '+L_CITY+' '+L_ZIP,
		CONTRACTNO,
		PAN_GIR_NO
	FROM
		FOSETTLEMENT F (NOLOCK),
		CLIENT1 C1 (NOLOCK),
		CLIENT2 C2 (NOLOCK),
		FOOWNER O (NOLOCK)
	WHERE
		F.PARTY_CODE = C2.PARTY_CODE
		AND C1.CL_CODE = C2.CL_CODE
		AND SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59:59'
		AND SELL_BUY = @SELLBUY
		AND (TRADEQTY*PRICE) > @VALUE
		AND TRADEQTY > 0
	ORDER BY
		LEFT(SAUDA_DATE,11),
		F.PARTY_CODE,
		SYMBOL,
		LEFT(EXPIRYDATE,11)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_TRANSLOGREPORT
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[RPT_TRANSLOGREPORT]
	(
		@FROMPARTY VARCHAR(20),
		@TOPARTY VARCHAR(20),
		@SYMBOL VARCHAR(12),
		@EXPDATE VARCHAR(12),
		@SAUDA VARCHAR(12),
		@CONTNO VARCHAR(12)
	) AS

	SELECT 
		FROMPARTY,
		TOPARTY,
		OPTION_TYPE,
		INST_TYPE,
		SYMBOL,LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) AS 	EXPIRYDATE,
		STRIKE_PRICE,
		QTY,
		SELL_BUY,
		LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) AS SAUDA_DATE,
		CONTRACTNO,
		LEFT(CONVERT(VARCHAR,SPLITDATE,109),11)	AS SPLITDATE,
		TRADENO 
	FROM 
		CONTLOGIN 
	WHERE 
		FROMPARTY LIKE @FROMPARTY +'%'
		AND TOPARTY LIKE @TOPARTY +'%'
		AND SYMBOL LIKE @SYMBOL +'%'
		AND EXPIRYDATE LIKE @EXPDATE+'%' 
		AND SAUDA_DATE LIKE @SAUDA +'%'
		AND CONTRACTNO LIKE @CONTNO +'%'

	ORDER BY 
	FROMPARTY,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	STRIKE_PRICE,
	OPTION_TYPE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_TRANSSTATEMENTBEN
-- --------------------------------------------------
CREATE PROC [dbo].[RPT_TRANSSTATEMENTBEN]               
(@FROMDATE VARCHAR(11), @TODATE VARCHAR(11), @FROMPARTY VARCHAR(10), @TOPARTY VARCHAR(10), @FROMSCRIP VARCHAR(12), @TOSCRIP VARCHAR(12),              
@CLTDPID VARCHAR(16), @DPID VARCHAR(10), @FLAG INT, @STATUSID VARCHAR(50), @STATUSNAME VARCHAR(50) )              
AS               
  
-- EXEC RPT_TRANSSTATEMENTBEN 'AUG  1 2008', 'OCT 15 2011', '0', 'ZZZ', '0', 'ZZZ', '12046300', '1204630000000091', 1, 'BROKER', 'BROKER'  
DECLARE @NEWFROMDATE VARCHAR(11)  
  
SELECT @NEWFROMDATE = 'APR  1 1950'  
  
IF LEN(@DPID) < 8         
 SELECT @DPID = 'AAAA'        
        
IF LEN(@CLTDPID) < 8         
 SELECT @CLTDPID = 'AAAA'        
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                
SELECT * INTO #DEL_TRANSSTAT FROM DELIVERY_TRANSACTION WITH(NOLOCK)                 
WHERE PARTY_CODE >= @FROMPARTY AND PARTY_CODE <= @TOPARTY                
AND SYMBOL >= @FROMSCRIP AND SYMBOL <= @TOSCRIP                
AND TRANSDATE >= @NEWFROMDATE AND TRANSDATE <= @TODATE                
    
CREATE     
  INDEX [DELHOLD] ON [DBO].[#DEL_TRANSSTAT] ([TRANSDATE], [PARTY_CODE], [SYMBOL], [HOLDERNAME], [DRCR], [BDPTYPE], [BDPID], [BCLTDPID])    
    
    
IF @FLAG = 1               
BEGIN              
 SELECT  TRANSDATE=CONVERT(VARCHAR,TRANSDATE,103), SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
  C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
  D.SYMBOL, SCRIP_NAME = D.SYMBOL+'( ' + ISIN + ')', ISIN, CQTY = SUM(QTY), DQTY = 0, SLIPNO, DPID=BDPID, CLTDPID=BCLTDPID, TRTYPE,               
  REASON = (CASE WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN' ELSE 'TRANS TO BEN' END),              
   BDPID, BCLTDPID, TRANSDATE1 = TRANSDATE,FLAG=1              
 INTO #DEL_TRANSSTAT_1  
 FROM  #DEL_TRANSSTAT D,               
  CLIENT2 C2,               
  CLIENT1 C1              
 WHERE  DRCR = 'D'               
 AND  SHARETYPE <> 'AUCTION'               
 AND  ISIN LIKE 'IN%'              
 AND  DELIVERED = 'G'               
 AND  FILLER2 = 0               
 AND  C2.CL_CODE = C1.CL_CODE               
 AND  C2.PARTY_CODE = D.PARTY_CODE               
 AND  TRANSDATE >= @NEWFROMDATE               
 AND  TRANSDATE <= @TODATE              
 AND  D.PARTY_CODE >= @FROMPARTY               
 AND  D.PARTY_CODE <= @TOPARTY              
 AND  D.SYMBOL >= @FROMSCRIP AND D.SYMBOL <= @TOSCRIP              
 AND  HOLDERNAME LIKE '%' + RTRIM(LTRIM(@CLTDPID))              
 AND HOLDERNAME NOT LIKE 'MARGIN%'                  
 --AND SETT_NO <> '2000000'              
 AND  C1.BRANCH_CD LIKE  (CASE WHEN @STATUSID = 'BRANCH'   THEN @STATUSNAME ELSE '%' END)              
 AND  C1.SUB_BROKER LIKE  (CASE WHEN @STATUSID = 'SUBBROKER'  THEN @STATUSNAME ELSE '%' END)              
 AND  C1.TRADER LIKE   (CASE WHEN @STATUSID = 'TRADER'   THEN @STATUSNAME ELSE '%' END)              
 AND  C1.FAMILY LIKE   (CASE WHEN @STATUSID = 'FAMILY'   THEN @STATUSNAME ELSE '%' END)              
 AND  C2.PARTY_CODE LIKE  (CASE WHEN @STATUSID = 'CLIENT'   THEN @STATUSNAME ELSE '%' END)               
 GROUP BY TRANSDATE, SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
  C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
  D.SYMBOL, ISIN, SLIPNO, DPID, CLTDPID, TRTYPE, ISETT_NO, ISETT_TYPE, BDPID, BCLTDPID, HOLDERNAME                
              
 UNION ALL   
 SELECT  TRANSDATE=CONVERT(VARCHAR,TRANSDATE,103), SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
  C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
  D.SYMBOL, SCRIP_NAME = D.SYMBOL+'( ' + ISIN + ')', ISIN, CQTY = SUM(QTY), DQTY = 0, SLIPNO, DPID=DPID, CLTDPID=CLTDPID, TRTYPE,      
  REASON , BDPID, BCLTDPID, TRANSDATE1 = TRANSDATE,FLAG=2                
 FROM  #DEL_TRANSSTAT D,               
  CLIENT2 C2,            
  CLIENT1 C1              
 WHERE  DRCR = 'C'          
 AND  SHARETYPE <> 'AUCTION'               
 AND  ISIN LIKE 'IN%'              
 /*AND DELIVERED = '0'*/ AND FILLER2 = 1               
 AND  C2.CL_CODE = C1.CL_CODE               
 AND  C2.PARTY_CODE = D.PARTY_CODE               
 AND  TRANSDATE >= @NEWFROMDATE               
 AND  TRANSDATE <= @TODATE              
 AND  D.PARTY_CODE >= @FROMPARTY               
 AND  D.PARTY_CODE <= @TOPARTY              
 AND  D.SYMBOL >= @FROMSCRIP               
 AND  D.SYMBOL <= @TOSCRIP              
 AND BDPID = @DPID AND BCLTDPID = @CLTDPID           
 /*AND SETT_NO = '2000000' */ AND FILLER1 NOT IN ('SPLIT','BONUS')              
 AND  C1.BRANCH_CD LIKE  (CASE WHEN @STATUSID = 'BRANCH'   THEN @STATUSNAME ELSE '%' END)              
 AND  C1.SUB_BROKER LIKE  (CASE WHEN @STATUSID = 'SUBBROKER'  THEN @STATUSNAME ELSE '%' END)              
 AND  C1.TRADER LIKE   (CASE WHEN @STATUSID = 'TRADER'   THEN @STATUSNAME ELSE '%' END)              
 AND  C1.FAMILY LIKE   (CASE WHEN @STATUSID = 'FAMILY'   THEN @STATUSNAME ELSE '%' END)              
 AND  C2.PARTY_CODE LIKE  (CASE WHEN @STATUSID = 'CLIENT'   THEN @STATUSNAME ELSE '%' END)               
 GROUP BY TRANSDATE, SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
  C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
  D.SYMBOL, ISIN, SLIPNO, DPID, CLTDPID, TRTYPE, ISETT_NO, ISETT_TYPE, BDPID, BCLTDPID ,REASON              
              
 UNION ALL         
              
 SELECT  TRANSDATE=CONVERT(VARCHAR,TRANSDATE,103), SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
  C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
  D.SYMBOL, SCRIP_NAME = D.SYMBOL+'( ' + ISIN + ')', ISIN, CQTY = SUM(QTY), DQTY = 0, SLIPNO=0, DPID='', CLTDPID='', TRTYPE,               
  REASON , BDPID, BCLTDPID, TRANSDATE1 = TRANSDATE,FLAG=3                
 FROM  #DEL_TRANSSTAT D, CLIENT2 C2, CLIENT1 C1              
 WHERE  DRCR = 'C'               
 AND  SHARETYPE <> 'AUCTION'               
 AND  ISIN LIKE 'IN%'              
 AND  DELIVERED = '0'               
 AND  FILLER2 = 1               
 AND  C2.CL_CODE = C1.CL_CODE               
 AND  C2.PARTY_CODE = D.PARTY_CODE               
 AND  TRANSDATE >= @NEWFROMDATE               
 AND  TRANSDATE <= @TODATE              
 AND  D.PARTY_CODE >= @FROMPARTY               
 AND  D.PARTY_CODE <= @TOPARTY              
 AND  D.SYMBOL >= @FROMSCRIP               
 AND  D.SYMBOL <= @TOSCRIP              
 AND BDPID = @DPID AND BCLTDPID = @CLTDPID           
 AND  FILLER1 IN ('SPLIT','BONUS')              
 AND  C1.BRANCH_CD LIKE  (CASE WHEN @STATUSID = 'BRANCH'   THEN @STATUSNAME ELSE '%' END)              
 AND  C1.SUB_BROKER LIKE  (CASE WHEN @STATUSID = 'SUBBROKER'  THEN @STATUSNAME ELSE '%' END)              
 AND  C1.TRADER LIKE   (CASE WHEN @STATUSID = 'TRADER'   THEN @STATUSNAME ELSE '%' END)              
 AND  C1.FAMILY LIKE   (CASE WHEN @STATUSID = 'FAMILY'   THEN @STATUSNAME ELSE '%' END)              
 AND  C2.PARTY_CODE LIKE  (CASE WHEN @STATUSID = 'CLIENT'   THEN @STATUSNAME ELSE '%' END)               
 GROUP BY TRANSDATE, SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
  C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
  D.SYMBOL, ISIN, SLIPNO, DPID, CLTDPID, TRTYPE, ISETT_NO, ISETT_TYPE, BDPID, BCLTDPID ,REASON              
              
 UNION ALL  
 SELECT  TRANSDATE=CONVERT(VARCHAR,TRANSDATE,103), SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,              
  C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
  D.SYMBOL, SCRIP_NAME = D.SYMBOL+'( ' + ISIN + ')', ISIN, CQTY = 0, DQTY = SUM(QTY), SLIPNO=(CASE WHEN FILLER1 = 'SPLIT' THEN 0 ELSE SLIPNO END),               
  DPID =  (CASE  WHEN TRTYPE IN (1000,907,908)  THEN ''               
            WHEN FILLER1 = 'SPLIT'    THEN ''              
WHEN FILLER1 LIKE 'CHANGE TO%'  THEN ''                
           ELSE DPID END),               
  CLTDPID = (CASE  WHEN TRTYPE IN (1000,907,908)  THEN ''               
    WHEN FILLER1 = 'SPLIT'    THEN ''             
                         WHEN FILLER1 LIKE 'CHANGE TO%'  THEN ''              
      ELSE CLTDPID               
      END),              
  TRTYPE,               
  REASON =  (CASE  WHEN TRTYPE IN (1000,907,908)  THEN 'TRANS TO POOL - ' + ISETT_NO + '-' + ISETT_TYPE               
           ELSE               
    (CASE  WHEN FILLER1 = 'SPLIT'    THEN 'CORPORATE ACTION'               
                WHEN FILLER1 LIKE 'CHANGE TO%'      THEN FILLER1              
              ELSE               
    (CASE  WHEN REASON = 'DEMAT'           THEN 'PAY-OUT'               
    ELSE  REASON               
    END)               
    END)              
    END),               
  BDPID, BCLTDPID, TRANSDATE1 = TRANSDATE,FLAG=4                
 FROM  #DEL_TRANSSTAT D,               
  CLIENT2 C2,               
  CLIENT1 C1              
 WHERE  FILLER2 = 1               
 AND  DRCR = 'D'               
 AND  DELIVERED <> '0'               
 AND  SHARETYPE <> 'AUCTION'               
 AND  ISIN LIKE 'IN%'              
 AND  C2.CL_CODE = C1.CL_CODE               
 AND  C2.PARTY_CODE = D.PARTY_CODE               
 AND  TRANSDATE >= @NEWFROMDATE               
 AND  TRANSDATE <= @TODATE              
 AND  D.PARTY_CODE >= @FROMPARTY               
 AND  D.PARTY_CODE <= @TOPARTY              
 AND  D.SYMBOL >= @FROMSCRIP               
 AND  D.SYMBOL <= @TOSCRIP              
 AND BDPID = @DPID AND BCLTDPID = @CLTDPID           
 AND  C1.BRANCH_CD LIKE  (CASE WHEN @STATUSID = 'BRANCH'   THEN @STATUSNAME ELSE '%' END)              
 AND  C1.SUB_BROKER LIKE  (CASE WHEN @STATUSID = 'SUBBROKER'  THEN @STATUSNAME ELSE '%' END)              
 AND  C1.TRADER LIKE   (CASE WHEN @STATUSID = 'TRADER'   THEN @STATUSNAME ELSE '%' END)              
 AND  C1.FAMILY LIKE   (CASE WHEN @STATUSID = 'FAMILY'   THEN @STATUSNAME ELSE '%' END)              
 AND  C2.PARTY_CODE LIKE  (CASE WHEN @STATUSID = 'CLIENT'   THEN @STATUSNAME ELSE '%' END)               
 AND  HOLDERNAME NOT LIKE 'MARGIN%'              
 GROUP BY TRANSDATE, SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
  C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
  D.SYMBOL, ISIN, SLIPNO, DPID, CLTDPID, TRTYPE, ISETT_NO, ISETT_TYPE, BDPID, BCLTDPID , FILLER1, REASON              
              
 UNION ALL  
 SELECT  TRANSDATE=CONVERT(VARCHAR,TRANSDATE,103), SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
  C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
  D.SYMBOL, SCRIP_NAME = D.SYMBOL+'( ' + ISIN + ')', ISIN, CQTY = 0, DQTY = SUM(QTY), SLIPNO, DPID=DP.DPID, CLTDPID=DP.DPCLTNO, TRTYPE,               
  REASON = (CASE WHEN HOLDERNAME LIKE 'MARGIN%' THEN 'TRANS TO MARGIN' ELSE 'TRANS TO BEN' END),              
   BDPID, BCLTDPID, TRANSDATE1 = TRANSDATE,FLAG=1              
 FROM  #DEL_TRANSSTAT D,               
  CLIENT2 C2,               
  CLIENT1 C1,               
  DELIVERYDP DP              
 WHERE  DRCR = 'D'               
 AND  SHARETYPE <> 'AUCTION'               
 AND  ISIN LIKE 'IN%'              
 AND  DELIVERED = 'G'               
 AND  FILLER2 = 0               
 AND  C2.CL_CODE = C1.CL_CODE               
 AND  C2.PARTY_CODE = D.PARTY_CODE               
 AND  TRANSDATE >= @NEWFROMDATE               
 AND  TRANSDATE <= @TODATE              
 AND  D.PARTY_CODE >= @FROMPARTY               
 AND  D.PARTY_CODE <= @TOPARTY              
 AND  D.SYMBOL >= @FROMSCRIP               
 AND  D.SYMBOL <= @TOSCRIP              
 AND BDPID = @DPID AND BCLTDPID = @CLTDPID           
 AND DESCRIPTION NOT LIKE '%POOL%'            
 AND  (HOLDERNAME LIKE 'BEN ' + DP.DPCLTNO               
  OR HOLDERNAME LIKE 'MARGIN ' + DP.DPCLTNO)              
 AND  C1.BRANCH_CD LIKE  (CASE WHEN @STATUSID = 'BRANCH'   THEN @STATUSNAME ELSE '%' END)              
 AND  C1.SUB_BROKER LIKE  (CASE WHEN @STATUSID = 'SUBBROKER'  THEN @STATUSNAME ELSE '%' END)              
 AND  C1.TRADER LIKE   (CASE WHEN @STATUSID = 'TRADER'   THEN @STATUSNAME ELSE '%' END)              
 AND  C1.FAMILY LIKE   (CASE WHEN @STATUSID = 'FAMILY'   THEN @STATUSNAME ELSE '%' END)              
 AND  C2.PARTY_CODE LIKE  (CASE WHEN @STATUSID = 'CLIENT'   THEN @STATUSNAME ELSE '%' END)               
 GROUP BY TRANSDATE, SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
  C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,             
  D.SYMBOL, ISIN, SLIPNO, TRTYPE, DP.DPID, DPCLTNO , ISETT_NO, ISETT_TYPE, BDPID, BCLTDPID, HOLDERNAME                
/*  
 SELECT TRANSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),  
 SETT_NO='',SETT_TYPE='',PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,  
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN,  
 CQTY=(CASE WHEN SUM(CQTY-DQTY) > 0 THEN SUM(CQTY-DQTY) ELSE 0 END),  
 DQTY=(CASE WHEN SUM(DQTY-CQTY) > 0 THEN SUM(DQTY-CQTY) ELSE 0 END),  
 SLIPNO='0',DPID='',CLTDPID='',TRTYPE='0',REASON='OPENING BALANCE',BDPID='',BCLTDPID='',  
 TRANSDATE1=CONVERT(DATETIME,@FROMDATE),FLAG=0  
 FROM #DEL_TRANSSTAT_1  
 WHERE TRANSDATE1 < @FROMDATE   
 GROUP BY PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,  
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN  
 UNION ALL  
 SELECT * FROM  #DEL_TRANSSTAT_1  
 WHERE TRANSDATE1 >= @FROMDATE AND TRANSDATE1 <= @TODATE  
 UNION ALL  
 SELECT TRANSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),  
 SETT_NO='',SETT_TYPE='',PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,  
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN,  
 CQTY=(CASE WHEN SUM(CQTY-DQTY) > 0 THEN SUM(CQTY-DQTY) ELSE 0 END),  
 DQTY=(CASE WHEN SUM(DQTY-CQTY) > 0 THEN SUM(DQTY-CQTY) ELSE 0 END),  
 SLIPNO='0',DPID='',CLTDPID='',TRTYPE='0',REASON='CLOSING BALANCE',BDPID='',BCLTDPID='',  
 TRANSDATE1=CONVERT(DATETIME,@TODATE),FLAG=6  
 FROM #DEL_TRANSSTAT_1  
 WHERE TRANSDATE1 <= @TODATE  
 GROUP BY PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,  
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN  
 ORDER BY PARTY_CODE, SYMBOL, ISIN, TRANSDATE1, FLAG, SETT_NO, SETT_TYPE  
*/  
  
SELECT * INTO #DEL_TRANSSTAT_3 FROM  #DEL_TRANSSTAT_1  WHERE 1 = 2    
     
 INSERT INTO #DEL_TRANSSTAT_3    
 SELECT TRANSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),            
 SETT_NO='',SETT_TYPE='',PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,            
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN,            
 CQTY=(CASE WHEN SUM(CQTY-DQTY) > 0 THEN SUM(CQTY-DQTY) ELSE 0 END),            
 DQTY=(CASE WHEN SUM(DQTY-CQTY) > 0 THEN SUM(DQTY-CQTY) ELSE 0 END),            
 SLIPNO='0',DPID='',CLTDPID='',TRTYPE='0',REASON='OPENING BALANCE',BDPID='',BCLTDPID='',            
 TRANSDATE1=CONVERT(DATETIME,@FROMDATE),FLAG=0            
 FROM #DEL_TRANSSTAT_1            
 WHERE TRANSDATE1 < @FROMDATE            
 GROUP BY PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,            
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN      
 HAVING SUM(CQTY-DQTY) <> 0    
    
 INSERT INTO #DEL_TRANSSTAT_3    
 SELECT TRANSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),            
 SETT_NO='',SETT_TYPE='',PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,            
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN,            
 CQTY=0,            
 DQTY=0,            
 SLIPNO='0',DPID='',CLTDPID='',TRTYPE='0',REASON='OPENING BALANCE',BDPID='',BCLTDPID='',            
 TRANSDATE1=CONVERT(DATETIME,@FROMDATE),FLAG=0            
 FROM #DEL_TRANSSTAT_1  D1          
 WHERE TRANSDATE1 >= @FROMDATE AND TRANSDATE1 <= @TODATE + ' 23:59:59'    
AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM #DEL_TRANSSTAT_3 D3 WHERE D1.PARTY_CODE = D3.PARTY_CODE     
  AND D1.ISIN = D3.ISIN)       
 GROUP BY PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,            
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN      
    
 INSERT INTO #DEL_TRANSSTAT_3     
 SELECT * FROM  #DEL_TRANSSTAT_1            
 WHERE TRANSDATE1 >= @FROMDATE AND TRANSDATE1 <= @TODATE + ' 23:59:59'     
          
 INSERT INTO #DEL_TRANSSTAT_3    
 SELECT TRANSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),            
 SETT_NO='',SETT_TYPE='',PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,            
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN,            
 CQTY=(CASE WHEN SUM(CQTY-DQTY) > 0 THEN SUM(CQTY-DQTY) ELSE 0 END),            
 DQTY=(CASE WHEN SUM(DQTY-CQTY) > 0 THEN SUM(DQTY-CQTY) ELSE 0 END),            
 SLIPNO='0',DPID='',CLTDPID='',TRTYPE='0',REASON='CLOSING BALANCE',BDPID='',BCLTDPID='',            
 TRANSDATE1=CONVERT(DATETIME,@TODATE),FLAG=6            
 FROM #DEL_TRANSSTAT_1 D1          
 WHERE TRANSDATE1 <= @TODATE     
 AND PARTY_CODE IN (SELECT PARTY_CODE FROM #DEL_TRANSSTAT_3 D3 WHERE D1.PARTY_CODE = D3.PARTY_CODE     
  AND D1.ISIN = D3.ISIN)           
 GROUP BY PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,            
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN            
 --HAVING SUM(CQTY-DQTY) <> 0         
    
 SELECT * FROM #DEL_TRANSSTAT_3    
 ORDER BY PARTY_CODE, SYMBOL, ISIN, TRANSDATE1, FLAG, SETT_NO, SETT_TYPE  
    
END              
ELSE              
BEGIN              
 SELECT TRANSDATE=CONVERT(VARCHAR,TRANSDATE,103), SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
 C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
 D.SYMBOL, SCRIP_NAME = D.SYMBOL+'( ' + ISIN + ')', ISIN, CQTY = SUM(QTY), DQTY = 0, SLIPNO, DPID=BDPID, CLTDPID=BCLTDPID, TRTYPE,               
 REASON = (CASE WHEN HOLDERNAME LIKE 'MARGIN%'               
                 THEN 'TRANS TO MARGIN'               
                 ELSE 'TRANS TO BEN'               
           END),              
 BDPID, BCLTDPID, TRANSDATE1 = TRANSDATE,FLAG=1  
 INTO #DEL_TRANSSTAT_2  
 FROM #DEL_TRANSSTAT D, CLIENT2 C2, CLIENT1 C1              
 WHERE DRCR = 'D' AND SHARETYPE <> 'AUCTION' AND ISIN LIKE 'IN%'              
 AND DELIVERED = 'G' AND FILLER2 = 0               
 AND C2.CL_CODE = C1.CL_CODE AND C2.PARTY_CODE = D.PARTY_CODE               
 AND TRANSDATE >= @NEWFROMDATE AND TRANSDATE <= @TODATE              
 AND D.PARTY_CODE >= @FROMPARTY AND D.PARTY_CODE <= @TOPARTY              
 AND D.SYMBOL >= @FROMSCRIP AND D.SYMBOL <= @TOSCRIP              
 AND HOLDERNAME LIKE '%' + RTRIM(LTRIM(@CLTDPID)) + '%'              
 AND HOLDERNAME NOT LIKE 'MARGIN%'                  
 --AND SETT_NO <> '2000000'                  
 AND C1.BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE '%' END)              
 AND C1.SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME ELSE '%' END)              
 AND C1.TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE '%' END)        
 AND C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE '%' END)              
 AND C2.PARTY_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE '%' END)               
              
 GROUP BY TRANSDATE, SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
 C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
 D.SYMBOL, ISIN, SLIPNO, DPID, CLTDPID, TRTYPE, ISETT_NO, ISETT_TYPE, BDPID, BCLTDPID, HOLDERNAME               
  
 UNION ALL   
 SELECT TRANSDATE=CONVERT(VARCHAR,TRANSDATE,103), SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
 C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
 D.SYMBOL, SCRIP_NAME = D.SYMBOL+'( ' + ISIN + ')', ISIN, CQTY = SUM(QTY), DQTY = 0, SLIPNO, DPID=DPID, CLTDPID=CLTDPID, TRTYPE,               
 REASON , BDPID, BCLTDPID, TRANSDATE1 = TRANSDATE,FLAG=2                
 FROM #DEL_TRANSSTAT D, CLIENT2 C2, CLIENT1 C1              
 WHERE DRCR = 'C' AND SHARETYPE <> 'AUCTION' AND ISIN LIKE 'IN%'              
 /*AND DELIVERED = '0' */AND FILLER2 = 1               
 AND C2.CL_CODE = C1.CL_CODE AND C2.PARTY_CODE = D.PARTY_CODE               
 AND TRANSDATE >= @NEWFROMDATE AND TRANSDATE <= @TODATE              
 AND D.PARTY_CODE >= @FROMPARTY AND D.PARTY_CODE <= @TOPARTY              
 AND D.SYMBOL >= @FROMSCRIP AND D.SYMBOL <= @TOSCRIP              
 AND BDPID = @DPID AND BCLTDPID = @CLTDPID           
 /*AND SETT_NO = '2000000' */ AND FILLER1 NOT IN ('SPLIT','BONUS')              
              
 AND C1.BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE '%' END)              
 AND C1.SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME ELSE '%' END)              
 AND C1.TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE '%' END)              
 AND C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE '%' END)              
 AND C2.PARTY_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE '%' END)               
              
 GROUP BY TRANSDATE, SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,           
 C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
 D.SYMBOL, ISIN, SLIPNO, DPID, CLTDPID, TRTYPE, ISETT_NO, ISETT_TYPE, BDPID, BCLTDPID ,REASON              
  
 UNION ALL             
 SELECT TRANSDATE=CONVERT(VARCHAR,TRANSDATE,103), SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
 C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
 D.SYMBOL, SCRIP_NAME = D.SYMBOL+'( ' + ISIN + ')', ISIN, CQTY = SUM(QTY), DQTY = 0, SLIPNO=0, DPID='', CLTDPID='', TRTYPE,               
 REASON , BDPID, BCLTDPID, TRANSDATE1 = TRANSDATE,FLAG=3                
 FROM #DEL_TRANSSTAT D, CLIENT2 C2, CLIENT1 C1              
 WHERE DRCR = 'C' AND SHARETYPE <> 'AUCTION' AND ISIN LIKE 'IN%'              
 AND DELIVERED = '0' AND FILLER2 = 1               
 AND C2.CL_CODE = C1.CL_CODE AND C2.PARTY_CODE = D.PARTY_CODE               
 AND TRANSDATE >= @NEWFROMDATE AND TRANSDATE <= @TODATE              
 AND D.PARTY_CODE >= @FROMPARTY AND D.PARTY_CODE <= @TOPARTY              
 AND D.SYMBOL >= @FROMSCRIP AND D.SYMBOL <= @TOSCRIP              
 AND BDPID = @DPID AND BCLTDPID = @CLTDPID           
 AND FILLER1 IN ('SPLIT','BONUS')              
              
 AND C1.BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE '%' END)              
 AND C1.SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME ELSE '%' END)              
 AND C1.TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE '%' END)              
 AND C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE '%' END)              
 AND C2.PARTY_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE '%' END)               
              
 GROUP BY TRANSDATE, SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
 C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
 D.SYMBOL, ISIN, SLIPNO, DPID, CLTDPID, TRTYPE, ISETT_NO, ISETT_TYPE, BDPID, BCLTDPID ,REASON              
  
 UNION ALL            
 SELECT TRANSDATE=CONVERT(VARCHAR,TRANSDATE,103), SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,              
 C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
 D.SYMBOL, SCRIP_NAME = D.SYMBOL+'( ' + ISIN + ')', ISIN, CQTY = 0, DQTY = SUM(QTY), SLIPNO=(CASE WHEN FILLER1 = 'SPLIT' THEN 0 ELSE SLIPNO END),               
 DPID = (CASE WHEN TRTYPE IN (1000,907,908) THEN ''               
          WHEN FILLER1 = 'SPLIT'  THEN ''              
          WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''              
          ELSE DPID END),               
 CLTDPID = (CASE WHEN TRTYPE IN (1000,907,908) THEN ''               
   WHEN FILLER1 = 'SPLIT'  THEN ''               
                WHEN FILLER1 LIKE 'CHANGE TO%' THEN ''               
   ELSE CLTDPID END),TRTYPE,               
 REASON = (CASE WHEN TRTYPE IN (1000,907,908)              
         THEN 'TRANS TO POOL - ' + ISETT_NO + '-' + ISETT_TYPE               
         ELSE (CASE WHEN FILLER1 = 'SPLIT'               
              THEN 'CORPORATE ACTION'               
              WHEN FILLER1 LIKE 'CHANGE TO%'              
              THEN FILLER1                 
              /*WHEN FILLER1 LIKE 'CHANGE FROM%'              
              THEN 'PAY-OUT'   */              
              ELSE (CASE WHEN REASON = 'DEMAT' THEN 'PAY-OUT' ELSE REASON END) END)              
           END), BDPID, BCLTDPID, TRANSDATE1 = TRANSDATE,FLAG=4                
 FROM #DEL_TRANSSTAT D, CLIENT2 C2, CLIENT1 C1              
 WHERE FILLER2 = 1 AND DRCR = 'D' AND DELIVERED <> '0'               
 AND SHARETYPE <> 'AUCTION' AND ISIN LIKE 'IN%'              
 AND C2.CL_CODE = C1.CL_CODE AND C2.PARTY_CODE = D.PARTY_CODE               
 AND TRANSDATE >= @NEWFROMDATE AND TRANSDATE <= @TODATE              
 AND D.PARTY_CODE >= @FROMPARTY AND D.PARTY_CODE <= @TOPARTY              
 AND D.SYMBOL >= @FROMSCRIP AND D.SYMBOL <= @TOSCRIP              
 AND BDPID = @DPID AND BCLTDPID = @CLTDPID                 
 AND C1.BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE '%' END)              
 AND C1.SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME ELSE '%' END)              
 AND C1.TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE '%' END)              
 AND C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE '%' END)              
 AND C2.PARTY_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE '%' END)               
 AND HOLDERNAME NOT LIKE 'MARGIN%'              
 GROUP BY TRANSDATE, SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
 C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
 D.SYMBOL, ISIN, SLIPNO, DPID, CLTDPID, TRTYPE, ISETT_NO, ISETT_TYPE, BDPID, BCLTDPID ,FILLER1, REASON              
  
 UNION ALL              
 SELECT TRANSDATE=CONVERT(VARCHAR,TRANSDATE,103), SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
 C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
 D.SYMBOL, SCRIP_NAME = D.SYMBOL+'( ' + ISIN + ')', ISIN, CQTY = 0, DQTY = SUM(QTY), SLIPNO, DPID=DP.DPID, CLTDPID=DP.DPCLTNO, TRTYPE,               
 REASON = (CASE WHEN HOLDERNAME LIKE 'MARGIN%'               
                 THEN 'TRANS TO MARGIN'               
                 ELSE 'TRANS TO BEN'               
           END),              
 BDPID, BCLTDPID, TRANSDATE1 = TRANSDATE,FLAG=1              
 FROM #DEL_TRANSSTAT D, CLIENT2 C2, CLIENT1 C1, DELIVERYDP DP              
 WHERE DRCR = 'D' AND SHARETYPE <> 'AUCTION' AND ISIN LIKE 'IN%'              
 AND DELIVERED = 'G' AND FILLER2 = 0     
 AND C2.CL_CODE = C1.CL_CODE AND C2.PARTY_CODE = D.PARTY_CODE               
 AND TRANSDATE >= @NEWFROMDATE AND TRANSDATE <= @TODATE              
 AND D.PARTY_CODE >= @FROMPARTY AND D.PARTY_CODE <= @TOPARTY              
 AND D.SYMBOL >= @FROMSCRIP AND D.SYMBOL <= @TOSCRIP              
 AND BDPID = @DPID AND BCLTDPID = @CLTDPID           
 AND ( HOLDERNAME LIKE 'BEN ' + DP.DPCLTNO OR HOLDERNAME LIKE 'MARGIN ' + DP.DPCLTNO )              
 AND C1.BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE '%' END)              
 AND C1.SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME ELSE '%' END)              
 AND C1.TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE '%' END)              
 AND C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE '%' END)              
 AND C2.PARTY_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE '%' END)               
 GROUP BY TRANSDATE, SETT_NO, SETT_TYPE, D.PARTY_CODE, C1.LONG_NAME,               
 C1.L_ADDRESS1, C1.L_ADDRESS2, C1.L_ADDRESS3, C1.L_CITY, C1.L_STATE, C1.L_ZIP, C1.FAMILY,              
 D.SYMBOL, ISIN, SLIPNO, TRTYPE, DP.DPID, DPCLTNO , ISETT_NO, ISETT_TYPE, BDPID, BCLTDPID, HOLDERNAME              
/*  
 SELECT TRANSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),  
 SETT_NO='',SETT_TYPE='',PARTY_CODE='',LONG_NAME='',L_ADDRESS1='',L_ADDRESS2='',L_ADDRESS3='',  
 L_CITY='',L_STATE='', L_ZIP='',FAMILY='',SYMBOL,SCRIP_NAME,ISIN,  
 CQTY=(CASE WHEN SUM(CQTY-DQTY) > 0 THEN SUM(CQTY-DQTY) ELSE 0 END),  
 DQTY=(CASE WHEN SUM(DQTY-CQTY) > 0 THEN SUM(DQTY-CQTY) ELSE 0 END),  
 SLIPNO='0',DPID='',CLTDPID='',TRTYPE='0',REASON='OPENING BALANCE',BDPID='',BCLTDPID='',  
 TRANSDATE1=CONVERT(DATETIME,@FROMDATE),FLAG=0  
 FROM #DEL_TRANSSTAT_2  
 WHERE TRANSDATE1 < @FROMDATE   
 GROUP BY SYMBOL,SCRIP_NAME,ISIN  
 UNION ALL  
 SELECT * FROM  #DEL_TRANSSTAT_2  
 WHERE TRANSDATE1 >= @FROMDATE AND TRANSDATE1 <= @TODATE  
 UNION ALL  
 SELECT TRANSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),  
 SETT_NO='',SETT_TYPE='',PARTY_CODE='',LONG_NAME='',L_ADDRESS1='',L_ADDRESS2='',L_ADDRESS3='',  
 L_CITY='',L_STATE='', L_ZIP='',FAMILY='',SYMBOL,SCRIP_NAME,ISIN,  
 CQTY=(CASE WHEN SUM(CQTY-DQTY) > 0 THEN SUM(CQTY-DQTY) ELSE 0 END),  
 DQTY=(CASE WHEN SUM(DQTY-CQTY) > 0 THEN SUM(DQTY-CQTY) ELSE 0 END),  
 SLIPNO='0',DPID='',CLTDPID='',TRTYPE='0',REASON='CLOSING BALANCE',BDPID='',BCLTDPID='',  
 TRANSDATE1=CONVERT(DATETIME,@TODATE),FLAG=6  
 FROM #DEL_TRANSSTAT_2  
 WHERE TRANSDATE1 <= @TODATE  
 GROUP BY SYMBOL,SCRIP_NAME,ISIN  
 ORDER BY SYMBOL, ISIN, TRANSDATE1, FLAG, SETT_NO, SETT_TYPE, PARTY_CODE  
*/  
  
SELECT * INTO #DEL_TRANSSTAT_4 FROM  #DEL_TRANSSTAT_2  WHERE 1 = 2    
     
 INSERT INTO #DEL_TRANSSTAT_4    
 SELECT TRANSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),            
 SETT_NO='',SETT_TYPE='',PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,            
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN,            
 CQTY=(CASE WHEN SUM(CQTY-DQTY) > 0 THEN SUM(CQTY-DQTY) ELSE 0 END),            
 DQTY=(CASE WHEN SUM(DQTY-CQTY) > 0 THEN SUM(DQTY-CQTY) ELSE 0 END),            
 SLIPNO='0',DPID='',CLTDPID='',TRTYPE='0',REASON='OPENING BALANCE',BDPID='',BCLTDPID='',            
 TRANSDATE1=CONVERT(DATETIME,@FROMDATE),FLAG=0            
 FROM #DEL_TRANSSTAT_2            
 WHERE TRANSDATE1 < @FROMDATE            
 GROUP BY PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,            
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN      
 HAVING SUM(CQTY-DQTY) <> 0    
    
 INSERT INTO #DEL_TRANSSTAT_4    
 SELECT TRANSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103),            
 SETT_NO='',SETT_TYPE='',PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,            
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN,            
 CQTY=0,            
 DQTY=0,            
 SLIPNO='0',DPID='',CLTDPID='',TRTYPE='0',REASON='OPENING BALANCE',BDPID='',BCLTDPID='',            
 TRANSDATE1=CONVERT(DATETIME,@FROMDATE),FLAG=0            
 FROM #DEL_TRANSSTAT_2  D1          
 WHERE TRANSDATE1 >= @FROMDATE AND TRANSDATE1 <= @TODATE + ' 23:59:59'    
 AND PARTY_CODE NOT IN (SELECT PARTY_CODE FROM #DEL_TRANSSTAT_4 D3 WHERE D1.PARTY_CODE = D3.PARTY_CODE     
  AND D1.ISIN = D3.ISIN)       
 GROUP BY PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,            
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN      
    
 INSERT INTO #DEL_TRANSSTAT_4     
 SELECT * FROM  #DEL_TRANSSTAT_2            
 WHERE TRANSDATE1 >= @FROMDATE AND TRANSDATE1 <= @TODATE + ' 23:59:59'     
          
 INSERT INTO #DEL_TRANSSTAT_4    
 SELECT TRANSDATE=CONVERT(VARCHAR,CONVERT(DATETIME,@TODATE),103),            
 SETT_NO='',SETT_TYPE='',PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,            
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN,            
 CQTY=(CASE WHEN SUM(CQTY-DQTY) > 0 THEN SUM(CQTY-DQTY) ELSE 0 END),            
 DQTY=(CASE WHEN SUM(DQTY-CQTY) > 0 THEN SUM(DQTY-CQTY) ELSE 0 END),            
 SLIPNO='0',DPID='',CLTDPID='',TRTYPE='0',REASON='CLOSING BALANCE',BDPID='',BCLTDPID='',            
 TRANSDATE1=CONVERT(DATETIME,@TODATE),FLAG=6            
 FROM #DEL_TRANSSTAT_2 D1          
 WHERE TRANSDATE1 <= @TODATE     
 AND PARTY_CODE IN (SELECT PARTY_CODE FROM #DEL_TRANSSTAT_4 D3 WHERE D1.PARTY_CODE = D3.PARTY_CODE     
  AND D1.ISIN = D3.ISIN)           
 GROUP BY PARTY_CODE,LONG_NAME,L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,            
 L_ZIP,FAMILY,SYMBOL,SCRIP_NAME,ISIN            
 --HAVING SUM(CQTY-DQTY) <> 0         
    
 SELECT * FROM #DEL_TRANSSTAT_4    
 ORDER BY PARTY_CODE, SYMBOL, ISIN, TRANSDATE1, FLAG, SETT_NO, SETT_TYPE                 
END              
            
DROP TABLE #DEL_TRANSSTAT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_UCCFILEGENERATION
-- --------------------------------------------------

--EXEC RPT_UCCFILEGENERATION 'JUL 20 2000','OCT  1 2013','0','ZZZZZZ','A','','ZZZZZZZ','C'

CREATE  PROC [dbo].[RPT_UCCFILEGENERATION]  
 (  
 @FROMDATE VARCHAR(11),  
 @TODATE VARCHAR(11),  
 @PARTYFROM VARCHAR(10),  
 @PARTYTO VARCHAR(10),  
 @OPTIONVAL VARCHAR(2),
 @FROMBRANCH VARCHAR(15),  
 @TOBRANCH VARCHAR(15),  
 @CLTYPE VARCHAR(2) 
 )  
  
 AS  
  
 SET NOCOUNT ON
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
 IF @PARTYTO='' BEGIN SET @PARTYTO = 'ZZZZZZ' END
 IF @TOBRANCH='' BEGIN SET @TOBRANCH ='ZZZZZZ' END
  
 CREATE TABLE #CLIENTLIST  
 (PARTY_CODE VARCHAR(10))  
   
 CREATE INDEX [INDXCL2] ON #CLIENTLIST ([PARTY_CODE])  
  
/*-----------------------------------------------------------------------------  
  FETCHING TRADED CLIENT LIST TO #CLIENTLIS  
-----------------------------------------------------------------------------*/  
  
IF @OPTIONVAL = 'T'  
BEGIN  
	INSERT INTO #CLIENTLIST  
	SELECT  
		DISTINCT PARTY_CODE  
	FROM  
		SETTLEMENT (NOLOCK)  
	WHERE  
		SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59'  
		AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  

	INSERT INTO #CLIENTLIST  
	SELECT  
		DISTINCT PARTY_CODE  
	FROM  
		HISTORY (NOLOCK)  
	WHERE  
		SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59'  
		AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  

	INSERT INTO #CLIENTLIST  
	SELECT  
		DISTINCT PARTY_CODE  
	FROM  
		ISETTLEMENT (NOLOCK)  
	WHERE  
		SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59'  
		AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  

	INSERT INTO #CLIENTLIST  
	SELECT  
		DISTINCT PARTY_CODE  
	FROM  
		IHISTORY (NOLOCK)  
	WHERE  
		SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59'  
		AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
END
ELSE IF @OPTIONVAL = 'M'
BEGIN
	INSERT INTO #CLIENTLIST  
	SELECT  
		PARTY_CODE  
	FROM  
		MSAJAG.DBO.CLIENT_DETAILS C (NOLOCK), 
		MSAJAG.DBO.CLIENT_BROK_DETAILS B (NOLOCK)
	WHERE  
		C.CL_CODE = B.CL_CODE 
		AND EXCHANGE = 'MFO' AND SEGMENT = 'FUTURES'
		AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
		AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH
		AND C.MODIFIDEDON BETWEEN @FROMDATE AND @TODATE + ' 23:59'  
		AND LEFT(SYSTEMDATE,11) <> LEFT(MODIFIDEDON,11)
END
ELSE  
BEGIN  
	INSERT INTO #CLIENTLIST  
	SELECT  
		PARTY_CODE  
	FROM  
		CLIENT2 (NOLOCK) 
	WHERE  
		PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
END

/*
UPDATE #CLIENTLIST
SET PARTY_CODE = PARENTCODE
FROM CLIENT2 (NOLOCK)
WHERE #CLIENTLIST.PARTY_CODE = CLIENT2.PARTY_CODE
*/
  
/*-----------------------------------------------------------------------------  
   FETCHING DATA TO #UCC_NSE  
-----------------------------------------------------------------------------*/  

   
SELECT   
	DISTINCT   
	CLIENTCODE = UPPER(C2.PARTY_CODE),
	LONGNAME = (
	CASE 
		WHEN ISNULL(ADDEMAILID,'') <> '' AND ADDEMAILID NOT LIKE '%@%' 
		THEN LEFT(REPLACE(REPLACE(REPLACE(ISNULL(ADDEMAILID,''),'.',''),',',''),';',''),150)
		ELSE LEFT(REPLACE(REPLACE(REPLACE(ISNULL(C1.LONG_NAME,''),'.',''),',',''),';',''),150)
	END),
	CATEGORY = (
	CASE 
		WHEN ISNULL(C1.CL_STATUS,'') IN ('PRO','IND','IN','ROR','CLI') THEN '01'
		WHEN ISNULL(C1.CL_STATUS,'') IN ('NRI','NOR','NRE','NRO') THEN '02'
		WHEN ISNULL(C1.CL_STATUS,'') IN ('SB') THEN '03'
		WHEN ISNULL(C1.CL_STATUS,'') IN ('PLC','FII') THEN '04'
		WHEN ISNULL(C1.CL_STATUS,'') IN ('LC') THEN '05'
		WHEN ISNULL(C1.CL_STATUS,'') IN ('MF') THEN '06' 
		WHEN ISNULL(C1.CL_STATUS,'') IN ('DFI','FVC','COT') THEN '07'  
		WHEN ISNULL(C1.CL_STATUS,'') IN ('PMS') THEN '08'  
		WHEN ISNULL(C1.CL_STATUS,'') IN ('NBFC') THEN '09'  
		WHEN ISNULL(C1.CL_STATUS,'') IN ('QFG','QFI') THEN '10'  
		WHEN ISNULL(C1.CL_STATUS,'') IN ('QFI-I') THEN '11'
		WHEN ISNULL(C1.CL_STATUS,'') IN ('NPS') THEN '12'
		WHEN ISNULL(C1.CL_STATUS,'') IN ('BC','BCP','CC','DBC','COR','PPB','COM') THEN '13'
		WHEN ISNULL(C1.CL_STATUS,'') IN ('AOP','PAR','PSF') THEN '15'
		WHEN ISNULL(C1.CL_STATUS,'') IN ('HUF') THEN '16'
		WHEN ISNULL(C1.CL_STATUS,'') IN ('TRU','TS') THEN '17'
		WHEN ISNULL(C1.CL_STATUS,'') IN ('DFI') THEN '18'
		WHEN ISNULL(C1.CL_STATUS,'') IN ('BK','BNK') THEN '19'
		WHEN ISNULL(C1.CL_STATUS,'') IN ('IC') THEN '20'		
		ELSE '99'
	END),
	ADDRESS1 = REPLACE(L_ADDRESS1,',',''),
	ADDRESS2 = REPLACE(L_ADDRESS2,',',''),
	ADDRESS3 = REPLACE(L_ADDRESS3,',',''),
	--FULLADDRESS = ISNULL(RTRIM(L_ADDRESS1),'') + ' ' + ISNULL(RTRIM(L_ADDRESS2),'') + ' ' + ISNULL(RTRIM(L_ADDRESS3),''),
	CITY = REPLACE(L_CITY,',',''),
	STATE = REPLACE(L_STATE,',',''),
	NATION = L_NATION,
	ZIP = ISNULL(L_ZIP,''),  
	PHONE1 = LEFT(
	CASE 
		WHEN ISNULL(C1.RES_PHONE1,'') <> ''   
		THEN REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(C1.RES_PHONE1,'/',''),'(',''),')',''),'-',''),':',''),';',''),',','')  
		WHEN ISNULL(C1.RES_PHONE2,'') <> ''   
		THEN REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(C1.RES_PHONE2,'/',''),'(',''),')',''),'-',''),':',''),';',''),',','')
		WHEN ISNULL(C1.OFF_PHONE1,'') <> ''   
		THEN REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(C1.OFF_PHONE1,'/',''),'(',''),')',''),'-',''),':',''),';',''),',','')
		WHEN ISNULL(C1.OFF_PHONE2,'') <> ''   
		THEN REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(C1.OFF_PHONE2,'/',''),'(',''),')',''),'-',''),':',''),';',''),',','')
		ELSE ''  
	END,25),

	AGGREMENTDATE = (
	CASE 
		WHEN C5.CLIENT_AGRE_DT IS NULL OR CONVERT(VARCHAR(11),C5.CLIENT_AGRE_DT,109) = 'JAN  1 1900' THEN ''
		ELSE REPLACE(CONVERT(VARCHAR(11),C5.CLIENT_AGRE_DT,103),'/','')
	END),
	
	DOB = (
	CASE 
		WHEN ISNULL(C1.CL_STATUS,'') IN ('PRO','IND','IN','ROR','CLI') THEN (
		CASE
			WHEN C5.BIRTHDATE IS NULL OR CONVERT(VARCHAR(11),C5.BIRTHDATE,109) = 'JAN  1 1900' THEN ''
			ELSE REPLACE(CONVERT(VARCHAR(11),C5.BIRTHDATE,103),'/','')
		END)
		ELSE ''
	END),
	PAN = ISNULL(PAN_GIR_NO, ''),  
	WARD = ISNULL(C1.WARD_NO, ''),  
	UIN	= CONVERT(VARCHAR(15),''),

	BANKNAME = CONVERT(VARCHAR(60),''),  
	BANKADDRESS = CONVERT(VARCHAR(255),''),  
	BANKACCOUNT = CONVERT(VARCHAR(25),''),  
	BANKACCTYPE = CONVERT(VARCHAR(2),''),  

	NSDL_DEPOSITORYNAME = CONVERT(VARCHAR(4),''),   
	NSDL_DEPOSITORYPARTICIPANTID = CONVERT(VARCHAR(8),''),  
	NSDL_DEPOSITORYPARTICIPANTNAME = CONVERT(VARCHAR(25),''),   
	NSDL_BENEFICIARYACCOUNTID = CONVERT(VARCHAR(8),''),  
	CDSL_DEPOSITORYNAME = CONVERT(VARCHAR(4),''),   
	CDSL_DEPOSITORYPARTICIPANTID = CONVERT(VARCHAR(8),''),  
	CDSL_DEPOSITORYPARTICIPANTNAME = CONVERT(VARCHAR(25),''),   
	CDSL_BENEFICIARYACCOUNTID = CONVERT(VARCHAR(16),''),

	PASSPORTNO = ISNULL(C5.PASSPORTDTL, ''),  
	PASSPORTPLACE = ISNULL(C5.PASSPORTPLACEOFISSUE, ''),  
	PASSPORTDATE = (
	CASE 
		WHEN C5.PASSPORTDATEOFISSUE IS NULL OR CONVERT(VARCHAR(11),C5.PASSPORTDATEOFISSUE,109) = 'JAN  1 1900' THEN ''
		ELSE REPLACE(CONVERT(VARCHAR(11),C5.PASSPORTDATEOFISSUE,103),'/','')
	END),
	PASSPORTEXPDATE = (
	CASE 
		WHEN C5.PASSPORTEXPDATE IS NULL OR CONVERT(VARCHAR(11),C5.PASSPORTEXPDATE,109) = 'JAN  1 1900' THEN ''
		ELSE REPLACE(CONVERT(VARCHAR(11),C5.PASSPORTEXPDATE,103),'/','')
	END),
	
	DRIVINGLICNO = ISNULL(C5.DRIVELICENDTL, ''),  
	DRIVINGLICPLACE = ISNULL(C5.LICENCENOPLACEOFISSUE, ''),  
	DRIVINGLICDATE = (
	CASE 
		WHEN C5.LICENCENODATEOFISSUE IS NULL OR CONVERT(VARCHAR(11),C5.LICENCENODATEOFISSUE,109) = 'JAN  1 1900' THEN ''
		ELSE REPLACE(CONVERT(VARCHAR(11),C5.LICENCENODATEOFISSUE,103),'/','')
	END),
	DRIVEEXPDATE = (
	CASE 
		WHEN C5.DRIVEEXPDATE IS NULL OR CONVERT(VARCHAR(11),C5.DRIVEEXPDATE,109) = 'JAN  1 1900' THEN ''
		ELSE REPLACE(CONVERT(VARCHAR(11),C5.DRIVEEXPDATE,103),'/','')
	END),
	  
	VOTERID = ISNULL(C5.VOTERSIDDTL, ''),  
	VOTERIDPLACE = ISNULL(C5.VOTERIDPLACEOFISSUE, ''),  
	VOTERIDDATE = (
	CASE 
		WHEN C5.VOTERIDDATEOFISSUE IS NULL OR CONVERT(VARCHAR(11),C5.VOTERIDDATEOFISSUE,109) = 'JAN  1 1900' THEN ''
		ELSE REPLACE(CONVERT(VARCHAR(11),C5.VOTERIDDATEOFISSUE,103),'/','')
	END),
    
	RATIONCARDID = ISNULL(C5.RATIONCARDDTL, ''),  
	RATIONCARDIDPLACE = ISNULL(C5.RATIONCARDPLACEOFISSUE, ''),  
	RATIONCARDIDDATE = (
	CASE 
		WHEN C5.RATIONCARDDATEOFISSUE IS NULL OR CONVERT(VARCHAR(11),C5.RATIONCARDDATEOFISSUE,109) = 'JAN  1 1900' THEN ''
		ELSE REPLACE(CONVERT(VARCHAR(11),C5.RATIONCARDDATEOFISSUE,103),'/','')
	END),
	   
	REGNO = ISNULL(C5.REGR_NO, ''),  
	REGAUTHORITY = ISNULL(C5.REGR_AUTH, ''),  
	REGPALCE = ISNULL(C5.REGR_PLACE, ''),  
	REGDATE = (
	CASE 
		WHEN C5.REGR_DATE IS NULL OR CONVERT(VARCHAR(11),C5.REGR_DATE,109) = 'JAN  1 1900' THEN ''
		ELSE REPLACE(CONVERT(VARCHAR(11),C5.REGR_DATE,103),'/','')
	END),
	
	INTRODUCER = ISNULL(C5.INTRODUCER, ''), 
	INTRORELATION = ISNULL(C5.INTROD_RELATION, ''),  
	INTROCLID = ISNULL(C5.INTROD_CLIENT_ID, ''),  
	OTHERTMCLIENT = (
	CASE
		WHEN ISNULL(C5.DEALING_WITH_OTHRER_TM, '') = '' OR ISNULL(C5.DEALING_WITH_OTHRER_TM, '') = 'N' THEN 'N'
		ELSE 'Y'
	END),
	RELATIONSHIPCODE = CONVERT(VARCHAR(10),''),
	ACTIVECLIENT = (
	CASE 
		WHEN CONVERT(VARCHAR,C5.INACTIVEFROM,112) > CONVERT(VARCHAR,GETDATE(),112) 
		THEN 1
		ELSE 2
	END),
	RESERVED1 = CONVERT(VARCHAR(1),''),
	MOBILENO = (
	CASE
		WHEN ISNULL(C1.MOBILE_PAGER,'') <> '' THEN REPLACE(C1.MOBILE_PAGER,',',' ')
		ELSE ''
	END),
	EMAIL = LEFT((
	CASE
		WHEN CHARINDEX(';',EMAIL) > 0 THEN LEFT(EMAIL,CHARINDEX(';',EMAIL) - 1)
		ELSE EMAIL
	END),50),
	RELATIONSHIP = CONVERT(VARCHAR(25),''),
	CIN_NO = CONVERT(VARCHAR(21),''),
	RESERVED = CONVERT(VARCHAR(1),''),
	END_FLAG = 'E'
INTO 
	#UCC_DETAIL
FROM   
	CLIENT1 C1(NOLOCK),  
	CLIENT2 C2(NOLOCK),  
	CLIENT5 C5(NOLOCK),
	#CLIENTLIST CL (NOLOCK)
WHERE
	C1.CL_CODE = C2.CL_CODE  
	AND C1.CL_CODE = C5.CL_CODE  
	AND CL.PARTY_CODE = C2.PARTY_CODE
	AND C1.CL_TYPE <> 'REM'  
	AND 1 = (
	CASE   
		WHEN @CLTYPE='' THEN 1   
		WHEN @CLTYPE='I' THEN (CASE WHEN C1.CL_TYPE = 'INS' THEN 1 ELSE 0 END)
		WHEN @CLTYPE='C' THEN (CASE WHEN C1.CL_TYPE <> 'INS' THEN 1 ELSE 0 END)
		ELSE 0  
	END)  
	AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH 
	AND C5.SYSTUMDATE BETWEEN   
	CASE WHEN @OPTIONVAL = 'A' THEN @FROMDATE ELSE 'JAN  1 1900' END  
	AND  
	CASE WHEN @OPTIONVAL = 'A' THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59' END  

	AND C5.ACTIVEFROM BETWEEN  
	CASE WHEN @OPTIONVAL = 'S' THEN @FROMDATE ELSE 'JAN  1 1900' END  
	AND  
	CASE WHEN @OPTIONVAL = 'S' THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59' END  

	AND C5.INACTIVEFROM NOT BETWEEN  
	CASE WHEN @OPTIONVAL = 'S' THEN @FROMDATE ELSE 'JAN  1 1900' END  
	AND  
	CASE WHEN @OPTIONVAL = 'S' THEN @TODATE + ' 23:59' ELSE '' END  

	AND C5.INACTIVEFROM BETWEEN  
	CASE WHEN @OPTIONVAL = 'I' THEN @FROMDATE ELSE 'JAN  1 1900' END  
	AND  
	CASE WHEN @OPTIONVAL = 'I' THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59' END

	/*-----------------------------------------------------------------------------
	UPDATING #UCC_NSE FOR EMAIL / SMS SERVICES DETAILS
	------------------------------------------------------------------------------*/  
	/*
	UPDATE
		#UCC_DETAIL
		SET   
			--SMS_EMAIL_ALERT	= ISNULL(CM.UPDATIONFLAG,'0'),
			RELATIONSHIP	= ISNULL(CM.RELATIONSHIP,'')
	FROM
		MSAJAG.DBO.CLIENT_MASTER_UCC_DATA CM (NOLOCK)
	WHERE
		#UCC_DETAIL.CLIENTCODE = CM.PARTY_CODE
	*/
	/*-----------------------------------------------------------------------------
	UPDATING #UCC_NSE FOR CIN DETAILS
	------------------------------------------------------------------------------*/

	UPDATE
		#UCC_DETAIL
		SET   
			CIN_NO = ISNULL(CM.CIN,'')
	FROM
		MSAJAG.DBO.CLIENT_MASTER_NOMINEE_DATA CM (NOLOCK)
	WHERE
		#UCC_DETAIL.CLIENTCODE = CM.PARTY_CODE

	/*-----------------------------------------------------------------------------  
	UPDATING #UCC_NSE FOR ACCOUNT DETAILS  
	-----------------------------------------------------------------------------*/  

	UPDATE   
		#UCC_DETAIL   
		SET BANKACCTYPE = (
		CASE 
			WHEN LEFT(C4.DEPOSITORY,6) = 'SAVING' THEN '10' 
			WHEN LEFT(C4.DEPOSITORY,7) = 'CURRENT' THEN '11' 
			ELSE '99'
		END),  
		BANKACCOUNT = (
		CASE 
			WHEN LEFT(C4.DEPOSITORY,7) IN ('SAVING','CURRENT','NRE','NRO') THEN CLTDPID 
			ELSE ''   
		END),  
		BANKNAME = REPLACE(ISNULL(LEFT(BANK_NAME,60),''),',',' '),
		BANKADDRESS = REPLACE(ISNULL(LEFT(BRANCH_NAME,255),''),',',' ')
	FROM
		CLIENT4 C4 LEFT OUTER JOIN POBANK P (NOLOCK)
		ON (CONVERT(VARCHAR, P.BANKID) = C4.BANKID)
	WHERE   
		C4.DEPOSITORY NOT IN ('CDSL', 'NSDL')  
		AND C4.PARTY_CODE = #UCC_DETAIL.CLIENTCODE  

	/*-----------------------------------------------------------------------------  
	UPDATING #UCC_NSE MULTIPLE DP DETAILS  
	-----------------------------------------------------------------------------*/  
  
	UPDATE   
		#UCC_DETAIL   
		SET 
		NSDL_DEPOSITORYNAME = (CASE WHEN M.DPTYPE ='NSDL' THEN LEFT(M.DPTYPE,4) ELSE '' END),  
		NSDL_DEPOSITORYPARTICIPANTID = CASE WHEN M.DPTYPE ='NSDL' THEN LEFT(M.DPID,8) ELSE '' END ,  
		NSDL_DEPOSITORYPARTICIPANTNAME = CASE WHEN M.DPTYPE ='NSDL' THEN LEFT(M.INTRODUCER,25) ELSE '' END,   
		NSDL_BENEFICIARYACCOUNTID = CASE WHEN M.DPTYPE ='NSDL' THEN LEFT(M.CLTDPNO,8) ELSE '' END,
		CDSL_DEPOSITORYNAME = (CASE WHEN M.DPTYPE ='CDSL' THEN LEFT(M.DPTYPE,4) ELSE '' END),  
		CDSL_DEPOSITORYPARTICIPANTID = CASE WHEN M.DPTYPE ='CDSL' THEN LEFT(M.DPID,8) ELSE '' END,  
		CDSL_DEPOSITORYPARTICIPANTNAME = CASE WHEN M.DPTYPE ='CDSL' THEN LEFT(M.INTRODUCER,25) ELSE '' END,   
		CDSL_BENEFICIARYACCOUNTID = CASE WHEN M.DPTYPE ='CDSL' THEN LEFT(M.CLTDPNO,16) ELSE '' END  
	FROM   
		MULTICLTID M (NOLOCK) 
	WHERE   
		M.DEF=1   
		AND M.PARTY_CODE = #UCC_DETAIL.CLIENTCODE   

	/*-----------------------------------------------------------------------------  
	FETCHING FINAL OUTPUT  
	-----------------------------------------------------------------------------*/  
  
	SELECT * FROM #UCC_DETAIL   
	ORDER BY CLIENTCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_UCCFILEGENERATION_NEW
-- --------------------------------------------------


CREATE PROC [dbo].[RPT_UCCFILEGENERATION_NEW]
	(  
	@FROMDATE VARCHAR(11),  
	@TODATE VARCHAR(11),  
	@PARTYFROM VARCHAR(10),  
	@PARTYTO VARCHAR(10),  
	@OPTIONVAL VARCHAR(2),
	@FROMBRANCH VARCHAR(15),  
	@TOBRANCH VARCHAR(15),  
	@CLTYPE VARCHAR(2),
	@UCC_FLAG VARCHAR(1) = ''
	)  
  
	AS  
  
	--- EXEC RPT_UCCFILEGENERATION_NEW 'JAN  1 2000','DEC 31 2013','','ZZZZZZZZZZ','A','','ZZZZZZZZZZ',''
	
	SET NOCOUNT ON  
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  

	DECLARE @SEGMENT	VARCHAR(4)
	DECLARE	@KRA_TYPE	VARCHAR(5)
	DECLARE @EXCHANGE	VARCHAR(11)
	DECLARE @R_COUNT	INT
	DECLARE @DBNAME		VARCHAR(10)
	
	SET @DBNAME		= DB_NAME()
	SET @KRA_TYPE	= 'CDSL'
	IF @DBNAME		= 'MCXDB'
	BEGIN
		SET @SEGMENT = 'MSX'
		SET	@EXCHANGE = 'MSXCAPITAL'
	END
	ELSE IF	@DBNAME	= 'MCXFO'
	BEGIN
		SET @SEGMENT = 'MFO'
		SET	@EXCHANGE = 'MFOFUTURES'
	END
	ELSE IF	@DBNAME	= 'MCDXCDS'
	BEGIN
		SET @SEGMENT = 'MCD'
		SET	@EXCHANGE = 'MCDFUTURES'
	END
	
	SELECT @KRA_TYPE = ISNULL(KRA_TYPE,'') FROM MSAJAG..OWNER (NOLOCK)
  
	IF @PARTYTO='' BEGIN SET @PARTYTO = 'ZZZZZZ' END
	IF @TOBRANCH='' BEGIN SET @TOBRANCH ='ZZZZZZ' END
  
	CREATE TABLE #CLIENTLIST  
	(PARTY_CODE VARCHAR(10))  

	CREATE INDEX [INDXCL2] ON #CLIENTLIST ([PARTY_CODE])
	
	/*-----------------------------------------------------------------------------  
	FETCHING TRADED CLIENT LIST TO #CLIENTLIS  
	-----------------------------------------------------------------------------*/  
  
	IF @OPTIONVAL = 'T'  
	BEGIN  

		IF @SEGMENT IN('MSX')
		BEGIN
			INSERT INTO #CLIENTLIST
			SELECT  
				DISTINCT PARTY_CODE  
			FROM  
				CMBILLVALAN (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59'
				AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
				AND TRADETYPE NOT IN ( 'SCF','ICF','IR' )
		END

		IF @SEGMENT IN('MFO','MCD')
		BEGIN
			INSERT INTO #CLIENTLIST
			SELECT  
				DISTINCT PARTY_CODE  
			FROM  
				FOBILLVALAN (NOLOCK)
			WHERE
				SAUDA_DATE BETWEEN @FROMDATE AND @TODATE + ' 23:59'
				AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
				AND TRADETYPE IN ( 'BT' )
		END
	END
	ELSE IF @OPTIONVAL = 'M'
	BEGIN
		INSERT INTO #CLIENTLIST  
		SELECT  
			PARTY_CODE  
		FROM  
			MSAJAG..CLIENT_DETAILS C (NOLOCK), 
			MSAJAG..CLIENT_BROK_DETAILS B (NOLOCK)
		WHERE  
			C.CL_CODE = B.CL_CODE 
			--AND EXCHANGE = 'NSE' AND SEGMENT = 'CAPITAL'
			AND EXCHANGE+SEGMENT = @EXCHANGE
			AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
			AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH
			AND C.MODIFIDEDON BETWEEN @FROMDATE AND @TODATE + ' 23:59'  
			AND LEFT(SYSTEMDATE,11) <> LEFT(MODIFIDEDON,11)
	END
	ELSE  
	BEGIN  
		INSERT INTO #CLIENTLIST  
		SELECT  
			PARTY_CODE
		FROM  
			CLIENT2 (NOLOCK)
		WHERE  
			PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
	END

	DELETE FROM #CLIENTLIST WHERE LEFT(PARTY_CODE,3) = 'MUM'

	/*-----------------------------------------------------------------------------  
	FOR PARENT LEVEL UCC
	-----------------------------------------------------------------------------*/  
	/*	
	UPDATE	#CLIENTLIST
	SET		PARTY_CODE = ISNULL(PARENTCODE,'')
	FROM	CLIENT2 C2 (NOLOCK)
	WHERE	C2.PARTY_CODE = #CLIENTLIST.PARTY_CODE  
	*/
	/*-----------------------------------------------------------------------------  
	FETCHING DATA TO #UCC_NSE  
	-----------------------------------------------------------------------------*/  

	SELECT
		CLIENT_CODE = C1.CL_CODE,
		CLIENT_NAME = (
		CASE 
			WHEN ISNULL(ADDEMAILID,'') <> '' AND ADDEMAILID NOT LIKE '%@%' 
			THEN LEFT(REPLACE(REPLACE(REPLACE(ISNULL(ADDEMAILID,''),'.',''),'&',''),'-',''),150)
			ELSE LEFT(REPLACE(REPLACE(REPLACE(ISNULL(C1.LONG_NAME,''),'.',''),'&',''),'-',''),150)
		END),
		CATEGORY = (
		CASE 
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PRO','IND','IN','ROR','CLI','STA') THEN '01'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('NRI','NOR','NRE','NRO') THEN '02'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('SB') THEN '03'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PLC','FII') THEN '04'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('LC','OCBC') THEN '05'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('MF') THEN '06' 
			WHEN ISNULL(C1.CL_STATUS,'') IN ('DFI','COT') THEN '07'  
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PMS') THEN '08'  
			WHEN ISNULL(C1.CL_STATUS,'') IN ('NBFC') THEN '09'  
			WHEN ISNULL(C1.CL_STATUS,'') IN ('QFG','QFI') THEN '10'  
			WHEN ISNULL(C1.CL_STATUS,'') IN ('QFI-I') THEN '11'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('NPS') THEN '12'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('BC','BCP','CC','DBC','COR','PPB','COM') THEN '13'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('AOP','PAR','PSF','PF') THEN '15'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('HUF') THEN '16'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('TRU','TS') THEN '17'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('DFI') THEN '18'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('BK','BNK') THEN '19'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('IC') THEN '20'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('FVC') THEN '21'
			WHEN ISNULL(C1.CL_STATUS,'') IN ('NGO') THEN '22'
			ELSE '99'
		END),
		PAN = ISNULL(C1.PAN_GIR_NO,''),
		GENDER = (
		CASE
			WHEN ISNULL(C1.CL_STATUS,'') IN ('IND','IN','ROR','CLI','STA','NRI','NRE','NRO','NOR','QFI','QFI-I') THEN ISNULL(C1.SEX,'')
			WHEN ISNULL(C1.CL_STATUS,'') = 'PRO' THEN 'NA'
			ELSE ''
		END),
		GUARDIANS_NAME = CONVERT(VARCHAR(150),''),
		MARITAL_STATUS = CONVERT(VARCHAR(2),''),
		NATIONALITY = CONVERT(VARCHAR(1),''),
		OTHER_NATIONALITY = CONVERT(VARCHAR(50),''),		
		EMAIL = LTRIM(RTRIM(MSAJAG.DBO.PIECE(MSAJAG.DBO.PIECE(C1.EMAIL,';',1),',',1))),
		
		COR_ADDRESS1 = REPLACE(ISNULL(C1.L_ADDRESS1,''),'''',''),
		COR_ADDRESS2 = REPLACE(ISNULL(C1.L_ADDRESS2,''),'''',''),
		COR_ADDRESS3 = REPLACE(ISNULL(C1.L_ADDRESS3,''),'''',''),
		COR_COUNTRY = ISNULL(DBO.GETCOUNTRY_STATE_CITY_CODE('COUNTRY',ISNULL(C1.L_NATION,''),ISNULL(C1.L_STATE,''),'',''),''),
		COR_STATE_CITY = ISNULL(DBO.GETCOUNTRY_STATE_CITY_CODE('CITY',ISNULL(C1.L_NATION,''),ISNULL(C1.L_STATE,''),ISNULL(C1.L_CITY,''),''),''),
		COR_L_ZIP = ISNULL(C1.L_ZIP,''),
		ADDRESS_FLAG = (
		CASE
			WHEN ISNULL(LTRIM(RTRIM(C1.L_ADDRESS1)),'') = ISNULL(LTRIM(RTRIM(C1.P_ADDRESS1)),'') AND ISNULL(LTRIM(RTRIM(C1.L_ADDRESS2)),'') = ISNULL(LTRIM(RTRIM(C1.P_ADDRESS2)),'') AND ISNULL(LTRIM(RTRIM(C1.L_ADDRESS3)),'') = ISNULL(LTRIM(RTRIM(C1.P_ADDRESS3)),'') THEN 'Y'
			ELSE 'N'
		END),	
		PER_ADDRESS1 = REPLACE(ISNULL(C1.P_ADDRESS1,''),'''',''),
		PER_ADDRESS2 = REPLACE(ISNULL(C1.P_ADDRESS2,''),'''',''),
		PER_ADDRESS3 = REPLACE(ISNULL(C1.P_ADDRESS3,''),'''',''),
		PER_COUNTRY = ISNULL(DBO.GETCOUNTRY_STATE_CITY_CODE('COUNTRY',ISNULL(C1.P_NATION,''),ISNULL(C1.P_STATE,''),'',''),''),
		PER_STATE_CITY = ISNULL(DBO.GETCOUNTRY_STATE_CITY_CODE('CITY',ISNULL(C1.P_NATION,''),ISNULL(C1.P_STATE,''),ISNULL(C1.P_CITY,''),''),''),
		PER_L_ZIP = ISNULL(C1.P_ZIP,''),

		PHONENO_RES = LEFT(
		CASE 
			WHEN ISNULL(C1.RES_PHONE1,'') <> '' THEN REPLACE(REPLACE(C1.RES_PHONE1,':',''),';','')
			WHEN ISNULL(C1.RES_PHONE2,'') <> ''	THEN REPLACE(REPLACE(C1.RES_PHONE2,':',''),';','')
			ELSE ''
		END,60),			
		MOBILENO = ISNULL(C1.MOBILE_PAGER,''),
		PHONENO_OFF = LEFT(
		CASE
			WHEN ISNULL(C1.OFF_PHONE1,'') <> '' THEN REPLACE(REPLACE(C1.OFF_PHONE1,':',''),';','')
			WHEN ISNULL(C1.OFF_PHONE2,'') <> ''	THEN REPLACE(REPLACE(C1.OFF_PHONE2,':',''),';','')
			ELSE ''
		END,60),
		DOB = (
		CASE
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PLC','FII','MF','NPS','DFI','BK','BNK','IC') THEN ''
			ELSE (
			CASE
				WHEN C1.DOB IS NULL THEN ''   
				WHEN LEFT(C1.DOB,11) = 'JAN  1 1900' THEN ''
				ELSE REPLACE(CONVERT(VARCHAR,C1.DOB,103),'/','')
			END)	
		END),
		UID = CONVERT(VARCHAR(12),''),
		
		BANK_NAME_1 = CONVERT(VARCHAR(60),''),
		BANK_BRANCH_ADD_1 = CONVERT(VARCHAR(255),''),
		BANK_ACCOUNT_NO_1 = CONVERT(VARCHAR(25),''),
		BANK_ACCOUNT_TYPE_1 = CONVERT(VARCHAR(2),''),

		BANK_NAME_2 = CONVERT(VARCHAR(60),''),
		BANK_BRANCH_ADD_2 = CONVERT(VARCHAR(255),''),
		BANK_ACCOUNT_NO_2 = CONVERT(VARCHAR(25),''),
		BANK_ACCOUNT_TYPE_2 = CONVERT(VARCHAR(2),''),

		BANK_NAME_3 = CONVERT(VARCHAR(60),''),
		BANK_BRANCH_ADD_3 = CONVERT(VARCHAR(255),''),
		BANK_ACCOUNT_NO_3 = CONVERT(VARCHAR(25),''),
		BANK_ACCOUNT_TYPE_3 = CONVERT(VARCHAR(2),''),
		
		DP_NAME_1 = CONVERT(VARCHAR(4),''),
		DP_ID_1	= CONVERT(VARCHAR(8),''),
		BEN_ACCOUNT_NO_1 = CONVERT(VARCHAR(16),''),

		DP_NAME_2 = CONVERT(VARCHAR(4),''),
		DP_ID_2	= CONVERT(VARCHAR(8),''),
		BEN_ACCOUNT_NO_2 = CONVERT(VARCHAR(16),''),

		DP_NAME_3 = CONVERT(VARCHAR(4),''),
		DP_ID_3	= CONVERT(VARCHAR(8),''),
		BEN_ACCOUNT_NO_3 = CONVERT(VARCHAR(16),''),
		
		CIN_NO = CONVERT(VARCHAR(21),''),
		PLACE_INCORPORATION = CONVERT(VARCHAR(75),''),
		OCCUPATION = CONVERT(VARCHAR(2),''),
		OCCUPATION_OTHER = CONVERT(VARCHAR(75),''),
		DATE_COMMENCEMENT = CONVERT(VARCHAR(8),''),
		GROSS_ANNUAL_INCOME = CONVERT(VARCHAR(2),''),
		GROSS_ANNUAL_INCOME_DATE = CONVERT(VARCHAR(8),''),
		NET_WORTH = CONVERT(VARCHAR(15),''),
		NET_WORTH_DATE = CONVERT(VARCHAR(8),''),		
		POLITICALLY_EXPOSED_PERSON = CONVERT(VARCHAR(1),''),
		CP_CODE = ISNULL(PARTICIPANT_CODE,''),

		REGISTRATION_NO = (
		CASE
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PRO','IND','IN','ROR','CLI','STA','NRI','NRE','NRO','NOR','QFI','QFI-I','BC','BCP','CC','DBC','COR','PPB','COM') THEN ''
			ELSE ISNULL(C1.REGR_NO,'')
		END),
		REGISTRATION_AUTHORITY = (
		CASE
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PRO','IND','IN','ROR','CLI','STA','NRI','NRE','NRO','NOR','QFI','QFI-I','BC','BCP','CC','DBC','COR','PPB','COM') THEN ''
			ELSE ISNULL(C1.REGR_AUTHORITY,'')
		END),
		REGISTRATION_PALCE = (
		CASE
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PRO','IND','IN','ROR','CLI','STA','NRI','NRE','NRO','NOR','QFI','QFI-I','BC','BCP','CC','DBC','COR','PPB','COM') THEN ''
			ELSE ISNULL(C1.REGR_AT, '')
		END),
		REGISTRATION_DATE = (
		CASE
			WHEN ISNULL(C1.CL_STATUS,'') IN ('PRO','IND','IN','ROR','CLI','STA','NRI','NRE','NRO','NOR','QFI','QFI-I','BC','BCP','CC','DBC','COR','PPB','COM') THEN ''
			ELSE	  
			CASE 
				WHEN C1.REGR_ON IS NULL THEN ''   
				WHEN (LEFT(CONVERT(VARCHAR,C1.REGR_ON,109),11) = 'JAN  1 1900') THEN '' 
				ELSE REPLACE(CONVERT(VARCHAR,C1.REGR_ON,103),'/','')
			END
		END),
		INPERSON_VERIFICATION = CONVERT(VARCHAR(1),''),
		CLIENT_AGREEMENT_DATE = CONVERT(VARCHAR(8),'') /*(
		CASE
			WHEN CLIENT_AGREEMENT_ON IS NULL THEN ''   
			WHEN (LEFT(CONVERT(VARCHAR,CLIENT_AGREEMENT_ON,109),11) = 'JAN  1 1900') THEN '' 
			ELSE REPLACE(CONVERT(VARCHAR,CLIENT_AGREEMENT_ON,103),'/','')
		END)*/,
		RESERVED_1		= CONVERT(VARCHAR(10),''),
		RELATIONSHIP_CODE = CONVERT(VARCHAR(10),''),
		/*
		UCC_CODE		= CONVERT(VARCHAR(10),''),
		UPDATIONFLAG	= CONVERT(VARCHAR(1),''),
		RELATIONSHIP	= CONVERT(VARCHAR(1),''),
		TYPEOFFACILITY	= CONVERT(VARCHAR(1),''),
		*/		
		PAN_EXEMPT_PROOF_TYPE = CONVERT(VARCHAR(2),''),
		PAN_EXEMPT_PROOF_NO	= CONVERT(VARCHAR(25),''),
		PAN_EXEMPT_PROOF_ISSUE_PLACE = CONVERT(VARCHAR(100),''),
		PAN_EXEMPT_PROOF_ISSUE_DATE = CONVERT(VARCHAR(8),''),
		CLIENT_STATUS = (
		CASE
			WHEN CB.INACTIVE_FROM >= GETDATE() THEN '1'
			ELSE '2'
		END),
		CLIENT_STATUS_REMARKS = CONVERT(VARCHAR(200),''),
		CLIENT_TYPE_CORPORATE = CONVERT(VARCHAR(1),''),

		CONTACT_PERSON_NAME_1 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_1 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_1 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_1 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_1 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_1 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_1 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_1 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_2 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_2 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_2 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_2 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_2 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_2 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_2 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_2 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_3 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_3 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_3 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_3 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_3 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_3 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_3 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_3 = CONVERT(VARCHAR(60),''),
		
		CONTACT_PERSON_NAME_4 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_4 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_4 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_4 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_4 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_4 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_4 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_4 = CONVERT(VARCHAR(60),''),
			
		CONTACT_PERSON_NAME_5 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_5 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_5 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_5 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_5 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_5 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_5 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_5 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_6 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_6 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_6 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_6 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_6 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_6 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_6 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_6 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_7 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_7 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_7 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_7 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_7 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_7 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_7 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_7 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_8 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_8 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_8 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_8 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_8 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_8 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_8 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_8 = CONVERT(VARCHAR(60),''),
		
		CONTACT_PERSON_NAME_9 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_9 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_9 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_9 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_9 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_9 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_9 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_9 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_10 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_10 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_10 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_10 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_10 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_10 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_10 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_10 = CONVERT(VARCHAR(60),''),
		
		CONTACT_PERSON_NAME_11 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_11 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_11 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_11 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_11 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_11 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_11 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_11 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_12 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_12 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_12 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_12 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_12 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_12 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_12 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_12 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_13 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_13 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_13 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_13 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_13 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_13 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_13 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_13 = CONVERT(VARCHAR(60),''),
		
		CONTACT_PERSON_NAME_14 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_14 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_14 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_14 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_14 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_14 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_14 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_14 = CONVERT(VARCHAR(60),''),
			
		CONTACT_PERSON_NAME_15 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_15 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_15 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_15 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_15 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_15 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_15 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_15 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_16 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_16 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_16 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_16 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_16 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_16 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_16 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_16 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_17 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_17 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_17 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_17 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_17 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_17 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_17 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_17 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_18 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_18 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_18 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_18 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_18 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_18 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_18 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_18 = CONVERT(VARCHAR(60),''),
		
		CONTACT_PERSON_NAME_19 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_19 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_19 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_19 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_19 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_19 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_19 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_19 = CONVERT(VARCHAR(60),''),

		CONTACT_PERSON_NAME_20 = CONVERT(VARCHAR(100),''),
		CONTACT_PERSON_DESIGNATION_20 = CONVERT(VARCHAR(25),''),
		CONTACT_PERSON_PAN_20 = CONVERT(VARCHAR(10),''),
		CONTACT_PERSON_ADDRESS_20 = CONVERT(VARCHAR(255),''),
		CONTACT_PERSON_DETAILS_20 = CONVERT(VARCHAR(60),''),
		CONTACT_PERSON_DIN_20 = CONVERT(VARCHAR(8),''),
		CONTACT_PERSON_UID_20 = CONVERT(VARCHAR(12),''),
		CONTACT_PERSON_EMAIL_20 = CONVERT(VARCHAR(60),''),	
		END_FLAG = 'E',

		ORD_FLAG = 1,
		ERROR_FLAG = 'N',
		ERROR_MSG = CONVERT(VARCHAR(1500),'')
	INTO
		#UCC_NSE
	FROM
		MSAJAG..CLIENT_DETAILS C1 (NOLOCK),
		MSAJAG..CLIENT_BROK_DETAILS CB (NOLOCK)
	WHERE
		C1.CL_CODE = CB.CL_CODE
		AND EXCHANGE+SEGMENT = @EXCHANGE
		AND C1.CL_TYPE <> 'REM'
		AND EXISTS (
					SELECT 
						DISTINCT PARTY_CODE 
					FROM 
						#CLIENTLIST C
					WHERE 
						C.PARTY_CODE = C1.CL_CODE )
		AND 1 = (
		CASE   
			WHEN @CLTYPE='' THEN 1   
			WHEN @CLTYPE='I' THEN (CASE WHEN C1.CL_TYPE = 'INS' THEN 1 ELSE 0 END)
			WHEN @CLTYPE='C' THEN (CASE WHEN C1.CL_TYPE <> 'INS' THEN 1 ELSE 0 END)
			ELSE 1
		END)
		AND BRANCH_CD BETWEEN @FROMBRANCH AND @TOBRANCH 
		AND CB.SYSTEMDATE BETWEEN   
			CASE WHEN @OPTIONVAL = 'A' THEN @FROMDATE ELSE 'JAN  1 1900' END  
			AND  
			CASE WHEN @OPTIONVAL = 'A' THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59' END  
		AND CB.ACTIVE_DATE BETWEEN  
			CASE WHEN @OPTIONVAL = 'S' THEN @FROMDATE ELSE 'JAN  1 1900' END  
			AND  
			CASE WHEN @OPTIONVAL = 'S' THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59' END
		AND CB.INACTIVE_FROM NOT BETWEEN  
			CASE WHEN @OPTIONVAL = 'S' THEN @FROMDATE ELSE 'JAN  1 1900' END  
			AND  
			CASE WHEN @OPTIONVAL = 'S' THEN @TODATE + ' 23:59' ELSE '' END  
		AND CB.INACTIVE_FROM BETWEEN  
			CASE WHEN @OPTIONVAL = 'I' THEN @FROMDATE ELSE 'JAN  1 1900' END  
			AND  
			CASE WHEN @OPTIONVAL = 'I' THEN @TODATE + ' 23:59' ELSE 'DEC 31 2049 23:59' END  
				   
	/*----------------------------
	  UPDATE FOR CLIENT DETAILS
	-----------------------------*/
	
	UPDATE 
		#UCC_NSE 
	SET	
		PER_ADDRESS1 = ( 
		CASE
			WHEN ADDRESS_FLAG = 'Y' THEN ''
			ELSE PER_ADDRESS1
		END),	
		PER_ADDRESS2 = ( 
		CASE
			WHEN ADDRESS_FLAG = 'Y' THEN ''
			ELSE PER_ADDRESS2
		END),
		PER_ADDRESS3 = ( 
		CASE
			WHEN ADDRESS_FLAG = 'Y' THEN ''
			ELSE PER_ADDRESS3
		END),
		PER_COUNTRY = ( 
		CASE
			WHEN ADDRESS_FLAG = 'Y' THEN ''
			ELSE PER_COUNTRY
		END),
		PER_STATE_CITY = ( 
		CASE
			WHEN ADDRESS_FLAG = 'Y' THEN ''
			ELSE PER_STATE_CITY
		END),
		PER_L_ZIP = ( 
		CASE
			WHEN ADDRESS_FLAG = 'Y' THEN ''
			ELSE PER_L_ZIP
		END),
		CLIENT_TYPE_CORPORATE = (
		CASE
			WHEN CATEGORY IN ('01','02','11','15','16','17') THEN 'N'
			ELSE 'Y'
		END)
		
	/*----------------------------
	  UPDATE BANK DETAILS
	-----------------------------*/

	IF @SEGMENT		= 'MSX'
	BEGIN
		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_1 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_1 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS1,''),255),
			BANK_ACCOUNT_NO_1 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_1 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTMCXDB..MULTIBANKID D (NOLOCK) INNER JOIN POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND #UCC_NSE.CATEGORY NOT IN ('04','06','12','18','19','20')
			AND DEFAULTBANK = 1

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_2 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_2 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS1,''),255),
			BANK_ACCOUNT_NO_2 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_2 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTMCXDB..MULTIBANKID D (NOLOCK) INNER JOIN POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND #UCC_NSE.CATEGORY NOT IN ('04','06','12','18','19','20')

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_3 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_3 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS1,''),255),
			BANK_ACCOUNT_NO_3 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_3 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTMCXDB..MULTIBANKID D (NOLOCK) INNER JOIN POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_2+#UCC_NSE.BANK_ACCOUNT_NO_2
			AND #UCC_NSE.CATEGORY NOT IN ('04','06','12','18','19','20')
	END
	ELSE IF	@SEGMENT = 'MFO'
	BEGIN
		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_1 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_1 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS1,''),255),
			BANK_ACCOUNT_NO_1 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_1 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTCURBFO..MULTIBANKID D (NOLOCK) INNER JOIN POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND #UCC_NSE.CATEGORY NOT IN ('04','06','12','18','19','20')
			AND DEFAULTBANK = 1

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_2 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_2 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS1,''),255),
			BANK_ACCOUNT_NO_2 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_2 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTCURBFO..MULTIBANKID D (NOLOCK) INNER JOIN POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND #UCC_NSE.CATEGORY NOT IN ('04','06','12','18','19','20')

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_3 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_3 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS1,''),255),
			BANK_ACCOUNT_NO_3 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_3 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTCURBFO..MULTIBANKID D (NOLOCK) INNER JOIN POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_2+#UCC_NSE.BANK_ACCOUNT_NO_2
			AND #UCC_NSE.CATEGORY NOT IN ('04','06','12','18','19','20')
	END	
	ELSE IF	@SEGMENT = 'MCD'
	BEGIN
		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_1 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_1 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS1,''),255),
			BANK_ACCOUNT_NO_1 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_1 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTMCDXCDS..MULTIBANKID D (NOLOCK) INNER JOIN POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND #UCC_NSE.CATEGORY NOT IN ('04','06','12','18','19','20')
			AND DEFAULTBANK = 1
			
		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_2 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_2 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS1,''),255),
			BANK_ACCOUNT_NO_2 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_2 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTMCDXCDS..MULTIBANKID D (NOLOCK) INNER JOIN POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND #UCC_NSE.CATEGORY NOT IN ('04','06','12','18','19','20')

		UPDATE 
			#UCC_NSE 
		SET	
			BANK_NAME_3 = LEFT(ISNULL(P.BANK_NAME,''),60),
			BANK_BRANCH_ADD_3 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS1,''),255),
			BANK_ACCOUNT_NO_3 = ISNULL(D.ACCNO,''),
			BANK_ACCOUNT_TYPE_3 = (
			CASE 
				WHEN LEFT(ACCTYPE,6) = 'SAVING' THEN '10' 
				WHEN LEFT(ACCTYPE,7) = 'CURRENT' THEN '11' 
				ELSE '99'
			END)
		FROM 
			ACCOUNTMCDXCDS..MULTIBANKID D (NOLOCK) INNER JOIN POBANK P (NOLOCK) ON D.BANKID = P.BANKID
		WHERE 
			#UCC_NSE.CLIENT_CODE = D.CLTCODE
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_ACCOUNT_NO_1
			AND LEFT(ISNULL(P.BANK_NAME,''),60)+D.ACCNO <> #UCC_NSE.BANK_NAME_2+#UCC_NSE.BANK_ACCOUNT_NO_2
			AND #UCC_NSE.CATEGORY NOT IN ('04','06','12','18','19','20')	
	END	


	UPDATE   
		#UCC_NSE   
	SET 
		BANK_NAME_1 = LEFT(ISNULL(P.BANK_NAME,''),60),
		BANK_BRANCH_ADD_1 = LEFT(ISNULL(P.BRANCH_NAME,'')+' '+ISNULL(P.ADDRESS1,''),255),
		BANK_ACCOUNT_NO_1 = ISNULL(CLTDPID,''),
		BANK_ACCOUNT_TYPE_1 = (
		CASE 
			WHEN LEFT(C4.DEPOSITORY,6) = 'SAVING' THEN '10' 
			WHEN LEFT(C4.DEPOSITORY,7) = 'CURRENT' THEN '11' 
			ELSE '99'
		END)
	FROM
		CLIENT4 C4 (NOLOCK) LEFT OUTER JOIN POBANK P (NOLOCK) ON (CONVERT(VARCHAR, P.BANKID) = C4.BANKID)
	WHERE   
		#UCC_NSE.CLIENT_CODE = C4.PARTY_CODE
		AND C4.DEPOSITORY NOT IN ('CDSL', 'NSDL')
		AND #UCC_NSE.CATEGORY NOT IN ('04','06','12','18','19','20')
		AND (#UCC_NSE.BANK_NAME_1+#UCC_NSE.BANK_BRANCH_ADD_1) = ''

	/*----------------------------
	  UPDATE DP BANK DETAILS
	-----------------------------*/

	UPDATE 
		#UCC_NSE 
	SET	
		DP_NAME_1 = (
		CASE
			WHEN ISNULL(D.DEPOSITORY,'') = 'NSDL' THEN '1'
			ELSE '2'
		END),
		DP_ID_1 = (
		CASE
			WHEN ISNULL(D.DEPOSITORY,'') = 'CDSL' THEN ''
			ELSE D.BANKID
		END),
		BEN_ACCOUNT_NO_1 = D.CLTDPID
	FROM 
		CLIENT4 D (NOLOCK) INNER JOIN BANK P (NOLOCK) ON D.BANKID = P.BANKID
	WHERE 
		#UCC_NSE.CLIENT_CODE = D.PARTY_CODE
		AND D.DEPOSITORY IN ('NSDL','CDSL') 
		AND D.DEFDP = 1
		AND #UCC_NSE.CATEGORY NOT IN ('04','06','12','18','19','20')

	UPDATE 
		#UCC_NSE 
	SET	
		DP_NAME_2 = (
		CASE
			WHEN ISNULL(D.DPTYPE,'') = 'NSDL' THEN '1'
			ELSE '2'
		END),
		DP_ID_2 = (
		CASE
			WHEN ISNULL(D.DPTYPE,'') = 'CDSL' THEN ''
			ELSE D.DPID
		END),
		BEN_ACCOUNT_NO_2 = D.CLTDPNO
	FROM 
		MULTICLTID D (NOLOCK) INNER JOIN BANK P (NOLOCK) ON D.DPID = P.BANKID
	WHERE 
		#UCC_NSE.CLIENT_CODE = D.PARTY_CODE
		AND D.CLTDPNO <> #UCC_NSE.BEN_ACCOUNT_NO_1
		AND #UCC_NSE.CATEGORY NOT IN ('04','06','12','18','19','20')

	UPDATE 
		#UCC_NSE 
	SET	
		DP_NAME_3 = (
		CASE
			WHEN ISNULL(D.DPTYPE,'') = 'NSDL' THEN '1'
			ELSE '2'
		END),
		DP_ID_3 = (
		CASE
			WHEN ISNULL(D.DPTYPE,'') = 'CDSL' THEN ''
			ELSE D.DPID
		END),
		BEN_ACCOUNT_NO_3 = D.CLTDPNO
	FROM 
		MULTICLTID D (NOLOCK) INNER JOIN BANK P (NOLOCK) ON D.DPID = P.BANKID
	WHERE 
		#UCC_NSE.CLIENT_CODE = D.PARTY_CODE
		AND D.CLTDPNO <> #UCC_NSE.BEN_ACCOUNT_NO_1
		AND D.CLTDPNO <> #UCC_NSE.BEN_ACCOUNT_NO_2
		AND #UCC_NSE.CATEGORY NOT IN ('04','06','12','18','19','20')

	/*-----------------------------------------------------------------------------
	  UPDATE #UCC_NSE FOR CIN DETAILS
	------------------------------------------------------------------------------*/

	UPDATE
		#UCC_NSE
	SET
		CIN_NO = ISNULL(CM.CIN,'')
	FROM
		MSAJAG..CLIENT_MASTER_NOMINEE_DATA CM (NOLOCK)
	WHERE
		#UCC_NSE.CLIENT_CODE = CM.PARTY_CODE
		AND #UCC_NSE.CATEGORY = '13'


	UPDATE
		#UCC_NSE
	SET
		UID = ISNULL(AADHAR_UID,''),
		GUARDIANS_NAME = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('01','02','11') THEN LEFT(REPLACE(REPLACE(REPLACE(ISNULL(CM.FATHERNAME,''),'.',''),'&',''),'-',''),150)
			ELSE ''
		END),
		MARITAL_STATUS = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('01','02','11') THEN 
			CASE
				WHEN ISNULL(CM.MARITALSTATUS,'') IN ('02','S') THEN 'S'
				WHEN ISNULL(CM.MARITALSTATUS,'') IN ('01','M') THEN 'M'
				ELSE ISNULL(CM.MARITALSTATUS,'')
			END	
			ELSE ''
		END),
		NATIONALITY = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('01','02','11') THEN 
			CASE
				WHEN REPLACE(ISNULL(CM.NATIONALITY,''),'0','') = '99' THEN '2'
				ELSE REPLACE(ISNULL(CM.NATIONALITY,''),'0','')
			END
			ELSE ''
		END),
		OTHER_NATIONALITY = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('01','02','11') 
			THEN 
			CASE 
				WHEN (REPLACE(ISNULL(CM.NATIONALITY,''),'0','') = '2' OR REPLACE(ISNULL(CM.NATIONALITY,''),'0','') = '99') THEN ISNULL(CM.NATIONALITY_OTHER,'')
				ELSE '' 
			END
			ELSE ''
		END),		
		GROSS_ANNUAL_INCOME = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('04','06','12','18','19','20') THEN ''
			ELSE ISNULL(CM.GROSS_INCOME,'')
		END),	
		GROSS_ANNUAL_INCOME_DATE = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('04','06','12','18','19','20') THEN ''
			ELSE
			CASE
				WHEN ISNULL(CM.GROSS_INCOME,'') = '' THEN ''
				WHEN CM.GROSS_DATE IS NULL THEN ''
				WHEN LEFT(CM.GROSS_DATE,11) = 'JAN  1 1900' THEN ''
				ELSE REPLACE(CONVERT(VARCHAR,CM.GROSS_DATE,103),'/','')
			END
		END),
		NET_WORTH = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('04','06','12','18','19','20') THEN '' 
			ELSE 
			CASE 
				WHEN ISNULL(CM.NET_WORTH,0) = 0 THEN ''
				ELSE CONVERT(VARCHAR,ISNULL(CM.NET_WORTH,0))
			END
		END),
		NET_WORTH_DATE = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('04','06','12','18','19','20') THEN '' 
			ELSE
			CASE
				WHEN ISNULL(CM.NET_WORTH,0) = 0 THEN ''
				WHEN CM.NET_WORTH_DATE IS NULL THEN ''
				WHEN LEFT(CM.NET_WORTH_DATE,11) = 'JAN  1 1900' THEN ''
				ELSE REPLACE(CONVERT(VARCHAR,CM.NET_WORTH_DATE,103),'/','')
			END
		END),	
		POLITICALLY_EXPOSED_PERSON = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('04','06','12','18','19','20') THEN '' 
			ELSE
			CASE
				WHEN ISNULL(PEP,'') IN ('NA','') THEN '0'
				WHEN ISNULL(PEP,'') = 'PEP' THEN '1'
				WHEN ISNULL(PEP,'') = 'RPEP' THEN '2'
				ELSE RIGHT(ISNULL(PEP,''),1)
			END
		END),
		PLACE_INCORPORATION = (
		CASE
			WHEN #UCC_NSE.CATEGORY NOT IN ('01','02','11') THEN ISNULL(PLACEOFINCORPRATION,'')
			ELSE ''
		END),
		OCCUPATION = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('01','02','11') THEN 
			CASE
				WHEN @KRA_TYPE = 'NSDL' THEN ISNULL(CM.OCCUPATION,'')
				ELSE 
				CASE
					WHEN ISNULL(CM.OCCUPATION,'') = '01' THEN '02'
					--WHEN OCCUPATION = '02' AND ISNULL(DESCRIPTION,'') LIKE '%PUBLIC%' THEN '01'
					--WHEN OCCUPATION = '02' AND ISNULL(DESCRIPTION,'') LIKE '%GOVERNMENT%' THEN '03'
					WHEN ISNULL(CM.OCCUPATION,'') = '02' THEN '01' 
					WHEN ISNULL(CM.OCCUPATION,'') = '03' THEN '04'
					WHEN ISNULL(CM.OCCUPATION,'') = '04' THEN '05'
					WHEN ISNULL(CM.OCCUPATION,'') = '05' THEN '06'
					WHEN ISNULL(CM.OCCUPATION,'') = '06' THEN '07'
					WHEN ISNULL(CM.OCCUPATION,'') = '07' THEN '08'
					WHEN ISNULL(CM.OCCUPATION,'') = '08' THEN '09'
					ELSE ISNULL(CM.OCCUPATION,'')
				END
			END
			ELSE ''
		END),
		OCCUPATION_OTHER = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('01','02','11') THEN 
			(CASE 
				WHEN ISNULL(CM.OCCUPATION,'') = '99' THEN ISNULL(CM.OCCUPATION_OTHER,'')
				ELSE ''
			END)	
			ELSE ''
		END),
		DATE_COMMENCEMENT = (
		CASE
			WHEN #UCC_NSE.CATEGORY NOT IN ('01','02','04','10','11') THEN 
			CASE
				WHEN CM.DATEOFCOMMENCMENT IS NULL THEN ''
				WHEN LEFT(CM.DATEOFCOMMENCMENT,11) = 'JAN  1 1900' THEN ''
				ELSE REPLACE(CONVERT(VARCHAR,CM.DATEOFCOMMENCMENT,103),'/','')
			END
		ELSE ''	
		END), /*,
		UPDATIONFLAG	= ISNULL(CM.UPDATIONFLAG,''),
		RELATIONSHIP	= '', --ISNULL(CM.RELATIONSHIP,''),
		TYPEOFFACILITY	= ISNULL(CM.TYPEOFFACILITY,'')	
		*/
		PAN_EXEMPT_PROOF_TYPE = (CASE WHEN ISNULL(PAN_EXEMPT,'') = 'Y' THEN ISNULL(PANEXEMPTPROOF,'') ELSE '' END),
		PAN_EXEMPT_PROOF_NO	= (CASE WHEN ISNULL(PAN_EXEMPT,'') = 'Y' THEN ISNULL(PROOF_NUMBER,'') ELSE '' END),
		PAN_EXEMPT_PROOF_ISSUE_PLACE = (CASE WHEN ISNULL(PAN_EXEMPT,'') = 'Y' THEN ISNULL(ISSUE_PLACE,'') ELSE '' END),
		PAN_EXEMPT_PROOF_ISSUE_DATE = (
		CASE
			WHEN ISNULL(PAN_EXEMPT,'') = 'Y' THEN
			CASE			
				WHEN CM.ISSUE_DATE IS NULL THEN ''
				WHEN LEFT(CM.ISSUE_DATE,11) = 'JAN  1 1900' THEN ''
				ELSE REPLACE(CONVERT(VARCHAR,CM.ISSUE_DATE,103),'/','')
			END		
			ELSE ''
		END),
		INPERSON_VERIFICATION = (
		CASE
			WHEN #UCC_NSE.CATEGORY IN ('01','02') THEN ISNULL(IN_PERSON,'')
			ELSE ''
		END)
	FROM
		#UCC_NSE,
		MSAJAG..CLIENT_MASTER_UCC_DATA CM (NOLOCK)
	WHERE
		#UCC_NSE.CLIENT_CODE = CM.PARTY_CODE

	
	UPDATE
		#UCC_NSE
	SET
		OTHER_NATIONALITY = ISNULL(DESCRIPTION,'')
	FROM
		MSAJAG..CLIENT_STATIC_CODES C (NOLOCK)
	WHERE
		C.CODE = #UCC_NSE.OTHER_NATIONALITY
		AND KRA_TYPE = @KRA_TYPE
		AND OCCUPATION = '99'
		

	/*-----------------------------------------------------------------------------
	FOR ONLY SLBS SEGMENT 
	------------------------------------------------------------------------------*/  
	/*
	UPDATE
		#UCC_NSE
	SET
		UCC_CODE = ISNULL(UC.UCC_CODE,'')
	FROM 
		UCC_CLIENT UC (NOLOCK)
	WHERE
		#UCC_NSE.CLIENT_CODE = UC.PARTY_CODE
		AND @SEGMENT = 'SLB'
	*/
	/*-----------------------------------------------------------------------------
	  UPDATING FOR EMAIL / SMS SERVICES DETAILS
	------------------------------------------------------------------------------*/  
	/*
	UPDATE
		#UCC_NSE
		SET   
			UPDATIONFLAG	= ISNULL(CM.UPDATIONFLAG,''),
			RELATIONSHIP	= '', --ISNULL(CM.RELATIONSHIP,''),
			TYPEOFFACILITY	= ISNULL(CM.TYPEOFFACILITY,'')
	FROM
		MSAJAG..CLIENT_MASTER_UCC_DATA CM (NOLOCK)
	WHERE
		#UCC_NSE.CLIENT_CODE = CM.PARTY_CODE
		AND @SEGMENT <> 'SLB'
	*/
	/*-----------------------------------------------------------------------------
	  UPDATING FOR CLIENT CONTACT DETAILS
	------------------------------------------------------------------------------*/  

	UPDATE
		#UCC_NSE
	SET
		CONTACT_PERSON_NAME_1 = LEFT(ISNULL(CD.CONTACT_NAME,''),100),
		CONTACT_PERSON_DESIGNATION_1 = LEFT(ISNULL(CD.DESIGNATION,''),25),
		CONTACT_PERSON_PAN_1 = LEFT(ISNULL(CD.PANNO,''),10),
		CONTACT_PERSON_ADDRESS_1 = LEFT((ISNULL(RTRIM(CD.ADDRESS1),'') + ' '
						+ ISNULL(RTRIM(CD.ADDRESS2),'') + ' '   
						+ ISNULL(RTRIM(CD.ADDRESS3),'') + ' '   
						+ ISNULL(RTRIM(CD.CITY),'') + ' '   
						+ ISNULL(RTRIM(CD.ZIP),'') + ' '
						+ ISNULL(RTRIM(CD.STATE),'') + ' '
						+ ISNULL(RTRIM(CD.NATION),'')),255),
		CONTACT_PERSON_DETAILS_1 = (
		CASE
			WHEN ISNULL(CD.PHONE_NO,'') <> '' THEN LEFT(ISNULL(CD.PHONE_NO,''),60)
			ELSE LEFT(ISNULL(CD.MOBILENO,''),60)
		END),
		CONTACT_PERSON_DIN_1 = LEFT(ISNULL(CD.DIN,''),8),
		CONTACT_PERSON_UID_1 = LEFT(ISNULL(CD.UID,''),12),
		CONTACT_PERSON_EMAIL_1 = LEFT(ISNULL(CD.EMAIL,''),60)
	FROM
		MSAJAG..CLIENT_CONTACT_DETAILS CD (NOLOCK)
	WHERE
		CD.CL_CODE = #UCC_NSE.CLIENT_CODE
		AND LINE_NO = 1
		AND #UCC_NSE.CATEGORY IN ('13','15','16','17')
		

	UPDATE
		#UCC_NSE
	SET
		CONTACT_PERSON_NAME_2 = LEFT(ISNULL(CD.CONTACT_NAME,''),100),
		CONTACT_PERSON_DESIGNATION_2 = LEFT(ISNULL(CD.DESIGNATION,''),25),
		CONTACT_PERSON_PAN_2 = ISNULL(CD.PANNO,''),
		CONTACT_PERSON_ADDRESS_2 = LEFT((ISNULL(RTRIM(CD.ADDRESS1),'') + ' '
						+ ISNULL(RTRIM(CD.ADDRESS2),'') + ' '   
						+ ISNULL(RTRIM(CD.ADDRESS3),'') + ' '   
						+ ISNULL(RTRIM(CD.CITY),'') + ' '   
						+ ISNULL(RTRIM(CD.ZIP),'') + ' '
						+ ISNULL(RTRIM(CD.STATE),'') + ' '
						+ ISNULL(RTRIM(CD.NATION),'')),255),
		CONTACT_PERSON_DETAILS_2 = (
		CASE
			WHEN ISNULL(CD.PHONE_NO,'') <> '' THEN LEFT(ISNULL(CD.PHONE_NO,''),60)
			ELSE LEFT(ISNULL(CD.MOBILENO,''),60)
		END),
		CONTACT_PERSON_DIN_2 = LEFT(ISNULL(CD.DIN,''),8),
		CONTACT_PERSON_UID_2 = LEFT(ISNULL(CD.UID,''),12),
		CONTACT_PERSON_EMAIL_2 = LEFT(ISNULL(CD.EMAIL,''),60)
	FROM
		MSAJAG..CLIENT_CONTACT_DETAILS CD (NOLOCK)
	WHERE
		CD.CL_CODE = #UCC_NSE.CLIENT_CODE
		AND LINE_NO = 2
		AND #UCC_NSE.CATEGORY IN ('13','15','16','17')
				
	/*
	UPDATE
		#UCC_NSE
	SET
		CONTACT_PERSON_NAME_3 = ISNULL(CD.CONTACT_NAME,''),
		CONTACT_PERSON_DESIGNATION_3 = ISNULL(CD.DESIGNATION,''),
		CONTACT_PERSON_PAN_3 = ISNULL(CD.PANNO,''),
		CONTACT_PERSON_ADDRESS_3 = LEFT((ISNULL(RTRIM(CD.ADDRESS1),'') + ' '
						+ ISNULL(RTRIM(CD.ADDRESS2),'') + ' '   
						+ ISNULL(RTRIM(CD.ADDRESS3),'') + ' '   
						+ ISNULL(RTRIM(CD.CITY),'') + ' '   
						+ ISNULL(RTRIM(CD.ZIP),'') + ' '
						+ ISNULL(RTRIM(CD.STATE),'') + ' '
						+ ISNULL(RTRIM(CD.NATION),'')),255),
		CONTACT_PERSON_DETAILS_3 = (
		CASE
			WHEN ISNULL(CD.PHONE_NO,'') <> '' THEN ISNULL(CD.PHONE_NO,'')
			ELSE ISNULL(CD.MOBILENO,'')
		END),
		CONTACT_PERSON_DIN_3 = ISNULL(CD.DIN,''),
		CONTACT_PERSON_UID_3 = ISNULL(CD.UID,''),
		CONTACT_PERSON_EMAIL_3 = ISNULL(CD.EMAIL,'')
	FROM
		MSAJAG..CLIENT_CONTACT_DETAILS CD (NOLOCK)
	WHERE
		CD.CL_CODE = #UCC_NSE.CLIENT_CODE
		AND LINE_NO = 3
		AND #UCC_NSE.CATEGORY IN ('13','15','16','17')
	*/	

	UPDATE
		#UCC_NSE
	SET
		ERROR_FLAG	= (
		CASE
			WHEN ISNULL(CLIENT_NAME,'') = '' THEN 'Y'
			WHEN ISNULL(CATEGORY,'') = '' THEN 'Y'
			WHEN ISNULL(PAN,'') = '' THEN 'Y'
			WHEN ISNULL(GENDER,'') = '' AND ISNULL(CATEGORY,'') IN ('01','02','11') THEN 'Y'
			WHEN ISNULL(GUARDIANS_NAME,'') = '' AND ISNULL(CATEGORY,'') IN ('01','02','11') THEN 'Y' 
			WHEN ISNULL(MARITAL_STATUS,'') = '' AND ISNULL(CATEGORY,'') IN ('01','02','11') THEN 'Y' 
			WHEN ISNULL(NATIONALITY,'') = '' AND ISNULL(CATEGORY,'') IN ('01','02','11') THEN 'Y'
			WHEN ISNULL(EMAIL,'') = '' AND ISNULL(CATEGORY,'') IN ('04','06','12','18','19','20') THEN 'Y'
			WHEN ISNULL(COR_ADDRESS1,'') = '' THEN 'Y'
			WHEN ISNULL(COR_COUNTRY,'') = '' THEN 'Y'
			WHEN ISNULL(COR_STATE_CITY,'') = '' THEN 'Y'
			WHEN ISNULL(ADDRESS_FLAG,'') = 'N' AND ISNULL(PER_ADDRESS1,'') = '' THEN 'Y'
			WHEN ISNULL(ADDRESS_FLAG,'') = 'N' AND ISNULL(PER_COUNTRY,'') = '' THEN 'Y'			
			WHEN ISNULL(ADDRESS_FLAG,'') = 'N' AND ISNULL(PER_STATE_CITY,'') = '' THEN 'Y'
			WHEN ISNULL(PHONENO_RES,'') = '' AND ISNULL(PHONENO_OFF,'') = '' AND ISNULL(MOBILENO,'') = '' THEN 'Y'
			WHEN ISNULL(DOB,'') = '' AND ISNULL(CATEGORY,'') NOT IN ('04','06','12','18','19','20') THEN 'Y'		
			WHEN (ISNULL(BANK_NAME_1,'') = '' OR ISNULL(BANK_BRANCH_ADD_1,'') = '' OR ISNULL(BANK_ACCOUNT_NO_1,'') = '') AND ISNULL(CATEGORY,'') NOT IN ('04','06','12','18','19','20') THEN 'Y'
			WHEN ISNULL(CIN_NO,'') = '' AND ISNULL(CATEGORY,'') = '13' THEN 'Y'
			WHEN ISNULL(OCCUPATION,'') = '' AND ISNULL(CATEGORY,'') IN ('01','02','11') THEN 'Y'			
			WHEN ISNULL(CATEGORY,'') NOT IN ('04','06','12','18','19','20') AND ISNULL(GROSS_ANNUAL_INCOME,'') = '' AND ISNULL(NET_WORTH,'') = '' THEN 'Y'
			WHEN ISNULL(CATEGORY,'') NOT IN ('04','06','12','18','19','20') AND ISNULL(GROSS_ANNUAL_INCOME_DATE,'') = '' AND ISNULL(GROSS_ANNUAL_INCOME,'') <> '' THEN 'Y'
			WHEN ISNULL(CATEGORY,'') NOT IN ('04','06','12','18','19','20') AND ISNULL(NET_WORTH_DATE,'') = '' AND ISNULL(NET_WORTH,'') <> '' THEN 'Y'			
			--WHEN ISNULL(CATEGORY,'') IN ('13','15','16','17') AND CONTACT_PERSON_NAME_1 = '' AND CONTACT_PERSON_DESIGNATION_1 = '' AND CONTACT_PERSON_PAN_1 = '' THEN 'Y'
			--WHEN ISNULL(CATEGORY,'') IN ('13','15','16','17') AND CONTACT_PERSON_NAME_2 = '' AND CONTACT_PERSON_DESIGNATION_2 = '' AND CONTACT_PERSON_PAN_2 = '' THEN 'Y'
			ELSE 'N'
		END),
		
		ERROR_MSG = ERROR_MSG + (
		CASE
			WHEN ISNULL(CLIENT_NAME,'') = '' THEN 'CLIENT NAME DETAILS MISSING' + '|'
			ELSE ''
		END) +
		CASE
			WHEN ISNULL(CATEGORY,'') = '' THEN 'CLIENT CATEGORY MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN PAN = '' THEN 'PAN NO DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(GENDER,'') = '' AND ISNULL(CATEGORY,'') IN ('01','02','11') THEN 'GENDER DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(GUARDIANS_NAME,'') = '' AND ISNULL(CATEGORY,'') IN ('01','02','11') THEN 'GUARDIAN (FATHER/HUSBAND/GUARDIAN NAME) DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(MARITAL_STATUS,'') = '' AND ISNULL(CATEGORY,'') IN ('01','02','11') THEN 'MARITAL DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(NATIONALITY,'') = '' AND ISNULL(CATEGORY,'') IN ('01','02','11') THEN 'NATIONALITY DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(EMAIL,'') = '' AND ISNULL(CATEGORY,'') IN ('04','06','12','18','19','20') THEN 'EMAIL DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(COR_ADDRESS1,'') = '' THEN 'CORRESPONDENCE ADDRESS DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(COR_COUNTRY,'') = '' THEN 'CORRESPONDENCE COUNTRY DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(COR_STATE_CITY,'') = '' THEN 'CORRESPONDENCE STATE CITY DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(ADDRESS_FLAG,'') = 'N' AND ISNULL(PER_ADDRESS1,'') = '' THEN 'PERMANENT ADDRESS DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(ADDRESS_FLAG,'') = 'N' AND ISNULL(PER_COUNTRY,'') = '' THEN 'PERMANENT COUNTRY DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(ADDRESS_FLAG,'') = 'N' AND ISNULL(PER_STATE_CITY,'') = '' THEN 'CORRESPONDENCE STATE CITY DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(PHONENO_RES,'') = '' AND ISNULL(PHONENO_OFF,'') = '' AND ISNULL(MOBILENO,'') = '' THEN 'RES. PHONE / OFFICE PHONE / MOBILE NO DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(DOB,'') = '' AND ISNULL(CATEGORY,'') NOT IN ('04','06','12','18','19','20') THEN 'EMAIL / DATE OF INCORPORATION DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN (ISNULL(BANK_NAME_1,'') = '' OR ISNULL(BANK_BRANCH_ADD_1,'') = '' OR ISNULL(BANK_ACCOUNT_NO_1,'') = '') AND ISNULL(CATEGORY,'') NOT IN ('04','06','12','18','19','20') THEN 'BANK DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(CIN_NO,'') = '' AND ISNULL(CATEGORY,'') = '13' THEN 'CIN DETAILS MISSING FOR CORPORATE CLIENT' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(OCCUPATION,'') = '' AND ISNULL(CATEGORY,'') IN ('01','02','11') THEN 'OCCUPATION DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(CATEGORY,'') NOT IN ('04','06','12','18','19','20') AND ISNULL(GROSS_ANNUAL_INCOME,'') = '' AND ISNULL(NET_WORTH,'') = '' THEN 'ANNUAL INCOME / NET WORTH DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(CATEGORY,'') NOT IN ('04','06','12','18','19','20') AND ISNULL(GROSS_ANNUAL_INCOME_DATE,'') = '' AND ISNULL(GROSS_ANNUAL_INCOME,'') <> '' THEN 'ANNUAL INCOME DATE DETAILS MISSING' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(CATEGORY,'') NOT IN ('04','06','12','18','19','20') AND ISNULL(NET_WORTH_DATE,'') = '' AND ISNULL(NET_WORTH,'') <> '' THEN 'NET WORTH DATE DETAILS MISSING' + '|'
			ELSE ''
		END /*+
		CASE
			WHEN ISNULL(CATEGORY,'') IN ('13','15','16','17') AND CONTACT_PERSON_NAME_1 = '' AND CONTACT_PERSON_DESIGNATION_1 = '' AND CONTACT_PERSON_PAN_1 = '' THEN 'DIRECTOR CONTACT DETAILS MISSING FOR CORPORATE CLIENT' + '|'
			ELSE ''
		END +
		CASE
			WHEN ISNULL(CATEGORY,'') IN ('13','15','16','17') AND CONTACT_PERSON_NAME_2 = '' AND CONTACT_PERSON_DESIGNATION_2 = '' AND CONTACT_PERSON_PAN_2 = '' THEN 'DIRECTOR CONTACT DETAILS MISSING FOR CORPORATE CLIENT' + '|'
			ELSE ''
		END*/		
	
	
	UPDATE	#UCC_NSE 
	SET		COR_ADDRESS1 = REPLACE(COR_ADDRESS1,',',''),
			COR_ADDRESS2 = REPLACE(COR_ADDRESS2,',',''),
			COR_ADDRESS3 = REPLACE(COR_ADDRESS3,',',''),
			PER_ADDRESS1 = REPLACE(PER_ADDRESS1,',',''),
			PER_ADDRESS2 = REPLACE(PER_ADDRESS2,',',''),
			PER_ADDRESS3 = REPLACE(PER_ADDRESS3,',',''),
			BANK_NAME_1	= REPLACE(BANK_NAME_1,',',''),
			BANK_BRANCH_ADD_1 = REPLACE(BANK_BRANCH_ADD_1,',',''),
			BANK_NAME_2	= REPLACE(BANK_NAME_2,',',''),
			BANK_BRANCH_ADD_2 = REPLACE(BANK_BRANCH_ADD_2,',',''),
			BANK_NAME_3	= REPLACE(BANK_NAME_3,',',''),
			BANK_BRANCH_ADD_3 = REPLACE(BANK_BRANCH_ADD_3,',',''),
			CONTACT_PERSON_ADDRESS_1 = REPLACE(CONTACT_PERSON_ADDRESS_1,',',''),
			CONTACT_PERSON_EMAIL_1 = REPLACE(CONTACT_PERSON_EMAIL_1,',',''),
			CONTACT_PERSON_ADDRESS_2 = REPLACE(CONTACT_PERSON_ADDRESS_2,',',''),
			CONTACT_PERSON_EMAIL_2 = REPLACE(CONTACT_PERSON_EMAIL_2,',','')


	SELECT @R_COUNT = COUNT(1) FROM #UCC_NSE WHERE ERROR_FLAG = 'N'		
	
	SELECT *,R_COUNT = @R_COUNT FROM #UCC_NSE (NOLOCK)
	WHERE ERROR_FLAG = (
	CASE
		WHEN @UCC_FLAG = '' THEN ERROR_FLAG
		ELSE @UCC_FLAG
	END)	
	ORDER BY ERROR_FLAG, CLIENT_CODE, ORD_FLAG
		
	DROP TABLE #UCC_NSE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_VBB_BROKTABLEDETAILS
-- --------------------------------------------------
CREATE  PROC [dbo].[RPT_VBB_BROKTABLEDETAILS]  
 (  
 @PARTYCODE VARCHAR(15)  
 )  
  
 AS  
  
 IF (SELECT COUNT(1) FROM SYSOBJECTS WHERE NAME ='SCHEME_MAPPING') > 0  
 BEGIN  
  
  SET NOCOUNT ON  
  SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED   
    
  SELECT    
  SCHEMEDT = LEFT(SP_DATE_FROM,11) + ' -  ' + LEFT(SP_DATE_TO,11),  
  SCHEMETYPE= CASE SP_INST_TYPE WHEN 'FUT' THEN 'FUTURE' ELSE 'OPTION' END + ' ' +   
   CASE WHEN SP_TRD_TYPE='TRD' THEN 'NORMAL TRADE' ELSE 'EXER.ASSG/EXP.CLOSD' END,  
  SYMBOL = SP_SCRIP ,   
  COMPUTATIONTYPE = CASE SP_BROK_COMPUTETYPE WHEN  'I' THEN 'INCREMENTAL' ELSE 'VARIABLE' END,  
  BROKCOMPUTEON = CASE WHEN SP_BROK_COMPUTEON ='T' THEN 'TURNOVER' ELSE  
     CASE WHEN SP_BROK_COMPUTEON ='Q' THEN 'QUANTITY' ELSE  
     CASE WHEN SP_BROK_COMPUTEON ='L' THEN 'LOT SIZE' ELSE  
     'VALUE OF LOT' END END END ,  
  COMPUTATIONLEVEL = CASE WHEN SP_COMPUTATION_LEVEL ='T' THEN 'TRADES' ELSE  
     CASE WHEN SP_COMPUTATION_LEVEL ='O' THEN 'ORDER' ELSE  
     CASE WHEN SP_COMPUTATION_LEVEL ='S' THEN 'SCRIP' ELSE  
      'CONTRACT' END END END,  
  SCHEME = CASE WHEN SP_SCHEME_TYPE=0 THEN 'DEFAULT' ELSE  
     CASE WHEN SP_SCHEME_TYPE=1 THEN 'MAX LOGIC BS FL' ELSE   
    'MAX LOGIC SS FL' END END,  
  VALUERANGE = CONVERT(VARCHAR,SP_VALUE_FROM) + ' - ' + CASE WHEN SP_VALUE_TO = -1 THEN 'UN LIMIT' ELSE  
   CONVERT(VARCHAR,SP_VALUE_TO) END,  
  BROK = 'BUY ' + CONVERT(VARCHAR,SP_BUY_BROK) + CASE WHEN SP_BUY_BROK_TYPE ='V' THEN ' VALUE' ELSE ' PERC' END  +
	 ' SELL ' + CONVERT(VARCHAR,SP_SELL_BROK) + CASE WHEN SP_SELL_BROK_TYPE ='V' THEN ' VALUE' ELSE ' PERC' END +
	 ' MIN BROK ' + CONVERT(VARCHAR,SP_MIN_BROKAMT) + ' MAX BROK ' + CONVERT(VARCHAR,SP_MAX_BROKAMT),
   
  SCRORD = CASE WHEN SP_SCRIP='ALL' THEN 1 ELSE 2 END,  
  RCOUNT = 1  
  FROM SCHEME_MAPPING   
  WHERE SP_PARTY_CODE = @PARTYCODE  
  ORDER BY 1,3,SCRORD  
   
 END  
 ELSE  
 BEGIN  
  SELECT  
  RCOUNT = 0  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_VBB_SCHEME_LISTING
-- --------------------------------------------------
CREATE PROCEDURE  [dbo].[RPT_VBB_SCHEME_LISTING]

   @SCHEME_TYPE VARCHAR(3),
   @COMPUTATION_TYPE VARCHAR(3)

AS
   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 

     SM_SCHEME_ID,
     SM_SCHEME_DESC, 
     SM_COMPUTATIONON = CASE WHEN SM_COMPUTATIONON = 'V' THEN 'VALUE OF LOT' 
                             WHEN SM_COMPUTATIONON = 'T' THEN 'TURNOVER'
                             WHEN SM_COMPUTATIONON = 'Q' THEN 'QUANTITY'
                             WHEN SM_COMPUTATIONON = 'L' THEN 'LOT SIZE'
                             END,
     SM_COMPUTATIONTYPE = CASE WHEN SM_COMPUTATIONTYPE = 'V' THEN 'VARIABLE'
                               WHEN SM_COMPUTATIONTYPE = 'I' THEN 'INCREMENTAL'
                               END,
     SM_TRD_TYPE,
     SM_TURNOVERON,
     SM_VALUE_FROM,
     SM_VALUE_TO,
     SM_RES_MULTIPLIER,
     SM_BUY_BROK_TYPE,
     SM_SELL_BROK_TYPE,
     SM_BUY_BROK,
     SM_SELL_BROK 

FROM 
     SCHEME_MASTER 

WHERE
	1 = CASE 
		WHEN @SCHEME_TYPE = 'ALL' 
		THEN 1
		ELSE 
			CASE WHEN SM_TRD_TYPE = @SCHEME_TYPE THEN 1 ELSE 2 END
		END AND					
	1 = CASE 
		WHEN @COMPUTATION_TYPE = 'ALL' 
		THEN 1
		ELSE 
			CASE WHEN SM_COMPUTATIONTYPE = @COMPUTATION_TYPE THEN 1 ELSE 2 END
		END

  ORDER BY 
         SM_SCHEME_ID,
         SM_VALUE_FROM

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_VBB_SCHEME_MAPPING
-- --------------------------------------------------
CREATE PROCEDURE  [dbo].[RPT_VBB_SCHEME_MAPPING]

   @DATE_FRM VARCHAR(12),
   @PARTY_FRM VARCHAR(20),
   @PARTY_TO VARCHAR(20),
   @INSTRU_TYPE VARCHAR(5),
   @SP_SCRIP VARCHAR(10),
   @SCHEME_TYPE VARCHAR(8)


AS

	IF @PARTY_TO = '' BEGIN SET @PARTY_TO = 'ZZZZZ' END
	IF @SP_SCRIP = '' BEGIN SET @SP_SCRIP = 'ALL' END

   SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT 

   SP_PARTY_CODE,
   LONG_NAME,
   SP_COMPUTATION_LEVEL = CASE WHEN SP_COMPUTATION_LEVEL = 'T' THEN 'TRADE' 
                               WHEN SP_COMPUTATION_LEVEL = 'O' THEN 'ORDER'
                               WHEN SP_COMPUTATION_LEVEL = 'S' THEN 'SCRIP'
                               WHEN SP_COMPUTATION_LEVEL = 'C' THEN 'CONTRACT'
                             END, 
   SP_INST_TYPE,
   SP_SCRIP,
   SP_SCHEME_ID,
   SP_TRD_TYPE,
   SP_SCHEME_TYPE = CASE WHEN SP_SCHEME_TYPE = '0' THEN 'DEFAULT'
                         WHEN SP_SCHEME_TYPE = '1' THEN 'MAX BUYFL'
                         WHEN SP_SCHEME_TYPE = '3' THEN 'MAX SELLFL'
                        END,
   SP_MULTIPLIER,
   SP_BUY_BROK_TYPE = CASE WHEN SP_BUY_BROK_TYPE='P' THEN '%' ELSE 'V' END,
   SP_SELL_BROK_TYPE  = CASE WHEN SP_SELL_BROK_TYPE='P' THEN '%' ELSE 'V' END,
   SP_BUY_BROK,
   SP_SELL_BROK,
   SP_VALUE_FROM,
   SP_VALUE_TO,
   SP_TURNOVERON,
   SP_BROK_COMPUTEON = CASE WHEN SP_BROK_COMPUTEON = 'V' THEN 'VALUE OF LOT' 
                           WHEN SP_BROK_COMPUTEON = 'L' THEN 'LOT SIZE'
                           WHEN SP_BROK_COMPUTEON = 'Q' THEN 'QUANTITY'
                           WHEN SP_BROK_COMPUTEON = 'T' THEN 'TURN OVER'
                        END,
   SP_BROK_COMPUTETYPE = CASE WHEN SP_BROK_COMPUTETYPE = 'V' THEN 'VARIABLE' 
                             WHEN SP_BROK_COMPUTETYPE = 'I' THEN 'INCREMENTAL' 
                        END,
   SP_MIN_BROKAMT,
   SP_MAX_BROKAMT,
   SP_MIN_SCRIPAMT,
   SP_MAX_SCRIPAMT,
   SP_DATE_FROM = CONVERT(VARCHAR,SP_DATE_FROM,106),
   SP_DATE_TO   = CONVERT(VARCHAR,SP_DATE_TO,106)

  FROM 
        SCHEME_MAPPING(NOLOCK) , CLIENT1(NOLOCK) , CLIENT2(NOLOCK)
 
 WHERE
      CLIENT1.CL_CODE= CLIENT2.CL_CODE AND CLIENT2.PARTY_CODE = SP_PARTY_CODE 
      AND @DATE_FRM BETWEEN  SP_DATE_FROM AND SP_DATE_TO + ' 23:29'
      AND SP_PARTY_CODE BETWEEN @PARTY_FRM AND @PARTY_TO
      AND  1 = CASE 
					WHEN @INSTRU_TYPE = 'BOTH' 
					THEN
						1
					ELSE 
						CASE WHEN SP_INST_TYPE = @INSTRU_TYPE THEN 1 ELSE 2 END
					END 
      AND 1 = CASE 
					WHEN @SCHEME_TYPE = 'ALL' 
					THEN
						1
					ELSE 
						CASE WHEN SP_TRD_TYPE = @SCHEME_TYPE THEN 1 ELSE 2 END
					END 

      AND SP_SCRIP = @SP_SCRIP

  ORDER BY

        SP_PARTY_CODE,
        SP_DATE_FROM,
        SP_INST_TYPE,
        SP_TRD_TYPE, 
        SP_SCRIP,
        SP_VALUE_FROM

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCRIPMAPPINGINSERT
-- --------------------------------------------------



CREATE PROC [dbo].[SCRIPMAPPINGINSERT]
AS

IF (SELECT (CASE WHEN ISNULL(COUNT(1),0) > 0 THEN 1 ELSE 0 END) FROM TBL_FOSCRIPMAP_TMP WHERE RIGHT(INST_TYPE,3) = 'CUR') <= 0
BEGIN
	DELETE FROM TBL_FOSCRIPMAP_TMP
END

UPDATE TBL_FOSCRIPMAP_TMP SET 
N_INST_TYPE= ISNULL(N_INST_TYPE,''),
N_SYMBOL= ISNULL(N_SYMBOL,''),
N_EXPIRYDATE= ISNULL(N_EXPIRYDATE,''),
N_STRIKE_PRICE= ISNULL(N_STRIKE_PRICE,''),
N_OPTION_TYPE= ISNULL(N_OPTION_TYPE,''),
B_INST_TYPE= ISNULL(B_INST_TYPE,''),
B_SYMBOL= ISNULL(B_SYMBOL,''),
B_EXPIRYDATE= ISNULL(B_EXPIRYDATE,''),
B_STRIKE_PRICE= ISNULL(B_STRIKE_PRICE,''),
B_OPTION_TYPE= ISNULL(B_OPTION_TYPE,''),
M_INST_TYPE= ISNULL(M_INST_TYPE,''),
M_SYMBOL= ISNULL(M_SYMBOL,''),
M_EXPIRYDATE= ISNULL(M_EXPIRYDATE,''),
M_STRIKE_PRICE= ISNULL(M_STRIKE_PRICE,''),
M_OPTION_TYPE= ISNULL(M_OPTION_TYPE,''),
INST_TYPE= ISNULL(INST_TYPE,''),
SYMBOL= ISNULL(SYMBOL,''),
EXPIRYDATE= ISNULL(EXPIRYDATE,''),
STRIKE_PRICE= ISNULL(STRIKE_PRICE,''),
OPTION_TYPE= ISNULL(OPTION_TYPE,'')

UPDATE TBL_FOSCRIPMAP_TMP SET N_EXPIRYDATE = LEFT(CONVERT(DATETIME,REPLACE(N_EXPIRYDATE,'-','/'),103),11)
WHERE LEN(N_EXPIRYDATE) = 10 
UPDATE TBL_FOSCRIPMAP_TMP SET B_EXPIRYDATE = LEFT(CONVERT(DATETIME,REPLACE(B_EXPIRYDATE,'-','/'),103),11)
WHERE LEN(B_EXPIRYDATE) = 10
UPDATE TBL_FOSCRIPMAP_TMP SET M_EXPIRYDATE = LEFT(CONVERT(DATETIME,REPLACE(M_EXPIRYDATE,'-','/'),103),11)
WHERE LEN(M_EXPIRYDATE) = 10
UPDATE TBL_FOSCRIPMAP_TMP SET EXPIRYDATE = LEFT(CONVERT(DATETIME,REPLACE(EXPIRYDATE,'-','/'),103),11)
WHERE LEN(EXPIRYDATE) = 10

UPDATE TBL_FOSCRIPMAP_TMP SET N_STRIKE_PRICE = '0'
WHERE N_STRIKE_PRICE = ''

UPDATE TBL_FOSCRIPMAP_TMP SET B_STRIKE_PRICE = '0'
WHERE B_STRIKE_PRICE = ''

UPDATE TBL_FOSCRIPMAP_TMP SET M_STRIKE_PRICE = '0'
WHERE M_STRIKE_PRICE = ''

UPDATE TBL_FOSCRIPMAP_TMP SET STRIKE_PRICE = '0'
WHERE STRIKE_PRICE = ''

UPDATE TBL_FOSCRIPMAP_TMP SET N_OPTION_TYPE = ''
WHERE N_OPTION_TYPE = 'FF'

UPDATE TBL_FOSCRIPMAP_TMP SET B_OPTION_TYPE = ''
WHERE B_OPTION_TYPE = 'FF'

UPDATE TBL_FOSCRIPMAP_TMP SET M_OPTION_TYPE = ''
WHERE M_OPTION_TYPE = 'FF'

UPDATE TBL_FOSCRIPMAP_TMP SET OPTION_TYPE = ''
WHERE OPTION_TYPE = 'FF'

SELECT *, REGULAR_LOT = 0, SEC_NAME = CONVERT(VARCHAR(25),''),
MATURITY_DATE = EXPIRYDATE
INTO #TBL_FOSCRIPMAP FROM TBL_FOSCRIPMAP
WHERE 1 = 2

INSERT INTO TBL_FOSCRIPMAP
SELECT N_INST_TYPE,N_SYMBOL,N_EXPIRYDATE=(CASE WHEN N_EXPIRYDATE <> '' THEN CONVERT(DATETIME,N_EXPIRYDATE) + ' 23:59' ELSE N_EXPIRYDATE END),
	   N_STRIKE_PRICE,N_OPTION_TYPE,
	   B_INST_TYPE,B_SYMBOL,
	   B_EXPIRYDATE=(CASE WHEN B_EXPIRYDATE <> '' THEN CONVERT(DATETIME,B_EXPIRYDATE) + ' 23:59' ELSE B_EXPIRYDATE END),
	   B_STRIKE_PRICE,B_OPTION_TYPE,
	   M_INST_TYPE,M_SYMBOL,
	   M_EXPIRYDATE=(CASE WHEN M_EXPIRYDATE <> '' THEN CONVERT(DATETIME,M_EXPIRYDATE) + ' 23:59' ELSE M_EXPIRYDATE END),
	   M_STRIKE_PRICE,M_OPTION_TYPE,
	   INST_TYPE,SYMBOL,EXPIRYDATE=CONVERT(DATETIME,EXPIRYDATE) + ' 23:59',STRIKE_PRICE,OPTION_TYPE,
       FROM_DATE=LEFT(GETDATE(),11),TO_DATE='DEC 31 2049 23:59:59',ADDED_ON=GETDATE(),ADDED_BY='BACKEND'
FROM TBL_FOSCRIPMAP_TMP T
WHERE NOT EXISTS (
		SELECT SYMBOL FROM TBL_FOSCRIPMAP F
		WHERE F.INST_TYPE = T.INST_TYPE
		AND F.SYMBOL = T.SYMBOL
		AND F.EXPIRYDATE = CONVERT(DATETIME,T.EXPIRYDATE) + ' 23:59'
		AND F.STRIKE_PRICE = T.STRIKE_PRICE
		AND F.OPTION_TYPE = T.OPTION_TYPE)

INSERT INTO #TBL_FOSCRIPMAP
SELECT N_INST_TYPE,N_SYMBOL,N_EXPIRYDATE=(CASE WHEN N_EXPIRYDATE <> '' THEN CONVERT(DATETIME,N_EXPIRYDATE) + ' 23:59' ELSE N_EXPIRYDATE END),
	   N_STRIKE_PRICE,N_OPTION_TYPE,
	   B_INST_TYPE,B_SYMBOL,B_EXPIRYDATE=(CASE WHEN B_EXPIRYDATE <> '' THEN CONVERT(DATETIME,B_EXPIRYDATE) + ' 23:59' ELSE B_EXPIRYDATE END),
	   B_STRIKE_PRICE,B_OPTION_TYPE,
	   M_INST_TYPE,M_SYMBOL,M_EXPIRYDATE=(CASE WHEN M_EXPIRYDATE <> '' THEN CONVERT(DATETIME,M_EXPIRYDATE) + ' 23:59' ELSE M_EXPIRYDATE END),
	   M_STRIKE_PRICE,M_OPTION_TYPE,
	   INST_TYPE,SYMBOL,EXPIRYDATE=CONVERT(DATETIME,EXPIRYDATE) + ' 23:59',STRIKE_PRICE,OPTION_TYPE,
       FROM_DATE=LEFT(GETDATE(),11),TO_DATE='DEC 31 2049 23:59:59',ADDED_ON=GETDATE(),ADDED_BY='BACKEND', 
	   REGULAR_LOT = 0, SEC_NAME = '', MATURITY_DATE = CONVERT(DATETIME,EXPIRYDATE) + ' 23:59' 
FROM TBL_FOSCRIPMAP_TMP T
WHERE NOT EXISTS (
		SELECT SYMBOL FROM FOSCRIP2 F
		WHERE F.INST_TYPE = T.INST_TYPE
		AND F.SYMBOL = T.SYMBOL
		AND F.EXPIRYDATE = CONVERT(DATETIME,T.EXPIRYDATE) + ' 23:59'
		AND F.STRIKE_PRICE = T.STRIKE_PRICE
		AND F.OPTION_TYPE = T.OPTION_TYPE)


UPDATE  #TBL_FOSCRIPMAP SET REGULAR_LOT = C_REGULAR_LOT, SEC_NAME = F.SEC_NAME, MATURITY_DATE = F.MATURITYDATE
FROM BSECURFO.DBO.FOSCRIP2 F
WHERE F.INST_TYPE = B_INST_TYPE
AND F.SYMBOL = B_SYMBOL
AND F.EXPIRYDATE = B_EXPIRYDATE
AND F.STRIKE_PRICE = B_STRIKE_PRICE
AND F.OPTION_TYPE = B_OPTION_TYPE
AND REGULAR_LOT = 0
/*
UPDATE  #TBL_FOSCRIPMAP SET REGULAR_LOT = C_REGULAR_LOT, SEC_NAME = F.SEC_NAME, MATURITY_DATE = F.MATURITYDATE
FROM MCDXCDS.DBO.FOSCRIP2 F
WHERE F.INST_TYPE = M_INST_TYPE
AND F.SYMBOL = M_SYMBOL
AND F.EXPIRYDATE = M_EXPIRYDATE
AND F.STRIKE_PRICE = M_STRIKE_PRICE
AND F.OPTION_TYPE = M_OPTION_TYPE
AND REGULAR_LOT = 0
*/
INSERT INTO FOSCRIP1
SELECT Inst_Type,Symbol,Expirydate,Strike_Price,Option_Type
FROM #TBL_FOSCRIPMAP T
WHERE  NOT EXISTS (
		SELECT SYMBOL FROM FOSCRIP1 F
		WHERE F.INST_TYPE = T.INST_TYPE
		AND F.SYMBOL = T.SYMBOL
		AND F.EXPIRYDATE = T.EXPIRYDATE
		AND F.STRIKE_PRICE = T.STRIKE_PRICE
		AND F.OPTION_TYPE = T.OPTION_TYPE)

INSERT INTO 

 FOSCRIP2
SELECT /*P_Key = 0,*/Inst_Type,Symbol,Sec_Name,Expirydate,Strike_Price,Option_Type,
	   /*Startdate=LEFT(GETDATE(),11),*/Maturitydate=Maturity_date,
	   /*Series='0',Cor_Act_Level='0',*/C_Regular_Lot=REGULAR_LOT /*,
	   C_Issue_Mat_Dt='',C_U_Inst_Type='',C_U_Symbol='',C_U_Series='',C_U_Expirydate='',C_U_Strikeprice='',C_U_Option_Type='',C_U_Cal=''*/
FROM #TBL_FOSCRIPMAP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SCRIPMAPPINGUPLOAD
-- --------------------------------------------------






CREATE PROC [dbo].[SCRIPMAPPINGUPLOAD] (@FilePath Varchar(100)) AS            
                   
TRUNCATE TABLE TBL_FOSCRIPMAP_TMP            
          
--Bulk insert #Scrip_imp from @FilePath with  ( FIELDTERMINATOR = ',', ROWTERMINATOR = '\n' )             
EXEC Proc_Bulk_Ins_new 'TBL_FOSCRIPMAP_TMP', @FilePath, ','

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP
-- --------------------------------------------------
  
CREATE PROC SP @spName VARCHAR(25)AS               
Select * from sysobjects where name Like '%' + @spName + '%' and xtype='P' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_ADDBRANCH_EXECUTE
-- --------------------------------------------------
CREATE  PROC [dbo].[SP_ADDBRANCH_EXECUTE]
@STRSQL VARCHAR(8000)
AS
	PRINT @STRSQL
	EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_ADDCLIENT_EXECUTE
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.SP_ADDCLIENT_EXECUTE    SCRIPT DATE: MAY 12 2003 11:20:53 ******/
CREATE  PROC [dbo].[SP_ADDCLIENT_EXECUTE]
@STRSQL VARCHAR(8000)
AS
	PRINT @STRSQL
	EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_ADDEDITSCRIP_EXECUTE
-- --------------------------------------------------
/****** OBJECT:  STORED PROCEDURE DBO.SP_ADDEDITSCRIP_EXECUTE    SCRIPT DATE: 01/15/2005 1:52:39 PM ******/

CREATE PROC [dbo].[SP_ADDEDITSCRIP_EXECUTE]
@STRSQL VARCHAR(8000)
AS
	PRINT @STRSQL
	EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_CLIENTDETAILS
-- --------------------------------------------------
CREATE   PROCEDURE [dbo].[SP_CLIENTDETAILS]     
(
	@FROMDATE   VARCHAR(11),     
	@TODATE     VARCHAR(11),
	@FROMPARTY  VARCHAR(10),     
	@TOPARTY    VARCHAR(10),
	@BRCODE     VARCHAR(10),
	@CLIENTTYPE VARCHAR(3) ,
	@STATUSID   VARCHAR(15),     
	@STATUSNAME VARCHAR(25),    
	@CLSTATUS   VARCHAR(20),    
	@DPSTATUS   VARCHAR(20),    
	@WITHTRANDT VARCHAR(10),
	@NONTRADMONTH INT = 0	
)
AS    



IF  (LEN(@TOPARTY)=0)
SET @TOPARTY = 'ZZZZZZZZZZ'

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT
	C2.PARTY_CODE, C1.LONG_NAME, C1.BRANCH_CD, C1.SUB_BROKER, C1.TRADER, 
	STATUS = (CASE WHEN INACTIVEFROM <= GETDATE() THEN 'INACTIVE' ELSE 'ACTIVE  ' END),     
	CONVERT(VARCHAR(10),ACTIVEFROM,103) AS ACTIVEFROM ,     
	CONVERT(VARCHAR(10),INACTIVEFROM,103) AS INACTIVEFROM, 
	APPROVER, DPID = ISNULL(C4.BANKID,''),     
	CLTDPID = ISNULL(CLTDPID,''), 
	DEPOSITORY = ISNULL(C4.DEPOSITORY,''),    
	FIRSTDATE = CONVERT(VARCHAR,''), 
	LASTDATE = CONVERT(VARCHAR,'')
INTO
	#CLTREPORT 
FROM
	CLIENT1 C1 (NOLOCK), CLIENT5 C5 (NOLOCK), CLIENT2 C2 (NOLOCK)
	LEFT OUTER JOIN CLIENT4 C4 (NOLOCK)    
	ON ( C4.PARTY_CODE = C2.PARTY_CODE AND C4.DEFDP = 1 AND C4.DEPOSITORY IN('NSDL','CDSL'))     
WHERE C1.CL_CODE = C2.CL_CODE AND C1.CL_CODE = C5.CL_CODE     
	AND C1.BRANCH_CD LIKE (CASE WHEN @BRCODE = '' THEN '%' ELSE @BRCODE END)    
	AND C1.CL_STATUS LIKE (CASE WHEN @CLIENTTYPE ='' THEN '%' ELSE @CLIENTTYPE END)
	AND INACTIVEFROM >= (CASE WHEN @CLSTATUS='ACTIVE' THEN GETDATE()+1 ELSE INACTIVEFROM END)    
	AND INACTIVEFROM <= (CASE WHEN @CLSTATUS='INACTIVE' THEN GETDATE() ELSE INACTIVEFROM END)    
	AND ACTIVEFROM >= @FROMDATE AND ACTIVEFROM <= @TODATE + ' 23:59'    
	AND LEN(ISNULL(C4.BANKID,'')) >= (CASE WHEN @DPSTATUS='WITH' THEN 1 ELSE 0 END)    
	AND LEN(ISNULL(C4.BANKID,'')) <= (CASE WHEN @DPSTATUS='WITHOUT' THEN 0 ELSE 16 END)
	AND C2.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY

        AND @STATUSNAME =   
	  (CASE   
	   WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD  
	   WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER  
	   WHEN @STATUSID = 'TRADER' THEN C1.TRADER  
	   WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY  
	   WHEN @STATUSID = 'AREA' THEN C1.AREA  
	   WHEN @STATUSID = 'REGION' THEN C1.REGION  
	   WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE  
	   ELSE   
	  'BROKER'  
	  END)

IF @WITHTRANDT ='WITHTRANDT' 
BEGIN
	CREATE TABLE #CLIENTLIST
	(
		PARTY_CODE VARCHAR(10),
		MINTRANDATE DATETIME,
		MAXTRANDATE DATETIME
	)

	INSERT INTO #CLIENTLIST
	SELECT 	
		PARTY_CODE,
		MINTRANDATE=MIN(SAUDA_DATE),
		MAXTRANDATE=MAX(SAUDA_DATE) 
	FROM 
		FOBILLVALAN (NOLOCK)
	WHERE 
		PARTY_CODE IN (SELECT PARTY_CODE FROM #CLTREPORT)
	GROUP BY 
		PARTY_CODE
	
	UPDATE
		#CLTREPORT 
		SET FIRSTDATE = CONVERT(VARCHAR,MINTRANDATE,103), 
		LASTDATE = CONVERT(VARCHAR,MAXTRANDATE,103)
	FROM  
		#CLIENTLIST
	WHERE
		#CLTREPORT.PARTY_CODE = #CLIENTLIST.PARTY_CODE

	DROP TABLE #CLIENTLIST
END

CREATE TABLE #NONTRCLIENTLIST
(
	PARTY_CODE VARCHAR(15)
)

IF @CLSTATUS = 'NOTTRADED'
BEGIN

	DELETE #CLTREPORT WHERE PARTY_CODE IN
	(
		SELECT PARTY_CODE FROM  CLIENT5 (NOLOCK), CLIENT2 (NOLOCK)
		WHERE CLIENT2.CL_CODE = CLIENT5.CL_CODE
		AND ACTIVEFROM > DATEADD(MONTH, -@NONTRADMONTH, @TODATE)
	)


	INSERT INTO #NONTRCLIENTLIST
	SELECT 
		DISTINCT PARTY_CODE
	FROM
		FOBILLVALAN (NOLOCK)
	WHERE
		SAUDA_DATE >= DATEADD(MONTH, -@NONTRADMONTH, @TODATE)
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE IN (SELECT PARTY_CODE FROM #CLTREPORT)	
	
END



SELECT 
	PARTY_CODE,
	LONG_NAME, 
	BRANCH_CD, 
	SUB_BROKER,
	TRADER, 
	STATUS,    
	ACTIVEFROM,
	INACTIVEFROM, 
	APPROVER,
	DPID = CASE WHEN @DPSTATUS='WITH' THEN DPID ELSE '' END, 
	CLTDPID = CASE WHEN @DPSTATUS='WITH' THEN CLTDPID ELSE '' END, 
	DEPOSITORY = CASE WHEN @DPSTATUS='WITH' THEN DEPOSITORY ELSE '' END,    
	FIRSTDATE  = CASE WHEN @WITHTRANDT ='WITHTRANDT' THEN CONVERT(VARCHAR,FIRSTDATE,103) ELSE '' END,     
	LASTDATE = CASE WHEN @WITHTRANDT ='WITHTRANDT' THEN CONVERT(VARCHAR,LASTDATE,103) ELSE '' END  
FROM
	#CLTREPORT
WHERE	
	PARTY_CODE NOT IN (SELECT PARTY_CODE FROM #NONTRCLIENTLIST)    
ORDER BY
	BRANCH_CD, LONG_NAME     

DROP TABLE #CLTREPORT
DROP TABLE #NONTRCLIENTLIST

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_CLIENTMARGINDETAILS
-- --------------------------------------------------

CREATE   PROC [dbo].[SP_CLIENTMARGINDETAILS]     
(   
 @STATUSID VARCHAR(15),        
 @STATUSNAME VARCHAR(25),        
 @FROMPARTY VARCHAR(20),        
 @TOPARTY VARCHAR(20),        
 @FROMDATE VARCHAR(11),        
 @TODATE VARCHAR(11),        
 @BRANCH VARCHAR(10),        
 @TRADER VARCHAR (10),      
 @ORDERBY INT,  
 @INTBRANCHWISE INT,  
 @INTMARGINFLAG INT = 0,  
 @INTREPORTBY INT  = 2        
)  
AS  
  
    
IF @TOPARTY = ''    
      BEGIN    
            SET @TOPARTY = 'ZZZZZZZ'    
      END       
  
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
SET NOCOUNT ON  
IF @INTREPORTBY = 1  
BEGIN  
 SELECT  
  STRREPROTORDER = CASE   
     WHEN @ORDERBY = 2   
     THEN   
      PARENTCODE + CONVERT(VARCHAR,MARGINDATE,112)  
     ELSE  
      CONVERT(VARCHAR,MARGINDATE,112) + PARENTCODE  
     END ,  
  
  INTREPORTORDER2 = CASE WHEN @INTBRANCHWISE = 1 THEN FO.BRANCH_CD ELSE '' END,  
  
  MARGINDATE = LEFT(CONVERT(VARCHAR,MARGINDATE,109),11),BILLDATE = LEFT(CONVERT(VARCHAR,MARGINDATE,103),11),PARTY_CODE=PARENTCODE,        
  FO.BRANCH_CD,FO.SUB_BROKER,FO.TRADER,FO.SHORT_NAME,BILLAMOUNT = SUM(ISNULL(BILLAMOUNT,0)),
  LEDGERAMOUNT = SUM(ISNULL(LEDGERAMOUNT,0))-SUM(ISNULL(BILLAMOUNT,0)),        
  CASH_COLL = SUM(ISNULL(CASH_COLL,0)),NONCASH_COLL=SUM(ISNULL(NONCASH_COLL,0)),        
  INITIALMARGIN = SUM(ISNULL(INITIALMARGIN,0)), MTMMARGIN = SUM(ISNULL(MTMMARGIN,0)),  
  ADDMARGIN = SUM(ISNULL(ADDMARGIN,0)),  
  YEAR(MARGINDATE),MONTH(MARGINDATE),DAY(MARGINDATE),  
  UNCLEARAMOUNT=0 
        
 FROM  
  TBL_CLIENTMARGIN FO (NOLOCK),  
  CLIENT1 , CLIENT2_VIEW CLIENT2  
 WHERE  
  MARGINDATE >= @FROMDATE        
  AND MARGINDATE <= @TODATE + ' 23:59:00'        
  AND CLIENT1.CL_CODE = CLIENT2.CL_CODE  
  AND PARENTCODE >= @FROMPARTY        
  AND PARENTCODE <= @TOPARTY        
  AND FO.BRANCH_CD LIKE @BRANCH      
  AND FO.TRADER LIKE @TRADER      
  AND @STATUSNAME =   
   (CASE   
    WHEN @STATUSID = 'BRANCH' THEN FO.BRANCH_CD  
    WHEN @STATUSID = 'SUBBROKER' THEN FO.SUB_BROKER  
    WHEN @STATUSID = 'TRADER' THEN FO.TRADER  
    WHEN @STATUSID = 'FAMILY' THEN FO.FAMILY  
    WHEN @STATUSID = 'AREA' THEN AREA  
    WHEN @STATUSID = 'REGION' THEN REGION  
    WHEN @STATUSID = 'CLIENT' THEN FO.PARTY_CODE  
    ELSE   
   'BROKER'  
   END)        
  AND FO.PARTY_CODE = CLIENT2.PARTY_CODE  
  AND (CASE WHEN @INTMARGINFLAG = 1 THEN (ISNULL(INITIALMARGIN,0)+ISNULL(MTMMARGIN,0)+ISNULL(ADDMARGIN,0)) ELSE 1 END) > 0   
   GROUP BY  
   PARENTCODE,MARGINDATE,FO.BRANCH_CD,FO.SUB_BROKER,FO.TRADER,FO.SHORT_NAME,YEAR(MARGINDATE),MONTH(MARGINDATE),DAY(MARGINDATE)  
   
   ORDER BY  2,1  
END  
ELSE  
BEGIN  
 SELECT  
  STRREPROTORDER = CASE   
     WHEN @ORDERBY = 2   
     THEN   
      FO.PARTY_CODE + CONVERT(VARCHAR,MARGINDATE,112)  
     ELSE  
      CONVERT(VARCHAR,MARGINDATE,112) + FO.PARTY_CODE  
     END ,  
  
  INTREPORTORDER2 = CASE WHEN @INTBRANCHWISE = 1 THEN FO.BRANCH_CD ELSE '' END,  
  
  MARGINDATE = LEFT(CONVERT(VARCHAR,MARGINDATE,109),11),BILLDATE = LEFT(CONVERT(VARCHAR,MARGINDATE,103),11),FO.PARTY_CODE,        
  FO.BRANCH_CD,FO.SUB_BROKER,FO.TRADER,FO.SHORT_NAME,BILLAMOUNT = ISNULL(BILLAMOUNT,0),
  LEDGERAMOUNT = ISNULL(LEDGERAMOUNT,0),
  /*-ISNULL(BILLAMOUNT,0)*/        
  CASH_COLL = ISNULL(CASH_COLL,0),NONCASH_COLL=ISNULL(NONCASH_COLL,0),        
  INITIALMARGIN = ISNULL(INITIALMARGIN,0), MTMMARGIN = ISNULL(MTMMARGIN,0),  
  ADDMARGIN = ISNULL(ADDMARGIN,0),  
  YEAR(MARGINDATE),MONTH(MARGINDATE),DAY(MARGINDATE),  
  UNCLEARAMOUNT=0      
        
 FROM  
  TBL_CLIENTMARGIN FO (NOLOCK),  
  CLIENT1 , CLIENT2  
 WHERE  
  MARGINDATE >= @FROMDATE        
  AND MARGINDATE <= @TODATE + ' 23:59:00'        
  AND CLIENT1.CL_CODE = CLIENT2.CL_CODE  
  AND FO.PARTY_CODE >= @FROMPARTY        
  AND FO.PARTY_CODE <= @TOPARTY        
  AND FO.BRANCH_CD LIKE @BRANCH      
  AND FO.TRADER LIKE @TRADER      
  AND @STATUSNAME =   
   (CASE   
    WHEN @STATUSID = 'BRANCH' THEN FO.BRANCH_CD  
    WHEN @STATUSID = 'SUBBROKER' THEN FO.SUB_BROKER  
    WHEN @STATUSID = 'TRADER' THEN FO.TRADER  
    WHEN @STATUSID = 'FAMILY' THEN FO.FAMILY  
    WHEN @STATUSID = 'AREA' THEN AREA  
    WHEN @STATUSID = 'REGION' THEN REGION  
    WHEN @STATUSID = 'CLIENT' THEN FO.PARTY_CODE  
    ELSE   
   'BROKER'  
   END)        
  AND FO.PARTY_CODE = CLIENT2.PARTY_CODE  
  AND (CASE WHEN @INTMARGINFLAG = 1 THEN (ISNULL(INITIALMARGIN,0)+ISNULL(MTMMARGIN,0)+ISNULL(ADDMARGIN,0)) ELSE 1 END) > 0   
   ORDER BY  2,1  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_FOEXPMARGIN_CALC
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[SP_FOEXPMARGIN_CALC] 
(
	@SAUDA_DATE VARCHAR(11),
	@STATUSNAME VARCHAR(20)
)
AS


/* ------- CREATING TEMP TABLE -----------*/

CREATE TABLE [#NETPOSITION] 
(
	[PARTY_CODE] [VARCHAR] (10)  ,
	[INST_TYPE] [VARCHAR] (6)  ,
	[SYMBOL] [VARCHAR] (12)  ,
	[YEAREXPDATE] [INT]  ,
	[MONTHEXPDATE] [INT]  ,
	[OPTION_TYPE] [VARCHAR] (2)  ,
	[STRIKE_PRICE] [MONEY]  ,
	[NETPOSITION] [INT],
	[PRICE] [NUMERIC] (36,12),
	[MARGINPERC] [NUMERIC] (9,4),
	[MARGINAMT] [MONEY]
) 

CREATE INDEX [FOBILL] ON [DBO].[#NETPOSITION] 
	(PARTY_CODE,INST_TYPE, SYMBOL, YEAREXPDATE,MONTHEXPDATE, STRIKE_PRICE, OPTION_TYPE)


/* ------- FETCHING FUT POSITIONS -----------*/
INSERT INTO #NETPOSITION
SELECT
	PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	YEAR(SAUDA_DATE) AS YEAREXPDATE,
	MONTH(SAUDA_DATE) AS MONTHEXPDATE,
	OPTION_TYPE,
	STRIKE_PRICE,
	ABS(SUM(SQTY-PQTY)) AS NETPOSITION ,
	CL_RATE AS PRICE,
	0 AS MARGINPERC,
	0 AS MARGINAMT

FROM
	FOBILLVALAN
WHERE 
	SAUDA_DATE LIKE @SAUDA_DATE + '%'
	AND LEFT(INST_TYPE,3) = 'FUT'
GROUP BY
	PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	OPTION_TYPE,
	STRIKE_PRICE,
	CL_RATE,
	YEAR(SAUDA_DATE),
	MONTH(SAUDA_DATE)



/* ------- FETCHING OPT  POSITIONS -----------*/
INSERT INTO #NETPOSITION
SELECT
	PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	YEAR(SAUDA_DATE) AS YEAREXPDATE,
	MONTH(SAUDA_DATE) AS MONTHEXPDATE,
	OPTION_TYPE,
	STRIKE_PRICE,
	ABS(SUM(SQTY-PQTY)) AS NETPOSITION ,
	0 AS PRICE,
	0 AS MARGINPERC,
	0 AS MARGINAMT

FROM
	FOBILLVALAN
WHERE 
	SAUDA_DATE LIKE @SAUDA_DATE + '%'
	AND LEFT(INST_TYPE,3) = 'OPT'
GROUP BY
	PARTY_CODE,
	INST_TYPE,
	SYMBOL,
	EXPIRYDATE,
	OPTION_TYPE,
	STRIKE_PRICE,
	YEAR(SAUDA_DATE),
	MONTH(SAUDA_DATE)

/* ------- UPDATING UL CLOSING RATE FOR OPT POSITIONS -----------*/
UPDATE
	#NETPOSITION
SET
	PRICE = CL_RATE 
FROM 
	CLOSING
WHERE
	SYSDATE LIKE @SAUDA_DATE + '%'
	AND INST_TYPE LIKE 'OPT%'
	AND SYMBOL = SCRIP_CD

/* ------- FETCHING EXPOSURE MARGIN PERCENTAGE FOR NIFTY -----------*/
UPDATE
	#NETPOSITION
SET
	MARGINPERC = MARGIN_PERC 
FROM 
	FOMARGIN_EXP_PERC
WHERE 
	MARGIN_YEAR = YEAREXPDATE
	AND MARGIN_MONTH = MONTHEXPDATE
	AND MARGIN_SYMBOL = SYMBOL

/* ------- FETCHING EXPOSURE MARGIN PERCENTAGE FOR NIFTY -----------*/
UPDATE
	#NETPOSITION
SET
	MARGINPERC = MARGIN_PERC 
FROM 
	FOMARGIN_EXP_PERC_NIFTY
WHERE
	@SAUDA_DATE BETWEEN MARGIN_FROM AND MARGIN_TO
	AND MARGIN_SYMBOL = SYMBOL



/*----------- COMPUTING EXPOSURE MARGING AMT ------------*/
UPDATE
	#NETPOSITION
SET
	MARGINAMT = NETPOSITION * PRICE * MARGINPERC  / 100



/*----------- SAVING COMPUTED EXPOSURE MARGING AMT ------------*/
INSERT INTO FOMARGIN_EXP_DET_LOG 
SELECT
	*,@STATUSNAME,GETDATE()
FROM
	FOMARGIN_EXP_DETAILS
WHERE
	SAUDA_DATE LIKE @SAUDA_DATE + '%'

DELETE FOMARGIN_EXP_DETAILS WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'

INSERT INTO FOMARGIN_EXP_DETAILS 
SELECT
	@SAUDA_DATE,
	PARTY_CODE,
	SYMBOL,
	SUM(NETPOSITION),
	MARGINPERC,
	SUM(MARGINAMT),
	@STATUSNAME,
	GETDATE()
FROM #NETPOSITION
WHERE
	MARGINAMT > 0
GROUP BY
	PARTY_CODE,
	SYMBOL,
	MARGINPERC
	

DROP TABLE #NETPOSITION

/* --------------------------- E O F -------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_FOSPANMARGIN_UPD
-- --------------------------------------------------
CREATE PROC [dbo].[SP_FOSPANMARGIN_UPD] (@SAUDA_DATE VARCHAR(11)) AS

CREATE TABLE [#FOSPANMARGINNEW] 
(
	[PARTY_CODE] [VARCHAR] (10)  ,
	[SYMBOL] [VARCHAR] (12),
	[SPANMARGIN] [MONEY]  ,
	[PREMIUM] [MONEY]  ,
	[TOTALMARGIN] [MONEY]  ,
	[PMARGINRATE] [DECIMAL](18, 0)  ,
	[NEWSPANMARGIN] [MONEY]  ,
	[FINALTOTALMARGIN] [MONEY]  ,
	[MTOM] [MONEY]  
)

INSERT INTO #FOSPANMARGINNEW
SELECT 
	PARTY_CODE = ACCT,
	SYMBOL = CC,
	SPANMARGIN = CASE WHEN (SPANREQ - ANOV) > 0 THEN (SPANREQ - ANOV) ELSE 0 END ,
	PREMIUM = 0,
	TOTALMARGIN = 0,
	PMARGINRATE = 0,
	NEWSPANMARGIN = 0,
	TOTALMARGIN= 0,
	MTOM = 0
FROM 
	SPANMARGIN_INTRADAY
WHERE
	NODE='DREQ'
	AND INTRADATE LIKE @SAUDA_DATE +'%'


UPDATE 
	#FOSPANMARGINNEW
SET
	PMARGINRATE = CLIENT3.PMARGINRATE
FROM
	CLIENT3
WHERE 
	CLIENT3.PARTY_CODE = #FOSPANMARGINNEW.PARTY_CODE


UPDATE
	#FOSPANMARGINNEW
SET
	NEWSPANMARGIN = SPANMARGIN + (SPANMARGIN * PMARGINRATE /100)



UPDATE
	#FOSPANMARGINNEW
SET
	PREMIUM = NETPREMIUM
FROM
	(	
	SELECT PARTY_CODE,SYMBOL,NETPREMIUM=SUM(NETPREMIUM)
	FROM(
	
		SELECT 
			PARTY_CODE,
			INST_TYPE,
			SYMBOL,
			OPTION_TYPE,
			STRIKE_PRICE,
			NETPREMIUM = SUM(CASE WHEN SELL_BUY = 1 
						THEN TRADEQTY * PRICE
						ELSE -TRADEQTY * PRICE END)
		FROM
			FOSETTLEMENT
		WHERE
			SAUDA_DATE LIKE @SAUDA_DATE + '%'
			AND INST_TYPE LIKE 'OPT%' 
			AND AUCTIONPART <> 'EA'
			AND AUCTIONPART <> 'CA'
			AND PRICE<>0
			AND RESERVED1 <> 1
		GROUP BY
			PARTY_CODE,
			INST_TYPE,
			SYMBOL,
			OPTION_TYPE,
			STRIKE_PRICE
		
	) T
	GROUP BY PARTY_CODE,SYMBOL
	) TRDPOS
WHERE
	TRDPOS.PARTY_CODE = #FOSPANMARGINNEW.PARTY_CODE
	AND TRDPOS.SYMBOL = #FOSPANMARGINNEW.SYMBOL


UPDATE
	#FOSPANMARGINNEW
SET
	TOTALMARGIN = SPANMARGIN + PREMIUM,
	FINALTOTALMARGIN = (SPANMARGIN + PREMIUM) + NEWSPANMARGIN


DELETE FOMARGIN_SPAN WHERE MDATE LIKE @SAUDA_DATE + '%'

INSERT INTO FOMARGIN_SPAN
SELECT
	PARTY_CODE,
	SYMBOL,
	SPANMARGIN,
	PREMIUM,
	TOTALMARGIN,
	PMARGINRATE,
	MDATE=@SAUDA_DATE,
	NEWSPANMARGIN,
	FINALTOTALMARGIN,
	CL_TYPE='CL'
FROM
	#FOSPANMARGINNEW



INSERT INTO FOMARGIN_SPAN
SELECT
	PARTY_CODE=(SELECT MEMBERCODE FROM FOOWNER),
	SYMBOL ='',
	SPANMARGIN= SUM(SPANMARGIN),
	PREMIUM = SUM(PREMIUM),
	TOTALMARGIN = SUM(TOTALMARGIN),
	PMARGINRATE=0,
	MDATE=@SAUDA_DATE,
	NEWSPANMARGIN=SUM(NEWSPANMARGIN),
	FINALTOTALMARGIN=SUM(FINALTOTALMARGIN),
	CL_TYPE='TM'
FROM
	#FOSPANMARGINNEW

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_GENERATE_INSERTS
-- --------------------------------------------------
----------------------------------------------------------------------------------------------------------------------   
-- HTTP://VYASKN.TRIPOD.COM/CODE.HTM#INSERTS   
------------------------------------------------------------------------------------------------------------------------   
--SET NOCOUNT ON   
--GO   
--   
--PRINT 'USING MASTER DATABASE'   
--USE MASTER   
--GO   
--   
--PRINT 'CHECKING FOR THE EXISTENCE OF THIS PROCEDURE'   
--IF (SELECT OBJECT_ID('SP_GENERATE_INSERTS','P')) IS NOT NULL --MEANS, THE PROCEDURE ALREADY EXISTS   
-- BEGIN   
-- PRINT 'PROCEDURE ALREADY EXISTS. SO, DROPPING IT'   
-- DROP PROC SP_GENERATE_INSERTS   
-- END   
--GO   
--   
----TURN SYSTEM OBJECT MARKING ON   
--EXEC MASTER.DBO.SP_MS_UPD_SYSOBJ_CATEGORY 1   
--GO   
CREATE PROC [dbo].[SP_GENERATE_INSERTS]   
(   
@TABLE_NAME VARCHAR(776), -- THE TABLE/VIEW FOR WHICH THE INSERT STATEMENTS WILL BE GENERATED USING THE EXISTING DATA   
@TARGET_TABLE VARCHAR(776) = NULL, -- USE THIS PARAMETER TO SPECIFY A DIFFERENT TABLE NAME INTO WHICH THE DATA WILL BE INSERTED   
@INCLUDE_COLUMN_LIST BIT = 1, -- USE THIS PARAMETER TO INCLUDE/OMMIT COLUMN LIST IN THE GENERATED INSERT STATEMENT   
@FROM VARCHAR(800) = NULL, -- USE THIS PARAMETER TO FILTER THE ROWS BASED ON A FILTER CONDITION (USING WHERE)   
@INCLUDE_TIMESTAMP BIT = 0, -- SPECIFY 1 FOR THIS PARAMETER, IF YOU WANT TO INCLUDE THE TIMESTAMP/ROWVERSION COLUMN'S DATA IN THE INSERT STATEMENT   
@DEBUG_MODE BIT = 0, -- IF @DEBUG_MODE IS SET TO 1, THE SQL STATEMENTS CONSTRUCTED BY THIS PROCEDURE WILL BE PRINTED FOR LATER EXAMINATION   
@OWNER VARCHAR(64) = NULL, -- USE THIS PARAMETER IF YOU ARE NOT THE OWNER OF THE TABLE   
@OMMIT_IMAGES BIT = 0, -- USE THIS PARAMETER TO GENERATE INSERT STATEMENTS BY OMITTING THE 'IMAGE' COLUMNS   
@OMMIT_IDENTITY BIT = 0, -- USE THIS PARAMETER TO OMMIT THE IDENTITY COLUMNS   
@TOP INT = NULL, -- USE THIS PARAMETER TO GENERATE INSERT STATEMENTS ONLY FOR THE TOP N ROWS   
@COLS_TO_INCLUDE VARCHAR(8000) = NULL, -- LIST OF COLUMNS TO BE INCLUDED IN THE INSERT STATEMENT   
@COLS_TO_EXCLUDE VARCHAR(8000) = NULL, -- LIST OF COLUMNS TO BE EXCLUDED FROM THE INSERT STATEMENT   
@DISABLE_CONSTRAINTS BIT = 0, -- WHEN 1, DISABLES FOREIGN KEY CONSTRAINTS AND ENABLES THEM AFTER THE INSERT STATEMENTS   
@OMMIT_COMPUTED_COLS BIT = 0 -- WHEN 1, COMPUTED COLUMNS WILL NOT BE INCLUDED IN THE INSERT STATEMENT   
)   
AS   
BEGIN   
/***********************************************************************************************************   
PROCEDURE: SP_GENERATE_INSERTS (BUILD 22)   
(COPYRIGHT  2002 NARAYANA VYAS KONDREDDI. ALL RIGHTS RESERVED.)   
PURPOSE: TO GENERATE INSERT STATEMENTS FROM EXISTING DATA.   
THESE INSERTS CAN BE EXECUTED TO REGENERATE THE DATA AT SOME OTHER LOCATION.   
THIS PROCEDURE IS ALSO USEFUL TO CREATE A DATABASE SETUP, WHERE IN YOU CAN   
SCRIPT YOUR DATA ALONG WITH YOUR TABLE DEFINITIONS.   
WRITTEN BY: NARAYANA VYAS KONDREDDI   
HTTP://VYASKN.TRIPOD.COM   
ACKNOWLEDGEMENTS:   
DIVYA KALRA -- FOR BETA TESTING   
MARK CHARSLEY -- FOR REPORTING A PROBLEM WITH SCRIPTING UNIQUEIDENTIFIER COLUMNS WITH NULL VALUES   
ARTUR ZEYGMAN -- FOR HELPING ME SIMPLIFY A BIT OF CODE FOR HANDLING NON-DBO OWNED TABLES   
JORIS LAPERRE -- FOR REPORTING A REGRESSION BUG IN HANDLING TEXT/NTEXT COLUMNS   
TESTED ON: SQL SERVER 7.0 AND SQL SERVER 2000   
DATE CREATED: JANUARY 17TH 2001 21:52 GMT   
DATE MODIFIED: MAY 1ST 2002 19:50 GMT   
EMAIL: VYASKN@HOTMAIL.COM   
NOTE: THIS PROCEDURE MAY NOT WORK WITH TABLES WITH TOO MANY COLUMNS.   
RESULTS CAN BE UNPREDICTABLE WITH HUGE TEXT COLUMNS OR SQL SERVER 2000'S SQL_VARIANT DATA TYPES   
WHENEVER POSSIBLE, USE @INCLUDE_COLUMN_LIST PARAMETER TO OMMIT COLUMN LIST IN THE INSERT STATEMENT, FOR BETTER RESULTS   
IMPORTANT: THIS PROCEDURE IS NOT TESTED WITH INTERNATION DATA (EXTENDED CHARACTERS OR UNICODE). IF NEEDED   
YOU MIGHT WANT TO CONVERT THE DATATYPES OF CHARACTER VARIABLES IN THIS PROCEDURE TO THEIR RESPECTIVE UNICODE COUNTERPARTS   
LIKE NCHAR AND NVARCHAR   
EXAMPLE 1: TO GENERATE INSERT STATEMENTS FOR TABLE 'TITLES':   
EXEC SP_GENERATE_INSERTS 'TITLES'   
EXAMPLE 2: TO OMMIT THE COLUMN LIST IN THE INSERT STATEMENT: (COLUMN LIST IS INCLUDED BY DEFAULT)   
IMPORTANT: IF YOU HAVE TOO MANY COLUMNS, YOU ARE ADVISED TO OMMIT COLUMN LIST, AS SHOWN BELOW,   
TO AVOID ERRONEOUS RESULTS   
EXEC SP_GENERATE_INSERTS 'TITLES', @INCLUDE_COLUMN_LIST = 0   
EXAMPLE 3: TO GENERATE INSERT STATEMENTS FOR 'TITLESCOPY' TABLE FROM 'TITLES' TABLE:   
EXEC SP_GENERATE_INSERTS 'TITLES', 'TITLESCOPY'   
EXAMPLE 4: TO GENERATE INSERT STATEMENTS FOR 'TITLES' TABLE FOR ONLY THOSE TITLES   
WHICH CONTAIN THE WORD 'COMPUTER' IN THEM:   
NOTE: DO NOT COMPLICATE THE FROM OR WHERE CLAUSE HERE. IT'S ASSUMED THAT YOU ARE GOOD WITH T-SQL IF YOU ARE USING THIS PARAMETER   
EXEC SP_GENERATE_INSERTS 'TITLES', @FROM = "FROM TITLES WHERE TITLE LIKE '%COMPUTER%'"   
EXAMPLE 5: TO SPECIFY THAT YOU WANT TO INCLUDE TIMESTAMP COLUMN'S DATA AS WELL IN THE INSERT STATEMENT:   
(BY DEFAULT TIMESTAMP COLUMN'S DATA IS NOT SCRIPTED)   
EXEC SP_GENERATE_INSERTS 'TITLES', @INCLUDE_TIMESTAMP = 1   
EXAMPLE 6: TO PRINT THE DEBUG INFORMATION:   
EXEC SP_GENERATE_INSERTS 'TITLES', @DEBUG_MODE = 1   
EXAMPLE 7: IF YOU ARE NOT THE OWNER OF THE TABLE, USE @OWNER PARAMETER TO SPECIFY THE OWNER NAME   
TO USE THIS OPTION, YOU MUST HAVE SELECT PERMISSIONS ON THAT TABLE   
EXEC SP_GENERATE_INSERTS NICKSTABLE, @OWNER = 'NICK'   
EXAMPLE 8: TO GENERATE INSERT STATEMENTS FOR THE REST OF THE COLUMNS EXCLUDING IMAGES   
WHEN USING THIS OTION, DO NOT SET @INCLUDE_COLUMN_LIST PARAMETER TO 0.   
EXEC SP_GENERATE_INSERTS IMGTABLE, @OMMIT_IMAGES = 1   
EXAMPLE 9: TO GENERATE INSERT STATEMENTS EXCLUDING (OMMITING) IDENTITY COLUMNS:   
(BY DEFAULT IDENTITY COLUMNS ARE INCLUDED IN THE INSERT STATEMENT)   
EXEC SP_GENERATE_INSERTS MYTABLE, @OMMIT_IDENTITY = 1   
EXAMPLE 10: TO GENERATE INSERT STATEMENTS FOR THE TOP 10 ROWS IN THE TABLE:   
EXEC SP_GENERATE_INSERTS MYTABLE, @TOP = 10   
EXAMPLE 11: TO GENERATE INSERT STATEMENTS WITH ONLY THOSE COLUMNS YOU WANT:   
EXEC SP_GENERATE_INSERTS TITLES, @COLS_TO_INCLUDE = "'TITLE','TITLE_ID','AU_ID'"   
EXAMPLE 12: TO GENERATE INSERT STATEMENTS BY OMITTING CERTAIN COLUMNS:   
EXEC SP_GENERATE_INSERTS TITLES, @COLS_TO_EXCLUDE = "'TITLE','TITLE_ID','AU_ID'"   
EXAMPLE 13: TO AVOID CHECKING THE FOREIGN KEY CONSTRAINTS WHILE LOADING DATA WITH INSERT STATEMENTS:   
EXEC SP_GENERATE_INSERTS TITLES, @DISABLE_CONSTRAINTS = 1   
EXAMPLE 14: TO EXCLUDE COMPUTED COLUMNS FROM THE INSERT STATEMENT:   
EXEC SP_GENERATE_INSERTS MYTABLE, @OMMIT_COMPUTED_COLS = 1   
***********************************************************************************************************/   
SET NOCOUNT ON   
--MAKING SURE USER ONLY USES EITHER @COLS_TO_INCLUDE OR @COLS_TO_EXCLUDE   
IF ((@COLS_TO_INCLUDE IS NOT NULL) AND (@COLS_TO_EXCLUDE IS NOT NULL))   
BEGIN   
RAISERROR('USE EITHER @COLS_TO_INCLUDE OR @COLS_TO_EXCLUDE. DO NOT USE BOTH THE PARAMETERS AT ONCE',16,1)   
RETURN -1 --FAILURE. REASON: BOTH @COLS_TO_INCLUDE AND @COLS_TO_EXCLUDE PARAMETERS ARE SPECIFIED   
END   
--MAKING SURE THE @COLS_TO_INCLUDE AND @COLS_TO_EXCLUDE PARAMETERS ARE RECEIVING VALUES IN PROPER FORMAT   
IF ((@COLS_TO_INCLUDE IS NOT NULL) AND (PATINDEX('''%''',@COLS_TO_INCLUDE) = 0))   
BEGIN   
RAISERROR('INVALID USE OF @COLS_TO_INCLUDE PROPERTY',16,1)   
PRINT 'SPECIFY COLUMN NAMES SURROUNDED BY SINGLE QUOTES AND SEPARATED BY COMMAS'   
PRINT 'EG: EXEC SP_GENERATE_INSERTS TITLES, @COLS_TO_INCLUDE = "''TITLE_ID'',''TITLE''"'   
RETURN -1 --FAILURE. REASON: INVALID USE OF @COLS_TO_INCLUDE PROPERTY   
END   
IF ((@COLS_TO_EXCLUDE IS NOT NULL) AND (PATINDEX('''%''',@COLS_TO_EXCLUDE) = 0))   
BEGIN   
RAISERROR('INVALID USE OF @COLS_TO_EXCLUDE PROPERTY',16,1)   
PRINT 'SPECIFY COLUMN NAMES SURROUNDED BY SINGLE QUOTES AND SEPARATED BY COMMAS'   
PRINT 'EG: EXEC SP_GENERATE_INSERTS TITLES, @COLS_TO_EXCLUDE = "''TITLE_ID'',''TITLE''"'   
RETURN -1 --FAILURE. REASON: INVALID USE OF @COLS_TO_EXCLUDE PROPERTY   
END   
--CHECKING TO SEE IF THE DATABASE NAME IS SPECIFIED ALONG WIH THE TABLE NAME   
--YOUR DATABASE CONTEXT SHOULD BE LOCAL TO THE TABLE FOR WHICH YOU WANT TO GENERATE INSERT STATEMENTS   
--SPECIFYING THE DATABASE NAME IS NOT ALLOWED   
IF (PARSENAME(@TABLE_NAME,3)) IS NOT NULL   
BEGIN   
RAISERROR('DO NOT SPECIFY THE DATABASE NAME. BE IN THE REQUIRED DATABASE AND JUST SPECIFY THE TABLE NAME.',16,1)   
RETURN -1 --FAILURE. REASON: DATABASE NAME IS SPECIFIED ALONG WITH THE TABLE NAME, WHICH IS NOT ALLOWED   
END   
--CHECKING FOR THE EXISTENCE OF 'USER TABLE' OR 'VIEW'   
--THIS PROCEDURE IS NOT WRITTEN TO WORK ON SYSTEM TABLES   
--TO SCRIPT THE DATA IN SYSTEM TABLES, JUST CREATE A VIEW ON THE SYSTEM TABLES AND SCRIPT THE VIEW INSTEAD   
IF @OWNER IS NULL   
BEGIN   
IF ((OBJECT_ID(@TABLE_NAME,'U') IS NULL) AND (OBJECT_ID(@TABLE_NAME,'V') IS NULL))   
BEGIN   
RAISERROR('USER TABLE OR VIEW NOT FOUND.',16,1)   
PRINT 'YOU MAY SEE THIS ERROR, IF YOU ARE NOT THE OWNER OF THIS TABLE OR VIEW. IN THAT CASE USE @OWNER PARAMETER TO SPECIFY THE OWNER NAME.'   
PRINT 'MAKE SURE YOU HAVE SELECT PERMISSION ON THAT TABLE OR VIEW.'   
RETURN -1 --FAILURE. REASON: THERE IS NO USER TABLE OR VIEW WITH THIS NAME   
END   
END   
ELSE   
BEGIN   
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = @TABLE_NAME AND (TABLE_TYPE = 'BASE TABLE' OR TABLE_TYPE = 'VIEW') AND TABLE_SCHEMA = @OWNER)   
BEGIN   
RAISERROR('USER TABLE OR VIEW NOT FOUND.',16,1)   
PRINT 'YOU MAY SEE THIS ERROR, IF YOU ARE NOT THE OWNER OF THIS TABLE. IN THAT CASE USE @OWNER PARAMETER TO SPECIFY THE OWNER NAME.'   
PRINT 'MAKE SURE YOU HAVE SELECT PERMISSION ON THAT TABLE OR VIEW.'   
RETURN -1 --FAILURE. REASON: THERE IS NO USER TABLE OR VIEW WITH THIS NAME   
END   
END   
--VARIABLE DECLARATIONS   
DECLARE @COLUMN_ID INT,   
@COLUMN_LIST VARCHAR(8000),   
@COLUMN_NAME VARCHAR(128),   
@START_INSERT VARCHAR(786),   
@DATA_TYPE VARCHAR(128),   
@ACTUAL_VALUES VARCHAR(8000), --THIS IS THE STRING THAT WILL BE FINALLY EXECUTED TO GENERATE INSERT STATEMENTS   
@IDN VARCHAR(128) --WILL CONTAIN THE IDENTITY COLUMN'S NAME IN THE TABLE   
--VARIABLE INITIALIZATION   
SET @IDN = ''   
SET @COLUMN_ID = 0   
SET @COLUMN_NAME = ''   
SET @COLUMN_LIST = ''   
SET @ACTUAL_VALUES = ''   
IF @OWNER IS NULL   
BEGIN   
SET @START_INSERT = 'INSERT INTO ' + '[' + RTRIM(COALESCE(@TARGET_TABLE,@TABLE_NAME)) + ']'   
END   
ELSE   
BEGIN   
SET @START_INSERT = 'INSERT ' + '[' + LTRIM(RTRIM(@OWNER)) + '].' + '[' + RTRIM(COALESCE(@TARGET_TABLE,@TABLE_NAME)) + ']'   
END   
--TO GET THE FIRST COLUMN'S ID   
SELECT @COLUMN_ID = MIN(ORDINAL_POSITION)   
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK)   
WHERE TABLE_NAME = @TABLE_NAME AND   
(@OWNER IS NULL OR TABLE_SCHEMA = @OWNER)   
--LOOP THROUGH ALL THE COLUMNS OF THE TABLE, TO GET THE COLUMN NAMES AND THEIR DATA TYPES   
WHILE @COLUMN_ID IS NOT NULL   
BEGIN   
SELECT @COLUMN_NAME = QUOTENAME(COLUMN_NAME),   
@DATA_TYPE = DATA_TYPE   
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK)   
WHERE ORDINAL_POSITION = @COLUMN_ID AND   
TABLE_NAME = @TABLE_NAME AND   
(@OWNER IS NULL OR TABLE_SCHEMA = @OWNER)   
IF @COLS_TO_INCLUDE IS NOT NULL --SELECTING ONLY USER SPECIFIED COLUMNS   
BEGIN   
IF CHARINDEX( '''' + SUBSTRING(@COLUMN_NAME,2,LEN(@COLUMN_NAME)-2) + '''',@COLS_TO_INCLUDE) = 0   
BEGIN   
GOTO SKIP_LOOP   
END   
END   
IF @COLS_TO_EXCLUDE IS NOT NULL --SELECTING ONLY USER SPECIFIED COLUMNS   
BEGIN   
IF CHARINDEX( '''' + SUBSTRING(@COLUMN_NAME,2,LEN(@COLUMN_NAME)-2) + '''',@COLS_TO_EXCLUDE) <> 0   
BEGIN   
GOTO SKIP_LOOP   
END   
END   
--MAKING SURE TO OUTPUT SET IDENTITY_INSERT ON/OFF IN CASE THE TABLE HAS AN IDENTITY COLUMN   
IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@OWNER,USER_NAME())) + '.' + @TABLE_NAME),SUBSTRING(@COLUMN_NAME,2,LEN(@COLUMN_NAME) - 2),'ISIDENTITY')) = 1   
BEGIN   
IF @OMMIT_IDENTITY = 0 --DETERMING WHETHER TO INCLUDE OR EXCLUDE THE IDENTITY COLUMN   
SET @IDN = @COLUMN_NAME   
ELSE   
GOTO SKIP_LOOP   
END   
--MAKING SURE WHETHER TO OUTPUT COMPUTED COLUMNS OR NOT   
IF @OMMIT_COMPUTED_COLS = 1   
BEGIN   
IF (SELECT COLUMNPROPERTY( OBJECT_ID(QUOTENAME(COALESCE(@OWNER,USER_NAME())) + '.' + @TABLE_NAME),SUBSTRING(@COLUMN_NAME,2,LEN(@COLUMN_NAME) - 2),'ISCOMPUTED')) = 1   
BEGIN   
GOTO SKIP_LOOP   
END   
END   
--TABLES WITH COLUMNS OF IMAGE DATA TYPE ARE NOT SUPPORTED FOR OBVIOUS REASONS   
IF(@DATA_TYPE IN ('IMAGE'))   
BEGIN   
IF (@OMMIT_IMAGES = 0)   
BEGIN   
RAISERROR('TABLES WITH IMAGE COLUMNS ARE NOT SUPPORTED.',16,1)   
PRINT 'USE @OMMIT_IMAGES = 1 PARAMETER TO GENERATE INSERTS FOR THE REST OF THE COLUMNS.'   
PRINT 'DO NOT OMMIT COLUMN LIST IN THE INSERT STATEMENTS. IF YOU OMMIT COLUMN LIST USING @INCLUDE_COLUMN_LIST=0, THE GENERATED INSERTS WILL FAIL.'   
RETURN -1 --FAILURE. REASON: THERE IS A COLUMN WITH IMAGE DATA TYPE   
END   
ELSE   
BEGIN   
GOTO SKIP_LOOP   
END   
END   
--DETERMINING THE DATA TYPE OF THE COLUMN AND DEPENDING ON THE DATA TYPE, THE VALUES PART OF   
--THE INSERT STATEMENT IS GENERATED. CARE IS TAKEN TO HANDLE COLUMNS WITH NULL VALUES. ALSO   
--MAKING SURE, NOT TO LOSE ANY DATA FROM FLOT, REAL, MONEY, SMALLMOMEY, DATETIME COLUMNS   
SET @ACTUAL_VALUES = @ACTUAL_VALUES +   
CASE   
WHEN @DATA_TYPE IN ('CHAR','VARCHAR','NCHAR','NVARCHAR')   
THEN   
'COALESCE('''''''' + REPLACE(RTRIM(' + @COLUMN_NAME + '),'''''''','''''''''''')+'''''''',''NULL'')'   
WHEN @DATA_TYPE IN ('DATETIME','SMALLDATETIME')   
THEN   
'COALESCE('''''''' + RTRIM(CONVERT(CHAR,' + @COLUMN_NAME + ',109))+'''''''',''NULL'')'   
WHEN @DATA_TYPE IN ('UNIQUEIDENTIFIER')   
THEN   
'COALESCE('''''''' + REPLACE(CONVERT(CHAR(255),RTRIM(' + @COLUMN_NAME + ')),'''''''','''''''''''')+'''''''',''NULL'')'   
WHEN @DATA_TYPE IN ('TEXT','NTEXT')   
THEN   
'COALESCE('''''''' + REPLACE(CONVERT(CHAR(8000),' + @COLUMN_NAME + '),'''''''','''''''''''')+'''''''',''NULL'')'   
WHEN @DATA_TYPE IN ('BINARY','VARBINARY')   
THEN   
'COALESCE(RTRIM(CONVERT(CHAR,' + 'CONVERT(INT,' + @COLUMN_NAME + '))),''NULL'')'   
WHEN @DATA_TYPE IN ('TIMESTAMP','ROWVERSION')   
THEN   
CASE   
WHEN @INCLUDE_TIMESTAMP = 0   
THEN   
'''DEFAULT'''   
ELSE   
'COALESCE(RTRIM(CONVERT(CHAR,' + 'CONVERT(INT,' + @COLUMN_NAME + '))),''NULL'')'   
END   
WHEN @DATA_TYPE IN ('FLOAT','REAL','MONEY','SMALLMONEY')   
THEN   
'COALESCE(LTRIM(RTRIM(' + 'CONVERT(CHAR, ' + @COLUMN_NAME + ',2)' + ')),''NULL'')'   
ELSE   
'COALESCE(LTRIM(RTRIM(' + 'CONVERT(CHAR, ' + @COLUMN_NAME + ')' + ')),''NULL'')'   
END + '+' + ''',''' + ' + '   
--GENERATING THE COLUMN LIST FOR THE INSERT STATEMENT   
SET @COLUMN_LIST = @COLUMN_LIST + @COLUMN_NAME + ','   
SKIP_LOOP: --THE LABEL USED IN GOTO   
SELECT @COLUMN_ID = MIN(ORDINAL_POSITION)   
FROM INFORMATION_SCHEMA.COLUMNS (NOLOCK)   
WHERE TABLE_NAME = @TABLE_NAME AND   
ORDINAL_POSITION > @COLUMN_ID AND   
(@OWNER IS NULL OR TABLE_SCHEMA = @OWNER)   
--LOOP ENDS HERE!   
END   
--TO GET RID OF THE EXTRA CHARACTERS THAT GOT CONCATENATED DURING THE LAST RUN THROUGH THE LOOP   
SET @COLUMN_LIST = LEFT(@COLUMN_LIST,LEN(@COLUMN_LIST) - 1)   
SET @ACTUAL_VALUES = LEFT(@ACTUAL_VALUES,LEN(@ACTUAL_VALUES) - 6)   
IF LTRIM(@COLUMN_LIST) = ''   
BEGIN   
RAISERROR('NO COLUMNS TO SELECT. THERE SHOULD AT LEAST BE ONE COLUMN TO GENERATE THE OUTPUT',16,1)   
RETURN -1 --FAILURE. REASON: LOOKS LIKE ALL THE COLUMNS ARE OMMITTED USING THE @COLS_TO_EXCLUDE PARAMETER   
END   
--FORMING THE FINAL STRING THAT WILL BE EXECUTED, TO OUTPUT THE INSERT STATEMENTS   
IF (@INCLUDE_COLUMN_LIST <> 0)   
BEGIN   
SET @ACTUAL_VALUES =   
'SELECT ' +   
CASE WHEN @TOP IS NULL OR @TOP < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@TOP)) + ' ' END +   
'''' + RTRIM(@START_INSERT) +   
' ''+' + '''(' + RTRIM(@COLUMN_LIST) + '''+' + ''')''' +   
' +''VALUES(''+ ' + @ACTUAL_VALUES + '+'')''' + ' ' +   
COALESCE(@FROM,' FROM ' + CASE WHEN @OWNER IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@OWNER)) + '].' END + '[' + RTRIM(@TABLE_NAME) + ']' + '(NOLOCK)')   
END   
ELSE IF (@INCLUDE_COLUMN_LIST = 0)   
BEGIN   
SET @ACTUAL_VALUES =   
'SELECT ' +   
CASE WHEN @TOP IS NULL OR @TOP < 0 THEN '' ELSE ' TOP ' + LTRIM(STR(@TOP)) + ' ' END +   
'''' + RTRIM(@START_INSERT) +   
' '' +''VALUES(''+ ' + @ACTUAL_VALUES + '+'')''' + ' ' +   
COALESCE(@FROM,' FROM ' + CASE WHEN @OWNER IS NULL THEN '' ELSE '[' + LTRIM(RTRIM(@OWNER)) + '].' END + '[' + RTRIM(@TABLE_NAME) + ']' + '(NOLOCK)')   
END   
--DETERMINING WHETHER TO OUPUT ANY DEBUG INFORMATION   
IF @DEBUG_MODE =1   
BEGIN   
PRINT '/*****START OF DEBUG INFORMATION*****'   
PRINT 'BEGINNING OF THE INSERT STATEMENT:'   
PRINT @START_INSERT   
PRINT ''   
PRINT 'THE COLUMN LIST:'   
PRINT @COLUMN_LIST   
PRINT ''   
PRINT 'THE SELECT STATEMENT EXECUTED TO GENERATE THE INSERTS'   
PRINT @ACTUAL_VALUES   
PRINT ''   
PRINT '*****END OF DEBUG INFORMATION*****/'   
PRINT ''   
END   
PRINT '--INSERTS GENERATED BY ''SP_GENERATE_INSERTS'' STORED PROCEDURE WRITTEN BY VYAS'   
PRINT '--BUILD NUMBER: 22'   
PRINT '--PROBLEMS/SUGGESTIONS? CONTACT VYAS @ VYASKN@HOTMAIL.COM'   
PRINT '--HTTP://VYASKN.TRIPOD.COM'   
PRINT ''   
PRINT 'SET NOCOUNT ON'   
PRINT ''   
--DETERMINING WHETHER TO PRINT IDENTITY_INSERT OR NOT   
IF (@IDN <> '')   
BEGIN   
PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@OWNER,USER_NAME())) + '.' + QUOTENAME(@TABLE_NAME) + ' ON'   
PRINT 'GO'   
PRINT ''   
END   
IF @DISABLE_CONSTRAINTS = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@OWNER,USER_NAME())) + '.' + @TABLE_NAME, 'U') IS NOT NULL)   
BEGIN   
IF @OWNER IS NULL   
BEGIN   
SELECT 'ALTER TABLE ' + QUOTENAME(COALESCE(@TARGET_TABLE, @TABLE_NAME)) + ' NOCHECK CONSTRAINT ALL' AS '--CODE TO DISABLE CONSTRAINTS TEMPORARILY'   
END   
ELSE   
BEGIN   
SELECT 'ALTER TABLE ' + QUOTENAME(@OWNER) + '.' + QUOTENAME(COALESCE(@TARGET_TABLE, @TABLE_NAME)) + ' NOCHECK CONSTRAINT ALL' AS '--CODE TO DISABLE CONSTRAINTS TEMPORARILY'   
END   
PRINT 'GO'   
END   
PRINT ''   
PRINT 'PRINT ''INSERTING VALUES INTO ' + '[' + RTRIM(COALESCE(@TARGET_TABLE,@TABLE_NAME)) + ']' + ''''   
--ALL THE HARD WORK PAYS OFF HERE!!! YOU'LL GET YOUR INSERT STATEMENTS, WHEN THE NEXT LINE EXECUTES!   
EXEC (@ACTUAL_VALUES)   
PRINT 'PRINT ''DONE'''   
PRINT ''   
IF @DISABLE_CONSTRAINTS = 1 AND (OBJECT_ID(QUOTENAME(COALESCE(@OWNER,USER_NAME())) + '.' + @TABLE_NAME, 'U') IS NOT NULL)   
BEGIN   
IF @OWNER IS NULL   
BEGIN   
SELECT 'ALTER TABLE ' + QUOTENAME(COALESCE(@TARGET_TABLE, @TABLE_NAME)) + ' CHECK CONSTRAINT ALL' AS '--CODE TO ENABLE THE PREVIOUSLY DISABLED CONSTRAINTS'   
END   
ELSE   
BEGIN   
SELECT 'ALTER TABLE ' + QUOTENAME(@OWNER) + '.' + QUOTENAME(COALESCE(@TARGET_TABLE, @TABLE_NAME)) + ' CHECK CONSTRAINT ALL' AS '--CODE TO ENABLE THE PREVIOUSLY DISABLED CONSTRAINTS'   
END   
PRINT 'GO'   
END   
PRINT ''   
IF (@IDN <> '')   
BEGIN   
PRINT 'SET IDENTITY_INSERT ' + QUOTENAME(COALESCE(@OWNER,USER_NAME())) + '.' + QUOTENAME(@TABLE_NAME) + ' OFF'   
PRINT 'GO'   
END   
PRINT 'SET NOCOUNT OFF'   
SET NOCOUNT OFF   
RETURN 0 --SUCCESS. WE ARE DONE!   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_GETPOSITIONSPAN
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[SP_GETPOSITIONSPAN]
  (
	@SDATE VARCHAR(11),  
	@PARTYFROM VARCHAR(10),
	@PARTYTO VARCHAR(10),
	@MODE VARCHAR(10)

  )
AS  

DECLARE @INTMONTH INT,
	@INTYEAR INT

SELECT @INTMONTH=MONTH(CONVERT(DATETIME,@SDATE)),@INTYEAR=YEAR(CONVERT(DATETIME,@SDATE))

IF @PARTYTO ='' BEGIN SET @PARTYTO = 'ZZZZZZ' END

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF @MODE ='NORMAL'
BEGIN
	SELECT 
		PARTY_CODE,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE=LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),
		OPTION_TYPE,
		STRIKE_PRICE, 
		PQTY = SUM( CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END ),
		SQTY = SUM( CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END )
	FROM
		FOSETTLEMENT 
	WHERE 
		RESERVED1 <> 1
		AND EXPIRYDATE > @SDATE + ' 23:59'  
		AND SAUDA_DATE <= @SDATE + ' 23:59'  
		AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
	GROUP BY 
		PARTY_CODE,
		INST_TYPE,
		SYMBOL,
		LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),
		OPTION_TYPE,
		STRIKE_PRICE
	HAVING SUM( CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END ) - SUM( CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END ) <> 0  
	ORDER BY
		PARTY_CODE,
		INST_TYPE,
		SYMBOL,
		LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),
		OPTION_TYPE,
		STRIKE_PRICE
END
ELSE IF @MODE ='3DAYS1'
BEGIN
	SELECT 
		PARTY_CODE,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE=LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),
		OPTION_TYPE,
		STRIKE_PRICE, 
		PQTY = SUM( CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END ),
		SQTY = SUM( CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END )
	FROM
		FOSETTLEMENT 
	WHERE 
		RESERVED1 <> 1
		AND EXPIRYDATE > @SDATE + ' 23:59'  
		AND SAUDA_DATE <= @SDATE + ' 23:59'  
		AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
		AND MONTH(EXPIRYDATE) = @INTMONTH
		AND YEAR(EXPIRYDATE) = @INTYEAR
	GROUP BY 
		PARTY_CODE,
		INST_TYPE,
		SYMBOL,
		LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),
		OPTION_TYPE,
		STRIKE_PRICE
	HAVING SUM( CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END ) - SUM( CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END ) <> 0  
	ORDER BY
		PARTY_CODE,
		INST_TYPE,
		SYMBOL,
		LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),
		OPTION_TYPE,
		STRIKE_PRICE
END
ELSE IF @MODE ='3DAYS2'
BEGIN
	SELECT 
		PARTY_CODE,
		INST_TYPE,
		SYMBOL,
		EXPIRYDATE=LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),
		OPTION_TYPE,
		STRIKE_PRICE, 
		PQTY = SUM( CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END ),
		SQTY = SUM( CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END )
	FROM
		FOSETTLEMENT 
	WHERE 
		RESERVED1 <> 1
		AND EXPIRYDATE > @SDATE + ' 23:59'  
		AND SAUDA_DATE <= @SDATE + ' 23:59'  
		AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
		AND 
		(
			MONTH(EXPIRYDATE) > @INTMONTH
			OR
			YEAR(EXPIRYDATE) > @INTYEAR
		)
	GROUP BY 
		PARTY_CODE,
		INST_TYPE,
		SYMBOL,
		LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),
		OPTION_TYPE,
		STRIKE_PRICE
	HAVING SUM( CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END ) - SUM( CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END ) <> 0  
	ORDER BY
		PARTY_CODE,
		INST_TYPE,
		SYMBOL,
		LEFT(CONVERT(VARCHAR,EXPIRYDATE,106),11),
		OPTION_TYPE,
		STRIKE_PRICE
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_MENU_RIGHTS
-- --------------------------------------------------
CREATE PROC [dbo].[SP_MENU_RIGHTS] 
(
	@NOPT INT, 
	@VALIDDATE VARCHAR(20)='',
	@NALERT INT=0
) AS

CREATE TABLE #VERSION
(
	 ERRCODE1 VARCHAR(100),  
	 ERRCODE2 VARCHAR(20),  
	 ERRCODE3 VARCHAR(2),  
	 ERRCODE4 VARCHAR(10),  
	 ERRCODE5 VARCHAR(10),  
	 ERRCODE6 VARCHAR(100),  
	 ERRCODE7 VARCHAR(100),  
	 ERRCODE8 VARCHAR(100),  
	 ERRCODE9 VARCHAR(100),  
	 ERRCODE10 VARCHAR(10),  
	 ERRCODE11 VARCHAR(100), 
	 ERRCODE12 VARCHAR(100),
	 ERRCODE13 VARCHAR(100),  
	 ERRCODE14 VARCHAR(100)  
)

INSERT INTO #VERSION EXEC CHECKVERSION

IF @NOPT =1
BEGIN
	SELECT ERRCODE2,ERRCODE3 FROM #VERSION
END
ELSE
BEGIN

	SELECT CASE
		WHEN DATEDIFF(D,GETDATE(),@VALIDDATE)- @NALERT < 0
		THEN ERRCODE7 + ' ' + @VALIDDATE
		WHEN  CONVERT(VARCHAR,GETDATE(),112) >= CONVERT(VARCHAR,CONVERT(DATETIME,@VALIDDATE,112),112)
		THEN ERRCODE6
		ELSE ''	
	END AS USERMSG
	FROM #VERSION	
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_MTOMCHECK
-- --------------------------------------------------

CREATE  PROC [DBO].[SP_MTOMCHECK] (@SAUDA_DATE VARCHAR(11)) AS  
  
DECLARE  @BO_EXALLOCAMT NUMERIC(18,4)
DECLARE  @BO_PREMIUM NUMERIC(18,4)
DECLARE  @BO_MTM NUMERIC(18,4)
DECLARE  @EX_EXALLOCAMT NUMERIC(18,4)
DECLARE  @EX_PREMIUM NUMERIC(18,4)
DECLARE  @EX_MTM NUMERIC(18,4) 
DECLARE  @ERRFLAG INT
DECLARE  @CNTFLAG INT 

SET NOCOUNT  OFF 

SET @BO_EXALLOCAMT  = 0 
SET @BO_PREMIUM  = 0 
SET @BO_MTM  = 0 
SET @EX_EXALLOCAMT  = 0 
SET @EX_PREMIUM  = 0 
SET @EX_MTM  = 0 
SET @ERRFLAG = 0 
SET @CNTFLAG = 0 

SELECT @EX_EXALLOCAMT = ABS(ISNULL(SUM(ISNULL(FOEA_EXERCISED_ASSIGNED_VALUE,0)), 0)), 
       @EX_PREMIUM = ABS(ISNULL(SUM(ISNULL(FOEA_NETPREMIUM,0)),0)), 
       @EX_MTM = ABS(ISNULL(SUM(ISNULL(FOEA_DAILY_MTM_SETTLEMENT_VALUE,0) + ISNULL(FOEA_FUTURES_FINAL_SETTLEMENT_VALUE,0)),0)), 
       @CNTFLAG = ISNULL(COUNT(1),0) 
FROM   FOEXERCISEALLOCATION (NOLOCK) 
WHERE  FOEA_POSITION_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'

IF @CNTFLAG = 0 
  BEGIN 
    SELECT 'ERROR', 'POSITION FILE IS NOT IMPORTED. PLEASE CHECK.' 
    SET @ERRFLAG = 1 
  END 

IF @EX_MTM <> 0 AND @ERRFLAG = 0 
  BEGIN 
	SELECT 
		@BO_MTM = ABS(AMOUNT)
	FROM   
		FOACCBILL 
	WHERE  
		BILLDATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' 
		AND PARTY_CODE = (
				SELECT ACCODE 
				FROM   VALANACCOUNT 
				WHERE  ACNAME = 'CLEARING HOUSE') 
		AND BRANCHCD = 'ZZZ' 
	IF @BO_MTM <> @EX_MTM 
	BEGIN 
        	SELECT 'ERROR','TOTAL BO MTOM ' +  CONVERT(VARCHAR,@BO_MTM) + ' IS NOT MATCHING WITH THE EXCHANGE MTOM ' +  CONVERT(VARCHAR,@EX_MTM) + '. PLEASE CHECK.'
        	SET @ERRFLAG = 1 
      	END 
  END 

IF @EX_PREMIUM <> 0 AND @ERRFLAG = 0 
  BEGIN 
	   SELECT 
		@BO_PREMIUM = ABS(AMOUNT) 
	   FROM   
		FOACCBILL 
	   WHERE  
		BILLDATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
	        AND PARTY_CODE = (SELECT ACCODE 
	                            FROM   VALANACCOUNT 
	                            WHERE  ACNAME = 'CLEARING PREMIUM ACCOUNT') 
	        AND BRANCHCD = 'ZZZ' 

      IF @BO_PREMIUM <> @EX_PREMIUM
      BEGIN 
	SELECT 'ERROR','TOTAL BO PREMIUM ' +  CONVERT(VARCHAR,@BO_PREMIUM) + ' IS NOT MATCHING WITH THE EXCHANGE PREMIUM ' +  CONVERT(VARCHAR,@EX_PREMIUM) + '. PLEASE CHECK.'
        SET @ERRFLAG = 1 
      END 
  END 

IF @EX_EXALLOCAMT <> 0 AND @ERRFLAG = 0 
  BEGIN 
	   SELECT 
		@BO_EXALLOCAMT = ABS(AMOUNT)
	   FROM   
		FOACCBILL 
	   WHERE  
		BILLDATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59'
	        AND PARTY_CODE = (SELECT ACCODE 
	                            FROM   VALANACCOUNT 
	                            WHERE  ACNAME = 'OPTION EXERCISE') 
	        AND BRANCHCD = 'ZZZ' 

     IF @BO_EXALLOCAMT <> @EX_EXALLOCAMT
      BEGIN 
	SELECT 'ERROR','TOTAL BO EXCECISE ALLOCATION  ' +  CONVERT(VARCHAR,@BO_EXALLOCAMT) + ' IS NOT MATCHING WITH THE EXCHANGE EXCECISE ALLOCATION ' +  CONVERT(VARCHAR,@EX_EXALLOCAMT) + '. PLEASE CHECK.'
        SET @ERRFLAG = 1 
      END 
  END 


IF @EX_MTM <> 0 AND @ERRFLAG = 0
BEGIN 
	IF (
		SELECT COUNT(1) FROM
		(
			SELECT 
				PARTY_CODE,
				BO_MTOM = SUM(SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT) 
			FROM
				FOBILLVALAN (NOLOCK) 
			WHERE 
				SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'
				AND LEFT(INST_TYPE,3) = 'FUT'
				AND PARTICIPANTCODE = (SELECT MEMBERCODE FROM FOOWNER)
			GROUP BY 
				PARTY_CODE
			HAVING 
				SUM(SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT) <> 0
		) BO_BILL
		
		FULL OUTER JOIN
		
		(
			SELECT 
				FOEA_PARTY_CODE,
				EX_MTOM = SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE+FOEA_FUTURES_FINAL_SETTLEMENT_VALUE)
			FROM  
				FOEXERCISEALLOCATION (NOLOCK)
			WHERE 
				FOEA_POSITION_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'
			GROUP BY 
				FOEA_PARTY_CODE
			HAVING 
				SUM(FOEA_DAILY_MTM_SETTLEMENT_VALUE+FOEA_FUTURES_FINAL_SETTLEMENT_VALUE) <> 0
		) EX_BILL
		
		ON (PARTY_CODE=FOEA_PARTY_CODE AND BO_MTOM = EX_MTOM)
		WHERE PARTY_CODE IS NULL OR FOEA_PARTY_CODE IS NULL
	) > 0
	
	BEGIN
		SELECT 'ERROR','TOTAL BO MTOM IS MATCHING WITH THE EXCHANGE TOTAL MTOM. PARTY LEVEL MTOM IS NOT MATCHING.'
		SET @ERRFLAG = 1 
	END
END 


IF @EX_PREMIUM <> 0 AND @ERRFLAG = 0
BEGIN 
	IF (
		SELECT COUNT(1) FROM
		(
			SELECT 
				PARTY_CODE,
				BO_MTOM = SUM(SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT) 
			FROM
				FOBILLVALAN (NOLOCK) 
			WHERE 
				SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'
				AND LEFT(INST_TYPE,3) = 'OPT'  AND AUCTIONPART =''
				AND PARTICIPANTCODE = (SELECT MEMBERCODE FROM FOOWNER)
			GROUP BY 
				PARTY_CODE
			HAVING 
				SUM(SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT) <> 0
		) BO_BILL
		
		FULL OUTER JOIN
		
		(
			SELECT 
				FOEA_PARTY_CODE,
				EX_MTOM = SUM(FOEA_NETPREMIUM)
			FROM  
				FOEXERCISEALLOCATION (NOLOCK)
			WHERE 
				FOEA_POSITION_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'
			GROUP BY 
				FOEA_PARTY_CODE
			HAVING 
				SUM(FOEA_NETPREMIUM) <> 0
		) EX_BILL
		
		ON (PARTY_CODE=FOEA_PARTY_CODE AND BO_MTOM = EX_MTOM)
		WHERE PARTY_CODE IS NULL OR FOEA_PARTY_CODE IS NULL
	) > 0
	
	BEGIN
		SELECT 'ERROR','TOTAL BO PREMIUM IS MATCHING WITH THE EXCHANGE TOTAL PREMIUM. PARTY LEVEL PREMIUM IS NOT MATCHING.'
		SET @ERRFLAG = 1 
	END
END 


IF @EX_EXALLOCAMT <> 0 AND @ERRFLAG = 0
BEGIN 
	IF (
		SELECT COUNT(1) FROM
		(
			SELECT 
				PARTY_CODE,
				BO_MTOM = SUM(SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT) 
			FROM
				FOBILLVALAN (NOLOCK) 
			WHERE 
				SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'
				AND LEFT(INST_TYPE,3) = 'OPT' AND AUCTIONPART ='EA'
				AND PARTICIPANTCODE = (SELECT MEMBERCODE FROM FOOWNER)
			GROUP BY 
				PARTY_CODE
			HAVING 
				SUM(SBILLAMT + SBROKAMT - PBILLAMT + PBROKAMT) <> 0
		) BO_BILL
		
		FULL OUTER JOIN
		
		(
			SELECT 
				FOEA_PARTY_CODE,
				EX_MTOM = SUM(FOEA_EXERCISED_ASSIGNED_VALUE)
			FROM  
				FOEXERCISEALLOCATION (NOLOCK)
			WHERE 
				FOEA_POSITION_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'
			GROUP BY 
				FOEA_PARTY_CODE
			HAVING 
				SUM(FOEA_EXERCISED_ASSIGNED_VALUE) <> 0
		) EX_BILL
		
		ON (PARTY_CODE=FOEA_PARTY_CODE AND BO_MTOM = EX_MTOM)
		WHERE PARTY_CODE IS NULL OR FOEA_PARTY_CODE IS NULL
	) > 0
	
	BEGIN
		SELECT 'ERROR','TOTAL BO EXCECISE ALLOCATION  IS MATCHING WITH THE EXCHANGE TOTAL EXCECISE ALLOCATION . PARTY LEVEL EXCECISE ALLOCATION IS NOT MATCHING.'
		SET @ERRFLAG = 1 
	END
END 


IF @ERRFLAG = 0 
  BEGIN 
    SELECT 'SUCCESS', '' 
  END 
  
SET NOCOUNT ON

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_STT_ANNEXURE_CUM
-- --------------------------------------------------

CREATE PROC [dbo].[SP_STT_ANNEXURE_CUM]  
 (  
 @DATEFROM VARCHAR(11),  
 @DATETO VARCHAR(11),  
 @PARTYFROM VARCHAR(10),  
 @PARTYTO VARCHAR(10),  
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),  
 @STRBRANCH VARCHAR(12),  
 @STRBRANCHTO VARCHAR(12),  
 @STRSUBBROKFROM VARCHAR(12),  
 @STRSUBBROKTO VARCHAR(12),  
 @DIGIFLAG INT = 0   
 )  
    
 AS  
                 
 IF LEN(LTRIM(RTRIM(@PARTYTO))) = 0  
 BEGIN  
  SET @PARTYTO = 'ZZZZZZZZZ'  
 END  
   
 IF LEN(LTRIM(RTRIM(@STRBRANCHTO))) = ''  
 BEGIN  
  SET @STRBRANCHTO = 'ZZZZZZZZZZZZZZ'  
 END  
   
 IF LEN(LTRIM(RTRIM(@STRSUBBROKTO))) = ''  
 BEGIN  
  SET @STRSUBBROKTO = 'ZZZZZZZZZZZ'  
 END  
   
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED             
          
SELECT PARTY_CODE,  TRANSACTIONCODE = '04', TURNOVER = SUM(TURNOVER), STT = SUM(STT)            
INTO #STT04 FROM         
(      
 SELECT SAUDA_DATE =LEFT(SAUDA_DATE,11), PARTY_CODE, TURNOVER = SUM(SAMTTRD), STT = ROUND(SUM(SSTTTRD),0)      
 FROM STT_CLIENTDETAIL   (NOLOCK)      
 WHERE PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO AND  SAUDA_DATE BETWEEN @DATEFROM AND  @DATETO +' 23:59'         
 AND  LEFT(INST_TYPE,3) = 'OPT'      
 GROUP BY LEFT(SAUDA_DATE,11),PARTY_CODE      
) STTDETAIL      
GROUP BY PARTY_CODE ORDER BY PARTY_CODE              
      
SELECT PARTY_CODE,  TRANSACTIONCODE = '05', TURNOVER = SUM(TURNOVER), STT = SUM(STT)            
INTO #STT05 FROM         
(      
 SELECT SAUDA_DATE =LEFT(SAUDA_DATE,11),PARTY_CODE,    
 TURNOVER = SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN SAMTTRD ELSE 0 END),   
 STT = ROUND(ROUND(SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN SSTTTRD ELSE 0 END),0)  
   - (ROUND(SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN SSTTTRD ELSE 0 END),0)  
   +  ROUND(SUM(CASE WHEN LEFT(INST_TYPE,3) = 'OPT' THEN SSTTTRD ELSE 0 END),0)  
   - ROUND(SUM(SSTTTRD),2)),0)  
 FROM STT_CLIENTDETAIL  (NOLOCK)      
 WHERE PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO AND  SAUDA_DATE BETWEEN @DATEFROM AND  @DATETO +' 23:59'         
 GROUP BY LEFT(SAUDA_DATE,11),PARTY_CODE      
 HAVING ROUND(SUM(CASE WHEN LEFT(INST_TYPE,3) = 'FUT' THEN SSTTTRD ELSE 0 END),0) > 0  
) STTDETAIL      
GROUP BY PARTY_CODE   
ORDER BY PARTY_CODE  
  
  
SELECT             
 COMPANY, ADDR1, ADDR2, CITY, ZIP, PHONE, 'NATIONAL STOCK EXCHANGE OF INDIA LIMITED' EXCHANGECODE,             
 MEMBERCODE,C2.PARTY_CODE, LONG_NAME,            
 L_ADDRESS1,            
 L_ADDRESS2,           
 L_ADDRESS3,           
 L_CITY ,     
 L_ZIP,         
 PAN_GIR_NO,' ' MAPIDID            
INTO   
 #CLIENT            
FROM             
 CLIENT1 C1 (NOLOCK),  
 CLIENT2 C2 (NOLOCK),  
 FOOWNER (NOLOCK),  
 CLIENT_PRINT_SETTINGS CP (NOLOCK)            
WHERE             
 C1.CL_CODE =C2.CL_CODE AND             
 PARTY_CODE >= @PARTYFROM AND PARTY_CODE <= @PARTYTO  AND                 
 BRANCH_CD >= @STRBRANCH AND  BRANCH_CD <= @STRBRANCHTO  AND                 
 SUB_BROKER >= @STRSUBBROKFROM  AND SUB_BROKER <= @STRSUBBROKTO AND                       
 C2.PRINTF = CP.PRINT_FLAG AND  
 CP.VALID_REPORT LIKE (CASE   
    WHEN @DIGIFLAG = 0 THEN '%'   
    WHEN @DIGIFLAG = 1 THEN '%CONTRACT%'   
    WHEN @DIGIFLAG = 2 THEN '%DIGITAL%'   
    ELSE CP.VALID_REPORT   
    END) AND  
 BRANCH_CD LIKE (CASE WHEN @STATUSID = 'BRANCH' THEN @STATUSNAME ELSE '%' END) AND                 
 SUB_BROKER LIKE (CASE WHEN @STATUSID = 'SUBBROKER' THEN @STATUSNAME ELSE '%' END) AND                 
 TRADER LIKE (CASE WHEN @STATUSID = 'TRADER' THEN @STATUSNAME ELSE '%' END) AND                 
 C1.FAMILY LIKE (CASE WHEN @STATUSID = 'FAMILY' THEN @STATUSNAME ELSE '%' END)  AND                 
 C1.CL_CODE LIKE (CASE WHEN @STATUSID = 'CLIENT' THEN @STATUSNAME ELSE '%' END)                
          
CREATE INDEX [PARTYCD] ON [DBO].[#CLIENT] ([PARTY_CODE])      
      
SELECT PARTY_CODE,'01' TRANSACTIONCODE ,0 TURNOVER,0 STT INTO #STT01  FROM #CLIENT              
SELECT PARTY_CODE,'02' TRANSACTIONCODE ,0 TURNOVER,0 STT INTO #STT02  FROM #CLIENT              
SELECT PARTY_CODE,'03' TRANSACTIONCODE ,0 TURNOVER,0 STT INTO #STT03  FROM #CLIENT   
      
CREATE INDEX [PARTYCD] ON [DBO].[#STT04] ([PARTY_CODE])      
      
CREATE INDEX [PARTYCD] ON [DBO].[#STT05] ([PARTY_CODE])      
     
INSERT INTO #STT04 SELECT PARTY_CODE,'04',0,0 FROM #CLIENT WHERE PARTY_CODE               
NOT IN (SELECT PARTY_CODE FROM #STT04)              
              
INSERT INTO #STT05 SELECT PARTY_CODE,'05',0,0 FROM #CLIENT WHERE PARTY_CODE               
NOT IN (SELECT PARTY_CODE FROM #STT05)              
          
SELECT S.PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT                 
INTO #STT00              
       
FROM              
              
(               
  SELECT PARTY_CODE,TRANSACTIONCODE, TURNOVER, STT  FROM #STT01                  
  UNION              
  SELECT PARTY_CODE,TRANSACTIONCODE,TURNOVER, STT   FROM #STT02              
  UNION               
  SELECT PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT  FROM #STT03              
  UNION               
  SELECT PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT  FROM #STT04              
  UNION               
  SELECT PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT  FROM #STT05              
              
) S              
              
ORDER BY S.PARTY_CODE,TRANSACTIONCODE              
          
DROP TABLE #STT01      
DROP TABLE #STT02      
DROP TABLE #STT03      
DROP TABLE #STT04      
DROP TABLE #STT05      
      
CREATE INDEX [PARTYCD] ON [DBO].[#STT00] ([PARTY_CODE])      
      
SELECT COMPANY, ADDR1, ADDR2, CITY, ZIP, PHONE, EXCHANGECODE,             
 MEMBERCODE,LONG_NAME, L_ADDRESS1,L_ADDRESS2,L_ADDRESS3, L_CITY,L_ZIP,PAN_GIR_NO, ISNULL(U.MAPIDID, '') MAPINID,             
 S.PARTY_CODE,TRANSACTIONCODE, TURNOVER,  STT, CONVERT(VARCHAR, GETDATE(), 103) CURDATE              
FROM  #CLIENT C  , #STT00 S LEFT OUTER JOIN UCC_CLIENT U ON (U.PARTY_CODE = S.PARTY_CODE)            
WHERE S.PARTY_CODE = C.PARTY_CODE              
AND S.PARTY_CODE IN ( SELECT PARTY_CODE FROM #STT00 GROUP BY PARTY_CODE HAVING SUM(STT) > 0)          
      
DROP TABLE #STT00

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SP_USERSTATUS
-- --------------------------------------------------
CREATE PROC [dbo].[SP_USERSTATUS]
 @USERID_FR VARCHAR(25),
 @USERID_TO VARCHAR(25),
 @STATUS CHAR(1)

AS

DECLARE @@SQL AS VARCHAR(1000)  
/*
EXEC SP_USERSTATUS '00','ZZZ', '3' 
SELECT TOP 100 * FROM TBLPRADNYAUSERS
SELECT * FROM TBLUSERS
*/

SET @@SQL = " SELECT" 
SET @@SQL = @@SQL + " FLDUSERNAME, "
SET @@SQL = @@SQL + " 	FLDFIRSTNAME, "
SET @@SQL = @@SQL + " 	FLDSTNAME, "
IF @STATUS = '2'
BEGIN
SET @@SQL = @@SQL + " 	BLOCK = ISNULL(REMARK,'') + ' '+CASE WHEN ISNULL(BLOCK,'N') = 'Y' THEN 'USER BLOCK' ELSE 'ACTIVE-UNAUTHORIZED' END , "
END
ELSE
BEGIN
SET @@SQL = @@SQL + " 	ISNULL(REMARK,'') + ' ACTIVE-AUTHORIZED', "
END

SET @@SQL = @@SQL + " 	FLDSTATUS = CASE WHEN FLDSTATUS = 2 OR FLDSTATUS = 1 THEN 'PENDING' WHEN FLDSTATUS = 0 THEN 'APPROVED' END "
SET @@SQL = @@SQL + " FROM "
SET @@SQL = @@SQL + " 	TBLPRADNYAUSERS T "
--IF @STATUS = '2'
--BEGIN
SET @@SQL = @@SQL + " 	LEFT OUTER JOIN (SELECT PRADNYAAUTO,REMARK, BLOCK FROM TBLUSERS ) TBS "
SET @@SQL = @@SQL + " 	ON TBS.PRADNYAAUTO = T.FLDAUTO , "
--END
--ELSE
--BEGIN
--SET @@SQL = @@SQL + ","
--END
SET @@SQL = @@SQL + " 	TBLUSERCONTROLMASTER TU "
SET @@SQL = @@SQL + " WHERE "
SET @@SQL = @@SQL + "   FLDUSERNAME	BETWEEN '"+@USERID_FR+"' AND '"+@USERID_TO+"' "
IF @STATUS <> '%' 
BEGIN
SET @@SQL = @@SQL + " 	AND FLDSTATUS = '"+@STATUS+"' "
END 
SET @@SQL = @@SQL + " 	AND TU.FLDUSERID = T.FLDAUTO "
SET @@SQL = @@SQL + " ORDER BY "
SET @@SQL = @@SQL + " 	T.FLDUSERNAME "

IF @STATUS = '3'
BEGIN 
SET @@SQL = " SELECT" 
SET @@SQL = @@SQL + " FLDUSERNAME, "
SET @@SQL = @@SQL + " 	FLDFIRSTNAME, "
SET @@SQL = @@SQL + " 	FLDSTNAME, "
SET @@SQL = @@SQL + " 	REMARK, "
SET @@SQL = @@SQL + " 	FLDSTATUS = CASE WHEN FLDSTATUS = 2 OR FLDSTATUS = 1 THEN 'PENDING' WHEN FLDSTATUS = 0 THEN 'APPROVED' WHEN FLDSTATUS = 3 THEN 'REJECTED' END "
SET @@SQL = @@SQL + " FROM "
SET @@SQL = @@SQL + " 	TBLPRADNYAUSERS T ,TBLUSERS TBS, TBLUSERCONTROLMASTER TU "
SET @@SQL = @@SQL + " WHERE "
SET @@SQL = @@SQL + " 	TBS.PRADNYAAUTO = T.FLDAUTO  "
SET @@SQL = @@SQL + " 	AND TU.FLDUSERID = T.FLDAUTO  "
SET @@SQL = @@SQL + "   AND FLDUSERNAME	BETWEEN '"+@USERID_FR+"' AND '"+@USERID_TO+"' "
SET @@SQL = @@SQL + " 	AND FLDSTATUS = '"+@STATUS+"' "
END 

PRINT(@@SQL)
EXEC(@@SQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STAMPDUTY_ROUNDING_FURTHER
-- --------------------------------------------------
CREATE PROC [dbo].[STAMPDUTY_ROUNDING_FURTHER] @SAUDA_DATE VARCHAR(11)    
AS    
    
DECLARE 
@BROKERNOTECUR 	 CURSOR,    
@SETTCUR 				 CURSOR,    
@DIFF 					 NUMERIC(36, 12),    
@PARTY_CODE      VARCHAR(10),       
@ORDER_NO 			 VARCHAR(20),    
@TRADE_NO 			 VARCHAR(14),    
@INST_TYPE       VARCHAR(6) ,    
@SYMBOL          VARCHAR(12),    
@EXPIRYDATE      DATETIME,    
@STRIKE_PRICE    MONEY      ,    
@OPTION_TYPE     VARCHAR(2),     
@BROKER_CHRG		 NUMERIC(36, 12)

    
SET @BROKERNOTECUR = CURSOR FOR    

SELECT PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE, DIFF = SUM(BROKER_CHRG) - ROUND(SUM(BROKER_CHRG),0) 
FROM FOSETTLEMENT
WHERE SAUDA_DATE LIKE @SAUDA_DATE +'%' AND AUCTIONPART <> 'CA'
GROUP BY PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE
HAVING SUM(BROKER_CHRG) <> ROUND(SUM(BROKER_CHRG),0) 
ORDER  BY PARTY_CODE,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE

OPEN @BROKERNOTECUR    
FETCH NEXT FROM @BROKERNOTECUR INTO @PARTY_CODE,@INST_TYPE,@SYMBOL,@EXPIRYDATE,@OPTION_TYPE,@STRIKE_PRICE,@DIFF    
WHILE @@FETCH_STATUS = 0 
BEGIN    
 SET @SETTCUR = CURSOR FOR    
 SELECT ORDER_NO, TRADE_NO, BROKER_CHRG FROM FOSETTLEMENT      
 WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'    
 AND PARTY_CODE = @PARTY_CODE 
 AND INST_TYPE = @INST_TYPE
 AND SYMBOL = @SYMBOL
 AND EXPIRYDATE = @EXPIRYDATE
 AND OPTION_TYPE = @OPTION_TYPE
 AND STRIKE_PRICE = @STRIKE_PRICE
 AND BROKER_CHRG > 0     
 AND AUCTIONPART <> 'CA'
 ORDER BY BROKER_CHRG DESC    
 OPEN @SETTCUR    
 FETCH NEXT FROM @SETTCUR INTO @ORDER_NO, @TRADE_NO, @BROKER_CHRG
 WHILE @@FETCH_STATUS = 0 AND @DIFF <> 0 
 BEGIN    
  IF @DIFF < 0     
  BEGIN    
   UPDATE FOSETTLEMENT SET BROKER_CHRG = BROKER_CHRG + ABS(@DIFF)    
   FROM FOSETTLEMENT 
   WHERE 
		SAUDA_DATE LIKE @SAUDA_DATE + '%'    
		AND PARTY_CODE = @PARTY_CODE 
		AND INST_TYPE = @INST_TYPE
		AND SYMBOL = @SYMBOL
		AND EXPIRYDATE = @EXPIRYDATE
		AND OPTION_TYPE = @OPTION_TYPE
		AND STRIKE_PRICE = @STRIKE_PRICE
		AND ORDER_NO = @ORDER_NO     
		AND TRADE_NO = @TRADE_NO  
                AND AUCTIONPART <> 'CA'  
   SELECT @DIFF = 0     
  END    
 ELSE    
   BEGIN    
   IF @DIFF >= @BROKER_CHRG     
   BEGIN    
   UPDATE FOSETTLEMENT SET BROKER_CHRG = 0
   FROM FOSETTLEMENT 
   WHERE 
		SAUDA_DATE LIKE @SAUDA_DATE + '%'    
		AND PARTY_CODE = @PARTY_CODE 
		AND INST_TYPE = @INST_TYPE
		AND SYMBOL = @SYMBOL
		AND EXPIRYDATE = @EXPIRYDATE
		AND OPTION_TYPE = @OPTION_TYPE
		AND STRIKE_PRICE = @STRIKE_PRICE
		AND ORDER_NO = @ORDER_NO     
		AND TRADE_NO = @TRADE_NO    
                AND AUCTIONPART <> 'CA'
    SELECT @DIFF = @DIFF - @BROKER_CHRG     
   END     
    ELSE    
   BEGIN    
   UPDATE FOSETTLEMENT SET BROKER_CHRG = @BROKER_CHRG - @DIFF    
   FROM FOSETTLEMENT 
   WHERE 
		SAUDA_DATE LIKE @SAUDA_DATE + '%'    
		AND PARTY_CODE = @PARTY_CODE 
		AND INST_TYPE = @INST_TYPE
		AND SYMBOL = @SYMBOL
		AND EXPIRYDATE = @EXPIRYDATE
		AND OPTION_TYPE = @OPTION_TYPE
		AND STRIKE_PRICE = @STRIKE_PRICE
		AND ORDER_NO = @ORDER_NO     
		AND TRADE_NO = @TRADE_NO  
                AND AUCTIONPART <> 'CA'  
    SELECT @DIFF = 0    
   END        
   END     
   FETCH NEXT FROM @SETTCUR INTO @ORDER_NO, @TRADE_NO, @BROKER_CHRG
 END    
 CLOSE @SETTCUR    
 DEALLOCATE @SETTCUR    
 FETCH NEXT FROM @BROKERNOTECUR INTO @PARTY_CODE,@INST_TYPE,@SYMBOL,@EXPIRYDATE,@OPTION_TYPE,@STRIKE_PRICE,@DIFF 
END    
CLOSE @BROKERNOTECUR    
DEALLOCATE @BROKERNOTECUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_CHARGES_FINAL
-- --------------------------------------------------


CREATE PROC [dbo].[STT_CHARGES_FINAL]  

(  
           @SAUDA_DATE VARCHAR(11),  
           @PARTYFROM  VARCHAR(10)  = '',  
           @PARTYTO    VARCHAR(11)  = 'ZZZZZZZZ',  
           @USERNAME   VARCHAR(50)  = ''  
)  
AS  
  
  DECLARE  @TRDSELLTRANS    NUMERIC(18,4),  
           @OPTTRDSELLTRANS NUMERIC(18,4),  
           @OPTDELSELLTRANS NUMERIC(18,4),  
           @STT_ON          VARCHAR(7)  
                              
  SET @TRDSELLTRANS = 0  
                        
  SET @OPTTRDSELLTRANS = 0  
                           
  SET @OPTDELSELLTRANS = 0  
                           
  SELECT @TRDSELLTRANS = TRDSELLTRANS,  
         @OPTTRDSELLTRANS = OPTTRDSELLTRANS,  
         @OPTDELSELLTRANS = OPTDELSELLTRANS,  
         @STT_ON = STT_ON  
  FROM   FOGLOBALS  
  WHERE  YEAR_START_DT <= @SAUDA_DATE  
         AND YEAR_END_DT >= @SAUDA_DATE  
                              
  IF (@TRDSELLTRANS > 0  
       OR @OPTTRDSELLTRANS > 0  
       OR @OPTDELSELLTRANS > 0)  
    BEGIN  
      BEGIN TRAN  
        
      UPDATE FOSETTLEMENT  
      SET    INS_CHRG = 0  
      WHERE  SAUDA_DATE >= @SAUDA_DATE  
             AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
             AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
                                                     
      UPDATE FOSETTLEMENT  
      SET    INS_CHRG = ROUND((TRADEQTY * ABS(CASE   
                             WHEN LEFT(INST_TYPE,3) = 'FUT' THEN (CASE WHEN AUCTIONPART = 'EA' THEN 0 ELSE PRICE END)
                             ELSE CASE   
                                  WHEN @STT_ON = 'PRICE' THEN PRICE + CASE WHEN AUCTIONPART= 'EA'   
       THEN   
        CASE WHEN LEFT(OPTION_TYPE,1) ='P'   
        THEN -STRIKE_PRICE ELSE STRIKE_PRICE END ELSE 0 END  
                                    WHEN @STT_ON = 'SPRICE' THEN STRIKE_PRICE  
                                    WHEN @STT_ON = 'SSPRICE' THEN PRICE + STRIKE_PRICE  
                                  END  
                           END) * (CASE   
                                     WHEN LEFT(INST_TYPE,3) = 'FUT' THEN @TRDSELLTRANS  
                                     ELSE CASE   
                                            WHEN AUCTIONPART = '' THEN @OPTTRDSELLTRANS  
                                            ELSE @OPTDELSELLTRANS  
                                          END  
                                   END) / 100),4)  
      WHERE  SAUDA_DATE >= @SAUDA_DATE  
             AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
             AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
             AND SELL_BUY = 2  
             AND AUCTIONPART <> 'CA'  
             AND TRADEQTY > 0  
                              

      UPDATE FOSETTLEMENT  
      SET    INS_CHRG = 0  
      WHERE  SAUDA_DATE >= @SAUDA_DATE  
             AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
             AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
			 AND LEFT(INST_TYPE,3) = 'FUT'
			 AND AUCTIONPART = 'EA'  
			 
			                               
      EXEC STT_INSERTDATA_DETAIL @SAUDA_DATE , '' , 'ZZZZZZZZ' , @STT_ON  
          
      SELECT   CONTRACTNO,  
               PARTY_CODE,  
               ACTCHRG = SUM(ACTINS_CHRG),  
               TOBECHRG = ROUND(SUM(INS_CHRG),0)  
      INTO     #SETTROUND  
      FROM     (SELECT   CONTRACTNO,  
                         PARTY_CODE,  
                         SYMBOL,  
                         INST_TYPE,  
                         EXPIRYDATE,  
                         STRIKE_PRICE,  
                         OPTION_TYPE,  
                         INS_CHRG = (SUM(INS_CHRG)),  
                         ACTINS_CHRG = SUM(INS_CHRG)  
                FROM     FOSETTLEMENT  
                WHERE    SAUDA_DATE >= @SAUDA_DATE  
                         AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
                         AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
                         AND TRADEQTY > 0  
                         AND AUCTIONPART <> 'CA'  
                GROUP BY CONTRACTNO,PARTY_CODE,SYMBOL,INST_TYPE,  
                         EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE) A  
      GROUP BY CONTRACTNO,PARTY_CODE  
                 
                 
      SELECT  S.CONTRACTNO,  
               S.PARTY_CODE,  
               SRNO = MIN(SRNO)  
      INTO     #SETTSTTPARTY  
      FROM     FOSETTLEMENT S,  
               #SETTROUND A  
	  WHERE    SAUDA_DATE >= @SAUDA_DATE  
               AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
               AND S.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
               AND TRADEQTY > 0  
               AND AUCTIONPART <> 'CA'  
               AND A.PARTY_CODE = S.PARTY_CODE  
               AND INS_CHRG >= (CASE   
                                  WHEN TOBECHRG - ACTCHRG < 0 THEN ABS(TOBECHRG - ACTCHRG)  
                                  ELSE 0  
                                END)  
               AND INS_CHRG > 0  
               AND S.CONTRACTNO = A.CONTRACTNO  
      GROUP BY S.CONTRACTNO,S.PARTY_CODE 
      
      

	UPDATE FOSETTLEMENT                          
      SET    INS_CHRG = INS_CHRG+ (TOBECHRG - ACTCHRG)                          
      FROM   #SETTSTTPARTY A,                          
             #SETTROUND S                          
      WHERE  SAUDA_DATE >= @SAUDA_DATE                          
             AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'                          
             AND A.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO                          
             AND TRADEQTY > 0                
             AND FOSETTLEMENT.PARTY_CODE = A.PARTY_CODE                
             AND FOSETTLEMENT.PARTY_CODE = S.PARTY_CODE    
             AND FOSETTLEMENT.CONTRACTNO = S.CONTRACTNO
             AND FOSETTLEMENT.CONTRACTNO = A.CONTRACTNO                
             AND AUCTIONPART <> 'CA'                
             AND FOSETTLEMENT.SRNO = A.SRNO                   
             AND FOSETTLEMENT.INS_CHRG > 0  
 
                          
      TRUNCATE TABLE #SETTROUND  
        
      TRUNCATE TABLE #SETTSTTPARTY  
        
      DROP TABLE #SETTROUND  
        
      DROP TABLE #SETTSTTPARTY  
        
      EXEC STT_ROUNDING_FURTHER @SAUDA_DATE , @PARTYFROM , @PARTYTO  
        
      EXEC STT_INSERTDATA_SUMMARY @SAUDA_DATE , '' , 'ZZZZZZZZ'  
          
      UPDATE FOSETTLEMENT  
      SET    INS_CHRG = 0  
      FROM   CLIENT2 C  
      WHERE  FOSETTLEMENT.PARTY_CODE = C.PARTY_CODE  
             AND INSURANCE_CHRG = 0  
             AND SAUDA_DATE >= @SAUDA_DATE  
             AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
                                               
      UPDATE FOSETTLEMENT  
      SET    INS_CHRG = 0  
      FROM   FOCLIENTTAXES C  
      WHERE  FOSETTLEMENT.PARTY_CODE = C.PARTY_CODE  
             AND SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO  
             AND C.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
             AND FUT_INSURANCE_CHRG = 0  
             AND SAUDA_DATE >= @SAUDA_DATE  
             AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
                                               


        
      COMMIT  
   END  

      EXEC CALCULATE_STAMP_DUTY  
        @SAUDA_DATE ,  
        '0' ,  
        'ZZZZZZZ'  
	IF     (SELECT  SUM(INSURANCE_CHRG_AC + TURNOVER_AC + SEBI_TURN_AC + BROKER_NOTE_AC + OTHER_CHRG_AC)
		    FROM   FOGLOBALS (NOLOCK)
		    WHERE  @SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT) > 0
	BEGIN
      /*----------------------------------------------------------------------------*/
	UPDATE FOSETTLEMENT SET 
	SERVICE_TAX = ((TRADEQTY*BROKAPPLIED)+
		      (CASE WHEN G.INSURANCE_CHRG_AC = 1 AND C2.INSURANCE_CHRG = 1 
			    THEN FOSETTLEMENT.INS_CHRG
		            ELSE 0 
		       END)+
		      (CASE WHEN G.TURNOVER_AC = 1 AND C2.TURNOVER_TAX = 1 
			    THEN FOSETTLEMENT.TURN_TAX
		            ELSE 0 
		       END)+
		      (CASE WHEN G.SEBI_TURN_AC = 1 AND C2.SEBI_TURN_TAX = 1 
			    THEN FOSETTLEMENT.SEBI_TAX
		            ELSE 0 
		       END)+
		      (CASE WHEN G.BROKER_NOTE_AC = 1 AND C2.BROKERNOTE = 1 
			    THEN FOSETTLEMENT.BROKER_CHRG
		            ELSE 0 
		       END)+
		      (CASE WHEN G.OTHER_CHRG_AC = 1 AND C2.OTHER_CHRG = 1
			    THEN FOSETTLEMENT.OTHER_CHRG
		            ELSE 0 
		       END)) * G.SERVICE_TAX /100
	FROM FOGLOBALS G, CLIENT2 C2, CLIENT1 C1
	WHERE 
		C1.CL_CODE = C2.CL_CODE AND
		SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' AND
 		C2.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO AND
		SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT AND
		FOSETTLEMENT.PARTY_CODE = C2.PARTY_CODE AND
		SERVICE_CHRG + SERVICE_CHRG + SERTAXMETHOD <> 3 AND
		C1.CL_TYPE = 'INS'
	END 
		 
   /*----------------------------------------------------------------------------*/

	UPDATE FOSETTLEMENT SET SERVICE_TAX = 0, NSERTAX = 0
	FROM  CLIENT1 C1 (NOLOCK), CLIENT2 C2 (NOLOCK)
	WHERE C1.CL_CODE = C2.CL_CODE
	AND C2.PARTY_CODE = FOSETTLEMENT.PARTY_CODE
	AND FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE  AND  @SAUDA_DATE + ' 23:59'
	AND L_STATE =  'JAMMU AND KASHMIR'
	AND SERVICE_CHRG = 0
	
 IF  (SELECT  SUM(INSURANCE_CHRG_AC + TURNOVER_AC + SEBI_TURN_AC + BROKER_NOTE_AC + OTHER_CHRG_AC)        
      FROM   FOGLOBALS (NOLOCK)        
      WHERE  @SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT) > 0        
 BEGIN
	 UPDATE FOSETTLEMENT SET         
	 SERVICE_TAX = ((TRADEQTY*BROKAPPLIED)+        
			(CASE WHEN G.INSURANCE_CHRG_AC = 1 AND C2.INSURANCE_CHRG = 1         
		   THEN FOSETTLEMENT.INS_CHRG        
				  ELSE 0         
			 END)+        
			(CASE WHEN G.TURNOVER_AC = 1 AND C2.TURNOVER_TAX = 1         
		   THEN FOSETTLEMENT.TURN_TAX        
				  ELSE 0         
			 END)+        
			(CASE WHEN G.SEBI_TURN_AC = 1 AND C2.SEBI_TURN_TAX = 1         
		   THEN FOSETTLEMENT.SEBI_TAX        
				  ELSE 0         
			 END)+        
			(CASE WHEN G.BROKER_NOTE_AC = 1 AND C2.BROKERNOTE = 1         
		   THEN FOSETTLEMENT.BROKER_CHRG        
				  ELSE 0         
			 END)+        
			(CASE WHEN G.OTHER_CHRG_AC = 1 AND C2.OTHER_CHRG = 1        
		   THEN FOSETTLEMENT.OTHER_CHRG        
				  ELSE 0         
			 END)) * G.SERVICE_TAX /100        
	 FROM FOGLOBALS G, CLIENT2 C2, CLIENT1 C1        
	 WHERE         
		C1.CL_CODE = C2.CL_CODE AND        
		SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59' AND        
		C2.PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO AND        
		SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT AND        
		FOSETTLEMENT.PARTY_CODE = C2.PARTY_CODE AND        
		SERVICE_CHRG + SERVICE_CHRG + SERTAXMETHOD <> 3 AND        
		C1.CL_TYPE = 'INS'        
	 END   
	 
    EXEC V2_PROCESS_STATUS_LOG_UPD @SAUDA_DATE,'STT','',@USERNAME,''

	
SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_INSERTDATA_DETAIL
-- --------------------------------------------------




CREATE PROC [dbo].[STT_INSERTDATA_DETAIL] 
(
	@SAUDA_DATE VARCHAR(11),
	@PARTYFROM VARCHAR(10),
	@PARTYTO VARCHAR(11),
	@STT_ON VARCHAR(7)
) AS   


UPDATE FOSETTLEMENT  
SET    INS_CHRG = 0  
WHERE  SAUDA_DATE >= @SAUDA_DATE  
     AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'  
     AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO  
	 AND EXISTS (SELECT SYMBOL FROM STT_EXCEPTION
				WHERE STT_EXCEPTION.SYMBOL = FOSETTLEMENT.SYMBOL
				AND @SAUDA_DATE BETWEEN EFFDATE_FROM AND EFFDATE_TO)
	 
DECLARE @MEMBERTYPE VARCHAR (2), @RECTYPE1 INT ,@RECTYPE2 INT

SET @RECTYPE1 = 30
SET @RECTYPE2 = 40

SELECT @MEMBERTYPE= MEMBERTYPE FROM FOOWNER
IF @MEMBERTYPE = 'CM' 
	BEGIN
		SET @RECTYPE1 = 40
		SET @RECTYPE2 = 50
	END


DELETE FROM STT_CLIENTDETAIL
WHERE       SAUDA_DATE = @SAUDA_DATE
            AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
            AND RECTYPE = @RECTYPE1

DELETE FROM STT_CLIENTDETAIL
WHERE       SAUDA_DATE = @SAUDA_DATE
            AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
            AND RECTYPE = @RECTYPE2
                          
INSERT INTO STT_CLIENTDETAIL
        (
		RECTYPE,SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,
		STRIKE_PRICE,TRDPRICE,PQTYTRD,PAMTTRD,PSTTTRD,SQTYTRD,SAMTTRD,SSTTTRD,TOTALSTT
	)
           
SELECT   
	@RECTYPE1,@SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
    PRICE = SUM(TRADEQTY*PRICE)/SUM(TRADEQTY),
	0,0,0,
	SUM(TRADEQTY),
	SUM(TRADEQTY * (CASE 
	           WHEN LEFT(INST_TYPE,3) = 'FUT' THEN PRICE
	           ELSE CASE 
	                  WHEN @STT_ON = 'PRICE' THEN PRICE
	                  WHEN @STT_ON = 'SPRICE' THEN STRIKE_PRICE
	                  WHEN @STT_ON = 'SSPRICE' THEN PRICE + STRIKE_PRICE
	                END
	         END)),
	ROUND(ABS(SUM(INS_CHRG)),2),
	ROUND(ABS(SUM(INS_CHRG)),2)
FROM     FOSETTLEMENT
WHERE    SAUDA_DATE >= @SAUDA_DATE
         AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
         AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
         AND AUCTIONPART = ''
         AND TRADEQTY > 0
         AND SELL_BUY = 2
GROUP BY CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,
         SYMBOL,EXPIRYDATE,STRIKE_PRICE
         

INSERT INTO STT_CLIENTDETAIL
        (
		RECTYPE,SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,
		STRIKE_PRICE,TRDPRICE,PQTYTRD,PAMTTRD,PSTTTRD,SQTYTRD,SAMTTRD,SSTTTRD,TOTALSTT
	)
           
SELECT   
	@RECTYPE2,@SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
	PRICE = SUM(TRADEQTY*PRICE)/SUM(TRADEQTY),
	0,0,0,
	SUM(TRADEQTY),
	SUM(TRADEQTY * ABS(CASE 
                               WHEN LEFT(INST_TYPE,3) = 'FUT' THEN (CASE 
                                                                      WHEN AUCTIONPART = 'EA' THEN 0
                                                                      ELSE PRICE
                                                                    END)
                               ELSE CASE 
                                      WHEN @STT_ON = 'PRICE' THEN PRICE + CASE 
                                                                            WHEN AUCTIONPART = 'EA' THEN CASE 
                                                                                   WHEN LEFT(OPTION_TYPE,1) = 'P' THEN -STRIKE_PRICE
                                                                                   ELSE STRIKE_PRICE
                                                                                 END
                                                                            ELSE 0
                                                                          END
                                      WHEN @STT_ON = 'SPRICE' THEN STRIKE_PRICE
                                      WHEN @STT_ON = 'SSPRICE' THEN PRICE + STRIKE_PRICE
                                    END
                             END) ),
	ROUND(ABS(SUM(INS_CHRG)),2),
	ROUND(ABS(SUM(INS_CHRG)),2)
FROM     FOSETTLEMENT
WHERE    SAUDA_DATE >= @SAUDA_DATE
         AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
         AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
         AND LEFT(INST_TYPE,3) = 'OPT'
         AND AUCTIONPART = 'EA'
         AND TRADEQTY > 0
         AND SELL_BUY = 2
GROUP BY CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,
         SYMBOL,EXPIRYDATE,STRIKE_PRICE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_INSERTDATA_SUMMARY
-- --------------------------------------------------


CREATE PROC [dbo].[STT_INSERTDATA_SUMMARY] 
(
	@SAUDA_DATE VARCHAR(11),
	@PARTYFROM VARCHAR(10)='',
	@PARTYTO VARCHAR(11)='ZZZZZZZZ'
) AS   

DELETE FROM STT_CLIENTDETAIL WHERE SAUDA_DATE = @SAUDA_DATE
AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
AND RECTYPE = 20

INSERT INTO STT_CLIENTDETAIL   
	(RECTYPE,SAUDA_DATE,CONTRACTNO,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,TRDPRICE,
	PQTYTRD,PAMTTRD,PSTTTRD,SQTYTRD,SAMTTRD,SSTTTRD,TOTALSTT)

SELECT 20,@SAUDA_DATE,'',PARTY_CODE,'',
	'','','',0,0,0,0,0,0,0,0,SUM(INS_CHRG) 
FROM FOSETTLEMENT
WHERE 
	SAUDA_DATE >= @SAUDA_DATE AND SAUDA_DATE <= @SAUDA_DATE + ' 23:59'
	AND PARTY_CODE BETWEEN @PARTYFROM AND @PARTYTO
	AND TRADEQTY > 0
	AND SELL_BUY = 2 
GROUP BY PARTY_CODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_MATCHING_PARTYSCRIPWISE_NSEFO
-- --------------------------------------------------



CREATE PROC  
 [dbo].[STT_MATCHING_PARTYSCRIPWISE_NSEFO]  
 (  
 @FROMDATE VARCHAR(11),  
 @TODATE VARCHAR(11),  
 @CLITYPE VARCHAR(2),  
 @FROMCODE VARCHAR(10),  
 @TOCODE VARCHAR(10),  
 @PARTYCODETYPE VARCHAR(5),  
 @SHOW VARCHAR(1)  ,
 @TYPE VARCHAR(2)
 )  
  
AS  

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF LEN(LTRIM(RTRIM(@TOCODE))) = 0 SET @TOCODE = 'ZZZZZZZZZZ' 

DECLARE @MEMBERTYPE VARCHAR (2)

SELECT @MEMBERTYPE= MEMBERTYPE FROM FOOWNER

CREATE TABLE #RECTYPE ( RECTYPE INT )
IF @MEMBERTYPE = 'CM' 
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (50)
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (40)
	END
	ELSE
	BEGIN		
		INSERT INTO #RECTYPE VALUES (40)
		INSERT INTO #RECTYPE VALUES (50)
	END	
END
ELSE
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (40)
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (30)
	END
	ELSE
	BEGIN		
		INSERT INTO #RECTYPE VALUES (30)
		INSERT INTO #RECTYPE VALUES (50)
	END	
END

IF @SHOW = 'A'
BEGIN  
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		ISNULL(C.PARTY_CODE,E.PARTY_CODE)                               AS PARTY_CODE,
		ISNULL(C.INST_TYPE,E.INST_TYPE) 				AS INST_TYPE,
		ISNULL(C.SYMBOL,E.SYMBOL) 					AS SYMBOL,
		LEFT(CONVERT(VARCHAR,ISNULL(C.EXPIRYDATE,E.EXPIRYDATE),109),11) AS EXPIRYDATE,
		ISNULL(C.STRIKE_PRICE,E.STRIKE_PRICE) 				AS STRIKE_PRICE,
		ISNULL(C.OPTION_TYPE,E.OPTION_TYPE) 				AS OPTION_TYPE,
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ROUND(ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0),2)  AS TOT_DIFF 
	FROM     (
		SELECT 	SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
		GROUP BY SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN 
			(
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
			) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),ISNULL(C.PARTY_CODE,E.PARTY_CODE),
	ISNULL(C.INST_TYPE,E.INST_TYPE),ISNULL(C.SYMBOL,E.SYMBOL),
	LEFT(CONVERT(VARCHAR,ISNULL(C.EXPIRYDATE,E.EXPIRYDATE),109),11),
	ISNULL(C.STRIKE_PRICE,E.STRIKE_PRICE),ISNULL(C.OPTION_TYPE,E.OPTION_TYPE)
	ORDER BY 1,2
END
ELSE
BEGIN
	SELECT * FROM (
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		ISNULL(C.PARTY_CODE,E.PARTY_CODE)                               AS PARTY_CODE,
		ISNULL(C.INST_TYPE,E.INST_TYPE) 				AS INST_TYPE,
		ISNULL(C.SYMBOL,E.SYMBOL) 					AS SYMBOL,
		LEFT(CONVERT(VARCHAR,ISNULL(C.EXPIRYDATE,E.EXPIRYDATE),109),11) AS EXPIRYDATE,
		ISNULL(C.STRIKE_PRICE,E.STRIKE_PRICE) 				AS STRIKE_PRICE,
		ISNULL(C.OPTION_TYPE,E.OPTION_TYPE) 				AS OPTION_TYPE,
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ROUND(ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0),2)  AS TOT_DIFF 
	FROM     (
		SELECT 	SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
		GROUP BY SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN 
			(
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
			) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),ISNULL(C.PARTY_CODE,E.PARTY_CODE),
	ISNULL(C.INST_TYPE,E.INST_TYPE),ISNULL(C.SYMBOL,E.SYMBOL),
	LEFT(CONVERT(VARCHAR,ISNULL(C.EXPIRYDATE,E.EXPIRYDATE),109),11),
	ISNULL(C.STRIKE_PRICE,E.STRIKE_PRICE),ISNULL(C.OPTION_TYPE,E.OPTION_TYPE)
	) STT_DIFF
	WHERE TOT_DIFF <> 0
	ORDER BY 1,2
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_MATCHING_PARTYWISE_NSEFO
-- --------------------------------------------------



CREATE PROC    
 [dbo].[STT_MATCHING_PARTYWISE_NSEFO]    
 (    
	 @FROMDATE VARCHAR(11),    
	 @TODATE VARCHAR(11),    
	 @CLITYPE VARCHAR(2),    
	 @FROMCODE VARCHAR(10),    
	 @TOCODE VARCHAR(10),    
	 @PARTYCODETYPE VARCHAR(5),    
	 @SHOW VARCHAR(1)    ,
	 @TYPE VARCHAR(2)
 )    
    
AS    

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

IF LEN(LTRIM(RTRIM(@TOCODE))) = 0 SET @TOCODE = 'ZZZZZZZZZZ' 
    
DECLARE @MEMBERTYPE VARCHAR (2), @EXRECTYPE INT

SELECT @MEMBERTYPE= MEMBERTYPE FROM FOOWNER
IF @MEMBERTYPE = 'CM' 
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		SET @EXRECTYPE = 50
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		SET @EXRECTYPE = 40
	END
	ELSE
	BEGIN		
		SET @EXRECTYPE = 20
	END	
END
ELSE
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		SET @EXRECTYPE = 40
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		SET @EXRECTYPE = 30
	END
	ELSE
	BEGIN		
		SET @EXRECTYPE = 20
	END	
END


IF @SHOW = 'A'
BEGIN  
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		ISNULL(C.PARTY_CODE,E.PARTY_CODE)                               AS PARTY_CODE,
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0)           AS TOT_DIFF 
	FROM     
		(
		SELECT 	RECTYPE,SAUDA_DATE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE = @EXRECTYPE
		GROUP BY RECTYPE,SAUDA_DATE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN 
			(
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE = @EXRECTYPE
			) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),ISNULL(C.PARTY_CODE,E.PARTY_CODE)
	ORDER BY 1,2
END
ELSE
BEGIN
	SELECT * FROM
	(
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		ISNULL(C.PARTY_CODE,E.PARTY_CODE)                               AS PARTY_CODE,
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0)           AS TOT_DIFF 
	FROM     
		(
		SELECT 	RECTYPE,SAUDA_DATE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE = @EXRECTYPE
		GROUP BY SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN 
			(
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE = @EXRECTYPE
			) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),ISNULL(C.PARTY_CODE,E.PARTY_CODE)
	) STT_DIFF
	WHERE TOT_DIFF <> 0
	ORDER BY 1,2
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_MISEXCEPTION_PARTYSCRIPWISE_NSEFO
-- --------------------------------------------------


CREATE   PROC  
 [dbo].[STT_MISEXCEPTION_PARTYSCRIPWISE_NSEFO]  
 (  
	 @FROMDATE VARCHAR(11),  
	 @TODATE VARCHAR(11),  
	 @CLITYPE VARCHAR(2),  
	 @FROMCODE VARCHAR(10),  
	 @TOCODE VARCHAR(10),  
	 @EXCEPTIONTYPE VARCHAR(2)  ,
	 @TYPE VARCHAR(2)
 )  
  
AS  
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED


DECLARE @MEMBERTYPE VARCHAR (2)

SELECT @MEMBERTYPE= MEMBERTYPE FROM FOOWNER

CREATE TABLE #RECTYPE ( RECTYPE INT )
IF @MEMBERTYPE = 'CM' 
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (50)
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (40)
	END
	ELSE
	BEGIN		
		INSERT INTO #RECTYPE VALUES (40)
		INSERT INTO #RECTYPE VALUES (50)
	END	
END
ELSE
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (40)
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		INSERT INTO #RECTYPE VALUES (30)
	END
	ELSE
	BEGIN		
		INSERT INTO #RECTYPE VALUES (30)
		INSERT INTO #RECTYPE VALUES (50)
	END	
END

IF LEN(LTRIM(RTRIM(@TOCODE))) = 0 SET @TOCODE = 'ZZZZZZZZZZ'  

IF @EXCEPTIONTYPE = 'BO'
BEGIN
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		C.PARTY_CODE                                                    AS PARTY_CODE,
		C.INST_TYPE,
		C.SYMBOL,
		LEFT(CONVERT(VARCHAR,C.EXPIRYDATE,109),11)    			AS EXPIRYDATE,
		C.STRIKE_PRICE,
		C.OPTION_TYPE,	
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0)           AS TOT_DIFF 
	FROM     (
		SELECT 	SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
		GROUP BY SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN (
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
				) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	WHERE    E.PARTY_CODE IS NULL
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),C.PARTY_CODE,
	C.INST_TYPE,C.SYMBOL,LEFT(CONVERT(VARCHAR,C.EXPIRYDATE,109),11),C.STRIKE_PRICE,C.OPTION_TYPE
	ORDER BY 1,2
END
ELSE
BEGIN
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		E.PARTY_CODE                                                    AS PARTY_CODE,
		E.INST_TYPE,
		E.SYMBOL,
		LEFT(CONVERT(VARCHAR,E.EXPIRYDATE,109),11)    			AS EXPIRYDATE,
		E.STRIKE_PRICE,
		E.OPTION_TYPE,		
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0)           AS TOT_DIFF 
	FROM     (
		SELECT 	SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
		GROUP BY SAUDA_DATE,RECTYPE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN (
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE IN (SELECT RECTYPE FROM #RECTYPE )
				) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	WHERE    C.PARTY_CODE IS NULL
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),E.PARTY_CODE,
	E.INST_TYPE,E.SYMBOL,LEFT(CONVERT(VARCHAR,E.EXPIRYDATE,109),11),E.STRIKE_PRICE,E.OPTION_TYPE
	ORDER BY 1,2
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_MISEXCEPTION_PARTYWISE_NSEFO
-- --------------------------------------------------


CREATE   PROC  
 [dbo].[STT_MISEXCEPTION_PARTYWISE_NSEFO]  
 (  
	@FROMDATE VARCHAR(11),  
	@TODATE VARCHAR(11),  
	@CLITYPE VARCHAR(2),  
	@FROMCODE VARCHAR(10),  
	@TOCODE VARCHAR(10),  
	@EXCEPTIONTYPE VARCHAR(2) ,
	@TYPE VARCHAR(2)
 
 )  
  
AS  

SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
  
DECLARE @MEMBERTYPE VARCHAR (2), @EXRECTYPE INT

SELECT @MEMBERTYPE= MEMBERTYPE FROM FOOWNER
IF @MEMBERTYPE = 'CM' 
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		SET @EXRECTYPE = 50
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		SET @EXRECTYPE = 40
	END
	ELSE
	BEGIN		
		SET @EXRECTYPE = 20
	END	
END
ELSE
BEGIN
	IF @TYPE = 'EA' 
	BEGIN		
		SET @EXRECTYPE = 40
	END
	ELSE IF @TYPE = 'FO' 
	BEGIN		
		SET @EXRECTYPE = 30
	END
	ELSE
	BEGIN		
		SET @EXRECTYPE = 20
	END	
END

IF LEN(LTRIM(RTRIM(@TOCODE))) = 0 SET @TOCODE = 'ZZZZZZZZZZ'  

IF @EXCEPTIONTYPE = 'BO'
BEGIN
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		C.PARTY_CODE                                                    AS PARTY_CODE,
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0)           AS TOT_DIFF 
	FROM    (
		SELECT 	RECTYPE,SAUDA_DATE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE = @EXRECTYPE
		GROUP BY RECTYPE,SAUDA_DATE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN (
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE = @EXRECTYPE
				) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	WHERE  E.PARTY_CODE IS NULL
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),C.PARTY_CODE
	ORDER BY 1,2
END
ELSE
BEGIN
	SELECT   
		LEFT(CONVERT(VARCHAR,ISNULL(C.SAUDA_DATE,E.STT_DATE),109),11) 	AS SAUDA_DATE,
		E.PARTY_CODE                                                    AS PARTY_CODE,
		ISNULL(SUM(C.TOTALSTT),0)                                       AS STT_TOT_BO, 
		ISNULL(SUM(E.TOTALSTT),0)                                       AS STT_TOT_EX, 
		ISNULL(SUM(C.TOTALSTT),0) - ISNULL(SUM(E.TOTALSTT),0)           AS TOT_DIFF 
	FROM     (
		SELECT 	RECTYPE,SAUDA_DATE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,
			TOTALSTT=SUM(TOTALSTT)
		FROM STT_CLIENTDETAIL
		WHERE 
		SAUDA_DATE >= @FROMDATE
		AND SAUDA_DATE <= @TODATE + ' 23:59:59'
		AND PARTY_CODE >= @FROMCODE
		AND PARTY_CODE <= @TOCODE
		AND RECTYPE = @EXRECTYPE
		GROUP BY RECTYPE,SAUDA_DATE,PARTY_CODE,INST_TYPE,OPTION_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE
		) C
	         FULL OUTER JOIN (
				SELECT * FROM STT_EXCHG
				WHERE 
				STT_DATE >= @FROMDATE
				AND STT_DATE <= @TODATE + ' 23:59:59'
				AND PARTY_CODE >= @FROMCODE
				AND PARTY_CODE <= @TOCODE
				AND RECTYPE = @EXRECTYPE
				) E
	           ON (
			LEFT(C.SAUDA_DATE,11) = LEFT(E.STT_DATE,11)
			AND E.RECTYPE = C.RECTYPE
			AND C.PARTY_CODE = E.PARTY_CODE
			AND E.INST_TYPE = C.INST_TYPE
			AND E.SYMBOL = C.SYMBOL
			AND LEFT(E.EXPIRYDATE,11) = LEFT(C.EXPIRYDATE,11)
			AND C.OPTION_TYPE = CASE WHEN LEFT(C.INST_TYPE,3) ='FUT' THEN '' ELSE E.OPTION_TYPE END
			AND E.STRIKE_PRICE = C.STRIKE_PRICE
			)
	WHERE  C.PARTY_CODE IS NULL
	GROUP BY LEFT(CONVERT(VARCHAR, ISNULL(C.SAUDA_DATE,E.STT_DATE), 109), 11),E.PARTY_CODE
	ORDER BY 1,2

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.STT_ROUNDING_FURTHER
-- --------------------------------------------------


CREATE PROC [dbo].[STT_ROUNDING_FURTHER] 
(@SAUDA_DATE VARCHAR(11), @FROMPARTY VARCHAR(10), @TOPARTY VARCHAR(10))  
AS  
  
DECLARE @STTCUR CURSOR,  
@DIFF NUMERIC(18,4),  
@PARTY_CODE VARCHAR(10),  
@CONTRACTNO VARCHAR(7)  
  
DECLARE @SETTCUR CURSOR,  
@ORDER_NO VARCHAR(20),  
@TRADE_NO VARCHAR(20),  
@SYMBOL VARCHAR(12),  
@INS_CHRG NUMERIC(18,4)  ,
@SRNO INT
  
SELECT PARTY_CODE, CONTRACTNO, TOTAL = SUM(INS_CHRG), ACTUAL = ROUND(SUM(INS_CHRG),0)   
INTO #SETT FROM FOSETTLEMENT 
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
GROUP BY PARTY_CODE, CONTRACTNO  
HAVING SUM(INS_CHRG) <> ROUND(SUM(INS_CHRG),0)  
  
SET @STTCUR = CURSOR FOR  
SELECT PARTY_CODE, CONTRACTNO, DIFF = TOTAL - ACTUAL FROM #SETT  
ORDER BY PARTY_CODE, CONTRACTNO  
OPEN @STTCUR  
FETCH NEXT FROM @STTCUR INTO @PARTY_CODE, @CONTRACTNO, @DIFF  
WHILE @@FETCH_STATUS = 0 --1  
BEGIN  
 SET @SETTCUR = CURSOR FOR  
 SELECT SRNO,SYMBOL, ORDER_NO, TRADE_NO, INS_CHRG FROM FOSETTLEMENT    
 WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
 AND PARTY_CODE = @PARTY_CODE AND CONTRACTNO = @CONTRACTNO  
 AND INS_CHRG > 0   
 ORDER BY INS_CHRG DESC  
 OPEN @SETTCUR  
 FETCH NEXT FROM @SETTCUR INTO @SRNO,@SYMBOL, @ORDER_NO, @TRADE_NO, @INS_CHRG  
 WHILE @@FETCH_STATUS = 0 AND @DIFF <> 0 --2  
 BEGIN  
  IF @DIFF < 0   
  BEGIN  
   UPDATE FOSETTLEMENT SET INS_CHRG = INS_CHRG + ABS(@DIFF)  
   WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
   AND PARTY_CODE = @PARTY_CODE AND CONTRACTNO = @CONTRACTNO  
   AND INS_CHRG > 0 AND SYMBOL = @SYMBOL AND ORDER_NO = @ORDER_NO   
   AND TRADE_NO = @TRADE_NO  
   AND SRNO = @SRNO
   SELECT @DIFF = 0   
  END  
 ELSE  
   BEGIN  
   IF @DIFF >= @INS_CHRG   
   BEGIN  
    UPDATE FOSETTLEMENT SET INS_CHRG = 0  
    WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
    AND PARTY_CODE = @PARTY_CODE AND CONTRACTNO = @CONTRACTNO  
    AND INS_CHRG > 0 AND SYMBOL = @SYMBOL AND ORDER_NO = @ORDER_NO   
    AND TRADE_NO = @TRADE_NO  
	AND SRNO = @SRNO

    SELECT @DIFF = @DIFF - @INS_CHRG   
   END   
    ELSE  
   BEGIN  
    UPDATE FOSETTLEMENT SET INS_CHRG = @INS_CHRG - @DIFF  
    WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  AND @SAUDA_DATE  + ' 23:59'  
    AND PARTY_CODE = @PARTY_CODE AND CONTRACTNO = @CONTRACTNO  
    AND INS_CHRG > 0 AND SYMBOL = @SYMBOL AND ORDER_NO = @ORDER_NO   
    AND TRADE_NO = @TRADE_NO  
    AND SRNO = @SRNO
     
    SELECT @DIFF = 0  
   END      
   END   
   FETCH NEXT FROM @SETTCUR INTO @SRNO,@SYMBOL, @ORDER_NO, @TRADE_NO, @INS_CHRG   
 END  
 CLOSE @SETTCUR  
 DEALLOCATE @SETTCUR  
 FETCH NEXT FROM @STTCUR INTO @PARTY_CODE, @CONTRACTNO, @DIFF  
END  
CLOSE @STTCUR  
DEALLOCATE @STTCUR

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Tbl
-- --------------------------------------------------
  

  
CREATE PROC Tbl @TblName VARCHAR(25)AS             
Select * from sysobjects where name Like '%' + @TblName + '%' and xtype='U' Order By Name

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TRADE_CONSOLIDATION_INS_ALL
-- --------------------------------------------------
  
  
  
  
  
  
  
  
  
    
CREATE PROC [dbo].[TRADE_CONSOLIDATION_INS_ALL]    
  
 @SAUDADATE VARCHAR(10),    
 @FROMPARTY VARCHAR(10),    
 @TOPARTY VARCHAR(10),    
 @FROMSYMBOL VARCHAR(10),    
 @TOSYMBOL VARCHAR(10),    
 @FROMTERM VARCHAR(10),    
 @TOTERM VARCHAR(10),    
 @CONSOLIDATE INT,       
 @CONTRACTNO VARCHAR(7),    
 @AFTERCONTRACT VARCHAR(1) = 'Y',    
 @SELL_BUY INT = 0,  
 @LEVEL INT,  
 @PARTICIPANT VARCHAR(20) = '',    
 @ORDER_NO VARCHAR(16) = '',    
 @SHOW INT = 0,    
 @TRFTABLE VARCHAR(20) = 'FOTRADE' ,   
 @ORDERBY VARCHAR(1) = '3',  
 @CHANNELTYPE VARCHAR(1)='',  
 @PRODUCTCODE VARCHAR(20)=''  
AS    
  
/*---------------------------------------------------------------------------  
 PROC NAME   : TRADE_CONSOLIDATION_PROC  
 PROJECT     : .NET NSEFO CONSOLIDATION  
 DESCRIPTION : AVAILABLE DATA FETCHING FOR CONSOLIDATES & NON CSONSOLIDATES  
------------------------------------------------------------------------------*/  
   
  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
 DECLARE @SQL AS VARCHAR(8000)    
 DECLARE @MEMBER VARCHAR(15)    
 SET @MEMBER = ''    
 SELECT @MEMBER = ISNULL(MEMBERCODE, '') FROM OWNER    
 CREATE TABLE #TRADE_CONSOLIDATION    
 (    
  PARTY_CODE VARCHAR(10),    
  ORGPARTY VARCHAR(10),  
  TRADE_NO VARCHAR(2),   
  BANKID  VARCHAR(16),  
  BILLNO  INT,  
  PARTIPANTCODE VARCHAR(15),    
  USER_ID VARCHAR(10),    
  CONTRACTNO VARCHAR(7),    
  SYMBOL VARCHAR(10),  
  INST_TYPE VARCHAR(10),  
  EXPIRYDATE VARCHAR(10),  
  STRIKE_PRICE NUMERIC(18,4),  
  OPTION_TYPE VARCHAR(10),    
  LONG_NAME VARCHAR(100),    
  DUMMY1 VARCHAR(15),    
  SELL_BUY VARCHAR(4),    
  QTY INT,    
  MKTRATE MONEY,    
  NETRATE MONEY,    
  AMOUNT MONEY,    
  DEALTICKETPRICE MONEY,    
  NETAMOUNT MONEY,    
  PARTY_NAME VARCHAR(100),    
  R_MKTRATE INT,    
  R_BROKERAGE INT,    
  R_NETRATE INT,    
  STP_TYPE VARCHAR(5),    
  STP_FLAG BIT,    
  CL_TYPE VARCHAR(3),  
  PRODUCTCODE VARCHAR(20),  
  CHANNELTYPE VARCHAR(20)    
 )    
 IF @CONSOLIDATE = 2    
  BEGIN    
   SET @SQL = "INSERT INTO #TRADE_CONSOLIDATION "    
   SET @SQL = @SQL + "( "    
   SET @SQL = @SQL + " PARTY_CODE, "    
   SET @SQL = @SQL + " TRADE_NO, "    
   SET @SQL = @SQL + " BANKID, "  
   SET @SQL = @SQL + " BILLNO, "  
   SET @SQL = @SQL + " ORGPARTY, "    
   SET @SQL = @SQL + " PARTIPANTCODE, "    
   SET @SQL = @SQL + " USER_ID, "    
   SET @SQL = @SQL + " CONTRACTNO, "    
   SET @SQL = @SQL + " SYMBOL, "  
   SET @SQL = @SQL + " INST_TYPE,"  
   SET @SQL = @SQL + " EXPIRYDATE,"  
   SET @SQL = @SQL + " STRIKE_PRICE,"  
   SET @SQL = @SQL + " OPTION_TYPE,"       
   SET @SQL = @SQL + " LONG_NAME, "       
   SET @SQL = @SQL + " DUMMY1, "    
   SET @SQL = @SQL + " SELL_BUY, "    
   SET @SQL = @SQL + " QTY, "    
   SET @SQL = @SQL + " MKTRATE, "    
   SET @SQL = @SQL + " NETRATE, "    
   SET @SQL = @SQL + " AMOUNT, "    
   SET @SQL = @SQL + " DEALTICKETPRICE, "    
   SET @SQL = @SQL + " NETAMOUNT, "    
   SET @SQL = @SQL + " PARTY_NAME, "    
   SET @SQL = @SQL + " R_MKTRATE, "    
   SET @SQL = @SQL + " R_BROKERAGE, "    
   SET @SQL = @SQL + " R_NETRATE, "    
   SET @SQL = @SQL + " STP_TYPE, "    
   SET @SQL = @SQL + " STP_FLAG, "    
   SET @SQL = @SQL + " CL_TYPE, "   
   SET @SQL = @SQL + " PRODUCTCODE, "  
   SET @SQL = @SQL + " CHANNELTYPE "   
   SET @SQL = @SQL + ") "    
   SET @SQL = @SQL + " SELECT "    
   SET @SQL = @SQL + "  I.PARTY_CODE, "    
   SET @SQL = @SQL + "  TRADE_NO = CASE WHEN C2.BANKID=I.PARTICIPANTCODE THEN 'Y' ELSE 'N' END ,"  
   SET @SQL = @SQL + "  C2.BANKID , "    
 IF @AFTERCONTRACT = 'Y'  
  BEGIN  
   SET @SQL = @SQL + "  I.BILLNO , "   
  END  
 ELSE  
  BEGIN  
   SET @SQL = @SQL + "  BILLNO=S.C_REGULAR_LOT , "   
  END  
   
   SET @SQL = @SQL + "  ORGPARTY = I.PARTY_CODE, "    
   SET @SQL = @SQL + "  I.PARTICIPANTCODE, "    
   SET @SQL = @SQL + "  I.USER_ID, "    
   IF @AFTERCONTRACT = 'Y'  
  BEGIN  
   SET @SQL = @SQL + "  I.CONTRACTNO, "  
  END  
 ELSE  
  BEGIN  
   SET @SQL = @SQL + "  CONTRACTNO = '', "  
  END  
   SET @SQL = @SQL + "  I.SYMBOL, "  
   SET @SQL = @SQL + " I.INST_TYPE,"  
   SET @SQL = @SQL + " I.EXPIRYDATE,"  
   SET @SQL = @SQL + " I.STRIKE_PRICE,"  
   SET @SQL = @SQL + " I.OPTION_TYPE,"       
   SET @SQL = @SQL + "  C1.LONG_NAME, "   
   IF @AFTERCONTRACT = 'Y'  
  BEGIN    
   SET @SQL = @SQL + "  I.DUMMY1, "    
  END  
 ELSE  
  BEGIN  
   SET @SQL = @SQL + "  (CASE WHEN LEN(I.RESERVED4)=0 THEN 0 ELSE I.RESERVED4 END) DUMMY1  ,"  
  END  
   SET @SQL = @SQL + "  SELL_BUY, " --= CASE WHEN I.SELL_BUY = 1 THEN 'BUY' ELSE 'SALE' END, "    
   SET @SQL = @SQL + "  QTY = SUM(I.TRADEQTY), "    
    
 IF @AFTERCONTRACT = 'Y'  
  BEGIN    
    SET @SQL = @SQL + "  MKTRATE = ((SUM(I.DUMMY2*I.TRADEQTY)) / (SUM(I.TRADEQTY))), "     
  END  
 ELSE  
  BEGIN  
    SET @SQL = @SQL + "  MKTRATE = 0, "    
  END  
 IF @AFTERCONTRACT = 'Y'  
  BEGIN    
   SET @SQL = @SQL + "  NETRATE = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) "  
      SET @SQL = @SQL + " ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END), "      
  END  
 ELSE  
  BEGIN  
    SET @SQL = @SQL + "  NETRATE = 0, "    
  END  
   SET @SQL = @SQL + "  AMOUNT = SUM(I.TRADEQTY * I.PRICE), "    
   SET @SQL = @SQL + "  DEALTICKETPRICE = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.PRICE, 4) WHEN 2 THEN ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) "  
   SET @SQL = @SQL + " ELSE ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END), "    
    IF @AFTERCONTRACT = 'Y'  
  BEGIN    
    SET @SQL = @SQL + "  NETAMOUNT = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) "  
    SET @SQL = @SQL + " ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END), "    
   END  
 ELSE  
  BEGIN  
    SET @SQL = @SQL + "  NETAMOUNT = 0, "    
  END  
     
   SET @SQL = @SQL + "  PARTY_NAME = C1.LONG_NAME, "    
   SET @SQL = @SQL + "  R_MKTRATE = ISNULL(R.PRICE, 4), "    
   SET @SQL = @SQL + "  R_BROKERAGE = ISNULL(R.BROKERAGE, 4), "    
   SET @SQL = @SQL + "  R_NETRATE = ISNULL(R.NETRATE, 4), "    
   SET @SQL = @SQL + "  STP_TYPE = C2.DUMMY6, "    
   SET @SQL = @SQL + "  STP_FLAG = 0,"    
   SET @SQL = @SQL + "  CL_TYPE = C1.CL_TYPE, "  
   IF @CHANNELTYPE<>''  
  BEGIN  
   SET @SQL = @SQL + " PRODUCTCODE = PRODUCT_TYPE,CHANNELTYPE =(CASE WHEN DMA_FLAG=0 THEN 'BOTH' WHEN DMA_FLAG=2 THEN 'CARE' WHEN DMA_FLAG=1 THEN 'DMA' ELSE '' END)"   
  END  
 ELSE  
  BEGIN  
   SET @SQL = @SQL + " PRODUCTCODE = '',CHANNELTYPE =' '"   
  END    
   SET @SQL = @SQL + "  FROM "    
  
 IF @AFTERCONTRACT = 'Y'  
  BEGIN  
   SET @SQL = @SQL + "  FOSETTLEMENT I, "  
   SET @SQL = @SQL + "  CLIENT2 C2"  
            IF @CHANNELTYPE<>''  
   BEGIN  
    SET @SQL = @SQL + "  LEFT JOIN MSAJAG..PRODUCT_MASTER PM"    
    SET @SQL = @SQL + "  ON (C2.PRODUCTCODE = PM.PRODUCT_CODE)"   
   END  
   SET @SQL = @SQL + "   LEFT JOIN INSTCLIENT_TBL R"  
   SET @SQL = @SQL + "    ON (C2.PARTY_CODE = R.PARTYCODE),"  
   SET @SQL = @SQL + "  CLIENT1 C1"  
  END  
 ELSE  
  BEGIN  
   SET @SQL = @SQL + "  FOTRADE I "  
   SET @SQL = @SQL + "  INNER JOIN FOSCRIP2  AS S "  
   SET @SQL = @SQL + "  ON ( S.INST_TYPE = I.INST_TYPE AND S.SYMBOL = I.SYMBOL "  
   SET @SQL = @SQL + "  AND S.EXPIRYDATE = I.EXPIRYDATE AND S.STRIKE_PRICE = I.STRIKE_PRICE AND S.OPTION_TYPE = I.OPTION_TYPE)"  
   SET @SQL = @SQL + "  LEFT JOIN CLIENT2 C2 ON (I.PARTY_CODE = C2.PARTY_CODE) "  
   IF @CHANNELTYPE<>''  
   BEGIN  
    SET @SQL = @SQL + "  LEFT JOIN MSAJAG..PRODUCT_MASTER PM"    
    SET @SQL = @SQL + "  ON (C2.PRODUCTCODE = PM.PRODUCT_CODE)"   
   END  
   SET @SQL = @SQL + "   LEFT JOIN INSTCLIENT_TBL R"  
   SET @SQL = @SQL + "    ON (C2.PARTY_CODE = R.PARTYCODE),"  
   SET @SQL = @SQL + "  CLIENT1 C1"  
  END  
  
   SET @SQL = @SQL + " WHERE"    
   SET @SQL = @SQL + "  C1.CL_CODE = C2.CL_CODE"    
   SET @SQL = @SQL + "  AND I.PARTY_CODE = C2.PARTY_CODE"    
   IF @AFTERCONTRACT = 'Y'  
  BEGIN  
   SET @SQL = @SQL + "  AND CONVERT(VARCHAR(10), SAUDA_DATE, 103) = '" + @SAUDADATE + "'"    
  END  
 ELSE  
  BEGIN  
   SET @SQL = @SQL + "  AND CONVERT(VARCHAR(10), ACTIVITYTIME, 103) = '" + @SAUDADATE + "'"   
  END  
  
   SET @SQL = @SQL + "  AND I.TRADEQTY > 0"    
   IF @FROMSYMBOL <> '' AND @TOSYMBOL <> ''    
    BEGIN    
     SET @SQL = @SQL + "  AND I.SYMBOL >= '" + @FROMSYMBOL + "'"    
     SET @SQL = @SQL + "  AND I.SYMBOL <= '" + @TOSYMBOL + "'"    
    END       
   IF @SELL_BUY <> 0    
    BEGIN    
     SET @SQL = @SQL + "  AND I.SELL_BUY = " + CONVERT(VARCHAR(1), @SELL_BUY) + " "    
    END    
   
   IF @CONTRACTNO <> ''    
    BEGIN    
     SET @SQL = @SQL + "  AND I.CONTRACTNO = '" + @CONTRACTNO + "'"    
    END    
   IF @CONSOLIDATE = 0    
    BEGIN    
     SET @SQL = @SQL + "  AND I.DUMMY1 = 0"    
    END    
   ELSE IF @CONSOLIDATE = 1    
    BEGIN    
     SET @SQL = @SQL + "  AND I.DUMMY1 = 1"    
    END    
   IF @FROMPARTY <> '' AND @TOPARTY = ''    
    BEGIN    
     SET @SQL = @SQL + "  AND I.PARTY_CODE = '" + @FROMPARTY + "'"    
    END    
   ELSE IF @FROMPARTY <> '' AND @TOPARTY <> ''    
    BEGIN    
     SET @SQL = @SQL + "  AND I.PARTY_CODE >= '" + @FROMPARTY + "'"    
     SET @SQL = @SQL + "  AND I.PARTY_CODE <= '" + @TOPARTY + "'"    
    END    
   IF @FROMTERM <> ''    
    BEGIN    
     SET @SQL = @SQL + "  AND I.USER_ID >= '" + @FROMTERM + "'"    
    END    
   IF @TOTERM <> ''    
    BEGIN    
     SET @SQL = @SQL + "  AND I.USER_ID <= '" + @TOTERM + "'"    
    END    
 IF @CHANNELTYPE<>'0' AND @CHANNELTYPE<>''  
  BEGIN  
   SET @SQL = @SQL + "  AND DMA_FLAG = " + @CHANNELTYPE  
  END  
 IF @PRODUCTCODE<>'ALL' AND @PRODUCTCODE<>''  
  BEGIN  
   SET @SQL = @SQL + "  AND PRODUCTCODE = '" + @PRODUCTCODE + "'"  
  END  
   SET @SQL = @SQL + " GROUP BY "    
   SET @SQL = @SQL + "  I.PARTY_CODE,"    
   SET @SQL = @SQL + "  I.PARTICIPANTCODE,"    
   SET @SQL = @SQL + "  I.USER_ID,"    
   IF @AFTERCONTRACT = 'Y'  
 BEGIN  
  SET @SQL = @SQL + "  I.CONTRACTNO,"  
 END    
   SET @SQL = @SQL + "  I.SYMBOL,"  
   SET @SQL = @SQL + " I.INST_TYPE,"  
   SET @SQL = @SQL + " I.EXPIRYDATE,"  
   SET @SQL = @SQL + " I.STRIKE_PRICE,"  
   SET @SQL = @SQL + " I.OPTION_TYPE,"     
   SET @SQL = @SQL + "  C1.LONG_NAME,"    
   SET @SQL = @SQL + "  I.SELL_BUY,"     
   SET @SQL = @SQL + "  C1.LONG_NAME,"    
   SET @SQL = @SQL + "  C2.BANKID,"  
     
    IF @AFTERCONTRACT = 'Y'  
  BEGIN  
   SET @SQL = @SQL + "  I.BILLNO,"   
  END   
 ELSE  
  BEGIN  
   SET @SQL = @SQL + "  S.C_REGULAR_LOT,"   
  END  
 IF @AFTERCONTRACT = 'Y'  
  BEGIN  
   SET @SQL = @SQL + "  I.DUMMY1,"  
  END  
 ELSE  
   BEGIN  
   SET @SQL = @SQL + "  I.RESERVED4,"  
  END  
 IF @CHANNELTYPE<>''  
 BEGIN  
  SET @SQL = @SQL + "DMA_FLAG,PRODUCT_TYPE,"   
 END  
   SET @SQL = @SQL + "  R.PRICE,"    
   SET @SQL = @SQL + "  R.BROKERAGE,"    
   SET @SQL = @SQL + "  R.NETRATE,"    
   SET @SQL = @SQL + "  C2.DUMMY6,"    
   SET @SQL = @SQL + "  C1.CL_TYPE "    
   SET @SQL = @SQL + " ORDER BY "    
   IF @ORDERBY = '3' OR @ORDERBY = '0'   
  BEGIN  
   SET @SQL = @SQL + "  I.PARTY_CODE,"  
   SET @SQL = @SQL + "  I.SYMBOL,"   
   SET @SQL = @SQL + "  I.SELL_BUY"  
  END   
 IF @ORDERBY = '1'  
  BEGIN        
   SET @SQL = @SQL + "  I.SYMBOL,"  
   SET @SQL = @SQL + "  I.PARTY_CODE,"  
   SET @SQL = @SQL + "  I.SELL_BUY"  
  END  
 IF @ORDERBY = '2'  
  BEGIN  
   SET @SQL = @SQL + "  I.CONTRACTNO,"  
   SET @SQL = @SQL + "  I.PARTY_CODE,"  
   SET @SQL = @SQL + "  I.SYMBOL,"  
   SET @SQL = @SQL + "  I.SELL_BUY"  
  END  
   PRINT @SQL    
 EXEC(@SQL)    
  
   SELECT *, SAUDA_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDADATE, 103), 109) FROM #TRADE_CONSOLIDATION    
 END    
  
 ELSE IF @CONSOLIDATE = 3    
  BEGIN    
   SET @SQL = "INSERT INTO #TRADE_CONSOLIDATION "    
   SET @SQL = @SQL + "( "    
   SET @SQL = @SQL + " PARTY_CODE, "    
   SET @SQL = @SQL + " ORGPARTY, "    
   SET @SQL = @SQL + " PARTIPANTCODE, "    
   SET @SQL = @SQL + " USER_ID, "    
   SET @SQL = @SQL + " CONTRACTNO, "    
   SET @SQL = @SQL + " SYMBOL, "    
   SET @SQL = @SQL + " INST_TYPE,"  
   SET @SQL = @SQL + " EXPIRYDATE,"  
   SET @SQL = @SQL + " STRIKE_PRICE,"  
   SET @SQL = @SQL + " OPTION_TYPE,"   
   SET @SQL = @SQL + " LONG_NAME,"    
    
   SET @SQL = @SQL + " DUMMY1, "    
   SET @SQL = @SQL + " SELL_BUY, "    
   SET @SQL = @SQL + " QTY, "    
   SET @SQL = @SQL + " MKTRATE, "    
   SET @SQL = @SQL + " NETRATE, "    
   SET @SQL = @SQL + " AMOUNT, "    
   SET @SQL = @SQL + " DEALTICKETPRICE, "    
   SET @SQL = @SQL + " NETAMOUNT, "    
   SET @SQL = @SQL + " PARTY_NAME, "    
   SET @SQL = @SQL + " R_MKTRATE, "    
   SET @SQL = @SQL + " R_BROKERAGE, "    
   SET @SQL = @SQL + " R_NETRATE, "    
   SET @SQL = @SQL + " STP_TYPE, "    
   SET @SQL = @SQL + " STP_FLAG, "    
   SET @SQL = @SQL + " CL_TYPE ,"   
   SET @SQL = @SQL + " PRODUCTCODE, "  
   SET @SQL = @SQL + " CHANNELTYPE "    
   SET @SQL = @SQL + ") "    
   SET @SQL = @SQL + " SELECT "    
   SET @SQL = @SQL + "  I.PARTY_CODE, "    
   SET @SQL = @SQL + "  ORGPARTY = I.PARTY_CODE, "    
   SET @SQL = @SQL + "  I.PARTICIPANTCODE, "    
   SET @SQL = @SQL + "  I.USER_ID, "    
   SET @SQL = @SQL + "  I.CONTRACTNO, "    
   SET @SQL = @SQL + "  I.SYMBOL, "    
   SET @SQL = @SQL + " I.INST_TYPE,"  
   SET @SQL = @SQL + " I.EXPIRYDATE,"  
   SET @SQL = @SQL + " I.STRIKE_PRICE,"  
   SET @SQL = @SQL + " I.OPTION_TYPE,"   
   SET @SQL = @SQL + "  S.LONG_NAME, "    
   SET @SQL = @SQL + "  I.DUMMY1, "    
   SET @SQL = @SQL + "  SELL_BUY = CASE WHEN I.SELL_BUY = 1 THEN 'BUY' ELSE 'SALE' END, "    
   SET @SQL = @SQL + "  QTY = SUM(I.TRADEQTY), "    
   SET @SQL = @SQL + "  MKTRATE = ((SUM(I.DUMMY2*I.TRADEQTY)) / (SUM(I.TRADEQTY))), "    
   SET @SQL = @SQL + "  NETRATE = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) "  
   SET @SQL = @SQL + " ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END), "    
   SET @SQL = @SQL + "  AMOUNT = SUM(I.TRADEQTY * I.PRICE), "    
   SET @SQL = @SQL + "  DEALTICKETPRICE = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.PRICE, 4) WHEN 2 THEN ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) "  
   SET @SQL = @SQL + " ELSE ROUND(((SUM(I.PRICE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END), "    
   SET @SQL = @SQL + "  NETAMOUNT = CONVERT(NUMERIC(12, 4), CASE ISNULL(R.NETRATE, 4) WHEN 2 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 2, 1) WHEN 4 THEN ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) "  
   SET @SQL = @SQL + " ELSE ROUND(((SUM(I.NETRATE*I.TRADEQTY)) / (SUM(I.TRADEQTY))), 4, 1) END), "    
   SET @SQL = @SQL + "  PARTY_NAME = C1.LONG_NAME, "    
   SET @SQL = @SQL + "  R_MKTRATE = ISNULL(R.PRICE, 4), "    
   SET @SQL = @SQL + "  R_BROKERAGE = ISNULL(R.BROKERAGE, 4), "    
   SET @SQL = @SQL + "  R_NETRATE = ISNULL(R.NETRATE, 4), "    
   SET @SQL = @SQL + "  STP_TYPE = C2.DUMMY6, "    
   SET @SQL = @SQL + "  STP_FLAG = 0,"    
   SET @SQL = @SQL + "  CL_TYPE = C1.CL_TYPE ,"   
    IF @CHANNELTYPE<>''  
  BEGIN  
   SET @SQL = @SQL + " PRODUCTCODE = PRODUCT_TYPE,CHANNELTYPE =(CASE WHEN DMA_FLAG=0 THEN 'BOTH' WHEN DMA_FLAG=2 THEN 'CARE' WHEN DMA_FLAG=1 THEN 'DMA' ELSE '' END)"   
  END  
 ELSE  
  BEGIN  
   SET @SQL = @SQL + " PRODUCTCODE = '',CHANNELTYPE =' '"   
  END     
   SET @SQL = @SQL + " FROM"    
   SET @SQL = @SQL + "  FOSETTLEMENT I, "    
   SET @SQL = @SQL + "  CLIENT2 C2"   
   IF @CHANNELTYPE<>''  
 BEGIN  
  SET @SQL = @SQL + "  LEFT JOIN MSAJAG..PRODUCT_MASTER PM"    
  SET @SQL = @SQL + "  ON (C2.PRODUCTCODE = PM.PRODUCT_CODE)"   
 END   
   SET @SQL = @SQL + "   LEFT JOIN INSTCLIENT_TBL R"    
   SET @SQL = @SQL + "    ON (C2.PARTY_CODE = R.PARTYCODE),"    
   SET @SQL = @SQL + "  CLIENT1 C1,"    
   SET @SQL = @SQL + "  (SELECT S1.CO_CODE, LONG_NAME = S1.LONG_NAME, S2.BSECODE"    
   SET @SQL = @SQL + "  FROM SCRIP1 S1 INNER JOIN SCRIP2 S2"    
   SET @SQL = @SQL + "  ON S1.CO_CODE = S2.CO_CODE AND S1.SERIES = S2.SERIES"    
   IF @FROMSYMBOL <> '' AND @TOSYMBOL <> ''    
    BEGIN    
     SET @SQL = @SQL + "  WHERE S2.BSECODE >= '" + @FROMSYMBOL + "'"    
     SET @SQL = @SQL + "  AND S2.BSECODE <= '" + @TOSYMBOL + "'"    
    END    
   SET @SQL = @SQL + "  ) S"    
   SET @SQL = @SQL + " WHERE"    
   SET @SQL = @SQL + "  C1.CL_CODE = C2.CL_CODE"    
   SET @SQL = @SQL + "  AND I.SYMBOL = S.BSECODE"    
   --SET @SQL = @SQL + "  AND C1.CL_TYPE = 'INS'"    
   SET @SQL = @SQL + "  AND I.PARTY_CODE = C2.PARTY_CODE"    
   SET @SQL = @SQL + "  AND CONVERT(VARCHAR(10), SAUDA_DATE, 103) = '" + @SAUDADATE + "'"    
   SET @SQL = @SQL + "  AND I.TRADEQTY > 0"    
   IF @SELL_BUY <> 0    
    BEGIN    
     SET @SQL = @SQL + "  AND I.SELL_BUY = " + CONVERT(VARCHAR(1), @SELL_BUY) + " "    
    END    
  
   IF @CONTRACTNO <> ''    
    BEGIN    
     SET @SQL = @SQL + "  AND I.CONTRACTNO = '" + @CONTRACTNO + "'"    
    END    
   IF @CONSOLIDATE = 0    
    BEGIN    
     SET @SQL = @SQL + "  AND I.DUMMY1 = 0"    
    END    
   ELSE IF @CONSOLIDATE = 1    
    BEGIN    
     SET @SQL = @SQL + "  AND I.DUMMY1 = 1"    
    END    
   IF @FROMPARTY <> '' AND @TOPARTY = ''    
    BEGIN    
     SET @SQL = @SQL + "  AND I.PARTY_CODE = '" + @FROMPARTY + "'"    
    END    
   ELSE IF @FROMPARTY <> '' AND @TOPARTY <> ''    
    BEGIN    
     SET @SQL = @SQL + "  AND I.PARTY_CODE >= '" + @FROMPARTY + "'"    
     SET @SQL = @SQL + "  AND I.PARTY_CODE <= '" + @TOPARTY + "'"    
    END    
   IF @FROMTERM <> ''    
    BEGIN    
     SET @SQL = @SQL + "  AND I.USER_ID >= '" + @FROMTERM + "'"    
    END    
   IF @TOTERM <> ''    
    BEGIN    
     SET @SQL = @SQL + "  AND I.USER_ID <= '" + @TOTERM + "'"    
    END    
   SET @SQL = @SQL + " GROUP BY"    
   SET @SQL = @SQL + "  I.PARTY_CODE,"    
   SET @SQL = @SQL + "  I.PARTICIPANTCODE,"    
   SET @SQL = @SQL + "  I.USER_ID,"    
   SET @SQL = @SQL + "  I.CONTRACTNO,"    
   SET @SQL = @SQL + "  I.SYMBOL,"    
   SET @SQL = @SQL + " I.INST_TYPE,"  
   SET @SQL = @SQL + " I.EXPIRYDATE,"  
   SET @SQL = @SQL + " I.STRIKE_PRICE,"  
   SET @SQL = @SQL + " I.OPTION_TYPE,"   
   SET @SQL = @SQL + "  S.LONG_NAME,"    
   SET @SQL = @SQL + "  I.SELL_BUY,"    
  IF @CHANNELTYPE<>''  
 BEGIN  
  SET @SQL = @SQL + "DMA_FLAG,PRODUCT_TYPE,"   
 END  
   SET @SQL = @SQL + "  C1.LONG_NAME,"    
   SET @SQL = @SQL + "  I.DUMMY1,"    
   SET @SQL = @SQL + "  R.PRICE,"    
   SET @SQL = @SQL + "  R.BROKERAGE,"    
   SET @SQL = @SQL + "  R.NETRATE,"    
   SET @SQL = @SQL + "  C2.DUMMY6,"    
   SET @SQL = @SQL + "  C1.CL_TYPE "    
   SET @SQL = @SQL + " ORDER BY"    
   SET @SQL = @SQL + "  I.PARTY_CODE,"    
   SET @SQL = @SQL + "  I.SYMBOL,"      
   SET @SQL = @SQL + "  I.CONTRACTNO,"    
   SET @SQL = @SQL + "  I.SELL_BUY"    
   EXEC(@SQL)    
 SELECT *, SAUDA_DATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDADATE, 103), 109) FROM #TRADE_CONSOLIDATION    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TRADE_CONSOLIDATION_PROC
-- --------------------------------------------------



CREATE  PROCEDURE [dbo].[TRADE_CONSOLIDATION_PROC]
(
	@SAUDA_DATE VARCHAR(11),
	@FROMPARTY VARCHAR(10),
	@TOPARTY VARCHAR(10),
	@SYMBOLSTR VARCHAR(8000),--COMBINING- SYMBOL|INSTYPE|EXPIRYDATE|STRIKEPRICE|OPTIONTYPE|DEALPRICE	
	@SELL_BUY INT,
	@ORGCONTRACTNO VARCHAR(7),
	@PRICE NUMERIC(18,4),
	@PARTIPANTCODE VARCHAR(15),
	@TERMINALID VARCHAR(10),
	@BRANCH_ID VARCHAR(10),
	@ORDER_NO VARCHAR(20),
	@LEVEL INT,
	@SPLITDATA VARCHAR(8000),
	@STATUSNAME VARCHAR(50),
	@FROMWHERE VARCHAR(100),
	@XMLDATA VARCHAR(8000),
	@SEL_POS INT,
	@EDITNETRATE INT = 0,
	@CONSOLFLAG SMALLINT = 0,
	@PROCESSON VARCHAR(20) = 'FOSETTLEMENT'
)
AS


/*---------------------------------------------------------------------------
	PROC NAME   : TRADE_CONSOLIDATION_PROC
	PROJECT	    : .NET NSEFO CONSOLIDATION
	DESCRIPTION : CALLING FOR THE TRADE/FOSETTLEMENT AFTER CONTRACT
				  SPLIT AND CONSOLIDATION

EXEC TRADE_CONSOLIDATION_PROC '13/06/2006', '0A141', 'ALWC000001', 'ACC|FUTSTK|29/06/2006|0| |698.7|750','1', '0000066', 698.7, '', '', '', '', 2, '', 'ASHOOKE/BROKER', 'FC.CONSOLIDATION .NET MODULE(/FC.INTERFACE/TRANDETAILS.ASPX)', '0A141,ALWC000001,750,698.7,699,1,|', '0', 0, 1 
EXEC PROC_TRADE_TRANSFER_ISETL 'JUN 13 2006', '0A141' , 'ALWC000001' , 'FUTSTK' , 'ACC' , 'JUN 29 2006' , 0.00 , '' , '1' , '' , '0000066' , '%' , '%', 750 , 750
------------------------------------------------------------------------------*/

	SET NOCOUNT OFF
	DECLARE
		@CHK_POS INT,
		@CHK_DATA VARCHAR(50),
		@XMLRECORD VARCHAR(100),
		@TOTALQTY INT,
		@ROWCOUNT INT,
		@STARTROW INT,
		@OUTER CURSOR,
		@INNER CURSOR,
		@CONT CURSOR,
		@CONT_PARTY VARCHAR(10),
		@CONT_SNO INT,
		@CONT_CLTYPE VARCHAR(3),
		@NEWCONTNO VARCHAR(7),
		@FPARTY VARCHAR(10),
		@TPARTY VARCHAR(10),
		@TRFQTY INT,
		@MKTRATE NUMERIC(18,4),
		@NETRATE NUMERIC(18,4),
		@F1 VARCHAR(50),
		@F2 VARCHAR(50),
		@QTY INT,
		@ORGQTY INT,
		@TQTY INT,
		@LQTY INT,
		@OUTERVAL VARCHAR(50),
		@SQL VARCHAR(2000),
		@BRKSQL VARCHAR(2000),
		@STTSQL VARCHAR(2000),
		@C1_STATUS INT,
		@C2_STATUS INT,
		@INNER_SPLIT VARCHAR(100),
		@SYMBOL VARCHAR(12),
		@INST_TYPE	VARCHAR(6) ,
		@EXPIRY_DATE VARCHAR(11),
		@STRIKE_PRICE MONEY,  
		@OPTION_TYPE VARCHAR(2) ,
		@DEALRATE NUMERIC(18,2),
		@TRADE_NO	VARCHAR(14),
		@ACTUALQTY	INT, 
		@BROK NUMERIC(18,8),
		@VAL_PERC VARCHAR(1),
		@FLAG INT,
		@CALCBROK VARCHAR(8000),
		@SQLC VARCHAR(8000)	,
		@SAUDA_DATE_11 VARCHAR(11),
		@EXPIRY_DATE_11 VARCHAR(11),
		@@FROMPARTY VARCHAR(10),
		@@TOPARTY VARCHAR(10),
		@@ORGQTY INT,
		@@TRFQTY INT,
		@@MKTRATE NUMERIC(18,4),
		@@NETRATE NUMERIC(18,4),
		@@CONTRACTNO VARCHAR(7),
		@@ORDER_NO VARCHAR(20),
		@@TRADE_NO VARCHAR(14),
		@CONSPARAM VARCHAR(8000)

	SET @CHK_POS = 1
	SET @SYMBOL = LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 1)))
	SET @INST_TYPE = LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 2)))
	SET @EXPIRY_DATE = LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 3)))
	SET @STRIKE_PRICE = CONVERT(MONEY,LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 4))))
	SET @OPTION_TYPE = LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 5)))
	SET @DEALRATE = CONVERT(NUMERIC(18, 2),LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 6))))
	SET @ACTUALQTY = CONVERT(INT,LTRIM(RTRIM(.DBO.PIECE(@SYMBOLSTR, '|', 7))))
	SET @TRADE_NO = ''
	SET @BROK = 0
	SET @VAL_PERC = ''
	SET @FLAG = 1

IF LEN(LTRIM(RTRIM(@XMLDATA))) > 0
	BEGIN
		CREATE TABLE #XMLDATA
		(
			FROMPARTY VARCHAR(10),
			TOPARTY VARCHAR(10),
			TRFQTY INT,
			MKTRATE NUMERIC(18,4),
			NETRATE NUMERIC(18,4),
			GENCONT TINYINT,
			CONTRACTNO VARCHAR(7),
			SNO INT IDENTITY(1,1)
		)
		CREATE TABLE #XMLDATA_ARR
		(
			FROMPARTY VARCHAR(10),
			TOPARTY VARCHAR(10),
			TRFQTY INT,
			MKTRATE NUMERIC(18,4),
			NETRATE NUMERIC(18,4),
			GENCONT TINYINT,
			CONTRACTNO VARCHAR(7),
			SNO INT IDENTITY(1,1)
		)
		WHILE 1 = 1
			BEGIN
				SET @XMLRECORD = .DBO.PIECE(@XMLDATA, '|', @CHK_POS)
				IF @XMLRECORD IS NOT NULL AND @XMLRECORD <> ''
					BEGIN
						INSERT INTO #XMLDATA (FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, GENCONT)
						VALUES (.DBO.PIECE(@XMLRECORD, ',', 1), .DBO.PIECE(@XMLRECORD, ',', 2), .DBO.PIECE(@XMLRECORD, ',', 3), .DBO.PIECE(@XMLRECORD, ',', 4), .DBO.PIECE(@XMLRECORD, ',', 5), .DBO.PIECE(@XMLRECORD, ',', 6))
						SET @CHK_POS = @CHK_POS + 1
					END
				ELSE
					BEGIN
						BREAK
					END
			END
			SET @CONT = CURSOR FOR
				SELECT SNO, TOPARTY FROM #XMLDATA WHERE GENCONT = 1
			OPEN @CONT
			FETCH NEXT FROM @CONT INTO @CONT_SNO, @CONT_PARTY
			WHILE @@FETCH_STATUS = 0
				BEGIN
					SELECT
						@CONT_CLTYPE = CL_TYPE
					FROM
						CLIENT1 C1,
						CLIENT2 C2
					WHERE
						C1.CL_CODE = C2.CL_CODE
						AND C2.PARTY_CODE = @CONT_PARTY
					IF @CONT_CLTYPE = 'PRO'
						BEGIN
							UPDATE
								#XMLDATA
							SET
								CONTRACTNO = '0000000'
							WHERE
								TOPARTY = @CONT_PARTY
								AND SNO = @CONT_SNO
							UPDATE
								#XMLDATA
							SET
								CONTRACTNO = '0000000'
							WHERE
								TOPARTY = @CONT_PARTY
								AND SNO <> @CONT_SNO
								AND GENCONT = 0
						END
					ELSE
						BEGIN
							SELECT
								@NEWCONTNO = CONVERT(VARCHAR(7), CONVERT(NUMERIC, CONTRACTNO) + 1)
							FROM
								CONTGEN
							WHERE
								CONVERT(DATETIME, @SAUDA_DATE, 103) BETWEEN START_DATE AND END_DATE

							UPDATE
								CONTGEN WITH (ROWLOCK)
							SET
								CONTRACTNO = @NEWCONTNO
							WHERE
								CONVERT(DATETIME, @SAUDA_DATE, 103) BETWEEN START_DATE AND END_DATE

							SELECT
								@NEWCONTNO = STUFF('0000000', 8 - LEN(@NEWCONTNO), LEN(@NEWCONTNO), @NEWCONTNO)

							UPDATE
								#XMLDATA
							SET
								CONTRACTNO = @NEWCONTNO
							WHERE
								TOPARTY = @CONT_PARTY
								AND SNO = @CONT_SNO

							UPDATE
								#XMLDATA
							SET
								CONTRACTNO = @NEWCONTNO
							WHERE
								TOPARTY = @CONT_PARTY
								AND SNO <> @CONT_SNO
								AND GENCONT = 0
								AND FROMPARTY = TOPARTY
						END
					FETCH NEXT FROM @CONT INTO @CONT_SNO, @CONT_PARTY
				END
			UPDATE
				#XMLDATA
			SET
				CONTRACTNO = ''
			WHERE
				CONTRACTNO IS NULL
			INSERT INTO #XMLDATA_ARR
				(FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, GENCONT, CONTRACTNO)
			SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, GENCONT, CONTRACTNO FROM #XMLDATA WHERE FROMPARTY = TOPARTY ORDER BY SNO
			INSERT INTO #XMLDATA_ARR
				(FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, GENCONT, CONTRACTNO)
			SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, GENCONT, CONTRACTNO FROM #XMLDATA WHERE FROMPARTY <> TOPARTY ORDER BY SNO

			TRUNCATE TABLE #XMLDATA
			INSERT INTO #XMLDATA (FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, GENCONT, CONTRACTNO) SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, GENCONT, CONTRACTNO FROM #XMLDATA_ARR ORDER BY SNO
			DROP TABLE #XMLDATA_ARR

					UPDATE
						#XMLDATA
					SET
						CONTRACTNO =(	SELECT
											ISNULL(MIN(CONTRACTNO), '')
										FROM
											FOSETTLEMENT I
										WHERE
											I.PARTY_CODE = #XMLDATA.TOPARTY
											AND I.SAUDA_DATE	BETWEEN CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)
											AND CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109) + ' 23:59:59'
											AND I.SYMBOL = @SYMBOL
											AND I.INST_TYPE = @INST_TYPE
											AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
											AND CONVERT(MONEY,I.STRIKE_PRICE) = @STRIKE_PRICE
											AND I.OPTION_TYPE =	@OPTION_TYPE
											AND I.SELL_BUY = @SELL_BUY
											AND I.DUMMY1 = 0
											AND I.TRADEQTY > 0
									)
					WHERE
						GENCONT = 0
						AND (CONTRACTNO = '' OR CONTRACTNO IS NULL)

				UPDATE
					#XMLDATA
				SET
					GENCONT = 1
				WHERE
					GENCONT = 0
					AND (CONTRACTNO = '' OR CONTRACTNO IS NULL)
	END
ELSE
	BEGIN
		SELECT 'NO RECORDS TO SPLIT'
		RETURN
	END
SELECT @TOTALQTY = SUM(TRFQTY) FROM #XMLDATA
SET @CHK_POS = 1
IF @SEL_POS > 0
	BEGIN
		CREATE TABLE #SELECTED (F1 VARCHAR(50), F2 VARCHAR(50), AVAILQTY INT)
		WHILE @CHK_POS <= @SEL_POS
			BEGIN
				SET @INNER_SPLIT = .DBO.PIECE(@SPLITDATA, '#', @CHK_POS)
				INSERT INTO #SELECTED SELECT .DBO.PIECE(@INNER_SPLIT, ',', 1), .DBO.PIECE(@INNER_SPLIT, ',', 2), 0
				SET @CHK_POS = @CHK_POS + 1
			END
		CREATE TABLE #SELECTED_A (F1 VARCHAR(50), F2 VARCHAR(50), QTY INT, ORGQTY INT)
		IF @LEVEL = 2
			BEGIN
				INSERT INTO #SELECTED_A (F1, F2, QTY, ORGQTY)
				SELECT I.CONTRACTNO, '%', SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOSETTLEMENT I, #SELECTED S
				WHERE
					I.CONTRACTNO = S.F1
					AND I.PARTY_CODE = @FROMPARTY
					AND I.SYMBOL = @SYMBOL
					AND I.INST_TYPE = @INST_TYPE
					AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
					AND CONVERT(MONEY,I.STRIKE_PRICE) = @STRIKE_PRICE
					AND I.OPTION_TYPE =	@OPTION_TYPE
					AND I.SELL_BUY = @SELL_BUY
				GROUP BY
					I.CONTRACTNO
			END
		ELSE IF @LEVEL = 3
			BEGIN
				INSERT INTO #SELECTED_A (F1, F2, QTY, ORGQTY)
				SELECT I.ORDER_NO, I.BRANCH_ID, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOSETTLEMENT I, #SELECTED S
				WHERE
					I.ORDER_NO = S.F1
					AND I.BRANCH_ID = S.F2
					AND I.PARTY_CODE = @FROMPARTY
					AND I.SYMBOL = @SYMBOL
					AND I.INST_TYPE = @INST_TYPE
					AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
					AND I.STRIKE_PRICE = @STRIKE_PRICE
					AND I.OPTION_TYPE =	@OPTION_TYPE
					AND I.CONTRACTNO = @ORGCONTRACTNO
					AND I.SELL_BUY = @SELL_BUY
				GROUP BY
					I.ORDER_NO,
					I.BRANCH_ID
			END
		ELSE IF @LEVEL = 102			-- FOR ORDER NOS. BUT TRADE TRANSFER
			BEGIN
						INSERT INTO #SELECTED_A (F1, F2, QTY, ORGQTY)
						SELECT I.ORDER_NO, I.BRANCH_ID, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOSETTLEMENT I, #SELECTED S
						WHERE
							I.ORDER_NO = S.F1
							AND I.BRANCH_ID = S.F2
							AND I.PARTY_CODE = @FROMPARTY
							AND I.SYMBOL = @SYMBOL
							AND I.INST_TYPE = @INST_TYPE
							AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
							AND CONVERT(MONEY,I.STRIKE_PRICE) = @STRIKE_PRICE
							AND I.OPTION_TYPE =	@OPTION_TYPE
							AND I.SELL_BUY = @SELL_BUY
						GROUP BY
							I.ORDER_NO,
							I.BRANCH_ID

			END
		ELSE IF @LEVEL = 4			-- FOR TRADE NOS
			BEGIN
				IF @ORDER_NO = ''
					BEGIN
						INSERT INTO #SELECTED_A (F1, F2, QTY, ORGQTY)
						SELECT I.TRADE_NO, I.BRANCH_ID, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOSETTLEMENT I, #SELECTED S
						WHERE
							I.TRADE_NO = S.F1
							AND I.BRANCH_ID = S.F2
							AND I.PARTY_CODE = @FROMPARTY
							AND I.SYMBOL = @SYMBOL
							AND I.INST_TYPE = @INST_TYPE
							AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
							AND I.STRIKE_PRICE = @STRIKE_PRICE
							AND I.OPTION_TYPE =	@OPTION_TYPE
							AND I.CONTRACTNO = @ORGCONTRACTNO
							AND I.SELL_BUY = @SELL_BUY
						GROUP BY
							I.TRADE_NO,
							I.BRANCH_ID
					END
				ELSE
					BEGIN
						INSERT INTO #SELECTED_A (F1, F2, QTY, ORGQTY)
						SELECT I.TRADE_NO, I.BRANCH_ID, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOSETTLEMENT I, #SELECTED S
						WHERE
							I.TRADE_NO = S.F1
							AND I.BRANCH_ID = S.F2
							AND I.PARTY_CODE = @FROMPARTY
							AND I.SYMBOL = @SYMBOL
							AND I.INST_TYPE = @INST_TYPE
							AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
							AND I.STRIKE_PRICE = @STRIKE_PRICE
							AND I.OPTION_TYPE =	@OPTION_TYPE
							AND I.CONTRACTNO = @ORGCONTRACTNO
							AND I.SELL_BUY = @SELL_BUY
							AND I.ORDER_NO = @ORDER_NO
						GROUP BY
							I.TRADE_NO,
							I.BRANCH_ID
					END
			END
		ELSE IF @LEVEL = 103			-- FOR TRADE NOS BUT TRADE TRANSFER
			BEGIN
						IF @ORDER_NO = ''
							BEGIN
								INSERT INTO #SELECTED_A (F1, F2, QTY, ORGQTY)
								SELECT I.TRADE_NO, I.BRANCH_ID, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOSETTLEMENT I, #SELECTED S
								WHERE
									I.TRADE_NO = S.F1
									AND I.BRANCH_ID = S.F2
									AND I.PARTY_CODE = @FROMPARTY
									AND I.SYMBOL = @SYMBOL
									AND I.INST_TYPE = @INST_TYPE
									AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
									AND I.STRIKE_PRICE = @STRIKE_PRICE
									AND I.OPTION_TYPE =	@OPTION_TYPE
									AND I.SELL_BUY = @SELL_BUY
								GROUP BY
									I.TRADE_NO,
									I.BRANCH_ID
							END
						ELSE
							BEGIN
								INSERT INTO #SELECTED_A (F1, F2, QTY, ORGQTY)
								SELECT I.TRADE_NO, I.BRANCH_ID, SUM(I.TRADEQTY), SUM(I.TRADEQTY) FROM FOSETTLEMENT I, #SELECTED S
								WHERE
									I.TRADE_NO = S.F1
									AND I.BRANCH_ID = S.F2
									AND I.PARTY_CODE = @FROMPARTY
									AND I.SYMBOL = @SYMBOL
									AND I.INST_TYPE = @INST_TYPE
									AND CONVERT(VARCHAR,I.EXPIRYDATE,103) = @EXPIRY_DATE
									AND I.STRIKE_PRICE = @STRIKE_PRICE
									AND I.OPTION_TYPE =	@OPTION_TYPE
									AND I.SELL_BUY = @SELL_BUY
									AND I.ORDER_NO = @ORDER_NO
								GROUP BY
									I.TRADE_NO,
									I.BRANCH_ID
							END

			END


		SELECT @ROWCOUNT = COUNT(1) FROM #SELECTED_A
		SET @STARTROW = 1
		SET @OUTER = CURSOR FOR
			SELECT F1, F2, QTY FROM #SELECTED_A
		OPEN @OUTER
		FETCH NEXT FROM @OUTER INTO @F1, @F2, @QTY
		WHILE @STARTROW <= @ROWCOUNT
			BEGIN
				IF @TOTALQTY < @QTY
					BEGIN
						UPDATE #SELECTED_A SET QTY = @TOTALQTY WHERE F1 = @F1 AND F2 = @F2
						BREAK
					END
				ELSE
					BEGIN
						SET @TOTALQTY = @TOTALQTY - @QTY
					END
				FETCH NEXT FROM @OUTER INTO @F1, @F2, @QTY
				SET @STARTROW = @STARTROW + 1
			END
		CLOSE @OUTER
		CREATE TABLE #DISTRIBUTED
		(
			FROMPARTY VARCHAR(10),
			TOPARTY VARCHAR(10),
			ORGQTY INT,
			TRFQTY INT,
			MKTRATE NUMERIC(18,4),
			NETRATE NUMERIC(18,4),
			CONTRACTNO VARCHAR(7),
			ORDER_NO VARCHAR(20),
			TRADE_NO VARCHAR(14),
			BRANCH_ID VARCHAR(10),
			NEWCONTRACTNO VARCHAR(7)
		)


		SET @OUTER = CURSOR FOR
			SELECT F1, F2, QTY, ORGQTY FROM #SELECTED_A
		SET @INNER = CURSOR FOR
			SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, ISNULL(CONTRACTNO, '') FROM #XMLDATA
		OPEN @OUTER
		FETCH NEXT FROM @OUTER INTO @F1, @F2, @QTY, @ORGQTY
		SET @C1_STATUS = @@FETCH_STATUS

		OPEN @INNER
		FETCH NEXT FROM @INNER INTO @FPARTY, @TPARTY, @TRFQTY, @MKTRATE, @NETRATE, @NEWCONTNO
		SET @C2_STATUS = @@FETCH_STATUS

		SET @LQTY = @QTY
		WHILE @C1_STATUS = 0 AND @C2_STATUS = 0
			BEGIN
				IF @LQTY > @TRFQTY
					BEGIN
						IF @LEVEL = 2
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @NETRATE, @F1, '%', '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 3
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @F1, '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 102
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @F1, '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 4
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, '%', @F1, @F2, @NEWCONTNO
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @ORDER_NO, @F1, @F2, @NEWCONTNO
								END
						ELSE IF @LEVEL = 103
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, '%', @F1, @F2, @NEWCONTNO
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @TRFQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @ORDER_NO, @F1, @F2, @NEWCONTNO
								END
						SET @LQTY = @LQTY - @TRFQTY
						FETCH NEXT FROM @INNER INTO @FPARTY, @TPARTY, @TRFQTY, @MKTRATE, @NETRATE, @NEWCONTNO
						SET @C2_STATUS = @@FETCH_STATUS
					END
				ELSE IF @LQTY < @TRFQTY AND @LQTY > 0
					BEGIN
						IF @LEVEL = 2
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @F1, '%', '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 3
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @F1, '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 102
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @F1, '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 4
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, '%', @F1, @F2, @NEWCONTNO
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @ORDER_NO, @F1, @F2, @NEWCONTNO
								END
						ELSE IF @LEVEL = 103
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, '%', @F1, @F2, @NEWCONTNO
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @ORDER_NO, @F1, @F2, @NEWCONTNO
								END
						SET @TRFQTY = @TRFQTY - @LQTY
						FETCH NEXT FROM @OUTER INTO @F1, @F2, @QTY, @ORGQTY
						SET @C1_STATUS = @@FETCH_STATUS
						SET @LQTY = @QTY
					END
				ELSE IF @LQTY = @TRFQTY
					BEGIN
						IF @LEVEL = 2
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @F1, '%', '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 3
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @F1, '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 102
							INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @F1, '%', @F2, @NEWCONTNO
						ELSE IF @LEVEL = 4
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, '%', @F1, @F2, @NEWCONTNO
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @ORDER_NO, @F1, @F2, @NEWCONTNO
								END
						ELSE IF @LEVEL = 103
							IF @ORDER_NO = ''
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, '%', @F1, @F2, @NEWCONTNO
								END
							ELSE
								BEGIN
									INSERT INTO #DISTRIBUTED (FROMPARTY, TOPARTY, ORGQTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ORDER_NO, TRADE_NO, BRANCH_ID, NEWCONTRACTNO) SELECT @FPARTY, @TPARTY, @ORGQTY, @LQTY, @MKTRATE, @NETRATE, @ORGCONTRACTNO, @ORDER_NO, @F1, @F2, @NEWCONTNO
								END
						FETCH NEXT FROM @OUTER INTO @F1, @F2, @QTY, @ORGQTY
						SET @C1_STATUS = @@FETCH_STATUS
						SET @LQTY = @QTY
						
						FETCH NEXT FROM @INNER INTO @FPARTY, @TPARTY, @TRFQTY, @MKTRATE, @NETRATE, @NEWCONTNO
						SET @C2_STATUS = @@FETCH_STATUS
					END
			END
		CLOSE @OUTER
		CLOSE @INNER

		PRINT 'CAME'
		DEALLOCATE @INNER
		SET @OUTER = CURSOR FOR
			SELECT LTRIM(RTRIM(FROMPARTY)), LTRIM(RTRIM(TOPARTY)), ORGQTY, TRFQTY, MKTRATE, NETRATE, LTRIM(RTRIM(CONTRACTNO)), LTRIM(RTRIM(ORDER_NO)), LTRIM(RTRIM(TRADE_NO)), LTRIM(RTRIM(BRANCH_ID)), LTRIM(RTRIM(NEWCONTRACTNO)) FROM #DISTRIBUTED
		OPEN @OUTER
		FETCH NEXT FROM @OUTER INTO @@FROMPARTY, @@TOPARTY, @@ORGQTY, @@TRFQTY, @@MKTRATE, @@NETRATE, @@CONTRACTNO, @@ORDER_NO, @@TRADE_NO, @BRANCH_ID, @NEWCONTNO
		
		WHILE @@FETCH_STATUS = 0
			BEGIN
				
				IF @ORDER_NO='' BEGIN SET @ORDER_NO ='%'END
				IF @TRADE_NO ='' BEGIN SET @TRADE_NO = '%' END 		
		
				SELECT @SAUDA_DATE_11 = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)
				SELECT @EXPIRY_DATE_11 = CONVERT(VARCHAR(11), CONVERT(DATETIME,@EXPIRY_DATE, 103), 109)

				IF @LEVEL = 101 OR @LEVEL = 102 OR @LEVEL = 103
					BEGIN						
						IF @PROCESSON = 'SETTLEMENT'
							BEGIN
								EXEC PROC_TRADE_TRANSFER_SETL  @SAUDA_DATE_11 , @FPARTY , @TPARTY , @INST_TYPE , @SYMBOL , @EXPIRY_DATE_11 , @STRIKE_PRICE , @OPTION_TYPE , @SELL_BUY ,  @PARTIPANTCODE , @@CONTRACTNO , @@ORDER_NO , @@TRADE_NO ,  @ACTUALQTY , @@TRFQTY, 'BROKER', '', ''
							END
						ELSE
							BEGIN
								EXEC PROC_TRADE_TRANSFER_ISETL @SAUDA_DATE_11 , @FPARTY , @TPARTY , @INST_TYPE , @SYMBOL , @EXPIRY_DATE_11 , @STRIKE_PRICE , @OPTION_TYPE , @SELL_BUY ,  @PARTIPANTCODE , @@CONTRACTNO , @@ORDER_NO , @@TRADE_NO ,  @ACTUALQTY , @@TRFQTY, 'BROKER', '', '', '', @CONSOLFLAG
							END
						
						EXEC PROC_TRADE_TRANSFER_RECAL  @SAUDA_DATE_11 , @FROMPARTY , @INST_TYPE , @SYMBOL , @EXPIRY_DATE_11 , @STRIKE_PRICE , @OPTION_TYPE,'',''

						EXEC STT_CHARGES_FINAL @SAUDA_DATE_11, @TPARTY , @TPARTY 

					END
				ELSE
					BEGIN

						EXEC PROC_TRADE_TRANSFER_ISETL  @SAUDA_DATE_11, @FPARTY , @TPARTY , @INST_TYPE , @SYMBOL , @EXPIRY_DATE_11 , @STRIKE_PRICE , @OPTION_TYPE , @SELL_BUY ,  @PARTIPANTCODE , @@CONTRACTNO , @@ORDER_NO , @@TRADE_NO ,  @ACTUALQTY , @@TRFQTY, 'BROKER', '', '', '', @CONSOLFLAG
						--SET @CONSPARAM = ','+ @@CONTRACTNO + ',' +  @FPARTY + ','+ @SYMBOL + ','+ @OPTION_TYPE + ','+ @SAUDA_DATE_11 + ','+ CONVERT(VARCHAR(11), CONVERT(DATETIME,@EXPIRY_DATE, 103), 103) + ','+ @INST_TYPE + ',0,' + CONVERT(VARCHAR,@LEVEL) + ','+ CONVERT(VARCHAR,@SELL_BUY) + ','+ CONVERT(VARCHAR,@DEALRATE) + ','+ CONVERT(VARCHAR,@PRICE) + ',0,'+ CONVERT(VARCHAR,@STRIKE_PRICE) + ','+ @PARTIPANTCODE 
						SET @CONSPARAM = ','+ @@CONTRACTNO + ',' +  @FPARTY + ',,'+ @SYMBOL + ','+ @INST_TYPE + ','+ CONVERT(VARCHAR(11), CONVERT(DATETIME,@EXPIRY_DATE, 103), 103) + ','+ CONVERT(VARCHAR,@STRIKE_PRICE) + ','+ @OPTION_TYPE + ','+ @SAUDA_DATE_11 + ',0,' + CONVERT(VARCHAR,@LEVEL) + ','+ CONVERT(VARCHAR,@SELL_BUY) + ','+ CONVERT(VARCHAR,@PRICE) + ','+ CONVERT(VARCHAR,@DEALRATE) + ','+ .DBO.PIECE(@XMLRECORD, ',', 5) +','+ @PARTIPANTCODE
						
						EXEC CONSOLIDATETRANS  @CONSPARAM ,'Y', @STATUSNAME ,@FROMWHERE

						EXEC STT_CHARGES_FINAL @SAUDA_DATE_11, @TPARTY , @TPARTY 					
					END
			
				FETCH NEXT FROM @OUTER INTO @@FROMPARTY, @@TOPARTY, @@ORGQTY, @@TRFQTY, @@MKTRATE, @@NETRATE, @@CONTRACTNO, @@ORDER_NO, @@TRADE_NO, @BRANCH_ID, @NEWCONTNO
			END
	END
ELSE
	BEGIN
		CREATE TABLE #XMLDATA_A
		(
			FROMPARTY VARCHAR(10),
			TOPARTY VARCHAR(10),
			TRFQTY INT,
			MKTRATE NUMERIC(18,4),
			NETRATE NUMERIC(18,4),
			CONTRACTNO VARCHAR(7),
			NEWCONTRACT VARCHAR(7)
		)
		INSERT INTO #XMLDATA_A (FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, NEWCONTRACT)
		SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, @ORGCONTRACTNO, CONTRACTNO FROM #XMLDATA
		DECLARE
			@@XMLCURSOR CURSOR,
			@@MKRATE NUMERIC(18, 4),
			@@NTRATE NUMERIC(18, 4)
		SET @@XMLCURSOR = CURSOR FOR
			SELECT FROMPARTY, TOPARTY, TRFQTY, MKTRATE, NETRATE, CONTRACTNO, ISNULL(NEWCONTRACT, '') FROM #XMLDATA_A
		OPEN @@XMLCURSOR
		FETCH NEXT FROM @@XMLCURSOR INTO @FPARTY, @TPARTY, @TRFQTY, @@MKRATE, @@NTRATE, @@CONTRACTNO, @NEWCONTNO
		WHILE @@FETCH_STATUS = 0
			BEGIN
				IF @ORDER_NO='' BEGIN SET @ORDER_NO ='%'END
				IF @TRADE_NO ='' BEGIN SET @TRADE_NO = '%' END 
				SELECT @SAUDA_DATE_11 = CONVERT(VARCHAR(11), CONVERT(DATETIME, @SAUDA_DATE, 103), 109)
				SELECT @EXPIRY_DATE_11 = CONVERT(VARCHAR(11), CONVERT(DATETIME,@EXPIRY_DATE, 103), 109)

				IF @LEVEL = 101 OR @LEVEL = 102 OR @LEVEL = 103
					BEGIN
						IF @PROCESSON = 'SETTLEMENT'
							BEGIN
								EXEC PROC_TRADE_TRANSFER_SETL  @SAUDA_DATE_11, @FPARTY , @TPARTY , @INST_TYPE , @SYMBOL , @EXPIRY_DATE_11 , @STRIKE_PRICE , @OPTION_TYPE , @SELL_BUY ,  @PARTIPANTCODE , @@CONTRACTNO , @ORDER_NO , @TRADE_NO ,  @ACTUALQTY , @TRFQTY, 'BROKER', '', ''
							END
						ELSE
							BEGIN
								EXEC PROC_TRADE_TRANSFER_ISETL  @SAUDA_DATE_11, @FPARTY , @TPARTY , @INST_TYPE , @SYMBOL , @EXPIRY_DATE_11 , @STRIKE_PRICE , @OPTION_TYPE , @SELL_BUY ,  @PARTIPANTCODE , @@CONTRACTNO , @ORDER_NO , @TRADE_NO ,  @ACTUALQTY , @TRFQTY, 'BROKER', '', '', '', @CONSOLFLAG
							END
						
						EXEC PROC_TRADE_TRANSFER_RECAL  @SAUDA_DATE_11 , @FROMPARTY , @INST_TYPE , @SYMBOL , @EXPIRY_DATE_11 , @STRIKE_PRICE , @OPTION_TYPE,'',''
						
						EXEC STT_CHARGES_FINAL @SAUDA_DATE_11, @TPARTY , @TPARTY 
						
					END
				ELSE
					BEGIN
						PRINT 'CAME'
						EXEC PROC_TRADE_TRANSFER_ISETL @SAUDA_DATE_11, @FPARTY, @TPARTY, @INST_TYPE, @SYMBOL, @EXPIRY_DATE_11, @STRIKE_PRICE, @OPTION_TYPE, @SELL_BUY, @PARTIPANTCODE, @@CONTRACTNO, @ORDER_NO, @TRADE_NO, @ACTUALQTY, @TRFQTY, 'BROKER', '', '', '', @CONSOLFLAG
						SET @CONSPARAM = ','+ @@CONTRACTNO + ',' +  @FPARTY + ',,'+ @SYMBOL + ','+ @INST_TYPE + ','+ CONVERT(VARCHAR(11), CONVERT(DATETIME,@EXPIRY_DATE, 103), 103) + ','+ CONVERT(VARCHAR,@STRIKE_PRICE) + ','+ @OPTION_TYPE + ','+ @SAUDA_DATE_11 + ',0,' + CONVERT(VARCHAR,@LEVEL) + ','+ CONVERT(VARCHAR,@SELL_BUY) + ','+ CONVERT(VARCHAR,@PRICE) + ','+ CONVERT(VARCHAR,@DEALRATE) + ','+ .DBO.PIECE(@XMLRECORD, ',', 5) +','+ @PARTIPANTCODE
						EXEC CONSOLIDATETRANS  @CONSPARAM ,'Y', @STATUSNAME ,@FROMWHERE
					
						EXEC STT_CHARGES_FINAL @SAUDA_DATE_11, @TPARTY , @TPARTY 
					END
				
				FETCH NEXT FROM @@XMLCURSOR INTO @FPARTY, @TPARTY, @TRFQTY, @@MKRATE, @@NTRATE, @@CONTRACTNO, @NEWCONTNO
			END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.UPBROKSETT
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[UPBROKSETT]   
@SAUDA_DATE VARCHAR(11),  
@PARTY_CODE VARCHAR(10),  
@OPTION_TYPE VARCHAR(2),  
@INST_TYPE VARCHAR(6),  
@SYMBOL VARCHAR(12),  
@EXPIRYDATE VARCHAR(11),  
@STRIKE_PRICE MONEY  
AS  
       UPDATE FOSETTLEMENT SET   
         
        TABLE_NO = FOSETTBROKVIEWFINAL.TABLE_NO,LINE_NO = FOSETTBROKVIEWFINAL.LINE_NO,  
       VAL_PERC = FOSETTBROKVIEWFINAL.VAL_PERC,NORMAL = FOSETTBROKVIEWFINAL.NORMAL,  
       DAY_PUC =  FOSETTBROKVIEWFINAL.DAY_PUC,DAY_SALES = FOSETTBROKVIEWFINAL.DAY_SALES,  
       SETT_PURCH = FOSETTBROKVIEWFINAL.SETT_PURCH,SETT_SALES = FOSETTBROKVIEWFINAL.SETT_SALES,  
       BROKAPPLIED = FOSETTBROKVIEWFINAL.BROKAPPLIED ,NETRATE = (CASE WHEN FOSETTBROKVIEWFINAL.SELL_BUY = 1   
                      THEN FOSETTBROKVIEWFINAL.PRICE + FOSETTBROKVIEWFINAL.BROKAPPLIED   
       ELSE FOSETTBROKVIEWFINAL.PRICE - FOSETTBROKVIEWFINAL.BROKAPPLIED   
          END),    
          
         AMOUNT = FOSETTBROKVIEWFINAL.TRADEQTY * (CASE WHEN FOSETTBROKVIEWFINAL.SELL_BUY = 1   
             THEN ( FOSETTBROKVIEWFINAL.PRICE + FOSETTBROKVIEWFINAL.BROKAPPLIED )  
                ELSE ( FOSETTBROKVIEWFINAL.PRICE - FOSETTBROKVIEWFINAL.BROKAPPLIED )  
          END),   
       INS_CHRG = FOSETTBROKVIEWFINAL.INS_CHRG,
	TURN_TAX = FOSETTBROKVIEWFINAL.TURN_TAX,
	OTHER_CHRG = FOSETTBROKVIEWFINAL.OTHER_CHRG,  
       SEBI_TAX= FOSETTBROKVIEWFINAL.SEBI_TAX,BROKER_CHRG = FOSETTBROKVIEWFINAL.BROKER_CHRG,  
       SERVICE_TAX = ((FLOOR ( (FOSETTBROKVIEWFINAL.BROKAPPLIED * FOSETTBROKVIEWFINAL.TRADEQTY*FOSETTBROKVIEWFINAL.SERVICE_TAX/100 *   
        POWER(10,FOSETTBROKVIEWFINAL.ROUND_TO) + FOSETTBROKVIEWFINAL.ROFIG + FOSETTBROKVIEWFINAL.ERRNUM  ) /    
        (FOSETTBROKVIEWFINAL.ROFIG + FOSETTBROKVIEWFINAL.NOZERO)) * (FOSETTBROKVIEWFINAL.ROFIG + FOSETTBROKVIEWFINAL.NOZERO) )   
         / POWER(10,FOSETTBROKVIEWFINAL.ROUND_TO)),  
       TRADE_AMOUNT = FOSETTBROKVIEWFINAL.TRADEQTY * FOSETTBROKVIEWFINAL.PRICE  
       FROM FOSETTBROKVIEWFINAL  
       WHERE  
            FOSETTLEMENT.PARTY_CODE = FOSETTBROKVIEWFINAL.PARTY_CODE
            AND	
            FOSETTLEMENT.INST_TYPE = FOSETTBROKVIEWFINAL.INST_TYPE
            AND
            FOSETTLEMENT.SYMBOL = FOSETTBROKVIEWFINAL.SYMBOL
            AND
            CONVERT(VARCHAR,FOSETTLEMENT.EXPIRYDATE,103) = CONVERT(VARCHAR,FOSETTBROKVIEWFINAL.EXPIRYDATE,103)
            AND
            FOSETTLEMENT.STRIKE_PRICE = FOSETTBROKVIEWFINAL.STRIKE_PRICE
            AND
            FOSETTLEMENT.OPTION_TYPE = FOSETTBROKVIEWFINAL.OPTION_TYPE
            AND
            CONVERT(VARCHAR,FOSETTLEMENT.SAUDA_DATE,103) = CONVERT(VARCHAR,FOSETTBROKVIEWFINAL.SAUDA_DATE,103)
            AND
            FOSETTBROKVIEWFINAL.PARTY_CODE = @PARTY_CODE  
            AND  
            FOSETTBROKVIEWFINAL.OPTION_TYPE = @OPTION_TYPE   
            AND  
            FOSETTBROKVIEWFINAL.INST_TYPE = @INST_TYPE  
            AND  
            FOSETTBROKVIEWFINAL.SYMBOL = @SYMBOL  
            AND   
            LEFT(CONVERT(VARCHAR,FOSETTBROKVIEWFINAL.EXPIRYDATE,109),11) = @EXPIRYDATE  
            AND  
            FOSETTBROKVIEWFINAL.STRIKE_PRICE = @STRIKE_PRICE  
            AND  
            FOSETTLEMENT.STATUS <>  'E'     
            AND 
            FOSETTLEMENT.SAUDA_DATE LIKE @SAUDA_DATE + '%'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_IMPORT_EXCHANGE_FILE
-- --------------------------------------------------
CREATE PROC [dbo].[USP_IMPORT_EXCHANGE_FILE]  
(  
  @PROGID VARCHAR(11),  
  @TRADEDATE VARCHAR(11),  
  @FILETYPE VARCHAR(10),  
  @UNAME VARCHAR(25),  
  @INTMODE INT     
)  
/*  
 SELECT * FROM CLASSFILEUPD   
 EXEC ACECOMM..USP_IMPORT_EXCHANGE_FILE '4639232012', '24/04/2012','CONTRACT MASTER FILE','DEMO',1
*/  
AS  
  
BEGIN   
  
INSERT INTO   
 CLASSFILEUPD  
SELECT   
 FILEDATA,PROGID FROM CLASSAPP..FILE_DATA WHERE PROGID = @PROGID   
   
IF(SELECT COUNT(1) FROM CLASSFILEUPD WHERE SESSION_ID = @PROGID) > 0  
 BEGIN  
 EXEC PR_IMPORT_FILE @FILETYPE, @PROGID, @UNAME, @TRADEDATE, @INTMODE  
 END  
   
DELETE FROM CLASSFILEUPD WHERE SESSION_ID = @PROGID    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CHECKBLOCKEDREPORTS
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_CHECKBLOCKEDREPORTS]
                @RPTPATH VARCHAR(100)
                
AS

  SET TRANSACTION ISOLATION  LEVEL  READ  UNCOMMITTED
  
  SET NOCOUNT ON
        
  IF (SELECT COUNT(1)
      FROM   TBLREPORTS_BLOCKED WITH (NOLOCK)
      WHERE  BLOCK_FLAG = 1
             AND LTRIM(RTRIM(FLDPATH)) = LEFT(LTRIM(RTRIM(@RPTPATH)),LEN(FLDPATH))) > 0 
  BEGIN 
    SELECT '<FONT COLOR = RED><B>THIS OPTION HAS BEEN DISABLED TEMPORARILY!! PLEASE CONTACT SYSTEM ADMINISTRATOR!!</B></FONT>'
  END 
  ELSE 
  BEGIN 
    SELECT '' 
  END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CHECKPROCESSFORTODAY
-- --------------------------------------------------

CREATE  PROC [dbo].[V2_CHECKPROCESSFORTODAY]  
(  
           @PROCESSFLAG VARCHAR(15),  
    @PROCESSDATE VARCHAR(11)  
)  
AS  

DECLARE @VBBFLAG INT

SELECT @VBBFLAG = 0
IF (SELECT ISNULL(COUNT(1),0) FROM (SELECT TOP 1 SP_PARTY_CODE FROM SCHEME_MAPPING) A) > 0 
	SELECT @VBBFLAG = 1

 SELECT FLAG = (CASE   
                   WHEN @PROCESSFLAG = 'VBB'  
                        AND IMPORT_TRADE > 0 THEN 1  
                   WHEN (@PROCESSFLAG = 'BILLGEN' OR @PROCESSFLAG = 'VALANGEN')
                        AND POSITIONFILE > 0  AND VBB >= @VBBFLAG THEN 1  
                   WHEN @PROCESSFLAG = 'CONTRACT'  
                        AND IMPORT_TRADE > 0  AND VBB >= @VBBFLAG THEN 1  
                   WHEN @PROCESSFLAG = 'POSTING'  
                        AND BILLING > 0 THEN 1  
                   WHEN @PROCESSFLAG = 'CLOSE'  
                        AND POSTING > 0 THEN 1  
                   ELSE 0  
                 END),  
         PROCESSNAME = (CASE   
                          WHEN @PROCESSFLAG = 'VBB' THEN 'IMPORT_TRADE'  
                          WHEN (@PROCESSFLAG = 'BILLGEN' OR @PROCESSFLAG = 'VALANGEN') THEN 
							   (CASE WHEN VBB < @VBBFLAG 
									 THEN 'VBB PROCESS'
									 ELSE 'POSITION FILE'  
							    END)			
                          WHEN @PROCESSFLAG = 'CONTRACT' THEN
								(CASE 
									 WHEN VBB < @VBBFLAG 
									 THEN 'VBB PROCESS'
									 ELSE 'BILLGEN'  
							    END)  
                          WHEN @PROCESSFLAG = 'POSTING' THEN 'CONTRACT'  
                          WHEN @PROCESSFLAG = 'CLOSE' THEN 'POSTING'  
                          ELSE 'SOME PROCESS'  
                        END)  
  FROM     
 V2_BUSINESS_PROCESS  
  WHERE    
 LEFT(BUSINESS_DATE,11) = @PROCESSDATE  
 AND OPEN_CLOSE = 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONTSECTION
-- --------------------------------------------------
  
CREATE PROCEDURE [V2_CONTSECTION] (  
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),  
 @SAUDA_DATE VARCHAR(11),  
 @FROMPARTY_CODE VARCHAR(10),  
 @TOPARTY_CODE VARCHAR(10),  
 @FROMBRANCH VARCHAR(10),  
 @TOBRANCH VARCHAR(10),  
 @FROMSUB_BROKER VARCHAR(10),  
 @TOSUB_BROKER VARCHAR(10),  
 @FROMCONTRACTNO VARCHAR(12),  
 @TOCONTRACTNO VARCHAR(12),  
 @CONTFLAG VARCHAR(10),  
 @BOUNCEDFLAG INT = 0,  
 @TOSAUDA_DATE VARCHAR(11) = ''  
 )  
 --EXEC V2_CONTSECTION 'BROKER','BROKER','MAY 26 2011','0','ZZZ','','ZZZZZZZ','','ZZZZZZZ','','','CONTRACT','0'       
AS  
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED  
  
DECLARE @COLNAME VARCHAR(6)  
  
SELECT @COLNAME = ''  
  
IF (@CONTFLAG = 'CONTRACT')  
 SELECT @COLNAME = RPT_CODE  
 FROM V2_CONTRACTPRINT_SETTING  
 WHERE RPT_TYPE = 'ORDER'  
  AND RPT_PRINTFLAG = 1  
ELSE  
 SELECT @COLNAME = RPT_CODE  
 FROM V2_CONTRACTPRINT_SETTING  
 WHERE RPT_TYPE = 'ORDER'  
  AND RPT_PRINTFLAG_DIGI = 1  
  
IF @FROMCONTRACTNO = ''  
BEGIN  
 SET @FROMCONTRACTNO = 000000  
END  
  
IF @TOCONTRACTNO = ''  
BEGIN  
 SET @TOCONTRACTNO = 99999999  
END  
  
IF @TOSAUDA_DATE = ''  
BEGIN  
 SET @TOSAUDA_DATE = @SAUDA_DATE  
END  
  
/*------------------  CANNED CONTRACT PLUG IN ------------------------*/  
/*IF EXISTS (  
  SELECT TOP 1 PARTY_CODE  
  FROM CONTRACT_DATA(NOLOCK)  
  WHERE SAUDA_DATE >= @SAUDA_DATE  
  )  
BEGIN  
 EXEC V2_CONTSECTION_DETAIL @STATUSID,  
  @STATUSNAME,  
  @SAUDA_DATE,  
  @FROMPARTY_CODE,  
  @TOPARTY_CODE,  
  @FROMBRANCH,  
  @TOBRANCH,  
  @FROMSUB_BROKER,  
  @TOSUB_BROKER,  
  @FROMCONTRACTNO,  
  @TOCONTRACTNO,  
  @CONTFLAG,  
  @BOUNCEDFLAG,  
  @TOSAUDA_DATE  
  
 RETURN  
END */ 
  
/*---------------------------------------------------------------------*/  
DECLARE @INTHISTFLAG INT  
  
/*  
SELECT @INTHISTFLAG = COUNT(1)  
FROM PRADNYA..DATAIN_HISTORY_FOSETTLEMENT_BSECURFO(NOLOCK)  
WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'  
*/  
  
SET @INTHISTFLAG = CONVERT(INT, ISNULL(@INTHISTFLAG, 0))  
  
SELECT DISTINCT PARTY_CODE  
INTO #PARTYLIST  
FROM FOSETTLEMENT(NOLOCK)  
WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'  
 AND PARTY_CODE >= @FROMPARTY_CODE  
 AND PARTY_CODE <= @TOPARTY_CODE  
  
  
IF @INTHISTFLAG > 0  
BEGIN  
 INSERT INTO #PARTYLIST  
 SELECT DISTINCT PARTY_CODE  
 FROM PRADNYA..HISTORY_FOSETTLEMENT_BSECURFO(NOLOCK)  
 WHERE SAUDA_DATE LIKE @SAUDA_DATE + '%'  
  AND PARTY_CODE >= @FROMPARTY_CODE  
  AND PARTY_CODE <= @TOPARTY_CODE  
END  
  
CREATE TABLE #PARTY (PARTYCODE VARCHAR(10))  
  
IF @BOUNCEDFLAG = 0  
 INSERT INTO #PARTY  
 SELECT DISTINCT PARTY_CODE  
 FROM #PARTYLIST(NOLOCK)  
ELSE  
 INSERT INTO #PARTY  
 SELECT DISTINCT PARTY_CODE  
 FROM TBL_ECNBOUNCED(NOLOCK)  
 WHERE SAUDA_DATE BETWEEN @SAUDA_DATE  
   AND @TOSAUDA_DATE + ' 23:59:59'  
  
  
SELECT C2.PARTY_CODE,  
 C1.LONG_NAME,  
 C1.L_ADDRESS1,  
 C1.L_ADDRESS2,  
 C1.L_ADDRESS3,  
 C1.L_CITY,  
 C1.L_STATE,  
 C1.L_ZIP,  
 C1.BRANCH_CD,  
 C1.SUB_BROKER,  
 C1.TRADER,  
 C1.PAN_GIR_NO,  
 C1.OFF_PHONE1,  
 C1.OFF_PHONE2,  
 PRINTF,  
 MAPIDID,  
 UCC_CODE,  
 C2.SERVICE_CHRG,  
 BROKERNOTE,  
 TURNOVER_TAX,  
 SEBI_TURN_TAX,  
 C2.OTHER_CHRG,  
 INSURANCE_CHRG,  
 SEBI_NO = FD_CODE  
INTO #CLIENTMASTER  
FROM CLIENT_PRINT_SETTINGS CP(NOLOCK),  
 CLIENT1 C1 WITH (NOLOCK),  
 CLIENT2 C2 WITH (NOLOCK)  
LEFT JOIN UCC_CLIENT UC WITH (NOLOCK)  
 ON C2.PARTY_CODE = UC.PARTY_CODE,  
  #PARTY P  
WHERE C2.CL_CODE = C1.CL_CODE  
 AND C2.PARTY_CODE BETWEEN @FROMPARTY_CODE  
  AND @TOPARTY_CODE  
 AND @STATUSNAME = (  
  CASE   
   WHEN @STATUSID = 'BRANCH'  
    THEN C1.BRANCH_CD  
   WHEN @STATUSID = 'SUBBROKER'  
    THEN C1.SUB_BROKER  
   WHEN @STATUSID = 'TRADER'  
    THEN C1.TRADER  
   WHEN @STATUSID = 'FAMILY'  
    THEN C1.FAMILY  
   WHEN @STATUSID = 'AREA'  
    THEN C1.AREA  
   WHEN @STATUSID = 'REGION'  
    THEN C1.REGION  
   WHEN @STATUSID = 'CLIENT'  
    THEN C2.PARTY_CODE  
   ELSE 'BROKER'  
   END  
  )  
 AND BRANCH_CD >= @FROMBRANCH  
 AND BRANCH_CD <= @TOBRANCH  
 AND SUB_BROKER >= @FROMSUB_BROKER  
 AND SUB_BROKER <= @TOSUB_BROKER  
 AND C2.PARTY_CODE IN (  
  SELECT PARTY_CODE  
  FROM #PARTYLIST  
  )  
 AND PRINTF = CP.PRINT_FLAG  
 --AND CP.VALID_REPORT LIKE '%' + @CONTFLAG + '%'      
 AND CP.VALID_REPORT LIKE (  
  CASE   
   WHEN @BOUNCEDFLAG = 0  
    THEN '%' + @CONTFLAG + '%'  
   ELSE CP.VALID_REPORT  
   END  
  )  
 AND C2.PARTY_CODE = P.PARTYCODE  
  
  
IF @BOUNCEDFLAG = 1  
BEGIN  
 UPDATE #CLIENTMASTER  
 SET PRINTF = 0  
 FROM TBL_ECNBOUNCED T  
 WHERE T.PARTY_CODE = #CLIENTMASTER.PARTY_CODE  
  AND PRINTF = 1  
END  
  
  
SELECT CONTRACTNO,  
 BILLNO,  
 TRADE_NO,  
 PARTY_CODE,  
 INST_TYPE,  
 SYMBOL,  
 SEC_NAME,  
 EXPIRYDATE,  
 STRIKE_PRICE,  
 OPTION_TYPE,  
 USER_ID,  
 PRO_CLI,  
 O_C_FLAG,  
 C_U_FLAG,  
 TRADEQTY,  
 AUCTIONPART,  
 MARKETTYPE,  
 SERIES,  
 ORDER_NO,  
 PRICE,  
 SAUDA_DATE,  
 TABLE_NO,  
 LINE_NO,  
 VAL_PERC,  
 NORMAL,  
 DAY_PUC,  
 DAY_SALES,  
 SETT_PURCH,  
 SETT_SALES,  
 SELL_BUY,  
 SETTFLAG,  
 BROKAPPLIED,  
 NETRATE,  
 AMOUNT,  
 INS_CHRG,  
 TURN_TAX,  
 OTHER_CHRG,  
 SEBI_TAX,  
 BROKER_CHRG,  
 SERVICE_TAX,  
 TRADE_AMOUNT,  
 BILLFLAG,  
 SETT_NO,  
 NBROKAPP,  
 NSERTAX = SERVICE_TAX,  
 N_NETRATE,  
 SETT_TYPE,  
 CL_RATE,  
 PARTICIPANTCODE,  
 STATUS,  
 CPID,  
 INSTRUMENT,  
 BOOKTYPE,  
 BRANCH_ID,  
 TMARK,  
 SCHEME,  
 DUMMY1,  
 DUMMY2,  
 RESERVED1,  
 RESERVED2  
INTO #FOSETT_1  
FROM FOSETTLEMENT  
WHERE 1 = 2  
  
INSERT INTO #FOSETT_1  
SELECT CONTRACTNO,  
 BILLNO,  
 TRADE_NO,  
 PARTY_CODE,  
 INST_TYPE,  
 SYMBOL,  
 SEC_NAME,  
 EXPIRYDATE,  
 STRIKE_PRICE,  
 OPTION_TYPE,  
 USER_ID,  
 PRO_CLI,  
 O_C_FLAG,  
 C_U_FLAG,  
 TRADEQTY,  
 AUCTIONPART,  
 MARKETTYPE,  
 SERIES,  
 ORDER_NO,  
 PRICE,  
 SAUDA_DATE,  
 TABLE_NO,  
 LINE_NO,  
 VAL_PERC,  
 NORMAL,  
 DAY_PUC,  
 DAY_SALES,  
 SETT_PURCH,  
 SETT_SALES,  
 SELL_BUY,  
 SETTFLAG,  
 BROKAPPLIED,  
 NETRATE,  
 AMOUNT,  
 INS_CHRG,  
 TURN_TAX,  
 OTHER_CHRG,  
 SEBI_TAX,  
 BROKER_CHRG,  
 NSERTAX = SERVICE_TAX,  
 TRADE_AMOUNT,  
 BILLFLAG,  
 SETT_NO,  
 NBROKAPP,  
 SERVICE_TAX,  
 N_NETRATE,  
 SETT_TYPE,  
 CL_RATE,  
 PARTICIPANTCODE,  
 STATUS,  
 CPID,  
 INSTRUMENT,  
 BOOKTYPE,  
 BRANCH_ID,  
 TMARK,  
 SCHEME,  
 DUMMY1,  
 DUMMY2,  
 RESERVED1,  
 RESERVED2  
FROM FOSETTLEMENT(NOLOCK)  
WHERE SAUDA_DATE >= @SAUDA_DATE  
 AND SAUDA_DATE <= @TOSAUDA_DATE + ' 23:59:59'  
 AND PARTY_CODE >= @FROMPARTY_CODE  
 AND PARTY_CODE <= @TOPARTY_CODE  
 AND AUCTIONPART <> (  
  CASE   
   WHEN LEFT(EXPIRYDATE, 11) = LEFT(SAUDA_DATE, 11)  
    THEN 'XX'  
   ELSE 'CA'  
   END  
  ) /*CHANGE*/  
 AND TRADEQTY <> 0  
 AND PRICE > 0  
 --AND RESERVED1 = 0  
 AND AUCTIONPART <> 'CA'  
 AND PARTY_CODE IN (  
  SELECT PARTY_CODE  
  FROM #CLIENTMASTER  
  )  
  
IF @INTHISTFLAG > 0  
BEGIN  
 INSERT INTO #FOSETT_1  
 SELECT CONTRACTNO,  
  BILLNO,  
  TRADE_NO,  
  PARTY_CODE,  
  INST_TYPE,  
  SYMBOL,  
  SEC_NAME,  
  EXPIRYDATE,  
  STRIKE_PRICE,  
  OPTION_TYPE,  
  USER_ID,  
  PRO_CLI,  
  O_C_FLAG,  
  C_U_FLAG,  
  TRADEQTY,  
  AUCTIONPART,  
  MARKETTYPE,  
  SERIES,  
  ORDER_NO,  
  PRICE,  
  SAUDA_DATE,  
  TABLE_NO,  
  LINE_NO,  
  VAL_PERC,  
  NORMAL,  
  DAY_PUC,  
  DAY_SALES,  
  SETT_PURCH,  
  SETT_SALES,  
  SELL_BUY,  
  SETTFLAG,  
  BROKAPPLIED,  
  NETRATE,  
  AMOUNT,  
  INS_CHRG,  
  TURN_TAX,  
  OTHER_CHRG,  
  SEBI_TAX,  
  BROKER_CHRG,  
  SERVICE_TAX,  
  TRADE_AMOUNT,  
  BILLFLAG,  
  SETT_NO,  
  NBROKAPP,  
  NSERTAX = SERVICE_TAX,  
  N_NETRATE,  
  SETT_TYPE,  
  CL_RATE,  
  PARTICIPANTCODE,  
  STATUS,  
  CPID,  
  INSTRUMENT,  
  BOOKTYPE,  
  BRANCH_ID,  
  TMARK,  
  SCHEME,  
  DUMMY1,  
  DUMMY2,  
  RESERVED1,  
  RESERVED2  
 FROM PRADNYA..HISTORY_FOSETTLEMENT_BSECURFO(NOLOCK)  
 WHERE SAUDA_DATE >= @SAUDA_DATE  
  AND SAUDA_DATE <= @TOSAUDA_DATE + ' 23:59:59'  
  AND PARTY_CODE >= @FROMPARTY_CODE  
  AND PARTY_CODE <= @TOPARTY_CODE  
  AND AUCTIONPART <> (  
   CASE   
    WHEN LEFT(EXPIRYDATE, 11) = LEFT(SAUDA_DATE, 11)  
     THEN 'XX'  
    ELSE 'CA'  
    END  
   ) /*CHANGE*/  
  AND TRADEQTY <> 0  
  AND PRICE > 0  
  AND RESERVED1 = 0  
  AND AUCTIONPART <> 'CA'  
  AND PARTY_CODE IN (  
   SELECT PARTY_CODE  
   FROM #CLIENTMASTER  
   )  
END  
  
SELECT CONTRACTNO,  
 BILLNO,  
 TRADE_NO = PRADNYA.dbo.REPLACETRADENO(TRADE_NO),  
 PARTY_CODE,  
 INST_TYPE,  
 SYMBOL,  
 SEC_NAME,  
 EXPIRYDATE,  
 STRIKE_PRICE,  
 OPTION_TYPE,  
 USER_ID,  
 PRO_CLI,  
 O_C_FLAG,  
 C_U_FLAG,  
 TRADEQTY = SUM(TRADEQTY),  
 AUCTIONPART,  
 MARKETTYPE,  
 SERIES,  
 ORDER_NO,  
 PRICE = SUM(TRADEQTY * PRICE) / SUM(TRADEQTY),  
 SAUDA_DATE,  
 TABLE_NO,  
 LINE_NO,  
 VAL_PERC,  
 NORMAL,  
 DAY_PUC,  
 DAY_SALES,  
 SETT_PURCH,  
 SETT_SALES,  
 SELL_BUY,  
 SETTFLAG = (  
  CASE   
   WHEN SELL_BUY = 1  
    THEN 2  
   ELSE 3  
   END  
  ),  
 BROKAPPLIED = SUM(BROKAPPLIED * TRADEQTY) / SUM(TRADEQTY),  
 NETRATE = SUM(NETRATE * TRADEQTY) / SUM(TRADEQTY),  
 AMOUNT = SUM(AMOUNT),  
 INS_CHRG = SUM(INS_CHRG),  
 TURN_TAX = SUM(TURN_TAX),  
 OTHER_CHRG = SUM(OTHER_CHRG),  
 SEBI_TAX = SUM(SEBI_TAX),  
 BROKER_CHRG = SUM(BROKER_CHRG),  
 SERVICE_TAX = SUM(SERVICE_TAX),  
 TRADE_AMOUNT = SUM(TRADE_AMOUNT),  
 BILLFLAG = 0,  
 SETT_NO = '    ',  
 NBROKAPP = 0,  
 NSERTAX = 0,  
 N_NETRATE = 0,  
 SETT_TYPE = '  ',  
 CL_RATE = 0,  
 PARTICIPANTCODE,  
 STATUS = ' ',  
 CPID,  
 INSTRUMENT = '0',  
 BOOKTYPE = '0',  
 BRANCH_ID = ' ',  
 TMARK = ' ',  
 SCHEME = ' ',  
 DUMMY1 = '0',  
 DUMMY2 = 0,  
 RESERVED1 = 0,  
 RESERVED2 = 0  
INTO #FOSETT  
FROM #FOSETT_1  
GROUP BY CONTRACTNO,  
 BILLNO,  
 PRADNYA.dbo.REPLACETRADENO(TRADE_NO),  
 PARTY_CODE,  
 INST_TYPE,  
 SYMBOL,  
 SEC_NAME,  
 EXPIRYDATE,  
 STRIKE_PRICE,  
 OPTION_TYPE,  
 USER_ID,  
 PRO_CLI,  
 O_C_FLAG,  
 C_U_FLAG,  
 AUCTIONPART,  
 MARKETTYPE,  
 SERIES,  
 ORDER_NO,  
 SAUDA_DATE,  
 TABLE_NO,  
 LINE_NO,  
 VAL_PERC,  
 NORMAL,  
 DAY_PUC,  
 DAY_SALES,  
 SETT_PURCH,  
 SETT_SALES,  
 SELL_BUY,  
 PARTICIPANTCODE,  
 CPID  
  
  
CREATE INDEX [DELPOS] ON [dbo].[#FOSETT] ([PARTY_CODE])  
  
SELECT ORDER_NO,  
 ORDER_TIME = (  
  CASE   
   WHEN CPID = 'NIL'  
    OR CPID = '0'  
    THEN '        '  
   ELSE RIGHT(CPID, 8)  
   END  
  ),  
 TRADE_NO,  
 LEFT(CONVERT(VARCHAR, SAUDA_DATE, 108), 11) AS TRADETIME,  
 PQTY = (  
  CASE   
   WHEN SELL_BUY = 1  
    THEN TRADEQTY  
   ELSE 0  
   END  
  ),  
 SQTY = (  
  CASE   
   WHEN SELL_BUY = 2  
    THEN TRADEQTY  
   ELSE 0  
   END  
  ),  
 PRATE = (  
  CASE   
   WHEN SELL_BUY = 1  
    THEN ISNULL(PRICE, 0)  
   ELSE 0  
   END  
  ),  
 SRATE = (  
  CASE   
   WHEN SELL_BUY = 2  
    THEN ISNULL(PRICE, 0)  
   ELSE 0  
   END  
  ),  
 PBROK = (  
  CASE   
   WHEN SELL_BUY = 1  
    THEN ISNULL((  
       BROKAPPLIED + (  
        CASE   
         WHEN C.SERVICE_CHRG = 1  
          THEN ISNULL(F.SERVICE_TAX / TRADEQTY, 0)  
         ELSE 0  
         END  
        )  
       ), 0)  
   ELSE 0  
   END  
  ),  
 SBROK = (  
  CASE   
   WHEN SELL_BUY = 2  
    THEN ISNULL((  
       BROKAPPLIED + (  
        CASE   
         WHEN C.SERVICE_CHRG = 1  
          THEN ISNULL(F.SERVICE_TAX / TRADEQTY, 0)  
         ELSE 0  
         END  
        )  
       ), 0)  
   ELSE 0  
   END  
  ),  
 PNETRATE = (  
  CASE   
   WHEN SELL_BUY = 1  
    THEN ISNULL(NETRATE + (  
       CASE   
        WHEN C.SERVICE_CHRG = 1  
         THEN ISNULL((F.SERVICE_TAX / TRADEQTY), 0)  
        ELSE 0  
        END  
       ), 0)  
   ELSE 0  
   END  
  ),  
 SNETRATE = (  
  CASE   
   WHEN SELL_BUY = 2  
    THEN ISNULL(NETRATE - (  
       CASE   
        WHEN C.SERVICE_CHRG = 1  
         THEN ISNULL((F.SERVICE_TAX / TRADEQTY), 0)  
        ELSE 0  
        END  
       ), 0)  
   ELSE 0  
   END  
  ),  
 ISNULL(AMOUNT, 0) AMOUNT,  
 INST_TYPE,  
 SYMBOL,  
 PAMT = (  
  CASE   
   WHEN SELL_BUY = 1  
    THEN (TRADEQTY * NETRATE) + (  
      CASE   
       WHEN C.SERVICE_CHRG = 1  
        THEN ISNULL((F.SERVICE_TAX), 0)  
       ELSE (  
         CASE   
          WHEN C.SERVICE_CHRG = 0  
           THEN 0  
          ELSE (  
            CASE   
             WHEN C.SERVICE_CHRG = 2  
              THEN 0  
             ELSE 0  
             END  
            )  
          END  
         )  
       END  
      )  
   ELSE 0  
   END  
  ),  
 SAMT = (  
  CASE   
   WHEN SELL_BUY = 2  
    THEN (TRADEQTY * NETRATE) - (  
      CASE   
       WHEN C.SERVICE_CHRG = 1  
        THEN ISNULL((F.SERVICE_TAX), 0)  
       ELSE (  
         CASE   
          WHEN C.SERVICE_CHRG = 0  
           THEN 0  
          ELSE (  
            CASE   
             WHEN C.SERVICE_CHRG = 2  
              THEN 0  
             ELSE 0  
             END  
            )  
          END  
         )  
       END  
      )  
   ELSE 0  
   END  
  ),  
 LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 11) AS EXPIRYDATE,  
 F.PARTY_CODE,  
 SELL_BUY,  
 CONTRACTNO,  
 CONVERT(VARCHAR, SAUDA_DATE, 103) AS SAUDA_DATE,  
 ISNULL(STRIKE_PRICE, 0) STRIKE_PRICE,  
 OPTION_TYPE,  
 PSERVICE_TAX = (  
  CASE   
   WHEN SELL_BUY = 1  
    THEN (  
      CASE   
       WHEN C.SERVICE_CHRG = 0  
        THEN (F.SERVICE_TAX)  
       ELSE (  
         CASE   
          WHEN C.SERVICE_CHRG = 1  
           THEN 0  
          ELSE (  
            CASE   
             WHEN C.SERVICE_CHRG = 2  
              THEN 0  
             END  
            )  
          END  
         )  
       END  
      )  
   ELSE 0  
   END  
  ),  
 SSERVICE_TAX = (  
  CASE   
   WHEN SELL_BUY = 2  
    THEN (  
      CASE   
       WHEN C.SERVICE_CHRG = 0  
        THEN (F.SERVICE_TAX)  
       ELSE (  
         CASE   
          WHEN C.SERVICE_CHRG = 1  
           THEN 0  
          ELSE (  
            CASE   
             WHEN C.SERVICE_CHRG = 2  
              THEN 0  
             END  
            )  
          END  
         )  
       END  
      )  
   ELSE 0  
   END  
  ),  
 YY = YEAR(SAUDA_DATE),  
 MM = MONTH(SAUDA_DATE),  
 DD = DAY(SAUDA_DATE),  
 DFLAG = 1,  
 BROKER_CHRG = (  
  CASE   
   WHEN BROKERNOTE = 1  
    THEN BROKER_CHRG  
   ELSE 0  
   END  
  ),  
 TURN_TAX = (  
  CASE   
   WHEN TURNOVER_TAX = 1  
    THEN TURN_TAX  
   ELSE 0  
   END  
  ),  
 SEBI_TAX = (  
  CASE   
   WHEN SEBI_TURN_TAX = 1  
    THEN SEBI_TAX  
   ELSE 0  
   END  
  ),  
 OTHER_CHRG = (  
  CASE   
   WHEN C.OTHER_CHRG = 1  
    THEN F.OTHER_CHRG  
   ELSE 0  
   END  
  ),  
 INS_CHRG = (  
  CASE   
   WHEN INSURANCE_CHRG = 1  
    THEN INS_CHRG  
   ELSE 0  
   END  
  ),  
 SERVICE_TAX = (  
  CASE   
   WHEN SERVICE_CHRG = 0  
    THEN SERVICE_TAX  
   ELSE 0  
   END  
  ),  
 NSERTAX = (  
  CASE   
   WHEN SERVICE_CHRG = 0  
    THEN SERVICE_TAX  
   ELSE 0  
   END  
  ),  
 BROKERAGE = ISNULL(TRADEQTY * BROKAPPLIED, 0),  
 C.BRANCH_CD,  
 C.SUB_BROKER,  
 C.TRADER,  
 PRINTF,  
 C.SERVICE_CHRG,  
 PARTYNAME = LONG_NAME,  
 L_ADDRESS1,  
 L_ADDRESS2,  
 L_ADDRESS3,  
 L_CITY,  
 L_STATE,  
 L_ZIP,  
 PAN_GIR_NO,  
 OFF_PHONE1,  
 OFF_PHONE2,  
 MAPIDID,  
 UCC_CODE,  
 SEBI_NO,  
 ORDFLG = 0  
INTO #CONTSETT  
FROM #FOSETT F,  
 #CLIENTMASTER C  
WHERE F.PARTY_CODE >= @FROMPARTY_CODE  
 AND F.PARTY_CODE <= @TOPARTY_CODE  
 AND SAUDA_DATE >= @SAUDA_DATE  
 AND SAUDA_DATE <= @TOSAUDA_DATE + ' 23:59:59'  
 AND CONTRACTNO BETWEEN (  
    CASE   
     WHEN INST_TYPE LIKE 'OPT%'  
      AND AUCTIONPART = 'EA'  
      THEN 0  
     ELSE @FROMCONTRACTNO  
     END  
    )  
  AND @TOCONTRACTNO  
 AND F.PARTY_CODE = C.PARTY_CODE  
  
UPDATE #CONTSETT  
SET BROKERAGE = CASE   
  WHEN SELL_BUY = 1  
   THEN CD_TOT_BUYBROK  
  ELSE CD_TOT_SELLBROK  
  END + (  
  CASE   
   WHEN SERVICE_CHRG = 1  
    THEN CASE   
      WHEN SELL_BUY = 1  
       THEN CD_TOT_BUYSERTAX  
      ELSE CD_TOT_SELLSERTAX  
      END  
   ELSE 0  
   END  
  ),  
 SERVICE_TAX = SERVICE_TAX + (  
  CASE   
   WHEN SERVICE_CHRG = 0  
    THEN CASE   
      WHEN SELL_BUY = 1  
       THEN CD_TOT_BUYSERTAX  
      ELSE CD_TOT_SELLSERTAX  
      END  
   ELSE 0  
   END  
  ),  
 NSERTAX = SERVICE_TAX + (  
  CASE   
   WHEN SERVICE_CHRG = 0  
    THEN CASE   
      WHEN SELL_BUY = 1  
       THEN CD_TOT_BUYSERTAX  
      ELSE CD_TOT_SELLSERTAX  
      END  
   ELSE 0  
   END  
  ),  
 PSERVICE_TAX = (  
  CASE   
   WHEN SERVICE_CHRG = 0  
    THEN CASE   
      WHEN SELL_BUY = 1  
       THEN SERVICE_TAX + CD_TOT_BUYSERTAX  
      ELSE 0  
      END  
   ELSE 0  
   END  
  ),  
 SSERVICE_TAX = (  
  CASE   
   WHEN SERVICE_CHRG = 0  
    THEN CASE   
      WHEN SELL_BUY = 1  
       THEN 0  
      ELSE SERVICE_TAX + CD_TOT_SELLSERTAX  
      END  
   ELSE 0  
   END  
  ),  
 PAMT = (  
  CASE   
   WHEN SELL_BUY = 1  
    THEN (PQTY * PRATE) + CD_TOT_BUYBROK + (  
      CASE   
       WHEN SERVICE_CHRG = 1  
        THEN ISNULL((SERVICE_TAX + CD_TOT_BUYSERTAX), 0)  
       ELSE 0  
       END  
      )  
   ELSE 0  
   END  
  ),  
 SAMT = (  
  CASE   
   WHEN SELL_BUY = 2  
    THEN (SQTY * SRATE) - CD_TOT_SELLBROK - (  
      CASE   
       WHEN SERVICE_CHRG = 1  
        THEN ISNULL((SERVICE_TAX + CD_TOT_SELLSERTAX), 0)  
       ELSE 0  
       END  
      )  
   ELSE 0  
   END  
  )  
FROM CHARGES_DETAIL  
WHERE CONVERT(VARCHAR, CD_SAUDA_DATE, 103) = CONVERT(VARCHAR, SAUDA_DATE, 103)  
 AND CD_PARTY_CODE = #CONTSETT.PARTY_CODE  
 AND CD_INST_TYPE = INST_TYPE  
 AND CD_SYMBOL = SYMBOL  
 AND CONVERT(VARCHAR, CD_EXPIRY_DATE, 106) = EXPIRYDATE  
 AND CD_OPTION_TYPE = OPTION_TYPE  
 AND CD_STRIKE_PRICE = STRIKE_PRICE  
 AND CD_TRADE_NO = TRADE_NO  
 AND CD_ORDER_NO = ORDER_NO  
  
INSERT INTO #CONTSETT  
SELECT CD_ORDER_NO,  
 ORDER_TIME = '',  
 CD_TRADE_NO,  
 TRADETIME = '',  
 PQTY = 0,  
 SQTY = 0,  
 PRATE = 0,  
 SRATE = 0,  
 PBROK = 0,  
 SBROK = 0,  
 PNETRATE = 0,  
 SNETRATE = 0,  
 AMOUNT = 0,  
 CD_INST_TYPE,  
 CD_SYMBOL = (  
  CASE   
   WHEN CD_SYMBOL = ''  
    THEN 'CONT BROK'  
   ELSE CD_SYMBOL  
   END  
  ),  
 PAMT = 0,  
 SAMT = 0,  
 (  
  CASE   
   WHEN CD_SYMBOL = ''  
    THEN ''  
   ELSE LEFT(CONVERT(VARCHAR, CD_EXPIRY_DATE, 106), 11)  
   END  
  ) AS EXPIRYDATE,  
 CD_PARTY_CODE,  
 SELL_BUY = 1,  
 CD_CONTRACT_NO,  
 CONVERT(VARCHAR, CD_SAUDA_DATE, 103) AS SAUDA_DATE,  
 ISNULL(CD_STRIKE_PRICE, 0) STRIKE_PRICE,  
 CD_OPTION_TYPE,  
 PSERVICE_TAX = (  
  CASE   
   WHEN SERVICE_CHRG = 0  
    THEN CD_TOT_BUYSERTAX  
   ELSE 0  
   END  
  ),  
 SSERVICE_TAX = 0,  
 YY = YEAR(CD_SAUDA_DATE),  
 MM = MONTH(CD_SAUDA_DATE),  
 DD = DAY(CD_SAUDA_DATE),  
 DFLAG = 1,  
 BROKER_CHRG = 0,  
 TURN_TAX = 0,  
 SEBI_TAX = 0,  
 OTHER_CHRG = 0,  
 INS_CHRG = 0,  
 SERVICE_TAX = (  
  CASE   
   WHEN SERVICE_CHRG = 0  
    THEN CD_TOT_BUYSERTAX  
   ELSE 0  
   END  
  ),  
 NSERTAX = (  
  CASE   
   WHEN SERVICE_CHRG = 0  
    THEN CD_TOT_BUYSERTAX  
   ELSE 0  
   END  
  ),  
 BROKERAGE = CD_TOT_BUYBROK + (  
  CASE   
   WHEN SERVICE_CHRG = 1  
    THEN CD_TOT_BUYSERTAX  
   ELSE 0  
   END  
  ),  
 C.BRANCH_CD,  
 C.SUB_BROKER,  
 C.TRADER,  
 PRINTF,  
 C.SERVICE_CHRG,  
 PARTYNAME = LONG_NAME,  
 L_ADDRESS1,  
 L_ADDRESS2,  
 L_ADDRESS3,  
 L_CITY,  
 L_STATE,  
 L_ZIP,  
 PAN_GIR_NO,  
 OFF_PHONE1,  
 OFF_PHONE2,  
 MAPIDID,  
 UCC_CODE,  
 SEBI_NO,  
 ORDFLG = (  
  CASE   
   WHEN CD_ORDER_NO <> ''  
    THEN 1  
   WHEN CD_SYMBOL <> ''  
    THEN 2  
   ELSE 3  
   END  
  )  
FROM CHARGES_DETAIL F,  
 #CLIENTMASTER C  
WHERE CD_SAUDA_DATE >= @SAUDA_DATE  
 AND CD_SAUDA_DATE <= @TOSAUDA_DATE + ' 23:59:59'  
 AND CD_PARTY_CODE >= '0'  
 AND CD_PARTY_CODE <= 'ZZ'  
 AND CD_CONTRACT_NO BETWEEN (  
    CASE   
     WHEN CD_INST_TYPE LIKE 'OPT%'  
      AND CD_AUCTIONPART = 'EA'  
      THEN 0  
     ELSE '0'  
     END  
    )  
  AND '9999'  
 AND CD_PARTY_CODE = C.PARTY_CODE  
 AND CD_TRADE_NO = ''  
 AND CD_TOT_BUYBROK > 0  
  
INSERT INTO #CONTSETT  
SELECT CD_ORDER_NO,  
 ORDER_TIME = '',  
 CD_TRADE_NO,  
 TRADETIME = '',  
 PQTY = 0,  
 SQTY = 0,  
 PRATE = 0,  
 SRATE = 0,  
 PBROK = 0,  
 SBROK = 0,  
 PNETRATE = 0,  
 SNETRATE = 0,  
 AMOUNT = 0,  
 CD_INST_TYPE,  
 CD_SYMBOL = (  
  CASE   
   WHEN CD_SYMBOL = ''  
    THEN 'CONT BROK'  
   ELSE CD_SYMBOL  
   END  
  ),  
 PAMT = 0,  
 SAMT = 0,  
 (  
  CASE   
   WHEN CD_SYMBOL = ''  
    THEN ''  
   ELSE LEFT(CONVERT(VARCHAR, CD_EXPIRY_DATE, 106), 11)  
   END  
  ) AS EXPIRYDATE,  
 CD_PARTY_CODE,  
 SELL_BUY = 1,  
 CD_CONTRACT_NO,  
 CONVERT(VARCHAR, CD_SAUDA_DATE, 103) AS SAUDA_DATE,  
 ISNULL(CD_STRIKE_PRICE, 0) STRIKE_PRICE,  
 CD_OPTION_TYPE,  
 PSERVICE_TAX = 0,  
 SSERVICE_TAX = (  
  CASE   
   WHEN SERVICE_CHRG = 0  
    THEN CD_TOT_SELLSERTAX  
   ELSE 0  
   END  
  ),  
 YY = YEAR(CD_SAUDA_DATE),  
 MM = MONTH(CD_SAUDA_DATE),  
 DD = DAY(CD_SAUDA_DATE),  
 DFLAG = 1,  
 BROKER_CHRG = 0,  
 TURN_TAX = 0,  
 SEBI_TAX = 0,  
 OTHER_CHRG = 0,  
 INS_CHRG = 0,  
 SERVICE_TAX = (  
  CASE   
   WHEN SERVICE_CHRG = 0  
    THEN CD_TOT_SELLSERTAX  
   ELSE 0  
   END  
  ),  
 NSERTAX = (  
  CASE   
   WHEN SERVICE_CHRG = 0  
    THEN CD_TOT_SELLSERTAX  
   ELSE 0     END  
  ),  
 BROKERAGE = CD_TOT_SELLBROK + (  
  CASE   
   WHEN SERVICE_CHRG = 1  
    THEN CD_TOT_SELLSERTAX  
   ELSE 0  
   END  
  ),  
 C.BRANCH_CD,  
 C.SUB_BROKER,  
 C.TRADER,  
 PRINTF,  
 C.SERVICE_CHRG,  
 PARTYNAME = LONG_NAME,  
 L_ADDRESS1,  
 L_ADDRESS2,  
 L_ADDRESS3,  
 L_CITY,  
 L_STATE,  
 L_ZIP,  
 PAN_GIR_NO,  
 OFF_PHONE1,  
 OFF_PHONE2,  
 MAPIDID,  
 UCC_CODE,  
 SEBI_NO,  
 ORDFLG = (  
  CASE   
   WHEN CD_ORDER_NO <> ''  
    THEN 1  
   WHEN CD_SYMBOL <> ''  
    THEN 2  
   ELSE 3  
   END  
  )  
FROM CHARGES_DETAIL F,  
 #CLIENTMASTER C  
WHERE CD_SAUDA_DATE >= @SAUDA_DATE  
 AND CD_SAUDA_DATE <= @TOSAUDA_DATE + ' 23:59:59'  
 AND CD_PARTY_CODE >= '0'  
 AND CD_PARTY_CODE <= 'ZZ'  
 AND CD_CONTRACT_NO BETWEEN (  
    CASE   
     WHEN CD_INST_TYPE LIKE 'OPT%'  
      AND CD_AUCTIONPART = 'EA'  
      THEN 0  
     ELSE '0'  
     END  
    )  
  AND '9999'  
 AND CD_PARTY_CODE = C.PARTY_CODE  
 AND CD_TRADE_NO = ''  
 AND CD_TOT_SELLBROK > 0  
  
SELECT ORDER_NO = '00000000000000000000',  
 ORDER_TIME = '                    ',  
 TRADE_NO = '00000000000000000000',  
 TRADETIME = '00000000000000000000',  
 PQTY = SUM(PQTY),  
 SQTY = SUM(SQTY),  
 PRATE = (  
  CASE   
   WHEN SUM(PQTY) > 0  
    THEN SUM(PRATE * PQTY) / SUM(PQTY)  
   ELSE 0  
   END  
  ),  
 SRATE = (  
  CASE   
   WHEN SUM(SQTY) > 0  
    THEN SUM(SRATE * SQTY) / SUM(SQTY)  
   ELSE 0  
   END  
  ),  
 PBROK = (  
  CASE   
   WHEN SUM(PQTY) > 0  
    THEN SUM(PBROK * PQTY) / SUM(PQTY)  
   ELSE 0  
   END  
  ),  
 SBROK = (  
  CASE   
   WHEN SUM(SQTY) > 0  
    THEN SUM(SBROK * SQTY) / SUM(SQTY)  
   ELSE 0  
   END  
  ),  
 PNETRATE = (  
  CASE   
   WHEN SUM(PQTY) > 0  
    THEN SUM(PNETRATE * PQTY) / SUM(PQTY)  
   ELSE 0  
   END  
  ),  
 SNETRATE = (  
  CASE   
   WHEN SUM(SQTY) > 0  
    THEN SUM(SNETRATE * SQTY) / SUM(SQTY)  
   ELSE 0  
   END  
  ),  
 AMOUNT = SUM(AMOUNT),  
 INST_TYPE,  
 SYMBOL,  
 PAMT = SUM(PAMT),  
 SAMT = SUM(SAMT),  
 EXPIRYDATE,  
 PARTY_CODE,  
 SELL_BUY,  
 CONTRACTNO,  
 SAUDA_DATE = LEFT(CONVERT(VARCHAR, SAUDA_DATE, 109), 11),  
 STRIKE_PRICE,  
 OPTION_TYPE,  
 PSERVICE_TAX = SUM(PSERVICE_TAX),  
 SSERVICE_TAX = SUM(SSERVICE_TAX),  
 YY,  
 MM,  
 DD,  
 DFLAG,  
 BROKER_CHRG = SUM(BROKER_CHRG),  
 TURN_TAX = SUM(TURN_TAX),  
 SEBI_TAX = SUM(SEBI_TAX),  
 OTHER_CHRG = SUM(OTHER_CHRG),  
 INS_CHRG = SUM(INS_CHRG),  
 SERVICE_TAX = SUM(SERVICE_TAX),  
 NSERTAX = SUM(SERVICE_TAX),  
 BROKERAGE = SUM(BROKERAGE),  
 BRANCH_CD,  
 SUB_BROKER,  
 TRADER,  
 PRINTF,  
 SERVICE_CHRG,  
 PARTYNAME,  
 L_ADDRESS1,  
 L_ADDRESS2,  
 L_ADDRESS3,  
 L_CITY,  
 L_STATE,  
 L_ZIP,  
 PAN_GIR_NO,  
 OFF_PHONE1,  
 OFF_PHONE2,  
 MAPIDID,  
 UCC_CODE,  
 SEBI_NO,  
 ORDFLG  
INTO #CONTSETTNEW  
FROM #CONTSETT  
WHERE PRINTF = '3'  
GROUP BY INST_TYPE,  
 SYMBOL,  
 EXPIRYDATE,  
 PARTY_CODE,  
 SELL_BUY,  
 CONTRACTNO,  
 STRIKE_PRICE,  
 OPTION_TYPE,  
 LEFT(CONVERT(VARCHAR, SAUDA_DATE, 109), 11),  
 YY,  
 MM,  
 DD,  
 DFLAG,  
 BRANCH_CD,  
 SUB_BROKER,  
 TRADER,  
 PRINTF,  
 SERVICE_CHRG,  
 PARTYNAME,  
 L_ADDRESS1,  
 L_ADDRESS2,  
 L_ADDRESS3,  
 L_CITY,  
 L_STATE,  
 L_ZIP,  
 PAN_GIR_NO,  
 OFF_PHONE1,  
 OFF_PHONE2,  
 MAPIDID,  
 UCC_CODE,  
 SEBI_NO,  
 ORDFLG  
  
INSERT INTO #CONTSETTNEW  
SELECT *  
FROM #CONTSETT WITH (NOLOCK)  
WHERE PRINTF <> '3'  
  
  
UPDATE #CONTSETTNEW  
SET ORDER_NO = S.ORDER_NO,  
 ORDER_TIME = S.ORDER_TIME,  
 TRADETIME = S.TRADETIME,  
 TRADE_NO = S.TRADE_NO  
FROM #CONTSETT S WITH (NOLOCK)  
WHERE S.PRINTF = #CONTSETTNEW.PRINTF  
 AND S.PRINTF = '3'  
 AND S.PARTY_CODE = #CONTSETTNEW.PARTY_CODE  
 AND S.INST_TYPE = #CONTSETTNEW.INST_TYPE  
 AND S.SYMBOL = #CONTSETTNEW.SYMBOL  
 AND S.EXPIRYDATE = #CONTSETTNEW.EXPIRYDATE  
 AND S.OPTION_TYPE = #CONTSETTNEW.OPTION_TYPE  
 AND S.STRIKE_PRICE = #CONTSETTNEW.STRIKE_PRICE  
 AND S.SELL_BUY = #CONTSETTNEW.SELL_BUY  
 AND S.TRADETIME = (  
  SELECT MIN(TRADETIME)  
  FROM #CONTSETT ISETT WITH (NOLOCK)  
  WHERE PRINTF = '3'  
   AND S.PARTY_CODE = ISETT.PARTY_CODE  
   AND S.INST_TYPE = ISETT.INST_TYPE  
   AND S.SYMBOL = ISETT.SYMBOL  
   AND S.EXPIRYDATE = ISETT.EXPIRYDATE  
   AND S.OPTION_TYPE = ISETT.OPTION_TYPE  
   AND S.STRIKE_PRICE = ISETT.STRIKE_PRICE  
   AND S.SELL_BUY = ISETT.SELL_BUY  
  )  
  
/* -- UPDATE FOR PARENTCODE --*/  
UPDATE #CONTSETTNEW  
SET PARTY_CODE = PARENTCODE  
FROM CLIENT2  
WHERE CLIENT2.PARTY_CODE = #CONTSETTNEW.PARTY_CODE  
  
/* -- UPDATE FOR PARENTCODE --*/  
DECLARE @CHARGES INT  
  
SET @CHARGES = 0  
  
IF (@CONTFLAG = 'CONTRACT')  
BEGIN  
 SELECT ORDERBYFLAG = (  
   CASE   
    WHEN @COLNAME = 'ORD_N'  
     THEN PARTYNAME  
    WHEN @COLNAME = 'ORD_P'  
     THEN PARTY_CODE  
    WHEN @COLNAME = 'ORD_BP'  
     THEN RTRIM(LTRIM(BRANCH_CD)) + RTRIM(LTRIM(PARTY_CODE))  
    WHEN @COLNAME = 'ORD_BN'  
     THEN RTRIM(LTRIM(BRANCH_CD)) + RTRIM(LTRIM(PARTYNAME))  
    WHEN @COLNAME = 'ORD_DP'  
     THEN RTRIM(LTRIM(BRANCH_CD)) + RTRIM(LTRIM(SUB_BROKER)) + RTRIM(LTRIM(TRADER)) + RTRIM(LTRIM(PARTY_CODE))  
    WHEN @COLNAME = 'ORD_DN'  
     THEN RTRIM(LTRIM(BRANCH_CD)) + RTRIM(LTRIM(SUB_BROKER)) + RTRIM(LTRIM(TRADER)) + RTRIM(LTRIM(PARTYNAME))  
    ELSE RTRIM(LTRIM(BRANCH_CD)) + RTRIM(LTRIM(SUB_BROKER)) + RTRIM(LTRIM(TRADER)) + RTRIM(LTRIM(PARTY_CODE))  
    END  
   ),  
  ORDER_NO,  
  ORDER_TIME,  
  TRADE_NO,  
  TM = TRADETIME,  
  QTY = (PQTY + SQTY),  
  PQTY,  
  SQTY,  
  RATE = PRATE + SRATE,  
  PRATE,  
  SRATE,  
  BROK = PBROK + SBROK,  
  PBROK,  
  SBROK,  
  NETRATE = PNETRATE + SNETRATE,  
  PNETRATE,  
  SNETRATE,  
  AMOUNT,  
  INST_TYPE,  
  SYMBOL,  
  AMT = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN - PAMT  
    ELSE SAMT  
    END  
   ),  
  PAMT,  
  SAMT,  
  AMTSTT = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN - (PAMT + INS_CHRG)  
    ELSE (SAMT - INS_CHRG)  
    END  
   ),  
  PAMTSTT = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN PAMT + INS_CHRG  
    ELSE 0  
    END  
   ),  
  SAMTSTT = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN SAMT - INS_CHRG  
    ELSE 0  
    END  
   ),  
  AMTSER = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN - (PAMT + SERVICE_TAX)  
    ELSE (SAMT - SERVICE_TAX)  
    END  
   ),  
  PAMTSER = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN PAMT + SERVICE_TAX  
    ELSE 0  
    END  
   ),  
  SAMTSER = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN SAMT - SERVICE_TAX  
    ELSE 0  
    END  
   ),  
  AMTSERSTT = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN - (PAMT + PSERVICE_TAX + INS_CHRG)  
    ELSE (SAMT - SSERVICE_TAX - INS_CHRG)  
    END  
   ),  
  PAMTSERSTT = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN PAMT + PSERVICE_TAX + INS_CHRG  
    ELSE 0  
    END  
   ),  
  SAMTSERSTT = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN SAMT - SSERVICE_TAX - INS_CHRG  
    ELSE 0  
    END  
   ),  
  AMTSERSTTSTAMPTRANS = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN - (PAMT + NSERTAX + INS_CHRG + BROKER_CHRG + TURN_TAX)  
    ELSE (SAMT - NSERTAX - INS_CHRG - BROKER_CHRG - TURN_TAX)  
    END  
   ),  
  PAMTSERSTTSTAMPTRANS = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN PAMT + NSERTAX + INS_CHRG + BROKER_CHRG + TURN_TAX  
    ELSE 0  
    END  
   ),  
  SAMTSERSTTSTAMPTRANS = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN SAMT - NSERTAX - INS_CHRG - BROKER_CHRG - TURN_TAX  
    ELSE 0  
    END  
   ),  
  AMTDIFF = 0,  
  EXPIRYDATE,  
  PARTY_CODE,  
  SELL_BUY,  
  CONTRACTNO,  
  SAUDA_DATE,  
  SDT = SAUDA_DATE,  
  STRIKE_PRICE,  
  OPTION_TYPE,  
  PSERVICE_TAX,  
  SSERVICE_TAX,  
  YY,  
  MM,  
  DD,  
  DFLAG,  
  BROKER_CHRG,  
  TURN_TAX,  
  SEBI_TAX,  
  OTHER_CHRG,  
  PINS_CHRG = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN INS_CHRG  
    ELSE 0  
    END  
   ),  
  SINS_CHRG = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN INS_CHRG  
    ELSE 0  
    END  
   ),  
  INS_CHRG,  
  SERVICE_TAX,  
  NSERTAX = SERVICE_TAX,  
  BROKERAGE,  
  PBROKERAGE = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN BROKERAGE  
    ELSE 0  
    END  
   ),  
  SBROKERAGE = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN BROKERAGE  
    ELSE 0  
    END  
   ),  
  BRANCH_CD,  
  SUB_BROKER,  
  TRADER,  
  PRINTF,  
  SERVICE_CHRG,  
  PARTYNAME,  
  L_ADDRESS1,  
  L_ADDRESS2,  
  L_ADDRESS3,  
  L_CITY,  
  L_STATE,  
  L_ZIP,  
  SEBI_NO,  
  PAN_GIR_NO,  
  OFF_PHONE1,  
  OFF_PHONE2,  
  MAPIDID,  
  UCC_CODE,  
  MARKETAMT = (PRATE + SRATE) * (PQTY + SQTY),  
  PMARKETAMT = PRATE * PQTY,  
  SMARKETAMT = SRATE * SQTY,  
  SERIES = '',  
  TMARK = '',  
  SCRIPNAME = (  
   CASE   
    WHEN INST_TYPE LIKE 'FUT%'  
     THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE, 11)  
    ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE, 11) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + ' ' + RTRIM(OPTION_TYPE)  
    END  
   ),  
  PSCRIPNAME = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN (  
       CASE   
        WHEN INST_TYPE LIKE 'FUT%'  
         THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE, 11)  
        ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE, 11) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + ' ' + RTRIM(OPTION_TYPE)  
        END  
       )  
    ELSE ''  
    END  
   ),  
  SSCRIPNAME = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN (  
       CASE   
        WHEN INST_TYPE LIKE 'FUT%'  
         THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE, 11)  
        ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE, 11) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + ' ' + RTRIM(OPTION_TYPE)  
        END  
       )  
    ELSE ''  
    END  
   ),  
  SCRIPNAMESHORT = (  
   CASE   
    WHEN INST_TYPE LIKE 'FUTIDX'  
     THEN 'FI' + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2)  
    WHEN INST_TYPE LIKE 'FUTSTK'  
     THEN 'FS' + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2)  
    WHEN INST_TYPE LIKE 'OPTIDX'  
     THEN 'OI' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
    WHEN INST_TYPE LIKE 'EA-IDX'  
     THEN 'EI' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
    WHEN INST_TYPE LIKE 'EA-STK'  
     THEN 'ES' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
    WHEN INST_TYPE LIKE 'OPTSTK'  
     THEN 'OS' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
    END  
   ),  
  PSCRIPNAMESHORT = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN (  
       CASE   
        WHEN INST_TYPE LIKE 'FUTIDX'  
         THEN 'FI' + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2)  
        WHEN INST_TYPE LIKE 'FUTSTK'  
         THEN 'FS' + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2)  
        WHEN INST_TYPE LIKE 'OPTIDX'  
         THEN 'OI' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        WHEN INST_TYPE LIKE 'EA-IDX'  
         THEN 'EI' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        WHEN INST_TYPE LIKE 'EA-STK'  
         THEN 'ES' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        WHEN INST_TYPE LIKE 'OPTSTK'  
         THEN 'OS' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        END  
       )  
    ELSE ''  
    END  
   ),  
  SSCRIPNAMESHORT = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN (  
       CASE   
        WHEN INST_TYPE LIKE 'FUTIDX'  
         THEN 'FI' + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2)  
        WHEN INST_TYPE LIKE 'FUTSTK'  
         THEN 'FS' + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2)  
        WHEN INST_TYPE LIKE 'OPTIDX'  
         THEN 'OI' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        WHEN INST_TYPE LIKE 'EA-IDX'  
         THEN 'EI' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        WHEN INST_TYPE LIKE 'EA-STK'  
         THEN 'ES' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        WHEN INST_TYPE LIKE 'OPTSTK'  
         THEN 'OS' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        END  
       )  
    ELSE ''  
    END  
   ),  
  ORDFLG,  
  TRDFLAG = (  
   CASE   
    WHEN ORDFLG = 3  
     THEN 1  
    ELSE 0  
    END  
   ),  
  ROW_P_COUNT = CONVERT(NUMERIC(18, 0), 0),  
  ROW_S_COUNT = CONVERT(NUMERIC(18, 0), 0)  
 INTO #CONTRACT  
 FROM #CONTSETTNEW WITH (NOLOCK)  
 WHERE PRINTF <> 1  
  
 /*ORDER BY        
     YY,      
        MM,      
        DD,      
 TRDFLAG,        
 ORDERBYFLAG,         
 BRANCH_CD,         
 SUB_BROKER,         
 TRADER,         
 PARTY_CODE,         
 CONTRACTNO DESC,      
 INST_TYPE,         
 SYMBOL,         
 CONVERT(DATETIME,EXPIRYDATE),          
 OPTION_TYPE,         
 STRIKE_PRICE,         
 ORDFLG,        
 ORDER_NO,         
 TRADE_NO*/  
 SELECT PARTY_CODE,  
  PARTY_COUNT = COUNT(PARTY_CODE),  
  SCRIP_COUNT = COUNT(DISTINCT (SCRIPNAME)) + @CHARGES + (  
   CASE   
    WHEN SUM(SERVICE_TAX) > 0  
     THEN 1  
    ELSE 0  
    END  
   ) + (  
   CASE   
    WHEN SUM(INS_CHRG) > 0  
     THEN 1  
    ELSE 0  
    END  
   ) + (  
   CASE   
    WHEN SUM(TURN_TAX) > 0  
     THEN 1  
    ELSE 0  
    END  
   ) + (  
   CASE   
    WHEN SUM(SEBI_TAX) > 0  
     THEN 1  
    ELSE 0  
    END  
   ) + (  
   CASE   
    WHEN SUM(OTHER_CHRG) > 0  
     THEN 1  
    ELSE 0  
    END  
   ) + (  
   CASE   
    WHEN SUM(BROKER_CHRG) > 0  
     THEN 1  
    ELSE 0  
    END  
   ) + 3  
 INTO #ROWCOUNT  
 FROM #CONTRACT  
 GROUP BY PARTY_CODE  
 ORDER BY 1  
  
 UPDATE #CONTRACT  
 SET ROW_P_COUNT = PARTY_COUNT,  
  ROW_S_COUNT = SCRIP_COUNT  
 FROM #ROWCOUNT  
 WHERE #ROWCOUNT.PARTY_CODE = #CONTRACT.PARTY_CODE  
  
 SELECT *  
 FROM #CONTRACT  
 ORDER BY YY,  
  MM,  
  DD,  
  TRDFLAG,  
  ORDERBYFLAG,  
  BRANCH_CD,  
  SUB_BROKER,  
  TRADER,  
  PARTY_CODE,  
  CONTRACTNO DESC,  
  INST_TYPE,  
  SYMBOL,  
  CONVERT(DATETIME, EXPIRYDATE),  
  OPTION_TYPE,  
  STRIKE_PRICE,  
  ORDFLG,  
  ORDER_NO,  
  TRADE_NO  
END  
ELSE  
BEGIN  
 SELECT ORDERBYFLAG = (  
   CASE   
    WHEN @COLNAME = 'ORD_N'  
     THEN PARTYNAME  
    WHEN @COLNAME = 'ORD_P'  
     THEN PARTY_CODE  
    WHEN @COLNAME = 'ORD_BP'  
     THEN RTRIM(LTRIM(BRANCH_CD)) + RTRIM(LTRIM(PARTY_CODE))  
    WHEN @COLNAME = 'ORD_BN'  
     THEN RTRIM(LTRIM(BRANCH_CD)) + RTRIM(LTRIM(PARTYNAME))  
    WHEN @COLNAME = 'ORD_DP'  
     THEN RTRIM(LTRIM(BRANCH_CD)) + RTRIM(LTRIM(SUB_BROKER)) + RTRIM(LTRIM(TRADER)) + RTRIM(LTRIM(PARTY_CODE))  
    WHEN @COLNAME = 'ORD_DN'  
     THEN RTRIM(LTRIM(BRANCH_CD)) + RTRIM(LTRIM(SUB_BROKER)) + RTRIM(LTRIM(TRADER)) + RTRIM(LTRIM(PARTYNAME))  
    ELSE RTRIM(LTRIM(BRANCH_CD)) + RTRIM(LTRIM(SUB_BROKER)) + RTRIM(LTRIM(TRADER)) + RTRIM(LTRIM(PARTY_CODE))  
    END  
   ),  
  ORDER_NO,  
  ORDER_TIME,  
  TRADE_NO,  
  TM = TRADETIME,  
  QTY = (PQTY + SQTY),  
  PQTY,  
  SQTY,  
  RATE = PRATE + SRATE,  
  PRATE,  
  SRATE,  
  BROK = PBROK + SBROK,  
  PBROK,  
  SBROK,  
  NETRATE = PNETRATE + SNETRATE,  
  PNETRATE,  
  SNETRATE,  
  AMOUNT,  
  INST_TYPE,  
  SYMBOL,  
  AMT = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN - PAMT  
    ELSE SAMT  
    END  
   ),  
  PAMT,  
  SAMT,  
  AMTSTT = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN - (PAMT + INS_CHRG)  
    ELSE (SAMT - INS_CHRG)  
    END  
   ),  
  PAMTSTT = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN PAMT + INS_CHRG  
    ELSE 0  
    END  
   ),  
  SAMTSTT = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN SAMT - INS_CHRG  
    ELSE 0  
    END  
   ),  
  AMTSER = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN - (PAMT + SERVICE_TAX)  
    ELSE (SAMT - SERVICE_TAX)  
    END  
   ),  
  PAMTSER = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN PAMT + SERVICE_TAX  
    ELSE 0  
    END  
   ),  
  SAMTSER = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN SAMT - SERVICE_TAX  
    ELSE 0  
    END  
   ),  
  AMTSERSTT = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN - (PAMT + PSERVICE_TAX + INS_CHRG)  
    ELSE (SAMT - SSERVICE_TAX - INS_CHRG)  
    END  
   ),  
  PAMTSERSTT = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN PAMT + PSERVICE_TAX + INS_CHRG  
    ELSE 0  
    END  
   ),  
  SAMTSERSTT = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN SAMT - SSERVICE_TAX - INS_CHRG  
    ELSE 0  
    END  
   ),  
  AMTSERSTTSTAMPTRANS = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN - (PAMT + NSERTAX + INS_CHRG + BROKER_CHRG + TURN_TAX)  
    ELSE (SAMT - NSERTAX - INS_CHRG - BROKER_CHRG - TURN_TAX)  
    END  
   ),  
  PAMTSERSTTSTAMPTRANS = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN PAMT + NSERTAX + INS_CHRG + BROKER_CHRG + TURN_TAX  
    ELSE 0  
    END  
   ),  
  SAMTSERSTTSTAMPTRANS = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN SAMT - NSERTAX - INS_CHRG - BROKER_CHRG - TURN_TAX  
    ELSE 0  
    END  
   ),  
  AMTDIFF = 0,  
  EXPIRYDATE,  
  PARTY_CODE,  
  SELL_BUY,  
  CONTRACTNO,  
  SAUDA_DATE,  
  SDT = SAUDA_DATE,  
  STRIKE_PRICE,  
  OPTION_TYPE,  
  PSERVICE_TAX,  
  SSERVICE_TAX,  
  YY,  
  MM,  
  DD,  
  DFLAG,  
  BROKER_CHRG,  
  TURN_TAX,  
  SEBI_TAX,  
  OTHER_CHRG,  
  PINS_CHRG = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN INS_CHRG  
    ELSE 0  
    END  
   ),  
  SINS_CHRG = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN INS_CHRG  
    ELSE 0  
    END  
   ),  
  INS_CHRG,  
  SERVICE_TAX,  
  NSERTAX = SERVICE_TAX,  
  BROKERAGE,  
  PBROKERAGE = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN BROKERAGE  
    ELSE 0  
    END  
   ),  
  SBROKERAGE = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN BROKERAGE  
    ELSE 0  
    END  
   ),  
  BRANCH_CD,  
  SUB_BROKER,  
  TRADER,  
  PRINTF,  
  SERVICE_CHRG,  
  PARTYNAME,  
  L_ADDRESS1,  
  L_ADDRESS2,  
  L_ADDRESS3,  
  L_CITY,  
  L_STATE,  
  L_ZIP,  
  SEBI_NO,  
  PAN_GIR_NO,  
  OFF_PHONE1,  
  OFF_PHONE2,  
  MAPIDID,  
  UCC_CODE,  
  MARKETAMT = (PRATE + SRATE) * (PQTY + SQTY),  
  PMARKETAMT = PRATE * PQTY,  
  SMARKETAMT = SRATE * SQTY,  
  SERIES = '',  
  TMARK = '',  
  SCRIPNAME = (  
   CASE   
    WHEN INST_TYPE LIKE 'FUT%'  
     THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE, 11)  
    ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE, 11) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + ' ' + RTRIM(OPTION_TYPE)  
    END  
   ),  
  PSCRIPNAME = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN (  
       CASE   
        WHEN INST_TYPE LIKE 'FUT%'  
         THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE, 11)  
        ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE, 11) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + ' ' + RTRIM(OPTION_TYPE)  
        END  
       )  
    ELSE ''  
    END  
   ),  
  SSCRIPNAME = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN (  
       CASE   
        WHEN INST_TYPE LIKE 'FUT%'  
         THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE, 11)  
        ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE, 11) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + ' ' + RTRIM(OPTION_TYPE)  
        END  
       )  
    ELSE ''  
    END  
   ),  
  SCRIPNAMESHORT = (  
   CASE   
    WHEN INST_TYPE LIKE 'FUTIDX'  
     THEN 'FI' + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2)  
    WHEN INST_TYPE LIKE 'FUTSTK'  
     THEN 'FS' + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2)  
    WHEN INST_TYPE LIKE 'OPTIDX'  
     THEN 'OI' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
    WHEN INST_TYPE LIKE 'EA-IDX'  
     THEN 'EI' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
    WHEN INST_TYPE LIKE 'EA-STK'  
     THEN 'ES' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
    WHEN INST_TYPE LIKE 'OPTSTK'  
     THEN 'OS' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
    END  
   ),  
  PSCRIPNAMESHORT = (  
   CASE   
    WHEN SELL_BUY = 1  
     THEN (  
       CASE   
        WHEN INST_TYPE LIKE 'FUTIDX'  
         THEN 'FI' + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2)  
        WHEN INST_TYPE LIKE 'FUTSTK'  
         THEN 'FS' + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2)  
        WHEN INST_TYPE LIKE 'OPTIDX'  
         THEN 'OI' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        WHEN INST_TYPE LIKE 'EA-IDX'  
         THEN 'EI' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        WHEN INST_TYPE LIKE 'EA-STK'  
         THEN 'ES' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        WHEN INST_TYPE LIKE 'OPTSTK'  
         THEN 'OS' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        END  
       )      ELSE ''  
    END  
   ),  
  SSCRIPNAMESHORT = (  
   CASE   
    WHEN SELL_BUY = 2  
     THEN (  
       CASE   
        WHEN INST_TYPE LIKE 'FUTIDX'  
         THEN 'FI' + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2)  
        WHEN INST_TYPE LIKE 'FUTSTK'  
         THEN 'FS' + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2)  
        WHEN INST_TYPE LIKE 'OPTIDX'  
         THEN 'OI' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        WHEN INST_TYPE LIKE 'EA-IDX'  
         THEN 'EI' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        WHEN INST_TYPE LIKE 'EA-STK'  
         THEN 'ES' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        WHEN INST_TYPE LIKE 'OPTSTK'  
         THEN 'OS' + ' ' + RTRIM(SYMBOL) + ' ' + RIGHT(LEFT(CONVERT(VARCHAR, EXPIRYDATE, 106), 6), 3) + ' ' + RIGHT(CONVERT(VARCHAR, EXPIRYDATE, 106), 2) + ' ' + RTRIM(CAST(CAST(STRIKE_PRICE AS NUMERIC(18, 2)) AS VARCHAR)) + RTRIM(OPTION_TYPE)  
        END  
       )  
    ELSE ''  
    END  
   ),  
  ORDFLG,  
  TRDFLAG = (  
   CASE   
    WHEN ORDFLG = 3  
     THEN 1  
    ELSE 0  
    END  
   ),  
  ROW_P_COUNT = CONVERT(NUMERIC(18, 0), 0),  
  ROW_S_COUNT = CONVERT(NUMERIC(18, 0), 0)  
 INTO #CONTRACT1  
 FROM #CONTSETTNEW WITH (NOLOCK)  
  
 SELECT PARTY_CODE,  
  PARTY_COUNT = COUNT(PARTY_CODE),  
  SCRIP_COUNT = COUNT(DISTINCT (SCRIPNAME)) + @CHARGES + (  
   CASE   
    WHEN SUM(SERVICE_TAX) > 0  
     THEN 1  
    ELSE 0  
    END  
   ) + (  
   CASE   
    WHEN SUM(INS_CHRG) > 0  
     THEN 1  
    ELSE 0  
    END  
   ) + (  
   CASE   
    WHEN SUM(TURN_TAX) > 0  
     THEN 1  
    ELSE 0  
    END  
   ) + (  
   CASE   
    WHEN SUM(SEBI_TAX) > 0  
     THEN 1  
    ELSE 0  
    END  
   ) + (  
   CASE   
    WHEN SUM(OTHER_CHRG) > 0  
     THEN 1  
    ELSE 0  
    END  
   ) + (  
   CASE   
    WHEN SUM(BROKER_CHRG) > 0  
     THEN 1  
    ELSE 0  
    END  
   ) + 3  
 INTO #ROWCOUNT1  
 FROM #CONTRACT1  
 GROUP BY PARTY_CODE  
 ORDER BY 1  
  
 UPDATE #CONTRACT1  
 SET ROW_P_COUNT = PARTY_COUNT,  
  ROW_S_COUNT = SCRIP_COUNT  
 FROM #ROWCOUNT1  
 WHERE #ROWCOUNT1.PARTY_CODE = #CONTRACT1.PARTY_CODE  
  
 SELECT *  
 FROM #CONTRACT1  
 ORDER BY YY,  
  MM,  
  DD,  
  TRDFLAG,  
  ORDERBYFLAG,  
  BRANCH_CD,  
  SUB_BROKER,  
  TRADER,  
  PARTY_CODE,  
  CONTRACTNO DESC,  
  INST_TYPE,  
  SYMBOL,  
  CONVERT(DATETIME, EXPIRYDATE),  
  OPTION_TYPE,  
  STRIKE_PRICE,  
  ORDFLG,  
  ORDER_NO,  
  TRADE_NO  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_CONTSECTION_DETAIL
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[V2_CONTSECTION_DETAIL]
	(  
	@STATUSID VARCHAR(15),  
	@STATUSNAME VARCHAR(25),   
	@SAUDA_DATE VARCHAR(11),   
	@FROMPARTY_CODE VARCHAR(10),   
	@TOPARTY_CODE VARCHAR(10),   
	@FROMBRANCH VARCHAR(10),   
	@TOBRANCH VARCHAR(10),   
	@FROMSUB_BROKER VARCHAR(10),   
	@TOSUB_BROKER VARCHAR(10),   
	@FROMCONTRACTNO VARCHAR(12),   
	@TOCONTRACTNO VARCHAR(12),   
	@CONTFLAG VARCHAR(10),
	@CLIENTTYPE VARCHAR(30),
	@PRINTALLCLIENT INT = 0,
	@BOUNCEDFLAG INT = 0
	)   

	AS  


CREATE TABLE #BPARTY
( PARTY_CODE VARCHAR(15) )

IF @BOUNCEDFLAG <> 0
BEGIN
	INSERT INTO #BPARTY
	SELECT 
		DISTINCT PARTY_CODE 
	FROM 
		TBL_ECNBOUNCED(NOLOCK) 
	WHERE 
		SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
END
ELSE
BEGIN
	INSERT INTO #BPARTY
	SELECT 
		DISTINCT PARTY_CODE 
	FROM 
		CLIENT2 (NOLOCK) 
	WHERE 
		PARTY_CODE BETWEEN @FROMPARTY_CODE AND @TOPARTY_CODE
END


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SELECT
	SDT=CONVERT(VARCHAR,SAUDA_DATE,103),
	SAUDA_DATE= CONVERT(VARCHAR,SAUDA_DATE,103),
	SDATETIME = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11) +' '+ TRADETIME,
	CONTRACT_MASTER.PARTY_CODE,
	CONTRACTNO,
	ORDER_NO = ORDER_NO,
	TRADE_NO = TRADE_NO,
	TRADETIME = TRADETIME,
	SCRIPNAME =
	        CASE 
                WHEN INST_TYPE LIKE 'FUT%' 
                THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11)     
                ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11) + ' ' + 
			RTRIM(CONVERT(VARCHAR,STRIKE_PRICE)) + ' ' + RTRIM(OPTION_TYPE)    
		END,
	PSCRIPNAME = CASE WHEN SELL_BUY = 1 THEN
		        CASE 
	                WHEN INST_TYPE LIKE 'FUT%' 
	                THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11)     
	                ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11) + 
				' ' + RTRIM(CONVERT(VARCHAR,STRIKE_PRICE)) + ' ' + RTRIM(OPTION_TYPE)    
			END
		ELSE '' END,   
	SSCRIPNAME = CASE WHEN SELL_BUY = 2 THEN
		        CASE 
	                WHEN INST_TYPE LIKE 'FUT%' 
	                THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11)     
	                ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11) + 
				' ' + RTRIM(CONVERT(VARCHAR,STRIKE_PRICE)) + ' ' + RTRIM(OPTION_TYPE)    
			END
		ELSE '' END,   
	BUYSELL = CASE WHEN SELL_BUY = 1 THEN 'B' ELSE 'S' END,
	SELL_BUY,
    QTY,
	PQTY,
	SQTY,
	RATE = PRICE,
	PRATE,
	SRATE,
	BROK = PBROK+ SBROK,
	PBROK ,
	SBROK ,
	BROKERAGE,
	PBROKERAGE = CASE WHEN SELL_BUY =1 THEN BROKERAGE ELSE 0 END,
	SBROKERAGE = CASE WHEN SELL_BUY =2 THEN BROKERAGE ELSE 0 END,
	NETRATE = PNETRATE + SNETRATE,
	PNETRATE,
	SNETRATE,
	MARKETAMT = AMOUNT,
	PMARKETAMT = CASE WHEN SELL_BUY =1 THEN AMOUNT ELSE 0 END,
	SMARKETAMT = CASE WHEN SELL_BUY =2 THEN AMOUNT ELSE 0 END,
	AMT = NETAMOUNT,
	PAMT = CASE WHEN SELL_BUY =1 THEN NETAMOUNT ELSE 0 END,
	SAMT = CASE WHEN SELL_BUY =2 THEN NETAMOUNT ELSE 0 END,
	CONTRACT_DATA.SERVICE_TAX,
	BROKER_CHRG,
	TURN_TAX,
	SEBI_TAX,
	INS_CHRG,
	CONTRACT_DATA.OTHER_CHRG,
	STAX = FOGLOBALS.SERVICE_TAX,
	SDATEY = YEAR(SAUDA_DATE),
	SDATEM = MONTH(SAUDA_DATE),
	SDATED = DAY(SAUDA_DATE), 
	PRICEUNIT,
	QTY_UNIT,
	PARTYNAME,
	L_ADDRESS1,
	L_ADDRESS2,
	L_ADDRESS3,
	L_CITY,
	L_STATE,
	L_ZIP, 
	PAN_GIR_NO,
	RES_PHONE1='',
	OFF_PHONE1,
	OFF_PHONE2,
    BRANCH_CD, 
	SUB_BROKER = SUBBROKER ,
	TRADER,
	SERVICE_CHRG,
	SEBI_NO,
	PARTICIPANTCODE,
	CANNED_DATA =1,
	ORDER_TIME
FROM
	CONTRACT_MASTER (NOLOCK), 
	CONTRACT_DATA (NOLOCK), 
	FOGLOBALS (NOLOCK), 
	CLIENT_PRINT_SETTINGS  CP (NOLOCK) 
WHERE   
	CONTRACT_MASTER.PARTY_CODE = CONTRACT_DATA.PARTY_CODE
	AND LEFT(CONTRACT_MASTER.TRADE_DATE,11) = LEFT(CONTRACT_DATA.SAUDA_DATE,11)
	AND SAUDA_DATE BETWEEN YEAR_START_DT AND YEAR_END_DT
	AND 1 <> CASE WHEN @CONTFLAG = 'CONTRACT' THEN PRINTF ELSE 2 END
	AND SAUDA_DATE >= @SAUDA_DATE 
	AND SAUDA_DATE <= @SAUDA_DATE
	AND CONTRACT_MASTER.PARTY_CODE >= @FROMPARTY_CODE 
	AND CONTRACT_MASTER.PARTY_CODE <= @TOPARTY_CODE 
	AND CONTRACTNO BETWEEN @FROMCONTRACTNO AND @TOCONTRACTNO
	AND BRANCH_CD >= @FROMBRANCH   
	AND BRANCH_CD <= @TOBRANCH   
	AND SUBBROKER >= @FROMSUB_BROKER  
	AND SUBBROKER <= @TOSUB_BROKER   
	AND @STATUSNAME = (
		CASE
		WHEN @STATUSID = 'BRANCH'   
		THEN BRANCH_CD   
		WHEN @STATUSID = 'SUBBROKER'   
		THEN SUBBROKER   
		WHEN @STATUSID = 'TRADER'   
		THEN TRADER   
		WHEN @STATUSID = 'FAMILY'   
		THEN FAMILY   
		WHEN @STATUSID = 'AREA'   
		THEN AREA   
		WHEN @STATUSID = 'REGION'   
		THEN REGION   
		WHEN @STATUSID = 'CLIENT'   
		THEN CONTRACT_MASTER.PARTY_CODE   
		ELSE 'BROKER' 
	END)
	AND PRINTF =  CP.PRINT_FLAG
	AND CP.VALID_REPORT LIKE (CASE WHEN @PRINTALLCLIENT = 0 THEN '%' + @CONTFLAG + '%' ELSE '' END)
	AND CONTRACT_MASTER.PARTY_CODE IN (SELECT PARTY_CODE FROM #BPARTY(NOLOCK))
ORDER BY  
	BRANCH_CD,   
	SUBBROKER,   
	TRADER,   
	CONTRACT_MASTER.PARTY_CODE,   
	CONTRACTNO DESC,
	INST_TYPE,   
	SYMBOL,   
	EXPIRYDATE,    
	OPTION_TYPE,   
	STRIKE_PRICE,   
	ORDFLG,  
	ORDER_NO,   
	TRADE_NO  


SET QUOTED_IDENTIFIER OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_FOBILLDETAIL
-- --------------------------------------------------

CREATE PROCEDURE [V2_FOBILLDETAIL]
	@STATUSID [varchar](20),
	@STATUSNAME [varchar](50),
	@FROMDATE [varchar](11),
	@TODATE [varchar](11) = '',
	@FROMPARTYCODE [varchar](20),
	@TOPARTYCODE [varchar](20),
	@FROMBRANCH [varchar](10),
	@TOBRANCH [varchar](10),
	@FROMSUB_BROKER [varchar](10),
	@TOSUB_BROKER [varchar](10),
	@REPORTMODE [varchar](20),
	@INTPRINTCF [int] = 0,
	@REPORTOPT [varchar](20) = '',
	@DIGIFLAG [int] = 0
AS
IF @TOPARTYCODE ='' BEGIN SET @TOPARTYCODE ='ZZZZZZZZ' END      
IF @TOBRANCH ='' BEGIN SET @TOBRANCH ='ZZZZZZZZ' END      
IF @TOSUB_BROKER ='' BEGIN SET @TOSUB_BROKER ='ZZZZZZZZZ' END      
IF @TODATE = '' BEGIN SET @TODATE = @FROMDATE END 
SET @REPORTMODE='SUMMARY' 
      
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED      
SELECT   
 DISTINCT PARTY_CODE   
 INTO #PARTYLIST  
FROM  
 FOBILLVALAN (NOLOCK)  
WHERE  
 SAUDA_DATE >= @FROMDATE  AND  SAUDA_DATE <= @FROMDATE + ' 23:59'  
 AND PARTY_CODE >= @FROMPARTYCODE       
 AND PARTY_CODE <= @TOPARTYCODE     
  
CREATE CLUSTERED INDEX [IDXCL] ON [#PARTYLIST] ([PARTY_CODE])  
   
SELECT      
 PARTYNAME =C1.LONG_NAME,      
 C2.PARTY_CODE,       
 CLIENT_TYPE = C1.CL_TYPE,       
 C1.L_ADDRESS1,       
 C1.L_ADDRESS2,      
 C1.L_ADDRESS3,      
 C1.L_CITY,      
 C1.L_STATE,      
 C1.L_NATION,      
 C1.L_ZIP,      
 C1.OFF_PHONE1,       
 C1.OFF_PHONE2,       
 BRANCH_CODE = C1.BRANCH_CD,      
 SUB_BROKER = C1.SUB_BROKER,      
 C1.TRADER,      
 C1.PAN_GIR_NO,      
 C2.SERVICE_CHRG      
INTO   
 #CLIENTMASTER      
FROM      
 CLIENT1 C1 (NOLOCK),  
 CLIENT2 C2 (NOLOCK),  
 CLIENT_PRINT_SETTINGS CP (NOLOCK)  
WHERE  
 C1.CL_CODE = C2.CL_CODE      
 AND PARTY_CODE >= @FROMPARTYCODE      
 AND PARTY_CODE <= @TOPARTYCODE      
 AND C2.PARTY_CODE IN (SELECT PARTY_CODE FROM #PARTYLIST (NOLOCK))  
 AND C2.PRINTF = CP.PRINT_FLAG   
 AND CP.VALID_REPORT LIKE (CASE   
     WHEN @DIGIFLAG = 0 THEN '%'   
     WHEN @DIGIFLAG = 1 THEN '%CONTRACT%'   
     WHEN @DIGIFLAG = 2 THEN '%DIGITAL%'   
     ELSE CP.VALID_REPORT   
     END)  
 AND @STATUSNAME = (CASE  
       WHEN @STATUSID = 'BRANCH'  
       THEN C1.BRANCH_CD  
       WHEN @STATUSID = 'SUBBROKER'  
       THEN C1.SUB_BROKER  
       WHEN @STATUSID = 'TRADER'  
       THEN C1.TRADER  
       WHEN @STATUSID = 'FAMILY'  
       THEN C1.FAMILY  
       WHEN @STATUSID = 'AREA'  
       THEN C1.AREA  
       WHEN @STATUSID = 'REGION'  
       THEN C1.REGION  
       WHEN @STATUSID = 'CLIENT'  
       THEN C2.PARTY_CODE  
       ELSE 'BROKER'   
      END)  
 AND BRANCH_CD >= @FROMBRANCH       
 AND BRANCH_CD <= @TOBRANCH       
 AND SUB_BROKER  >= @FROMSUB_BROKER      
 AND SUB_BROKER  <= @TOSUB_BROKER       
      
CREATE CLUSTERED INDEX [IDXCL] ON [#CLIENTMASTER] ([PARTY_CODE])  
  
IF @REPORTMODE <> 'DETAIL'      
BEGIN      
 SELECT      
  F.PARTY_CODE,       
  BILLNO = 0,      
  F.INST_TYPE,       
  F.SYMBOL,      
  CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,      
  F.STRIKE_PRICE,       
  CASE WHEN F.OPTION_TYPE = '' THEN '' ELSE F.OPTION_TYPE END AS OPTION_TYPE,      
  CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103) AS SAUDADATE,      
   CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),112) AS SAUDADATEORD,      
         SCRIPNAME  = (      
         CASE       
                 WHEN INST_TYPE LIKE 'FUT%'       
                 THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11)           
                 ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11) + ' ' +       
   RTRIM(CONVERT(VARCHAR,STRIKE_PRICE)) + ' ' + RTRIM(OPTION_TYPE)          
   END),      
  CL_RATE AS CLRATE,       
  CASE WHEN TRADETYPE = 'BF' THEN       
   CASE WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN CASE       
    WHEN SUM(PQTY) > 0 THEN SUM(PAMT)/SUM(PQTY) ELSE 0 END ELSE 0 END ELSE       
    CASE WHEN SUM(PQTY) > 0 THEN SUM(PAMT)/SUM(PQTY) ELSE 0 END END AS PRATE,      
  CASE WHEN TRADETYPE = 'BF' THEN       
   CASE WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN CASE       
    WHEN SUM(SQTY) > 0 THEN SUM(SAMT)/SUM(SQTY) ELSE 0 END ELSE 0 END ELSE       
    CASE WHEN SUM(SQTY) > 0 THEN SUM(SAMT)/SUM(SQTY) ELSE 0 END END AS SRATE,     
  CASE WHEN TRADETYPE = 'BF' THEN CASE       
   WHEN SUM(F.PQTY) > SUM(F.SQTY) THEN SUM(F.PQTY) - SUM(F.SQTY) ELSE 0 END ELSE SUM(F.PQTY) END AS PQTY,      
  CASE WHEN TRADETYPE = 'BF' THEN CASE       
   WHEN SUM(F.PQTY) < SUM(F.SQTY) THEN SUM(F.SQTY) - SUM(F.PQTY) ELSE 0 END ELSE SUM(F.SQTY) END AS SQTY,      
 CASE WHEN SUM(F.PBILLAMT) > SUM(F.SBILLAMT) THEN SUM(F.PBILLAMT) - SUM(F.SBILLAMT) ELSE 0 END AS PBILLAMT,      
  CASE WHEN SUM(F.SBILLAMT) > SUM(F.PBILLAMT) THEN SUM(F.SBILLAMT) - SUM(F.PBILLAMT) ELSE 0 END AS SBILLAMT,      
    
  SUM((F.PBILLAMT)) - SUM((F.SBILLAMT) ) AS DIFF,      
  SUM(((F.CL_CHRG - F.EXCL_CHRG) + (F.SERVICE_TAX - F.EXSER_TAX) +      
    (F.SEBI_TAX) + (F.TURN_TAX) + (F.BROKER_NOTE) + (F.INS_CHRG) +       
   (F.OTHER_CHRG)) ) AS CHRG_TOTAL,      
  SUM((F.PBILLAMT) + ((F.SERVICE_TAX- F.EXSER_TAX) + (F.TURN_TAX) + (F.SEBI_TAX) +       
    (F.BROKER_NOTE) +  (F.INS_CHRG) + (F.OTHER_CHRG) +       
    (F.CL_CHRG-F.EXCL_CHRG)) ) - SUM((F.SBILLAMT)  ) AS FINALFIGURE,      
  CLEARING_CHRG = SUM(F.CL_CHRG),      
  SERVICE_TAX = SUM(((F.SERVICE_TAX + F.EXSER_TAX)) ),       
  SEBI_TAX = SUM(((F.SEBI_TAX)) ),       
  TURN_TAX = SUM(((F.TURN_TAX)) ),       
  BROKER_NOTE = SUM(((F.BROKER_NOTE)) ),       
  INS_CHRG = SUM(((F.INS_CHRG)) ),       
  OTHER_CHRG = SUM(((F.OTHER_CHRG)) ),       
  TRADETYPE = CASE WHEN F.TRADETYPE = 'BT' AND  AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%'       
    THEN  'FF' ELSE REPLACE(F.TRADETYPE,'BT','') END,      
  MTOM =  SUM(CASE WHEN AUCTIONPART = '' THEN       
    (SBILLAMT+SBROKAMT-PBILLAMT+PBROKAMT) ELSE 0 END)      
 INTO #FOBILL_SUMMARY      
 FROM      
  FOBILLVALAN F (NOLOCK) ,      
  #CLIENTMASTER C2      
 WHERE      
  C2.PARTY_CODE = F.PARTY_CODE      
  AND F.SAUDA_DATE >= @FROMDATE       
  AND F.SAUDA_DATE <= @TODATE +' 23:59:59'       
  AND F.TRADETYPE LIKE (CASE WHEN INST_TYPE LIKE 'OPT%'       
     THEN 'BT'       
     ELSE '%'       
     END )      
 GROUP BY       
  F.PARTY_CODE,       
  F.SYMBOL,       
  F.INST_TYPE,       
  F.EXPIRYDATE,       
  F.STRIKE_PRICE,       
  F.OPTION_TYPE,      
  F.TRADETYPE,       
  CL_RATE,      
  AUCTIONPART      
      
 HAVING CASE WHEN TRADETYPE = 'BF' THEN SUM(SQTY-PQTY) ELSE 1 END <> 0       
      
 IF @INTPRINTCF = 1      
 BEGIN      
  INSERT INTO #FOBILL_SUMMARY      
  SELECT      
   F.PARTY_CODE,       
   BILLNO = 0,      
   F.INST_TYPE,       
   F.SYMBOL,      
   CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,      
   F.STRIKE_PRICE,       
   CASE WHEN F.OPTION_TYPE = '' THEN '' ELSE F.OPTION_TYPE END AS OPTION_TYPE,      
   CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103) AS SAUDADATE,      
   CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),112) AS SAUDADATEORD,      
      SCRIPNAME  = (      
          CASE       
                  WHEN INST_TYPE LIKE 'FUT%'       
                  THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11)           
                  ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11) + ' ' +       
    RTRIM(CONVERT(VARCHAR,STRIKE_PRICE)) + ' ' + RTRIM(OPTION_TYPE)          
    END),      
   CL_RATE AS CLRATE,       
     
   PRATE = (CASE WHEN SUM(F.PQTY - F.SQTY) < 0 THEN CL_RATE ELSE 0 END),      
   SRATE = (CASE WHEN SUM(F.PQTY - F.SQTY) > 0  THEN CL_RATE ELSE 0 END),      
   CASE WHEN SUM(F.PQTY - F.SQTY) < 0  THEN ABS(SUM(F.PQTY - F.SQTY)) ELSE 0 END AS PQTY,      
   CASE WHEN SUM(F.PQTY - F.SQTY) > 0  THEN ABS(SUM(F.PQTY - F.SQTY)) ELSE 0 END AS SQTY,      
   PBILLAMT = 0,   
   SBILLAMT = 0,   
      
   DIFF=0,      
   CHRG_TOTAL=0,      
   FINALFIGURE =0,      
   CLEARING_CHRG = 0,      
   SERVICE_TAX = 0 ,      
   SEBI_TAX = 0,      
   TURN_TAX = 0,       
   BROKER_NOTE = 0,      
   INS_CHRG = 0 ,      
   OTHER_CHRG =0,      
   TRADETYPE = 'CF',      
   MTOM =  0      
        
  FROM      
   FOBILLVALAN F (NOLOCK) ,      
   #CLIENTMASTER C2      
  WHERE      
    C2.PARTY_CODE = F.PARTY_CODE      
  AND F.SAUDA_DATE >= @FROMDATE       
   AND F.SAUDA_DATE <= @TODATE +' 23:59:59'       
   AND F.TRADETYPE LIKE (CASE WHEN INST_TYPE LIKE 'OPT%'       
      THEN 'BT'       
      ELSE '%'       
      END )      
  GROUP BY       
   F.PARTY_CODE,        F.SYMBOL,       
   F.INST_TYPE,       
   F.EXPIRYDATE,       
   F.STRIKE_PRICE,       
   F.OPTION_TYPE,      
   CL_RATE      
  HAVING (CASE WHEN TRADETYPE = 'BF' THEN SUM(F.PQTY - F.SQTY) ELSE 1 END) <> 0 OR (CASE WHEN TRADETYPE = 'BF' THEN SUM(PRATE + SRATE) ELSE 1 END) > 0    
 END      
      
      
END      
ELSE      
BEGIN      
      
DECLARE @PARTYCOUNT VARCHAR (10)      
 SELECT      
  TOP 1 @PARTYCOUNT = PARTY_CODE       
 FROM      
  TBL_MTOMPREMIUMBILL
 WHERE      
  BILLDATE >= @FROMDATE       
  AND BILLDATE <= @TODATE +' 23:59:59'       
      
 CREATE TABLE #FOBILL_DETAIL      
 (      
  PARTY_CODE VARCHAR(10),      
  BILLNO BIGINT,      
  INST_TYPE VARCHAR(7),      
  SYMBOL VARCHAR(12),      
  EXPIRYDATE VARCHAR(11),      
  STRIKE_PRICE MONEY,      
  OPTION_TYPE VARCHAR(2),      
  SAUDADATE VARCHAR(11),      
  SAUDADATEORD VARCHAR(11),      
  SCRIPNAME VARCHAR(50),      
  CL_RATE MONEY,      
  PRATE MONEY,      
  SRATE MONEY,      
  PQTY INT,      
  SQTY INT,      
  PBILLAMT MONEY,      
  SBILLAMT MONEY,      
  DIFF MONEY,      
  CHRG_TOTAL MONEY,      
  FINALFIGURE MONEY,      
  CLEARING_CHRG MONEY,      
  SERVICE_TAX MONEY,      
  SEBI_TAX MONEY,      
  TURN_TAX MONEY,      
  STAMPDUTY MONEY,      
  INSURANCE_CHRG MONEY,      
  OTHER_CHRG MONEY,      
  TRADETYPE VARCHAR(10),      
  MTOM MONEY      
 )      
      
 IF @PARTYCOUNT <> ''      
  BEGIN      
   INSERT INTO #FOBILL_DETAIL      
   SELECT      
   F.PARTY_CODE,       
   BILLNO = 0,      
   F.INST_TYPE,       
   F.SYMBOL,      
   CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,      
   F.STRIKE_PRICE,       
   CASE WHEN F.OPTION_TYPE = '' THEN '' ELSE F.OPTION_TYPE END AS OPTION_TYPE,      
   CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103) AS SAUDADATE,      
    CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),112) AS SAUDADATEORD,      
          SCRIPNAME  = (      
          CASE       
                  WHEN INST_TYPE LIKE 'FUT%'       
                  THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11)           
                  ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11) + ' ' +       
    RTRIM(CONVERT(VARCHAR,STRIKE_PRICE)) + ' ' + RTRIM(OPTION_TYPE)          
    END),      
   CL_RATE AS CLRATE,       
   CASE WHEN SUM(PQTY)-SUM(SQTY) > 0 THEN SUM(NETWITHBROK*PQTY+NETWITHBROK*SQTY) /       
    SUM(PQTY+SQTY) ELSE 0 END AS PRATE,          
   CASE WHEN SUM(PQTY)-SUM(SQTY) < 0 THEN SUM(NETWITHBROK*PQTY+NETWITHBROK*SQTY) /       
    SUM(PQTY+SQTY) ELSE 0 END AS SRATE,          
   (CASE WHEN SUM(PQTY)-SUM(SQTY) > 0 THEN SUM(PQTY)-SUM(SQTY) ELSE 0 END) AS PQTY,            
   (CASE WHEN SUM(PQTY)-SUM(SQTY) < 0 THEN ABS(SUM(PQTY)-SUM(SQTY)) ELSE 0 END) AS SQTY,            
  
   CASE WHEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) < 0       
        THEN ABS(SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)))      
        ELSE 0       
   END        
   AS PBILLAMT ,      
   CASE WHEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) > 0       
        THEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK))      
        ELSE 0       
   END        
   AS SBILLAMT,        
  
   SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) AS DIFF,          
   SUM((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) AS CHRG_TOTAL,            
   SUM((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) -       
   SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) AS FINALFIGURE,              
   CLEARING_CHRG = 0,      
   SERVICE_TAX = SUM(SERVICE_TAX),            
   SEBI_TAX = SUM(F.SEBI_TAX),       
   TURN_TAX = SUM(F.TURN_TAX),     
   STAMPDUTY = SUM(F.STAMPDUTY),   
   INSURANCE_CHRG = SUM(F.INSURANCE_CHRG),   
   OTHER_CHRG = SUM(F.OTHER_CHRG),     
         
   TRADETYPE = CASE WHEN F.BFDAYFLAG = 'B-T' AND  AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%'       
     THEN  'FF' ELSE REPLACE(REPLACE(F.BFDAYFLAG,'-',''),'BT','') END,      
   MTOM = SUM(CASE WHEN AUCTIONPART =''       
     THEN ABS((SQTY-PQTY)*(NETRATE-F.CL_RATE))       
     ELSE 0 END)      
  FROM      
   TBL_MTOMPREMIUMBILL_REPORT F (NOLOCK) ,      
   #CLIENTMASTER C2      
  WHERE      
   C2.PARTY_CODE = F.PARTY_CODE      
   AND F.BILLDATE >= @FROMDATE       
 AND F.BILLDATE <= @TODATE +' 23:59:59'       
       
  GROUP BY       
   F.PARTY_CODE,       
   F.SYMBOL,       
   F.INST_TYPE,       
   F.EXPIRYDATE,       
   F.STRIKE_PRICE,       
   F.OPTION_TYPE,      
   F.BFDAYFLAG,       
   CL_RATE,      
   AUCTIONPART,      
   CASE WHEN F.BFDAYFLAG <> 'B-F' THEN PQTY ELSE '' END,      
   CASE WHEN F.BFDAYFLAG <> 'B-F' THEN SQTY ELSE '' END,      
   CASE WHEN F.BFDAYFLAG <> 'B-F' THEN NETWITHBROK ELSE 0 END          
             
   HAVING CASE WHEN  BFDAYFLAG = 'B-F' THEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK))  ELSE 1 END <> 0      
         
   OR      
   CASE WHEN  BFDAYFLAG = 'B-F' THEN SUM(SQTY-PQTY)  ELSE 1 END <> 0      
             
  END      
 ELSE      
  BEGIN      
   INSERT INTO #FOBILL_DETAIL      
   SELECT F.PARTY_CODE,       
   BILLNO = 0,      
   F.INST_TYPE,       
   F.SYMBOL,      
   CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,      
   F.STRIKE_PRICE,       
   CASE WHEN F.OPTION_TYPE = '' THEN '' ELSE F.OPTION_TYPE END AS OPTION_TYPE,      
    CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103) AS SAUDADATE,      
    CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),112) AS SAUDADATEORD,      
          SCRIPNAME  = (      
          CASE       
                  WHEN INST_TYPE LIKE 'FUT%'       
                  THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11)           
                  ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11) + ' ' +       
    RTRIM(CONVERT(VARCHAR,STRIKE_PRICE)) + ' ' + RTRIM(OPTION_TYPE)          
    END),      
   CL_RATE AS CLRATE,       
   CASE WHEN SUM(PQTY)-SUM(SQTY) > 0 THEN SUM(NETWITHBROK*PQTY+NETWITHBROK*SQTY) /       
    SUM(PQTY+SQTY) ELSE 0 END AS PRATE,          
   CASE WHEN SUM(PQTY)-SUM(SQTY) < 0 THEN SUM(NETWITHBROK*PQTY+NETWITHBROK*SQTY) /       
    SUM(PQTY+SQTY) ELSE 0 END AS SRATE,          
   (CASE WHEN SUM(PQTY)-SUM(SQTY) > 0 THEN SUM(PQTY)-SUM(SQTY) ELSE 0 END) AS PQTY,            
   (CASE WHEN SUM(PQTY)-SUM(SQTY) < 0 THEN ABS(SUM(PQTY)-SUM(SQTY)) ELSE 0 END) AS SQTY,            
  
   CASE WHEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) < 0       
        THEN ABS(SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)))      
        ELSE 0       
   END        
   AS PBILLAMT ,      
   CASE WHEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) > 0       
        THEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK))      
        ELSE 0       
   END        
   AS SBILLAMT,        
  
   SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) AS DIFF,          
   SUM((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) AS CHRG_TOTAL,            
   SUM((SERVICE_TAX+F.SEBI_TAX+F.TURN_TAX+F.STAMPDUTY+F.INSURANCE_CHRG+F.OTHER_CHRG)) -       
   SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK)) AS FINALFIGURE,              
   CLEARING_CHRG = 0,      
   SERVICE_TAX = SUM(SERVICE_TAX),     
   SEBI_TAX = SUM(F.SEBI_TAX),   
   TURN_TAX = SUM(F.TURN_TAX),     
   STAMPDUTY = SUM(F.STAMPDUTY),   
   INSURANCE_CHRG = SUM(F.INSURANCE_CHRG),        
   OTHER_CHRG = SUM(F.OTHER_CHRG),   
         
   TRADETYPE = CASE WHEN F.BFDAYFLAG = 'B-T' AND  AUCTIONPART = 'EA' AND INST_TYPE LIKE 'FUT%'       
     THEN  'FF' ELSE REPLACE(REPLACE(F.BFDAYFLAG,'-',''),'BT','') END,      
   MTOM = SUM(CASE WHEN AUCTIONPART =''       
     THEN ABS((SQTY-PQTY)*(NETRATE-F.CL_RATE))       
     ELSE 0 END)      
  FROM      
   TBL_MTOMPREMIUMBILL F (NOLOCK) ,      
   #CLIENTMASTER C2      
  WHERE      
   C2.PARTY_CODE = F.PARTY_CODE      
   AND F.BILLDATE >= @FROMDATE       
   AND F.BILLDATE <= @TODATE +' 23:59:59'       
       
  GROUP BY       
   F.PARTY_CODE,       
   F.SYMBOL,       
   F.INST_TYPE,       
   F.EXPIRYDATE,       
   F.STRIKE_PRICE,       
   F.OPTION_TYPE,      
   F.BFDAYFLAG,       
   CL_RATE,      
   AUCTIONPART,      
   CASE WHEN F.BFDAYFLAG <> 'B-F' THEN PQTY ELSE '' END,      
   CASE WHEN F.BFDAYFLAG <> 'B-F' THEN SQTY ELSE '' END,      
   CASE WHEN F.BFDAYFLAG <> 'B-F' THEN NETWITHBROK ELSE 0 END          
             
   HAVING CASE WHEN  BFDAYFLAG = 'B-F' THEN SUM((SQTY-PQTY)*(NETRATE-F.CL_RATE)-(BROK))  ELSE 1 END <> 0      
         
   OR      
   CASE WHEN  BFDAYFLAG = 'B-F' THEN SUM(SQTY-PQTY)  ELSE 1 END <> 0      
             
  END      
        
      
 IF @INTPRINTCF = 1      
 BEGIN      
  INSERT INTO #FOBILL_DETAIL      
  SELECT      
   F.PARTY_CODE,       
   BILLNO = 0,      
   F.INST_TYPE,       
   F.SYMBOL,      
   CONVERT(VARCHAR, F.EXPIRYDATE, 103) AS EXPIRYDATE,      
   F.STRIKE_PRICE,       
   CASE WHEN F.OPTION_TYPE = '' THEN '' ELSE F.OPTION_TYPE END AS OPTION_TYPE,      
   CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),103) AS SAUDADATE,      
    CONVERT(VARCHAR,CONVERT(DATETIME,@FROMDATE),112) AS SAUDADATEORD,      
          SCRIPNAME  = (      
          CASE       
                  WHEN INST_TYPE LIKE 'FUT%'       
                  THEN RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11)           
                  ELSE RTRIM(INST_TYPE) + ' ' + RTRIM(SYMBOL) + ' ' + LEFT(EXPIRYDATE,11) + ' ' +       
    RTRIM(CONVERT(VARCHAR,STRIKE_PRICE)) + ' ' + RTRIM(OPTION_TYPE)          
    END),      
   CL_RATE AS CLRATE,       
    
   PRATE = (CASE WHEN SUM(F.PQTY - F.SQTY) < 0 THEN CL_RATE ELSE 0 END),      
   SRATE = (CASE WHEN SUM(F.PQTY - F.SQTY) > 0  THEN CL_RATE ELSE 0 END),      
   CASE WHEN SUM(F.PQTY - F.SQTY) < 0  THEN ABS(SUM(F.PQTY - F.SQTY)) ELSE 0 END AS PQTY,      
   CASE WHEN SUM(F.PQTY - F.SQTY) > 0  THEN ABS(SUM(F.PQTY - F.SQTY)) ELSE 0 END AS SQTY,      
   PBILLAMT = 0,     
   SBILLAMT = 0,   
   DIFF=0,      
   CHRG_TOTAL=0,      
   FINALFIGURE =0,      
   CLEARING_CHRG = 0,      
   SERVICE_TAX = 0 ,      
   SEBI_TAX = 0,      
   TURN_TAX = 0,       
   BROKER_NOTE = 0,      
   INS_CHRG = 0 ,      
   OTHER_CHRG =0,      
   TRADETYPE = 'CF',      
   MTOM =  0       
  FROM      
   FOBILLVALAN F (NOLOCK) ,      
   #CLIENTMASTER C2      
  WHERE      
    C2.PARTY_CODE = F.PARTY_CODE      
   AND F.SAUDA_DATE >= @FROMDATE       
   AND F.SAUDA_DATE <= @TODATE +' 23:59:59'       
   AND F.TRADETYPE LIKE (CASE WHEN INST_TYPE LIKE 'OPT%'       
      THEN 'BT'       
      ELSE '%'       
      END )      
  GROUP BY       
   F.PARTY_CODE,       
   F.SYMBOL,       
   F.INST_TYPE,       
   F.EXPIRYDATE,       
   F.STRIKE_PRICE,       
   F.OPTION_TYPE,      
   CL_RATE      
  HAVING (CASE WHEN TRADETYPE = 'BF' THEN SUM(F.PQTY - F.SQTY) ELSE 1 END) <> 0 OR (CASE WHEN TRADETYPE = 'BF' THEN SUM(PRATE + SRATE) ELSE 1 END) > 0    
 END      
END      
      
      
CREATE TABLE #FOBILL      
(      
 PARTY_CODE VARCHAR(10),      
 BILLNO NVARCHAR(10),      
 INST_TYPE VARCHAR(7),      
 SYMBOL VARCHAR(12),      
 EXPIRYDATE VARCHAR(10),      
 STRIKE_PRICE INT,      
 OPTION_TYPE VARCHAR(2),      
 SAUDADATE VARCHAR(10),      
 SAUDADATEORD VARCHAR(10),      
 SCRIPNAME VARCHAR(40),      
 CLRATE MONEY,      
 PRATE MONEY,      
 SRATE MONEY,      
 PQTY INT,      
 SQTY INT,      
 PBILLAMT MONEY,      
 SBILLAMT MONEY,      
 DIFF MONEY,      
 CHRG_TOTAL MONEY,      
 FINALFIGURE MONEY,      
 CLEARING_CHRG MONEY,      
 SERVICE_TAX MONEY,      
 SEBI_TAX MONEY,      
 TURN_TAX MONEY,      
 BROKER_NOTE MONEY,      
 INS_CHRG MONEY,      
 OTHER_CHRG MONEY,      
 TRADETYPE VARCHAR(3),      
 MTOM MONEY      
)      
       
IF @REPORTMODE <> 'DETAIL'      
BEGIN      
 INSERT INTO #FOBILL SELECT * FROM #FOBILL_SUMMARY      
 DROP TABLE #FOBILL_SUMMARY      
END      
ELSE      
BEGIN      
 INSERT INTO #FOBILL SELECT * FROM #FOBILL_DETAIL      
 DROP TABLE #FOBILL_DETAIL      
END      
      
UPDATE #FOBILL      
SET BILLNO = FA.BILL_NO      
FROM FOACCBILL FA      
WHERE FA.PARTY_CODE = #FOBILL.PARTY_CODE      
AND  BILLDATE >= @FROMDATE       
AND BILLDATE <= @TODATE +' 23:59:59'      
      
      
IF @REPORTOPT = 'PRE_PRINT' AND @INTPRINTCF = 1      
BEGIN      
SELECT     
  PARTYNAME,PARTY_CODE,      
  L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,L_NATION,L_ZIP,      
  OFF_PHONE1,OFF_PHONE2,      
  BRANCH_CODE,SUB_BROKER,TRADER,      
  PAN_GIR_NO,SERVICE_CHRG,BILLNO,      
  INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,      
  SAUDADATE,      
  SAUDADATEORD,      
  SCRIPNAME,      
  CLRATE= CASE WHEN SUM(PQTY+SQTY) >0 THEN SUM(CLRATE * (PQTY+SQTY)) / SUM(PQTY+SQTY) ELSE 0 END,      
  BF_QTY = SUM(BF_QTY),      
  BF_RATE = CASE WHEN SUM(BF_QTY) > 0 THEN  SUM(BF_RATE*BF_QTY)/ SUM(BF_QTY) ELSE 0 END,      
  BF_AMT=SUM(BF_AMT),      
  BT_PQTY=SUM(BT_PQTY),      
  BT_SQTY=SUM(BT_SQTY),      
  BT_PRATE= CASE WHEN SUM(BT_PQTY) > 0 THEN SUM(BT_PRATE*BT_PQTY)/SUM(BT_PQTY) ELSE 0 END ,      
  BT_SRATE=CASE WHEN SUM(BT_SQTY) >0 THEN SUM(BT_SRATE*BT_SQTY)/SUM(BT_SQTY) ELSE 0 END ,      
  BT_PAMT=SUM(BT_PAMT),      
  BT_SAMT=SUM(BT_SAMT),      
  BT_DIFF=SUM(BT_DIFF),      
  CF_RATE=CASE WHEN SUM(CF_QTY) > 0 THEN SUM(CF_RATE*CF_QTY)/SUM(CF_QTY) ELSE 0 END ,      
  CF_QTY=SUM(CF_QTY),      
  CF_AMOUNT=SUM(CF_AMOUNT),      
  PRATE= CASE WHEN SUM(PQTY) > 0 THEN SUM(PRATE*PQTY)/SUM(PQTY) ELSE 0 END ,      
  SRATE= CASE WHEN SUM(SQTY) > 0 THEN SUM(SRATE*SQTY)/SUM(SQTY) ELSE 0 END,      
  PQTY=SUM(PQTY),      
  SQTY=SUM(SQTY),      
  PBILLAMT=SUM(PBILLAMT),      
  SBILLAMT=SUM(SBILLAMT),      
  CHRG_TOTAL=SUM(CHRG_TOTAL),      
  FINALFIGURE=SUM(FINALFIGURE),      
  CLEARING_CHRG = SUM(CLEARING_CHRG),      
  SERVICE_TAX=SUM(SERVICE_TAX),      
  SEBI_TAX=SUM(SEBI_TAX),      
  TURN_TAX=SUM(TURN_TAX),      
  BROKER_NOTE=SUM(BROKER_NOTE),      
  INS_CHRG=SUM(INS_CHRG),      
  OTHER_CHRG=SUM(OTHER_CHRG),   
  TRADETYPE,      
  TRADETYPE_P = CASE WHEN SUM(PQTY) > 0 THEN TRADETYPE ELSE '' END,      
  TRADETYPE_S = CASE WHEN SUM(SQTY) > 0 THEN TRADETYPE ELSE '' END,      
  MTOM=SUM(MTOM)      
FROM      
(      
 SELECT       
  PARTYNAME,#CLIENTMASTER.PARTY_CODE,      
  L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,L_NATION,L_ZIP,      
  OFF_PHONE1,OFF_PHONE2,      
  BRANCH_CODE,SUB_BROKER,TRADER,      
  PAN_GIR_NO,SERVICE_CHRG,BILLNO,      
  INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,      
  SAUDADATE,SAUDADATEORD,      
  SCRIPNAME,CLRATE,      
      
  BF_QTY = CASE WHEN PQTY >0 THEN PQTY ELSE SQTY END,      
  BF_RATE = CASE WHEN PQTY > 0 THEN PRATE ELSE SRATE END ,      
  BF_AMT = 0,      
        
  BT_PQTY = 0,      
  BT_SQTY = 0,      
  BT_PRATE = 0,      
  BT_SRATE = 0,      
  BT_PAMT = 0,      
  BT_SAMT = 0,      
  BT_DIFF = 0,      
      
  CF_QTY = 0,      
  CF_RATE = 0,      
  CF_AMOUNT = 0,      
      
  PRATE,SRATE,      
  PQTY,SQTY,PBILLAMT,SBILLAMT,      
      
  CHRG_TOTAL,      
  FINALFIGURE,      
  CLEARING_CHRG,      
  SERVICE_TAX,SEBI_TAX,TURN_TAX,      
  BROKER_NOTE,INS_CHRG,OTHER_CHRG,      
  TRADETYPE,      
  MTOM=0     
      
 FROM #FOBILL ,#CLIENTMASTER       
 WHERE      
  #CLIENTMASTER.PARTY_CODE = #FOBILL.PARTY_CODE      
  AND TRADETYPE = 'BF'      
  AND (PQTY > 0  OR SQTY > 0)      
       
 UNION ALL      
       
 SELECT       
  PARTYNAME,#CLIENTMASTER.PARTY_CODE,      
  L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,L_NATION,L_ZIP,      
  OFF_PHONE1,OFF_PHONE2,      
  BRANCH_CODE,SUB_BROKER,TRADER,      
  PAN_GIR_NO,SERVICE_CHRG,BILLNO,      
  INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,      
  SAUDADATE,SAUDADATEORD,      
  SCRIPNAME,CLRATE,      
      
  BF_QTY = 0,      
  BF_RATE = 0,      
  BF_AMT = 0,      
        
  BT_PQTY = PQTY,      
  BT_SQTY = SQTY,      
  BT_PRATE = PRATE,      
  BT_SRATE = SRATE,      
  BT_PAMT = PBILLAMT,      
  BT_SAMT = SBILLAMT,      
  BT_DIFF = (PBILLAMT-SBILLAMT),      
      
  CF_QTY = 0,      
  CF_RATE = 0 ,      
  CF_AMOUNT = 0,      
      
  PRATE,SRATE,      
  PQTY,SQTY,PBILLAMT,SBILLAMT,      
      
  CHRG_TOTAL,      
  FINALFIGURE,      
  CLEARING_CHRG,      
  SERVICE_TAX,SEBI_TAX,TURN_TAX,   
  BROKER_NOTE,INS_CHRG,OTHER_CHRG,      
  TRADETYPE,      
  MTOM    
      
 FROM #FOBILL ,#CLIENTMASTER       
 WHERE      
  #CLIENTMASTER.PARTY_CODE = #FOBILL.PARTY_CODE      
  AND ( TRADETYPE = '' OR TRADETYPE = 'BT' )      
  AND (PQTY > 0  OR SQTY > 0 OR SYMBOL = 'BROKERAGE')  
       
 UNION ALL      
      
 SELECT       
  PARTYNAME,#CLIENTMASTER.PARTY_CODE,      
  L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,L_NATION,L_ZIP,      
  OFF_PHONE1,OFF_PHONE2,      
  BRANCH_CODE,SUB_BROKER,TRADER,      
  PAN_GIR_NO,SERVICE_CHRG,BILLNO,      
  INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,      
  SAUDADATE,SAUDADATEORD,      
  SCRIPNAME,CLRATE,      
      
  BF_QTY = 0,      
  BF_RATE = 0,      
  BF_AMT = 0,      
        
  BT_PQTY = 0,      
  BT_SQTY = 0,      
  BT_PRATE = 0,      
  BT_SRATE = 0,      
  BT_PAMT = 0,      
  BT_SAMT = 0,      
  BT_DIFF = 0,      
      
  CF_QTY = CASE WHEN PQTY >0 THEN PQTY ELSE SQTY END,      
  CF_RATE = CASE WHEN PQTY > 0 THEN PRATE ELSE SRATE END ,      
  CF_AMOUNT = (CASE WHEN PQTY >0 THEN PQTY ELSE SQTY END ) * CLRATE,      
      
  PRATE,SRATE,      
  PQTY,SQTY,PBILLAMT,SBILLAMT,      
      
  CHRG_TOTAL,      
  FINALFIGURE,      
  CLEARING_CHRG,      
  SERVICE_TAX,SEBI_TAX,TURN_TAX,      
  BROKER_NOTE,INS_CHRG,OTHER_CHRG,      
  TRADETYPE,      
  MTOM=0     
      
 FROM #FOBILL ,#CLIENTMASTER       
 WHERE      
  #CLIENTMASTER.PARTY_CODE = #FOBILL.PARTY_CODE      
  AND  TRADETYPE = 'CF'      
  AND (PQTY > 0  OR SQTY > 0)      
      
 ) FOBILL      
 GROUP BY       
  PARTYNAME,PARTY_CODE,      
  L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,L_NATION,L_ZIP,      
  OFF_PHONE1,OFF_PHONE2,      
  BRANCH_CODE,SUB_BROKER,TRADER,      
  PAN_GIR_NO,SERVICE_CHRG,BILLNO,      
  INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,SCRIPNAME,  
  SAUDADATE,      
  SAUDADATEORD,      
  TRADETYPE      
  
 HAVING SUM(PBILLAMT+SBILLAMT) > 0  
      
 ORDER BY       
  PARTY_CODE,       
  SAUDADATEORD,      
  PARTYNAME,       
  SUB_BROKER,      
  SYMBOL,       
  INST_TYPE,       
  EXPIRYDATE,       
  STRIKE_PRICE,       
  OPTION_TYPE      
       
 END      
ELSE      
BEGIN      
      
 SELECT       
  PARTYNAME,#CLIENTMASTER.PARTY_CODE,CLIENT_TYPE,      
  L_ADDRESS1,L_ADDRESS2,L_ADDRESS3,L_CITY,L_STATE,L_NATION,L_ZIP,      
  OFF_PHONE1,OFF_PHONE2,      
  BRANCH_CODE,SUB_BROKER,TRADER,      
  PAN_GIR_NO,SERVICE_CHRG,BILLNO,      
  INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,       
  SAUDADATE,SAUDADATEORD,      
  SCRIPNAME,CLRATE,PRATE,SRATE,      
  PQTY,SQTY,PBILLAMT,SBILLAMT,DIFF,CHRG_TOTAL,      
  FINALFIGURE,CLEARING_CHRG,      
  SERVICE_TAX,SEBI_TAX,TURN_TAX,      
  BROKER_NOTE,INS_CHRG,OTHER_CHRG,      
  TRADETYPE,      
  TRADETYPE_P = CASE WHEN PQTY > 0 THEN TRADETYPE ELSE '' END,      
  TRADETYPE_S = CASE WHEN SQTY > 0 THEN TRADETYPE ELSE '' END,      
  MTOM,      
  INTORDER = CASE WHEN TRADETYPE = 'BF' THEN 1 ELSE CASE WHEN TRADETYPE='CF' THEN 3 ELSE 2 END END       
       
 FROM #FOBILL ,#CLIENTMASTER       
 WHERE      
  #CLIENTMASTER.PARTY_CODE = #FOBILL.PARTY_CODE      
  AND (PQTY > 0  OR SQTY > 0 OR SYMBOL = 'BROKERAGE')  
        
 ORDER BY       
  #CLIENTMASTER.PARTY_CODE,       
  SAUDADATEORD,      
  PARTYNAME,       
  SUB_BROKER,      
  SYMBOL,       
  INST_TYPE,       
  EXPIRYDATE,       
  STRIKE_PRICE,       
  OPTION_TYPE,       
  INTORDER  
 END      
  
DROP TABLE #FOBILL      
DROP TABLE #CLIENTMASTER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_GETMARGINREQ
-- --------------------------------------------------
CREATE PROC [dbo].[V2_GETMARGINREQ](
           @MARGINDATE VARCHAR(11),
           @FCODE      VARCHAR(10),
           @TCODE      VARCHAR(10),
           @STATUSID   VARCHAR(15),
           @STATUSNAME VARCHAR(15),
           @STRBRANCH  VARCHAR(10))

AS

  SET NOCOUNT ON
  
  DECLARE  @TDATE    DATETIME, 
           @EXCHANGE VARCHAR(3) 

  SELECT   TOP 1 @TDATE = MARGINDATE
  FROM     TBL_CLIENTMARGIN WITH (NOLOCK)
  WHERE    MARGINDATE <= @MARGINDATE + ' 23:59:59'
  ORDER BY 1 DESC
           
  SET @MARGINDATE = LEFT(@TDATE,11)

  SELECT   TOP 1 @EXCHANGE = EXCHANGE
  FROM     FOGLOBALS WITH (NOLOCK)
                    
  IF @STATUSID <> 'AREA'
      OR @STATUSID <> 'REGION'
    BEGIN
      SELECT VOUDT = MARGINDATE,
             EFFDT = MARGINDATE,
             SHORTDESC = '0IM',
             DRAMT = INITIALMARGIN,
             CRAMT = 0,
             VNO = '0',
             DDNO = '0',
             NARRATION = @EXCHANGE + ' - INITIAL MARGIN AS ON ' + @MARGINDATE,
             CLTCODE = PARTY_CODE,
             VTYP = '8',
             VDT = @MARGINDATE,
             EDT = @MARGINDATE
      FROM   TBL_CLIENTMARGIN WITH (NOLOCK)
      WHERE  LEFT(MARGINDATE,11) = @MARGINDATE
             AND PARTY_CODE BETWEEN @FCODE AND @TCODE
             AND BRANCH_CD LIKE @STRBRANCH
             AND INITIALMARGIN > 0
             AND @STATUSNAME = (CASE 
                                  WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD
                                  WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
                                  WHEN @STATUSID = 'TRADER' THEN TRADER
                                  WHEN @STATUSID = 'FAMILY' THEN FAMILY
                                  WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
                                  ELSE 'BROKER'
                                END)
      UNION ALL
      SELECT VOUDT = MARGINDATE,
             EFFDT = MARGINDATE,
             SHORTDESC = '1EX',
             DRAMT = MTMMARGIN,
             CRAMT = 0,
             VNO = '0',
             DDNO = '0',
             NARRATION = @EXCHANGE + ' - EXPOSURE MARGIN AS ON ' + @MARGINDATE,
             CLTCODE = PARTY_CODE,
             VTYP = '8',
             VDT = @MARGINDATE,
             EDT = @MARGINDATE
      FROM   TBL_CLIENTMARGIN WITH (NOLOCK)
      WHERE  MARGINDATE = @MARGINDATE
             AND PARTY_CODE BETWEEN @FCODE AND @TCODE
             AND BRANCH_CD LIKE @STRBRANCH
             AND MTMMARGIN > 0
             AND @STATUSNAME = (CASE 
                                  WHEN @STATUSID = 'BRANCH' THEN BRANCH_CD
                                  WHEN @STATUSID = 'SUBBROKER' THEN SUB_BROKER
                                  WHEN @STATUSID = 'TRADER' THEN TRADER
                                  WHEN @STATUSID = 'FAMILY' THEN FAMILY
                                  WHEN @STATUSID = 'CLIENT' THEN PARTY_CODE
                                  ELSE 'BROKER'
                                END)
      ORDER BY 9,
               3
    END
  ELSE
    BEGIN
      SELECT VOUDT = MARGINDATE,
             EFFDT = MARGINDATE,
             SHORTDESC = '0IM',
             DRAMT = INITIALMARGIN,
             CRAMT = 0,
             VNO = '0',
             DDNO = '0',
             NARRATION = '',
             CLTCODE = PARTY_CODE,
             VTYP = '8',
             VDT = @MARGINDATE,
             EDT = @MARGINDATE
      FROM   TBL_CLIENTMARGIN WITH (NOLOCK),
             (SELECT STATUSID = 'AREA',
                     STATUSNAME = AREACODE,
                     BRANCH_CODE
              FROM   AREA WITH (NOLOCK)
              UNION ALL
              SELECT STATUSID = 'REGION',
                     STATUSNAME = REGIONCODE,
                     BRANCH_CODE
              FROM   REGION WITH (NOLOCK)) E
      WHERE  LEFT(MARGINDATE,11) = @MARGINDATE
             AND PARTY_CODE BETWEEN @FCODE AND @TCODE
             AND BRANCH_CD = BRANCH_CODE
             AND BRANCH_CD LIKE @STRBRANCH
             AND INITIALMARGIN > 0
             AND STATUSNAME = @STATUSNAME
             AND STATUSID = @STATUSID
      UNION ALL
      SELECT VOUDT = MARGINDATE,
             EFFDT = MARGINDATE,
             SHORTDESC = '1EX',
             DRAMT = MTMMARGIN,
             CRAMT = 0,
             VNO = '0',
             DDNO = '0',
             NARRATION = '',
             CLTCODE = PARTY_CODE,
             VTYP = '8',
             VDT = @MARGINDATE,
             EDT = @MARGINDATE
      FROM   TBL_CLIENTMARGIN WITH (NOLOCK),
             (SELECT STATUSID = 'AREA',
                     STATUSNAME = AREACODE,
                     BRANCH_CODE
              FROM   AREA WITH (NOLOCK)
              UNION ALL
              SELECT STATUSID = 'REGION',
                     STATUSNAME = REGIONCODE,
                     BRANCH_CODE
              FROM   REGION WITH (NOLOCK)) E
      WHERE  LEFT(MARGINDATE,11) = @MARGINDATE
             AND PARTY_CODE BETWEEN @FCODE AND @TCODE
             AND BRANCH_CD = BRANCH_CODE
             AND BRANCH_CD LIKE @STRBRANCH
             AND MTMMARGIN > 0
             AND STATUSNAME = @STATUSNAME
             AND STATUSID = @STATUSID
      ORDER BY 9,
               3
    END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_OBJECTLISTING
-- --------------------------------------------------
CREATE PROC [dbo].[V2_OBJECTLISTING]  
  
AS  
  
SELECT B.NAME TABLENAME, A.ROWCNT ROWCNT, CAST(SUM(C.USED)*8192/1024  AS VARCHAR) + ' KB' SPACEUSED  
FROM SYSINDEXES A, SYSOBJECTS B, SYSINDEXES C  
WHERE A.ID = B.ID  
AND A.INDID = 0  
AND A.ID = C.ID  
AND C.INDID IN (0,1,255)  
AND B.XTYPE = 'U'  
GROUP BY B.NAME, A.ROWCNT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROCESS_STATUS_LOG_UPD
-- --------------------------------------------------

CREATE PROC [dbo].[V2_PROCESS_STATUS_LOG_UPD] 

(
	@@SAUDA_DATE VARCHAR(11),
	@PROCESSID VARCHAR(10), 
	@FILENAME VARCHAR(255),
	@UNAME VARCHAR(20),
	@MACHINEIP VARCHAR(20) =''

)
AS

DECLARE @PROCESSNAME VARCHAR(50)
SET @PROCESSNAME = @PROCESSID

SELECT @PROCESSNAME = 
CASE 
	WHEN @PROCESSID = 'BILLGEN' THEN 'BILL GENERATION'
	WHEN @PROCESSID = 'CHKPOST' THEN 'BILL POSTING'
	WHEN @PROCESSID = 'CONTRACT' THEN 'CONTRACT POP'
	WHEN @PROCESSID = 'IMPTRD' THEN 'IMPORT TRADE'
	WHEN @PROCESSID = 'CHKSTTIMP'THEN 'EXCH STT IMPORT'
	WHEN @PROCESSID = 'MRGFILE' THEN 'MARGIN RET FILE GEN'
	WHEN @PROCESSID = 'MRGIMP' THEN 'EXCH MARGIN IMPORT'
	WHEN @PROCESSID = 'MRGPOP' THEN 'MARGIN REP POP'
	WHEN @PROCESSID = 'POSIMP' THEN 'EXCH POS IMPORT'
	WHEN @PROCESSID = 'CLOSING' THEN 'CLOSING FILE IMPORT'
	WHEN @PROCESSID = 'STT' THEN 'STT COMPUTATION'
	WHEN @PROCESSID = 'VBB' THEN 'VBB COMPUTATION'
	WHEN @PROCESSID = 'CNTMST' THEN 'CONTRACT MST IMPORT'
	WHEN @PROCESSID = 'CLOSE' THEN 'CLOSE TR DATE'
END


IF (SELECT COUNT(1)  
  FROM   (SELECT TOP 1 BUSINESS_DATE  
          FROM   V2_BUSINESS_PROCESS  
          WHERE  LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE) A) = 0  
BEGIN    
	INSERT INTO V2_BUSINESS_PROCESS 
		(
			BUSINESS_DATE,IMPORT_TRADE,VBB,STT,BILLING,CONTRACT,
			POSTING,POSITIONFILE,MARGINFILE,MARGINRETURNFILE,
			CLIENTMARGINPOP,EXCHANGESTT,EXERCISEALLOCATION,OPEN_CLOSE,
			PROCESSDATE,PROCESSBY,LASTUPDATEDATE,LASTUPDATEBY,MACHINEIP
		)
	SELECT 	
		BUSINESS_DATE = @@SAUDA_DATE,
		IMPORT_TRADE		= 0,VBB 		= 0,STT 		= 0,
		BILLING 		= 0,CONTRACT 		= 0,POSTING 		= 0,
		POSITIONFILE 		= 0,MARGINFILE 		= 0,MARGINRETURNFILE 	= 0,
		CLIENTMARGINPOP 	= 0,EXCHANGESTT 	= 0,EXERCISEALLOCATION 	= 0,
		OPEN_CLOSE 		= 0,
		PROCESSDATE 		= GETDATE(),
		PROCESSBY 		= @UNAME,
		LASTUPDATEDATE 		= GETDATE(),
		LASTUPDATEBY		= '',
		MACHINEIP 		= @MACHINEIP

END

IF @PROCESSID = 'VBB' /*VBB COMPUTATION*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		VBB 			= VBB + 1,
		BILLING 		= 0,CONTRACT		= 0,
		POSTING 		= 0,MARGINRETURNFILE 	= 0,
		CLIENTMARGINPOP 	= 0,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END


IF @PROCESSID = 'CHKSTTIMP' /*EXCHG STT IMPORT*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		EXCHANGESTT 		= EXCHANGESTT + 1,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END
	

IF @PROCESSID = 'IMPTRD'  /*IMPORT TRADE*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 
		IMPORT_TRADE 		= IMPORT_TRADE + 1,
		VBB 			= 0,STT 		= 0,
		BILLING 		= 0,CONTRACT		= 0,POSTING 		= 0,
		POSITIONFILE 		= 0,MARGINFILE 		= 0,MARGINRETURNFILE 	= 0,
		CLIENTMARGINPOP 	= 0,EXCHANGESTT 	= 0,EXERCISEALLOCATION 	= 0,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END


IF @PROCESSID = 'STT' /*STT COMPUTATION*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		STT 			= STT + 1,
		BILLING 		= 0,CONTRACT		= 0,
		POSTING 		= 0,MARGINRETURNFILE 	= 0,
		CLIENTMARGINPOP 	= 0,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END


IF @PROCESSID = 'BILLGEN' OR @PROCESSID = 'VALANGEN' /*BILL GENERATION*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		BILLING 		= BILLING + 1,
		CONTRACT		= 0,POSTING 		= 0,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END




IF @PROCESSID = 'CONTRACT' /*CONTRACT PRINT DATA POPUP*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		CONTRACT 		= CONTRACT + 1,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END
	

IF @PROCESSID = 'MRGFILE' /*MARGIN RETURN FILE GENEATION*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		MARGINRETURNFILE 		= MARGINRETURNFILE + 1,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END
	

	

IF @PROCESSID = 'MRGIMP' /*IMPORT EXCHG MARGIN FILE*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		MARGINFILE 		= MARGINFILE + 1,
		MARGINRETURNFILE =0,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END
	

IF @PROCESSID = 'MRGPOP' /*MARGIN REPORT DATA POP*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		CLIENTMARGINPOP 		= CLIENTMARGINPOP + 1,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END
	


IF @PROCESSID = 'POSIMP' /*IMPORT EXCHG POSITION FILE*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		POSITIONFILE 		= POSITIONFILE + 1,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END
	

IF @PROCESSID = 'CNTMST' /*CONTRACT MASTER IMPORT*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		STT 			= 0,
		BILLING 		= 0,
		CONTRACT		= CONTRACT + 1,
		POSTING 		= 0,MARGINRETURNFILE 	= 0,
		CLIENTMARGINPOP 	= 0,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END



IF @PROCESSID = 'CLOSING' /*CLOSING RATE FILE IMPORT*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		VBB 			= VBB + 1,
		BILLING 		= 0,CONTRACT		= 0,
		POSTING 		= 0,MARGINRETURNFILE 	= 0,
		CLIENTMARGINPOP 	= 0,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END




IF @PROCESSID = 'CLOSE' /*CLOSE TRADING DAY*/
BEGIN
	UPDATE 
		V2_BUSINESS_PROCESS 
	SET 

		OPEN_CLOSE 	=  1,
		LASTUPDATEDATE = GETDATE(),
		LASTUPDATEBY = @UNAME 	,
		MACHINEIP = @MACHINEIP	
	WHERE 
		LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE	
END
	


IF @PROCESSID = 'CHKPOST' /*CHECKING BLL POSTING STATUS*/
BEGIN


      DECLARE @POSTFLAG INT

      SELECT * INTO #ACCBILL FROM FOACCBILL  (NOLOCK)
      WHERE BILLDATE LIKE @@SAUDA_DATE + '%' 
	  AND AMOUNT <> 0
  
      SELECT * INTO #BILLMATCH FROM ACCOUNTCURBFO.DBO.BILLMATCH  (NOLOCK)
      WHERE DATE LIKE @@SAUDA_DATE + '%' 
	  AND AMOUNT <> 0
  
      SELECT @POSTFLAG = ISNULL(COUNT(1),0)  
      FROM   (SELECT   POSTFLAG = ISNULL(B.PARTY_CODE,'0')  
              FROM     #ACCBILL A  
                       LEFT OUTER JOIN #BILLMATCH B  
                         ON ( A.PARTY_CODE = B.PARTY_CODE  
                             AND A.AMOUNT = B.AMOUNT  
                             AND SELL_BUY = (CASE   
                                               WHEN DRCR = 'D' THEN 1  
                                               ELSE 2  
                                             END))  
              WHERE    
					NOT EXISTS (SELECT ACCODE  
                                       FROM   VALANACCOUNT  
                                       WHERE  ACCODE = A.PARTY_CODE)  
              GROUP BY ISNULL(B.PARTY_CODE,'0')  
              UNION   
              SELECT POSTFLAG = '0'  
              FROM   #BILLMATCH B  
              WHERE  NOT EXISTS (SELECT PARTY_CODE  
                                     FROM   #ACCBILL A  
                                     WHERE  A.PARTY_CODE = B.PARTY_CODE  
				)) P  
         WHERE  POSTFLAG = '0'  
                          

	DROP TABLE #BILLMATCH
	DROP TABLE #ACCBILL

	IF (SELECT COUNT(1)  
        	  FROM   ACCOUNTCURBFO.DBO.BILLPOSTED  (NOLOCK)
	          WHERE  LEFT(VDT,11) = @@SAUDA_DATE) > 0
	BEGIN
		UPDATE 
			V2_BUSINESS_PROCESS 
		SET 	
			POSTING 	=  CASE WHEN  BILLING = 0 THEN 0 
						ELSE (CASE   
							                          WHEN @POSTFLAG = 0 THEN 1  
							                          ELSE 0  
							                        END) 
						END
		WHERE 
			LEFT(BUSINESS_DATE,11) = @@SAUDA_DATE			
	END
END


IF @PROCESSID <> 'INSTCONS' AND @PROCESSID <> 'CHKPOST'
BEGIN
	
	INSERT INTO V2_PROCESS_STATUS_LOG 
	( 
		EXCHANGE,SEGMENT,BUSINESSDATE,PROCESSID,PROCESSNAME,
		FILENAME,START_END_FLAG,PROCESSDATE,PROCESSBY,MACHINEIP
	)
	SELECT
		EXCHANGE=(SELECT TOP 1 EXCHANGE FROM FOTAXES),
		SEGMENT='FUTURES',
		BUSINESSDATE=@@SAUDA_DATE,
		PROCESSID = @PROCESSID,
		PROCESSNAME= @PROCESSNAME,
		FILENAME=@FILENAME,
		START_END_FLAG=1,
		PROCESSDATE=GETDATE(),
		PROCESSBY=@UNAME,
		MACHINEIP= @MACHINEIP
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_PROCESSFORTODAY
-- --------------------------------------------------
CREATE PROC [dbo].[V2_PROCESSFORTODAY]
(  
           @PROCESSFLAG VARCHAR(15),  
           @UNAME       VARCHAR(50),  
           @PROCESSDATE VARCHAR(11)
)  
AS  

	


	/*-------------------------------------------------------------------------*/

	IF @PROCESSFLAG = 'VBB'  
	BEGIN  
		EXEC PR_CHARGES_DETAIL @PROCESSDATE,@PROCESSDATE,'0','ZZZZZZ',@UNAME
	END


	IF @PROCESSFLAG = 'STT'  
	BEGIN  
		EXEC STT_CHARGES_FINAL @PROCESSDATE,'0','ZZZZZZ',@UNAME
	END

	/*-------------------------------------------------------------------------*/

	IF @PROCESSFLAG = 'BILLGEN'  
	BEGIN  
		EXEC FOBILLGENERATE @PROCESSDATE,@UNAME
	END

	IF @PROCESSFLAG = 'VALANGEN'  
	BEGIN  
		EXEC FOVALANGENERATE @PROCESSDATE,@UNAME
	END

	/*-------------------------------------------------------------------------*/
	IF @PROCESSFLAG = 'CONTRACT'  
	BEGIN  
		EXEC POP_CONTRACTDATA @PROCESSDATE,@UNAME
	END

	/*-------------------------------------------------------------------------*/
	IF @PROCESSFLAG = 'CLOSE'  
	BEGIN 
		EXEC V2_PROCESS_STATUS_LOG_UPD @PROCESSDATE,@PROCESSFLAG,'',@UNAME,''
	END

	/*-------------------------------------------------------------------------*/
	IF @PROCESSFLAG = 'STATUS'  
	BEGIN  

		EXEC V2_PROCESS_STATUS_LOG_UPD @PROCESSDATE,'CHKPOST','',@UNAME,''


		EXEC V2_PROCESS_STATUS_LOG_UPD @PROCESSDATE,'INSTCONS','',@UNAME,''

		IF (SELECT SUM(FOEA_DAY_BUY_QUANTITY + FOEA_DAY_SELL_QUANTITY)  FROM FOEXERCISEALLOCATION
								WHERE FOEA_POSITION_DATE BETWEEN @PROCESSDATE AND @PROCESSDATE + ' 23:59') = 0 
			AND 
			(SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
				WHERE LEFT(BUSINESS_DATE,11) = @PROCESSDATE AND POSITIONFILE > 0)> 0
		BEGIN
			UPDATE V2_BUSINESS_PROCESS SET IMPORT_TRADE=1,VBB=1,STT=1 WHERE LEFT(BUSINESS_DATE,11) = @PROCESSDATE
		END


		/*-----------------------------------------------------------------*/
		CREATE TABLE #PROCESS_LOG
		(
			PROCESS_ID VARCHAR(100),
			PROCESS_STAT VARCHAR(200) 
		)


		/*--------------------- IMPORT TRADE ------------------------*/
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE LEFT(BUSINESS_DATE,11) = @PROCESSDATE AND IMPORT_TRADE > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('IMPORT TRADE','PENDING')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'IMPORT TRADE','DONE - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='IMPTRD')

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('IMPORT TRADE','DONE')
			END
		END




		/*--------------------- VBB COMPUTATION ------------------------*/ 
		IF (SELECT COUNT(1) FROM SCHEME_MAPPING (NOLOCK)) > 0
		BEGIN
			IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
				WHERE LEFT(BUSINESS_DATE,11) = @PROCESSDATE AND VBB > 0)= 0 
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('VBB COMPUTATION','PENDING')
			END
			ELSE
			BEGIN
				INSERT INTO #PROCESS_LOG 
				SELECT 'VBB COMPUTATION','DONE - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
				WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
				FROM V2_PROCESS_STATUS_LOG (NOLOCK)
				WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
					WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='VBB')
			END

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('VBB COMPUTATION','DONE')
			END
		END


		/*--------------------- STT COMPUTATION ------------------------
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE LEFT(BUSINESS_DATE,11) = @PROCESSDATE AND STT > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('STT COMPUTATION','PENDING')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'STT COMPUTATION','DONE - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='STT')

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('STT COMPUTATION','DONE')
			END
		END

		--------------------- EXCHG STT IMPORT ------------------------
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE LEFT(BUSINESS_DATE,11) = @PROCESSDATE AND EXCHANGESTT > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('STT EXCHANGE FILE IMPORT','PENDING')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'STT EXCHANGE FILE IMPORT','DONE - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='CHKSTTIMP')

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('STT EXCHANGE FILE IMPORT','DONE')
			END
		END*/
	
			/*--------------------- POSITION FILE IMPORT ------------------------*/ 
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE LEFT(BUSINESS_DATE,11) = @PROCESSDATE AND POSITIONFILE > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('POSITION FILE IMPORT','PENDING')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'POSITION FILE IMPORT','DONE - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='POSIMP')


			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('POSITION FILE IMPORT','DONE')
			END
		END


		/*--------------------- BILL GENERATION ------------------------*/
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE LEFT(BUSINESS_DATE,11) = @PROCESSDATE AND BILLING > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('BILL GENERATION','PENDING')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'BILL GENERATION','DONE - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='BILLGEN')

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('BILL GENERATION','DONE')
			END
		END


		/*--------------------- VALAN GENERATION ------------------------*/
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE LEFT(BUSINESS_DATE,11) = @PROCESSDATE AND BILLING > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('VALAN GENERATION','PENDING')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'VALAN GENERATION','DONE - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='VALANGEN')

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('VALAN GENERATION','DONE')
			END
		END

		/*--------------------- BILL POSTING ------------------------*/
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE LEFT(BUSINESS_DATE,11) = @PROCESSDATE AND POSTING > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('BILL POSTING','PENDING')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT  'BILL POSTING','DONE - ' + PROC_STAT FROM
			(SELECT TOP 1 (CASE WHEN CONVERT(VARCHAR,POSTDATE,108) <> '00:00:00' 
			THEN CONVERT(VARCHAR,POSTDATE) ELSE LEFT(POSTDATE,11) END ) + 
			(CASE WHEN ISNULL(USERNAME,'')<>'' THEN ' ('+ USERNAME + ')' ELSE '' END) AS PROC_STAT
			FROM  ACCOUNTCURBFO.DBO.BILLPOSTED (NOLOCK) WHERE VDT BETWEEN @PROCESSDATE AND @PROCESSDATE + ' 23:59') STAT

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('BILL POSTING','DONE')
			END
		END


		/*--------------------- CONTRACT PRINT CANNED DATA POPUP ------------------------*/
		IF (SELECT TOP 1 EXCHANGE FROM FOTAXES (NOLOCK) ) <> 'NCM'
		BEGIN
			IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
				WHERE LEFT(BUSINESS_DATE,11) = @PROCESSDATE AND CONTRACT > 0) = 0 
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('CONTRACT PRINT DATA POPUP','PENDING')
			END
			ELSE
			BEGIN
				INSERT INTO #PROCESS_LOG 
				SELECT 'CONTRACT PRINT DATA POPUP','DONE - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
				WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
				FROM V2_PROCESS_STATUS_LOG (NOLOCK)
				WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
					WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='CONTRACT')
			END

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('CONTRACT PRINT DATA POPUP','DONE')
			END
		END

		/*--------------------- MARGIN FILE IMPORT ------------------------*/
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE LEFT(BUSINESS_DATE,11) = @PROCESSDATE AND MARGINFILE > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('MARGIN FILE IMPORT','PENDING')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'MARGIN FILE IMPORT','DONE - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='MRGIMP')

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('MARGIN FILE IMPORT','DONE')
			END
		END

	
		/*--------------------- MARGIN RETURN FILE GENERATION ------------------------*/
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE LEFT(BUSINESS_DATE,11) = @PROCESSDATE AND MARGINRETURNFILE > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('MARGIN RETURN FILE GENERATION','PENDING')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'MARGIN RETURN FILE GENERATION','DONE - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='MRGFILE')

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('MARGIN RETURN FILE GENERATION','DONE')
			END
		END
	

		/*--------------------- MARGIN REPORT DATA POPUP ------------------------*/
		IF (SELECT COUNT(1) FROM V2_BUSINESS_PROCESS (NOLOCK)
			WHERE LEFT(BUSINESS_DATE,11) = @PROCESSDATE AND CLIENTMARGINPOP > 0) = 0 
		BEGIN
			INSERT INTO #PROCESS_LOG VALUES ('MARGIN REPORT DATA POPUP','PENDING')
		END
		ELSE
		BEGIN
			INSERT INTO #PROCESS_LOG 
			SELECT 'MARGIN REPORT DATA POPUP','DONE - ' + CONVERT(VARCHAR,PROCESSDATE) + CASE 
			WHEN ISNULL(PROCESSBY,'')<>'' THEN ' (' +  LTRIM(RTRIM(PROCESSBY)) + ')' ELSE '' END 
			FROM V2_PROCESS_STATUS_LOG (NOLOCK)
			WHERE SNO = (SELECT MAX(SNO) FROM V2_PROCESS_STATUS_LOG (NOLOCK) 
				WHERE LEFT(BUSINESSDATE,11) = @PROCESSDATE AND PROCESSID ='MRGPOP')

			IF @@ROWCOUNT  = 0
			BEGIN
				INSERT INTO #PROCESS_LOG VALUES ('MARGIN REPORT DATA POPUP','DONE')
			END
		END



		SELECT * FROM #PROCESS_LOG
	
		DROP TABLE #PROCESS_LOG
		
		
		
	END

/*--------------------------------------------- EOF --------------------------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_UPDATE_ADMINPASSWORD
-- --------------------------------------------------
CREATE PROC [dbo].[V2_UPDATE_ADMINPASSWORD]  
(  
 @PASSWORD VARCHAR(512),  
 @ADMINID VARCHAR(25),  
 @DAYCOUNT INT   
)  
  
AS
SET NOCOUNT ON  
  
DECLARE @@FLDOLDPASSWORD TINYINT  
DECLARE @@FLDAUTO INT  
DECLARE @@PASSAUTO BIGINT  
DECLARE @@OLDPASSSTRING VARCHAR(2000)  
DECLARE @@OLDPASSCOUNT INT  
DECLARE @@NEWPASSSTRING VARCHAR(2000)  
  
  
/*  
CREATE TABLE TBLUSERPASSHIST  
(  
 FLDAUTO BIGINT IDENTITY(1,1),  
 FLDUSERID INT,  
 FLDOLDPASSLISTING VARCHAR(2000)  
)  
*/  
  
  
SELECT @@FLDOLDPASSWORD = ISNULL(FLDOLDPASSWORD,1) FROM TBLGLOBALPARAMS  
  
IF ISNULL(@@FLDOLDPASSWORD,0) = 0  
BEGIN  
 SET @@FLDOLDPASSWORD = 1  
END  
  
  
  
SELECT @@FLDAUTO = ISNULL(FLDAUTO_ADMIN,0) FROM TBLADMIN  
WHERE FLDNAME = @ADMINID  
  
IF ISNULL(@@FLDAUTO,0) = 0  
BEGIN  
 SELECT MSG = 'ADMIN USER NOT FOUND'  
 RETURN  
END  
  
  
  
SELECT @@OLDPASSSTRING = ISNULL(FLDOLDPASSLISTING,''), @@PASSAUTO = ISNULL(FLDAUTO,0)  FROM TBLADMINPASSHIST  
WHERE FLDADMINID = @@FLDAUTO  
  
IF ISNULL(@@OLDPASSSTRING,'') = ''  
BEGIN  
 SET @@OLDPASSSTRING = ''  
END  
  
IF ISNULL(@@PASSAUTO,0) = 0  
BEGIN  
 SET @@PASSAUTO = 0  
END  
  
  
SELECT   
 @@OLDPASSCOUNT = COUNT(1)  
FROM   
 FUN_SPLITSTRING (@@OLDPASSSTRING,'')  
WHERE   
 SPLITTED_VALUE = @PASSWORD  
 AND SNO > (  
      SELECT   
        ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)  
      FROM   
       FUN_SPLITSTRING (@@OLDPASSSTRING,'')  
     )  
  
  
IF ISNULL(@@OLDPASSCOUNT,0) > 0  
BEGIN  
 SELECT MSG = 'PASSWORD ALREADY USED DURING LAST ' + CAST(@@FLDOLDPASSWORD AS VARCHAR) + ' ATTEMPTS.  PLEASE CHANGE'  
 RETURN  
END  
  
  
  
UPDATE TBLADMIN   
SET   
 FLDPASSWORD = @PASSWORD,  
 PWD_EXPIRY_DATE = (GETDATE()+ @DAYCOUNT),
 FLDATTEMPTCNT = 0 
WHERE   
 FLDAUTO_ADMIN = @@FLDAUTO  
  
SET @@NEWPASSSTRING = ''  
  
DECLARE @@STRING VARCHAR(100)  
  
DECLARE vendor_cursor CURSOR FOR   
  
SELECT SPLITTED_VALUE  
FROM   
 FUN_SPLITSTRING (@@OLDPASSSTRING,'')  
WHERE  SNO > (  
      SELECT   
        ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)  
      FROM   
       FUN_SPLITSTRING (@@OLDPASSSTRING,'')  
     )  
OPEN vendor_cursor  
  
FETCH NEXT FROM vendor_cursor   
INTO @@STRING  
  
WHILE @@FETCH_STATUS = 0  
BEGIN  
 SET @@NEWPASSSTRING = @@NEWPASSSTRING + @@STRING + ''  
FETCH NEXT FROM vendor_cursor   
INTO @@STRING  
END   
  
CLOSE vendor_cursor  
DEALLOCATE vendor_cursor  
  
 SET @@NEWPASSSTRING = @@NEWPASSSTRING + @PASSWORD   
  
IF ISNULL(@@PASSAUTO,0) = 0  
BEGIN  
 INSERT INTO TBLADMINPASSHIST   
 (FLDADMINID, FLDOLDPASSLISTING)   
 VALUES  
 (@@FLDAUTO, @@NEWPASSSTRING)  
END  
ELSE  
BEGIN  
 UPDATE TBLADMINPASSHIST  
 SET FLDOLDPASSLISTING = @@NEWPASSSTRING  
 WHERE FLDAUTO = @@PASSAUTO  
 AND FLDADMINID = @@FLDAUTO   
END  
  
SELECT MSG = 'PASSWORD UPDATED SUCCESSFULLY'  
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_UPDATE_ADMINPASSWORD_26112019
-- --------------------------------------------------
CREATE PROC [dbo].[V2_UPDATE_ADMINPASSWORD]
(    
 @PASSWORD VARCHAR(512),    
 @ADMINID VARCHAR(25),    
 @DAYCOUNT INT     
)    
    
AS    
    
    
SET NOCOUNT ON    
    
DECLARE @@FLDOLDPASSWORD TINYINT    
DECLARE @@FLDAUTO INT    
DECLARE @@PASSAUTO BIGINT    
DECLARE @@OLDPASSSTRING VARCHAR(2000)    
DECLARE @@OLDPASSCOUNT INT    
DECLARE @@NEWPASSSTRING VARCHAR(2000)    
    
    
/*    
CREATE TABLE TBLUSERPASSHIST    
(    
 FLDAUTO BIGINT IDENTITY(1,1),    
 FLDUSERID INT,    
 FLDOLDPASSLISTING VARCHAR(2000)    
)    
SELECT * FROM TBLADMINPASSHIST
*/    
    
    
SELECT @@FLDOLDPASSWORD = ISNULL(FLDOLDPASSWORD,1) FROM TBLGLOBALPARAMS    
    
IF ISNULL(@@FLDOLDPASSWORD,0) = 0    
BEGIN    
 SET @@FLDOLDPASSWORD = 1    
END    
    
    
    
SELECT @@FLDAUTO = ISNULL(FLDAUTO_ADMIN,0) FROM TBLADMIN    
WHERE FLDNAME = @ADMINID    
    
IF ISNULL(@@FLDAUTO,0) = 0    
BEGIN    
 SELECT MSG = 'ADMIN USER NOT FOUND'    
 RETURN    
END    
    
    
    
SELECT @@OLDPASSSTRING = ISNULL(FLDOLDPASSLISTING,''), @@PASSAUTO = ISNULL(FLDAUTO,0)  FROM TBLADMINPASSHIST    
WHERE FLDADMINID = @@FLDAUTO    
    
IF ISNULL(@@OLDPASSSTRING,'') = ''    
BEGIN    
 SET @@OLDPASSSTRING = ''    
END    
    
IF ISNULL(@@PASSAUTO,0) = 0    
BEGIN    
 SET @@PASSAUTO = 0    
END    
    
    
SELECT     
 @@OLDPASSCOUNT = COUNT(1)    
FROM     
 FUN_SPLITSTRING (@@OLDPASSSTRING,'')    
WHERE     
 SPLITTED_VALUE = @PASSWORD    
 AND SNO > (    
      SELECT     
        ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)    
      FROM     
       FUN_SPLITSTRING (@@OLDPASSSTRING,'')    
     )    
    
    
IF ISNULL(@@OLDPASSCOUNT,0) > 0    
BEGIN    
 SELECT MSG = 'PASSWORD ALREADY USED DURING LAST ' + CAST(@@FLDOLDPASSWORD AS VARCHAR) + ' ATTEMPTS.  PLEASE CHANGE'    
 RETURN    
END    
    
    
    
UPDATE TBLADMIN     
SET     
 FLDPASSWORD = @PASSWORD,    
 PWD_EXPIRY_DATE = (GETDATE()+ @DAYCOUNT),  
 FLDATTEMPTCNT = 0   
WHERE     
 FLDAUTO_ADMIN = @@FLDAUTO    
    
SET @@NEWPASSSTRING = ''    
    
DECLARE @@STRING VARCHAR(100)    
    
DECLARE VENDOR_CURSOR CURSOR FOR     
    
SELECT SPLITTED_VALUE    
FROM     
 FUN_SPLITSTRING (@@OLDPASSSTRING,'')    
WHERE  SNO > (    
      SELECT     
        ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)    
      FROM     
       FUN_SPLITSTRING (@@OLDPASSSTRING,'')    
     )    
OPEN VENDOR_CURSOR    
    
FETCH NEXT FROM VENDOR_CURSOR     
INTO @@STRING    
    
WHILE @@FETCH_STATUS = 0    
BEGIN    
 SET @@NEWPASSSTRING = @@NEWPASSSTRING + @@STRING + ''    
FETCH NEXT FROM VENDOR_CURSOR     
INTO @@STRING    
END     
    
CLOSE VENDOR_CURSOR    
DEALLOCATE VENDOR_CURSOR    
    
 SET @@NEWPASSSTRING = @@NEWPASSSTRING + @PASSWORD     
    
IF ISNULL(@@PASSAUTO,0) = 0    
BEGIN    
 INSERT INTO TBLADMINPASSHIST     
 (FLDADMINID, FLDOLDPASSLISTING)     
 VALUES    
 (@@FLDAUTO, @@NEWPASSSTRING)    
END    
ELSE    
BEGIN    
 UPDATE TBLADMINPASSHIST    
 SET FLDOLDPASSLISTING = @@NEWPASSSTRING    
 WHERE FLDAUTO = @@PASSAUTO    
 AND FLDADMINID = @@FLDAUTO     
END    
    
SELECT MSG = 'PASSWORD UPDATED SUCCESSFULLY'    
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_UPDATE_PASSWORD
-- --------------------------------------------------

CREATE  PROC [dbo].[V2_UPDATE_PASSWORD]
(
	@PASSWORD VARCHAR(512),
	@USERID VARCHAR(25),
	@DAYCOUNT INT	
)

AS


SET NOCOUNT ON

DECLARE @@FLDOLDPASSWORD TINYINT
DECLARE @@FLDAUTO INT
DECLARE @@PASSAUTO BIGINT
DECLARE @@OLDPASSSTRING VARCHAR(2000)
DECLARE @@OLDPASSCOUNT INT
DECLARE @@NEWPASSSTRING VARCHAR(2000)


/*
CREATE TABLE TBLUSERPASSHIST
(
	FLDAUTO BIGINT IDENTITY(1,1),
	FLDUSERID INT,
	FLDOLDPASSLISTING VARCHAR(2000)
)
*/


SELECT @@FLDOLDPASSWORD = ISNULL(FLDOLDPASSWORD,1) FROM TBLGLOBALPARAMS

IF ISNULL(@@FLDOLDPASSWORD,0) = 0
BEGIN
	SET @@FLDOLDPASSWORD = 1
END



SELECT @@FLDAUTO = ISNULL(FLDAUTO,0) FROM TBLPRADNYAUSERS
WHERE FLDUSERNAME = @USERID

IF ISNULL(@@FLDAUTO,0) = 0
BEGIN
	SELECT MSG = 'USER NOT FOUND'
	RETURN
END



SELECT @@OLDPASSSTRING = ISNULL(FLDOLDPASSLISTING,''), @@PASSAUTO = ISNULL(FLDAUTO,0)  FROM TBLUSERPASSHIST
WHERE FLDUSERID = @@FLDAUTO

IF ISNULL(@@OLDPASSSTRING,'') = ''
BEGIN
	SET @@OLDPASSSTRING = ''
END

IF ISNULL(@@PASSAUTO,0) = 0
BEGIN
	SET @@PASSAUTO = 0
END


SELECT 
	@@OLDPASSCOUNT = COUNT(1)
FROM 
	FUN_SPLITSTRING (@@OLDPASSSTRING,'')
WHERE 
	SPLITTED_VALUE = @PASSWORD
	AND SNO > (
						SELECT 
								ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)
						FROM 
							FUN_SPLITSTRING (@@OLDPASSSTRING,'')
					)


IF ISNULL(@@OLDPASSCOUNT,0) > 0
BEGIN
	SELECT MSG = 'PASSWORD ALREADY USED DURING LAST ' + CAST(@@FLDOLDPASSWORD AS VARCHAR) + ' ATTEMPTS.  PLEASE CHANGE'
	RETURN
END



UPDATE TBLPRADNYAUSERS 
SET 
	FLDPASSWORD = @PASSWORD,
	PWD_EXPIRY_DATE = (GETDATE()+ @DAYCOUNT)
WHERE 
	FLDAUTO = @@FLDAUTO

								
UPDATE TBLUSERCONTROLMASTER 
SET 
	FLDATTEMPTCNT = 0,
	FLDFIRSTLOGIN = 'N'
WHERE 
	TBLUSERCONTROLMASTER.FLDUSERID = @@FLDAUTO 



SET @@NEWPASSSTRING = ''


DECLARE @@STRING VARCHAR(100)

DECLARE vendor_cursor CURSOR FOR 

SELECT SPLITTED_VALUE
FROM 
	FUN_SPLITSTRING (@@OLDPASSSTRING,'')
WHERE  SNO > (
						SELECT 
								ISNULL(ISNULL(MAX(SNO),0) - @@FLDOLDPASSWORD, 0)
						FROM 
							FUN_SPLITSTRING (@@OLDPASSSTRING,'')
					)
OPEN vendor_cursor

FETCH NEXT FROM vendor_cursor 
INTO @@STRING

WHILE @@FETCH_STATUS = 0
BEGIN
	SET @@NEWPASSSTRING = @@NEWPASSSTRING + @@STRING + ''
FETCH NEXT FROM vendor_cursor 
INTO @@STRING
END 

CLOSE vendor_cursor
DEALLOCATE vendor_cursor

	SET @@NEWPASSSTRING = @@NEWPASSSTRING + @PASSWORD 

IF ISNULL(@@PASSAUTO,0) = 0
BEGIN
	INSERT INTO TBLUSERPASSHIST 
	(FLDUSERID, FLDOLDPASSLISTING) 
	VALUES
	(@@FLDAUTO, @@NEWPASSSTRING)
END
ELSE
BEGIN
	UPDATE TBLUSERPASSHIST
	SET FLDOLDPASSLISTING = @@NEWPASSSTRING
	WHERE FLDAUTO = @@PASSAUTO
	AND FLDUSERID = @@FLDAUTO 
END

SELECT MSG = 'PASSWORD UPDATED SUCCESSFULLY'
RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_USER_REPORT_MAPPING
-- --------------------------------------------------
CREATE PROC [dbo].[V2_USER_REPORT_MAPPING]  
@FLDSTAT VARCHAR(15)          
  
AS  
  
SELECT   
      U.FLDUSERNAME,  
      FLDNAME = U.FLDFIRSTNAME +  ' ' + U.FLDMIDDLENAME + ' ' + U.FLDLASTNAME,  
      U.FLDSTNAME,  
      A.FLDSTATUS,   
      C.FLDCATEGORYNAME,   
      R.FLDREPORTNAME,   
      R.FLDPATH,   
      G.FLDGRPNAME,   
      M.FLDMENUNAME,  
      BRANCH_CD = ISNULL(BRANCH_CD,''),   
      TRADER = ISNULL(TRADER,A.FLDSTATUS + ' LOGIN'),   
      CLIENT_NAME = ISNULL(LONG_NAME,A.FLDSTATUS + ' LOGIN')   
FROM   
      TBLADMIN A (NOLOCK),  
      TBLCATEGORY C (NOLOCK),  
      TBLREPORTS R (NOLOCK),   
      TBLREPORTGRP G (NOLOCK),   
      TBLMENUHEAD M (NOLOCK),   
      TBLCATMENU CM (NOLOCK),     
      TBLPRADNYAUSERS U  (NOLOCK)  
      LEFT OUTER JOIN   
      (  
            SELECT   
                  PARTY_CODE,   
                  BRANCH_CD,  
                  TRADER,  
                  LONG_NAME  
            FROM  
                  CLIENT1 C1 (NOLOCK),  
                  CLIENT2 C2 (NOLOCK)  
            WHERE  
                  C1.CL_CODE = C2.CL_CODE  
      ) CL  
      ON  
      (CL.PARTY_CODE = U.FLDSTNAME)  
WHERE   
      U.FLDADMINAUTO = A.FLDAUTO_ADMIN  
      AND U.FLDCATEGORY = C.FLDCATEGORYCODE   
      AND R.FLDREPORTGRP =G.FLDREPORTGRP    
      AND R.FLDMENUGRP = M.FLDMENUCODE    
      AND R.FLDREPORTCODE = CM.FLDREPORTCODE    
--      AND U.FLDCATEGORY = 8  
      AND CM.FLDCATEGORYCODE LIKE '%,' + U.FLDCATEGORY + ',%' 
      AND A.FLDSTATUS=@FLDSTAT
ORDER BY   
      U.FLDUSERNAME,   
      G.FLDGRPNAME,   
      M.FLDMENUNAME,  
      R.FLDREPORTNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_USER_REPORT_MAPPING_WITHOUTREP
-- --------------------------------------------------
CREATE PROC [dbo].[V2_USER_REPORT_MAPPING_WITHOUTREP]    
@FLDSTAT VARCHAR(15)            
    
AS    
    
SELECT DISTINCT      
      U.FLDUSERNAME,    
      FLDNAME = U.FLDFIRSTNAME +  ' ' + U.FLDMIDDLENAME + ' ' + U.FLDLASTNAME,    
      U.FLDSTNAME,    
      A.FLDSTATUS,     
      C.FLDCATEGORYNAME     
    /*  R.FLDREPORTNAME,     
      R.FLDPATH,     
      G.FLDGRPNAME,     
      M.FLDMENUNAME,    
      BRANCH_CD = ISNULL(BRANCH_CD,''),     
      TRADER = ISNULL(TRADER,A.FLDSTATUS + ' LOGIN'),     
      CLIENT_NAME = ISNULL(LONG_NAME,A.FLDSTATUS + ' LOGIN')     */
FROM     
      TBLADMIN A (NOLOCK),    
      TBLCATEGORY C (NOLOCK),    
      TBLREPORTS R (NOLOCK),     
      TBLREPORTGRP G (NOLOCK),     
      TBLMENUHEAD M (NOLOCK),     
      TBLCATMENU CM (NOLOCK),       
      TBLPRADNYAUSERS U  (NOLOCK)    
      LEFT OUTER JOIN     
      (    
            SELECT     
                  PARTY_CODE,     
                  BRANCH_CD,    
                  TRADER,    
                  LONG_NAME    
            FROM    
                  CLIENT1 C1 (NOLOCK),    
                  CLIENT2 C2 (NOLOCK)    
            WHERE    
                  C1.CL_CODE = C2.CL_CODE    
      ) CL    
      ON    
      (CL.PARTY_CODE = U.FLDSTNAME)    
WHERE     
      U.FLDADMINAUTO = A.FLDAUTO_ADMIN    
      AND U.FLDCATEGORY = C.FLDCATEGORYCODE     
      AND R.FLDREPORTGRP =G.FLDREPORTGRP      
      AND R.FLDMENUGRP = M.FLDMENUCODE      
      AND R.FLDREPORTCODE = CM.FLDREPORTCODE      
      AND CM.FLDCATEGORYCODE LIKE '%,' + U.FLDCATEGORY + ',%'   
      AND A.FLDSTATUS=@FLDSTAT  
ORDER BY     
      U.FLDUSERNAME
   --   G.FLDGRPNAME,     
 --     M.FLDMENUNAME,    
--      R.FLDREPORTNAME

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VALAN_ADDITIONAL_PROCESS
-- --------------------------------------------------

  
-- Query For ALL FUTURES AND CURRENCY Segments --  
  
create PROC [dbo].[VALAN_ADDITIONAL_PROCESS]  
(  
 @BILLDATE VARCHAR(11)  
)  
AS  
  
DECLARE @SBCCODE VARCHAR(10)  
DECLARE @SBCCODEPAY VARCHAR(10)   
DECLARE @KKCCODE VARCHAR(10)  
DECLARE @KKCCODEPAY VARCHAR(10)   
  
SET @SBCCODE = ''  
SET @SBCCODEPAY = ''  
SET @KKCCODE = ''  
SET @KKCCODEPAY = ''  
  
SELECT @KKCCODE = ACCODE FROM VALANACCOUNT   
WHERE ACNAME = 'KRISHI KALYAN CESS'  
  
SELECT @KKCCODEPAY = ACCODE FROM VALANACCOUNT   
WHERE ACNAME = 'KRISHI KALYAN CESS PAYABLE'  
  
SELECT @SBCCODE = ACCODE FROM VALANACCOUNT   
WHERE ACNAME = 'SWACHH BHARAT CESS'  
  
SELECT @SBCCODEPAY = ACCODE FROM VALANACCOUNT   
WHERE ACNAME = 'SWACHH BHARAT CESS PAYABLE'  
  
IF ISNULL(@SBCCODE,'')='' AND ISNULL(@KKCCODE,'')=''  
BEGIN  
 RETURN  
END  
  
SELECT A.* INTO #SBC  
FROM FOACCBILL A, VALANACCOUNT V, FOGLOBALS  
WHERE BILLDATE = @BILLDATE  
AND PARTY_CODE = ACCODE  
AND V.ACNAME = 'SERVICE TAX'  
AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT   
AND ISNULL(SBCCHARGE,0) > 0  
  
IF (SELECT ISNULL(COUNT(1),0) FROM #SBC) > 0   
BEGIN  
 UPDATE #SBC SET PARTY_CODE = @SBCCODE, AMOUNT = ROUND((AMOUNT * 100 / SERVICE_TAX) * ISNULL(SBCCHARGE,0) / 100,2)  
 FROM FOGLOBALS  
 WHERE BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT   
 AND ISNULL(SBCCHARGE,0) > 0  
  
 SELECT A.* INTO #SERTAX  
 FROM FOACCBILL A, VALANACCOUNT V, FOGLOBALS  
 WHERE BILLDATE = @BILLDATE  
 AND PARTY_CODE = ACCODE  
 AND V.ACNAME = 'SERVICE TAX'  
 AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT   
 AND ISNULL(SBCCHARGE,0) > 0  
  
 UPDATE #SERTAX SET AMOUNT = #SERTAX.AMOUNT - #SBC.AMOUNT  
 FROM #SBC   
 WHERE #SERTAX.BILLDATE = #SBC.BILLDATE  
 AND #SERTAX.BRANCHCD = #SBC.BRANCHCD  
  
   
 INSERT INTO FOACCBILL  
 SELECT * FROM #SBC  
  
  
  SELECT A.* INTO #KKC  
  FROM FOACCBILL A, VALANACCOUNT V, FOGLOBALS  
  WHERE BILLDATE = @BILLDATE  
  AND PARTY_CODE = ACCODE  
  AND V.ACNAME = 'SERVICE TAX'  
  AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT   
  AND ISNULL(KRISHICHARGE,0) > 0  
  
  IF (SELECT ISNULL(COUNT(1),0) FROM #KKC) > 0   
  BEGIN  
   UPDATE #KKC SET PARTY_CODE = @KKCCODE, AMOUNT = ROUND((AMOUNT * 100 / SERVICE_TAX) * ISNULL(KRISHICHARGE,0) / 100,2)  
   FROM FOGLOBALS  
   WHERE BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT   
   AND ISNULL(KRISHICHARGE,0) > 0  
  
   UPDATE #SERTAX SET AMOUNT = #SERTAX.AMOUNT - #KKC.AMOUNT  
   FROM #KKC   
   WHERE #SERTAX.BILLDATE = #KKC.BILLDATE  
   AND #SERTAX.BRANCHCD = #KKC.BRANCHCD  
  
  
   INSERT INTO FOACCBILL  
   SELECT * FROM #KKC  
  
  END  
  DROP TABLE #KKC  
    
   
 DELETE FROM FOACCBILL  
 WHERE BILLDATE = @BILLDATE  
 AND EXISTS (SELECT PARTY_CODE FROM #SERTAX WHERE FOACCBILL.PARTY_CODE = #SERTAX.PARTY_CODE)   
  
 INSERT INTO FOACCBILL  
 SELECT * FROM #SERTAX  
  
 DROP TABLE #SERTAX  
END  
DROP TABLE #SBC  
  
SELECT A.* INTO #PAYSBC  
FROM FOACCBILL A, VALANACCOUNT V, FOGLOBALS  
WHERE BILLDATE = @BILLDATE  
AND PARTY_CODE = ACCODE  
AND V.ACNAME = 'SERVICE TAX PAYABLE'  
AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT   
AND ISNULL(SBCCHARGE,0) > 0  
  
IF (SELECT ISNULL(COUNT(1),0) FROM #PAYSBC) > 0   
BEGIN  
 UPDATE #PAYSBC SET PARTY_CODE = @SBCCODEPAY, AMOUNT = ROUND((AMOUNT * 100 / SERVICE_TAX) * ISNULL(SBCCHARGE,0) / 100,2)  
 FROM FOGLOBALS  
 WHERE BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT   
 AND ISNULL(SBCCHARGE,0) > 0  
  
 SELECT A.* INTO #PAYSERTAX  
 FROM FOACCBILL A, VALANACCOUNT V, FOGLOBALS  
 WHERE BILLDATE = @BILLDATE  
 AND PARTY_CODE = ACCODE  
 AND V.ACNAME = 'SERVICE TAX PAYABLE'  
 AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT   
 AND ISNULL(SBCCHARGE,0) > 0  
  
 UPDATE #PAYSERTAX SET AMOUNT = #PAYSERTAX.AMOUNT - #PAYSBC.AMOUNT  
 FROM #PAYSBC   
 WHERE #PAYSERTAX.BILLDATE = #PAYSBC.BILLDATE  
 AND #PAYSERTAX.BRANCHCD = #PAYSBC.BRANCHCD  
  
 INSERT INTO FOACCBILL  
 SELECT * FROM #PAYSBC  
  
  SELECT A.* INTO #PAYKKC  
  FROM FOACCBILL A, VALANACCOUNT V, FOGLOBALS  
  WHERE BILLDATE = @BILLDATE  
  AND PARTY_CODE = ACCODE  
  AND V.ACNAME = 'SERVICE TAX PAYABLE'  
  AND BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT   
  AND ISNULL(KRISHICHARGE,0) > 0  
  
  IF (SELECT ISNULL(COUNT(1),0) FROM #PAYKKC) > 0   
  BEGIN  
   UPDATE #PAYKKC SET PARTY_CODE = @KKCCODEPAY, AMOUNT = ROUND((AMOUNT * 100 / SERVICE_TAX) * ISNULL(KRISHICHARGE,0) / 100,2)  
   FROM FOGLOBALS  
   WHERE BILLDATE BETWEEN YEAR_START_DT AND YEAR_END_DT   
   AND ISNULL(KRISHICHARGE,0) > 0  
  
   UPDATE #PAYSERTAX SET AMOUNT = #PAYSERTAX.AMOUNT - #PAYKKC.AMOUNT  
   FROM #PAYKKC   
   WHERE #PAYSERTAX.BILLDATE = #PAYKKC.BILLDATE  
   AND #PAYSERTAX.BRANCHCD = #PAYKKC.BRANCHCD  
  
   DELETE FROM FOACCBILL  
   WHERE BILLDATE = @BILLDATE  
   AND EXISTS (SELECT PARTY_CODE FROM #PAYSERTAXKKC WHERE FOACCBILL.PARTY_CODE = #PAYSERTAXKKC.PARTY_CODE)  
  
   INSERT INTO FOACCBILL  
   SELECT * FROM #PAYKKC  
  
  END  
  DROP TABLE #PAYKKC  
  
 DELETE FROM FOACCBILL  
 WHERE BILLDATE = @BILLDATE  
 AND EXISTS (SELECT PARTY_CODE FROM #PAYSERTAX WHERE FOACCBILL.PARTY_CODE = #PAYSERTAX.PARTY_CODE)  
  
 INSERT INTO FOACCBILL  
 SELECT * FROM #PAYSERTAX  
  
 DROP TABLE #PAYSERTAX  
END  
DROP TABLE #PAYSBC

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VALAN_GST_BILLPOST
-- --------------------------------------------------


CREATE PROC [dbo].[VALAN_GST_BILLPOST]
(
	@BILLDATE	VARCHAR(11)
)
AS


DECLARE @NARRATION VARCHAR(100),
		@START_DATE	DATETIME,
		@END_DATE	DATETIME,
		@PAYIN_DATE	DATETIME,
		@PAYOUT_DATE DATETIME

SELECT @NARRATION = ISNULL(MAX(NARRATION),'BILL POSTED'),
	   @START_DATE = MAX(START_DATE),
	   @END_DATE = MAX(END_DATE),
	   @PAYIN_DATE = MAX(PAYIN_DATE),
	   @PAYOUT_DATE = MAX(PAYOUT_DATE)
 FROM FOACCBILL WHERE Billdate LIKE @BILLDATE + '%'

SELECT N.PARTY_CODE, N.Branch_Code,
STATE_CODE=CONVERT(VARCHAR(10),''),
SERVICE_TAX = SUM(SERVICE_TAX),
EXSERVICE_TAX = SUM(Exser_Tax),
TARGETSTATE=L_STATE, SOURCESTATE=STATE,
GST_PER=CONVERT(NUMERIC(18,4),0),  
CGST_PER=CONVERT(NUMERIC(18,4),0),
IGST_PER=CONVERT(NUMERIC(18,4),0),
SGST_PER=CONVERT(NUMERIC(18,4),0),
UGST_PER=CONVERT(NUMERIC(18,4),0),
AGST_PER=CONVERT(NUMERIC(18,4),0) 
INTO #GSTDATA
FROM TBL_CLIENT_GST_DATA G, TBL_GST_LOCATION L, FOBILLVALAN N 
WHERE N.Sauda_Date BETWEEN @BILLDATE AND @BILLDATE + ' 23:59'
AND N.Party_Code = G.PARTY_CODE
AND GST_LOCATION = LOC_CODE
AND @BILLDATE BETWEEN G.EFF_FROM_DATE AND G.EFF_TO_DATE
AND TRADETYPE = 'BT'
AND  SERVICE_TAX > 0 
GROUP BY N.PARTY_CODE,N.Branch_Code,L_STATE,STATE 

INSERT INTO #GSTDATA
SELECT N.PARTY_CODE, N.Branch_Code,
STATE_CODE=CONVERT(VARCHAR(10),''),
SERVICE_TAX = SUM(SERVICE_TAX),
EXSERVICE_TAX = SUM(Exser_Tax),
TARGETSTATE=L_STATE, SOURCESTATE=FOOWNER.STATE,
GST_PER=CONVERT(NUMERIC(18,4),0),  
CGST_PER=CONVERT(NUMERIC(18,4),0),
IGST_PER=CONVERT(NUMERIC(18,4),0),
SGST_PER=CONVERT(NUMERIC(18,4),0),
UGST_PER=CONVERT(NUMERIC(18,4),0),
AGST_PER=CONVERT(NUMERIC(18,4),0) 
FROM FOBILLVALAN N, FOOWNER,
TBL_STATE_GST_DATA T, CLIENT1 G
WHERE N.Sauda_Date BETWEEN @BILLDATE AND @BILLDATE + ' 23:59' 
AND FOOWNER.State = STATE_NAME
AND @BILLDATE BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE 
AND TRADETYPE = 'BT'
AND  SERVICE_TAX > 0 
AND N.PARTY_CODE NOT IN (SELECT PARTY_CODE FROM #GSTDATA WHERE N.PARTY_CODE = #GSTDATA.Party_Code)
AND G.CL_CODE = N.Party_Code
GROUP BY N.PARTY_CODE,N.Branch_Code,FOOWNER.STATE, L_STATE 

UPDATE #GSTDATA SET TARGETSTATE = SOURCESTATE
WHERE TARGETSTATE NOT IN (SELECT STATE FROM STATE_MASTER)

UPDATE #GSTDATA SET 
STATE_CODE=D.STATE_CODE,
GST_PER=D.GST_PER,
CGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE THEN D.CGST_PER ELSE 0 END),
IGST_PER=(CASE WHEN SOURCESTATE <> TARGETSTATE THEN D.IGST_PER ELSE 0 END),
SGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE AND UTI_FLAG = 0 THEN D.SGST_PER ELSE 0 END),
UGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE AND UTI_FLAG = 1 THEN D.UGST_PER ELSE 0 END),
AGST_PER=(CASE WHEN SOURCESTATE = TARGETSTATE THEN D.AGST_PER ELSE 0 END)
FROM TBL_STATE_GST_DATA D
WHERE D.STATE_NAME = SOURCESTATE
AND @BILLDATE BETWEEN EFF_FROM_DATE AND EFF_TO_DATE

UPDATE #GSTDATA SET 
CGST_PER = SERVICE_TAX * CGST_PER / GST_PER,
SGST_PER = SERVICE_TAX * SGST_PER / GST_PER,
IGST_PER = SERVICE_TAX * IGST_PER / GST_PER,
UGST_PER = SERVICE_TAX * UGST_PER / GST_PER,
AGST_PER = SERVICE_TAX * AGST_PER / GST_PER

UPDATE #GSTDATA SET SGST_PER = SERVICE_TAX - (CGST_PER + IGST_PER + UGST_PER + AGST_PER)
WHERE SGST_PER > 0 
UPDATE #GSTDATA SET UGST_PER = SERVICE_TAX - (CGST_PER + IGST_PER + SGST_PER + AGST_PER)
WHERE UGST_PER > 0 

IF (SELECT ISNULL(COUNT(1),0) FROM #GSTDATA WHERE GST_PER > 0) <= 0 
BEGIN
	RETURN
END
 
IF (SELECT ISNULL(COUNT(1),0) FROM #GSTDATA WHERE GST_PER > 0) > 0 
BEGIN
	DELETE FROM FOACCBILL 
	WHERE Billdate LIKE @BILLDATE + '%'
	AND Party_Code IN (SELECT ACCODE FROM Valanaccount
	WHERE ACNAME = 'SERVICE TAX')

	DELETE FROM FOACCBILL 
	WHERE  Billdate LIKE @BILLDATE + '%'
	AND PARTY_CODE IN (SELECT ACCODE FROM VALANACCOUNT WHERE ACNAME = 'ROUNDING OFF')

	UPDATE FOACCBILL SET AMOUNT = ROUND(AMOUNT,2)
	WHERE  Billdate LIKE @BILLDATE + '%'
END

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(CGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_CGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(SGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_SGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(IGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_IGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(UGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_UGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(AGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_AGST' 
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(CGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_CGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(SGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_SGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(IGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_IGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(UGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_UGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=2,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(AGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_AGST' 
GROUP BY ACCODE
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(CGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_CGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(SGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_SGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(IGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_IGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(UGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_UGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(AGST_PER),2),0,0,0,0,Branch_Code,NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_AGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE,Branch_Code
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(CGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_CGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE
HAVING ROUND(SUM(CGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(SGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_SGST'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE
HAVING ROUND(SUM(SGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(IGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_IGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE
HAVING ROUND(SUM(IGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(UGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_UGST'
AND EXSERVICE_TAX > 0 
GROUP BY ACCODE
HAVING ROUND(SUM(UGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,SELL_BUY=1,SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ROUND(SUM(AGST_PER),2),0,0,0,0,Branch_Code='ZZZ',NARRATION=@NARRATION
FROM #GSTDATA G, VALANACCOUNT 
WHERE ACNAME = STATE_CODE + '_P_AGST' 
AND EXSERVICE_TAX > 0
GROUP BY ACCODE
HAVING ROUND(SUM(AGST_PER),2) > 0 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,
SELL_BUY=(CASE WHEN ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0) > 0 THEN 2 ELSE 1 END),
SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)),0,0,0,0,Branchcd,NARRATION=@NARRATION
FROM FOACCBILL G, VALANACCOUNT 
WHERE Billdate LIKE @BILLDATE + '%'
AND ACNAME = 'ROUNDING OFF' 
AND Branchcd <> 'ZZZ'
GROUP BY ACCODE,BRANCHCD 
HAVING  ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)) > 0 
ORDER BY BRANCHCD 

INSERT INTO FOACCBILL
SELECT PARTY_CODE=ACCODE,BILL_NO=0,
SELL_BUY=(CASE WHEN ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0) > 0 THEN 2 ELSE 1 END),
SETT_NO='',SETT_TYPE='',@BILLDATE,@START_DATE,@END_DATE,@PAYIN_DATE,@PAYOUT_DATE,
AMOUNT=ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)),0,0,0,0,'ZZZ',NARRATION=@NARRATION 
FROM FOACCBILL G, VALANACCOUNT, ACCOUNTCURBFO.DBO.ACMAST 
WHERE Billdate LIKE @BILLDATE + '%'
AND VALANACCOUNT.ACNAME = 'ROUNDING OFF' 
AND G.Party_Code = CLTCODE 
AND (BRANCHCD = 'ZZZ' OR ACCAT = 4)
GROUP BY ACCODE
HAVING  ABS(ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE - AMOUNT END),0)) > 0

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VALAN_INTEROP
-- --------------------------------------------------




CREATE PROC [dbo].[VALAN_INTEROP]
(
	@SAUDA_Date VARCHAR(11)
)
AS

DECLARE @CLEARINGCODE	VARCHAR(10) 
 

SELECT @CLEARINGCODE = ISNULL(CLEARINGCODE,'') FROM TBL_INTEROP_SETTING
WHERE  @SAUDA_Date BETWEEN FROM_DATE AND TO_DATE

IF @CLEARINGCODE = ''
BEGIN
	RETURN
END 

DELETE FROM FOACCBILL_ORG 
WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  

INSERT INTO FOACCBILL_ORG 
SELECT * FROM FOACCBILL 
WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  

DELETE FROM FOACCBILL 
WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  

DELETE FROM FOBILLVALAN_ORG
WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'  

INSERT INTO FOBILLVALAN_ORG
SELECT * FROM FOBILLVALAN 
WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'  

DELETE FROM FOBILLVALAN
WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'  

IF @CLEARINGCODE = 'NSCCL'   
BEGIN
	UPDATE FOACCBILL_ORG SET PARTY_CODE = N.ACCODE FROM NseCurFo.DBO.ValanAccount N, BSECURFO.DBO.ValanAccount B
	WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  
	AND N.AcName = 'Clearing House'
	AND B.AcName = 'Clearing House'
	AND B.AcCode = PARTY_CODE 
	
	UPDATE FOACCBILL_ORG SET PARTY_CODE = N.ACCODE FROM NseCurFo.DBO.ValanAccount N, BSECURFO.DBO.ValanAccount B
	Where BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  
	AND N.AcName = 'Rounding Off'
	AND B.AcName = 'Rounding Off'
	AND B.AcCode = PARTY_CODE 
END
ELSE
BEGIN
	SELECT * INTO #ACC_OP FROM NSECURFO.DBO.FOACCBILL_ORG 
	WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  
	
	INSERT INTO #ACC_OP 
	SELECT PARTY_CODE,BILL_NO,SELL_BUY,SETT_NO,SETT_TYPE,BILLDATE,
	START_DATE=LEFT(START_DATE,11),END_DATE=LEFT(END_DATE,11),PAYIN_DATE=LEFT(PAYIN_DATE,11),PAYOUT_DATE=LEFT(PAYOUT_DATE,11),
	AMOUNT,EXPIRYFLAG,RESERVED1,RESERVED2,RESERVED3,BRANCHCD,NARRATION 
	FROM BSECURFO.DBO.FOACCBILL_ORG
	WHERE BILLDATE >= @SAUDA_DATE AND BILLDATE <= @SAUDA_DATE + ' 23:59'  

	INSERT INTO FOACCBILL  
	SELECT Party_Code,Bill_No,
	Sell_Buy=(CASE WHEN SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END) > 0 THEN 1 ELSE 2 END),
	Sett_No,Sett_Type,billdate,
	Start_Date=MAX(Start_Date),End_Date=MAX(End_Date),
	PayIn_Date=MAX(PayIn_Date),PayOut_Date=MAX(PayOut_Date),
	Amount=ABS(SUM(CASE WHEN SELL_BUY = 1 THEN AMOUNT ELSE -AMOUNT END)),
	EXPIRYFLAG,RESERVED1,RESERVED2,RESERVED3,branchCd,narration=MAX(narration)
	FROM #ACC_OP  
	GROUP BY Party_Code,Bill_No,Sett_No,Sett_Type,billdate,branchCd,EXPIRYFLAG,RESERVED1,RESERVED2,RESERVED3,branchCd
	
	INSERT INTO FOBILLVALAN
	SELECT PARTY_CODE,PARTY_NAME,CLIENT_TYPE,BILLNO,CONTRACTNO,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,AUCTIONPART,
		   MATURITYDATE,SAUDA_DATE,ISIN,PQTY,SQTY,PRATE,SRATE,PAMT,SAMT,PBROKAMT,SBROKAMT,PBILLAMT,SBILLAMT,CL_RATE,CL_CHRG,
		   EXCL_CHRG,SERVICE_TAX,EXSER_TAX,INEXSERFLAG,SEBI_TAX,TURN_TAX,BROKER_NOTE,INS_CHRG,OTHER_CHRG,TRADETYPE,PARTICIPANTCODE,
		   TERMINAL_ID,FAMILY,FAMILYNAME,TRADER,BRANCH_CODE,SUB_BROKER,STATUSNAME,EXCHANGE,SEGMENT,MEMBERTYPE,COMPANYNAME,REGION,
		   UPDATEDATE,EMAIL,SBU,RELMGR,GRP,SECTOR,CMCLOSING,TRACK,AREA 
	FROM BSECURFO.DBO.FOBILLVALAN_ORG
	WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'
	  
	INSERT INTO FOBILLVALAN
	SELECT PARTY_CODE,PARTY_NAME,CLIENT_TYPE,BILLNO,CONTRACTNO,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,AUCTIONPART,
		   MATURITYDATE,SAUDA_DATE,ISIN,PQTY,SQTY,PRATE,SRATE,PAMT,SAMT,PBROKAMT,SBROKAMT,PBILLAMT,SBILLAMT,CL_RATE,CL_CHRG,
		   EXCL_CHRG,SERVICE_TAX,EXSER_TAX,INEXSERFLAG,SEBI_TAX,TURN_TAX,BROKER_NOTE,INS_CHRG,OTHER_CHRG,TRADETYPE,PARTICIPANTCODE,
		   TERMINAL_ID,FAMILY,FAMILYNAME,TRADER,BRANCH_CODE,SUB_BROKER,STATUSNAME,EXCHANGE,SEGMENT,MEMBERTYPE,COMPANYNAME,REGION,
		   UPDATEDATE,EMAIL,SBU,RELMGR,GRP,SECTOR,CMCLOSING,TRACK,AREA 
	FROM NseCurFo.DBO.FOBILLVALAN_ORG
	WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59' 
	
	UPDATE FOBILLVALAN SET 
	INST_TYPE = M.INST_TYPE,
	SYMBOL = M.SYMBOL,
	EXPIRYDATE = M.EXPIRYDATE,
	STRIKE_PRICE = M.STRIKE_PRICE,
	OPTION_TYPE = M.OPTION_TYPE
	FROM TBL_FOSCRIPMAP M
	WHERE Sauda_Date >= @SAUDA_DATE AND Sauda_Date <= @SAUDA_DATE + ' 23:59'  
	AND FOBILLVALAN.INST_TYPE = M.B_INST_TYPE
	AND FOBILLVALAN.SYMBOL = M.B_SYMBOL
	AND FOBILLVALAN.EXPIRYDATE = M.B_EXPIRYDATE
	AND FOBILLVALAN.STRIKE_PRICE = M.B_STRIKE_PRICE
	AND FOBILLVALAN.OPTION_TYPE = M.B_OPTION_TYPE
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VALANGENERATE_CLCHRG
-- --------------------------------------------------

CREATE PROC [dbo].[VALANGENERATE_CLCHRG]
(	
	@SAUDA_DATE VARCHAR(11)
)
AS
DECLARE 
		@FROMPARTY	VARCHAR(10),
		@TOPARTY	VARCHAR(10)

 
SET @FROMPARTY = ''
SET @TOPARTY = 'ZZZZZZ'

SELECT TRADE_NO_CNT = 1, T.SNO, FROM_LIMIT, TO_LIMIT  
INTO #TOT
FROM TBL_TURNOVER_TAX T
WHERE @SAUDA_DATE BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE
AND T.REC_FOR = 'CLCHRG'
AND FROM_LIMIT = (SELECT MIN(FROM_LIMIT) FROM  TBL_TURNOVER_TAX T
WHERE @SAUDA_DATE BETWEEN T.EFF_FROM_DATE AND T.EFF_TO_DATE
AND T.REC_FOR = 'CLCHRG')

IF (SELECT ISNULL(COUNT(1),0) FROM #TOT ) < 1
BEGIN
	RETURN
END

SELECT A.* INTO #FOACCBILL 
FROM FOACCBILL A, VALANACCOUNT V 
WHERE BILLDATE LIKE @SAUDA_DATE + '%'
AND A.PARTY_CODE = V.ACCODE
AND V.ACNAME = 'TURN OVER TAX'

IF (SELECT ISNULL(COUNT(1),0) FROM #FOACCBILL ) >= 1
BEGIN
	DELETE FROM FOACCBILL
	WHERE BILLDATE LIKE @SAUDA_DATE + '%'
	AND EXISTS (SELECT PARTY_CODE FROM #FOACCBILL
				WHERE #FOACCBILL.BILLDATE LIKE @SAUDA_DATE + '%'
				AND FOACCBILL.PARTY_CODE = #FOACCBILL.PARTY_CODE)					

	SELECT SAUDA_DATE, PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, 
		  ORDER_NO, TRADE_NO, SRNO = MIN(SRNO), ORGTRADE_NO = MIN(TRADE_NO), TOTFLAG = 1
	INTO #TOTTRADE
	FROM (
			SELECT SAUDA_DATE=LEFT(SAUDA_DATE,11), PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, 
				   ORDER_NO, TRADE_NO = PRADNYA.DBO.REPLACETRADENO(TRADE_NO), SRNO = 
					MIN(SRNO), ORGTRADE_NO = MIN(TRADE_NO)
			FROM FOSETTLEMENT
			WHERE SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
			AND PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
			AND TRADEQTY > 0 AND PRICE > 0
			AND AUCTIONPART <> 'CA'
			GROUP BY LEFT(SAUDA_DATE,11), PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, ORDER_NO,TRADE_NO 
			) A 
	GROUP BY SAUDA_DATE, PARTY_CODE, INST_TYPE, SYMBOL, EXPIRYDATE, STRIKE_PRICE, OPTION_TYPE, ORDER_NO, TRADE_NO
	 
	CREATE TABLE #CLTAX 
	(
		PARTY_CODE	VARCHAR(10)
	)

	INSERT INTO #CLTAX
	SELECT PARTY_CODE 
	FROM FOCLIENTTAXES 
	WHERE @SAUDA_DATE BETWEEN DATE_FROM AND DATE_TO
	AND FUT_TURNOVER_TAX <= 0 
	AND EXISTS (SELECT PARTY_CODE FROM #TOTTRADE
				WHERE #TOTTRADE.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE)

	UPDATE #TOTTRADE SET TOTFLAG = 0
	FROM #CLTAX C
	WHERE C.PARTY_CODE = #TOTTRADE.PARTY_CODE

	TRUNCATE TABLE #CLTAX

	INSERT INTO #CLTAX
	SELECT PARTY_CODE 
	FROM CLIENT2 WHERE EXISTS (SELECT PARTY_CODE FROM #TOTTRADE
							   WHERE #TOTTRADE.PARTY_CODE = CLIENT2.CL_CODE)
	AND TURNOVER_TAX <= 0

	UPDATE #TOTTRADE SET TOTFLAG = 0
	FROM #CLTAX C
	WHERE C.PARTY_CODE = #TOTTRADE.PARTY_CODE

	SELECT BRANCH_CD, CHARGE_TAX = SUM(CHARGE_TAX)
	INTO #CLCHRG
	FROM FOSETTLEMENT, #TOT T, #TOTTRADE T1, TBL_TURNOVER_TAX B, CLIENT1 C2
	WHERE FOSETTLEMENT.SAUDA_DATE BETWEEN @SAUDA_DATE AND @SAUDA_DATE + ' 23:59:59'
	AND FOSETTLEMENT.PARTY_CODE BETWEEN @FROMPARTY AND @TOPARTY
	AND T.SNO = B.SNO
	AND FOSETTLEMENT.SRNO = T1.SRNO
	AND TOTFLAG = 1
	AND FOSETTLEMENT.PARTY_CODE = C2.CL_CODE
	GROUP BY BRANCH_CD

	UPDATE #FOACCBILL SET AMOUNT = AMOUNT - CLCHRG
	FROM (
			SELECT BRANCH_CD, CLCHRG = SUM(CHARGE_TAX)
			FROM #CLCHRG
			GROUP BY BRANCH_CD
			HAVING SUM(CHARGE_TAX) <> 0 
			UNION ALL
			SELECT BRANCH_CD='ZZZ', CLCHRG = SUM(CHARGE_TAX)
			FROM #CLCHRG
			HAVING SUM(CHARGE_TAX) <> 0 
		  ) A
	WHERE BRANCHCD = A.BRANCH_CD
	
	INSERT INTO FOACCBILL
	SELECT * FROM #FOACCBILL

	INSERT INTO FOACCBILL
	SELECT PARTY_CODE=ACCODE,BILL_NO,SELL_BUY,SETT_NO,SETT_TYPE,BILLDATE,START_DATE,END_DATE,PAYIN_DATE,PAYOUT_DATE,
		   AMOUNT=CLCHRG,EXPIRYFLAG,RESERVED1,RESERVED2,RESERVED3,BRANCHCD,NARRATION
    FROM #FOACCBILL, (
			SELECT BRANCH_CD, CLCHRG = SUM(CHARGE_TAX)
			FROM #CLCHRG
			GROUP BY BRANCH_CD
			HAVING SUM(CHARGE_TAX) <> 0 
			UNION ALL
			SELECT BRANCH_CD='ZZZ', CLCHRG = SUM(CHARGE_TAX)
			FROM #CLCHRG
			HAVING SUM(CHARGE_TAX) <> 0 
		  ) A, VALANACCOUNT
	WHERE BRANCHCD = A.BRANCH_CD		  
	AND ACNAME = 'ICCL CLEARING CHARGE'  
	         
	DROP TABLE #TOTTRADE
	DROP TABLE #CLTAX 
	DROP TABLE #TOT
	DROP TABLE #CLCHRG
	DROP TABLE #FOACCBILL
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VBB_CI_NEW_CLIENT
-- --------------------------------------------------
   
CREATE PROC [dbo].[VBB_CI_NEW_CLIENT] (@PARTY_CODE VARCHAR(10),@BROK_SCHEME VARCHAR(50))     
AS     
    
--SELECT DISTINCT PARTY_CODE =@PARTY_CODE ,TABLE_NAME =@BROK_SCHEME INTO #CLT     
    
--CREATE INDEX #CL ON #CLT (PARTY_CODE)    
    
SELECT DISTINCT PARTY_CODE =Cl_Code ,TABLE_NAME =@BROK_SCHEME INTO #CLT     
From Client5 With(Nolock) where Cl_code =@PARTY_CODE    
CREATE INDEX #CL ON #CLT (PARTY_CODE)    
    
IF(Select Count(1) from #CLT) >1    
Begin     
    
    
UPDATE Scheme_Mapping SET SP_Date_To= CONVERT(VARCHAR(11),GETDATE()-1,120) + ' 23:59:59.000' WHERE SP_Party_Code =@PARTY_CODE AND  SP_Date_To >GETDATE()    
    
INSERT INTO Scheme_Mapping    
SELECT DISTINCT * FROM (    
SELECT  PARTY_CODE,'O' A , 'FUT' B ,'ALL' V,CAST(SCHEME_ID AS NUMERIC) E,SM_Trd_Type, 0 SR,SM_Multiplier,SM_Buy_Brok_Type,SM_Sell_Brok_Type,    
SM_Buy_Brok,SM_Sell_Brok,SM_Res_Multiplier='0.0000',SM_Res_Buy_Brok,SM_Res_Sell_Brok,    
SM_Value_From,SM_Value_To,SM_TurnOverOn,SM_ComputationOn,SM_ComputationType, MIN_BROK ,MAX_BROK,'0.0000' S,'-1.0000' T,    
convert(varchar(11),GETDATE(),120) ERE,'2049-12-31 23:59:00.000' U,'AUTO' VX,GETDATE() RE,'' Z,GETDATE() R FROM     
(    
SELECT  SCHEME_NAME,DEL_SCHEME_ID SCHEME_ID,DEL_FROM_TURNOVER AS FROM_TURNOVER, DEL_TO_TURNOVER  AS TO_TURNOVER,DEL_MIN_BROK AS MIN_BROK,DEL_MAX_BROK  AS MAX_BROK    
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='BSX' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE     
AND DEL_SCHEME_ID <> ''    
UNION ALL    
SELECT  SCHEME_NAME,TRD_SCHEME_ID,FROM_TURNOVER, TO_TURNOVER ,MIN_BROK, MAX_BROK     
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='BSX' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE    
AND TRD_SCHEME_ID <> ''    
 ) A ,    
Scheme_Master S ,#CLT V    
WHERE SM_Scheme_Id = SCHEME_ID AND RTRIM(LTRIM(V.TABLE_NAME)) = RTRIM(LTRIM(SCHEME_NAME))  --AND EXCHANGE ='NSE' AND SEGMENT ='CAPITAL'    
AND SM_Value_From = FROM_TURNOVER AND  SM_Value_To = TO_TURNOVER    
---AND PARTY_CODE  IN (SELECT * FROM #CL)    
) A    
WHERE NOT EXISTS (SELECT SP_PARTY_CODE FROM Scheme_Mapping S WHERE S.SP_PARTY_CODE= PARTY_CODE AND SP_Date_To >GETDATE())     
UNION ALL    
SELECT DISTINCT * FROM (    
SELECT  PARTY_CODE,'O' A , 'OPT' B ,'ALL' V,CAST(SCHEME_ID AS NUMERIC) E,SM_Trd_Type, 0 SR,SM_Multiplier,SM_Buy_Brok_Type,SM_Sell_Brok_Type,    
SM_Buy_Brok,SM_Sell_Brok,SM_Res_Multiplier='0.0000',SM_Res_Buy_Brok,SM_Res_Sell_Brok,    
SM_Value_From,SM_Value_To,SM_TurnOverOn,SM_ComputationOn,SM_ComputationType, MIN_BROK ,MAX_BROK,'0.0000' S,'-1.0000' T,    
convert(varchar(11),GETDATE(),120) ERE,'2049-12-31 23:59:00.000' U,'AUTO' VX,GETDATE() RE,'' Z,GETDATE() R FROM     
(    
SELECT  SCHEME_NAME,DEL_SCHEME_ID SCHEME_ID,DEL_FROM_TURNOVER AS FROM_TURNOVER, DEL_TO_TURNOVER  AS TO_TURNOVER,DEL_MIN_BROK AS MIN_BROK,DEL_MAX_BROK  AS MAX_BROK    
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='BSX' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE     
AND DEL_SCHEME_ID <> ''    
UNION ALL    
SELECT  SCHEME_NAME,TRD_SCHEME_ID,FROM_TURNOVER, TO_TURNOVER ,MIN_BROK, MAX_BROK     
FROM Vw_MAPPING_TABLE WHERE EXCHANGE ='BSX' AND SEGMENT ='FUTURES' AND GETDATE()  BETWEEN FROM_DATE AND TO_DATE    
AND TRD_SCHEME_ID <> ''    
 ) A ,    
Scheme_Master S ,#CLT V    
WHERE SM_Scheme_Id = SCHEME_ID AND RTRIM(LTRIM(V.TABLE_NAME)) = RTRIM(LTRIM(SCHEME_NAME))  --AND EXCHANGE ='NSE' AND SEGMENT ='CAPITAL'    
AND SM_Value_From = FROM_TURNOVER AND  SM_Value_To = TO_TURNOVER    
---AND PARTY_CODE  IN (SELECT * FROM #CL)    
) A    
WHERE NOT EXISTS (SELECT SP_PARTY_CODE FROM Scheme_Mapping S WHERE S.SP_PARTY_CODE= PARTY_CODE AND SP_Date_To >GETDATE())     
    
UPDATE R SET CR_Date_To = CR_Date_FROM-1 + ' 23:59:59.000'    
FROM  CONTRACT_ROUNDING R, #CLT C WHERE CR_Party_Code =C.Party_Code  AND CR_Date_To >= GETDATE()    
    
    
UPDATE R SET TODATE = CONVERT(VARCHAR(11),GETDATE()-1,120) + ' 23:59:59.000'    
FROM  TBL_ADDITIONAL_BROEKRAGE R, #CLT C WHERE R.Party_Code =C.Party_Code  AND TODATE >= GETDATE()    
    
      SELECT 'BSX' AS EXCHANGE,'FUTURES' AS SEGMENT, @BROK_SCHEME+' UPDATED' AS STATUS 
    
END    ELSE     
BEGIN     
  Select 'BSX' AS EXCHANGE,'FUTURES' AS SEGMENT,'Client Not Registered' As Status    
    
   Return    
    
End    
    
    
    
    
--IF @@ROWCOUNT =0     
--  BEGIN     
    
--   Select 'Aleready Marked' As Status    
    
--   Return    
--  End    
    
--UPDATE R SET CR_Date_To = CR_Date_FROM-1 + ' 23:59:59.000'    
--FROM  CONTRACT_ROUNDING R, #CLT C WHERE CR_Party_Code =C.Party_Code  AND CR_Date_To >= GETDATE()    
    
--UPDATE R SET TODATE = CONVERT(VARCHAR(11),GETDATE()-1,120) + ' 23:59:59.000'    
--FROM  TBL_ADDITIONAL_BROEKRAGE R, #CLT C WHERE R.Party_Code =C.Party_Code  AND TODATE >= GETDATE()

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Vw
-- --------------------------------------------------
    
CREATE PROC Vw @VwName VARCHAR(25)AS                   
Select * from sysobjects where name Like '%' + @VwName + '%' and xtype='V' Order By Name

GO

-- --------------------------------------------------
-- TABLE dbo.ACCBILL
-- --------------------------------------------------
CREATE TABLE [dbo].[ACCBILL]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] VARCHAR(2) NOT NULL,
    [SETT_NO] VARCHAR(7) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [START_DATE] DATETIME NOT NULL,
    [END_DATE] DATETIME NOT NULL,
    [PAYIN_DATE] DATETIME NOT NULL,
    [PAYOUT_DATE] DATETIME NOT NULL,
    [AMOUNT] NUMERIC(36, 12) NOT NULL,
    [BRANCHCD] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AREA
-- --------------------------------------------------
CREATE TABLE [dbo].[AREA]
(
    [AreaCode] VARCHAR(20) NULL,
    [Description] VARCHAR(50) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Dummy1] VARCHAR(1) NULL,
    [Dummy2] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AUTHORISEDSIGNATORY
-- --------------------------------------------------
CREATE TABLE [dbo].[AUTHORISEDSIGNATORY]
(
    [AUTH1] VARCHAR(50) NULL,
    [AUTH2] VARCHAR(50) NULL,
    [AUTH3] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.AUTHORISEDSIGNETORIES
-- --------------------------------------------------
CREATE TABLE [dbo].[AUTHORISEDSIGNETORIES]
(
    [AUTHORISEDSIGNETORY1] VARCHAR(100) NULL,
    [AUTHORISEDSIGNETORY2] VARCHAR(100) NULL,
    [AUTHORISEDSIGNETORY3] VARCHAR(100) NULL,
    [AUTHORISEDSIGNETORY4] VARCHAR(100) NULL,
    [AUTHORISEDSIGNETORY5] VARCHAR(100) NULL,
    [AUTHORISEDSIGNETORY6] VARCHAR(100) NULL,
    [AUTHORISEDSIGNETORY7] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BADDEBTSDP_JAN2017
-- --------------------------------------------------
CREATE TABLE [dbo].[BADDEBTSDP_JAN2017]
(
    [NISE_PARTY_CODE] VARCHAR(10) NULL,
    [CLIENT_CODE] VARCHAR(16) NULL,
    [OS] MONEY NULL,
    [INVTOZERO] MONEY NULL,
    [ZEROTOINV] MONEY NULL,
    [BADDEBTS] MONEY NULL,
    [BDRECOVERY] MONEY NULL,
    [HOLDING_VAL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BADDEBTSDP_MAR2017_NEW
-- --------------------------------------------------
CREATE TABLE [dbo].[BADDEBTSDP_MAR2017_NEW]
(
    [NISE_PARTY_CODE] VARCHAR(10) NULL,
    [CLIENT_CODE] VARCHAR(16) NULL,
    [OS] MONEY NULL,
    [INVTOZERO] MONEY NULL,
    [ZEROTOINV] MONEY NULL,
    [BADDEBTS] MONEY NULL,
    [BDRECOVERY] MONEY NULL,
    [HOLDING_VAL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BADDEBTSDP_MAY2017
-- --------------------------------------------------
CREATE TABLE [dbo].[BADDEBTSDP_MAY2017]
(
    [NISE_PARTY_CODE] VARCHAR(10) NULL,
    [CLIENT_CODE] VARCHAR(16) NULL,
    [OS] MONEY NULL,
    [INVTOZERO] MONEY NULL,
    [ZEROTOINV] MONEY NULL,
    [BADDEBTS] MONEY NULL,
    [BDRECOVERY] MONEY NULL,
    [HOLDING_VAL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BADDEBTSDP_SEP2016
-- --------------------------------------------------
CREATE TABLE [dbo].[BADDEBTSDP_SEP2016]
(
    [NISE_PARTY_CODE] VARCHAR(10) NULL,
    [CLIENT_CODE] VARCHAR(16) NULL,
    [OS] MONEY NULL,
    [INVTOZERO] MONEY NULL,
    [ZEROTOINV] MONEY NULL,
    [BADDEBTS] MONEY NULL,
    [BDRECOVERY] MONEY NULL,
    [HOLDING_VAL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BAK_TBL_TURN_OVER_SLAB_29122017
-- --------------------------------------------------
CREATE TABLE [dbo].[BAK_TBL_TURN_OVER_SLAB_29122017]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [INST_TYPE] VARCHAR(3) NULL,
    [FROMDATE] DATETIME NULL,
    [TODATE] DATETIME NULL,
    [TOT_LOW_LIMIT] NUMERIC(18, 6) NULL,
    [TOT_UP_LIMIT] NUMERIC(18, 6) NULL,
    [TOT_PER] NUMERIC(18, 12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BANK
-- --------------------------------------------------
CREATE TABLE [dbo].[BANK]
(
    [BankId] VARCHAR(16) NULL,
    [BankName] VARCHAR(50) NULL,
    [address1] VARCHAR(35) NULL,
    [address2] VARCHAR(60) NULL,
    [city] VARCHAR(30) NULL,
    [pincode] VARCHAR(20) NULL,
    [phone1] VARCHAR(20) NULL,
    [phone2] VARCHAR(20) NULL,
    [phone3] VARCHAR(20) NULL,
    [phone4] VARCHAR(20) NULL,
    [fax1] VARCHAR(20) NULL,
    [fax2] VARCHAR(20) NULL,
    [email] VARCHAR(50) NULL,
    [BankType] VARCHAR(5) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BBGFOSETTLEMENT
-- --------------------------------------------------
CREATE TABLE [dbo].[BBGFOSETTLEMENT]
(
    [ContractNo] VARCHAR(14) NULL,
    [BillNo] VARCHAR(10) NULL,
    [Trade_no] VARCHAR(10) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_name] VARCHAR(25) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [User_id] VARCHAR(15) NULL,
    [Pro_cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [MarketType] VARCHAR(2) NULL,
    [Series] CHAR(2) NULL,
    [Order_no] VARCHAR(20) NULL,
    [Price] MONEY NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NULL,
    [Line_No] NUMERIC(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_puc] MONEY NULL,
    [day_sales] MONEY NULL,
    [Sett_purch] MONEY NULL,
    [Sett_sales] MONEY NULL,
    [Sell_buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] MONEY NULL,
    [NetRate] NUMERIC(15, 7) NULL,
    [Amount] MONEY NULL,
    [Ins_chrg] MONEY NULL,
    [turn_tax] MONEY NULL,
    [other_chrg] MONEY NULL,
    [sebi_tax] MONEY NULL,
    [Broker_chrg] MONEY NULL,
    [Service_tax] MONEY NULL,
    [Trade_amount] MONEY NULL,
    [Billflag] INT NULL,
    [sett_no] VARCHAR(16) NULL,
    [NBrokApp] MONEY NULL,
    [NSerTax] MONEY NULL,
    [N_NetRate] NUMERIC(15, 7) NULL,
    [sett_type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [ParticipantCode] VARCHAR(15) NULL,
    [Status] VARCHAR(3) NULL,
    [CpId] VARCHAR(20) NULL,
    [Instrument] INT NULL,
    [BookType] INT NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [TMark] VARCHAR(10) NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] MONEY NULL,
    [Reserved1] INT NULL,
    [Reserved2] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bd_jan
-- --------------------------------------------------
CREATE TABLE [dbo].[bd_jan]
(
    [Clientcode] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Baddebt_recovery] FLOAT NULL,
    [TYPE] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.bdr
-- --------------------------------------------------
CREATE TABLE [dbo].[bdr]
(
    [Client Code] NVARCHAR(255) NULL,
    [Amount] FLOAT NULL,
    [Type ] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BFOOWNER
-- --------------------------------------------------
CREATE TABLE [dbo].[BFOOWNER]
(
    [Company] VARCHAR(50) NOT NULL,
    [Addr1] VARCHAR(30) NULL,
    [Addr2] VARCHAR(30) NULL,
    [Phone] VARCHAR(15) NULL,
    [Zip] VARCHAR(6) NULL,
    [city] VARCHAR(15) NULL,
    [membertype] VARCHAR(15) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [BankName] VARCHAR(50) NULL,
    [BankAdd] VARCHAR(50) NULL,
    [csdlId] VARCHAR(10) NULL,
    [Cdaccno] VARCHAR(10) NULL,
    [DpId] VARCHAR(10) NULL,
    [CltAccNo] VARCHAR(10) NULL,
    [Mainbroker] CHAR(1) NULL,
    [Maxpartylen] TINYINT NULL,
    [Preprintchq] CHAR(1) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_TableNo] SMALLINT NULL,
    [Std_rate] SMALLINT NULL,
    [P_to_P] SMALLINT NULL,
    [demat_tableno] SMALLINT NULL,
    [AlbmCf_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [Terminal] VARCHAR(10) NULL,
    [tscheme] TINYINT NULL,
    [dispcharge] TINYINT NULL,
    [Brok_Inc_STax] TINYINT NULL,
    [def_scheme] CHAR(1) NULL,
    [brok_scheme] TINYINT NULL,
    [ContCharge] TINYINT NULL,
    [MinContCharge] TINYINT NULL,
    [MarginMultiplier] TINYINT NULL,
    [TradingFees] MONEY NULL,
    [ClearingFees] MONEY NULL,
    [MinChrgTrdfees] MONEY NULL,
    [MinChrgClfees] MONEY NULL,
    [TrdFeePerValue] MONEY NULL,
    [ClFeePerValue] MONEY NULL,
    [Tm_Code] VARCHAR(10) NULL,
    [dummy1] TINYINT NULL,
    [dummy2] TINYINT NULL,
    [clrgchg] INT NULL,
    [chmclchrg] INT NULL,
    [StampDuty] TINYINT NULL,
    [Turnover_Tax] TINYINT NULL,
    [TaxesFlag] INT NULL,
    [ContNo] VARCHAR(8) NULL,
    [Style] INT NULL,
    [ContPrint_Party_Style] INT NULL,
    [Email] VARCHAR(50) NULL,
    [state] VARCHAR(50) NULL,
    [SebiNo] VARCHAR(20) NULL,
    [BrokerSebiRegNo] VARCHAR(20) NULL,
    [SMTP_SRV_NAME] VARCHAR(50) NULL,
    [EXCHANGECODE] VARCHAR(3) NULL,
    [Panno] VARCHAR(15) NULL,
    [PARENTCODE_FLAG] INT NULL,
    [COMPLIANCE_NAME] VARCHAR(50) NULL,
    [COMPLIANCE_EMAIL] VARCHAR(100) NULL,
    [COMPLIANCE_PHONE] VARCHAR(15) NULL,
    [COMPLIANCE_MOBILE] VARCHAR(15) NULL,
    [WEBSITE_ID] VARCHAR(100) NULL,
    [FAX] VARCHAR(25) NULL,
    [SERVICES_TAXNO] VARCHAR(30) NULL,
    [CUT_CHRGS_FROM_BROK] INT NULL,
    [CIN] VARCHAR(30) NULL,
    [VB_RDO_CONNECTION] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILL_DIGITAL_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[BILL_DIGITAL_DATA]
(
    [C_SR_NO] NUMERIC(10, 0) IDENTITY(1,1) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILL_DIGITAL_TEXT
-- --------------------------------------------------
CREATE TABLE [dbo].[BILL_DIGITAL_TEXT]
(
    [C_SR_NO] NUMERIC(10, 0) IDENTITY(1,1) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BILLNO
-- --------------------------------------------------
CREATE TABLE [dbo].[BILLNO]
(
    [bill_no] INT IDENTITY(1,1) NOT NULL,
    [party_code] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BRANCH
-- --------------------------------------------------
CREATE TABLE [dbo].[BRANCH]
(
    [BRANCH_CODE] CHAR(20) NULL,
    [BRANCH] CHAR(80) NULL,
    [Long_Name] CHAR(100) NULL,
    [Address1] CHAR(100) NULL,
    [Address2] CHAR(100) NULL,
    [City] CHAR(40) NULL,
    [State] CHAR(30) NULL,
    [Nation] CHAR(30) NULL,
    [Zip] CHAR(30) NULL,
    [Phone1] CHAR(30) NULL,
    [Phone2] CHAR(30) NULL,
    [Fax] CHAR(30) NULL,
    [Email] CHAR(100) NULL,
    [Remote] BIT NOT NULL,
    [Security_Net] BIT NOT NULL,
    [Money_Net] BIT NOT NULL,
    [Excise_Reg] CHAR(60) NULL,
    [Contact_Person] CHAR(100) NULL,
    [prefix] CHAR(3) NULL,
    [REMPARTYCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BranchBrokTable
-- --------------------------------------------------
CREATE TABLE [dbo].[BranchBrokTable]
(
    [Table_No] INT NULL,
    [Table_Name] VARCHAR(30) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Table_Type] CHAR(1) NULL,
    [Created_By] VARCHAR(25) NULL,
    [Created_On] DATETIME NULL,
    [Sr_No] INT IDENTITY(1,1) NOT NULL,
    [Remarks] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BRANCHES
-- --------------------------------------------------
CREATE TABLE [dbo].[BRANCHES]
(
    [Branch_cd] CHAR(10) NOT NULL,
    [Short_Name] CHAR(20) NOT NULL,
    [Long_Name] CHAR(50) NULL,
    [Address1] CHAR(25) NULL,
    [Address2] CHAR(25) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Fax] CHAR(15) NULL,
    [Email] CHAR(50) NULL,
    [Remote] BIT NOT NULL,
    [Security_Net] BIT NOT NULL,
    [Money_Net] BIT NOT NULL,
    [Excise_Reg] CHAR(30) NULL,
    [Contact_Person] CHAR(25) NULL,
    [Com_Perc] MONEY NULL,
    [Terminal_Id] VARCHAR(10) NULL,
    [deftrader] BIT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BRANCHPAYMODE
-- --------------------------------------------------
CREATE TABLE [dbo].[BRANCHPAYMODE]
(
    [AcName] VARCHAR(100) NULL,
    [Branch] VARCHAR(10) NULL,
    [CltCode] VARCHAR(10) NULL,
    [Created_By] VARCHAR(25) NULL,
    [Created_On] DATETIME NULL,
    [Sr_no] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.BROKTABLE
-- --------------------------------------------------
CREATE TABLE [dbo].[BROKTABLE]
(
    [Table_No] SMALLINT NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_perc] CHAR(1) NULL,
    [Upper_lim] MONEY NULL,
    [Day_puc] NUMERIC(18, 4) NULL,
    [Day_Sales] NUMERIC(18, 4) NULL,
    [Sett_Purch] NUMERIC(18, 4) NULL,
    [round_to] DECIMAL(10, 2) NULL,
    [Table_name] CHAR(25) NULL,
    [sett_sales] NUMERIC(18, 4) NULL,
    [NORMAL] DECIMAL(10, 6) NULL,
    [Trd_Del] CHAR(1) NULL,
    [Lower_lim] DECIMAL(10, 2) NULL,
    [Def_table] TINYINT NULL,
    [RoFig] INT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] INT NULL,
    [Branch_code] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.broktablevalues
-- --------------------------------------------------
CREATE TABLE [dbo].[broktablevalues]
(
    [brok] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CHARGES_DETAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[CHARGES_DETAIL]
(
    [CD_SRNO] INT IDENTITY(1,1) NOT NULL,
    [CD_PARTY_CODE] VARCHAR(10) NOT NULL,
    [CD_SAUDA_DATE] DATETIME NOT NULL,
    [CD_CONTRACT_NO] VARCHAR(14) NOT NULL,
    [CD_TRADE_NO] VARCHAR(15) NOT NULL,
    [CD_ORDER_NO] VARCHAR(20) NULL,
    [CD_INST_TYPE] VARCHAR(6) NOT NULL,
    [CD_SYMBOL] VARCHAR(12) NOT NULL,
    [CD_EXPIRY_DATE] DATETIME NOT NULL,
    [CD_OPTION_TYPE] VARCHAR(2) NOT NULL,
    [CD_STRIKE_PRICE] MONEY NOT NULL,
    [CD_AUCTIONPART] VARCHAR(2) NOT NULL,
    [CD_MARKETLOT] INT NOT NULL,
    [CD_SCHEME_ID] INT NOT NULL,
    [CD_COMPUTATIONLEVEL] CHAR(1) NOT NULL,
    [CD_COMPUTATIONON] CHAR(1) NOT NULL,
    [CD_COMPUTATIONTYPE] CHAR(1) NOT NULL,
    [CD_BUYRATE] NUMERIC(36, 12) NOT NULL,
    [CD_SELLRATE] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_BUYQTY] INT NOT NULL,
    [CD_TOT_SELLQTY] INT NOT NULL,
    [CD_TOT_BUYTURNOVER] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SELLTURNOVER] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_BUYTURNOVER_ROUNDED] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SELLTURNOVER_ROUNDED] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_TURNOVER] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_TURNOVER_ROUNDED] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_LOT] INT NOT NULL,
    [CD_TOT_RES_TURNOVER] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_RES_TURNOVER_ROUNDED] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_RES_LOT] INT NOT NULL,
    [CD_TOT_BUYBROK] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SELLBROK] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_BROK] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_BUYSERTAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SELLSERTAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SERTAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_STT] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_TURN_TAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_OTHER_CHRG] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_SEBI_TAX] NUMERIC(36, 12) NOT NULL,
    [CD_TOT_STAMPDUTY] NUMERIC(36, 12) NOT NULL,
    [CD_EXCH_BUYRATE] NUMERIC(36, 12) NOT NULL,
    [CD_EXCH_SELLRATE] NUMERIC(36, 12) NOT NULL,
    [CD_TIMESTAMP] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Class_SQLTableIndex
-- --------------------------------------------------
CREATE TABLE [dbo].[Class_SQLTableIndex]
(
    [TableName] VARCHAR(50) NULL,
    [IndexName] VARCHAR(200) NULL,
    [IndexType] VARCHAR(18) NULL,
    [IndexColumns] NVARCHAR(800) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Class_SQLTableListing
-- --------------------------------------------------
CREATE TABLE [dbo].[Class_SQLTableListing]
(
    [TableName] VARCHAR(50) NULL,
    [Description] VARCHAR(200) NULL,
    [StatusFlag] CHAR(1) NULL,
    [CreatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLASSFILEUPD
-- --------------------------------------------------
CREATE TABLE [dbo].[CLASSFILEUPD]
(
    [FILE_DATA] VARCHAR(8000) NULL,
    [SESSION_ID] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLASSFILEUPD_BULK
-- --------------------------------------------------
CREATE TABLE [dbo].[CLASSFILEUPD_BULK]
(
    [FILEDATA] VARCHAR(2000) NOT NULL,
    [SPID] BIGINT NOT NULL DEFAULT @@spid
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLASSFILEUPD_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[CLASSFILEUPD_LOG]
(
    [FILE_PARAM] VARCHAR(1000) NULL,
    [SESSION_ID] VARCHAR(30) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT_BROK_DETAILS_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT_BROK_DETAILS_TMP]
(
    [CL_CODE] VARCHAR(10) NOT NULL,
    [EXCHANGE] VARCHAR(3) NOT NULL,
    [SEGMENT] VARCHAR(7) NOT NULL,
    [BROK_SCHEME] TINYINT NULL,
    [TRD_BROK] INT NULL,
    [DEL_BROK] INT NULL,
    [SER_TAX] TINYINT NULL,
    [SER_TAX_METHOD] TINYINT NULL,
    [CREDIT_LIMIT] INT NOT NULL,
    [INACTIVE_FROM] DATETIME NULL,
    [PRINT_OPTIONS] TINYINT NULL,
    [NO_OF_COPIES] INT NULL,
    [PARTICIPANT_CODE] VARCHAR(15) NULL,
    [CUSTODIAN_CODE] VARCHAR(50) NULL,
    [INST_CONTRACT] CHAR(1) NULL,
    [ROUND_STYLE] INT NULL,
    [STP_PROVIDER] VARCHAR(5) NULL,
    [STP_RP_STYLE] TINYINT NULL,
    [MARKET_TYPE] INT NULL,
    [MULTIPLIER] INT NULL,
    [CHARGED] INT NULL,
    [MAINTENANCE] INT NULL,
    [REQD_BY_EXCH] INT NULL,
    [REQD_BY_BROKER] INT NULL,
    [CLIENT_RATING] VARCHAR(10) NULL,
    [DEBIT_BALANCE] CHAR(1) NULL,
    [INTER_SETT] CHAR(1) NULL,
    [TRD_STT] MONEY NULL,
    [TRD_TRAN_CHRGS] FLOAT NULL,
    [TRD_SEBI_FEES] MONEY NULL,
    [TRD_STAMP_DUTY] MONEY NULL,
    [TRD_OTHER_CHRGS] MONEY NULL,
    [TRD_EFF_DT] DATETIME NULL,
    [DEL_STT] MONEY NULL,
    [DEL_TRAN_CHRGS] FLOAT NULL,
    [DEL_SEBI_FEES] MONEY NULL,
    [DEL_STAMP_DUTY] MONEY NULL,
    [DEL_OTHER_CHRGS] MONEY NULL,
    [DEL_EFF_DT] DATETIME NULL,
    [ROUNDING_METHOD] VARCHAR(10) NULL,
    [ROUND_TO_DIGIT] TINYINT NULL,
    [ROUND_TO_PAISE] INT NULL,
    [FUT_BROK] INT NULL,
    [FUT_OPT_BROK] INT NULL,
    [FUT_FUT_FIN_BROK] INT NULL,
    [FUT_OPT_EXC] INT NULL,
    [FUT_BROK_APPLICABLE] INT NULL,
    [FUT_STT] SMALLINT NULL,
    [FUT_TRAN_CHRGS] SMALLINT NULL,
    [FUT_SEBI_FEES] SMALLINT NULL,
    [FUT_STAMP_DUTY] SMALLINT NULL,
    [FUT_OTHER_CHRGS] SMALLINT NULL,
    [STATUS] CHAR(1) NULL,
    [MODIFIEDON] DATETIME NULL,
    [MODIFIEDBY] VARCHAR(25) NULL,
    [IMP_STATUS] TINYINT NULL,
    [PAY_B3B_PAYMENT] CHAR(1) NULL,
    [PAY_BANK_NAME] VARCHAR(50) NULL,
    [PAY_BRANCH_NAME] VARCHAR(50) NULL,
    [PAY_AC_NO] VARCHAR(10) NULL,
    [PAY_PAYMENT_MODE] CHAR(1) NULL,
    [BROK_EFF_DATE] DATETIME NULL,
    [INST_TRD_BROK] INT NULL,
    [INST_DEL_BROK] INT NULL,
    [SYSTEMDATE] DATETIME NULL,
    [ACTIVE_DATE] DATETIME NULL,
    [CHECKACTIVECLIENT] VARCHAR(1) NULL,
    [Deactive_Remarks] VARCHAR(100) NULL,
    [Deactive_value] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client_details_tmp
-- --------------------------------------------------
CREATE TABLE [dbo].[client_details_tmp]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [branch_cd] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NOT NULL,
    [sub_broker] VARCHAR(10) NOT NULL,
    [trader] VARCHAR(20) NULL,
    [long_name] VARCHAR(100) NULL,
    [short_name] VARCHAR(21) NOT NULL,
    [l_address1] VARCHAR(40) NOT NULL,
    [l_city] VARCHAR(40) NULL,
    [l_address2] VARCHAR(40) NULL,
    [l_state] VARCHAR(50) NULL,
    [l_address3] VARCHAR(40) NULL,
    [l_nation] VARCHAR(15) NULL,
    [l_zip] VARCHAR(10) NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [ward_no] VARCHAR(50) NULL,
    [sebi_regn_no] VARCHAR(25) NULL,
    [res_phone1] VARCHAR(15) NULL,
    [res_phone2] VARCHAR(15) NULL,
    [off_phone1] VARCHAR(15) NULL,
    [off_phone2] VARCHAR(15) NULL,
    [mobile_pager] VARCHAR(40) NULL,
    [fax] VARCHAR(15) NULL,
    [email] VARCHAR(50) NULL,
    [cl_type] VARCHAR(3) NOT NULL,
    [cl_status] VARCHAR(3) NOT NULL,
    [family] VARCHAR(10) NOT NULL,
    [region] VARCHAR(50) NULL,
    [area] VARCHAR(10) NULL,
    [p_address1] VARCHAR(50) NULL,
    [p_city] VARCHAR(20) NULL,
    [p_address2] VARCHAR(50) NULL,
    [p_state] VARCHAR(50) NULL,
    [p_address3] VARCHAR(50) NULL,
    [p_nation] VARCHAR(15) NULL,
    [p_zip] VARCHAR(10) NULL,
    [p_phone] VARCHAR(15) NULL,
    [addemailid] VARCHAR(230) NULL,
    [sex] CHAR(1) NULL,
    [dob] DATETIME NULL,
    [introducer] VARCHAR(30) NULL,
    [approver] VARCHAR(30) NULL,
    [interactmode] TINYINT NULL,
    [passport_no] VARCHAR(30) NULL,
    [passport_issued_at] VARCHAR(30) NULL,
    [passport_issued_on] DATETIME NULL,
    [passport_expires_on] DATETIME NULL,
    [licence_no] VARCHAR(30) NULL,
    [licence_issued_at] VARCHAR(30) NULL,
    [licence_issued_on] DATETIME NULL,
    [licence_expires_on] DATETIME NULL,
    [rat_card_no] VARCHAR(30) NULL,
    [rat_card_issued_at] VARCHAR(30) NULL,
    [rat_card_issued_on] DATETIME NULL,
    [votersid_no] VARCHAR(30) NULL,
    [votersid_issued_at] VARCHAR(30) NULL,
    [votersid_issued_on] DATETIME NULL,
    [it_return_yr] VARCHAR(30) NULL,
    [it_return_filed_on] DATETIME NULL,
    [regr_no] VARCHAR(50) NULL,
    [regr_at] VARCHAR(50) NULL,
    [regr_on] DATETIME NULL,
    [regr_authority] VARCHAR(50) NULL,
    [client_agreement_on] DATETIME NULL,
    [sett_mode] VARCHAR(50) NULL,
    [dealing_with_other_tm] VARCHAR(50) NULL,
    [other_ac_no] VARCHAR(50) NULL,
    [introducer_id] VARCHAR(50) NULL,
    [introducer_relation] VARCHAR(50) NULL,
    [repatriat_bank] NUMERIC(18, 0) NULL,
    [repatriat_bank_ac_no] VARCHAR(30) NULL,
    [chk_kyc_form] TINYINT NULL,
    [chk_corporate_deed] TINYINT NULL,
    [chk_bank_certificate] TINYINT NULL,
    [chk_annual_report] TINYINT NULL,
    [chk_networth_cert] TINYINT NULL,
    [chk_corp_dtls_recd] TINYINT NULL,
    [Bank_Name] VARCHAR(50) NULL,
    [Branch_Name] VARCHAR(50) NULL,
    [AC_Type] VARCHAR(10) NULL,
    [AC_Num] VARCHAR(20) NULL,
    [Depository1] VARCHAR(7) NULL,
    [DpId1] VARCHAR(16) NULL,
    [CltDpId1] VARCHAR(16) NULL,
    [Poa1] CHAR(1) NULL,
    [Depository2] VARCHAR(7) NULL,
    [DpId2] VARCHAR(16) NULL,
    [CltDpId2] VARCHAR(16) NULL,
    [Poa2] CHAR(1) NULL,
    [Depository3] VARCHAR(7) NULL,
    [DpId3] VARCHAR(16) NULL,
    [CltDpId3] VARCHAR(16) NULL,
    [Poa3] CHAR(1) NULL,
    [rel_mgr] VARCHAR(10) NULL,
    [c_group] VARCHAR(10) NULL,
    [sbu] VARCHAR(10) NULL,
    [Status] CHAR(1) NULL,
    [Imp_Status] TINYINT NULL,
    [ModifidedBy] VARCHAR(25) NULL,
    [ModifidedOn] DATETIME NULL,
    [Bank_id] VARCHAR(9) NULL,
    [Mapin_id] VARCHAR(12) NULL,
    [UCC_Code] VARCHAR(12) NULL,
    [Micr_No] VARCHAR(10) NULL,
    [Director_name] VARCHAR(200) NULL,
    [paylocation] VARCHAR(20) NULL,
    [FMCode] VARCHAR(10) NULL,
    [INCOME_SLAB] INT NULL,
    [NETWORTH_SLAB] INT NULL,
    [PARENTCODE] VARCHAR(10) NULL,
    [PRODUCTCODE] VARCHAR(10) NULL,
    [RES_PHONE1_STD] VARCHAR(5) NULL,
    [RES_PHONE2_STD] VARCHAR(5) NULL,
    [OFF_PHONE1_STD] VARCHAR(5) NULL,
    [OFF_PHONE2_STD] VARCHAR(5) NULL,
    [P_PHONE_STD] VARCHAR(5) NULL,
    [GST_NO] VARCHAR(20) NULL,
    [GST_LOCATION] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT_PARTY_MODIFICATION_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT_PARTY_MODIFICATION_TMP]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [OLD_PARTY_CODE] VARCHAR(10) NOT NULL,
    [NEW_PARTY_CODE] VARCHAR(10) NOT NULL,
    [BRANCH_CD] VARCHAR(10) NOT NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [TRADER] VARCHAR(10) NOT NULL,
    [FAMILY] VARCHAR(10) NOT NULL,
    [AREA] VARCHAR(10) NOT NULL,
    [REGION] VARCHAR(20) NOT NULL,
    [STATUS] INT NOT NULL,
    [ADDEDBY] VARCHAR(50) NOT NULL,
    [ADDEDON] DATETIME NOT NULL,
    [UPDATEDON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT1
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT1]
(
    [Cl_Code] VARCHAR(10) NOT NULL,
    [Short_Name] VARCHAR(21) NOT NULL,
    [Long_Name] VARCHAR(100) NULL,
    [L_Address1] VARCHAR(100) NULL,
    [L_Address2] VARCHAR(100) NULL,
    [L_city] VARCHAR(40) NULL,
    [L_State] VARCHAR(50) NULL,
    [L_Nation] VARCHAR(15) NULL,
    [L_Zip] VARCHAR(10) NULL,
    [Fax] VARCHAR(15) NULL,
    [Res_Phone1] VARCHAR(15) NULL,
    [Res_Phone2] VARCHAR(15) NULL,
    [Off_Phone1] VARCHAR(15) NULL,
    [Off_Phone2] VARCHAR(15) NULL,
    [Email] VARCHAR(100) NULL,
    [Branch_cd] VARCHAR(10) NULL,
    [Credit_Limit] DECIMAL(13, 2) NULL,
    [Cl_type] VARCHAR(3) NOT NULL,
    [Cl_Status] VARCHAR(3) NOT NULL,
    [Gl_Code] VARCHAR(20) NULL,
    [Fd_Code] VARCHAR(25) NULL,
    [Family] VARCHAR(10) NOT NULL,
    [Penalty] DECIMAL(6, 0) NULL,
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Confirm_fax] TINYINT NOT NULL,
    [PhoneOld] VARCHAR(40) NULL,
    [L_Address3] VARCHAR(100) NULL,
    [Mobile_Pager] VARCHAR(40) NULL,
    [pan_gir_no] VARCHAR(50) NULL,
    [trader] VARCHAR(20) NULL,
    [WARD_NO] VARCHAR(50) NULL,
    [Region] VARCHAR(20) NULL,
    [Area] VARCHAR(20) NULL,
    [ClRating] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT2
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT2]
(
    [Cl_Code] CHAR(10) NOT NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Tran_Cat] CHAR(3) NOT NULL,
    [Scrip_Cat] NUMERIC(18, 4) NULL,
    [Party_Code] CHAR(10) NOT NULL,
    [Table_No] INT NULL,
    [Sub_Tableno] INT NULL,
    [Margin] TINYINT NOT NULL,
    [Turnover_Tax] TINYINT NOT NULL,
    [Sebi_Turn_Tax] TINYINT NOT NULL,
    [Insurance_Chrg] TINYINT NOT NULL,
    [Service_Chrg] TINYINT NOT NULL,
    [Std_Rate] INT NULL,
    [P_To_P] INT NULL,
    [Exposure_Lim] NUMERIC(12, 2) NOT NULL,
    [Demat_Tableno] INT NULL,
    [Bankid] VARCHAR(16) NULL,
    [Cltdpno] VARCHAR(16) NULL,
    [Printf] TINYINT NOT NULL,
    [Albmdelchrg] TINYINT NULL,
    [Albmdelivery] INT NULL,
    [Albmcf_Tableno] INT NULL,
    [Mf_Tableno] INT NULL,
    [Sb_Tableno] INT NULL,
    [Brok1_Tableno] INT NULL,
    [Brok2_Tableno] INT NULL,
    [Brok3_Tableno] INT NULL,
    [Brokernote] TINYINT NULL,
    [Other_Chrg] TINYINT NULL,
    [Brok_Scheme] TINYINT NULL,
    [Contcharge] TINYINT NULL,
    [Mincontamt] TINYINT NULL,
    [Addledgerbal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] INT NULL,
    [Inscont] CHAR(1) NULL,
    [Sertaxmethod] INT NULL,
    [Dummy6] VARCHAR(5) NULL,
    [Dummy7] VARCHAR(4) NULL,
    [Dummy8] VARCHAR(10) NULL,
    [Dummy9] VARCHAR(10) NULL,
    [Dummy10] VARCHAR(10) NULL,
    [PARENTCODE] VARCHAR(10) NULL,
    [PRODUCTCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT2_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT2_LOG]
(
    [Cl_Code] CHAR(10) NULL,
    [Exchange] CHAR(3) NULL,
    [Tran_Cat] CHAR(3) NULL,
    [Scrip_Cat] DECIMAL(9, 0) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_Tableno] SMALLINT NULL,
    [Margin] TINYINT NULL,
    [Turnover_Tax] TINYINT NULL,
    [Sebi_Turn_Tax] TINYINT NULL,
    [Insurance_Chrg] TINYINT NULL,
    [Service_Chrg] TINYINT NULL,
    [Std_Rate] INT NULL,
    [P_To_P] INT NULL,
    [Exposure_Lim] DECIMAL(18, 0) NULL,
    [Demat_Tableno] INT NULL,
    [Bankid] VARCHAR(16) NULL,
    [Cltdpno] VARCHAR(16) NULL,
    [Printf] TINYINT NULL,
    [Albmdelchrg] TINYINT NULL,
    [Albmdelivery] INT NULL,
    [Albmcf_Tableno] INT NULL,
    [Mf_Tableno] INT NULL,
    [Sb_Tableno] INT NULL,
    [Brok1_Tableno] INT NULL,
    [Brok2_Tableno] INT NULL,
    [Brok3_Tableno] INT NULL,
    [Brokernote] TINYINT NULL,
    [Other_Chrg] TINYINT NULL,
    [Brok_Scheme] TINYINT NULL,
    [Contcharge] TINYINT NULL,
    [Mincontamt] TINYINT NULL,
    [Addledgerbal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] INT NULL,
    [Inscont] CHAR(1) NULL,
    [Sertaxmethod] INT NULL,
    [Dummy6] VARCHAR(5) NULL,
    [Dummy7] VARCHAR(4) NULL,
    [Dummy8] VARCHAR(10) NULL,
    [Dummy9] VARCHAR(10) NULL,
    [Dummy10] VARCHAR(10) NULL,
    [Activefrom] DATETIME NULL,
    [Inactivefrom] DATETIME NULL,
    [Debitbalflag] INT NULL,
    [Intersettflag] INT NULL,
    [Logfld_Script_Name] VARCHAR(500) NULL,
    [Logfld_Session_Id] VARCHAR(30) NULL,
    [Logfld_Local_Addr] VARCHAR(20) NULL,
    [Logfld_Remote_Addr] VARCHAR(20) NULL,
    [Logfld_Remote_Host] VARCHAR(50) NULL,
    [Logfld_Statusname] VARCHAR(50) NULL,
    [Logfld_Username] VARCHAR(100) NULL,
    [Logfld_When_109] VARCHAR(30) NULL,
    [Logfld_Action] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT3
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT3]
(
    [cl_code] VARCHAR(10) NULL,
    [party_code] CHAR(10) NOT NULL,
    [exchange] CHAR(3) NOT NULL,
    [markettype] VARCHAR(15) NOT NULL,
    [margin] MONEY NOT NULL,
    [nooftimes] DECIMAL(2, 0) NOT NULL,
    [margin_recd] DECIMAL(18, 4) NULL,
    [MtoM] DECIMAL(18, 4) NULL,
    [pmarginrate] DECIMAL(5, 2) NULL,
    [MtoMdate] DATETIME NULL,
    [InitialMargin] DECIMAL(18, 4) NULL,
    [MainenancetMargin] DECIMAL(18, 4) NULL,
    [MarginExchange] DECIMAL(18, 4) NULL,
    [MarginBroker] DECIMAL(18, 4) NULL,
    [Dummy1] VARCHAR(4) NULL,
    [Dummy2] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.client3_29012016
-- --------------------------------------------------
CREATE TABLE [dbo].[client3_29012016]
(
    [cl_code] VARCHAR(10) NULL,
    [party_code] CHAR(10) NOT NULL,
    [exchange] CHAR(3) NOT NULL,
    [markettype] VARCHAR(15) NOT NULL,
    [margin] MONEY NOT NULL,
    [nooftimes] DECIMAL(2, 0) NOT NULL,
    [margin_recd] DECIMAL(18, 4) NULL,
    [MtoM] DECIMAL(18, 4) NULL,
    [pmarginrate] DECIMAL(5, 2) NULL,
    [MtoMdate] DATETIME NULL,
    [InitialMargin] DECIMAL(18, 4) NULL,
    [MainenancetMargin] DECIMAL(18, 4) NULL,
    [MarginExchange] DECIMAL(18, 4) NULL,
    [MarginBroker] DECIMAL(18, 4) NULL,
    [Dummy1] VARCHAR(4) NULL,
    [Dummy2] VARCHAR(4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT4
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT4]
(
    [Cl_code] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Instru] TINYINT NOT NULL,
    [BankID] VARCHAR(20) NULL,
    [Cltdpid] VARCHAR(20) NULL,
    [Depository] VARCHAR(7) NULL,
    [DefDp] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT5
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT5]
(
    [cl_code] VARCHAR(10) NOT NULL,
    [BirthDate] DATETIME NULL,
    [Sex] CHAR(1) NULL,
    [ActiveFrom] DATETIME NULL,
    [InteractMode] TINYINT NULL,
    [RepatriatAC] TINYINT NULL,
    [RepatriatBank] INT NULL,
    [RepatriatACNO] VARCHAR(30) NULL,
    [Introducer] VARCHAR(30) NULL,
    [Approver] VARCHAR(30) NULL,
    [KYCForm] TINYINT NULL,
    [BankCert] TINYINT NULL,
    [Passport] TINYINT NULL,
    [Passportdtl] VARCHAR(30) NULL,
    [VotersID] TINYINT NULL,
    [VotersIDdtl] VARCHAR(30) NULL,
    [ITReturn] TINYINT NULL,
    [ITReturndtl] VARCHAR(30) NULL,
    [Drivelicen] TINYINT NULL,
    [Drivelicendtl] VARCHAR(30) NULL,
    [Rationcard] TINYINT NULL,
    [Rationcarddtl] VARCHAR(30) NULL,
    [Corpdtlrecd] TINYINT NULL,
    [Corpdeed] TINYINT NULL,
    [Anualreport] TINYINT NULL,
    [Networthcert] TINYINT NULL,
    [InactiveFrom] DATETIME NULL,
    [P_Address1] VARCHAR(100) NULL,
    [P_Address2] VARCHAR(100) NULL,
    [P_Address3] VARCHAR(100) NULL,
    [P_City] VARCHAR(20) NULL,
    [P_State] VARCHAR(50) NULL,
    [P_Nation] VARCHAR(15) NULL,
    [P_Phone] VARCHAR(15) NULL,
    [P_Zip] VARCHAR(10) NULL,
    [AddEmailId] VARCHAR(230) NULL,
    [PassportDateOfIssue] DATETIME NULL,
    [PassportPlaceOfIssue] VARCHAR(30) NULL,
    [VoterIdDateOfIssue] DATETIME NULL,
    [VoterIdPlaceOfIssue] VARCHAR(30) NULL,
    [ITReturnDateOfFiling] DATETIME NULL,
    [LicenceNoDateOfIssue] DATETIME NULL,
    [LicenceNoPlaceOfIssue] VARCHAR(30) NULL,
    [RationCardDateOfIssue] DATETIME NULL,
    [RationCardPlaceOfIssue] VARCHAR(30) NULL,
    [Client_AGRE_DT] DATETIME NULL,
    [REGR_NO] VARCHAR(50) NULL,
    [REGR_PLACE] VARCHAR(50) NULL,
    [REGR_DATE] DATETIME NULL,
    [REGR_AUTH] VARCHAR(50) NULL,
    [INTROD_CLIENT_ID] VARCHAR(50) NULL,
    [INTROD_RELATION] VARCHAR(50) NULL,
    [ANY_OTHER_ACC] VARCHAR(50) NULL,
    [SETT_MODE] VARCHAR(50) NULL,
    [DEALING_WITH_OTHRER_TM] VARCHAR(50) NULL,
    [systumdate] DATETIME NULL,
    [PASSPORTEXPDATE] DATETIME NULL,
    [DRIVEEXPDATE] DATETIME NULL,
    [Director_name] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT6
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT6]
(
    [Cl_Code] CHAR(6) NOT NULL,
    [Exchange] CHAR(3) NOT NULL,
    [Tran_Cat] CHAR(3) NOT NULL,
    [Scrip_cat] NUMERIC(18, 4) NULL,
    [Party_code] CHAR(10) NOT NULL,
    [Table_no] SMALLINT NOT NULL,
    [Sub_TableNo] SMALLINT NOT NULL,
    [Margin] TINYINT NOT NULL,
    [Turnover_tax] TINYINT NOT NULL,
    [Sebi_Turn_tax] TINYINT NOT NULL,
    [Insurance_Chrg] TINYINT NOT NULL,
    [Service_chrg] TINYINT NOT NULL,
    [Std_rate] SMALLINT NOT NULL,
    [P_To_P] SMALLINT NOT NULL,
    [exposure_lim] NUMERIC(12, 2) NOT NULL,
    [demat_tableno] SMALLINT NOT NULL,
    [BankId] VARCHAR(15) NULL,
    [CltDpNo] VARCHAR(15) NULL,
    [Printf] TINYINT NOT NULL,
    [ALBMDelchrg] TINYINT NULL,
    [ALBMDelivery] TINYINT NULL,
    [AlbmCF_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [BrokerNote] TINYINT NULL,
    [Other_chrg] TINYINT NULL,
    [brok_scheme] TINYINT NULL,
    [Contcharge] TINYINT NULL,
    [MinContAmt] TINYINT NULL,
    [AddLedgerBal] TINYINT NULL,
    [Dummy1] TINYINT NULL,
    [Dummy2] TINYINT NULL,
    [InsCont] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENTBROK_SCHEME
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENTBROK_SCHEME]
(
    [SCHEME_ID] DECIMAL(18, 0) IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [TABLE_NO] VARCHAR(5) NOT NULL,
    [SCHEME_TYPE] VARCHAR(5) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NOT NULL,
    [TRADE_TYPE] VARCHAR(3) NOT NULL,
    [BROKSCHEME] VARCHAR(1) NOT NULL,
    [FROM_DATE] DATETIME NOT NULL,
    [TO_DATE] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENTSETTINGS
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENTSETTINGS]
(
    [EXCHANGE] CHAR(3) NULL,
    [SCIDENTITY] CHAR(3) NULL,
    [CL_CODE] VARCHAR(10) NULL,
    [TRAN_CAT] CHAR(3) NOT NULL,
    [SCRIP_CAT] NUMERIC(18, 4) NULL,
    [PARTY_CODE] CHAR(10) NOT NULL,
    [TABLE_NO] SMALLINT NOT NULL,
    [SUB_TABLENO] SMALLINT NOT NULL,
    [MARGIN] TINYINT NOT NULL,
    [TURNOVER_TAX] TINYINT NOT NULL,
    [SEBI_TURN_TAX] TINYINT NOT NULL,
    [INSURANCE_CHRG] TINYINT NOT NULL,
    [SERVICE_CHRG] TINYINT NOT NULL,
    [STD_RATE] SMALLINT NOT NULL,
    [P_TO_P] SMALLINT NOT NULL,
    [EXPOSURE_LIM] NUMERIC(12, 2) NOT NULL,
    [DEMAT_TABLENO] SMALLINT NOT NULL,
    [BANKID] VARCHAR(16) NULL,
    [CLTDPNO] VARCHAR(16) NULL,
    [PRINTF] TINYINT NOT NULL,
    [ALBMDELCHRG] TINYINT NULL,
    [ALBMDELIVERY] TINYINT NULL,
    [ALBMCF_TABLENO] SMALLINT NULL,
    [MF_TABLENO] SMALLINT NULL,
    [SB_TABLENO] SMALLINT NULL,
    [BROK1_TABLENO] SMALLINT NULL,
    [BROK2_TABLENO] SMALLINT NULL,
    [BROK3_TABLENO] SMALLINT NULL,
    [BROKERNOTE] TINYINT NULL,
    [OTHER_CHRG] TINYINT NULL,
    [BROK_SCHEME] TINYINT NULL,
    [ADDLEDGERBAL] TINYINT NULL,
    [DUMMY1] TINYINT NULL,
    [DUMMY2] TINYINT NULL,
    [INSCONT] CHAR(1) NULL,
    [SERTAXMETHOD] INT NULL,
    [DUMMY6] VARCHAR(4) NULL,
    [DUMMY7] VARCHAR(4) NULL,
    [DUMMY8] VARCHAR(4) NULL,
    [DUMMY9] VARCHAR(4) NULL,
    [DUMMY10] VARCHAR(4) NULL,
    [ROUNDSTYLE] SMALLINT NULL,
    [ROUNDSTYLE1] SMALLINT NULL,
    [DEBITBALANCE] TINYINT NULL,
    [INTERSETT] TINYINT NULL,
    [LATEST] CHAR(4) NULL,
    [AREA] VARCHAR(10) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [CL_TYPE] CHAR(3) NULL,
    [CL_STATUS] CHAR(3) NULL,
    [CLRATING] VARCHAR(10) NULL,
    [FAMILY] VARCHAR(50) NULL,
    [SUB_BROKER] VARCHAR(50) NULL,
    [TRADER] VARCHAR(20) NULL,
    [REGION] VARCHAR(50) NULL,
    [FROMDATE] DATETIME NULL,
    [TODATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENTSTATUS
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENTSTATUS]
(
    [CL_STATUS] CHAR(3) NOT NULL,
    [DESCRIPTION] CHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENTTAXES
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENTTAXES]
(
    [EXCHANGE] CHAR(10) NULL,
    [SCIDENTITY] CHAR(3) NULL,
    [PARTY_CODE] CHAR(10) NULL,
    [CL_TYPE] CHAR(5) NULL,
    [TRANS_CAT] CHAR(5) NULL,
    [INSURANCE_CHRG] MONEY NULL,
    [TURNOVER_TAX] MONEY NULL,
    [OTHER_CHRG] MONEY NULL,
    [SEBITURN_TAX] MONEY NULL,
    [BROKER_NOTE] MONEY NULL,
    [DEMAT_INSURE] MONEY NULL,
    [SERVICE_TAX] MONEY NULL,
    [TAX1] MONEY NULL,
    [TAX2] MONEY NULL,
    [TAX3] MONEY NULL,
    [TAX4] MONEY NULL,
    [TAX5] MONEY NULL,
    [TAX6] MONEY NULL,
    [TAX7] MONEY NULL,
    [TAX8] MONEY NULL,
    [TAX9] MONEY NULL,
    [TAX10] MONEY NULL,
    [LATEST] CHAR(10) NULL,
    [STATE] CHAR(15) NULL,
    [FROMDATE] DATETIME NULL,
    [TODATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENTTAXES_NEW
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENTTAXES_NEW]
(
    [EXCHANGE] CHAR(10) NULL,
    [SCIDENTITY] CHAR(3) NULL,
    [PARTY_CODE] CHAR(10) NULL,
    [CL_TYPE] CHAR(5) NULL,
    [TRANS_CAT] CHAR(5) NULL,
    [INSURANCE_CHRG] MONEY NULL,
    [TURNOVER_TAX] MONEY NULL,
    [OTHER_CHRG] MONEY NULL,
    [SEBITURN_TAX] MONEY NULL,
    [BROKER_NOTE] MONEY NULL,
    [DEMAT_INSURE] MONEY NULL,
    [SERVICE_TAX] MONEY NULL,
    [TAX1] MONEY NULL,
    [TAX2] MONEY NULL,
    [TAX3] MONEY NULL,
    [TAX4] MONEY NULL,
    [TAX5] MONEY NULL,
    [TAX6] MONEY NULL,
    [TAX7] MONEY NULL,
    [TAX8] MONEY NULL,
    [TAX9] MONEY NULL,
    [TAX10] MONEY NULL,
    [LATEST] CHAR(10) NULL,
    [STATE] CHAR(15) NULL,
    [FROMDATE] DATETIME NULL,
    [TODATE] DATETIME NULL,
    [ROUND_TO] INT NULL,
    [ROFIG] INT NULL,
    [ERRNUM] MONEY NULL,
    [NOZERO] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENTTYPE
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENTTYPE]
(
    [Cl_Type] CHAR(3) NOT NULL,
    [Description] CHAR(25) NULL,
    [prefix] CHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLOSING
-- --------------------------------------------------
CREATE TABLE [dbo].[CLOSING]
(
    [MARKET] VARCHAR(12) NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] CHAR(3) NULL,
    [CL_RATE] MONEY NULL,
    [SYSDATE] SMALLDATETIME NULL,
    [PRE_CL_RATE] MONEY NULL,
    [OPEN_RATE] MONEY NULL,
    [HI_RATE] MONEY NULL,
    [LOW_RATE] MONEY NULL,
    [TOTTRDQTY] INT NULL,
    [TOTTURNOVER] MONEY NULL,
    [YEARHIRATE] MONEY NULL,
    [YEARLOWRATE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_EXCH_IMPFILE_TYPE
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_EXCH_IMPFILE_TYPE]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [FILETYPE_CD] VARCHAR(12) NULL,
    [FILETYPE_DESC] VARCHAR(30) NULL,
    [VALID_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLS_TRADEFILE_TYPE
-- --------------------------------------------------
CREATE TABLE [dbo].[CLS_TRADEFILE_TYPE]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [FILETYPE_CD] VARCHAR(12) NULL,
    [FILETYPE_DESC] VARCHAR(30) NULL,
    [VALID_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ContGen
-- --------------------------------------------------
CREATE TABLE [dbo].[ContGen]
(
    [ContractNo] VARCHAR(10) NULL,
    [Start_Date] DATETIME NULL,
    [End_Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTLOGIN
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTLOGIN]
(
    [LOGINID] VARCHAR(30) NULL,
    [FROMPARTY] VARCHAR(10) NULL,
    [TOPARTY] VARCHAR(10) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] INT NULL,
    [QTY] INT NULL,
    [SELL_BUY] INT NULL,
    [SAUDA_DATE] SMALLDATETIME NULL,
    [CONTRACTNO] VARCHAR(10) NULL,
    [SPLITDATE] SMALLDATETIME NULL,
    [PRINTED] INT NULL,
    [TRADENO] VARCHAR(14) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_DATA]
(
    [CONTRACTNO] VARCHAR(14) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [ORDER_TIME] VARCHAR(10) NULL,
    [TRADE_NO] VARCHAR(15) NULL,
    [TRADETIME] VARCHAR(10) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [QTY] INT NULL,
    [PQTY] INT NULL,
    [SQTY] INT NULL,
    [PRICE] MONEY NULL,
    [PRATE] MONEY NULL,
    [SRATE] MONEY NULL,
    [PBROK] MONEY NULL,
    [SBROK] MONEY NULL,
    [PNETRATE] MONEY NULL,
    [SNETRATE] MONEY NULL,
    [NETAMOUNT] MONEY NULL,
    [AMOUNT] MONEY NULL,
    [PAMT] MONEY NULL,
    [SAMT] MONEY NULL,
    [SELL_BUY] INT NULL,
    [PSERVICE_TAX] MONEY NULL,
    [SSERVICE_TAX] MONEY NULL,
    [BROKER_CHRG] MONEY NULL,
    [TURN_TAX] MONEY NULL,
    [SEBI_TAX] MONEY NULL,
    [OTHER_CHRG] MONEY NULL,
    [INS_CHRG] MONEY NULL,
    [SERVICE_TAX] MONEY NULL,
    [NSERTAX] MONEY NULL,
    [BROKERAGE] MONEY NULL,
    [ORDFLG] INT NULL,
    [PRICEUNIT] VARCHAR(20) NULL,
    [QTY_UNIT] VARCHAR(10) NULL,
    [CONT_CL_RATE] MONEY NULL,
    [CONT_USER_ID] VARCHAR(20) NULL,
    [CONT_REMARK_ID] VARCHAR(1) NULL,
    [CONT_REMARK_DESC] VARCHAR(200) NULL,
    [CONT_TOT_MTOM] MONEY NULL,
    [CONT_MTOM] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_DATA_DET
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_DATA_DET]
(
    [CONTRACTNO] VARCHAR(14) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [ORDER_TIME] VARCHAR(10) NULL,
    [TRADE_NO] VARCHAR(15) NULL,
    [TRADETIME] VARCHAR(10) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [QTY] INT NULL,
    [PQTY] INT NULL,
    [SQTY] INT NULL,
    [PRICE] MONEY NULL,
    [PRATE] MONEY NULL,
    [SRATE] MONEY NULL,
    [PBROK] MONEY NULL,
    [SBROK] MONEY NULL,
    [PNETRATE] MONEY NULL,
    [SNETRATE] MONEY NULL,
    [NETAMOUNT] MONEY NULL,
    [AMOUNT] MONEY NULL,
    [PAMT] MONEY NULL,
    [SAMT] MONEY NULL,
    [SELL_BUY] INT NULL,
    [PSERVICE_TAX] MONEY NULL,
    [SSERVICE_TAX] MONEY NULL,
    [BROKER_CHRG] MONEY NULL,
    [TURN_TAX] MONEY NULL,
    [SEBI_TAX] MONEY NULL,
    [OTHER_CHRG] MONEY NULL,
    [INS_CHRG] MONEY NULL,
    [SERVICE_TAX] MONEY NULL,
    [NSERTAX] MONEY NULL,
    [BROKERAGE] MONEY NULL,
    [ORDFLG] INT NULL,
    [PRICEUNIT] VARCHAR(20) NULL,
    [QTY_UNIT] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_MASTER]
(
    [TRADE_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTYNAME] VARCHAR(100) NULL,
    [L_ADDRESS1] VARCHAR(40) NULL,
    [L_ADDRESS2] VARCHAR(40) NULL,
    [L_ADDRESS3] VARCHAR(40) NULL,
    [L_CITY] VARCHAR(40) NULL,
    [L_STATE] VARCHAR(50) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [SUBBROKER] VARCHAR(10) NULL,
    [TRADER] VARCHAR(20) NULL,
    [AREA] VARCHAR(20) NULL,
    [REGION] VARCHAR(20) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [OFF_PHONE1] VARCHAR(15) NULL,
    [OFF_PHONE2] VARCHAR(15) NULL,
    [PRINTF] INT NULL,
    [MAPIDID] VARCHAR(12) NULL,
    [UCC_CODE] VARCHAR(16) NULL,
    [SERVICE_CHRG] NUMERIC(36, 12) NULL,
    [BROKERNOTE] NUMERIC(36, 12) NULL,
    [TURNOVER_TAX] NUMERIC(36, 12) NULL,
    [SEBI_TURN_TAX] NUMERIC(36, 12) NULL,
    [OTHER_CHRG] NUMERIC(36, 12) NULL,
    [INSURANCE_CHRG] NUMERIC(36, 12) NULL,
    [SEBI_NO] VARCHAR(25) NULL,
    [PARTICIPANTCODE] VARCHAR(20) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [CL_STATUS] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_MST
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_MST]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [CONTRACT_ID] INT NULL,
    [TOCKEN_NO] INT NULL,
    [INST_TYPE] CHAR(6) NULL,
    [SYMBOL] CHAR(10) NULL,
    [FILLER1] CHAR(2) NULL,
    [FILLER2] CHAR(4) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(18, 4) NULL,
    [OPTION_TYPE] CHAR(2) NULL,
    [PRECISION] CHAR(1) NULL,
    [FILLER3] INT NULL,
    [FILLER4] CHAR(3) NULL,
    [PARTITION_ID] INT NULL,
    [FILLER5] INT NULL,
    [FILLER6] INT NULL,
    [FILLER7] INT NULL,
    [FILLER8] CHAR(2) NULL,
    [FILLER9] INT NULL,
    [FILLER10] INT NULL,
    [FILLER11] CHAR(2) NULL,
    [FILLER12] INT NULL,
    [FILLER13] INT NULL,
    [FILLER14] CHAR(2) NULL,
    [FILLER15] INT NULL,
    [FILLER16] INT NULL,
    [FILLER17] CHAR(2) NULL,
    [CONTRAT_STARTDATE] DATETIME NULL,
    [SETTLEMENT_DATE] DATETIME NULL,
    [PRODUCT_ID] INT NULL,
    [FILLER18] INT NULL,
    [MIN_LOT_SIZE] INT NULL,
    [LOT_SIZE] INT NULL,
    [TICK_SIZE] INT NULL,
    [FILLER19] INT NULL,
    [FILLER20] INT NULL,
    [FILLER21] INT NULL,
    [INSTRUMENT_ID] INT NULL,
    [FILLER22] INT NULL,
    [FILLER23] INT NULL,
    [FILLER24] INT NULL,
    [FILLER25] INT NULL,
    [FILLER26] INT NULL,
    [FILLER27] INT NULL,
    [FILLER28] INT NULL,
    [FILLER29] INT NULL,
    [FILLER30] INT NULL,
    [FILLER31] INT NULL,
    [FILLER32] INT NULL,
    [EXERCISE_START_DATE] DATETIME NULL,
    [EXERCISE_END_DATE] DATETIME NULL,
    [FILLER33] INT NULL,
    [QTY_MULTIPLIER] INT NULL,
    [FILLER34] CHAR(12) NULL,
    [INSTRUMENT_NAME] CHAR(26) NULL,
    [FILLER35] INT NULL,
    [FILLER36] INT NULL,
    [FILLER37] INT NULL,
    [UNDERLYING_MARKET] INT NULL,
    [FILLER38] CHAR(24) NULL,
    [CONTRACT_TYPE] VARCHAR(4) NULL,
    [FILLER39] CHAR(1) NULL,
    [FILLER40] CHAR(1) NULL,
    [FILLER41] CHAR(1) NULL,
    [FILLER42] CHAR(1) NULL,
    [FILLER43] CHAR(1) NULL,
    [FILLER44] CHAR(10) NULL,
    [FILLER45] CHAR(6) NULL,
    [BASE_PRICE] INT NULL,
    [DELETE_FLAG] CHAR(1) NULL,
    [UPDATED_BY] VARCHAR(20) NULL,
    [UPDATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CONTRACT_ROUNDING
-- --------------------------------------------------
CREATE TABLE [dbo].[CONTRACT_ROUNDING]
(
    [CR_SRNO] INT IDENTITY(1,1) NOT NULL,
    [CR_PARTY_CODE] VARCHAR(10) NOT NULL,
    [CR_MIN_CONTRACTAMT] NUMERIC(18, 4) NOT NULL,
    [CR_MAX_CONTRACTAMT] NUMERIC(18, 4) NOT NULL,
    [CR_DATE_FROM] DATETIME NOT NULL,
    [CR_DATE_TO] DATETIME NOT NULL,
    [CR_CREATEDBY] VARCHAR(20) NOT NULL,
    [CR_CREATEDON] DATETIME NOT NULL,
    [CR_MODIFIEDBY] VARCHAR(20) NOT NULL,
    [CR_MODIFIEDON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CUSTODIAN
-- --------------------------------------------------
CREATE TABLE [dbo].[CUSTODIAN]
(
    [CUSTODIANCODE] VARCHAR(15) NOT NULL,
    [SHORT_NAME] VARCHAR(21) NOT NULL,
    [LONG_NAME] VARCHAR(50) NULL,
    [ADDRESS1] VARCHAR(50) NULL,
    [ADDRESS2] VARCHAR(50) NULL,
    [CITY] VARCHAR(50) NULL,
    [STATE] VARCHAR(50) NULL,
    [NATION] VARCHAR(50) NULL,
    [ZIP] CHAR(10) NULL,
    [FAX] CHAR(10) NULL,
    [OFF_PHONE1] CHAR(10) NULL,
    [OFF_PHONE2] CHAR(10) NULL,
    [EMAIL] CHAR(50) NULL,
    [CLTDPNO] VARCHAR(16) NULL,
    [DPID] VARCHAR(16) NULL,
    [SEBIREGNO] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DBRR
-- --------------------------------------------------
CREATE TABLE [dbo].[DBRR]
(
    [Clientcode] VARCHAR(50) NULL,
    [Party_Code] VARCHAR(50) NULL,
    [ baddebt_recovery ] VARCHAR(50) NULL,
    [TYPE] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.DEALINGADDRESS
-- --------------------------------------------------
CREATE TABLE [dbo].[DEALINGADDRESS]
(
    [BRANCHNAME] VARCHAR(100) NULL,
    [ADDR1] VARCHAR(100) NULL,
    [ADDR2] VARCHAR(100) NULL,
    [ADDR3] VARCHAR(100) NULL,
    [PHONE1] VARCHAR(100) NULL,
    [PHONE2] VARCHAR(100) NULL,
    [FAX] VARCHAR(100) NULL,
    [EMAIL] VARCHAR(100) NULL,
    [COMPLEMAIL1] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Digital_File_Name
-- --------------------------------------------------
CREATE TABLE [dbo].[Digital_File_Name]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [D_Type] VARCHAR(8) NULL,
    [D_Name] VARCHAR(10) NULL,
    [D_Description] VARCHAR(30) NULL,
    [D_Value] VARCHAR(10) NULL,
    [D_Order] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.dpm34012016
-- --------------------------------------------------
CREATE TABLE [dbo].[dpm34012016]
(
    [1203320000000028~IN8418H01010~142 000~0 000~0 000~0 000~0 000~0 000~0 000~0 000~142 000~0 000~0 000~0 000~0 000~1~0~0~] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EMAIL_BLANK_CHECK
-- --------------------------------------------------
CREATE TABLE [dbo].[EMAIL_BLANK_CHECK]
(
    [Email_Blank_Flag] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EMAIL_LOGIN_USER
-- --------------------------------------------------
CREATE TABLE [dbo].[EMAIL_LOGIN_USER]
(
    [EMail_Login_Id] VARCHAR(10) NOT NULL,
    [EMail_Login_Name] VARCHAR(50) NOT NULL,
    [EMail_Login_Password] VARCHAR(10) NOT NULL,
    [EMail_Login_Status] CHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EMAIL_PARTYREPORT
-- --------------------------------------------------
CREATE TABLE [dbo].[EMAIL_PARTYREPORT]
(
    [EMail_Party_Code] CHAR(10) NOT NULL,
    [EMail_Report_Names] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EMAIL_REPORT_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[EMAIL_REPORT_LOG]
(
    [EMail_Login_Id] VARCHAR(10) NOT NULL,
    [EMail_Activity_Type] CHAR(1) NOT NULL,
    [EMail_Activity_Date] INT NOT NULL,
    [EMail_Activity_Time] INT NOT NULL,
    [EMail_From_Party] VARCHAR(10) NOT NULL,
    [EMail_Mail_Add] VARCHAR(100) NOT NULL,
    [EMail_Report_Name] VARCHAR(5000) NULL,
    [EMail_Report_Date] INT NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Email_Report_Process
-- --------------------------------------------------
CREATE TABLE [dbo].[Email_Report_Process]
(
    [Email_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Email_Report_Name] VARCHAR(50) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [EmailId] VARCHAR(100) NULL,
    [Email_Report_Path] VARCHAR(500) NULL,
    [Email_SubFolder] VARCHAR(100) NULL,
    [Email_File_Name] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.EMAIL_REPORT_SETTINGS
-- --------------------------------------------------
CREATE TABLE [dbo].[EMAIL_REPORT_SETTINGS]
(
    [email_report_name] VARCHAR(50) NOT NULL,
    [email_report_path] VARCHAR(256) NOT NULL,
    [email_report_subject] VARCHAR(256) NOT NULL,
    [email_report_cc] VARCHAR(256) NOT NULL,
    [email_report_body] VARCHAR(256) NOT NULL,
    [email_report_priority] INT NOT NULL,
    [email_report_parameter] VARCHAR(256) NOT NULL,
    [email_search_parameter] VARCHAR(256) NOT NULL,
    [email_out_file_prefix] VARCHAR(10) NOT NULL,
    [email_output_folder] VARCHAR(256) NOT NULL,
    [email_output_sub_folder] VARCHAR(100) NOT NULL,
    [email_dateformat] INT NOT NULL,
    [email_table_name] VARCHAR(200) NULL,
    [email_network_path] VARCHAR(256) NOT NULL,
    [email_report_from] VARCHAR(256) NOT NULL,
    [Email_Out_File_Suffix] VARCHAR(20) NULL,
    [Email_Out_File_SubFolderFlag] INT NULL,
    [Email_Out_File_SrNo_Part1] INT NULL,
    [Email_Out_File_SrNo_Part2] INT NULL,
    [Email_Out_File_SrNo_Type] VARCHAR(8) NULL,
    [Email_Out_File_Name] VARCHAR(50) NULL,
    [Email_Report_Desc] VARCHAR(30) NULL,
    [Email_Zip_File] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ERRORLOG
-- --------------------------------------------------
CREATE TABLE [dbo].[ERRORLOG]
(
    [ERRDATE] SMALLDATETIME NULL,
    [CNAME] VARCHAR(200) NULL,
    [MNAME] VARCHAR(200) NULL,
    [SNAME] VARCHAR(200) NULL,
    [ERRSTR] VARCHAR(300) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ExAlloc_NetPosition
-- --------------------------------------------------
CREATE TABLE [dbo].[ExAlloc_NetPosition]
(
    [Party_Code] VARCHAR(20) NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(15) NULL,
    [Expirydate] DATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Option_Type] VARCHAR(2) NULL,
    [Pqty] INT NULL,
    [Sqty] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FO_POS_DETAILS_DAS
-- --------------------------------------------------
CREATE TABLE [dbo].[FO_POS_DETAILS_DAS]
(
    [FOPDD_PARTY_CODE] VARCHAR(10) NOT NULL,
    [FOPDD_INST_TYPE] VARCHAR(6) NULL,
    [FOPDD_SYMBOL] VARCHAR(12) NULL,
    [FOPDD_STRIKE_PRICE] MONEY NOT NULL,
    [FOPDD_OPTION_TYPE] VARCHAR(2) NULL,
    [FOPDD_INTFLAG] VARCHAR(15) NULL,
    [FOPDD_EXPIRYDATE] DATETIME NULL,
    [FOPDD_SEC_NAME] VARCHAR(35) NULL,
    [FOPDD_OPENING_PQTY] INT NULL,
    [FOPDD_OPENING_SQTY] INT NULL,
    [FOPDD_TODAY_PQTY] INT NULL,
    [FOPDD_TODAY_SQTY] INT NULL,
    [FOPDD_EXERCISEDQTY] INT NULL,
    [FOPDD_ASSIGNEDQTY] INT NULL,
    [FOPDD_INS_PQTY] INT NULL,
    [FOPDD_INS_SQTY] INT NULL,
    [FOPDD_CLOSING_PQTY] INT NULL,
    [FOPDD_CLOSING_SQTY] INT NULL,
    [FOPDD_EXPQTY] INT NULL,
    [FOPDD_AUTOCORPQTY] INT NULL,
    [FOPDD_LONGVALUE] NUMERIC(36, 12) NOT NULL,
    [FOPDD_SHORTVALUE] NUMERIC(36, 12) NOT NULL,
    [FOPDD_CLOSINGPRICE] NUMERIC(36, 12) NOT NULL,
    [FOPDD_STLMNTPRICE] NUMERIC(36, 12) NOT NULL,
    [FOPDD_FLAG] VARCHAR(2) NULL,
    [FOPDD_SAUDA_DATE] DATETIME NOT NULL,
    [FOPDD_CREATED_BY] VARCHAR(10) NOT NULL,
    [FOPDD_CREATED_DT] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FO_TRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[FO_TRADE]
(
    [Column 0] VARCHAR(50) NULL,
    [Column 1] VARCHAR(50) NULL,
    [Column 2] VARCHAR(50) NULL,
    [Column 3] VARCHAR(50) NULL,
    [Column 4] VARCHAR(50) NULL,
    [Column 5] VARCHAR(50) NULL,
    [Column 6] VARCHAR(50) NULL,
    [Column 7] VARCHAR(50) NULL,
    [Column 8] VARCHAR(50) NULL,
    [Column 9] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FO_TRADE_DETAILS_DAS
-- --------------------------------------------------
CREATE TABLE [dbo].[FO_TRADE_DETAILS_DAS]
(
    [FOTDD_PARTY_CODE] VARCHAR(10) NOT NULL,
    [FOTDD_INST_TYPE] VARCHAR(6) NULL,
    [FOTDD_SYMBOL] VARCHAR(12) NULL,
    [FOTDD_STRIKE_PRICE] MONEY NOT NULL,
    [FOTDD_OPTION_TYPE] VARCHAR(2) NULL,
    [FOTDD_EXPIRY_DATE] DATETIME NULL,
    [FOTDD_SEC_NAME] VARCHAR(25) NOT NULL,
    [FOTDD_TRADEQTY] INT NULL,
    [FOTDD_VALUE] NUMERIC(36, 12) NOT NULL,
    [FOTDD_PRICE] NUMERIC(36, 12) NOT NULL,
    [FOTDD_PQTY] INT NULL,
    [FOTDD_SQTY] INT NULL,
    [FOTDD_PAMT] NUMERIC(36, 12) NOT NULL,
    [FOTDD_SAMT] NUMERIC(36, 12) NOT NULL,
    [FOTDD_NETRATE] NUMERIC(36, 12) NULL,
    [FOTDD_CFPPRICE] NUMERIC(36, 12) NOT NULL,
    [FOTDD_CFSPRICE] NUMERIC(36, 12) NOT NULL,
    [FOTDD_SETTPRICE] NUMERIC(36, 12) NOT NULL,
    [FOTDD_SAUDA_DATE] DATETIME NOT NULL,
    [FOTDD_PNETRATE] NUMERIC(36, 12) NOT NULL,
    [FOTDD_SNETRATE] NUMERIC(36, 12) NOT NULL,
    [FOTDD_CHARGES] NUMERIC(36, 12) NOT NULL,
    [FOTDD_BROKERAGE] NUMERIC(36, 12) NOT NULL,
    [FOTDD_SERVICE_TAX] NUMERIC(36, 12) NOT NULL,
    [FOTDD_BROKER_NOTE] NUMERIC(36, 12) NOT NULL,
    [FOTDD_TURN_TAX] NUMERIC(36, 12) NOT NULL,
    [FOTDD_SEBI_TAX] NUMERIC(36, 12) NOT NULL,
    [FOTDD_CONTRACTNO] VARCHAR(14) NOT NULL,
    [FOTDD_PCOMM] NUMERIC(36, 12) NOT NULL,
    [FOTDD_SCOMM] NUMERIC(36, 12) NOT NULL,
    [FOTDD_INS_CHRG] NUMERIC(36, 12) NOT NULL,
    [FOTDD_FLAG] VARCHAR(5) NULL,
    [FOTDD_O_C_FLAG] VARCHAR(5) NULL,
    [FOTDD_AUCTIONPART] VARCHAR(2) NULL,
    [FOTDD_CREATED_BY] VARCHAR(10) NOT NULL,
    [FOTDD_CREATED_DT] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOACCBILL
-- --------------------------------------------------
CREATE TABLE [dbo].[FOACCBILL]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] VARCHAR(2) NOT NULL,
    [SETT_NO] VARCHAR(12) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [BILLDATE] DATETIME NOT NULL,
    [START_DATE] DATETIME NULL,
    [END_DATE] DATETIME NULL,
    [PAYIN_DATE] DATETIME NULL,
    [PAYOUT_DATE] DATETIME NULL,
    [AMOUNT] MONEY NOT NULL,
    [EXPIRYFLAG] INT NULL,
    [RESERVED1] INT NULL,
    [RESERVED2] INT NULL,
    [RESERVED3] INT NULL,
    [BRANCHCD] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOACCBILL_ORG
-- --------------------------------------------------
CREATE TABLE [dbo].[FOACCBILL_ORG]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [BILL_NO] INT NULL,
    [SELL_BUY] VARCHAR(2) NOT NULL,
    [SETT_NO] VARCHAR(12) NOT NULL,
    [SETT_TYPE] VARCHAR(2) NOT NULL,
    [BILLDATE] SMALLDATETIME NOT NULL,
    [START_DATE] DATETIME NULL,
    [END_DATE] DATETIME NULL,
    [PAYIN_DATE] DATETIME NULL,
    [PAYOUT_DATE] DATETIME NULL,
    [AMOUNT] MONEY NOT NULL,
    [EXPIRYFLAG] INT NULL,
    [RESERVED1] INT NULL,
    [RESERVED2] INT NULL,
    [RESERVED3] INT NULL,
    [BRANCHCD] VARCHAR(10) NULL,
    [NARRATION] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOBILLNO
-- --------------------------------------------------
CREATE TABLE [dbo].[FOBILLNO]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [BILL_NO] INT NULL,
    [BILLDATE] SMALLDATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOBILLVALAN
-- --------------------------------------------------
CREATE TABLE [dbo].[FOBILLVALAN]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(50) NULL,
    [CLIENT_TYPE] VARCHAR(10) NULL,
    [BILLNO] INT NULL,
    [CONTRACTNO] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [MATURITYDATE] SMALLDATETIME NULL,
    [SAUDA_DATE] SMALLDATETIME NULL,
    [ISIN] VARCHAR(12) NULL,
    [PQTY] INT NULL,
    [SQTY] INT NULL,
    [PRATE] NUMERIC(36, 12) NOT NULL,
    [SRATE] NUMERIC(36, 12) NOT NULL,
    [PAMT] NUMERIC(36, 12) NOT NULL,
    [SAMT] NUMERIC(36, 12) NOT NULL,
    [PBROKAMT] NUMERIC(36, 12) NOT NULL,
    [SBROKAMT] NUMERIC(36, 12) NOT NULL,
    [PBILLAMT] NUMERIC(36, 12) NOT NULL,
    [SBILLAMT] NUMERIC(36, 12) NOT NULL,
    [CL_RATE] NUMERIC(36, 12) NOT NULL,
    [CL_CHRG] NUMERIC(36, 12) NOT NULL,
    [EXCL_CHRG] NUMERIC(36, 12) NOT NULL,
    [SERVICE_TAX] NUMERIC(36, 12) NOT NULL,
    [EXSER_TAX] NUMERIC(36, 12) NOT NULL,
    [INEXSERFLAG] SMALLINT NULL,
    [SEBI_TAX] NUMERIC(36, 12) NOT NULL,
    [TURN_TAX] NUMERIC(36, 12) NOT NULL,
    [BROKER_NOTE] NUMERIC(36, 12) NOT NULL,
    [INS_CHRG] NUMERIC(36, 12) NOT NULL,
    [OTHER_CHRG] NUMERIC(36, 12) NOT NULL,
    [TRADETYPE] VARCHAR(3) NULL,
    [PARTICIPANTCODE] VARCHAR(15) NULL,
    [TERMINAL_ID] VARCHAR(15) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [FAMILYNAME] VARCHAR(50) NULL,
    [TRADER] VARCHAR(20) NULL,
    [BRANCH_CODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [STATUSNAME] VARCHAR(15) NULL,
    [EXCHANGE] VARCHAR(5) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [MEMBERTYPE] VARCHAR(2) NULL,
    [COMPANYNAME] VARCHAR(100) NULL,
    [REGION] VARCHAR(20) NULL,
    [UPDATEDATE] VARCHAR(11) NULL,
    [EMAIL] VARCHAR(100) NULL,
    [SBU] VARCHAR(10) NULL,
    [RELMGR] VARCHAR(10) NULL,
    [GRP] VARCHAR(10) NULL,
    [SECTOR] VARCHAR(20) NULL,
    [CMCLOSING] NUMERIC(36, 12) NOT NULL,
    [TRACK] VARCHAR(1) NULL,
    [AREA] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOBILLVALAN_ORG
-- --------------------------------------------------
CREATE TABLE [dbo].[FOBILLVALAN_ORG]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(50) NULL,
    [CLIENT_TYPE] VARCHAR(10) NULL,
    [BILLNO] INT NULL,
    [CONTRACTNO] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [MATURITYDATE] SMALLDATETIME NULL,
    [SAUDA_DATE] SMALLDATETIME NULL,
    [ISIN] VARCHAR(12) NULL,
    [PQTY] INT NULL,
    [SQTY] INT NULL,
    [PRATE] NUMERIC(36, 12) NOT NULL,
    [SRATE] NUMERIC(36, 12) NOT NULL,
    [PAMT] NUMERIC(36, 12) NOT NULL,
    [SAMT] NUMERIC(36, 12) NOT NULL,
    [PBROKAMT] NUMERIC(36, 12) NOT NULL,
    [SBROKAMT] NUMERIC(36, 12) NOT NULL,
    [PBILLAMT] NUMERIC(36, 12) NOT NULL,
    [SBILLAMT] NUMERIC(36, 12) NOT NULL,
    [CL_RATE] NUMERIC(36, 12) NOT NULL,
    [CL_CHRG] NUMERIC(36, 12) NOT NULL,
    [EXCL_CHRG] NUMERIC(36, 12) NOT NULL,
    [SERVICE_TAX] NUMERIC(36, 12) NOT NULL,
    [EXSER_TAX] NUMERIC(36, 12) NOT NULL,
    [INEXSERFLAG] SMALLINT NULL,
    [SEBI_TAX] NUMERIC(36, 12) NOT NULL,
    [TURN_TAX] NUMERIC(36, 12) NOT NULL,
    [BROKER_NOTE] NUMERIC(36, 12) NOT NULL,
    [INS_CHRG] NUMERIC(36, 12) NOT NULL,
    [OTHER_CHRG] NUMERIC(36, 12) NOT NULL,
    [TRADETYPE] VARCHAR(3) NULL,
    [PARTICIPANTCODE] VARCHAR(15) NULL,
    [TERMINAL_ID] VARCHAR(15) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [FAMILYNAME] VARCHAR(50) NULL,
    [TRADER] VARCHAR(20) NULL,
    [BRANCH_CODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [STATUSNAME] VARCHAR(15) NULL,
    [EXCHANGE] VARCHAR(5) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [MEMBERTYPE] VARCHAR(2) NULL,
    [COMPANYNAME] VARCHAR(100) NULL,
    [REGION] VARCHAR(20) NULL,
    [UPDATEDATE] VARCHAR(11) NULL,
    [EMAIL] VARCHAR(100) NULL,
    [SBU] VARCHAR(10) NULL,
    [RELMGR] VARCHAR(10) NULL,
    [GRP] VARCHAR(10) NULL,
    [SECTOR] VARCHAR(20) NULL,
    [CMCLOSING] NUMERIC(36, 12) NOT NULL,
    [TRACK] VARCHAR(1) NULL,
    [AREA] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOBILLVALAN_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOBILLVALAN_TEMP]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTY_NAME] VARCHAR(50) NULL,
    [CLIENT_TYPE] VARCHAR(10) NULL,
    [BILLNO] VARCHAR(10) NULL,
    [CONTRACTNO] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [MATURITYDATE] SMALLDATETIME NULL,
    [SAUDA_DATE] SMALLDATETIME NULL,
    [ISIN] VARCHAR(12) NULL,
    [PQTY] INT NULL,
    [SQTY] INT NULL,
    [PRATE] NUMERIC(36, 12) NOT NULL,
    [SRATE] NUMERIC(36, 12) NOT NULL,
    [PAMT] NUMERIC(36, 12) NOT NULL,
    [SAMT] NUMERIC(36, 12) NOT NULL,
    [PBROKAMT] NUMERIC(36, 12) NOT NULL,
    [SBROKAMT] NUMERIC(36, 12) NOT NULL,
    [PBILLAMT] NUMERIC(36, 12) NOT NULL,
    [SBILLAMT] NUMERIC(36, 12) NOT NULL,
    [CL_RATE] NUMERIC(36, 12) NOT NULL,
    [CL_CHRG] NUMERIC(36, 12) NOT NULL,
    [EXCL_CHRG] NUMERIC(36, 12) NOT NULL,
    [SERVICE_TAX] NUMERIC(36, 12) NOT NULL,
    [EXSER_TAX] NUMERIC(36, 12) NOT NULL,
    [INEXSERFLAG] SMALLINT NULL,
    [SEBI_TAX] NUMERIC(36, 12) NOT NULL,
    [TURN_TAX] NUMERIC(36, 12) NOT NULL,
    [BROKER_NOTE] NUMERIC(36, 12) NOT NULL,
    [INS_CHRG] NUMERIC(36, 12) NOT NULL,
    [OTHER_CHRG] NUMERIC(36, 12) NOT NULL,
    [TRADETYPE] VARCHAR(3) NULL,
    [PARTICIPANTCODE] VARCHAR(15) NULL,
    [TERMINAL_ID] VARCHAR(15) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [FAMILYNAME] VARCHAR(50) NULL,
    [TRADER] VARCHAR(20) NULL,
    [BRANCH_CODE] VARCHAR(10) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [STATUSNAME] VARCHAR(15) NULL,
    [EXCHANGE] VARCHAR(5) NULL,
    [SEGMENT] VARCHAR(10) NULL,
    [MEMBERTYPE] VARCHAR(2) NULL,
    [COMPANYNAME] VARCHAR(100) NULL,
    [REGION] VARCHAR(10) NULL,
    [UPDATEDATE] VARCHAR(11) NULL,
    [EMAIL] VARCHAR(100) NULL,
    [SBU] VARCHAR(10) NULL,
    [RELMGR] VARCHAR(10) NULL,
    [GRP] VARCHAR(10) NULL,
    [SECTOR] VARCHAR(20) NULL,
    [CMCLOSING] NUMERIC(36, 12) NOT NULL,
    [TRACK] VARCHAR(1) NULL,
    [AREA] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOCLIENTBROKSCHEME
-- --------------------------------------------------
CREATE TABLE [dbo].[FOCLIENTBROKSCHEME]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [DATE_FROM] DATETIME NULL,
    [DATE_TO] DATETIME NULL,
    [FUT_BROKTABLE] INT NULL,
    [OPT_BROKTABLE] INT NULL,
    [FUT_EXP_BROKTABLE] INT NULL,
    [OPT_EXC_BROKTABLE] INT NULL,
    [COMM_DEL_BROKTABLE] INT NULL,
    [BROK_SCHEME] TINYINT NULL,
    [OPT_BROK_COMPUTEON] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOCLIENTTAXES
-- --------------------------------------------------
CREATE TABLE [dbo].[FOCLIENTTAXES]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [DATE_FROM] DATETIME NULL,
    [DATE_TO] DATETIME NULL,
    [FUT_INSURANCE_CHRG] DECIMAL(18, 5) NULL,
    [FUT_TURNOVER_TAX] DECIMAL(18, 5) NULL,
    [FUT_OTHER_CHRG] DECIMAL(18, 5) NULL,
    [FUT_SEBITURN_TAX] DECIMAL(18, 5) NULL,
    [FUT_BROKER_NOTE] DECIMAL(18, 5) NULL,
    [OPT_INSURANCE_CHRG] DECIMAL(18, 5) NULL,
    [OPT_TURNOVER_TAX] DECIMAL(18, 5) NULL,
    [OPT_OTHER_CHRG] DECIMAL(18, 5) NULL,
    [OPT_SEBITURN_TAX] DECIMAL(18, 5) NULL,
    [OPT_BROKER_NOTE] DECIMAL(18, 5) NULL,
    [ROUND_TO] DECIMAL(18, 0) NULL,
    [ROFIG] INT NULL,
    [ERRNUM] NUMERIC(18, 10) NULL,
    [NOZERO] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOCLOSING
-- --------------------------------------------------
CREATE TABLE [dbo].[FOCLOSING]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [TRADE_DATE] DATETIME NULL,
    [MARKET_TYPE] VARCHAR(6) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(18, 2) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [RESERVED] VARCHAR(2) NULL,
    [PRV_CL_RATE] NUMERIC(18, 2) NULL,
    [OPEN_PRICE] NUMERIC(18, 2) NULL,
    [HIGH_PRICE] NUMERIC(18, 2) NULL,
    [LOW_PRICE] NUMERIC(18, 2) NULL,
    [CL_RATE] NUMERIC(26, 12) NULL,
    [TOTAL_TRD_QTY] NUMERIC(18, 2) NULL,
    [TOTAL_TRD_VALUE] NUMERIC(18, 2) NULL,
    [OPEN_INTEREST] NUMERIC(18, 2) NULL,
    [CHANGE_INOPEN_INTEREST] NUMERIC(18, 2) NULL,
    [POPULATED_BY] VARCHAR(20) NULL,
    [POPULATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOCLOSING_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOCLOSING_IMP]
(
    [TRADE_DATE] DATETIME NULL,
    [MARKET_TYPE] VARCHAR(6) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(18, 2) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [RESERVED] VARCHAR(2) NULL,
    [PRV_CL_RATE] NUMERIC(18, 2) NULL,
    [OPEN_PRICE] NUMERIC(18, 2) NULL,
    [HIGH_PRICE] NUMERIC(18, 2) NULL,
    [LOW_PRICE] NUMERIC(18, 2) NULL,
    [CL_RATE] NUMERIC(26, 12) NULL,
    [TOTAL_TRD_QTY] NUMERIC(18, 2) NULL,
    [TOTAL_TRD_VALUE] NUMERIC(18, 2) NULL,
    [OPEN_INTEREST] NUMERIC(18, 2) NULL,
    [CHANGE_INOPEN_INTEREST] NUMERIC(18, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOCLOSING_MTM
-- --------------------------------------------------
CREATE TABLE [dbo].[FOCLOSING_MTM]
(
    [TRADE_DATE] DATETIME NULL,
    [SERIES_ID] VARCHAR(12) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(18, 2) NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [CL_RATE] NUMERIC(26, 12) NULL,
    [OPEN_INTEREST] NUMERIC(18, 2) NULL,
    [FILLER1] VARCHAR(50) NULL,
    [FILLER2] VARCHAR(50) NULL,
    [FILLER3] VARCHAR(50) NULL,
    [FILLER4] VARCHAR(50) NULL,
    [UPLOAD_ON] DATETIME NOT NULL,
    [UPLOAD_BY] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOCORPACTADJUSTMENT_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[FOCORPACTADJUSTMENT_LOG]
(
    [FILE_DATE] DATETIME NULL,
    [SAUDA_DATE] DATETIME NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [METHOD] VARCHAR(10) NULL,
    [ADJFACTORQTY] NUMERIC(18, 4) NULL,
    [ADJFACTORPRICE] NUMERIC(18, 4) NULL,
    [OLDLOTSIZE] INT NULL,
    [NEWLOTSIZE] INT NULL,
    [ROUNDING] INT NULL,
    [CREATEDBY] VARCHAR(20) NULL,
    [CREATEDON] DATETIME NULL,
    [NEWSYMBOL] VARCHAR(12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOERRORLOG
-- --------------------------------------------------
CREATE TABLE [dbo].[FOERRORLOG]
(
    [ERRDATE] SMALLDATETIME NULL,
    [CNAME] VARCHAR(200) NULL,
    [MNAME] VARCHAR(200) NULL,
    [SNAME] VARCHAR(200) NULL,
    [ERRSTR] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOERRTRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[FOERRTRADE]
(
    [TRADE_NO] VARCHAR(20) NOT NULL,
    [STATUS] VARCHAR(3) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SEC_NAME] VARCHAR(25) NULL,
    [BOOKTYPE] INT NULL,
    [BOOKTYPENAME] INT NULL,
    [MARKETTYPE] VARCHAR(2) NULL,
    [USER_ID] VARCHAR(15) NULL,
    [BRANCH_ID] VARCHAR(15) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [PRICE] NUMERIC(36, 12) NOT NULL,
    [PRO_CLI] INT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(50) NULL,
    [O_C_FLAG] VARCHAR(5) NULL,
    [C_U_FLAG] VARCHAR(7) NULL,
    [ACTIVITYTIME] DATETIME NULL,
    [LAST_MOD_TIME] DATETIME NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [OPP_BROKER_ID] VARCHAR(20) NULL,
    [SETTFLAG] INT NULL,
    [MEMBERCODE] VARCHAR(10) NULL,
    [TMPARTYCODE] VARCHAR(10) NULL,
    [RESERVED1] MONEY NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(16) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOEXALLOCSETTLEMENT
-- --------------------------------------------------
CREATE TABLE [dbo].[FOEXALLOCSETTLEMENT]
(
    [CONTRACTNO] VARCHAR(14) NULL,
    [BILLNO] VARCHAR(10) NULL,
    [TRADE_NO] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [SEC_NAME] VARCHAR(25) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [USER_ID] VARCHAR(15) NULL,
    [PRO_CLI] INT NULL,
    [O_C_FLAG] VARCHAR(5) NULL,
    [C_U_FLAG] VARCHAR(7) NULL,
    [TRADEQTY] INT NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [MARKETTYPE] VARCHAR(2) NULL,
    [SERIES] CHAR(2) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PRICE] NUMERIC(36, 12) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [TABLE_NO] VARCHAR(4) NULL,
    [LINE_NO] NUMERIC(3, 0) NULL,
    [VAL_PERC] CHAR(1) NULL,
    [NORMAL] NUMERIC(36, 12) NOT NULL,
    [DAY_PUC] NUMERIC(36, 12) NOT NULL,
    [DAY_SALES] NUMERIC(36, 12) NOT NULL,
    [SETT_PURCH] NUMERIC(36, 12) NOT NULL,
    [SETT_SALES] NUMERIC(36, 12) NOT NULL,
    [SELL_BUY] INT NOT NULL,
    [SETTFLAG] INT NULL,
    [BROKAPPLIED] NUMERIC(36, 12) NOT NULL,
    [NETRATE] NUMERIC(36, 12) NULL,
    [AMOUNT] NUMERIC(36, 12) NOT NULL,
    [INS_CHRG] NUMERIC(36, 12) NOT NULL,
    [TURN_TAX] NUMERIC(36, 12) NOT NULL,
    [OTHER_CHRG] NUMERIC(36, 12) NOT NULL,
    [SEBI_TAX] NUMERIC(36, 12) NOT NULL,
    [BROKER_CHRG] NUMERIC(36, 12) NOT NULL,
    [SERVICE_TAX] NUMERIC(36, 12) NOT NULL,
    [TRADE_AMOUNT] NUMERIC(36, 12) NOT NULL,
    [BILLFLAG] INT NULL,
    [SETT_NO] VARCHAR(7) NULL,
    [NBROKAPP] NUMERIC(36, 12) NOT NULL,
    [NSERTAX] NUMERIC(36, 12) NOT NULL,
    [N_NETRATE] NUMERIC(36, 12) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [CL_RATE] NUMERIC(36, 12) NOT NULL,
    [PARTICIPANTCODE] VARCHAR(15) NULL,
    [STATUS] VARCHAR(2) NULL,
    [CPID] INT NULL,
    [INSTRUMENT] INT NULL,
    [BOOKTYPE] INT NULL,
    [BRANCH_ID] INT NULL,
    [TMARK] INT NULL,
    [SCHEME] INT NULL,
    [DUMMY1] INT NULL,
    [DUMMY2] INT NULL,
    [RESERVED1] INT NULL,
    [RESERVED2] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOEXALLOCTRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[FOEXALLOCTRADE]
(
    [FOEATRD_TRADE_NO] VARCHAR(20) NULL,
    [FOEATRD_STATUS] VARCHAR(2) NULL,
    [FOEATRD_INST_TYPE] VARCHAR(6) NULL,
    [FOEATRD_SYMBOL] VARCHAR(12) NULL,
    [FOEATRD_EXPIRYDATE] SMALLDATETIME NULL,
    [FOEATRD_STRIKE_PRICE] MONEY NOT NULL,
    [FOEATRD_OPTION_TYPE] VARCHAR(2) NULL,
    [FOEATRD_SEC_NAME] VARCHAR(50) NULL,
    [FOEATRD_MARKETTYPE] VARCHAR(2) NULL,
    [FOEATRD_USER_ID] VARCHAR(15) NULL,
    [FOEATRD_SELL_BUY] INT NULL,
    [FOEATRD_TRADEQTY] INT NULL,
    [FOEATRD_PRICE] NUMERIC(36, 12) NOT NULL,
    [FOEATRD_PRO_CLI] INT NULL,
    [FOEATRD_PARTY_CODE] VARCHAR(10) NULL,
    [FOEATRD_O_C_FLAG] VARCHAR(5) NULL,
    [FOEATRD_C_U_FLAG] VARCHAR(7) NULL,
    [FOEATRD_ACTIVITYTIME] DATETIME NULL,
    [FOEATRD_ORDER_NO] VARCHAR(20) NULL,
    [FOEATRD_SETTFLAG] INT NULL,
    [FOEATRD_CL_RATE] NUMERIC(36, 12) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOEXALLOCTRADEHIST
-- --------------------------------------------------
CREATE TABLE [dbo].[FOEXALLOCTRADEHIST]
(
    [FOEATRD_TRADE_NO] VARCHAR(20) NULL,
    [FOEATRD_STATUS] VARCHAR(2) NULL,
    [FOEATRD_INST_TYPE] VARCHAR(6) NULL,
    [FOEATRD_SYMBOL] VARCHAR(12) NULL,
    [FOEATRD_EXPIRYDATE] SMALLDATETIME NULL,
    [FOEATRD_STRIKE_PRICE] MONEY NOT NULL,
    [FOEATRD_OPTION_TYPE] VARCHAR(2) NULL,
    [FOEATRD_SEC_NAME] VARCHAR(50) NULL,
    [FOEATRD_MARKETTYPE] VARCHAR(2) NULL,
    [FOEATRD_USER_ID] VARCHAR(15) NULL,
    [FOEATRD_SELL_BUY] INT NULL,
    [FOEATRD_TRADEQTY] INT NULL,
    [FOEATRD_PRICE] NUMERIC(36, 12) NOT NULL,
    [FOEATRD_PRO_CLI] INT NULL,
    [FOEATRD_PARTY_CODE] VARCHAR(10) NULL,
    [FOEATRD_O_C_FLAG] VARCHAR(5) NULL,
    [FOEATRD_C_U_FLAG] VARCHAR(7) NULL,
    [FOEATRD_ACTIVITYTIME] DATETIME NULL,
    [FOEATRD_ORDER_NO] VARCHAR(20) NULL,
    [FOEATRD_SETTFLAG] INT NULL,
    [FOEATRD_CL_RATE] NUMERIC(36, 12) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOEXERCISEALLOCATION
-- --------------------------------------------------
CREATE TABLE [dbo].[FOEXERCISEALLOCATION]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [FOEA_POSITION_DATE] DATETIME NULL,
    [FOEA_CM_CODE] VARCHAR(12) NULL,
    [FOEA_TM_CODE] VARCHAR(12) NULL,
    [FOEA_ACC_TYPE] VARCHAR(2) NULL,
    [FOEA_PARTY_CODE] VARCHAR(16) NULL,
    [FOEA_INST_TYPE] VARCHAR(6) NULL,
    [FOEA_SYMBOL] VARCHAR(12) NULL,
    [FOEA_EXPIRYDATE] DATETIME NULL,
    [FOEA_STRIKE_PRICE] MONEY NULL,
    [FOEA_OPTION_TYPE] VARCHAR(2) NULL,
    [FOEA_BROUGHT_FORWARD_BUY_QUANTITY] INT NULL,
    [FOEA_BROUGHT_FORWARD_BUY_VALUE] MONEY NULL,
    [FOEA_BROUGHT_FORWARD_SELL_QUANTITY] INT NULL,
    [FOEA_BROUGHT_FORWARD_SELL_VALUE] MONEY NULL,
    [FOEA_DAY_BUY_QUANTITY] INT NULL,
    [FOEA_DAY_BUY_VALUE] MONEY NULL,
    [FOEA_DAY_SELL_QUANTITY] INT NULL,
    [FOEA_DAY_SELL_VALUE] MONEY NULL,
    [FOEA_PREEXALL_LONGQTY] INT NULL,
    [FOEA_PREEXALL_SHORTQTY] INT NULL,
    [FOEA_PREEXALL_LONGVALUE] MONEY NULL,
    [FOEA_PREEXALL_SHORTVALUE] MONEY NULL,
    [FOEA_EXERCISE_QTY] INT NULL,
    [FOEA_ALLOC_QTY] INT NULL,
    [FOEA_POSTEXALL_LONGQTY] INT NULL,
    [FOEA_POSTEXALL_SHORTQTY] INT NULL,
    [FOEA_POSTEXALL_LONGVALUE] MONEY NULL,
    [FOEA_POSTEXALL_SHORTVALUE] MONEY NULL,
    [FOEA_SETTLEMENTPRICE] MONEY NULL,
    [FOEA_NETPREMIUM] MONEY NULL,
    [FOEA_DAILY_MTM_SETTLEMENT_VALUE] MONEY NULL,
    [FOEA_FUTURES_FINAL_SETTLEMENT_VALUE] MONEY NULL,
    [FOEA_EXERCISED_ASSIGNED_VALUE] MONEY NULL,
    [FOEA_POPULATED_BY] VARCHAR(20) NULL,
    [FOEA_POPULATES_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOEXERCISEALLOCATION_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOEXERCISEALLOCATION_IMP]
(
    [FOEA_POSITION_DATE] DATETIME NULL,
    [FOEA_CM_CODE] VARCHAR(12) NULL,
    [FOEA_TM_CODE] VARCHAR(12) NULL,
    [FOEA_ACC_TYPE] VARCHAR(2) NULL,
    [FOEA_PARTY_CODE] VARCHAR(16) NULL,
    [FOEA_INST_TYPE] VARCHAR(6) NULL,
    [FOEA_SYMBOL] VARCHAR(12) NULL,
    [FOEA_EXPIRYDATE] DATETIME NULL,
    [FOEA_STRIKE_PRICE] MONEY NULL,
    [FOEA_OPTION_TYPE] VARCHAR(2) NULL,
    [FOEA_BROUGHT_FORWARD_BUY_QUANTITY] INT NULL,
    [FOEA_BROUGHT_FORWARD_BUY_VALUE] MONEY NULL,
    [FOEA_BROUGHT_FORWARD_SELL_QUANTITY] INT NULL,
    [FOEA_BROUGHT_FORWARD_SELL_VALUE] MONEY NULL,
    [FOEA_DAY_BUY_QUANTITY] INT NULL,
    [FOEA_DAY_BUY_VALUE] MONEY NULL,
    [FOEA_DAY_SELL_QUANTITY] INT NULL,
    [FOEA_DAY_SELL_VALUE] MONEY NULL,
    [FOEA_PREEXALL_LONGQTY] INT NULL,
    [FOEA_PREEXALL_SHORTQTY] INT NULL,
    [FOEA_PREEXALL_LONGVALUE] MONEY NULL,
    [FOEA_PREEXALL_SHORTVALUE] MONEY NULL,
    [FOEA_EXERCISE_QTY] INT NULL,
    [FOEA_ALLOC_QTY] INT NULL,
    [FOEA_POSTEXALL_LONGQTY] INT NULL,
    [FOEA_POSTEXALL_SHORTQTY] INT NULL,
    [FOEA_POSTEXALL_LONGVALUE] MONEY NULL,
    [FOEA_POSTEXALL_SHORTVALUE] MONEY NULL,
    [FOEA_SETTLEMENTPRICE] MONEY NULL,
    [FOEA_NETPREMIUM] MONEY NULL,
    [FOEA_DAILY_MTM_SETTLEMENT_VALUE] MONEY NULL,
    [FOEA_FUTURES_FINAL_SETTLEMENT_VALUE] MONEY NULL,
    [FOEA_EXERCISED_ASSIGNED_VALUE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOEXPIRYBACKUP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOEXPIRYBACKUP]
(
    [SRNO] INT NULL,
    [CONTRACTNO] VARCHAR(14) NULL,
    [BILLNO] INT NULL,
    [TRADE_NO] VARCHAR(10) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [SEC_NAME] VARCHAR(25) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [USER_ID] VARCHAR(15) NULL,
    [PRO_CLI] INT NULL,
    [O_C_FLAG] VARCHAR(5) NULL,
    [C_U_FLAG] VARCHAR(7) NULL,
    [TRADEQTY] INT NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [MARKETTYPE] VARCHAR(2) NULL,
    [SERIES] CHAR(2) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PRICE] NUMERIC(36, 12) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [TABLE_NO] VARCHAR(4) NULL,
    [LINE_NO] NUMERIC(3, 0) NULL,
    [VAL_PERC] CHAR(1) NULL,
    [NORMAL] NUMERIC(36, 12) NULL,
    [DAY_PUC] NUMERIC(36, 12) NULL,
    [DAY_SALES] NUMERIC(36, 12) NULL,
    [SETT_PURCH] NUMERIC(36, 12) NULL,
    [SETT_SALES] NUMERIC(36, 12) NULL,
    [SELL_BUY] INT NULL,
    [SETTFLAG] INT NULL,
    [BROKAPPLIED] NUMERIC(36, 12) NULL,
    [NETRATE] NUMERIC(36, 12) NULL,
    [AMOUNT] NUMERIC(36, 12) NULL,
    [INS_CHRG] NUMERIC(36, 12) NULL,
    [TURN_TAX] NUMERIC(36, 12) NULL,
    [OTHER_CHRG] NUMERIC(36, 12) NULL,
    [SEBI_TAX] NUMERIC(36, 12) NULL,
    [BROKER_CHRG] NUMERIC(36, 12) NULL,
    [SERVICE_TAX] NUMERIC(36, 12) NULL,
    [TRADE_AMOUNT] NUMERIC(36, 12) NULL,
    [BILLFLAG] INT NULL,
    [SETT_NO] VARCHAR(12) NULL,
    [NBROKAPP] NUMERIC(36, 12) NULL,
    [NSERTAX] NUMERIC(36, 12) NULL,
    [N_NETRATE] NUMERIC(36, 12) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [CL_RATE] NUMERIC(36, 12) NULL,
    [PARTICIPANTCODE] VARCHAR(15) NULL,
    [STATUS] VARCHAR(3) NULL,
    [CPID] INT NULL,
    [INSTRUMENT] NUMERIC(18, 4) NULL,
    [BOOKTYPE] NUMERIC(18, 4) NULL,
    [BRANCH_ID] VARCHAR(15) NULL,
    [TMARK] VARCHAR(10) NULL,
    [SCHEME] INT NULL,
    [DUMMY1] INT NULL,
    [DUMMY2] NUMERIC(36, 12) NULL,
    [RESERVED1] INT NULL,
    [RESERVED2] INT NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOEXPIRYSETTLEMENT
-- --------------------------------------------------
CREATE TABLE [dbo].[FOEXPIRYSETTLEMENT]
(
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [BILLNO] VARCHAR(10) NULL,
    [TRADE_NO] VARCHAR(15) NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [SEC_NAME] VARCHAR(25) NOT NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [USER_ID] VARCHAR(15) NULL,
    [PRO_CLI] INT NULL,
    [O_C_FLAG] VARCHAR(5) NULL,
    [C_U_FLAG] VARCHAR(7) NULL,
    [TRADEQTY] INT NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [MARKETTYPE] VARCHAR(2) NULL,
    [SERIES] CHAR(2) NOT NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PRICE] NUMERIC(36, 12) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [TABLE_NO] VARCHAR(4) NOT NULL,
    [LINE_NO] DECIMAL(3, 0) NOT NULL,
    [VAL_PERC] CHAR(1) NULL,
    [NORMAL] NUMERIC(36, 12) NOT NULL,
    [DAY_PUC] NUMERIC(36, 12) NOT NULL,
    [DAY_SALES] NUMERIC(36, 12) NOT NULL,
    [SETT_PURCH] NUMERIC(36, 12) NOT NULL,
    [SETT_SALES] NUMERIC(36, 12) NOT NULL,
    [SELL_BUY] INT NOT NULL,
    [SETTFLAG] INT NULL,
    [BROKAPPLIED] NUMERIC(36, 12) NOT NULL,
    [NETRATE] DECIMAL(15, 7) NULL,
    [AMOUNT] NUMERIC(36, 12) NOT NULL,
    [INS_CHRG] NUMERIC(36, 12) NOT NULL,
    [TURN_TAX] NUMERIC(36, 12) NOT NULL,
    [OTHER_CHRG] NUMERIC(36, 12) NOT NULL,
    [SEBI_TAX] NUMERIC(36, 12) NOT NULL,
    [BROKER_CHRG] NUMERIC(36, 12) NOT NULL,
    [SERVICE_TAX] NUMERIC(36, 12) NOT NULL,
    [TRADE_AMOUNT] NUMERIC(36, 12) NOT NULL,
    [BILLFLAG] INT NULL,
    [SETT_NO] VARCHAR(12) NULL,
    [NBROKAPP] NUMERIC(36, 12) NOT NULL,
    [NSERTAX] NUMERIC(36, 12) NOT NULL,
    [N_NETRATE] DECIMAL(15, 7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [CL_RATE] NUMERIC(36, 12) NOT NULL,
    [PARTICIPANTCODE] VARCHAR(15) NULL,
    [STATUS] VARCHAR(3) NULL,
    [CPID] INT NULL,
    [INSTRUMENT] INT NULL,
    [BOOKTYPE] VARCHAR(5) NULL,
    [BRANCH_ID] VARCHAR(15) NULL,
    [TMARK] VARCHAR(10) NULL,
    [SCHEME] INT NULL,
    [DUMMY1] INT NULL,
    [DUMMY2] NUMERIC(36, 12) NOT NULL,
    [RESERVED1] INT NULL,
    [RESERVED2] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOFTTRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[FOFTTRADE]
(
    [TRADE_NO] VARCHAR(10) NOT NULL,
    [STATUS] VARCHAR(3) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SEC_NAME] VARCHAR(25) NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [BOOKTYPENAME] VARCHAR(3) NULL,
    [MARKETTYPE] VARCHAR(2) NULL,
    [USER_ID] VARCHAR(15) NULL,
    [BRANCH_ID] VARCHAR(20) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] NUMERIC(36, 0) NULL,
    [PRICE] NUMERIC(36, 12) NULL,
    [PRO_CLI] INT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(50) NULL,
    [O_C_FLAG] VARCHAR(5) NULL,
    [C_U_FLAG] VARCHAR(7) NULL,
    [ACTIVITYTIME] DATETIME NULL,
    [LAST_MOD_TIME] DATETIME NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [OPP_BROKER_ID] VARCHAR(8) NULL,
    [SETTFLAG] INT NULL,
    [MEMBERCODE] VARCHAR(10) NULL,
    [TMPARTYCODE] VARCHAR(10) NULL,
    [RESERVED1] NUMERIC(36, 12) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(10) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOFTTRADE_3_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOFTTRADE_3_IMP]
(
    [TRADE_NO] VARCHAR(20) NULL,
    [TRADEDATE] DATETIME NULL,
    [ACTIVITYTYPE] VARCHAR(2) NULL,
    [MARKETTYPE] VARCHAR(2) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [C_U_FLAG] VARCHAR(7) NULL,
    [B_BROKERCODE] VARCHAR(10) NULL,
    [S_BROKERCODE] VARCHAR(10) NULL,
    [PRICE] NUMERIC(36, 12) NULL,
    [ACTIVITYTIME] DATETIME NULL,
    [TRADEVOLUME] NUMERIC(36, 12) NULL,
    [TOKEN_NO] VARCHAR(50) NULL,
    [BRANCH_ID] VARCHAR(16) NULL,
    [B_CMCODE] VARCHAR(10) NULL,
    [S_CMCODE] VARCHAR(10) NULL,
    [SELL_BRANCH] VARCHAR(20) NULL,
    [B_PARTICIPANTCODE] VARCHAR(50) NULL,
    [B_CONFIRMATION] CHAR(2) NULL,
    [S_PARTICIPANTCODE] VARCHAR(50) NULL,
    [S_CONFIRMATION] CHAR(2) NULL,
    [B_O_C_FLAG] VARCHAR(5) NULL,
    [S_O_C_FLAG] VARCHAR(5) NULL,
    [B_OLD_PARTICIPANTCODE] VARCHAR(50) NULL,
    [B_OLD_CMCODE] VARCHAR(10) NULL,
    [S_OLD_PARTICIPANTCODE] VARCHAR(50) NULL,
    [S_OLD_CMCODE] VARCHAR(10) NULL,
    [B_TRADER] VARCHAR(12) NULL,
    [S_TRADER] VARCHAR(12) NULL,
    [B_ORDER_NO] VARCHAR(20) NULL,
    [S_ORDER_NO] VARCHAR(20) NULL,
    [B_PARTY_CODE] VARCHAR(20) NULL,
    [S_PARTY_CODE] VARCHAR(20) NULL,
    [B_REMARK] VARCHAR(100) NULL,
    [S_REMARK] VARCHAR(100) NULL,
    [B_TRADEQTY] VARCHAR(5) NULL,
    [S_TRADEQTY] VARCHAR(5) NULL,
    [B_PRO_CLI] VARCHAR(10) NULL,
    [S_PRO_CLI] VARCHAR(10) NULL,
    [CONTROLFLAG] VARCHAR(2) NULL,
    [ORDERTIME] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOGLOBALS
-- --------------------------------------------------
CREATE TABLE [dbo].[FOGLOBALS]
(
    [Year] VARCHAR(4) NOT NULL,
    [Exchange] VARCHAR(3) NOT NULL,
    [Service_Tax] MONEY NULL,
    [Service_Tax_Ac] VARCHAR(30) NULL,
    [Turnover_Ac] SMALLINT NULL,
    [Sebi_Turn_Ac] SMALLINT NULL,
    [Broker_Note_Ac] SMALLINT NULL,
    [Other_Chrg_Ac] SMALLINT NULL,
    [Exchange_Gl_Ac] VARCHAR(30) NULL,
    [Year_Start_Dt] DATETIME NOT NULL,
    [Year_End_Dt] DATETIME NOT NULL,
    [Cess_Tax] NUMERIC(10, 9) NULL,
    [Trdbuytrans] NUMERIC(18, 4) NULL,
    [Trdselltrans] NUMERIC(18, 4) NULL,
    [Insurance_Chrg_Ac] SMALLINT NULL,
    [EXPIRY_POSTING] INT NULL,
    [EDUCESS_TAX] NUMERIC(18, 4) NULL,
    [OptTrdSellTrans] NUMERIC(18, 4) NULL,
    [OptDelSellTrans] NUMERIC(18, 4) NULL,
    [STT_On] VARCHAR(7) NULL,
    [SBCCHARGE] NUMERIC(18, 4) NULL,
    [KRISHICHARGE] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGIN_PENALTY
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGIN_PENALTY]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [MARGIN_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SHORTAGE] MONEY NULL,
    [PENALTY_PERC] NUMERIC(12, 6) NULL,
    [PENALTY_AMT] MONEY NULL,
    [DAYS_3_COUNT] INT NULL,
    [MONTH_5_COUNT] INT NULL,
    [LEDGER_POST_FLAG] INT NULL,
    [UPDATED_BY] VARCHAR(20) NULL,
    [UPDATED_ON] DATETIME NULL,
    [SERVICE_TAX] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGIN_PENALTY_MST
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGIN_PENALTY_MST]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [FROM_DATE] DATETIME NULL,
    [TO_DATE] DATETIME NULL,
    [SHORTAGE_VALUE_FROM] MONEY NULL,
    [SHORTAGE_VALUE_TO] MONEY NULL,
    [SHORTAGE_PERC] NUMERIC(12, 6) NULL,
    [DAYS_3_PERC] NUMERIC(12, 6) NULL,
    [MONTH_5_PERC] NUMERIC(12, 6) NULL,
    [COMPUTATION_ON] INT NULL,
    [COMPUTATION_ON_DESC] VARCHAR(100) NULL,
    [CREATED_BY] VARCHAR(20) NULL,
    [CREATED_ON] DATETIME NULL,
    [MODIFY_BY] VARCHAR(20) NULL,
    [MODIFY_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGIN_PENALTY_POST_STAT
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGIN_PENALTY_POST_STAT]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [MARGIN_DATE] DATETIME NULL,
    [POST_FLAG] INT NULL,
    [LEDGER_VNO] VARCHAR(12) NULL,
    [LEDGER_VDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGIN_PENALTY_POST_STAT_DETAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGIN_PENALTY_POST_STAT_DETAIL]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [MARGIN_DATE] DATETIME NULL,
    [POST_FLAG] INT NULL,
    [LEDGER_VNO] VARCHAR(12) NULL,
    [LEDGER_VDT] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGIN_REPORT_STAT
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGIN_REPORT_STAT]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [MARGIN_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [SPAN_MARGIN] MONEY NULL,
    [EXTREME_LOSS_MARGIN] MONEY NULL,
    [NET_PREMIUM] MONEY NULL,
    [MTM] MONEY NULL,
    [FINALDAY_MTM] MONEY NULL,
    [TOTAL_MARGIN] MONEY NULL,
    [CLIENT_TYPE] VARCHAR(2) NULL,
    [MRG_UPLOADED_ON] DATETIME NULL,
    [REPORTED_MARGIN] MONEY NULL,
    [SHORTAGE] MONEY NULL,
    [PENALTY_CODE] VARCHAR(1) NULL,
    [PENALTY_AMT] MONEY NULL,
    [UPLOADED_BY] VARCHAR(20) NULL,
    [UPLOADED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGIN_REPORT_STAT_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGIN_REPORT_STAT_IMP]
(
    [MARGIN_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [SPAN_MARGIN] MONEY NULL,
    [EXTREME_LOSS_MARGIN] MONEY NULL,
    [NET_PREMIUM] MONEY NULL,
    [MTM] MONEY NULL,
    [FINALDAY_MTM] MONEY NULL,
    [TOTAL_MARGIN] MONEY NULL,
    [CLIENT_TYPE] VARCHAR(2) NULL,
    [MRG_UPLOADED_ON] DATETIME NULL,
    [REPORTED_MARGIN] MONEY NULL,
    [SHORTAGE] MONEY NULL,
    [PENALTY_CODE] VARCHAR(1) NULL,
    [PENALTY_AMT] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGINNEW
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGINNEW]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [MDATE] DATETIME NULL,
    [CLIENT_TYPE] CHAR(1) NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [INTIAL_MARGIN] NUMERIC(18, 2) NULL,
    [NET_BUY_PREMIUM] NUMERIC(18, 2) NULL,
    [EXTREME_LOSS_MARGIN] NUMERIC(18, 2) NULL,
    [TOTAL_MARGIN] NUMERIC(18, 2) NULL,
    [POPULATED_BY] VARCHAR(20) NULL,
    [POPULATED_ON] DATETIME NULL,
    [MTOMLOSS] NUMERIC(18, 4) NULL,
    [FILLER1_MAR] NUMERIC(18, 4) NULL,
    [FILLER2_MAR] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGINNEW_EFFCOLL
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGINNEW_EFFCOLL]
(
    [PARTY_CODE] VARCHAR(12) NULL,
    [EFFECTIVECOLL] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGINNEW_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGINNEW_IMP]
(
    [MDATE] DATETIME NULL,
    [CLIENT_TYPE] CHAR(1) NULL,
    [PARTY_CODE] VARCHAR(20) NULL,
    [INTIAL_MARGIN] NUMERIC(18, 2) NULL,
    [NET_BUY_PREMIUM] NUMERIC(18, 2) NULL,
    [EXTREME_LOSS_MARGIN] NUMERIC(18, 2) NULL,
    [TOTAL_MARGIN] NUMERIC(18, 2) NULL,
    [MTOMLOSS] NUMERIC(18, 4) NULL,
    [FILLER1_MAR] NUMERIC(18, 4) NULL,
    [FILLER2_MAR] NUMERIC(18, 4) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMARGINPERCENT
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMARGINPERCENT]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [MARGIN_PERCENT] NUMERIC(5, 2) NULL,
    [INTEREST_PERCENT] NUMERIC(5, 2) NULL,
    [EFFECTIVE_DATEFROM] DATETIME NULL,
    [ENTRY_ID] VARCHAR(25) NOT NULL,
    [ENTRY_DT] DATETIME NOT NULL,
    [MODIFY_ID] VARCHAR(25) NULL,
    [MODIFY_DT] DATETIME NULL,
    [DELETE_ID] VARCHAR(25) NULL,
    [DELETE_DT] DATETIME NULL,
    [STAT] VARCHAR(1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMG13PENALTYMASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMG13PENALTYMASTER]
(
    [EFFECTIVEDATE] SMALLDATETIME NULL,
    [SLAB] INT NULL,
    [FROMPENALTYPERCENTAGE] NUMERIC(18, 2) NULL,
    [TOPENALTYPERCENTAGE] NUMERIC(18, 2) NULL,
    [MINIMUMAMT] INT NULL,
    [MINIMUMPERCENTAGE] NUMERIC(18, 2) NULL,
    [CHARGEFLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMG13REFERENCE
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMG13REFERENCE]
(
    [REFNO] INT NULL,
    [SUBMENUREFNO] INT NULL,
    [SUBJECT] VARCHAR(50) NULL,
    [HEADING] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOMG13SHORTAGE
-- --------------------------------------------------
CREATE TABLE [dbo].[FOMG13SHORTAGE]
(
    [FILEDATE] SMALLDATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [BATCH_NO] VARCHAR(10) NULL,
    [REFNO] INT NULL,
    [MARGINREQUIREMENT] MONEY NULL,
    [MARGINAVAILABLE] MONEY NULL,
    [MARGINREPORTED] MONEY NULL,
    [EXCHSHORT] MONEY NULL,
    [BRKSHORT] MONEY NULL,
    [BRKSLAB] INT NULL,
    [EXCHSLAB] INT NULL,
    [BRKSHORTAGEPERCENTAGE] NUMERIC(18, 2) NULL,
    [BRKPENALTY] MONEY NULL,
    [EXCHSHORTAGEPERCENTAGE] NUMERIC(18, 2) NULL,
    [EXCHPENALTY] MONEY NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.foowner
-- --------------------------------------------------
CREATE TABLE [dbo].[foowner]
(
    [Company] VARCHAR(100) NOT NULL,
    [Addr1] VARCHAR(30) NULL,
    [Addr2] VARCHAR(30) NULL,
    [Phone] VARCHAR(15) NULL,
    [Zip] VARCHAR(6) NULL,
    [city] VARCHAR(15) NULL,
    [membertype] VARCHAR(15) NULL,
    [MemberCode] VARCHAR(15) NULL,
    [BankName] VARCHAR(50) NULL,
    [BankAdd] VARCHAR(50) NULL,
    [csdlId] VARCHAR(10) NULL,
    [Cdaccno] VARCHAR(10) NULL,
    [DpId] VARCHAR(10) NULL,
    [CltAccNo] VARCHAR(10) NULL,
    [Mainbroker] CHAR(1) NULL,
    [Maxpartylen] TINYINT NULL,
    [Preprintchq] CHAR(1) NULL,
    [Table_No] SMALLINT NULL,
    [Sub_TableNo] SMALLINT NULL,
    [Std_rate] SMALLINT NULL,
    [P_to_P] SMALLINT NULL,
    [demat_tableno] SMALLINT NULL,
    [AlbmCf_tableno] SMALLINT NULL,
    [MF_tableno] SMALLINT NULL,
    [SB_tableno] SMALLINT NULL,
    [brok1_tableno] SMALLINT NULL,
    [brok2_tableno] SMALLINT NULL,
    [brok3_tableno] SMALLINT NULL,
    [Terminal] VARCHAR(10) NULL,
    [tscheme] TINYINT NULL,
    [dispcharge] TINYINT NULL,
    [Brok_Inc_STax] TINYINT NULL,
    [def_scheme] CHAR(1) NULL,
    [brok_scheme] TINYINT NULL,
    [ContCharge] TINYINT NULL,
    [MinContCharge] TINYINT NULL,
    [MarginMultiplier] TINYINT NULL,
    [TradingFees] MONEY NULL,
    [ClearingFees] MONEY NULL,
    [MinChrgTrdfees] MONEY NULL,
    [MinChrgClfees] MONEY NULL,
    [TrdFeePerValue] MONEY NULL,
    [ClFeePerValue] MONEY NULL,
    [Tm_Code] VARCHAR(10) NULL,
    [dummy1] TINYINT NULL,
    [dummy2] TINYINT NULL,
    [clrgchg] INT NULL,
    [chmclchrg] INT NULL,
    [StampDuty] TINYINT NULL,
    [Turnover_Tax] TINYINT NULL,
    [TaxesFlag] INT NULL,
    [ContNo] VARCHAR(8) NULL,
    [Style] INT NULL,
    [ContPrint_Party_Style] INT NULL,
    [Email] VARCHAR(50) NULL,
    [state] VARCHAR(50) NULL,
    [SebiNo] VARCHAR(20) NULL,
    [BrokerSebiRegNo] VARCHAR(20) NULL,
    [SMTP_SRV_NAME] VARCHAR(50) NULL,
    [EXCHANGECODE] VARCHAR(3) NULL,
    [Panno] VARCHAR(15) NULL,
    [PARENTCODE_FLAG] INT NULL,
    [COMPLIANCE_NAME] VARCHAR(50) NULL,
    [COMPLIANCE_EMAIL] VARCHAR(100) NULL,
    [COMPLIANCE_PHONE] VARCHAR(15) NULL,
    [COMPLIANCE_MOBILE] VARCHAR(15) NULL,
    [WEBSITE_ID] VARCHAR(100) NULL,
    [FAX] VARCHAR(25) NULL,
    [SERVICES_TAXNO] VARCHAR(30) NULL,
    [CUT_CHRGS_FROM_BROK] INT NULL,
    [CIN] VARCHAR(30) NULL,
    [VB_RDO_CONNECTION] INT NULL,
    [GST_NO] VARCHAR(20) NULL,
    [SERVICE_DESCRIPTION] VARCHAR(100) NULL,
    [ACCOUNT_SERVICE_NO] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSCRIP_IMP
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSCRIP_IMP]
(
    [CONTRACT_ID] INT NULL,
    [TOCKEN_NO] INT NULL,
    [INST_TYPE] CHAR(6) NULL,
    [SYMBOL] CHAR(10) NULL,
    [FILLER1] CHAR(2) NULL,
    [FILLER2] CHAR(4) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] NUMERIC(18, 4) NULL,
    [OPTION_TYPE] CHAR(2) NULL,
    [PRECISION] CHAR(1) NULL,
    [FILLER3] INT NULL,
    [FILLER4] CHAR(3) NULL,
    [PARTITION_ID] INT NULL,
    [FILLER5] INT NULL,
    [FILLER6] INT NULL,
    [FILLER7] INT NULL,
    [FILLER8] CHAR(2) NULL,
    [FILLER9] INT NULL,
    [FILLER10] INT NULL,
    [FILLER11] CHAR(2) NULL,
    [FILLER12] INT NULL,
    [FILLER13] INT NULL,
    [FILLER14] CHAR(2) NULL,
    [FILLER15] INT NULL,
    [FILLER16] INT NULL,
    [FILLER17] CHAR(2) NULL,
    [CONTRAT_STARTDATE] DATETIME NULL,
    [SETTLEMENT_DATE] DATETIME NULL,
    [PRODUCT_ID] INT NULL,
    [FILLER18] INT NULL,
    [MIN_LOT_SIZE] INT NULL,
    [LOT_SIZE] INT NULL,
    [TICK_SIZE] INT NULL,
    [FILLER19] INT NULL,
    [FILLER20] INT NULL,
    [FILLER21] INT NULL,
    [INSTRUMENT_ID] INT NULL,
    [FILLER22] INT NULL,
    [FILLER23] INT NULL,
    [FILLER24] INT NULL,
    [FILLER25] INT NULL,
    [FILLER26] INT NULL,
    [FILLER27] INT NULL,
    [FILLER28] INT NULL,
    [FILLER29] INT NULL,
    [FILLER30] INT NULL,
    [FILLER31] INT NULL,
    [FILLER32] INT NULL,
    [EXERCISE_START_DATE] DATETIME NULL,
    [EXERCISE_END_DATE] DATETIME NULL,
    [FILLER33] INT NULL,
    [QTY_MULTIPLIER] INT NULL,
    [FILLER34] CHAR(12) NULL,
    [INSTRUMENT_NAME] CHAR(26) NULL,
    [FILLER35] INT NULL,
    [FILLER36] INT NULL,
    [FILLER37] INT NULL,
    [UNDERLYING_MARKET] INT NULL,
    [FILLER38] CHAR(24) NULL,
    [CONTRACT_TYPE] VARCHAR(4) NULL,
    [FILLER39] CHAR(1) NULL,
    [FILLER40] CHAR(1) NULL,
    [FILLER41] CHAR(1) NULL,
    [FILLER42] CHAR(1) NULL,
    [FILLER43] CHAR(1) NULL,
    [FILLER44] CHAR(10) NULL,
    [FILLER45] CHAR(6) NULL,
    [BASE_PRICE] INT NULL,
    [DELETE_FLAG] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSCRIP2
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSCRIP2]
(
    [P_KEY] INT IDENTITY(1,1) NOT NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [SEC_NAME] VARCHAR(25) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [MATURITYDATE] DATETIME NULL,
    [C_REGULAR_LOT] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSETTCORPACT
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSETTCORPACT]
(
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [BILLNO] VARCHAR(10) NULL,
    [TRADE_NO] VARCHAR(15) NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [SEC_NAME] VARCHAR(25) NOT NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [USER_ID] VARCHAR(15) NULL,
    [PRO_CLI] INT NULL,
    [O_C_FLAG] VARCHAR(5) NULL,
    [C_U_FLAG] VARCHAR(7) NULL,
    [TRADEQTY] INT NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [MARKETTYPE] VARCHAR(2) NULL,
    [SERIES] CHAR(2) NOT NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PRICE] MONEY NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [TABLE_NO] VARCHAR(4) NOT NULL,
    [LINE_NO] DECIMAL(3, 0) NOT NULL,
    [VAL_PERC] CHAR(1) NULL,
    [NORMAL] MONEY NULL,
    [DAY_PUC] MONEY NULL,
    [DAY_SALES] MONEY NULL,
    [SETT_PURCH] MONEY NULL,
    [SETT_SALES] MONEY NULL,
    [SELL_BUY] INT NOT NULL,
    [SETTFLAG] INT NULL,
    [BROKAPPLIED] MONEY NULL,
    [NETRATE] DECIMAL(15, 7) NULL,
    [AMOUNT] MONEY NULL,
    [INS_CHRG] MONEY NULL,
    [TURN_TAX] MONEY NULL,
    [OTHER_CHRG] MONEY NULL,
    [SEBI_TAX] MONEY NULL,
    [BROKER_CHRG] MONEY NULL,
    [SERVICE_TAX] MONEY NULL,
    [TRADE_AMOUNT] MONEY NULL,
    [BILLFLAG] INT NULL,
    [SETT_NO] VARCHAR(12) NULL,
    [NBROKAPP] MONEY NULL,
    [NSERTAX] MONEY NULL,
    [N_NETRATE] DECIMAL(15, 7) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [CL_RATE] MONEY NULL,
    [PARTICIPANTCODE] VARCHAR(15) NULL,
    [STATUS] VARCHAR(3) NULL,
    [CPID] VARCHAR(20) NULL,
    [INSTRUMENT] INT NULL,
    [BOOKTYPE] VARCHAR(5) NULL,
    [BRANCH_ID] VARCHAR(15) NULL,
    [TMARK] VARCHAR(10) NULL,
    [SCHEME] INT NULL,
    [DUMMY1] INT NULL,
    [DUMMY2] MONEY NULL,
    [RESERVED1] INT NULL,
    [RESERVED2] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FoSettlement
-- --------------------------------------------------
CREATE TABLE [dbo].[FoSettlement]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Contractno] VARCHAR(14) NOT NULL,
    [Billno] INT NULL,
    [Trade_No] VARCHAR(15) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_Type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Sec_Name] VARCHAR(25) NOT NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_Price] MONEY NULL,
    [Option_Type] VARCHAR(2) NULL,
    [User_Id] VARCHAR(15) NULL,
    [Pro_Cli] INT NULL,
    [O_C_Flag] VARCHAR(5) NULL,
    [C_U_Flag] VARCHAR(7) NULL,
    [Tradeqty] INT NULL,
    [Auctionpart] VARCHAR(2) NULL,
    [Markettype] VARCHAR(2) NULL,
    [Series] CHAR(2) NOT NULL,
    [Order_No] VARCHAR(20) NULL,
    [Price] NUMERIC(18, 8) NULL,
    [Sauda_Date] DATETIME NOT NULL,
    [Table_No] VARCHAR(4) NOT NULL,
    [Line_No] DECIMAL(3, 0) NOT NULL,
    [Val_Perc] CHAR(1) NULL,
    [Normal] MONEY NULL,
    [Day_Puc] MONEY NULL,
    [Day_Sales] MONEY NULL,
    [Sett_Purch] MONEY NULL,
    [Sett_Sales] MONEY NULL,
    [Sell_Buy] INT NOT NULL,
    [Settflag] INT NULL,
    [Brokapplied] NUMERIC(18, 8) NULL,
    [Netrate] NUMERIC(18, 8) NULL,
    [Amount] MONEY NULL,
    [Ins_Chrg] MONEY NULL,
    [Turn_Tax] MONEY NULL,
    [Other_Chrg] MONEY NULL,
    [Sebi_Tax] MONEY NULL,
    [Broker_Chrg] MONEY NULL,
    [Service_Tax] NUMERIC(18, 8) NULL,
    [Trade_Amount] MONEY NULL,
    [Billflag] INT NULL,
    [Sett_No] VARCHAR(12) NULL,
    [Nbrokapp] NUMERIC(18, 8) NULL,
    [Nsertax] MONEY NULL,
    [N_Netrate] NUMERIC(18, 8) NULL,
    [Sett_Type] VARCHAR(3) NULL,
    [Cl_Rate] MONEY NULL,
    [Participantcode] VARCHAR(15) NULL,
    [Status] VARCHAR(3) NULL,
    [Cpid] VARCHAR(20) NULL,
    [Instrument] INT NULL,
    [Booktype] VARCHAR(5) NULL,
    [Branch_Id] VARCHAR(15) NULL,
    [Tmark] VARCHAR(10) NULL,
    [Scheme] INT NULL,
    [Dummy1] INT NULL,
    [Dummy2] MONEY NULL,
    [Reserved1] INT NULL,
    [Reserved2] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSETTLEMENTEXPIRY
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSETTLEMENTEXPIRY]
(
    [SRNO] INT NOT NULL,
    [CONTRACTNO] VARCHAR(14) NOT NULL,
    [BILLNO] INT NULL,
    [TRADE_NO] VARCHAR(10) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [SEC_NAME] VARCHAR(25) NOT NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [USER_ID] VARCHAR(15) NULL,
    [PRO_CLI] INT NULL,
    [O_C_FLAG] VARCHAR(5) NULL,
    [C_U_FLAG] VARCHAR(7) NULL,
    [TRADEQTY] INT NULL,
    [AUCTIONPART] VARCHAR(2) NULL,
    [MARKETTYPE] VARCHAR(2) NULL,
    [SERIES] CHAR(2) NOT NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [PRICE] NUMERIC(36, 12) NOT NULL,
    [SAUDA_DATE] DATETIME NOT NULL,
    [TABLE_NO] VARCHAR(4) NOT NULL,
    [LINE_NO] NUMERIC(3, 0) NOT NULL,
    [VAL_PERC] CHAR(1) NULL,
    [NORMAL] NUMERIC(36, 12) NOT NULL,
    [DAY_PUC] NUMERIC(36, 12) NOT NULL,
    [DAY_SALES] NUMERIC(36, 12) NOT NULL,
    [SETT_PURCH] NUMERIC(36, 12) NOT NULL,
    [SETT_SALES] NUMERIC(36, 12) NOT NULL,
    [SELL_BUY] INT NOT NULL,
    [SETTFLAG] INT NULL,
    [BROKAPPLIED] NUMERIC(36, 12) NOT NULL,
    [NETRATE] NUMERIC(36, 12) NULL,
    [AMOUNT] NUMERIC(36, 12) NOT NULL,
    [INS_CHRG] NUMERIC(36, 12) NOT NULL,
    [TURN_TAX] NUMERIC(36, 12) NOT NULL,
    [OTHER_CHRG] NUMERIC(36, 12) NOT NULL,
    [SEBI_TAX] NUMERIC(36, 12) NOT NULL,
    [BROKER_CHRG] NUMERIC(36, 12) NOT NULL,
    [SERVICE_TAX] NUMERIC(36, 12) NOT NULL,
    [TRADE_AMOUNT] NUMERIC(36, 12) NOT NULL,
    [BILLFLAG] INT NULL,
    [SETT_NO] VARCHAR(12) NULL,
    [NBROKAPP] NUMERIC(36, 12) NOT NULL,
    [NSERTAX] NUMERIC(36, 12) NOT NULL,
    [N_NETRATE] NUMERIC(36, 12) NULL,
    [SETT_TYPE] VARCHAR(3) NULL,
    [CL_RATE] NUMERIC(36, 12) NOT NULL,
    [PARTICIPANTCODE] VARCHAR(15) NULL,
    [STATUS] VARCHAR(3) NULL,
    [CPID] VARCHAR(20) NULL,
    [INSTRUMENT] NUMERIC(18, 4) NULL,
    [BOOKTYPE] NUMERIC(18, 4) NULL,
    [BRANCH_ID] VARCHAR(15) NULL,
    [TMARK] VARCHAR(10) NULL,
    [SCHEME] INT NULL,
    [DUMMY1] INT NULL,
    [DUMMY2] NUMERIC(36, 12) NOT NULL,
    [RESERVED1] INT NULL,
    [RESERVED2] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOSTAT_TRD
-- --------------------------------------------------
CREATE TABLE [dbo].[FOSTAT_TRD]
(
    [ACTIONCODE] VARCHAR(3) NULL,
    [SYSDATE] SMALLDATETIME NULL,
    [FILEDATE] SMALLDATETIME NULL,
    [COM_DATE] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTAXES
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTAXES]
(
    [EXCHANGE] VARCHAR(3) NULL,
    [TRANS_CAT] VARCHAR(3) NULL,
    [TURNOVER_TAX] NUMERIC(18, 8) NULL,
    [OTHER_CHRG] DECIMAL(5, 4) NULL,
    [SEBITURN_TAX] DECIMAL(5, 4) NULL,
    [BROKER_NOTE] DECIMAL(6, 4) NULL,
    [FROM_DATE] SMALLDATETIME NULL,
    [TO_DATE] SMALLDATETIME NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [TURNOVER_TAX_ON] VARCHAR(10) NULL,
    [OTHER_CHRG_ON] VARCHAR(10) NULL,
    [SEBI_TAX_ON] VARCHAR(10) NULL,
    [BROKER_NOTE_ON] VARCHAR(10) NULL,
    [CREATED_BY] VARCHAR(25) NULL,
    [CREATED_ON] SMALLDATETIME NULL,
    [MODIFIED_BY] VARCHAR(25) NULL,
    [MODIFIED_ON] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTMCLCHRG
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTMCLCHRG]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [ORDERNO] VARCHAR(15) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [CLEARINGCHARGES] MONEY NULL,
    [DUMMY1] TINYINT NULL,
    [DUMMY2] VARCHAR(15) NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [SELL_BUY] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTMINFO
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTMINFO]
(
    [TM_CODE] VARCHAR(10) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [SHORT_NAME] VARCHAR(20) NULL,
    [LONG_NAME] VARCHAR(50) NULL,
    [ADD1] VARCHAR(50) NULL,
    [ADD2] VARCHAR(50) NULL,
    [PHONENO] VARCHAR(15) NULL,
    [CLEARINGFEES] MONEY NULL,
    [MINCHRGCLFEES] MONEY NULL,
    [CLFEEPERVAL] MONEY NULL,
    [ROUNDING] INT NULL,
    [MTOM] NUMERIC(18, 0) NULL,
    [DUMMY1] TINYINT NULL,
    [DUMMY2] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRADE
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRADE]
(
    [TRADE_NO] VARCHAR(20) NOT NULL,
    [STATUS] VARCHAR(3) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SEC_NAME] VARCHAR(25) NULL,
    [BOOKTYPE] INT NULL,
    [BOOKTYPENAME] INT NULL,
    [MARKETTYPE] VARCHAR(2) NULL,
    [USER_ID] VARCHAR(15) NULL,
    [BRANCH_ID] VARCHAR(15) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [PRICE] NUMERIC(36, 12) NOT NULL,
    [PRO_CLI] INT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(50) NULL,
    [O_C_FLAG] VARCHAR(5) NULL,
    [C_U_FLAG] VARCHAR(7) NULL,
    [ACTIVITYTIME] DATETIME NULL,
    [LAST_MOD_TIME] DATETIME NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [OPP_BROKER_ID] VARCHAR(20) NULL,
    [SETTFLAG] INT NULL,
    [MEMBERCODE] VARCHAR(10) NULL,
    [TMPARTYCODE] VARCHAR(10) NULL,
    [RESERVED1] MONEY NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(16) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRADEMISSING
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRADEMISSING]
(
    [TRADE_NO] VARCHAR(20) NOT NULL,
    [STATUS] VARCHAR(3) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SEC_NAME] VARCHAR(25) NULL,
    [BOOKTYPE] VARCHAR(2) NULL,
    [BOOKTYPENAME] VARCHAR(3) NULL,
    [MARKETTYPE] VARCHAR(2) NULL,
    [USER_ID] VARCHAR(15) NULL,
    [BRANCH_ID] VARCHAR(15) NULL,
    [SELL_BUY] INT NULL,
    [TRADEQTY] INT NULL,
    [PRICE] NUMERIC(36, 12) NOT NULL,
    [PRO_CLI] INT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PARTICIPANTCODE] VARCHAR(50) NULL,
    [O_C_FLAG] VARCHAR(5) NULL,
    [C_U_FLAG] VARCHAR(7) NULL,
    [ACTIVITYTIME] DATETIME NULL,
    [LAST_MOD_TIME] DATETIME NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [OPP_BROKER_ID] VARCHAR(5) NULL,
    [SETTFLAG] INT NULL,
    [MEMBERCODE] VARCHAR(10) NULL,
    [TMPARTYCODE] VARCHAR(10) NULL,
    [RESERVED1] VARCHAR(10) NULL,
    [RESERVED2] VARCHAR(10) NULL,
    [RESERVED3] VARCHAR(16) NULL,
    [RESERVED4] VARCHAR(10) NULL,
    [RESERVED5] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRD_BROKTABLE
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRD_BROKTABLE]
(
    [TABLE_NO] SMALLINT NOT NULL,
    [LINE_NO] DECIMAL(3, 0) NOT NULL,
    [VAL_PERC] CHAR(1) NULL,
    [UPPER_LIM] NUMERIC(36, 12) NOT NULL,
    [DAY_PUC] NUMERIC(18, 4) NULL,
    [DAY_SALES] NUMERIC(18, 4) NULL,
    [SETT_PURCH] NUMERIC(18, 4) NULL,
    [ROUND_TO] DECIMAL(10, 2) NULL,
    [TABLE_NAME] CHAR(25) NULL,
    [SETT_SALES] NUMERIC(18, 4) NULL,
    [NORMAL] DECIMAL(10, 6) NULL,
    [TRD_DEL] CHAR(1) NULL,
    [LOWER_LIM] DECIMAL(10, 2) NULL,
    [DEF_TABLE] TINYINT NULL,
    [ROFIG] INT NULL,
    [ERRNUM] NUMERIC(36, 12) NOT NULL,
    [NOZERO] INT NULL,
    [BRANCH_CODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRD_CLIENT1
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRD_CLIENT1]
(
    [CL_CODE] VARCHAR(10) NULL,
    [SHORT_NAME] VARCHAR(21) NULL,
    [LONG_NAME] VARCHAR(100) NULL,
    [L_ADDRESS1] VARCHAR(100) NULL,
    [L_ADDRESS2] VARCHAR(100) NULL,
    [L_CITY] VARCHAR(40) NULL,
    [L_STATE] VARCHAR(50) NULL,
    [L_NATION] VARCHAR(15) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [FAX] VARCHAR(15) NULL,
    [RES_PHONE1] VARCHAR(15) NULL,
    [RES_PHONE2] VARCHAR(15) NULL,
    [OFF_PHONE1] VARCHAR(15) NULL,
    [OFF_PHONE2] VARCHAR(15) NULL,
    [EMAIL] VARCHAR(50) NULL,
    [BRANCH_CD] VARCHAR(10) NULL,
    [CREDIT_LIMIT] DECIMAL(13, 2) NULL,
    [CL_TYPE] VARCHAR(3) NULL,
    [CL_STATUS] VARCHAR(3) NULL,
    [GL_CODE] VARCHAR(20) NULL,
    [FD_CODE] VARCHAR(25) NULL,
    [FAMILY] VARCHAR(10) NULL,
    [PENALTY] DECIMAL(6, 0) NULL,
    [SUB_BROKER] VARCHAR(10) NULL,
    [CONFIRM_FAX] TINYINT NOT NULL,
    [PHONEOLD] VARCHAR(40) NULL,
    [L_ADDRESS3] VARCHAR(100) NULL,
    [MOBILE_PAGER] VARCHAR(40) NULL,
    [PAN_GIR_NO] VARCHAR(50) NULL,
    [TRADER] VARCHAR(20) NULL,
    [WARD_NO] VARCHAR(50) NULL,
    [REGION] VARCHAR(50) NULL,
    [AREA] VARCHAR(20) NULL,
    [CLRATING] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRD_CLIENT2
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRD_CLIENT2]
(
    [CL_CODE] CHAR(10) NOT NULL,
    [EXCHANGE] CHAR(3) NOT NULL,
    [TRAN_CAT] CHAR(3) NOT NULL,
    [SCRIP_CAT] DECIMAL(18, 4) NULL,
    [PARTY_CODE] CHAR(10) NOT NULL,
    [TABLE_NO] SMALLINT NOT NULL,
    [SUB_TABLENO] SMALLINT NOT NULL,
    [MARGIN] TINYINT NOT NULL,
    [TURNOVER_TAX] TINYINT NOT NULL,
    [SEBI_TURN_TAX] TINYINT NOT NULL,
    [INSURANCE_CHRG] TINYINT NOT NULL,
    [SERVICE_CHRG] TINYINT NOT NULL,
    [STD_RATE] INT NULL,
    [P_TO_P] INT NULL,
    [EXPOSURE_LIM] DECIMAL(12, 2) NOT NULL,
    [DEMAT_TABLENO] INT NULL,
    [BANKID] VARCHAR(16) NULL,
    [CLTDPNO] VARCHAR(16) NULL,
    [PRINTF] TINYINT NOT NULL,
    [ALBMDELCHRG] TINYINT NULL,
    [ALBMDELIVERY] SMALLINT NULL,
    [ALBMCF_TABLENO] INT NULL,
    [MF_TABLENO] INT NULL,
    [SB_TABLENO] INT NULL,
    [BROK1_TABLENO] INT NULL,
    [BROK2_TABLENO] INT NULL,
    [BROK3_TABLENO] INT NULL,
    [BROKERNOTE] TINYINT NULL,
    [OTHER_CHRG] TINYINT NULL,
    [BROK_SCHEME] TINYINT NULL,
    [CONTCHARGE] TINYINT NULL,
    [MINCONTAMT] TINYINT NULL,
    [ADDLEDGERBAL] TINYINT NULL,
    [DUMMY1] TINYINT NULL,
    [DUMMY2] SMALLINT NULL,
    [INSCONT] CHAR(1) NULL,
    [SERTAXMETHOD] INT NULL,
    [DUMMY6] VARCHAR(5) NULL,
    [DUMMY7] VARCHAR(4) NULL,
    [DUMMY8] VARCHAR(10) NULL,
    [DUMMY9] VARCHAR(10) NULL,
    [DUMMY10] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRD_CLIENTBROKSCHEME
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRD_CLIENTBROKSCHEME]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [DATE_FROM] DATETIME NULL,
    [DATE_TO] DATETIME NULL,
    [FUT_BROKTABLE] INT NULL,
    [OPT_BROKTABLE] INT NULL,
    [FUT_EXP_BROKTABLE] INT NULL,
    [OPT_EXC_BROKTABLE] INT NULL,
    [COMM_DEL_BROKTABLE] INT NULL,
    [BROK_SCHEME] TINYINT NULL,
    [OPT_BROK_COMPUTEON] VARCHAR(7) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRD_CLIENTTAXES
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRD_CLIENTTAXES]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [DATE_FROM] DATETIME NULL,
    [DATE_TO] DATETIME NULL,
    [FUT_INSURANCE_CHRG] DECIMAL(18, 5) NULL,
    [FUT_TURNOVER_TAX] DECIMAL(18, 5) NULL,
    [FUT_OTHER_CHRG] DECIMAL(18, 5) NULL,
    [FUT_SEBITURN_TAX] DECIMAL(18, 5) NULL,
    [FUT_BROKER_NOTE] DECIMAL(18, 5) NULL,
    [OPT_INSURANCE_CHRG] DECIMAL(18, 5) NULL,
    [OPT_TURNOVER_TAX] DECIMAL(18, 5) NULL,
    [OPT_OTHER_CHRG] DECIMAL(18, 5) NULL,
    [OPT_SEBITURN_TAX] DECIMAL(18, 5) NULL,
    [OPT_BROKER_NOTE] DECIMAL(18, 5) NULL,
    [ROUND_TO] DECIMAL(18, 0) NULL,
    [ROFIG] INT NULL,
    [ERRNUM] NUMERIC(18, 9) NULL,
    [NOZERO] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRD_CONTRACTNO
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRD_CONTRACTNO]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [SELL_BUY] INT NULL,
    [INSCONT] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRD_FOSCRIP1
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRD_FOSCRIP1]
(
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] SMALLDATETIME NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FOTRD_FOSCRIP2
-- --------------------------------------------------
CREATE TABLE [dbo].[FOTRD_FOSCRIP2]
(
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [SEC_NAME] VARCHAR(25) NULL,
    [EXPIRYDATE] SMALLDATETIME NOT NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [MATURITYDATE] SMALLDATETIME NULL,
    [C_REGULAR_LOT] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HOLDING_JAN
-- --------------------------------------------------
CREATE TABLE [dbo].[HOLDING_JAN]
(
    [HLD_AC_CODE] VARCHAR(16) NULL,
    [VALUE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HOLDING_MAY_17
-- --------------------------------------------------
CREATE TABLE [dbo].[HOLDING_MAY_17]
(
    [HLD_AC_CODE] VARCHAR(16) NULL,
    [VALUE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HOLDING_SEP
-- --------------------------------------------------
CREATE TABLE [dbo].[HOLDING_SEP]
(
    [HLD_AC_CODE] VARCHAR(16) NULL,
    [VALUE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HOLDINGCM
-- --------------------------------------------------
CREATE TABLE [dbo].[HOLDINGCM]
(
    [Party_Code] NVARCHAR(255) NULL,
    [Party_Name] NVARCHAR(255) NULL,
    [Scrip_Cd] NVARCHAR(255) NULL,
    [Series] NVARCHAR(255) NULL,
    [DPId] FLOAT NULL,
    [ClientId] NVARCHAR(255) NULL,
    [Isin] NVARCHAR(255) NULL,
    [Sett_No] FLOAT NULL,
    [Sett_Type] NVARCHAR(255) NULL,
    [Qty] FLOAT NULL,
    [F11] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.HOLDINGFO
-- --------------------------------------------------
CREATE TABLE [dbo].[HOLDINGFO]
(
    [F1] NVARCHAR(255) NULL,
    [F2] NVARCHAR(255) NULL,
    [F3] NVARCHAR(255) NULL,
    [F4] NVARCHAR(255) NULL,
    [F5] FLOAT NULL,
    [F6] NVARCHAR(255) NULL,
    [F7] NVARCHAR(255) NULL,
    [F8] FLOAT NULL,
    [F9] NVARCHAR(255) NULL,
    [F10] FLOAT NULL,
    [F11] DATETIME NULL,
    [F12] DATETIME NULL,
    [F13] FLOAT NULL,
    [F14] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.IMP_FILEPATH
-- --------------------------------------------------
CREATE TABLE [dbo].[IMP_FILEPATH]
(
    [File_Type] VARCHAR(20) NULL,
    [File_Path] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.INST_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[INST_LOG]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [NEW_PARTY_CODE] VARCHAR(10) NULL,
    [SAUDA_DATE] DATETIME NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NULL,
    [ORDER_NO] VARCHAR(20) NULL,
    [TRADE_NO] VARCHAR(20) NULL,
    [SELL_BUY] VARCHAR(1) NULL,
    [CONTRACT_NO] VARCHAR(20) NULL,
    [NEW_CONTRACT_NO] VARCHAR(20) NULL,
    [BROKERAGE] NUMERIC(36, 12) NULL,
    [NEW_BROKERAGE] NUMERIC(36, 12) NULL,
    [MARKET_RATE] NUMERIC(36, 12) NULL,
    [NEW_MARKET_RATE] NUMERIC(36, 12) NULL,
    [NET_RATE] NUMERIC(36, 12) NULL,
    [NEW_NET_RATE] NUMERIC(36, 12) NULL,
    [QTY] BIGINT NULL,
    [NEW_QTY] BIGINT NULL,
    [ROUNDTO] INT NULL,
    [PARTICIPANT_CODE] VARCHAR(20) NULL,
    [NEW_PARTICIPANT_CODE] VARCHAR(20) NULL,
    [USERNAME] VARCHAR(25) NULL,
    [MODULE] VARCHAR(50) NULL,
    [CALLED_FROM] VARCHAR(100) NULL,
    [TIMESTAMP] DATETIME NULL,
    [EXTRAFIELD3] VARCHAR(10) NULL,
    [EXTRAFIELD4] VARCHAR(1) NULL,
    [EXTRAFIELD5] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.INST_MAPPING
-- --------------------------------------------------
CREATE TABLE [dbo].[INST_MAPPING]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [USERNAME] VARCHAR(25) NULL,
    [RIGHTTYPE] VARCHAR(1) NULL,
    [MAP_CODE] VARCHAR(50) NULL,
    [ISVALID] VARCHAR(1) NULL,
    [MAP_TYPE] VARCHAR(1) NULL,
    [ADD_BY] VARCHAR(25) NULL,
    [ADD_ON] DATETIME NULL,
    [DEL_BY] VARCHAR(25) NULL,
    [DEL_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.INSTCLIENT_TBL
-- --------------------------------------------------
CREATE TABLE [dbo].[INSTCLIENT_TBL]
(
    [PARTYCODE] CHAR(10) NULL,
    [MARKETRATE] CHAR(1) NULL,
    [BROKERAGE] CHAR(1) NULL,
    [NETRATE] CHAR(1) NULL,
    [NOC] INT NULL,
    [RES1] VARCHAR(10) NULL,
    [RES2] VARCHAR(10) NULL,
    [RES3] VARCHAR(10) NULL,
    [RES4] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LEDGER_DETAILS_DAS
-- --------------------------------------------------
CREATE TABLE [dbo].[LEDGER_DETAILS_DAS]
(
    [LEDDD_PARTY_CODE] VARCHAR(10) NOT NULL,
    [LEDDD_SAUDA_DATE] DATETIME NULL,
    [LEDDD_OPENING_BAL] MONEY NULL,
    [LEDDD_CHQ_REC] MONEY NULL,
    [LEDDD_CHQ_PAY] MONEY NULL,
    [LEDDD_JV_ENTRY] MONEY NULL,
    [LEDDD_CLOSING_BAL] MONEY NULL,
    [LEDDD_CASH_MARGIN] MONEY NULL,
    [LEDDD_OPENING_INIT_MARGIN] MONEY NULL,
    [LEDDD_MRG_REC] MONEY NULL,
    [LEDDD_MRG_REPAY] MONEY NULL,
    [LEDDD_MRG_JV_ENTRY] MONEY NULL,
    [LEDDD_CLOSING_INIT_MARGIN] MONEY NULL,
    [LEDDD_NONCASH_COLL_HC] MONEY NULL,
    [LEDDD_INIT_EXPO_MARGIN] MONEY NULL,
    [LEDDD_CREATED_BY] VARCHAR(10) NOT NULL,
    [LEDDD_CREATED_DT] DATETIME NOT NULL,
    [LEDDD_ADD_MARGIN] MONEY NULL,
    [LEDDD_FT_D] MONEY NULL,
    [LEDDD_FT_C] MONEY NULL,
    [LEDDD_MRG_FT] MONEY NULL,
    [LEDDD_RUNNINGBAL] MONEY NULL,
    [LEDDD_CASH_COLL_HC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LOG_PWDMAILS
-- --------------------------------------------------
CREATE TABLE [dbo].[LOG_PWDMAILS]
(
    [FLDID] INT NOT NULL,
    [FLDSTNAME] VARCHAR(10) NOT NULL,
    [FLDUSERNAME] VARCHAR(20) NOT NULL,
    [PAN_GIR_NO] VARCHAR(20) NOT NULL,
    [DOB] VARCHAR(10) NOT NULL,
    [EMAIL] VARCHAR(200) NOT NULL,
    [IP_ADDR] VARCHAR(20) NOT NULL,
    [MAC_ID] VARCHAR(25) NOT NULL,
    [ERROR_DESC] VARCHAR(100) NOT NULL,
    [UPDATEDATE] DATETIME NOT NULL,
    [EMAIL_SENT_STAT] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LOGIN_EXP
-- --------------------------------------------------
CREATE TABLE [dbo].[LOGIN_EXP]
(
    [EXP_PERIOD_TYPE] CHAR(2) NULL,
    [EXP_PERIOD] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Marbd
-- --------------------------------------------------
CREATE TABLE [dbo].[Marbd]
(
    [F1] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Marbd1
-- --------------------------------------------------
CREATE TABLE [dbo].[Marbd1]
(
    [ClientCode] NVARCHAR(255) NULL,
    [Amount] FLOAT NULL,
    [Type] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MARGIN_REPORTING
-- --------------------------------------------------
CREATE TABLE [dbo].[MARGIN_REPORTING]
(
    [SAUDA_DATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [PREV_CASH] NUMERIC(18, 4) NULL,
    [PREV_FD] NUMERIC(18, 4) NULL,
    [PREV_BG] NUMERIC(18, 4) NULL,
    [PREV_SEC] NUMERIC(18, 4) NULL,
    [PREV_VAR] NUMERIC(18, 4) NULL,
    [CURR_CASH] NUMERIC(18, 4) NULL,
    [CURR_FD] NUMERIC(18, 4) NULL,
    [CURR_BG] NUMERIC(18, 4) NULL,
    [CURR_SEC] NUMERIC(18, 4) NULL,
    [MAR_ADJUST] NUMERIC(18, 4) NULL,
    [MAR_STATUS] NUMERIC(18, 4) NULL,
    [RUNDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MG13BATCHNO_TBL
-- --------------------------------------------------
CREATE TABLE [dbo].[MG13BATCHNO_TBL]
(
    [FILEDATE] SMALLDATETIME NULL,
    [BATCHNO] INT NULL,
    [REJECTED] VARCHAR(5) NULL,
    [RESERVED1] INT NULL,
    [RESERVERD2] INT NULL,
    [RESERVED3] INT NULL,
    [VALIDATE_FLD] VARCHAR(50) NULL,
    [LAST_UPDATE_TIME] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MULTICLTID
-- --------------------------------------------------
CREATE TABLE [dbo].[MULTICLTID]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [CLTDPNO] VARCHAR(16) NOT NULL,
    [DPID] VARCHAR(16) NOT NULL,
    [INTRODUCER] VARCHAR(100) NULL,
    [DPTYPE] VARCHAR(4) NULL,
    [DEF] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PARTYMAPPING
-- --------------------------------------------------
CREATE TABLE [dbo].[PARTYMAPPING]
(
    [OLDPARTY_CODE] VARCHAR(10) NULL,
    [NEWPARTY_CODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.POBANK
-- --------------------------------------------------
CREATE TABLE [dbo].[POBANK]
(
    [BankId] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Bank_Name] VARCHAR(50) NOT NULL,
    [Branch_Name] VARCHAR(50) NULL,
    [Address1] VARCHAR(50) NULL,
    [Address2] VARCHAR(50) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Nation] VARCHAR(25) NULL,
    [Zip] VARCHAR(15) NULL,
    [Phone1] VARCHAR(15) NULL,
    [Phone2] VARCHAR(15) NULL,
    [Fax] VARCHAR(15) NULL,
    [Email] VARCHAR(50) NULL,
    [IFSCCODE] VARCHAR(12) NULL,
    [MICRNO] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.POBANK_ING_VYSYA_DONOTDELETE
-- --------------------------------------------------
CREATE TABLE [dbo].[POBANK_ING_VYSYA_DONOTDELETE]
(
    [BankId] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [Bank_Name] VARCHAR(50) NOT NULL,
    [Branch_Name] VARCHAR(50) NULL,
    [Address1] VARCHAR(50) NULL,
    [Address2] VARCHAR(50) NULL,
    [City] VARCHAR(25) NULL,
    [State] VARCHAR(25) NULL,
    [Nation] VARCHAR(25) NULL,
    [Zip] VARCHAR(15) NULL,
    [Phone1] VARCHAR(15) NULL,
    [Phone2] VARCHAR(15) NULL,
    [Fax] VARCHAR(15) NULL,
    [Email] VARCHAR(50) NULL,
    [IFSCCODE] VARCHAR(12) NULL,
    [MICRNO] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.prevbal
-- --------------------------------------------------
CREATE TABLE [dbo].[prevbal]
(
    [Clientcode] NVARCHAR(255) NULL,
    [Party_Code] NVARCHAR(255) NULL,
    [Amout] FLOAT NULL,
    [Type] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.RATING
-- --------------------------------------------------
CREATE TABLE [dbo].[RATING]
(
    [Rating] VARCHAR(10) NULL,
    [Description] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.REGION
-- --------------------------------------------------
CREATE TABLE [dbo].[REGION]
(
    [RegionCode] VARCHAR(20) NULL,
    [Description] VARCHAR(50) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Dummy1] VARCHAR(1) NULL,
    [Dummy2] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.ROUNDPARAM
-- --------------------------------------------------
CREATE TABLE [dbo].[ROUNDPARAM]
(
    [RoundStyle] SMALLINT NULL,
    [Description] CHAR(25) NULL,
    [Round_to] SMALLINT NULL,
    [RoFig] SMALLINT NULL,
    [ErrNum] MONEY NULL,
    [NoZero] SMALLINT NULL,
    [RoundMarketrate] TINYINT NULL,
    [RoundBrokerage] TINYINT NULL,
    [RoundNetrate] TINYINT NULL,
    [OtherRound] TINYINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SBU_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[SBU_MASTER]
(
    [SBU_CODE] VARCHAR(10) NOT NULL,
    [SBU_NAME] VARCHAR(50) NOT NULL,
    [SBU_ADDR1] VARCHAR(40) NOT NULL,
    [SBU_ADDR2] VARCHAR(40) NULL,
    [SBU_ADDR3] VARCHAR(40) NULL,
    [SBU_CITY] VARCHAR(20) NULL,
    [SBU_STATE] VARCHAR(20) NULL,
    [SBU_ZIP] VARCHAR(10) NULL,
    [SBU_PHONE1] VARCHAR(15) NULL,
    [SBU_PHONE2] VARCHAR(15) NULL,
    [SBU_TYPE] VARCHAR(10) NOT NULL,
    [SBU_PARTY_CODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCHEME_MAPPING
-- --------------------------------------------------
CREATE TABLE [dbo].[SCHEME_MAPPING]
(
    [SP_SRNO] INT IDENTITY(1,1) NOT NULL,
    [SP_PARTY_CODE] VARCHAR(10) NOT NULL,
    [SP_COMPUTATION_LEVEL] CHAR(1) NOT NULL,
    [SP_INST_TYPE] VARCHAR(3) NOT NULL,
    [SP_SCRIP] VARCHAR(12) NOT NULL,
    [SP_SCHEME_ID] INT NOT NULL,
    [SP_TRD_TYPE] VARCHAR(3) NOT NULL,
    [SP_SCHEME_TYPE] CHAR(1) NOT NULL,
    [SP_MULTIPLIER] NUMERIC(18, 4) NOT NULL,
    [SP_BUY_BROK_TYPE] CHAR(1) NULL,
    [SP_SELL_BROK_TYPE] CHAR(1) NULL,
    [SP_BUY_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_SELL_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_RES_MULTIPLIER] NUMERIC(18, 4) NOT NULL,
    [SP_RES_BUY_BROK] NUMERIC(18, 4) NOT NULL,
    [SP_RES_SELL_BROK] NUMERIC(18, 4) NULL,
    [SP_VALUE_FROM] NUMERIC(18, 4) NOT NULL,
    [SP_VALUE_TO] NUMERIC(18, 4) NOT NULL,
    [SP_TURNOVERON] VARCHAR(7) NOT NULL,
    [SP_BROK_COMPUTEON] CHAR(1) NOT NULL,
    [SP_BROK_COMPUTETYPE] CHAR(1) NOT NULL,
    [SP_MIN_BROKAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MAX_BROKAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MIN_SCRIPAMT] NUMERIC(18, 4) NOT NULL,
    [SP_MAX_SCRIPAMT] NUMERIC(18, 4) NOT NULL,
    [SP_DATE_FROM] DATETIME NOT NULL,
    [SP_DATE_TO] DATETIME NOT NULL,
    [SP_CREATEDBY] VARCHAR(20) NOT NULL,
    [SP_CREATEDON] DATETIME NOT NULL,
    [SP_MODIFIEDBY] VARCHAR(20) NOT NULL,
    [SP_MODIFIEDON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCHEME_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[SCHEME_MASTER]
(
    [SM_SRNO] INT IDENTITY(1,1) NOT NULL,
    [SM_SCHEME_ID] INT NOT NULL,
    [SM_SCHEME_DESC] VARCHAR(50) NULL,
    [SM_TRD_TYPE] VARCHAR(3) NOT NULL,
    [SM_MULTIPLIER] NUMERIC(18, 4) NOT NULL,
    [SM_BUY_BROK_TYPE] CHAR(1) NOT NULL,
    [SM_SELL_BROK_TYPE] CHAR(10) NOT NULL,
    [SM_BUY_BROK] NUMERIC(18, 4) NOT NULL,
    [SM_SELL_BROK] NUMERIC(18, 4) NOT NULL,
    [SM_RES_MULTIPLIER] NUMERIC(18, 4) NOT NULL,
    [SM_RES_BUY_BROK] NUMERIC(18, 4) NOT NULL,
    [SM_RES_SELL_BROK] NUMERIC(18, 4) NOT NULL,
    [SM_VALUE_FROM] NUMERIC(18, 4) NOT NULL,
    [SM_VALUE_TO] NUMERIC(18, 4) NOT NULL,
    [SM_TURNOVERON] VARCHAR(7) NOT NULL,
    [SM_COMPUTATIONON] CHAR(1) NOT NULL,
    [SM_COMPUTATIONTYPE] CHAR(1) NOT NULL,
    [SM_CREATEDBY] VARCHAR(20) NOT NULL,
    [SM_CREATEDON] DATETIME NOT NULL,
    [SM_MODIFIEDBY] VARCHAR(20) NOT NULL,
    [SM_MODIFIEDON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCHEMES
-- --------------------------------------------------
CREATE TABLE [dbo].[SCHEMES]
(
    [schemeID] TINYINT NOT NULL,
    [Desc] VARCHAR(50) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SCRIP_CODES
-- --------------------------------------------------
CREATE TABLE [dbo].[SCRIP_CODES]
(
    [SYMBOL] VARCHAR(15) NOT NULL,
    [ISIN] VARCHAR(12) NOT NULL,
    [RICBASIC] VARCHAR(15) NOT NULL,
    [BLOOMBERG] VARCHAR(15) NOT NULL,
    [SEDOL] VARCHAR(15) NOT NULL,
    [CUSIP] VARCHAR(15) NOT NULL,
    [SCRIP_NAME] VARCHAR(100) NOT NULL,
    [BSECODE] VARCHAR(50) NOT NULL,
    [MERRYLCODE] VARCHAR(15) NULL,
    [MDSCODE] VARCHAR(25) NULL,
    [IDBI_SCRIP] VARCHAR(25) NULL,
    [SBI_CODE] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SETT_CALENDAR
-- --------------------------------------------------
CREATE TABLE [dbo].[SETT_CALENDAR]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [TRADE_DATE] DATETIME NULL,
    [SETTLEMENT_DATE] DATETIME NULL,
    [CREATEDBY] VARCHAR(20) NULL,
    [CREATEDON] DATETIME NULL,
    [MODIFIEDBY] VARCHAR(20) NULL,
    [MODIFIEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STATE_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[STATE_MASTER]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [STATE] VARCHAR(50) NULL,
    [TRDSTAMPDUTY] DECIMAL(18, 4) NULL,
    [DELSTAMPDUTY] DECIMAL(18, 4) NULL,
    [PROSTAMPDUTY] DECIMAL(18, 4) NULL,
    [MIN_MULTIPLIER] DECIMAL(18, 4) NULL,
    [FOR_TURNOVER] DECIMAL(18, 4) NULL,
    [MAXIMUM_LIMIT] DECIMAL(18, 4) NULL,
    [YEAR_START_DATE] DATETIME NULL,
    [YEAR_END_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STATE_MASTER_BAK_16112018
-- --------------------------------------------------
CREATE TABLE [dbo].[STATE_MASTER_BAK_16112018]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [STATE] VARCHAR(50) NULL,
    [TRDSTAMPDUTY] DECIMAL(18, 4) NULL,
    [DELSTAMPDUTY] DECIMAL(18, 4) NULL,
    [PROSTAMPDUTY] DECIMAL(18, 4) NULL,
    [MIN_MULTIPLIER] DECIMAL(18, 4) NULL,
    [FOR_TURNOVER] DECIMAL(18, 4) NULL,
    [MAXIMUM_LIMIT] DECIMAL(18, 4) NULL,
    [YEAR_START_DATE] DATETIME NULL,
    [YEAR_END_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STT_EXCEPTION
-- --------------------------------------------------
CREATE TABLE [dbo].[STT_EXCEPTION]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EFFDATE_FROM] DATETIME NULL,
    [EFFDATE_TO] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.STT_EXCHG
-- --------------------------------------------------
CREATE TABLE [dbo].[STT_EXCHG]
(
    [RECTYPE] INT NOT NULL,
    [STT_DATE] DATETIME NOT NULL,
    [TM_CODE] VARCHAR(15) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [INST_TYPE] VARCHAR(6) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [EXPIRYDATE] DATETIME NULL,
    [STRIKE_PRICE] MONEY NULL,
    [OPTION_TYPE] VARCHAR(6) NULL,
    [CA_LEVEL] INT NULL,
    [SQTY] INT NULL,
    [SAMT] NUMERIC(18, 4) NULL,
    [TSAMT_FUT] NUMERIC(18, 4) NULL,
    [TSAMT_OPT] NUMERIC(18, 4) NULL,
    [STT_FUT] NUMERIC(18, 4) NULL,
    [STT_OPT] NUMERIC(18, 4) NULL,
    [TOTALSTT] NUMERIC(18, 4) NULL,
    [STT_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.subbrokers
-- --------------------------------------------------
CREATE TABLE [dbo].[subbrokers]
(
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Name] VARCHAR(50) NULL,
    [Address1] CHAR(100) NULL,
    [Address2] CHAR(100) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(10) NULL,
    [Fax] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Reg_No] CHAR(30) NULL,
    [Registered] BIT NOT NULL,
    [Main_Sub] CHAR(1) NULL,
    [Email] CHAR(50) NULL,
    [Com_Perc] NUMERIC(36, 12) NULL,
    [Branch_Code] VARCHAR(10) NULL,
    [Contact_Person] VARCHAR(100) NULL,
    [REMPARTYCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.SUBBROKERS_29012016
-- --------------------------------------------------
CREATE TABLE [dbo].[SUBBROKERS_29012016]
(
    [Sub_Broker] VARCHAR(10) NOT NULL,
    [Name] CHAR(25) NOT NULL,
    [Address1] CHAR(25) NULL,
    [Address2] CHAR(25) NULL,
    [City] CHAR(20) NULL,
    [State] CHAR(15) NULL,
    [Nation] CHAR(15) NULL,
    [Zip] CHAR(10) NULL,
    [Fax] CHAR(15) NULL,
    [Phone1] CHAR(15) NULL,
    [Phone2] CHAR(15) NULL,
    [Reg_No] CHAR(30) NULL,
    [Registered] BIT NOT NULL,
    [Main_Sub] CHAR(1) NULL,
    [Email] CHAR(50) NULL,
    [Com_Perc] MONEY NULL,
    [Branch_code] VARCHAR(10) NULL,
    [Contact_Person] VARCHAR(25) NULL,
    [REMPARTYCODE] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_DETAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_DETAIL]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [PROCESS_DATE] DATETIME NOT NULL,
    [BUSINESS_DATE] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_TYPE] VARCHAR(30) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [PROCESS_ID] INT NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(10) NULL,
    [INTERNAL_PROCESS_ID] INT NULL,
    [SUB_PROCESS_ID] INT NULL,
    [PROCESS_START_DATE] DATETIME NOT NULL,
    [PROCESS_STARTED_DATE] DATETIME NOT NULL,
    [PROCESS_END_DATE] DATETIME NOT NULL,
    [PROCESS_ENDED_DATE] DATETIME NOT NULL,
    [PROCESS_FILE_NAME] VARBINARY(8000) NULL,
    [IS_DEPEND_ON_ORG] VARCHAR(20) NULL,
    [IS_DEPEND_ON] VARCHAR(20) NULL,
    [WAIT_PERIOD] VARCHAR(10) NULL,
    [APPROX_END_TIME] VARCHAR(10) NULL,
    [PROCESS_STATUS] INT NOT NULL,
    [PROCESS_HALTED_AT] INT NOT NULL,
    [PROCESS_HALTED_REASON] VARCHAR(200) NULL,
    [PROCESS_STATUS_ALERT] INT NULL,
    [PROCESS_STATUS_ALERT_COUNT] INT NULL,
    [PROCESS_STATUS_ALERT_INTERVAL] VARCHAR(10) NULL,
    [PROCESS_LAST_ALERT_DATE] DATETIME NULL,
    [PROCESS_OUTPUT_QUERY] VARCHAR(MAX) NULL,
    [ATTACHEMENT_FILE_NAME] VARCHAR(200) NULL,
    [PROCESS_ORDER_ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_EMAIL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_EMAIL]
(
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [TO_EMAIL_ID] VARCHAR(500) NULL,
    [CC_EMAIL_ID] VARCHAR(500) NULL,
    [BCC_EMAIL_ID] VARCHAR(500) NULL,
    [EMAIL_SEND_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_EMAIL_GROUP_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_EMAIL_GROUP_LOG]
(
    [SNO] NUMERIC(18, 0) IDENTITY(1,1) NOT NULL,
    [PROCESS_DATE] DATETIME NULL,
    [PROCESS_GROUP] VARCHAR(100) NULL,
    [EMAIL_SEND_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_EMAIL_GRP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_EMAIL_GRP]
(
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_GROUP] VARCHAR(100) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [TO_EMAIL_ID] VARCHAR(500) NULL,
    [CC_EMAIL_ID] VARCHAR(500) NULL,
    [BCC_EMAIL_ID] VARCHAR(500) NULL,
    [EMAIL_SEND_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_FILE
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_FILE]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [FLD_FILENAME] VARCHAR(200) NULL,
    [FLD_FILEDATE] DATETIME NULL,
    [PROCESS_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_AUTO_PROCESS_MASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_AUTO_PROCESS_MASTER]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [EXCHANGE] VARCHAR(3) NULL,
    [SEGMENT] VARCHAR(7) NULL,
    [PROCESS_TYPE] VARCHAR(30) NULL,
    [PROCESS_FOR] VARCHAR(30) NULL,
    [PROCESS_ID] INT NULL,
    [INTERNAL_PROCESS_ID] INT NULL,
    [SETT_NO] VARCHAR(20) NULL,
    [SETT_TYPE] VARCHAR(20) NULL,
    [IS_FILE_BASED] VARCHAR(1) NULL,
    [PROCESS_FREQ] VARCHAR(10) NULL,
    [PROCESS_START_TIME] VARCHAR(10) NULL,
    [PROCESS_END_TIME] VARCHAR(10) NULL,
    [PROCESS_REPEAT_INTERVAL] VARCHAR(10) NULL,
    [FILE_DWLOAD_LOCATION] VARBINARY(8000) NULL,
    [FILE_DWLOAD_NAME] VARBINARY(8000) NULL,
    [FILE_DWLOAD_USERID] VARBINARY(8000) NULL,
    [FILE_DWLOAD_PWD] VARBINARY(8000) NULL,
    [FILE_DWLOAD_MAP_DRIVE] VARCHAR(100) NULL,
    [PROCESS_FILE_PATH] VARBINARY(8000) NULL,
    [PROCESS_FILE_NAME] VARBINARY(8000) NULL,
    [PROCESS_FILE_MOVE_PATH] VARBINARY(8000) NULL,
    [PROCESS_SP_NAME] VARBINARY(8000) NULL,
    [PROCESS_CHECK_QUERY] VARBINARY(8000) NULL,
    [IS_DEPEND_ON] VARCHAR(20) NULL,
    [WAIT_PERIOD] VARCHAR(10) NULL,
    [APPROX_END_TIME] VARCHAR(10) NULL,
    [PROCESS_STATUS_ALERT] INT NULL,
    [PROCESS_STATUS_ALERT_INTERVAL] VARCHAR(10) NULL,
    [FILE_INTERNET_LOCATION] VARCHAR(500) NULL,
    [FILE_INTERNAL_ISS_PATH] VARCHAR(500) NULL,
    [PROCESS_OUTPUT_QUERY] VARCHAR(MAX) NULL,
    [IS_ATTACHEMENT] INT NULL,
    [OTHER_DBDETAILS] VARCHAR(200) NULL,
    [OTHER_PROCESS_FOR] VARCHAR(200) NULL,
    [PROCESS_ORDER_ID] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CLIENT_GST_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CLIENT_GST_DATA]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [BRANCH_CD] VARCHAR(10) NOT NULL,
    [SUB_BROKER] VARCHAR(10) NOT NULL,
    [LONG_NAME] VARCHAR(250) NULL,
    [L_ADDRESS1] VARCHAR(100) NULL,
    [L_ADDRESS2] VARCHAR(100) NULL,
    [L_ADDRESS3] VARCHAR(100) NULL,
    [L_CITY] VARCHAR(50) NULL,
    [L_STATE] VARCHAR(100) NULL,
    [L_ZIP] VARCHAR(10) NULL,
    [L_NATION] VARCHAR(15) NULL,
    [GST_NO] VARCHAR(20) NULL,
    [GST_LOCATION] VARCHAR(100) NULL,
    [EFF_FROM_DATE] DATETIME NOT NULL,
    [EFF_TO_DATE] DATETIME NOT NULL,
    [CREATED_ON] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_CLIENTMARGIN
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_CLIENTMARGIN]
(
    [Party_Code] VARCHAR(15) NOT NULL,
    [Margindate] DATETIME NOT NULL,
    [Billamount] MONEY NOT NULL,
    [Ledgeramount] MONEY NOT NULL,
    [Cash_Coll] MONEY NOT NULL,
    [Noncash_Coll] MONEY NOT NULL,
    [Initialmargin] MONEY NOT NULL,
    [Lst_Update_Dt] DATETIME NOT NULL,
    [Short_Name] VARCHAR(100) NULL,
    [Long_Name] VARCHAR(100) NULL,
    [Branch_Cd] VARCHAR(20) NULL,
    [Family] VARCHAR(20) NULL,
    [Sub_Broker] VARCHAR(20) NULL,
    [Trader] VARCHAR(20) NULL,
    [Mtmmargin] MONEY NULL,
    [ActNoncash_Coll] MONEY NULL,
    [Client_Ctgry] VARCHAR(10) NULL,
    [AddMargin] MONEY NULL,
    [UNCLEARAMOUNT] MONEY NULL,
    [MRG_REP_COLL_CASH] MONEY NULL,
    [MRG_REP_COLL_NCASH] MONEY NULL,
    [PREV_BILLAMOUNT] MONEY NULL,
    [PREMIUM_MARGIN] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_COLLATERAL_MARGIN
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_COLLATERAL_MARGIN]
(
    [EFFDATE] DATETIME NULL,
    [PARTY_CODE] VARCHAR(10) NULL,
    [CASH] MONEY NULL,
    [NONCASH] MONEY NULL,
    [SCRIP_CD] VARCHAR(12) NULL,
    [SERIES] VARCHAR(3) NULL,
    [ISIN] VARCHAR(20) NULL,
    [CL_RATE] MONEY NULL,
    [AMOUNT] MONEY NULL,
    [QTY] NUMERIC(18, 4) NULL,
    [HAIRCUT] MONEY NULL,
    [FINALAMOUNT] MONEY NULL,
    [PERCENTAGECASH] NUMERIC(18, 2) NULL,
    [PERECNTAGENONCASH] NUMERIC(18, 2) NULL,
    [COLL_TYPE] VARCHAR(6) NULL,
    [CASH_NCASH] VARCHAR(2) NULL,
    [FD_BG_NO] VARCHAR(20) NULL,
    [BANK_CODE] VARCHAR(15) NULL,
    [FD_TYPE] VARCHAR(1) NULL,
    [UPDATEDON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_FOSCRIPMAP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_FOSCRIPMAP]
(
    [N_INST_TYPE] VARCHAR(6) NOT NULL,
    [N_SYMBOL] VARCHAR(12) NOT NULL,
    [N_EXPIRYDATE] SMALLDATETIME NOT NULL,
    [N_STRIKE_PRICE] MONEY NOT NULL,
    [N_OPTION_TYPE] VARCHAR(2) NOT NULL,
    [B_INST_TYPE] VARCHAR(6) NOT NULL,
    [B_SYMBOL] VARCHAR(12) NOT NULL,
    [B_EXPIRYDATE] SMALLDATETIME NOT NULL,
    [B_STRIKE_PRICE] MONEY NOT NULL,
    [B_OPTION_TYPE] VARCHAR(2) NOT NULL,
    [M_INST_TYPE] VARCHAR(6) NOT NULL,
    [M_SYMBOL] VARCHAR(12) NOT NULL,
    [M_EXPIRYDATE] SMALLDATETIME NOT NULL,
    [M_STRIKE_PRICE] MONEY NOT NULL,
    [M_OPTION_TYPE] VARCHAR(2) NOT NULL,
    [INST_TYPE] VARCHAR(6) NOT NULL,
    [SYMBOL] VARCHAR(12) NOT NULL,
    [EXPIRYDATE] SMALLDATETIME NOT NULL,
    [STRIKE_PRICE] MONEY NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NOT NULL,
    [EFF_FROM] DATETIME NOT NULL,
    [EFF_TO] DATETIME NOT NULL,
    [UPLOAD_ON] DATETIME NOT NULL,
    [UPLOAD_BY] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_FOSCRIPMAP_TMP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_FOSCRIPMAP_TMP]
(
    [N_INST_TYPE] VARCHAR(6) NOT NULL,
    [N_SYMBOL] VARCHAR(12) NOT NULL,
    [N_EXPIRYDATE] VARCHAR(12) NOT NULL,
    [N_STRIKE_PRICE] VARCHAR(12) NOT NULL,
    [N_OPTION_TYPE] VARCHAR(2) NOT NULL,
    [B_INST_TYPE] VARCHAR(6) NOT NULL,
    [B_SYMBOL] VARCHAR(12) NOT NULL,
    [B_EXPIRYDATE] VARCHAR(12) NOT NULL,
    [B_STRIKE_PRICE] VARCHAR(12) NOT NULL,
    [B_OPTION_TYPE] VARCHAR(2) NOT NULL,
    [M_INST_TYPE] VARCHAR(6) NOT NULL,
    [M_SYMBOL] VARCHAR(12) NOT NULL,
    [M_EXPIRYDATE] VARCHAR(12) NOT NULL,
    [M_STRIKE_PRICE] VARCHAR(12) NOT NULL,
    [M_OPTION_TYPE] VARCHAR(2) NOT NULL,
    [INST_TYPE] VARCHAR(6) NOT NULL,
    [SYMBOL] VARCHAR(12) NOT NULL,
    [EXPIRYDATE] VARCHAR(12) NOT NULL,
    [STRIKE_PRICE] VARCHAR(12) NOT NULL,
    [OPTION_TYPE] VARCHAR(2) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_GST_LOCATION
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_GST_LOCATION]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [LOC_CODE] VARCHAR(20) NULL,
    [LOCATION] VARCHAR(80) NULL,
    [LONG_NAME] VARCHAR(100) NULL,
    [ADDRESS1] VARCHAR(100) NULL,
    [ADDRESS2] VARCHAR(100) NULL,
    [CITY] VARCHAR(50) NULL,
    [STATE] VARCHAR(50) NULL,
    [NATION] VARCHAR(50) NULL,
    [ZIP] VARCHAR(30) NULL,
    [PHONE1] VARCHAR(30) NULL,
    [PHONE2] VARCHAR(30) NULL,
    [FAX] VARCHAR(30) NULL,
    [EMAIL] VARCHAR(100) NULL,
    [GST_NO] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_INTEROP_SETTING
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_INTEROP_SETTING]
(
    [CLEARINGCODE] VARCHAR(10) NULL,
    [FROM_DATE] DATETIME NULL,
    [TO_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_STATE_GST_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_STATE_GST_DATA]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [STATE_NAME] VARCHAR(50) NULL,
    [STATE_CODE] VARCHAR(10) NULL,
    [TIN_NO] VARCHAR(10) NULL,
    [UTI_FLAG] INT NULL,
    [GST_PER] NUMERIC(18, 4) NULL,
    [CGST_PER] NUMERIC(18, 4) NULL,
    [SGST_PER] NUMERIC(18, 4) NULL,
    [IGST_PER] NUMERIC(18, 4) NULL,
    [UGST_PER] NUMERIC(18, 4) NULL,
    [AGST_PER] NUMERIC(18, 4) NULL,
    [EFF_FROM_DATE] DATETIME NULL,
    [EFF_TO_DATE] DATETIME NULL,
    [ADDED_BY] VARCHAR(50) NULL,
    [ADDED_ON] DATETIME NULL,
    [MODIFY_BY] VARCHAR(50) NULL,
    [MODIFY_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_TURN_OVER_SLAB
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_TURN_OVER_SLAB]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [INST_TYPE] VARCHAR(3) NULL,
    [FROMDATE] DATETIME NULL,
    [TODATE] DATETIME NULL,
    [TOT_LOW_LIMIT] NUMERIC(18, 6) NULL,
    [TOT_UP_LIMIT] NUMERIC(18, 6) NULL,
    [TOT_PER] NUMERIC(18, 12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_TURNOVER_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_TURNOVER_DATA]
(
    [SAUDA_DATE] DATETIME NULL,
    [TURNOVER_AMT] NUMERIC(18, 4) NULL,
    [PROCESSED_ON] DATETIME NULL,
    [INST_TYPE] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBL_TURNOVER_TAX
-- --------------------------------------------------
CREATE TABLE [dbo].[TBL_TURNOVER_TAX]
(
    [SNO] INT IDENTITY(1,1) NOT NULL,
    [REC_FOR] VARCHAR(10) NULL,
    [FROM_LIMIT] NUMERIC(18, 4) NULL,
    [TO_LIMIT] NUMERIC(18, 4) NULL,
    [CHARGE_TAX] NUMERIC(18, 4) NULL,
    [EXCLUDE_GRP_TYPE_NO] INT NULL,
    [EXCLUDE_SETT_TYPE_NO] INT NULL,
    [EFF_FROM_DATE] DATETIME NULL,
    [EFF_TO_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLADMIN
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLADMIN]
(
    [fldauto_admin] INT IDENTITY(1,1) NOT NULL,
    [fldname] NVARCHAR(30) NOT NULL,
    [fldpassword] VARCHAR(512) NULL,
    [fldcompany] NVARCHAR(50) NULL,
    [fldstname] NVARCHAR(50) NULL,
    [fldstatus] NVARCHAR(25) NOT NULL,
    [flddesc] NVARCHAR(100) NULL,
    [Pwd_Expiry_Date] DATETIME NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDUSERSTATUS] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDROLE] SMALLINT NULL,
    [FLDRIGHTS] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLADMIN_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLADMIN_LOG]
(
    [Fldauto_Admin] INT NOT NULL,
    [Fldname] VARCHAR(30) NOT NULL,
    [Fldpassword] VARCHAR(512) NULL,
    [Fldcompany] VARCHAR(50) NULL,
    [Fldstname] VARCHAR(50) NULL,
    [Fldstatus] VARCHAR(25) NOT NULL,
    [Flddesc] VARCHAR(100) NULL,
    [Pwd_Expiry_Date] DATETIME NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDUSERSTATUS] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDROLE] SMALLINT NULL,
    [FLDRIGHTS] SMALLINT NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL,
    [MACHINEIP] VARCHAR(20) NULL,
    [FLDLOG_DATA] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLADMINCONFIG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLADMINCONFIG]
(
    [Fldauto] INT IDENTITY(1,1) NOT NULL,
    [Fldadmin] VARCHAR(50) NULL,
    [Fldflag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLADMINPASSHIST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLADMINPASSHIST]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDADMINID] INT NULL,
    [FLDOLDPASSLISTING] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCATEGORY
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCATEGORY]
(
    [fldcategorycode] INT IDENTITY(1,1) NOT NULL,
    [fldcategoryname] NVARCHAR(50) NOT NULL,
    [fldadminauto] INT NULL,
    [flddesc] NVARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCATEGORY_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCATEGORY_LOG]
(
    [Fldcategorycode] INT NOT NULL,
    [Fldcategoryname] VARCHAR(50) NOT NULL,
    [Fldadminauto] INT NULL,
    [Flddesc] VARCHAR(80) NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCATMENU
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCATMENU]
(
    [fldauto] INT IDENTITY(1,1) NOT NULL,
    [fldreportcode] INT NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldcategorycode] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCATMENU_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCATMENU_LOG]
(
    [Fldreportcode] INT NOT NULL,
    [Fldadminauto] INT NOT NULL,
    [Fldcategorycode_OLD] VARCHAR(2000) NULL,
    [Fldcategorycode_NEW] VARCHAR(2000) NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL,
    [MACHINE_IP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCLASSADMINLOGINS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCLASSADMINLOGINS]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDAUTO] BIGINT NULL,
    [FLDADMINNAME] VARCHAR(50) NULL,
    [FLDSTATUS] VARCHAR(25) NULL,
    [FLDSTNAME] VARCHAR(50) NULL,
    [FLDSESSION] VARCHAR(200) NULL,
    [FLDIPADDRESS] VARCHAR(20) NULL,
    [FLDLASTVISIT] DATETIME NULL,
    [FLDTIMEOUTPRD] INT NULL,
    [FLDLASTLOGIN] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLCLASSUSERLOGINS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLCLASSUSERLOGINS]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDAUTO] BIGINT NULL,
    [FLDUSERNAME] VARCHAR(50) NULL,
    [FLDSTATUS] VARCHAR(25) NULL,
    [FLDSTNAME] VARCHAR(50) NULL,
    [FLDSESSION] VARCHAR(200) NULL,
    [FLDIPADDRESS] VARCHAR(20) NULL,
    [FLDLASTVISIT] DATETIME NULL,
    [FLDTIMEOUTPRD] INT NULL,
    [FLDLASTLOGIN] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLEXCHANGEFILE
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLEXCHANGEFILE]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [FILE_NAME] VARCHAR(50) NULL,
    [DESCRIPTION] VARCHAR(100) NULL,
    [FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLGLOBALPARAMS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLGLOBALPARAMS]
(
    [FLDPWDMINLENGTH] SMALLINT NULL,
    [FLDPWDMAXLENGTH] SMALLINT NULL,
    [FLDSPCLCHAR] CHAR(1) NULL,
    [FLDENCRYPTION] CHAR(1) NULL,
    [FLDBLOCKPWD] VARCHAR(255) NULL,
    [FLDDELBLOCK] CHAR(1) NULL,
    [fldlastins] BIGINT NULL,
    [fldlastdel] BIGINT NULL,
    [fldlastupdt] BIGINT NULL,
    [fldupdtdate] DATETIME NULL,
    [fldclientMakerCheker] INT NULL,
    [fldAutoCodeGenerate] INT NULL,
    [fldflag] VARCHAR(3) NULL,
    [fldreportflag] VARCHAR(3) NULL,
    [fldCheckClientProcess] VARCHAR(1) NULL,
    [fldBranchAdd] TINYINT NULL,
    [BranchFlag] CHAR(1) NULL,
    [FldPwdAlphaNumOnly] INT NULL,
    [FLDOLDPASSWORD] TINYINT NULL,
    [FLDPANVALIDATION] CHAR(1) NULL,
    [FLDPARTYCODEBY] VARCHAR(10) NULL,
    [ALLOW_MULTI_LOGIN] INT NULL,
    [MAX_REJECTION_ALLOW] SMALLINT NULL,
    [MAC_ID_VALIDATION] INT NULL,
    [MKCKFLAG] SMALLINT NULL,
    [FldAddRpt] SMALLINT NULL,
    [FldCaptcha] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLMENUHEAD
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLMENUHEAD]
(
    [fldmenucode] NVARCHAR(20) NULL,
    [fldmenuname] NVARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLPRADNYAUSERS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLPRADNYAUSERS]
(
    [fldauto] INT IDENTITY(1,1) NOT NULL,
    [fldusername] NVARCHAR(25) NULL,
    [fldpassword] VARCHAR(512) NULL,
    [fldfirstname] NVARCHAR(25) NULL,
    [fldmiddlename] NVARCHAR(25) NULL,
    [fldlastname] NVARCHAR(25) NULL,
    [fldsex] NVARCHAR(8) NULL,
    [fldaddress1] VARCHAR(100) NULL,
    [fldaddress2] VARCHAR(100) NULL,
    [fldphone1] NVARCHAR(10) NULL,
    [fldphone2] NVARCHAR(10) NULL,
    [fldcategory] NVARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstname] NVARCHAR(50) NULL,
    [PWD_EXPIRY_DATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLPRADNYAUSERS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLPRADNYAUSERS_LOG]
(
    [Fldauto] INT NOT NULL,
    [Fldusername] VARCHAR(25) NULL,
    [Fldpassword] VARCHAR(512) NULL,
    [Fldfirstname] VARCHAR(25) NULL,
    [Fldmiddlename] VARCHAR(25) NULL,
    [Fldlastname] VARCHAR(25) NULL,
    [Fldsex] VARCHAR(8) NULL,
    [Fldaddress1] VARCHAR(100) NULL,
    [Fldaddress2] VARCHAR(100) NULL,
    [Fldphone1] VARCHAR(10) NULL,
    [Fldphone2] VARCHAR(10) NULL,
    [Fldcategory] VARCHAR(10) NOT NULL,
    [Fldadminauto] INT NOT NULL,
    [Fldstname] VARCHAR(50) NULL,
    [Pwd_Expiry_Date] DATETIME NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL,
    [MachineIP] VARCHAR(20) NULL,
    [FLDLOG_DATA] VARCHAR(8000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLREPORTGRP
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLREPORTGRP]
(
    [fldreportgrp] INT IDENTITY(1,1) NOT NULL,
    [fldgrpname] NVARCHAR(35) NULL,
    [fldmenugrp] NVARCHAR(3) NULL,
    [flddesc] NVARCHAR(80) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLREPORTGRP_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLREPORTGRP_LOG]
(
    [Fldreportgrp] INT NOT NULL,
    [Fldgrpname] VARCHAR(35) NULL,
    [Fldmenugrp] VARCHAR(3) NULL,
    [Flddesc] VARCHAR(80) NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLREPORTS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLREPORTS]
(
    [fldreportcode] INT IDENTITY(1,1) NOT NULL,
    [fldreportname] NVARCHAR(50) NULL,
    [fldpath] NVARCHAR(100) NULL,
    [fldtarget] NVARCHAR(25) NULL,
    [flddesc] NVARCHAR(80) NULL,
    [fldreportgrp] NVARCHAR(10) NULL,
    [fldmenugrp] NVARCHAR(3) NULL,
    [fldstatus] NVARCHAR(20) NULL,
    [fldorder] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLREPORTS_BLOCKED
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLREPORTS_BLOCKED]
(
    [fldusername] VARCHAR(25) NOT NULL,
    [fldcategory] VARCHAR(10) NOT NULL,
    [fldadminauto] INT NOT NULL,
    [fldstatus] VARCHAR(25) NOT NULL,
    [Block_Flag] INT NOT NULL,
    [Fldreportcode] INT NOT NULL,
    [fldpath] VARCHAR(100) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLREPORTS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLREPORTS_LOG]
(
    [Fldreportcode] INT NOT NULL,
    [Fldreportname] VARCHAR(35) NULL,
    [Fldpath] VARCHAR(500) NULL,
    [Fldtarget] VARCHAR(25) NULL,
    [Flddesc] VARCHAR(80) NULL,
    [Fldreportgrp] VARCHAR(10) NULL,
    [Fldmenugrp] VARCHAR(3) NULL,
    [Fldstatus] VARCHAR(20) NULL,
    [Fldorder] INT NOT NULL,
    [EDIT_FLAG] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(30) NULL,
    [CREATED_ON] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERBLOCK
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERBLOCK]
(
    [FLDAUTO] INT NOT NULL,
    [FLDNAME] VARCHAR(25) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERCONTROLGLOBALS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERCONTROLGLOBALS]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDCATEGORYID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERCONTROLMASTER
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERCONTROLMASTER]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDUSERID] INT NOT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERCONTROLMASTER_JRNL
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERCONTROLMASTER_JRNL]
(
    [FLDAUTO] BIGINT NULL,
    [FLDUSERID] INT NULL,
    [FLDPWDEXPIRY] INT NULL,
    [FLDMAXATTEMPT] SMALLINT NULL,
    [FLDATTEMPTCNT] SMALLINT NULL,
    [FLDSTATUS] SMALLINT NULL,
    [FLDLOGINFLAG] SMALLINT NULL,
    [FLDACCESSLVL] CHAR(1) NULL,
    [FLDIPADD] VARCHAR(2000) NULL,
    [FLDTIMEOUT] SMALLINT NULL,
    [FLDFIRSTLOGIN] CHAR(1) NULL,
    [FLDFORCELOGOUT] SMALLINT NULL,
    [FLDUPDTBY] VARCHAR(64) NULL,
    [FLDUPDTDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERPASSHIST
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERPASSHIST]
(
    [FLDAUTO] BIGINT IDENTITY(1,1) NOT NULL,
    [FLDUSERID] INT NULL,
    [FLDOLDPASSLISTING] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERS
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERS]
(
    [FLDAUTO] INT IDENTITY(1,1) NOT NULL,
    [PRADNYAAUTO] INT NULL,
    [REMARK] VARCHAR(200) NULL,
    [MAX_EDIT] TINYINT NULL,
    [BLOCK] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TBLUSERS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[TBLUSERS_LOG]
(
    [FLDAUTO] INT NULL,
    [PRADNYAAUTO] INT NULL,
    [REMARK] VARCHAR(200) NULL,
    [MAX_EDIT] TINYINT NULL,
    [BLOCK] CHAR(1) NULL,
    [CREATED_BY] VARCHAR(20) NULL,
    [CREATED_ON] DATETIME NULL,
    [MACHINEIP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TERMLIMIT
-- --------------------------------------------------
CREATE TABLE [dbo].[TERMLIMIT]
(
    [USERID] VARCHAR(50) NOT NULL,
    [TRADELIMIT] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TermLimit_Log
-- --------------------------------------------------
CREATE TABLE [dbo].[TermLimit_Log]
(
    [USERID] VARCHAR(50) NULL,
    [TRADELIMIT] MONEY NULL,
    [MODIFIEDBY] VARCHAR(50) NULL,
    [MODIFIEDON] DATETIME NULL,
    [MODE] VARCHAR(10) NULL,
    [flag] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TERMPARTY
-- --------------------------------------------------
CREATE TABLE [dbo].[TERMPARTY]
(
    [USERID] CHAR(10) NOT NULL,
    [PARTY_CODE] CHAR(10) NOT NULL,
    [TMARK] VARCHAR(1) NULL,
    [SCHEME] VARCHAR(2) NULL,
    [PROCLI] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TRD_CONTRACT_ROUNDING
-- --------------------------------------------------
CREATE TABLE [dbo].[TRD_CONTRACT_ROUNDING]
(
    [CR_SrNo] INT NOT NULL,
    [CR_Party_Code] VARCHAR(10) NOT NULL,
    [CR_Min_ContractAmt] NUMERIC(36, 12) NULL,
    [CR_Max_ContractAmt] NUMERIC(36, 12) NULL,
    [CR_Date_From] DATETIME NOT NULL,
    [CR_Date_To] DATETIME NOT NULL,
    [CR_CreatedBy] VARCHAR(20) NOT NULL,
    [CR_CreatedOn] DATETIME NOT NULL,
    [CR_ModifiedBy] VARCHAR(20) NOT NULL,
    [CR_ModifiedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TRD_FOSETTLEMENT
-- --------------------------------------------------
CREATE TABLE [dbo].[TRD_FOSETTLEMENT]
(
    [T_SAUDADATE] VARCHAR(30) NULL,
    [T_PARTY_CODE] VARCHAR(10) NOT NULL,
    [T_INST_TYPE] VARCHAR(6) NULL,
    [T_SYMBOL] VARCHAR(12) NULL,
    [T_EXPIRYDATE] SMALLDATETIME NULL,
    [T_OPTION_TYPE] VARCHAR(2) NULL,
    [T_STRIKE_PRICE] MONEY NULL,
    [T_AUCTIONPART] VARCHAR(2) NULL,
    [TOT_BUYTURNOVER] MONEY NULL,
    [TOT_SELLTURNOVER] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TRD_SCHEME_MAPPING
-- --------------------------------------------------
CREATE TABLE [dbo].[TRD_SCHEME_MAPPING]
(
    [SP_SrNo] INT NOT NULL,
    [SP_Party_Code] VARCHAR(10) NOT NULL,
    [SP_Computation_Level] CHAR(1) NOT NULL,
    [SP_Inst_Type] VARCHAR(3) NOT NULL,
    [SP_Scrip] VARCHAR(12) NOT NULL,
    [SP_Scheme_Id] INT NOT NULL,
    [SP_Trd_Type] VARCHAR(3) NOT NULL,
    [SP_Scheme_Type] CHAR(1) NOT NULL,
    [SP_Multiplier] NUMERIC(36, 12) NULL,
    [SP_Buy_Brok_Type] CHAR(1) NULL,
    [SP_Sell_Brok_Type] CHAR(1) NULL,
    [SP_Buy_Brok] NUMERIC(18, 10) NOT NULL,
    [SP_Sell_Brok] NUMERIC(18, 10) NOT NULL,
    [SP_Res_Multiplier] NUMERIC(36, 12) NULL,
    [SP_Res_Buy_Brok] NUMERIC(18, 10) NOT NULL,
    [SP_Res_Sell_Brok] NUMERIC(36, 12) NULL,
    [SP_Value_From] NUMERIC(36, 12) NULL,
    [SP_Value_To] NUMERIC(36, 12) NULL,
    [SP_TurnOverOn] VARCHAR(7) NOT NULL,
    [SP_Brok_ComputeOn] CHAR(1) NOT NULL,
    [SP_Brok_ComputeType] CHAR(1) NOT NULL,
    [SP_Min_BrokAmt] NUMERIC(36, 12) NULL,
    [SP_Max_BrokAmt] NUMERIC(36, 12) NULL,
    [SP_Min_ScripAmt] NUMERIC(36, 12) NULL,
    [SP_Max_ScripAmt] NUMERIC(36, 12) NULL,
    [SP_Date_From] DATETIME NOT NULL,
    [SP_Date_To] DATETIME NOT NULL,
    [SP_CreatedBy] VARCHAR(20) NOT NULL,
    [SP_CreatedOn] DATETIME NOT NULL,
    [SP_ModifiedBy] VARCHAR(20) NOT NULL,
    [SP_ModifiedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TURNTAX_EXCEPTION
-- --------------------------------------------------
CREATE TABLE [dbo].[TURNTAX_EXCEPTION]
(
    [INST_TYPE] VARCHAR(7) NULL,
    [SYMBOL] VARCHAR(12) NULL,
    [SEC_NAME] VARCHAR(25) NULL,
    [EFFDATE_FROM] DATETIME NULL,
    [EFFDATE_TO] DATETIME NULL,
    [MIN_TURNOVER] MONEY NULL,
    [TAX_PERC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.UCC_CLIENT
-- --------------------------------------------------
CREATE TABLE [dbo].[UCC_CLIENT]
(
    [Party_Code] VARCHAR(10) NOT NULL,
    [Client_Name] VARCHAR(100) NOT NULL,
    [Contract_Person] VARCHAR(60) NULL,
    [Clearingno1] VARCHAR(4) NULL,
    [Clearingno2] VARCHAR(4) NULL,
    [Clearingno3] VARCHAR(4) NULL,
    [Clearingno4] VARCHAR(4) NULL,
    [Mapidid] VARCHAR(12) NULL,
    [Fmcode] VARCHAR(10) NULL,
    [Dealing_With_Othrer_Tm] VARCHAR(50) NULL,
    [Any_Other_Acc] VARCHAR(50) NULL,
    [Family_Code1] VARCHAR(10) NULL,
    [Family_Code2] VARCHAR(10) NULL,
    [Family_Code3] VARCHAR(10) NULL,
    [Family_Code4] VARCHAR(10) NULL,
    [Remark] VARCHAR(100) NULL,
    [Ucc_Code] VARCHAR(16) NULL,
    [Stpprovider] VARCHAR(100) NULL,
    [Dummy1] VARCHAR(10) NULL,
    [Dummy2] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Bill_Digital_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Bill_Digital_DATA]
(
    [C_SR_NO] NUMERIC(10, 0) IDENTITY(1,1) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_Bill_Digital_text
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_Bill_Digital_text]
(
    [C_SR_NO] NUMERIC(10, 0) NOT NULL,
    [C_TEXT] VARCHAR(500) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_BillPrint_Setting
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_BillPrint_Setting]
(
    [Rpt_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Rpt_Code] VARCHAR(20) NOT NULL,
    [Rpt_Desc] VARCHAR(300) NULL,
    [Rpt_XPos] NUMERIC(10, 0) NULL,
    [Rpt_YPos] NUMERIC(18, 0) NULL,
    [Rpt_Width] NUMERIC(10, 0) NULL,
    [Rpt_Align] CHAR(1) NULL,
    [Rpt_PrintFlag] SMALLINT NULL,
    [Rpt_PrintFlag_Inst] SMALLINT NULL,
    [Rpt_PrintFlag_Dvp] SMALLINT NULL,
    [Rpt_PrintFlag_Digi] SMALLINT NULL,
    [Rpt_Rounding] TINYINT NULL,
    [Rpt_Type] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_BUSINESS_PROCESS
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_BUSINESS_PROCESS]
(
    [Business_Date] SMALLDATETIME NULL,
    [Import_Trade] INT NULL,
    [VBB] INT NULL,
    [STT] INT NULL,
    [Billing] INT NULL,
    [Contract] INT NULL,
    [Posting] INT NULL,
    [PositionFile] INT NULL,
    [MarginFile] INT NULL,
    [MarginReturnFile] INT NULL,
    [ClientMarginPop] INT NULL,
    [ExchangeSTT] INT NULL,
    [ExerciseAllocation] INT NULL,
    [Open_Close] INT NULL,
    [ProcessDate] DATETIME NULL,
    [ProcessBy] VARCHAR(20) NULL,
    [LastUpdateDate] DATETIME NULL,
    [LastUpdateBy] VARCHAR(20) NULL,
    [MachineIP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CLIENTBROK_SCHEME
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CLIENTBROK_SCHEME]
(
    [SCHEME_ID] DECIMAL(18, 0) IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [TABLE_NO] VARCHAR(5) NOT NULL,
    [SCHEME_TYPE] VARCHAR(5) NOT NULL,
    [SCRIP_CD] VARCHAR(12) NOT NULL,
    [TRADE_TYPE] VARCHAR(3) NOT NULL,
    [BROKSCHEME] VARCHAR(1) NOT NULL,
    [FROM_DATE] DATETIME NOT NULL,
    [TO_DATE] DATETIME NOT NULL,
    [ROUND_TO] INT NULL,
    [ROFIG] INT NULL,
    [ERRNUM] NUMERIC(19, 8) NULL,
    [NOZERO] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CONTRACT_DIGITAL_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CONTRACT_DIGITAL_DATA]
(
    [C_SR_NO] NUMERIC(10, 0) IDENTITY(1,1) NOT NULL,
    [C_TEXT] VARCHAR(2000) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_CONTRACT_DIGITAL_TEXT
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_CONTRACT_DIGITAL_TEXT]
(
    [C_SR_NO] NUMERIC(10, 0) NOT NULL,
    [C_TEXT] VARCHAR(500) NULL,
    [C_Type] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_contractprint_setting
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_contractprint_setting]
(
    [Rpt_SrNo] INT IDENTITY(1,1) NOT NULL,
    [Rpt_Code] VARCHAR(30) NULL,
    [Rpt_Desc] VARCHAR(500) NULL,
    [Rpt_XPos] DECIMAL(10, 0) NULL,
    [Rpt_YPos] DECIMAL(18, 0) NULL,
    [Rpt_Width] DECIMAL(10, 0) NULL,
    [Rpt_Align] CHAR(1) NULL,
    [Rpt_PrintFlag] SMALLINT NULL,
    [Rpt_PrintFlag_Inst] SMALLINT NULL,
    [Rpt_PrintFlag_Dvp] SMALLINT NULL,
    [Rpt_PrintFlag_Digi] SMALLINT NULL,
    [Rpt_Rounding] TINYINT NULL,
    [Rpt_Type] VARCHAR(10) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_DIGITAL_FILE_NAME
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_DIGITAL_FILE_NAME]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [D_Type] VARCHAR(15) NULL,
    [D_Name] VARCHAR(10) NULL,
    [D_Description] VARCHAR(30) NULL,
    [D_Value] VARCHAR(15) NULL,
    [D_Order] INT NULL,
    [D_Seprater] VARCHAR(3) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_INST_PARTYMAPPING
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_INST_PARTYMAPPING]
(
    [PARTY_CODE] VARCHAR(15) NULL,
    [RPT_REPORT_NO] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_INST_PARTYMAPPINGLOG
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_INST_PARTYMAPPINGLOG]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [PARTY_CODE] VARCHAR(15) NULL,
    [RPT_REPORT_NO] INT NULL,
    [ACTIONBY] VARCHAR(25) NULL,
    [MACHINENAME] VARCHAR(25) NULL,
    [ACTION] VARCHAR(10) NULL,
    [ACTIONDATE] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_InstReport_Setting
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_InstReport_Setting]
(
    [SrNo] INT IDENTITY(1,1) NOT NULL,
    [Rpt_Type] VARCHAR(10) NULL,
    [Rpt_Name] VARCHAR(50) NULL,
    [Rpt_Column] VARCHAR(500) NULL,
    [Rpt_Field] VARCHAR(500) NULL,
    [Rpt_Summaries] CHAR(3) NULL,
    [Rpt_FileName] VARCHAR(100) NULL,
    [Rpt_DateFormat] VARCHAR(25) NULL,
    [Rpt_SubTotal] VARCHAR(200) NULL,
    [Rpt_GrandTotal] VARCHAR(200) NULL,
    [Rpt_TopHeader] VARCHAR(500) NULL,
    [Rpt_Footer] VARCHAR(500) NULL,
    [Rpt_SQL_Proc1] VARCHAR(50) NULL,
    [Rpt_Delimiter] VARCHAR(50) NULL,
    [Rpt_BatchGen] VARCHAR(50) NULL,
    [Rpt_Incremental_Allowed] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LOGIN_ERR_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LOGIN_ERR_LOG]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [LOGIN_ID] VARCHAR(20) NULL,
    [LOGIN_PWD] VARCHAR(512) NULL,
    [IPADD] VARCHAR(20) NULL,
    [ERR_TYPE] VARCHAR(20) NULL,
    [LOGIN_TYPE] VARCHAR(10) NULL,
    [LOGIN_DT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_LOGIN_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_LOGIN_LOG]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [USERID] INT NULL,
    [USERNAME] VARCHAR(64) NULL,
    [CATEGORY] VARCHAR(64) NULL,
    [STATUSNAME] VARCHAR(32) NULL,
    [STATUSID] VARCHAR(32) NULL,
    [IPADD] VARCHAR(20) NULL,
    [ACTION] VARCHAR(6) NULL,
    [ADDDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_PROCESS_STATUS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_PROCESS_STATUS_LOG]
(
    [SNO] NUMERIC(9, 0) IDENTITY(1,1) NOT NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [BusinessDate] SMALLDATETIME NULL,
    [ProcessId] VARCHAR(10) NULL,
    [ProcessName] VARCHAR(50) NULL,
    [FileName] VARCHAR(255) NULL,
    [Start_End_Flag] INT NULL,
    [ProcessDate] DATETIME NULL,
    [ProcessBy] VARCHAR(64) NULL,
    [MachineIP] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.V2_REPORT_ACCESS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[V2_REPORT_ACCESS_LOG]
(
    [SNO] BIGINT IDENTITY(1,1) NOT NULL,
    [REPPATH] VARCHAR(4000) NULL,
    [USERID] INT NULL,
    [USERNAME] VARCHAR(50) NULL,
    [STATUSNAME] VARCHAR(32) NULL,
    [STATUSID] VARCHAR(32) NULL,
    [IPADD] VARCHAR(20) NULL,
    [ADDDT] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VALANACCOUNT
-- --------------------------------------------------
CREATE TABLE [dbo].[VALANACCOUNT]
(
    [AcCode] VARCHAR(10) NULL,
    [AcName] VARCHAR(50) NULL,
    [Reversed] INT NULL,
    [RevCode] VARCHAR(10) NULL,
    [OppCode] VARCHAR(10) NULL,
    [EffDate] SMALLDATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VBB_Charges_Detail
-- --------------------------------------------------
CREATE TABLE [dbo].[VBB_Charges_Detail]
(
    [CD_SrNo] INT IDENTITY(1,1) NOT NULL,
    [CD_Party_Code] VARCHAR(10) NOT NULL,
    [CD_Sauda_Date] DATETIME NOT NULL,
    [CD_Contract_No] VARCHAR(14) NOT NULL,
    [CD_Trade_No] VARCHAR(15) NOT NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Inst_Type] VARCHAR(6) NOT NULL,
    [CD_Symbol] VARCHAR(12) NOT NULL,
    [CD_Expiry_Date] DATETIME NOT NULL,
    [CD_Option_Type] VARCHAR(2) NOT NULL,
    [CD_Strike_Price] MONEY NULL,
    [CD_AuctionPart] VARCHAR(2) NOT NULL,
    [CD_MarketLot] INT NOT NULL,
    [CD_Scheme_Id] INT NOT NULL,
    [CD_ComputationLevel] CHAR(1) NOT NULL,
    [CD_ComputationOn] CHAR(1) NOT NULL,
    [CD_ComputationType] CHAR(1) NOT NULL,
    [CD_BuyRate] NUMERIC(36, 12) NULL,
    [CD_SellRate] NUMERIC(36, 12) NULL,
    [CD_Tot_BuyQty] NUMERIC(36, 0) NULL,
    [CD_Tot_SellQty] NUMERIC(36, 0) NULL,
    [CD_Tot_BuyTurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_SellTurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_BuyTurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_SellTurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_TurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_TurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_Lot] INT NOT NULL,
    [CD_Tot_Res_TurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_Res_TurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_Res_Lot] INT NOT NULL,
    [CD_Tot_BuyBrok] NUMERIC(36, 12) NULL,
    [CD_Tot_SellBrok] NUMERIC(36, 12) NULL,
    [CD_Tot_Brok] NUMERIC(36, 12) NULL,
    [CD_Tot_BuySerTax] NUMERIC(36, 12) NULL,
    [CD_Tot_SellSerTax] NUMERIC(36, 12) NULL,
    [CD_Tot_SerTax] NUMERIC(36, 12) NULL,
    [CD_Tot_Stt] NUMERIC(36, 12) NULL,
    [CD_Tot_Turn_Tax] NUMERIC(36, 12) NULL,
    [CD_Tot_Other_Chrg] NUMERIC(36, 12) NULL,
    [CD_Tot_Sebi_Tax] NUMERIC(36, 12) NULL,
    [CD_Tot_StampDuty] NUMERIC(36, 12) NULL,
    [CD_Exch_BuyRate] NUMERIC(36, 12) NULL,
    [CD_Exch_SellRate] NUMERIC(36, 12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VBB_Charges_Detail_Final
-- --------------------------------------------------
CREATE TABLE [dbo].[VBB_Charges_Detail_Final]
(
    [CD_Party_Code] VARCHAR(10) NULL,
    [CD_Sauda_Date] DATETIME NULL,
    [CD_Contract_No] VARCHAR(14) NULL,
    [CD_Trade_No] VARCHAR(15) NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Inst_Type] VARCHAR(6) NULL,
    [CD_Symbol] VARCHAR(12) NULL,
    [CD_Expiry_Date] DATETIME NULL,
    [CD_Option_Type] VARCHAR(2) NULL,
    [CD_Strike_Price] MONEY NULL,
    [CD_AuctionPart] VARCHAR(2) NULL,
    [CD_MarketLot] INT NULL,
    [CD_Scheme_Id] INT NULL,
    [CD_ComputationLevel] CHAR(1) NULL,
    [CD_ComputationOn] CHAR(1) NULL,
    [CD_ComputationType] CHAR(1) NULL,
    [CD_BuyRate] NUMERIC(36, 12) NULL,
    [CD_SellRate] NUMERIC(36, 12) NULL,
    [CD_Tot_BuyQty] NUMERIC(36, 0) NULL,
    [CD_Tot_SellQty] NUMERIC(36, 0) NULL,
    [CD_Tot_BuyTurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_SellTurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_BuyTurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_SellTurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_TurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_TurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_Lot] INT NULL,
    [CD_Tot_Res_TurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_Res_TurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_Res_Lot] INT NULL,
    [CD_Tot_BuyBrok] NUMERIC(36, 12) NULL,
    [CD_Tot_SellBrok] NUMERIC(36, 12) NULL,
    [CD_Tot_Brok] NUMERIC(36, 12) NULL,
    [CD_Tot_SerTax] NUMERIC(36, 12) NULL,
    [CD_Tot_Stt] NUMERIC(36, 12) NULL,
    [CD_Tot_Turn_Tax] NUMERIC(36, 12) NULL,
    [CD_Tot_Other_Chrg] NUMERIC(36, 12) NULL,
    [CD_Tot_Sebi_Tax] NUMERIC(36, 12) NULL,
    [CD_Tot_StampDuty] NUMERIC(36, 12) NULL,
    [CD_Exch_BuyRate] NUMERIC(36, 12) NULL,
    [CD_Exch_SellRate] NUMERIC(36, 12) NULL,
    [CD_Min_BrokAmt] NUMERIC(18, 10) NULL,
    [CD_Max_BrokAmt] NUMERIC(18, 10) NULL,
    [CD_Min_ScripAmt] NUMERIC(18, 10) NULL,
    [CD_Max_ScripAmt] NUMERIC(18, 10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VBB_Charges_Detail_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[VBB_Charges_Detail_Temp]
(
    [CD_Party_Code] VARCHAR(10) NULL,
    [CD_Sauda_Date] DATETIME NULL,
    [CD_Contract_No] VARCHAR(14) NULL,
    [CD_Trade_No] VARCHAR(15) NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Inst_Type] VARCHAR(6) NULL,
    [CD_Symbol] VARCHAR(12) NULL,
    [CD_Expiry_Date] DATETIME NULL,
    [CD_Option_Type] VARCHAR(2) NULL,
    [CD_Strike_Price] MONEY NULL,
    [CD_AuctionPart] VARCHAR(2) NULL,
    [CD_MarketLot] INT NULL,
    [CD_Scheme_Id] INT NULL,
    [CD_ComputationLevel] CHAR(1) NULL,
    [CD_ComputationOn] CHAR(1) NULL,
    [CD_ComputationType] CHAR(1) NULL,
    [CD_BuyRate] NUMERIC(36, 12) NULL,
    [CD_SellRate] NUMERIC(36, 12) NULL,
    [CD_Tot_BuyQty] NUMERIC(36, 0) NULL,
    [CD_Tot_SellQty] NUMERIC(36, 0) NULL,
    [CD_Tot_BuyTurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_SellTurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_BuyTurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_SellTurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_TurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_TurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_Lot] INT NULL,
    [CD_Tot_Res_TurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_Res_TurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_Res_Lot] INT NULL,
    [CD_Tot_BuyBrok] NUMERIC(36, 12) NULL,
    [CD_Tot_SellBrok] NUMERIC(36, 12) NULL,
    [CD_Tot_Brok] NUMERIC(36, 12) NULL,
    [CD_Tot_SerTax] NUMERIC(36, 12) NULL,
    [CD_Tot_Stt] NUMERIC(36, 12) NULL,
    [CD_Tot_Turn_Tax] NUMERIC(36, 12) NULL,
    [CD_Tot_Other_Chrg] NUMERIC(36, 12) NULL,
    [CD_Tot_Sebi_Tax] NUMERIC(36, 12) NULL,
    [CD_Tot_StampDuty] NUMERIC(36, 12) NULL,
    [CD_Exch_BuyRate] NUMERIC(36, 12) NULL,
    [CD_Exch_SellRate] NUMERIC(36, 12) NULL,
    [CD_Min_BrokAmt] NUMERIC(18, 10) NULL,
    [CD_Max_BrokAmt] NUMERIC(18, 10) NULL,
    [CD_Min_ScripAmt] NUMERIC(18, 10) NULL,
    [CD_Max_ScripAmt] NUMERIC(18, 10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VBB_Charges_Detail_Temp1
-- --------------------------------------------------
CREATE TABLE [dbo].[VBB_Charges_Detail_Temp1]
(
    [CD_Party_Code] VARCHAR(10) NULL,
    [CD_Sauda_Date] DATETIME NULL,
    [CD_Contract_No] VARCHAR(14) NULL,
    [CD_Trade_No] VARCHAR(15) NULL,
    [CD_Order_No] VARCHAR(20) NULL,
    [CD_Inst_Type] VARCHAR(6) NULL,
    [CD_Symbol] VARCHAR(12) NULL,
    [CD_Expiry_Date] DATETIME NULL,
    [CD_Option_Type] VARCHAR(2) NULL,
    [CD_Strike_Price] MONEY NULL,
    [CD_AuctionPart] VARCHAR(2) NULL,
    [CD_MarketLot] INT NULL,
    [CD_Scheme_Id] INT NULL,
    [CD_ComputationLevel] CHAR(1) NULL,
    [CD_ComputationOn] CHAR(1) NULL,
    [CD_ComputationType] CHAR(1) NULL,
    [CD_BuyRate] NUMERIC(36, 12) NULL,
    [CD_SellRate] NUMERIC(36, 12) NULL,
    [CD_Tot_BuyQty] NUMERIC(36, 0) NULL,
    [CD_Tot_SellQty] NUMERIC(36, 0) NULL,
    [CD_Tot_BuyTurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_SellTurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_BuyTurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_SellTurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_TurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_TurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_Lot] INT NULL,
    [CD_Tot_Res_TurnOver] NUMERIC(36, 12) NULL,
    [CD_Tot_Res_TurnOver_Rounded] NUMERIC(36, 12) NULL,
    [CD_Tot_Res_Lot] INT NULL,
    [CD_Tot_BuyBrok] NUMERIC(36, 12) NULL,
    [CD_Tot_SellBrok] NUMERIC(36, 12) NULL,
    [CD_Tot_Brok] NUMERIC(36, 12) NULL,
    [CD_Tot_SerTax] NUMERIC(36, 12) NULL,
    [CD_Tot_Stt] NUMERIC(36, 12) NULL,
    [CD_Tot_Turn_Tax] NUMERIC(36, 12) NULL,
    [CD_Tot_Other_Chrg] NUMERIC(36, 12) NULL,
    [CD_Tot_Sebi_Tax] NUMERIC(36, 12) NULL,
    [CD_Tot_StampDuty] NUMERIC(36, 12) NULL,
    [CD_Exch_BuyRate] NUMERIC(36, 12) NULL,
    [CD_Exch_SellRate] NUMERIC(36, 12) NULL,
    [CD_Min_BrokAmt] NUMERIC(18, 10) NULL,
    [CD_Max_BrokAmt] NUMERIC(18, 10) NULL,
    [CD_Min_ScripAmt] NUMERIC(18, 10) NULL,
    [CD_Max_ScripAmt] NUMERIC(18, 10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VBB_FoSettlement
-- --------------------------------------------------
CREATE TABLE [dbo].[VBB_FoSettlement]
(
    [BillNo] NUMERIC(36, 12) NULL,
    [Trade_no] VARCHAR(14) NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [Inst_type] VARCHAR(6) NULL,
    [Symbol] VARCHAR(12) NULL,
    [Expirydate] SMALLDATETIME NULL,
    [Strike_price] MONEY NULL,
    [Option_type] VARCHAR(2) NULL,
    [Tradeqty] NUMERIC(36, 0) NULL,
    [AuctionPart] VARCHAR(2) NULL,
    [Order_No] VARCHAR(20) NULL,
    [Price] NUMERIC(36, 12) NULL,
    [Sauda_date] DATETIME NOT NULL,
    [Sell_buy] INT NOT NULL,
    [ContractNo] VARCHAR(14) NULL,
    [Ins_Chrg] NUMERIC(36, 12) NULL,
    [Turn_Tax] NUMERIC(36, 12) NULL,
    [Other_Chrg] NUMERIC(36, 12) NULL,
    [Sebi_Tax] NUMERIC(36, 12) NULL,
    [Broker_Chrg] NUMERIC(36, 12) NULL,
    [Status] VARCHAR(2) NULL,
    [BrokApplied] NUMERIC(36, 12) NULL,
    [Service_Tax] NUMERIC(36, 12) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VBB_SCHEME_TEMP
-- --------------------------------------------------
CREATE TABLE [dbo].[VBB_SCHEME_TEMP]
(
    [VBB_PARTY_CODE] VARCHAR(10) NULL,
    [VBB_SCHEME_ID] INT NULL,
    [VBB_MIN_BROKAMT] NUMERIC(18, 0) NULL,
    [VBB_MAX_BROKAMT] NUMERIC(18, 0) NULL,
    [VBB_SCHEME_TYPE] CHAR(1) NULL
);

GO

-- --------------------------------------------------
-- VIEW dbo.BBGFOSETTBFVIEW
-- --------------------------------------------------
CREATE VIEW [dbo].[BBGFOSETTBFVIEW] AS
SELECT S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,PQTY=(CASE WHEN SELL_BUY = 1 THEN SUM(TRADEQTY) ELSE 0 END),
SQTY=(CASE WHEN SELL_BUY = 2 THEN SUM(TRADEQTY) ELSE 0 END),S.STRIKE_PRICE,S.OPTION_TYPE ,SAUDA_DATE = CONVERT(DATETIME , LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)) ,SETTFLAG 
FROM FOSETTLEMENT S ,CLIENT2 C WHERE S.PARTY_CODE = C.PARTY_CODE AND C.BROK_SCHEME IN ('20','21','22','23','24','25','26','27','28','29','30') 

GROUP BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE,
SELL_BUY,EXPIRYDATE  ,CONVERT(DATETIME , LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11))  ,SETTFLAG

GO

-- --------------------------------------------------
-- VIEW dbo.CHARGES_DETAIL_VIEW
-- --------------------------------------------------
CREATE  VIEW [dbo].[CHARGES_DETAIL_VIEW]  
AS  
  
SELECT 
	CD_CONTRACT_NO,
	CD_SAUDA_DATE,  
	CD_INST_TYPE,  
	CD_SYMBOL,  
	CD_EXPIRY_DATE,  
	CD_STRIKE_PRICE,  
	CD_OPTION_TYPE,  
	CD_ORDER_NO,  
	CD_TRADE_NO,  
	CD_PARTY_CODE,  
	CD_AUCTIONPART,  
	CD_TOTALBROKERAGE = SUM(CD_TOTALBROKERAGE),  
	CD_BUY_QTY = SUM(CD_TOT_BUYQTY),  
	CD_SELL_QTY= SUM(CD_TOT_SELLQTY),  
	CD_TOTALSERTAX = SUM(CD_TOT_SERTAX),  
	CD_BUYRATE,  
	CD_SELLRATE,
	TRD_TRADEQTY = SUM(TRD_TRADEQTY),
	CD_STATUS
FROM
	(
	SELECT  
		CD_CONTRACT_NO,
		CD_SAUDA_DATE,  
		CD_INST_TYPE,  
		CD_SYMBOL,  
		CD_EXPIRY_DATE,  
		CD_STRIKE_PRICE,  
		CD_OPTION_TYPE,  
		CD_ORDER_NO,  
		CD_TRADE_NO = TRADE_NO,  
		CD_PARTY_CODE,  
		CD_AUCTIONPART,  
		CD_TOTALBROKERAGE=CONVERT(NUMERIC(26,12),CD_TOT_BROK)/(CD_TOT_BUYQTY+CD_TOT_SELLQTY)*TRD_TRADEQTY,  
		CD_TOT_BUYQTY,  
		CD_TOT_SELLQTY,  
		CD_TOT_SERTAX = CONVERT(NUMERIC(26,12),CD_TOT_SERTAX)/(CD_TOT_BUYQTY+CD_TOT_SELLQTY)*TRD_TRADEQTY,  
		CD_BUYRATE ,  
		CD_SELLRATE,  
		TRD_TRADEQTY, 
		CD_STATUS 
	FROM   
		CHARGES_DETAIL (NOLOCK),  
		(SELECT   
			SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,112),   
			INST_TYPE,  
			SYMBOL,  
			EXPIRYDATE,  
			STRIKE_PRICE,  
			OPTION_TYPE,  
			ORDER_NO,  
			PARTY_CODE,  
			AUCTION_PART=AUCTIONPART,  
			TRADE_NO=PRADNYA.DBO.REPLACETRADENO(TRADE_NO),  
			TRD_TRADEQTY=SUM(TRADEQTY)   
		FROM  
			FOSETTLEMENT (NOLOCK)  
		WHERE  
			TRADEQTY > 0  
		GROUP BY  
			CONVERT(VARCHAR,SAUDA_DATE,112),
			INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
			AUCTIONPART,ORDER_NO,PARTY_CODE,PRADNYA.DBO.REPLACETRADENO(TRADE_NO)  
	 ) STLMNT  
	WHERE  
		SAUDA_DATE  =  CONVERT(VARCHAR,CD_SAUDA_DATE,112) AND  
		INST_TYPE = CD_INST_TYPE AND 
		SYMBOL = CD_SYMBOL AND
		EXPIRYDATE = CD_EXPIRY_DATE AND
		STRIKE_PRICE = CD_STRIKE_PRICE AND  
		OPTION_TYPE = CD_OPTION_TYPE AND
		ORDER_NO = CD_ORDER_NO AND   
		PARTY_CODE = CD_PARTY_CODE AND   
		AUCTION_PART = CD_AUCTIONPART AND  
		CD_TRADE_NO =''
	) SS	
GROUP BY
	CD_CONTRACT_NO,
	CD_SAUDA_DATE,  
	CD_INST_TYPE,  
	CD_SYMBOL,  
	CD_EXPIRY_DATE,  
	CD_STRIKE_PRICE,  
	CD_OPTION_TYPE,  
	CD_ORDER_NO,  
	CD_TRADE_NO,  
	CD_PARTY_CODE,  
	CD_AUCTIONPART,  
	CD_BUYRATE,  
	CD_SELLRATE, 
	CD_STATUS 

UNION ALL

SELECT 
	CD_CONTRACT_NO,
	CD_SAUDA_DATE,  
	CD_INST_TYPE,  
	CD_SYMBOL,  
	CD_EXPIRY_DATE,  
	CD_STRIKE_PRICE,  
	CD_OPTION_TYPE,  
	CD_ORDER_NO,  
	CD_TRADE_NO,  
	CD_PARTY_CODE,  
	CD_AUCTIONPART,  
	CD_TOTALBROKERAGE = SUM(CD_TOTALBROKERAGE),  
	CD_BUY_QTY = SUM(CD_TOT_BUYQTY),  
	CD_SELL_QTY= SUM(CD_TOT_SELLQTY),  
	CD_TOTALSERTAX = SUM(CD_TOT_SERTAX),  
	CD_BUYRATE,  
	CD_SELLRATE,
	TRD_TRADEQTY = SUM(TRD_TRADEQTY),
	CD_STATUS
FROM
	(
	SELECT  
		CD_CONTRACT_NO,
		CD_SAUDA_DATE,  
		CD_INST_TYPE=INST_TYPE,  
		CD_SYMBOL=SYMBOL,  
		CD_EXPIRY_DATE=EXPIRYDATE,  
		CD_STRIKE_PRICE=STRIKE_PRICE,  
		CD_OPTION_TYPE=OPTION_TYPE,  
		CD_ORDER_NO=ORDER_NO,  
		CD_TRADE_NO = TRADE_NO,  
		CD_PARTY_CODE,  
		CD_AUCTIONPART=AUCTION_PART,  
		CD_TOTALBROKERAGE=CONVERT(NUMERIC(26,12),CD_TOT_BROK)/(CD_TOT_BUYQTY+CD_TOT_SELLQTY)*TRD_TRADEQTY,  
		CD_TOT_BUYQTY=TRD_TRADEQTY,  
		CD_TOT_SELLQTY=TRD_TRADEQTY,  
		CD_TOT_SERTAX = CONVERT(NUMERIC(26,12),CD_TOT_SERTAX)/(CD_TOT_BUYQTY+CD_TOT_SELLQTY)*TRD_TRADEQTY,  
		CD_BUYRATE ,  
		CD_SELLRATE,  
		TRD_TRADEQTY, 
		CD_STATUS 
	FROM   
		CHARGES_DETAIL (NOLOCK),  
		(SELECT   
			CONTRACTNO,
			SAUDA_DATE=CONVERT(VARCHAR,SAUDA_DATE,112),   
			INST_TYPE,  
			SYMBOL,  
			EXPIRYDATE,  
			STRIKE_PRICE,  
			OPTION_TYPE,  
			ORDER_NO,  
			PARTY_CODE,  
			AUCTION_PART=AUCTIONPART,  
			TRADE_NO=PRADNYA.DBO.REPLACETRADENO(TRADE_NO),  
			TRD_TRADEQTY=SUM(TRADEQTY) 
		FROM  
			FOSETTLEMENT (NOLOCK)  
		WHERE  
			TRADEQTY > 0  
		GROUP BY  
			CONTRACTNO,CONVERT(VARCHAR,SAUDA_DATE,112),
			INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,  
			AUCTIONPART,ORDER_NO,PARTY_CODE,PRADNYA.DBO.REPLACETRADENO(TRADE_NO)  
	 ) STLMNT  
	WHERE  
		SAUDA_DATE  =  CONVERT(VARCHAR,CD_SAUDA_DATE,112) AND  
		PARTY_CODE = CD_PARTY_CODE AND   
		CONTRACTNO = CD_CONTRACT_NO AND   
		CD_INST_TYPE  = '' AND
		CD_SYMBOL = '' AND
		CD_OPTION_TYPE = '' AND
		CD_ORDER_NO = '' AND
		CD_AUCTIONPART ='' AND
		CD_TRADE_NO =''
	) SS	
GROUP BY
	CD_CONTRACT_NO,
	CD_SAUDA_DATE,  
	CD_INST_TYPE,  
	CD_SYMBOL,  
	CD_EXPIRY_DATE,  
	CD_STRIKE_PRICE,  
	CD_OPTION_TYPE,  
	CD_ORDER_NO,  
	CD_TRADE_NO,  
	CD_PARTY_CODE,  
	CD_AUCTIONPART,  
	CD_BUYRATE,  
	CD_SELLRATE, 
	CD_STATUS 

UNION ALL  
  
SELECT  
	CD_CONTRACT_NO,
	CD_SAUDA_DATE,  
	CD_INST_TYPE,  
	CD_SYMBOL,  
	CD_EXPIRY_DATE,  
	CD_STRIKE_PRICE,  
	CD_OPTION_TYPE,  
	CD_ORDER_NO,  
	CD_TRADE_NO,  
	CD_PARTY_CODE,  
	CD_AUCTIONPART,  
	CD_TOT_BROK,  
	CD_TOT_BUYQTY,  
	CD_TOT_SELLQTY,  
	CD_TOT_SERTAX,  
	CD_BUYRATE ,  
	CD_SELLRATE,  
	TRD_TRADEQTY = 0,
	CD_STATUS
FROM CHARGES_DETAIL (NOLOCK)  
WHERE  
	CD_TRADE_NO <> ''

GO

-- --------------------------------------------------
-- VIEW dbo.CLASSFILEUPD_BULK_VIEW
-- --------------------------------------------------

CREATE VIEW [dbo].[CLASSFILEUPD_BULK_VIEW] AS

SELECT FILEDATA FROM CLASSFILEUPD_BULK

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT_PRINT_SETTINGS
-- --------------------------------------------------
CREATE VIEW [dbo].[CLIENT_PRINT_SETTINGS] AS
SELECT * FROM MSAJAG.DBO.CLIENT_PRINT_SETTINGS (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.CLIENT2_VIEW
-- --------------------------------------------------
CREATE VIEW [dbo].[CLIENT2_VIEW] AS  SELECT * FROM CLIENT2 (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.EA_FOEXALLOCSALEPUR
-- --------------------------------------------------
CREATE VIEW [dbo].[EA_FOEXALLOCSALEPUR]
AS

SELECT  PARTY_CODE=T1.FOEATRD_PARTY_CODE,INST_TYPE=T1.FOEATRD_INST_TYPE,
	SYMBOL=T1.FOEATRD_SYMBOL,SEC_NAME=T1.FOEATRD_SEC_NAME,EXPIRYDATE=T1.FOEATRD_EXPIRYDATE,
	STRIKE_PRICE=T1.FOEATRD_STRIKE_PRICE ,OPTION_TYPE=T1.FOEATRD_OPTION_TYPE,
        SELL_BUY=T1.FOEATRD_SELL_BUY, TRADEQTY=T1.FOEATRD_TRADEQTY ,
      	PQTY = ISNULL((SELECT SUM(FOEATRD_TRADEQTY) FROM FOEXALLOCTRADE WHERE 
                FOEXALLOCTRADE.FOEATRD_PARTY_CODE = T1.FOEATRD_PARTY_CODE AND
                FOEXALLOCTRADE.FOEATRD_INST_TYPE=T1.FOEATRD_INST_TYPE AND 
                FOEXALLOCTRADE.FOEATRD_SYMBOL=T1.FOEATRD_SYMBOL AND 
                FOEXALLOCTRADE.FOEATRD_EXPIRYDATE=T1.FOEATRD_EXPIRYDATE  AND
                FOEXALLOCTRADE.FOEATRD_STRIKE_PRICE=T1.FOEATRD_STRIKE_PRICE AND  
                FOEXALLOCTRADE.FOEATRD_OPTION_TYPE=T1.FOEATRD_OPTION_TYPE 
                AND FOEXALLOCTRADE.FOEATRD_SELL_BUY = 1),0),

        SQTY =ISNULL( (SELECT SUM(FOEATRD_TRADEQTY) FROM FOEXALLOCTRADE WHERE 
                FOEXALLOCTRADE.FOEATRD_PARTY_CODE = T1.FOEATRD_PARTY_CODE AND
                FOEXALLOCTRADE.FOEATRD_INST_TYPE=T1.FOEATRD_INST_TYPE AND
	FOEXALLOCTRADE.FOEATRD_SYMBOL=T1.FOEATRD_SYMBOL AND
	FOEXALLOCTRADE.FOEATRD_EXPIRYDATE=T1.FOEATRD_EXPIRYDATE AND
                FOEXALLOCTRADE.FOEATRD_STRIKE_PRICE=T1.FOEATRD_STRIKE_PRICE AND 
                FOEXALLOCTRADE.FOEATRD_OPTION_TYPE=T1.FOEATRD_OPTION_TYPE 
                AND FOEXALLOCTRADE.FOEATRD_SELL_BUY = 2),0)
FROM FOEXALLOCTRADE T1

GO

-- --------------------------------------------------
-- VIEW dbo.EXERCISEASSIGNMENTVIEW
-- --------------------------------------------------
CREATE VIEW [dbo].[EXERCISEASSIGNMENTVIEW] 
AS
SELECT DISTINCT B.SAUDA_DATE,B.PARTY_CODE,B.INST_TYPE,B.SYMBOL,B.OPTION_TYPE,B.STRIKE_PRICE,B.MARKETTYPE,B.EXPIRYDATE ,
EAPAYABLE = (SELECT DISTINCT ISNULL(SUM(A.TRADEQTY*A.PRICE),0) 
FROM FOSETTLEMENT A WHERE A.SAUDA_DATE = B.SAUDA_DATE AND 
A.PARTY_CODE = B.PARTY_CODE AND A.STRIKE_PRICE = B.STRIKE_PRICE 
AND A.OPTION_TYPE = B.OPTION_TYPE AND A.EXPIRYDATE=B.EXPIRYDATE AND
A.INST_TYPE = B.INST_TYPE AND A.SELL_BUY = 2
AND A.AUCTIONPART = 'EA'),

EARECEIVABLE = (SELECT ISNULL(SUM(C.TRADEQTY*C.PRICE),0)
FROM FOSETTLEMENT C WHERE C.SAUDA_DATE = B.SAUDA_DATE AND 
C.PARTY_CODE = B.PARTY_CODE AND C.STRIKE_PRICE = B.STRIKE_PRICE AND 
C.OPTION_TYPE = B.OPTION_TYPE AND C.EXPIRYDATE=B.EXPIRYDATE AND C.INST_TYPE = B.INST_TYPE AND C.SELL_BUY =1 AND C.AUCTIONPART = 'EA'), 


NETEA = ((SELECT ISNULL(SUM(D.TRADEQTY*D.PRICE),0) FROM FOSETTLEMENT D
 WHERE D.SAUDA_DATE = B.SAUDA_DATE AND D.PARTY_CODE = B.PARTY_CODE AND 
D.STRIKE_PRICE = B.STRIKE_PRICE AND D.OPTION_TYPE = B.OPTION_TYPE AND D.EXPIRYDATE=B.EXPIRYDATE AND
D.INST_TYPE = B.INST_TYPE AND D.SELL_BUY = 2 AND D.AUCTIONPART = 'EA') - 
(SELECT ISNULL(SUM(E.TRADEQTY*E.PRICE),0) FROM FOSETTLEMENT E 
WHERE E.SAUDA_DATE = B.SAUDA_DATE AND E.PARTY_CODE = B.PARTY_CODE AND
 E.STRIKE_PRICE = B.STRIKE_PRICE AND E.OPTION_TYPE = B.OPTION_TYPE AND E.EXPIRYDATE=B.EXPIRYDATE AND
E.INST_TYPE = B.INST_TYPE AND E.SELL_BUY = 1 AND E.AUCTIONPART = 'EA')), 
B.SEC_NAME,PQTY = ( CASE WHEN B.SELL_BUY = 1 THEN SUM(B.TRADEQTY) ELSE 0 END ),
SQTY = ( CASE WHEN B.SELL_BUY = 2 THEN SUM(B.TRADEQTY) ELSE 0 END )
FROM FOSETTLEMENT B 
WHERE LEFT(RTRIM(LTRIM(INST_TYPE)),3) = 'OPT' 
AND B.AUCTIONPART = 'EA'
GROUP BY B.PARTY_CODE,B.INST_TYPE,B.SYMBOL,B.OPTION_TYPE,B.STRIKE_PRICE,B.MARKETTYPE,B.EXPIRYDATE,B.SEC_NAME, B.SAUDA_DATE ,B.SELL_BUY

GO

-- --------------------------------------------------
-- VIEW dbo.EXPIRYNETPOSVIEW_FINAL
-- --------------------------------------------------
CREATE VIEW [dbo].[EXPIRYNETPOSVIEW_FINAL]  
AS  
  
SELECT S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.STRIKE_PRICE,S.OPTION_TYPE,SEC_NAME=LEFT(S.INST_TYPE,3)+S.SYMBOL+LEFT(CONVERT(VARCHAR,S.EXPIRYDATE,109),11),S.EXPIRYDATE,  
S.SAUDA_DATE,  
PQTY = ( CASE WHEN SELL_BUY = 1 THEN SUM(S.TRADEQTY) ELSE 0 END ),  
SQTY = ( CASE WHEN SELL_BUY = 2 THEN SUM(S.TRADEQTY) ELSE 0 END ),NETRATE,PRICE,  
PARTICIPANTCODE = (CASE WHEN (PARTICIPANTCODE = '' OR PARTICIPANTCODE IS NULL)   
   THEN (SELECT LTRIM(RTRIM(ISNULL(MEMBERCODE,''))) FROM FOOWNER)  
   ELSE LTRIM(RTRIM(PARTICIPANTCODE))  
   END)  
FROM FOSETTLEMENT S  
WHERE  
--(AUCTIONPART <> 'EA' AND INST_TYPE LIKE 'FUT%'  
--OR AUCTIONPART <> 'CA' AND INST_TYPE LIKE 'OPT%')  
S.RESERVED1 = '0'   
GROUP BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.STRIKE_PRICE,S.OPTION_TYPE,S.EXPIRYDATE,  
S.SAUDA_DATE,S.SELL_BUY,S.NETRATE,S.PRICE,PARTICIPANTCODE

GO

-- --------------------------------------------------
-- VIEW dbo.FOBASALEPUR
-- --------------------------------------------------
CREATE  VIEW [dbo].[FOBASALEPUR] AS  
 
  
SELECT  T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.EXPIRYDATE  ,T1.STRIKE_PRICE ,T1.OPTION_TYPE,  
      PQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),0),  
      SQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),0)  
FROM FOTRADE T1  
GROUP BY T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.EXPIRYDATE ,T1.STRIKE_PRICE  ,T1.OPTION_TYPE

GO

-- --------------------------------------------------
-- VIEW dbo.FOBILLVALAN_VBB_VIEW
-- --------------------------------------------------
CREATE VIEW [dbo].[FOBILLVALAN_VBB_VIEW] AS

SELECT 
	PARTY_CODE,PARTY_NAME,CLIENT_TYPE,BILLNO=max(BILLNO),
	CONTRACTNO,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,AUCTIONPART,MATURITYDATE,SAUDA_DATE,
	ISIN,PQTY=sum(PQTY),SQTY=sum(SQTY),PRATE=sum(PRATE),SRATE=sum(SRATE),PAMT=sum(PAMT),SAMT=sum(SAMT),
	PBROKAMT=sum(PBROKAMT),SBROKAMT=sum(SBROKAMT),PBILLAMT=sum(PBILLAMT),SBILLAMT=sum(SBILLAMT),
	CL_RATE,CL_CHRG=sum(CL_CHRG),EXCL_CHRG=sum(EXCL_CHRG),SERVICE_TAX=sum(SERVICE_TAX),
	EXSER_TAX=sum(EXSER_TAX),INEXSERFLAG=max(INEXSERFLAG),
	SEBI_TAX=sum(SEBI_TAX),TURN_TAX=sum(TURN_TAX),
	BROKER_NOTE=sum(BROKER_NOTE),INS_CHRG=sum(INS_CHRG),OTHER_CHRG=sum(OTHER_CHRG),
	TRADETYPE,PARTICIPANTCODE,TERMINAL_ID,FAMILY,FAMILYNAME,TRADER,
	BRANCH_CODE,SUB_BROKER,STATUSNAME='',EXCHANGE,SEGMENT,MEMBERTYPE,
	COMPANYNAME,REGION,UPDATEDATE,EMAIL,SBU,RELMGR,GRP,SECTOR,CMCLOSING,
	TRACK,AREA
FROM FOBILLVALAN (NOLOCK)
GROUP BY
	PARTY_CODE,PARTY_NAME,CLIENT_TYPE,CONTRACTNO,INST_TYPE,SYMBOL,EXPIRYDATE,OPTION_TYPE,STRIKE_PRICE,
	AUCTIONPART,MATURITYDATE,SAUDA_DATE,ISIN,
	CL_RATE,TRADETYPE,PARTICIPANTCODE,TERMINAL_ID,FAMILY,FAMILYNAME,TRADER,BRANCH_CODE,SUB_BROKER,
	EXCHANGE,SEGMENT,MEMBERTYPE,COMPANYNAME,REGION,UPDATEDATE,EMAIL,SBU,RELMGR,GRP,
	SECTOR,CMCLOSING,TRACK,AREA

GO

-- --------------------------------------------------
-- VIEW dbo.FOBROKEXALLOCVIEW
-- --------------------------------------------------
CREATE VIEW [dbo].[FOBROKEXALLOCVIEW] AS
SELECT 

F.FOEATRD_TRADE_NO AS TRADE_NO,F.FOEATRD_PARTY_CODE AS PARTY_CODE,F.FOEATRD_INST_TYPE AS INST_TYPE,F.FOEATRD_SYMBOL AS SYMBOL,
F.FOEATRD_SEC_NAME AS SEC_NAME,F.FOEATRD_EXPIRYDATE AS EXPIRYDATE,F.FOEATRD_STRIKE_PRICE AS STRIKE_PRICE,
F.FOEATRD_OPTION_TYPE AS OPTION_TYPE,F.FOEATRD_TRADEQTY AS TRADEQTY,F.FOEATRD_MARKETTYPE AS MARKETTYPE,
       F.FOEATRD_USER_ID AS USER_ID,F.FOEATRD_ORDER_NO AS ORDER_NO,F.FOEATRD_PRICE AS PRICE,F.FOEATRD_PRO_CLI AS PRO_CLI,
F.FOEATRD_O_C_FLAG AS O_C_FLAG,F.FOEATRD_C_U_FLAG AS C_U_FLAG,F.FOEATRD_ACTIVITYTIME AS ACTIVITYTIME,F.FOEATRD_SELL_BUY AS SELL_BUY,
       F.FOEATRD_SETTFLAG AS SETTFLAG,DUMMY2,BROK3_TABLENO,BROK_SCHEME,TRAN_CAT,OFF_PHONE1,F.FOEATRD_CL_RATE AS CL_RATE,
MPRICE = /*(CASE WHEN C2.DUMMY1 = 0 
	       THEN F.FOEATRD_PRICE 
	       ELSE
		   (CASE WHEN C2.DUMMY1 = 1 
			 THEN (CASE WHEN F.FOEATRD_STRIKE_PRICE = 0 THEN F.FOEATRD_PRICE ELSE F.FOEATRD_STRIKE_PRICE END ) 			
	                 ELSE F.FOEATRD_STRIKE_PRICE + F.FOEATRD_PRICE  
		    END)
	  END),*/
F.FOEATRD_CL_RATE,
MULTIPLIER = ( CASE WHEN ( BROK_SCHEME = 4 OR BROK_SCHEME = 5 OR BROK_SCHEME = 6) 
		THEN CEILING(CONVERT(NUMERIC(19,2),F.FOEATRD_TRADEQTY) / CONVERT(NUMERIC(19,2),C_REGULAR_LOT))
		ELSE  1
	      END)		
FROM FOEXALLOCTRADE F, CLIENT2 C2,FOSCRIP2 S2,CLIENT1 C1
WHERE C2.PARTY_CODE = F.FOEATRD_PARTY_CODE 
AND C1.CL_CODE = C2.CL_CODE
AND F.FOEATRD_INST_TYPE = S2.INST_TYPE 
AND F.FOEATRD_SYMBOL = S2.SYMBOL      
AND F.FOEATRD_EXPIRYDATE = S2.EXPIRYDATE
AND F.FOEATRD_OPTION_TYPE = S2.OPTION_TYPE 
AND F.FOEATRD_STRIKE_PRICE = S2.STRIKE_PRICE

GO

-- --------------------------------------------------
-- VIEW dbo.FOBROKVIEW
-- --------------------------------------------------
CREATE  VIEW [dbo].[FOBROKVIEW]   
AS  
SELECT F.TRADE_NO,    
STATUS,F.INST_TYPE,F.SYMBOL,F.EXPIRYDATE,  F.STRIKE_PRICE,F.OPTION_TYPE,F.SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE,  
USER_ID,  
BRANCH_ID=(CASE WHEN (SELECT MEMBERTYPE FROM FOOWNER) = 'CM' THEN TMPARTYCODE ELSE BRANCH_ID END),  
SELL_BUY,TRADEQTY,PRICE,  
PRO_CLI,  
F.PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,  
ORDER_NO,OPP_BROKER_ID,SETTFLAG,C2.STD_RATE,C2.BROK2_TABLENO,C2.BROK_SCHEME,TRAN_CAT,OFF_PHONE1,C2.DUMMY6,C2.DUMMY7,CL_TYPE,  
MPRICE = (CASE WHEN ((C2.DUMMY1 = 0) OR (C2.DUMMY1 = 20))  
        THEN PRICE   
        ELSE  
     (CASE WHEN (C2.DUMMY1 = 1 OR C2.DUMMY1 = 21 )   
    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )      
                   ELSE F.STRIKE_PRICE + PRICE    
      END)  
   END),  
MULTIPLIER = ( CASE WHEN ( C2.BROK_SCHEME = 4 OR C2.BROK_SCHEME = 5 OR C2.BROK_SCHEME = 6 OR C2.BROK_SCHEME = 24 OR C2.BROK_SCHEME = 25 OR C2.BROK_SCHEME = 26)    
  THEN CEILING(CONVERT(NUMERIC(19,2),TRADEQTY) / CONVERT(NUMERIC(19,2),C_REGULAR_LOT))/(CASE WHEN TRADEQTY = 0 THEN 1 ELSE TRADEQTY END)  
  ELSE  1  
       END),   
TAXPRICE = (CASE WHEN ((C2.DUMMY1 = 0) OR (C2.DUMMY1 = 20))  
        THEN PRICE   
        ELSE  
     (CASE WHEN (C2.DUMMY1 = 1 OR C2.DUMMY1 = 21 )   
    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )      
                   ELSE F.STRIKE_PRICE + PRICE    
      END)  
   END)
FROM FOTRADE F, FOTRD_CLIENT2 C2,FOTRD_FOSCRIP2 S2,FOTRD_CLIENT1 C1, FOOWNER  
WHERE C2.PARTY_CODE = F.PARTY_CODE   
AND C1.CL_CODE = C2.CL_CODE  
AND F.INST_TYPE = S2.INST_TYPE   
AND F.SYMBOL = S2.SYMBOL        
AND F.EXPIRYDATE = S2.EXPIRYDATE  
AND F.OPTION_TYPE = S2.OPTION_TYPE   
AND F.STRIKE_PRICE = S2.STRIKE_PRICE

GO

-- --------------------------------------------------
-- VIEW dbo.FOBROKVIEW_EXALLOC
-- --------------------------------------------------

CREATE VIEW [dbo].[FOBROKVIEW_EXALLOC]
 AS
SELECT TRADE_NO=F.FOEATRD_TRADE_NO,STATUS=F.FOEATRD_STATUS,INST_TYPE=F.FOEATRD_INST_TYPE,SYMBOL=F.FOEATRD_SYMBOL,
EXPIRYDATE=F.FOEATRD_EXPIRYDATE,STRIKE_PRICE=F.FOEATRD_STRIKE_PRICE,OPTION_TYPE=F.FOEATRD_OPTION_TYPE,
SEC_NAME=F.FOEATRD_SEC_NAME,BOOKTYPE=1,INSTRUMENT=1,BOOKTYPENAME='',MARKETTYPE=FOEATRD_MARKETTYPE,
USER_ID=FOEATRD_USER_ID,BRANCH_ID='1',SELL_BUY=FOEATRD_SELL_BUY,TRADEQTY=FOEATRD_TRADEQTY,PRICE=FOEATRD_PRICE,
PRO_CLI=FOEATRD_PRO_CLI,PARTY_CODE=F.FOEATRD_PARTY_CODE,PARTICIPANTCODE='',
O_C_FLAG=FOEATRD_O_C_FLAG,C_U_FLAG=FOEATRD_C_U_FLAG,ACTIVITYTIME=FOEATRD_ACTIVITYTIME,LAST_MOD_TIME=FOEATRD_ACTIVITYTIME,
ORDER_NO=FOEATRD_ORDER_NO,OPP_BROKER_ID='',SETTFLAG=FOEATRD_SETTFLAG,DUMMY2,BROK_SCHEME,TRAN_CAT,OFF_PHONE1,
MPRICE = (CASE WHEN C2.DUMMY1 = 0 
	       THEN FOEATRD_PRICE 
	       ELSE
		   (CASE WHEN C2.DUMMY1 = 1 
			 THEN (CASE WHEN F.FOEATRD_STRIKE_PRICE = 0 THEN F.FOEATRD_PRICE ELSE F.FOEATRD_STRIKE_PRICE END ) 			
	                 ELSE F.FOEATRD_STRIKE_PRICE + FOEATRD_PRICE  
		    END)
	  END),
F.FOEATRD_CL_RATE,
MULTIPLIER = ( CASE WHEN ( BROK_SCHEME = 4 OR BROK_SCHEME = 5 OR BROK_SCHEME = 6) 
		THEN CEILING(CONVERT(NUMERIC(19,2),FOEATRD_TRADEQTY) / CONVERT(NUMERIC(19,2),C_REGULAR_LOT))/(CASE WHEN FOEATRD_TRADEQTY = 0 THEN 1 ELSE FOEATRD_TRADEQTY END)
		ELSE  1
	      END),
CL_RATE=FOEATRD_CL_RATE		
FROM FOEXALLOCTRADE F, CLIENT2 C2,FOSCRIP2 S2,CLIENT1 C1
WHERE C2.PARTY_CODE = F.FOEATRD_PARTY_CODE 
AND C1.CL_CODE = C2.CL_CODE
AND F.FOEATRD_INST_TYPE = S2.INST_TYPE 
AND F.FOEATRD_SYMBOL = S2.SYMBOL      
AND F.FOEATRD_EXPIRYDATE = S2.EXPIRYDATE
AND F.FOEATRD_OPTION_TYPE = S2.OPTION_TYPE 
AND F.FOEATRD_STRIKE_PRICE = S2.STRIKE_PRICE
AND F.FOEATRD_TRADEQTY <> 0

GO

-- --------------------------------------------------
-- VIEW dbo.FOBROKVIEW_EXALLOCFINAL
-- --------------------------------------------------

CREATE VIEW [dbo].[FOBROKVIEW_EXALLOCFINAL] 
AS
SELECT TRADE_NO,STATUS,FOBROKVIEW_EXALLOC.INST_TYPE,FOBROKVIEW_EXALLOC.SYMBOL,FOBROKVIEW_EXALLOC.EXPIRYDATE,FOBROKVIEW_EXALLOC.STRIKE_PRICE,
FOBROKVIEW_EXALLOC.OPTION_TYPE,
FOBROKVIEW_EXALLOC.SEC_NAME,BOOKTYPE=1,BOOKTYPENAME,MARKETTYPE,USER_ID,BRANCH_ID,FOBROKVIEW_EXALLOC.SELL_BUY,
TRADEQTY = FOBROKVIEW_EXALLOC.TRADEQTY,C_REGULAR_LOT,
PRICE,PRO_CLI,
FOBROKVIEW_EXALLOC.PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,TRAN_CAT,OFF_PHONE1,CL_RATE,
ORDER_NO,OPP_BROKER_ID,SETTFLAG,BROK_SCHEME,MPRICE,MULTIPLIER,FOGLOBALS.SERVICE_TAX,
BROKTABLE.TABLE_NO,BROKTABLE.LINE_NO,BROKTABLE.VAL_PERC,BROKTABLE.NORMAL,BROKTABLE.DAY_PUC,BROKTABLE.DAY_SALES,
BROKTABLE.SETT_PURCH,BROKTABLE.SETT_SALES,FOCLIENTTAXES.ROUND_TO,FOCLIENTTAXES.ROFIG,FOCLIENTTAXES.ERRNUM,FOCLIENTTAXES.NOZERO,
INSURANCE_CHRG=0,FOTAXES.TURNOVER_TAX,FOTAXES.SEBITURN_TAX,FOTAXES.BROKER_NOTE,
SERTAX=FOGLOBALS.SERVICE_TAX,FOGLOBALS.YEAR,FOGLOBALS.EXCHANGE, 
BROKAPPLIED = (  CASE  
                         WHEN ( FOBROKVIEW_EXALLOC.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW_EXALLOC.SELL_BUY = 1)
                              THEN 
		((FLOOR((FOBROKVIEW_EXALLOC.MULTIPLIER* BROKTABLE.NORMAL* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
		POWER(10,FOCLIENTTAXES.ROUND_TO))
                         WHEN ( FOBROKVIEW_EXALLOC.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW_EXALLOC.SELL_BUY = 2)
                              THEN 
		((FLOOR((FOBROKVIEW_EXALLOC.MULTIPLIER*BROKTABLE.NORMAL  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
		POWER(10,FOCLIENTTAXES.ROUND_TO))
                         WHEN ( FOBROKVIEW_EXALLOC.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOBROKVIEW_EXALLOC.SELL_BUY = 1)
                               THEN  
                                     ((FLOOR ( (((FOBROKVIEW_EXALLOC.MULTIPLIER*BROKTABLE.NORMAL  * 
		(FOBROKVIEW_EXALLOC.MPRICE))/100 )  * POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + 
		FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))
                        WHEN ( FOBROKVIEW_EXALLOC.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOBROKVIEW_EXALLOC.SELL_BUY = 2)
                             THEN 
		((FLOOR(( ((FOBROKVIEW_EXALLOC.MULTIPLIER*BROKTABLE.NORMAL * (FOBROKVIEW_EXALLOC.MPRICE)) /100 )* 
		POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
		POWER(10,FOCLIENTTAXES.ROUND_TO))
                      WHEN (FOBROKVIEW_EXALLOC.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' ) 
                            THEN 
		((FLOOR(( ((FOBROKVIEW_EXALLOC.MULTIPLIER*BROKTABLE.DAY_PUC))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
		POWER(10,FOCLIENTTAXES.ROUND_TO))
                      WHEN (FOBROKVIEW_EXALLOC.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' ) 
                             THEN 
		((FLOOR(( ((FOBROKVIEW_EXALLOC.MULTIPLIER*BROKTABLE.DAY_PUC * (FOBROKVIEW_EXALLOC.MPRICE))/100) * 
		POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
		POWER(10,FOCLIENTTAXES.ROUND_TO))
                   WHEN (FOBROKVIEW_EXALLOC.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
		((FLOOR(( FOBROKVIEW_EXALLOC.MULTIPLIER*BROKTABLE.DAY_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
		POWER(10,FOCLIENTTAXES.ROUND_TO))
                  WHEN (FOBROKVIEW_EXALLOC.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )
          THEN 
		((FLOOR(( ((FOBROKVIEW_EXALLOC.MULTIPLIER*BROKTABLE.DAY_SALES * (FOBROKVIEW_EXALLOC.MPRICE))/ 100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+
		FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
		POWER(10,FOCLIENTTAXES.ROUND_TO))
                WHEN ( FOBROKVIEW_EXALLOC.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
		((FLOOR((FOBROKVIEW_EXALLOC.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
		POWER(10,FOCLIENTTAXES.ROUND_TO))
                         WHEN ( FOBROKVIEW_EXALLOC.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )
                             THEN 
		((FLOOR(( ((FOBROKVIEW_EXALLOC.MULTIPLIER*BROKTABLE.SETT_PURCH * (FOBROKVIEW_EXALLOC.MPRICE))/100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+
		FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
		POWER(10,FOCLIENTTAXES.ROUND_TO))
             WHEN ( FOBROKVIEW_EXALLOC.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
		((FLOOR((FOBROKVIEW_EXALLOC.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
		POWER(10,FOCLIENTTAXES.ROUND_TO))
                         WHEN ( FOBROKVIEW_EXALLOC.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='P' )
                             THEN 
		((FLOOR(( ((FOBROKVIEW_EXALLOC.MULTIPLIER*BROKTABLE.SETT_SALES * (FOBROKVIEW_EXALLOC.MPRICE))/100) * 
		POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / 
		POWER(10,FOCLIENTTAXES.ROUND_TO))
	ELSE  0 
	END 
	) ,
    INS_CHRG  = 0,

  	TURN_TAX  =  
		((FLOOR(( ((CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FUT_TURNOVER_TAX ELSE OPT_TURNOVER_TAX END * 
		(CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FOBROKVIEW_EXALLOC.PRICE
		ELSE CASE WHEN FOTAXES.TURNOVER_TAX_ON='PRICE'  THEN  FOBROKVIEW_EXALLOC.PRICE
		ELSE CASE WHEN FOTAXES.TURNOVER_TAX_ON='SPRICE' THEN  FOBROKVIEW_EXALLOC.SPRICE
		ELSE FOBROKVIEW_EXALLOC.SPPRICE  END END END) * FOBROKVIEW_EXALLOC.TRADEQTY)/100 ) * 
		POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /  
		POWER(10,FOCLIENTTAXES.ROUND_TO)),
	
	OTHER_CHRG = 
		((FLOOR(( ((CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FUT_OTHER_CHRG ELSE OPT_OTHER_CHRG END  * 
		(CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN	FOBROKVIEW_EXALLOC.PRICE
		ELSE CASE WHEN FOTAXES.OTHER_CHRG_ON='PRICE'  THEN  FOBROKVIEW_EXALLOC.PRICE
		ELSE CASE WHEN FOTAXES.OTHER_CHRG_ON='SPRICE' THEN  FOBROKVIEW_EXALLOC.SPRICE
		ELSE FOBROKVIEW_EXALLOC.SPPRICE  END END END) * FOBROKVIEW_EXALLOC.TRADEQTY)/100 ) * 
		POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /  
		POWER(10,FOCLIENTTAXES.ROUND_TO)),
	
	SEBI_TAX =     
		((FLOOR(( ((CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FUT_SEBITURN_TAX ELSE OPT_SEBITURN_TAX END  *
		(CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN	FOBROKVIEW_EXALLOC.PRICE
		ELSE CASE WHEN FOTAXES.SEBI_TAX_ON='PRICE'  THEN  FOBROKVIEW_EXALLOC.PRICE
		ELSE CASE WHEN FOTAXES.SEBI_TAX_ON='SPRICE' THEN  FOBROKVIEW_EXALLOC.SPRICE
		ELSE FOBROKVIEW_EXALLOC.SPPRICE  END END END) * FOBROKVIEW_EXALLOC.TRADEQTY)/100) * 
		POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / 
		POWER(10,FOCLIENTTAXES.ROUND_TO)),
	    
    BROKER_CHRG = 0,

	CPID=0,INSTRUMENT=1,TMARK=0,SCHEME=BROK_SCHEME,
	DUMMY1=0,DUMMY2=0,RESERVED1=0,RESERVED2=0
FROM
	(SELECT TRADE_NO=F.FOEATRD_TRADE_NO,STATUS=F.FOEATRD_STATUS,INST_TYPE=F.FOEATRD_INST_TYPE,SYMBOL=F.FOEATRD_SYMBOL,  
	EXPIRYDATE=F.FOEATRD_EXPIRYDATE,STRIKE_PRICE=F.FOEATRD_STRIKE_PRICE,OPTION_TYPE=F.FOEATRD_OPTION_TYPE,  
	SEC_NAME=F.FOEATRD_SEC_NAME,BOOKTYPE='1',BOOKTYPENAME='',MARKETTYPE=FOEATRD_MARKETTYPE,  
	USER_ID=FOEATRD_USER_ID,BRANCH_ID='1',SELL_BUY=FOEATRD_SELL_BUY,TRADEQTY=FOEATRD_TRADEQTY,PRICE=FOEATRD_PRICE,  
	PRO_CLI=FOEATRD_PRO_CLI,PARTY_CODE=F.FOEATRD_PARTY_CODE,PARTICIPANTCODE='',  
	O_C_FLAG=FOEATRD_O_C_FLAG,C_U_FLAG=FOEATRD_C_U_FLAG,ACTIVITYTIME=FOEATRD_ACTIVITYTIME,LAST_MOD_TIME=FOEATRD_ACTIVITYTIME,  
	ORDER_NO=FOEATRD_ORDER_NO,OPP_BROKER_ID='',SETTFLAG=FOEATRD_SETTFLAG,DUMMY2,TRAN_CAT,OFF_PHONE1,  
	MPRICE = FOEATRD_PRICE ,  
	MULTIPLIER = ( CASE WHEN ( BROK_SCHEME = 4 OR BROK_SCHEME = 5 OR BROK_SCHEME = 6)   
	  THEN CEILING(CONVERT(NUMERIC(19,2),FOEATRD_TRADEQTY) / CONVERT(NUMERIC(19,2),C_REGULAR_LOT))/
		(CASE WHEN FOEATRD_TRADEQTY = 0 THEN 1 ELSE FOEATRD_TRADEQTY END)  
	  ELSE  1  
	       END),  
	CL_RATE=FOEATRD_CL_RATE ,
	SPRICE = F.FOEATRD_STRIKE_PRICE ,
	SPPRICE = F.FOEATRD_STRIKE_PRICE + F.FOEATRD_PRICE ,
	SPPRICE1 = ABS(F.FOEATRD_STRIKE_PRICE - F.FOEATRD_PRICE) ,
	CL_TYPE
	FROM FOEXALLOCTRADE F, CLIENT2 C2,FOSCRIP2 S2,CLIENT1 C1  
	WHERE C2.PARTY_CODE = F.FOEATRD_PARTY_CODE   
	AND C1.CL_CODE = C2.CL_CODE  
	AND F.FOEATRD_INST_TYPE = S2.INST_TYPE   
	AND F.FOEATRD_SYMBOL = S2.SYMBOL        
	AND F.FOEATRD_EXPIRYDATE = S2.EXPIRYDATE  
	AND F.FOEATRD_OPTION_TYPE = S2.OPTION_TYPE   
	AND F.FOEATRD_STRIKE_PRICE = S2.STRIKE_PRICE  
	AND F.FOEATRD_TRADEQTY <> 0  
	  
	)FOBROKVIEW_EXALLOC,BROKTABLE,
	(SELECT PARTY_CODE=T1.FOEATRD_PARTY_CODE,INST_TYPE=T1.FOEATRD_INST_TYPE,
		SYMBOL=T1.FOEATRD_SYMBOL,EXPIRYDATE=T1.FOEATRD_EXPIRYDATE,
		STRIKE_PRICE=T1.FOEATRD_STRIKE_PRICE ,OPTION_TYPE=T1.FOEATRD_OPTION_TYPE,	        
		PQTY=SUM(CASE WHEN FOEATRD_SELL_BUY = 1 THEN FOEATRD_TRADEQTY ELSE 0 END),
		SQTY=SUM(CASE WHEN FOEATRD_SELL_BUY = 2 THEN FOEATRD_TRADEQTY ELSE 0 END),
		PRATE= (CASE WHEN SUM(CASE WHEN FOEATRD_SELL_BUY = 1 THEN FOEATRD_TRADEQTY ELSE 0 END) > 0 THEN 
			SUM(CASE WHEN FOEATRD_SELL_BUY = 1 THEN FOEATRD_TRADEQTY*FOEATRD_PRICE ELSE 0 END)/
			SUM(CASE WHEN FOEATRD_SELL_BUY = 1 THEN FOEATRD_TRADEQTY ELSE 0 END) ELSE 0 END),
		SRATE=(CASE WHEN SUM(CASE WHEN FOEATRD_SELL_BUY = 2 THEN FOEATRD_TRADEQTY ELSE 0 END) > 0 THEN 
			SUM(CASE WHEN FOEATRD_SELL_BUY = 2 THEN FOEATRD_TRADEQTY*FOEATRD_PRICE ELSE 0 END)/
			SUM(CASE WHEN FOEATRD_SELL_BUY = 2 THEN FOEATRD_TRADEQTY ELSE 0 END) ELSE 0 END)
	FROM FOEXALLOCTRADE T1
	GROUP BY T1.FOEATRD_PARTY_CODE,T1.FOEATRD_INST_TYPE,
		T1.FOEATRD_SYMBOL,T1.FOEATRD_EXPIRYDATE,
		T1.FOEATRD_STRIKE_PRICE ,T1.FOEATRD_OPTION_TYPE
) S,
	FOTAXES ,
	FOGLOBALS , 
	FOSCRIP2,
	FOCLIENTTAXES,
	FOCLIENTBROKSCHEME
WHERE 
      FOBROKVIEW_EXALLOC.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE AND 
      FOBROKVIEW_EXALLOC.ACTIVITYTIME BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO AND
      FOBROKVIEW_EXALLOC.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE AND 
      FOBROKVIEW_EXALLOC.ACTIVITYTIME BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO AND

      FOBROKVIEW_EXALLOC.PARTY_CODE = S.PARTY_CODE AND
      FOBROKVIEW_EXALLOC.INST_TYPE=S.INST_TYPE AND  
      FOBROKVIEW_EXALLOC.SYMBOL=S.SYMBOL AND
    FOBROKVIEW_EXALLOC.EXPIRYDATE=S.EXPIRYDATE  AND
      FOBROKVIEW_EXALLOC.STRIKE_PRICE = S.STRIKE_PRICE AND                 
      FOBROKVIEW_EXALLOC.OPTION_TYPE = S.OPTION_TYPE    AND  
      LEFT(S.INST_TYPE,3) = FOTAXES.INST_TYPE  AND     
	  FOTAXES.TRANS_CAT='DEL' and 
	  FOBROKVIEW_EXALLOC.ACTIVITYTIME  BETWEEN  FOTAXES.FROM_DATE AND FOTAXES.TO_DATE AND
      FOBROKVIEW_EXALLOC.ACTIVITYTIME  BETWEEN FOGLOBALS.YEAR_START_DT AND FOGLOBALS.YEAR_END_DT AND
      BROKTABLE.TABLE_NO = OPT_EXC_BROKTABLE AND   
           BROKTABLE.LINE_NO =  ( CASE WHEN (BROK_SCHEME= 1 OR BROK_SCHEME= 5 ) THEN					
              (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE
               		    BROKTABLE.TABLE_NO = OPT_EXC_BROKTABLE
                	    AND TRD_DEL = ( CASE WHEN S.PQTY > S.SQTY 
			 THEN ( CASE WHEN ( FOBROKVIEW_EXALLOC.SELL_BUY = 1 ) 
     			 	    THEN 'F'  
    			 	    ELSE 'S'
			       END )
		     	 ELSE
			      ( CASE WHEN ( FOBROKVIEW_EXALLOC.SELL_BUY = 2 ) 
    			 	    THEN 'F'  
    			 	    ELSE 'S'
			       END )					
		    END )
                      AND FOBROKVIEW_EXALLOC.PARTY_CODE =  S.PARTY_CODE   	
   		    AND FOBROKVIEW_EXALLOC.MPRICE <= BROKTABLE.UPPER_LIM)							    
	        WHEN ( BROK_SCHEME= 3 OR BROK_SCHEME= 6 ) THEN					
	       		   (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE
               		    BROKTABLE.TABLE_NO =  OPT_EXC_BROKTABLE                     						
                	    AND TRD_DEL = ( CASE WHEN S.PQTY > S.SQTY 
				 THEN ( CASE WHEN ( FOBROKVIEW_EXALLOC.SELL_BUY = 1 ) 
	    			 	    THEN 'F'  
	    			 	    ELSE 'S'
				       END )
			     	 ELSE
				      ( CASE WHEN ( FOBROKVIEW_EXALLOC.SELL_BUY = 2 ) 
	    			 	    THEN 'F'  
	    			 	    ELSE 'S'
				       END )					
			    END )
            	    AND FOBROKVIEW_EXALLOC.PARTY_CODE = S.PARTY_CODE   	
			AND FOBROKVIEW_EXALLOC.MPRICE <= BROKTABLE.UPPER_LIM)	
	        WHEN ( BROK_SCHEME= 2) THEN					
	       		   (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE
               		    BROKTABLE.TABLE_NO =  OPT_EXC_BROKTABLE                     						
                	    AND TRD_DEL = (CASE WHEN S.PQTY = S.SQTY 
				   THEN (CASE WHEN S.PRATE >= S.SRATE 
				              THEN (CASE WHEN FOBROKVIEW_EXALLOC.SELL_BUY = 1
				                         THEN 'F' 
							 ELSE 'S'
					            END )
					      ELSE
               				           (CASE WHEN ( FOBROKVIEW_EXALLOC.SELL_BUY = 2 ) 
                          			         THEN 'F'
				                         ELSE 'S'
				                    END )     
	 			              END)
	                           ELSE (CASE WHEN S.PQTY >= S.SQTY 
                                              THEN (CASE WHEN ( FOBROKVIEW_EXALLOC.SELL_BUY = 1 ) 
                                                         THEN 'F'  
                                                         ELSE 'S'
                                                    END )
                                              ELSE
                                                   (CASE WHEN ( FOBROKVIEW_EXALLOC.SELL_BUY = 2 ) 
                                                         THEN 'F'  
                                                         ELSE 'S'
                                                    END )     
				              END )
           			   END )
            	    AND FOBROKVIEW_EXALLOC.PARTY_CODE = S.PARTY_CODE   	
			AND FOBROKVIEW_EXALLOC.MPRICE <= BROKTABLE.UPPER_LIM)
		    ELSE 
                                       (  SELECT MIN(LINE_NO) FROM BROKTABLE 
                                          WHERE FOBROKVIEW_EXALLOC.MPRICE <= BROKTABLE.UPPER_LIM 
			                  AND BROKTABLE.TABLE_NO = OPT_EXC_BROKTABLE)
				   END )
		AND FOSCRIP2.INST_TYPE = S.INST_TYPE  
		AND FOSCRIP2.SYMBOL = S.SYMBOL  
		AND FOSCRIP2.EXPIRYDATE = S.EXPIRYDATE  
		AND FOSCRIP2.OPTION_TYPE = S.OPTION_TYPE  
		AND FOSCRIP2.STRIKE_PRICE = S.STRIKE_PRICE

GO

-- --------------------------------------------------
-- VIEW dbo.FOBROKVIEW_EXPIRY
-- --------------------------------------------------
/*
DROP VIEW FOBROKVIEW_EXPIRY
*/
/****** OBJECT:  VIEW DBO.FOBROKVIEW    SCRIPT DATE: 03/21/2002 2:11:53 PM ******/
/****** OBJECT:  VIEW DBO.FOBROKVIEW    SCRIPT DATE: 01/23/2002 2:36:42 PM ******/
CREATE VIEW [dbo].[FOBROKVIEW_EXPIRY]
AS
SELECT F.TRADE_NO,  
STATUS,F.INST_TYPE,F.SYMBOL,F.EXPIRYDATE,  F.STRIKE_PRICE,F.OPTION_TYPE,F.SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE,
USER_ID,
BRANCH_ID=(CASE WHEN (SELECT MEMBERTYPE FROM FOOWNER) = 'CM' THEN TMPARTYCODE ELSE BRANCH_ID END),
SELL_BUY,TRADEQTY,PRICE,
/*PRO_CLI = ( CASE WHEN CL_TYPE = 'PRO' THEN 1 ELSE 2 END ),*/
PRO_CLI,
F.PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,
ORDER_NO,OPP_BROKER_ID,SETTFLAG,C2.STD_RATE,C2.BROK1_TABLENO,C2.BROK_SCHEME,TRAN_CAT,OFF_PHONE1,C2.DUMMY6,C2.DUMMY7,CL_TYPE,
MPRICE = /*(CASE WHEN ((C2.DUMMY1 = 0) OR (C2.DUMMY1 = 20))
        THEN PRICE 
        ELSE
     (CASE WHEN (C2.DUMMY1 = 1 OR C2.DUMMY1 = 21 ) 
    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )    
                   ELSE F.STRIKE_PRICE + PRICE  
      END)
   END),*/
/* COMMENTED BY UPPILI KRISHNAN */
/*
 ISNULL(( SELECT FOFINALCLOSING.CL_RATE FROM FOFINALCLOSING
                         WHERE 
                            F.EXPIRYDATE = FOFINALCLOSING.CLOSINGDATE
                                        AND FOFINALCLOSING.UNDERLYINGASSET=F.SYMBOL   
                         
                     
           ),ISNULL(( SELECT FOCLOSING_BILLREPORT.CL_RATE FROM FOCLOSING_BILLREPORT
                         WHERE LEFT(CONVERT(VARCHAR,FOCLOSING_BILLREPORT.TRADE_DATE,109),11)  LIKE LEFT(CONVERT(VARCHAR,F.EXPIRYDATE,109),11)
                         AND FOCLOSING_BILLREPORT.INST_TYPE = F.INST_TYPE AND FOCLOSING_BILLREPORT.SYMBOL=F.SYMBOL 
                          AND FOCLOSING_BILLREPORT.STRIKE_PRICE=F.STRIKE_PRICE AND FOCLOSING_BILLREPORT.OPTION_TYPE =F.OPTION_TYPE 
                         AND CONVERT(VARCHAR,FOCLOSING_BILLREPORT.EXPIRYDATE,103) = CONVERT(VARCHAR,F.EXPIRYDATE,103)
                     
           ),0)), */
F.PRICE,
MULTIPLIER = ( CASE WHEN ( C2.BROK_SCHEME = 4 OR C2.BROK_SCHEME = 5 OR C2.BROK_SCHEME = 6 OR C2.BROK_SCHEME = 24 OR C2.BROK_SCHEME = 25 OR C2.BROK_SCHEME = 26)  
  THEN CEILING(CONVERT(NUMERIC(19,2),TRADEQTY) / CONVERT(NUMERIC(19,2),C_REGULAR_LOT))/(CASE WHEN TRADEQTY = 0 THEN 1 ELSE TRADEQTY END)
  ELSE  1
       END), 
TAXPRICE = (CASE WHEN TAXESFLAG = 0 
        THEN PRICE 
        ELSE
     (CASE WHEN TAXESFLAG = 1 
    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )    
                   ELSE F.STRIKE_PRICE + PRICE  
      END)
   END) 
FROM FOTRADE F, CLIENT2 C2,FOSCRIP2 S2,CLIENT1 C1, FOOWNER
WHERE C2.PARTY_CODE = F.PARTY_CODE 
AND C1.CL_CODE = C2.CL_CODE
AND F.INST_TYPE = S2.INST_TYPE 
AND F.SYMBOL = S2.SYMBOL      
AND F.EXPIRYDATE = S2.EXPIRYDATE
AND F.OPTION_TYPE = S2.OPTION_TYPE 
AND F.STRIKE_PRICE = S2.STRIKE_PRICE

GO

-- --------------------------------------------------
-- VIEW dbo.FOBROKVIEWFINAL
-- --------------------------------------------------

CREATE VIEW  [dbo].[FOBROKVIEWFINAL]           
AS          
SELECT     
 TRADE_NO,STATUS,FOBROKVIEW.INST_TYPE,FOBROKVIEW.SYMBOL,FOBROKVIEW.EXPIRYDATE,    
 FOBROKVIEW.STRIKE_PRICE,FOBROKVIEW.OPTION_TYPE,          
 FOBROKVIEW.SEC_NAME,BOOKTYPE=1,BOOKTYPENAME,MARKETTYPE,USER_ID,    
 BRANCH_ID,FOBROKVIEW.SELL_BUY,TRADEQTY,PRICE,PRO_CLI,          
 FOBROKVIEW.PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,TRAN_CAT,OFF_PHONE1,          
 ORDER_NO,OPP_BROKER_ID,SETTFLAG,BROK_SCHEME,MPRICE,MULTIPLIER,FOGLOBALS.SERVICE_TAX,          
 BROKTABLE.TABLE_NO,BROKTABLE.LINE_NO,BROKTABLE.VAL_PERC,BROKTABLE.NORMAL,    
 BROKTABLE.DAY_PUC,BROKTABLE.DAY_SALES,          
 BROKTABLE.SETT_PURCH,BROKTABLE.SETT_SALES,FOCLIENTTAXES.ROUND_TO,FOCLIENTTAXES.ROFIG,    
 FOCLIENTTAXES.ERRNUM,FOCLIENTTAXES.NOZERO,          
 INSURANCE_CHRG=0,FOTAXES.TURNOVER_TAX,FOTAXES.SEBITURN_TAX,FOTAXES.BROKER_NOTE,          
 SERTAX=FOGLOBALS.SERVICE_TAX,FOGLOBALS.YEAR,FOGLOBALS.EXCHANGE,C_REGULAR_LOT,      
 BROKAPPLIED = (((  CASE      
                         WHEN ( FOBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW.SELL_BUY = 1)    
                              THEN     
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.NORMAL* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
                         WHEN ( FOBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW.SELL_BUY = 2)    
                              THEN     
  ((FLOOR((FOBROKVIEW.MULTIPLIER*BROKTABLE.NORMAL  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
  WHEN ( FOBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOBROKVIEW.SELL_BUY = 1)    
                               THEN      
 ((FLOOR ( (((FOBROKVIEW.MULTIPLIER*BROKTABLE.NORMAL * (FOBROKVIEW.MPRICE))  /100 ) * POWER(10,FOCLIENTTAXES.ROUND_TO) +     
FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /    
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))    
                        WHEN ( FOBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOBROKVIEW.SELL_BUY = 2)    
                             THEN     
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.NORMAL * (FOBROKVIEW.MPRICE)) /100 )* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
                      WHEN (FOBROKVIEW.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )     
                            THEN     
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.DAY_PUC))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
                      WHEN (FOBROKVIEW.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' )     
                             THEN     
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.DAY_PUC * (FOBROKVIEW.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
                   WHEN (FOBROKVIEW.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )    
                             THEN     
  ((FLOOR(( FOBROKVIEW.MULTIPLIER*BROKTABLE.DAY_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
                  WHEN (FOBROKVIEW.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )    
  THEN     
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.DAY_SALES * (FOBROKVIEW.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
                WHEN ( FOBROKVIEW.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )    
                             THEN     
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
                         WHEN ( FOBROKVIEW.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )    
                             THEN     
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_PURCH * (FOBROKVIEW.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
             WHEN ( FOBROKVIEW.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )    
                             THEN     
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
                         WHEN ( FOBROKVIEW.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='P' )    
                             THEN     
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_SALES * (FOBROKVIEW.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
WHEN (FOBROKVIEW.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='V' )     
                            THEN     
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_PURCH))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
                      WHEN (FOBROKVIEW.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='P' )     
                             THEN     
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_PURCH * (FOBROKVIEW.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
                       
WHEN (FOBROKVIEW.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='V' )    
                             THEN     
  ((FLOOR(( FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
                  WHEN (FOBROKVIEW.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='P' )    
                             THEN     
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_SALES * (FOBROKVIEW.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
                WHEN ( FOBROKVIEW.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='V' )    
                             THEN     
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
                         WHEN ( FOBROKVIEW.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='P' )    
                             THEN     
((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_PURCH * (FOBROKVIEW.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
             WHEN ( FOBROKVIEW.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='V' )    
                             THEN     
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
                         WHEN ( FOBROKVIEW.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='P' )    
                             THEN     
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_SALES * (FOBROKVIEW.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /      
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /     
  POWER(10,FOCLIENTTAXES.ROUND_TO))    
   ELSE  0     
                        END     
                         ) ) ),    
          
	INS_CHRG  = 0,          
    
  	TURN_TAX  =  
		((FLOOR(( ((CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FUT_TURNOVER_TAX ELSE OPT_TURNOVER_TAX END * 
		(CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FOBROKVIEW.PRICE
		ELSE CASE WHEN FOTAXES.TURNOVER_TAX_ON='PRICE'  THEN  FOBROKVIEW.PRICE
		ELSE CASE WHEN FOTAXES.TURNOVER_TAX_ON='SPRICE' THEN  FOBROKVIEW.SPRICE
		ELSE FOBROKVIEW.SPPRICE  END END END) * FOBROKVIEW.TRADEQTY)/100 ) * 
		POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /  
		POWER(10,FOCLIENTTAXES.ROUND_TO)),
	
	OTHER_CHRG = 
		((FLOOR(( ((CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FUT_OTHER_CHRG ELSE OPT_OTHER_CHRG END  * 
		(CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN	FOBROKVIEW.PRICE
		ELSE CASE WHEN FOTAXES.OTHER_CHRG_ON='PRICE'  THEN  FOBROKVIEW.PRICE
		ELSE CASE WHEN FOTAXES.OTHER_CHRG_ON='SPRICE' THEN  FOBROKVIEW.SPRICE
		ELSE FOBROKVIEW.SPPRICE  END END END) * FOBROKVIEW.TRADEQTY)/100 ) * 
		POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /  
		POWER(10,FOCLIENTTAXES.ROUND_TO)),
	
	SEBI_TAX =     
		((FLOOR(( ((CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FUT_SEBITURN_TAX ELSE OPT_SEBITURN_TAX END  *
		(CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN	FOBROKVIEW.PRICE
		ELSE CASE WHEN FOTAXES.SEBI_TAX_ON='PRICE'  THEN  FOBROKVIEW.PRICE
		ELSE CASE WHEN FOTAXES.SEBI_TAX_ON='SPRICE' THEN  FOBROKVIEW.SPRICE
		ELSE FOBROKVIEW.SPPRICE  END END END) * FOBROKVIEW.TRADEQTY)/100) * 
		POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / 
		POWER(10,FOCLIENTTAXES.ROUND_TO)),
	      
      
BROKER_CHRG = 0,CPID=0,INSTRUMENT=1,TMARK=0,SCHEME=BROK_SCHEME,DUMMY1=0,    
RESERVED1,RESERVED4,RESERVED2=0,CL_TYPE,          
DUMMY2 =           
 (CASE            
 WHEN (FOBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW.SELL_BUY = 1)          
 THEN           
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.NORMAL* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /            
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /    
POWER(10,FOCLIENTTAXES.ROUND_TO))          
 WHEN (FOBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW.SELL_BUY = 2)          
 THEN           
  ((FLOOR((FOBROKVIEW.MULTIPLIER*BROKTABLE.NORMAL  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /            
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /           
  POWER(10,FOCLIENTTAXES.ROUND_TO))          
 WHEN (FOBROKVIEW.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )           
 THEN           
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.DAY_PUC))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /            
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /           
  POWER(10,FOCLIENTTAXES.ROUND_TO))          
 WHEN (FOBROKVIEW.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )          
 THEN           
  ((FLOOR(( FOBROKVIEW.MULTIPLIER*BROKTABLE.DAY_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /            
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /           
  POWER(10,FOCLIENTTAXES.ROUND_TO))          
 WHEN ( FOBROKVIEW.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )          
 THEN           
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /            
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /           
  POWER(10,FOCLIENTTAXES.ROUND_TO))          
 WHEN ( FOBROKVIEW.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )          
 THEN           
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /            
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /           
  POWER(10,FOCLIENTTAXES.ROUND_TO))          
 WHEN (FOBROKVIEW.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='V' )           
 THEN           
  ((FLOOR(( ((FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_PURCH))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /            
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /           
  POWER(10,FOCLIENTTAXES.ROUND_TO))          
 WHEN (FOBROKVIEW.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='V' )          
 THEN           
  ((FLOOR(( FOBROKVIEW.MULTIPLIER*BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /            
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /           
  POWER(10,FOCLIENTTAXES.ROUND_TO))          
 WHEN ( FOBROKVIEW.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='V' )          
 THEN           
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /            
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /           
  POWER(10,FOCLIENTTAXES.ROUND_TO))          
 WHEN ( FOBROKVIEW.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='V' )          
 THEN           
  ((FLOOR((FOBROKVIEW.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /            
  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) )  /           
  POWER(10,FOCLIENTTAXES.ROUND_TO))          
 ELSE  0           
 END )           
FROM          
(      
 SELECT F.TRADE_NO,          
 STATUS,F.INST_TYPE,F.SYMBOL,F.EXPIRYDATE,  F.STRIKE_PRICE,F.OPTION_TYPE,F.SEC_NAME,BOOKTYPE,      
 BOOKTYPENAME,MARKETTYPE,  USER_ID,        
 BRANCH_ID=(CASE WHEN (SELECT MEMBERTYPE FROM FOOWNER) = 'CM' THEN TMPARTYCODE ELSE BRANCH_ID END),        
 SELL_BUY,TRADEQTY,PRICE, PRO_CLI,        
 F.PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,        
 ORDER_NO,OPP_BROKER_ID,SETTFLAG,C2.STD_RATE,C2.BROK2_TABLENO,TRAN_CAT,OFF_PHONE1,      
 C2.DUMMY6,C2.DUMMY7,CL_TYPE,        
 MPRICE = (CASE WHEN ((C2.DUMMY1 = 0) OR (C2.DUMMY1 = 20))        
         THEN PRICE         
         ELSE        
      (CASE WHEN (C2.DUMMY1 = 1 OR C2.DUMMY1 = 21 )         
     THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )            
                    ELSE F.STRIKE_PRICE + PRICE          
       END)        
    END),        
 MULTIPLIER = 1,         
 TAXPRICE = (CASE WHEN ((C2.DUMMY1 = 0) OR (C2.DUMMY1 = 20))        
         THEN PRICE         
         ELSE        
      (CASE WHEN (C2.DUMMY1 = 1 OR C2.DUMMY1 = 21 )         
     THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )            
                    ELSE F.STRIKE_PRICE + PRICE          
       END)        
    END),      
 SPRICE = F.STRIKE_PRICE ,
 SPPRICE = F.STRIKE_PRICE + F.PRICE ,
 C_REGULAR_LOT ,   
 RESERVED4 ,RESERVED1    
 FROM FOTRADE F, FOTRD_CLIENT2 C2,FOTRD_FOSCRIP2 S2,FOTRD_CLIENT1 C1, FOOWNER        
 WHERE C2.PARTY_CODE = F.PARTY_CODE         
 AND C1.CL_CODE = C2.CL_CODE        
 AND F.INST_TYPE = S2.INST_TYPE         
 AND F.SYMBOL = S2.SYMBOL              
 AND F.EXPIRYDATE = S2.EXPIRYDATE        
 AND F.OPTION_TYPE = S2.OPTION_TYPE         
 AND F.STRIKE_PRICE = S2.STRIKE_PRICE        
)      
FOBROKVIEW,    
FOTRD_BROKTABLE BROKTABLE,    
FOTAXES ,    
FOGLOBALS,    
FOTRD_CLIENTTAXES FOCLIENTTAXES,    
FOTRD_CLIENTBROKSCHEME FOCLIENTBROKSCHEME    
    
WHERE     
 FOBROKVIEW.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE AND     
 FOBROKVIEW.ACTIVITYTIME BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO AND    
 FOBROKVIEW.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE AND     
 FOBROKVIEW.ACTIVITYTIME BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO AND     
 BROKTABLE.TABLE_NO =( CASE  WHEN LEFT(FOBROKVIEW.INST_TYPE,3) = 'FUT' THEN FUT_BROKTABLE ELSE OPT_BROKTABLE END) AND        
 BROKTABLE.TRD_DEL = FOBROKVIEW.RESERVED4 AND    
 MPRICE >= BROKTABLE.LOWER_LIM AND    
 MPRICE < BROKTABLE.UPPER_LIM AND                          
 FOTAXES.TRANS_CAT = (CASE WHEN CL_TYPE = 'PRO' THEN 'PRO' ELSE FOBROKVIEW.TRAN_CAT END ) AND     
 FOBROKVIEW.ACTIVITYTIME BETWEEN FOTAXES.FROM_DATE AND FOTAXES.TO_DATE AND    
 FOBROKVIEW.ACTIVITYTIME BETWEEN FOGLOBALS.YEAR_START_DT AND FOGLOBALS.YEAR_END_DT AND
 FOTAXES.INST_TYPE = LEFT(FOBROKVIEW.INST_TYPE,3)

GO

-- --------------------------------------------------
-- VIEW dbo.FOBROKVIEWFINAL_EXPIRY
-- --------------------------------------------------

CREATE VIEW [dbo].[FOBROKVIEWFINAL_EXPIRY]      
AS      
SELECT TRADE_NO,STATUS,FOBROKVIEW_EXPIRY.INST_TYPE,FOBROKVIEW_EXPIRY.SYMBOL,FOBROKVIEW_EXPIRY.EXPIRYDATE,FOBROKVIEW_EXPIRY.STRIKE_PRICE,FOBROKVIEW_EXPIRY.OPTION_TYPE,      
FOBROKVIEW_EXPIRY.SEC_NAME,BOOKTYPE=1,BOOKTYPENAME,MARKETTYPE,USER_ID,BRANCH_ID,FOBROKVIEW_EXPIRY.SELL_BUY,TRADEQTY,PRICE,PRO_CLI,      
FOBROKVIEW_EXPIRY.PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,TRAN_CAT,OFF_PHONE1,      
ORDER_NO,OPP_BROKER_ID,SETTFLAG,BROK_SCHEME,MPRICE,MULTIPLIER,FOGLOBALS.SERVICE_TAX,      
BROKTABLE.TABLE_NO,BROKTABLE.LINE_NO,BROKTABLE.VAL_PERC,BROKTABLE.NORMAL,BROKTABLE.DAY_PUC,BROKTABLE.DAY_SALES,      
BROKTABLE.SETT_PURCH,BROKTABLE.SETT_SALES,FOCLIENTTAXES.ROUND_TO,FOCLIENTTAXES.ROFIG,FOCLIENTTAXES.ERRNUM,FOCLIENTTAXES.NOZERO,      
INSURANCE_CHRG=0,FOTAXES.TURNOVER_TAX,FOTAXES.SEBITURN_TAX,FOTAXES.BROKER_NOTE,C_REGULAR_LOT,
SERTAX=FOGLOBALS.SERVICE_TAX,FOGLOBALS.YEAR,FOGLOBALS.EXCHANGE,       
BROKAPPLIED = (  CASE        
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW_EXPIRY.SELL_BUY = 1)      
	THEN       
		((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.NORMAL* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW_EXPIRY.SELL_BUY = 2)      
	THEN       
		((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.NORMAL  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOBROKVIEW_EXPIRY.SELL_BUY = 1)      
	THEN        
	        ((FLOOR ( (((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.NORMAL * (FOBROKVIEW_EXPIRY.MPRICE))  /100 ) *    
		POWER(10,FOCLIENTTAXES.ROUND_TO) + FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /  (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) *    
		(FOCLIENTTAXES.ROFIG      
		+FOCLIENTTAXES.ROFIG ) )  / POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOBROKVIEW_EXPIRY.SELL_BUY = 2)      
	THEN       
		((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.NORMAL * (FOBROKVIEW_EXPIRY.MPRICE))/100 ) * POWER(10,FOCLIENTTAXES.ROUND_TO)+    
		FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )       
	THEN       
		((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.DAY_PUC))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' )       
	THEN       
		((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.DAY_PUC * (FOBROKVIEW_EXPIRY.MPRICE))/100) * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )      
	THEN       
		((FLOOR(( FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.DAY_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))     
	WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )      
	THEN 
		((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.DAY_SALES * (FOBROKVIEW_EXPIRY.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )      
	THEN       
		((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      

	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )      
	THEN       
		((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_PURCH * (FOBROKVIEW_EXPIRY.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))   
   
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )      
	THEN       
		((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='P' )      
	THEN       
		((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_SALES * (FOBROKVIEW_EXPIRY.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='V' )       
	THEN       
		((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_PURCH))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='P' )       
	THEN       
		((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_PURCH * (FOBROKVIEW_EXPIRY.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      	
	WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='V' )      
	THEN       
		((FLOOR(( FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='P' )      
	THEN 
		((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_SALES * (FOBROKVIEW_EXPIRY.MPRICE)) / 100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='V' )      
	THEN       
		((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='P' )      
	THEN       
		((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_PURCH * (FOBROKVIEW_EXPIRY.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='V' )      
	THEN       
		((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='P' )      
	THEN       
		((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_SALES * (FOBROKVIEW_EXPIRY.MPRICE)) /100)* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	ELSE  0       
	END       
	) ,      
  
INS_CHRG  = 0,      
  

  	TURN_TAX  = 0 /* 
		((FLOOR(( ((CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FUT_TURNOVER_TAX ELSE OPT_TURNOVER_TAX END * 
		(CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FOBROKVIEW_EXPIRY.PRICE
		ELSE CASE WHEN FOTAXES.TURNOVER_TAX_ON='PRICE'  THEN  FOBROKVIEW_EXPIRY.PRICE
		ELSE CASE WHEN FOTAXES.TURNOVER_TAX_ON='SPRICE' THEN  FOBROKVIEW_EXPIRY.SPRICE
		ELSE FOBROKVIEW_EXPIRY.SPPRICE  END END END) * FOBROKVIEW_EXPIRY.TRADEQTY)/100 ) * 
		POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /  
		POWER(10,FOCLIENTTAXES.ROUND_TO))*/,
	
	OTHER_CHRG = 
		((FLOOR(( ((CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FUT_OTHER_CHRG ELSE OPT_OTHER_CHRG END  * 
		(CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN	FOBROKVIEW_EXPIRY.PRICE
		ELSE CASE WHEN FOTAXES.OTHER_CHRG_ON='PRICE'  THEN  FOBROKVIEW_EXPIRY.PRICE
		ELSE CASE WHEN FOTAXES.OTHER_CHRG_ON='SPRICE' THEN  FOBROKVIEW_EXPIRY.SPRICE
		ELSE FOBROKVIEW_EXPIRY.SPPRICE  END END END) * FOBROKVIEW_EXPIRY.TRADEQTY)/100 ) * 
		POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) /  
		POWER(10,FOCLIENTTAXES.ROUND_TO)),
	
	SEBI_TAX =     
		((FLOOR(( ((CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN FUT_SEBITURN_TAX ELSE OPT_SEBITURN_TAX END  *
		(CASE WHEN FOTAXES.INST_TYPE ='FUT' THEN	FOBROKVIEW_EXPIRY.PRICE
		ELSE CASE WHEN FOTAXES.SEBI_TAX_ON='PRICE'  THEN  FOBROKVIEW_EXPIRY.PRICE
		ELSE CASE WHEN FOTAXES.SEBI_TAX_ON='SPRICE' THEN  FOBROKVIEW_EXPIRY.SPRICE
		ELSE FOBROKVIEW_EXPIRY.SPPRICE  END END END) * FOBROKVIEW_EXPIRY.TRADEQTY)/100) * 
		POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) / 
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG +FOCLIENTTAXES.NOZERO ) ) / 
		POWER(10,FOCLIENTTAXES.ROUND_TO)),
	    
BROKER_CHRG =  0,
CPID=0,INSTRUMENT=1,TMARK=0,SCHEME=BROK_SCHEME,DUMMY1=0,RESERVED1=0,RESERVED2=0,CL_TYPE,      
DUMMY2 =       
(CASE        
	WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW_EXPIRY.SELL_BUY = 1)      
	THEN       
		((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.NORMAL* POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOBROKVIEW_EXPIRY.SELL_BUY = 2)      
	THEN       
		((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.NORMAL  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' )       
	THEN       
		((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.DAY_PUC))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )      
	THEN       
		((FLOOR(( FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.DAY_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )      
	THEN       
		((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )      
	THEN       
		((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='V' )       
	THEN       
		((FLOOR(( ((FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_PURCH))  * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN (FOBROKVIEW_EXPIRY.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='V' )      
	THEN       
		((FLOOR(( FOBROKVIEW_EXPIRY.MULTIPLIER*BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='V' )      
	THEN       
		((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	WHEN ( FOBROKVIEW_EXPIRY.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='V' )      
	THEN    ((FLOOR((FOBROKVIEW_EXPIRY.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,FOCLIENTTAXES.ROUND_TO)+FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.ERRNUM ) /        
		(FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO )) * (FOCLIENTTAXES.ROFIG + FOCLIENTTAXES.NOZERO ) )  /       
		POWER(10,FOCLIENTTAXES.ROUND_TO))      
	ELSE  0       
	END )       
FROM      
(
	SELECT F.TRADE_NO,  
	STATUS,F.INST_TYPE,F.SYMBOL,F.EXPIRYDATE,  F.STRIKE_PRICE,F.OPTION_TYPE,S2.SEC_NAME,BOOKTYPE,BOOKTYPENAME,MARKETTYPE,
	USER_ID,BRANCH_ID=(CASE WHEN (SELECT MEMBERTYPE FROM FOOWNER) = 'CM' THEN TMPARTYCODE ELSE BRANCH_ID END),
	SELL_BUY,TRADEQTY,PRICE,PRO_CLI,
	F.PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,ACTIVITYTIME,LAST_MOD_TIME,
	ORDER_NO,OPP_BROKER_ID,SETTFLAG,C2.STD_RATE,C2.BROK1_TABLENO,TRAN_CAT,OFF_PHONE1,
	C2.DUMMY6,C2.DUMMY7,CL_TYPE,MPRICE = F.PRICE,
	MULTIPLIER = ( CASE WHEN ( C2.BROK_SCHEME = 4 OR C2.BROK_SCHEME = 5 OR C2.BROK_SCHEME = 6 OR 
		C2.BROK_SCHEME = 24 OR C2.BROK_SCHEME = 25 OR C2.BROK_SCHEME = 26)  
		 THEN CEILING(CONVERT(NUMERIC(19,2),TRADEQTY) / CONVERT(NUMERIC(19,2),C_REGULAR_LOT))/
		(CASE WHEN TRADEQTY = 0 THEN 1 ELSE TRADEQTY END)
		 ELSE  1
	       	END), 
	TAXPRICE = (CASE WHEN TAXESFLAG = 0 
	        THEN PRICE 
	        ELSE
	     (CASE WHEN TAXESFLAG = 1 
	    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )    
	                   ELSE F.STRIKE_PRICE + PRICE  
	      END)
	   END),
	SPRICE = F.STRIKE_PRICE ,
	SPPRICE = F.STRIKE_PRICE + F.PRICE ,
	C_REGULAR_LOT
	FROM FOTRADE F, CLIENT2 C2,FOSCRIP2 S2,CLIENT1 C1, FOOWNER
	WHERE C2.PARTY_CODE = F.PARTY_CODE 
	AND C1.CL_CODE = C2.CL_CODE
	AND F.INST_TYPE = S2.INST_TYPE 
	AND F.SYMBOL = S2.SYMBOL      
	AND F.EXPIRYDATE = S2.EXPIRYDATE
	AND F.OPTION_TYPE = S2.OPTION_TYPE 
	AND F.STRIKE_PRICE = S2.STRIKE_PRICE
)
FOBROKVIEW_EXPIRY,BROKTABLE,
(
	SELECT  T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.EXPIRYDATE  ,T1.STRIKE_PRICE ,T1.OPTION_TYPE,  
	      PQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END),0),  
	      SQTY = ISNULL(SUM(CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END),0)  
	FROM FOTRADE T1  
	GROUP BY T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.EXPIRYDATE ,T1.STRIKE_PRICE  ,T1.OPTION_TYPE
)
S,FOTAXES ,
FOGLOBALS ,
FOCLIENTTAXES,
FOCLIENTBROKSCHEME

WHERE 
	FOBROKVIEW_EXPIRY.PARTY_CODE = FOCLIENTTAXES.PARTY_CODE AND 
	FOBROKVIEW_EXPIRY.ACTIVITYTIME BETWEEN FOCLIENTTAXES.DATE_FROM AND FOCLIENTTAXES.DATE_TO AND
	FOBROKVIEW_EXPIRY.PARTY_CODE = FOCLIENTBROKSCHEME.PARTY_CODE AND 
	FOBROKVIEW_EXPIRY.ACTIVITYTIME BETWEEN FOCLIENTBROKSCHEME.DATE_FROM AND FOCLIENTBROKSCHEME.DATE_TO AND
	
	FOBROKVIEW_EXPIRY.PARTY_CODE = S.PARTY_CODE AND      
	FOBROKVIEW_EXPIRY.INST_TYPE=S.INST_TYPE AND        
	FOBROKVIEW_EXPIRY.SYMBOL=S.SYMBOL AND      
	FOBROKVIEW_EXPIRY.EXPIRYDATE=S.EXPIRYDATE  AND      
	FOBROKVIEW_EXPIRY.STRIKE_PRICE = S.STRIKE_PRICE AND                       
	FOBROKVIEW_EXPIRY.OPTION_TYPE = S.OPTION_TYPE AND        

	BROKTABLE.TABLE_NO = ( CASE WHEN (FOBROKVIEW_EXPIRY.TRAN_CAT = 'TRD')  THEN 
	                   		FUT_EXP_BROKTABLE          
					END ) AND
	BROKTABLE.LINE_NO = (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE 
				BROKTABLE.TABLE_NO = FUT_EXP_BROKTABLE   
				AND S.PARTY_CODE =  FOBROKVIEW_EXPIRY.PARTY_CODE          
				AND TRD_DEL = 'T'        
	                    	AND FOBROKVIEW_EXPIRY.MPRICE <= BROKTABLE.UPPER_LIM ) 

	AND FOTAXES.TRANS_CAT = (CASE WHEN CL_TYPE = 'PRO' THEN 'PRO' ELSE 'DEL' END ) 
	AND FOTAXES.INST_TYPE = LEFT(FOBROKVIEW_EXPIRY.INST_TYPE,3) 
	AND YEAR_END_DT >= ACTIVITYTIME      
	AND YEAR_START_DT <= ACTIVITYTIME      
	AND ACTIVITYTIME >= FOTAXES.FROM_DATE      
	AND ACTIVITYTIME <= FOTAXES.TO_DATE

GO

-- --------------------------------------------------
-- VIEW dbo.FOCONFIRMVIEW
-- --------------------------------------------------

CREATE VIEW  [dbo].[FOCONFIRMVIEW] AS   
SELECT FOBROKVIEWFINAL.TRADE_NO,FOBROKVIEWFINAL.PARTY_CODE,FOBROKVIEWFINAL.INST_TYPE,FOBROKVIEWFINAL.SYMBOL,  
 FOBROKVIEWFINAL.SEC_NAME,FOBROKVIEWFINAL.EXPIRYDATE,FOBROKVIEWFINAL.STRIKE_PRICE,FOBROKVIEWFINAL.OPTION_TYPE,  
 FOBROKVIEWFINAL.TRADEQTY,FOBROKVIEWFINAL.MARKETTYPE,  
 FOBROKVIEWFINAL.USER_ID,FOBROKVIEWFINAL.ORDER_NO,FOBROKVIEWFINAL.PRICE,FOBROKVIEWFINAL.PRO_CLI,  
 FOBROKVIEWFINAL.O_C_FLAG,FOBROKVIEWFINAL.C_U_FLAG,FOBROKVIEWFINAL.ACTIVITYTIME,  
 FOBROKVIEWFINAL.TABLE_NO,FOBROKVIEWFINAL.LINE_NO,FOBROKVIEWFINAL.VAL_PERC,FOBROKVIEWFINAL.NORMAL,  
 FOBROKVIEWFINAL.DAY_PUC,FOBROKVIEWFINAL.DAY_SALES,FOBROKVIEWFINAL.SETT_PURCH,FOBROKVIEWFINAL.SETT_SALES,  
 FOBROKVIEWFINAL.SELL_BUY,FOBROKVIEWFINAL.SETTFLAG,  
 FOBROKVIEWFINAL.INSURANCE_CHRG,FOBROKVIEWFINAL.TURNOVER_TAX,  
 FOBROKVIEWFINAL.SEBITURN_TAX,FOBROKVIEWFINAL.BROKER_NOTE,SERTAX,YEAR,  
 FOBROKVIEWFINAL.EXCHANGE,OFF_PHONE1,  
 BROKAPPLIED ,NETRATE = (CASE WHEN FOBROKVIEWFINAL.SELL_BUY = 1   
               THEN FOBROKVIEWFINAL.PRICE + BROKAPPLIED   
 ELSE FOBROKVIEWFINAL.PRICE - BROKAPPLIED   
   END),    
 AMOUNT = FOBROKVIEWFINAL.TRADEQTY * (CASE WHEN FOBROKVIEWFINAL.SELL_BUY = 1   
      THEN ( FOBROKVIEWFINAL.PRICE + BROKAPPLIED )  
         ELSE ( FOBROKVIEWFINAL.PRICE - BROKAPPLIED )  
   END) * BOOKTYPE / INSTRUMENT,   
 INS_CHRG,TURN_TAX,FOBROKVIEWFINAL.OTHER_CHRG,SEBI_TAX,BROKER_CHRG,  
 SERVICE_TAX = CASE WHEN CLIENT2.SERVICE_CHRG = 1 AND CLIENT2.SERTAXMETHOD = 1 THEN 0 ELSE  
   ((FLOOR ( ((BROKAPPLIED*TRADEQTY*BOOKTYPE/INSTRUMENT)*FOBROKVIEWFINAL.SERVICE_TAX/100 *   
   POWER(10,FOBROKVIEWFINAL.ROUND_TO) + FOBROKVIEWFINAL.ROFIG + FOBROKVIEWFINAL.ERRNUM  ) /   
    (FOBROKVIEWFINAL.ROFIG + FOBROKVIEWFINAL.NOZERO)) * (FOBROKVIEWFINAL.ROFIG +  
    FOBROKVIEWFINAL.NOZERO) )  / POWER(10,FOBROKVIEWFINAL.ROUND_TO)) END,  
 TRADE_AMOUNT = FOBROKVIEWFINAL.TRADEQTY * FOBROKVIEWFINAL.PRICE * BOOKTYPE / INSTRUMENT,AUCTIONPART = '',  
 PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,  
 FOBROKVIEWFINAL.DUMMY1,FOBROKVIEWFINAL.DUMMY2,RESERVED1,RESERVED2,CL_TYPE,C_REGULAR_LOT,  
 BOOKTYPENAME,LAST_MOD_TIME,OPP_BROKER_ID ,RESERVED4
FROM FOBROKVIEWFINAL , CLIENT2 WHERE CLIENT2.PARTY_CODE = FOBROKVIEWFINAL.PARTY_CODE

GO

-- --------------------------------------------------
-- VIEW dbo.FOCONFIRMVIEW_EXPIRY
-- --------------------------------------------------
CREATE  VIEW [dbo].[FOCONFIRMVIEW_EXPIRY] AS   
SELECT DISTINCT FOBROKVIEWFINAL_EXPIRY.TRADE_NO,FOBROKVIEWFINAL_EXPIRY.PARTY_CODE,  
	FOBROKVIEWFINAL_EXPIRY.INST_TYPE,FOBROKVIEWFINAL_EXPIRY.SYMBOL,FOBROKVIEWFINAL_EXPIRY.SEC_NAME,  
	FOBROKVIEWFINAL_EXPIRY.EXPIRYDATE,FOBROKVIEWFINAL_EXPIRY.STRIKE_PRICE,FOBROKVIEWFINAL_EXPIRY.OPTION_TYPE,  
	FOBROKVIEWFINAL_EXPIRY.TRADEQTY,FOBROKVIEWFINAL_EXPIRY.MARKETTYPE,FOBROKVIEWFINAL_EXPIRY.USER_ID,  
	FOBROKVIEWFINAL_EXPIRY.ORDER_NO,FOBROKVIEWFINAL_EXPIRY.PRICE,FOBROKVIEWFINAL_EXPIRY.PRO_CLI,  
	FOBROKVIEWFINAL_EXPIRY.O_C_FLAG,FOBROKVIEWFINAL_EXPIRY.C_U_FLAG,FOBROKVIEWFINAL_EXPIRY.ACTIVITYTIME,  
	FOBROKVIEWFINAL_EXPIRY.TABLE_NO,FOBROKVIEWFINAL_EXPIRY.LINE_NO,FOBROKVIEWFINAL_EXPIRY.VAL_PERC,  
	FOBROKVIEWFINAL_EXPIRY.NORMAL,FOBROKVIEWFINAL_EXPIRY.DAY_PUC,FOBROKVIEWFINAL_EXPIRY.DAY_SALES,  
	FOBROKVIEWFINAL_EXPIRY.SETT_PURCH,FOBROKVIEWFINAL_EXPIRY.SETT_SALES,FOBROKVIEWFINAL_EXPIRY.SELL_BUY,  
	FOBROKVIEWFINAL_EXPIRY.SETTFLAG,FOBROKVIEWFINAL_EXPIRY.INSURANCE_CHRG,
	FOBROKVIEWFINAL_EXPIRY.TURNOVER_TAX,FOBROKVIEWFINAL_EXPIRY.SEBITURN_TAX,
	FOBROKVIEWFINAL_EXPIRY.BROKER_NOTE,SERTAX,YEAR,  
	FOBROKVIEWFINAL_EXPIRY.EXCHANGE,OFF_PHONE1,BROKAPPLIED ,  
	NETRATE = (CASE WHEN FOBROKVIEWFINAL_EXPIRY.SELL_BUY = 1   
	              THEN FOBROKVIEWFINAL_EXPIRY.PRICE + BROKAPPLIED   
	  ELSE FOBROKVIEWFINAL_EXPIRY.PRICE - BROKAPPLIED   
	    END),    
	AMOUNT = FOBROKVIEWFINAL_EXPIRY.TRADEQTY * (CASE WHEN FOBROKVIEWFINAL_EXPIRY.SELL_BUY = 1   
	     THEN ( FOBROKVIEWFINAL_EXPIRY.PRICE + BROKAPPLIED )  
	        ELSE ( FOBROKVIEWFINAL_EXPIRY.PRICE - BROKAPPLIED )  
	  END)*BOOKTYPE/INSTRUMENT,   
	INS_CHRG,TURN_TAX,FOBROKVIEWFINAL_EXPIRY.OTHER_CHRG,SEBI_TAX,BROKER_CHRG,  
	SERVICE_TAX = CASE WHEN CLIENT2.SERVICE_CHRG = 1 AND CLIENT2.SERTAXMETHOD = 1 THEN 0 ELSE
			((FLOOR ( (BROKAPPLIED*TRADEQTY*BOOKTYPE/INSTRUMENT*FOBROKVIEWFINAL_EXPIRY.SERVICE_TAX/100 *
			 POWER(10,FOBROKVIEWFINAL_EXPIRY.ROUND_TO) + FOBROKVIEWFINAL_EXPIRY.ROFIG +
			 FOBROKVIEWFINAL_EXPIRY.ERRNUM  ) /  (FOBROKVIEWFINAL_EXPIRY.ROFIG + 
			FOBROKVIEWFINAL_EXPIRY.NOZERO)) * (FOBROKVIEWFINAL_EXPIRY.ROFIG + 
			FOBROKVIEWFINAL_EXPIRY.NOZERO) )  / POWER(10,FOBROKVIEWFINAL_EXPIRY.ROUND_TO)) END,  
	TRADE_AMOUNT = FOBROKVIEWFINAL_EXPIRY.TRADEQTY * FOBROKVIEWFINAL_EXPIRY.PRICE*BOOKTYPE/INSTRUMENT ,
	PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,FOBROKVIEWFINAL_EXPIRY.DUMMY1,
	FOBROKVIEWFINAL_EXPIRY.DUMMY2,RESERVED1,RESERVED2,CL_TYPE,AUCTIONPART = CASE WHEN LEFT(INST_TYPE,3)= 'FUT' THEN 'EA' ELSE 'CA' END
	,C_REGULAR_LOT  
FROM FOBROKVIEWFINAL_EXPIRY  , CLIENT2 WHERE CLIENT2.PARTY_CODE = FOBROKVIEWFINAL_EXPIRY.PARTY_CODE

GO

-- --------------------------------------------------
-- VIEW dbo.FOCURSORCONTSALE
-- --------------------------------------------------
CREATE VIEW [dbo].[FOCURSORCONTSALE]  
AS  
SELECT T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.SEC_NAME,T1.EXPIRYDATE,T1.STRIKE_PRICE,T1.OPTION_TYPE,SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11),      
PQTY = SUM(PQTY),SQTY=SUM(SQTY)  
FROM 
(
        SELECT T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.SEC_NAME,T1.EXPIRYDATE,T1.STRIKE_PRICE,T1.OPTION_TYPE,T1.SELL_BUY,
        TRADEQTY,SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11), /*  T1.PRICE,  */    
        PQTY = (CASE WHEN SELL_BUY = 1 THEN SUM(TRADEQTY) ELSE 0 END ),
        SQTY = (CASE WHEN SELL_BUY = 2 THEN SUM(TRADEQTY) ELSE 0 END )
        FROM FOSETTLEMENT T1, CLIENT2  WHERE  TRADEQTY > 0  
        AND T1.PARTY_CODE = CLIENT2.PARTY_CODE
        GROUP BY T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.SEC_NAME,T1.EXPIRYDATE,T1.STRIKE_PRICE,T1.OPTION_TYPE,T1.SELL_BUY,
        T1.TRADEQTY,LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)  
) T1   
GROUP BY T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.SEC_NAME,T1.EXPIRYDATE,T1.STRIKE_PRICE,T1.OPTION_TYPE,LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)

GO

-- --------------------------------------------------
-- VIEW dbo.FOCURSORCONTUNEQUALSALEPUR
-- --------------------------------------------------
CREATE VIEW [dbo].[FOCURSORCONTUNEQUALSALEPUR] AS 
SELECT S1.PARTY_CODE,S1.INST_TYPE,S1.SYMBOL,S1.SEC_NAME,S1.EXPIRYDATE,S1.STRIKE_PRICE,S1.OPTION_TYPE,SAUDA_DATE,
ISNULL(S1.PQTY,0) PQTY,ISNULL(S1.SQTY,0) SQTY 
FROM 
(
        SELECT T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.SEC_NAME,T1.EXPIRYDATE,T1.STRIKE_PRICE,T1.OPTION_TYPE,
        SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11), /*  T1.PRICE,  */      
        PQTY = SUM(PQTY),SQTY=SUM(SQTY)  
        FROM 
        (
        SELECT T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.SEC_NAME,T1.EXPIRYDATE,T1.STRIKE_PRICE,T1.OPTION_TYPE,T1.SELL_BUY,
        TRADEQTY,SAUDA_DATE = LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11), /*  T1.PRICE,  */    
        PQTY =
        	(CASE WHEN SELL_BUY = 1 THEN SUM(TRADEQTY) ELSE 0 END ),
        
        SQTY = 
        	(CASE WHEN SELL_BUY = 2 THEN SUM(TRADEQTY) ELSE 0 END )
        FROM FOSETTLEMENT T1, CLIENT2  WHERE  TRADEQTY > 0  
        AND T1.PARTY_CODE = CLIENT2.PARTY_CODE
        GROUP BY T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.SEC_NAME,T1.EXPIRYDATE,T1.STRIKE_PRICE,T1.OPTION_TYPE,T1.SELL_BUY,
        T1.TRADEQTY,LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)  
        ) T1   
        GROUP BY T1.PARTY_CODE,T1.INST_TYPE,T1.SYMBOL,T1.SEC_NAME,T1.EXPIRYDATE,T1.STRIKE_PRICE,T1.OPTION_TYPE,
        LEFT(CONVERT(VARCHAR,SAUDA_DATE,109),11)    
) S1 
GROUP BY SAUDA_DATE,S1.PARTY_CODE,S1.INST_TYPE,S1.SYMBOL,S1.SEC_NAME,S1.EXPIRYDATE,S1.STRIKE_PRICE,S1.OPTION_TYPE,SQTY,PQTY

GO

-- --------------------------------------------------
-- VIEW dbo.FODAILYCONFFSHEETVIEW
-- --------------------------------------------------
CREATE VIEW [dbo].[FODAILYCONFFSHEETVIEW]
AS
SELECT S.PARTY_CODE,INST_TYPE,SYMBOL,LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11)AS EXPDATE,
CONVERT(VARCHAR,EXPIRYDATE,103)AS EXPIRYDATE,
TRADE_NO=(CASE WHEN AUCTIONPART = 'EA' THEN 'FINAL' ELSE TRADE_NO END),
PQTY=(CASE WHEN SELL_BUY = 1 THEN TRADEQTY/BILLNO ELSE 0 END),
SQTY =(CASE WHEN SELL_BUY = 2 THEN TRADEQTY/BILLNO ELSE 0 END),
PAMT=((CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)*PRICE*BOOKTYPE/INSTRUMENT),
SAMT=((CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)*PRICE*BOOKTYPE/INSTRUMENT),
SAUDA_DATE,YEAR(EXPIRYDATE) AS YEXP,MONTH(EXPIRYDATE) AS MEXP,DAY(EXPIRYDATE)AS DEXP,
NETRATE=PRICE,
CHARGES=(BROKAPPLIED*TRADEQTY*BOOKTYPE/INSTRUMENT) 
	  + (CASE WHEN C2.SERVICE_CHRG <> 2 
		  THEN (SERVICE_TAX)
		  ELSE 0 
             END)
	  + (CASE WHEN TURNOVER_TAX = 1 
		  THEN (TURN_TAX)		
		  ELSE 0 
             END)	 
	  + (CASE WHEN SEBI_TURN_TAX = 1 
		  THEN (SEBI_TAX)		
		  ELSE 0 
             END)		
	  + (CASE WHEN BROKERNOTE = 1 
		  THEN (BROKER_CHRG)
		  ELSE 0 
             END)
      + (CASE WHEN C2.OTHER_CHRG = 1
		THEN (S.OTHER_CHRG)
		ELSE 0
	END) ,
BROKERAGE=(BROKAPPLIED*TRADEQTY*BOOKTYPE/INSTRUMENT),
SERVICE_TAX=(CASE WHEN C2.SERVICE_CHRG <> 2 
		  THEN (SERVICE_TAX)
		  ELSE 0 
	     END ),
BROKER_NOTE=(CASE WHEN BROKERNOTE = 1 
		  THEN (BROKER_CHRG)
		  ELSE 0 
             END),
TURN_TAX=(CASE WHEN TURNOVER_TAX = 1 
		  THEN ( TURN_TAX)		
		  ELSE 0 
             END),
SEBI_TAX=(CASE WHEN SEBI_TURN_TAX = 1 
		  THEN (SEBI_TAX)		
		  ELSE 0 
             END),
OTHER_CHRG = (CASE WHEN C2.OTHER_CHRG = 1
			THEN (S.OTHER_CHRG)
			ELSE 0
				END)
FROM FOSETTLEMENT S , CLIENT2 C2
WHERE INST_TYPE LIKE 'FUT%' 
AND C2.PARTY_CODE = S.PARTY_CODE

GO

-- --------------------------------------------------
-- VIEW dbo.FODAILYCONFOPSHEETVIEW
-- --------------------------------------------------
CREATE VIEW [dbo].[FODAILYCONFOPSHEETVIEW]
AS
SELECT S.PARTY_CODE,INST_TYPE,SYMBOL,LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11)AS EXPDATE,
CONVERT(VARCHAR,EXPIRYDATE,103)AS EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE,TRADE_NO,
PQTY=(CASE WHEN SELL_BUY = 1 THEN TRADEQTY/BILLNO ELSE 0 END),
SQTY =(CASE WHEN SELL_BUY = 2 THEN TRADEQTY/BILLNO ELSE 0 END),
PAMT=((CASE WHEN SELL_BUY = 1 THEN TRADEQTY ELSE 0 END)*PRICE*BOOKTYPE/INSTRUMENT),
SAMT=((CASE WHEN SELL_BUY = 2 THEN TRADEQTY ELSE 0 END)*PRICE*BOOKTYPE/INSTRUMENT),
SAUDA_DATE,YEAR(EXPIRYDATE) AS YEXP,MONTH(EXPIRYDATE) AS MEXP,DAY(EXPIRYDATE)AS DEXP,
NETRATE=PRICE,
CHARGES=(BROKAPPLIED*TRADEQTY*BOOKTYPE/INSTRUMENT) 
	  + (CASE WHEN C2.SERVICE_CHRG <> 2 
		  THEN (SERVICE_TAX)
		  ELSE 0 
             END)
	  + (CASE WHEN TURNOVER_TAX = 1 
		  THEN (TURN_TAX)		
		  ELSE 0 
             END)	 
	  + (CASE WHEN SEBI_TURN_TAX = 1 
		  THEN (SEBI_TAX)		
		  ELSE 0 
             END)		
	  + (CASE WHEN BROKERNOTE = 1 
		  THEN (BROKER_CHRG)
		  ELSE 0 
             END)
      + (CASE WHEN C2.OTHER_CHRG = 1
		THEN (S.OTHER_CHRG)
		ELSE 0
	END) ,
BROKERAGE=(BROKAPPLIED*TRADEQTY*BOOKTYPE/INSTRUMENT),
SERVICE_TAX=(CASE WHEN C2.SERVICE_CHRG <> 2 
		  THEN (SERVICE_TAX)
		  ELSE 0 
	     END ),
BROKER_NOTE=(CASE WHEN BROKERNOTE = 1 
		  THEN (BROKER_CHRG)
		  ELSE 0 
             END),
TURN_TAX=(CASE WHEN TURNOVER_TAX = 1 
		  THEN ( TURN_TAX)		
		  ELSE 0 
             END),
SEBI_TAX=(CASE WHEN SEBI_TURN_TAX = 1 
		  THEN (SEBI_TAX)		
		  ELSE 0 
             END),
OTHER_CHRG = (CASE WHEN C2.OTHER_CHRG = 1
			THEN (S.OTHER_CHRG)
			ELSE 0
				END)
FROM FOSETTLEMENT S , CLIENT2 C2
WHERE  INST_TYPE LIKE 'OPT%'
AND C2.PARTY_CODE = S.PARTY_CODE
AND S.AUCTIONPART <> 'EA'

GO

-- --------------------------------------------------
-- VIEW dbo.FODAILYSHEETBFVIEW
-- --------------------------------------------------

CREATE VIEW [dbo].[FODAILYSHEETBFVIEW] AS
SELECT PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,PQTY=(CASE WHEN SELL_BUY = 1 THEN SUM(TRADEQTY) ELSE 0 END),
SQTY=(CASE WHEN SELL_BUY = 2 THEN SUM(TRADEQTY) ELSE 0 END),S.STRIKE_PRICE,S.OPTION_TYPE,SAUDA_DATE, BILLNO 
FROM FOSETTLEMENT S
WHERE S.AUCTIONPART <> 'EA'
GROUP BY PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE,
SELL_BUY,EXPIRYDATE,SAUDA_DATE,BILLNO

GO

-- --------------------------------------------------
-- VIEW dbo.FODAILYSHEETBFVIEW_NEW
-- --------------------------------------------------
CREATE VIEW [dbo].[FODAILYSHEETBFVIEW_NEW] AS
SELECT PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,PQTY=(CASE WHEN SELL_BUY = 1 THEN SUM(TRADEQTY) ELSE 0 END),
SQTY=(CASE WHEN SELL_BUY = 2 THEN SUM(TRADEQTY) ELSE 0 END),S.STRIKE_PRICE,S.OPTION_TYPE,SAUDA_DATE,BILLNO
FROM FOSETTLEMENT S
GROUP BY PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE,
SELL_BUY,EXPIRYDATE,SAUDA_DATE,BILLNO

GO

-- --------------------------------------------------
-- VIEW dbo.FOEXALLOCCONFIRMVIEW
-- --------------------------------------------------

CREATE VIEW [dbo].[FOEXALLOCCONFIRMVIEW] 
AS 
       SELECT
	FOBROKVIEW_EXALLOCFINAL.TRADE_NO,FOBROKVIEW_EXALLOCFINAL.PARTY_CODE,
	FOBROKVIEW_EXALLOCFINAL.INST_TYPE,FOBROKVIEW_EXALLOCFINAL.SYMBOL,FOBROKVIEW_EXALLOCFINAL.SEC_NAME,
	FOBROKVIEW_EXALLOCFINAL.EXPIRYDATE,FOBROKVIEW_EXALLOCFINAL.STRIKE_PRICE,FOBROKVIEW_EXALLOCFINAL.OPTION_TYPE,
	FOBROKVIEW_EXALLOCFINAL.TRADEQTY,FOBROKVIEW_EXALLOCFINAL.MARKETTYPE,
	FOBROKVIEW_EXALLOCFINAL.USER_ID,FOBROKVIEW_EXALLOCFINAL.ORDER_NO,FOBROKVIEW_EXALLOCFINAL.PRICE,
	FOBROKVIEW_EXALLOCFINAL.PRO_CLI,FOBROKVIEW_EXALLOCFINAL.O_C_FLAG,FOBROKVIEW_EXALLOCFINAL.C_U_FLAG,
	FOBROKVIEW_EXALLOCFINAL.ACTIVITYTIME,
	FOBROKVIEW_EXALLOCFINAL.TABLE_NO,FOBROKVIEW_EXALLOCFINAL.LINE_NO,FOBROKVIEW_EXALLOCFINAL.VAL_PERC,
	FOBROKVIEW_EXALLOCFINAL.NORMAL,FOBROKVIEW_EXALLOCFINAL.DAY_PUC,FOBROKVIEW_EXALLOCFINAL.DAY_SALES,
	FOBROKVIEW_EXALLOCFINAL.SETT_PURCH,FOBROKVIEW_EXALLOCFINAL.SETT_SALES,FOBROKVIEW_EXALLOCFINAL.SELL_BUY,
	FOBROKVIEW_EXALLOCFINAL.SETTFLAG,
	FOBROKVIEW_EXALLOCFINAL.INSURANCE_CHRG,FOBROKVIEW_EXALLOCFINAL.TURNOVER_TAX,
	FOBROKVIEW_EXALLOCFINAL.SEBITURN_TAX,FOBROKVIEW_EXALLOCFINAL.BROKER_NOTE,SERTAX,YEAR,
	FOBROKVIEW_EXALLOCFINAL.EXCHANGE,OFF_PHONE1,
       BROKAPPLIED ,NETRATE = (CASE WHEN FOBROKVIEW_EXALLOCFINAL.SELL_BUY = 1 
		                    THEN FOBROKVIEW_EXALLOCFINAL.PRICE + BROKAPPLIED 
				    ELSE FOBROKVIEW_EXALLOCFINAL.PRICE - BROKAPPLIED 
			       END), 	
       AMOUNT = FOBROKVIEW_EXALLOCFINAL.TRADEQTY * (CASE WHEN FOBROKVIEW_EXALLOCFINAL.SELL_BUY = 1 
		      				 THEN ( FOBROKVIEW_EXALLOCFINAL.PRICE + BROKAPPLIED )
	   	      				 ELSE ( FOBROKVIEW_EXALLOCFINAL.PRICE - BROKAPPLIED )
		 			    END), 
	INS_CHRG,TURN_TAX,FOBROKVIEW_EXALLOCFINAL.OTHER_CHRG,SEBI_TAX,BROKER_CHRG,
	SERVICE_TAX = CASE WHEN C2.SERVICE_CHRG = 1 AND C2.SERTAXMETHOD = 1 THEN 0 ELSE
				((FLOOR ( (BROKAPPLIED*TRADEQTY * FOBROKVIEW_EXALLOCFINAL.SERVICE_TAX/100 * 
				POWER(10,FOBROKVIEW_EXALLOCFINAL.ROUND_TO) +
				FOBROKVIEW_EXALLOCFINAL.ROFIG + FOBROKVIEW_EXALLOCFINAL.ERRNUM  ) /  
				(FOBROKVIEW_EXALLOCFINAL.ROFIG + FOBROKVIEW_EXALLOCFINAL.NOZERO)) * 
				(FOBROKVIEW_EXALLOCFINAL.ROFIG + FOBROKVIEW_EXALLOCFINAL.NOZERO) )  / 
				POWER(10,FOBROKVIEW_EXALLOCFINAL.ROUND_TO)) END,

	TRADE_AMOUNT = FOBROKVIEW_EXALLOCFINAL.TRADEQTY * FOBROKVIEW_EXALLOCFINAL.PRICE,FOBROKVIEW_EXALLOCFINAL.CL_RATE,
	PARTICIPANTCODE,STATUS,CPID,INSTRUMENT,BOOKTYPE,BRANCH_ID,TMARK,SCHEME,
	FOBROKVIEW_EXALLOCFINAL.DUMMY1,FOBROKVIEW_EXALLOCFINAL.DUMMY2,RESERVED1,RESERVED2,
	LEFT(CONVERT(VARCHAR,ACTIVITYTIME,109),11) AS SAUDADT,
	LEFT(CONVERT(VARCHAR,EXPIRYDATE,109),11) AS EXPDATE,C_REGULAR_LOT
	FROM FOBROKVIEW_EXALLOCFINAL ,CLIENT2 C2
WHERE
	C2.PARTY_CODE = FOBROKVIEW_EXALLOCFINAL.PARTY_CODE

GO

-- --------------------------------------------------
-- VIEW dbo.FOMARGINNEW_VIEW
-- --------------------------------------------------

CREATE VIEW FOMARGINNEW_VIEW AS

SELECT * FROM FOMARGINNEW (NOLOCK)

--SELECT *,ADDMARGIN = 0 FROM FOMARGINNEW (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.FOSCRIP1
-- --------------------------------------------------
CREATE VIEW [dbo].[FOSCRIP1] AS
SELECT INST_TYPE,SYMBOL,EXPIRYDATE,STRIKE_PRICE,OPTION_TYPE
FROM FOSCRIP2

GO

-- --------------------------------------------------
-- VIEW dbo.FOSETTBROKVIEW
-- --------------------------------------------------
CREATE  VIEW [dbo].[FOSETTBROKVIEW] 
AS
SELECT F.TRADE_NO,  
STATUS,F.INST_TYPE,F.SYMBOL,F.EXPIRYDATE,  F.STRIKE_PRICE,F.OPTION_TYPE,F.SEC_NAME,BOOKTYPE,MARKETTYPE,
USER_ID,BRANCH_ID,
SELL_BUY,TRADEQTY,PRICE,PRO_CLI,F.PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,SAUDA_DATE,
ORDER_NO,SETTFLAG,C2.STD_RATE,C2.BROK2_TABLENO,C2.BROK_SCHEME,TRAN_CAT,OFF_PHONE1,C2.DUMMY6,C2.DUMMY7,
MPRICE = (CASE WHEN ((C2.DUMMY1 = 0) OR (C2.DUMMY1 = 20))
        THEN PRICE 
        ELSE
     (CASE WHEN (C2.DUMMY1 = 1 OR C2.DUMMY1 = 21 ) 
    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )    
                   ELSE F.STRIKE_PRICE + PRICE  
      END)
   END),
MULTIPLIER = ( CASE WHEN ( C2.BROK_SCHEME = 4 OR C2.BROK_SCHEME = 5 OR C2.BROK_SCHEME = 6 OR C2.BROK_SCHEME = 24 OR C2.BROK_SCHEME = 25 OR C2.BROK_SCHEME = 26)  
  THEN CEILING(CONVERT(NUMERIC(19,2),TRADEQTY) / CONVERT(NUMERIC(19,2),C_REGULAR_LOT))/(CASE WHEN TRADEQTY = 0 THEN 1 ELSE TRADEQTY END)
  ELSE  1
       END), 
TAXPRICE = (CASE WHEN TAXESFLAG = 0 
        THEN PRICE 
        ELSE
     (CASE WHEN TAXESFLAG = 1 
    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )    
                   ELSE F.STRIKE_PRICE + PRICE  
      END)
   END) 
FROM FOSETTLEMENT F, CLIENT2 C2,FOSCRIP2 S2,CLIENT1 C1, FOOWNER
WHERE C2.PARTY_CODE = F.PARTY_CODE 
AND C1.CL_CODE = C2.CL_CODE
AND F.INST_TYPE = S2.INST_TYPE 
AND F.SYMBOL = S2.SYMBOL      
AND F.EXPIRYDATE = S2.EXPIRYDATE
AND F.OPTION_TYPE = S2.OPTION_TYPE 
AND F.STRIKE_PRICE = S2.STRIKE_PRICE

GO

-- --------------------------------------------------
-- VIEW dbo.FOSETTBROKVIEWFINAL
-- --------------------------------------------------

 CREATE VIEW [dbo].[FOSETTBROKVIEWFINAL] AS 
SELECT TRADE_NO,STATUS,FOSETTBROKVIEW.INST_TYPE,FOSETTBROKVIEW.SYMBOL,FOSETTBROKVIEW.EXPIRYDATE,FOSETTBROKVIEW.STRIKE_PRICE,FOSETTBROKVIEW.OPTION_TYPE,
FOSETTBROKVIEW.SEC_NAME,BOOKTYPE,MARKETTYPE,USER_ID,BRANCH_ID,FOSETTBROKVIEW.SELL_BUY,TRADEQTY,PRICE,PRO_CLI,
FOSETTBROKVIEW.PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,SAUDA_DATE,TRAN_CAT,OFF_PHONE1,
ORDER_NO,SETTFLAG,BROK_SCHEME,MPRICE,MULTIPLIER,FOGLOBALS.SERVICE_TAX,
BROKTABLE.TABLE_NO,BROKTABLE.LINE_NO,BROKTABLE.VAL_PERC,BROKTABLE.NORMAL,BROKTABLE.DAY_PUC,BROKTABLE.DAY_SALES,
BROKTABLE.SETT_PURCH,BROKTABLE.SETT_SALES,BROKTABLE.ROUND_TO,BROKTABLE.ROFIG,BROKTABLE.ERRNUM,BROKTABLE.NOZERO,
 INSURANCE_CHRG=0,FOTAXES.TURNOVER_TAX,FOTAXES.SEBITURN_TAX,FOTAXES.BROKER_NOTE,
       SERTAX=FOGLOBALS.SERVICE_TAX,FOGLOBALS.YEAR,FOGLOBALS.EXCHANGE, 
BROKAPPLIED = (  CASE  
                         WHEN ( FOSETTBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTBROKVIEW.SELL_BUY = 1)
                              THEN 
  ((FLOOR((FOSETTBROKVIEW.MULTIPLIER* BROKTABLE.NORMAL* POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( FOSETTBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='V' AND FOSETTBROKVIEW.SELL_BUY = 2)
                              THEN 
  ((FLOOR((FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.NORMAL  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( FOSETTBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTBROKVIEW.SELL_BUY = 1)
                               THEN  
                                          ((FLOOR ( (((FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.NORMAL /100 ) * (FOSETTBROKVIEW.MPRICE))  * POWER(10,BROKTABLE.ROUND_TO) + BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / 
                                           (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / POWER(10,BROKTABLE.ROUND_TO))
                        WHEN ( FOSETTBROKVIEW.SETTFLAG = 1 AND BROKTABLE.VAL_PERC ='P' AND FOSETTBROKVIEW.SELL_BUY = 2)
                             THEN 
  ((FLOOR(( ((FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.NORMAL /100 )* (FOSETTBROKVIEW.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                      WHEN (FOSETTBROKVIEW.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='V' ) 
                            THEN 
  ((FLOOR(( ((FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.DAY_PUC))  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                      WHEN (FOSETTBROKVIEW.SETTFLAG = 2  AND BROKTABLE.VAL_PERC ='P' ) 
                             THEN 
  ((FLOOR(( ((FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.DAY_PUC/100) * (FOSETTBROKVIEW.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                   WHEN (FOSETTBROKVIEW.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
  ((FLOOR(( FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.DAY_SALES * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                  WHEN (FOSETTBROKVIEW.SETTFLAG = 3  AND BROKTABLE.VAL_PERC ='P' )
                             THEN /*ROUND((BROKTABLE.DAY_SALES/ 100) * (FOSETTBROKVIEW.MPRICE) ,BROKTABLE.ROUND_TO) */
  ((FLOOR(( ((FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.DAY_SALES/ 100) * (FOSETTBROKVIEW.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                WHEN ( FOSETTBROKVIEW.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
  ((FLOOR((FOSETTBROKVIEW.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( FOSETTBROKVIEW.SETTFLAG = 4  AND BROKTABLE.VAL_PERC ='P' )
                             THEN 
  ((FLOOR(( ((FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.SETT_PURCH/100) * (FOSETTBROKVIEW.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
             WHEN ( FOSETTBROKVIEW.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
  ((FLOOR((FOSETTBROKVIEW.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( FOSETTBROKVIEW.SETTFLAG = 5  AND BROKTABLE.VAL_PERC ='P' )
                             THEN 
  ((FLOOR(( ((FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.SETT_SALES/100) * (FOSETTBROKVIEW.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))


 
WHEN (FOSETTBROKVIEW.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='V' ) 
                            THEN 
  ((FLOOR(( ((FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.DAY_PUC))  * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                      WHEN (FOSETTBROKVIEW.SETTFLAG = 6  AND BROKTABLE.VAL_PERC ='P' ) 
                             THEN 
  ((FLOOR(( ((FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.DAY_PUC/100) * (FOSETTBROKVIEW.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                   WHEN (FOSETTBROKVIEW.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
  ((FLOOR(( FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.DAY_SALES * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                  WHEN (FOSETTBROKVIEW.SETTFLAG = 7  AND BROKTABLE.VAL_PERC ='P' )
                             THEN /*ROUND((BROKTABLE.DAY_SALES/ 100) * (FOSETTBROKVIEW.MPRICE) ,BROKTABLE.ROUND_TO) */
  ((FLOOR(( ((FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.DAY_SALES/ 100) * (FOSETTBROKVIEW.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                WHEN ( FOSETTBROKVIEW.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
  ((FLOOR((FOSETTBROKVIEW.MULTIPLIER* BROKTABLE.SETT_PURCH * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( FOSETTBROKVIEW.SETTFLAG = 8  AND BROKTABLE.VAL_PERC ='P' )
                             THEN 
  ((FLOOR(( ((FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.SETT_PURCH/100) * (FOSETTBROKVIEW.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
             WHEN ( FOSETTBROKVIEW.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='V' )
                             THEN 
  ((FLOOR((FOSETTBROKVIEW.MULTIPLIER* BROKTABLE.SETT_SALES * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
                         WHEN ( FOSETTBROKVIEW.SETTFLAG = 9  AND BROKTABLE.VAL_PERC ='P' )
                             THEN 
  ((FLOOR(( ((FOSETTBROKVIEW.MULTIPLIER*BROKTABLE.SETT_SALES/100) * (FOSETTBROKVIEW.MPRICE)) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /  
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) )  / 
  POWER(10,BROKTABLE.ROUND_TO))
   ELSE  0 
                        END 
                         ) ,
        INS_CHRG  = 0,
        TURN_TAX  =  ((FLOOR(( ((FOTAXES.TURNOVER_TAX * FOSETTBROKVIEW.TRADEQTY * FOSETTBROKVIEW.TAXPRICE) ) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) /
  (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /
  POWER(10,BROKTABLE.ROUND_TO)),
        OTHER_CHRG = ((FLOOR(( ((FOTAXES.OTHER_CHRG * (FOSETTBROKVIEW.TAXPRICE) * FOSETTBROKVIEW.TRADEQTY)/100 ) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /  POWER(10,BROKTABLE.ROUND_TO)),
        SEBI_TAX =     ((FLOOR(( ((FOTAXES.SEBITURN_TAX *(FOSETTBROKVIEW.TAXPRICE) * FOSETTBROKVIEW.TRADEQTY)/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) / POWER(10,BROKTABLE.ROUND_TO)),
        BROKER_CHRG =  ((FLOOR(( ((FOTAXES.BROKER_NOTE * (FOSETTBROKVIEW.TAXPRICE) * FOSETTBROKVIEW.TRADEQTY)/100) * POWER(10,BROKTABLE.ROUND_TO)+BROKTABLE.ROFIG + BROKTABLE.ERRNUM ) / (BROKTABLE.ROFIG + BROKTABLE.NOZERO )) * (BROKTABLE.ROFIG +BROKTABLE.NOZERO ) ) /POWER(10,BROKTABLE.ROUND_TO))
,CPID=0,INSTRUMENT=0,TMARK=0,SCHEME=FOSETTBROKVIEW.BROK_SCHEME,DUMMY1=0,DUMMY2=0,RESERVED1=0,RESERVED2=0
FROM
(
	SELECT F.TRADE_NO,  
	STATUS,F.INST_TYPE,F.SYMBOL,F.EXPIRYDATE,  F.STRIKE_PRICE,F.OPTION_TYPE,F.SEC_NAME,BOOKTYPE,MARKETTYPE,
	USER_ID,BRANCH_ID,
	SELL_BUY,TRADEQTY,PRICE,PRO_CLI,F.PARTY_CODE,PARTICIPANTCODE,O_C_FLAG,C_U_FLAG,SAUDA_DATE,
	ORDER_NO,SETTFLAG,C2.STD_RATE,C2.BROK2_TABLENO,C2.BROK_SCHEME,TRAN_CAT,OFF_PHONE1,C2.DUMMY6,C2.DUMMY7,
	MPRICE = (CASE WHEN ((C2.DUMMY1 = 0) OR (C2.DUMMY1 = 20))
	        THEN PRICE 
	        ELSE
	     (CASE WHEN (C2.DUMMY1 = 1 OR C2.DUMMY1 = 21 ) 
	    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )    
	                   ELSE F.STRIKE_PRICE + PRICE  
	      END)
	   END),
	MULTIPLIER = ( CASE WHEN ( C2.BROK_SCHEME = 4 OR C2.BROK_SCHEME = 5 OR C2.BROK_SCHEME = 6 OR C2.BROK_SCHEME = 24 OR C2.BROK_SCHEME = 25 OR C2.BROK_SCHEME = 26)  
	  THEN CEILING(CONVERT(NUMERIC(19,2),TRADEQTY) / CONVERT(NUMERIC(19,2),C_REGULAR_LOT))/(CASE WHEN TRADEQTY = 0 THEN 1 ELSE TRADEQTY END)
	  ELSE  1
	       END), 
	TAXPRICE = (CASE WHEN TAXESFLAG = 0 
	        THEN PRICE 
	        ELSE
	     (CASE WHEN TAXESFLAG = 1 
	    THEN (CASE WHEN F.STRIKE_PRICE = 0 THEN F.PRICE ELSE F.STRIKE_PRICE END )    
	                   ELSE F.STRIKE_PRICE + PRICE  
	      END)
	   END) ,CL_TYPE
	FROM FOSETTLEMENT F, CLIENT2 C2,FOSCRIP2 S2,CLIENT1 C1, FOOWNER
	WHERE C2.PARTY_CODE = F.PARTY_CODE 
	AND C1.CL_CODE = C2.CL_CODE
	AND F.INST_TYPE = S2.INST_TYPE 
	AND F.SYMBOL = S2.SYMBOL      
	AND F.EXPIRYDATE = S2.EXPIRYDATE
	AND F.OPTION_TYPE = S2.OPTION_TYPE 
	AND F.STRIKE_PRICE = S2.STRIKE_PRICE)FOSETTBROKVIEW,
BROKTABLE,FOBASALEPUR S,FOTAXES ,FOGLOBALS 
WHERE FOSETTBROKVIEW.PARTY_CODE = S.PARTY_CODE AND
      FOSETTBROKVIEW.INST_TYPE=S.INST_TYPE AND  
      FOSETTBROKVIEW.SYMBOL=S.SYMBOL AND
      FOSETTBROKVIEW.EXPIRYDATE=S.EXPIRYDATE  AND
      FOSETTBROKVIEW.STRIKE_PRICE = S.STRIKE_PRICE AND                 
      FOSETTBROKVIEW.OPTION_TYPE = S.OPTION_TYPE    AND  
      YEAR_START_DT >= SAUDA_DATE AND
      YEAR_START_DT <= SAUDA_DATE AND
	 SAUDA_DATE >= FOTAXES.FROM_DATE AND
	 SAUDA_DATE <= FOTAXES.TO_DATE 

AND
      BROKTABLE.TABLE_NO =(CASE 
                                WHEN 
                                    LEFT(FOSETTBROKVIEW.INST_TYPE,3) = 'FUT' /*  AND SETTFLAG IN(1,2,3,4,5) */
                                THEN 
                                    FOSETTBROKVIEW.STD_RATE
                              /*   WHEN 
                                    LEFT(FOSETTBROKVIEW.INST_TYPE,3) = 'FUT'  AND SETTFLAG IN(6,7,8,9)
          THEN 
                                    FOSETTBROKVIEW.DUMMY6
                                WHEN 
                                    SETTFLAG IN(6,7,8,9)
                                THEN 
                                    FOSETTBROKVIEW.DUMMY7  */
                                ELSE 
                                    FOSETTBROKVIEW.BROK2_TABLENO
                                END)
           AND   
           BROKTABLE.LINE_NO =  ( CASE WHEN 

                                           /* (FOSETTBROKVIEW.BROK_SCHEME = 1  OR FOSETTBROKVIEW.BROK_SCHEME = 5 ) */
                                           FOSETTBROKVIEW.BROK_SCHEME IN (1,5,21,25) 
                                       THEN     
                                           (SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE
                                            BROKTABLE.TABLE_NO =(CASE 
                                                                     WHEN 
                                                                         LEFT(FOSETTBROKVIEW.INST_TYPE,3) = 'FUT' /*   AND SETTFLAG IN(1,2,3,4,5)  */
                                                                     THEN 
                                                                         FOSETTBROKVIEW.STD_RATE
                                                                    /* WHEN 
                                                                         LEFT(FOSETTBROKVIEW.INST_TYPE,3) = 'FUT'  AND SETTFLAG IN(6,7,8,9)
                                                                     THEN 
                                                                         FOSETTBROKVIEW.DUMMY6 
                                                                     WHEN 
                                                                         SETTFLAG IN(6,7,8,9)
                                                                     THEN 
                                                                         FOSETTBROKVIEW.DUMMY7  */

                                                                     ELSE 
                                                                         FOSETTBROKVIEW.BROK2_TABLENO
                                                                 END)
           AND TRD_DEL = 
( CASE 
                              WHEN ((S.PQTY >= S.SQTY) AND SETTFLAG IN (1,2,3,4,5)) 
                              THEN 
                                  ( CASE 
                                        WHEN ( FOSETTBROKVIEW.SELL_BUY = 1 ) 
                    THEN 
                                            'F'  
                                        ELSE 
                                            'S'
                                    END )
                           WHEN 
                               SETTFLAG IN(6,7) 
                           THEN
                                'S' 
                           WHEN 
                                SETTFLAG IN(8,9) 
                           THEN
                               'F'
                           WHEN 
                               ((S.PQTY < S.SQTY) AND SETTFLAG IN (1,2,3,4,5))
                           THEN 
                              ( CASE 
                                WHEN
                                    ( FOSETTBROKVIEW.SELL_BUY = 2 ) 
                                THEN 
                                    'F'  
                                ELSE
                                    'S'
                                END )
                           WHEN 
                               SETTFLAG IN(6,7) 
                           THEN
                                'S' 
                           WHEN 
                                SETTFLAG IN(8,9) 
                           THEN
                               'F'

 
                        END )     
 
   AND FOSETTBROKVIEW.PARTY_CODE =  S.PARTY_CODE    
                           AND FOSETTBROKVIEW.MPRICE <= BROKTABLE.UPPER_LIM)  
        
                           WHEN 
                               /* ( FOSETTBROKVIEW.BROK_SCHEME = 3 OR FOSETTBROKVIEW.BROK_SCHEME = 6 ) */
                               FOSETTBROKVIEW.BROK_SCHEME IN (3,6,23,26) 
                           THEN     
                               ( SELECT MIN(BROKTABLE.LINE_NO) FROM BROKTABLE WHERE
                                        BROKTABLE.TABLE_NO =  ( CASE WHEN 
                                                                         LEFT(FOSETTBROKVIEW.INST_TYPE,3) = 'FUT' /*  AND SETTFLAG IN(1,2,3,4,5)  */
                                                                     THEN 
                                                                         FOSETTBROKVIEW.STD_RATE
                                                                    /*  WHEN 
                                                                          LEFT(FOSETTBROKVIEW.INST_TYPE,3) = 'FUT'  AND SETTFLAG IN(6,7,8,9)
                                                                     THEN 
                                                                         FOSETTBROKVIEW.DUMMY6
                                                                     WHEN 
                                                                         SETTFLAG IN(6,7,8,9)
                                                                     THEN 
                                                                         FOSETTBROKVIEW.DUMMY7 */

                                                                     ELSE 
                                                                         FOSETTBROKVIEW.BROK2_TABLENO
   END)
              
           AND TRD_DEL = 
                        ( CASE 
                              WHEN ((S.PQTY >= S.SQTY) AND SETTFLAG IN (1,2,3,4,5)) 
                              THEN 
                                  ( CASE 
                                        WHEN ( FOSETTBROKVIEW.SELL_BUY = 1 ) 
                                        THEN 
                                            'F'  
                                        ELSE 
                                            'S'
                                    END )
                           WHEN 
                               SETTFLAG IN(6,7) 
                           THEN
                                'S' 
                           WHEN 
                                SETTFLAG IN(8,9) 
           THEN
                               'F'
                           WHEN 
                               ((S.PQTY < S.SQTY) AND SETTFLAG IN (1,2,3,4,5))
                           THEN 
                              ( CASE 
                                WHEN
                                    ( FOSETTBROKVIEW.SELL_BUY = 2 ) 
                                THEN 
                                    'F'  
                                ELSE
                                    'S'
                                END)
                           WHEN 
                               SETTFLAG IN(6,7) 
                           THEN
                                'S' 
                           WHEN 
                                SETTFLAG IN(8,9) 
                           THEN
                               'F'
                                
 
                        END )     
            /*  END ) */
             AND FOSETTBROKVIEW.PARTY_CODE = S.PARTY_CODE    
             AND FOSETTBROKVIEW.MPRICE <= BROKTABLE.UPPER_LIM) 
      ELSE 
          (SELECT MIN(LINE_NO) FROM BROKTABLE 
                  WHERE FOSETTBROKVIEW.MPRICE <= BROKTABLE.UPPER_LIM 
                  AND BROKTABLE.TABLE_NO = (CASE WHEN 
                                                     LEFT(FOSETTBROKVIEW.INST_TYPE,3) = 'FUT' /* AND SETTFLAG IN(1,2,3,4,5)  */
                                                 THEN
                                                     FOSETTBROKVIEW.STD_RATE
                                               /*  WHEN 

                                                     LEFT(FOSETTBROKVIEW.INST_TYPE,3) = 'FUT'  AND SETTFLAG IN(6,7,8,9)
                                                 THEN 
                                                     FOSETTBROKVIEW.DUMMY6
                                                 WHEN 
                                                     SETTFLAG IN(6,7,8,9)
                                                 THEN 
                                                     FOSETTBROKVIEW.DUMMY7  */
                                                 ELSE FOSETTBROKVIEW.BROK2_TABLENO
                                             END)
)
       END )
  AND FOSETTBROKVIEW.TRAN_CAT = (CASE WHEN CL_TYPE = 'PRO' THEN 'PRO' ELSE FOTAXES.TRANS_CAT END )

GO

-- --------------------------------------------------
-- VIEW dbo.FOTRDIMPBFVIEW
-- --------------------------------------------------
/* JAN 16  2002  */
/*  MADE THE SAUDA_DATE AS DATE TIME   */

CREATE VIEW [dbo].[FOTRDIMPBFVIEW] AS
SELECT S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,PQTY=(CASE WHEN SELL_BUY = 1 THEN SUM(TRADEQTY) ELSE 0 END),
SQTY=(CASE WHEN SELL_BUY = 2 THEN SUM(TRADEQTY) ELSE 0 END),S.STRIKE_PRICE,S.OPTION_TYPE ,SETTFLAG 
FROM FOTRADE S ,CLIENT2 C WHERE S.PARTY_CODE = C.PARTY_CODE AND C.TRAN_CAT = 'TRD' 
GROUP BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE,
SELL_BUY,EXPIRYDATE,SETTFLAG

GO

-- --------------------------------------------------
-- VIEW dbo.FOTRDSETTBFVIEW
-- --------------------------------------------------
CREATE VIEW [dbo].[FOTRDSETTBFVIEW] AS
SELECT S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,PQTY=(CASE WHEN SELL_BUY = 1 THEN SUM(TRADEQTY) ELSE 0 END),
SQTY=(CASE WHEN SELL_BUY = 2 THEN SUM(TRADEQTY) ELSE 0 END),S.STRIKE_PRICE,S.OPTION_TYPE ,SETTFLAG 
FROM FOTRADE S ,CLIENT2 C WHERE S.PARTY_CODE = C.PARTY_CODE AND C.BROK_SCHEME IN ('20','21','22','23','24','25','26','27','28','29','30') 
GROUP BY S.PARTY_CODE,S.INST_TYPE,S.SYMBOL,S.EXPIRYDATE,EXPIRYDATE,S.STRIKE_PRICE,S.OPTION_TYPE,
SELL_BUY,EXPIRYDATE,SETTFLAG

GO

-- --------------------------------------------------
-- VIEW dbo.MULTICOMPANY
-- --------------------------------------------------
CREATE  VIEW [dbo].[MULTICOMPANY]  
AS  
SELECT * FROM PRADNYA.DBO.MULTICOMPANY WHERE EXCHANGE ='BSX'AND SEGMENT='FUTURES'

GO

-- --------------------------------------------------
-- VIEW dbo.OWNER
-- --------------------------------------------------

CREATE VIEW [OWNER] AS
SELECT * FROM FOOWNER

GO

-- --------------------------------------------------
-- VIEW dbo.SCRIP1
-- --------------------------------------------------
CREATE VIEW SCRIP1 AS
SELECT * FROM MSAJAG.DBO.SCRIP1 (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.SCRIP2
-- --------------------------------------------------
CREATE VIEW SCRIP2 AS
SELECT * FROM MSAJAG.DBO.SCRIP2 (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.STT_EXCHG_VIEW_PARTY_NSEFO
-- --------------------------------------------------



CREATE VIEW
	[dbo].[STT_EXCHG_VIEW_PARTY_NSEFO]
AS 
SELECT RECTYPE
	,STT_DATE
	,PARTY_CODE
	,TSSTTTRD = SUM(CASE 
			WHEN UPPER(LEFT(LTRIM(RTRIM(INST_TYPE)), 3)) = 'FUT'
				THEN STT_FUT
			ELSE CASE 
					WHEN UPPER(LEFT(LTRIM(RTRIM(INST_TYPE)), 3)) = 'OPT'
						THEN STT_OPT
					ELSE 0
					END
			END)
	,TOTALSTT = (
		CASE 
			WHEN RECTYPE = 30
				THEN SUM(CASE 
							WHEN UPPER(LEFT(LTRIM(RTRIM(INST_TYPE)), 3)) = 'FUT'
								THEN TOTALSTT
							ELSE CASE 
									WHEN UPPER(LEFT(LTRIM(RTRIM(INST_TYPE)), 3)) = 'OPT'
										THEN TOTALSTT
									ELSE 0
									END
							END)
			ELSE SUM(TOTALSTT)
			END
		)
FROM STT_EXCHG
GROUP BY RECTYPE
	,STT_DATE
	,PARTY_CODE

GO

-- --------------------------------------------------
-- VIEW dbo.STT_EXCHG_VIEW_PARTY_SCRIP_NSEFO
-- --------------------------------------------------



CREATE VIEW
[dbo].[STT_EXCHG_VIEW_PARTY_SCRIP_NSEFO]
AS
SELECT RECTYPE
	,STT_DATE
	,PARTY_CODE
	,INST_TYPE
	,SYMBOL
	,EXPIRYDATE
	,STRIKE_PRICE
	,OPTION_TYPE
	,TSSTTTRD = SUM(CASE 
			WHEN UPPER(LEFT(LTRIM(RTRIM(INST_TYPE)), 3)) = 'FUT'
				THEN STT_FUT
			ELSE CASE 
					WHEN UPPER(LEFT(LTRIM(RTRIM(INST_TYPE)), 3)) = 'OPT'
						THEN STT_OPT
					ELSE 0
					END
			END)
	,TOTALSTT = SUM(CASE 
			WHEN UPPER(LEFT(LTRIM(RTRIM(INST_TYPE)), 3)) = 'FUT'
				THEN TOTALSTT
			ELSE CASE 
					WHEN UPPER(LEFT(LTRIM(RTRIM(INST_TYPE)), 3)) = 'OPT'
						THEN TOTALSTT
					ELSE 0
					END
			END)
FROM STT_EXCHG
GROUP BY RECTYPE
	,STT_DATE
	,PARTY_CODE
	,INST_TYPE
	,SYMBOL
	,EXPIRYDATE
	,STRIKE_PRICE
	,OPTION_TYPE

GO

-- --------------------------------------------------
-- VIEW dbo.TBL_CLIENTMARGIN_VIEW
-- --------------------------------------------------


CREATE VIEW TBL_CLIENTMARGIN_VIEW AS

SELECT * FROM TBL_CLIENTMARGIN (NOLOCK)

--SELECT *,ADDMARGIN = 0 FROM TBL_CLIENTMARGIN (NOLOCK)

GO

-- --------------------------------------------------
-- VIEW dbo.TRADERS
-- --------------------------------------------------
CREATE VIEW [dbo].[TRADERS] AS
SELECT 
	BRANCH_CD,TRADER_CODE = SHORT_NAME,LONG_NAME,ADDRESS1,ADDRESS2,CITY,STATE,NATION,ZIP,PHONE1,PHONE2,FAX,EMAIL,[REMOTE]
	SECURITY_NET,MONEY_NET,EXCISE_REG,CONTACT_PERSON,COM_PERC,TERMINAL_ID,DEFTRADER
FROM BRANCHES

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_MAPPING_TABLE
-- --------------------------------------------------
CREATE VIEW Vw_MAPPING_TABLE AS  
  
SELECT * FROM  MSAJAG.DBO.MAPPING_TABLE

GO

