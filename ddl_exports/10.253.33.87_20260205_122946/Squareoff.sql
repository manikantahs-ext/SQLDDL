-- DDL Export
-- Server: 10.253.33.87
-- Database: Squareoff
-- Exported: 2026-02-05T12:29:51.525770

USE Squareoff;
GO

-- --------------------------------------------------
-- FUNCTION dbo.FILLSTRING
-- --------------------------------------------------
CREATE FUNCTION DBO.FILLSTRING      
(      
    @STR AS VARCHAR(1000),      
    @REPLACESTR AS VARCHAR(1000),      
    @TO_LEN AS SMALLINT,      
    @BEFORE_AFTER AS BIT      
)      
RETURNS VARCHAR(1000)      
BEGIN      
    DECLARE @CURR_LEN AS INT      
    SET @CURR_LEN = LEN(@STR)      
      
    WHILE (@CURR_LEN<@TO_LEN)      
    BEGIN      
              
        SELECT @STR = CASE WHEN @BEFORE_AFTER = 0 THEN @REPLACESTR+@STR ELSE @STR+@REPLACESTR END      
              
        --SET @CURR_LEN = LEN(@STR)      
        SET @CURR_LEN = @CURR_LEN + 1      
    END      
    RETURN @STR      
END

GO

-- --------------------------------------------------
-- INDEX dbo.MTF_data
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_MTF_data_Processdate_party_code_New] ON [dbo].[MTF_data] ([Processdate], [party_code], [SquareoffValue]) INCLUDE ([Shortage], [NoofDays])

GO

-- --------------------------------------------------
-- INDEX dbo.MTF_data
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NC_NoofDays] ON [dbo].[MTF_data] ([NoofDays], [SquareoffValue]) INCLUDE ([Processdate], [party_code], [Shortage])

GO

-- --------------------------------------------------
-- INDEX dbo.MTF_data
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NC_Processdate] ON [dbo].[MTF_data] ([Processdate], [NoofDays]) INCLUDE ([party_code], [Shortage], [SquareoffValue])

GO

-- --------------------------------------------------
-- INDEX dbo.mtf_holding
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [<Name of Missing Index, sysname,>] ON [dbo].[mtf_holding] ([EXCHANGE]) INCLUDE ([sett_no], [Party_code], [accno])

GO

-- --------------------------------------------------
-- INDEX dbo.mtf_holding
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_mtf_holding_Party_code] ON [dbo].[mtf_holding] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.VMSS_ASB7_Days
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxpty] ON [dbo].[VMSS_ASB7_Days] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.VMSS_ASB7_Days_hist
-- --------------------------------------------------
CREATE CLUSTERED INDEX [idxpty] ON [dbo].[VMSS_ASB7_Days_hist] ([Rms_date], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.VMSS_data
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [NC_VMSSData_PartyCode_NoOfDays] ON [dbo].[VMSS_data] ([Party_code], [NoofDays]) INCLUDE ([processDate])

GO

-- --------------------------------------------------
-- INDEX dbo.VMSS_DP_Holding
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_VMSS_DP_Holding_id] ON [dbo].[VMSS_DP_Holding] ([id])

GO

-- --------------------------------------------------
-- INDEX dbo.VMSS_DP_Holding
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_VMSS_DP_Holding_Party_code_Category_Clsrate_HairCut] ON [dbo].[VMSS_DP_Holding] ([Party_code], [Category], [Clsrate], [HairCut]) INCLUDE ([HoldDate], [Cltdpid], [isin], [bsecode], [nsesymbol], [nseseries], [holding], [VBHC], [VAHC], [SqOffQty], [SqOffSeq], [id])

GO

-- --------------------------------------------------
-- INDEX dbo.VMSS_DP_Holding
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_VMSS_DP_Holding_ToSegment] ON [dbo].[VMSS_DP_Holding] ([ToSegment]) INCLUDE ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.VMSS_Holding
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [ix_missing_VMSS_Holding_SquareOffQty] ON [dbo].[VMSS_Holding] ([SquareOffQty], [ToSegment]) INCLUDE ([scrip_cd], [series], [Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.VMSS_Holding
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_VMSS_Holding_id] ON [dbo].[VMSS_Holding] ([id])

GO

-- --------------------------------------------------
-- INDEX dbo.VMSS_Holding
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_VMSS_Holding_Party_code] ON [dbo].[VMSS_Holding] ([Party_code])

GO

-- --------------------------------------------------
-- INDEX dbo.VMSS_Holding
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_VMSS_Holding_Party_code_CLSRATE] ON [dbo].[VMSS_Holding] ([Party_code], [CLSRATE])

GO

-- --------------------------------------------------
-- INDEX dbo.vmss_NonCash
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_vmss_NonCash_id_MarginHC] ON [dbo].[vmss_NonCash] ([id], [MarginHC])

GO

-- --------------------------------------------------
-- INDEX dbo.vmss_NonCash
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [IX_vmss_NonCash_Party_Code] ON [dbo].[vmss_NonCash] ([Party_Code])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_BSE_VarShortage
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[MTF_BSE_VarShortage]                                  
AS                                  
                                  
SET XACT_ABORT ON                                          
Set nocount on                                          
BEGIN TRY       
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with (nolock) where IS_Accepted='Y'    
  
  SELECT                                  
  A.PARTY_CODE,                                  
  SCRIP_CD,                                  
  /* CLSRATE,   */                
  mis.dbo.RoundtoUnit(CLSRATE,0.05) as CLSRATE,                              
  sum(squareoffqty) as SquareOffQty,                                  
  ToSegment=Exchange   into #mtf_Holding                               
  FROM mtf_holding A WITH (NOLOCK)-- inner join #MTFCodes  MTF On A.party_code=MTF.party_code                            
  WHERE squareoffqty <>0 and Exchange='BSECM'              
  GROUP BY A.PArty_code,scrip_Cd,clsrate,Exchange     
      
  select A.party_code into #mtf_data from  mtf_data A with (nolock) where NoofDays >=5 and                   
  processdate >= (select max(processdate) from mtf_data with (nolock))                   
  group by A.party_code         
       
  TRUNCATE table dbo.upd_bse_outfile_squp_MTF_shortage   
 
                                    
  INSERT INTO dbo.upd_bse_outfile_squp_MTF_shortage(S,Qty,Qty1,Scrip_Cd,clsrate,Client_Code,EOSESS,CLIENT,L)                                  
  SELECT                                  
  S,                                  
  Qty,                                  
  Qty1,                                  
  Scrip_Cd,                                  
  clsrate,                                  
  Client_Code,                                  
  EOSESS,                                  
  CLIENT,                                  
  L                                  
  FROM                             
  (                            
  SELECT                                  
  S = 'S',                                  
  CONVERT(int, SquareOffQty) Qty,                                  
  CASE                                  
  WHEN CONVERT(int, CEILING(SquareOffQty * .1)) <= 1 THEN SquareOffQty                                  
  ELSE CONVERT(int, CEILING(SquareOffQty * .1))                                  
  END AS Qty1,                                  
  Scrip_Cd,                                  
  REPLACE(CONVERT(decimal(15, 2), clsrate - ((clsrate * 2) / 100.00)), '.', '') + (5 - REPLACE(CONVERT(decimal(15, 2), clsrate - ((clsrate * 2) / 100.00)), '.', '') % 5) clsrate,                                  
  LTRIM(RTRIM(c.Party_code)) Client_Code,                                  
  EOSESS = 'EOSESS',                                  
  CLIENT = 'CLIENT',                                  
  L = 'L'                                  
  FROM                                 
  (                            
  SELECT                                  
  PARTY_CODE,                                  
  SCRIP_CD,                                             
  CLSRATE,                              
  SquareOffQty,                                  
  ToSegment                                  
  FROM #mtf_Holding                  
      
  )a                            
  
  INNER JOIN general.dbo.Vw_RMS_CLIENT_Vertical b                                  
  ON a.PARTY_CODE = b.Client                            
  INNER JOIN                   
  (select party_code from general.dbo.client_details where LEN(LTRIM(RTRIM(pan_gir_no))) = 10)cli                                  
  ON a.PARTY_CODE = cli.PARTY_CODE                               
  inner join (                  
  select party_code from  #mtf_data                  
  )c                          
  on a.Party_code=c.Party_code                  
      
  ) x        
                                  
End try                                                               
BEGIN CATCH                                                                  
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                        
  select GETDATE(),'MTF_BSE_VarShortage',ERROR_LINE(),ERROR_MESSAGE()                                                                        
                  
                  
 DECLARE @ErrorMessage NVARCHAR(4000);                                              
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                              
 RAISERROR (@ErrorMessage , 16, 1);                    
                   
End catch                                           
                                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_BSE_VarShortage_4Percent
-- --------------------------------------------------
Create PROCEDURE [dbo].[MTF_BSE_VarShortage_4Percent]                                  
AS                                  
                                  
SET XACT_ABORT ON                                          
Set nocount on                                          
BEGIN TRY       
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with (nolock) where IS_Accepted='Y'    
  
  SELECT                                  
  A.PARTY_CODE,                                  
  SCRIP_CD,                                  
  /* CLSRATE,   */                
  mis.dbo.RoundtoUnit(CLSRATE,0.05) as CLSRATE,                              
  sum(squareoffqty) as SquareOffQty,                                  
  ToSegment=Exchange   into #mtf_Holding                               
  FROM mtf_holding A WITH (NOLOCK)-- inner join #MTFCodes  MTF On A.party_code=MTF.party_code                            
  WHERE squareoffqty <>0 and Exchange='BSECM'              
  GROUP BY A.PArty_code,scrip_Cd,clsrate,Exchange     
      
  select A.party_code into #mtf_data from  mtf_data A with (nolock) where NoofDays >=5 and                   
  processdate >= (select max(processdate) from mtf_data with (nolock))                   
  group by A.party_code         
       
  TRUNCATE table dbo.upd_bse_outfile_squp_MTF_shortage   
 
                                    
  INSERT INTO dbo.upd_bse_outfile_squp_MTF_shortage(S,Qty,Qty1,Scrip_Cd,clsrate,Client_Code,EOSESS,CLIENT,L)                                  
  SELECT                                  
  S,                                  
  Qty,                                  
  Qty1,                                  
  Scrip_Cd,                                  
  clsrate,                                  
  Client_Code,                                  
  EOSESS,                                  
  CLIENT,                                  
  L                                  
  FROM                             
  (                            
  SELECT                                  
  S = 'S',                                  
  CONVERT(int, SquareOffQty) Qty,                                  
  CASE                                  
  WHEN CONVERT(int, CEILING(SquareOffQty * .1)) <= 1 THEN SquareOffQty                                  
  ELSE CONVERT(int, CEILING(SquareOffQty * .1))                                  
  END AS Qty1,                                  
  Scrip_Cd,                                  
  REPLACE(CONVERT(decimal(15, 2), clsrate - ((clsrate * 4) / 100.00)), '.', '') + (5 - REPLACE(CONVERT(decimal(15, 2), clsrate - ((clsrate * 4) / 100.00)), '.', '') % 5) clsrate,                                  
  LTRIM(RTRIM(c.Party_code)) Client_Code,                                  
  EOSESS = 'EOSESS',                                  
  CLIENT = 'CLIENT',                                  
  L = 'L'                                  
  FROM                                 
  (                            
  SELECT                                  
  PARTY_CODE,                                  
  SCRIP_CD,                                             
  CLSRATE,                              
  SquareOffQty,                                  
  ToSegment                                  
  FROM #mtf_Holding                  
      
  )a                            
  
  INNER JOIN general.dbo.Vw_RMS_CLIENT_Vertical b                                  
  ON a.PARTY_CODE = b.Client                            
  INNER JOIN                   
  (select party_code from general.dbo.client_details where LEN(LTRIM(RTRIM(pan_gir_no))) = 10)cli                                  
  ON a.PARTY_CODE = cli.PARTY_CODE                               
  inner join (                  
  select party_code from  #mtf_data                  
  )c                          
  on a.Party_code=c.Party_code                  
      
  ) x        
                                  
End try                                                               
BEGIN CATCH                                                                  
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                        
  select GETDATE(),'MTF_BSE_VarShortage',ERROR_LINE(),ERROR_MESSAGE()                                                                        
                  
                  
 DECLARE @ErrorMessage NVARCHAR(4000);                                              
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                              
 RAISERROR (@ErrorMessage , 16, 1);                    
                   
End catch                                           
                                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_Hold_process_step2
-- --------------------------------------------------
Create procedure [dbo].[MTF_Hold_process_step2]                      
as                      
                      
set transaction isolation level read UNCOMMITTED                      
set nocount on                      
begin try                      


	truncate table mtf_rms_holding                      
	insert into mtf_rms_holding
	select isin,scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,                      
	aben,apool,nben,npool,approved,scripname,partyname,pool,total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty                      
	from General.dbo.RMS_Holding with (nolock)
                      
end try                      
begin catch                      
 insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                      
 select GETDATE(),'MTF_Hold_process_step2',ERROR_LINE(),ERROR_MESSAGE()                      
                       
 DECLARE @ErrorMessage NVARCHAR(4000);                      
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                      
 RAISERROR (@ErrorMessage , 16, 1);                      
end catch;                      
set nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_notification
-- --------------------------------------------------




--ProjectedRisk_notification
--NBFC_notification
--MTF_Ageing_notification

--MTF_notification


---exec MTF_notification 1

CREATE PROCEDURE [dbo].[MTF_notification] (@Status as int, @errorMsg varchar(max) = '')        
AS        
        
BEGIN        
        
declare @str as varchar(max)        
declare @To as varchar(max)        
        
if @status=0        
Begin        
set @str='MTF Process Failed. '+ isnull(@errorMsg,'')        
end        
--else if @status=2        
--Begin        
--set @str='MTF Job Failed - Problem in Client/SB Master.'        
--end        
else if @status=1        
begin  
   
--declare @str as varchar(max)        
select @str='MTF Process Successfully completed Date : '+convert(varchar(11),ProcessDate)+'.<br> Total T 5 Count:'        
+convert(varchar(10),count(1))+ '. SquareoffValue:'+convert(varchar(15),sum(SquareoffValue)/100000)+' lacs'   
--select *     
from mtf_data with (nolock)        
where ProcessDate= (select max(ProcessDate) from mtf_data with (nolock))        
and noofDays>=5 
and abs(Shortage) > 650 
--and  Party_code NOT IN (SELECT DISTINCT Party_code FROM  squareoff.dbo.MTF_sqoff_client_exp with (nolock) WHERE EXCEPTION ='Y')  
and ISNULL(SquareoffValue,0)<>0        
group by ProcessDate        
--PRINT @str




     
SELECT @str= @str+' <br>Total T 4 Count:'+convert(varchar(10),count(1))+'. SquareoffValue:'+convert(varchar(15),sum(SquareoffValue)/100000)+' lacs'   
--select *     
from mtf_data with (nolock)        
where ProcessDate= (select max(ProcessDate) from mtf_data with (nolock))        
and noofDays=4
and abs(Shortage) > 650 
and ISNULL(SquareoffValue,0)<>0        
group by ProcessDate                
        
SELECT @str= @str+'<br> Total T 3 Count:'+convert(varchar(10),count(1))+'. SquareoffValue:'+convert(varchar(15),sum(SquareoffValue)/100000)+' lacs.'     

--select *     
from mtf_data with (nolock)        
where ProcessDate= (select max(ProcessDate) from mtf_data with (nolock))        
and noofDays=3 
and abs(Shortage) > 650 
and ISNULL(SquareoffValue,0)<>0        
group by ProcessDate        
       
end        
else        
begin        
set @str='MTF Process - Unknown.'        
end        
        
create table #MobNo        
(        
mobno numeric(10,0)        
)        
                 
if @status in (1,2)        
begin        
insert into #MobNo        
----select 9820202050 /*Bhavin Parekh*/        
----union all        
----select 9820701602 /*VISHAL GOHIL*/        
----union all        
------select 9819446406 /*AKILA IYER*/        
------union all        
----select 9819090240 /*Anand Golatkar*/        
----union all        
select 9820701602 /*VIRAL MEHTA*/               
        
set @To = 'mgs.abha@angelbroking.com;chitragupt.sharan@angelbroking.com'        
end        
        
--Trigger SMS.        
insert into intranet.sms.dbo.sms        
select a.mobno,@str,convert(varchar(10), getdate(), 103),        
ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +        
ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),        
'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12        
then 'PM' else 'AM' end,'RMS UPDATION'        
from #MobNo a        
        
--Trigger Mail.        
----EXEC MSDB.DBO.SP_SEND_DBMAIL        
----@RECIPIENTS = @To,        
----@PROFILE_NAME = 'angelbroking',        
----@BODY_FORMAT ='HTML',        
----@SUBJECT = @str,        
----@BODY = @str        
        
--If not successfull then mail triggered to DBA as well.        
if @status <> 1        
begin        
        
set @str = @str + case when @status = 2        
then        
' Please trigger Process "MTF_notification" in 182 server.'        
else ''        
end        
        
----EXEC MSDB.DBO.SP_SEND_DBMAIL        
----@RECIPIENTS = 'bi.dba@angelbroking.com;renil.pillai@angelbroking.com;mindgate.support@angelbroking.com',        
----@PROFILE_NAME = 'angelbroking',        
----@BODY_FORMAT ='HTML',        
----@SUBJECT = 'URGENT ATTENTION : ASB7 JOB Failed',        
------@SUBJECT = 'Please ignore this mail ..testing purpose only',        
----@BODY = @str        
end        
drop table #MobNo        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_NSE_VarShortage
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[MTF_NSE_VarShortage]                                    
AS                                    
                                           
Set nocount on                                            
 BEGIN TRY       
   -- select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with (nolock) where IS_Accepted='Y'   
  

  TRUNCATE TABLE upd_nse_outfile_squp_MTF_shortage                                    
      
  INSERT INTO upd_nse_outfile_squp_MTF_shortage 
                                 
  SELECT '1'                               AS [Regular_Lot],                             
  2                                 [Buy/Sell],                             
   d.nsesymbol                       AS symbol,                                
   d.nseseries                       AS series,                             
  1                                 AS Instructions,                             
  ''                                AS Default_1,                             
  ''                                AS Default_2,                             
  ''                                AS Default_3,                             
  price=CONVERT(INT, clsrate - ( ( clsrate * 2 ) / 100 )),                             
  ''                                AS Default_4,                             
  SquareOffQty as                           qty,                             
  CONVERT(INT, Ceiling(SquareOffQty / 10.0)) AS [Disclosed Qty.],                             
  '12798'                           AS Member_Code,                             
  '2'                               AS Pro_Client,                             
  A.party_code                      AS [Client_Code],                             
  ''                                AS Default_5,                             
  ''                                AS Default_6,                             
  ''                                AS Default_7                             
  FROM                            
  (                    
  SELECT scrip_Cd=Upper(scrip_Cd),series,                    
  party_code, isin, sum( squareoffqty) as SquareOffQty, clsrate,SEGMENT=Exchange                             
  FROM mtf_holding WITH(nolock)                             
  WHERE   squareoffqty > 0 and exchange ='NSECM'                   
  GROUP by party_code, isin,clsrate, exchange,scrip_Cd,series                    
  ) a                             
  INNER JOIN general.dbo.scrip_master d                             
  ON a.isin = d.isin                             
  inner join (                    
  select party_code from mtf_data where NoofDays >=5 and                     
  processdate >= (select max(processdate) from mtf_data)                     
  group by party_code                    
  )c                            
  on a.Party_code=c.Party_code -- where  a.party_code='JOD5070'   
 -- inner join #MTFCodes MTF on a.party_code=MTF.party_code  
                  
     
  update a   set a.series=b.cpseries  from upd_nse_outfile_squp_MTF_shortage a    ,                         
  (Select scrip,series as cpseries from general.dbo.cp_nsecm where series in ('EQ','BE','BZ')) b                
  where a.symbol=b.scrip                 
  and a.series in ('EQ','BE','BZ')                
  and a.series<>b.cpseries    
  
         
 End try                                                                 
 BEGIN CATCH                               
  insert into general.dbo.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                          
  select GETDATE(),'MTF_NSE_VarShortage',ERROR_LINE(),ERROR_MESSAGE()                                                                          
      
  DECLARE @ErrorMessage NVARCHAR(4000);                                        
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                
  RAISERROR (@ErrorMessage , 16, 1);                      
 End catch                                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_NSE_VarShortage_4Percent
-- --------------------------------------------------
create PROCEDURE [dbo].[MTF_NSE_VarShortage_4Percent]                                    
AS                                    
                                           
Set nocount on                                            
 BEGIN TRY       
   -- select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with (nolock) where IS_Accepted='Y'   
  
   
                        
  TRUNCATE TABLE upd_nse_outfile_squp_MTF_shortage                                    
      
  INSERT INTO upd_nse_outfile_squp_MTF_shortage 
                                 
  SELECT '1'                               AS [Regular_Lot],                             
  2                                 [Buy/Sell],                             
  (Case when series='BSE' then upper(d.nsesymbol) else scrip_cd end) AS Symbol,                             
  (Case when series='BSE' then upper(d.nseseries) else series end) as series,                             
  1                                 AS Instructions,                             
  ''                                AS Default_1,                             
  ''                                AS Default_2,                             
  ''                                AS Default_3,                             
  price=CONVERT(INT, clsrate - ( ( clsrate * 4 ) / 100 )),                             
  ''                                AS Default_4,                             
  SquareOffQty as                           qty,                             
  CONVERT(INT, Ceiling(SquareOffQty / 10.0)) AS [Disclosed Qty.],                             
  '12798'                           AS Member_Code,                             
  '2'                               AS Pro_Client,                             
  A.party_code                      AS [Client_Code],                             
  ''                                AS Default_5,                             
  ''                                AS Default_6,                             
  ''                                AS Default_7                             
  FROM                            
  (                    
  SELECT scrip_Cd=Upper(scrip_Cd),series,                    
  party_code, isin, sum( squareoffqty) as SquareOffQty, clsrate,SEGMENT=Exchange                             
  FROM mtf_holding WITH(nolock)                             
  WHERE   squareoffqty > 0 and exchange ='NSECM'                   
  GROUP by party_code, isin,clsrate, exchange,scrip_Cd,series                    
  ) a                             
  INNER JOIN general.dbo.scrip_master d                             
  ON a.isin = d.isin                             
  inner join (                    
  select party_code from mtf_data where NoofDays >=5 and                     
  processdate >= (select max(processdate) from mtf_data)                     
  group by party_code                    
  )c                            
  on a.Party_code=c.Party_code     
 -- inner join #MTFCodes MTF on a.party_code=MTF.party_code  
                  
     
  update a   set a.series=b.cpseries  from upd_nse_outfile_squp_MTF_shortage a    ,                         
  (Select scrip,series as cpseries from general.dbo.cp_nsecm where series in ('EQ','BE','BZ')) b                
  where a.symbol=b.scrip                 
  and a.series in ('EQ','BE','BZ')                
  and a.series<>b.cpseries    
  
         
 End try                                                                 
 BEGIN CATCH                               
  insert into general.dbo.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                          
  select GETDATE(),'MTF_NSE_VarShortage',ERROR_LINE(),ERROR_MESSAGE()                                                                          
      
  DECLARE @ErrorMessage NVARCHAR(4000);                                        
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                
  RAISERROR (@ErrorMessage , 16, 1);                      
 End catch                                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation
-- --------------------------------------------------
  
  
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
CREATE Procedure [dbo].[MTF_SqOffAmtCalculation]                                      
as                                                              
SET XACT_ABORT ON                                                                    
Set nocount on                                                              
BEGIN TRY               
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'  
/*client shortage fetching*/  
  
exec general.dbo.[Update_Projected_OnlyVaR]  
exec general.dbo.MTF_BO_DATA  
  
declare @mtfdate datetime   
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)  
  
SELECT PARTY_CODE,NET_MTF_REQ_Old=MARGIN_SHORTFALL , 
NET_MTF_REQ =MARGIN_SHORTFALL,SAUDA_DATE=CONVERT(VARCHAR(10), CONVERT(date, ORDERBYDATE, 105), 23),
net_ledger =cast(0.00 as money),recipent_val=cast(0.00 as money)
into #mtfshortage  
from general.dbo.BO_MTFFinal with (nolock) 
WHERE ORDERBYDATE =@mtfdate  
  
delete from #mtfshortage where NET_MTF_REQ>=0  

select distinct T.party_code, MTFLEDBAL,netledger=cast(0.00 as money),
Final_bal=cast(0.00 as money)
into  #ledger 
from [AngelNseCM].MTFTrade.dbo.TBL_MTF_DATA T with (nolock) 
inner join #mtfshortage P
on T.PARTY_CODE=P.party_code
where cast(T.SAUDA_DATE as date)=(select max(cast(SAUDA_DATE as date)) 
from [AngelNseCM].MTFTrade.dbo.TBL_MTF_DATA with (nolock))   
group by T.party_code, MTFLEDBAL
	
select party_code,MTFLEDBAL,netledger=balance-MTFLEDBAL 
into #net
from general.dbo.tbl_ledger_All_Risk T with (nolock)  inner join #ledger L with (nolock)
on T.cltcode=L.party_code

declare @dt varchar(10)
;with sqoffdatae as      
 (      
    select top 2 ROW_NUMBER() over(order by a.Start_Date)as srno,  cast( a.Start_Date as date)   Start_Date                                            
    from general.dbo.bse_sett_mst a                                                                            
    where CONVERT(VARCHAR(10),a.start_Date,121) > =CONVERT(VARCHAR(10),getdate()-2,121)                                                     
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                              
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                            
    group by Start_Date
)      
select @dt = cast(Start_Date as date)  from sqoffdatae where srno=2 ; 

select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode into #Recieved_entry  from  
[AngelNseCM].account.dbo.lEDGER with (nolock) 
where  cast(vdt as date)=cast(@dt as date) and  vtyp=2 and drcr='C'  

select cltcode,credit=sum(balamt) into #cr 
from #Recieved_entry group by cltcode 

select party_code,NET_MTF_REQ, c.credit into #segmentwisecr 
from #mtfshortage m inner join #cr c
on m.PARTY_CODE=c.cltcode

update m set net_ledger=N.netledger  from #mtfshortage m inner join #net N
on m.PARTY_CODE=N.party_code 

update m set recipent_val=N.credit  from #mtfshortage m inner join #segmentwisecr N
on m.PARTY_CODE=N.party_code 
  
update c set NET_MTF_REQ = isnull(NET_MTF_REQ ,0) + isnull(t.netledger,0)
from #mtfshortage c inner join #net t with (nolock) on c.party_code= t.party_code    
where t.netledger>0.00

update c set NET_MTF_REQ = isnull(c.NET_MTF_REQ ,0) + isnull(t.credit,0)
from #mtfshortage c inner join #segmentwisecr t with (nolock) on c.party_code= t.party_code 
inner join #net N on c.PARTY_CODE=N.party_code
where N.netledger<=0

update c set NET_MTF_REQ = isnull(NET_MTF_REQ,0)+isnull(Amount,0)  
from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t with (nolock) on c.party_code= t.PARTY_CODE    
  
truncate table tbl_MTF_FinalShortage
insert into tbl_MTF_FinalShortage
select * ,upd_date=getdate() from #mtfshortage

delete from #mtfshortage where NET_MTF_REQ>=0.00  
  
/*added as required by v gohil on Jan 28 2020*/  
select * into #poa_mtf from Angeldemat.msajag.dbo.TBL_POA_COLL_DATA_MTF with (nolock) where cast(processdate as date)=@mtfdate  
  
update #poa_mtf set MTF_VARATE =secvar from  squareoff.dbo.MTF_ScripMaster M with (nolock) 
where #poa_mtf.CERTNO=m.isin  

alter table #poa_mtf add  value_after_hc money  
  
update #poa_mtf set value_after_hc=NET_VALUE*((100-MTF_VARATE)/100.00)      
  
select party_code,value_after_hc=sum(value_after_hc) into #final_data from  #poa_mtf group by party_code  
  
  
truncate table tbl_mtf_poa_holding  
insert into tbl_mtf_poa_holding  
select * from #final_data  
  
update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(value_after_hc,0)  from #mtfshortage c join #final_data t on c.party_code= t.PARTY_CODE    
  
delete from #mtfshortage where NET_MTF_REQ>=0.00  
/*added as required by v gohil on Jan 28 2020*/  
  
  
delete from MTF_data where Processdate=@mtfdate  
/*(select MAX(sauda_date) from #mtfshortage)*/  
  
insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)  
SELECT Processdate=@mtfdate,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00  
FROM #mtfshortage MTF  
  
delete from MTF_data where Shortage<1000 and Processdate=@mtfdate  
   
select @mtfdate as ProcessDate,  
EXCHANGE,  
sett_no,SEtt_type,  
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,  
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,  
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,  
CONVERT(MONEY,0) AS HAIRCUT,  
CONVERT(MONEY,0) AS VAHC,  
SPACE(10) AS CATEGORY,  
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )  
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,  
accno  
into #mtf_rms_holding  
from general.dbo.rms_holding with (nolock) where source in ('SI','SO','H','D')  and  accno in ('1203320030135829')--,'unsettled')  
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno  
  
update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b with (nolock)
where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                 
                          
update #mtf_rms_holding set clsrate=b.cls                                                                                                                     
from General.dbo.cp_nsecm b with (nolock)                                                                                                           
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                  
                        
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                               
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                   
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                    
        
        
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                          
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                      
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM'   
  
/*MTF Scrip Master */  
insert into MTF_ScripMaster_hist  
select distinct srno,Entereddate,Isin,Scrip_CodeNSE,Scrip_CodeBSE,ScripName,FromDate,Todate,
SpecialRemarks,Secvar,Splvar,Folisted,Multiplier,FinalHaircut,historydate=GETDATE() from MTF_ScripMaster  
  
truncate table MTF_ScripMaster_BO  
 
Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='M' and BillDate <= GETDATE())                                                                                                               
  
insert into MTF_ScripMaster_BO  
EXEC [AngelNseCM].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', ''   

truncate table MTF_ScripMaster
insert into MTF_ScripMaster
select distinct Entereddate,Isin,Scrip_CodeNSE,Scrip_CodeBSE,ScripName,FromDate,Todate,
SpecialRemarks,Secvar,Splvar,Folisted,Multiplier,FinalHaircut
from MTF_ScripMaster_BO

 
update x set Haircut=y.haircut from   
      #mtf_rms_holding x inner join   
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin   
      where accno in ('1203320030135829')--,'unsettled')  
  
/*** Added for non mtf scrip haircut ***/   
  
update x set Haircut=100 from   
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock))   
  
/*****Completed****/  
  
update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                  
                      
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)        
  
/*Negative Holding Adjustment*/  
  
select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin  
  
select psrno=DENSE_RANK() over (order by party_code,isin),  
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),  
* into #mtf_rms_holding1   
from #mtf_rms_holding a with (nolock) where exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
  
 ; WITH Hold_CTE AS (  
SELECT   
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin  
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/  
UNION ALL  
SELECT   
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from  
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno  
 and x.SrNoisin=y.SrNoisin+1  
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/  
)  
SELECT * into #mtf_rms_holding2  
FROM Hold_CTE option  (maxrecursion 32767) ;  
  
  
delete from #mtf_rms_holding2 where Qty<=0  
--select * from #mtf_rms_holding2  
  
    
/*************************************/  
  
  
delete from mtf_holding_hist where ProcessDate=@mtfdate  
  
insert into mtf_holding_hist  
select *,histdate=GETDATE() from mtf_holding  
  
truncate table mtf_holding  
  
insert into mtf_holding  
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)  
  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding2   
union all  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding_rest  
  
update MTF_HOLDING  set VAHC=VBHC where HAIRCUT=100.00 and clsrate>0 and VAHC =0.00 

drop table #negative_holding  
drop table #mtf_rms_holding1  
drop table #mtf_rms_holding2  
  
                                                                         
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b with (nolock) where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                                
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b with (nolock) where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                                
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                    
    
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join   
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING with (nolock) group by party_code)b  
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data) 
  
  update MTF_HOLDING set CATEGORY=S.Status From  general.dbo.scrip_master S with (nolock) where 
  MTF_HOLDING.ISIN=S.isin and MTF_HOLDING.CATEGORY=''
    
    
  select psrno =dense_rank() over(order by party_code ),  
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320030135829') then 0 else 1 end,sett_no desc,srno desc),  
  a.* into #holding  
  from MTF_HOLDING a with (nolock) inner join General.dbo.ScripCategory_master b with (nolock) on a.category=b.CategoryName   
    
  select   
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,  
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno  
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld  
  from #holding --where party_code='A88004'  
  order by psrno,sqoffsseg  

  
  update #hld  set  ShortageReduction=VBHC where HAIRCUT=100.00 and clsrate>0 and VAHC =0.00

    
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b  
  on a.party_code=b.party_code  where a.sqoffsseg=1  
    
  
  --drop table #holdd  
    
;  WITH Hold_CTE AS (  
SELECT   
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,  
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,  
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x   
WHERE  sqoffsseg=1  
UNION ALL  
SELECT   
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,  
shortage= (ecte.shortage-ShortageReduction)  
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1   
and ecte.shortage>0  
)  
SELECT * into #holdd  
FROM Hold_CTE option  (maxrecursion 32767) ;  
   
update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0    
  
/*Addedd as suggested by vishal gohil on Aug 31 2017*/  
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)  
from #holdd a where clsrate>0 and haircut>0.00  
  
update a set Adjamt=Squareoffqty*clsrate from #holdd a  
  
update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,  
ShortageReduction=b.ShortageReduction,  
shortage=b.shortage  
  from mtf_holding a  inner join   
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and   
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type  
and a.exchange=b.exchange  
  
  
update a set squareoffvalue=b.adjamt from  mtf_data a inner join   
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b   
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)  
 
 update a set NoofDays=b.NoofDays+a.NoofDays   
  from   
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a  
inner join   
 (select * from mtf_data where Processdate in   
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b  
 on a.party_code=b.party_code  
   
  /* Remove T Day codes from MTF Process */  
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data with (nolock)  where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))  
  and processdate=(select max(processdate) from MTF_DATA)   
    
  /* Remove T+1 Day codes from MTF Process */  
 delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data with (nolock) where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data with (nolock)) 
 UNION 
 select DISTINCT party_code from [general].dbo.legalblkclients WITH (NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)  
    
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and  
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli with (nolock) where net_ledger>0.00 )  
  
  exec MTF_SqOffSeg  
  exec squareoff.dbo.MTF_BSE_VarShortage   
  exec squareoff.dbo.MTF_NSE_VarShortage   
  exec MTF_SquareOff_Exception_Process  

End try                                                                                   
    
BEGIN CATCH                                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                            
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                            
  DECLARE @ErrorMessage NVARCHAR(4000);                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
  RAISERROR (@ErrorMessage , 16, 1);                          
End catch                               
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_04122017
-- --------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_04122017]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             


--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'

/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00


select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
into #bb
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 

--select * from #mtfshortage where  party_code='pprw028'

--select * from #bb where  party_code='J51492'

--select * from #aa where  party_code='J51492'

update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
from #mtfshortage a   join  #aa b on a.party_code=b.party_code

update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
delete from #mtfshortage where NET_MTF_REQ>0.00

 
delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno


update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  

  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.SquareUp_Client_Alert where updt=(select MAX(updt) from general.dbo.SquareUp_Client_Alert))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.SquareUp_Client where updt=(select MAX(updt) from general.dbo.SquareUp_Client))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 select 9892953949                 
 union all                          
 select 8108987990                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_05102017
-- --------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_05102017]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             


--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'

/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00


select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
into #bb
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 

--select * from #mtfshortage where  party_code='pprw028'


--select * from #aa where  party_code='pprw028'
--select * from #bb where  party_code='pprw028'

--select * from #creditclients where  party_code='pprw028'

select A.party_code,Shortage_after_excessAdj=isnull(shortage,0.00)+isnull(NET_ledger,0.00)
into #creditclients_net_ledger 
from #aa a 

select A.party_code,Shortage_after_excessAdj=isnull(Shortage_after_excessAdj,0.00)+isnull(NET_ledger,0.00)
into #creditclients 
from #bb a 
  
delete from #mtfshortage where party_code in (select party_code from #creditclients where Shortage_after_excessAdj>0.00)

update a  set  A.NET_MTF_REQ =isnull(B.Shortage_after_excessAdj,A.NET_MTF_REQ) 
from #mtfshortage a   join  #creditclients b on a.party_code=b.party_code
 
delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno


update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  

  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.SquareUp_Client_Alert where updt=(select MAX(updt) from general.dbo.SquareUp_Client_Alert))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.SquareUp_Client where updt=(select MAX(updt) from general.dbo.SquareUp_Client))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 select 9892953949                 
 union all                          
 select 8108987990                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_0712207
-- --------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_0712207]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             


--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'

/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00


select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
into #bb
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 

--select * from #mtfshortage where  party_code='pprw028'

--select * from #bb where  party_code='J51492'

--select * from #aa where  party_code='J51492'

update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
from #mtfshortage a   join  #aa b on a.party_code=b.party_code

update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
delete from #mtfshortage where NET_MTF_REQ>0.00

 
delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

/*Added on Dec 04 2017 to update bse segement for scrips not listed in NSE*/
 --select * from #mtf_rms_holding  where scrip_cd in (select scrip_cd from general.dbo.tbl_NSE_NOT_LISTED_SCRIPS)
update #mtf_rms_holding set exchange= 'BSECM' where scrip_cd in (select scrip_cd from general.dbo.tbl_NSE_NOT_LISTED_SCRIPS)
update #mtf_rms_holding set exchange= 'NSECM' where scrip_cd in (select distinct  scrip_cd from general.dbo.tbl_BSE_NOT_LISTED_SCRIPS)


update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  

  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.SquareUp_Client_Alert where updt=(select MAX(updt) from general.dbo.SquareUp_Client_Alert))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.SquareUp_Client where updt=(select MAX(updt) from general.dbo.SquareUp_Client))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 select 9892953949                 
 union all                          
 select 8108987990                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_12072017
-- --------------------------------------------------
Create Procedure [dbo].[MTF_SqOffAmtCalculation_12072017]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             


--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'

/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1
FROM #mtfshortage MTF




select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty,CLSRATE,Total AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D') 


update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

                      
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin where accno='1203320009603460'

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  

  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock)) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 

update a set Squareoffqty=convert(int,ceiling((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0


update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  
  
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_18082017
-- --------------------------------------------------
Create Procedure [dbo].[MTF_SqOffAmtCalculation_18082017]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             


--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'

/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1
FROM #mtfshortage MTF

select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno


update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', 'Aug 12 2017', 'Aug 12 2017', '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno='1203320009603460'

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  

  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 

update a set Squareoffqty=convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0


update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  
  
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_23022018
-- --------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_23022018]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             


--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'

/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00


select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
into #bb
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 

--select * from #mtfshortage where  party_code='pprw028'

--select * from #bb where  party_code='J51492'

--select * from #aa where  party_code='J51492'

update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
from #mtfshortage a   join  #aa b on a.party_code=b.party_code

update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
delete from #mtfshortage where NET_MTF_REQ>0.00

 
delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  

  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 select 9892953949                 
 union all                          
 select 8108987990                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_25112024
-- --------------------------------------------------

  
  
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
CREATE Procedure [dbo].[MTF_SqOffAmtCalculation_25112024]                                      
as                                                              
SET XACT_ABORT ON                                                                    
Set nocount on                                                              
BEGIN TRY               
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'  
/*client shortage fetching*/  
  
exec general.dbo.[Update_Projected_OnlyVaR]  
exec general.dbo.MTF_BO_DATA  
  
declare @mtfdate datetime   
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)  
  
SELECT PARTY_CODE,NET_MTF_REQ_Old=MARGIN_SHORTFALL , 
NET_MTF_REQ =MARGIN_SHORTFALL,SAUDA_DATE=CONVERT(VARCHAR(10), CONVERT(date, ORDERBYDATE, 105), 23),
net_ledger =cast(0.00 as money),recipent_val=cast(0.00 as money)
into #mtfshortage  
from general.dbo.BO_MTFFinal with (nolock) 
WHERE ORDERBYDATE =@mtfdate  
  
delete from #mtfshortage where NET_MTF_REQ>=0  

select distinct T.party_code, MTFLEDBAL,netledger=cast(0.00 as money),
Final_bal=cast(0.00 as money)
into  #ledger 
from [AngelNseCM].MTFTrade.dbo.TBL_MTF_DATA T with (nolock) 
inner join #mtfshortage P
on T.PARTY_CODE=P.party_code
where cast(T.SAUDA_DATE as date)=(select max(cast(SAUDA_DATE as date)) 
from [AngelNseCM].MTFTrade.dbo.TBL_MTF_DATA with (nolock))   
group by T.party_code, MTFLEDBAL
	
select party_code,MTFLEDBAL,netledger=balance-MTFLEDBAL 
into #net
from general.dbo.tbl_ledger_All_Risk T with (nolock)  inner join #ledger L with (nolock)
on T.cltcode=L.party_code

declare @dt varchar(10)
;with sqoffdatae as      
 (      
    select top 2 ROW_NUMBER() over(order by a.Start_Date)as srno,  cast( a.Start_Date as date)   Start_Date                                            
    from general.dbo.bse_sett_mst a                                                                            
    where CONVERT(VARCHAR(10),a.start_Date,121) > =CONVERT(VARCHAR(10),getdate()-2,121)                                                     
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                              
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                            
    group by Start_Date
)      
select @dt = cast(Start_Date as date)  from sqoffdatae where srno=2 ; 

select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode into #Recieved_entry  from  
[AngelNseCM].account.dbo.lEDGER with (nolock) 
where  cast(vdt as date)=cast(@dt as date) and  vtyp=2 and drcr='C'  

select cltcode,credit=sum(balamt) into #cr 
from #Recieved_entry group by cltcode 

select party_code,NET_MTF_REQ, c.credit into #segmentwisecr 
from #mtfshortage m inner join #cr c
on m.PARTY_CODE=c.cltcode

update m set net_ledger=N.netledger  from #mtfshortage m inner join #net N
on m.PARTY_CODE=N.party_code 

update m set recipent_val=N.credit  from #mtfshortage m inner join #segmentwisecr N
on m.PARTY_CODE=N.party_code 
  
update c set NET_MTF_REQ = isnull(NET_MTF_REQ ,0) + isnull(t.netledger,0)
from #mtfshortage c inner join #net t with (nolock) on c.party_code= t.party_code    
where t.netledger>0.00

update c set NET_MTF_REQ = isnull(c.NET_MTF_REQ ,0) + isnull(t.credit,0)
from #mtfshortage c inner join #segmentwisecr t with (nolock) on c.party_code= t.party_code 
inner join #net N on c.PARTY_CODE=N.party_code
where N.netledger<=0

update c set NET_MTF_REQ = isnull(NET_MTF_REQ,0)+isnull(Amount,0)  
from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t with (nolock) on c.party_code= t.PARTY_CODE    
  
truncate table tbl_MTF_FinalShortage
insert into tbl_MTF_FinalShortage
select * ,upd_date=getdate() from #mtfshortage

delete from #mtfshortage where NET_MTF_REQ>=0.00  
  
/*added as required by v gohil on Jan 28 2020*/  
select * into #poa_mtf from Angeldemat.msajag.dbo.TBL_POA_COLL_DATA_MTF with (nolock) where cast(processdate as date)=@mtfdate  
  
update #poa_mtf set MTF_VARATE =secvar from  squareoff.dbo.MTF_ScripMaster M with (nolock) 
where #poa_mtf.CERTNO=m.isin  

alter table #poa_mtf add  value_after_hc money  
  
update #poa_mtf set value_after_hc=NET_VALUE*((100-MTF_VARATE)/100.00)      
  
select party_code,value_after_hc=sum(value_after_hc) into #final_data from  #poa_mtf group by party_code  
  
  
truncate table tbl_mtf_poa_holding  
insert into tbl_mtf_poa_holding  
select * from #final_data  
  
update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(value_after_hc,0)  from #mtfshortage c join #final_data t on c.party_code= t.PARTY_CODE    
  
delete from #mtfshortage where NET_MTF_REQ>=0.00  
/*added as required by v gohil on Jan 28 2020*/  
  
  
delete from MTF_data where Processdate=@mtfdate  
/*(select MAX(sauda_date) from #mtfshortage)*/  
  
insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)  
SELECT Processdate=@mtfdate,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00  
FROM #mtfshortage MTF  
  
delete from MTF_data where Shortage<1000 and Processdate=@mtfdate  
   
select @mtfdate as ProcessDate,  
EXCHANGE,  
sett_no,SEtt_type,  
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,  
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,  
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,  
CONVERT(MONEY,0) AS HAIRCUT,  
CONVERT(MONEY,0) AS VAHC,  
SPACE(10) AS CATEGORY,  
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )  
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,  
accno  
into #mtf_rms_holding  
from general.dbo.rms_holding with (nolock) where source in ('SI','SO','H','D')  and  accno in ('1203320030135829')--,'unsettled')  
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno  
  
update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b with (nolock)
where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                 
                          
update #mtf_rms_holding set clsrate=b.cls                                                                                                                     
from General.dbo.cp_nsecm b with (nolock)                                                                                                           
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                  
                        
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                               
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                   
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                    
        
        
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                          
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                      
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM'   
  
/*MTF Scrip Master */  
insert into MTF_ScripMaster_hist  
select distinct srno,Entereddate,Isin,Scrip_CodeNSE,Scrip_CodeBSE,ScripName,FromDate,Todate,
SpecialRemarks,Secvar,Splvar,Folisted,Multiplier,FinalHaircut,historydate=GETDATE() from MTF_ScripMaster  
  
truncate table MTF_ScripMaster_BO  
 
Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='M' and BillDate <= GETDATE())                                                                                                               
  
insert into MTF_ScripMaster_BO  
EXEC [AngelNseCM].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', ''   

truncate table MTF_ScripMaster
insert into MTF_ScripMaster
select distinct Entereddate,Isin,Scrip_CodeNSE,Scrip_CodeBSE,ScripName,FromDate,Todate,
SpecialRemarks,Secvar,Splvar,Folisted,Multiplier,FinalHaircut
from MTF_ScripMaster_BO

 
update x set Haircut=y.haircut from   
      #mtf_rms_holding x inner join   
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin   
      where accno in ('1203320030135829')--,'unsettled')  
  
/*** Added for non mtf scrip haircut ***/   
  
update x set Haircut=100 from   
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock))   
  
/*****Completed****/  
  
update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                  
                      
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)        
  
/*Negative Holding Adjustment*/  
  
select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin  
  
select psrno=DENSE_RANK() over (order by party_code,isin),  
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),  
* into #mtf_rms_holding1   
from #mtf_rms_holding a with (nolock) where exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
  
 ; WITH Hold_CTE AS (  
SELECT   
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin  
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/  
UNION ALL  
SELECT   
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from  
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno  
 and x.SrNoisin=y.SrNoisin+1  
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/  
)  
SELECT * into #mtf_rms_holding2  
FROM Hold_CTE option  (maxrecursion 32767) ;  
  
  
delete from #mtf_rms_holding2 where Qty<=0  
--select * from #mtf_rms_holding2  
  
    
/*************************************/  
  
  
delete from mtf_holding_hist where ProcessDate=@mtfdate  
  
insert into mtf_holding_hist  
select *,histdate=GETDATE() from mtf_holding  
  
truncate table mtf_holding  
  
insert into mtf_holding  
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)  
  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding2   
union all  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding_rest  
  
  
drop table #negative_holding  
drop table #mtf_rms_holding1  
drop table #mtf_rms_holding2  
  
                                                                         
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b with (nolock) where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                                
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b with (nolock) where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                                
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                    
    
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join   
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING with (nolock) group by party_code)b  
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)  
    
    
  select psrno =dense_rank() over(order by party_code ),  
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320030135829') then 0 else 1 end,sett_no desc,srno desc),  
  a.* into #holding  
  from MTF_HOLDING a with (nolock) inner join General.dbo.ScripCategory_master b with (nolock) on a.category=b.CategoryName   
    
  select   
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,  
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno  
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld  
  from #holding --where party_code='A88004'  
  order by psrno,sqoffsseg  
    
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b  
  on a.party_code=b.party_code  where a.sqoffsseg=1  
    
  
  --drop table #holdd  
    
;  WITH Hold_CTE AS (  
SELECT   
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,  
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,  
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x   
WHERE  sqoffsseg=1  
UNION ALL  
SELECT   
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,  
shortage= (ecte.shortage-ShortageReduction)  
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1   
and ecte.shortage>0  
)  
SELECT * into #holdd  
FROM Hold_CTE option  (maxrecursion 32767) ;  
   
update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0    
  
/*Addedd as suggested by vishal gohil on Aug 31 2017*/  
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)  
from #holdd a where clsrate>0 and haircut>0.00  
  
update a set Adjamt=Squareoffqty*clsrate from #holdd a  
  
update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,  
ShortageReduction=b.ShortageReduction,  
shortage=b.shortage  
  from mtf_holding a  inner join   
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and   
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type  
and a.exchange=b.exchange  
  
  
update a set squareoffvalue=b.adjamt from  mtf_data a inner join   
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b   
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)  
 
 update a set NoofDays=b.NoofDays+a.NoofDays   
  from   
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a  
inner join   
 (select * from mtf_data where Processdate in   
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b  
 on a.party_code=b.party_code  
   
  /* Remove T Day codes from MTF Process */  
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data with (nolock)  where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))  
  and processdate=(select max(processdate) from MTF_DATA)   
    
  /* Remove T+1 Day codes from MTF Process */  
 delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data with (nolock) where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data with (nolock)) 
 UNION 
 select DISTINCT party_code from [general].dbo.legalblkclients WITH (NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)  
    
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and  
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli with (nolock) where net_ledger>0.00 )  
  
  exec MTF_SqOffSeg  
  exec squareoff.dbo.MTF_BSE_VarShortage   
  exec squareoff.dbo.MTF_NSE_VarShortage   
  exec MTF_SquareOff_Exception_Process  

End try                                                                                   
    
BEGIN CATCH                                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                            
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                            
  DECLARE @ErrorMessage NVARCHAR(4000);                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
  RAISERROR (@ErrorMessage , 16, 1);                          
End catch                               
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_26122018
-- --------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE Procedure [dbo].[MTF_SqOffAmtCalculation_26122018]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  

                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=650)b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH
(NOLOCK))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
 select 8210223265 
 union all
 select 9892755595                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_30082017
-- --------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_30082017]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             


--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'

/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1
FROM #mtfshortage MTF

select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno


update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', 'Aug 12 2017', 'Aug 12 2017', '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno='1203320009603460'

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  

  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 

update a set Squareoffqty=convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0


update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.SquareUp_Client_Alert where updt=(select MAX(updt) from general.dbo.SquareUp_Client_Alert))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.SquareUp_Client where updt=(select MAX(updt) from general.dbo.SquareUp_Client))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_backup_04122019
-- --------------------------------------------------


------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE Procedure [dbo].[MTF_SqOffAmtCalculation_backup_04122019]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

exec general.dbo.[Update_Projected_OnlyVaR]

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = sum(NETAMT-(MARGIN_REQ+MTOM_LOSS))+(MTFLEDBAL+MTFCASHCOLLATERAL
 +MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code


--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE  

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t on c.party_code= t.PARTY_CODE  

-------------------------------------------------------End here-------------------------------------------------------------------------------------

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


delete from MTF_data where Shortage<1000 and Processdate=@mtfdate


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320018512144','1203320018512898','1203320000000028','20057752','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  


                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())                                                                                                             

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','1203320018512144','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320009603460','1203320018512144') then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
	delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH
	(NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)
  
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli where net_ledger>0.00 )

  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_BKP_12112018
-- --------------------------------------------------
CREATE Procedure [dbo].[MTF_SqOffAmtCalculation_BKP_12112018]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH(NOLOCK))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
 select 8210223265 
 union all
 select 9892755595                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkp_20180806
-- --------------------------------------------------

CREATE Procedure [dbo].[MTF_SqOffAmtCalculation_bkp_20180806]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 select 9892953949                 
 union all                          
 select 8108987990                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_Bkp11122018
-- --------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE Procedure [dbo].[MTF_SqOffAmtCalculation_Bkp11122018]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  

                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH
(NOLOCK))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
 select 8210223265 
 union all
 select 9892755595                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_Bkp24Apr2019
-- --------------------------------------------------
CREATE Procedure [dbo].[MTF_SqOffAmtCalculation_Bkp24Apr2019]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code


--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE  

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t on c.party_code= t.PARTY_CODE  

-------------------------------------------------------End here-------------------------------------------------------------------------------------

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                 
 


                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
 (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=650)b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
	delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH


	(NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
 select 8210223265 
 union all
 select 9892755595                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_Bkp31Jan2019
-- --------------------------------------------------


------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE Procedure [dbo].[MTF_SqOffAmtCalculation_Bkp31Jan2019]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code


--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------
update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE  

-------------------------------------------------------End here-------------------------------------------------------------------------------------

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  

                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=650)b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH
(NOLOCK))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
 select 8210223265 
 union all
 select 9892755595                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup_03122019
-- --------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_bkup_03122019]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

exec general.dbo.[Update_Projected_OnlyVaR]

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code


--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE  

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t on c.party_code= t.PARTY_CODE  

-------------------------------------------------------End here-------------------------------------------------------------------------------------

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF

delete from MTF_data where Shortage<1000 and Processdate=@mtfdate


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320018512144','1203320018512898','1203320000000028','20057752','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  


                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())                                                                                                             

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','1203320018512144','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320009603460','1203320018512144') then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
	delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH
	(NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)
  
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli where net_ledger>0.00 )

  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup_04122019
-- --------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_bkup_04122019]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

exec general.dbo.[Update_Projected_OnlyVaR]

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code


--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE  

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t on c.party_code= t.PARTY_CODE  

-------------------------------------------------------End here-------------------------------------------------------------------------------------

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


delete from MTF_data where Shortage<1000 and Processdate=@mtfdate


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320018512144','1203320018512898','1203320000000028','20057752','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  


                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())                                                                                                             

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','1203320018512144','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320009603460','1203320018512144') then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
	delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH
	(NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)
  
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli where net_ledger>0.00 )

  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup_04122024
-- --------------------------------------------------
  
  
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
Create Procedure [dbo].[MTF_SqOffAmtCalculation_bkup_04122024]                                      
as                                                              
SET XACT_ABORT ON                                                                    
Set nocount on                                                              
BEGIN TRY               
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'  
/*client shortage fetching*/  
  
exec general.dbo.[Update_Projected_OnlyVaR]  
exec general.dbo.MTF_BO_DATA  
  
declare @mtfdate datetime   
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)  
  
SELECT PARTY_CODE,NET_MTF_REQ_Old=MARGIN_SHORTFALL , 
NET_MTF_REQ =MARGIN_SHORTFALL,SAUDA_DATE=CONVERT(VARCHAR(10), CONVERT(date, ORDERBYDATE, 105), 23),
net_ledger =cast(0.00 as money),recipent_val=cast(0.00 as money)
into #mtfshortage  
from general.dbo.BO_MTFFinal with (nolock) 
WHERE ORDERBYDATE =@mtfdate  
  
delete from #mtfshortage where NET_MTF_REQ>=0  

select distinct T.party_code, MTFLEDBAL,netledger=cast(0.00 as money),
Final_bal=cast(0.00 as money)
into  #ledger 
from [AngelNseCM].MTFTrade.dbo.TBL_MTF_DATA T with (nolock) 
inner join #mtfshortage P
on T.PARTY_CODE=P.party_code
where cast(T.SAUDA_DATE as date)=(select max(cast(SAUDA_DATE as date)) 
from [AngelNseCM].MTFTrade.dbo.TBL_MTF_DATA with (nolock))   
group by T.party_code, MTFLEDBAL
	
select party_code,MTFLEDBAL,netledger=balance-MTFLEDBAL 
into #net
from general.dbo.tbl_ledger_All_Risk T with (nolock)  inner join #ledger L with (nolock)
on T.cltcode=L.party_code

declare @dt varchar(10)
;with sqoffdatae as      
 (      
    select top 2 ROW_NUMBER() over(order by a.Start_Date)as srno,  cast( a.Start_Date as date)   Start_Date                                            
    from general.dbo.bse_sett_mst a                                                                            
    where CONVERT(VARCHAR(10),a.start_Date,121) > =CONVERT(VARCHAR(10),getdate()-2,121)                                                     
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                              
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                            
    group by Start_Date
)      
select @dt = cast(Start_Date as date)  from sqoffdatae where srno=2 ; 

select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode into #Recieved_entry  from  
[AngelNseCM].account.dbo.lEDGER with (nolock) 
where  cast(vdt as date)=cast(@dt as date) and  vtyp=2 and drcr='C'  

select cltcode,credit=sum(balamt) into #cr 
from #Recieved_entry group by cltcode 

select party_code,NET_MTF_REQ, c.credit into #segmentwisecr 
from #mtfshortage m inner join #cr c
on m.PARTY_CODE=c.cltcode

update m set net_ledger=N.netledger  from #mtfshortage m inner join #net N
on m.PARTY_CODE=N.party_code 

update m set recipent_val=N.credit  from #mtfshortage m inner join #segmentwisecr N
on m.PARTY_CODE=N.party_code 
  
update c set NET_MTF_REQ = isnull(NET_MTF_REQ ,0) + isnull(t.netledger,0)
from #mtfshortage c inner join #net t with (nolock) on c.party_code= t.party_code    
where t.netledger>0.00

update c set NET_MTF_REQ = isnull(c.NET_MTF_REQ ,0) + isnull(t.credit,0)
from #mtfshortage c inner join #segmentwisecr t with (nolock) on c.party_code= t.party_code 
inner join #net N on c.PARTY_CODE=N.party_code
where N.netledger<=0

update c set NET_MTF_REQ = isnull(NET_MTF_REQ,0)+isnull(Amount,0)  
from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t with (nolock) on c.party_code= t.PARTY_CODE    
  
truncate table tbl_MTF_FinalShortage
insert into tbl_MTF_FinalShortage
select * ,upd_date=getdate() from #mtfshortage

delete from #mtfshortage where NET_MTF_REQ>=0.00  
  
/*added as required by v gohil on Jan 28 2020*/  
select * into #poa_mtf from Angeldemat.msajag.dbo.TBL_POA_COLL_DATA_MTF with (nolock) where cast(processdate as date)=@mtfdate  
  
update #poa_mtf set MTF_VARATE =secvar from  squareoff.dbo.MTF_ScripMaster M with (nolock) 
where #poa_mtf.CERTNO=m.isin  

alter table #poa_mtf add  value_after_hc money  
  
update #poa_mtf set value_after_hc=NET_VALUE*((100-MTF_VARATE)/100.00)      
  
select party_code,value_after_hc=sum(value_after_hc) into #final_data from  #poa_mtf group by party_code  
  
  
truncate table tbl_mtf_poa_holding  
insert into tbl_mtf_poa_holding  
select * from #final_data  
  
update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(value_after_hc,0)  from #mtfshortage c join #final_data t on c.party_code= t.PARTY_CODE    
  
delete from #mtfshortage where NET_MTF_REQ>=0.00  
/*added as required by v gohil on Jan 28 2020*/  
  
  
delete from MTF_data where Processdate=@mtfdate  
/*(select MAX(sauda_date) from #mtfshortage)*/  
  
insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)  
SELECT Processdate=@mtfdate,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00  
FROM #mtfshortage MTF  
  
delete from MTF_data where Shortage<1000 and Processdate=@mtfdate  
   
select @mtfdate as ProcessDate,  
EXCHANGE,  
sett_no,SEtt_type,  
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,  
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,  
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,  
CONVERT(MONEY,0) AS HAIRCUT,  
CONVERT(MONEY,0) AS VAHC,  
SPACE(10) AS CATEGORY,  
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )  
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,  
accno  
into #mtf_rms_holding  
from general.dbo.rms_holding with (nolock) where source in ('SI','SO','H','D')  and  accno in ('1203320030135829')--,'unsettled')  
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno  
  
update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b with (nolock)
where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                 
                          
update #mtf_rms_holding set clsrate=b.cls                                                                                                                     
from General.dbo.cp_nsecm b with (nolock)                                                                                                           
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                  
                        
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                               
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                   
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                    
        
        
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                          
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                      
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM'   
  
/*MTF Scrip Master */  
insert into MTF_ScripMaster_hist  
select distinct srno,Entereddate,Isin,Scrip_CodeNSE,Scrip_CodeBSE,ScripName,FromDate,Todate,
SpecialRemarks,Secvar,Splvar,Folisted,Multiplier,FinalHaircut,historydate=GETDATE() from MTF_ScripMaster  
  
truncate table MTF_ScripMaster_BO  
 
Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='M' and BillDate <= GETDATE())                                                                                                               
  
insert into MTF_ScripMaster_BO  
EXEC [AngelNseCM].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', ''   

truncate table MTF_ScripMaster
insert into MTF_ScripMaster
select distinct Entereddate,Isin,Scrip_CodeNSE,Scrip_CodeBSE,ScripName,FromDate,Todate,
SpecialRemarks,Secvar,Splvar,Folisted,Multiplier,FinalHaircut
from MTF_ScripMaster_BO

 
update x set Haircut=y.haircut from   
      #mtf_rms_holding x inner join   
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin   
      where accno in ('1203320030135829')--,'unsettled')  
  
/*** Added for non mtf scrip haircut ***/   
  
update x set Haircut=100 from   
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock))   
  
/*****Completed****/  
  
update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                  
                      
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)        
  
/*Negative Holding Adjustment*/  
  
select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin  
  
select psrno=DENSE_RANK() over (order by party_code,isin),  
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),  
* into #mtf_rms_holding1   
from #mtf_rms_holding a with (nolock) where exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
  
 ; WITH Hold_CTE AS (  
SELECT   
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin  
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/  
UNION ALL  
SELECT   
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from  
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno  
 and x.SrNoisin=y.SrNoisin+1  
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/  
)  
SELECT * into #mtf_rms_holding2  
FROM Hold_CTE option  (maxrecursion 32767) ;  
  
  
delete from #mtf_rms_holding2 where Qty<=0  
--select * from #mtf_rms_holding2  
  
    
/*************************************/  
  
  
delete from mtf_holding_hist where ProcessDate=@mtfdate  
  
insert into mtf_holding_hist  
select *,histdate=GETDATE() from mtf_holding  
  
truncate table mtf_holding  
  
insert into mtf_holding  
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)  
  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding2   
union all  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding_rest  
  
  
drop table #negative_holding  
drop table #mtf_rms_holding1  
drop table #mtf_rms_holding2  
  
                                                                         
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b with (nolock) where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                                
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b with (nolock) where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                                
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                    
    
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join   
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING with (nolock) group by party_code)b  
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)  
    
    
  select psrno =dense_rank() over(order by party_code ),  
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320030135829') then 0 else 1 end,sett_no desc,srno desc),  
  a.* into #holding  
  from MTF_HOLDING a with (nolock) inner join General.dbo.ScripCategory_master b with (nolock) on a.category=b.CategoryName   
    
  select   
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,  
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno  
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld  
  from #holding --where party_code='A88004'  
  order by psrno,sqoffsseg  
    
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b  
  on a.party_code=b.party_code  where a.sqoffsseg=1  
    
  
  --drop table #holdd  
    
;  WITH Hold_CTE AS (  
SELECT   
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,  
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,  
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x   
WHERE  sqoffsseg=1  
UNION ALL  
SELECT   
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,  
shortage= (ecte.shortage-ShortageReduction)  
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1   
and ecte.shortage>0  
)  
SELECT * into #holdd  
FROM Hold_CTE option  (maxrecursion 32767) ;  
   
update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0    
  
/*Addedd as suggested by vishal gohil on Aug 31 2017*/  
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)  
from #holdd a where clsrate>0 and haircut>0.00  
  
update a set Adjamt=Squareoffqty*clsrate from #holdd a  
  
update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,  
ShortageReduction=b.ShortageReduction,  
shortage=b.shortage  
  from mtf_holding a  inner join   
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and   
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type  
and a.exchange=b.exchange  
  
  
update a set squareoffvalue=b.adjamt from  mtf_data a inner join   
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b   
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)  
 
 update a set NoofDays=b.NoofDays+a.NoofDays   
  from   
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a  
inner join   
 (select * from mtf_data where Processdate in   
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b  
 on a.party_code=b.party_code  
   
  /* Remove T Day codes from MTF Process */  
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data with (nolock)  where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))  
  and processdate=(select max(processdate) from MTF_DATA)   
    
  /* Remove T+1 Day codes from MTF Process */  
 delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data with (nolock) where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data with (nolock)) 
 UNION 
 select DISTINCT party_code from [general].dbo.legalblkclients WITH (NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)  
    
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and  
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli with (nolock) where net_ledger>0.00 )  
  
  exec MTF_SqOffSeg  
  exec squareoff.dbo.MTF_BSE_VarShortage   
  exec squareoff.dbo.MTF_NSE_VarShortage   
  exec MTF_SquareOff_Exception_Process  

End try                                                                                   
    
BEGIN CATCH                                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                            
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                            
  DECLARE @ErrorMessage NVARCHAR(4000);                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
  RAISERROR (@ErrorMessage , 16, 1);                          
End catch                               
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup_06052021
-- --------------------------------------------------

  
  
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
CREATE Procedure [dbo].[MTF_SqOffAmtCalculation_bkup_06052021]                                      
as                                                              
SET XACT_ABORT ON                                                                    
Set nocount on                                                              
BEGIN TRY               
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'  
/*client shortage fetching*/  
  
exec general.dbo.[Update_Projected_OnlyVaR]  
exec general.dbo.MTF_BO_DATA  
  
declare @mtfdate datetime   
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)  
  
SELECT PARTY_CODE,  
NET_MTF_REQ =MARGIN_SHORTFALL ,SAUDA_DATE=CONVERT(VARCHAR(10), CONVERT(date, ORDERBYDATE, 105), 23)    
into #mtfshortage  
from general.dbo.BO_MTFFinal  
WHERE ORDERBYDATE =@mtfdate  
  
delete from #mtfshortage where NET_MTF_REQ>=0  
  
select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)  
into #aa  
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00  
  
select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)  
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage  
  
--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger   
--into #bb  
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708'   
  
  
--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)  
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code  
  
--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)  
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code  
   
--delete from #mtfshortage where NET_MTF_REQ>0.00  
  
/*Received Entries from BSE.NSE and NSEFO added on 24022018*/  
/*Start*/  
if (DATEPART(dw,GETDATE())=2)  
begin  
  
 select * into #Recieved_entry1  
 from  
 (  
 select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from  
 [anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000  
 where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'  
 union all  
 select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]  
 where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577  
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577  
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'  
 )A  
  
   
 IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL      
 DROP TABLE #Other_bal1    
 select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode  
   
 Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a  
 where #Other_SegAdj.party_code=a.party_code  
  
 Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a  
 where #Other_SegAdj.party_code=a.cltcode  
  
end  
else  
begin  
 select * into #Recieved_entry2  
 from  
 (  
 select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from  
 [anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000  
 where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'  
 union all  
 select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]  
 where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577  
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577  
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'  
 )A  
   
 IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL      
 DROP TABLE #Other_bal2    
 select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode  
   
 Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a  
 where #Other_SegAdj.party_code=a.party_code ---and  a.Party_Code <>'P250906'  
  
 Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a  
 where #Other_SegAdj.party_code=a.cltcode  
end  
  
update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )  
  
select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00  
/*  
select  A.client,OtherSeg_Credit=sum(net)  
into #Direct_Adj  
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code   
where  net>0.00 group by client-- and B.party_code='s140708'   
*/  
  
/*Added on 06 July 2018 as required by Vishal Gohil */  
select  A.client,OtherSeg_Credit=sum(net)  
into #Direct_Adj  
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code   
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708'   
  
delete from #Direct_Adj where OtherSeg_Credit<=0.00  
  
update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D  
where #Other_SegAdj.party_code=D.client  
  
update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O  
where #mtfshortage.party_code=O.party_code  
  
  
--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------  
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE    
  
update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t on c.party_code= t.PARTY_CODE    
  
-------------------------------------------------------End here-------------------------------------------------------------------------------------  
  
delete from #mtfshortage where NET_MTF_REQ>=0.00  
/*End*/  
  
/*added as required by v gohil on Jan 28 2020*/  
select * into #poa_mtf from Angeldemat.msajag.dbo.TBL_POA_COLL_DATA_MTF where cast(processdate as date)=@mtfdate  
  
update #poa_mtf set MTF_VARATE =secvar from  squareoff.dbo.MTF_ScripMaster M where #poa_mtf.CERTNO=m.isin   
alter table #poa_mtf add  value_after_hc money  
  
update #poa_mtf set value_after_hc=NET_VALUE*((100-MTF_VARATE)/100.00)      
  
select party_code,value_after_hc=sum(value_after_hc) into #final_data from  #poa_mtf group by party_code  
  
  
truncate table tbl_mtf_poa_holding  
insert into tbl_mtf_poa_holding  
select * from #final_data  
  
update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(value_after_hc,0)  from #mtfshortage c join #final_data t on c.party_code= t.PARTY_CODE    
  
delete from #mtfshortage where NET_MTF_REQ>=0.00  
/*added as required by v gohil on Jan 28 2020*/  
  
  
delete from MTF_data where Processdate=@mtfdate  
/*(select MAX(sauda_date) from #mtfshortage)*/  
  
insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)  
SELECT Processdate=@mtfdate,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00  
FROM #mtfshortage MTF  
  
  
delete from MTF_data where Shortage<1000 and Processdate=@mtfdate  
  
  
select @mtfdate as ProcessDate,  
EXCHANGE,  
sett_no,SEtt_type,  
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,  
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,  
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,  
CONVERT(MONEY,0) AS HAIRCUT,  
CONVERT(MONEY,0) AS VAHC,  
SPACE(10) AS CATEGORY,  
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )  
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,  
accno  
into #mtf_rms_holding  
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320030135829')--,'unsettled')  
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno  
  
update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                 
   
  
  
                        
update #mtf_rms_holding set clsrate=b.cls                                                                                                                     
from General.dbo.cp_nsecm b                                                                                                           
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                  
                        
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                               
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                   
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                    
        
        
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                          
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                      
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM'   
  
/*MTF Scrip Master */  
insert into MTF_ScripMaster_hist  
select *,historydate=GETDATE() from MTF_ScripMaster  
  
truncate table MTF_ScripMaster  
  
  
Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())                                                                                                               
  
insert into MTF_ScripMaster  
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', ''   
  
         /*               
update x set Haircut=y.haircut from   
      #mtf_rms_holding x inner join   
      (select isin,haircut=max(haircut) from   
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate  
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */  
       group by isin)y on x.isin=y.isin   
       where accno='1203320009603460'  
       */  
  
  
update x set Haircut=y.haircut from   
      #mtf_rms_holding x inner join   
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin   
      where accno in ('1203320030135829')--,'unsettled')  
  
/*** Added for non mtf scrip haircut ***/   
  
update x set Haircut=100 from   
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock))   
  
/*****Completed****/  
  
update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                  
                      
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)        
  
/*Negative Holding Adjustment*/  
  
select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin  
  
select psrno=DENSE_RANK() over (order by party_code,isin),  
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),  
* into #mtf_rms_holding1   
from #mtf_rms_holding a with (nolock) where exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
  
 ; WITH Hold_CTE AS (  
SELECT   
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin  
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/  
UNION ALL  
SELECT   
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from  
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno  
 and x.SrNoisin=y.SrNoisin+1  
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/  
)  
SELECT * into #mtf_rms_holding2  
FROM Hold_CTE option  (maxrecursion 32767) ;  
  
  
delete from #mtf_rms_holding2 where Qty<=0  
--select * from #mtf_rms_holding2  
  
    
/*************************************/  
  
  
delete from mtf_holding_hist where ProcessDate=@mtfdate  
  
insert into mtf_holding_hist  
select *,histdate=GETDATE() from mtf_holding  
  
truncate table mtf_holding  
  
insert into mtf_holding  
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)  
  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding2   
union all  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding_rest  
  
  
drop table #negative_holding  
drop table #mtf_rms_holding1  
drop table #mtf_rms_holding2  
  
                                                                         
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                                
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                                
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                    
    
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join   
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b  
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)  
    
    
  select psrno =dense_rank() over(order by party_code ),  
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320030135829') then 0 else 1 end,sett_no desc,srno desc),  
  a.* into #holding  
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName   
    
  select   
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,  
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno  
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld  
  from #holding --where party_code='A88004'  
  order by psrno,sqoffsseg  
    
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b  
  on a.party_code=b.party_code  where a.sqoffsseg=1  
    
  
  --drop table #holdd  
    
;  WITH Hold_CTE AS (  
SELECT   
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,  
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,  
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x   
WHERE  sqoffsseg=1  
UNION ALL  
SELECT   
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,  
shortage= (ecte.shortage-ShortageReduction)  
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1   
and ecte.shortage>0  
)  
SELECT * into #holdd  
FROM Hold_CTE option  (maxrecursion 32767) ;  
  
  
update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0   
/*  
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else    
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0  
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0  
*/  
  
/*Addedd as suggested by vishal gohil on Aug 31 2017*/  
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)  
from #holdd a where clsrate>0 and haircut>0.00  
  
update a set Adjamt=Squareoffqty*clsrate from #holdd a  
  
update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,  
ShortageReduction=b.ShortageReduction,  
shortage=b.shortage  
  from mtf_holding a  inner join   
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and   
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type  
and a.exchange=b.exchange  
  
  
update a set squareoffvalue=b.adjamt from  mtf_data a inner join   
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b   
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)  
  
--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'  
  
--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end  
    
/*Ageing days calculation*/  
 /*select * from mtf_data with (nolock) where party_code='U10452'*/  
   
-- declare @mtfdate datetime   
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)  
  
  
 update a set NoofDays=b.NoofDays+a.NoofDays   
  from   
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a  
inner join   
 (select * from mtf_data where Processdate in   
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b  
 on a.party_code=b.party_code  
   
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000'   
  
 /*  
 select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,  
 a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from   
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a  
inner join   
 (select * from mtf_data where Processdate in   
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b  
 on a.party_code=b.party_code  
  */  
  /* Remove T Day codes from MTF Process */  
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))  
  and processdate=(select max(processdate) from MTF_DATA)   
    
  /* Remove T+1 Day codes from MTF Process */  
 delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH 
 
 (NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)  
    
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and  
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli where net_ledger>0.00 )  
  
  exec MTF_SqOffSeg  
  exec squareoff.dbo.MTF_BSE_VarShortage   
  exec squareoff.dbo.MTF_NSE_VarShortage   
  exec MTF_SquareOff_Exception_Process  
    
    
 create table #MobNo                         
 (                            
 mobno numeric(10,0)                            
 )                            
                             
 insert into #MobNo                            
 --select 9892953949                   
 --union all                            
-- select 9820202050 /*Bhavin Parekh*/                            
 --union all                            
 select 9820701602 /*VISHAL GOHIL*/                            
 union all                                                    
 select 9820731985 /*VISHAL KANANI*/       
 union all                            
 select 9892312837 /*TUSHAR J*/                            
 union all                            
 select 9860579556 /*SANDEEP NEGI*/      
 union all                            
 select 9819164199 /*NAVNEET SHAH*/      
    
 declare @str varchar(1000)                     
 set @str='MTF Process completed successfully.'    
   
                      
 insert into intranet.sms.dbo.sms                            
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                            
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                            
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                            
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                            
 then 'PM' else 'AM' end,'RMS UPDATION'                            
 from #MobNo a            
    
      
End try                                                                                   
    
BEGIN CATCH                                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                            
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                            
  DECLARE @ErrorMessage NVARCHAR(4000);                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
  RAISERROR (@ErrorMessage , 16, 1);                          
End catch                               
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup_14062024
-- --------------------------------------------------

  
  
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
CREATE Procedure [dbo].[MTF_SqOffAmtCalculation_bkup_14062024]                                      
as                                                              
SET XACT_ABORT ON                                                                    
Set nocount on                                                              
BEGIN TRY               
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'  
/*client shortage fetching*/  
  
exec general.dbo.[Update_Projected_OnlyVaR]  
exec general.dbo.MTF_BO_DATA  
  
declare @mtfdate datetime   
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)  
  
SELECT PARTY_CODE,  
NET_MTF_REQ =MARGIN_SHORTFALL ,SAUDA_DATE=CONVERT(VARCHAR(10), CONVERT(date, ORDERBYDATE, 105), 23)    
into #mtfshortage  
from general.dbo.BO_MTFFinal with (nolock) 
WHERE ORDERBYDATE =@mtfdate  
  
delete from #mtfshortage where NET_MTF_REQ>=0  
  
select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)  
into #aa  
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00  
  
select party_code,net_mtf_req,Net_Bal=convert(money,0.00),Reciept_Entry=convert(money,0.00)  
,Higher_Amount=convert(money,0.00) into #Other_SegAdj from #mtfshortage  
  
--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger   
--into #bb  
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708'   
  
  
--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)  
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code  
  
--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)  
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code  
   
--delete from #mtfshortage where NET_MTF_REQ>0.00  
  
/*Received Entries from BSE.NSE and NSEFO added on 24022018*/  
/*Start*/  
if (DATEPART(dw,GETDATE())=2)  
begin  
  
 select * into #Recieved_entry1  
 from  
 (  
 select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from  
 [AngelNseCM].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [AngelBSECM].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000  
 where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'  
 union all  
 select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]  
 where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577  
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577  
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'  
 )A  
  
   
 IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL      
 DROP TABLE #Other_bal1    
 select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode  
   
 Update #Other_SegAdj set Net_Bal=Net_ledger from #aa a  
 where #Other_SegAdj.party_code=a.party_code  
  
 Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a  
 where #Other_SegAdj.party_code=a.cltcode  
  
end  
else  
begin  
 select * into #Recieved_entry2  
 from  
 (  
 select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from  
 [AngelNseCM].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [AngelBSECM].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000  
 where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'  
 union all  
 select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]  
 where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577  
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577  
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'  
 )A  
   
 IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL      
 DROP TABLE #Other_bal2    
 select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode  
   
 Update #Other_SegAdj set Net_Bal=Net_ledger from #aa a  
 where #Other_SegAdj.party_code=a.party_code ---and  a.Party_Code <>'P250906'  
  
 Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a  
 where #Other_SegAdj.party_code=a.cltcode  
end  
  
update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )  
  
select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00  
/*  
select  A.client,OtherSeg_Credit=sum(net)  
into #Direct_Adj  
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code   
where  net>0.00 group by client-- and B.party_code='s140708'   
*/  
  
/*Added on 06 July 2018 as required by Vishal Gohil */  
select  A.client,OtherSeg_Credit=sum(net)  
into #Direct_Adj  
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code   
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708'   
  
delete from #Direct_Adj where OtherSeg_Credit<=0.00  
  
update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D  
where #Other_SegAdj.party_code=D.client  
  
update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O  
where #mtfshortage.party_code=O.party_code  
  
  
--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------  
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE    
  
update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t with (nolock) on c.party_code= t.PARTY_CODE    
  
-------------------------------------------------------End here-------------------------------------------------------------------------------------  
  
delete from #mtfshortage where NET_MTF_REQ>=0.00  
/*End*/  
  
/*added as required by v gohil on Jan 28 2020*/  
select * into #poa_mtf from Angeldemat.msajag.dbo.TBL_POA_COLL_DATA_MTF with (nolock) where cast(processdate as date)=@mtfdate  
  
update #poa_mtf set MTF_VARATE =secvar from  squareoff.dbo.MTF_ScripMaster M with (nolock) 
where #poa_mtf.CERTNO=m.isin  

alter table #poa_mtf add  value_after_hc money  
  
update #poa_mtf set value_after_hc=NET_VALUE*((100-MTF_VARATE)/100.00)      
  
select party_code,value_after_hc=sum(value_after_hc) into #final_data from  #poa_mtf group by party_code  
  
  
truncate table tbl_mtf_poa_holding  
insert into tbl_mtf_poa_holding  
select * from #final_data  
  
update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(value_after_hc,0)  from #mtfshortage c join #final_data t on c.party_code= t.PARTY_CODE    
  
delete from #mtfshortage where NET_MTF_REQ>=0.00  
/*added as required by v gohil on Jan 28 2020*/  
  
  
delete from MTF_data where Processdate=@mtfdate  
/*(select MAX(sauda_date) from #mtfshortage)*/  
  
insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)  
SELECT Processdate=@mtfdate,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00  
FROM #mtfshortage MTF  
  
  
delete from MTF_data where Shortage<1000 and Processdate=@mtfdate  
  
  
select @mtfdate as ProcessDate,  
EXCHANGE,  
sett_no,SEtt_type,  
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,  
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,  
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,  
CONVERT(MONEY,0) AS HAIRCUT,  
CONVERT(MONEY,0) AS VAHC,  
SPACE(10) AS CATEGORY,  
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )  
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,  
accno  
into #mtf_rms_holding  
from general.dbo.rms_holding with (nolock) where source in ('SI','SO','H','D')  and  accno in ('1203320030135829')--,'unsettled')  
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno  
  
update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b with (nolock)
where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                 
                          
update #mtf_rms_holding set clsrate=b.cls                                                                                                                     
from General.dbo.cp_nsecm b with (nolock)                                                                                                           
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                  
                        
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                               
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                   
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                    
        
        
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                          
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                      
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM'   
  
/*MTF Scrip Master */  
insert into MTF_ScripMaster_hist  
select distinct srno,Entereddate,Isin,Scrip_CodeNSE,Scrip_CodeBSE,ScripName,FromDate,Todate,
SpecialRemarks,Secvar,Splvar,Folisted,Multiplier,FinalHaircut,historydate=GETDATE() from MTF_ScripMaster  
  
truncate table MTF_ScripMaster_BO  
 
Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='M' and BillDate <= GETDATE())                                                                                                               
  
insert into MTF_ScripMaster_BO  
EXEC [AngelNseCM].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', ''   

truncate table MTF_ScripMaster
insert into MTF_ScripMaster
select distinct Entereddate,Isin,Scrip_CodeNSE,Scrip_CodeBSE,ScripName,FromDate,Todate,
SpecialRemarks,Secvar,Splvar,Folisted,Multiplier,FinalHaircut
from MTF_ScripMaster_BO

         /*               
update x set Haircut=y.haircut from   
      #mtf_rms_holding x inner join   
      (select isin,haircut=max(haircut) from   
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate  
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */  
       group by isin)y on x.isin=y.isin   
       where accno='1203320009603460'  
       */  
  
  
update x set Haircut=y.haircut from   
      #mtf_rms_holding x inner join   
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin   
      where accno in ('1203320030135829')--,'unsettled')  
  
/*** Added for non mtf scrip haircut ***/   
  
update x set Haircut=100 from   
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock))   
  
/*****Completed****/  
  
update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                  
                      
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)        
  
/*Negative Holding Adjustment*/  
  
select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin  
  
select psrno=DENSE_RANK() over (order by party_code,isin),  
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),  
* into #mtf_rms_holding1   
from #mtf_rms_holding a with (nolock) where exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
  
 ; WITH Hold_CTE AS (  
SELECT   
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin  
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/  
UNION ALL  
SELECT   
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from  
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno  
 and x.SrNoisin=y.SrNoisin+1  
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/  
)  
SELECT * into #mtf_rms_holding2  
FROM Hold_CTE option  (maxrecursion 32767) ;  
  
  
delete from #mtf_rms_holding2 where Qty<=0  
--select * from #mtf_rms_holding2  
  
    
/*************************************/  
  
  
delete from mtf_holding_hist where ProcessDate=@mtfdate  
  
insert into mtf_holding_hist  
select *,histdate=GETDATE() from mtf_holding  
  
truncate table mtf_holding  
  
insert into mtf_holding  
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)  
  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding2   
union all  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding_rest  
  
  
drop table #negative_holding  
drop table #mtf_rms_holding1  
drop table #mtf_rms_holding2  
  
                                                                         
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b with (nolock) where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                                
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b with (nolock) where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                                
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                    
    
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join   
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING with (nolock) group by party_code)b  
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)  
    
    
  select psrno =dense_rank() over(order by party_code ),  
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320030135829') then 0 else 1 end,sett_no desc,srno desc),  
  a.* into #holding  
  from MTF_HOLDING a with (nolock) inner join General.dbo.ScripCategory_master b with (nolock) on a.category=b.CategoryName   
    
  select   
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,  
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno  
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld  
  from #holding --where party_code='A88004'  
  order by psrno,sqoffsseg  
    
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b  
  on a.party_code=b.party_code  where a.sqoffsseg=1  
    
  
  --drop table #holdd  
    
;  WITH Hold_CTE AS (  
SELECT   
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,  
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,  
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x   
WHERE  sqoffsseg=1  
UNION ALL  
SELECT   
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,  
shortage= (ecte.shortage-ShortageReduction)  
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1   
and ecte.shortage>0  
)  
SELECT * into #holdd  
FROM Hold_CTE option  (maxrecursion 32767) ;  
  
  
update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0   
/*  
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else    
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0  
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0  
*/  
  
/*Addedd as suggested by vishal gohil on Aug 31 2017*/  
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)  
from #holdd a where clsrate>0 and haircut>0.00  
  
update a set Adjamt=Squareoffqty*clsrate from #holdd a  
  
update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,  
ShortageReduction=b.ShortageReduction,  
shortage=b.shortage  
  from mtf_holding a  inner join   
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and   
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type  
and a.exchange=b.exchange  
  
  
update a set squareoffvalue=b.adjamt from  mtf_data a inner join   
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b   
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)  
  
--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'  
  
--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end  
    
/*Ageing days calculation*/  
 /*select * from mtf_data with (nolock) where party_code='U10452'*/  
   
-- declare @mtfdate datetime   
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)  
  
  
 update a set NoofDays=b.NoofDays+a.NoofDays   
  from   
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a  
inner join   
 (select * from mtf_data where Processdate in   
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b  
 on a.party_code=b.party_code  
   
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000'   
  
 /*  
 select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,  
 a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from   
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a  
inner join   
 (select * from mtf_data where Processdate in   
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b  
 on a.party_code=b.party_code  
  */  
  /* Remove T Day codes from MTF Process */  
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data with (nolock)  where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))  
  and processdate=(select max(processdate) from MTF_DATA)   
    
  /* Remove T+1 Day codes from MTF Process */  
 delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data with (nolock) where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data with (nolock)) 
 UNION 
 select DISTINCT party_code from [general].dbo.legalblkclients WITH (NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)  
    
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and  
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli with (nolock) where net_ledger>0.00 )  
  
  exec MTF_SqOffSeg  
  exec squareoff.dbo.MTF_BSE_VarShortage   
  exec squareoff.dbo.MTF_NSE_VarShortage   
  exec MTF_SquareOff_Exception_Process  
/*    
    
 create table #MobNo                         
 (                            
 mobno numeric(10,0)                            
 )                            
                             
 insert into #MobNo                            
 --select 9892953949                   
 --union all                            
-- select 9820202050 /*Bhavin Parekh*/                            
 --union all                            
 select 9820701602 /*VISHAL GOHIL*/                            
 union all                                                    
 select 9820731985 /*VISHAL KANANI*/       
 union all                            
 select 9892312837 /*TUSHAR J*/                            
 union all                            
 select 9860579556 /*SANDEEP NEGI*/      
 union all                            
 select 9819164199 /*NAVNEET SHAH*/      
    
 declare @str varchar(1000)                     
 set @str='MTF Process completed successfully.'    
   
                      
 insert into intranet.sms.dbo.sms                            
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                            
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                            
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                            
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                            
 then 'PM' else 'AM' end,'RMS UPDATION'                            
 from #MobNo a            
    
    */  
End try                                                                                   
    
BEGIN CATCH                                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                            
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                            
  DECLARE @ErrorMessage NVARCHAR(4000);                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
  RAISERROR (@ErrorMessage , 16, 1);                          
End catch                               
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup_22122022
-- --------------------------------------------------

  
  
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
CREATE Procedure [dbo].[MTF_SqOffAmtCalculation_bkup_22122022]                                      
as                                                              
SET XACT_ABORT ON                                                                    
Set nocount on                                                              
BEGIN TRY               
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'  
/*client shortage fetching*/  
  
exec general.dbo.[Update_Projected_OnlyVaR]  
exec general.dbo.MTF_BO_DATA  
  
declare @mtfdate datetime   
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)  
  
SELECT PARTY_CODE,  
NET_MTF_REQ =MARGIN_SHORTFALL ,SAUDA_DATE=CONVERT(VARCHAR(10), CONVERT(date, ORDERBYDATE, 105), 23)    
into #mtfshortage  
from general.dbo.BO_MTFFinal  
WHERE ORDERBYDATE =@mtfdate  
  
delete from #mtfshortage where NET_MTF_REQ>=0  
  
select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)  
into #aa  
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00  
  
select party_code,net_mtf_req,Net_Bal=convert(money,0.00),Reciept_Entry=convert(money,0.00)  
,Higher_Amount=convert(money,0.00) into #Other_SegAdj from #mtfshortage  
  
--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger   
--into #bb  
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708'   
  
  
--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)  
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code  
  
--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)  
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code  
   
--delete from #mtfshortage where NET_MTF_REQ>0.00  
  
/*Received Entries from BSE.NSE and NSEFO added on 24022018*/  
/*Start*/  
if (DATEPART(dw,GETDATE())=2)  
begin  
  
 select * into #Recieved_entry1  
 from  
 (  
 select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from  
 [anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000  
 where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'  
 union all  
 select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]  
 where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577  
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577  
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'  
 )A  
  
   
 IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL      
 DROP TABLE #Other_bal1    
 select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode  
   
 Update #Other_SegAdj set Net_Bal=Net_ledger from #aa a  
 where #Other_SegAdj.party_code=a.party_code  
  
 Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a  
 where #Other_SegAdj.party_code=a.cltcode  
  
end  
else  
begin  
 select * into #Recieved_entry2  
 from  
 (  
 select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from  
 [anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000  
 where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'  
 union all  
 select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]  
 where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577  
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'  
 union all  
 select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577  
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'  
 )A  
   
 IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL      
 DROP TABLE #Other_bal2    
 select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode  
   
 Update #Other_SegAdj set Net_Bal=Net_ledger from #aa a  
 where #Other_SegAdj.party_code=a.party_code ---and  a.Party_Code <>'P250906'  
  
 Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a  
 where #Other_SegAdj.party_code=a.cltcode  
end  
  
update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )  
  
select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00  
/*  
select  A.client,OtherSeg_Credit=sum(net)  
into #Direct_Adj  
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code   
where  net>0.00 group by client-- and B.party_code='s140708'   
*/  
  
/*Added on 06 July 2018 as required by Vishal Gohil */  
select  A.client,OtherSeg_Credit=sum(net)  
into #Direct_Adj  
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code   
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708'   
  
delete from #Direct_Adj where OtherSeg_Credit<=0.00  
  
update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D  
where #Other_SegAdj.party_code=D.client  
  
update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O  
where #mtfshortage.party_code=O.party_code  
  
  
--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------  
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE    
  
update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t on c.party_code= t.PARTY_CODE    
  
-------------------------------------------------------End here-------------------------------------------------------------------------------------  
  
delete from #mtfshortage where NET_MTF_REQ>=0.00  
/*End*/  
  
/*added as required by v gohil on Jan 28 2020*/  
select * into #poa_mtf from Angeldemat.msajag.dbo.TBL_POA_COLL_DATA_MTF where cast(processdate as date)=@mtfdate  
  
update #poa_mtf set MTF_VARATE =secvar from  squareoff.dbo.MTF_ScripMaster M where #poa_mtf.CERTNO=m.isin   
alter table #poa_mtf add  value_after_hc money  
  
update #poa_mtf set value_after_hc=NET_VALUE*((100-MTF_VARATE)/100.00)      
  
select party_code,value_after_hc=sum(value_after_hc) into #final_data from  #poa_mtf group by party_code  
  
  
truncate table tbl_mtf_poa_holding  
insert into tbl_mtf_poa_holding  
select * from #final_data  
  
update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(value_after_hc,0)  from #mtfshortage c join #final_data t on c.party_code= t.PARTY_CODE    
  
delete from #mtfshortage where NET_MTF_REQ>=0.00  
/*added as required by v gohil on Jan 28 2020*/  
  
  
delete from MTF_data where Processdate=@mtfdate  
/*(select MAX(sauda_date) from #mtfshortage)*/  
  
insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)  
SELECT Processdate=@mtfdate,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00  
FROM #mtfshortage MTF  
  
  
delete from MTF_data where Shortage<1000 and Processdate=@mtfdate  
  
  
select @mtfdate as ProcessDate,  
EXCHANGE,  
sett_no,SEtt_type,  
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,  
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,  
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,  
CONVERT(MONEY,0) AS HAIRCUT,  
CONVERT(MONEY,0) AS VAHC,  
SPACE(10) AS CATEGORY,  
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )  
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,  
accno  
into #mtf_rms_holding  
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320030135829')--,'unsettled')  
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno  
  
update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                 
   
  
  
                        
update #mtf_rms_holding set clsrate=b.cls                                                                                                                     
from General.dbo.cp_nsecm b                                                                                                           
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                  
                        
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                               
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                   
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                    
        
        
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                          
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                      
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM'   
  
/*MTF Scrip Master */  
insert into MTF_ScripMaster_hist  
select *,historydate=GETDATE() from MTF_ScripMaster  
  
truncate table MTF_ScripMaster  
  
  
Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())                                                                                                               
  
insert into MTF_ScripMaster  
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', ''   
  
         /*               
update x set Haircut=y.haircut from   
      #mtf_rms_holding x inner join   
      (select isin,haircut=max(haircut) from   
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate  
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */  
       group by isin)y on x.isin=y.isin   
       where accno='1203320009603460'  
       */  
  
  
update x set Haircut=y.haircut from   
      #mtf_rms_holding x inner join   
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin   
      where accno in ('1203320030135829')--,'unsettled')  
  
/*** Added for non mtf scrip haircut ***/   
  
update x set Haircut=100 from   
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock))   
  
/*****Completed****/  
  
update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                  
                      
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)        
  
/*Negative Holding Adjustment*/  
  
select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin  
  
select psrno=DENSE_RANK() over (order by party_code,isin),  
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),  
* into #mtf_rms_holding1   
from #mtf_rms_holding a with (nolock) where exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
  
 ; WITH Hold_CTE AS (  
SELECT   
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin  
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/  
UNION ALL  
SELECT   
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from  
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno  
 and x.SrNoisin=y.SrNoisin+1  
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/  
)  
SELECT * into #mtf_rms_holding2  
FROM Hold_CTE option  (maxrecursion 32767) ;  
  
  
delete from #mtf_rms_holding2 where Qty<=0  
--select * from #mtf_rms_holding2  
  
    
/*************************************/  
  
  
delete from mtf_holding_hist where ProcessDate=@mtfdate  
  
insert into mtf_holding_hist  
select *,histdate=GETDATE() from mtf_holding  
  
truncate table mtf_holding  
  
insert into mtf_holding  
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)  
  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding2   
union all  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding_rest  
  
  
drop table #negative_holding  
drop table #mtf_rms_holding1  
drop table #mtf_rms_holding2  
  
                                                                         
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                                
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                                
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                    
    
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join   
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b  
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)  
    
    
  select psrno =dense_rank() over(order by party_code ),  
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320030135829') then 0 else 1 end,sett_no desc,srno desc),  
  a.* into #holding  
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName   
    
  select   
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,  
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno  
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld  
  from #holding --where party_code='A88004'  
  order by psrno,sqoffsseg  
    
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b  
  on a.party_code=b.party_code  where a.sqoffsseg=1  
    
  
  --drop table #holdd  
    
;  WITH Hold_CTE AS (  
SELECT   
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,  
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,  
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x   
WHERE  sqoffsseg=1  
UNION ALL  
SELECT   
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,  
shortage= (ecte.shortage-ShortageReduction)  
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1   
and ecte.shortage>0  
)  
SELECT * into #holdd  
FROM Hold_CTE option  (maxrecursion 32767) ;  
  
  
update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0   
/*  
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else    
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0  
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0  
*/  
  
/*Addedd as suggested by vishal gohil on Aug 31 2017*/  
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)  
from #holdd a where clsrate>0 and haircut>0.00  
  
update a set Adjamt=Squareoffqty*clsrate from #holdd a  
  
update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,  
ShortageReduction=b.ShortageReduction,  
shortage=b.shortage  
  from mtf_holding a  inner join   
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and   
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type  
and a.exchange=b.exchange  
  
  
update a set squareoffvalue=b.adjamt from  mtf_data a inner join   
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b   
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)  
  
--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'  
  
--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end  
    
/*Ageing days calculation*/  
 /*select * from mtf_data with (nolock) where party_code='U10452'*/  
   
-- declare @mtfdate datetime   
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)  
  
  
 update a set NoofDays=b.NoofDays+a.NoofDays   
  from   
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a  
inner join   
 (select * from mtf_data where Processdate in   
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b  
 on a.party_code=b.party_code  
   
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000'   
  
 /*  
 select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,  
 a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from   
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a  
inner join   
 (select * from mtf_data where Processdate in   
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b  
 on a.party_code=b.party_code  
  */  
  /* Remove T Day codes from MTF Process */  
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))  
  and processdate=(select max(processdate) from MTF_DATA)   
    
  /* Remove T+1 Day codes from MTF Process */  
 delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH 
 
 (NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)  
    
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and  
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli where net_ledger>0.00 )  
  
  exec MTF_SqOffSeg  
  exec squareoff.dbo.MTF_BSE_VarShortage   
  exec squareoff.dbo.MTF_NSE_VarShortage   
  exec MTF_SquareOff_Exception_Process  
    
    
 create table #MobNo                         
 (                            
 mobno numeric(10,0)                            
 )                            
                             
 insert into #MobNo                            
 --select 9892953949                   
 --union all                            
-- select 9820202050 /*Bhavin Parekh*/                            
 --union all                            
 select 9820701602 /*VISHAL GOHIL*/                            
 union all                                                    
 select 9820731985 /*VISHAL KANANI*/       
 union all                            
 select 9892312837 /*TUSHAR J*/                            
 union all                            
 select 9860579556 /*SANDEEP NEGI*/      
 union all                            
 select 9819164199 /*NAVNEET SHAH*/      
    
 declare @str varchar(1000)                     
 set @str='MTF Process completed successfully.'    
   
                      
 insert into intranet.sms.dbo.sms                            
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                            
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                            
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                            
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                            
 then 'PM' else 'AM' end,'RMS UPDATION'                            
 from #MobNo a            
    
      
End try                                                                                   
    
BEGIN CATCH                                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                            
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                            
  DECLARE @ErrorMessage NVARCHAR(4000);                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
  RAISERROR (@ErrorMessage , 16, 1);                          
End catch                               
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup_24022018
-- --------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_bkup_24022018]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             


--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'

/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00


select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
into #bb
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 

--select * from #mtfshortage where  party_code='pprw028'

--select * from #bb where  party_code='J51492'

--select * from #aa where  party_code='J51492'

update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
from #mtfshortage a   join  #aa b on a.party_code=b.party_code

update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
delete from #mtfshortage where NET_MTF_REQ>0.00

 
delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  

  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 select 9892953949                 
 union all                          
 select 8108987990                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup_24072019
-- --------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_bkup_24072019]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

exec general.dbo.[Update_Projected_OnlyVaR]

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code


--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE  

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t on c.party_code= t.PARTY_CODE  

-------------------------------------------------------End here-------------------------------------------------------------------------------------

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','20057752','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  


                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=650)b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
	delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH
	(NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup_25092020
-- --------------------------------------------------


------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_bkup_25092020]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

exec general.dbo.[Update_Projected_OnlyVaR]
exec general.dbo.MTF_BO_DATA

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ =MARGIN_SHORTFALL ,SAUDA_DATE=CONVERT(VARCHAR(10), CONVERT(date, ORDERBYDATE, 105), 23)  
into #mtfshortage
from general.dbo.BO_MTFFinal
WHERE ORDERBYDATE =@mtfdate

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code


--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE  

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t on c.party_code= t.PARTY_CODE  

-------------------------------------------------------End here-------------------------------------------------------------------------------------

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

/*added as required by v gohil on Jan 28 2020*/
select * into #poa_mtf from Angeldemat.msajag.dbo.TBL_POA_COLL_DATA_MTF where cast(processdate as date)=@mtfdate

update #poa_mtf set MTF_VARATE =secvar from  squareoff.dbo.MTF_ScripMaster M where #poa_mtf.CERTNO=m.isin 
alter table #poa_mtf add  value_after_hc money

update #poa_mtf set value_after_hc=NET_VALUE*((100-MTF_VARATE)/100.00)    

select party_code,value_after_hc=sum(value_after_hc) into #final_data from  #poa_mtf group by party_code


truncate table tbl_mtf_poa_holding
insert into tbl_mtf_poa_holding
select * from #final_data

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(value_after_hc,0)  from #mtfshortage c join #final_data t on c.party_code= t.PARTY_CODE  

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*added as required by v gohil on Jan 28 2020*/


delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=@mtfdate,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


delete from MTF_data where Shortage<1000 and Processdate=@mtfdate


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320018512144','20131776','1203320000000028','1203320030135829','20057752','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  


                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())                                                                                                             

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','1203320018512144','1203320030135829','20131776','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320009603460','20131776','1203320030135829','1203320018512144') then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
	delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH
	(NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)
  
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli where net_ledger>0.00 )

  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                                                  
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup_26082020
-- --------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_bkup_26082020]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

exec general.dbo.[Update_Projected_OnlyVaR]
exec general.dbo.MTF_BO_DATA

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ =MARGIN_SHORTFALL ,SAUDA_DATE=CONVERT(VARCHAR(10), CONVERT(date, ORDERBYDATE, 105), 23)  
into #mtfshortage
from general.dbo.BO_MTFFinal
WHERE ORDERBYDATE =@mtfdate

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code


--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE  

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t on c.party_code= t.PARTY_CODE  

-------------------------------------------------------End here-------------------------------------------------------------------------------------

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

/*added as required by v gohil on Jan 28 2020*/
select * into #poa_mtf from Angeldemat.msajag.dbo.TBL_POA_COLL_DATA_MTF where cast(processdate as date)=@mtfdate

update #poa_mtf set MTF_VARATE =secvar from  squareoff.dbo.MTF_ScripMaster M where #poa_mtf.CERTNO=m.isin 
alter table #poa_mtf add  value_after_hc money

update #poa_mtf set value_after_hc=NET_VALUE*((100-MTF_VARATE)/100.00)    

select party_code,value_after_hc=sum(value_after_hc) into #final_data from  #poa_mtf group by party_code


truncate table tbl_mtf_poa_holding
insert into tbl_mtf_poa_holding
select * from #final_data

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(value_after_hc,0)  from #mtfshortage c join #final_data t on c.party_code= t.PARTY_CODE  

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*added as required by v gohil on Jan 28 2020*/


delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=@mtfdate,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


delete from MTF_data where Shortage<1000 and Processdate=@mtfdate


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320018512144','20131776','1203320000000028','20057752','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  


                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())                                                                                                             

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','1203320018512144','20131776','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320009603460','20131776','1203320018512144') then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
	delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH
	(NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)
  
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli where net_ledger>0.00 )

  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                                                  
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup_29012020
-- --------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_bkup_29012020]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

exec general.dbo.[Update_Projected_OnlyVaR]

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = sum(NETAMT-(MARGIN_REQ+MTOM_LOSS))+(MTFLEDBAL+MTFCASHCOLLATERAL
 +MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code


--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE  

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t on c.party_code= t.PARTY_CODE  

-------------------------------------------------------End here-------------------------------------------------------------------------------------

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


delete from MTF_data where Shortage<1000 and Processdate=@mtfdate


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320018512144','20131776','1203320018512898','1203320000000028','20057752','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  


                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())                                                                                                             

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','1203320018512144','20131776','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320009603460','20131776','1203320018512144') then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
	delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH
	(NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)
  
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli where net_ledger>0.00 )

  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                                                  
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup01062020
-- --------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_bkup01062020]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

exec general.dbo.[Update_Projected_OnlyVaR]
exec general.dbo.MTF_BO_DATA

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ =MARGIN_SHORTFALL ,SAUDA_DATE=CONVERT(VARCHAR(10), CONVERT(date, ORDERBYDATE, 105), 23)  
into #mtfshortage
from general.dbo.BO_MTFFinal
WHERE ORDERBYDATE =@mtfdate

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code


--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE  

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t on c.party_code= t.PARTY_CODE  

-------------------------------------------------------End here-------------------------------------------------------------------------------------

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

/*added as required by v gohil on Jan 28 2020*/
select * into #poa_mtf from Angeldemat.msajag.dbo.TBL_POA_COLL_DATA_MTF where cast(processdate as date)=@mtfdate

update #poa_mtf set MTF_VARATE =secvar from  squareoff.dbo.MTF_ScripMaster M where #poa_mtf.CERTNO=m.isin 
alter table #poa_mtf add  value_after_hc money

update #poa_mtf set value_after_hc=NET_VALUE*((100-MTF_VARATE)/100.00)    

select party_code,value_after_hc=sum(value_after_hc) into #final_data from  #poa_mtf group by party_code


truncate table tbl_mtf_poa_holding
insert into tbl_mtf_poa_holding
select * from #final_data

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(value_after_hc,0)  from #mtfshortage c join #final_data t on c.party_code= t.PARTY_CODE  

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*added as required by v gohil on Jan 28 2020*/


delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=@mtfdate,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


delete from MTF_data where Shortage<1000 and Processdate=@mtfdate


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320018512144','20131776','1203320018512898','1203320000000028','20057752','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  


                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())                                                                                                             

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','1203320018512144','20131776','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320009603460','20131776','1203320018512144') then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
	delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH
	(NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)
  
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli where net_ledger>0.00 )

  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                                                  
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup06072018
-- --------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_bkup06072018]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00

select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 select 9892953949                 
 union all                          
 select 8108987990                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup08122017
-- --------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_bkup08122017]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             


--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'

/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00


select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
into #bb
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 

--select * from #mtfshortage where  party_code='pprw028'

--select * from #bb where  party_code='J51492'

--select * from #aa where  party_code='J51492'

update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
from #mtfshortage a   join  #aa b on a.party_code=b.party_code

update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
delete from #mtfshortage where NET_MTF_REQ>0.00

 
delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  

  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.SquareUp_Client_Alert where updt=(select MAX(updt) from general.dbo.SquareUp_Client_Alert))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.SquareUp_Client where updt=(select MAX(updt) from general.dbo.SquareUp_Client))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 select 9892953949                 
 union all                          
 select 8108987990                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup14042020
-- --------------------------------------------------


------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE Procedure [dbo].[MTF_SqOffAmtCalculation_bkup14042020]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

exec general.dbo.[Update_Projected_OnlyVaR]

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = sum(NETAMT-(MARGIN_REQ+MTOM_LOSS))+(MTFLEDBAL+MTFCASHCOLLATERAL
 +MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code


--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE  

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t on c.party_code= t.PARTY_CODE  

-------------------------------------------------------End here-------------------------------------------------------------------------------------

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

/*added as required by v gohil on Jan 28 2020*/
select * into #poa_mtf from Angeldemat.msajag.dbo.TBL_POA_COLL_DATA_MTF where cast(processdate as date)=@mtfdate

update #poa_mtf set MTF_VARATE =secvar from  squareoff.dbo.MTF_ScripMaster M where #poa_mtf.CERTNO=m.isin 
alter table #poa_mtf add  value_after_hc money

update #poa_mtf set value_after_hc=NET_VALUE*((100-MTF_VARATE)/100.00)    

select party_code,value_after_hc=sum(value_after_hc) into #final_data from  #poa_mtf group by party_code


truncate table tbl_mtf_poa_holding
insert into tbl_mtf_poa_holding
select * from #final_data

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(value_after_hc,0)  from #mtfshortage c join #final_data t on c.party_code= t.PARTY_CODE  

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*added as required by v gohil on Jan 28 2020*/


delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


delete from MTF_data where Shortage<1000 and Processdate=@mtfdate


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320018512144','20131776','1203320018512898','1203320000000028','20057752','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  


                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())                                                                                                             

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','1203320018512144','20131776','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320009603460','20131776','1203320018512144') then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
	delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH
	(NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)
  
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli where net_ledger>0.00 )

  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                                                  
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkup26022018
-- --------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_bkup26022018]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             


--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'

/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  

  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 select 9892953949                 
 union all                          
 select 8108987990                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_bkuplive_15092017
-- --------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_bkuplive_15092017]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             


--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'

/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF

select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno


update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  

  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.SquareUp_Client_Alert where updt=(select MAX(updt) from general.dbo.SquareUp_Client_Alert))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.SquareUp_Client where updt=(select MAX(updt) from general.dbo.SquareUp_Client))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 select 9892953949                 
 union all                          
 select 8108987990                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_haircut
-- --------------------------------------------------
  
  
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
Create Procedure [dbo].[MTF_SqOffAmtCalculation_haircut]                                      
as                                                              
SET XACT_ABORT ON                                                                    
Set nocount on                                                              
BEGIN TRY               
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'  
/*client shortage fetching*/  
  
exec general.dbo.[Update_Projected_OnlyVaR]  
exec general.dbo.MTF_BO_DATA  
  
declare @mtfdate datetime   
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)  
  
SELECT PARTY_CODE,NET_MTF_REQ_Old=MARGIN_SHORTFALL , 
NET_MTF_REQ =MARGIN_SHORTFALL,SAUDA_DATE=CONVERT(VARCHAR(10), CONVERT(date, ORDERBYDATE, 105), 23),
net_ledger =cast(0.00 as money),recipent_val=cast(0.00 as money)
into #mtfshortage  
from general.dbo.BO_MTFFinal with (nolock) 
WHERE ORDERBYDATE =@mtfdate  
  
delete from #mtfshortage where NET_MTF_REQ>=0  

select distinct T.party_code, MTFLEDBAL,netledger=cast(0.00 as money),
Final_bal=cast(0.00 as money)
into  #ledger 
from [AngelNseCM].MTFTrade.dbo.TBL_MTF_DATA T with (nolock) 
inner join #mtfshortage P
on T.PARTY_CODE=P.party_code
where cast(T.SAUDA_DATE as date)=(select max(cast(SAUDA_DATE as date)) 
from [AngelNseCM].MTFTrade.dbo.TBL_MTF_DATA with (nolock))   
group by T.party_code, MTFLEDBAL
	
select party_code,MTFLEDBAL,netledger=balance-MTFLEDBAL 
into #net
from general.dbo.tbl_ledger_All_Risk T with (nolock)  inner join #ledger L with (nolock)
on T.cltcode=L.party_code

declare @dt varchar(10)
;with sqoffdatae as      
 (      
    select top 2 ROW_NUMBER() over(order by a.Start_Date)as srno,  cast( a.Start_Date as date)   Start_Date                                            
    from general.dbo.bse_sett_mst a                                                                            
    where CONVERT(VARCHAR(10),a.start_Date,121) > =CONVERT(VARCHAR(10),getdate()-2,121)                                                     
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                              
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                            
    group by Start_Date
)      
select @dt = cast(Start_Date as date)  from sqoffdatae where srno=2 ; 

select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode into #Recieved_entry  from  
[AngelNseCM].account.dbo.lEDGER with (nolock) 
where  cast(vdt as date)=cast(@dt as date) and  vtyp=2 and drcr='C'  

select cltcode,credit=sum(balamt) into #cr 
from #Recieved_entry group by cltcode 

select party_code,NET_MTF_REQ, c.credit into #segmentwisecr 
from #mtfshortage m inner join #cr c
on m.PARTY_CODE=c.cltcode

update m set net_ledger=N.netledger  from #mtfshortage m inner join #net N
on m.PARTY_CODE=N.party_code 

update m set recipent_val=N.credit  from #mtfshortage m inner join #segmentwisecr N
on m.PARTY_CODE=N.party_code 
  
update c set NET_MTF_REQ = isnull(NET_MTF_REQ ,0) + isnull(t.netledger,0)
from #mtfshortage c inner join #net t with (nolock) on c.party_code= t.party_code    
where t.netledger>0.00

update c set NET_MTF_REQ = isnull(c.NET_MTF_REQ ,0) + isnull(t.credit,0)
from #mtfshortage c inner join #segmentwisecr t with (nolock) on c.party_code= t.party_code 
inner join #net N on c.PARTY_CODE=N.party_code
where N.netledger<=0

update c set NET_MTF_REQ = isnull(NET_MTF_REQ,0)+isnull(Amount,0)  
from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t with (nolock) on c.party_code= t.PARTY_CODE    
  
truncate table tbl_MTF_FinalShortage
insert into tbl_MTF_FinalShortage
select * ,upd_date=getdate() from #mtfshortage

delete from #mtfshortage where NET_MTF_REQ>=0.00  
  
/*added as required by v gohil on Jan 28 2020*/  
select * into #poa_mtf from Angeldemat.msajag.dbo.TBL_POA_COLL_DATA_MTF with (nolock) where cast(processdate as date)=@mtfdate  
  
update #poa_mtf set MTF_VARATE =secvar from  squareoff.dbo.MTF_ScripMaster M with (nolock) 
where #poa_mtf.CERTNO=m.isin  

alter table #poa_mtf add  value_after_hc money  
  
update #poa_mtf set value_after_hc=NET_VALUE*((100-MTF_VARATE)/100.00)      
  
select party_code,value_after_hc=sum(value_after_hc) into #final_data from  #poa_mtf group by party_code  
  
  
truncate table tbl_mtf_poa_holding  
insert into tbl_mtf_poa_holding  
select * from #final_data  
  
update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(value_after_hc,0)  from #mtfshortage c join #final_data t on c.party_code= t.PARTY_CODE    
  
delete from #mtfshortage where NET_MTF_REQ>=0.00  
/*added as required by v gohil on Jan 28 2020*/  
  
  
delete from MTF_data where Processdate=@mtfdate  
/*(select MAX(sauda_date) from #mtfshortage)*/  
  
insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)  
SELECT Processdate=@mtfdate,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00  
FROM #mtfshortage MTF  
  
delete from MTF_data where Shortage<1000 and Processdate=@mtfdate  
   
select @mtfdate as ProcessDate,  
EXCHANGE,  
sett_no,SEtt_type,  
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,  
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,  
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,  
CONVERT(MONEY,0) AS HAIRCUT,  
CONVERT(MONEY,0) AS VAHC,  
SPACE(10) AS CATEGORY,  
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )  
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,  
accno  
into #mtf_rms_holding  
from general.dbo.rms_holding with (nolock) where source in ('SI','SO','H','D')  and  accno in ('1203320030135829')--,'unsettled')  
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno  
  
update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b with (nolock)
where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                 
                          
update #mtf_rms_holding set clsrate=b.cls                                                                                                                     
from General.dbo.cp_nsecm b with (nolock)                                                                                                           
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                  
                        
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                               
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                   
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                    
        
        
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                          
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                      
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM'   
  
/*MTF Scrip Master */  
insert into MTF_ScripMaster_hist  
select distinct srno,Entereddate,Isin,Scrip_CodeNSE,Scrip_CodeBSE,ScripName,FromDate,Todate,
SpecialRemarks,Secvar,Splvar,Folisted,Multiplier,FinalHaircut,historydate=GETDATE() from MTF_ScripMaster  
  
truncate table MTF_ScripMaster_BO  
 
Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='M' and BillDate <= GETDATE())                                                                                                               
  
insert into MTF_ScripMaster_BO  
EXEC [AngelNseCM].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', ''   

truncate table MTF_ScripMaster
insert into MTF_ScripMaster
select distinct Entereddate,Isin,Scrip_CodeNSE,Scrip_CodeBSE,ScripName,FromDate,Todate,
SpecialRemarks,Secvar,Splvar,Folisted,Multiplier,FinalHaircut
from MTF_ScripMaster_BO

 
update x set Haircut=y.haircut from   
      #mtf_rms_holding x inner join   
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin   
      where accno in ('1203320030135829')--,'unsettled')  
  
/*** Added for non mtf scrip haircut ***/   
  
update x set Haircut=100 from   
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock))   
  
/*****Completed****/  
  
update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                  
                      
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)        
  
/*Negative Holding Adjustment*/  
  
select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin  
  
select psrno=DENSE_RANK() over (order by party_code,isin),  
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),  
* into #mtf_rms_holding1   
from #mtf_rms_holding a with (nolock) where exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
  
 ; WITH Hold_CTE AS (  
SELECT   
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin  
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/  
UNION ALL  
SELECT   
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from  
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno  
 and x.SrNoisin=y.SrNoisin+1  
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/  
)  
SELECT * into #mtf_rms_holding2  
FROM Hold_CTE option  (maxrecursion 32767) ;  
  
  
delete from #mtf_rms_holding2 where Qty<=0  
--select * from #mtf_rms_holding2  
  
    
/*************************************/  
  
  
delete from mtf_holding_hist where ProcessDate=@mtfdate  
  
insert into mtf_holding_hist  
select *,histdate=GETDATE() from mtf_holding  
  
truncate table mtf_holding  
  
insert into mtf_holding  
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)  
  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding2   
union all  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding_rest  
  
  
drop table #negative_holding  
drop table #mtf_rms_holding1  
drop table #mtf_rms_holding2  

update mtf_holding_tt  set VAHC=VBHC where HAIRCUT=100.00 and clsrate>0 and VAHC =0.00
  
                                                                         
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b with (nolock) where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                                
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b with (nolock) where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                                
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                    
    
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join   
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING with (nolock) group by party_code)b  
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)  
    
    
  select psrno =dense_rank() over(order by party_code ),  
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320030135829') then 0 else 1 end,sett_no desc,srno desc),  
  a.* into #holding  
  from MTF_HOLDING a with (nolock) inner join General.dbo.ScripCategory_master b with (nolock) on a.category=b.CategoryName   
    
  select   
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,  
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno  
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld  
  from #holding --where party_code='A88004'  
  order by psrno,sqoffsseg  
    
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b  
  on a.party_code=b.party_code  where a.sqoffsseg=1  
    
  
  --drop table #holdd  
    
;  WITH Hold_CTE AS (  
SELECT   
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,  
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,  
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x   
WHERE  sqoffsseg=1  
UNION ALL  
SELECT   
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,  
shortage= (ecte.shortage-ShortageReduction)  
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1   
and ecte.shortage>0  
)  
SELECT * into #holdd  
FROM Hold_CTE option  (maxrecursion 32767) ;  
   
update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0    
  
/*Addedd as suggested by vishal gohil on Aug 31 2017*/  
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)  
from #holdd a where clsrate>0 and haircut>0.00  
  
update a set Adjamt=Squareoffqty*clsrate from #holdd a  
  
update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,  
ShortageReduction=b.ShortageReduction,  
shortage=b.shortage  
  from mtf_holding a  inner join   
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and   
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type  
and a.exchange=b.exchange  
  
  
update a set squareoffvalue=b.adjamt from  mtf_data a inner join   
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b   
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)  
 
 update a set NoofDays=b.NoofDays+a.NoofDays   
  from   
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a  
inner join   
 (select * from mtf_data where Processdate in   
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b  
 on a.party_code=b.party_code  
   
  /* Remove T Day codes from MTF Process */  
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data with (nolock)  where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))  
  and processdate=(select max(processdate) from MTF_DATA)   
    
  /* Remove T+1 Day codes from MTF Process */  
 delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data with (nolock) where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data with (nolock)) 
 UNION 
 select DISTINCT party_code from [general].dbo.legalblkclients WITH (NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)  
    
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and  
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli with (nolock) where net_ledger>0.00 )  
  
  exec MTF_SqOffSeg  
  exec squareoff.dbo.MTF_BSE_VarShortage   
  exec squareoff.dbo.MTF_NSE_VarShortage   
  exec MTF_SquareOff_Exception_Process  

End try                                                                                   
    
BEGIN CATCH                                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                            
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                            
  DECLARE @ErrorMessage NVARCHAR(4000);                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
  RAISERROR (@ErrorMessage , 16, 1);                          
End catch                               
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_livebkup_14042020
-- --------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_livebkup_14042020]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

exec general.dbo.[Update_Projected_OnlyVaR]

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = sum(NETAMT-(MARGIN_REQ+MTOM_LOSS))+(MTFLEDBAL+MTFCASHCOLLATERAL
 +MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code


--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE  

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t on c.party_code= t.PARTY_CODE  

-------------------------------------------------------End here-------------------------------------------------------------------------------------

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

/*added as required by v gohil on Jan 28 2020*/
select * into #poa_mtf from Angeldemat.msajag.dbo.TBL_POA_COLL_DATA_MTF where cast(processdate as date)=@mtfdate

update #poa_mtf set MTF_VARATE =secvar from  squareoff.dbo.MTF_ScripMaster M where #poa_mtf.CERTNO=m.isin 
alter table #poa_mtf add  value_after_hc money

update #poa_mtf set value_after_hc=NET_VALUE*((100-MTF_VARATE)/100.00)    

select party_code,value_after_hc=sum(value_after_hc) into #final_data from  #poa_mtf group by party_code


truncate table tbl_mtf_poa_holding
insert into tbl_mtf_poa_holding
select * from #final_data

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(value_after_hc,0)  from #mtfshortage c join #final_data t on c.party_code= t.PARTY_CODE  

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*added as required by v gohil on Jan 28 2020*/


delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


delete from MTF_data where Shortage<1000 and Processdate=@mtfdate


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320018512144','20131776','1203320018512898','1203320000000028','20057752','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  


                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())                                                                                                             

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','1203320018512144','20131776','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320009603460','20131776','1203320018512144') then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
	delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH
	(NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)
  
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli where net_ledger>0.00 )

  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                                                  
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_MERGER_23022018
-- --------------------------------------------------
CREATE Procedure [dbo].[MTF_SqOffAmtCalculation_MERGER_23022018]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             


--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'

/*client shortage fetching*/

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = SUM(NETAMT+MTOM_LOSS-MARGIN_REQ)+(MTFLEDBAL+MTFCASHCOLLATERAL
+MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00


select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger+MCX_Ledger+NCDEX_Ledger /*comm merger*/ 
into #bb
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 or MCX_Ledger>0.00 or NCDEX_Ledger>0.00 )-- and B.party_code='s140708' 

--select * from #mtfshortage where  party_code='pprw028'

--select * from #bb where  party_code='J51492'

--select * from #aa where  party_code='J51492'

update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
from #mtfshortage a   join  #aa b on a.party_code=b.party_code

update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
delete from #mtfshortage where NET_MTF_REQ>0.00

 
delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320000000028','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  
                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @BSElastBillDate, @BSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','unsettled')

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno='1203320009603460' then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  

  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by  case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data))
  and processdate=(select max(processdate) from MTF_DATA)
  
  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 select 9892953949                 
 union all                          
 select 8108987990                          
 union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                          
 select 9819090240 /*Anand Golatkar*/                          
 union all                          
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_new_28012020
-- --------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
create Procedure [dbo].[MTF_SqOffAmtCalculation_new_28012020]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY             
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
/*client shortage fetching*/

exec general.dbo.[Update_Projected_OnlyVaR]

declare @mtfdate datetime 
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)

SELECT PARTY_CODE,
NET_MTF_REQ = sum(NETAMT-(MARGIN_REQ+MTOM_LOSS))+(MTFLEDBAL+MTFCASHCOLLATERAL
 +MTFNONCASHCOLLATERAL+MTFCASHEQCOLLATERAL)
+ CASHDEBITADJ + CASHNONCASHADJ + FONONCASHADJ + CASHLEDADJ + FOLEDBALADJ + POAADJ ,
SAUDA_DATE
into #mtfshortage
from
anand1.mtftrade.dbo.TBL_MTF_DATA M, anand1.MSAJAG.DBO.CLIENT1 C1
WHERE SAUDA_DATE =@mtfdate
/*in (select MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock))*/
AND C1.CL_CODE = PARTY_CODE
group by PARTY_CODE,MTFLEDBAL,MTFCASHCOLLATERAL,
MTFNONCASHCOLLATERAL,MTFCASHEQCOLLATERAL,
CASHDEBITADJ,CASHNONCASHADJ , FONONCASHADJ , CASHLEDADJ , FOLEDBALADJ , POAADJ,SAUDA_DATE

delete from #mtfshortage where NET_MTF_REQ>=0

select A.party_code,shortage=NET_MTF_REQ,NET_ledger=(BSE_Ledger+NSE_Ledger)
into #aa
from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code   where (BSE_Ledger+NSE_Ledger)>0.00

select party_code,net_mtf_req,Net_Bal=convert(decimal(10,2),0.00),Reciept_Entry=convert(decimal(10,2),0.00)
,Higher_Amount=convert(decimal(10,2),0.00) into #Other_SegAdj from #mtfshortage

--select  A.party_code,OtherSeg_Credit=NSEFO_Ledger+MCD_Ledger+NSX_Ledger 
--into #bb
--from general.dbo.tbl_rms_collection_cli A with (nolock)  inner join #mtfshortage B on A.party_code=B.party_code 
--where  (NSEFO_Ledger>0 or MCD_Ledger>0.00 or NSX_Ledger>0.00 )-- and B.party_code='s140708' 


--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(NET_ledger,0.00)
--from #mtfshortage a   join  #aa b on a.party_code=b.party_code

--update a  set  A.NET_MTF_REQ =  isnull(A.NET_MTF_REQ,0.00)+isnull(OtherSeg_Credit,0.00)
--from #mtfshortage a   join  #bb b on a.party_code=b.party_code
 
--delete from #mtfshortage where NET_MTF_REQ>0.00

/*Received Entries from BSE.NSE and NSEFO added on 24022018*/
/*Start*/
if (DATEPART(dw,GETDATE())=2)
begin

	select * into #Recieved_entry1
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-2) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-2) as date) and  vtyp=2 and drcr='C'
	)A

	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal1') IS NOT NULL    
	DROP TABLE #Other_bal1  
	select cltcode,balamt=sum(balamt) into #Other_bal1 from #Recieved_entry1 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal1 a
	where #Other_SegAdj.party_code=a.cltcode

end
else
begin
	select * into #Recieved_entry2
	from
	(
	select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode  from
	[anand1].account.dbo.lEDGER with (nolock) where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='BSECM',vtyp,drcr,vamt,vdt,balamt,cltcode from  [anand].account_ab.dbo.lEDGER with (nolock)--2000-08-01 00:00:00.000
	where  cast(vdt as date)>=cast((getdate()-1) as date) and   vtyp=2 and drcr='C'
	union all
	select segment='NSEFO',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountfo.dbo.lEDGER with (nolock)--1900-01-01 00:00:00.000]
	where cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='NSX',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelfo].accountcurfo.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	union all
	select segment='MCD',vtyp,drcr,vamt,vdt,balamt,cltcode from [angelcommodity].accountmcdxcds.dbo.lEDGER with (nolock)--2008-08-28 18:32:15.577
    where  cast(vdt as date)>=cast((getdate()-1) as date) and  vtyp=2 and drcr='C'
	)A
	
	IF OBJECT_ID('TEMPDB.DBO.#Other_bal2') IS NOT NULL    
	DROP TABLE #Other_bal2  
	select cltcode,balamt=sum(balamt) into #Other_bal2 from #Recieved_entry2 group by cltcode
	
	Update #Other_SegAdj set Net_Bal=convert(decimal(10,2),Net_ledger) from #aa a
	where #Other_SegAdj.party_code=a.party_code

	Update #Other_SegAdj set Reciept_Entry=convert(decimal(10,2),balamt) from #Other_bal2 a
	where #Other_SegAdj.party_code=a.cltcode
end

update #Other_SegAdj set Higher_amount= (case when Net_Bal>=Reciept_Entry then Net_Bal else Reciept_Entry end )

select * into #NotAdj_Clients from #Other_SegAdj where Higher_Amount=0.00
/*
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where  net>0.00 group by client-- and B.party_code='s140708' 
*/

/*Added on 06 July 2018 as required by Vishal Gohil */
select  A.client,OtherSeg_Credit=sum(net)
into #Direct_Adj
from general.dbo.Vw_CollectionDetails_CLIENT  A with (nolock)  inner join #NotAdj_Clients B on A.client=B.party_code 
where co_code in ('BSECM','NSECM','NSEFO','MCX','NCDEX') group by client-- and B.party_code='s140708' 

delete from #Direct_Adj where OtherSeg_Credit<=0.00

update #Other_SegAdj set Higher_Amount=D.OtherSeg_Credit from #Direct_Adj D
where #Other_SegAdj.party_code=D.client

update #mtfshortage set NET_MTF_REQ=#mtfshortage.NET_MTF_REQ+Higher_amount from #Other_SegAdj O
where #mtfshortage.party_code=O.party_code


--------------------------------------------------------Corporate VAlues added on 26 Dec 2018-------------------------------------------------------
--update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(corporate_value,0)  from #mtfshortage c join general.dbo.Corporate_Value t on c.party_code= t.PARTY_CODE  

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(Amount,0)  from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t on c.party_code= t.PARTY_CODE  

/*added as required by v gohil on Jan 28 2020*/
select * into #poa_mtf from Angeldemat.msajag.dbo.TBL_POA_COLL_DATA_MTF

update #poa_mtf set MTF_VARATE =secvar from  squareoff.dbo.MTF_ScripMaster M where #aa.CERTNO=m.isin 
alter table #aa add  value_after_hc money

update #poa_mtf set value_after_hc=NET_VALUE*((100-MTF_VARATE)/100.00)    

select party_code,value_after_hc=sum(value_after_hc) into #final_data from  #poa_mtf group by party_code

update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(value_after_hc,0)  from #mtfshortage c join #final_data t on c.party_code= t.PARTY_CODE  

-------------------------------------------------------End here-------------------------------------------------------------------------------------

delete from #mtfshortage where NET_MTF_REQ>=0.00
/*End*/

delete from MTF_data where Processdate=@mtfdate
/*(select MAX(sauda_date) from #mtfshortage)*/

insert into MTF_data(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)
SELECT Processdate=SAUDA_DATE,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00
FROM #mtfshortage MTF


delete from MTF_data where Shortage<1000 and Processdate=@mtfdate


select @mtfdate as ProcessDate,
EXCHANGE,
sett_no,SEtt_type,
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,
CONVERT(MONEY,0) AS HAIRCUT,
CONVERT(MONEY,0) AS VAHC,
SPACE(10) AS CATEGORY,
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,
accno
into #mtf_rms_holding
from general.dbo.rms_holding where source in ('SI','SO','H','D')  and  accno in ('1203320009603460','1203320018512144','20131776','1203320018512898','1203320000000028','20057752','unsettled','')
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno

update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                  


                      
update #mtf_rms_holding set clsrate=b.cls                                                                                                                   
from General.dbo.cp_nsecm b                                                                                                         
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                
                      
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                             
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                 
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                  
      
      
                      
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                    
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM' 

/*MTF Scrip Master */
insert into MTF_ScripMaster_hist
select *,historydate=GETDATE() from MTF_ScripMaster

truncate table MTF_ScripMaster


Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())                                                                                                             

insert into MTF_ScripMaster
EXEC [anand1].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', '' 

         /*             
update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=max(haircut) from 
      [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock) where sauda_date =@mtfdate
      /*in (select MAX(sauda_date) from [anand1].mtftrade.dbo.TBL_MTF_DATA with (nolock)) */
       group by isin)y on x.isin=y.isin 
       where accno='1203320009603460'
       */


update x set Haircut=y.haircut from 
      #mtf_rms_holding x inner join 
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin 
      where accno in ('1203320009603460','1203320018512144','20131776','unsettled')

/*** Added for non mtf scrip haircut ***/ 

update x set Haircut=100 from 
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock)) 

/*****Completed****/

update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)      

/*Negative Holding Adjustment*/

select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin

select psrno=DENSE_RANK() over (order by party_code,isin),
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),
* into #mtf_rms_holding1 
from #mtf_rms_holding a with (nolock) where exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 

select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists 
(select * from #negative_holding b 
where a.party_Code=b.party_Code and a.isin=b.isin 
) and qty>0 


 ; WITH Hold_CTE AS (
SELECT 
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/
UNION ALL
SELECT 
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno
 and x.SrNoisin=y.SrNoisin+1
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/
)
SELECT * into #mtf_rms_holding2
FROM Hold_CTE option  (maxrecursion 32767) ;


delete from #mtf_rms_holding2 where Qty<=0
--select * from #mtf_rms_holding2

  
/*************************************/


delete from mtf_holding_hist where ProcessDate=@mtfdate

insert into mtf_holding_hist
select *,histdate=GETDATE() from mtf_holding

truncate table mtf_holding

insert into mtf_holding
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)

select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding2 
union all
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                        
from #mtf_rms_holding_rest


drop table #negative_holding
drop table #mtf_rms_holding1
drop table #mtf_rms_holding2

                                                                       
  update MTF_HOLDING set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update MTF_HOLDING  set isin=b.isin from General.dbo.scrip_master b where MTF_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update MTF_HOLDING  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from mtf_data a inner join 
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from MTF_HOLDING group by party_code)b
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from mtf_data)
  
  
  select psrno =dense_rank() over(order by party_code ),
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320009603460','20131776','1203320018512144') then 0 else 1 end,sett_no desc,srno desc),
  a.* into #holding
  from MTF_HOLDING a inner join General.dbo.ScripCategory_master b on a.category=b.CategoryName 
  
  select 
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld
  from #holding --where party_code='A88004'
  order by psrno,sqoffsseg
  
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data with (nolock) where processdate=@mtfdate) b
  on a.party_code=b.party_code  where a.sqoffsseg=1
  

  --drop table #holdd
  
;  WITH Hold_CTE AS (
SELECT 
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x 
WHERE  sqoffsseg=1
UNION ALL
SELECT 
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,
shortage= (ecte.shortage-ShortageReduction)
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1 
and ecte.shortage>0
)
SELECT * into #holdd
FROM Hold_CTE option  (maxrecursion 32767) ;


update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0 
/*
update a set Squareoffqty=(case when convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE))<=0 then 1 else  
convert(int,floor((((ShortageReduction*(100/HAIRCUT))/CLSRATE)*CLSRATE)/CLSRATE)) end) from #holdd a where clsrate>0
--update a set Squareoffqty=Ceiling(((case when shortage=0 then shortagereduction else vahc end)+ShortageReduction)/clsrate) from #holdd a where clsrate>0
*/

/*Addedd as suggested by vishal gohil on Aug 31 2017*/
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)
from #holdd a where clsrate>0 and haircut>0.00

update a set Adjamt=Squareoffqty*clsrate from #holdd a

update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,
ShortageReduction=b.ShortageReduction,
shortage=b.shortage
  from mtf_holding a  inner join 
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and 
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type
and a.exchange=b.exchange


update a set squareoffvalue=b.adjamt from  mtf_data a inner join 
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b 
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)

--select SquareoffValue=sum(SquareoffValue),shortage=SUM(shortage) from mtf_data with (nolock) where processdate='2017-08-10 00:00:00.000'

--select * from mtf_holding where party_code='U10452' order by case when SqOffseq=0 then 9999999 else SqOffseq end
  
/*Ageing days calculation*/
 /*select * from mtf_data with (nolock) where party_code='U10452'*/
 
-- declare @mtfdate datetime 
--select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)


	update a set NoofDays=b.NoofDays+a.NoofDays 
	 from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b
 on a.party_code=b.party_code
 
 --select * from mtf_data where Processdate='2017-08-10 00:00:00.000' 

	/*
	select a.Processdate,a.Entity,a.party_code,NoofDays=b.NoofDays+a.NoofDays,
	a.Shortage,a.HoldingBHC,a.HoldingAhC,a.SquareoffValue from 
 (select * from mtf_data with (nolock) where Processdate=@mtfdate)a
inner join 
 (select * from mtf_data where Processdate in 
 (select Processdate=MAX(Processdate) from mtf_data with (nolock) where Processdate<>@mtfdate))b
 on a.party_code=b.party_code
  */
  /* Remove T Day codes from MTF Process */
  delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))
  and processdate=(select max(processdate) from MTF_DATA) 
  
  /* Remove T+1 Day codes from MTF Process */
	delete from MTF_DATA where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data) UNION select DISTINCT party_code from [general].dbo.legalblkclients WITH
	(NOLOCK)) and processdate=(select max(processdate) from MTF_DATA)
  
   delete from MTF_DATA where processdate=(select max(processdate) from MTF_DATA) and
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli where net_ledger>0.00 )

  exec MTF_SqOffSeg
  exec squareoff.dbo.MTF_BSE_VarShortage 
  exec squareoff.dbo.MTF_NSE_VarShortage 
  exec MTF_SquareOff_Exception_Process
  
  
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 --select 9892953949                 
 --union all                          
-- select 9820202050 /*Bhavin Parekh*/                          
 --union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                                                  
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
  
 declare @str varchar(1000)                   
 set @str='MTF Process completed successfully.'  
 
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a          
  
    
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffAmtCalculation_new_cradj
-- --------------------------------------------------

------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
CREATE Procedure [dbo].[MTF_SqOffAmtCalculation_new_cradj]                                      
as                                                              
SET XACT_ABORT ON                                                                    
Set nocount on                                                              
BEGIN TRY               
--select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'  
/*client shortage fetching*/  
  
--exec general.dbo.[Update_Projected_OnlyVaR]  
--exec general.dbo.MTF_BO_DATA  
  
declare @mtfdate datetime   
select @mtfdate=MAX(SAUDA_DATE) from anand1.mtftrade.dbo.TBL_MTF_DATA with (nolock)  
  
SELECT PARTY_CODE,NET_MTF_REQ_Old=MARGIN_SHORTFALL , 
NET_MTF_REQ =MARGIN_SHORTFALL,SAUDA_DATE=CONVERT(VARCHAR(10), CONVERT(date, ORDERBYDATE, 105), 23),
net_ledger =cast(0.00 as money),recipent_val=cast(0.00 as money)
into #mtfshortage  
from general.dbo.BO_MTFFinal with (nolock) 
WHERE ORDERBYDATE =@mtfdate  
  
delete from #mtfshortage where NET_MTF_REQ>=0  

select distinct T.party_code, MTFLEDBAL,netledger=cast(0.00 as money),
Final_bal=cast(0.00 as money)
into  #ledger 
from [AngelNseCM].MTFTrade.dbo.TBL_MTF_DATA T with (nolock) 
inner join #mtfshortage P
on T.PARTY_CODE=P.party_code
where cast(T.SAUDA_DATE as date)=(select max(cast(SAUDA_DATE as date)) 
from [AngelNseCM].MTFTrade.dbo.TBL_MTF_DATA with (nolock))   
group by T.party_code, MTFLEDBAL
	
select party_code,MTFLEDBAL,netledger=balance-MTFLEDBAL 
into #net
from general.dbo.tbl_ledger_All_Risk T with (nolock)  inner join #ledger L with (nolock)
on T.cltcode=L.party_code

declare @dt varchar(10)
;with sqoffdatae as      
 (      
    select top 2 ROW_NUMBER() over(order by a.Start_Date)as srno,  cast( a.Start_Date as date)   Start_Date                                            
    from general.dbo.bse_sett_mst a                                                                            
    where CONVERT(VARCHAR(10),a.start_Date,121) > =CONVERT(VARCHAR(10),getdate()-2,121)                                                     
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                              
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                            
    group by Start_Date
)      
select @dt = cast(Start_Date as date)  from sqoffdatae where srno=2 ; 

select segment='NSECM',vtyp,drcr,vamt,vdt,balamt,cltcode into #Recieved_entry  from  
[AngelNseCM].account.dbo.lEDGER with (nolock) 
where  cast(vdt as date)=cast(@dt as date) and  vtyp=2 and drcr='C'  

select cltcode,credit=sum(balamt) into #cr 
from #Recieved_entry group by cltcode 

select party_code,NET_MTF_REQ, c.credit into #segmentwisecr 
from #mtfshortage m inner join #cr c
on m.PARTY_CODE=c.cltcode

update m set net_ledger=N.netledger  from #mtfshortage m inner join #net N
on m.PARTY_CODE=N.party_code 

update m set recipent_val=N.credit  from #mtfshortage m inner join #segmentwisecr N
on m.PARTY_CODE=N.party_code 
  
update c set NET_MTF_REQ = isnull(NET_MTF_REQ ,0) + isnull(t.netledger,0)
from #mtfshortage c inner join #net t with (nolock) on c.party_code= t.party_code    
where t.netledger>0.00

update c set NET_MTF_REQ = isnull(c.NET_MTF_REQ ,0) + isnull(t.credit,0)
from #mtfshortage c inner join #segmentwisecr t with (nolock) on c.party_code= t.party_code 
inner join #net N on c.PARTY_CODE=N.party_code
where N.netledger<=0

update c set NET_MTF_REQ = isnull(NET_MTF_REQ,0)+isnull(Amount,0)  
from #mtfshortage c join general.dbo.tbl_CorporateAction_Data t with (nolock) on c.party_code= t.PARTY_CODE    
  
truncate table tbl_MTF_FinalShortage
insert into tbl_MTF_FinalShortage
select * ,upd_date=getdate() from #mtfshortage  
-------------------------------------------------------End here-------------------------------------------------------------------------------------  
  
delete from #mtfshortage where NET_MTF_REQ>=0.00  
/*End*/  
 
/*added as required by v gohil on Jan 28 2020*/  
select * into #poa_mtf from Angeldemat.msajag.dbo.TBL_POA_COLL_DATA_MTF with (nolock) where cast(processdate as date)=@mtfdate  
  
update #poa_mtf set MTF_VARATE =secvar from  squareoff.dbo.MTF_ScripMaster M with (nolock) 
where #poa_mtf.CERTNO=m.isin  

alter table #poa_mtf add  value_after_hc money  
  
update #poa_mtf set value_after_hc=NET_VALUE*((100-MTF_VARATE)/100.00)      
  
select party_code,value_after_hc=sum(value_after_hc) into #final_data from  #poa_mtf group by party_code  
  
  
truncate table tbl_mtf_poa_holding  
insert into tbl_mtf_poa_holding  
select * from #final_data  
  
update c set NET_MTF_REQ=isnull(NET_MTF_REQ,0)+isnull(value_after_hc,0) 
from #mtfshortage c join #final_data t on c.party_code= t.PARTY_CODE    
  
delete from #mtfshortage where NET_MTF_REQ>=0.00  
/*added as required by v gohil on Jan 28 2020*/  
  
  
delete from MTF_data_new where Processdate=@mtfdate  
/*(select MAX(sauda_date) from #mtfshortage)*/  
  
insert into MTF_data_new(Processdate,Entity,party_code,NoofDays,Shortage,Actual_Cash_Square_Off_Done)  
SELECT Processdate=@mtfdate,Entity='Equity',party_code,NoofDays=1,Shortage=NET_MTF_REQ*-1,0.00  
FROM #mtfshortage MTF  
    
delete from MTF_data_new where Shortage<1000 and Processdate=@mtfdate  
   
select @mtfdate as ProcessDate,  
EXCHANGE,  
sett_no,SEtt_type,  
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,  
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,  
Party_code,Qty=SUM(qty),CLSRATE,sum(Total) AS VBHC,  
CONVERT(MONEY,0) AS HAIRCUT,  
CONVERT(MONEY,0) AS VAHC,  
SPACE(10) AS CATEGORY,  
source AS SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd )  
AS [SrNo],SqOffseq=0,ISIN,ActualSqOffQty=CONVERT(int,0),AvgRate=0.00 ,  
accno  
into #mtf_rms_holding  
from general.dbo.rms_holding with (nolock) where source in ('SI','SO','H','D')  and  accno in ('1203320030135829')--,'unsettled')  
group by EXCHANGE,sett_no,SEtt_type,DUMMY1,DUMMY2,series,SCRIP_CD,Party_code,CLSRATE,source,ISIN,accno  
  
update #mtf_rms_holding set clsrate=b.rate from General.dbo.cp_bsecm b with (nolock)
where #mtf_rms_holding.scrip_Cd=b.scode and #mtf_rms_holding.clsrate=0                                                                                                                 
                          
update #mtf_rms_holding set clsrate=b.cls                                                                                                                     
from General.dbo.cp_nsecm b with (nolock)                                                                                                           
where #mtf_rms_holding.scrip_Cd=b.scrip and #mtf_rms_holding.series=b.series and #mtf_rms_holding.clsrate=0 and exchange='NSECM'                                                  
                        
update #mtf_rms_holding set VBHC=clsrate*Qty                                                                                               
                        
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                        
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                                   
where #mtf_rms_holding.SCRIP_cD=B.BSECODE AND #mtf_rms_holding.EXCHANGE='BSECM'                                                                                                                    
                                
update #mtf_rms_holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                          
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                      
where #mtf_rms_holding.SCRIP_cD=B.NSESYMBOL AND #mtf_rms_holding.SERIES=B.NSESERIES AND #mtf_rms_holding.EXCHANGE='NSECM'   
  
/*MTF Scrip Master  
insert into MTF_ScripMaster_hist  
select distinct srno,Entereddate,Isin,Scrip_CodeNSE,Scrip_CodeBSE,ScripName,FromDate,Todate,
SpecialRemarks,Secvar,Splvar,Folisted,Multiplier,FinalHaircut,historydate=GETDATE() from MTF_ScripMaster  
  
truncate table MTF_ScripMaster_BO  
 
Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='M' and BillDate <= GETDATE())                                                                                                               
  
insert into MTF_ScripMaster_BO  
EXEC [AngelNseCM].mtftrade.dbo.RPT_SCRIPMFUND 'broker', 'broker', @NSElastBillDate, @NSElastBillDate, '', 'zzzzzzzzz', '', '', ''   

truncate table MTF_ScripMaster
insert into MTF_ScripMaster
select distinct Entereddate,Isin,Scrip_CodeNSE,Scrip_CodeBSE,ScripName,FromDate,Todate,
SpecialRemarks,Secvar,Splvar,Folisted,Multiplier,FinalHaircut
from MTF_ScripMaster_BO
*/ 
update x set Haircut=y.haircut from   
      #mtf_rms_holding x inner join   
      (select isin,haircut=finalhaircut from MTF_ScripMaster with (nolock))y on x.isin=y.isin   
      where accno in ('1203320030135829')--,'unsettled')  
  
/*** Added for non mtf scrip haircut ***/   
  
update x set Haircut=100 from   
      #mtf_rms_holding x WHERE ISIN NOT IN (select isin  from MTF_ScripMaster with (nolock))   
  
/*****Completed****/  
  
update #mtf_rms_holding set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                  
                      
update #mtf_rms_holding set VAHC=VBHC*((100-HAIRCUT)/100.00)        
  
/*Negative Holding Adjustment*/  
  
select party_Code,isin,qty=SUM(qty) into #negative_holding from #mtf_rms_holding with (nolock) where qty<0 group by party_Code,isin  
  
select psrno=DENSE_RANK() over (order by party_code,isin),  
SrNoisin=ROW_NUMBER() over (partition by party_code,isin order by qty desc),  
* into #mtf_rms_holding1   
from #mtf_rms_holding a with (nolock) where exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
select * into #mtf_rms_holding_rest from #mtf_rms_holding a with (nolock) where not exists   
(select * from #negative_holding b   
where a.party_Code=b.party_Code and a.isin=b.isin   
) and qty>0   
  
  
 ; WITH Hold_CTE AS (  
SELECT   
psrno,SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.qty)<=0 then 0 else (x.qty+y.qty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.qty)<0 then (x.qty+y.qty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  #negative_holding y on x.party_Code=y.party_Code and x.isin=y.isin  
WHERE  SrNoisin=1 /*and x.party_code='S162618 ' and x.isin='INE947A01014'*/  
UNION ALL  
SELECT   
x.psrno,x.SrNoisin,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,x.Party_code,  
Qty=case when (x.qty+y.negqty)<=0 then 0 else (x.qty+y.negqty) end,  
CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,x.ISIN,ActualSqOffQty,AvgRate,accno,  
negqty=case when (x.qty+y.negqty)<0 then (x.qty+y.negqty) else 0 end  
 FROM #mtf_rms_holding1 x inner join  (select party_Code ,isin,psrno,negqty,SrNoisin from  
 Hold_CTE) y on x.party_Code=y.party_Code and x.isin=y.isin and x.psrno=y.psrno  
 and x.SrNoisin=y.SrNoisin+1  
 /*WHERE  x.party_code='S162618' and x.isin='INE947A01014'*/  
)  
SELECT * into #mtf_rms_holding2  
FROM Hold_CTE option  (maxrecursion 32767) ;  
  
  
delete from #mtf_rms_holding2 where Qty<=0  
--select * from #mtf_rms_holding2  
  
    
/*************************************/  
   
--delete from mtf_holding_hist where ProcessDate=@mtfdate  
  
--insert into mtf_holding_hist  
--select *,histdate=GETDATE() from mtf_holding  
  
truncate table mtf_holding_test  
  
insert into mtf_holding_test  
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno)  
  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding2   
union all  
select ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,SrNo,SqOffseq,ISIN,ActualSqOffQty,AvgRate,accno                                                                          
from #mtf_rms_holding_rest  
  
  
drop table #negative_holding  
drop table #mtf_rms_holding1  
drop table #mtf_rms_holding2  
  
                                                                         
  update mtf_holding_test set isin=b.isin from General.dbo.scrip_master b with (nolock) where mtf_holding_test.isin is null and scrip_cd=b.NseSymbol                                
  update mtf_holding_test  set isin=b.isin from General.dbo.scrip_master b with (nolock) where mtf_holding_test.isin is null and scrip_cd=b.bsecode                                
  update mtf_holding_test  set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                    
    
  update   a set holdingbhc=b.vbhc,holdingahc=b.vahc  from MTF_data_new a inner join   
  (select party_code,vbhc=SUM(vbhc),vahc=SUM(vahc) from mtf_holding_test with (nolock) group by party_code)b  
  on a.party_code=b.party_code where processdate in (select processdate=MAX(processdate) from MTF_data_new)  
    
    
  select psrno =dense_rank() over(order by party_code ),  
  sqoffsseg=ROW_NUMBER() over(partition by party_code order by case when accno in ('1203320030135829') then 0 else 1 end,sett_no desc,srno desc),  
  a.* 
  into #holding  
  from mtf_holding_test a with (nolock) inner join General.dbo.ScripCategory_master b with (nolock) on a.category=b.CategoryName   
    
  select   
  psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,  
  HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno  
  ,ShortageReduction=(VBHC*Haircut/100),shortage=CONVERT(money,0) into #hld  
  from #holding --where party_code='A88004'  
  order by psrno,sqoffsseg  
    
  update a set shortage=b.shortage  from #hld a inner join (select * from MTF_data_new with (nolock) where processdate=@mtfdate) b  
  on a.party_code=b.party_code  where a.sqoffsseg=1  
    
  
  --drop table #holdd  
    
; WITH Hold_CTE AS (  
SELECT   
psrno,sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,  
ShortageReduction=case when (shortage-ShortageReduction)<0 then shortage else ShortageReduction end,  
shortage=case when (shortage-ShortageReduction)<0 then 0 else(shortage-ShortageReduction) end FROM #hld x   
WHERE  sqoffsseg=1  
UNION ALL  
SELECT   
psrno,e.sqoffsseg,ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,e.Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,  
SquareOffQty,id,SqOffseq,AdjAmt,ISIN,FromAcc,ToAcc,ToSegment,ActualSqOffQty,AvgRate,accno,ShortageReduction,  
shortage= (ecte.shortage-ShortageReduction)  
FROM #hld e INNER JOIN (select party_code,sqoffsseg,shortage from  Hold_CTE) ecte ON ecte.party_code = e.party_code and e.sqoffsseg=ecte.sqoffsseg+1   
and ecte.shortage>0  
)  
SELECT * into #holdd  
FROM Hold_CTE option  (maxrecursion 32767) ;  
  
update #holdd set ShortageReduction=ShortageReduction+shortage,shortage=0 where shortage<0    
  
/*Addedd as suggested by vishal gohil on Aug 31 2017*/  
update a set Squareoffqty=ceiling(Case when ((ShortageReduction/Haircut)*100.00)/CLSRATE <= qty then ((ShortageReduction/Haircut)*100.00)/CLSRATE else qty end)  
from #holdd a where clsrate>0 and haircut>0.00  
  
update a set Adjamt=Squareoffqty*clsrate from #holdd a  
  
update a set squareoffqty=b.SquareOffQty ,sqoffseq=b.sqoffsseg , Adjamt=b.AdjAmt,  
ShortageReduction=b.ShortageReduction,  
shortage=b.shortage  
  from mtf_holding_test a  inner join   
(select * from #holdd ) b on a.Party_code=b.Party_code and a.ProcessDate=b.ProcessDate and   
a.sett_no=b.sett_no and a.accno=b.accno and a.ISIN=b.ISIN and a.SEtt_type=b.SEtt_type  
and a.exchange=b.exchange  
  
  
update a set squareoffvalue=b.adjamt from  MTF_data_new a inner join   
(select Processdate,Party_code,adjamt=SUM(adjamt) from #holdd group by Processdate,Party_code)b   
on a.party_code=b.Party_code and Convert(varchar(11),a.Processdate,121)=Convert(varchar(11),b.Processdate,121)  
 
 update a set NoofDays=b.NoofDays+a.NoofDays   
  from   
 (select * from MTF_data_new with (nolock) where Processdate=@mtfdate)a  
inner join   
 (select * from MTF_data_new where Processdate in   
 (select Processdate=MAX(Processdate) from MTF_data_new with (nolock) where Processdate<>@mtfdate) and Shortage>=1000)b  
 on a.party_code=b.party_code  
   

  delete from MTF_data_new where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t1day_data with (nolock)  where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t1day_data))  
  and processdate=(select max(processdate) from MTF_data_new)   
    
  /* Remove T+1 Day codes from MTF Process */  
 delete from MTF_data_new where party_code in (select distinct party_code from general.dbo.tbl_projrisk_t2day_data with (nolock) where updt=(select MAX(updt) from general.dbo.tbl_projrisk_t2day_data with (nolock)) 
 UNION 
 select DISTINCT party_code from [general].dbo.legalblkclients WITH (NOLOCK)) and processdate=(select max(processdate) from MTF_data_new)  
    
   delete from MTF_data_new where processdate=(select max(processdate) from MTF_data_new) and  
   party_code in (select distinct party_code from general.dbo.tbl_rms_collection_cli with (nolock) where net_ledger>0.00 )  
  
  --exec MTF_SqOffSeg  
  --exec squareoff.dbo.MTF_BSE_VarShortage   
  --exec squareoff.dbo.MTF_NSE_VarShortage   
  --exec MTF_SquareOff_Exception_Process  
  
End try                                                                                   
    
BEGIN CATCH                                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                            
  select GETDATE(),'MTF_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                            
  DECLARE @ErrorMessage NVARCHAR(4000);                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
  RAISERROR (@ErrorMessage , 16, 1);                          
End catch                               
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SqOffSeg
-- --------------------------------------------------
CREATE procedure [dbo].[MTF_SqOffSeg]        
as        
set nocount on        
        
 update mtf_holding set toSegment=''        
         
 update mtf_holding set toSegment='BSECM' from        
 (select party_code,bsecm,nsecm from General.dbo.client_Details where bsecm='Y') b         
 where mtf_holding.party_code=b.party_code and squareoffQty > 0 and Exchange='BSECM'        
        
 update mtf_holding set toSegment='NSECM' from        
 (select party_code,bsecm,nsecm from General.dbo.client_Details where nsecm='Y') b         
 where mtf_holding.party_code=b.party_code and squareoffQty > 0 and Exchange='NSECM'        
 and isnull(toSegment,'')=''        
        
 update mtf_holding set toSegment='BSECM' from        
 (select party_code,bsecm,nsecm from General.dbo.client_Details where Bsecm='Y') b         
 where mtf_holding.party_code=b.party_code and squareoffQty > 0 and Exchange='NSECM'        
 and isnull(toSegment,'')=''        
   
 /*Added on Dec 05 2016 as suggested by Vishal Gohil to handle client active and inactive cases*/  
   
 update mtf_holding set toSegment='NSECM' from   
 (select party_code,bsecm,nsecm from General.dbo.client_Details where nsecm='Y' and Bsecm='N') b           
 where mtf_holding.party_code=b.party_code and squareoffQty > 0 and Exchange='BSECM'          
 and isnull(toSegment,'')=''    
        
 update mtf_holding set toSegment='N.A.' from        
 (select party_code,bsecm,nsecm from General.dbo.client_Details where Bsecm='N' and Nsecm='N') b         
 where mtf_holding.party_code=b.party_code and squareoffQty > 0         
 and isnull(toSegment,'')=''        
      
update mtf_holding set scrip_cd=b.bsecode from  general.dbo.scrip_master  b  
where mtf_holding.scrip_Cd=b.nsesymbol and mtf_holding.series=b.nseseries  
and EXCHANGE='NSECM' and ToSegment='BSECM'  
       
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_SquareOff_Exception_Process
-- --------------------------------------------------
  
 --exec [MTF_SquareOff_Exception_Process]  
   
-- select * from mis.dbo.MTF_sqoff_client_exp  
  
  
CREATE procedure [dbo].[MTF_SquareOff_Exception_Process]                                              
as                           
begin                                                                 
begin try                                            
              
  declare @alertdate datetime                                              
  select  @alertdate = (select max(processdate) from mtf_data)                                     
  --select @alertdate =  dateadd(d, -((datepart(weekday, getdate()) + 1 + @@datefirst) % 7), getdate())                                               
              
IF OBJECT_ID(N'mis.dbo.MTF_sqoff_client_exp') IS NOT NULL                                                                  
 drop table MTF_sqoff_client_exp                                        
  /*                     
  insert into mis.dbo.vmss_margin_shortage_sqoff_client_exp             
  (region,branch,sb,party_code,category,cli_type,sb_category,varmarginshortfall_aftadj,squareoffvalue,noofdays,update_date,mobile_pager,email,balance,holding_bhc,holding_ahc)                                              
  */    
  select   b.region, b.branch, b.sb,c.party_code, b.category,b.cli_type ,                                               
  b.sb_category ,c.Shortage,c.squareoffvalue,                                            
  c.noofdays,update_date=getdate(),                                            
  (rtrim(ltrim(cli.mobile_pager))) as mobile_pager,(rtrim(ltrim(cli.email)))  as email,                                
  balance='', holdingbhc,holdingahc         
   into dbo.MTF_sqoff_client_exp                                             
  from mtf_data c with (nolock)                                                  
  inner join general.dbo.vw_rms_client_vertical b with (nolock) on b.client = c.party_code                                               
  inner join general.dbo.client_details cli with (nolock) on b.client = cli.party_code                                                    
  where convert(varchar(10),c.processDate,120) = convert(varchar(10),@alertdate,120)  and                                        
  --abs(c.t_value) > 500                                              
  c.noofdays> = 5 --+ @t_day                                               
  and isnull(c.squareoffvalue,0.0) <> 0        

  delete from MTF_sqoff_client_exp where squareoffvalue = 0                                                          
  alter table MTF_sqoff_client_exp add exception varchar(10),remarks varchar(50), amount numeric,source_type varchar(10),IPADDRESS varchar(20),ENTERED_BY varchar(50)                                       
              
  /*                                                   
  update a                                              
  set source_type = 's3',a.amount = b.amount,                                              
  exemption ='y',remarks ='cheque in hand'                                              
  from  vmss_margin_shortage_sqoff_client_exp a inner join                                               
  tbl_voucherentry_mis_t  b                                              
  on a.client_code  = b.[client code]                                              
  */                                      
              
              
  update MTF_sqoff_client_exp                                              
  set source_type = 's1',amount=0,                                              
  exception ='N'                                              
  where source_type is null                                              
              
  update MTF_sqoff_client_exp                                               
  set exception ='Y',remarks ='without mobile and email'                    
  where mobile_pager =''                             
  --and email =''                               
  /*                
  declare @vmssdata int,@clientdetail int,@vw_rms_client_vertical int,@ExceptionTableCount int                        
              
  select  @vw_rms_client_vertical=COUNT(1) from [csokyc-6].general.dbo.vw_rms_client_vertical                        
  select @clientdetail=COUNT(1) from [csokyc-6].general.dbo.client_details cli                        
  select @vmssdata=COUNT(1) from VMSS_data where convert(varchar(10),updatedon,120) = convert(varchar(10),GETDATE(),120) and noofdays> = 7 --+ @t_day                                              
  and squareoffvalue <> 0                         
  select @ExceptionTableCount=COUNT(1) from vmss_margin_shortage_sqoff_client_exp                        
              
  insert into ExceptionCount(vmssdata,clientdetail,vw_rms_client_vertical,ExceptionTableCount,UpdateDate) values(@vmssdata,@clientdetail,@vw_rms_client_vertical,@ExceptionTableCount,GETDATE())                         
  */           
               
 end try                                               
 begin catch                                                                                                    
  insert into general.DBO.EODBODDetail_Error(errtime,errobject,errline,errmessage)                                                                                                          
  select getdate(),'MTF_SquareOff_Exception_Process',error_line(),error_message()                                                               
  declare @errormessage nvarchar(4000);                                                                  
  select @errormessage = error_message() + convert(varchar(10),error_line());                                                                  
  raiserror (@errormessage , 16, 1);                                                   
 end catch                           
end                                                                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_Upd_DP_Holding
-- --------------------------------------------------
  
CREATE PROCEDURE [dbo].[MTF_Upd_DP_Holding]        
AS        
        
SET XACT_ABORT ON                    
Set nocount on                    
BEGIN TRY         
      
      
  CREATE TABLE #db        
  (        
  hld_hold_date DATETIME,        
  hld_ac_Code VARCHAR(16),        
  hld_isin_code VARCHAR(14),        
  hld_ac_pos INT        
  )        
  CREATE CLUSTERED INDEX IDXDP ON #db (hld_isin_code)        
      
  INSERT INTO #db        
  SELECT hld_hold_date,hld_ac_Code,hld_isin_code,hld_ac_pos        
  FROM ANGELDP4.Inhouse.dbo.holding WITH (NOLOCK)        
  WHERE hld_ac_type = '11'        
  AND hld_ac_pos > 0        
       
      
  select         
  X.party_code,        
  X.dpid,        
  X.cltdpid        
  into #temp from        
  (select A.party_code,A.bankid as dpid,A.cltdpid from         
  angeldemat.bsedb.dbo.client4 A with (nolock) INNER JOIN        
  ANGELDEMAT.BSEDB.DBO.MULTICLTID B WITH (NOLOCK)             
  ON  A.party_code = B.party_code         
  AND  A.bankid = B.DPID         
  AND  A.cltdpid = B.CLTDPNO        
  where A.defdp = 1 and left(A.party_code,2) <> '98' and A.bankid = '12033200'              
  group by A.party_code,A.bankid ,A.cltdpid         
      
  Union         
      
  select A.party_code,A.bankid as dpid,A.cltdpid         
  from angeldemat.msajag.dbo.client4 A with (nolock) INNER JOIN        
  ANGELDEMAT.MSAJAG.DBO.MULTICLTID B WITH (NOLOCK)        
  ON  A.party_code = B.party_code         
  AND  A.bankid = B.DPID         
  AND  A.cltdpid = B.CLTDPNO        
  where A.defdp = 1 and left(A.party_code,2) <> '98' and A.bankid = '12033200'              
  group by A.party_code,A.bankid ,A.cltdpid ) X    
  
  
      
      
      
  SELECT X.party_code AS Client,X.CLTDPID INTO  #NBFC_CLTDPID        
  FROM #temp x WITH (NOLOCK) JOIN        
  (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF')) y        
  ON x.party_code=y.party_code --AND cm_brboffcode='MGR'        
      
  
  
  
      
  TRUNCATE TABLE MTF_DP_Holding        
      
  INSERT INTO MTF_DP_Holding(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Category,id)        
  SELECT HoldDate=hld_hold_date,party_code,Cltdpid=hld_ac_code,isin=hld_isin_code,bsecode,        
  nsesymbol,nseseries,holding=hld_ac_pos,[Status],ROW_NUMBER() OVER ( ORDER BY party_code desc,isin desc) AS [id]    
  FROM #db a        
  INNER JOIN        
  (SELECT ID,isin,BseCode,NseSymbol,NseSeries,[Status]         
  FROM        
  (        
  SELECT ID=ROW_NUMBER() OVER(PARTITION BY ISIN ORDER BY ISIN,BseCode,NseSymbol),isin,BseCode,NseSymbol,NseSeries,status        
  FROM  General.dbo.scrip_master WITH(NOLOCK)        
  ) T        
  WHERE ID = 1        
  ) B        
  ON a.hld_isin_code = b.isin        
  INNER JOIN General.dbo.bo_dppoa c WITH(NOLOCK)         
  ON a.hld_ac_code = c.cltdpid        
  
    
  DELETE a FROM MTF_DP_Holding a        
  INNER JOIN #NBFC_CLTDPID b         
  ON a.Party_code = b.Client         
  AND a.Cltdpid = b.Cltdpid        
   
       
   DELETE X       
   from MTF_DP_Holding X       
   left outer join      
   (      
   SELECT Client_Code FROM MIS.KYC.DBO.tbl_POA_details WITH(nolock)      
   WHERE Created_By IS NOT NULL      
   GRoup by Client_Code      
   ) Y on  x.party_code=Y.client_Code where Y.client_code is null      

    
   delete from MTF_DP_Holding where isnull(Category,'Poor')='Poor'    
    
   update MTF_DP_Holding set Clsrate=b.cls     
   from General.dbo.CP_NSECM b where MTF_DP_Holding.nsesymbol=b.scrip and MTF_DP_Holding.nseseries=b.series    
    
   update MTF_DP_Holding set Clsrate=b.rate    
   from General.dbo.CP_BSECM b where MTF_DP_Holding.bsecode=b.scode and isnull(clsrate,0)=0    
       
  update MTF_DP_Holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                 
  General.dbo.Scrip_ValidOnlyVar b                                 
  where MTF_DP_Holding.isin=B.isin     
      
    update MTF_DP_Holding set VBHC=isnull(Clsrate,0)*holding  
    update MTF_DP_Holding set VAHC=VBHC*((100-HAIRCUT)/100.00),SqOffQty=0,SqOffSeq=0    
    
End try                                         
BEGIN CATCH                                            
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                  
  select GETDATE(),'MTF_Upd_DP_Holding',ERROR_LINE(),ERROR_MESSAGE()                                                  
End catch                     
    
                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_Upd_DP_Holding_bkup_27012022
-- --------------------------------------------------
  
create PROCEDURE [dbo].[MTF_Upd_DP_Holding_bkup_27012022]        
AS        
        
SET XACT_ABORT ON                    
Set nocount on                    
BEGIN TRY         
      
      
  CREATE TABLE #db        
  (        
  hld_hold_date DATETIME,        
  hld_ac_Code VARCHAR(16),        
  hld_isin_code VARCHAR(14),        
  hld_ac_pos INT        
  )        
  CREATE CLUSTERED INDEX IDXDP ON #db (hld_isin_code)        
      
  INSERT INTO #db        
  SELECT hld_hold_date,hld_ac_Code,hld_isin_code,hld_ac_pos        
  FROM [172.31.16.94].Inhouse.dbo.holding WITH (NOLOCK)        
  WHERE hld_ac_type = '11'        
  AND hld_ac_pos > 0        
       
      
  select         
  X.party_code,        
  X.dpid,        
  X.cltdpid        
  into #temp from        
  (select A.party_code,A.bankid as dpid,A.cltdpid from         
  angeldemat.bsedb.dbo.client4 A with (nolock) INNER JOIN        
  ANGELDEMAT.BSEDB.DBO.MULTICLTID B WITH (NOLOCK)             
  ON  A.party_code = B.party_code         
  AND  A.bankid = B.DPID         
  AND  A.cltdpid = B.CLTDPNO        
  where A.defdp = 1 and left(A.party_code,2) <> '98' and A.bankid = '12033200'              
  group by A.party_code,A.bankid ,A.cltdpid         
      
  Union         
      
  select A.party_code,A.bankid as dpid,A.cltdpid         
  from angeldemat.msajag.dbo.client4 A with (nolock) INNER JOIN        
  ANGELDEMAT.MSAJAG.DBO.MULTICLTID B WITH (NOLOCK)        
  ON  A.party_code = B.party_code         
  AND  A.bankid = B.DPID         
  AND  A.cltdpid = B.CLTDPNO        
  where A.defdp = 1 and left(A.party_code,2) <> '98' and A.bankid = '12033200'              
  group by A.party_code,A.bankid ,A.cltdpid ) X    
  
  
      
      
      
  SELECT X.party_code AS Client,X.CLTDPID INTO  #NBFC_CLTDPID        
  FROM #temp x WITH (NOLOCK) JOIN        
  (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF')) y        
  ON x.party_code=y.party_code --AND cm_brboffcode='MGR'        
      
  
  
  
      
  TRUNCATE TABLE MTF_DP_Holding        
      
  INSERT INTO MTF_DP_Holding(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Category,id)        
  SELECT HoldDate=hld_hold_date,party_code,Cltdpid=hld_ac_code,isin=hld_isin_code,bsecode,        
  nsesymbol,nseseries,holding=hld_ac_pos,[Status],ROW_NUMBER() OVER ( ORDER BY party_code desc,isin desc) AS [id]    
  FROM #db a        
  INNER JOIN        
  (SELECT ID,isin,BseCode,NseSymbol,NseSeries,[Status]         
  FROM        
  (        
  SELECT ID=ROW_NUMBER() OVER(PARTITION BY ISIN ORDER BY ISIN,BseCode,NseSymbol),isin,BseCode,NseSymbol,NseSeries,status        
  FROM  General.dbo.scrip_master WITH(NOLOCK)        
  ) T        
  WHERE ID = 1        
  ) B        
  ON a.hld_isin_code = b.isin        
  INNER JOIN General.dbo.bo_dppoa c WITH(NOLOCK)         
  ON a.hld_ac_code = c.cltdpid        
  
    
  DELETE a FROM MTF_DP_Holding a        
  INNER JOIN #NBFC_CLTDPID b         
  ON a.Party_code = b.Client         
  AND a.Cltdpid = b.Cltdpid        
   
       
   DELETE X       
   from MTF_DP_Holding X       
   left outer join      
   (      
   SELECT Client_Code FROM [196.1.115.167].KYC.DBO.tbl_POA_details WITH(nolock)      
   WHERE Created_By IS NOT NULL      
   GRoup by Client_Code      
   ) Y on  x.party_code=Y.client_Code where Y.client_code is null      

    
   delete from MTF_DP_Holding where isnull(Category,'Poor')='Poor'    
    
   update MTF_DP_Holding set Clsrate=b.cls     
   from General.dbo.CP_NSECM b where MTF_DP_Holding.nsesymbol=b.scrip and MTF_DP_Holding.nseseries=b.series    
    
   update MTF_DP_Holding set Clsrate=b.rate    
   from General.dbo.CP_BSECM b where MTF_DP_Holding.bsecode=b.scode and isnull(clsrate,0)=0    
       
  update MTF_DP_Holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                 
  General.dbo.Scrip_ValidOnlyVar b                                 
  where MTF_DP_Holding.isin=B.isin     
      
    update MTF_DP_Holding set VBHC=isnull(Clsrate,0)*holding  
    update MTF_DP_Holding set VAHC=VBHC*((100-HAIRCUT)/100.00),SqOffQty=0,SqOffSeq=0    
    
End try                                         
BEGIN CATCH                                            
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                  
  select GETDATE(),'MTF_Upd_DP_Holding',ERROR_LINE(),ERROR_MESSAGE()                                                  
End catch                     
    
                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.MTF_UPDstatus
-- --------------------------------------------------
CREATE procedure [dbo].[MTF_UPDstatus](@flag as int)    
as    
set nocount on    
update MTF_processStatus  set UpdStatus = @flag,UpdDate=GETDATE()    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pure_Risk_DP_Adj_file_mail
-- --------------------------------------------------

     
CREATE Procedure [dbo].[Pure_Risk_DP_Adj_file_mail]                                      
as                                      
                                              
SET XACT_ABORT ON                                              
Set nocount on                                              
 BEGIN TRY                                                                      
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                                    
         
  --alter table VMSS_PURERISK_DPHOLDING add FromAcc varchar(20),ToAcc varchar(20),ToSegment varchar(20)       
           
  /*update VMSS_PURERISK_DPHOLDING set Tosegment=b.segment from Pure_RiskClients_ActiveSeg_Details b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code */  
 /* Added on Aug 23 2016 as discussed with vishal and Renil SIr to check client is having account in  BSE and NSE*/ 
 --delete from VMSS_PURERISK_DPHOLDING where isin='INE075A01022'
   
  select distinct A.party_code,Exchange,Segment into #temp  from  VMSS_PURERISK_DPHOLDING A inner join  AngelNseCM.msajag.dbo.client_brok_details  B with (nolock) on A.party_code=B.cl_code  
  where  ( exchange in ('BSE','NSE') and segment in('CAPITAL'))  
  
 select * into #temp2  
 from   
 (  
   select party_code,Exchange,Segment  
   from #temp  
 ) src  
 pivot  
 (  
   max(Exchange)  
   for Exchange in ([BSE],[NSE])  
 ) piv;  
  
  
 update VMSS_PURERISK_DPHOLDING set Tosegment=case when b.BSE='BSE' and b.NSE='NSE' then 'NSECM'   
                                                    when b.BSE='BSE' and b.NSE is null  then 'BSECM'  
                                                    when b.NSE='NSE'  and b.BSE is null then 'NSECM'  else '' end  
 from #temp2 b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code  
  
                                       
  --and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                                      
                  
  /************************************************************************/                                      
  update VMSS_PURERISK_DPHOLDING set toacc= case                                       
  /*        
  when tosegment= 'NSECM' then '1203320000000051'                                      
  when tosegment= 'BSECM' then '1203320000000066'               
  */        
  when tosegment= 'NSECM' then '1203320018512938'                                      
  when tosegment= 'BSECM' then '1203320009603460'               
  ELSE '' END                                      
  --where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                                      
                  
  update VMSS_PURERISK_DPHOLDING set fromacc=Cltdpid   from general.dbo.dp_holding A  where  VMSS_PURERISK_DPHOLDING.party_code=A.party_code                            
                            
                  
  /*****************************/                                      
  --history updation                                      
 --select  top 1 * from VMSS_PURERISK_DPHOLDING      
 --select  top 1 *  from vmss_DP_holding      
 --select * from VMSS_PURERISK_DPHOLDING where cast(process_date as date)=cast('May 10 2016' as date)  and total_adj=348025.70      
            --select * into VMSS_PURERISK_DPHOLDING_hist from VMSS_PURERISK_DPHOLDING where 1=2      
            /*      
  delete from VMSS_PURERISK_DPHOLDING_hist where HoldDate =(select Max(processDate) from VMSS_data)                              
                  
  insert into VMSS_PURERISK_DPHOLDING_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                                
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                                 
  from VMSS_PURERISK_DPHOLDING where SqOffQty > 0    
      */     
                
  truncate table PURE_RISK_JV_DP_file                                
  select party_code,scrip_cd,series='BSE',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                             
  when len(fromacc)<16 then 'IN301549' else ''  end,                                            
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             
  when len(toacc)<16 then 'IN301549' else ''  end,                                            
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                            
  from VMSS_PURERISK_DPHOLDING where                                              
 -- sqoffseq > 0 and HoldDate =(select Max(processDate) from VMSS_data)                                            
   TOSEGMENT='BSECM'                                            
                  
  INSERT INTO #JVDATA                                            
  select party_code,scrip_cd,series='',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)              
  when len(fromacc)<16 then 'IN301549' else ''  end,                                            
  fromacc,                                        
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             
  when len(toacc)<16 then 'IN301549' else ''  end,                                            
  toacc,type1='BTM',TOSEGMENT from VMSS_PURERISK_DPHOLDING where                                            
 -- sqoffseq > 0   and HoldDate =(select Max(processDate) from VMSS_data)                                            
   TOSEGMENT='NSECM'    
     
     
   /*To delete corp action clients added on July 20 2017*/     
  --select *  from #JVDATA where isin in (  
  --select distinct isin from VMSS_PURERISK_DPHOLDING A inner join  [196.1.115.239].CommonMaster.dbo.Corp_action B with (nolock) on A.isin=b.Sca_ISIN  
  --where cast(Sca_Ex_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '') -- and cast(Sca_BCFrom_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '')  
  --)    
  
  
  select distinct Sca_ISIN,Sca_Ex_Dt into #TEMP_ISIN from [196.1.115.239].CommonMaster.dbo.Corp_action A with (nolock)  where  Sca_CatCode<>'D'  
  and cast(Sca_Ex_Dt as date)<=cast(getdate()+2 as date) and cast(Sca_Ex_Dt as date)>=cast(getdate()-2 as date) order by Sca_Ex_Dt desc  
   
  delete from #JVDATA where isin in (  
  select distinct isin from VMSS_PURERISK_DPHOLDING A inner join #TEMP_ISIN B with (nolock) on A.isin=b.Sca_ISIN  
  )                                          
       
        
  truncate table PURE_RISK_JV_DP_file                                
                  
  insert into PURE_RISK_JV_DP_file                                           
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                          
  from #JVDATA                                          
                  
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                         
                  
  DECLARE @file1 AS VARCHAR(100)                                              
  DECLARE @file2 AS VARCHAR(100)                         
  DECLARE @i AS INT                                            
  DECLARE @str VARCHAR(8000)                                             
  declare @segment varchar(10)                                        
                
  DECLARE @fileCnt as int                    
  DECLARE @RowCnt int,@FileName as varchar(500)                  
                    
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                  
                    
  DECLARE @SQL VARCHAR(MAX)                                                
  SET @SQL = '' 
                    
 CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))                  
  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))                  
                
   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/                  
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   
                    
  SET @RowCnt = (SELECT COUNT(*)as a FROM #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')                   
  SET @FileName=''                  
                    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  
                    
  PRINT @FileName                  
            
  TRUNCATE TABLE FileData            
                      
  INSERT INTO FileData                
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               
                    
  INSERT INTO FileData                                            
  SELECT  '<Tp>5</Tp>'+            
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>14</Rsn>'+                              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf><Conamt>0</Conamt>'                               
  FROM   #JVDATAFILE a (nolock)                                    
  WHERE tosegment = 'BSECM'                 
                
    /*                  
  INSERT INTO FileData_rohit_23092015                                          
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse                   
  */                  
                                                 
  SET @SQL = ''                                                
              
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                           
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '   */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '                                                    
  SET @SQL = '''' + @SQL + ''''                                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                
  PRINT @SQL                                                
  EXEC (@SQL)                    
                        
  /*Used For Unix formated Data*/                  
  /*exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName*/ 
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                   
                    
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                   
                    
  /*SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName */ 
  SET @filename1='H:\MindGate\UploadJVCollateral\'+ @FileName                  
                     
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/                      
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/                  
                      
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   
                    
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')                   
  SET @FileName=''                  
                    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  
                    
  PRINT @FileName                  
                    
  TRUNCATE TABLE FileData              
                      
  INSERT INTO FileData              
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               
                      
  INSERT INTO FileData                                          
  SELECT  '<Tp>5</Tp>'+            
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>14</Rsn>'+                              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf><Conamt>0</Conamt>'                              
  FROM   #JVDATAFILE a (nolock)                                    
  WHERE tosegment = 'NSECM'                   
                       
                    
  /*                  
  INSERT INTO FileData_rohit_23092015                                          
  select DATA from #VMSS_JVCEColl_tblfile_nse                   
  */                                                  
                    
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                           
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc ' */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '                                                   
  SET @SQL = '''' + @SQL + ''''                                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                
  PRINT @SQL                                                
  EXEC (@SQL)                      
                        
  /*Used For Unix formated Data*/                  
  /*exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName  */
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                    
             
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                    
                     
  /*SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName*/                  
  SET @filename2='H:\MindGate\UploadJVCollateral\'+ @FileName                    
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/                    
      
  SET @SQL =''                 
  SET @SQL = 'Dear Team,<br/><br/>'                                                
  SET @SQL = @SQL + 'Please find the attached file for (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') with criteria for shares fetching as given below:    
  

 <br/><br/>1. Shares fetching is done only when client is in continous projected + pure  risk for 5 days.  
 <br/><br/>2. Codes considered for shares fetching to the extent of pure + projected risk value . Sequence will be Blue-chip , good , Average and Poor if client in Pure risk and Blue-chip, Good , Average if client in projected risk.   
 <br/><br/>3. If there is only projected risk then the cap of fetching of shares will be done above Rs.500 and if there is pure risk then there will be cap of Rs.100 for fetching of shares which will be done to the extent of pure +projected risk value.  


 <br/><br/>4. Shares fetching will not be done in this process if there is no Pure and projected risk.   
 <br/><br/>5. Regions/Branches and SBs can see the reports on daily basis in NRMS - >Risk Manager - > Var Margin Report -> DP POA Shares Movement- with every details given below:   
 <br/><br/>6. SMS logs report will also be available to all users on daily basis.'  
       
                                                 
  SET @SQL = @SQL + '<br/><br/><br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                                
                    
  DECLARE @s varchar(500)                                                          
  SET @s = @filename1 + ';' + @filename2                                               
                    
  EXEC msdb.dbo.sp_send_dbmail            
  @profile_name = 'Square',                                    
  @recipients= 'anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;datta.gurav@angelbroking.com;vijay.agre@angelbroking.com;vilasnaram@angelbroking.com;',                                                
  @copy_recipients= 'vishal@angelbroking.com;csorm@angelbroking.com;',                  
   --@blind_copy_recipients= @BCC,                                                
  @body= @SQL,                                                
  @file_attachments= @s,                                                
  @body_format= 'HTML',                                                  
  @subject='Shares fetching to the extent of pure + projected risk value'  
  
  exec general.dbo.USP_ALL_SQOFF_JOB_SUMMARY                                         
                                       
End try                                                                     
BEGIN CATCH                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                               
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                              
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                 
                                                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pure_Risk_DP_Adj_file_mail_01Feb2019
-- --------------------------------------------------
    
CREATE Procedure [dbo].[Pure_Risk_DP_Adj_file_mail_01Feb2019]                                      
as                                      
                                              
SET XACT_ABORT ON                                              
Set nocount on                                              
 BEGIN TRY                                                                      
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                                    
         
  --alter table VMSS_PURERISK_DPHOLDING add FromAcc varchar(20),ToAcc varchar(20),ToSegment varchar(20)       
           
  /*update VMSS_PURERISK_DPHOLDING set Tosegment=b.segment from Pure_RiskClients_ActiveSeg_Details b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code */  
 /* Added on Aug 23 2016 as discussed with vishal and Renil SIr to check client is having account in  BSE and NSE*/   
  select distinct A.party_code,Exchange,Segment 
  into #temp 
   from  general.dbo.tmp_VMSS_PURERISK_DPHOLDING A inner join  anand1.msajag.dbo.client_brok_details  B on A.party_code=B.cl_code  
  where  ( exchange in ('BSE','NSE') and segment in('CAPITAL'))  
  
 select * into #temp2  
 from   
 (  
   select party_code,Exchange,Segment  
   from #temp  
 ) src  
 pivot  
 (  
   max(Exchange)  
   for Exchange in ([BSE],[NSE])  
 ) piv;  
  
 

 update general.dbo.tmp_VMSS_PURERISK_DPHOLDING set Tosegment=case when b.BSE='BSE' and b.NSE='NSE' then 'NSECM'   
                                                    when b.BSE='BSE' and b.NSE is null  then 'BSECM'  
                                                    when b.NSE='NSE'  and b.BSE is null then 'NSECM'  else '' end  
 from #temp2 b where general.dbo.tmp_VMSS_PURERISK_DPHOLDING.party_code=b.party_code  
  
                                       
  --and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                                      
                  
  /************************************************************************/                                      
  update general.dbo.tmp_VMSS_PURERISK_DPHOLDING set toacc= case                                       
  /*        
  when tosegment= 'NSECM' then '1203320000000051'                                      
  when tosegment= 'BSECM' then '1203320000000066'               
  */        
  when tosegment= 'NSECM' then '1203320000000028'                                      
  when tosegment= 'BSECM' then '1203320009603460'               
  ELSE '' END                                      
  --where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                                      
                  
  update general.dbo.tmp_VMSS_PURERISK_DPHOLDING set fromacc=Cltdpid   from general.dbo.dp_holding A  where  general.dbo.tmp_VMSS_PURERISK_DPHOLDING.party_code=A.party_code                            
                            
                  
  /*****************************/                                      
  --history updation                                      
 --select  top 1 * from VMSS_PURERISK_DPHOLDING      
 --select  top 1 *  from vmss_DP_holding      
 --select * from VMSS_PURERISK_DPHOLDING where cast(process_date as date)=cast('May 10 2016' as date)  and total_adj=348025.70      
            --select * into VMSS_PURERISK_DPHOLDING_hist from VMSS_PURERISK_DPHOLDING where 1=2      
            /*      
  delete from VMSS_PURERISK_DPHOLDING_hist where HoldDate =(select Max(processDate) from VMSS_data)                              
                  
  insert into VMSS_PURERISK_DPHOLDING_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                                
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                                 
  from VMSS_PURERISK_DPHOLDING where SqOffQty > 0    
      */     
	
 --select top 0 * 
 --into tmp_PURE_RISK_JV_DP_file
 --from PURE_RISK_JV_DP_file
             
  --truncate table tmp_PURE_RISK_JV_DP_file   
                               
  select party_code,scrip_cd,series='BSE',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                             
  when len(fromacc)<16 then 'IN301549' else ''  end,                                            
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             
  when len(toacc)<16 then 'IN301549' else ''  end,                                            
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                            
  from general.dbo.tmp_VMSS_PURERISK_DPHOLDING where                                              
 -- sqoffseq > 0 and HoldDate =(select Max(processDate) from VMSS_data)                                            
   TOSEGMENT='BSECM'                                            
                  
  INSERT INTO #JVDATA                                            
  select party_code,scrip_cd,series='',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)              
  when len(fromacc)<16 then 'IN301549' else ''  end,                                            
  fromacc,                                        
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             
  when len(toacc)<16 then 'IN301549' else ''  end,                                            
  toacc,type1='BTM',TOSEGMENT from general.dbo.tmp_VMSS_PURERISK_DPHOLDING where                                            
 -- sqoffseq > 0   and HoldDate =(select Max(processDate) from VMSS_data)                                            
   TOSEGMENT='NSECM'    
     
     
   /*To delete corp action clients added on July 20 2017*/     
  --select *  from #JVDATA where isin in (  
  --select distinct isin from VMSS_PURERISK_DPHOLDING A inner join  [196.1.115.239].CommonMaster.dbo.Corp_action B with (nolock) on A.isin=b.Sca_ISIN  
  --where cast(Sca_Ex_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '') -- and cast(Sca_BCFrom_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '')  
  --)    
  
  
  select distinct Sca_ISIN,Sca_Ex_Dt into #TEMP_ISIN from [196.1.115.239].CommonMaster.dbo.Corp_action A with (nolock)  where  Sca_CatCode<>'D'  
  and cast(Sca_Ex_Dt as date)<=cast(getdate()+2 as date) and cast(Sca_Ex_Dt as date)>=cast(getdate()-2 as date) order by Sca_Ex_Dt desc  
   
  delete from #JVDATA where isin in (  
  select distinct isin from general.dbo.tmp_VMSS_PURERISK_DPHOLDING A inner join #TEMP_ISIN B with (nolock) on A.isin=b.Sca_ISIN  
  )                                          
       
        
  --truncate table tmp_PURE_RISK_JV_DP_file                                
                  
  --insert into tmp_PURE_RISK_JV_DP_file                                           
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                          
  from #JVDATA                                          
                  
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                         
                  
  DECLARE @file1 AS VARCHAR(100)                                              
  DECLARE @file2 AS VARCHAR(100)                         
  DECLARE @i AS INT                                            
  DECLARE @str VARCHAR(8000)                                             
  declare @segment varchar(10)                                        
                
  DECLARE @fileCnt as int                    
  DECLARE @RowCnt int,@FileName as varchar(500)                  
                    
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                  
                    
  DECLARE @SQL VARCHAR(MAX)                                                
  SET @SQL = '' 
                    
 --CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))                  
 -- CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))                  
                
   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/                  
  SET @fileCnt=(select FileCnt from VMSS_FileCounter) --5799                  
                    
  SET @RowCnt = (SELECT COUNT(*)as a FROM #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')                   
  SET @FileName=''                  
                    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  
                    
  PRINT @FileName                  
    
	-- select top 0 * 
 --into tmp_FileData
 --from FileData  
         
  --TRUNCATE TABLE tmp_FileData            
                      
  INSERT INTO tmp_FileData                
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               
                    
  INSERT INTO tmp_FileData                                            
  SELECT  '<Tp>5</Tp>'+            
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                               
  FROM   #JVDATAFILE a (nolock)                                    
  WHERE tosegment = 'BSECM'            
                
    /*                  
  INSERT INTO FileData_rohit_23092015                                          
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse                   
  */                  
                                                 
  SET @SQL = ''                                                
              
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.tmp_FileData '                                           
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '   */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                    
  SET @SQL = '''' + @SQL + ''''                                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                
  PRINT @SQL                                                
  EXEC (@SQL)                    
                        
  /*Used For Unix formated Data*/                  
  /*exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName*/ 
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                   
                    
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                   
                    
  /*SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName */ 
  SET @filename1='H:\MindGate\UploadJVCollateral\'+ @FileName                  
                     
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/                      
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/                                  
				                      
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   
                    
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')                   
  SET @FileName=''                  
                    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  
                    
  PRINT @FileName                  
                    
  --TRUNCATE TABLE tmp_FileData              
                      
  INSERT INTO tmp_FileData              
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               
                      
  INSERT INTO tmp_FileData                                          
   SELECT  '<Tp>5</Tp>'+            
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                              
  FROM   #JVDATAFILE a (nolock)                                    
  WHERE tosegment = 'NSECM'        
                       
                    
  /*                  
  INSERT INTO FileData_rohit_23092015                                          
  select DATA from #VMSS_JVCEColl_tblfile_nse                   
  */                                                  
                    
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.tmp_FileData '                                           
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 ' */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                   
  SET @SQL = '''' + @SQL + ''''                                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                
  PRINT @SQL                                                
  EXEC (@SQL)                      
                        
  /*Used For Unix formated Data*/                  
  /*exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName  */
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                    
             
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                    
                     
  /*SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName*/                  
  SET @filename2='H:\MindGate\UploadJVCollateral\'+ @FileName                    
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/                    
      
  SET @SQL =''                 
  SET @SQL = 'Dear Team,<br/><br/>'                                                
  SET @SQL = @SQL + 'Please find the attached file for (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') with criteria for shares fetching as given below:    
  

 <br/><br/>1. Shares fetching is done only when client is in continous projected + pure  risk for 5 days.  
 <br/><br/>2. Codes considered for shares fetching to the extent of pure + projected risk value . Sequence will be Blue-chip , good , Average and Poor if client in Pure risk and Blue-chip, Good , Average if client in projected risk.   
 <br/><br/>3. If there is only projected risk then the cap of fetching of shares will be done above Rs.500 and if there is pure risk then there will be cap of Rs.100 for fetching of shares which will be done to the extent of pure +projected risk value.  





 <br/><br/>4. Shares fetching will not be done in this process if there is no Pure and projected risk.   
 <br/><br/>5. Regions/Branches and SBs can see the reports on daily basis in NRMS - >Risk Manager - > Var Margin Report -> DP POA Shares Movement- with every details given below:   
 <br/><br/>6. SMS logs report will also be available to all users on daily basis.'  
       
                                                 
  SET @SQL = @SQL + '<br/><br/><br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                                
                    
  DECLARE @s varchar(500)                                                          
  SET @s = @filename1 + ';' + @filename2                                               
                    
  EXEC msdb.dbo.sp_send_dbmail            
  @profile_name = 'Square',                                    
  @recipients= 'unistanz.sneha@angelbroking.com;',                                                
  @copy_recipients= '' ,                 
   --@blind_copy_recipients= @BCC,                                                
  @body= @SQL,                                                
  @file_attachments= @s,                                                
  @body_format= 'HTML',                                                  
  @subject='Shares fetching to the extent of pure + projected risk value'                                           
                                       
End try                                                                     
BEGIN CATCH                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                               
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                              
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                 
                                                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pure_Risk_DP_Adj_file_mail_20072017
-- --------------------------------------------------
      
create Procedure [dbo].[Pure_Risk_DP_Adj_file_mail_20072017]                                    
as                                    
                                            
SET XACT_ABORT ON                                            
Set nocount on                                            
 BEGIN TRY                                                                    
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                                  
       
  --alter table VMSS_PURERISK_DPHOLDING add FromAcc varchar(20),ToAcc varchar(20),ToSegment varchar(20)     
         
  /*update VMSS_PURERISK_DPHOLDING set Tosegment=b.segment from Pure_RiskClients_ActiveSeg_Details b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code */
 /* Added on Aug 23 2016 as discussed with vishal and Renil SIr to check client is having account in  BSE and NSE*/ 
  select distinct A.party_code,Exchange,Segment into #temp  from  VMSS_PURERISK_DPHOLDING A inner join  anand1.msajag.dbo.client_brok_details  B on A.party_code=B.cl_code
  where  ( exchange in ('BSE','NSE') and segment in('CAPITAL'))

	select * into #temp2
	from 
	(
	  select party_code,Exchange,Segment
	  from #temp
	) src
	pivot
	(
	  max(Exchange)
	  for Exchange in ([BSE],[NSE])
	) piv;


 update VMSS_PURERISK_DPHOLDING set Tosegment=case when b.BSE='BSE' and b.NSE='NSE' then 'BSECM' 
                                                    when b.BSE='BSE' and b.NSE is null  then 'BSECM'
                                                    when b.NSE='NSE'  and b.BSE is null then 'NSECM'  else '' end
 from #temp2 b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code

                                     
  --and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                                    
                
  /************************************************************************/                                    
  update VMSS_PURERISK_DPHOLDING set toacc= case                                     
  /*      
  when tosegment= 'NSECM' then '1203320000000051'                                    
  when tosegment= 'BSECM' then '1203320000000066'             
  */      
  when tosegment= 'NSECM' then '1203320000000028'                                    
  when tosegment= 'BSECM' then '1203320009603460'             
  ELSE '' END                                    
  --where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                                    
                
  update VMSS_PURERISK_DPHOLDING set fromacc=Cltdpid   from general.dbo.dp_holding A  where  VMSS_PURERISK_DPHOLDING.party_code=A.party_code                          
                          
                
  /*****************************/                                    
  --history updation                                    
 --select  top 1 * from VMSS_PURERISK_DPHOLDING    
 --select  top 1 *  from vmss_DP_holding    
 --select * from VMSS_PURERISK_DPHOLDING where cast(process_date as date)=cast('May 10 2016' as date)  and total_adj=348025.70    
            --select * into VMSS_PURERISK_DPHOLDING_hist from VMSS_PURERISK_DPHOLDING where 1=2    
            /*    
  delete from VMSS_PURERISK_DPHOLDING_hist where HoldDate =(select Max(processDate) from VMSS_data)                            
                
  insert into VMSS_PURERISK_DPHOLDING_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                              
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                               
  from VMSS_PURERISK_DPHOLDING where SqOffQty > 0                              
      */   
              
  truncate table PURE_RISK_JV_DP_file                              
  select party_code,scrip_cd,series='BSE',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                           
  when len(fromacc)<16 then 'IN301549' else ''  end,                                          
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                           
  when len(toacc)<16 then 'IN301549' else ''  end,                                          
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                          
  from VMSS_PURERISK_DPHOLDING where                                            
 -- sqoffseq > 0 and HoldDate =(select Max(processDate) from VMSS_data)                                          
   TOSEGMENT='BSECM'                                          
                
  INSERT INTO #JVDATA                                          
  select party_code,scrip_cd,series='',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)            
  when len(fromacc)<16 then 'IN301549' else ''  end,                                          
  fromacc,                                      
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                           
  when len(toacc)<16 then 'IN301549' else ''  end,                                          
  toacc,type1='BTM',TOSEGMENT from VMSS_PURERISK_DPHOLDING where                                          
 -- sqoffseq > 0   and HoldDate =(select Max(processDate) from VMSS_data)                                          
   TOSEGMENT='NSECM'                                          
                
  truncate table PURE_RISK_JV_DP_file                              
                
  insert into PURE_RISK_JV_DP_file                                         
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                        
  from #JVDATA                                        
                
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                       
                
  DECLARE @file1 AS VARCHAR(100)                                            
  DECLARE @file2 AS VARCHAR(100)                       
  DECLARE @i AS INT                                          
  DECLARE @str VARCHAR(8000)                                           
  declare @segment varchar(10)                                      
              
  DECLARE @fileCnt as int                  
  DECLARE @RowCnt int,@FileName as varchar(500)                
                  
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                
                  
  DECLARE @SQL VARCHAR(MAX)                                              
  SET @SQL = ''                
                  
  CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))                
  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))                
              
   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/                
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                 
                  
  SET @RowCnt = (SELECT COUNT(*)as a FROM #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')                 
  SET @FileName=''                
                  
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                
                  
  PRINT @FileName                
          
  TRUNCATE TABLE FileData          
                    
  INSERT INTO FileData              
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                 
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                             
                  
  INSERT INTO FileData                                          
  SELECT  '<Tp>5</Tp>'+          
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+          
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'          
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                             
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                             
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                            
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                            
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                            
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                            
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                             
  FROM   #JVDATAFILE a (nolock)                                  
  WHERE tosegment = 'BSECM'               
              
    /*                
  INSERT INTO FileData_rohit_23092015                                        
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse                 
  */                
                                               
  SET @SQL = ''                                              
            
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                         
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                 
  SET @SQL = '''' + @SQL + ''''                                              
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                              
  PRINT @SQL                                              
  EXEC (@SQL)                  
                      
  /*Used For Unix formated Data*/                
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName                
                  
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                 
                  
  SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName                
                   
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/                    
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/                
                    
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                 
                  
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')                 
  SET @FileName=''                
                  
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                
                  
  PRINT @FileName                
                  
  TRUNCATE TABLE FileData            
                    
  INSERT INTO FileData            
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                 
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                             
                    
  INSERT INTO FileData                                        
  SELECT  '<Tp>5</Tp>'+          
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+          
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'          
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                             
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                             
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                            
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                            
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                            
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                            
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                            
  FROM   #JVDATAFILE a (nolock)                                  
  WHERE tosegment = 'NSECM'                 
                     
                  
  /*                
  INSERT INTO FileData_rohit_23092015                                        
  select DATA from #VMSS_JVCEColl_tblfile_nse                 
  */                                                
                  
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                         
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                 
  SET @SQL = '''' + @SQL + ''''                                                SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                              
  PRINT @SQL                                              
  EXEC (@SQL)                    
                      
  /*Used For Unix formated Data*/                
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName                 
           
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                  
                   
  SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName                
                    
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/                  
    
  SET @SQL =''                  
  SET @SQL = 'Dear Team,<br/><br/>'                                              
  SET @SQL = @SQL + 'Please find the attached file for (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') with criteria for shares fetching as given below:  

	<br/><br/>1.	Codes considered for shares fetching to the extent of pure + projected risk value . Sequence will be Blue-chip , good , Average and Poor if client in Pure risk and Blue-chip, Good , Average if client in projected risk. 
	<br/><br/>2.	If there is only projected risk then the cap of fetching of shares will be done above Rs.500 and if there is pure risk then there will be cap of Rs.100 for fetching of shares which will be done to the extent of pure +projected risk value.
	<br/><br/>3.	Shares fetching will not be done in this process if there is no Pure and projected risk. 
	<br/><br/>4.	Regions/Branches and SBs can see the reports on daily basis in NRMS - >Risk Manager - > Var Margin Report -> DP POA Shares Movement- with every details given below: 
	<br/><br/>5.	SMS logs report will also be available to all users on daily basis.'
	    
                                               
  SET @SQL = @SQL + '<br/><br/><br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                              
                  
  DECLARE @s varchar(500)                                                        
  SET @s = @filename1 + ';' + @filename2                                             
                  
  EXEC msdb.dbo.sp_send_dbmail          
  @profile_name = 'Square',                                  
  @recipients= 'anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;rajendra.tiwari@angelbroking.com;vilasnaram@angelbroking.com;',                                              
  @copy_recipients= 'renil.pillai@angelbroking.com;vishal@angelbroking.com;csorm@angelbroking.com;mgs.abha@angelbroking.com;',                
   --@blind_copy_recipients= @BCC,                                              
  @body= @SQL,                                              
  @file_attachments= @s,                                              
  @body_format= 'HTML',                                                
  @subject='Shares fetching to the extent of pure + projected risk value'                                         
                                     
End try                                                                   
BEGIN CATCH                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                             
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                            
  DECLARE @ErrorMessage NVARCHAR(4000);                                                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                              
  RAISERROR (@ErrorMessage , 16, 1);                                    
End catch                                               
                                              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pure_Risk_DP_Adj_file_mail_23082016
-- --------------------------------------------------
      
create Procedure [dbo].[Pure_Risk_DP_Adj_file_mail_23082016]                                    
as                                    
                                            
SET XACT_ABORT ON                                            
Set nocount on                                            
 BEGIN TRY                                                                    
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                                  
       
  --alter table VMSS_PURERISK_DPHOLDING add FromAcc varchar(20),ToAcc varchar(20),ToSegment varchar(20)     
         
  update VMSS_PURERISK_DPHOLDING set Tosegment=b.segment from Pure_RiskClients_ActiveSeg_Details b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code                                    
  --and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                                    
                
  /************************************************************************/                                    
  update VMSS_PURERISK_DPHOLDING set toacc= case                                     
  /*      
  when tosegment= 'NSECM' then '1203320000000051'                                    
  when tosegment= 'BSECM' then '1203320000000066'             
  */      
  when tosegment= 'NSECM' then '1203320000000028'                                    
  when tosegment= 'BSECM' then '1203320009603460'             
  ELSE '' END                                    
  --where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                                    
                
  update VMSS_PURERISK_DPHOLDING set fromacc=Cltdpid   from general.dbo.dp_holding A  where  VMSS_PURERISK_DPHOLDING.party_code=A.party_code                          
                          
                
  /*****************************/                                    
  --history updation                                    
 --select  top 1 * from VMSS_PURERISK_DPHOLDING    
 --select  top 1 *  from vmss_DP_holding    
 --select * from VMSS_PURERISK_DPHOLDING where cast(process_date as date)=cast('May 10 2016' as date)  and total_adj=348025.70    
            --select * into VMSS_PURERISK_DPHOLDING_hist from VMSS_PURERISK_DPHOLDING where 1=2    
            /*    
  delete from VMSS_PURERISK_DPHOLDING_hist where HoldDate =(select Max(processDate) from VMSS_data)                            
                
  insert into VMSS_PURERISK_DPHOLDING_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                              
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                               
  from VMSS_PURERISK_DPHOLDING where SqOffQty > 0                              
      */   
              
  truncate table PURE_RISK_JV_DP_file                              
  select party_code,scrip_cd,series='BSE',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                           
  when len(fromacc)<16 then 'IN301549' else ''  end,                                          
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                           
  when len(toacc)<16 then 'IN301549' else ''  end,                                          
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                          
  from VMSS_PURERISK_DPHOLDING where                                            
 -- sqoffseq > 0 and HoldDate =(select Max(processDate) from VMSS_data)                                          
   TOSEGMENT='BSECM'                                          
                
  INSERT INTO #JVDATA                                          
  select party_code,scrip_cd,series='',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)            
  when len(fromacc)<16 then 'IN301549' else ''  end,                                          
  fromacc,                                      
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                           
  when len(toacc)<16 then 'IN301549' else ''  end,                                          
  toacc,type1='BTM',TOSEGMENT from VMSS_PURERISK_DPHOLDING where                                          
 -- sqoffseq > 0   and HoldDate =(select Max(processDate) from VMSS_data)                                          
   TOSEGMENT='NSECM'                                          
                
  truncate table PURE_RISK_JV_DP_file                              
                
  insert into PURE_RISK_JV_DP_file                                         
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                        
  from #JVDATA                                        
                
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                       
                
  DECLARE @file1 AS VARCHAR(100)                                            
  DECLARE @file2 AS VARCHAR(100)                       
  DECLARE @i AS INT                                          
  DECLARE @str VARCHAR(8000)                                           
  declare @segment varchar(10)                                      
              
  DECLARE @fileCnt as int                  
  DECLARE @RowCnt int,@FileName as varchar(500)                
                  
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                
                  
  DECLARE @SQL VARCHAR(MAX)                                              
  SET @SQL = ''                
                  
  CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))                
  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))                
              
   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/                
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                 
                  
  SET @RowCnt = (SELECT COUNT(*)as a FROM #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')                 
  SET @FileName=''                
                  
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                
                  
  PRINT @FileName                
          
  TRUNCATE TABLE FileData          
                    
  INSERT INTO FileData              
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                 
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                             
                  
  INSERT INTO FileData                                          
  SELECT  '<Tp>5</Tp>'+          
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+          
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'          
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                             
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                             
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                            
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                            
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn></Rsn>'+                            
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                            
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                             
  FROM   #JVDATAFILE a (nolock)                                  
  WHERE tosegment = 'BSECM'               
              
    /*                
  INSERT INTO FileData_rohit_23092015                                        
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse                 
  */                
                                               
  SET @SQL = ''                                              
            
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                         
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                 
  SET @SQL = '''' + @SQL + ''''                                              
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                              
  PRINT @SQL                                              
  EXEC (@SQL)                  
                      
  /*Used For Unix formated Data*/                
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName                
                  
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                 
                  
  SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName                
                   
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/                    
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/                
                    
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                 
                  
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')                 
  SET @FileName=''                
                  
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                
                  
  PRINT @FileName                
                  
  TRUNCATE TABLE FileData            
                    
  INSERT INTO FileData            
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                 
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                             
                    
  INSERT INTO FileData                                        
  SELECT  '<Tp>5</Tp>'+          
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+          
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'          
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                             
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                             
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                            
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                            
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn></Rsn>'+                            
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                            
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                            
  FROM   #JVDATAFILE a (nolock)                                  
  WHERE tosegment = 'NSECM'                 
                     
                  
  /*                
  INSERT INTO FileData_rohit_23092015                                        
  select DATA from #VMSS_JVCEColl_tblfile_nse                 
  */                                                
                  
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                         
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                 
  SET @SQL = '''' + @SQL + ''''                                                SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                              
  PRINT @SQL                                              
  EXEC (@SQL)                    
                      
  /*Used For Unix formated Data*/                
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName                 
           
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                  
                   
  SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName                
                    
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/                  
    
  SET @SQL =''                  
  SET @SQL = 'Dear Team,<br/><br/>'                                              
  SET @SQL = @SQL + 'Please find the attached file for (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') with criteria for shares fetching as given below:  

	<br/><br/>1.	Codes considered for shares fetching to the extent of pure + projected risk value . Sequence will be Blue-chip , good , Average and Poor if client in Pure risk and Blue-chip, Good , Average if client in projected risk. 
	<br/><br/>2.	If there is only projected risk then the cap of fetching of shares will be done above Rs.500 and if there is pure risk then there will be cap of Rs.100 for fetching of shares which will be done to the extent of pure +projected risk value.
	<br/><br/>3.	Shares fetching will not be done in this process if there is no Pure and projected risk. 
	<br/><br/>4.	Regions/Branches and SBs can see the reports on daily basis in NRMS - >Risk Manager - > Var Margin Report -> DP POA Shares Movement- with every details given below: 
	<br/><br/>5.	SMS logs report will also be available to all users on daily basis.'
	    
                                               
  SET @SQL = @SQL + '<br/><br/><br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                              
                  
  DECLARE @s varchar(500)                                                        
  SET @s = @filename1 + ';' + @filename2                                             
                  
  EXEC msdb.dbo.sp_send_dbmail          
  @profile_name = 'Square',                                  
  @recipients= 'anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;rajendra.tiwari@angelbroking.com;vilasnaram@angelbroking.com;',                                              
  @copy_recipients= 'renil.pillai@angelbroking.com;vishal@angelbroking.com;csorm@angelbroking.com;mgs.abha@angelbroking.com;',                
   --@blind_copy_recipients= @BCC,                                              
  @body= @SQL,                                              
  @file_attachments= @s,                                              
  @body_format= 'HTML',                                                
  @subject='Shares fetching to the extent of pure + projected risk value'                                         
                                     
End try                                                                   
BEGIN CATCH                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                             
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                            
  DECLARE @ErrorMessage NVARCHAR(4000);                                                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                              
  RAISERROR (@ErrorMessage , 16, 1);                                    
End catch                                               
                                              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pure_Risk_DP_Adj_file_mail_26092017
-- --------------------------------------------------
        
CREATE Procedure [dbo].[Pure_Risk_DP_Adj_file_mail_26092017]                                      
as                                      
                                              
SET XACT_ABORT ON                                              
Set nocount on                                              
 BEGIN TRY                                                                      
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                                    
         
  --alter table VMSS_PURERISK_DPHOLDING add FromAcc varchar(20),ToAcc varchar(20),ToSegment varchar(20)       
           
  /*update VMSS_PURERISK_DPHOLDING set Tosegment=b.segment from Pure_RiskClients_ActiveSeg_Details b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code */  
 /* Added on Aug 23 2016 as discussed with vishal and Renil SIr to check client is having account in  BSE and NSE*/   
  select distinct A.party_code,Exchange,Segment into #temp  from  VMSS_PURERISK_DPHOLDING A inner join  anand1.msajag.dbo.client_brok_details  B on A.party_code=B.cl_code  
  where  ( exchange in ('BSE','NSE') and segment in('CAPITAL'))  
  
 select * into #temp2  
 from   
 (  
   select party_code,Exchange,Segment  
   from #temp  
 ) src  
 pivot  
 (  
   max(Exchange)  
   for Exchange in ([BSE],[NSE])  
 ) piv;  
  
  
 update VMSS_PURERISK_DPHOLDING set Tosegment=case when b.BSE='BSE' and b.NSE='NSE' then 'BSECM'   
                                                    when b.BSE='BSE' and b.NSE is null  then 'BSECM'  
                                                    when b.NSE='NSE'  and b.BSE is null then 'NSECM'  else '' end  
 from #temp2 b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code  
  
                                       
  --and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                                      
                  
  /************************************************************************/                                      
  update VMSS_PURERISK_DPHOLDING set toacc= case                                       
  /*        
  when tosegment= 'NSECM' then '1203320000000051'                                      
  when tosegment= 'BSECM' then '1203320000000066'               
  */        
  when tosegment= 'NSECM' then '1203320000000028'                                      
  when tosegment= 'BSECM' then '1203320009603460'               
  ELSE '' END                                      
  --where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                                      
                  
  update VMSS_PURERISK_DPHOLDING set fromacc=Cltdpid   from general.dbo.dp_holding A  where  VMSS_PURERISK_DPHOLDING.party_code=A.party_code                            
                            
                  
  /*****************************/                                      
  --history updation                                      
 --select  top 1 * from VMSS_PURERISK_DPHOLDING      
 --select  top 1 *  from vmss_DP_holding      
 --select * from VMSS_PURERISK_DPHOLDING where cast(process_date as date)=cast('May 10 2016' as date)  and total_adj=348025.70      
            --select * into VMSS_PURERISK_DPHOLDING_hist from VMSS_PURERISK_DPHOLDING where 1=2      
            /*      
  delete from VMSS_PURERISK_DPHOLDING_hist where HoldDate =(select Max(processDate) from VMSS_data)                              
                  
  insert into VMSS_PURERISK_DPHOLDING_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                                
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                                 
  from VMSS_PURERISK_DPHOLDING where SqOffQty > 0                                
      */     
                
  truncate table PURE_RISK_JV_DP_file                                
  select party_code,scrip_cd,series='BSE',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                             
  when len(fromacc)<16 then 'IN301549' else ''  end,                                            
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             
  when len(toacc)<16 then 'IN301549' else ''  end,                                            
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                            
  from VMSS_PURERISK_DPHOLDING where                                              
 -- sqoffseq > 0 and HoldDate =(select Max(processDate) from VMSS_data)                                            
   TOSEGMENT='BSECM'                                            
                  
  INSERT INTO #JVDATA                                            
  select party_code,scrip_cd,series='',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)              
  when len(fromacc)<16 then 'IN301549' else ''  end,                                            
  fromacc,                                        
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             
  when len(toacc)<16 then 'IN301549' else ''  end,                                            
  toacc,type1='BTM',TOSEGMENT from VMSS_PURERISK_DPHOLDING where                                            
 -- sqoffseq > 0   and HoldDate =(select Max(processDate) from VMSS_data)                                            
   TOSEGMENT='NSECM'    
     
     
   /*To delete corp action clients added on July 20 2017*/     
  --select *  from #JVDATA where isin in (  
  --select distinct isin from VMSS_PURERISK_DPHOLDING A inner join  [196.1.115.239].CommonMaster.dbo.Corp_action B with (nolock) on A.isin=b.Sca_ISIN  
  --where cast(Sca_Ex_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '') -- and cast(Sca_BCFrom_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '')  
  --)    
  
  
  select distinct Sca_ISIN,Sca_Ex_Dt into #TEMP_ISIN from [196.1.115.239].CommonMaster.dbo.Corp_action A with (nolock)  where  Sca_CatCode<>'D'  
  and cast(Sca_Ex_Dt as date)<=cast(getdate()+2 as date) and cast(Sca_Ex_Dt as date)>=cast(getdate()-2 as date) order by Sca_Ex_Dt desc  
   
  delete from #JVDATA where isin in (  
  select distinct isin from VMSS_PURERISK_DPHOLDING A inner join #TEMP_ISIN B with (nolock) on A.isin=b.Sca_ISIN  
  )                                          
       
        
  truncate table PURE_RISK_JV_DP_file                                
                  
  insert into PURE_RISK_JV_DP_file                                           
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                          
  from #JVDATA                                          
                  
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                         
                  
  DECLARE @file1 AS VARCHAR(100)                                              
  DECLARE @file2 AS VARCHAR(100)                         
  DECLARE @i AS INT                                            
  DECLARE @str VARCHAR(8000)                                             
  declare @segment varchar(10)                                        
                
  DECLARE @fileCnt as int                    
  DECLARE @RowCnt int,@FileName as varchar(500)                  
                    
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                  
                    
  DECLARE @SQL VARCHAR(MAX)                                                
  SET @SQL = ''                  
                    
  CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))                  
  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))                  
                
   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/                  
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   
                    
  SET @RowCnt = (SELECT COUNT(*)as a FROM #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')                   
  SET @FileName=''                  
                    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  
                    
  PRINT @FileName                  
            
  TRUNCATE TABLE FileData            
                      
  INSERT INTO FileData                
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               
                    
  INSERT INTO FileData                                            
  SELECT  '<Tp>5</Tp>'+            
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                               
  FROM   #JVDATAFILE a (nolock)                                    
  WHERE tosegment = 'BSECM'                 
                
    /*                  
  INSERT INTO FileData_rohit_23092015                                          
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse                   
  */                  
                                                 
  SET @SQL = ''                                                
              
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                           
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                   
  SET @SQL = '''' + @SQL + ''''                                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                
  PRINT @SQL                                                
  EXEC (@SQL)                    
                        
  /*Used For Unix formated Data*/                  
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName                  
                    
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                   
                    
  SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName                  
                     
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/                      
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/                  
                      
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   
                    
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')                   
  SET @FileName=''                  
                    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  
                    
  PRINT @FileName                  
                    
  TRUNCATE TABLE FileData              
                      
  INSERT INTO FileData              
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               
                      
  INSERT INTO FileData                                          
  SELECT  '<Tp>5</Tp>'+            
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                              
  FROM   #JVDATAFILE a (nolock)                                    
  WHERE tosegment = 'NSECM'                   
                       
                    
  /*                  
  INSERT INTO FileData_rohit_23092015                                          
  select DATA from #VMSS_JVCEColl_tblfile_nse                   
  */                                                  
                    
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                           
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                   
  SET @SQL = '''' + @SQL + ''''                                                SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                
  PRINT @SQL                                                
  EXEC (@SQL)                      
                        
  /*Used For Unix formated Data*/                  
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName                   
             
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                    
                     
  SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName                  
                      
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/                    
      
  SET @SQL =''                    
  SET @SQL = 'Dear Team,<br/><br/>'                                                
  SET @SQL = @SQL + 'Please find the attached file for (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') with criteria for shares fetching as given below:    
  
 <br/><br/>1. Codes considered for shares fetching to the extent of pure + projected risk value . Sequence will be Blue-chip , good , Average and Poor if client in Pure risk and Blue-chip, Good , Average if client in projected risk.   
 <br/><br/>2. If there is only projected risk then the cap of fetching of shares will be done above Rs.500 and if there is pure risk then there will be cap of Rs.100 for fetching of shares which will be done to the extent of pure +projected risk value.  
 <br/><br/>3. Shares fetching will not be done in this process if there is no Pure and projected risk.   
 <br/><br/>4. Regions/Branches and SBs can see the reports on daily basis in NRMS - >Risk Manager - > Var Margin Report -> DP POA Shares Movement- with every details given below:   
 <br/><br/>5. SMS logs report will also be available to all users on daily basis.'  
       
                                                 
  SET @SQL = @SQL + '<br/><br/><br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                                
                    
  DECLARE @s varchar(500)                                                          
  SET @s = @filename1 + ';' + @filename2                                               
                    
  EXEC msdb.dbo.sp_send_dbmail            
  @profile_name = 'Square',                                    
  @recipients= 'anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;rajendra.tiwari@angelbroking.com;vilasnaram@angelbroking.com;',                                                
  @copy_recipients= 'renil.pillai@angelbroking.com;vishal@angelbroking.com;csorm@angelbroking.com;mgs.abha@angelbroking.com;',                  
   --@blind_copy_recipients= @BCC,                                                
  @body= @SQL,                                                
  @file_attachments= @s,                                                
  @body_format= 'HTML',                                                  
  @subject='Shares fetching to the extent of pure + projected risk value'                                           
                                       
End try                                                                     
BEGIN CATCH                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                               
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                              
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                 
                                                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pure_Risk_DP_Adj_file_mail_27072017
-- --------------------------------------------------
      
create Procedure [dbo].[Pure_Risk_DP_Adj_file_mail_27072017]                                    
as                                    
                                            
SET XACT_ABORT ON                                            
Set nocount on                                            
 BEGIN TRY                                                                    
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                                  
       
  --alter table VMSS_PURERISK_DPHOLDING add FromAcc varchar(20),ToAcc varchar(20),ToSegment varchar(20)     
         
  /*update VMSS_PURERISK_DPHOLDING set Tosegment=b.segment from Pure_RiskClients_ActiveSeg_Details b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code */
 /* Added on Aug 23 2016 as discussed with vishal and Renil SIr to check client is having account in  BSE and NSE*/ 
  select distinct A.party_code,Exchange,Segment into #temp  from  VMSS_PURERISK_DPHOLDING A inner join  anand1.msajag.dbo.client_brok_details  B on A.party_code=B.cl_code
  where  ( exchange in ('BSE','NSE') and segment in('CAPITAL'))

	select * into #temp2
	from 
	(
	  select party_code,Exchange,Segment
	  from #temp
	) src
	pivot
	(
	  max(Exchange)
	  for Exchange in ([BSE],[NSE])
	) piv;


 update VMSS_PURERISK_DPHOLDING set Tosegment=case when b.BSE='BSE' and b.NSE='NSE' then 'BSECM' 
                                                    when b.BSE='BSE' and b.NSE is null  then 'BSECM'
                                                    when b.NSE='NSE'  and b.BSE is null then 'NSECM'  else '' end
 from #temp2 b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code

                                     
  --and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                                    
                
  /************************************************************************/                                    
  update VMSS_PURERISK_DPHOLDING set toacc= case                                     
  /*      
  when tosegment= 'NSECM' then '1203320000000051'                                    
  when tosegment= 'BSECM' then '1203320000000066'             
  */      
  when tosegment= 'NSECM' then '1203320000000028'                                    
  when tosegment= 'BSECM' then '1203320009603460'             
  ELSE '' END                                    
  --where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                                    
                
  update VMSS_PURERISK_DPHOLDING set fromacc=Cltdpid   from general.dbo.dp_holding A  where  VMSS_PURERISK_DPHOLDING.party_code=A.party_code                          
                          
                
  /*****************************/                                    
  --history updation                                    
 --select  top 1 * from VMSS_PURERISK_DPHOLDING    
 --select  top 1 *  from vmss_DP_holding    
 --select * from VMSS_PURERISK_DPHOLDING where cast(process_date as date)=cast('May 10 2016' as date)  and total_adj=348025.70    
            --select * into VMSS_PURERISK_DPHOLDING_hist from VMSS_PURERISK_DPHOLDING where 1=2    
            /*    
  delete from VMSS_PURERISK_DPHOLDING_hist where HoldDate =(select Max(processDate) from VMSS_data)                            
                
  insert into VMSS_PURERISK_DPHOLDING_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                              
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                               
  from VMSS_PURERISK_DPHOLDING where SqOffQty > 0                              
      */   
              
  truncate table PURE_RISK_JV_DP_file                              
  select party_code,scrip_cd,series='BSE',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                           
  when len(fromacc)<16 then 'IN301549' else ''  end,                                          
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                           
  when len(toacc)<16 then 'IN301549' else ''  end,                                          
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                          
  from VMSS_PURERISK_DPHOLDING where                                            
 -- sqoffseq > 0 and HoldDate =(select Max(processDate) from VMSS_data)                                          
   TOSEGMENT='BSECM'                                          
                
  INSERT INTO #JVDATA                                          
  select party_code,scrip_cd,series='',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)            
  when len(fromacc)<16 then 'IN301549' else ''  end,                                          
  fromacc,                                      
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                           
  when len(toacc)<16 then 'IN301549' else ''  end,                                          
  toacc,type1='BTM',TOSEGMENT from VMSS_PURERISK_DPHOLDING where                                          
 -- sqoffseq > 0   and HoldDate =(select Max(processDate) from VMSS_data)                                          
   TOSEGMENT='NSECM'                                          
                
  truncate table PURE_RISK_JV_DP_file                              
                
  insert into PURE_RISK_JV_DP_file                                         
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                        
  from #JVDATA                                        
                
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                       
                
  DECLARE @file1 AS VARCHAR(100)                                            
  DECLARE @file2 AS VARCHAR(100)                       
  DECLARE @i AS INT                                          
  DECLARE @str VARCHAR(8000)                                           
  declare @segment varchar(10)                                      
              
  DECLARE @fileCnt as int                  
  DECLARE @RowCnt int,@FileName as varchar(500)                
                  
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                
                  
  DECLARE @SQL VARCHAR(MAX)                                              
  SET @SQL = ''                
                  
  CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))                
  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))                
              
   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/                
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                 
                  
  SET @RowCnt = (SELECT COUNT(*)as a FROM #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')                 
  SET @FileName=''                
                  
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                
                  
  PRINT @FileName                
          
  TRUNCATE TABLE FileData          
                    
  INSERT INTO FileData              
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                 
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                             
                  
  INSERT INTO FileData                                          
  SELECT  '<Tp>5</Tp>'+          
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+          
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'          
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                             
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                             
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                            
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                            
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                            
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                            
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                             
  FROM   #JVDATAFILE a (nolock)                                  
  WHERE tosegment = 'BSECM'               
              
    /*                
  INSERT INTO FileData_rohit_23092015                                        
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse                 
  */                
                                               
  SET @SQL = ''                                              
            
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                         
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                 
  SET @SQL = '''' + @SQL + ''''                                              
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                              
  PRINT @SQL                                              
  EXEC (@SQL)                  
                      
  /*Used For Unix formated Data*/                
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName                
                  
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                 
                  
  SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName                
                   
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/                    
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/                
                    
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                 
                  
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')                 
  SET @FileName=''                
                  
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                
                  
  PRINT @FileName                
                  
  TRUNCATE TABLE FileData            
                    
  INSERT INTO FileData            
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                 
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                             
                    
  INSERT INTO FileData                                        
  SELECT  '<Tp>5</Tp>'+          
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+          
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'          
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                             
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                             
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                            
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                            
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                            
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                            
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                            
  FROM   #JVDATAFILE a (nolock)                                  
  WHERE tosegment = 'NSECM'                 
                     
                  
  /*                
  INSERT INTO FileData_rohit_23092015                                        
  select DATA from #VMSS_JVCEColl_tblfile_nse                 
  */                                                
                  
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                         
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                 
  SET @SQL = '''' + @SQL + ''''                                                SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                              
  PRINT @SQL                                              
  EXEC (@SQL)                    
                      
  /*Used For Unix formated Data*/                
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName                 
           
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                  
                   
  SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName                
                    
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/                  
    
  SET @SQL =''                  
  SET @SQL = 'Dear Team,<br/><br/>'                                              
  SET @SQL = @SQL + 'Please find the attached file for (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') with criteria for shares fetching as given below:  

	<br/><br/>1.	Codes considered for shares fetching to the extent of pure + projected risk value . Sequence will be Blue-chip , good , Average and Poor if client in Pure risk and Blue-chip, Good , Average if client in projected risk. 
	<br/><br/>2.	If there is only projected risk then the cap of fetching of shares will be done above Rs.500 and if there is pure risk then there will be cap of Rs.100 for fetching of shares which will be done to the extent of pure +projected risk value.
	<br/><br/>3.	Shares fetching will not be done in this process if there is no Pure and projected risk. 
	<br/><br/>4.	Regions/Branches and SBs can see the reports on daily basis in NRMS - >Risk Manager - > Var Margin Report -> DP POA Shares Movement- with every details given below: 
	<br/><br/>5.	SMS logs report will also be available to all users on daily basis.'
	    
                                               
  SET @SQL = @SQL + '<br/><br/><br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                              
                  
  DECLARE @s varchar(500)                                                        
  SET @s = @filename1 + ';' + @filename2                                             
                  
  EXEC msdb.dbo.sp_send_dbmail          
  @profile_name = 'Square',                                  
  @recipients= 'anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;rajendra.tiwari@angelbroking.com;vilasnaram@angelbroking.com;',                                              
  @copy_recipients= 'renil.pillai@angelbroking.com;vishal@angelbroking.com;csorm@angelbroking.com;mgs.abha@angelbroking.com;',                
   --@blind_copy_recipients= @BCC,                                              
  @body= @SQL,                                              
  @file_attachments= @s,                                              
  @body_format= 'HTML',                                                
  @subject='Shares fetching to the extent of pure + projected risk value'                                         
                                     
End try                                                                   
BEGIN CATCH                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                             
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                            
  DECLARE @ErrorMessage NVARCHAR(4000);                                                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                              
  RAISERROR (@ErrorMessage , 16, 1);                                    
End catch                                               
                                              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pure_Risk_DP_Adj_file_mail_Bkp15Jan2019
-- --------------------------------------------------
       
CREATE Procedure [dbo].[Pure_Risk_DP_Adj_file_mail_Bkp15Jan2019]                                      
as                                      
                                              
SET XACT_ABORT ON                                              
Set nocount on                                              
 BEGIN TRY                                                                      
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                                    
         
  --alter table VMSS_PURERISK_DPHOLDING add FromAcc varchar(20),ToAcc varchar(20),ToSegment varchar(20)       
           
  /*update VMSS_PURERISK_DPHOLDING set Tosegment=b.segment from Pure_RiskClients_ActiveSeg_Details b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code */  
 /* Added on Aug 23 2016 as discussed with vishal and Renil SIr to check client is having account in  BSE and NSE*/   
  select distinct A.party_code,Exchange,Segment into #temp  from  VMSS_PURERISK_DPHOLDING A inner join  anand1.msajag.dbo.client_brok_details  B on A.party_code=B.cl_code  
  where  ( exchange in ('BSE','NSE') and segment in('CAPITAL'))  
  
 select * into #temp2  
 from   
 (  
   select party_code,Exchange,Segment  
   from #temp  
 ) src  
 pivot  
 (  
   max(Exchange)  
   for Exchange in ([BSE],[NSE])  
 ) piv;  
  
  
 update VMSS_PURERISK_DPHOLDING set Tosegment=case when b.BSE='BSE' and b.NSE='NSE' then 'NSECM'   
                                                    when b.BSE='BSE' and b.NSE is null  then 'BSECM'  
                                                    when b.NSE='NSE'  and b.BSE is null then 'NSECM'  else '' end  
 from #temp2 b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code  
  
                                       
  --and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                                      
                  
  /************************************************************************/                                      
  update VMSS_PURERISK_DPHOLDING set toacc= case                                       
  /*        
  when tosegment= 'NSECM' then '1203320000000051'                                      
  when tosegment= 'BSECM' then '1203320000000066'               
  */        
  when tosegment= 'NSECM' then '1203320000000028'                                      
  when tosegment= 'BSECM' then '1203320009603460'               
  ELSE '' END                                      
  --where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                                      
                  
  update VMSS_PURERISK_DPHOLDING set fromacc=Cltdpid   from general.dbo.dp_holding A  where  VMSS_PURERISK_DPHOLDING.party_code=A.party_code                            
                            
                  
  /*****************************/                                      
  --history updation                                      
 --select  top 1 * from VMSS_PURERISK_DPHOLDING      
 --select  top 1 *  from vmss_DP_holding      
 --select * from VMSS_PURERISK_DPHOLDING where cast(process_date as date)=cast('May 10 2016' as date)  and total_adj=348025.70      
            --select * into VMSS_PURERISK_DPHOLDING_hist from VMSS_PURERISK_DPHOLDING where 1=2      
            /*      
  delete from VMSS_PURERISK_DPHOLDING_hist where HoldDate =(select Max(processDate) from VMSS_data)                              
                  
  insert into VMSS_PURERISK_DPHOLDING_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                                
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                                 
  from VMSS_PURERISK_DPHOLDING where SqOffQty > 0            
      */     
                
  truncate table PURE_RISK_JV_DP_file                                
  select party_code,scrip_cd,series='BSE',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                             
  when len(fromacc)<16 then 'IN301549' else ''  end,                                            
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             
  when len(toacc)<16 then 'IN301549' else ''  end,                                            
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                            
  from VMSS_PURERISK_DPHOLDING where                                              
 -- sqoffseq > 0 and HoldDate =(select Max(processDate) from VMSS_data)                                            
   TOSEGMENT='BSECM'                                            
                  
  INSERT INTO #JVDATA                                            
  select party_code,scrip_cd,series='',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)              
  when len(fromacc)<16 then 'IN301549' else ''  end,                                            
  fromacc,                                        
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             
  when len(toacc)<16 then 'IN301549' else ''  end,                                            
  toacc,type1='BTM',TOSEGMENT from VMSS_PURERISK_DPHOLDING where                                            
 -- sqoffseq > 0   and HoldDate =(select Max(processDate) from VMSS_data)                                            
   TOSEGMENT='NSECM'    
     
     
   /*To delete corp action clients added on July 20 2017*/     
  --select *  from #JVDATA where isin in (  
  --select distinct isin from VMSS_PURERISK_DPHOLDING A inner join  [196.1.115.239].CommonMaster.dbo.Corp_action B with (nolock) on A.isin=b.Sca_ISIN  
  --where cast(Sca_Ex_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '') -- and cast(Sca_BCFrom_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '')  
  --)    
  
  
  select distinct Sca_ISIN,Sca_Ex_Dt into #TEMP_ISIN from [196.1.115.239].CommonMaster.dbo.Corp_action A with (nolock)  where  Sca_CatCode<>'D'  
  and cast(Sca_Ex_Dt as date)<=cast(getdate()+2 as date) and cast(Sca_Ex_Dt as date)>=cast(getdate()-2 as date) order by Sca_Ex_Dt desc  
   
  delete from #JVDATA where isin in (  
  select distinct isin from VMSS_PURERISK_DPHOLDING A inner join #TEMP_ISIN B with (nolock) on A.isin=b.Sca_ISIN  
  )                                          
       
        
  truncate table PURE_RISK_JV_DP_file                                
                  
  insert into PURE_RISK_JV_DP_file                                           
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                          
  from #JVDATA                                          
                  
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                         
                  
  DECLARE @file1 AS VARCHAR(100)                                              
  DECLARE @file2 AS VARCHAR(100)                         
  DECLARE @i AS INT                                            
  DECLARE @str VARCHAR(8000)                                             
  declare @segment varchar(10)                                        
                
  DECLARE @fileCnt as int                    
  DECLARE @RowCnt int,@FileName as varchar(500)                  
                    
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                  
                    
  DECLARE @SQL VARCHAR(MAX)                                                
  SET @SQL = '' 
                    
  CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))                  
  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))                  
                
   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/                  
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   
                    
  SET @RowCnt = (SELECT COUNT(*)as a FROM #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')                   
  SET @FileName=''                  
                    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  
                    
  PRINT @FileName                  
            
  TRUNCATE TABLE FileData            
                      
  INSERT INTO FileData                
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               
                    
  INSERT INTO FileData                                            
  SELECT  '<Tp>5</Tp>'+            
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                               
  FROM   #JVDATAFILE a (nolock)                                    
  WHERE tosegment = 'BSECM'                 
                
    /*                  
  INSERT INTO FileData_rohit_23092015                                          
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse                   
  */                  
                                                 
  SET @SQL = ''                                                
              
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                           
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '   */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                    
  SET @SQL = '''' + @SQL + ''''                                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                
  PRINT @SQL                                                
  EXEC (@SQL)                    
                        
  /*Used For Unix formated Data*/                  
  /*exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName*/ 
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                   
                    
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                   
                    
  /*SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName */ 
  SET @filename1='H:\MindGate\UploadJVCollateral\'+ @FileName                  
                     
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/                      
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/                  
                      
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   
                    
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')                   
  SET @FileName=''                  
                    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  
                    
  PRINT @FileName                  
                    
  TRUNCATE TABLE FileData              
                      
  INSERT INTO FileData              
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               
                      
  INSERT INTO FileData                                          
  SELECT  '<Tp>5</Tp>'+            
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                              
  FROM   #JVDATAFILE a (nolock)                                    
  WHERE tosegment = 'NSECM'                   
                       
                    
  /*                  
  INSERT INTO FileData_rohit_23092015                                          
  select DATA from #VMSS_JVCEColl_tblfile_nse                   
  */                                                  
                    
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                           
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 ' */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                   
  SET @SQL = '''' + @SQL + ''''                                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                
  PRINT @SQL                                                
  EXEC (@SQL)                      
                        
  /*Used For Unix formated Data*/                  
  /*exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName  */
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                    
             
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                    
                     
  /*SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName*/                  
  SET @filename2='H:\MindGate\UploadJVCollateral\'+ @FileName                    
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/                    
      
  SET @SQL =''                 
  SET @SQL = 'Dear Team,<br/><br/>'                                                
  SET @SQL = @SQL + 'Please find the attached file for (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') with criteria for shares fetching as given below:    
  

 <br/><br/>1. Shares fetching is done only when client is in continous projected + pure  risk for 5 days.  
 <br/><br/>2. Codes considered for shares fetching to the extent of pure + projected risk value . Sequence will be Blue-chip , good , Average and Poor if client in Pure risk and Blue-chip, Good , Average if client in projected risk.   
 <br/><br/>3. If there is only projected risk then the cap of fetching of shares will be done above Rs.500 and if there is pure risk then there will be cap of Rs.100 for fetching of shares which will be done to the extent of pure +projected risk value.  

 <br/><br/>4. Shares fetching will not be done in this process if there is no Pure and projected risk.   
 <br/><br/>5. Regions/Branches and SBs can see the reports on daily basis in NRMS - >Risk Manager - > Var Margin Report -> DP POA Shares Movement- with every details given below:   
 <br/><br/>6. SMS logs report will also be available to all users on daily basis.'  
       
                                                 
  SET @SQL = @SQL + '<br/><br/><br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                                
                    
  DECLARE @s varchar(500)                                                          
  SET @s = @filename1 + ';' + @filename2                                               
                    
  EXEC msdb.dbo.sp_send_dbmail            
  @profile_name = 'Square',                                    
  @recipients= 'anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;rajendra.tiwari@angelbroking.com;vilasnaram@angelbroking.com;',                                                
  @copy_recipients= 'renil.pillai@angelbroking.com;vishal@angelbroking.com;csorm@angelbroking.com;mgs.abha@angelbroking.com;',                  
   --@blind_copy_recipients= @BCC,                                                
  @body= @SQL,                                                
  @file_attachments= @s,                                                
  @body_format= 'HTML',                                                  
  @subject='Shares fetching to the extent of pure + projected risk value'                                           
                                       
End try                                                                     
BEGIN CATCH                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                               
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                              
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                 
                                                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pure_Risk_DP_Adj_file_mail_bkup_01072020
-- --------------------------------------------------


     
CREATE Procedure [dbo].[Pure_Risk_DP_Adj_file_mail_bkup_01072020]                                      
as                                      
                                              
SET XACT_ABORT ON                                              
Set nocount on                                              
 BEGIN TRY                                                                      
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                                    
         
  --alter table VMSS_PURERISK_DPHOLDING add FromAcc varchar(20),ToAcc varchar(20),ToSegment varchar(20)       
           
  /*update VMSS_PURERISK_DPHOLDING set Tosegment=b.segment from Pure_RiskClients_ActiveSeg_Details b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code */  
 /* Added on Aug 23 2016 as discussed with vishal and Renil SIr to check client is having account in  BSE and NSE*/ 
 --delete from VMSS_PURERISK_DPHOLDING where isin='INE075A01022'
   
  select distinct A.party_code,Exchange,Segment into #temp  from  VMSS_PURERISK_DPHOLDING A inner join  anand1.msajag.dbo.client_brok_details  B on A.party_code=B.cl_code  
  where  ( exchange in ('BSE','NSE') and segment in('CAPITAL'))  
  
 select * into #temp2  
 from   
 (  
   select party_code,Exchange,Segment  
   from #temp  
 ) src  
 pivot  
 (  
   max(Exchange)  
   for Exchange in ([BSE],[NSE])  
 ) piv;  
  
  
 update VMSS_PURERISK_DPHOLDING set Tosegment=case when b.BSE='BSE' and b.NSE='NSE' then 'NSECM'   
                                                    when b.BSE='BSE' and b.NSE is null  then 'BSECM'  
                                                    when b.NSE='NSE'  and b.BSE is null then 'NSECM'  else '' end  
 from #temp2 b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code  
  
                                       
  --and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                                      
                  
  /************************************************************************/                                      
  update VMSS_PURERISK_DPHOLDING set toacc= case                                       
  /*        
  when tosegment= 'NSECM' then '1203320000000051'                                      
  when tosegment= 'BSECM' then '1203320000000066'               
  */        
  when tosegment= 'NSECM' then '1203320018512938'                                      
  when tosegment= 'BSECM' then '1203320009603460'               
  ELSE '' END                                      
  --where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                                      
                  
  update VMSS_PURERISK_DPHOLDING set fromacc=Cltdpid   from general.dbo.dp_holding A  where  VMSS_PURERISK_DPHOLDING.party_code=A.party_code                            
                            
                  
  /*****************************/                                      
  --history updation                                      
 --select  top 1 * from VMSS_PURERISK_DPHOLDING      
 --select  top 1 *  from vmss_DP_holding      
 --select * from VMSS_PURERISK_DPHOLDING where cast(process_date as date)=cast('May 10 2016' as date)  and total_adj=348025.70      
            --select * into VMSS_PURERISK_DPHOLDING_hist from VMSS_PURERISK_DPHOLDING where 1=2      
            /*      
  delete from VMSS_PURERISK_DPHOLDING_hist where HoldDate =(select Max(processDate) from VMSS_data)                              
                  
  insert into VMSS_PURERISK_DPHOLDING_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                                
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                                 
  from VMSS_PURERISK_DPHOLDING where SqOffQty > 0    
      */     
                
  truncate table PURE_RISK_JV_DP_file                                
  select party_code,scrip_cd,series='BSE',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                             
  when len(fromacc)<16 then 'IN301549' else ''  end,                                            
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             
  when len(toacc)<16 then 'IN301549' else ''  end,                                            
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                            
  from VMSS_PURERISK_DPHOLDING where                                              
 -- sqoffseq > 0 and HoldDate =(select Max(processDate) from VMSS_data)                                            
   TOSEGMENT='BSECM'                                            
                  
  INSERT INTO #JVDATA                                            
  select party_code,scrip_cd,series='',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)              
  when len(fromacc)<16 then 'IN301549' else ''  end,                                            
  fromacc,                                        
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             
  when len(toacc)<16 then 'IN301549' else ''  end,                                            
  toacc,type1='BTM',TOSEGMENT from VMSS_PURERISK_DPHOLDING where                                            
 -- sqoffseq > 0   and HoldDate =(select Max(processDate) from VMSS_data)                                            
   TOSEGMENT='NSECM'    
     
     
   /*To delete corp action clients added on July 20 2017*/     
  --select *  from #JVDATA where isin in (  
  --select distinct isin from VMSS_PURERISK_DPHOLDING A inner join  [196.1.115.239].CommonMaster.dbo.Corp_action B with (nolock) on A.isin=b.Sca_ISIN  
  --where cast(Sca_Ex_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '') -- and cast(Sca_BCFrom_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '')  
  --)    
  
  
  select distinct Sca_ISIN,Sca_Ex_Dt into #TEMP_ISIN from [196.1.115.239].CommonMaster.dbo.Corp_action A with (nolock)  where  Sca_CatCode<>'D'  
  and cast(Sca_Ex_Dt as date)<=cast(getdate()+2 as date) and cast(Sca_Ex_Dt as date)>=cast(getdate()-2 as date) order by Sca_Ex_Dt desc  
   
  delete from #JVDATA where isin in (  
  select distinct isin from VMSS_PURERISK_DPHOLDING A inner join #TEMP_ISIN B with (nolock) on A.isin=b.Sca_ISIN  
  )                                          
       
        
  truncate table PURE_RISK_JV_DP_file                                
                  
  insert into PURE_RISK_JV_DP_file                                           
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                          
  from #JVDATA                                          
                  
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                         
                  
  DECLARE @file1 AS VARCHAR(100)                                              
  DECLARE @file2 AS VARCHAR(100)                         
  DECLARE @i AS INT                                            
  DECLARE @str VARCHAR(8000)                                             
  declare @segment varchar(10)                                        
                
  DECLARE @fileCnt as int                    
  DECLARE @RowCnt int,@FileName as varchar(500)                  
                    
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                  
                    
  DECLARE @SQL VARCHAR(MAX)                                                
  SET @SQL = '' 
                    
 CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))                  
  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))                  
                
   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/                  
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   
                    
  SET @RowCnt = (SELECT COUNT(*)as a FROM #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')                   
  SET @FileName=''                  
                    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  
                    
  PRINT @FileName                  
            
  TRUNCATE TABLE FileData            
                      
  INSERT INTO FileData                
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               
                    
  INSERT INTO FileData                                            
  SELECT  '<Tp>5</Tp>'+            
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                               
  FROM   #JVDATAFILE a (nolock)                                    
  WHERE tosegment = 'BSECM'                 
                
    /*                  
  INSERT INTO FileData_rohit_23092015                                          
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse                   
  */                  
                                                 
  SET @SQL = ''                                                
              
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                           
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '   */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                    
  SET @SQL = '''' + @SQL + ''''                                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                
  PRINT @SQL                                                
  EXEC (@SQL)                    
                        
  /*Used For Unix formated Data*/                  
  /*exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName*/ 
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                   
                    
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                   
                    
  /*SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName */ 
  SET @filename1='H:\MindGate\UploadJVCollateral\'+ @FileName                  
                     
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/                      
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/                  
                      
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   
                    
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')                   
  SET @FileName=''                  
                    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  
                    
  PRINT @FileName                  
                    
  TRUNCATE TABLE FileData              
                      
  INSERT INTO FileData              
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               
                      
  INSERT INTO FileData                                          
  SELECT  '<Tp>5</Tp>'+            
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                              
  FROM   #JVDATAFILE a (nolock)                                    
  WHERE tosegment = 'NSECM'                   
                       
                    
  /*                  
  INSERT INTO FileData_rohit_23092015                                          
  select DATA from #VMSS_JVCEColl_tblfile_nse                   
  */                                                  
                    
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                           
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 ' */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                   
  SET @SQL = '''' + @SQL + ''''                                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                
  PRINT @SQL                                                
  EXEC (@SQL)                      
                        
  /*Used For Unix formated Data*/                  
  /*exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName  */
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                    
             
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                    
                     
  /*SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName*/                  
  SET @filename2='H:\MindGate\UploadJVCollateral\'+ @FileName                    
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/                    
      
  SET @SQL =''                 
  SET @SQL = 'Dear Team,<br/><br/>'                                                
  SET @SQL = @SQL + 'Please find the attached file for (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') with criteria for shares fetching as given below:    
  

 <br/><br/>1. Shares fetching is done only when client is in continous projected + pure  risk for 5 days.  
 <br/><br/>2. Codes considered for shares fetching to the extent of pure + projected risk value . Sequence will be Blue-chip , good , Average and Poor if client in Pure risk and Blue-chip, Good , Average if client in projected risk.   
 <br/><br/>3. If there is only projected risk then the cap of fetching of shares will be done above Rs.500 and if there is pure risk then there will be cap of Rs.100 for fetching of shares which will be done to the extent of pure +projected risk value.  


 <br/><br/>4. Shares fetching will not be done in this process if there is no Pure and projected risk.   
 <br/><br/>5. Regions/Branches and SBs can see the reports on daily basis in NRMS - >Risk Manager - > Var Margin Report -> DP POA Shares Movement- with every details given below:   
 <br/><br/>6. SMS logs report will also be available to all users on daily basis.'  
       
                                                 
  SET @SQL = @SQL + '<br/><br/><br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                                
                    
  DECLARE @s varchar(500)                                                          
  SET @s = @filename1 + ';' + @filename2                                               
                    
  EXEC msdb.dbo.sp_send_dbmail            
  @profile_name = 'Square',                                    
  @recipients= 'anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;datta.gurav@angelbroking.com;vijay.agre@angelbroking.com;vilasnaram@angelbroking.com;',                                                
  @copy_recipients= 'vishal@angelbroking.com;csorm@angelbroking.com;',                  
   --@blind_copy_recipients= @BCC,                                                
  @body= @SQL,                                                
  @file_attachments= @s,                                                
  @body_format= 'HTML',                                                  
  @subject='Shares fetching to the extent of pure + projected risk value'  
  
  exec general.dbo.USP_ALL_SQOFF_JOB_SUMMARY                                         
                                       
End try                                                                     
BEGIN CATCH                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                               
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                              
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                 
                                                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pure_Risk_DP_Adj_file_mail_bkup_22122022
-- --------------------------------------------------


     
CREATE Procedure [dbo].[Pure_Risk_DP_Adj_file_mail_bkup_22122022]                                      
as                                      
                                              
SET XACT_ABORT ON                                              
Set nocount on                                              
 BEGIN TRY                                                                      
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                                    
         
  --alter table VMSS_PURERISK_DPHOLDING add FromAcc varchar(20),ToAcc varchar(20),ToSegment varchar(20)       
           
  /*update VMSS_PURERISK_DPHOLDING set Tosegment=b.segment from Pure_RiskClients_ActiveSeg_Details b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code */  
 /* Added on Aug 23 2016 as discussed with vishal and Renil SIr to check client is having account in  BSE and NSE*/ 
 --delete from VMSS_PURERISK_DPHOLDING where isin='INE075A01022'
   
  select distinct A.party_code,Exchange,Segment into #temp  from  VMSS_PURERISK_DPHOLDING A inner join  anand1.msajag.dbo.client_brok_details  B on A.party_code=B.cl_code  
  where  ( exchange in ('BSE','NSE') and segment in('CAPITAL'))  
  
 select * into #temp2  
 from   
 (  
   select party_code,Exchange,Segment  
   from #temp  
 ) src  
 pivot  
 (  
   max(Exchange)  
   for Exchange in ([BSE],[NSE])  
 ) piv;  
  
  
 update VMSS_PURERISK_DPHOLDING set Tosegment=case when b.BSE='BSE' and b.NSE='NSE' then 'NSECM'   
                                                    when b.BSE='BSE' and b.NSE is null  then 'BSECM'  
                                                    when b.NSE='NSE'  and b.BSE is null then 'NSECM'  else '' end  
 from #temp2 b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code  
  
                                       
  --and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                                      
                  
  /************************************************************************/                                      
  update VMSS_PURERISK_DPHOLDING set toacc= case                                       
  /*        
  when tosegment= 'NSECM' then '1203320000000051'                                      
  when tosegment= 'BSECM' then '1203320000000066'               
  */        
  when tosegment= 'NSECM' then '1203320018512938'                                      
  when tosegment= 'BSECM' then '1203320009603460'               
  ELSE '' END                                      
  --where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                                      
                  
  update VMSS_PURERISK_DPHOLDING set fromacc=Cltdpid   from general.dbo.dp_holding A  where  VMSS_PURERISK_DPHOLDING.party_code=A.party_code                            
                            
                  
  /*****************************/                                      
  --history updation                                      
 --select  top 1 * from VMSS_PURERISK_DPHOLDING      
 --select  top 1 *  from vmss_DP_holding      
 --select * from VMSS_PURERISK_DPHOLDING where cast(process_date as date)=cast('May 10 2016' as date)  and total_adj=348025.70      
            --select * into VMSS_PURERISK_DPHOLDING_hist from VMSS_PURERISK_DPHOLDING where 1=2      
            /*      
  delete from VMSS_PURERISK_DPHOLDING_hist where HoldDate =(select Max(processDate) from VMSS_data)                              
                  
  insert into VMSS_PURERISK_DPHOLDING_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                                
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                                 
  from VMSS_PURERISK_DPHOLDING where SqOffQty > 0    
      */     
                
  truncate table PURE_RISK_JV_DP_file                                
  select party_code,scrip_cd,series='BSE',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                             
  when len(fromacc)<16 then 'IN301549' else ''  end,                                            
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             
  when len(toacc)<16 then 'IN301549' else ''  end,                                            
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                            
  from VMSS_PURERISK_DPHOLDING where                                              
 -- sqoffseq > 0 and HoldDate =(select Max(processDate) from VMSS_data)                                            
   TOSEGMENT='BSECM'                                            
                  
  INSERT INTO #JVDATA                                            
  select party_code,scrip_cd,series='',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)              
  when len(fromacc)<16 then 'IN301549' else ''  end,                                            
  fromacc,                                        
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             
  when len(toacc)<16 then 'IN301549' else ''  end,                                            
  toacc,type1='BTM',TOSEGMENT from VMSS_PURERISK_DPHOLDING where                                            
 -- sqoffseq > 0   and HoldDate =(select Max(processDate) from VMSS_data)                                            
   TOSEGMENT='NSECM'    
     
     
   /*To delete corp action clients added on July 20 2017*/     
  --select *  from #JVDATA where isin in (  
  --select distinct isin from VMSS_PURERISK_DPHOLDING A inner join  [196.1.115.239].CommonMaster.dbo.Corp_action B with (nolock) on A.isin=b.Sca_ISIN  
  --where cast(Sca_Ex_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '') -- and cast(Sca_BCFrom_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '')  
  --)    
  
  
  select distinct Sca_ISIN,Sca_Ex_Dt into #TEMP_ISIN from [196.1.115.239].CommonMaster.dbo.Corp_action A with (nolock)  where  Sca_CatCode<>'D'  
  and cast(Sca_Ex_Dt as date)<=cast(getdate()+2 as date) and cast(Sca_Ex_Dt as date)>=cast(getdate()-2 as date) order by Sca_Ex_Dt desc  
   
  delete from #JVDATA where isin in (  
  select distinct isin from VMSS_PURERISK_DPHOLDING A inner join #TEMP_ISIN B with (nolock) on A.isin=b.Sca_ISIN  
  )                                          
       
        
  truncate table PURE_RISK_JV_DP_file                                
                  
  insert into PURE_RISK_JV_DP_file                                           
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                          
  from #JVDATA                                          
                  
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                         
                  
  DECLARE @file1 AS VARCHAR(100)                                              
  DECLARE @file2 AS VARCHAR(100)                         
  DECLARE @i AS INT                                            
  DECLARE @str VARCHAR(8000)                                             
  declare @segment varchar(10)                                        
                
  DECLARE @fileCnt as int                    
  DECLARE @RowCnt int,@FileName as varchar(500)                  
                    
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                  
                    
  DECLARE @SQL VARCHAR(MAX)                                                
  SET @SQL = '' 
                    
 CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))                  
  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))                  
                
   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/                  
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   
                    
  SET @RowCnt = (SELECT COUNT(*)as a FROM #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')                   
  SET @FileName=''                  
                    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  
                    
  PRINT @FileName                  
            
  TRUNCATE TABLE FileData            
                      
  INSERT INTO FileData                
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               
                    
  INSERT INTO FileData                                            
  SELECT  '<Tp>5</Tp>'+            
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>14</Rsn>'+                              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf><Conamt>0</Conamt>'                               
  FROM   #JVDATAFILE a (nolock)                                    
  WHERE tosegment = 'BSECM'                 
                
    /*                  
  INSERT INTO FileData_rohit_23092015                                          
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse                   
  */                  
                                                 
  SET @SQL = ''                                                
              
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                           
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '   */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                    
  SET @SQL = '''' + @SQL + ''''                                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                
  PRINT @SQL                                                
  EXEC (@SQL)                    
                        
  /*Used For Unix formated Data*/                  
  /*exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName*/ 
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                   
                    
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                   
                    
  /*SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName */ 
  SET @filename1='H:\MindGate\UploadJVCollateral\'+ @FileName                  
                     
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/                      
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/                  
                      
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   
                    
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')                   
  SET @FileName=''                  
                    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  
                    
  PRINT @FileName                  
                    
  TRUNCATE TABLE FileData              
                      
  INSERT INTO FileData              
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               
                      
  INSERT INTO FileData                                          
  SELECT  '<Tp>5</Tp>'+            
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>14</Rsn>'+                              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf><Conamt>0</Conamt>'                              
  FROM   #JVDATAFILE a (nolock)                                    
  WHERE tosegment = 'NSECM'                   
                       
                    
  /*                  
  INSERT INTO FileData_rohit_23092015                                          
  select DATA from #VMSS_JVCEColl_tblfile_nse                   
  */                                                  
                    
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                           
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 ' */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                   
  SET @SQL = '''' + @SQL + ''''                                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                
  PRINT @SQL                                                
  EXEC (@SQL)                      
                        
  /*Used For Unix formated Data*/                  
  /*exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName  */
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                    
             
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                    
                     
  /*SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName*/                  
  SET @filename2='H:\MindGate\UploadJVCollateral\'+ @FileName                    
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/                    
      
  SET @SQL =''                 
  SET @SQL = 'Dear Team,<br/><br/>'                                                
  SET @SQL = @SQL + 'Please find the attached file for (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') with criteria for shares fetching as given below:    
  

 <br/><br/>1. Shares fetching is done only when client is in continous projected + pure  risk for 5 days.  
 <br/><br/>2. Codes considered for shares fetching to the extent of pure + projected risk value . Sequence will be Blue-chip , good , Average and Poor if client in Pure risk and Blue-chip, Good , Average if client in projected risk.   
 <br/><br/>3. If there is only projected risk then the cap of fetching of shares will be done above Rs.500 and if there is pure risk then there will be cap of Rs.100 for fetching of shares which will be done to the extent of pure +projected risk value.  


 <br/><br/>4. Shares fetching will not be done in this process if there is no Pure and projected risk.   
 <br/><br/>5. Regions/Branches and SBs can see the reports on daily basis in NRMS - >Risk Manager - > Var Margin Report -> DP POA Shares Movement- with every details given below:   
 <br/><br/>6. SMS logs report will also be available to all users on daily basis.'  
       
                                                 
  SET @SQL = @SQL + '<br/><br/><br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                                
                    
  DECLARE @s varchar(500)                                                          
  SET @s = @filename1 + ';' + @filename2                                               
                    
  EXEC msdb.dbo.sp_send_dbmail            
  @profile_name = 'Square',                                    
  @recipients= 'anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;datta.gurav@angelbroking.com;vijay.agre@angelbroking.com;vilasnaram@angelbroking.com;',                                                
  @copy_recipients= 'vishal@angelbroking.com;csorm@angelbroking.com;',                  
   --@blind_copy_recipients= @BCC,                                                
  @body= @SQL,                                                
  @file_attachments= @s,                                                
  @body_format= 'HTML',                                                  
  @subject='Shares fetching to the extent of pure + projected risk value'  
  
  exec general.dbo.USP_ALL_SQOFF_JOB_SUMMARY                                         
                                       
End try                                                                     
BEGIN CATCH                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                               
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                              
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                 
                                                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pure_Risk_DP_Adj_file_mail_bkup_26082019
-- --------------------------------------------------

     
CREATE Procedure [dbo].[Pure_Risk_DP_Adj_file_mail_bkup_26082019]                                      
as                                      
                                              
SET XACT_ABORT ON                                              
Set nocount on                                              
 BEGIN TRY                                                                      
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                                    
         
  --alter table VMSS_PURERISK_DPHOLDING add FromAcc varchar(20),ToAcc varchar(20),ToSegment varchar(20)       
           
  /*update VMSS_PURERISK_DPHOLDING set Tosegment=b.segment from Pure_RiskClients_ActiveSeg_Details b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code */  
 /* Added on Aug 23 2016 as discussed with vishal and Renil SIr to check client is having account in  BSE and NSE*/   
  select distinct A.party_code,Exchange,Segment into #temp  from  VMSS_PURERISK_DPHOLDING A inner join  anand1.msajag.dbo.client_brok_details  B on A.party_code=B.cl_code  
  where  ( exchange in ('BSE','NSE') and segment in('CAPITAL'))  
  
 select * into #temp2  
 from   
 (  
   select party_code,Exchange,Segment  
   from #temp  
 ) src  
 pivot  
 (  
   max(Exchange)  
   for Exchange in ([BSE],[NSE])  
 ) piv;  
  
  
 update VMSS_PURERISK_DPHOLDING set Tosegment=case when b.BSE='BSE' and b.NSE='NSE' then 'NSECM'   
                                                    when b.BSE='BSE' and b.NSE is null  then 'BSECM'  
                                                    when b.NSE='NSE'  and b.BSE is null then 'NSECM'  else '' end  
 from #temp2 b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code  
  
                                       
  --and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                                      
                  
  /************************************************************************/                                      
  update VMSS_PURERISK_DPHOLDING set toacc= case                                       
  /*        
  when tosegment= 'NSECM' then '1203320000000051'                                      
  when tosegment= 'BSECM' then '1203320000000066'               
  */        
  when tosegment= 'NSECM' then '1203320000000028'                                      
  when tosegment= 'BSECM' then '1203320009603460'               
  ELSE '' END                                      
  --where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                                      
                  
  update VMSS_PURERISK_DPHOLDING set fromacc=Cltdpid   from general.dbo.dp_holding A  where  VMSS_PURERISK_DPHOLDING.party_code=A.party_code                            
                            
                  
  /*****************************/                                      
  --history updation                                      
 --select  top 1 * from VMSS_PURERISK_DPHOLDING      
 --select  top 1 *  from vmss_DP_holding      
 --select * from VMSS_PURERISK_DPHOLDING where cast(process_date as date)=cast('May 10 2016' as date)  and total_adj=348025.70      
            --select * into VMSS_PURERISK_DPHOLDING_hist from VMSS_PURERISK_DPHOLDING where 1=2      
            /*      
  delete from VMSS_PURERISK_DPHOLDING_hist where HoldDate =(select Max(processDate) from VMSS_data)                              
                  
  insert into VMSS_PURERISK_DPHOLDING_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                                
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                                 
  from VMSS_PURERISK_DPHOLDING where SqOffQty > 0    
      */     
                
  truncate table PURE_RISK_JV_DP_file                                
  select party_code,scrip_cd,series='BSE',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                             
  when len(fromacc)<16 then 'IN301549' else ''  end,                                            
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             
  when len(toacc)<16 then 'IN301549' else ''  end,                                            
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                            
  from VMSS_PURERISK_DPHOLDING where                                              
 -- sqoffseq > 0 and HoldDate =(select Max(processDate) from VMSS_data)                                            
   TOSEGMENT='BSECM'                                            
                  
  INSERT INTO #JVDATA                                            
  select party_code,scrip_cd,series='',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)              
  when len(fromacc)<16 then 'IN301549' else ''  end,                                            
  fromacc,                                        
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             
  when len(toacc)<16 then 'IN301549' else ''  end,                                            
  toacc,type1='BTM',TOSEGMENT from VMSS_PURERISK_DPHOLDING where                                            
 -- sqoffseq > 0   and HoldDate =(select Max(processDate) from VMSS_data)                                            
   TOSEGMENT='NSECM'    
     
     
   /*To delete corp action clients added on July 20 2017*/     
  --select *  from #JVDATA where isin in (  
  --select distinct isin from VMSS_PURERISK_DPHOLDING A inner join  [196.1.115.239].CommonMaster.dbo.Corp_action B with (nolock) on A.isin=b.Sca_ISIN  
  --where cast(Sca_Ex_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '') -- and cast(Sca_BCFrom_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '')  
  --)    
  
  
  select distinct Sca_ISIN,Sca_Ex_Dt into #TEMP_ISIN from [196.1.115.239].CommonMaster.dbo.Corp_action A with (nolock)  where  Sca_CatCode<>'D'  
  and cast(Sca_Ex_Dt as date)<=cast(getdate()+2 as date) and cast(Sca_Ex_Dt as date)>=cast(getdate()-2 as date) order by Sca_Ex_Dt desc  
   
  delete from #JVDATA where isin in (  
  select distinct isin from VMSS_PURERISK_DPHOLDING A inner join #TEMP_ISIN B with (nolock) on A.isin=b.Sca_ISIN  
  )                                          
       
        
  truncate table PURE_RISK_JV_DP_file                                
                  
  insert into PURE_RISK_JV_DP_file                                           
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                          
  from #JVDATA                                          
                  
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                         
                  
  DECLARE @file1 AS VARCHAR(100)                                              
  DECLARE @file2 AS VARCHAR(100)                         
  DECLARE @i AS INT                                            
  DECLARE @str VARCHAR(8000)                                             
  declare @segment varchar(10)                                        
                
  DECLARE @fileCnt as int                    
  DECLARE @RowCnt int,@FileName as varchar(500)                  
                    
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                  
                    
  DECLARE @SQL VARCHAR(MAX)                                                
  SET @SQL = '' 
                    
 CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))                  
  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))                  
                
   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/                  
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   
                    
  SET @RowCnt = (SELECT COUNT(*)as a FROM #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')                   
  SET @FileName=''                  
                    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  
                    
  PRINT @FileName                  
            
  TRUNCATE TABLE FileData            
                      
  INSERT INTO FileData                
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               
                    
  INSERT INTO FileData                                            
  SELECT  '<Tp>5</Tp>'+            
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                               
  FROM   #JVDATAFILE a (nolock)                                    
  WHERE tosegment = 'BSECM'                 
                
    /*                  
  INSERT INTO FileData_rohit_23092015                                          
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse                   
  */                  
                                                 
  SET @SQL = ''                                                
              
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                           
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '   */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                    
  SET @SQL = '''' + @SQL + ''''                                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                
  PRINT @SQL                                                
  EXEC (@SQL)                    
                        
  /*Used For Unix formated Data*/                  
  /*exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName*/ 
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                   
                    
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                   
                    
  /*SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName */ 
  SET @filename1='H:\MindGate\UploadJVCollateral\'+ @FileName                  
                     
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/                      
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/                  
                      
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   
                    
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')                   
  SET @FileName=''                  
                    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  
                    
  PRINT @FileName                  
                    
  TRUNCATE TABLE FileData              
                      
  INSERT INTO FileData              
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               
                      
  INSERT INTO FileData                                          
  SELECT  '<Tp>5</Tp>'+            
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                              
  FROM   #JVDATAFILE a (nolock)                                    
  WHERE tosegment = 'NSECM'                   
                       
                    
  /*                  
  INSERT INTO FileData_rohit_23092015                                          
  select DATA from #VMSS_JVCEColl_tblfile_nse                   
  */                                                  
                    
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                           
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 ' */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                                   
  SET @SQL = '''' + @SQL + ''''                                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                
  PRINT @SQL                                                
  EXEC (@SQL)                      
                        
  /*Used For Unix formated Data*/                  
  /*exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName  */
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                    
             
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                    
                     
  /*SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName*/                  
  SET @filename2='H:\MindGate\UploadJVCollateral\'+ @FileName                    
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/                    
      
  SET @SQL =''                 
  SET @SQL = 'Dear Team,<br/><br/>'                                                
  SET @SQL = @SQL + 'Please find the attached file for (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') with criteria for shares fetching as given below:    
  

 <br/><br/>1. Shares fetching is done only when client is in continous projected + pure  risk for 5 days.  
 <br/><br/>2. Codes considered for shares fetching to the extent of pure + projected risk value . Sequence will be Blue-chip , good , Average and Poor if client in Pure risk and Blue-chip, Good , Average if client in projected risk.   
 <br/><br/>3. If there is only projected risk then the cap of fetching of shares will be done above Rs.500 and if there is pure risk then there will be cap of Rs.100 for fetching of shares which will be done to the extent of pure +projected risk value.  


 <br/><br/>4. Shares fetching will not be done in this process if there is no Pure and projected risk.   
 <br/><br/>5. Regions/Branches and SBs can see the reports on daily basis in NRMS - >Risk Manager - > Var Margin Report -> DP POA Shares Movement- with every details given below:   
 <br/><br/>6. SMS logs report will also be available to all users on daily basis.'  
       
                                                 
  SET @SQL = @SQL + '<br/><br/><br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                                
                    
  DECLARE @s varchar(500)                                                          
  SET @s = @filename1 + ';' + @filename2                                               
                    
  EXEC msdb.dbo.sp_send_dbmail            
  @profile_name = 'Square',                                    
  @recipients= 'anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;rajendra.tiwari@angelbroking.com;vilasnaram@angelbroking.com;',                                                
  @copy_recipients= 'renil.pillai@angelbroking.com;vishal@angelbroking.com;csorm@angelbroking.com;',                  
   --@blind_copy_recipients= @BCC,                                                
  @body= @SQL,                                                
  @file_attachments= @s,                                                
  @body_format= 'HTML',                                                  
  @subject='Shares fetching to the extent of pure + projected risk value'                                           
                                       
End try                                                                     
BEGIN CATCH                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                               
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                              
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                 
                                                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pure_Risk_DP_Adj_file_mail_corpAction
-- --------------------------------------------------
      
CREATE Procedure [dbo].[Pure_Risk_DP_Adj_file_mail_corpAction]                                    
as                                    
                                            
SET XACT_ABORT ON                                            
Set nocount on                                            
 BEGIN TRY                                                                    
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                                  
       
  --alter table VMSS_PURERISK_DPHOLDING add FromAcc varchar(20),ToAcc varchar(20),ToSegment varchar(20)     
         
  /*update VMSS_PURERISK_DPHOLDING set Tosegment=b.segment from Pure_RiskClients_ActiveSeg_Details b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code */
 /* Added on Aug 23 2016 as discussed with vishal and Renil SIr to check client is having account in  BSE and NSE*/ 
  select distinct A.party_code,Exchange,Segment into #temp  from  VMSS_PURERISK_DPHOLDING A inner join  anand1.msajag.dbo.client_brok_details  B on A.party_code=B.cl_code
  where  ( exchange in ('BSE','NSE') and segment in('CAPITAL'))

	select * into #temp2
	from 
	(
	  select party_code,Exchange,Segment
	  from #temp
	) src
	pivot
	(
	  max(Exchange)
	  for Exchange in ([BSE],[NSE])
	) piv;


 update VMSS_PURERISK_DPHOLDING set Tosegment=case when b.BSE='BSE' and b.NSE='NSE' then 'BSECM' 
                                                    when b.BSE='BSE' and b.NSE is null  then 'BSECM'
                                                    when b.NSE='NSE'  and b.BSE is null then 'NSECM'  else '' end
 from #temp2 b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code

                                     
  --and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                                    
                
  /************************************************************************/                                    
  update VMSS_PURERISK_DPHOLDING set toacc= case                                     
  /*      
  when tosegment= 'NSECM' then '1203320000000051'                                    
  when tosegment= 'BSECM' then '1203320000000066'             
  */      
  when tosegment= 'NSECM' then '1203320000000028'                                    
  when tosegment= 'BSECM' then '1203320009603460'             
  ELSE '' END                                    
  --where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                                    
                
  update VMSS_PURERISK_DPHOLDING set fromacc=Cltdpid   from general.dbo.dp_holding A  where  VMSS_PURERISK_DPHOLDING.party_code=A.party_code                          
                          
                
  /*****************************/                                    
  --history updation                                    
 --select  top 1 * from VMSS_PURERISK_DPHOLDING    
 --select  top 1 *  from vmss_DP_holding    
 --select * from VMSS_PURERISK_DPHOLDING where cast(process_date as date)=cast('May 10 2016' as date)  and total_adj=348025.70    
            --select * into VMSS_PURERISK_DPHOLDING_hist from VMSS_PURERISK_DPHOLDING where 1=2    
            /*    
  delete from VMSS_PURERISK_DPHOLDING_hist where HoldDate =(select Max(processDate) from VMSS_data)                            
                
  insert into VMSS_PURERISK_DPHOLDING_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                              
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                               
  from VMSS_PURERISK_DPHOLDING where SqOffQty > 0                              
      */   
              
  truncate table PURE_RISK_JV_DP_file                              
  select party_code,scrip_cd,series='BSE',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                           
  when len(fromacc)<16 then 'IN301549' else ''  end,                                          
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                           
  when len(toacc)<16 then 'IN301549' else ''  end,                                          
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                          
  from VMSS_PURERISK_DPHOLDING where                                            
 -- sqoffseq > 0 and HoldDate =(select Max(processDate) from VMSS_data)                                          
   TOSEGMENT='BSECM'                                          
                
  INSERT INTO #JVDATA                                          
  select party_code,scrip_cd,series='',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)            
  when len(fromacc)<16 then 'IN301549' else ''  end,                                          
  fromacc,                                      
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                           
  when len(toacc)<16 then 'IN301549' else ''  end,                                          
  toacc,type1='BTM',TOSEGMENT from VMSS_PURERISK_DPHOLDING where                                          
 -- sqoffseq > 0   and HoldDate =(select Max(processDate) from VMSS_data)                                          
   TOSEGMENT='NSECM'  
   
   
   /*To delete corp action clients added on July 20 2017*/   
  --select *  from #JVDATA where isin in (
  --select distinct isin from VMSS_PURERISK_DPHOLDING A inner join  [196.1.115.239].CommonMaster.dbo.Corp_action B with (nolock) on A.isin=b.Sca_ISIN
  --where cast(Sca_Ex_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '') -- and cast(Sca_BCFrom_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '')
  --)  


  select distinct Sca_ISIN,Sca_Ex_Dt into #TEMP_ISIN from [196.1.115.239].CommonMaster.dbo.Corp_action A with (nolock)  where  Sca_CatCode<>'D'
  and cast(Sca_Ex_Dt as date)<=cast(getdate()+2 as date) and cast(Sca_Ex_Dt as date)>=cast(getdate()-2 as date) order by Sca_Ex_Dt desc
 
  delete from #JVDATA where isin in (
  select distinct isin from VMSS_PURERISK_DPHOLDING A inner join #TEMP_ISIN B with (nolock) on A.isin=b.Sca_ISIN
  )                                        
     
      
  truncate table PURE_RISK_JV_DP_file                              
                
  insert into PURE_RISK_JV_DP_file                                         
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                        
  from #JVDATA                                        
                
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                       
                
  DECLARE @file1 AS VARCHAR(100)                                            
  DECLARE @file2 AS VARCHAR(100)                       
  DECLARE @i AS INT                                          
  DECLARE @str VARCHAR(8000)                                           
  declare @segment varchar(10)                                      
              
  DECLARE @fileCnt as int                  
  DECLARE @RowCnt int,@FileName as varchar(500)                
                  
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                
                  
  DECLARE @SQL VARCHAR(MAX)                                              
  SET @SQL = ''                
                  
  CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))                
  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))                
              
   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/                
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                 
                  
  SET @RowCnt = (SELECT COUNT(*)as a FROM #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')                 
  SET @FileName=''                
                  
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                
                  
  PRINT @FileName                
          
  TRUNCATE TABLE FileData          
                    
  INSERT INTO FileData              
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                 
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                             
                  
  INSERT INTO FileData                                          
  SELECT  '<Tp>5</Tp>'+          
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+          
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'          
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                             
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                             
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                            
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                            
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                            
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                            
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                             
  FROM   #JVDATAFILE a (nolock)                                  
  WHERE tosegment = 'BSECM'               
              
    /*                
  INSERT INTO FileData_rohit_23092015                                        
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse                 
  */                
                                               
  SET @SQL = ''                                              
            
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                         
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '                                                 
  SET @SQL = '''' + @SQL + ''''                                              
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                              
  PRINT @SQL                                              
  EXEC (@SQL)                  
                      
  /*Used For Unix formated Data*/                
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                
                  
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                 
                  
  SET @filename1='H:\MindGate\UploadJVCollateral\'+ @FileName                
                   
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/                    
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/                
                    
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                 
                  
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')                 
  SET @FileName=''                
                  
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                
                  
  PRINT @FileName                
                  
  TRUNCATE TABLE FileData            
                    
  INSERT INTO FileData            
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                 
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                             
                    
  INSERT INTO FileData                                        
  SELECT  '<Tp>5</Tp>'+          
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+          
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'          
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                             
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                             
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                            
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                            
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                            
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                            
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                            
  FROM   #JVDATAFILE a (nolock)                                  
  WHERE tosegment = 'NSECM'                 
                     
                  
  /*                
  INSERT INTO FileData_rohit_23092015                                        
  select DATA from #VMSS_JVCEColl_tblfile_nse                 
  */                                                
                  
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                         
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '                                                 
  SET @SQL = '''' + @SQL + ''''                                                SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                              
  PRINT @SQL                                              
  EXEC (@SQL)                    
                      
  /*Used For Unix formated Data*/                
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                 
           
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                  
                   
  SET @filename2='H:\MindGate\UploadJVCollateral\'+ @FileName                
                    
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/                  
    
  SET @SQL =''                  
  SET @SQL = 'Dear Team,<br/><br/>'                                              
  SET @SQL = @SQL + 'Please find the attached file for (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') with criteria for shares fetching as given below:  

	<br/><br/>1.	Codes considered for shares fetching to the extent of pure + projected risk value . Sequence will be Blue-chip , good , Average and Poor if client in Pure risk and Blue-chip, Good , Average if client in projected risk. 
	<br/><br/>2.	If there is only projected risk then the cap of fetching of shares will be done above Rs.500 and if there is pure risk then there will be cap of Rs.100 for fetching of shares which will be done to the extent of pure +projected risk value.
	<br/><br/>3.	Shares fetching will not be done in this process if there is no Pure and projected risk. 
	<br/><br/>4.	Regions/Branches and SBs can see the reports on daily basis in NRMS - >Risk Manager - > Var Margin Report -> DP POA Shares Movement- with every details given below: 
	<br/><br/>5.	SMS logs report will also be available to all users on daily basis.'
	    
                                               
  SET @SQL = @SQL + '<br/><br/><br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                              
                  
  DECLARE @s varchar(500)                                                        
  SET @s = @filename1 + ';' + @filename2                                             
                  
  EXEC msdb.dbo.sp_send_dbmail          
  @profile_name = 'Square',                                  
  @recipients= 'anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;rajendra.tiwari@angelbroking.com;vilasnaram@angelbroking.com;',                                              
  @copy_recipients= 'renil.pillai@angelbroking.com;vishal@angelbroking.com;csorm@angelbroking.com;mgs.abha@angelbroking.com;',                
   --@blind_copy_recipients= @BCC,                                              
  @body= @SQL,                                              
  @file_attachments= @s,                                              
  @body_format= 'HTML',                                                
  @subject='Shares fetching to the extent of pure + projected risk value'                                         
                                     
End try                                                                   
BEGIN CATCH                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                             
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                            
  DECLARE @ErrorMessage NVARCHAR(4000);                                                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                              
  RAISERROR (@ErrorMessage , 16, 1);                                    
End catch                                               
                                              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Pure_Risk_DP_Adj_file_mail_newvishal
-- --------------------------------------------------
     

CREATE Procedure [dbo].[Pure_Risk_DP_Adj_file_mail_newvishal]                                      

as                                      

                                              

SET XACT_ABORT ON                                              

Set nocount on                                              

 BEGIN TRY                                                                      

  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                                    

         

  --alter table VMSS_PURERISK_DPHOLDING add FromAcc varchar(20),ToAcc varchar(20),ToSegment varchar(20)       

           

  /*update VMSS_PURERISK_DPHOLDING set Tosegment=b.segment from Pure_RiskClients_ActiveSeg_Details b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code */  

 /* Added on Aug 23 2016 as discussed with vishal and Renil SIr to check client is having account in  BSE and NSE*/   

  select distinct A.party_code,Exchange,Segment into #temp  from  VMSS_PURERISK_DPHOLDING A inner join  anand1.msajag.dbo.client_brok_details  B on A.party_code=B.cl_code  

  where  ( exchange in ('BSE','NSE') and segment in('CAPITAL'))  

  

 select * into #temp2  

 from   

 (  

   select party_code,Exchange,Segment  

   from #temp  

 ) src  

 pivot  

 (  

   max(Exchange)  

   for Exchange in ([BSE],[NSE])  

 ) piv;  

  

  

 update VMSS_PURERISK_DPHOLDING set Tosegment=case when b.BSE='BSE' and b.NSE='NSE' then 'NSECM'   

                                                    when b.BSE='BSE' and b.NSE is null  then 'BSECM'  

                                                    when b.NSE='NSE'  and b.BSE is null then 'NSECM'  else '' end  

 from #temp2 b where VMSS_PURERISK_DPHOLDING.party_code=b.party_code  

  

                                       

  --and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                                      

                  

  /************************************************************************/                                      

  update VMSS_PURERISK_DPHOLDING set toacc= case                                       

  /*        

  when tosegment= 'NSECM' then '1203320000000051'                                      

  when tosegment= 'BSECM' then '1203320000000066'               

  */        

  when tosegment= 'NSECM' then '1203320004574264'                                      

  when tosegment= 'BSECM' then '1203320009603460'               

  ELSE '' END                                      

  --where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                                      

                  

  update VMSS_PURERISK_DPHOLDING set fromacc=Cltdpid   from general.dbo.dp_holding A  where  VMSS_PURERISK_DPHOLDING.party_code=A.party_code                            

                            

                  

  /*****************************/                                      

  --history updation                                      

 --select  top 1 * from VMSS_PURERISK_DPHOLDING      

 --select  top 1 *  from vmss_DP_holding      

 --select * from VMSS_PURERISK_DPHOLDING where cast(process_date as date)=cast('May 10 2016' as date)  and total_adj=348025.70      

            --select * into VMSS_PURERISK_DPHOLDING_hist from VMSS_PURERISK_DPHOLDING where 1=2      

            /*      

  delete from VMSS_PURERISK_DPHOLDING_hist where HoldDate =(select Max(processDate) from VMSS_data)                              

                  

  insert into VMSS_PURERISK_DPHOLDING_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                                

  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                                 

  from VMSS_PURERISK_DPHOLDING where SqOffQty > 0    

      */     

             

  truncate table PURE_RISK_JV_DP_file                                

  select party_code,scrip_cd,series='BSE',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                             

  when len(fromacc)<16 then 'IN301549' else ''  end,                                            

  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             

  when len(toacc)<16 then 'IN301549' else ''  end,                                            

  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                            

  from VMSS_PURERISK_DPHOLDING where                                              

 -- sqoffseq > 0 and HoldDate =(select Max(processDate) from VMSS_data)                                            

   TOSEGMENT='BSECM'                                            

                  

  INSERT INTO #JVDATA                                            

  select party_code,scrip_cd,series='',isin,qty=Qty_adj,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)              

  when len(fromacc)<16 then 'IN301549' else ''  end,                                            

  fromacc,                                        

  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                             

  when len(toacc)<16 then 'IN301549' else ''  end,                                            

  toacc,type1='BTM',TOSEGMENT from VMSS_PURERISK_DPHOLDING where                                            

 -- sqoffseq > 0   and HoldDate =(select Max(processDate) from VMSS_data)                                            

   TOSEGMENT='NSECM'    

     

     

   /*To delete corp action clients added on July 20 2017*/     

  --select *  from #JVDATA where isin in (  

  --select distinct isin from VMSS_PURERISK_DPHOLDING A inner join  [196.1.115.239].CommonMaster.dbo.Corp_action B with (nolock) on A.isin=b.Sca_ISIN  

  --where cast(Sca_Ex_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '') -- and cast(Sca_BCFrom_Dt as date) between isnull(@dt1, '') and isnull(@dt2, '')  

  --)    

  

  

  select distinct Sca_ISIN,Sca_Ex_Dt into #TEMP_ISIN from [196.1.115.239].CommonMaster.dbo.Corp_action A with (nolock)  where  Sca_CatCode<>'D'  

  and cast(Sca_Ex_Dt as date)<=cast(getdate()+2 as date) and cast(Sca_Ex_Dt as date)>=cast(getdate()-2 as date) order by Sca_Ex_Dt desc  

   

  delete from #JVDATA where isin in (  

  select distinct isin from VMSS_PURERISK_DPHOLDING A inner join #TEMP_ISIN B with (nolock) on A.isin=b.Sca_ISIN  

  )                                          

       

        

  truncate table PURE_RISK_JV_DP_file                                

                  

  insert into PURE_RISK_JV_DP_file                                           

  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                          

  from #JVDATA                                          

                  

  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                         

                  

  DECLARE @file1 AS VARCHAR(100)                                              

  DECLARE @file2 AS VARCHAR(100)                         

  DECLARE @i AS INT                                            

  DECLARE @str VARCHAR(8000)                                             

  declare @segment varchar(10)                                        

                

  DECLARE @fileCnt as int                    

  DECLARE @RowCnt int,@FileName as varchar(500)                  

                    

  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                  

                    

  DECLARE @SQL VARCHAR(MAX)                                                

  SET @SQL = '' 

                    

 CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))                  

  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))                  

                

   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/                  

  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   

                    

  SET @RowCnt = (SELECT COUNT(*)as a FROM #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')                   

  SET @FileName=''                  

                    

  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  

                    

  PRINT @FileName                  

            

  TRUNCATE TABLE FileData            

                      

  INSERT INTO FileData                

  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   

  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  

  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               

                    

  INSERT INTO FileData                                            

  SELECT  '<Tp>5</Tp>'+            

  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            

     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            

  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               

  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               

  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              

  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              

  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                              

  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              

  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                               

  FROM   #JVDATAFILE a (nolock)                                    

  WHERE tosegment = 'BSECM'                 

                

    /*                  

  INSERT INTO FileData_rohit_23092015                                          

  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse                   

  */                  

                                                 

  SET @SQL = ''                                                

              

  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                           

  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '   */

  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '                                                    

  SET @SQL = '''' + @SQL + ''''                                                

  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                

  PRINT @SQL                                                

  EXEC (@SQL)                    

                        

  /*Used For Unix formated Data*/                  

  /*exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName*/ 

  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                   

                    

  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                   

                    

  /*SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName */ 

  SET @filename1='H:\MindGate\UploadJVCollateral\'+ @FileName                  

                     

  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/                      

  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/                  

                      

  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                   

                    

  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')                   

  SET @FileName=''                  

                    

  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                  

                    

  PRINT @FileName                  

                    

  TRUNCATE TABLE FileData              

                      

  INSERT INTO FileData              

  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                   

  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                  

  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                               

                      

  INSERT INTO FileData                                          

  SELECT  '<Tp>5</Tp>'+            

  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+            

     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'            

  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                               

  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                               

  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                              

  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                              

  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                              

  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                              

  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                              

  FROM   #JVDATAFILE a (nolock)                                    

  WHERE tosegment = 'NSECM'                   

                       

                    

  /*                  

  INSERT INTO FileData_rohit_23092015                                          

  select DATA from #VMSS_JVCEColl_tblfile_nse                   

  */                                                  

                    

  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                           

  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc ' */

  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '                                                   

  SET @SQL = '''' + @SQL + ''''                                                

  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                

  PRINT @SQL                                                

  EXEC (@SQL)                      

                        

  /*Used For Unix formated Data*/                  

  /*exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName  */

  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\H\MindGate\UploadJVCollateral\',@FileName                    

             

  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                    

                     

  /*SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName*/                  

  SET @filename2='H:\MindGate\UploadJVCollateral\'+ @FileName                    

  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/                    

      

  SET @SQL =''                 

  SET @SQL = 'Dear Team,<br/><br/>'                                                

  SET @SQL = @SQL + 'Please find the attached file for (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') with criteria for shares fetching as given below:    

  



 <br/><br/>1. Shares fetching is done only when client is in continous projected + pure  risk for 5 days.  

 <br/><br/>2. Codes considered for shares fetching to the extent of pure + projected risk value . Sequence will be Blue-chip , good , Average and Poor if client in Pure risk and Blue-chip, Good , Average if client in projected risk.   

 <br/><br/>3. If there is only projected risk then the cap of fetching of shares will be done above Rs.500 and if there is pure risk then there will be cap of Rs.100 for fetching of shares which will be done to the extent of pure +projected risk value.  






 <br/><br/>4. Shares fetching will not be done in this process if there is no Pure and projected risk.   

 <br/><br/>5. Regions/Branches and SBs can see the reports on daily basis in NRMS - >Risk Manager - > Var Margin Report -> DP POA Shares Movement- with every details given below:   

 <br/><br/>6. SMS logs report will also be available to all users on daily basis.'  

       

                                                 

  SET @SQL = @SQL + '<br/><br/><br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                                

                    

  DECLARE @s varchar(500)                                                          

  SET @s = @filename1 + ';' + @filename2                                               

                    

  EXEC msdb.dbo.sp_send_dbmail            

  @profile_name = 'Square',                                    

  @recipients= 'anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;rajendra.tiwari@angelbroking.com;vilasnaram@angelbroking.com;',                                                

  @copy_recipients= 'renil.pillai@angelbroking.com;vishal@angelbroking.com;csorm@angelbroking.com;mgs.abha@angelbroking.com;',                  

   --@blind_copy_recipients= @BCC,                                                

  @body= @SQL,                                                

  @file_attachments= @s,                                                

  @body_format= 'HTML',                                                  

  @subject='Shares fetching to the extent of pure + projected risk value'                                           

                                       

End try                                                                     

BEGIN CATCH                                                                        

  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                               

  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                              

  DECLARE @ErrorMessage NVARCHAR(4000);                                                                

  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                

  RAISERROR (@ErrorMessage , 16, 1);                                      

End catch                                                 

                                                

SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PURE_RISK_DP_ADJ_SMS
-- --------------------------------------------------

-- =============================================
-- author:	abha jaiswal
-- create date: 29/07/2016
-- description:	<description,,>
-- =============================================
CREATE procedure [dbo].[PURE_RISK_DP_ADJ_SMS]

as
begin
 select a.party_code,a.adjamt,b.mobile_pager into #send1                                          
 from       
 (select party_code,adjamt=sum(total_adj_value) from vmss_purerisk_dpholding where tosegment is not null group by party_code) a     
  left outer join general.dbo.client_details b with (nolock)                                          
  on a.party_code = b.party_code where b.mobile_pager is not null    
                             
 insert into intranet.sms.dbo.sms                                          
 select party_code,mobile_pager,                                          
 'dear client,shares worth rs.' + convert(varchar, convert(int, adjamt)) + ' are trf from your dp a/c to broker margin a/c against net debit in your trading a/c.for queries call 022-42185454.',                                        
 convert(varchar(11), getdate(), 103),substring(convert(varchar(25), getdate()), 13, 5),'p',right(getdate(), 2),'new poa debit client'                                          
 from   #send1  
 
 insert into tbl_purerisk_dp_adj_sms_log(party_code,mobile_no,sms_content,msg_date,msg_by)
 select party_code,mobile_pager,                                          
 'dear client,shares worth rs.' + convert(varchar, convert(int, adjamt)) + ' are trf from your dp a/c to broker margin a/c against net debit in your trading a/c.for queries call 022-42185454.',                                        
 convert(varchar(11), getdate(), 103),'system' from   #send1 
 
                     
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.rebuild_index
-- --------------------------------------------------
/*

Proc Created by Amit kumar Bhatta on 27th feb 2013 for rebuilding the indexes of database passed as paremeter for the proc.

*/
create procedure [dbo].[rebuild_index]
@database varchar(100)
as
begin

declare @db_id int
Select @db_id = db_id(@database) 

if @db_id is Null
return

SET NOCOUNT ON;
DECLARE @objectid int;
DECLARE @indexid int;
DECLARE @partitioncount bigint;
DECLARE @schemaname nvarchar(130); 
DECLARE @objectname nvarchar(130); 
DECLARE @indexname nvarchar(130); 
DECLARE @partitionnum bigint;
DECLARE @partitions bigint;
DECLARE @frag float;
DECLARE @command nvarchar(4000); 
-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function 
-- and convert object and index IDs to names.

SELECT
    object_id AS objectid,
    index_id AS indexid,
    partition_number AS partitionnum,
    avg_fragmentation_in_percent AS frag
INTO #work_to_do
FROM sys.dm_db_index_physical_stats (@db_id, NULL, NULL , NULL, 'LIMITED')
WHERE avg_fragmentation_in_percent > 10.0 AND index_id > 0;

-- Declare the cursor for the list of partitions to be processed.
DECLARE partitions CURSOR FOR SELECT * FROM #work_to_do;

-- Open the cursor.
OPEN partitions;

-- Loop through the partitions.
WHILE (1=1)
    BEGIN;
        FETCH NEXT
           FROM partitions
           INTO @objectid, @indexid, @partitionnum, @frag;
        IF @@FETCH_STATUS < 0 BREAK;
        SELECT @objectname = QUOTENAME(o.name), @schemaname = QUOTENAME(s.name)
        FROM sys.objects AS o
        JOIN sys.schemas as s ON s.schema_id = o.schema_id
        WHERE o.object_id = @objectid;
        SELECT @indexname = QUOTENAME(name)
        FROM sys.indexes
        WHERE  object_id = @objectid AND index_id = @indexid;
        SELECT @partitioncount = count (*)
        FROM sys.partitions
        WHERE object_id = @objectid AND index_id = @indexid;

-- 30 is an arbitrary decision point at which to switch between reorganizing and rebuilding.
        IF @frag < 30.0
            SET @command = N'use '+@database + N' ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REORGANIZE';
        IF @frag >= 30.0
            SET @command = N'ALTER INDEX ' + @indexname + N' ON ' + @schemaname + N'.' + @objectname + N' REBUILD';
        IF @partitioncount > 1
            SET @command = @command + N' PARTITION=' + CAST(@partitionnum AS nvarchar(10));
        EXEC (@command);
        PRINT N'Executed: ' + @command;
    END;

-- Close and deallocate the cursor.
CLOSE partitions;
DEALLOCATE partitions;

-- Drop the temporary table.
DROP TABLE #work_to_do;

end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_VMSS_DP_ADJUST_REPORT
-- --------------------------------------------------

-- Author:		Abha Jaiswal
-- Create date: Feb 05 2016
-- Description:	Dp Adjustment movement
-- =============================================
CREATE PROCEDURE Rpt_VMSS_DP_ADJUST_REPORT
	
AS
BEGIN

select * from vmss_dp_holding where tosegment is not null
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_VMSS_DP_ADJUST_REPORT_28052016
-- --------------------------------------------------
--select convert(varchar(11),getdate(),120)  --2016-02-05 18:03:43.843    
    
-- Author:  Abha Jaiswal    
    
-- Create date: Feb 05 2016    
    
-- Description: Dp Adjustment movement    
    
    
    
--Rpt_VMSS_DP_ADJUST_REPORT 'client','MANS832','2016/03/01','BROKER','CSO'    
    
-- =============================================    
    
CREATE PROCEDURE Rpt_VMSS_DP_ADJUST_REPORT_28052016       
@ACCESSLEVEL VARCHAR(20),         
@ACCESSCODE VARCHAR(20),         
@ALERTDATE datetime,         
@ACCESS_TO VARCHAR(20),         
@ACCESS_CODE VARCHAR(20), 
@Report_Type varchar(20)    
--select * from  squareoff.dbo.vmss_DP_holding_hist A inner join vw_rms_client_vertical B  on a.party_code=B.client where CONVERT(VARCHAR(11),HoldDate,120) ='2016-02-04 ' and CLIENT LIKE '%'   order by CONVERT(VARCHAR(11),HoldDate,120) desc       
AS       
BEGIN       
IF @ACCESSCODE ='ALL'         
SET @ACCESSCODE ='%'      
       
DECLARE @MAIN VARCHAR(MAX)         
/* Added on 01 01 2016 as suggested by Vishal Gohil & Anand*/    

if(@Report_Type='VMSS')
begin
	if(CONVERT(date,@ALERTDATE,120)=CONVERT(date,getdate(),120))       
	begin        
		set @main =''      
		set @main =' select REGION,BRANCH,SB,Cli_Type,B.Category ,party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,clsrate,vbhc,a.category as scripCat,haircut,vahc,sqoffqty,adjamt,tosegment from squareoff.dbo.vmss_dp_holding a  '        
		set @main = @main + ' inner join vw_rms_client_vertical b on a.party_code=b.client '     
		set @main = @main + ' where tosegment is not null and CONVERT(date,HoldDate,120) =(select max( CONVERT(date,HoldDate,120)) from squareoff.dbo.vmss_dp_holding) and '           
	end       
	else        
	begin     
		set @main =''         
		set @main =' select  REGION,BRANCH,SB,Cli_Type,B.Category,holddate,party_code,cltdpid,isin,bsecode,nsesymbol,nseseries,holding,clsrate,vbhc,a.category as scripCat,a.category,haircut,vahc,sqoffqty,sqoffseq,id,adjamt,fromacc,toacc,tosegment from squareoff.dbo.vmss_DP_holding_hist a  '         
		set @main = @main + ' inner join vw_rms_client_vertical b on a.party_code=b.client '    
		set @main = @main + ' where CONVERT(VARCHAR(11),HoldDate,120) ='''+ CONVERT(VARCHAR(11),@ALERTDATE ,120)+''' and '     
	end
end 
	   
else if(@Report_Type='Pure Risk') 
begin  
	if(CONVERT(date,@ALERTDATE,120)=CONVERT(date,getdate(),120))        
	begin        
	print 'Hii'       
		set @main =''         
		set @main =' select REGION,BRANCH,SB,Cli_Type,B.Category ,party_code,qty,accno,total,nse_approved,Net_debit,total_adj,Qty_adj,clsrate,Total_Adj_Value,Process_date,ToSegment from squareoff.dbo.VMSS_PURERISK_DPHOLDING a  '          
		set @main = @main + ' inner join vw_rms_client_vertical b on a.party_code=b.client '    
		set @main = @main + ' CONVERT(date,HoldDate,120) =(select max( CONVERT(date,HoldDate,120)) from squareoff.dbo.vmss_dp_holding) and '          
	end       
	else       
	begin       
		print 'Byee'        
		set @main =''         
		set @main =' select REGION,BRANCH,SB,Cli_Type,B.Category ,party_code,qty,accno,total,nse_approved,Net_debit,total_adj,Qty_adj,clsrate,Total_Adj_Value,Process_date,ToSegment from HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST a  '          
		set @main = @main + ' inner join vw_rms_client_vertical b on a.party_code=b.client '       
		set @main = @main + ' where CONVERT(VARCHAR(11),HoldDate,120) ='''+ CONVERT(VARCHAR(11),@ALERTDATE ,120)+''' and '        
	end        
end
else
print 'no data'
   
IF @ACCESSLEVEL ='REGION'                                                    
SET @MAIN =  @MAIN + ' REGION LIKE ''' + @ACCESSCODE  +''''                                            
       
ELSE IF @ACCESSLEVEL = 'BRANCH'                                                   
SET @MAIN =  @MAIN + ' BRANCH LIKE ''' + @ACCESSCODE  +''''                                            
      
ELSE IF @ACCESSLEVEL = 'SB'                             
SET @MAIN =  @MAIN + ' SB LIKE ''' + @ACCESSCODE  +''''                                            
     
ELSE IF @ACCESSLEVEL = 'CLIENT'                                                   
SET @MAIN =  @MAIN + ' CLIENT LIKE ''' + @ACCESSCODE  +''''                                            
         
IF @ACCESS_TO = 'REGIONMAST'                                   
SET @MAIN =  @MAIN + ' AND REGION IN (SELECT ACCESSCODE FROM TBL_RMS_GROUPMASTER  WHERE GROUPCODE= '''+@ACCESS_CODE+''')  '                                                                                               
    
ELSE IF @ACCESS_TO = 'BRMAST'                                                                                           
SET @MAIN =  @MAIN + ' AND BRANCH IN (SELECT ACCESSCODE FROM TBL_RMS_GROUPMASTER  WHERE GROUPCODE= '''+@ACCESS_CODE+''')  '                                                                                            
    
ELSE IF @ACCESS_TO = 'SBMAST'                                                                                    
SET @MAIN =  @MAIN + ' AND SB IN (SELECT sub_broker FROM sb_master  WHERE sbmast_cd= '''+@ACCESS_CODE+''')  '            
     
ELSE IF @ACCESS_TO = 'BROKER'                                                                                         
SET @MAIN =  @MAIN + ' '                                                       
    
        
ELSE                                                                                         
SET @MAIN =  @MAIN + ' AND '+@ACCESS_TO+' LIKE '''+@ACCESS_CODE+''' '                                                                                          
   
PRINT (@MAIN)          
EXEC (@MAIN)   
    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.SMS_PureRisk_day2
-- --------------------------------------------------

-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
CREATE PROCEDURE [dbo].[SMS_PureRisk_day2]
AS
BEGIN  
BEGIN TRY 

 declare @mdate as varchar(11)   
 select @mdate=max(vdt) from anand1.account.dbo.ledger WITH(NOLOCK) where vtyp=15 and vdt <=convert(varchar(11),getdate()) and narration like 'SETTNO=_______NSECMNBill Posted'          
 print @mdate
 select party_code,pure_risk,proj_risk,rms_date=cast(pdate as date), risktype=case when pure_risk<-100 then 'Pure'else 'Projected' end      
 into #temp_Riskdata 
 from history.dbo.TBL_RMS_COLLECTION_CLI_HIST with (nolock)  where        
 cast(pdate as date)>@mdate     
 and (pure_risk<-100 or  proj_risk<-501) and Exp_Gross>0.00     
		    
 select party_code,risktype=min(risktype) into #final from #temp_Riskdata  group by party_code having count(party_code)>=2
                  
 SELECT A.*      
 INTO #CLI                    
 FROM (SELECT A.PARTY_CODE,                    
 NON_CASH=0.00,                    
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),                    
 FOSHRT=CONVERT(MONEY, 0) ,  risktype                                   
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI A WITH (NOLOCK)   inner join #final F on A.party_code=F.party_code                 
  LEFT JOIN (SELECT PARTY_CODE,                    
 NON_CASH=Sum(FinalAmount)                    
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)                    
 WHERE COLL_TYPE = 'SEC'                    
 GROUP BY PARTY_CODE) B                    
 ON A.PARTY_CODE = B.PARTY_CODE                    
 where (A.Pure_Risk+A.proj_risk)<0 ) A                    
 WHERE EXISTS (                    
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)                    
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)                    
                                    
                          
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/              
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI b with (nolock) where b.Pure_Risk>=-100    

  declare @dt varchar(10)   
    ;with sqoffdatae as  
    (  
    select ROW_NUMBER() over(order by a.Start_Date)as srno,  isnull(convert(varchar(10), a.Start_Date, 103),'')   Start_Date                                        
    from general.dbo.bse_sett_mst a                                                                        
    where CONVERT(VARCHAR(10),a.start_Date,121) > CONVERT(VARCHAR(10),getdate(),121)                                                 
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                          
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                        
    group by Start_Date)  
    select @dt = isnull(convert(varchar(10), Start_Date , 103),'')  from sqoffdatae where srno=1 ;  


	SELECT mobile_pager,'Dear Customer ' + Ltrim(Rtrim(A.party_code))+ ', Shares worth Rs.'+ CONVERT(VARCHAR, Abs(convert(numeric,round(proj_risk,0))))+ ' will be fetched on '+@dt+'  from your DP A/c towards net debit in your trading a/c.' as text ,CONVERT(VARCHAR(10), Getdate(), 103) as [date],  
	Ltrim(Rtrim(Str(Datepart(hh, Dateadd(minute, 15, Getdate())))))+ ':'  
	+ Ltrim(Rtrim(Str(Datepart(minute, Dateadd(minute, 15, Getdate()))))) as [time],'P' as flag,  
	CASE WHEN ( Datepart(hh, Dateadd(minute, 15, Getdate())) ) >= 12 THEN 'PM' ELSE 'AM' END as [ampm],'T Day' as purpose,
	A.party_code,Amount= CONVERT(VARCHAR, Abs(convert(numeric,round(proj_risk,0)))),segment=(case when C.BSECM='Y' then 'BSE'   
									 when C.NSECM='Y' then 'NSE' else  '' end)
	into #SMS_DATA								    
	FROM #temp_Riskdata A  
	Inner join (select party_code,BSECM,NSECM,NSEFO,mobile_pager from general.dbo.client_details with(nolock)) C  
	   on A.party_code=C.party_code  
	WHERE mobile_pager <> ''  
	AND Len(mobile_pager) = 10  
	AND ( LEFT(mobile_pager, 1) = '9' OR LEFT(mobile_pager, 1) = '8' OR LEFT(mobile_pager, 1) = '7')  

	INSERT INTO general.dbo.nrms_sms  
	SELECT mobile_pager,[text],[date],[time],flag,[ampm],purpose,party_code,Amount,segment 
	FROM #SMS_DATA
  
  
	INSERT INTO nrms_sms  
	SELECT b.MOBILE,a.*  
	FROM (SELECT TOP 1 [text],[date],[time],flag,[ampm],purpose,party_code,Amount,segment 
	FROM #SMS_DATA) a,  
	(SELECT DISTINCT MOBILE FROM TBL_USEREMAILID WHERE MODULE IN('TDay') AND SENDSMS =1) b  
		
	END TRY  
    BEGIN CATCH  
  
    INSERT INTO EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)  
    SELECT GETDATE(),'Squareup_tday_alert',ERROR_LINE(),ERROR_MESSAGE()  
  
    DECLARE @ErrorMessage NVARCHAR(4000);  
	SELECT @ErrorMessage = ERROR_MESSAGE() + CONVERT(VARCHAR(10),ERROR_LINE());  
	RAISERROR (@ErrorMessage , 16, 1);  
	END CATCH;  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.stp_help_search
-- --------------------------------------------------
--DROP PROC stp_help_search
Create  PROCEDURE [dbo].[stp_help_search]  
 (  
 @fslike    [nvarchar](500),  
 @nxtype    [tinyint]= 0,  
 @fntype    [tinyint]= 0  
 )  
-- WITH ENCRYPTION  
 AS  
 BEGIN  
 SET NOCOUNT ON   
   DECLARE @xtype varchar(2)  
   DECLARE @fxlike varchar(100)  
   DECLARE @charindex NVARCHAR(2)  
    
   SET @fslike =REPLACE (@fslike,'[','')  
   SET @fslike =REPLACE (@fslike,']','')  
   SET @fslike =REPLACE (@fslike,'','')  
     
   SET @fslike =LTRIM(RTRIM(@fslike))  
  
   SET @xtype = case  
       when @nxtype = 0 then ''  
       when @nxtype = 1 then 'U'  
       when @nxtype = 11 then 'U'  
       when @nxtype = 2 then 'P'  
       when @nxtype = 5 then 'PK'  
       when @nxtype = 10 then 'F'  
       when @nxtype = 4 then 'D'  
   
       else ''  
       end;  
   SET @fxlike ='stp_help'  
  
   IF  @fntype = 0 and  @nxtype <> 11  
    BEGIN  -- FOR TABLES  
      SELECT [name]  AS ' ' FROM sysobjects  
      WHERE upper([name])   LIKE '%'+ upper(@fslike) +'%'  
      AND ((@xtype   = '' and [xtype] = 'U' )  OR [xtype]  =  @xtype)  
      AND upper([name])   NOT LIKE '%'+ upper(@fxlike) +'%'  
     ORDER BY [name] ASC  
       -- FOR STP  
      SELECT [name]  AS ' ' FROM sysobjects  
      WHERE upper([name])   LIKE '%'+ upper(@fslike) +'%'  
      AND ((@xtype   = '' and [xtype] = 'P')  OR [xtype]  =  @xtype)  
      AND [name]   NOT LIKE '%'+ @fxlike +'%'  
       --FOR VIEWS  
      SELECT [name]  AS ' ' FROM sysobjects  
      WHERE upper([name])   LIKE '%'+ upper(@fslike) +'%'  
      AND ((@xtype   = '' and [xtype] = 'V')  OR [xtype]  =  @xtype)  
      AND [name]   NOT LIKE '%'+ @fxlike +'%'  
       
     ORDER BY [name] ASC  
  
        
    END  
   ELSE  
    BEGIN   
     IF @nxtype = 11  
     begin  
     declare @tabname nvarchar(100), @tabdata nvarchar(500)  
  
     create table #trper   
     (  
     tabname nvarchar(100),  
     tabdata nvarchar(500)  
     )  
  
  
       
     insert into #trper SELECT  [name], ' select * from '+ [name] FROM sysobjects  
     WHERE upper([name])   LIKE '%'+ upper(@fslike) +'%'  
     AND (@xtype   = ''  
      OR [xtype]  =  @xtype)  
     ORDER BY [name]  
  
     declare tableselect cursor for select * from #trper  
  
     open  tableselect  
     fetch next from tableselect into @tabname, @tabdata  
      while @@fetch_status = 0  
       begin  
        print ' '  
        print '-------------------------------------------------------------------------------------'  
        print @tabname  
        execute(@tabdata)  
        fetch next from tableselect into @tabname, @tabdata  
       end  
     close tableselect  
     deallocate tableselect  
      
     drop table #trper  
     end  
  
  
  
    ELSE IF @nxtype = 2 AND @fntype <> 20  
     SELECT 'GO  
 sp_helptext '+ [name] FROM sysobjects  
     WHERE upper([name])   LIKE '%'+ upper(@fslike) +'%'  
     AND (@xtype   = ''  
      OR [xtype]  =  @xtype)  
     ORDER BY [name]  
      
    ELSE IF @nxtype = 1 AND @fntype = 20  
     SELECT 'GO  
 stp_help_select '+ [name] FROM sysobjects  
     WHERE upper([name])   LIKE '%'+ upper(@fslike) +'%'  
     AND (@xtype   = ''  
      OR [xtype]  =  @xtype)  
     ORDER BY [name]  
  
    ELSE IF @nxtype = 1 AND @fntype = 100  
     SELECT 'GO  
 stp_help_anyTableScripGenerator '+ [name] FROM sysobjects  
     WHERE upper([name])   LIKE '%'+ upper(@fslike) +'%'  
     AND (@xtype   = ''  
      OR [xtype]  =  @xtype)  
     ORDER BY [name]  
  
    ELSE IF @nxtype = 1 AND @fntype  =200  
     begin  
     truncate table table_Null_FinalStatus  
     SELECT 'GO  
 stp_help_whereclouse '+ [name] FROM sysobjects  
     WHERE upper([name])   LIKE '%'+ upper(@fslike) +'%'  
     AND (@xtype   = ''  
      OR [xtype]  =  @xtype)  
     ORDER BY [name]  
     end  
    ELSE IF @nxtype = 1 AND @fntype = 22  
     SELECT 'GO  
 stp_help_PreviousDayScripMasterGenerator_stp '+ [name] FROM sysobjects  
     WHERE upper([name])   LIKE '%'+ upper(@fslike) +'%'  
     AND (@xtype   = ''  
      OR [xtype]  =  @xtype)  
     ORDER BY [name]  
  
    ELSE IF @nxtype = 2 AND @fntype = 20  
     SELECT 'GO  
 stp_help_stpdoc '+ [name] FROM sysobjects  
     WHERE upper([name])   LIKE '%'+ upper(@fslike) +'%'  
     AND (@xtype   = ''  
      OR [xtype]  =  @xtype)  
     ORDER BY [name]  
  
     ELSE  
        SELECT 'GO  
    sp_help '+ [name] FROM sysobjects  
       WHERE upper([name])   LIKE '%'+ upper(@fslike) +'%'  
        AND (@xtype   = ''  
         OR [xtype]  =  @xtype)  
        ORDER BY [name]  
  
    END  
  
 END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_FINDINUSP
-- --------------------------------------------------
CREATE PROCEDURE USP_FINDINUSP                
 @DBNAME VARCHAR(500),              
 @SRCSTR VARCHAR(500)                
AS                
                
 SET NOCOUNT ON              
 SET @SRCSTR  = '%' + @SRCSTR + '%'                
              
 DECLARE @STR AS VARCHAR(1000),@xdbname as varchar(500)              
  
 set @xdbname=@DBNAME  
  
 SET @STR=''              
 IF @DBNAME <>''              
 BEGIN              
 SET @DBNAME=@DBNAME+'.DBO.'              
 END              
 ELSE              
 BEGIN              
 SET @DBNAME=DB_NAME()+'.DBO.'              
 END              
 ----PRINT @DBNAME              
              
 SET @STR='SELECT DISTINCT '''+@xdbname+''' as DBNAME,O.NAME,O.XTYPE FROM '+@DBNAME+'SYSCOMMENTS  C '               
 SET @STR=@STR+' JOIN '+@DBNAME+'SYSOBJECTS O ON O.ID = C.ID '               
 SET @STR=@STR+' WHERE O.XTYPE IN (''P'',''V'') AND C.TEXT LIKE '''+@SRCSTR+''''                
-- PRINT @STR              
  EXEC(@STR)              
      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Batch_Exe
-- --------------------------------------------------

CREATE Procedure VMSS_Batch_Exe                          
as                          
                          
set nocount on                          
                          
DECLARE @XACT_ABORT VARCHAR(3) = 'OFF',@XactChg varchar(3) ='No';                          
IF ( (16384 & @@OPTIONS) = 16384 ) SET @XACT_ABORT = 'ON';                          
if @XACT_ABORT='OFF'                          
Begin                          
 SET XACT_ABORT ON                          
 set @XactChg='Yes'                          
End                          
      
select ROW_NUMBER() OVER ( ORDER BY srno ) AS [Ctr],* into #File1     
from squareoff.dbo.vmss_batch_process WITH (NOLOCK) where active_Status=1 and flag=0      
ORDER BY SRNO    
                        
declare @totctr as int = 0,@ctr as int = 1, @str as varchar(2000),@srno as int,@spname as varchar(200)                          
SET @ctr =1    
    
select @totctr=MAX(Ctr) from #file1                          
    
While @ctr <= @totctr                          
Begin                          
 set @str = ''                          
 select @srno=srno,@str='exec '+procedurename,@spname=procedurename from #File1 where ctr=@ctr                          
    
 Begin Try                          
  update squareoff.dbo.vmss_batch_process set StartDate=GETDATE(),errflag='' where srno=@srno                          
  exec(@str)   
  /*  WAITFOR DELAY '00:00:02' */  
  update squareoff.dbo.vmss_batch_process set EndDate=GETDATE(),Flag=1 where srno=@srno                          
  set @ctr=@ctr+1                          
 End Try                          
    
 Begin Catch                          
  insert into GENERAL.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                      
  select GETDATE(),@spname,ERROR_LINE(),ERROR_MESSAGE()                                      
                      
  update squareoff.dbo.vmss_batch_process set errflag='<font color="red">Error</font>' where Srno=@srno                    
                                        
  DECLARE @ErrorMessage NVARCHAR(4000);                                      
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                      
  RAISERROR (@ErrorMessage , 16, 1);                             
  RETURN                          
 End Catch                          
     
End                          
                          
if @XactChg='Yes'                          
Begin                          
 SET XACT_ABORT OFF                          
end                          
                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Batch_initialise
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_Batch_initialise]  
as  
insert into VMSS_Batch_process_log(Srno,ProcedureName,Active_Status,StartDate,EndDate,Flag,UpdatedOn)   
select Srno,ProcedureName,Active_Status,StartDate,EndDate,Flag,getdate() from VMSS_Batch_process

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_BatchProJobExecutor
-- --------------------------------------------------

CREATE Procedure [dbo].[VMSS_BatchProJobExecutor]                        
as                        
SET XACT_ABORT ON                                                                                                          
Set nocount on    
                                                                                                 
BEGIN TRY                                                                                                                                  
	Declare @NSElastBillDate datetime = (select MAX(vdt)+1 from AngelNseCM.account.dbo.ledger WITH(NOLOCK) where vtyp=15 and vdt <=convert(varchar(11),getdate()) and narration like 'SETTNO=_______NSECMNBill Posted')                                                                                                    

	if (@NSElastBillDate > (select MAX(processDate) from squareoff.dbo.vmss_data with (nolock)))          
	begin       
		/* EOD process */   
		update squareoff.dbo.vmss_batch_process set flag=0, Errflag ='',startdate='Jan 1 1900' ,enddate='Jan  1 1900'        
	end      
	else    
	begin    
		/* BOD process */
		update vmss_batch_process set flag=0, Errflag ='' where Srno >= 9 
	end     

	exec vmss_batch_exe

End try                                                                                                                               
BEGIN CATCH                                                                                                                                  
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                        
  select GETDATE(),'VMSS_BatchProJobExecutor',ERROR_LINE(),ERROR_MESSAGE()                                                                                             
                    
  DECLARE @ErrorMessage NVARCHAR(4000);                                                          
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                        
  RAISERROR (@ErrorMessage , 16, 1);                                
End catch                                                                               
     
           
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_BatchProJobExecutor_T3
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_BatchProJobExecutor_T3]                        
as        
            
set nocount on                        
    
 /*          
 Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                    
                   
 if (@BSElastBillDate > (select MAX(processDate) from vmss_data with (nolock)))          
 begin          
  update vmss_batch_process set flag=0, Errflag ='',startdate='Jan 1 1900' ,enddate='Jan  1 1900'        
 end          
 */         
      
declare @enddate as datetime,@flag as int = 0,@startdate as datetime                        
select @enddate=enddate,@flag=flag from vmss_batch_process with (nolock) where srno = (select max(srno) from vmss_batch_process where active_status=1)                        
select @startdate=enddate from vmss_batch_process with (nolock) where srno = (select min(srno) from vmss_batch_process where active_status=1)                        
/*    
PRINT @enddate    
PRINT @FLAG    
*/    
    
if @flag=1 and convert(varchar(11),@enddate)=convert(varchar(11),getdate())                        
Begin       
    
 Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                    
 if (@BSElastBillDate > (select MAX(processDate) from vmss_data with (nolock)))          
 begin          
  update vmss_batch_process set flag=0, Errflag ='',startdate='Jan 1 1900' ,enddate='Jan  1 1900'        
 end      
    else    
    begin    
  Select 'Process completed for Today. Kindly contact System Administrator to re-process.' as vmssstat,0 as status                        
  RETURN                        
 end     
 End                        
    
/*                         
 if @flag=1 and convert(datetime,convert(varchar(11),@enddate))<convert(Datetime,convert(varchar(11),getdate()))                         
 and convert(datetime,convert(varchar(11),@startdate))<convert(datetime,convert(varchar(11),getdate()))                        
*/            
    
/*    
if @flag=1 and (select max(processdate) from vmss_Data) < (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                            
  
    
Begin                        
   update vmss_batch_process set flag=0, Errflag ='',startdate='Jan 1 1900' ,enddate='Jan  1 1900'                        
End                        
*/    
    
              
/*                    
if (select max(processdate) from vmss_Data) < (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                
begin               
 update vmss_batch_process set flag=0, Errflag =''                      
end              
else              
begin              
 update vmss_batch_process set flag=0, Errflag ='' where Srno >= 9                     
end              
*/              
                         
 DECLARE @JobRunningStatus INT,@JOB_ID uniqueidentifier                        
 SET @JobRunningStatus = 0                        
                        
 SELECT @JOB_ID = job_id                         
 FROM msdb.dbo.sysjobs                         
 WHERE name = 'vmss T4 Batch process'                        
                        
 create table #jobstatus                        
 (                        
  [Job ID] uniqueidentifier,                         
  [last run date] int,                        
  [last run time] int,                        
  [next run date] int,                        
  [next run time] int,                        
  [next run schedule id] int,                        
  [request to run] int,                        
  [request source] int,                        
  [request source id] varchar(100),                        
  [running] int,              
  [current step] int,                        
  [current retry attempt] int,                        
  [state] int                        
 )                        
                        
 INSERT INTO #jobstatus                        
 EXEC master.dbo.xp_sqlagent_enum_jobs 1, sa,@JOB_ID                        
                        
 IF (SELECT COUNT(*) FROM #jobstatus) > 0                        
  SELECT TOP 1 @JobRunningStatus = RUNNING FROM #jobstatus                        
 ELSE                        
  SELECT @JobRunningStatus = -1                        
                        
 IF @JobRunningStatus = 0                        
 BEGIN                        
  EXEC msdb.dbo.sp_start_job 'vmss T4 Batch process'    
  select 'Process Triggered. vmss Process in Progress...Wait...' as vmssStat,1 as [status]                        
 END                        
 ELSE                        
 BEGIN                        
  select 'VMSS Process in Progress...Wait...' as vmssStat,[updstatus] as [status] from VMSS_processStatus                          
 END                        
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_BSE_VarShortage
-- --------------------------------------------------

 CREATE PROCEDURE [dbo].[VMSS_BSE_VarShortage]                              
AS                              
                              
SET XACT_ABORT ON                                      
Set nocount on                                      
BEGIN TRY   

 select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with (nolock) where IS_Accepted='Y'
 
  SELECT                              
  A.PARTY_CODE,                              
  SCRIP_CD,                              
  /* CLSRATE,   */            
  mis.dbo.RoundtoUnit(CLSRATE,0.05) as CLSRATE,                          
  sum(SquareOffQty) as SquareOffQty,                              
  ToSegment   into #VMSS_Holding                           
  FROM vmss_holding A WITH (NOLOCK) inner join #MTFCodes  MTF On A.party_code=MTF.party_code                        
  WHERE SquareOffQty <>0 and tosegment='BSECM'              
  GROUP BY A.PArty_code,scrip_Cd,clsrate,tosegment 
  
  
  select A.party_code into #vmss_data from  VMSS_data A with (nolock) inner join #MTFCodes  MTF On A.party_code=MTF.party_code    where NoofDays >=3 and               
  processdate >= (select max(processdate) from VMSS_data with (nolock))               
  group by A.party_code
  
  
   
  TRUNCATE table dbo.upd_bse_outfile_squp_var_margin_shortage                              
  
  INSERT INTO dbo.upd_bse_outfile_squp_var_margin_shortage(S,Qty,Qty1,Scrip_Cd,clsrate,Client_Code,EOSESS,CLIENT,L)                              
  SELECT                              
  S,                              
  Qty,                              
  Qty1,                              
  Scrip_Cd,                              
  clsrate,                              
  Client_Code,                              
  EOSESS,                              
  CLIENT,                              
  L                              
  FROM                         
  (                        
  SELECT                              
  S = 'S',                              
  CONVERT(int, SquareOffQty) Qty,                              
  CASE                              
  WHEN CONVERT(int, CEILING(SquareOffQty * .1)) <= 1 THEN SquareOffQty                              
  ELSE CONVERT(int, CEILING(SquareOffQty * .1))                              
  END AS Qty1,                              
  Scrip_Cd,                              
  REPLACE(CONVERT(decimal(15, 2), clsrate - ((clsrate * 2) / 100.00)), '.', '') + (5 - REPLACE(CONVERT(decimal(15, 2), clsrate - ((clsrate * 2) / 100.00)), '.', '') % 5) clsrate,                              
  LTRIM(RTRIM(c.Party_code)) Client_Code,                              
  EOSESS = 'EOSESS',                              
  CLIENT = 'CLIENT',                              
  L = 'L'                              
  FROM                             
  (                        
  SELECT                              
  PARTY_CODE,                              
  SCRIP_CD,                                         
  CLSRATE,                          
  SquareOffQty,                              
  ToSegment                              
  FROM #VMSS_Holding              
  
  )a                        
  INNER JOIN general.dbo.Vw_RMS_CLIENT_Vertical b                              
  ON a.PARTY_CODE = b.Client                        
  INNER JOIN               
  (select party_code from general.dbo.client_details where LEN(LTRIM(RTRIM(pan_gir_no))) = 10)cli                              
  ON a.PARTY_CODE = cli.PARTY_CODE                           
  inner join (              
  select party_code from  #vmss_data              
  )c                      
  on a.Party_code=c.Party_code              
  
  ) x    

                            
End try                                                           
BEGIN CATCH                                                              
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                    
  select GETDATE(),'VMSS_BSE_VarShortage',ERROR_LINE(),ERROR_MESSAGE()                                                                    
              
              
 DECLARE @ErrorMessage NVARCHAR(4000);                                          
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                          
 RAISERROR (@ErrorMessage , 16, 1);                
               
End catch                                       
                                      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_BSE_VarShortage_10_percent
-- --------------------------------------------------
  
 create PROCEDURE [dbo].[VMSS_BSE_VarShortage_10_percent]                                
AS                                
                                
SET XACT_ABORT ON                                        
Set nocount on                                        
BEGIN TRY                                                                
    
  TRUNCATE table dbo.upd_bse_outfile_squp_var_margin_shortage                                
    
  INSERT INTO dbo.upd_bse_outfile_squp_var_margin_shortage(S,Qty,Qty1,Scrip_Cd,clsrate,Client_Code,EOSESS,CLIENT,L)                                
  SELECT                                
  S,                                
  Qty,                                
  Qty1,                                
  Scrip_Cd,                                
  clsrate,                                
  Client_Code,                                
  EOSESS,                                
  CLIENT,                                
  L                                
  FROM                           
  (                          
  SELECT                                
  S = 'S',                                
  CONVERT(int, SquareOffQty) Qty,                                
  CASE                                
  WHEN CONVERT(int, CEILING(SquareOffQty * .1)) <= 1 THEN SquareOffQty                                
  ELSE CONVERT(int, CEILING(SquareOffQty * .1))                                
  END AS Qty1,                                
  Scrip_Cd,                                
  REPLACE(CONVERT(decimal(15, 2), clsrate - ((clsrate * 10) / 100.00)), '.', '') + (5 - REPLACE(CONVERT(decimal(15, 2), clsrate - ((clsrate * 10) / 100.00)), '.', '') % 5) clsrate,                                
  LTRIM(RTRIM(c.Party_code)) Client_Code,                                
  EOSESS = 'EOSESS',                                
  CLIENT = 'CLIENT',                                
  L = 'L'                                
  FROM                               
  (                          
  SELECT                                
  PARTY_CODE,                                
  SCRIP_CD,                                
  /* CLSRATE,   */              
  mis.dbo.RoundtoUnit(CLSRATE,0.05) as CLSRATE,                            
  sum(SquareOffQty) as SquareOffQty,                                
  ToSegment                                
  FROM vmss_holding WITH (NOLOCK)                                
  WHERE SquareOffQty <>0 and tosegment='BSECM'                
  GROUP BY PArty_code,scrip_Cd,clsrate,tosegment                
    
  )a                          
  INNER JOIN general.dbo.Vw_RMS_CLIENT_Vertical b                                
  ON a.PARTY_CODE = b.Client                          
  INNER JOIN                 
  (select party_code from general.dbo.client_details where LEN(LTRIM(RTRIM(pan_gir_no))) = 10)cli                                
  ON a.PARTY_CODE = cli.PARTY_CODE                             
  inner join (                
  select party_code from VMSS_data where NoofDays >=3 and                 
  processdate >= (select max(processdate) from VMSS_data)                 
  group by party_code                
  )c                        
  on a.Party_code=c.Party_code                
    
  ) x                                
End try                                                             
BEGIN CATCH                                                                
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                      
  select GETDATE(),'VMSS_BSE_VarShortage',ERROR_LINE(),ERROR_MESSAGE()                                                                      
                
                
 DECLARE @ErrorMessage NVARCHAR(4000);                                            
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                            
 RAISERROR (@ErrorMessage , 16, 1);                  
                 
End catch                                     
                                        
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_BSE_VarShortage_5_percent
-- --------------------------------------------------
  
 CREATE PROCEDURE [dbo].[VMSS_BSE_VarShortage_5_percent]                                
AS                                
                                
SET XACT_ABORT ON                                        
Set nocount on                                        
BEGIN TRY                                                                
    
  TRUNCATE table dbo.upd_bse_outfile_squp_var_margin_shortage                                
    
  INSERT INTO dbo.upd_bse_outfile_squp_var_margin_shortage(S,Qty,Qty1,Scrip_Cd,clsrate,Client_Code,EOSESS,CLIENT,L)                                
  SELECT                                
  S,                                
  Qty,                                
  Qty1,                                
  Scrip_Cd,                                
  clsrate,                                
  Client_Code,                                
  EOSESS,                                
  CLIENT,                                
  L                                
  FROM                           
  (                          
  SELECT                                
  S = 'S',                                
  CONVERT(int, SquareOffQty) Qty,                                
  CASE                                
  WHEN CONVERT(int, CEILING(SquareOffQty * .1)) <= 1 THEN SquareOffQty                                
  ELSE CONVERT(int, CEILING(SquareOffQty * .1))                                
  END AS Qty1,                                
  Scrip_Cd,                                
  REPLACE(CONVERT(decimal(15, 2), clsrate - ((clsrate * 5) / 100.00)), '.', '') + (5 - REPLACE(CONVERT(decimal(15, 2), clsrate - ((clsrate * 5) / 100.00)), '.', '') % 5) clsrate,                                
  LTRIM(RTRIM(c.Party_code)) Client_Code,                                
  EOSESS = 'EOSESS',                                
  CLIENT = 'CLIENT',                                
  L = 'L'                                
  FROM                               
  (                          
  SELECT                                
  PARTY_CODE,                                
  SCRIP_CD,                                
  /* CLSRATE,   */              
  mis.dbo.RoundtoUnit(CLSRATE,0.05) as CLSRATE,                            
  sum(SquareOffQty) as SquareOffQty,                                
  ToSegment                                
  FROM vmss_holding WITH (NOLOCK)                                
  WHERE SquareOffQty <>0 and tosegment='BSECM'                
  GROUP BY PArty_code,scrip_Cd,clsrate,tosegment                
    
  )a                          
  INNER JOIN general.dbo.Vw_RMS_CLIENT_Vertical b                                
  ON a.PARTY_CODE = b.Client                          
  INNER JOIN                 
  (select party_code from general.dbo.client_details where LEN(LTRIM(RTRIM(pan_gir_no))) = 10)cli                                
  ON a.PARTY_CODE = cli.PARTY_CODE                             
  inner join (                
  select party_code from VMSS_data where NoofDays >=3 and                 
  processdate >= (select max(processdate) from VMSS_data)                 
  group by party_code                
  )c                        
  on a.Party_code=c.Party_code                
    
  ) x                                
End try                                                             
BEGIN CATCH                                                                
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                      
  select GETDATE(),'VMSS_BSE_VarShortage',ERROR_LINE(),ERROR_MESSAGE()                                                                      
                
                
 DECLARE @ErrorMessage NVARCHAR(4000);                                            
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                            
 RAISERROR (@ErrorMessage , 16, 1);                  
                 
End catch                                     
                                        
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_BSENSELedger_Link
-- --------------------------------------------------
  
--VMSS_BSENSELedger_Link 'v53526','07/07/2015'      
      
CREATE  procedure [dbo].[VMSS_BSENSELedger_Link]      
@party_code varchar(10),     
@ALERTDATE VARCHAR(11)            
--@ACCESS_TO VARCHAR(20),            
--@ACCESS_CODE VARCHAR(20)           
      
as      
      
begin      
select Party_code,bsecm_balance,nsecm_balance       
from mis.dbo.vmss_data where Party_code=@party_code      
and convert(varchar(10),updatedon,103) =CONVERT(VARCHAR(10),@ALERTDATE,103)      
      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Calculation
-- --------------------------------------------------
  
CREATE Procedure [dbo].[VMSS_Calculation]        
as                  
                  
SET XACT_ABORT ON                  
Set nocount on                  
BEGIN TRY                                          
                  
 Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                  
 Declare @LowerCapNonCash as money = 500  /* NONCASH COLLATERAL MOVEMENT : always +ve */                  
                  
                   
 EXEC general.dbo.update_projected_onlyvar                    
 EXEC VMSS_EarlyPayin                  
                  
 Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                  
                  
 select                   
 @BSElastBillDate  as processDate,                  
 b.Entity,                  
 b.segment,                  
 a.Party_code,                  
 a.Ledger as Balance,                  
 CONVERT(money,0)  as UnsettledCr,                  
 CONVERT(money,0) as UnsettledDr,                  
 a.Unrecosiled_Credit as UnrecoAmt,                  
 CONVERT(money,0) as ShortSellValue,                  
 a.Imargin as MarginAmt,                  
 a.Deposit,                  
 a.Cash_Colleteral as CashColl,                  
 a.NonCash_Colleteral as NonCashColl,                  
 Holding_total,                  
 Holding_Approved,                  
 CONVERT(money,0) as OtherDebit,                  
 CONVERT(int,0) as NonCashConsideration,                  
 CONVERT(money,0) as Net,                  
 CONVERT(money,0) as EarlyPayinValue,                  
 CONVERT(money,0) as LeverageMultiplier,                  
 CONVERT(money,0) as VarMarginShortFall,                  
 CONVERT(money,0) as SquareOffValue,      
 CONVERT(money,0) as MgnAdjNonCash,      
 CONVERT(money,0) as MgnAdjNonLed      
 into #File1                  
 from General.dbo.RMS_DtClFi a with (nolock) join (select segment,entity from intranet.cms.dbo.ncms_entity where entity='Equity') b                  
 on a.Co_code=b.segment                  
                  
                   
                  
 Declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59'                         
 select @sdtcur=sdtcur from general.dbo.parameter where sdtcur <= @ToDate and ldtcur >=@ToDate                  
                  
                   
 select CLTCODE,                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                  
 into #BSECM                  
 from anand.account_ab.dbo.ledger a with (nolock)                         
 where vDT>=@sdtcur and eDT <= @ToDate                        
 group by cltcode                      
                  
 select CLTCODE,                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                  
 into #NSECM                  
 from anand1.account.dbo.ledger a with (nolock)                         
 where vDT>=@sdtcur and eDT <= @ToDate                        
 group by cltcode                      
                  
 select CLTCODE,                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                  
 into #NSEFO                  
 from angelfo.accountfo.dbo.ledger a with (nolock)                         
 where vDT>=@sdtcur and eDT <= @ToDate                        
 group by cltcode                      
                    
 select CLTCODE,                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                  
 into #NSX                  
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                         
 where vDT>=@sdtcur and eDT <= @ToDate                        
 group by cltcode                      
                  
 select CLTCODE,                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                  
 into #MCD                  
 from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                         
 where vDT>=@sdtcur and eDT <= @ToDate                      
 group by cltcode                      
                  
 update #File1 set Balance=0,UnsettledCr=0                  
 update #File1 set Balance=b.Vbal from #BSECM b where #File1.segment='BSECM' and #File1.party_Code=b.cltcode                  
 update #File1 set Balance=b.Vbal from #NSECM b where #File1.segment='NSECM' and #File1.party_Code=b.cltcode                  
 update #File1 set Balance=b.Vbal from #NSEFO b where #File1.segment='NSEFO' and #File1.party_Code=b.cltcode                  
 update #File1 set Balance=b.Vbal from #NSX b where #File1.segment='NSX' and #File1.party_Code=b.cltcode                  
 update #File1 set Balance=b.Vbal from #MCD b where #File1.segment='MCD' and #File1.party_Code=b.cltcode                  
                  
 select EXCHANGE,sett_no,SEtt_type,                  
 (CASE WHEN EXCHANGE='NSECM' THEN DUMMY1 ELSE SCRIP_CD END) AS scrip_cd,                  
 (CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,Party_code,Qty,                  
 CLSRATE,                  
 Total AS VBHC,                  
 CONVERT(MONEY,0) AS HAIRCUT,                  
 CONVERT(MONEY,0) AS VAHC,                  
 SPACE(10) AS CATEGORY,                  
 source AS SRC                  
 INTO #HOLD                  
 from General.dbo.rms_holding with (nolock) where source='H'                  
                  
 /*                  
 INSERT INTO #HOLD                  
 select EXCHANGE,a.SETT_NO,A.SETT_TYPE,A.SCRIP_CD,A.SERIES,A.PARTY_CODE,a.Qty,0,0,0,0,'','E'                  
 FROM VMSS_EarlyPayinData A                  
 */                  
                  
 update #HOLD set clsrate=b.rate from General.dbo.cp_bsecm b where #HOLD.scrip_Cd=b.scode and #HOLD.clsrate=0                   
 update #HOLD set clsrate=b.cls                   
 from General.dbo.cp_nsecm b with (nolock) where #HOLD.scrip_Cd=b.scrip and #HOLD.series=b.series and #HOLD.clsrate=0 and exchange='NSECM'                  
                  
 update #HOLD set VBHC=clsrate*Qty                  
                  
 update #HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                   
 (select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock)  on a.isin=b.isin) b                   
 where #HOLD.SCRIP_cD=B.BSECODE AND #HOLD.EXCHANGE='BSECM'                  
                  
 update #HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                   
 (select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock)  join General.dbo.scrip_master b with (nolock)  on a.isin=b.isin) b                   
 where #HOLD.SCRIP_cD=B.NSESYMBOL AND #HOLD.SERIES=B.NSESERIES AND #HOLD.EXCHANGE='NSECM'                  
                  
 update #HOLD set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                  
                  
 update #HOLD set VAHC=VBHC*((100-HAIRCUT)/100.00)                  
                  
 update #File1 set holding_total=b.VBHC,holding_approved=b.VAHC from                   
 (select party_code,exchange,VBHC=sum(VBHC),VAHC=sum(VAHC)                  
  from #hold group by party_code,exchange) b                  
 where #File1.party_code=b.party_code and #File1.segment=b.exchange                  
                  
 update #File1 set Earlypayinvalue=b.EPV from                  
 (select Exchange,party_code,SUM(total) as EPV from VMSS_EarlyPayinData group by Exchange,party_code) b                  
 where #File1.party_code=b.party_Code       
                   
 select                   
 max(processDate) as processDate,Entity,Party_code,convert(int,1) as NoofDays,                  
 sum(Balance) as Balance,sum(MarginAmt) as MarginAmt,sum(Deposit) as Deposit,                  
 sum(CashColl) as CashColl,sum(NonCashColl) as NonCashColl,sum(Holding_total) as Holding_BHC,                  
 sum(Holding_Approved) as Holding_AHC,sum(OtherDebit) as OtherDebit,                  
 sum(EarlyPayinValue) as EarlyPayinValue,sum(LeverageMultiplier) as LeverageMultiplier,                  
 sum(VarMarginShortFall) as VarMarginShortFall,                  
 Convert(money,0) as NSEFO_JV,                  
 Convert(money,0) as NSEFO_NonCash,                  
 Convert(money,0) as MCD_JV,                  
 Convert(money,0) as MCD_NonCash,                  
 Convert(money,0) as NSX_JV,                  
 Convert(money,0) as NSX_NonCash,                  
 Convert(money,0) as VarMarginShortFall_AftAdj,                  
 Convert(money,0) as Stage,                  
 sum(SquareOffValue) as SquareOffValue,                  
 Sum(Case when Segment='BSECM' then BAlance else 0 end) as BSECM_Balance,                   
 Sum(Case when Segment='NSECM' then BAlance else 0 end) as NSECM_Balance                   
 into #file2                  
 from #file1 where segment in ('BSECM','NSECM')                  
 group by Entity,Party_code                  
                  
 /* delete Client with Cash Credit effective Balance */                  
 Delete from #file2 where balance >= @LowerCapAmt                  
                  
 update #File2 set VarMarginShortFall=(case when Holding_AHC+Balance+EarlypayinValue < @LowerCapAmt then Holding_AHC+Balance+EarlypayinValue  else 0 end)                  
                  
 update #File2 set LeverageMultiplier=                  
 Case when 100-(Holding_AHC/Holding_BHC)*100.00 > 100 then 100 else 100-(Holding_AHC/Holding_BHC)*100.00 end                  
 where Holding_BHC > 0                   
      
/* Calculation Margin Adjusted with NonCash */      
update #file1 set MgnAdjNonCash=(Case when MarginAmt-(NonCashColl+CashColl) < 0 then MarginAmt else (NonCashColl+CashColl) end)      
where segment in ('NSEFO','MCD','MSX')      
      
/* Calculation Margin Adjusted with Ledger Credit */      
update #file1 set MgnAdjNonLed=(Case       
when Balance > (MarginAmt-MgnAdjNonCash) and balance > 0 then (MarginAmt-MgnAdjNonCash)       
when Balance <= (MarginAmt-MgnAdjNonCash) and balance > 0 then Balance      
else 0 end) where segment in ('NSEFO','MCD','MSX')      
                  
 update  #File2 set NSEFO_JV=b.AdjWithLedgerCr,NSEFO_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                  
 (      
 /*                  
  select Party_code,                  
  (Case when (Balance-MarginAmt) > 0 then (Balance-MarginAmt) else 0 end) as AdjWithLedgerCr,                  
  (Case when Balance-MarginAmt < 0 and CashColl+(Balance-MarginAmt) > 0                   
        then NonCashColl else NonCashColl-CashColl+(Balance-MarginAmt) end) as AdjWithNonCashColl                  
  from #file1 where segment='NSEFO'       
*/      
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash      
from #file1 where segment='NSEFO'                    
 ) b where #File2.party_code=b.party_code and #File2.vARmARGINsHORTFALL < 0                   
                   
 update  #File2 set NSX_JV=b.AdjWithLedgerCr,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                  
 (          
 /*              
  select Party_code,                  
  (Case when (Balance-MarginAmt) > 0 then (Balance-MarginAmt) else 0 end) as AdjWithLedgerCr,                  
  (Case when Balance-MarginAmt < 0 and CashColl+(Balance-MarginAmt) > 0 then NonCashColl else NonCashColl-CashColl+(Balance-MarginAmt) end) as AdjWithNonCashColl                  
  from #file1 where segment='NSX'                  
 */      
 select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash      
    from #file1 where segment='NSX'                    
 ) b where #File2.party_code=b.party_code and #File2.vARmARGINsHORTFALL < 0                   
                   
 update  #File2 set MCD_JV=b.AdjWithLedgerCr,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                  
 (        
 /*                
  select Party_code,                  
  (Case when (Balance-MarginAmt) > 0 then (Balance-MarginAmt) else 0 end) as AdjWithLedgerCr,                  
  (Case when Balance-MarginAmt < 0 and CashColl+(Balance-MarginAmt) > 0 then NonCashColl else NonCashColl-CashColl+(Balance-MarginAmt) end) as AdjWithNonCashColl                  
  from #file1 where segment='MCD'                  
  */      
 select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash      
 from #file1 where segment='MCD'                    
      
 ) b where #File2.party_code=b.party_code  and #File2.vARmARGINsHORTFALL < 0                
                   
      
                  
 UPDATE #File2 SET NSEFO_JV=-vARmARGINsHORTFALL  WHERE NSEFO_JV > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV > 0                  
 UPDATE #File2 SET mcd_jv=-vARmARGINsHORTFALL-NSEFO_jv  WHERE mcd_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv >= 0                  
 UPDATE #File2 SET NSX_jv=-VARMARGINSHORTFALL-NSEFO_JV-mcd_jv  WHERE nsx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv >= 0                  
                  
 UPDATE #File2 SET NSEFO_NONCASH=0,MCD_NONCASH=0,NSX_NONCASH=0                   
 WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL = 0 AND vARmARGINsHORTFALL < 0                  
                  
                  
                  
 UPDATE #FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)                  
 WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                  
 AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                  
                  
 /*                  
 UPDATE #FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)                  
 WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                  
 AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                  
 */                  
                   
 UPDATE #FILE2 SET MCD_NONCASH=0                  
 UPDATE #FILE2 SET MCD_NONCASH=Stage                  
 UPDATE #FILE2 SET Stage=0                  
                  
                   
 UPDATE #FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)                  
 WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                  
 AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)*-1                  
                   
 /*                  
 UPDATE #FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSEFO_NONCASH)                  
 WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSEFO_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                  
 AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSEFO_NONCASH)*-1                  
 */                  
                   
 UPDATE #FILE2 SET NSX_NONCASH=0                  
 UPDATE #FILE2 SET NSX_NONCASH=Stage                  
 UPDATE #FILE2 SET Stage=0                  
                  
 UPDATE #FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)                  
 WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                  
 AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)*-1                  
                   
 /*                  
 UPDATE #FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSEFO_NONCASH+MCD_NONCASH)                  
 WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSEFO_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                  
 AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSEFO_NONCASH+MCD_NONCASH)*-1                  
 */                  
                   
 UPDATE #FILE2 SET NSEFO_NONCASH=0                  
 UPDATE #FILE2 SET NSEFO_NONCASH=Stage                  
 UPDATE #FILE2 SET Stage=0                  
                  
                  
 update #File2  set VarMarginShortFall_AftAdj=vARmARGINsHORTFALL+NSefo_jv+MCD_JV+NSX_JV+NSEFO_NONCASH+MCD_NONCASH+NSX_NONCASH                  
 where  vARmARGINsHORTFALL < 0                   
                  
 /* Var Margin % */                  
truncate table vmss_holding          
 insert into vmss_holding          
 (ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq )            
 select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,          
 SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS [SrNo],0 from #hold          
           
 Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1          
 declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0          
          
 select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #filex           
 from #file2 where VarMarginShortFall_AftAdj < 0          
           
 select @totctr=MAX(srno) from #filex          
           
 While @ctr <= @totctr          
 Begin          
 set @SqOffVal=0          
           
 select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdj*-1 from #filex where srno=@ctr          
 select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],* into #holdadj from vmss_holding a join          
 (select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName          
  where party_code=@pcode and Clsrate > 0          
 select @Xtotctr=MAX(Srno) from #holdadj           
           
 set @TSqOffVal=0     
 set @Xctr=1         
 While @Xctr <= @Xtotctr           
 BEGIN          
          
  select @TSqOffVal=VBHC*(Haircut/100.00),@clsrate=Clsrate,@id=id  from #holdadj where srno=@xctr          
  if (@SqOffVal<@TSqOffVal)          
   set @TSqOffVal=@SqOffVal          
        
  update vmss_holding set SquareOffQty=ceiling(@TSqOffVal/@clsrate),SqOffseq=@xctr where id=@id          
  set @SqOffVal=@SqOffVal-@TSqOffVal          
            
  set @Xctr=@Xctr+1          
  if @SqOffVal<=0           
    BREAK          
              
 END          
           
 DROP TABLE #holdadj          
           
 set @ctr=@ctr+1          
 end          
          
 drop table #filex          
           
 truncate table vmss_holding_hist           
 insert into vmss_holding(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq)           
 select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq from vmss_holding          
           
 update #file2 set SquareOffValue=b.SqVal from          
 (select party_code,sum(SquareOffQty*Clsrate) as SqVal from vmss_holding where isnull(SquareOffQty,0) > 0 group by party_code) b           
 where #file2.party_code=b.party_Code                   
                  
 UPDATE #File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                            
 (                  
 SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                             
 (                  
 SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                                             
 WHERE CONVERT(DATE,processdate) < (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data )                   
 )                                            
 ) B WHERE #File2.party_code=B.party_code                                             
                  
 UPDATE #File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                  
           
 delete from VMSS_data where processDate=@BSElastBillDate                  
                   
 insert into VMSS_data(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,                  
 Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,                  
 NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,remarks,Actual_Cash_Square_Off_Done)                  
 SELECT processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,                  
 OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,                  
 VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,GETDATE(),'V','',0.00                 
 FROM #FILE2                   
               
 insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,              
 VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks,Actual_Cash_Square_Off_Done)                  
               
 select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,              
 VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks,Actual_Cash_Square_Off_Done from VMSS_data              
                  
End try                                       
BEGIN CATCH                                          
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                
  select GETDATE(),'VMSS_Calculation',ERROR_LINE(),ERROR_MESSAGE()                                                
End catch                   
                  
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Calculation_NoNRMS
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_Calculation_NoNRMS]                                                                                                      
as                                                                                                                
                                                                                                                
SET XACT_ABORT ON                                                                                                                
Set nocount on                                                                                                                
BEGIN TRY                                                                                                                                        
  
 exec VMSS_upd_ASB7_Days    
                                                                             
 Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                                                                
 Declare @LowerCapNonCash as money = 500  /* NONCASH COLLATERAL MOVEMENT : always +ve */                                                                                                                
 Declare @BSElastBillDate datetime = (select MAX(vdt)+1 from AngelNseCM.account.dbo.ledger WITH(NOLOCK) where vtyp=15 and vdt <=convert(varchar(11),getdate()) and narration like 'SETTNO=_______NSECMNBill Posted')                                                                                                                
 print  @BSElastBillDate                                                                                                      
 select                                                                                                                 
 @BSElastBillDate  as processDate,                                                                                                                
 --Entity,                                                                                                                
 segment=a.Co_code,                                                                                                                
 a.Party_code,                                                                                                                
 a.Ledger as Balance,                                                                                                                
 CONVERT(money,0)  as UnsettledCr,                                                                                                                
 CONVERT(money,0) as UnsettledDr,                                                                                                                
 a.Unrecosiled_Credit as UnrecoAmt,                                                                                                                
 CONVERT(money,0) as ShortSellValue,                                                                                                                
 a.Imargin as MarginAmt,                                                                                                                
 a.Deposit,                                                                                                                
a.Cash_Colleteral as CashColl,                                                                                                                
a.NonCash_Colleteral as NonCashColl,                                                                                                                
Holding_total,                                                                                                                
Holding_Approved,                                                                                                                
CONVERT(money,0) as OtherDebit,                                                      
CONVERT(int,0) as NonCashConsideration,          
CONVERT(money,0) as Net,   
CONVERT(money,0) as EarlyPayinValue,                    
CONVERT(money,0) as LeverageMultiplier,                            
CONVERT(money,0) as VarMarginShortFall,                                                                
CONVERT(money,0) as SquareOffValue,                                    
CONVERT(money,0) as MgnAdjNonCash,                                                       
CONVERT(money,0) as MgnAdjNonLed                                                                  
into #p9_File1                                                     
from (select * from General.dbo.RMS_DtClFi with (nolock) where 1=2)a 
--a join (select segment,entity from intranet.cms.dbo.ncms_entity with (nolock) where entity='Equity') b         on a.Co_code=b.segment                                                                       
                                                                                                       
                                                                                                       
 /* update Holding */                                                                                                      
select EXCHANGE,sett_no,SEtt_type,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,Party_code,Qty,                                                                            
CLSRATE,                                                                                                                
Total AS VBHC,                                                                              
CONVERT(MONEY,0) AS HAIRCUT,                                                                                                                
CONVERT(MONEY,0) AS VAHC,                                                                                                    
SPACE(10) AS CATEGORY,                                                                                                                
source AS SRC,                                                                        
ISIN                                                                        
INTO #p9_HOLD                                                                                                                
from vmss_rms_holding where source in ('SI','SO','H','D')                    
  
update #p9_HOLD set series=b.NseSeries from general.dbo.scrip_master b  
where #p9_HOLD.isin=b.isin and b.NseSeries='EQ'   
  
                    
SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0          
DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin          
DROP TABLE #nqty          
                                                                                                       
update #p9_HOLD set clsrate=b.rate from General.dbo.cp_bsecm b where #p9_HOLD.scrip_Cd=b.scode and #p9_HOLD.clsrate=0                                                                                                                
                    
update #p9_HOLD set clsrate=b.cls                                                                                                                 
from General.dbo.cp_nsecm b                                                                                                       
where #p9_HOLD.scrip_Cd=b.scrip and #p9_HOLD.series=b.series and #p9_HOLD.clsrate=0 and exchange='NSECM'                                                                                                              
                    
update #p9_HOLD set VBHC=clsrate*Qty                                                                                           
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                    
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                               
where #p9_HOLD.SCRIP_cD=B.BSECODE AND #p9_HOLD.EXCHANGE='BSECM'                                                                                                                
    
    
/*Added to handle scrip:idfc ltd as it has shifted from BE to Eq as suggested by Vishal Gohil on Dec 10 2015*/    
--select * from #p9_HOLD where  isin='INE092T01019' and series='EQ'    
--update #p9_HOLD set series='EQ' where isin='INE092T01019' and series='BE'    
    
/* update a set series=b.Currenteries from #p9_HOLD a inner join VMSS_Exception_NSESeries b on a.isin=b.isin and a.series=b.previousseries  */  
    
/*******************************************************************/    
    
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                  
where #p9_HOLD.SCRIP_cD=B.NSESYMBOL AND #p9_HOLD.SERIES=B.NSESERIES AND #p9_HOLD.EXCHANGE='NSECM'                                                              
      
                    
update #p9_HOLD set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #p9_HOLD set VAHC=VBHC*((100-HAIRCUT)/100.00)                                                  
                    
insert into #p9_File1(segment,party_code)                                                              
select b.co_code,party_Code from                                                                                                      
/*(select party_code from #p9_hold group by party_code) a,*/ 
(select t_day,party_code from mis.dbo.asb7_clidetails_crdet_process2 --commented on Aug 26 2016  as required by Vishal Gohil mail dated Aug 24 2016 
 where T_day>0 and  
 rms_date=(select max(rms_date)from  mis.dbo.asb7_clidetails_crdet_process2)) a,                                                                                                      
(select * from General.dbo.company where entitytype in ('EQ','COMMO') and bo_active=1) b 

--select distinct entitytype,co_code,segment from  General.dbo.company                                                                                                    
                                                                                                      
update #p9_file1                                                                 
set ProcessDate=@BSElastBillDate,Balance=0,UnsettledCr=0,UnsettledDr=0,UnrecoAmt=0,ShortSellValue=0,                                                                                       
MarginAmt=0,Deposit=0,CashColl=0,NonCashColl=0,Holding_total=0,Holding_Approved=0,OtherDebit=0,NonCashConsideration=0,Net=0,                                                                                                      
EarlyPayinValue=0,LeverageMultiplier=0,VarMarginShortFall=0,SquareOffValue=0                                                                                                      
                                                                                       
update #p9_File1 set holding_total=b.VBHC,holding_approved=b.VAHC from                                                                 
(select party_code,exchange,VBHC=sum(VBHC),VAHC=sum(VAHC)                                                                                                                
from #p9_hold group by party_code,exchange) b                                                                       
where #p9_File1.party_code=b.party_code and #p9_File1.segment=b.exchange                                                                              
                                                                                                      
/* Get Last settlement Date */                                                                                                     
                                                                                      
 Declare @sdtcur as datetime,-- @ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59'                                                                                                        
 @ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'                                  
 select @sdtcur=sdtcur from General.dbo.parameter with (nolock) where sdtcur <= @ToDate and ldtcur >=@ToDate                                           
                                       
/* Fetch effective Ledger Balance - Only Bill's effective date else voucher date*/                                 
                
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
 into #p9_BSECM                                                                                                                
 from AngelBSECM.account_ab.dbo.ledger a with (nolock)                                                                                       
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and  
 vDT>=@sdtcur and vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                           
 group by cltcode
 
                                      
                                                                                   
 select CLTCODE,                                                                                                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                           
 into #p9_NSECM                                                                                                                
from AngelNseCM.account.dbo.ledger a with (nolock)                                                                                                                       
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
 vDT>=@sdtcur and  vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                                                       
 group by cltcode                                                                                                                    
                                                 
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                 
 into #p9_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                                                       
 /* where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end) */                                                                                                           
 where-- ( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and
 vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                                 
 select CLTCODE,                                                                          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_NSX                         
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                                                       
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS')and 
 vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                               
select CLTCODE,                                                
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
into #p9_MCD                                                                                                    
from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)          
where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
group by cltcode  

 /*added on May 29 to consider commodity segment*/
select CLTCODE,                                                
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
into #p9_MCX                                                                                                   
from ANGELcommodity.ACCOUNTMCDX.DBO.LEDGER a with (nolock)          
where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
group by cltcode 


select CLTCODE,                                                
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
into #p9_NCDEX                                                                                                  
from ANGELcommodity.ACCOUNTNCDX.DBO.LEDGER a with (nolock)          
where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
group by cltcode                                                                                                                   
  
  
                                                                                                  
 /* Fetch Deposit */  
 
                                                                           
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                 
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                    
 into #p9_dep_BSECM                                                                                                                
 from AngelBSECM.account_ab.dbo.ledger a with (nolock)                                                                        
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
 vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                      
 group by cltcode                                              
                                    
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSECM from AngelNseCM.account.dbo.ledger a with (nolock)                                                           
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
 vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                      
                                                                                                                
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                       
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                     
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS')and 
 vDT>=@sdtcur and vdt <= @ToDate and cltcode like '40%'                                                                                                                      
 group by cltcode                                                                                       
                                                                  
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                         
 into #p9_dep_NSX                                                                                                                
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                   
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
 vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                              
 group by cltcode                                       
                                                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                   
 into #p9_dep_MCD                        
 from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                                   
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
 vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode  
  /*added on May 29 to consider commodity segment*/
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                   
 into #p9_dep_MCX                        
 from ANGELcommodity.ACCOUNTMCDX.DBO.LEDGER  a with (nolock)                                   
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
 vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode 
 
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                   
 into #p9_dep_NCDEX                         
 from ANGELcommodity.ACCOUNTNCDX.DBO.LEDGER a with (nolock)                                   
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
 vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                                               
                                                                         
 update #p9_File1 set Balance=b.Vbal from #p9_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                                                      
 update #p9_File1 set Balance=b.Vbal from #p9_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode   
 update #p9_File1 set Balance=b.Vbal from #p9_MCX b where #p9_File1.segment='MCX' and #p9_File1.party_Code=b.cltcode                                                                                                      
 update #p9_File1 set Balance=b.Vbal from #p9_NCDEX b where #p9_File1.segment='NCDEX' and #p9_File1.party_Code=b.cltcode                                            

                                          
                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                          
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                                                                          
 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCX b where #p9_File1.segment='MCX' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NCDEX b where #p9_File1.segment='NCDEX' and #p9_File1.party_Code=b.cltcode                                                                                          
 
                                                                                                     
 update #p9_File1 set Earlypayinvalue=b.EPV from                      
 (select Exchange,party_code,SUM(total) as EPV from VMSS_EarlyPayinData group by Exchange,party_code) b          
 where #p9_File1.party_code=b.party_Code and #p9_File1.segment=b.exchange                                                                                              
                                                                                                                 
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                             
 (           
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelfo.nsefo.dbo.tbl_clientmargin with (nolock)                                                        
 where MarginDate = (select MAX(margindate) from angelfo.nsefo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                   
  ) b                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSEFO'                                                                                                      
                                                                                                      
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                            
 (                                                                                                      
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                                   
 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                         
  ) b                                                                                                       
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCD'                                                                                           
                                                                                        
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                      
 (                                                                             
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                      
 from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock)                                                                                                      
 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                          
) b                                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSX' 
  
  /*added on May 29 to consider commodity segment*/
  update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                            
 (                                                                                                      
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                                   
 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                         
  ) b                                                                                                       
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCX'                                                                                           
                                                                                        
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                      
 (                                                                             
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                      
 from ANGELCOMMODITY.NCDX.dbo.tbl_clientmargin with (nolock)                                                                                                      
 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                          
) b                                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NCDEX'                                                                                                      
 -------------------------------------------------------------------------------------------------------------------------------------------                                                                             
 update #p9_File1 set NonCashColl=b.NonCashColl                                         
 from VMSS_Client_collateral_NonEquity_NoBrInfo b                                                
 where #p9_File1.party_code=b.party_code and #p9_file1.segment=b.co_code                                                                                 
                                                                
/* Excess Collateral adjustement with Ledger Debit */            
 update #p9_File1 set NonCashColl=NonCashColl+Balance                                                                                                     
 where NonCashColl > 0 and Balance < 0 and segment in ('NSEFO','MCD','NSX','MCX','NCDEX')                                                               
                                                                               
 /* GEnerate Summarised Data */                    
                                                           
delete from #p9_file1 where party_code in (select party_code from mis.sccs.dbo.Combine_legal)                                                              
delete from #p9_file1 where party_code in (select party_code from General.dbo.client_Details where (branch_cd='NRIS' or sub_broker='BH'))                          
                        
/*Remove Tday and T+1 day clients ,added by abha as suggested by vishal gohil*/                           
                        
delete from #p9_file1 where party_code in (select Party_Code         
from General.dbo.tbl_projrisk_t1day_data where updt=(select max(updt) from General.dbo.tbl_projrisk_t1day_data))           
/* -----T day------ */        
        
          
                             
delete from #p9_file1 where party_code in (select party_Code from General.dbo.tbl_projrisk_t2day_data         
where updt=(select max(updt) from General.dbo.tbl_projrisk_t2day_data))            
/*------T+1day --------*/        
        
          
                                                                                     
select                                                                                                                 
max(processDate) as processDate,Party_code,convert(int,1) as NoofDays,                                                                                                                
sum(Balance) as Balance,sum(MarginAmt) as MarginAmt,sum(Deposit) as Deposit,                                               
sum(CashColl) as CashColl,sum(NonCashColl) as NonCashColl,sum(Holding_total) as Holding_BHC,                                                                                                   
sum(Holding_Approved) as Holding_AHC,sum(OtherDebit) as OtherDebit,                                                
sum(EarlyPayinValue) as EarlyPayinValue,sum(LeverageMultiplier) as LeverageMultiplier,                                                                                               
sum(VarMarginShortFall) as VarMarginShortFall,                                 
Convert(money,0) as NSEFO_JV,                                                                                                                
Convert(money,0) as NSEFO_NonCash,                                                                                                                
Convert(money,0) as MCD_JV,                                                                                               
Convert(money,0) as MCD_NonCash,                                                                                                                
Convert(money,0) as NSX_JV,                                                                                                                
Convert(money,0) as NSX_NonCash, 
Convert(money,0) as MCX_JV,                                                                                                                
Convert(money,0) as MCX_NonCash, 
Convert(money,0) as NCDEX_JV,                                                                                                                
Convert(money,0) as NCDEX_NonCash,                                                              
Convert(money,0) as VarMarginShortFall_AftAdj,                                                                                               
Convert(money,0) as Stage,                                                                                                                
sum(SquareOffValue) as SquareOffValue,Sum(Case when Segment='BSECM' then BAlance else 0 end) as BSECM_Balance,                                                                                                                 
Sum(Case when Segment='NSECM' then BAlance else 0 end) as NSECM_Balance,                                                         
Convert(money,0) as DP_adj ,                
Convert(money,0) as VarMarginShortFall_AftAdjCurrDay                                                     
into #p9_file2                                                                                                                
from #p9_file1 where segment in ('BSECM','NSECM','NSEFO','MCD','NSX','MCX','NCDEX')                                                                                                                
group by Party_code                                       
                                                           
/* delete Client with Cash Credit effective Balance */                                                                                                       
                                                              
Delete from #p9_file2 where balance >= @LowerCapAmt                          
Delete from #p9_file2 where party_code in (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF'))                                                                                  
Delete from #p9_file1 where party_Code not in (select party_code from #p9_file2)                                                                              
/*Delete from #p9_file2 where Holding_BHC <= 0 */ --commented on Aug 26 2016  as required by Vishal Gohil mail dated Aug 24 2016                                                    
                                  
update #p9_File2 set VarMarginShortFall=(case when Holding_AHC+Balance+Deposit+EarlypayinValue < @LowerCapAmt then Holding_AHC+Balance+Deposit+EarlypayinValue  else 0 end)                                                                                   
  
                                          
update #p9_File2 set LeverageMultiplier=                                                                                                                
Case when 100-(Holding_AHC/Holding_BHC)*100.00 > 100 then 100 else 100-(Holding_AHC/Holding_BHC)*100.00 end                                                                                                                
where Holding_BHC > 0                                                                                                  
                                                                          
update #p9_file1 set MgnAdjNonCash=0 where MgnAdjNonCash is null                                                                                            
update #p9_file1 set MgnAdjNonLed=0 where MgnAdjNonLed is null                                                    
                        
/* Adj.Margin with Non_Cash Scripwise */                                                                       
                                      
update vmss_NonCash set FinalAmount=Amount-(Amount*(MarginHC/100.00))                                              
update vmss_noncash set MarginSqOffQty=0                                                    
/*---- Full NonCash Getting adjusted against Margin */                                                                              
update vmss_noncash set MarginSqOffQty=Qty from                                                                              
(                                                                              
/*                                                              
select a.*,b.MarginAmt from                                                                              
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                              
(select segment,party_code,MArginAmt from #p9_file1 where MArginAmt > 0) b                        
on a.party_code=b.party_code and a.co_code=b.segment                                                                              
where b.MArginAmt >= a.VAHC                                                               
*/                                    
select a.*,b.MarginAmt from                                                    
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                            
(select segment,party_code,MArginAmt+(Case when balance < 0 then -balance else 0 end) as MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                       
on a.party_code=b.party_code and a.co_code=b.segment                                                                            
where b.MArginAmt >= a.VAHC                                                                
) x where vmss_noncash.party_code=x.party_Code and vmss_noncash.co_code=x.co_Code                                                
                                                                  
/*---- Partial NonCash Getting adjusted against Margin */                                                       
                                          
                                                         
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex from                                                                               
/* (select * from #p9_file1 where marginAmt > 0 ) a  left outer join             */                                                            
(select                       
processDate,segment,Party_code,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,                                                   
(Case when Balance < 0 then MarginAmt-Balance else MArginAmt end) as MarginAmt,                                                      
Deposit,CashColl,NonCashColl,Holding_total,Holding_Approved,OtherDebit,NonCashConsideration,                                                      
Net,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,SquareOffValue,MgnAdjNonCash,MgnAdjNonLed                                                      
from #p9_file1 where segment in ('NSEFO','MCD','NSX','MCX','NCDEX')) a  left outer join                                                     
(select co_code,party_code from vmss_noncash where MarginSqOffQty <> 0 group by party_code,Co_Code) b                                                                              
on a.party_code=b.party_code and a.segment=b.co_Code                                                                              
join (select co_code,party_code from vmss_noncash where MarginSqOffQty = 0 group by party_code,Co_Code) c                                                                              
on a.party_code=c.party_code and a.segment=c.co_Code                                                                              
where b.Party_Code is null                                                                              
                                                    
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                               
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0,@segment as varchar(10) = ''                                                                                
                                                
select @totctr=MAX(srno) from #p9_filex                                                                
                                                                  
While @ctr <= @totctr                                                                                                  
Begin                    
                                                                             
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=MarginAmt,@segment=segment from #p9_filex where srno=@ctr                                                                 
                     
select ROW_NUMBER() OVER (ORDER BY b.seqid,FinalAmount desc) AS [SrNo],                                                           
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,MarginHC as HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,                                                                              
clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty                                                                              
into #p9_holdadj from vmss_noncash a join                                                                                        
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                             
where party_code=@pcode and Clsrate > 0 and MarginHC < 100 and co_Code=@segment                             
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                        
set @TSqOffVal=0                                                                                  
                                                                  
set @Xctr=1                                                                                        
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                           
BEGIN                                                                     
                                                                         
select @TSqOffVal=FinalAmount,@qty=Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                
set @TSqOffVal=@SqOffVal                                                                                             
                                                                  
      
update vmss_noncash                                                                                        
set MarginSqOffQty=ceiling(Case when @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) <= @qty                                             
then @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) else @qty end)                                                                                    
where id=@id  and  MarginHC < 100                                                           
                                                                                  
set @SqOffVal=@SqOffVal-@TSqOffVal                                                                          
set @Xctr=@Xctr+1                                                                                                  
      
END                                                                                                  
                                 
DROP TABLE #p9_holdadj                                                                                                  
                                                                                        
set @ctr=@ctr+1                                
end                                                                                                  
         
drop table #p9_filex                                                                                                  
                                                                  
/* Calculation Margin Adjusted with NonCash */                                                                                                  
                                                                  
/*    
update #p9_file1 set MgnAdjNonCash=(Case when MarginAmt-(NonCashColl+CashColl) < 0 then MarginAmt else (NonCashColl+CashColl) end)                                                                          
where segment in ('NSEFO','MCD','NSX')                                                                                                  
*/                                                                              
                                                                  
update #p9_file1 set MgnAdjNonCash=B.AdjWithMargin from                                                                              
(                               
select co_Code,party_code,sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) as AdjWithMargin from vmss_noncash                                                                               
group by co_Code,party_code                                                                              
having sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) > 0                                            
) b where #p9_file1.party_code=b.party_Code and #p9_file1.segment=b.co_Code                                                        
                                                                                      
/* Calculation Margin Adjusted with Ledger Credit */                                                                                                  
update #p9_file1 set MgnAdjNonLed=(Case                                                 
when Balance > (MarginAmt-MgnAdjNonCash) and MarginAmt-MgnAdjNonCash > 0 and balance > 0 then (MarginAmt-MgnAdjNonCash)                                                                                        
when Balance <= (MarginAmt-MgnAdjNonCash) and balance > 0 then Balance                                                                                                  
else 0 end) where segment in ('NSEFO','MCD','NSX','MCX','NCDEX')                                                                   
                                             
                                       
                                                                                   
update  #p9_File2 set NSEFO_JV=b.AdjWithLedgerCr /*,NSEFO_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                                                             
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                   
from #p9_file1 where segment='NSEFO' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                                                     
                
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr /*,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                      
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                     
from #p9_file1 where segment='NSX' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                   
/*                                                                              
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                                
(              
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                          
from #p9_file1 where segment='NSX'                                                                                                     
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                
*/                                                                               
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                             
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                
from #p9_file1 where segment='MCD' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                    
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 

 /*added on May 29 to consider commodity segment*/                                                                   
update  #p9_File2 set MCX_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                             
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                
from #p9_file1 where segment='MCX' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                    
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 

update  #p9_File2 set NCDEX_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                             
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                
from #p9_file1 where segment='NCDEX' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                    
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
   
                                                                                                           
                                                                  
UPDATE #p9_File2 SET NSEFO_JV=-vARmARGINsHORTFALL  WHERE NSEFO_JV > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV > 0                                        
UPDATE #p9_File2 SET mcd_jv=-vARmARGINsHORTFALL-NSEFO_jv  WHERE mcd_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv >= 0             
UPDATE #p9_File2 SET NSX_jv=-VARMARGINSHORTFALL-NSEFO_JV-mcd_jv  WHERE nsx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv >= 0                                                      

 /*added on May 29 to consider commodity segment*/     
UPDATE #p9_File2 SET mcx_jv=-vARmARGINsHORTFALL-NSEFO_JV-mcd_jv-NSX_jv  WHERE mcx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv+mcx_jv >= 0             
UPDATE #p9_File2 SET ncdex_jv=-vARmARGINsHORTFALL-NSEFO_JV-mcd_jv-NSX_jv-mcx_jv  WHERE ncdex_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv+mcx_jv+ncdex_jv >= 0             

                                                                  
UPDATE #p9_File2 SET NSEFO_JV=0 where NSEFO_JV<0                                                                                        
UPDATE #p9_File2 SET mcd_jv=0 where mcd_jv<0                                                                                        
UPDATE #p9_File2 SET NSX_jv=0 where NSX_jv<0                              
 /*added on May 29 to consider commodity segment*/ 
UPDATE #p9_File2 SET mcx_jv=0 where mcx_jv<0                                                                                        
UPDATE #p9_File2 SET ncdex_jv=0 where ncdex_jv<0                                                                                                     
/* Adjust VarMArgin Shortage with NonCash Collateral */                                                                              
                                      
update vmss_NonCash set FinalAmount=Amount*(Haircut/100.00)                                                   
                                                                  
/*----- NSEFO-----*/                                         
                                                                  
set @totctr  = 0                          
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                        
set @Xctr = 1                                                                              
SET @qty = 0                             
set @TSqOffVal = 0                                                                                  
set @SqQty = 0                                                                    
set @clsrate =0                                                                                  
set @id = 0                                                                               


                                                
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex1                                                                              
from                                                                        
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+mcx_jv+ncdex_jv as VarMarginShortFallAftJV from #p9_file2 where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+mcx_jv+ncdex_jv < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSEFO' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                                                                     
select @totctr=MAX(srno) from #p9_filex1                                                                                                  
                                                                    
While @ctr <= @totctr                                                        
Begin                                                                                                  
                           
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex1 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                             
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                   
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj1                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                               
where party_code=@pcode and Clsrate > 0 and co_code='NSEFO' and haircut < 100                                              
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj1                                                                                                   
set @TSqOffVal=0          
set @Xctr=1                                                             
      
      
                        
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN                                                                      
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj1 where srno=@xctr                                                              
                         
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                                                                  
                                                            
update VMSS_NonCash                                                                           
set                                         
/* SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                        
SqOffseq=@xctr                                                                                     
where id=@id  and  Haircut < 100                                                                                          
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                  
      
set @Xctr=@Xctr+1          
      
                                                                                              
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj1                                                                                        
                                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                    
                                                                                       
update #p9_file2 set NSEFO_noncash=B.AdjustedAmt FROM                                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSEFO' and SquareOffQty > 0                                                                           
group by party_Code      
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                              
                                                                 
/*------ NSX ----*/                                                                
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                        
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                      
set @SqQty = 0                                                                      
set @clsrate =0                                                           
set @id = 0                                                                               
                                                   
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex2                                                                     
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+mcx_jv+ncdex_jv +NSEFO_noncash as VarMarginShortFallAftJV from #p9_file2                     
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSX' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                              
select @totctr=MAX(srno) from #p9_filex2                                                                                                  
                                                                                        
While @ctr <= @totctr                                                                                              
Begin                                                                                                  
                                                                          
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex2 where srno=@ctr                                                                              
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj2                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='NSX'  and haircut < 100                             
                                       
select @Xtotctr=MAX(Srno) from #p9_holdadj2                                                                                                   
set @TSqOffVal=0                                                                                         
                                                                  
set @Xctr=1                                                           
          
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN             
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj2 where srno=@xctr                       
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                               
                                                                  
update VMSS_NonCash                                                                              
/*set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                                        
SqOffseq=@xctr                                                                                  
where id=@id and Haircut < 100      
           
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                                                  
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj2                                                                                                  
                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                                              
drop table #p9_filex2                                                                                
                                                        
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSX' and SquareOffQty > 0                                               
group by party_Code                                                              
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                              
                                                                   
                                                                  
/*------ MCD ----*/                                                                              
                   
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                
set @SqQty = 0                                                                                  
set @clsrate =0                                                                                  
set @id = 0                                
                                        
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex3                                                                              
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+mcx_jv+ncdex_jv +NSEFO_noncash+MCD_noncash as VarMarginShortFallAftJV from #p9_file2                                                                               
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash < 0) a join                                            
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='MCD' group by party_code) c                                      
on a.party_code=c.party_code                                            
                                                                     
select @totctr=MAX(srno) from #p9_filex3                                                     
                                    
While @ctr <= @totctr                                                                                                  
Begin                          
                                                                
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex3 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj3                                                                  
from VMSS_NonCash_BalAfterMargin a join              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='MCD' and haircut < 100                                                                                                
                                         
select @Xtotctr=MAX(Srno) from #p9_holdadj3                               
set @TSqOffVal=0                                                                                                  
                                                                  
set @Xctr=1                                                 
                                                                     
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                               
BEGIN                                                                                                  
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj3 where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal               
                                                                  
update VMSS_NonCash                                                                                        
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),             
SqOffseq=@xctr                                                                                     
where id=@id and Haircut < 100                                                                                          
          
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                         
END                                                        
                                                                                        
DROP TABLE #p9_holdadj3                                                                                                  
                         
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                     
drop table #p9_filex3                                                                                
                                                                  
update #p9_file2 set MCD_noncash=B.AdjustedAmt FROM                                                                 (                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                              
from VMSS_NonCash_BalAfterMargin where co_Code='MCD' and SquareOffQty > 0                                                                           
group by party_Code                                                            
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE      
/*------ MCX ----*/                                                                              
                   
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                
set @SqQty = 0                                                                                  
set @clsrate =0                                                                                  
set @id = 0                                
                                        
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex4                                                                              
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+mcx_jv+ncdex_jv +NSEFO_noncash+MCD_noncash+NSX_noncash  as VarMarginShortFallAftJV from #p9_file2                                                                               
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash +NSX_noncash< 0) a join                                            
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='MCX' group by party_code) c                                      
on a.party_code=c.party_code                                            
                                                                     
select @totctr=MAX(srno) from #p9_filex4                                                     
                                    
While @ctr <= @totctr                                                                                                  
Begin                          
                                                                
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex4 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj4                                                                  
from VMSS_NonCash_BalAfterMargin a join              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='MCX' and haircut < 100                                                                                                
                                         
select @Xtotctr=MAX(Srno) from #p9_holdadj4                               
set @TSqOffVal=0                                                                                                  
                                                                  
set @Xctr=1                                                 
                                                                     
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                               
BEGIN                                                                                                  
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj4 where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal               
                                                                  
update VMSS_NonCash                                                                                        
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),             
SqOffseq=@xctr                                                                                     
where id=@id and Haircut < 100                                                                                          
          
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                         
END                                                        
                                                                                        
DROP TABLE #p9_holdadj4                                                                                                  
                         
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                     
drop table #p9_filex4                                                                                
                                                                  
update #p9_file2 set MCX_noncash=B.AdjustedAmt FROM                                                                 (                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                              
from VMSS_NonCash_BalAfterMargin where co_Code='MCX' and SquareOffQty > 0                                                                           
group by party_Code                                                            
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE      
 ------------------
/*------ NCDEX ----*/                                                                              
                   
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                
set @SqQty = 0                                                                                  
set @clsrate =0                                                                                  
set @id = 0                                
                                        
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex5                                                                              
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+mcx_jv+ncdex_jv +NSEFO_noncash+MCD_noncash+NSX_noncash+MCX_noncash  as VarMarginShortFallAftJV from #p9_file2                                                                               
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash+NSX_noncash+MCX_noncash < 0) a join                                            
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NCDEX' group by party_code) c                                      
on a.party_code=c.party_code                                            
                                                                     
select @totctr=MAX(srno) from #p9_filex5                                                     
                                    
While @ctr <= @totctr                                                                                                  
Begin                          
                                                                
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex5 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj5                                                                  
from VMSS_NonCash_BalAfterMargin a join              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='NCDEX' and haircut < 100                                                                                                
                                         
select @Xtotctr=MAX(Srno) from #p9_holdadj5                               
set @TSqOffVal=0                                                                                                  
                                                                  
set @Xctr=1                                                 
                                                                     
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                               
BEGIN                                                                                                  
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj5 where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal               
                                                                  
update VMSS_NonCash                                                                                        
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),             
SqOffseq=@xctr                                                                                     
where id=@id and Haircut < 100                                                                                          
          
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                         
END                                                        
                                                                                        
DROP TABLE #p9_holdadj5                                                                                                  
                         
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                     
drop table #p9_filex5                                                                                
                                                                  
update #p9_file2 set NCDEX_noncash=B.AdjustedAmt FROM                                                                 (                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                              
from VMSS_NonCash_BalAfterMargin where co_Code='NCDEX' and SquareOffQty > 0                                                                           
group by party_Code                                                            
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE  
                                                                   
/*----*/ 

---------                                                                             
UPDATE #p9_File2 SET NSEFO_NONCASH=0,MCD_NONCASH=0,NSX_NONCASH=0,MCX_NONCASH=0,NCDEX_NONCASH=0                                                                                                                 
WHERE NSefo_jv+MCD_JV+NSX_JV+MCX_NONCASH+NCDEX_NONCASH+vARmARGINsHORTFALL = 0 AND vARmARGINsHORTFALL < 0                                                                                    
                                                                  
/*                                                                               
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)                                                                          
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                                                 
AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                                                     
                                                                                                 
UPDATE #p9_FILE2 SET MCD_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET MCD_NONCASH=Stage                                                                                                                
UPDATE #p9_FILE2 SET Stage=0                                                             
                                             
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)                                                                                                                
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                                                                                                                
AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)*-1                                                       
                                                                                                     
UPDATE #p9_FILE2 SET NSX_NONCASH=0                                                       
UPDATE #p9_FILE2 SET NSX_NONCASH=Stage                                                                                                             
UPDATE #p9_FILE2 SET Stage=0                                                                                     
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)                                                                                                               
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                                                                                                               
AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)*-1                                                                                                                
                                                                             
UPDATE #p9_FILE2 SET NSEFO_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET NSEFO_NONCASH=Stage                                                          
UPDATE #p9_FILE2 SET Stage=0                                                                                                                
*/                                                                              
                                  
update #p9_File2  set VarMarginShortFall_AftAdjCurrDay=vARmARGINsHORTFALL+NSefo_jv+MCD_JV+NSX_JV+MCX_JV+NCDEX_JV+NSEFO_NONCASH+MCD_NONCASH+NSX_NONCASH+MCX_NONCASH+NCDEX_NONCASH                                                                                         
where  vARmARGINsHORTFALL < 0                                                                                                                 
        
update #p9_File2  set VarMarginShortFall_AftAdj=VarMarginShortFall_AftAdjCurrDay        
        
/*        
--- Used to compute min of last 4 days for squareoff.. not required as per PRMS id: 10391261 dt...14/08/2015...        
update #p9_File2 set VarMarginShortFall_AftAdj=(Case when #p9_File2.VarMarginShortFall_AftAdjCurrDay > q.VarMarginShortFall_AftAdjCurrDay                   
then #p9_File2.VarMarginShortFall_AftAdjCurrDay else q.VarMarginShortFall_AftAdjCurrDay end)                  
from                  
(                  
select Party_code,MAX(VarMarginShortFall_AftAdjCurrDay) as VarMarginShortFall_AftAdjCurrDay                   
from vmss_Data x join                  
(select top 3 processdate from (select distinct processdate from vmss_Data where processdate < @BSElastBillDate) a order by processdate) y                   
on x.processdate=y.processdate                               
group by party_code                  
) q where #p9_File2.party_code=q.party_code                  
*/          
                                      
/* Var Margin % */                                                                                  
                                                                                     
truncate table vmss_holding                                                                        
insert into vmss_holding                                                                                                      
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate)                                                
          
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,                                                                                                      
SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS [SrNo],0,ISIN,ActualSqOffQty=CONVERT(int,0),0.00 from #p9_hold                                                                                                      
                                                                        
/*                                                                                                    
select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #p9_filex                                                                                                       
from #p9_file2 where VarMarginShortFall_AftAdj < 0                
                                                                                
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                                                                      
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                                                                      
                                                                 
select @totctr=MAX(srno) from #p9_filex                                                                                                      
                                                                                           
While @ctr <= @totctr                                                                                                      
Begin                                                                                               
                                                                   
set @SqOffVal=0                                                              
select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdj*-1 from #p9_filex where srno=@ctr                                                                                                                      
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],* into #p9_holdadj from vmss_holding a join                                                                                                      
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                             
where party_code=@pcode and Clsrate > 0                                                                                    
                                                                                
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                                                     
set @TSqOffVal=0                                                                                                      
                                                                
set @Xctr=1                                                                                          
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                     
BEGIN                                                                                          
                                                                              
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                             
                                                  
if (@SqOffVal<@TSqOffVal)                                                              
set @TSqOffVal=@SqOffVal                                                                                                      
                                                              
update vmss_holding                                                                               
set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                                                       
SqOffseq=@xctr                                                                                         
where id=@id                                                                                
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                      
                      
set @Xctr=@Xctr+1                                                                                                      
END                                                                                                      
                                                                                           
DROP TABLE #p9_holdadj                                            
                                                                                           
set @ctr=@ctr+1                                            
end                                                                                                      
                                                                                          
drop table #p9_filex                                                                                                      
                                                                
truncate table vmss_holding_hist                                                                                                       
insert into vmss_holding(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq)                                                         
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq from vmss_holding                                                                                   
                                                                                     
update #p9_file2 set SquareOffValue=b.SqVal from                                                              
(                                                                                            
select party_code,sum(SquareOffQty*Clsrate) as SqVal from vmss_holding where isnull(SquareOffQty,0) > 0                                                                                       
group by party_code                                                                                            
) b                
where #p9_file2.party_code=b.party_Code                                                                                                      
*/                                                                                    
                                                                                        
/*                                                                                                            
update #p9_File2 set SquareOffValue=                                                                                                                
Case when (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 < (Holding_BHC)*-1 then (Holding_BHC)*-1                                                                                                                
else (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 end                                      
where LeverageMultiplier > 0                                                                                                                
*/                                                                                                      
                                                                               
/*                                                                              
UPDATE #p9_File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                             
(                                                                                  
SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                                                                           
(                                                                                     
SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                             
WHERE CONVERT(DATE,processdate) < (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data )                                                    
)                                                                                                                                          
) B WHERE #p9_File2.party_code=B.party_code                                                                                                        
                                                                                   
UPDATE #p9_File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                                            
              
*/                                                                                       

/*  
delete a from #p9_FILE2 a left outer join VMSS_ASB7_Days b on a.party_code=b.Party_code   
WHERE b.Party_code is null  
*/
  
delete from VMSS_data where processDate=@BSElastBillDate                                                                                                                
--commented on Mar 16 2020 as required by v gohil
/*select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'*/

--alter table VMSS_data add NCDEX_JV money,NCDEX_NonCash money
                                                                                         
insert into VMSS_data(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,                                                                                                      
Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,                                                                                                         
NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,remarks,DP_adj,Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay,MCX_JV,MCX_NonCash,NCDEX_JV,NCDEX_NonCash)                                                                           
   
SELECT processDate,'',A.Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,                                                                                                                
OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,                                                  
VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,GETDATE(),'V','',DP_adj,0.00,VarMarginShortFall_AftAdjCurrDay,MCX_JV,MCX_NonCash,NCDEX_JV,NCDEX_NonCash                                                                                                            
FROM #p9_FILE2 A 
/*
inner join mis.dbo.ASB7_Clidetails_CrDet_process2  B on A.Party_code=B.party_code
inner join #MTFCodes MTF on A.party_code=mtf.party_code where B.SQ_AMT> 0                                                                                                                
and B.T_day>0 and  rms_date=(select max(rms_date)from  mis.dbo.ASB7_Clidetails_CrDet_process2)  */                                                                 

/*                                                                                
insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                        
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks)                                                                                   
  
  
select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                                            
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks from VMSS_data                                                                     
  
  
*/                                                                  
                                                                        
End try                                                                                                                                     
BEGIN CATCH                                                                                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                              
  select GETDATE(),'VMSS_Calculation_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                                                                                   
                          
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                              
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                                                     
                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Calculation_NoNRMS_01082017
-- --------------------------------------------------
create Procedure [dbo].[VMSS_Calculation_NoNRMS_01082017]                                                                                                      
as                                                                                                                
                                                                                                                
SET XACT_ABORT ON                                                                                                                
Set nocount on                                                                                                                
BEGIN TRY                                                                                                                                        
  
 exec VMSS_upd_ASB7_Days    
                                                                             
 Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                                                                
 Declare @LowerCapNonCash as money = 500  /* NONCASH COLLATERAL MOVEMENT : always +ve */                                                                                                                
 Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                
                                                                                                          
 select                                                                                                                 
 @BSElastBillDate  as processDate,                                                                                                                
 b.Entity,                                                                                                                
 b.segment,                                                                                                                
 a.Party_code,                                                                                                                
 a.Ledger as Balance,                                                                                                                
 CONVERT(money,0)  as UnsettledCr,                                                                                                                
 CONVERT(money,0) as UnsettledDr,                                                                                                                
 a.Unrecosiled_Credit as UnrecoAmt,                                                                                                                
 CONVERT(money,0) as ShortSellValue,                                                                                                                
 a.Imargin as MarginAmt,                                                                                                                
 a.Deposit,                                                                                                                
a.Cash_Colleteral as CashColl,                                                                                                                
a.NonCash_Colleteral as NonCashColl,                                                                                                                
Holding_total,                                                                                                                
Holding_Approved,                                                                                                                
CONVERT(money,0) as OtherDebit,                                                      
CONVERT(int,0) as NonCashConsideration,          
CONVERT(money,0) as Net,   
CONVERT(money,0) as EarlyPayinValue,                    
CONVERT(money,0) as LeverageMultiplier,                            
CONVERT(money,0) as VarMarginShortFall,                                                                
CONVERT(money,0) as SquareOffValue,                                    
CONVERT(money,0) as MgnAdjNonCash,                                                       
CONVERT(money,0) as MgnAdjNonLed                                                                  
into #p9_File1                                                     
from (select * from General.dbo.RMS_DtClFi with (nolock) where 1=2) a join (select segment,entity from intranet.cms.dbo.ncms_entity with (nolock) where entity='Equity') b                                                                      
on a.Co_code=b.segment                                                                       
                                                                                                       
                                                                                                       
 /* update Holding */                                                                                                      
select EXCHANGE,sett_no,SEtt_type,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,Party_code,Qty,                                                                            
CLSRATE,                                                                                                                
Total AS VBHC,                                                                              
CONVERT(MONEY,0) AS HAIRCUT,                                                                                                                
CONVERT(MONEY,0) AS VAHC,                                                                                                    
SPACE(10) AS CATEGORY,                                                                                                                
source AS SRC,                                                                        
ISIN                                                                        
INTO #p9_HOLD                                                                                                                
from vmss_rms_holding where source in ('SI','SO','H','D')                    
  
update #p9_HOLD set series=b.NseSeries from general.dbo.scrip_master b  
where #p9_HOLD.isin=b.isin and b.NseSeries='EQ'   
  
                    
SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0          
DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin          
DROP TABLE #nqty          
                                                                                                       
update #p9_HOLD set clsrate=b.rate from General.dbo.cp_bsecm b where #p9_HOLD.scrip_Cd=b.scode and #p9_HOLD.clsrate=0                                                                                                                
                    
update #p9_HOLD set clsrate=b.cls                                                                                                                 
from General.dbo.cp_nsecm b                                                                                                       
where #p9_HOLD.scrip_Cd=b.scrip and #p9_HOLD.series=b.series and #p9_HOLD.clsrate=0 and exchange='NSECM'                                                                                                              
                    
update #p9_HOLD set VBHC=clsrate*Qty                                                                                           
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                    
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                               
where #p9_HOLD.SCRIP_cD=B.BSECODE AND #p9_HOLD.EXCHANGE='BSECM'                                                                                                                
    
    
/*Added to handle scrip:idfc ltd as it has shifted from BE to Eq as suggested by Vishal Gohil on Dec 10 2015*/    
--select * from #p9_HOLD where  isin='INE092T01019' and series='EQ'    
--update #p9_HOLD set series='EQ' where isin='INE092T01019' and series='BE'    
    
/* update a set series=b.Currenteries from #p9_HOLD a inner join VMSS_Exception_NSESeries b on a.isin=b.isin and a.series=b.previousseries  */  
    
/*******************************************************************/    
    
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                  
where #p9_HOLD.SCRIP_cD=B.NSESYMBOL AND #p9_HOLD.SERIES=B.NSESERIES AND #p9_HOLD.EXCHANGE='NSECM'                                                              
      
                    
update #p9_HOLD set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #p9_HOLD set VAHC=VBHC*((100-HAIRCUT)/100.00)                                                  
                    
insert into #p9_File1(segment,party_code)                                                              
select b.co_code,party_Code from                                                                                                      
/*(select party_code from #p9_hold group by party_code) a,*/ 
(select t_day,party_code from  mis.dbo.asb7_clidetails_crdet --commented on Aug 26 2016  as required by Vishal Gohil mail dated Aug 24 2016 
 where T_day>0 and  
 rms_date=(select max(rms_date)from  mis.dbo.asb7_clidetails_crdet)) a,                                                                                                      
(select * from General.dbo.company where entitytype='EQ' and bo_active=1) b                                                                                                      
                                                                                                      
update #p9_file1                                                                 
set entity='EQUITY',ProcessDate=@BSElastBillDate,Balance=0,UnsettledCr=0,UnsettledDr=0,UnrecoAmt=0,ShortSellValue=0,                                                                                       
MarginAmt=0,Deposit=0,CashColl=0,NonCashColl=0,Holding_total=0,Holding_Approved=0,OtherDebit=0,NonCashConsideration=0,Net=0,                                                                                                      
EarlyPayinValue=0,LeverageMultiplier=0,VarMarginShortFall=0,SquareOffValue=0                                                                                                      
                                                                                       
update #p9_File1 set holding_total=b.VBHC,holding_approved=b.VAHC from                                                                 
(select party_code,exchange,VBHC=sum(VBHC),VAHC=sum(VAHC)                                                                                                                
from #p9_hold group by party_code,exchange) b                                                                       
where #p9_File1.party_code=b.party_code and #p9_File1.segment=b.exchange                                                                              
                                                                                                      
/* Get Last settlement Date */                                                                                                     
                                                                                      
 Declare @sdtcur as datetime,-- @ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59'                                                                                                        
 @ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'                                  
 select @sdtcur=sdtcur from General.dbo.parameter with (nolock) where sdtcur <= @ToDate and ldtcur >=@ToDate                                           
                                       
/* Fetch effective Ledger Balance - Only Bill's effective date else voucher date*/                                 
                
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
 into #p9_BSECM                                                                                                                
 from anand.account_ab.dbo.ledger a with (nolock)                                                                                       
 where vDT>=@sdtcur and vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                           
 group by cltcode                                     
                                                                                   
 select CLTCODE,                                                                                                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                           
 into #p9_NSECM                                                                                                                
from anand1.account.dbo.ledger a with (nolock)                                                                                                                       
 where vDT>=@sdtcur and  vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                                                       
 group by cltcode                                                                                                                    
                                                 
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                 
 into #p9_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                                                       
 /* where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end) */                                                                                                           
  
  
    
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                                 
 select CLTCODE,                                                                          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_NSX                         
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                                                       
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                               
select CLTCODE,                                                
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
into #p9_MCD                                                                                                    
from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)          
where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
group by cltcode                                                                                                                    
                                                                                                  
 /* Fetch Deposit */                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                 
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                    
 into #p9_dep_BSECM                                                                                                                
 from anand.account_ab.dbo.ledger a with (nolock)                                                                        
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                      
 group by cltcode                                              
                                    
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSECM from anand1.account.dbo.ledger a with (nolock)                                                           
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                      
                                                                                                                
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                       
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                     
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '40%'                                                                                                                      
 group by cltcode                                                                                       
                                                                  
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                         
 into #p9_dep_NSX                                                                                                                
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                   
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                              
 group by cltcode                                       
                                                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                   
 into #p9_dep_MCD                        
 from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                                   
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                                                
                                                                         
 update #p9_File1 set Balance=b.Vbal from #p9_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                                                      
 update #p9_File1 set Balance=b.Vbal from #p9_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                            
                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                          
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                                                                          
                                                                                                      
 update #p9_File1 set Earlypayinvalue=b.EPV from                      
 (select Exchange,party_code,SUM(total) as EPV from VMSS_EarlyPayinData group by Exchange,party_code) b          
 where #p9_File1.party_code=b.party_Code and #p9_File1.segment=b.exchange                                                                                              
                                                                                                                 
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                             
 (           
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelfo.nsefo.dbo.tbl_clientmargin with (nolock)                                                        
 where MarginDate = (select MAX(margindate) from angelfo.nsefo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                   
  ) b                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSEFO'                                                                                                      
                                                                                                      
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                            
 (                                                                                                      
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                                   
 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                         
  ) b                                                                                                       
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCD'                                                                                           
                                                                                        
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                      
 (                                                                             
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                      
 from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock)                                                                                                      
 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                          
) b                                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSX'                                                                                                      
                                                                              
 update #p9_File1 set NonCashColl=b.NonCashColl                                         
 from VMSS_Client_collateral_NonEquity_NoBrInfo b                                                
 where #p9_File1.party_code=b.party_code and #p9_file1.segment=b.co_code                                                                                 
                                                                
/* Excess Collateral adjustement with Ledger Debit */            
 update #p9_File1 set NonCashColl=NonCashColl+Balance                                                                                                     
 where NonCashColl > 0 and Balance < 0 and segment in ('NSEFO','MCD','NSX')                                                               
                                                                               
 /* GEnerate Summarised Data */                    
                                                           
delete from #p9_file1 where party_code in (select party_code from mis.sccs.dbo.Combine_legal)                                                              
delete from #p9_file1 where party_code in (select party_code from General.dbo.client_Details where (branch_cd='NRIS' or sub_broker='BH'))                          
                        
/*Remove Tday and T+1 day clients ,added by abha as suggested by vishal gohil*/                           
                        
delete from #p9_file1 where party_code in (select Party_Code         
from General.dbo.SQUAREUP_CLIENT_ALERT where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT_ALERT))           
/* -----T day------ */        
        
          
                             
delete from #p9_file1 where party_code in (select party_Code from General.dbo.SQUAREUP_CLIENT         
where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT))            
/*------T+1day --------*/        
        
          
                                                                                     
select                                                                                                                 
max(processDate) as processDate,Entity,Party_code,convert(int,1) as NoofDays,                                                                                                                
sum(Balance) as Balance,sum(MarginAmt) as MarginAmt,sum(Deposit) as Deposit,                                               
sum(CashColl) as CashColl,sum(NonCashColl) as NonCashColl,sum(Holding_total) as Holding_BHC,                                                                                                   
sum(Holding_Approved) as Holding_AHC,sum(OtherDebit) as OtherDebit,                                                
sum(EarlyPayinValue) as EarlyPayinValue,sum(LeverageMultiplier) as LeverageMultiplier,                                                                                               
sum(VarMarginShortFall) as VarMarginShortFall,                                 
Convert(money,0) as NSEFO_JV,                                                                                                                
Convert(money,0) as NSEFO_NonCash,                                                                                                                
Convert(money,0) as MCD_JV,                                                                                               
Convert(money,0) as MCD_NonCash,                                                                                                                
Convert(money,0) as NSX_JV,                                                                                                                
Convert(money,0) as NSX_NonCash,                                                              
Convert(money,0) as VarMarginShortFall_AftAdj,                                                                                               
Convert(money,0) as Stage,                                                                                                                
sum(SquareOffValue) as SquareOffValue,Sum(Case when Segment='BSECM' then BAlance else 0 end) as BSECM_Balance,                                                                                                                 
Sum(Case when Segment='NSECM' then BAlance else 0 end) as NSECM_Balance,                                                         
Convert(money,0) as DP_adj ,                
Convert(money,0) as VarMarginShortFall_AftAdjCurrDay                                                     
into #p9_file2                                                                                                                
from #p9_file1 where segment in ('BSECM','NSECM')                                                                                                                
group by Entity,Party_code                                       
                                                           
/* delete Client with Cash Credit effective Balance */                                                                                                       
                                                              
Delete from #p9_file2 where balance >= @LowerCapAmt                          
Delete from #p9_file2 where party_code in (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF'))                                                                                  
Delete from #p9_file1 where party_Code not in (select party_code from #p9_file2)                                                                              
/*Delete from #p9_file2 where Holding_BHC <= 0 */ --commented on Aug 26 2016  as required by Vishal Gohil mail dated Aug 24 2016                                                    
                                  
update #p9_File2 set VarMarginShortFall=(case when Holding_AHC+Balance+Deposit+EarlypayinValue < @LowerCapAmt then Holding_AHC+Balance+Deposit+EarlypayinValue  else 0 end)                                                                                   
  
                                          
update #p9_File2 set LeverageMultiplier=                                                                                                                
Case when 100-(Holding_AHC/Holding_BHC)*100.00 > 100 then 100 else 100-(Holding_AHC/Holding_BHC)*100.00 end                                                                                                                
where Holding_BHC > 0                                                                                                  
                                                                          
update #p9_file1 set MgnAdjNonCash=0 where MgnAdjNonCash is null                                                                                            
update #p9_file1 set MgnAdjNonLed=0 where MgnAdjNonLed is null                                                    
                        
/* Adj.Margin with Non_Cash Scripwise */                                                                       
                                      
update vmss_NonCash set FinalAmount=Amount-(Amount*(MarginHC/100.00))                                              
update vmss_noncash set MarginSqOffQty=0                                                    
/*---- Full NonCash Getting adjusted against Margin */                                                                              
update vmss_noncash set MarginSqOffQty=Qty from                                                                              
(                                                                              
/*                                                              
select a.*,b.MarginAmt from                                                                              
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                              
(select segment,party_code,MArginAmt from #p9_file1 where MArginAmt > 0) b                        
on a.party_code=b.party_code and a.co_code=b.segment                                                                              
where b.MArginAmt >= a.VAHC                                                               
*/                                    
select a.*,b.MarginAmt from                                                    
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                            
(select segment,party_code,MArginAmt+(Case when balance < 0 then -balance else 0 end) as MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                       
on a.party_code=b.party_code and a.co_code=b.segment                                                                            
where b.MArginAmt >= a.VAHC                                                                
) x where vmss_noncash.party_code=x.party_Code and vmss_noncash.co_code=x.co_Code                                                
                                                                  
/*---- Partial NonCash Getting adjusted against Margin */                                                       
                                          
                                                         
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex from                                                                               
/* (select * from #p9_file1 where marginAmt > 0 ) a  left outer join             */                                                            
(select                       
processDate,Entity,segment,Party_code,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,                                                   
(Case when Balance < 0 then MarginAmt-Balance else MArginAmt end) as MarginAmt,                                                      
Deposit,CashColl,NonCashColl,Holding_total,Holding_Approved,OtherDebit,NonCashConsideration,                                                      
Net,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,SquareOffValue,MgnAdjNonCash,MgnAdjNonLed                                                      
from #p9_file1 where segment in ('NSEFO','MCD','NSX')) a  left outer join                                                     
(select co_code,party_code from vmss_noncash where MarginSqOffQty <> 0 group by party_code,Co_Code) b                                                                              
on a.party_code=b.party_code and a.segment=b.co_Code                                                                              
join (select co_code,party_code from vmss_noncash where MarginSqOffQty = 0 group by party_code,Co_Code) c                                                                              
on a.party_code=c.party_code and a.segment=c.co_Code                                                                              
where b.Party_Code is null                                                                              
                                                    
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                               
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0,@segment as varchar(10) = ''                                                                                
                                                
select @totctr=MAX(srno) from #p9_filex                                                                
                                                                  
While @ctr <= @totctr                                                                                                  
Begin                    
                                                                             
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=MarginAmt,@segment=segment from #p9_filex where srno=@ctr                                                                 
                     
select ROW_NUMBER() OVER (ORDER BY b.seqid,FinalAmount desc) AS [SrNo],                                                           
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,MarginHC as HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,                                                                              
clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty                                                                              
into #p9_holdadj from vmss_noncash a join                                                                                        
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                             
where party_code=@pcode and Clsrate > 0 and MarginHC < 100 and co_Code=@segment                             
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                        
set @TSqOffVal=0                                                                                  
                                                                  
set @Xctr=1                                                                                        
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                           
BEGIN                                                                     
                                                                         
select @TSqOffVal=FinalAmount,@qty=Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                
set @TSqOffVal=@SqOffVal                                                                                             
                                                                  
      
update vmss_noncash                                                                                        
set MarginSqOffQty=ceiling(Case when @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) <= @qty                                             
then @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) else @qty end)                                                                                    
where id=@id  and  MarginHC < 100                                                           
                                                                                  
set @SqOffVal=@SqOffVal-@TSqOffVal                                                                          
set @Xctr=@Xctr+1                                                                                                  
      
END                                                                                                  
                                 
DROP TABLE #p9_holdadj                                                                                                  
                                                                                        
set @ctr=@ctr+1                                
end                                                                                                  
         
drop table #p9_filex                                                                                                  
                                                                  
/* Calculation Margin Adjusted with NonCash */                                                                                                  
                                                                  
/*    
update #p9_file1 set MgnAdjNonCash=(Case when MarginAmt-(NonCashColl+CashColl) < 0 then MarginAmt else (NonCashColl+CashColl) end)                                                                          
where segment in ('NSEFO','MCD','NSX')                                                                                                  
*/                                                                              
                                                                  
update #p9_file1 set MgnAdjNonCash=B.AdjWithMargin from                                                                              
(                               
select co_Code,party_code,sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) as AdjWithMargin from vmss_noncash                                                                               
group by co_Code,party_code                                                                              
having sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) > 0                                            
) b where #p9_file1.party_code=b.party_Code and #p9_file1.segment=b.co_Code                                                        
                                                                                      
/* Calculation Margin Adjusted with Ledger Credit */                                                                                                  
update #p9_file1 set MgnAdjNonLed=(Case                                                 
when Balance > (MarginAmt-MgnAdjNonCash) and MarginAmt-MgnAdjNonCash > 0 and balance > 0 then (MarginAmt-MgnAdjNonCash)                                                                                        
when Balance <= (MarginAmt-MgnAdjNonCash) and balance > 0 then Balance                                                                                                  
else 0 end) where segment in ('NSEFO','MCD','NSX')                                                                   
                                             
                                       
                                                                                   
update  #p9_File2 set NSEFO_JV=b.AdjWithLedgerCr /*,NSEFO_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                                                              
  
  
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                   
from #p9_file1 where segment='NSEFO' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                                                     
                
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr /*,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                      
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                     
from #p9_file1 where segment='NSX' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                   
/*                                                                              
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                                
(              
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                          
from #p9_file1 where segment='NSX'                                                                                                     
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                
*/                                                                               
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                             
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                
from #p9_file1 where segment='MCD' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                    
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                   
/*                                                                                                                 
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                                
(                                                                                                    
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                     
from #p9_file1 where segment='MCD'                                                                                                     
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                           
*/                                                                                                        
                                                                  
UPDATE #p9_File2 SET NSEFO_JV=-vARmARGINsHORTFALL  WHERE NSEFO_JV > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV > 0                                        
UPDATE #p9_File2 SET mcd_jv=-vARmARGINsHORTFALL-NSEFO_jv  WHERE mcd_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv >= 0            
  
   
UPDATE #p9_File2 SET NSX_jv=-VARMARGINSHORTFALL-NSEFO_JV-mcd_jv  WHERE nsx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv >= 0                                                      
                                                                   
UPDATE #p9_File2 SET NSEFO_JV=0 where NSEFO_JV<0                                                                                        
UPDATE #p9_File2 SET mcd_jv=0 where mcd_jv<0                                                                                        
UPDATE #p9_File2 SET NSX_jv=0 where NSX_jv<0                              
                                                                                                    
/* Adjust VarMArgin Shortage with NonCash Collateral */                                                                              
                                      
update vmss_NonCash set FinalAmount=Amount*(Haircut/100.00)                                                   
                                                                  
/*----- NSEFO-----*/                                         
                                                                  
set @totctr  = 0                          
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                        
set @Xctr = 1                                                                              
SET @qty = 0                             
set @TSqOffVal = 0                                                                                  
set @SqQty = 0                                                                    
set @clsrate =0                                                                                  
set @id = 0                                                                               
                                                            
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex1                                                                              
from                                                                        
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv as VarMarginShortFallAftJV from #p9_file2 where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSEFO' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                                                                     
select @totctr=MAX(srno) from #p9_filex1                                                                                                  
                                                                    
While @ctr <= @totctr                                                        
Begin                                                                                                  
                           
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex1 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                             
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                   
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj1                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                               
where party_code=@pcode and Clsrate > 0 and co_code='NSEFO' and haircut < 100                                              
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj1                                                                                                   
set @TSqOffVal=0          
set @Xctr=1                                                             
      
      
                        
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN                                                                      
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj1 where srno=@xctr                                                              
                         
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                                                                  
                                                            
update VMSS_NonCash                                                                           
set                                         
/* SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                        
SqOffseq=@xctr                                                                                     
where id=@id  and  Haircut < 100                                                                                          
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                  
      
set @Xctr=@Xctr+1          
      
                                                                                              
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj1                                                                                        
                                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                    
                                                                                       
update #p9_file2 set NSEFO_noncash=B.AdjustedAmt FROM                                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSEFO' and SquareOffQty > 0                                                                           
group by party_Code      
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                              
                                                                 
/*------ NSX ----*/                                                                
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                        
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                      
set @SqQty = 0                                                                      
set @clsrate =0                                                           
set @id = 0                                                                               
                                                   
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex2                                                                     
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash as VarMarginShortFallAftJV from #p9_file2                     
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSX' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                              
select @totctr=MAX(srno) from #p9_filex2                                                                                                  
                                                                                        
While @ctr <= @totctr                                                                                              
Begin                                                                                                  
                                                                          
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex2 where srno=@ctr                                                                              
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj2                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='NSX'  and haircut < 100                             
                                       
select @Xtotctr=MAX(Srno) from #p9_holdadj2                                                                                                   
set @TSqOffVal=0                                                                                         
                                                                  
set @Xctr=1                                                           
          
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN             
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj2 where srno=@xctr                       
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                               
                                                                  
update VMSS_NonCash                                                                              
/*set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                                        
SqOffseq=@xctr                                                                                  
where id=@id and Haircut < 100      
           
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                                                  
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj2                                                                                                  
                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                                              
drop table #p9_filex2                                                                                
                                                        
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSX' and SquareOffQty > 0                                               
group by party_Code                                                              
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                              
                                                                   
                                                                  
/*------ MCD ----*/                                                                              
                   
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                
set @SqQty = 0                                                                                  
set @clsrate =0                                                                                  
set @id = 0                                
                                        
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex3                                                                              
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash as VarMarginShortFallAftJV from #p9_file2                                                                               
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash < 0) a join                                            
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='MCD' group by party_code) c                                      
on a.party_code=c.party_code                                            
                                                                     
select @totctr=MAX(srno) from #p9_filex3                                                     
                                    
While @ctr <= @totctr                                                                                                  
Begin                          
                                                                
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex3 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj3                                                                  
from VMSS_NonCash_BalAfterMargin a join              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='MCD' and haircut < 100                                                                                                
                                         
select @Xtotctr=MAX(Srno) from #p9_holdadj3                               
set @TSqOffVal=0                                                                                                  
                                                                  
set @Xctr=1                                                 
                                                                     
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                               
BEGIN                                                                                                  
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj3 where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal               
                                                                  
update VMSS_NonCash                                                                                        
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),             
SqOffseq=@xctr                                                                                     
where id=@id and Haircut < 100                                                                                          
          
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                         
END                                                        
                                                                                        
DROP TABLE #p9_holdadj3                                                                                                  
                         
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                     
drop table #p9_filex3                                                                                
                                                                  
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                                 (                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                              
from VMSS_NonCash_BalAfterMargin where co_Code='MCD' and SquareOffQty > 0                                                                           
group by party_Code                                                            
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE      
                                                                  
/*----*/                                                                              
UPDATE #p9_File2 SET NSEFO_NONCASH=0,MCD_NONCASH=0,NSX_NONCASH=0                                                                                                                 
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL = 0 AND vARmARGINsHORTFALL < 0                                                                                    
                                                                  
/*                                                                               
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)                                                                          
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                                                 
AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                                                     
                                                                                                 
UPDATE #p9_FILE2 SET MCD_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET MCD_NONCASH=Stage                                                                                                                
UPDATE #p9_FILE2 SET Stage=0                                                             
                                             
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)                                                                                                                
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                                                                                                                
AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)*-1                                                       
                                                                                                     
UPDATE #p9_FILE2 SET NSX_NONCASH=0                                                       
UPDATE #p9_FILE2 SET NSX_NONCASH=Stage                                                                                                             
UPDATE #p9_FILE2 SET Stage=0                                                                                     
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)                                                                                                               
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                                                                                                               
AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)*-1                                                                                                                
                                                                             
UPDATE #p9_FILE2 SET NSEFO_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET NSEFO_NONCASH=Stage                                                          
UPDATE #p9_FILE2 SET Stage=0                                                                                                                
*/                                                                              
                                  
update #p9_File2  set VarMarginShortFall_AftAdjCurrDay=vARmARGINsHORTFALL+NSefo_jv+MCD_JV+NSX_JV+NSEFO_NONCASH+MCD_NONCASH+NSX_NONCASH                                                                                         
where  vARmARGINsHORTFALL < 0                                                                                                                 
        
update #p9_File2  set VarMarginShortFall_AftAdj=VarMarginShortFall_AftAdjCurrDay        
        
/*        
--- Used to compute min of last 4 days for squareoff.. not required as per PRMS id: 10391261 dt...14/08/2015...        
update #p9_File2 set VarMarginShortFall_AftAdj=(Case when #p9_File2.VarMarginShortFall_AftAdjCurrDay > q.VarMarginShortFall_AftAdjCurrDay                   
then #p9_File2.VarMarginShortFall_AftAdjCurrDay else q.VarMarginShortFall_AftAdjCurrDay end)                  
from                  
(                  
select Party_code,MAX(VarMarginShortFall_AftAdjCurrDay) as VarMarginShortFall_AftAdjCurrDay                   
from vmss_Data x join                  
(select top 3 processdate from (select distinct processdate from vmss_Data where processdate < @BSElastBillDate) a order by processdate) y                   
on x.processdate=y.processdate                               
group by party_code                  
) q where #p9_File2.party_code=q.party_code                  
*/          
                                      
/* Var Margin % */                                                                                  
                                                                                     
truncate table vmss_holding                                                                        
insert into vmss_holding                                                                                                      
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate)                                                
          
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,                                                                                                      
SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS [SrNo],0,ISIN,ActualSqOffQty=CONVERT(int,0),0.00 from #p9_hold                                                                                                      
                                                                        
/*                                                                                                    
select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #p9_filex                                                                                                       
from #p9_file2 where VarMarginShortFall_AftAdj < 0                
                                                                                
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                                                                      
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                                                                      
                                                                 
select @totctr=MAX(srno) from #p9_filex                                                                                                      
                                                                                           
While @ctr <= @totctr                                                                                                      
Begin                                                                                               
                                                                   
set @SqOffVal=0                                                              
select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdj*-1 from #p9_filex where srno=@ctr                                                                                                                      
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],* into #p9_holdadj from vmss_holding a join                                                                                                      
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                             
where party_code=@pcode and Clsrate > 0                                                                                    
                                                                                
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                                                     
set @TSqOffVal=0                                                                                                      
                                                                
set @Xctr=1                                                                                          
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                     
BEGIN                                                                                          
                                                                              
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                             
                                                  
if (@SqOffVal<@TSqOffVal)                                                              
set @TSqOffVal=@SqOffVal                                                                                                      
                                                              
update vmss_holding                                                                               
set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                                                       
SqOffseq=@xctr                                                                                         
where id=@id                                                                                
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                      
                      
set @Xctr=@Xctr+1                                                                                                      
END                                                                                                      
                                                                                           
DROP TABLE #p9_holdadj                                            
                                                                                           
set @ctr=@ctr+1                                            
end                                                                                                      
                                                                                          
drop table #p9_filex                                                                                                      
                                                                
truncate table vmss_holding_hist                                                                                                       
insert into vmss_holding(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq)                                                         
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq from vmss_holding                                                                                   
                                                                                     
update #p9_file2 set SquareOffValue=b.SqVal from                                                              
(                                                                                            
select party_code,sum(SquareOffQty*Clsrate) as SqVal from vmss_holding where isnull(SquareOffQty,0) > 0                                                                                       
group by party_code                                                                                            
) b                
where #p9_file2.party_code=b.party_Code                                                                                                      
*/                                                                                    
                                                                                        
/*                                                                                                            
update #p9_File2 set SquareOffValue=                                                                                                                
Case when (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 < (Holding_BHC)*-1 then (Holding_BHC)*-1                                                                                                                
else (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 end                                      
where LeverageMultiplier > 0                                                                                                                
*/                                                                                                      
                                                                               
/*                                                                              
UPDATE #p9_File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                             
(                                                                                  
SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                                                                           
(                                                                                     
SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                             
WHERE CONVERT(DATE,processdate) < (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data )                                                    
)                                                                                                                                          
) B WHERE #p9_File2.party_code=B.party_code                                                                                                        
                                                                                   
UPDATE #p9_File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                                            
              
*/                                                                                       

/*  
delete a from #p9_FILE2 a left outer join VMSS_ASB7_Days b on a.party_code=b.Party_code   
WHERE b.Party_code is null  
*/
  
delete from VMSS_data where processDate=@BSElastBillDate                                                                                                                

select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'
                                                                                         
insert into VMSS_data(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,                                                                                                      
Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,                                                                                                         
NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,remarks,DP_adj,Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                                                                           
   
SELECT processDate,Entity,A.Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,                                                                                                                
OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,                                                  
VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,GETDATE(),'V','',DP_adj,0.00,VarMarginShortFall_AftAdjCurrDay                                                                                                            
FROM #p9_FILE2 A inner join mis.dbo.asb7_clidetails_crdet  B on A.Party_code=B.party_code
inner join #MTFCodes MTF on A.party_code=B.party_code where B.SQ_AMT> 0                                                                                                                
and B.T_day>0 and  rms_date=(select max(rms_date)from  mis.dbo.asb7_clidetails_crdet)                                                                   

/*                                                                                
insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                        
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks)                                                                                   
  
  
select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                                            
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks from VMSS_data                                                                     
  
  
*/                                                                  
                                                                        
End try                                                                                                                                     
BEGIN CATCH                                                                                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                              
  select GETDATE(),'VMSS_Calculation_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                                                                                   
                          
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                              
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                                                     
                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Calculation_NoNRMS_10122015
-- --------------------------------------------------
  
Create Procedure [dbo].[VMSS_Calculation_NoNRMS_10122015]                                                                                                  
as                                                                                                            
                                                                                                            
SET XACT_ABORT ON                                                                                                            
Set nocount on                                                                                                            
BEGIN TRY                                                                                                                                    
                                                                          
 Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                                                            
 Declare @LowerCapNonCash as money = 500  /* NONCASH COLLATERAL MOVEMENT : always +ve */                                                                                                            
 Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                            
                                                                                                      
 select                                                                                                             
 @BSElastBillDate  as processDate,                                                                                                            
 b.Entity,                                                                                                            
 b.segment,                                                                                                            
 a.Party_code,                                                                                                            
 a.Ledger as Balance,                                                                                                            
 CONVERT(money,0)  as UnsettledCr,                                                                                                            
 CONVERT(money,0) as UnsettledDr,                                                                                                            
 a.Unrecosiled_Credit as UnrecoAmt,                                                                                                            
 CONVERT(money,0) as ShortSellValue,                                                                                                            
 a.Imargin as MarginAmt,                                                                                                            
 a.Deposit,                                                                                                            
a.Cash_Colleteral as CashColl,                                                                                                            
a.NonCash_Colleteral as NonCashColl,                                                                                                            
Holding_total,                                                                                                            
Holding_Approved,                                                                                                            
CONVERT(money,0) as OtherDebit,                                                  
CONVERT(int,0) as NonCashConsideration,                                                                                                
CONVERT(money,0) as Net,                                             
CONVERT(money,0) as EarlyPayinValue,                
CONVERT(money,0) as LeverageMultiplier,                        
CONVERT(money,0) as VarMarginShortFall,                                                            
CONVERT(money,0) as SquareOffValue,                                
CONVERT(money,0) as MgnAdjNonCash,                                                   
CONVERT(money,0) as MgnAdjNonLed                                                              
into #p9_File1                                                 
from (select * from General.dbo.RMS_DtClFi with (nolock) where 1=2) a join (select segment,entity from intranet.cms.dbo.ncms_entity with (nolock) where entity='Equity') b                                                                  
on a.Co_code=b.segment                                                                   
                                                                                                   
                                                                                                   
 /* update Holding */                                                                                                  
                                                            
select EXCHANGE,sett_no,SEtt_type,                                                                                                            
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY1 ELSE SCRIP_CD END) AS scrip_cd,                                                                                                            
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,Party_code,Qty,                                                                        
CLSRATE,                                                                                                            
Total AS VBHC,                                                                          
CONVERT(MONEY,0) AS HAIRCUT,                                                                                                            
CONVERT(MONEY,0) AS VAHC,                                                                                                
SPACE(10) AS CATEGORY,                                                                                                            
source AS SRC,                                                                    
ISIN                                                                    
INTO #p9_HOLD                                                                                                            
from vmss_rms_holding where source in ('SI','SO','H','D')                
                
SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0      
DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin      
DROP TABLE #nqty      
                                                                                                   
update #p9_HOLD set clsrate=b.rate from General.dbo.cp_bsecm b where #p9_HOLD.scrip_Cd=b.scode and #p9_HOLD.clsrate=0                                                                                                            
                
update #p9_HOLD set clsrate=b.cls                                                                                                             
from General.dbo.cp_nsecm b                                                                                                   
where #p9_HOLD.scrip_Cd=b.scrip and #p9_HOLD.series=b.series and #p9_HOLD.clsrate=0 and exchange='NSECM'                                                                                                          
                
update #p9_HOLD set VBHC=clsrate*Qty                                                                                                            
                
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                           
    
      
where #p9_HOLD.SCRIP_cD=B.BSECODE AND #p9_HOLD.EXCHANGE='BSECM'                                                                                                            
                
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                  
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                              
where #p9_HOLD.SCRIP_cD=B.NSESYMBOL AND #p9_HOLD.SERIES=B.NSESERIES AND #p9_HOLD.EXCHANGE='NSECM'                                                          
                
update #p9_HOLD set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                            
                
update #p9_HOLD set VAHC=VBHC*((100-HAIRCUT)/100.00)                                              
                
insert into #p9_File1(segment,party_code)                                                          
select b.co_code,party_Code from                                                                                                  
(select party_code from #p9_hold group by party_code) a,                                                                                                   
(select * from General.dbo.company where entitytype='EQ' and bo_active=1) b                                                                                                  
                                                                                                  
update #p9_file1                                                             
set entity='EQUITY',ProcessDate=@BSElastBillDate,Balance=0,UnsettledCr=0,UnsettledDr=0,UnrecoAmt=0,ShortSellValue=0,                                                                                   
MarginAmt=0,Deposit=0,CashColl=0,NonCashColl=0,Holding_total=0,Holding_Approved=0,OtherDebit=0,NonCashConsideration=0,Net=0,                                                                                                  
EarlyPayinValue=0,LeverageMultiplier=0,VarMarginShortFall=0,SquareOffValue=0                                                                                                  
                                                                                   
update #p9_File1 set holding_total=b.VBHC,holding_approved=b.VAHC from                                                             
(select party_code,exchange,VBHC=sum(VBHC),VAHC=sum(VAHC)                                                                                                            
from #p9_hold group by party_code,exchange) b                                                                   
where #p9_File1.party_code=b.party_code and #p9_File1.segment=b.exchange                                                                                                            
                                                                                                  
/* Get Last settlement Date */                                                                                                 
                                                                                  
 Declare @sdtcur as datetime,-- @ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59'                                                                                                    
 @ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'                              
 select @sdtcur=sdtcur from General.dbo.parameter with (nolock) where sdtcur <= @ToDate and ldtcur >=@ToDate                                       
                                   
/* Fetch effective Ledger Balance - Only Bill's effective date else voucher date*/                             
            
 select CLTCODE,                                                                                                            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                      
 into #p9_BSECM                                                                                                            
 from anand.account_ab.dbo.ledger a with (nolock)                                                                                   
 where vDT>=@sdtcur and vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                       
 group by cltcode                                 
                                                                               
 select CLTCODE,                                                                                              
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                       
 into #p9_NSECM                                                                                                            
from anand1.account.dbo.ledger a with (nolock)                                                                                                                   
 where vDT>=@sdtcur and  vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                                                   
 group by cltcode                                                                                                                
                                             
 select CLTCODE,                                                                                                            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                             
 into #p9_NSEFO                                                                                                            
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                                                   
 /* where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end) */                                                                                                           
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate         
 group by cltcode                                                                                                                
                                                             
 select CLTCODE,                                                                                                            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            
 into #p9_NSX                                                                                             
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                                                   
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate         
 group by cltcode                                                                                                                
                                                           
select CLTCODE,                                            
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                      
into #p9_MCD                                                                                                
from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)      
where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate         
group by cltcode                                                                                                                
                                                                                              
 /* Fetch Deposit */                                                                        
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                             
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                
 into #p9_dep_BSECM                                                                                                            
 from anand.account_ab.dbo.ledger a with (nolock)                                                                    
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                  
 group by cltcode                                          
                                
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            
 into #p9_dep_NSECM from anand1.account.dbo.ledger a with (nolock)                                                       
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                  
 group by cltcode                                                                  
                                                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                   
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            
 into #p9_dep_NSEFO                                                                                                            
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                 
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '40%'                                                                                                                  
 group by cltcode                                                                                   
                                                                                                              
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            
 into #p9_dep_NSX                                                                                                            
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                               
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                          
 group by cltcode                                   
                                                                                                        
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                               
 into #p9_dep_MCD                    
 from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                               
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                  
 group by cltcode                                                                                            
                                                                     
 update #p9_File1 set Balance=b.Vbal from #p9_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                                                            
 update #p9_File1 set Balance=b.Vbal from #p9_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                            
 update #p9_File1 set Balance=b.Vbal from #p9_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                                            
 update #p9_File1 set Balance=b.Vbal from #p9_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                                                  
 update #p9_File1 set Balance=b.Vbal from #p9_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                        
                                                                                                            
 update #p9_File1 set deposit=b.Vbal from #p9_dep_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                       
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                                                            
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                      
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                       
 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                                                                      
                                                                                                  
 update #p9_File1 set Earlypayinvalue=b.EPV from                                                                                                       
 (select Exchange,party_code,SUM(total) as EPV from VMSS_EarlyPayinData group by Exchange,party_code) b                                                                                                            
 where #p9_File1.party_code=b.party_Code and #p9_File1.segment=b.exchange                                                                                                  
                                                                                                             
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                         
 (       
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                  
 from angelfo.nsefo.dbo.tbl_clientmargin with (nolock)                                                    
 where MarginDate = (select MAX(margindate) from angelfo.nsefo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                               
  ) b                                                                
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSEFO'                                                                                                  
                                                                                                  
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                        
 (                                                                                                  
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                  
 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                               
 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                     
  ) b                                                                                                   
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCD'                                                                                       
                                                                                    
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                  
 (                                                                         
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                  
 from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock)                                                                                                  
 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                      
) b                                                                                
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSX'                                                                                                  
                                                                          
 update #p9_File1 set NonCashColl=b.NonCashColl                                     
 from VMSS_Client_collateral_NonEquity_NoBrInfo b                                                                                                  
 where #p9_File1.party_code=b.party_code and #p9_file1.segment=b.co_code                                                                             
                                                            
/* Excess Collateral adjustement with Ledger Debit */                                                            
 update #p9_File1 set NonCashColl=NonCashColl+Balance                                                                                                 
 where NonCashColl > 0 and Balance < 0 and segment in ('NSEFO','MCD','NSX')                                                           
                                                                           
 /* GEnerate Summarised Data */                
                                                       
delete from #p9_file1 where party_code in (select party_code from mis.sccs.dbo.Combine_legal)                                                          
delete from #p9_file1 where party_code in (select party_code from General.dbo.client_Details where (branch_cd='NRIS' or sub_broker='BH'))                      
                    
/*Remove Tday and T+1 day clients ,added by abha as suggested by vishal gohil*/                       
                    
delete from #p9_file1 where party_code in (select Party_Code     
from General.dbo.SQUAREUP_CLIENT_ALERT where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT_ALERT))       
/* -----T day------ */    
    
      
                         
delete from #p9_file1 where party_code in (select party_Code from General.dbo.SQUAREUP_CLIENT     
where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT))        
/*------T+1day --------*/    
    
      
                                                                                 
select                                                                                                             
max(processDate) as processDate,Entity,Party_code,convert(int,1) as NoofDays,                                                                                                            
sum(Balance) as Balance,sum(MarginAmt) as MarginAmt,sum(Deposit) as Deposit,                                           
sum(CashColl) as CashColl,sum(NonCashColl) as NonCashColl,sum(Holding_total) as Holding_BHC,                                                                                               
sum(Holding_Approved) as Holding_AHC,sum(OtherDebit) as OtherDebit,                                            
sum(EarlyPayinValue) as EarlyPayinValue,sum(LeverageMultiplier) as LeverageMultiplier,                                                                                           
sum(VarMarginShortFall) as VarMarginShortFall,                             
Convert(money,0) as NSEFO_JV,                                                                                                            
Convert(money,0) as NSEFO_NonCash,                                                                                                            
Convert(money,0) as MCD_JV,                                                                                           
Convert(money,0) as MCD_NonCash,                                                                                                            
Convert(money,0) as NSX_JV,                                                                                                            
Convert(money,0) as NSX_NonCash,                                                          
Convert(money,0) as VarMarginShortFall_AftAdj,                                                                                           
Convert(money,0) as Stage,                                                                                                            
sum(SquareOffValue) as SquareOffValue,Sum(Case when Segment='BSECM' then BAlance else 0 end) as BSECM_Balance,                                                                                                             
Sum(Case when Segment='NSECM' then BAlance else 0 end) as NSECM_Balance,                                                     
Convert(money,0) as DP_adj ,            
Convert(money,0) as VarMarginShortFall_AftAdjCurrDay                                                                              
into #p9_file2                                                                                                            
from #p9_file1 where segment in ('BSECM','NSECM')                                                                                                            
group by Entity,Party_code                                   
                                                       
/* delete Client with Cash Credit effective Balance */                                                                                                   
                                                          
Delete from #p9_file2 where balance >= @LowerCapAmt                      
Delete from #p9_file2 where party_code in (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF'))                                                                              
Delete from #p9_file1 where party_Code not in (select party_code from #p9_file2)                                                                          
Delete from #p9_file2 where Holding_BHC <= 0                                                   
                              
update #p9_File2 set VarMarginShortFall=(case when Holding_AHC+Balance+Deposit+EarlypayinValue < @LowerCapAmt then Holding_AHC+Balance+Deposit+EarlypayinValue  else 0 end)                                                                                   
   
   
    
    
     
                                       
update #p9_File2 set LeverageMultiplier=                                                                                                            
Case when 100-(Holding_AHC/Holding_BHC)*100.00 > 100 then 100 else 100-(Holding_AHC/Holding_BHC)*100.00 end                                                                                                            
where Holding_BHC > 0                                                                                              
                                                                      
update #p9_file1 set MgnAdjNonCash=0 where MgnAdjNonCash is null                                                                                        
update #p9_file1 set MgnAdjNonLed=0 where MgnAdjNonLed is null                                                
                    
/* Adj.Margin with Non_Cash Scripwise */                                                                   
                                  
update vmss_NonCash set FinalAmount=Amount-(Amount*(MarginHC/100.00))                                          
update vmss_noncash set MarginSqOffQty=0                                                
/*---- Full NonCash Getting adjusted against Margin */                                                                          
update vmss_noncash set MarginSqOffQty=Qty from                                                                          
(                                                                          
/*                                                          
select a.*,b.MarginAmt from                                                                          
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                          
(select segment,party_code,MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                          
on a.party_code=b.party_code and a.co_code=b.segment                                                                          
where b.MArginAmt >= a.VAHC                                                           
*/                                
select a.*,b.MarginAmt from                                                                        
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                        
(select segment,party_code,MArginAmt+(Case when balance < 0 then -balance else 0 end) as MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                   
on a.party_code=b.party_code and a.co_code=b.segment                                                                        
where b.MArginAmt >= a.VAHC                                                            
) x where vmss_noncash.party_code=x.party_Code and vmss_noncash.co_code=x.co_Code                                            
                                                              
/*---- Partial NonCash Getting adjusted against Margin */                                                   
                                      
                                                     
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex from                                                                           
/* (select * from #p9_file1 where marginAmt > 0 ) a  left outer join             */                                                        
(select                   
processDate,Entity,segment,Party_code,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,                                               
(Case when Balance < 0 then MarginAmt-Balance else MArginAmt end) as MarginAmt,                                                  
Deposit,CashColl,NonCashColl,Holding_total,Holding_Approved,OtherDebit,NonCashConsideration,                                                  
Net,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,SquareOffValue,MgnAdjNonCash,MgnAdjNonLed                                                  
from #p9_file1 where segment in ('NSEFO','MCD','NSX')) a  left outer join                                                 
(select co_code,party_code from vmss_noncash where MarginSqOffQty <> 0 group by party_code,Co_Code) b                                                                          
on a.party_code=b.party_code and a.segment=b.co_Code                                                                          
join (select co_code,party_code from vmss_noncash where MarginSqOffQty = 0 group by party_code,Co_Code) c                                                                          
on a.party_code=c.party_code and a.segment=c.co_Code                                                                          
where b.Party_Code is null                                                                          
                                                
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                           
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0,@segment as varchar(10) = ''                                                                            
                                            
select @totctr=MAX(srno) from #p9_filex                                                            
                                                              
While @ctr <= @totctr                                                                                              
Begin                                                                                              
                                                                         
set @SqOffVal=0                                                                                              
select @pcode=party_Code,@SqOffVal=MarginAmt,@segment=segment from #p9_filex where srno=@ctr                                                             
                                                              
select ROW_NUMBER() OVER (ORDER BY b.seqid,FinalAmount desc) AS [SrNo],                                                                          
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,MarginHC as HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,                                                                          
clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty                                                                          
into #p9_holdadj from vmss_noncash a join                                                                                    
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                         
where party_code=@pcode and Clsrate > 0 and MarginHC < 100 and co_Code=@segment                         
                                                              
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                    
set @TSqOffVal=0                                                                              
                                                              
set @Xctr=1                                                                                    
                                                                              
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                       
BEGIN                                                                 
                                                                     
select @TSqOffVal=FinalAmount,@qty=Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                     
                                                                      
if (@SqOffVal<@TSqOffVal)                                                                                            
set @TSqOffVal=@SqOffVal                                                                                         
                                                              
  
update vmss_noncash                                                                                    
set MarginSqOffQty=ceiling(Case when @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) <= @qty                                         
then @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) else @qty end)                                                                                
where id=@id  and  MarginHC < 100                                                       
                                                                              
set @SqOffVal=@SqOffVal-@TSqOffVal                                                                      
set @Xctr=@Xctr+1                                                                                              
  
END                                                                                              
                             
DROP TABLE #p9_holdadj                                                                                              
                                                                                    
set @ctr=@ctr+1                            
end                                                                                              
                                                                          
drop table #p9_filex                                                                                              
                                                              
/* Calculation Margin Adjusted with NonCash */                                                                                              
                                                              
/*                                                                          
update #p9_file1 set MgnAdjNonCash=(Case when MarginAmt-(NonCashColl+CashColl) < 0 then MarginAmt else (NonCashColl+CashColl) end)                                                                      
where segment in ('NSEFO','MCD','NSX')                                                                                              
*/                                                                          
                                                              
update #p9_file1 set MgnAdjNonCash=B.AdjWithMargin from                                                                          
(                           
select co_Code,party_code,sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) as AdjWithMargin from vmss_noncash                                                                           
group by co_Code,party_code                                                                          
having sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) > 0                                        
) b where #p9_file1.party_code=b.party_Code and #p9_file1.segment=b.co_Code                                                    
                                                                                  
/* Calculation Margin Adjusted with Ledger Credit */                                                                                              
update #p9_file1 set MgnAdjNonLed=(Case                                             
when Balance > (MarginAmt-MgnAdjNonCash) and MarginAmt-MgnAdjNonCash > 0 and balance > 0 then (MarginAmt-MgnAdjNonCash)                                                                                    
when Balance <= (MarginAmt-MgnAdjNonCash) and balance > 0 then Balance                                                                                              
else 0 end) where segment in ('NSEFO','MCD','NSX')                                                               
                                         
                                   
                                                                               
update  #p9_File2 set NSEFO_JV=b.AdjWithLedgerCr /*,NSEFO_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                                                            
(                                                                                                            
select party_code,                                                                          
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                          
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                               
from #p9_file1 where segment='NSEFO' and                                                                 
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                          
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             
                                                                                                 
                                                               
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr /*,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                  
(                                                                                                            
select party_code,                                                                          
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                          
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                  
from #p9_file1 where segment='NSX' and                                                                 
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                          
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             
                                                               
/*                                                                          
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                            
(          
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                      
from #p9_file1 where segment='NSX'                                                                                                 
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                            
*/                                                                           
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                         
(                                                                                                            
select party_code,                                                                          
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                          
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                            
from #p9_file1 where segment='MCD' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             
                                                               
/*                                                                                                             
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                            
(                                                                                                
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                 
from #p9_file1 where segment='MCD'                                                                                                 
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             
*/                                                                                                    
                                                              
UPDATE #p9_File2 SET NSEFO_JV=-vARmARGINsHORTFALL  WHERE NSEFO_JV > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV > 0                                    
UPDATE #p9_File2 SET mcd_jv=-vARmARGINsHORTFALL-NSEFO_jv  WHERE mcd_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv >= 0                                                                                                            
UPDATE #p9_File2 SET NSX_jv=-VARMARGINSHORTFALL-NSEFO_JV-mcd_jv  WHERE nsx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv >= 0                                                  
                                                               
UPDATE #p9_File2 SET NSEFO_JV=0 where NSEFO_JV<0                                                                                    
UPDATE #p9_File2 SET mcd_jv=0 where mcd_jv<0                                                                                    
UPDATE #p9_File2 SET NSX_jv=0 where NSX_jv<0                          
                                                                                                
/* Adjust VarMArgin Shortage with NonCash Collateral */                                                                          
                                  
update vmss_NonCash set FinalAmount=Amount*(Haircut/100.00)                                               
                                                              
/*----- NSEFO-----*/                                     
                                                              
set @totctr  = 0                      
set @ctr = 1                                                                              
set @SqOffVal = 0                                                                              
set @pcode =''                                                                              
set @Xtotctr = 0                    
set @Xctr = 1                                                                          
SET @qty = 0                         
set @TSqOffVal = 0                                                                              
set @SqQty = 0                                                                
set @clsrate =0                                                                              
set @id = 0                                                                           
                                                        
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex1                                                                          
from                                                                    
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv as VarMarginShortFallAftJV from #p9_file2 where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv < 0) a join                                                                          
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSEFO' group by party_code) c                                                                          
on a.party_code=c.party_code                                                                          
                                                                 
select @totctr=MAX(srno) from #p9_filex1                                                                                              
                                                                
While @ctr <= @totctr                                                    
Begin                                                                                              
                       
set @SqOffVal=0                                                                                              
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex1 where srno=@ctr                                                                                       
                                                              
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                          
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                          
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                               
A_Qty,VBHC,VAHC                                                                          
into #p9_holdadj1                                                                           
from VMSS_NonCash_BalAfterMargin a join                                                                                              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                           
where party_code=@pcode and Clsrate > 0 and co_code='NSEFO' and haircut < 100                                          
                                                              
select @Xtotctr=MAX(Srno) from #p9_holdadj1                                                                                               
set @TSqOffVal=0      
set @Xctr=1                                                         
  
  
                    
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                             
BEGIN                                                                  
                                                                     
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj1 where srno=@xctr                                                          
                     
if (@SqOffVal<@TSqOffVal)                                                                                              
set @TSqOffVal=@SqOffVal                                                                                              
                                                        
update VMSS_NonCash                                                                       
set                                     
/* SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                    
SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                    
SqOffseq=@xctr                                                                                 
where id=@id  and  Haircut < 100                                                                                      
                                                                              
set @SqOffVal=@TSqOffVal                                                                                              
  
set @Xctr=@Xctr+1      
  
                                                                                          
END                                                                                              
                                                                                    
DROP TABLE #p9_holdadj1                                                                                    
                                                                                    
set @ctr=@ctr+1                                                                                              
end                                                
                                                                                   
update #p9_file2 set NSEFO_noncash=B.AdjustedAmt FROM                                                                          
(                                                                          
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                           
from VMSS_NonCash_BalAfterMargin where co_Code='NSEFO' and SquareOffQty > 0                                                                       
group by party_Code                                                          
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                          
                                                             
/*------ NSX ----*/                                                            
set @totctr  = 0                                                                              
set @ctr = 1                                                                              
set @SqOffVal = 0                                                                              
set @pcode =''                                                    
set @Xtotctr = 0                                                                              
set @Xctr = 1                                                
SET @qty = 0                                                                          
set @TSqOffVal = 0                                                  
set @SqQty = 0                                                                  
set @clsrate =0                                                       
set @id = 0                                                                           
                                               
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex2                                                                 
from                                                                          
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash as VarMarginShortFallAftJV from #p9_file2                 
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash < 0) a join                                                                          
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSX' group by party_code) c                                                                          
on a.party_code=c.party_code                                                                          
                          
select @totctr=MAX(srno) from #p9_filex2                                                                                              
                                                                                    
While @ctr <= @totctr                                                                                          
Begin                                                                                              
                                                                      
set @SqOffVal=0                                                                                              
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex2 where srno=@ctr                                                                          
                                                              
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                          
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                          
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                          
A_Qty,VBHC,VAHC                                                                          
into #p9_holdadj2                                                                           
from VMSS_NonCash_BalAfterMargin a join                                                                                              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                              
where party_code=@pcode and Clsrate > 0 and co_code='NSX'  and haircut < 100                                                                                           
                                   
select @Xtotctr=MAX(Srno) from #p9_holdadj2                                                                                               
set @TSqOffVal=0                                                                                     
                                                              
set @Xctr=1                                                       
      
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                             
BEGIN         
                                                                     
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj2 where srno=@xctr                   
                                                                      
if (@SqOffVal<@TSqOffVal)                                                                                              
set @TSqOffVal=@SqOffVal                                                           
                                                              
update VMSS_NonCash                                                                          
/*set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                    
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                                    
SqOffseq=@xctr                                                                              
where id=@id and Haircut < 100  
       
set @SqOffVal=@TSqOffVal                                                                                              
                                                                            
set @Xctr=@Xctr+1                                                                                              
END                                                                                              
                                                                                    
DROP TABLE #p9_holdadj2                                                                                              
                                                                    
set @ctr=@ctr+1                                                                                              
end                                                                                              
                                                                          
drop table #p9_filex2                                                                            
                                                    
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                          
(                                                                          
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                           
from VMSS_NonCash_BalAfterMargin where co_Code='NSX' and SquareOffQty > 0                                           
group by party_Code                                                          
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                          
                                                               
                                                              
/*------ MCD ----*/                                                                          
                                                              
set @totctr  = 0                                                                              
set @ctr = 1                                                                              
set @SqOffVal = 0                                                              
set @pcode =''                                                                              
set @Xtotctr = 0                                                                              
set @Xctr = 1                                                                                
SET @qty = 0                                                                          
set @TSqOffVal = 0                                            
set @SqQty = 0                                                                              
set @clsrate =0                                                                              
set @id = 0                            
                                    
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex3                                                                          
from                                                                          
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash as VarMarginShortFallAftJV from #p9_file2                                                                           
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash < 0) a join                                        
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='MCD' group by party_code) c                                  
on a.party_code=c.party_code                                        
                                                                 
select @totctr=MAX(srno) from #p9_filex3                                                 
                                
While @ctr <= @totctr                                                                                              
Begin                      
                                                            
set @SqOffVal=0                                                                                              
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex3 where srno=@ctr                                                                                       
                                                              
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                          
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                          
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                          
A_Qty,VBHC,VAHC                                                                          
into #p9_holdadj3                                                              
from VMSS_NonCash_BalAfterMargin a join                                                                                              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                              
where party_code=@pcode and Clsrate > 0 and co_code='MCD' and haircut < 100                                                                                            
                                     
select @Xtotctr=MAX(Srno) from #p9_holdadj3                           
set @TSqOffVal=0                                                                                              
                                                              
set @Xctr=1                                                                                 
                                                                 
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                             
BEGIN                                                                                              
                                                                     
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj3 where srno=@xctr                                                                                     
                                                                      
if (@SqOffVal<@TSqOffVal)                                                                                              
set @TSqOffVal=@SqOffVal           
                                                              
update VMSS_NonCash                                                                                    
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                    
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),         
SqOffseq=@xctr                                                                                 
where id=@id and Haircut < 100                                                                                      
      
set @SqOffVal=@TSqOffVal                                                                                              
                                                                            
set @Xctr=@Xctr+1                                                                     
END                                                    
                                                                                    
DROP TABLE #p9_holdadj3                                                                                              
                     
set @ctr=@ctr+1                                                                                              
end                                                                                              
                                                 
drop table #p9_filex3                                                                            
                                                              
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                                 (                                                                          
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                          
from VMSS_NonCash_BalAfterMargin where co_Code='MCD' and SquareOffQty > 0                                                                       
group by party_Code                                                        
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                          
                                                              
/*----*/                                                                          
UPDATE #p9_File2 SET NSEFO_NONCASH=0,MCD_NONCASH=0,NSX_NONCASH=0                                                                                                             
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL = 0 AND vARmARGINsHORTFALL < 0                                                                                
                                                              
/*                                                                           
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)                                                                      
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                                                                                                            
AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                                                 
                                                                                             
UPDATE #p9_FILE2 SET MCD_NONCASH=0                                                                                                            
UPDATE #p9_FILE2 SET MCD_NONCASH=Stage                                                                                                            
UPDATE #p9_FILE2 SET Stage=0                                                         
                                         
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)                                                                                                            
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                                                                                                            
AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)*-1                                                   
                                                                                                 
UPDATE #p9_FILE2 SET NSX_NONCASH=0                                                   
UPDATE #p9_FILE2 SET NSX_NONCASH=Stage                                                                                                         
UPDATE #p9_FILE2 SET Stage=0                                                                                 
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)                                                                                                           
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                                                                                                           
AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)*-1                                                                                                            
                                                                         
UPDATE #p9_FILE2 SET NSEFO_NONCASH=0                                                                                                            
UPDATE #p9_FILE2 SET NSEFO_NONCASH=Stage                                                      
UPDATE #p9_FILE2 SET Stage=0                                                                                                            
*/                                                                          
                              
update #p9_File2  set VarMarginShortFall_AftAdjCurrDay=vARmARGINsHORTFALL+NSefo_jv+MCD_JV+NSX_JV+NSEFO_NONCASH+MCD_NONCASH+NSX_NONCASH                                                                                                            
where  vARmARGINsHORTFALL < 0                                                                                                             
    
update #p9_File2  set VarMarginShortFall_AftAdj=VarMarginShortFall_AftAdjCurrDay    
    
/*    
--- Used to compute min of last 4 days for squareoff.. not required as per PRMS id: 10391261 dt...14/08/2015...    
update #p9_File2 set VarMarginShortFall_AftAdj=(Case when #p9_File2.VarMarginShortFall_AftAdjCurrDay > q.VarMarginShortFall_AftAdjCurrDay               
then #p9_File2.VarMarginShortFall_AftAdjCurrDay else q.VarMarginShortFall_AftAdjCurrDay end)              
from              
(              
select Party_code,MAX(VarMarginShortFall_AftAdjCurrDay) as VarMarginShortFall_AftAdjCurrDay               
from vmss_Data x join              
(select top 3 processdate from (select distinct processdate from vmss_Data where processdate < @BSElastBillDate) a order by processdate) y               
on x.processdate=y.processdate                           
group by party_code              
) q where #p9_File2.party_code=q.party_code              
*/      
                                  
/* Var Margin % */                                                                              
                                                                                 
truncate table vmss_holding                                                                    
insert into vmss_holding                                                                                                  
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate)                                            
      
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,                                                                                                  
SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS [SrNo],0,ISIN,ActualSqOffQty=CONVERT(int,0),0.00 from #p9_hold                                                                                                  
                                                                    
/*                                                                                                
select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #p9_filex                                                                                                   
from #p9_file2 where VarMarginShortFall_AftAdj < 0            
                                                                            
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                                                                  
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                                                                  
                                                             
select @totctr=MAX(srno) from #p9_filex                                                                                                  
                                                                                       
While @ctr <= @totctr                                                                                                  
Begin                                                                                           
                                                               
set @SqOffVal=0                                                          
select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdj*-1 from #p9_filex where srno=@ctr                                                                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],* into #p9_holdadj from vmss_holding a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                         
where party_code=@pcode and Clsrate > 0                                                                                
                                                                            
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                                                                   
set @TSqOffVal=0                                                                                                  
                                                                              
set @Xctr=1                                                                                      
                                                                              
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN                                                                                      
                                                                          
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                         
                                              
if (@SqOffVal<@TSqOffVal)                                                          
set @TSqOffVal=@SqOffVal                                                                                                  
                                                          
update vmss_holding                                                                           
set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                                                   
SqOffseq=@xctr                                                                                     
where id=@id                                                                            
                                                                              
set @SqOffVal=@TSqOffVal                                                                                                  
                  
set @Xctr=@Xctr+1                                                                                                  
END                                                                                                  
                                                                                       
DROP TABLE #p9_holdadj                                        
                                                                                       
set @ctr=@ctr+1                                        
end                                                                                                  
                                                                                      
drop table #p9_filex                                                                                                  
                                                            
truncate table vmss_holding_hist                                                                                                   
insert into vmss_holding(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq)                                                     
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq from vmss_holding                                                                                   
  
    
    
    
     
                                                                                    
update #p9_file2 set SquareOffValue=b.SqVal from                                                          
(                                                                                        
select party_code,sum(SquareOffQty*Clsrate) as SqVal from vmss_holding where isnull(SquareOffQty,0) > 0                                                                                         
group by party_code                                                                                        
) b                                                                                                   
where #p9_file2.party_code=b.party_Code                                                                                                  
*/                                                                                
                                                                                    
/*                                                                                                        
update #p9_File2 set SquareOffValue=                                                                                                            
Case when (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 < (Holding_BHC)*-1 then (Holding_BHC)*-1                                                                                                            
else (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 end                                  
where LeverageMultiplier > 0                                                                                                            
*/                                                                                                  
                                                                           
/*                                                                          
UPDATE #p9_File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                         
(                                                                              
SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                                                                       
(                                                                                 
SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                         
WHERE CONVERT(DATE,processdate) < (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data )                                                
)                                                                                                                                      
) B WHERE #p9_File2.party_code=B.party_code                                                                                                    
                                                                               
UPDATE #p9_File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                                        
          
*/                                                                                   
                                                                      
delete from VMSS_data where processDate=@BSElastBillDate                                                                                                            
                                                                                       
insert into VMSS_data(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,                                                                                                  
Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,                                                                                                     
NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,remarks,DP_adj,Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                                                                           
   
   
    
    
     
                    
SELECT processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,                                                                                                            
OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,                                              
VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,GETDATE(),'V','',DP_adj,0.00,VarMarginShortFall_AftAdjCurrDay                                                                                                        
FROM #p9_FILE2                                                                                                             
                                                                    
/*                                                                            
insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                        
  
    
    
    
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks)                                                                                   
  
    
    
    
select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                                            
  
    
    
    
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks from VMSS_data                                                                     
  
    
    
    
*/                                                              
                                                                    
End try                                                                                                                                 
BEGIN CATCH                                                                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                          
  select GETDATE(),'VMSS_Calculation_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                                                                               
                      
  DECLARE @ErrorMessage NVARCHAR(4000);                                                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                          
  RAISERROR (@ErrorMessage , 16, 1);                                  
End catch                                                                                 
                      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Calculation_NoNRMS_12122015
-- --------------------------------------------------
  
create Procedure [dbo].[VMSS_Calculation_NoNRMS_12122015]                                                                                                  
as                                                                                                            
                                                                                                            
SET XACT_ABORT ON                                                                                                            
Set nocount on                                                                                                            
BEGIN TRY                                                                                                                                    
                                                                          
 Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                                                            
 Declare @LowerCapNonCash as money = 500  /* NONCASH COLLATERAL MOVEMENT : always +ve */                                                                                                            
 Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                            
                                                                                                      
 select                                                                                                             
 @BSElastBillDate  as processDate,                                                                                                            
 b.Entity,                                                                                                            
 b.segment,                                                                                                            
 a.Party_code,                                                                                                            
 a.Ledger as Balance,                                                                                                            
 CONVERT(money,0)  as UnsettledCr,                                                                                                            
 CONVERT(money,0) as UnsettledDr,                                                                                                            
 a.Unrecosiled_Credit as UnrecoAmt,                                                                                                            
 CONVERT(money,0) as ShortSellValue,                                                                                                            
 a.Imargin as MarginAmt,                                                                                                            
 a.Deposit,                                                                                                            
a.Cash_Colleteral as CashColl,                                                                                                            
a.NonCash_Colleteral as NonCashColl,                                                                                                            
Holding_total,                                                                                                            
Holding_Approved,                                                                                                            
CONVERT(money,0) as OtherDebit,                                                  
CONVERT(int,0) as NonCashConsideration,                                                                                                
CONVERT(money,0) as Net,                                             
CONVERT(money,0) as EarlyPayinValue,                
CONVERT(money,0) as LeverageMultiplier,                        
CONVERT(money,0) as VarMarginShortFall,                                                            
CONVERT(money,0) as SquareOffValue,                                
CONVERT(money,0) as MgnAdjNonCash,                                                   
CONVERT(money,0) as MgnAdjNonLed                                                              
into #p9_File1                                                 
from (select * from General.dbo.RMS_DtClFi with (nolock) where 1=2) a join (select segment,entity from intranet.cms.dbo.ncms_entity with (nolock) where entity='Equity') b                                                                  
on a.Co_code=b.segment                                                                   
                                                                                                   
                                                                                                   
 /* update Holding */                                                                                                  
                                                            
select EXCHANGE,sett_no,SEtt_type,                                                                                                            
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY1 ELSE SCRIP_CD END) AS scrip_cd,                                                                                                            
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,Party_code,Qty,                                                                        
CLSRATE,                                                                                                            
Total AS VBHC,                                                                          
CONVERT(MONEY,0) AS HAIRCUT,                                                                                                            
CONVERT(MONEY,0) AS VAHC,                                                                                                
SPACE(10) AS CATEGORY,                                                                                                            
source AS SRC,                                                                    
ISIN                                                                    
INTO #p9_HOLD                                                                                                            
from vmss_rms_holding where source in ('SI','SO','H','D')                
                
SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0      
DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin      
DROP TABLE #nqty      
                                                                                                   
update #p9_HOLD set clsrate=b.rate from General.dbo.cp_bsecm b where #p9_HOLD.scrip_Cd=b.scode and #p9_HOLD.clsrate=0                                                                                                            
                
update #p9_HOLD set clsrate=b.cls                                                                                                             
from General.dbo.cp_nsecm b                                                                                                   
where #p9_HOLD.scrip_Cd=b.scrip and #p9_HOLD.series=b.series and #p9_HOLD.clsrate=0 and exchange='NSECM'                                                                                                          
                
update #p9_HOLD set VBHC=clsrate*Qty                                                                                                            
                
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                           
where #p9_HOLD.SCRIP_cD=B.BSECODE AND #p9_HOLD.EXCHANGE='BSECM'                                                                                                            


/*Added to handle scrip:idfc ltd as it has shifted from BE to Eq as suggested by Vishal Gohil on Dec 10 2015*/
--select * from #p9_HOLD where  isin='INE092T01019' and series='EQ'
--update #p9_HOLD set series='EQ' where isin='INE092T01019' and series='BE'

update a set series=b.Currenteries from #p9_HOLD a inner join VMSS_Exception_NSESeries b on a.isin=b.isin and a.series=b.previousseries

/*******************************************************************/

                
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                  
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                              
where #p9_HOLD.SCRIP_cD=B.NSESYMBOL AND #p9_HOLD.SERIES=B.NSESERIES AND #p9_HOLD.EXCHANGE='NSECM'                                                          



                
update #p9_HOLD set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                            
                
update #p9_HOLD set VAHC=VBHC*((100-HAIRCUT)/100.00)                                              
                
insert into #p9_File1(segment,party_code)                                                          
select b.co_code,party_Code from                                                                                                  
(select party_code from #p9_hold group by party_code) a,                                                                                                   
(select * from General.dbo.company where entitytype='EQ' and bo_active=1) b                                                                                                  
                                                                                                  
update #p9_file1                                                             
set entity='EQUITY',ProcessDate=@BSElastBillDate,Balance=0,UnsettledCr=0,UnsettledDr=0,UnrecoAmt=0,ShortSellValue=0,                                                                                   
MarginAmt=0,Deposit=0,CashColl=0,NonCashColl=0,Holding_total=0,Holding_Approved=0,OtherDebit=0,NonCashConsideration=0,Net=0,                                                                                                  
EarlyPayinValue=0,LeverageMultiplier=0,VarMarginShortFall=0,SquareOffValue=0                                                                                                  
                                                                                   
update #p9_File1 set holding_total=b.VBHC,holding_approved=b.VAHC from                                                             
(select party_code,exchange,VBHC=sum(VBHC),VAHC=sum(VAHC)                                                                                                            
from #p9_hold group by party_code,exchange) b                                                                   
where #p9_File1.party_code=b.party_code and #p9_File1.segment=b.exchange                                                                                                            
                                                                                                  
/* Get Last settlement Date */                                                                                                 
                                                                                  
 Declare @sdtcur as datetime,-- @ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59'                                                                                                    
 @ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'                              
 select @sdtcur=sdtcur from General.dbo.parameter with (nolock) where sdtcur <= @ToDate and ldtcur >=@ToDate                                       
                                   
/* Fetch effective Ledger Balance - Only Bill's effective date else voucher date*/                             
            
 select CLTCODE,                                                                                                            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                      
 into #p9_BSECM                                                                                                            
 from anand.account_ab.dbo.ledger a with (nolock)                                                                                   
 where vDT>=@sdtcur and vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                       
 group by cltcode                                 
                                                                               
 select CLTCODE,                                                                                              
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                       
 into #p9_NSECM                                                                                                            
from anand1.account.dbo.ledger a with (nolock)                                                                                                                   
 where vDT>=@sdtcur and  vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                                                   
 group by cltcode                                                                                                                
                                             
 select CLTCODE,                                                                                                            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                             
 into #p9_NSEFO                                                                                                            
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                                                   
 /* where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end) */                                                                                                           
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate         
 group by cltcode                                                                                                                
                                                             
 select CLTCODE,                                                                                                            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            
 into #p9_NSX                                                                                             
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                                                   
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate         
 group by cltcode                                                                                                                
                                                           
select CLTCODE,                                            
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                      
into #p9_MCD                                                                                                
from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)      
where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate         
group by cltcode                                                                                                                
                                                                                              
 /* Fetch Deposit */                                                                        
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                             
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                
 into #p9_dep_BSECM                                                                                                            
 from anand.account_ab.dbo.ledger a with (nolock)                                                                    
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                  
 group by cltcode                                          
                                
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            
 into #p9_dep_NSECM from anand1.account.dbo.ledger a with (nolock)                                                       
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                  
 group by cltcode                                                                  
                                                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                   
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            
 into #p9_dep_NSEFO                                                                                                            
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                 
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '40%'                                                                                                                  
 group by cltcode                                                                                   
                                                                                                              
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            
 into #p9_dep_NSX                                                                                                            
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                               
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                          
 group by cltcode                                   
                                                                                                        
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                               
 into #p9_dep_MCD                    
 from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                               
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                  
 group by cltcode                                                                                            
                                                                     
 update #p9_File1 set Balance=b.Vbal from #p9_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                                                            
 update #p9_File1 set Balance=b.Vbal from #p9_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                            
 update #p9_File1 set Balance=b.Vbal from #p9_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                                            
 update #p9_File1 set Balance=b.Vbal from #p9_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                                                  
 update #p9_File1 set Balance=b.Vbal from #p9_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                        
                                                                                                            
 update #p9_File1 set deposit=b.Vbal from #p9_dep_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                       
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                                                            
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                      
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                       
 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                                                                      
                                                                                                  
 update #p9_File1 set Earlypayinvalue=b.EPV from                                                                                                       
 (select Exchange,party_code,SUM(total) as EPV from VMSS_EarlyPayinData group by Exchange,party_code) b                                                                                                            
 where #p9_File1.party_code=b.party_Code and #p9_File1.segment=b.exchange                                                                                                  
                                                                                                             
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                         
 (       
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                  
 from angelfo.nsefo.dbo.tbl_clientmargin with (nolock)                                                    
 where MarginDate = (select MAX(margindate) from angelfo.nsefo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                               
  ) b                                                                
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSEFO'                                                                                                  
                                                                                                  
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                        
 (                                                                                                  
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                  
 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                               
 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                     
  ) b                                                                                                   
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCD'                                                                                       
                                                                                    
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                  
 (                                                                         
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                  
 from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock)                                                                                                  
 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                      
) b                                                                                
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSX'                                                                                                  
                                                                          
 update #p9_File1 set NonCashColl=b.NonCashColl                                     
 from VMSS_Client_collateral_NonEquity_NoBrInfo b                                                                                                  
 where #p9_File1.party_code=b.party_code and #p9_file1.segment=b.co_code                                                                             
                                                            
/* Excess Collateral adjustement with Ledger Debit */                                                            
 update #p9_File1 set NonCashColl=NonCashColl+Balance                                                                                                 
 where NonCashColl > 0 and Balance < 0 and segment in ('NSEFO','MCD','NSX')                                                           
                                                                           
 /* GEnerate Summarised Data */                
                                                       
delete from #p9_file1 where party_code in (select party_code from mis.sccs.dbo.Combine_legal)                                                          
delete from #p9_file1 where party_code in (select party_code from General.dbo.client_Details where (branch_cd='NRIS' or sub_broker='BH'))                      
                    
/*Remove Tday and T+1 day clients ,added by abha as suggested by vishal gohil*/                       
                    
delete from #p9_file1 where party_code in (select Party_Code     
from General.dbo.SQUAREUP_CLIENT_ALERT where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT_ALERT))       
/* -----T day------ */    
    
      
                         
delete from #p9_file1 where party_code in (select party_Code from General.dbo.SQUAREUP_CLIENT     
where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT))        
/*------T+1day --------*/    
    
      
                                                                                 
select                                                                                                             
max(processDate) as processDate,Entity,Party_code,convert(int,1) as NoofDays,                                                                                                            
sum(Balance) as Balance,sum(MarginAmt) as MarginAmt,sum(Deposit) as Deposit,                                           
sum(CashColl) as CashColl,sum(NonCashColl) as NonCashColl,sum(Holding_total) as Holding_BHC,                                                                                               
sum(Holding_Approved) as Holding_AHC,sum(OtherDebit) as OtherDebit,                                            
sum(EarlyPayinValue) as EarlyPayinValue,sum(LeverageMultiplier) as LeverageMultiplier,                                                                                           
sum(VarMarginShortFall) as VarMarginShortFall,                             
Convert(money,0) as NSEFO_JV,                                                                                                            
Convert(money,0) as NSEFO_NonCash,                                                                                                            
Convert(money,0) as MCD_JV,                                                                                           
Convert(money,0) as MCD_NonCash,                                                                                                            
Convert(money,0) as NSX_JV,                                                                                                            
Convert(money,0) as NSX_NonCash,                                                          
Convert(money,0) as VarMarginShortFall_AftAdj,                                                                                           
Convert(money,0) as Stage,                                                                                                            
sum(SquareOffValue) as SquareOffValue,Sum(Case when Segment='BSECM' then BAlance else 0 end) as BSECM_Balance,                                                                                                             
Sum(Case when Segment='NSECM' then BAlance else 0 end) as NSECM_Balance,                                                     
Convert(money,0) as DP_adj ,            
Convert(money,0) as VarMarginShortFall_AftAdjCurrDay                                                                              
into #p9_file2                                                                                                            
from #p9_file1 where segment in ('BSECM','NSECM')                                                                                                            
group by Entity,Party_code                                   
                                                       
/* delete Client with Cash Credit effective Balance */                                                                                                   
                                                          
Delete from #p9_file2 where balance >= @LowerCapAmt                      
Delete from #p9_file2 where party_code in (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF'))                                                                              
Delete from #p9_file1 where party_Code not in (select party_code from #p9_file2)                                                                          
Delete from #p9_file2 where Holding_BHC <= 0                                                   
                              
update #p9_File2 set VarMarginShortFall=(case when Holding_AHC+Balance+Deposit+EarlypayinValue < @LowerCapAmt then Holding_AHC+Balance+Deposit+EarlypayinValue  else 0 end)                                                                                   
   
   
    
    
     
                                       
update #p9_File2 set LeverageMultiplier=                                                                                                            
Case when 100-(Holding_AHC/Holding_BHC)*100.00 > 100 then 100 else 100-(Holding_AHC/Holding_BHC)*100.00 end                                                                                                            
where Holding_BHC > 0                                                                                              
                                                                      
update #p9_file1 set MgnAdjNonCash=0 where MgnAdjNonCash is null                                                                                        
update #p9_file1 set MgnAdjNonLed=0 where MgnAdjNonLed is null                                                
                    
/* Adj.Margin with Non_Cash Scripwise */                                                                   
                                  
update vmss_NonCash set FinalAmount=Amount-(Amount*(MarginHC/100.00))                                          
update vmss_noncash set MarginSqOffQty=0                                                
/*---- Full NonCash Getting adjusted against Margin */                                                                          
update vmss_noncash set MarginSqOffQty=Qty from                                                                          
(                                                                          
/*                                                          
select a.*,b.MarginAmt from                                                                          
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                          
(select segment,party_code,MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                          
on a.party_code=b.party_code and a.co_code=b.segment                                                                          
where b.MArginAmt >= a.VAHC                                                           
*/                                
select a.*,b.MarginAmt from                                                                        
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                        
(select segment,party_code,MArginAmt+(Case when balance < 0 then -balance else 0 end) as MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                   
on a.party_code=b.party_code and a.co_code=b.segment                                                                        
where b.MArginAmt >= a.VAHC                                                            
) x where vmss_noncash.party_code=x.party_Code and vmss_noncash.co_code=x.co_Code                                            
                                                              
/*---- Partial NonCash Getting adjusted against Margin */                                                   
                                      
                                                     
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex from                                                                           
/* (select * from #p9_file1 where marginAmt > 0 ) a  left outer join             */                                                        
(select                   
processDate,Entity,segment,Party_code,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,                                               
(Case when Balance < 0 then MarginAmt-Balance else MArginAmt end) as MarginAmt,                                                  
Deposit,CashColl,NonCashColl,Holding_total,Holding_Approved,OtherDebit,NonCashConsideration,                                                  
Net,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,SquareOffValue,MgnAdjNonCash,MgnAdjNonLed                                                  
from #p9_file1 where segment in ('NSEFO','MCD','NSX')) a  left outer join                                                 
(select co_code,party_code from vmss_noncash where MarginSqOffQty <> 0 group by party_code,Co_Code) b                                                                          
on a.party_code=b.party_code and a.segment=b.co_Code                                                                          
join (select co_code,party_code from vmss_noncash where MarginSqOffQty = 0 group by party_code,Co_Code) c                                                                          
on a.party_code=c.party_code and a.segment=c.co_Code                                                                          
where b.Party_Code is null                                                                          
                                                
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                           
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0,@segment as varchar(10) = ''                                                                            
                                            
select @totctr=MAX(srno) from #p9_filex                                                            
                                                              
While @ctr <= @totctr                                                                                              
Begin                                                                                              
                                                                         
set @SqOffVal=0                                                                                              
select @pcode=party_Code,@SqOffVal=MarginAmt,@segment=segment from #p9_filex where srno=@ctr                                                             
                                                              
select ROW_NUMBER() OVER (ORDER BY b.seqid,FinalAmount desc) AS [SrNo],                                                                          
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,MarginHC as HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,                                                                          
clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty                                                                          
into #p9_holdadj from vmss_noncash a join                                                                                    
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                         
where party_code=@pcode and Clsrate > 0 and MarginHC < 100 and co_Code=@segment                         
                                                              
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                    
set @TSqOffVal=0                                                                              
                                                              
set @Xctr=1                                                                                    
                                                                              
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                       
BEGIN                                                                 
                                                                     
select @TSqOffVal=FinalAmount,@qty=Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                     
                                                                      
if (@SqOffVal<@TSqOffVal)                                                                                            
set @TSqOffVal=@SqOffVal                                                                                         
                                                              
  
update vmss_noncash                                                                                    
set MarginSqOffQty=ceiling(Case when @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) <= @qty                                         
then @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) else @qty end)                                                                                
where id=@id  and  MarginHC < 100                                                       
                                                                              
set @SqOffVal=@SqOffVal-@TSqOffVal                                                                      
set @Xctr=@Xctr+1                                                                                              
  
END                                                                                              
                             
DROP TABLE #p9_holdadj                                                                                              
                                                                                    
set @ctr=@ctr+1                            
end                                                                                              
                                                                          
drop table #p9_filex                                                                                              
                                                              
/* Calculation Margin Adjusted with NonCash */                                                                                              
                                                              
/*                                                                          
update #p9_file1 set MgnAdjNonCash=(Case when MarginAmt-(NonCashColl+CashColl) < 0 then MarginAmt else (NonCashColl+CashColl) end)                                                                      
where segment in ('NSEFO','MCD','NSX')                                                                                              
*/                                                                          
                                                              
update #p9_file1 set MgnAdjNonCash=B.AdjWithMargin from                                                                          
(                           
select co_Code,party_code,sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) as AdjWithMargin from vmss_noncash                                                                           
group by co_Code,party_code                                                                          
having sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) > 0                                        
) b where #p9_file1.party_code=b.party_Code and #p9_file1.segment=b.co_Code                                                    
                                                                                  
/* Calculation Margin Adjusted with Ledger Credit */                                                                                              
update #p9_file1 set MgnAdjNonLed=(Case                                             
when Balance > (MarginAmt-MgnAdjNonCash) and MarginAmt-MgnAdjNonCash > 0 and balance > 0 then (MarginAmt-MgnAdjNonCash)                                                                                    
when Balance <= (MarginAmt-MgnAdjNonCash) and balance > 0 then Balance                                                                                              
else 0 end) where segment in ('NSEFO','MCD','NSX')                                                               
                                         
                                   
                                                                               
update  #p9_File2 set NSEFO_JV=b.AdjWithLedgerCr /*,NSEFO_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                                                            
(                                                                                                            
select party_code,                                                                          
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                          
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                               
from #p9_file1 where segment='NSEFO' and                                                                 
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                          
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             
                                                                                                 
                                                               
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr /*,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                  
(                                                                                                            
select party_code,                                                                          
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                          
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                  
from #p9_file1 where segment='NSX' and                                                                 
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                          
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             
                                                               
/*                                                                          
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                            
(          
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                      
from #p9_file1 where segment='NSX'                                                                                                 
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                            
*/                                                                           
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                         
(                                                                                                            
select party_code,                                                                          
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                          
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                            
from #p9_file1 where segment='MCD' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             
                                                               
/*                                                                                                             
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                            
(                                                                                                
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                 
from #p9_file1 where segment='MCD'                                                                                                 
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             
*/                                                                                                    
                                                              
UPDATE #p9_File2 SET NSEFO_JV=-vARmARGINsHORTFALL  WHERE NSEFO_JV > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV > 0                                    
UPDATE #p9_File2 SET mcd_jv=-vARmARGINsHORTFALL-NSEFO_jv  WHERE mcd_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv >= 0                                                                                                            
UPDATE #p9_File2 SET NSX_jv=-VARMARGINSHORTFALL-NSEFO_JV-mcd_jv  WHERE nsx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv >= 0                                                  
                                                               
UPDATE #p9_File2 SET NSEFO_JV=0 where NSEFO_JV<0                                                                                    
UPDATE #p9_File2 SET mcd_jv=0 where mcd_jv<0                                                                                    
UPDATE #p9_File2 SET NSX_jv=0 where NSX_jv<0                          
                                                                                                
/* Adjust VarMArgin Shortage with NonCash Collateral */                                                                          
                                  
update vmss_NonCash set FinalAmount=Amount*(Haircut/100.00)                                               
                                                              
/*----- NSEFO-----*/                                     
                                                              
set @totctr  = 0                      
set @ctr = 1                                                                              
set @SqOffVal = 0                                                                              
set @pcode =''                                                                              
set @Xtotctr = 0                    
set @Xctr = 1                                                                          
SET @qty = 0                         
set @TSqOffVal = 0                                                                              
set @SqQty = 0                                                                
set @clsrate =0                                                                              
set @id = 0                                                                           
                                                        
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex1                                                                          
from                                                                    
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv as VarMarginShortFallAftJV from #p9_file2 where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv < 0) a join                                                                          
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSEFO' group by party_code) c                                                                          
on a.party_code=c.party_code                                                                          
                                                                 
select @totctr=MAX(srno) from #p9_filex1                                                                                              
                                                                
While @ctr <= @totctr                                                    
Begin                                                                                              
                       
set @SqOffVal=0                                                                                              
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex1 where srno=@ctr                                                                                       
                                                              
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                          
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                          
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                               
A_Qty,VBHC,VAHC                                                                          
into #p9_holdadj1                                                                           
from VMSS_NonCash_BalAfterMargin a join                                                                                              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                           
where party_code=@pcode and Clsrate > 0 and co_code='NSEFO' and haircut < 100                                          
                                                              
select @Xtotctr=MAX(Srno) from #p9_holdadj1                                                                                               
set @TSqOffVal=0      
set @Xctr=1                                                         
  
  
                    
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                             
BEGIN                                                                  
                                                                     
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj1 where srno=@xctr                                                          
                     
if (@SqOffVal<@TSqOffVal)                                                                                              
set @TSqOffVal=@SqOffVal                                                                                              
                                                        
update VMSS_NonCash                                                                       
set                                     
/* SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                    
SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                    
SqOffseq=@xctr                                                                                 
where id=@id  and  Haircut < 100                                                                                      
                                                                              
set @SqOffVal=@TSqOffVal                                                                                              
  
set @Xctr=@Xctr+1      
  
                                                                                          
END                                                                                              
                                                                                    
DROP TABLE #p9_holdadj1                                                                                    
                                                                                    
set @ctr=@ctr+1                                                                                              
end                                                
                                                                                   
update #p9_file2 set NSEFO_noncash=B.AdjustedAmt FROM                                                                          
(                                                                          
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                           
from VMSS_NonCash_BalAfterMargin where co_Code='NSEFO' and SquareOffQty > 0                                                                       
group by party_Code                                                          
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                          
                                                             
/*------ NSX ----*/                                                            
set @totctr  = 0                                                                              
set @ctr = 1                                                                              
set @SqOffVal = 0                                                                              
set @pcode =''                                                    
set @Xtotctr = 0                                                                              
set @Xctr = 1                                                
SET @qty = 0                                                                          
set @TSqOffVal = 0                                                  
set @SqQty = 0                                                                  
set @clsrate =0                                                       
set @id = 0                                                                           
                                               
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex2                                                                 
from                                                                          
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash as VarMarginShortFallAftJV from #p9_file2                 
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash < 0) a join                                                                          
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSX' group by party_code) c                                                                          
on a.party_code=c.party_code                                                                          
                          
select @totctr=MAX(srno) from #p9_filex2                                                                                              
                                                                                    
While @ctr <= @totctr                                                                                          
Begin                                                                                              
                                                                      
set @SqOffVal=0                                                                                              
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex2 where srno=@ctr                                                                          
                                                              
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                          
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                          
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                          
A_Qty,VBHC,VAHC                                                                          
into #p9_holdadj2                                                                           
from VMSS_NonCash_BalAfterMargin a join                                                                                              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                              
where party_code=@pcode and Clsrate > 0 and co_code='NSX'  and haircut < 100                                                                                           
                                   
select @Xtotctr=MAX(Srno) from #p9_holdadj2                                                                                               
set @TSqOffVal=0                                                                                     
                                                              
set @Xctr=1                                                       
      
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                             
BEGIN         
                                                                     
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj2 where srno=@xctr                   
                                                                      
if (@SqOffVal<@TSqOffVal)                                                                                              
set @TSqOffVal=@SqOffVal                                                           
                                                              
update VMSS_NonCash                                                                          
/*set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                    
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                                    
SqOffseq=@xctr                                                                              
where id=@id and Haircut < 100  
       
set @SqOffVal=@TSqOffVal                                                                                              
                                                                            
set @Xctr=@Xctr+1                                                                                              
END                                                                                              
                                                                                    
DROP TABLE #p9_holdadj2                                                                                              
                                                                    
set @ctr=@ctr+1                                                                                              
end                                                                                              
                                                                          
drop table #p9_filex2                                                                            
                                                    
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                          
(                                                                          
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                           
from VMSS_NonCash_BalAfterMargin where co_Code='NSX' and SquareOffQty > 0                                           
group by party_Code                                                          
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                          
                                                               
                                                              
/*------ MCD ----*/                                                                          
                                                              
set @totctr  = 0                                                                              
set @ctr = 1                                                                              
set @SqOffVal = 0                                                              
set @pcode =''                                                                              
set @Xtotctr = 0                                                                              
set @Xctr = 1                                                                                
SET @qty = 0                                                                          
set @TSqOffVal = 0                                            
set @SqQty = 0                                                                              
set @clsrate =0                                                                              
set @id = 0                            
                                    
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex3                                                                          
from                                                                          
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash as VarMarginShortFallAftJV from #p9_file2                                                                           
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash < 0) a join                                        
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='MCD' group by party_code) c                                  
on a.party_code=c.party_code                                        
                                                                 
select @totctr=MAX(srno) from #p9_filex3                                                 
                                
While @ctr <= @totctr                                                                                              
Begin                      
                                                            
set @SqOffVal=0                                                                                              
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex3 where srno=@ctr                                                                                       
                                                              
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                          
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                          
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                          
A_Qty,VBHC,VAHC                                                                          
into #p9_holdadj3                                                              
from VMSS_NonCash_BalAfterMargin a join                                                                                              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                              
where party_code=@pcode and Clsrate > 0 and co_code='MCD' and haircut < 100                                                                                            
                                     
select @Xtotctr=MAX(Srno) from #p9_holdadj3                           
set @TSqOffVal=0                                                                                              
                                                              
set @Xctr=1                                                                                 
                                                                 
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                             
BEGIN                                                                                              
                                                                     
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj3 where srno=@xctr                                                                                     
                                                                      
if (@SqOffVal<@TSqOffVal)                                                                                              
set @TSqOffVal=@SqOffVal           
                                                              
update VMSS_NonCash                                                                                    
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                    
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),         
SqOffseq=@xctr                                                                                 
where id=@id and Haircut < 100                                                                                      
      
set @SqOffVal=@TSqOffVal                                                                                              
                                                                            
set @Xctr=@Xctr+1                                                                     
END                                                    
                                                                                    
DROP TABLE #p9_holdadj3                                                                                              
                     
set @ctr=@ctr+1                                                                                              
end                                                                                              
                                                 
drop table #p9_filex3                                                                            
                                                              
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                                 (                                                                          
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                          
from VMSS_NonCash_BalAfterMargin where co_Code='MCD' and SquareOffQty > 0                                                                       
group by party_Code                                                        
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                          
                                                              
/*----*/                                                                          
UPDATE #p9_File2 SET NSEFO_NONCASH=0,MCD_NONCASH=0,NSX_NONCASH=0                                                                                                             
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL = 0 AND vARmARGINsHORTFALL < 0                                                                                
                                                              
/*                                                                           
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)                                                                      
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                                                                                                            
AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                                                 
                                                                                             
UPDATE #p9_FILE2 SET MCD_NONCASH=0                                                                                                            
UPDATE #p9_FILE2 SET MCD_NONCASH=Stage                                                                                                            
UPDATE #p9_FILE2 SET Stage=0                                                         
                                         
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)                                                                                                            
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                                                                                                            
AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)*-1                                                   
                                                                                                 
UPDATE #p9_FILE2 SET NSX_NONCASH=0                                                   
UPDATE #p9_FILE2 SET NSX_NONCASH=Stage                                                                                                         
UPDATE #p9_FILE2 SET Stage=0                                                                                 
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)                                                                                                           
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                                                                                                           
AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)*-1                                                                                                            
                                                                         
UPDATE #p9_FILE2 SET NSEFO_NONCASH=0                                                                                                            
UPDATE #p9_FILE2 SET NSEFO_NONCASH=Stage                                                      
UPDATE #p9_FILE2 SET Stage=0                                                                                                            
*/                                                                          
                              
update #p9_File2  set VarMarginShortFall_AftAdjCurrDay=vARmARGINsHORTFALL+NSefo_jv+MCD_JV+NSX_JV+NSEFO_NONCASH+MCD_NONCASH+NSX_NONCASH                                                                                                            
where  vARmARGINsHORTFALL < 0                                                                                                             
    
update #p9_File2  set VarMarginShortFall_AftAdj=VarMarginShortFall_AftAdjCurrDay    
    
/*    
--- Used to compute min of last 4 days for squareoff.. not required as per PRMS id: 10391261 dt...14/08/2015...    
update #p9_File2 set VarMarginShortFall_AftAdj=(Case when #p9_File2.VarMarginShortFall_AftAdjCurrDay > q.VarMarginShortFall_AftAdjCurrDay               
then #p9_File2.VarMarginShortFall_AftAdjCurrDay else q.VarMarginShortFall_AftAdjCurrDay end)              
from              
(              
select Party_code,MAX(VarMarginShortFall_AftAdjCurrDay) as VarMarginShortFall_AftAdjCurrDay               
from vmss_Data x join              
(select top 3 processdate from (select distinct processdate from vmss_Data where processdate < @BSElastBillDate) a order by processdate) y               
on x.processdate=y.processdate                           
group by party_code              
) q where #p9_File2.party_code=q.party_code              
*/      
                                  
/* Var Margin % */                                                                              
                                                                                 
truncate table vmss_holding                                                                    
insert into vmss_holding                                                                                                  
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate)                                            
      
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,                                                                                                  
SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS [SrNo],0,ISIN,ActualSqOffQty=CONVERT(int,0),0.00 from #p9_hold                                                                                                  
                                                                    
/*                                                                                                
select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #p9_filex                                                                                                   
from #p9_file2 where VarMarginShortFall_AftAdj < 0            
                                                                            
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                                                                  
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                                                                  
                                                             
select @totctr=MAX(srno) from #p9_filex                                                                                                  
                                                                                       
While @ctr <= @totctr                                                                                                  
Begin                                                                                           
                                                               
set @SqOffVal=0                                                          
select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdj*-1 from #p9_filex where srno=@ctr                                                                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],* into #p9_holdadj from vmss_holding a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                         
where party_code=@pcode and Clsrate > 0                                                                                
                                                                            
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                                                                   
set @TSqOffVal=0                                                                                                  
                                                                              
set @Xctr=1                                                                                      
                                                                              
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN                                                                                      
                                                                          
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                         
                                              
if (@SqOffVal<@TSqOffVal)                                                          
set @TSqOffVal=@SqOffVal                                                                                                  
                                                          
update vmss_holding                                                                           
set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                                                   
SqOffseq=@xctr                                                                                     
where id=@id                                                                            
                                                                              
set @SqOffVal=@TSqOffVal                                                                                                  
                  
set @Xctr=@Xctr+1                                                                                                  
END                                                                                                  
                                                                                       
DROP TABLE #p9_holdadj                                        
                                                                                       
set @ctr=@ctr+1                                        
end                                                                                                  
                                                                                      
drop table #p9_filex                                                                                                  
                                                            
truncate table vmss_holding_hist                                                                                                   
insert into vmss_holding(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq)                                                     
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq from vmss_holding                                                                                   
  
    
    
    
     
                                                                                    
update #p9_file2 set SquareOffValue=b.SqVal from                                                          
(                                                                                        
select party_code,sum(SquareOffQty*Clsrate) as SqVal from vmss_holding where isnull(SquareOffQty,0) > 0                                                                                         
group by party_code                                                                                        
) b                                                                                                   
where #p9_file2.party_code=b.party_Code                                                                                                  
*/                                                                                
                                                                                    
/*                                                                                                        
update #p9_File2 set SquareOffValue=                                                                                                            
Case when (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 < (Holding_BHC)*-1 then (Holding_BHC)*-1                                                                                                            
else (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 end                                  
where LeverageMultiplier > 0                                                                                                            
*/                                                                                                  
                                                                           
/*                                                                          
UPDATE #p9_File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                         
(                                                                              
SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                                                                       
(                                                                                 
SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                         
WHERE CONVERT(DATE,processdate) < (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data )                                                
)                                                                                                                                      
) B WHERE #p9_File2.party_code=B.party_code                                                                                                    
                                                                               
UPDATE #p9_File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                                        
          
*/                                                                                   
                                                                      
delete from VMSS_data where processDate=@BSElastBillDate                                                                                                            
                                                                                       
insert into VMSS_data(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,                                                                                                  
Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,                                                                                                     
NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,remarks,DP_adj,Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                                                                           
   
   
    
    
     
                    
SELECT processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,                                                                                                            
OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,                                              
VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,GETDATE(),'V','',DP_adj,0.00,VarMarginShortFall_AftAdjCurrDay                                                                                                        
FROM #p9_FILE2                                                                                                             
                                                                    
/*                                                                            
insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                        
  
    
    
    
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks)                                                                                   
  
    
    
    
select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                                            
  
    
    
    
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks from VMSS_data                                                                     
  
    
    
    
*/                                                              
                                                                    
End try                                                                                                                                 
BEGIN CATCH                                                                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                          
  select GETDATE(),'VMSS_Calculation_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                                                                               
                      
  DECLARE @ErrorMessage NVARCHAR(4000);                                                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                          
  RAISERROR (@ErrorMessage , 16, 1);                                  
End catch                                                                                 
                      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Calculation_NoNRMS_14122015
-- --------------------------------------------------
  

create Procedure [dbo].[VMSS_Calculation_NoNRMS_14122015]                                                                                                  

as                                                                                                            

                                                                                                            

SET XACT_ABORT ON                                                                                                            

Set nocount on                                                                                                            

BEGIN TRY                                                                                                                                    

                                                                          

 Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                                                            

 Declare @LowerCapNonCash as money = 500  /* NONCASH COLLATERAL MOVEMENT : always +ve */                                                                                                            

 Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                            

                                                                                                      

 select                                                                                                             

 @BSElastBillDate  as processDate,                                                                                                            

 b.Entity,                                                                                                            

 b.segment,                                                                                                            

 a.Party_code,                                                                                                            

 a.Ledger as Balance,                                                                                                            

 CONVERT(money,0)  as UnsettledCr,                                                                                                            

 CONVERT(money,0) as UnsettledDr,                                                                                                            

 a.Unrecosiled_Credit as UnrecoAmt,                                                                                                            

 CONVERT(money,0) as ShortSellValue,                                                                                                            

 a.Imargin as MarginAmt,                                                                                                            

 a.Deposit,                                                                                                            

a.Cash_Colleteral as CashColl,                                                                                                            

a.NonCash_Colleteral as NonCashColl,                                                                                                            

Holding_total,                                                                                                            

Holding_Approved,                                                                                                            

CONVERT(money,0) as OtherDebit,                                                  

CONVERT(int,0) as NonCashConsideration,                                                                                                

CONVERT(money,0) as Net,                       

CONVERT(money,0) as EarlyPayinValue,                

CONVERT(money,0) as LeverageMultiplier,                        

CONVERT(money,0) as VarMarginShortFall,                                                            

CONVERT(money,0) as SquareOffValue,                                

CONVERT(money,0) as MgnAdjNonCash,                                                   

CONVERT(money,0) as MgnAdjNonLed                                                              

into #p9_File1                                                 

from (select * from General.dbo.RMS_DtClFi with (nolock) where 1=2) a join (select segment,entity from intranet.cms.dbo.ncms_entity with (nolock) where entity='Equity') b                                                                  

on a.Co_code=b.segment                                                                   

                                                                                                   

                                                                                                   

 /* update Holding */                                                                                                  

                                                            

select EXCHANGE,sett_no,SEtt_type,                                                                                                            

(CASE WHEN EXCHANGE='NSECM' THEN DUMMY1 ELSE SCRIP_CD END) AS scrip_cd,                                                                                                            

(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,Party_code,Qty,                                                                        

CLSRATE,                                                                                                            

Total AS VBHC,                                                                          

CONVERT(MONEY,0) AS HAIRCUT,                                                                                                            

CONVERT(MONEY,0) AS VAHC,                                                                                                

SPACE(10) AS CATEGORY,                                                                                                            

source AS SRC,                                                                    

ISIN                                                                    

--INTO #p9_HOLD                                                                                                            

from vmss_rms_holding where source in ('SI','SO','H','D')   and party_code='R80022'                  

/*              

SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0      

DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin      

DROP TABLE #nqty  */    

SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0      

SELECT  party_code,isin,SUM(qty) as NQty into  #nqty1 from #p9_hold group by party_code,isin 

if exists (select NQty from #nqty where NQty<0)
begin
	print 'hii'
	DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin      
end
if exists(select NQty from #nqty1 where NQty>0)
begin
 print'byee'
 delete from #p9_HOLD where qty<0
 update #p9_HOLD set qty=NQty from #nqty1 T2 where  T2.party_code = #p9_HOLD.party_code AND T2.isin = #p9_HOLD.isin  
	  
end
DROP TABLE #nqty      
                                                                                                        

update #p9_HOLD set clsrate=b.rate from General.dbo.cp_bsecm b where #p9_HOLD.scrip_Cd=b.scode and #p9_HOLD.clsrate=0                                                                                                            

                

update #p9_HOLD set clsrate=b.cls                                                                                                             

from General.dbo.cp_nsecm b                                                                                                   

where #p9_HOLD.scrip_Cd=b.scrip and #p9_HOLD.series=b.series and #p9_HOLD.clsrate=0 and exchange='NSECM'                                                                                                          

                

update #p9_HOLD set VBHC=clsrate*Qty                                                                                                            

                

update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                

(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                           

where #p9_HOLD.SCRIP_cD=B.BSECODE AND #p9_HOLD.EXCHANGE='BSECM'                                                                                                            

 /*Added to handle scrip:idfc ltd as it has shifted from BE to Eq as suggested by Vishal Gohil on Dec 10 2015*/
--select * from #p9_HOLD where  isin='INE092T01019' and series='EQ'
--update #p9_HOLD set series='EQ' where isin='INE092T01019' and series='BE'

update a set series=b.Currenteries from #p9_HOLD a inner join VMSS_Exception_NSESeries b on a.isin=b.isin and a.series=b.previousseries
               

update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                  

(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                              

where #p9_HOLD.SCRIP_cD=B.NSESYMBOL AND #p9_HOLD.SERIES=B.NSESERIES AND #p9_HOLD.EXCHANGE='NSECM'                                                          

                

update #p9_HOLD set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                            

                

update #p9_HOLD set VAHC=VBHC*((100-HAIRCUT)/100.00)                                              

                

insert into #p9_File1(segment,party_code)                                                          

select b.co_code,party_Code from                                                                                                  

(select party_code from #p9_hold group by party_code) a,                                                                                                   

(select * from General.dbo.company where entitytype='EQ' and bo_active=1) b                                                                                                  

                                                                                                  

update #p9_file1                                                             

set entity='EQUITY',ProcessDate=@BSElastBillDate,Balance=0,UnsettledCr=0,UnsettledDr=0,UnrecoAmt=0,ShortSellValue=0,                                                                                   

MarginAmt=0,Deposit=0,CashColl=0,NonCashColl=0,Holding_total=0,Holding_Approved=0,OtherDebit=0,NonCashConsideration=0,Net=0,                                                                                                  

EarlyPayinValue=0,LeverageMultiplier=0,VarMarginShortFall=0,SquareOffValue=0                                                                                                  

                                                                                   

update #p9_File1 set holding_total=b.VBHC,holding_approved=b.VAHC from                                                             

(select party_code,exchange,VBHC=sum(VBHC),VAHC=sum(VAHC)                                                                                                            

from #p9_hold group by party_code,exchange) b                                                                   

where #p9_File1.party_code=b.party_code and #p9_File1.segment=b.exchange                                                                                                            

                                                                                                  

/* Get Last settlement Date */                                                                                                 

                                                                                  

 Declare @sdtcur as datetime,-- @ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59'                                                                                                    

 @ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'                        

 select @sdtcur=sdtcur from General.dbo.parameter with (nolock) where sdtcur <= @ToDate and ldtcur >=@ToDate                                       

                                   

/* Fetch effective Ledger Balance - Only Bill's effective date else voucher date*/                             

            

 select CLTCODE,                                                                                                            

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                      

 into #p9_BSECM                                                                                                            

 from anand.account_ab.dbo.ledger a with (nolock)                                                                                   

 where vDT>=@sdtcur and vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                       

 group by cltcode                                 

                                                                               

 select CLTCODE,                                                                                              

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                       

 into #p9_NSECM                                                                                                            

from anand1.account.dbo.ledger a with (nolock)                                                                                                                   

 where vDT>=@sdtcur and  vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                                                   

 group by cltcode                                                                                                                

                                             

 select CLTCODE,                                                                                                            

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                             

 into #p9_NSEFO                                                                                                            

 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                                                   

 /* where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end) */                                                                                                           


 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate         

 group by cltcode                                                                                                                

                                                             

 select CLTCODE,                                                                                                            

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            

 into #p9_NSX                                                                                             

 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                                                   

 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate         

 group by cltcode                                                                                                                

               

select CLTCODE,                                            

VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                      

into #p9_MCD                                                                                                

from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)      

where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate         

group by cltcode                                                                                                                

                                                                                              

 /* Fetch Deposit */                                                                        

 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                             

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                

 into #p9_dep_BSECM                                                                                                            

 from anand.account_ab.dbo.ledger a with (nolock)                                                                    

 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                  

 group by cltcode                                          

                                

 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                  

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            

 into #p9_dep_NSECM from anand1.account.dbo.ledger a with (nolock)                                                       

 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                  

 group by cltcode                                                                  

                                                                                                            

 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                   

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            

 into #p9_dep_NSEFO                                                                                                            

 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                 

 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '40%'                                                                                                                  

 group by cltcode                                                                                   

                                                                                                              

 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                  

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            

 into #p9_dep_NSX                                                                                                            

 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                               

 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                          

 group by cltcode                                   

                                                                                                        

 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                               

 into #p9_dep_MCD                    

 from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                               

 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                  

 group by cltcode                                                                                            

                                                                     

 update #p9_File1 set Balance=b.Vbal from #p9_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                                                            

 update #p9_File1 set Balance=b.Vbal from #p9_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                            

 update #p9_File1 set Balance=b.Vbal from #p9_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                                            

 update #p9_File1 set Balance=b.Vbal from #p9_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                                                  

 update #p9_File1 set Balance=b.Vbal from #p9_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                        

                                                                                                            

 update #p9_File1 set deposit=b.Vbal from #p9_dep_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                       

 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                                                            

 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                      

 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                       

 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                                                                      

                                                                                                  

 update #p9_File1 set Earlypayinvalue=b.EPV from                                                                                                       

 (select Exchange,party_code,SUM(total) as EPV from VMSS_EarlyPayinData group by Exchange,party_code) b                                                                                                            

 where #p9_File1.party_code=b.party_Code and #p9_File1.segment=b.exchange                                                                                                  

                                                                                                             

 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                         

 (       

 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                  

 from angelfo.nsefo.dbo.tbl_clientmargin with (nolock)                                                    

 where MarginDate = (select MAX(margindate) from angelfo.nsefo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                               

  ) b                                                                

  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSEFO'                                                                                                  

                                                                                                  

 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                        

 (                                                                                                  

 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                  

 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                               

 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                     

  ) b                                                                                                   

  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCD'                                                                                       

                                                                                    

 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                  

 (                                                                         

 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                  

 from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock)                                                                                                  

 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                      

) b                                                                                

  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSX'                                                                                                  

                                                                          

 update #p9_File1 set NonCashColl=b.NonCashColl                                     

 from VMSS_Client_collateral_NonEquity_NoBrInfo b                                                                                                  

 where #p9_File1.party_code=b.party_code and #p9_file1.segment=b.co_code                                                                             

                                                            

/* Excess Collateral adjustement with Ledger Debit */                                                            

 update #p9_File1 set NonCashColl=NonCashColl+Balance                                                                                                 

 where NonCashColl > 0 and Balance < 0 and segment in ('NSEFO','MCD','NSX')                                                           

                                                                           

 /* GEnerate Summarised Data */                

          

delete from #p9_file1 where party_code in (select party_code from mis.sccs.dbo.Combine_legal)                                                          

delete from #p9_file1 where party_code in (select party_code from General.dbo.client_Details where (branch_cd='NRIS' or sub_broker='BH'))                      

                    

/*Remove Tday and T+1 day clients ,added by abha as suggested by vishal gohil*/                       

                    

delete from #p9_file1 where party_code in (select Party_Code     

from General.dbo.SQUAREUP_CLIENT_ALERT where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT_ALERT))       

/* -----T day------ */    
                        

delete from #p9_file1 where party_code in (select party_Code from General.dbo.SQUAREUP_CLIENT     

where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT))        

/*------T+1day --------*/    


select                                                                                                             

max(processDate) as processDate,Entity,Party_code,convert(int,1) as NoofDays,                                                                                                            

sum(Balance) as Balance,sum(MarginAmt) as MarginAmt,sum(Deposit) as Deposit,                                           

sum(CashColl) as CashColl,sum(NonCashColl) as NonCashColl,sum(Holding_total) as Holding_BHC,                                                                                               

sum(Holding_Approved) as Holding_AHC,sum(OtherDebit) as OtherDebit,                                            

sum(EarlyPayinValue) as EarlyPayinValue,sum(LeverageMultiplier) as LeverageMultiplier,                                                                                           

sum(VarMarginShortFall) as VarMarginShortFall,                             

Convert(money,0) as NSEFO_JV,                                                                                                            

Convert(money,0) as NSEFO_NonCash,                                                                                                            

Convert(money,0) as MCD_JV,                                                                                           

Convert(money,0) as MCD_NonCash,                                                                                                            

Convert(money,0) as NSX_JV,                                                                                                            

Convert(money,0) as NSX_NonCash,                                                          

Convert(money,0) as VarMarginShortFall_AftAdj,                                                                                           

Convert(money,0) as Stage,                                                                                                            

sum(SquareOffValue) as SquareOffValue,Sum(Case when Segment='BSECM' then BAlance else 0 end) as BSECM_Balance,                                                                                                             

Sum(Case when Segment='NSECM' then BAlance else 0 end) as NSECM_Balance,                                                     

Convert(money,0) as DP_adj ,            

Convert(money,0) as VarMarginShortFall_AftAdjCurrDay                                                                              

into #p9_file2                                                                                                            

from #p9_file1 where segment in ('BSECM','NSECM')                                                                                                            

group by Entity,Party_code                                   

                                                       

/* delete Client with Cash Credit effective Balance */                                                                                                   

                                                          

Delete from #p9_file2 where balance >= @LowerCapAmt                      

Delete from #p9_file2 where party_code in (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF'))                                                                              

Delete from #p9_file1 where party_Code not in (select party_code from #p9_file2)                                                                          

Delete from #p9_file2 where Holding_BHC <= 0                                                   

                              

update #p9_File2 set VarMarginShortFall=(case when Holding_AHC+Balance+Deposit+EarlypayinValue < @LowerCapAmt then Holding_AHC+Balance+Deposit+EarlypayinValue  else 0 end)                                                                                   
                                    

update #p9_File2 set LeverageMultiplier=                                                                                                            

Case when 100-(Holding_AHC/Holding_BHC)*100.00 > 100 then 100 else 100-(Holding_AHC/Holding_BHC)*100.00 end                                                                                                            

where Holding_BHC > 0                                                                                              

                                                                      

update #p9_file1 set MgnAdjNonCash=0 where MgnAdjNonCash is null                                                                                        

update #p9_file1 set MgnAdjNonLed=0 where MgnAdjNonLed is null                                                

                    

/* Adj.Margin with Non_Cash Scripwise */                                                                   

                                  

update vmss_NonCash set FinalAmount=Amount-(Amount*(MarginHC/100.00))                                          

update vmss_NonCash set MarginSqOffQty=0                                                

/*---- Full NonCash Getting adjusted against Margin */                                                                          

update vmss_NonCash set MarginSqOffQty=Qty from                                                                          

(                                                                          

/*                                                          

select a.*,b.MarginAmt from                                                                          

(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_NonCash group by party_code,co_Code) a join                                                                          

(select segment,party_code,MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                          

on a.party_code=b.party_code and a.co_code=b.segment                                                                          

where b.MArginAmt >= a.VAHC                                                           

*/                                

select a.*,b.MarginAmt from                                                                        

(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_NonCash group by party_code,co_Code) a join                                                                        

(select segment,party_code,MArginAmt+(Case when balance < 0 then -balance else 0 end) as MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                   

on a.party_code=b.party_code and a.co_code=b.segment                                                                        

where b.MArginAmt >= a.VAHC                                                           

) x where vmss_NonCash.party_code=x.party_Code and vmss_NonCash.co_code=x.co_Code                                            

                                                              

/*---- Partial NonCash Getting adjusted against Margin */                                                   

                                      

                                                     

select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex from                                                                           

/* (select * from #p9_file1 where marginAmt > 0 ) a  left outer join             */                                                        

(select                   

processDate,Entity,segment,Party_code,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,                                               

(Case when Balance < 0 then MarginAmt-Balance else MArginAmt end) as MarginAmt,                                                  

Deposit,CashColl,NonCashColl,Holding_total,Holding_Approved,OtherDebit,NonCashConsideration,                                                  

Net,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,SquareOffValue,MgnAdjNonCash,MgnAdjNonLed                                                  

from #p9_file1 where segment in ('NSEFO','MCD','NSX')) a  left outer join                                                 

(select co_code,party_code from vmss_NonCash where MarginSqOffQty <> 0 group by party_code,Co_Code) b                                                                          

on a.party_code=b.party_code and a.segment=b.co_Code                                                                          

join (select co_code,party_code from vmss_NonCash where MarginSqOffQty = 0 group by party_code,Co_Code) c                                                                          

on a.party_code=c.party_code and a.segment=c.co_Code                                                                          

where b.Party_Code is null                                                                          

                                                

Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                           

declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0,@segment as varchar(10) = ''                                                                            

                                            

select @totctr=MAX(srno) from #p9_filex                                                            

                                                              

While @ctr <= @totctr                                                                                              

Begin                                                                                              

                                                                         

set @SqOffVal=0                                                                                              

select @pcode=party_Code,@SqOffVal=MarginAmt,@segment=segment from #p9_filex where srno=@ctr                                                             

                                                              

select ROW_NUMBER() OVER (ORDER BY b.seqid,FinalAmount desc) AS [SrNo],                                                                          

id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,MarginHC as HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,                                                                          

clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty                                                                          

into #p9_holdadj from vmss_NonCash a join                                                        

(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                         

where party_code=@pcode and Clsrate > 0 and MarginHC < 100 and co_Code=@segment                         

                                                              

select @Xtotctr=MAX(Srno) from #p9_holdadj                                                    

set @TSqOffVal=0                                                                              

                                                              

set @Xctr=1                                                                                    

                                                                              

While @Xctr <= @Xtotctr  and @SqOffVal > 0                                       

BEGIN                                                                 

                                                                     

select @TSqOffVal=FinalAmount,@qty=Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                     

                                                                      

if (@SqOffVal<@TSqOffVal)                                                                                            

set @TSqOffVal=@SqOffVal                                                                                         

                                                              

  

update vmss_NonCash                                                                                    

set MarginSqOffQty=ceiling(Case when @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) <= @qty                                         

then @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) else @qty end)                                                                                

where id=@id  and  MarginHC < 100                                                       

                                                                              

set @SqOffVal=@SqOffVal-@TSqOffVal                                                                      

set @Xctr=@Xctr+1                                                                                              

  

END                                                                                              

                             

DROP TABLE #p9_holdadj                                                                                              

                                                                                    

set @ctr=@ctr+1                            

end                                                                                              

                                                                          

drop table #p9_filex                                                                                              

                                                              

/* Calculation Margin Adjusted with NonCash */                                                                                              

                                                              

/*                                                                          

update #p9_file1 set MgnAdjNonCash=(Case when MarginAmt-(NonCashColl+CashColl) < 0 then MarginAmt else (NonCashColl+CashColl) end)                                                                      

where segment in ('NSEFO','MCD','NSX')                                                                                              

*/                                                                          

                                                              

update #p9_file1 set MgnAdjNonCash=B.AdjWithMargin from                                     

(                           

select co_Code,party_code,sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) as AdjWithMargin from vmss_NonCash                                                                          

group by co_Code,party_code                                                                          

having sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) > 0                                        

) b where #p9_file1.party_code=b.party_Code and #p9_file1.segment=b.co_Code                                                    

                                                                                  

/* Calculation Margin Adjusted with Ledger Credit */                                                                                              

update #p9_file1 set MgnAdjNonLed=(Case                                             

when Balance > (MarginAmt-MgnAdjNonCash) and MarginAmt-MgnAdjNonCash > 0 and balance > 0 then (MarginAmt-MgnAdjNonCash)                                                                                    

when Balance <= (MarginAmt-MgnAdjNonCash) and balance > 0 then Balance                                                                                              

else 0 end) where segment in ('NSEFO','MCD','NSX')                                                               

                                         

                                   

                                                                               

update  #p9_File2 set NSEFO_JV=b.AdjWithLedgerCr /*,NSEFO_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                                                            

(                                                                                                            

select party_code,                                                                          

AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                          

AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                               

from #p9_file1 where segment='NSEFO' and                                                                 

(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                          

) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             

                                                                                                 

                                                               

update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr /*,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                  

(                                                                                                            

select party_code,                                                                          

AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                          

AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                  

from #p9_file1 where segment='NSX' and                                                                 

(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                          

) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             

                                            

/*                                                                          

update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                            

(          

select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                      

from #p9_file1 where segment='NSX'                                                                                                 

) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                            

*/                                                                           

update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                         

(                                                                                                            

select party_code,                                                                          

AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                          

AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                            

from #p9_file1 where segment='MCD' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                

) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             

                                                               

/*                                                                                                             

update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                            

(                                                                                                

select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                 

from #p9_file1 where segment='MCD'                                                                                                 

) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             

*/                                                                                                    

                                                              

UPDATE #p9_File2 SET NSEFO_JV=-vARmARGINsHORTFALL  WHERE NSEFO_JV > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV > 0                                    

UPDATE #p9_File2 SET mcd_jv=-vARmARGINsHORTFALL-NSEFO_jv  WHERE mcd_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv >= 0                                                                                                            


UPDATE #p9_File2 SET NSX_jv=-VARMARGINSHORTFALL-NSEFO_JV-mcd_jv  WHERE nsx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv >= 0                                                  

                                                               

UPDATE #p9_File2 SET NSEFO_JV=0 where NSEFO_JV<0                                                                                    

UPDATE #p9_File2 SET mcd_jv=0 where mcd_jv<0                                                   

UPDATE #p9_File2 SET NSX_jv=0 where NSX_jv<0                          

                                                                                                

/* Adjust VarMArgin Shortage with NonCash Collateral */                                                                          

                                  

update vmss_NonCash set FinalAmount=Amount*(Haircut/100.00)                                               

                                                              

/*----- NSEFO-----*/                                     

                                                              

set @totctr  = 0                      

set @ctr = 1                                                                              

set @SqOffVal = 0                                                                              

set @pcode =''                                                                              

set @Xtotctr = 0                    

set @Xctr = 1                                                                          

SET @qty = 0                         

set @TSqOffVal = 0                                                                              

set @SqQty = 0                                                                

set @clsrate =0                                                                              

set @id = 0                                                                           

                                                        

select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex1                                                                          

from                                                                    

(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv as VarMarginShortFallAftJV from #p9_file2 where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv < 0) a join                                                                          

(select party_code from vmss_NonCash where MarginSqOffQty < Qty and Co_Code='NSEFO' group by party_code) c                                                                          

on a.party_code=c.party_code                                                                          

                                                                 

select @totctr=MAX(srno) from #p9_filex1                                                                                              

                                                                

While @ctr <= @totctr                                                    

Begin                                                                                              

                       

set @SqOffVal=0                                                                                              

select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex1 where srno=@ctr                                                                                       

                                                              

select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                          

id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                          

FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                               

A_Qty,VBHC,VAHC                                                                          

into #p9_holdadj1                                                                           

from VMSS_NonCash_BalAfterMargin a join                                                                                              

(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                           

where party_code=@pcode and Clsrate > 0 and co_code='NSEFO' and haircut < 100                                          

                                                              

select @Xtotctr=MAX(Srno) from #p9_holdadj1                                                                                               

set @TSqOffVal=0      

set @Xctr=1                                                         

  

  

                    

While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                             

BEGIN                                                                  

                                                                     

select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj1 where srno=@xctr                                                          

                     

if (@SqOffVal<@TSqOffVal)                                                                                              

set @TSqOffVal=@SqOffVal                                                                                              

                                                        

update vmss_NonCash                                                                       

set                                     

/* SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                    

SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                    

SqOffseq=@xctr                                                                                 

where id=@id  and  Haircut < 100                                                                                      

                                                                              

set @SqOffVal=@TSqOffVal                                                                                              

  

set @Xctr=@Xctr+1      

  

                                                                                          

END                                                                                              

                                                                                    

DROP TABLE #p9_holdadj1                                                                                    

                                                                                    

set @ctr=@ctr+1                                                                                              

end                                                

                                                                                   

update #p9_file2 set NSEFO_noncash=B.AdjustedAmt FROM                                                                          

(                                                                          

select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                           

from VMSS_NonCash_BalAfterMargin where co_Code='NSEFO' and SquareOffQty > 0                                                                       

group by party_Code                                                          

) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                          

                                                             

/*------ NSX ----*/                                                            

set @totctr  = 0                                                                              

set @ctr = 1                                                                              

set @SqOffVal = 0                                                  

set @pcode =''                                                    

set @Xtotctr = 0                                                                              

set @Xctr = 1                                                

SET @qty = 0                                                                          

set @TSqOffVal = 0                                                  

set @SqQty = 0                                                                  

set @clsrate =0                                                       

set @id = 0                                                                           

                                               

select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex2                                                                 

from                                                                          

(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash as VarMarginShortFallAftJV from #p9_file2                 

where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash < 0) a join                                                                          

(select party_code from vmss_NonCash where MarginSqOffQty < Qty and Co_Code='NSX' group by party_code) c                                                                          

on a.party_code=c.party_code                                                                          

                          

select @totctr=MAX(srno) from #p9_filex2                                                                                              

                                                                                    

While @ctr <= @totctr                                                                                          

Begin                                                                                              

                                                                      

set @SqOffVal=0                                                                                              

select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex2 where srno=@ctr                                                                          

                                                              

select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                          

id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                          

FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                          

A_Qty,VBHC,VAHC                                                                          

into #p9_holdadj2                                                                           

from VMSS_NonCash_BalAfterMargin a join                                                                                              

(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                              

where party_code=@pcode and Clsrate > 0 and co_code='NSX'  and haircut < 100                                                                                           

                                   

select @Xtotctr=MAX(Srno) from #p9_holdadj2                                                                                               

set @TSqOffVal=0                                                                                     

                                                              

set @Xctr=1                                                       

      

While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                             

BEGIN         

                                                                     

select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj2 where srno=@xctr                   

                                                                      

if (@SqOffVal<@TSqOffVal)                                                                                              

set @TSqOffVal=@SqOffVal                                                           

                                                              

update vmss_NonCash                                                                          

/*set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                    

set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                                    

SqOffseq=@xctr                                                                              

where id=@id and Haircut < 100  

       

set @SqOffVal=@TSqOffVal                                                                                              

                                                                            

set @Xctr=@Xctr+1                                                                                              

END                                                                                              

                                                                                    

DROP TABLE #p9_holdadj2                                                                                              

                                                                    

set @ctr=@ctr+1                                                                                              

end                                                                                              

                                                                          

drop table #p9_filex2                                                                            

                                                    

update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                          

(                                                                          

select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                           

from VMSS_NonCash_BalAfterMargin where co_Code='NSX' and SquareOffQty > 0                                           

group by party_Code                                                          

) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                          

                                                               

                                                              

/*------ MCD ----*/                                                                          

                                                              

set @totctr  = 0                                                                              

set @ctr = 1                                                                              

set @SqOffVal = 0                                                              

set @pcode =''                                                                              

set @Xtotctr = 0                                                                              

set @Xctr = 1                                                                                

SET @qty = 0                                                                          

set @TSqOffVal = 0                                            

set @SqQty = 0                                                                              

set @clsrate =0                                                                              

set @id = 0                            

                                    

select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex3                                                                          

from                                                                          

(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash as VarMarginShortFallAftJV from #p9_file2                                                                           

where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash < 0) a join                                        

(select party_code from vmss_NonCash where MarginSqOffQty < Qty and Co_Code='MCD' group by party_code) c                                  

on a.party_code=c.party_code                                        

                                                                 

select @totctr=MAX(srno) from #p9_filex3                                                 

                                

While @ctr <= @totctr                                                                                              

Begin                      

                                                            

set @SqOffVal=0                                                                                              

select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex3 where srno=@ctr                                                                                       

                                                              

select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                          

id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                          

FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                          

A_Qty,VBHC,VAHC                                                                          

into #p9_holdadj3                                                              

from VMSS_NonCash_BalAfterMargin a join                                                                                              

(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                              

where party_code=@pcode and Clsrate > 0 and co_code='MCD' and haircut < 100                                                                                            

                                     

select @Xtotctr=MAX(Srno) from #p9_holdadj3                           

set @TSqOffVal=0                                                                                              

                                                              

set @Xctr=1                                                                                 

                                                                 

While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                             

BEGIN                                                                                              

                                                                     

select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj3 where srno=@xctr                                                                                     

                           

if (@SqOffVal<@TSqOffVal)                                                                                              

set @TSqOffVal=@SqOffVal           

                                                              

update vmss_NonCash                                                                                    

/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                    

set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),         

SqOffseq=@xctr                                                                                 

where id=@id and Haircut < 100                                                                                      

      

set @SqOffVal=@TSqOffVal                                                                                              

                                                                            

set @Xctr=@Xctr+1                                                                     

END                                                    

                                                                                    

DROP TABLE #p9_holdadj3                                                                                              

                     

set @ctr=@ctr+1                                                                                              

end                                                                                              

                                                 

drop table #p9_filex3                                                                            

                                                              

update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                                 (                                                                          

select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                          

from VMSS_NonCash_BalAfterMargin where co_Code='MCD' and SquareOffQty > 0                                                                       

group by party_Code                                                        

) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                          

                                                              

/*----*/                                                                          

UPDATE #p9_File2 SET NSEFO_NONCASH=0,MCD_NONCASH=0,NSX_NONCASH=0                                                                                                             

WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL = 0 AND vARmARGINsHORTFALL < 0                                                                                

                                                              

/*                                                                           

UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)                                                                      

WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                                                                                                            

AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                                                 

                                                                                             

UPDATE #p9_FILE2 SET MCD_NONCASH=0                                                                                                            

UPDATE #p9_FILE2 SET MCD_NONCASH=Stage                                                                               

UPDATE #p9_FILE2 SET Stage=0                                                         

                                         

UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)                                                                                                            

WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                                                                                                            

AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)*-1                                                   

                                                                                                 

UPDATE #p9_FILE2 SET NSX_NONCASH=0                                                   

UPDATE #p9_FILE2 SET NSX_NONCASH=Stage                                                                                                         

UPDATE #p9_FILE2 SET Stage=0                                                                                 

UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)                                                                                                           

WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                                                                                                           

AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)*-1                                                                                                            

                                                                         

UPDATE #p9_FILE2 SET NSEFO_NONCASH=0                                                                                                            

UPDATE #p9_FILE2 SET NSEFO_NONCASH=Stage                                                      

UPDATE #p9_FILE2 SET Stage=0                                                                                                            

*/                                                                          

                              

update #p9_File2  set VarMarginShortFall_AftAdjCurrDay=vARmARGINsHORTFALL+NSefo_jv+MCD_JV+NSX_JV+NSEFO_NONCASH+MCD_NONCASH+NSX_NONCASH                                                                                                            

where  vARmARGINsHORTFALL < 0                                                                                                             

    

update #p9_File2  set VarMarginShortFall_AftAdj=VarMarginShortFall_AftAdjCurrDay    

    

/*    

--- Used to compute min of last 4 days for squareoff.. not required as per PRMS id: 10391261 dt...14/08/2015...    

update #p9_File2 set VarMarginShortFall_AftAdj=(Case when #p9_File2.VarMarginShortFall_AftAdjCurrDay > q.VarMarginShortFall_AftAdjCurrDay               

then #p9_File2.VarMarginShortFall_AftAdjCurrDay else q.VarMarginShortFall_AftAdjCurrDay end)              

from              

(              

select Party_code,MAX(VarMarginShortFall_AftAdjCurrDay) as VarMarginShortFall_AftAdjCurrDay               

from VMSS_data x join              

(select top 3 processdate from (select distinct processdate from VMSS_data where processdate < @BSElastBillDate) a order by processdate) y               

on x.processdate=y.processdate                           

group by party_code              

) q where #p9_File2.party_code=q.party_code              

*/      

                                  

/* Var Margin % */                                                                              

          

truncate table vmss_holding                                                                    

insert into vmss_holding                                                                                                  

(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate)                                            

      

select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,                                                                                                  

SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS [SrNo],0,ISIN,ActualSqOffQty=CONVERT(int,0),0.00 from #p9_hold                                                                                                  

                                                                    
select distinct SRC from  vmss_holding
/*                                                                                                

select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #p9_filex                                                                                                   

from #p9_file2 where VarMarginShortFall_AftAdj < 0            

                                                                            

Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                                                                  

declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                                                                  

                                                             

select @totctr=MAX(srno) from #p9_filex                                                                                                  

                                                                                       

While @ctr <= @totctr                                                                                                  

Begin                                                                                           

                                                               

set @SqOffVal=0                                                          

select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdj*-1 from #p9_filex where srno=@ctr                                                                                                                  

select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],* into #p9_holdadj from vmss_holding a join                                                                                                  

(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                         

where party_code=@pcode and Clsrate > 0                                                                                

                                                                            

select @Xtotctr=MAX(Srno) from #p9_holdadj                                                                                                   

set @TSqOffVal=0                                                                                                  

                                                                              

set @Xctr=1                                                                                      

                                                                              

While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 

BEGIN      

                                                                          

select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                         

                                              

if (@SqOffVal<@TSqOffVal)                                                          

set @TSqOffVal=@SqOffVal                                                                                                  

                                                          

update vmss_holding                                                                       

set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                                                   

SqOffseq=@xctr                                                                                     

where id=@id                                                                            

                                                                              

set @SqOffVal=@TSqOffVal                                                                                                  

                  

set @Xctr=@Xctr+1                                                                                                  

END                                                                                                  

                                                                                       

DROP TABLE #p9_holdadj                                        

                                                                                       

set @ctr=@ctr+1                                        

end                                                                                                  

                                                                                      

drop table #p9_filex                                                                                                  

                                                            

truncate table vmss_holding_hist                                                                                                   

insert into vmss_holding(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq)                                                     

select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq from vmss_holding                                                                                   


update #p9_file2 set SquareOffValue=b.SqVal from                                                          

(                                                                                        

select party_code,sum(SquareOffQty*Clsrate) as SqVal from vmss_holding where isnull(SquareOffQty,0) > 0                                                                                         

group by party_code                                                                                        

) b                                                                                                   

where #p9_file2.party_code=b.party_Code                                                                                                  

*/                                                                                

                                                                                    

/*                                                                                                        

update #p9_File2 set SquareOffValue=                                                                                                           

Case when (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 < (Holding_BHC)*-1 then (Holding_BHC)*-1                                                                                                            

else (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 end                                  

where LeverageMultiplier > 0                                                                                                            

*/                                                                                                  

                                                                           

/*                                                                          

UPDATE #p9_File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                         

(                                                                              

SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                                                                       

(                                                                                 

SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                       

WHERE CONVERT(DATE,processdate) < (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data)                                                

)                                                                                                                                      

) B WHERE #p9_File2.party_code=B.party_code                                                                                                    

                                                                               

UPDATE #p9_File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                                        

          

*/                                                                                   

                                                                      

delete from VMSS_data where processDate=@BSElastBillDate                                                                                                            

                                                                                       

insert into VMSS_data(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,                                                                                                  

Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,                                                                                                     

NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,remarks,DP_adj,Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                                                                           


SELECT processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,                                                                                                            

OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,                                              

VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,GETDATE(),'V','',DP_adj,0.00,VarMarginShortFall_AftAdjCurrDay                                                                                                        

FROM #p9_FILE2                                                                                                             

                          

/*                                                                            

insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                        
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks)                                                                                   
select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                                            
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks from VMSS_data                                                                     
*/                                                              

                                                                    

End try                                                                                                                                 

BEGIN CATCH                                                                                                                                    

  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                          

  select GETDATE(),'VMSS_Calculation_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                                                                               

                      

  DECLARE @ErrorMessage NVARCHAR(4000);                                                            

  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                          

  RAISERROR (@ErrorMessage , 16, 1);                                  

End catch                                                                                 

                      

SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Calculation_NoNRMS_26082016
-- --------------------------------------------------
create Procedure [dbo].[VMSS_Calculation_NoNRMS_26082016]                                                                                                      
as                                                                                                                
                                                                                                                
SET XACT_ABORT ON                                                                                                                
Set nocount on                                                                                                                
BEGIN TRY                                                                                                                                        
  
 exec VMSS_upd_ASB7_Days    
                                                                             
 Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                                                                
 Declare @LowerCapNonCash as money = 500  /* NONCASH COLLATERAL MOVEMENT : always +ve */                                                                                                                
 Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                
                                                                                                          
 select                                                                                                                 
 @BSElastBillDate  as processDate,                                                                                                                
 b.Entity,                                                                                                                
 b.segment,                                                                                                                
 a.Party_code,                                                                                                                
 a.Ledger as Balance,                                                                                                                
 CONVERT(money,0)  as UnsettledCr,                                                                                                                
 CONVERT(money,0) as UnsettledDr,                                                                                                                
 a.Unrecosiled_Credit as UnrecoAmt,                                                                                                                
 CONVERT(money,0) as ShortSellValue,                                                                                                                
 a.Imargin as MarginAmt,                                                                                                                
 a.Deposit,                                                                                                                
a.Cash_Colleteral as CashColl,                                                                                                                
a.NonCash_Colleteral as NonCashColl,                                                                                                                
Holding_total,                                                                                                                
Holding_Approved,                                                                                                                
CONVERT(money,0) as OtherDebit,                                                      
CONVERT(int,0) as NonCashConsideration,          
CONVERT(money,0) as Net,   
CONVERT(money,0) as EarlyPayinValue,                    
CONVERT(money,0) as LeverageMultiplier,                            
CONVERT(money,0) as VarMarginShortFall,                                                                
CONVERT(money,0) as SquareOffValue,                                    
CONVERT(money,0) as MgnAdjNonCash,                                                       
CONVERT(money,0) as MgnAdjNonLed                                                                  
into #p9_File1                                                     
from (select * from General.dbo.RMS_DtClFi with (nolock) where 1=2) a join (select segment,entity from intranet.cms.dbo.ncms_entity with (nolock) where entity='Equity') b                                                                      
on a.Co_code=b.segment                                                                       
                                                                                                       
                                                                                                       
 /* update Holding */                                                                                                      
select EXCHANGE,sett_no,SEtt_type,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY1 ELSE SCRIP_CD END) AS scrip_cd,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,Party_code,Qty,                                                                            
CLSRATE,                                                                                                                
Total AS VBHC,                                                                              
CONVERT(MONEY,0) AS HAIRCUT,                                                                                                                
CONVERT(MONEY,0) AS VAHC,                                                                                                    
SPACE(10) AS CATEGORY,                                                                                                                
source AS SRC,                                                                        
ISIN                                                                        
INTO #p9_HOLD                                                                                                                
from vmss_rms_holding where source in ('SI','SO','H','D')                    
  
update #p9_HOLD set series=b.NseSeries from general.dbo.scrip_master b  
where #p9_HOLD.isin=b.isin and b.NseSeries='EQ'   
  
                    
SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0          
DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin          
DROP TABLE #nqty          
                                                                                                       
update #p9_HOLD set clsrate=b.rate from General.dbo.cp_bsecm b where #p9_HOLD.scrip_Cd=b.scode and #p9_HOLD.clsrate=0                                                                                                                
                    
update #p9_HOLD set clsrate=b.cls                                                                                                                 
from General.dbo.cp_nsecm b                                                                                                       
where #p9_HOLD.scrip_Cd=b.scrip and #p9_HOLD.series=b.series and #p9_HOLD.clsrate=0 and exchange='NSECM'                                                                                                              
                    
update #p9_HOLD set VBHC=clsrate*Qty                                                                                           
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                    
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                               
where #p9_HOLD.SCRIP_cD=B.BSECODE AND #p9_HOLD.EXCHANGE='BSECM'                                                                                                                
    
    
/*Added to handle scrip:idfc ltd as it has shifted from BE to Eq as suggested by Vishal Gohil on Dec 10 2015*/    
--select * from #p9_HOLD where  isin='INE092T01019' and series='EQ'    
--update #p9_HOLD set series='EQ' where isin='INE092T01019' and series='BE'    
    
/* update a set series=b.Currenteries from #p9_HOLD a inner join VMSS_Exception_NSESeries b on a.isin=b.isin and a.series=b.previousseries  */  
    
/*******************************************************************/    
    
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                  
where #p9_HOLD.SCRIP_cD=B.NSESYMBOL AND #p9_HOLD.SERIES=B.NSESERIES AND #p9_HOLD.EXCHANGE='NSECM'                                                              
      
                    
update #p9_HOLD set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #p9_HOLD set VAHC=VBHC*((100-HAIRCUT)/100.00)                                                  
                    
insert into #p9_File1(segment,party_code)                                                              
select b.co_code,party_Code from                                                                                                      
(select party_code from #p9_hold group by party_code) a,                                                                                                       
(select * from General.dbo.company where entitytype='EQ' and bo_active=1) b                                                                                                      
                                                                                                      
update #p9_file1                                                                 
set entity='EQUITY',ProcessDate=@BSElastBillDate,Balance=0,UnsettledCr=0,UnsettledDr=0,UnrecoAmt=0,ShortSellValue=0,                                                                                       
MarginAmt=0,Deposit=0,CashColl=0,NonCashColl=0,Holding_total=0,Holding_Approved=0,OtherDebit=0,NonCashConsideration=0,Net=0,                                                                                                      
EarlyPayinValue=0,LeverageMultiplier=0,VarMarginShortFall=0,SquareOffValue=0                                                                                                      
                                                                                       
update #p9_File1 set holding_total=b.VBHC,holding_approved=b.VAHC from                                                                 
(select party_code,exchange,VBHC=sum(VBHC),VAHC=sum(VAHC)                                                                                                                
from #p9_hold group by party_code,exchange) b                                                                       
where #p9_File1.party_code=b.party_code and #p9_File1.segment=b.exchange                                                                              
                                                                                                      
/* Get Last settlement Date */                                                                                                     
                                                                                      
 Declare @sdtcur as datetime,-- @ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59'                                                                                                        
 @ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'                                  
 select @sdtcur=sdtcur from General.dbo.parameter with (nolock) where sdtcur <= @ToDate and ldtcur >=@ToDate                                           
                                       
/* Fetch effective Ledger Balance - Only Bill's effective date else voucher date*/                                 
                
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
 into #p9_BSECM                                                                                                                
 from anand.account_ab.dbo.ledger a with (nolock)                                                                                       
 where vDT>=@sdtcur and vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                           
 group by cltcode                                     
                                                                                   
 select CLTCODE,                                                                                                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                           
 into #p9_NSECM                                                                                                                
from anand1.account.dbo.ledger a with (nolock)                                                                                                                       
 where vDT>=@sdtcur and  vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                                                       
 group by cltcode                                                                                                                    
                                                 
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                 
 into #p9_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                                                       
 /* where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end) */                                                                                                           
  
  
    
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                                 
 select CLTCODE,                                                                          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_NSX                         
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                                                       
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                               
select CLTCODE,                                                
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
into #p9_MCD                                                                                                    
from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)          
where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
group by cltcode                                                                                                                    
                                                                                                  
 /* Fetch Deposit */                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                 
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                    
 into #p9_dep_BSECM                                                                                                                
 from anand.account_ab.dbo.ledger a with (nolock)                                                                        
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                      
 group by cltcode                                              
                                    
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSECM from anand1.account.dbo.ledger a with (nolock)                                                           
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                      
                                                                                                                
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                       
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                     
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '40%'                                                                                                                      
 group by cltcode                                                                                       
                                                                  
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                         
 into #p9_dep_NSX                                                                                                                
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                   
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                              
 group by cltcode                                       
                                                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                   
 into #p9_dep_MCD                        
 from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                                   
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                                                
                                                                         
 update #p9_File1 set Balance=b.Vbal from #p9_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                                                      
 update #p9_File1 set Balance=b.Vbal from #p9_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                            
                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                          
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                                                                          
                                                                                                      
 update #p9_File1 set Earlypayinvalue=b.EPV from                      
 (select Exchange,party_code,SUM(total) as EPV from VMSS_EarlyPayinData group by Exchange,party_code) b          
 where #p9_File1.party_code=b.party_Code and #p9_File1.segment=b.exchange                                                                                              
                                                                                                                 
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                             
 (           
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelfo.nsefo.dbo.tbl_clientmargin with (nolock)                                                        
 where MarginDate = (select MAX(margindate) from angelfo.nsefo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                   
  ) b                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSEFO'                                                                                                      
                                                                                                      
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                            
 (                                                                                                      
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                                   
 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                         
  ) b                                                                                                       
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCD'                                                                                           
                                                                                        
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                      
 (                                                                             
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                      
 from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock)                                                                                                      
 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                          
) b                                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSX'                                                                                                      
                                                                              
 update #p9_File1 set NonCashColl=b.NonCashColl                                         
 from VMSS_Client_collateral_NonEquity_NoBrInfo b                                                
 where #p9_File1.party_code=b.party_code and #p9_file1.segment=b.co_code                                                                                 
                                                                
/* Excess Collateral adjustement with Ledger Debit */            
 update #p9_File1 set NonCashColl=NonCashColl+Balance                                                                                                     
 where NonCashColl > 0 and Balance < 0 and segment in ('NSEFO','MCD','NSX')                                                               
                                                                               
 /* GEnerate Summarised Data */                    
                                                           
delete from #p9_file1 where party_code in (select party_code from mis.sccs.dbo.Combine_legal)                                                              
delete from #p9_file1 where party_code in (select party_code from General.dbo.client_Details where (branch_cd='NRIS' or sub_broker='BH'))                          
                        
/*Remove Tday and T+1 day clients ,added by abha as suggested by vishal gohil*/                           
                        
delete from #p9_file1 where party_code in (select Party_Code         
from General.dbo.SQUAREUP_CLIENT_ALERT where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT_ALERT))           
/* -----T day------ */        
        
          
                             
delete from #p9_file1 where party_code in (select party_Code from General.dbo.SQUAREUP_CLIENT         
where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT))            
/*------T+1day --------*/        
        
          
                                                                                     
select                                                                                                                 
max(processDate) as processDate,Entity,Party_code,convert(int,1) as NoofDays,                                                                                                                
sum(Balance) as Balance,sum(MarginAmt) as MarginAmt,sum(Deposit) as Deposit,                                               
sum(CashColl) as CashColl,sum(NonCashColl) as NonCashColl,sum(Holding_total) as Holding_BHC,                                                                                                   
sum(Holding_Approved) as Holding_AHC,sum(OtherDebit) as OtherDebit,                                                
sum(EarlyPayinValue) as EarlyPayinValue,sum(LeverageMultiplier) as LeverageMultiplier,                                                                                               
sum(VarMarginShortFall) as VarMarginShortFall,                                 
Convert(money,0) as NSEFO_JV,                                                                                                                
Convert(money,0) as NSEFO_NonCash,                                                                                                                
Convert(money,0) as MCD_JV,                                                                                               
Convert(money,0) as MCD_NonCash,                                                                                                                
Convert(money,0) as NSX_JV,                                                                                                                
Convert(money,0) as NSX_NonCash,                                                              
Convert(money,0) as VarMarginShortFall_AftAdj,                                                                                               
Convert(money,0) as Stage,                                                                                                                
sum(SquareOffValue) as SquareOffValue,Sum(Case when Segment='BSECM' then BAlance else 0 end) as BSECM_Balance,                                                                                                                 
Sum(Case when Segment='NSECM' then BAlance else 0 end) as NSECM_Balance,                                                         
Convert(money,0) as DP_adj ,                
Convert(money,0) as VarMarginShortFall_AftAdjCurrDay                                                     
into #p9_file2                                                                                                                
from #p9_file1 where segment in ('BSECM','NSECM')                                                                                                                
group by Entity,Party_code                                       
                                                           
/* delete Client with Cash Credit effective Balance */                                                                                                       
                                                              
Delete from #p9_file2 where balance >= @LowerCapAmt                          
Delete from #p9_file2 where party_code in (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF'))                                                                                  
Delete from #p9_file1 where party_Code not in (select party_code from #p9_file2)                                                                              
Delete from #p9_file2 where Holding_BHC <= 0                                                       
                                  
update #p9_File2 set VarMarginShortFall=(case when Holding_AHC+Balance+Deposit+EarlypayinValue < @LowerCapAmt then Holding_AHC+Balance+Deposit+EarlypayinValue  else 0 end)                                                                                   
  
  
    
       
       
        
        
         
                                           
update #p9_File2 set LeverageMultiplier=                                                                                                                
Case when 100-(Holding_AHC/Holding_BHC)*100.00 > 100 then 100 else 100-(Holding_AHC/Holding_BHC)*100.00 end                                                                                                                
where Holding_BHC > 0                                                                                                  
                                                                          
update #p9_file1 set MgnAdjNonCash=0 where MgnAdjNonCash is null                                                                                            
update #p9_file1 set MgnAdjNonLed=0 where MgnAdjNonLed is null                                                    
                        
/* Adj.Margin with Non_Cash Scripwise */                                                                       
                                      
update vmss_NonCash set FinalAmount=Amount-(Amount*(MarginHC/100.00))                                              
update vmss_noncash set MarginSqOffQty=0                                                    
/*---- Full NonCash Getting adjusted against Margin */                                                                              
update vmss_noncash set MarginSqOffQty=Qty from                                                                              
(                                                                              
/*                                                              
select a.*,b.MarginAmt from                                                                              
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                              
(select segment,party_code,MArginAmt from #p9_file1 where MArginAmt > 0) b                        
on a.party_code=b.party_code and a.co_code=b.segment                                                                              
where b.MArginAmt >= a.VAHC                                                               
*/                                    
select a.*,b.MarginAmt from                                                    
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                            
(select segment,party_code,MArginAmt+(Case when balance < 0 then -balance else 0 end) as MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                       
on a.party_code=b.party_code and a.co_code=b.segment                                                                            
where b.MArginAmt >= a.VAHC                                                                
) x where vmss_noncash.party_code=x.party_Code and vmss_noncash.co_code=x.co_Code                                                
                                                                  
/*---- Partial NonCash Getting adjusted against Margin */                                                       
                                          
                                                         
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex from                                                                               
/* (select * from #p9_file1 where marginAmt > 0 ) a  left outer join             */                                                            
(select                       
processDate,Entity,segment,Party_code,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,                                                   
(Case when Balance < 0 then MarginAmt-Balance else MArginAmt end) as MarginAmt,                                                      
Deposit,CashColl,NonCashColl,Holding_total,Holding_Approved,OtherDebit,NonCashConsideration,                                                      
Net,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,SquareOffValue,MgnAdjNonCash,MgnAdjNonLed                                                      
from #p9_file1 where segment in ('NSEFO','MCD','NSX')) a  left outer join                                                     
(select co_code,party_code from vmss_noncash where MarginSqOffQty <> 0 group by party_code,Co_Code) b                                                                              
on a.party_code=b.party_code and a.segment=b.co_Code                                                                              
join (select co_code,party_code from vmss_noncash where MarginSqOffQty = 0 group by party_code,Co_Code) c                                                                              
on a.party_code=c.party_code and a.segment=c.co_Code                                                                              
where b.Party_Code is null                                                                              
                                                    
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                               
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0,@segment as varchar(10) = ''                                                                                
                                                
select @totctr=MAX(srno) from #p9_filex                                                                
                                                                  
While @ctr <= @totctr                                                                                                  
Begin                    
                                                                             
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=MarginAmt,@segment=segment from #p9_filex where srno=@ctr                                                                 
                     
select ROW_NUMBER() OVER (ORDER BY b.seqid,FinalAmount desc) AS [SrNo],                                                           
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,MarginHC as HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,                                                                              
clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty                                                                              
into #p9_holdadj from vmss_noncash a join                                                                                        
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                             
where party_code=@pcode and Clsrate > 0 and MarginHC < 100 and co_Code=@segment                             
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                        
set @TSqOffVal=0                                                                                  
                                                                  
set @Xctr=1                                                                                        
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                           
BEGIN                                                                     
                                                                         
select @TSqOffVal=FinalAmount,@qty=Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                
set @TSqOffVal=@SqOffVal                                                                                             
                                                                  
      
update vmss_noncash                                                                                        
set MarginSqOffQty=ceiling(Case when @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) <= @qty                                             
then @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) else @qty end)                                                                                    
where id=@id  and  MarginHC < 100                                                           
                                                                                  
set @SqOffVal=@SqOffVal-@TSqOffVal                                                                          
set @Xctr=@Xctr+1                                                                                                  
      
END                                                                                                  
                                 
DROP TABLE #p9_holdadj                                                                                                  
                                                                                        
set @ctr=@ctr+1                                
end                                                                                                  
         
drop table #p9_filex                                                                                                  
                                                                  
/* Calculation Margin Adjusted with NonCash */                                                                                                  
                                                                  
/*    
update #p9_file1 set MgnAdjNonCash=(Case when MarginAmt-(NonCashColl+CashColl) < 0 then MarginAmt else (NonCashColl+CashColl) end)                                                                          
where segment in ('NSEFO','MCD','NSX')                                                                                                  
*/                                                                              
                                                                  
update #p9_file1 set MgnAdjNonCash=B.AdjWithMargin from                                                                              
(                               
select co_Code,party_code,sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) as AdjWithMargin from vmss_noncash                                                                               
group by co_Code,party_code                                                                              
having sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) > 0                                            
) b where #p9_file1.party_code=b.party_Code and #p9_file1.segment=b.co_Code                                                        
                                                                                      
/* Calculation Margin Adjusted with Ledger Credit */                                                                                                  
update #p9_file1 set MgnAdjNonLed=(Case                                                 
when Balance > (MarginAmt-MgnAdjNonCash) and MarginAmt-MgnAdjNonCash > 0 and balance > 0 then (MarginAmt-MgnAdjNonCash)                                                                                        
when Balance <= (MarginAmt-MgnAdjNonCash) and balance > 0 then Balance                                                                                                  
else 0 end) where segment in ('NSEFO','MCD','NSX')                                                                   
                                             
                                       
                                                                                   
update  #p9_File2 set NSEFO_JV=b.AdjWithLedgerCr /*,NSEFO_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                                                              
  
  
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                   
from #p9_file1 where segment='NSEFO' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                                                     
                
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr /*,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                      
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                     
from #p9_file1 where segment='NSX' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                   
/*                                                                              
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                                
(              
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                          
from #p9_file1 where segment='NSX'                                                                                                     
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                
*/                                                                               
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                             
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                
from #p9_file1 where segment='MCD' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                    
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                   
/*                                                                                                                 
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                                
(                                                                                                    
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                     
from #p9_file1 where segment='MCD'                                                                                                     
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                           
*/                                                                                                        
                                                                  
UPDATE #p9_File2 SET NSEFO_JV=-vARmARGINsHORTFALL  WHERE NSEFO_JV > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV > 0                                        
UPDATE #p9_File2 SET mcd_jv=-vARmARGINsHORTFALL-NSEFO_jv  WHERE mcd_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv >= 0            
  
   
UPDATE #p9_File2 SET NSX_jv=-VARMARGINSHORTFALL-NSEFO_JV-mcd_jv  WHERE nsx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv >= 0                                                      
                                                                   
UPDATE #p9_File2 SET NSEFO_JV=0 where NSEFO_JV<0                                                                                        
UPDATE #p9_File2 SET mcd_jv=0 where mcd_jv<0                                                                                        
UPDATE #p9_File2 SET NSX_jv=0 where NSX_jv<0                              
                                                                                                    
/* Adjust VarMArgin Shortage with NonCash Collateral */                                                                              
                                      
update vmss_NonCash set FinalAmount=Amount*(Haircut/100.00)                                                   
                                                                  
/*----- NSEFO-----*/                                         
                                                                  
set @totctr  = 0                          
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                        
set @Xctr = 1                                                                              
SET @qty = 0                             
set @TSqOffVal = 0                                                                                  
set @SqQty = 0                                                                    
set @clsrate =0                                                                                  
set @id = 0                                                                               
                                                            
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex1                                                                              
from                                                                        
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv as VarMarginShortFallAftJV from #p9_file2 where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSEFO' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                                                                     
select @totctr=MAX(srno) from #p9_filex1                                                                                                  
                                                                    
While @ctr <= @totctr                                                        
Begin                                                                                                  
                           
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex1 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                             
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                   
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj1                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                               
where party_code=@pcode and Clsrate > 0 and co_code='NSEFO' and haircut < 100                                              
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj1                                                                                                   
set @TSqOffVal=0          
set @Xctr=1                                                             
      
      
                        
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN                                                                      
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj1 where srno=@xctr                                                              
                         
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                                                                  
                                                            
update VMSS_NonCash                                                                           
set                                         
/* SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                        
SqOffseq=@xctr                                                                                     
where id=@id  and  Haircut < 100                                                                                          
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                  
      
set @Xctr=@Xctr+1          
      
                                                                                              
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj1                                                                                        
                                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                    
                                                                                       
update #p9_file2 set NSEFO_noncash=B.AdjustedAmt FROM                                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSEFO' and SquareOffQty > 0                                                                           
group by party_Code      
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                              
                                                                 
/*------ NSX ----*/                                                                
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                        
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                      
set @SqQty = 0                                                                      
set @clsrate =0                                                           
set @id = 0                                                                               
                                                   
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex2                                                                     
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash as VarMarginShortFallAftJV from #p9_file2                     
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSX' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                              
select @totctr=MAX(srno) from #p9_filex2                                                                                                  
                                                                                        
While @ctr <= @totctr                                                                                              
Begin                                                                                                  
                                                                          
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex2 where srno=@ctr                                                                              
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj2                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='NSX'  and haircut < 100                             
                                       
select @Xtotctr=MAX(Srno) from #p9_holdadj2                                                                                                   
set @TSqOffVal=0                                                                                         
                                                                  
set @Xctr=1                                                           
          
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN             
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj2 where srno=@xctr                       
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                               
                                                                  
update VMSS_NonCash                                                                              
/*set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                                        
SqOffseq=@xctr                                                                                  
where id=@id and Haircut < 100      
           
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                                                  
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj2                                                                                                  
                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                                              
drop table #p9_filex2                                                                                
                                                        
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSX' and SquareOffQty > 0                                               
group by party_Code                                                              
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                              
                                                                   
                                                                  
/*------ MCD ----*/                                                                              
                   
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                
set @SqQty = 0                                                                                  
set @clsrate =0                                                                                  
set @id = 0                                
                                        
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex3                                                                              
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash as VarMarginShortFallAftJV from #p9_file2                                                                               
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash < 0) a join                                            
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='MCD' group by party_code) c                                      
on a.party_code=c.party_code                                            
                                                                     
select @totctr=MAX(srno) from #p9_filex3                                                     
                                    
While @ctr <= @totctr                                                                                                  
Begin                          
                                                                
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex3 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj3                                                                  
from VMSS_NonCash_BalAfterMargin a join              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='MCD' and haircut < 100                                                                                                
                                         
select @Xtotctr=MAX(Srno) from #p9_holdadj3                               
set @TSqOffVal=0                                                                                                  
                                                                  
set @Xctr=1                                                 
                                                                     
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                               
BEGIN                                                                                                  
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj3 where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal               
                                                                  
update VMSS_NonCash                                                                                        
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),             
SqOffseq=@xctr                                                                                     
where id=@id and Haircut < 100                                                                                          
          
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                         
END                                                        
                                                                                        
DROP TABLE #p9_holdadj3                                                                                                  
                         
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                     
drop table #p9_filex3                                                                                
                                                                  
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                                 (                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                              
from VMSS_NonCash_BalAfterMargin where co_Code='MCD' and SquareOffQty > 0                                                                           
group by party_Code                                                            
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE      
                                                                  
/*----*/                                                                              
UPDATE #p9_File2 SET NSEFO_NONCASH=0,MCD_NONCASH=0,NSX_NONCASH=0                                                                                                                 
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL = 0 AND vARmARGINsHORTFALL < 0                                                                                    
                                                                  
/*                                                                               
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)                                                                          
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                                                 
AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                                                     
                                                                                                 
UPDATE #p9_FILE2 SET MCD_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET MCD_NONCASH=Stage                                                                                                                
UPDATE #p9_FILE2 SET Stage=0                                                             
                                             
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)                                                                                                                
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                                                                                                                
AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)*-1                                                       
                                                                                                     
UPDATE #p9_FILE2 SET NSX_NONCASH=0                                                       
UPDATE #p9_FILE2 SET NSX_NONCASH=Stage                                                                                                             
UPDATE #p9_FILE2 SET Stage=0                                                                                     
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)                                                                                                               
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                                                                                                               
AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)*-1                                                                                                                
                                                                             
UPDATE #p9_FILE2 SET NSEFO_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET NSEFO_NONCASH=Stage                                                          
UPDATE #p9_FILE2 SET Stage=0                                                                                                                
*/                                                                              
                                  
update #p9_File2  set VarMarginShortFall_AftAdjCurrDay=vARmARGINsHORTFALL+NSefo_jv+MCD_JV+NSX_JV+NSEFO_NONCASH+MCD_NONCASH+NSX_NONCASH                                                                                         
where  vARmARGINsHORTFALL < 0                                                                                                                 
        
update #p9_File2  set VarMarginShortFall_AftAdj=VarMarginShortFall_AftAdjCurrDay        
        
/*        
--- Used to compute min of last 4 days for squareoff.. not required as per PRMS id: 10391261 dt...14/08/2015...        
update #p9_File2 set VarMarginShortFall_AftAdj=(Case when #p9_File2.VarMarginShortFall_AftAdjCurrDay > q.VarMarginShortFall_AftAdjCurrDay                   
then #p9_File2.VarMarginShortFall_AftAdjCurrDay else q.VarMarginShortFall_AftAdjCurrDay end)                  
from                  
(                  
select Party_code,MAX(VarMarginShortFall_AftAdjCurrDay) as VarMarginShortFall_AftAdjCurrDay                   
from vmss_Data x join                  
(select top 3 processdate from (select distinct processdate from vmss_Data where processdate < @BSElastBillDate) a order by processdate) y                   
on x.processdate=y.processdate                               
group by party_code                  
) q where #p9_File2.party_code=q.party_code                  
*/          
                                      
/* Var Margin % */                                                                                  
                                                                                     
truncate table vmss_holding                                                                        
insert into vmss_holding                                                                                                      
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate)                                                
          
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,                                                                                                      
SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS [SrNo],0,ISIN,ActualSqOffQty=CONVERT(int,0),0.00 from #p9_hold                                                                                                      
                                                                        
/*                                                                                                    
select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #p9_filex                                                                                                       
from #p9_file2 where VarMarginShortFall_AftAdj < 0                
                                                                                
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                                                                      
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                                                                      
                                                                 
select @totctr=MAX(srno) from #p9_filex                                                                                                      
                                                                                           
While @ctr <= @totctr                                                                                                      
Begin                                                                                               
                                                                   
set @SqOffVal=0                                                              
select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdj*-1 from #p9_filex where srno=@ctr                                                                                                                      
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],* into #p9_holdadj from vmss_holding a join                                                                                                      
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                             
where party_code=@pcode and Clsrate > 0                                                                                    
                                                                                
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                                                     
set @TSqOffVal=0                                                                                                      
                                                                
set @Xctr=1                                                                                          
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                     
BEGIN                                                                                          
                                                                              
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                             
                                                  
if (@SqOffVal<@TSqOffVal)                                                              
set @TSqOffVal=@SqOffVal                                                                                                      
                                                              
update vmss_holding                                                                               
set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                                                       
SqOffseq=@xctr                                                                                         
where id=@id                                                                                
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                      
                      
set @Xctr=@Xctr+1                                                                                                      
END                                                                                                      
                                                                                           
DROP TABLE #p9_holdadj                                            
                                                                                           
set @ctr=@ctr+1                                            
end                                                                                                      
                                                                                          
drop table #p9_filex                                                                                                      
                                                                
truncate table vmss_holding_hist                                                                                                       
insert into vmss_holding(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq)                                                         
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq from vmss_holding                                                                                   
  
  
    
      
        
        
        
         
                                                                                        
update #p9_file2 set SquareOffValue=b.SqVal from                                                              
(                                                                                            
select party_code,sum(SquareOffQty*Clsrate) as SqVal from vmss_holding where isnull(SquareOffQty,0) > 0                                                                                       
group by party_code                                                                                            
) b                
where #p9_file2.party_code=b.party_Code                                                                                                      
*/                                                                                    
                                                                                        
/*                                                                                                            
update #p9_File2 set SquareOffValue=                                                                                                                
Case when (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 < (Holding_BHC)*-1 then (Holding_BHC)*-1                                                                                                                
else (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 end                                      
where LeverageMultiplier > 0                                                                                                                
*/                                                                                                      
                                                                               
/*                                                                              
UPDATE #p9_File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                             
(                                                                                  
SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                                                                           
(                                                                                     
SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                             
WHERE CONVERT(DATE,processdate) < (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data )                                                    
)                                                                                                                                          
) B WHERE #p9_File2.party_code=B.party_code                                                                                                        
                                                                                   
UPDATE #p9_File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                                            
              
*/                                                                                       

/*  
delete a from #p9_FILE2 a left outer join VMSS_ASB7_Days b on a.party_code=b.Party_code   
WHERE b.Party_code is null  
*/
  
delete from VMSS_data where processDate=@BSElastBillDate                                                                                                                
                                                                                           
insert into VMSS_data(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,                                                                                                      
Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,                                                                                                         
NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,remarks,DP_adj,Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                                                                           
   
SELECT processDate,Entity,A.Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,                                                                                                                
OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,                                                  
VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,GETDATE(),'V','',DP_adj,0.00,VarMarginShortFall_AftAdjCurrDay                                                                                                            
FROM #p9_FILE2 A inner join mis.dbo.asb7_clidetails_crdet  B on A.Party_code=B.party_code where B.SQ_AMT> 0                                                                                                                
and B.T_day>0 and  rms_date=(select max(rms_date)from  mis.dbo.asb7_clidetails_crdet)                                                                   

/*                                                                                
insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                        
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks)                                                                                   
  
  
select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                                            
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks from VMSS_data                                                                     
  
  
*/                                                                  
                                                                        
End try                                                                                                                                     
BEGIN CATCH                                                                                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                              
  select GETDATE(),'VMSS_Calculation_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                                                                                   
                          
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                              
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                                                     
                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Calculation_NoNRMS_26092015
-- --------------------------------------------------
   
CREATE Procedure [dbo].[VMSS_Calculation_NoNRMS_26092015]                                                                                                    
as                                                                                                              
                                                                                                              
SET XACT_ABORT ON                                                                                                              
Set nocount on                                                                                                              
BEGIN TRY                                                                                                                                      
                                                                            
 Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                                                              
 Declare @LowerCapNonCash as money = 500  /* NONCASH COLLATERAL MOVEMENT : always +ve */                                                                                                              
 Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                              
                                                                                                        
 select                                                                                                               
 @BSElastBillDate  as processDate,                                                                                                              
 b.Entity,                                                                                                              
 b.segment,                                                                                                              
 a.Party_code,                                                                                                              
 a.Ledger as Balance,                                                                                                              
 CONVERT(money,0)  as UnsettledCr,                                                                                                              
 CONVERT(money,0) as UnsettledDr,                                                                                                              
 a.Unrecosiled_Credit as UnrecoAmt,                                                                                                              
 CONVERT(money,0) as ShortSellValue,                                                                                                              
 a.Imargin as MarginAmt,                                                                                                              
 a.Deposit,                                                                                                              
a.Cash_Colleteral as CashColl,                                                                                                              
a.NonCash_Colleteral as NonCashColl,                                                                                                              
Holding_total,                                                                                                              
Holding_Approved,                                                                                                              
CONVERT(money,0) as OtherDebit,                                                    
CONVERT(int,0) as NonCashConsideration,                                                                                                  
CONVERT(money,0) as Net,                         
CONVERT(money,0) as EarlyPayinValue,                  
CONVERT(money,0) as LeverageMultiplier,                          
CONVERT(money,0) as VarMarginShortFall,                                                              
CONVERT(money,0) as SquareOffValue,                                  
CONVERT(money,0) as MgnAdjNonCash,                                                     
CONVERT(money,0) as MgnAdjNonLed                                                                
into #p9_File1                                                   
from (select * from General.dbo.RMS_DtClFi with (nolock) where 1=2) a join (select segment,entity from intranet.cms.dbo.ncms_entity with (nolock) where entity='Equity') b                                                                    
on a.Co_code=b.segment                                                                     
                                                                                                     
                                                                                                     
 /* update Holding */                                                                                                    
                                                              
select EXCHANGE,sett_no,SEtt_type,                                                                                                              
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY1 ELSE SCRIP_CD END) AS scrip_cd,                                                                                                              
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,Party_code,Qty,                                                                          
CLSRATE,                                                                                                              
Total AS VBHC,                                                                            
CONVERT(MONEY,0) AS HAIRCUT,                                                                                                              
CONVERT(MONEY,0) AS VAHC,                                                                                                  
SPACE(10) AS CATEGORY,                                                                                                              
source AS SRC,                                                                      
ISIN                                                                      
INTO #p9_HOLD                                                                                                              
from vmss_rms_holding where source in ('SI','SO','H','D')                  
  
                
SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0   
SELECT  party_code,isin,SUM(qty) as NQty,scrip_cd into #nqty_negative from #p9_hold  where qty<0 group by party_code,isin ,scrip_cd /*added as required by vishal gohil on 24-09-2015 to handle netoff>0 */        
DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin   
DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty_negative T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin and t1.qty=t2.NQty  /*added as required by vishal gohil on 24-09-2015 to handle netoff>0 */          
update #p9_hold set qty=A.qty+b.Nqty  from #p9_hold A inner join #nqty_negative B on A.isin=B.isin and A.scrip_cd=b.scrip_cd  /*added as required by vishal gohil on 24-09-2015 to handle netoff>0 */        
       
DROP TABLE #nqty    
DROP TABLE #nqty_negative       
                                                                                                     
update #p9_HOLD set clsrate=b.rate from General.dbo.cp_bsecm b where #p9_HOLD.scrip_Cd=b.scode and #p9_HOLD.clsrate=0                                                                                                              
                  
update #p9_HOLD set clsrate=b.cls                                                                                                               
from General.dbo.cp_nsecm b                                                                                                     
where #p9_HOLD.scrip_Cd=b.scrip and #p9_HOLD.series=b.series and #p9_HOLD.clsrate=0 and exchange='NSECM'                                                                                                            
                  
update #p9_HOLD set VBHC=clsrate*Qty                                                                                                              
                  
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                  
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                             
      
        
where #p9_HOLD.SCRIP_cD=B.BSECODE AND #p9_HOLD.EXCHANGE='BSECM'                                                                                                              
                  
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                    
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                
where #p9_HOLD.SCRIP_cD=B.NSESYMBOL AND #p9_HOLD.SERIES=B.NSESERIES AND #p9_HOLD.EXCHANGE='NSECM'                                                            
                  
update #p9_HOLD set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                              
                  
update #p9_HOLD set VAHC=VBHC*((100-HAIRCUT)/100.00)                                                
                  
insert into #p9_File1(segment,party_code)                                                            
select b.co_code,party_Code from                                                                                                    
(select party_code from #p9_hold group by party_code) a,                                                                                                     
(select * from General.dbo.company where entitytype='EQ' and bo_active=1) b                                                                                                    
                                                                                                    
update #p9_file1                                                               
set entity='EQUITY',ProcessDate=@BSElastBillDate,Balance=0,UnsettledCr=0,UnsettledDr=0,UnrecoAmt=0,ShortSellValue=0,                                                                                     
MarginAmt=0,Deposit=0,CashColl=0,NonCashColl=0,Holding_total=0,Holding_Approved=0,OtherDebit=0,NonCashConsideration=0,Net=0,                                                                                                    
EarlyPayinValue=0,LeverageMultiplier=0,VarMarginShortFall=0,SquareOffValue=0                                                                                                    
                                                                                     
update #p9_File1 set holding_total=b.VBHC,holding_approved=b.VAHC from                                                               
(select party_code,exchange,VBHC=sum(VBHC),VAHC=sum(VAHC)                                                                                                              
from #p9_hold group by party_code,exchange) b                                                                     
where #p9_File1.party_code=b.party_code and #p9_File1.segment=b.exchange                                                                
                                                                                                    
/* Get Last settlement Date */                                                                                                   
                                                                                    
 Declare @sdtcur as datetime,-- @ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59'                                                                                                      
 @ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'                                
 select @sdtcur=sdtcur from General.dbo.parameter with (nolock) where sdtcur <= @ToDate and ldtcur >=@ToDate                                         
                                     
/* Fetch effective Ledger Balance - Only Bill's effective date else voucher date*/                               
              
 select CLTCODE,                                                                                                              
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                        
 into #p9_BSECM                                                                                                              
 from anand.account_ab.dbo.ledger a with (nolock)                                                                                     
 where vDT>=@sdtcur and vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                         
 group by cltcode                                   
                                                                                 
 select CLTCODE,                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                         
 into #p9_NSECM                                                                                                              
from anand1.account.dbo.ledger a with (nolock)                                                                                                                     
 where vDT>=@sdtcur and  vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                                                     
 group by cltcode                                                                                                                  
                                               
 select CLTCODE,                                                                                                              
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                               
 into #p9_NSEFO                                                                                                              
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                                                     
 /* where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end) */                                                                                                           
  
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate           
 group by cltcode                                                                                                                  
                                                               
 select CLTCODE,                                                                                                              
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                    
 into #p9_NSX                                                                                               
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                                                     
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate           
 group by cltcode                                                                                                                  
                                                             
select CLTCODE,                                              
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                        
into #p9_MCD                                                                                                  
from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)        
where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate           
group by cltcode                                                                                                                  
                                                                                                
 /* Fetch Deposit */                                                                          
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                               
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                  
 into #p9_dep_BSECM                                                                                                              
 from anand.account_ab.dbo.ledger a with (nolock)                                                                      
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                    
 group by cltcode                                            
                                  
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                    
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                              
 into #p9_dep_NSECM from anand1.account.dbo.ledger a with (nolock)                                                         
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                    
 group by cltcode                                                                    
                                                                                                              
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                     
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                              
 into #p9_dep_NSEFO                                                                                                              
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                   
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '40%'                                                                                                                    
 group by cltcode                                                                                     
                                                                                                                
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                            
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                              
 into #p9_dep_NSX                                                                                                              
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                 
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                            
 group by cltcode                                     
                                                                                                          
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                 
 into #p9_dep_MCD                      
 from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                                 
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                    
 group by cltcode                                                                                              
                                                                       
 update #p9_File1 set Balance=b.Vbal from #p9_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                                                              
 update #p9_File1 set Balance=b.Vbal from #p9_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                              
 update #p9_File1 set Balance=b.Vbal from #p9_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                                              
 update #p9_File1 set Balance=b.Vbal from #p9_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                                                    
 update #p9_File1 set Balance=b.Vbal from #p9_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                          
                                                                                                              
 update #p9_File1 set deposit=b.Vbal from #p9_dep_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                         
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                                                              
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                        
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                         
 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                                                                        
                                                                                                    
 update #p9_File1 set Earlypayinvalue=b.EPV from                                                                                                         
 (select Exchange,party_code,SUM(total) as EPV from VMSS_EarlyPayinData group by Exchange,party_code) b                                                                                                        
 where #p9_File1.party_code=b.party_Code and #p9_File1.segment=b.exchange                                                                                                    
                                                                                                               
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                           
 (         
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                    
 from angelfo.nsefo.dbo.tbl_clientmargin with (nolock)                                                      
 where MarginDate = (select MAX(margindate) from angelfo.nsefo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                 
  ) b                                                                  
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSEFO'                                                                                                    
                                                                                                    
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                          
 (                                                                                                    
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                    
 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                                 
 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                       
  ) b                                                                                                     
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCD'                                                                                         
                                                                                      
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                    
 (                                                                           
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                    
 from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock)                                                                                                    
 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                        
) b                                                                                  
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSX'                                                                                                    
                                                                            
 update #p9_File1 set NonCashColl=b.NonCashColl                                       
 from VMSS_Client_collateral_NonEquity_NoBrInfo b                                                                                                    
 where #p9_File1.party_code=b.party_code and #p9_file1.segment=b.co_code                  
                                                              
/* Excess Collateral adjustement with Ledger Debit */                                                              
 update #p9_File1 set NonCashColl=NonCashColl+Balance                                                                                                   
 where NonCashColl > 0 and Balance < 0 and segment in ('NSEFO','MCD','NSX')                                                             
                                                                             
 /* GEnerate Summarised Data */                  
                                                         
delete from #p9_file1 where party_code in (select party_code from mis.sccs.dbo.Combine_legal)                                                            
delete from #p9_file1 where party_code in (select party_code from General.dbo.client_Details where (branch_cd='NRIS' or sub_broker='BH'))                        
                      
/*Remove Tday and T+1 day clients ,added by abha as suggested by vishal gohil*/                         
                      
delete from #p9_file1 where party_code in (select Party_Code       
from General.dbo.SQUAREUP_CLIENT_ALERT where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT_ALERT))         
/* -----T day------ */      
      
        
                           
delete from #p9_file1 where party_code in (select party_Code from General.dbo.SQUAREUP_CLIENT       
where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT))          
/*------T+1day --------*/      
      
        
                                                                                   
select                                                                                                               
max(processDate) as processDate,Entity,Party_code,convert(int,1) as NoofDays,                                                                                                              
sum(Balance) as Balance,sum(MarginAmt) as MarginAmt,sum(Deposit) as Deposit,                                             
sum(CashColl) as CashColl,sum(NonCashColl) as NonCashColl,sum(Holding_total) as Holding_BHC,                                                                                                 
sum(Holding_Approved) as Holding_AHC,sum(OtherDebit) as OtherDebit,                                              
sum(EarlyPayinValue) as EarlyPayinValue,sum(LeverageMultiplier) as LeverageMultiplier,                                                                                             
sum(VarMarginShortFall) as VarMarginShortFall,                               
Convert(money,0) as NSEFO_JV,                                                                                                              
Convert(money,0) as NSEFO_NonCash,                                                                                                              
Convert(money,0) as MCD_JV,                                                                                             
Convert(money,0) as MCD_NonCash,                                                                                                              
Convert(money,0) as NSX_JV,                                                                                                              
Convert(money,0) as NSX_NonCash,                                                            
Convert(money,0) as VarMarginShortFall_AftAdj,                                                                                             
Convert(money,0) as Stage,                                                                                                              
sum(SquareOffValue) as SquareOffValue,Sum(Case when Segment='BSECM' then BAlance else 0 end) as BSECM_Balance,                                                                                                               
Sum(Case when Segment='NSECM' then BAlance else 0 end) as NSECM_Balance,                                                       
Convert(money,0) as DP_adj ,              
Convert(money,0) as VarMarginShortFall_AftAdjCurrDay                                                                                
into #p9_file2                                                                                                              
from #p9_file1 where segment in ('BSECM','NSECM')                                                                                                              
group by Entity,Party_code                                     
                                                         
/* delete Client with Cash Credit effective Balance */                                                                                                     
                                                            
Delete from #p9_file2 where balance >= @LowerCapAmt                        
Delete from #p9_file2 where party_code in (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF'))                                                                                
Delete from #p9_file1 where party_Code not in (select party_code from #p9_file2)                                                                            
Delete from #p9_file2 where Holding_BHC <= 0                                                     
                                
update #p9_File2 set VarMarginShortFall=(case when Holding_AHC+Balance+Deposit+EarlypayinValue < @LowerCapAmt then Holding_AHC+Balance+Deposit+EarlypayinValue  else 0 end)                                                                                   
  
     
     
      
      
       
                                         
update #p9_File2 set LeverageMultiplier=                                                                                                              
Case when 100-(Holding_AHC/Holding_BHC)*100.00 > 100 then 100 else 100-(Holding_AHC/Holding_BHC)*100.00 end                                                                                                              
where Holding_BHC > 0                                                                                                
                                                                        
update #p9_file1 set MgnAdjNonCash=0 where MgnAdjNonCash is null                                                                                          
update #p9_file1 set MgnAdjNonLed=0 where MgnAdjNonLed is null                                                  
                      
/* Adj.Margin with Non_Cash Scripwise */                                                                     
                                    
update vmss_NonCash set FinalAmount=Amount-(Amount*(MarginHC/100.00))                                            
update vmss_noncash set MarginSqOffQty=0                                                  
/*---- Full NonCash Getting adjusted against Margin */                                                                            
update vmss_noncash set MarginSqOffQty=Qty from                                                                            
(                                                                            
/*                                                            
select a.*,b.MarginAmt from                                                                            
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                            
(select segment,party_code,MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                            
on a.party_code=b.party_code and a.co_code=b.segment                                                                            
where b.MArginAmt >= a.VAHC                                                             
*/              
select a.*,b.MarginAmt from                                                                          
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                          
(select segment,party_code,MArginAmt+(Case when balance < 0 then -balance else 0 end) as MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                     
on a.party_code=b.party_code and a.co_code=b.segment                                                                          
where b.MArginAmt >= a.VAHC                                                              
) x where vmss_noncash.party_code=x.party_Code and vmss_noncash.co_code=x.co_Code                                              
                                                                
/*---- Partial NonCash Getting adjusted against Margin */                                                     
                                        
                                                       
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex from                                                                             
/* (select * from #p9_file1 where marginAmt > 0 ) a  left outer join             */                                                          
(select                     
processDate,Entity,segment,Party_code,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,                                                 
(Case when Balance < 0 then MarginAmt-Balance else MArginAmt end) as MarginAmt,                                                    
Deposit,CashColl,NonCashColl,Holding_total,Holding_Approved,OtherDebit,NonCashConsideration,                                                    
Net,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,SquareOffValue,MgnAdjNonCash,MgnAdjNonLed                                                    
from #p9_file1 where segment in ('NSEFO','MCD','NSX')) a  left outer join                                                   
(select co_code,party_code from vmss_noncash where MarginSqOffQty <> 0 group by party_code,Co_Code) b                                                                            
on a.party_code=b.party_code and a.segment=b.co_Code                                                                            
join (select co_code,party_code from vmss_noncash where MarginSqOffQty = 0 group by party_code,Co_Code) c                                                                            
on a.party_code=c.party_code and a.segment=c.co_Code                                                                            
where b.Party_Code is null                                                                            
                                                  
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                             
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0,@segment as varchar(10) = ''                                                                              
                                              
select @totctr=MAX(srno) from #p9_filex                                                              
                                                                
While @ctr <= @totctr                                                                                                
Begin                                                                                                
                                                                           
set @SqOffVal=0                                                                                                
select @pcode=party_Code,@SqOffVal=MarginAmt,@segment=segment from #p9_filex where srno=@ctr                               
                                                                
select ROW_NUMBER() OVER (ORDER BY b.seqid,FinalAmount desc) AS [SrNo],                                                                            
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,MarginHC as HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,                                                                            
clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty                                                                            
into #p9_holdadj from vmss_noncash a join                                                                                      
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                           
where party_code=@pcode and Clsrate > 0 and MarginHC < 100 and co_Code=@segment                           
                                                                
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                      
set @TSqOffVal=0                                                                                
                                                                
set @Xctr=1                                                                                      
                                                                                
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                         
BEGIN                                                                   
                                                                       
select @TSqOffVal=FinalAmount,@qty=Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                       
                                                                        
if (@SqOffVal<@TSqOffVal)                                                                                              
set @TSqOffVal=@SqOffVal                                                                                           
                                                                
    
update vmss_noncash                                                                                      
set MarginSqOffQty=ceiling(Case when @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) <= @qty                                           
then @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) else @qty end)                                                                                  
where id=@id  and  MarginHC < 100                                                         
                                                                                
set @SqOffVal=@SqOffVal-@TSqOffVal                                                                        
set @Xctr=@Xctr+1                                                                                                
    
END                                                                                                
                               
DROP TABLE #p9_holdadj                                                                                                
                                                                                      
set @ctr=@ctr+1                              
end                                                                                                
                                                                            
drop table #p9_filex                                                                                                
                                                                
/* Calculation Margin Adjusted with NonCash */                                                                                                
    
/*                                                                            
update #p9_file1 set MgnAdjNonCash=(Case when MarginAmt-(NonCashColl+CashColl) < 0 then MarginAmt else (NonCashColl+CashColl) end)                                                                        
where segment in ('NSEFO','MCD','NSX')                                                                                                
*/                                                                            
                                                                
update #p9_file1 set MgnAdjNonCash=B.AdjWithMargin from                                                                            
(                             
select co_Code,party_code,sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) as AdjWithMargin from vmss_noncash                                                                             
group by co_Code,party_code                                                                            
having sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) > 0                                          
) b where #p9_file1.party_code=b.party_Code and #p9_file1.segment=b.co_Code                                                      
                                                                                    
/* Calculation Margin Adjusted with Ledger Credit */                                                                                                
update #p9_file1 set MgnAdjNonLed=(Case                                               
when Balance > (MarginAmt-MgnAdjNonCash) and MarginAmt-MgnAdjNonCash > 0 and balance > 0 then (MarginAmt-MgnAdjNonCash)                                                                                      
when Balance <= (MarginAmt-MgnAdjNonCash) and balance > 0 then Balance                                                                                                
else 0 end) where segment in ('NSEFO','MCD','NSX')                                                                 
                                           
                                     
                                                                                 
update  #p9_File2 set NSEFO_JV=b.AdjWithLedgerCr /*,NSEFO_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                                                              
(                                                                                                              
select party_code,                                                                            
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                            
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                 
from #p9_file1 where segment='NSEFO' and                                                                   
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                            
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                               
                                                                                                   
                                                                 
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr /*,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                    
(                                                                                                              
select party_code,                                                                            
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                            
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                    
from #p9_file1 where segment='NSX' and                                                                   
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                            
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                               
                                                                 
/*                                                                            
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                              
(            
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                        
from #p9_file1 where segment='NSX'                                                                                                   
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                              
*/                                                                             
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                           
(                                                                                                              
select party_code,                                                                            
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                            
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                              
from #p9_file1 where segment='MCD' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                  
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                               
                                                                 
/*                                                                                                               
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                              
(                                                                                                  
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                   
from #p9_file1 where segment='MCD'                                                                                                   
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                               
*/                                                                                                      
                                                                
UPDATE #p9_File2 SET NSEFO_JV=-vARmARGINsHORTFALL  WHERE NSEFO_JV > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV > 0                                      
UPDATE #p9_File2 SET mcd_jv=-vARmARGINsHORTFALL-NSEFO_jv  WHERE mcd_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv >= 0                                                                                                             
 
UPDATE #p9_File2 SET NSX_jv=-VARMARGINSHORTFALL-NSEFO_JV-mcd_jv  WHERE nsx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv >= 0                                                    
                                                                 
UPDATE #p9_File2 SET NSEFO_JV=0 where NSEFO_JV<0                                                                                      
UPDATE #p9_File2 SET mcd_jv=0 where mcd_jv<0                                                                                      
UPDATE #p9_File2 SET NSX_jv=0 where NSX_jv<0                            
                                                                                                  
/* Adjust VarMArgin Shortage with NonCash Collateral */                                                                            
                                    
update vmss_NonCash set FinalAmount=Amount*(Haircut/100.00)                                                 
                                                                
/*----- NSEFO-----*/                                       
                                                                
set @totctr  = 0                        
set @ctr = 1                                                                                
set @SqOffVal = 0                                                                                
set @pcode =''                                                                                
set @Xtotctr = 0                      
set @Xctr = 1                                                                            
SET @qty = 0                           
set @TSqOffVal = 0                                                                                
set @SqQty = 0                                                                  
set @clsrate =0                                                                                
set @id = 0                                                                             
                                                          
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex1                                                                            
from                                                                      
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv as VarMarginShortFallAftJV from #p9_file2 where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv < 0) a join                                                                            
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSEFO' group by party_code) c                                                                            
on a.party_code=c.party_code                                                                            
                                                                   
select @totctr=MAX(srno) from #p9_filex1                                                                                                
                                                                  
While @ctr <= @totctr                                                      
Begin                                                                                                
                         
set @SqOffVal=0                                                                                                
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex1 where srno=@ctr                                                                                         
                                                                
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                            
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                            
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                 
A_Qty,VBHC,VAHC                                                                            
into #p9_holdadj1                                                                             
from VMSS_NonCash_BalAfterMargin a join                                                                                                
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                             
where party_code=@pcode and Clsrate > 0 and co_code='NSEFO' and haircut < 100                                            
                                                                
select @Xtotctr=MAX(Srno) from #p9_holdadj1                                                                                                 
set @TSqOffVal=0        
set @Xctr=1                                                           
    
    
                      
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                               
BEGIN                                                                    
                                                                       
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj1 where srno=@xctr                                                            
                       
if (@SqOffVal<@TSqOffVal)                                                                                                
set @TSqOffVal=@SqOffVal                                                                                                
                                                          
update VMSS_NonCash                                                                         
set                                       
/* SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                      
SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                      
SqOffseq=@xctr                                                                                   
where id=@id  and  Haircut < 100                                                                                        
                                                                                
set @SqOffVal=@TSqOffVal                                                                                                
    
set @Xctr=@Xctr+1        
    
                                                                                            
END                                                                                                
                                                                                      
DROP TABLE #p9_holdadj1                                                                                      
                                                                                      
set @ctr=@ctr+1                                                                                                
end                                                  
                                                                                     
update #p9_file2 set NSEFO_noncash=B.AdjustedAmt FROM                                                                            
(                                                                            
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                             
from VMSS_NonCash_BalAfterMargin where co_Code='NSEFO' and SquareOffQty > 0                                                                         
group by party_Code                                                            
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                            
                                                               
/*------ NSX ----*/                                                              
set @totctr  = 0                                                                                
set @ctr = 1                                                                                
set @SqOffVal = 0                                                                                
set @pcode =''                                                      
set @Xtotctr = 0                                                                                
set @Xctr = 1                                                  
SET @qty = 0                                                                            
set @TSqOffVal = 0                                                    
set @SqQty = 0                                                                    
set @clsrate =0                                                         
set @id = 0                                                                             
                                                 
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex2                                                                   
from                                                                            
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash as VarMarginShortFallAftJV from #p9_file2                   
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash < 0) a join                                                                            
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSX' group by party_code) c                                                                            
on a.party_code=c.party_code                                                                            
                            
select @totctr=MAX(srno) from #p9_filex2                                                                                                
                                                                                      
While @ctr <= @totctr                                                                                            
Begin                                                                                                
                                                                        
set @SqOffVal=0                                                                                                
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex2 where srno=@ctr                                                                            
                                                                
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                            
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                            
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                            
A_Qty,VBHC,VAHC                                                                            
into #p9_holdadj2                                                                             
from VMSS_NonCash_BalAfterMargin a join                                                                                                
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                           
where party_code=@pcode and Clsrate > 0 and co_code='NSX'  and haircut < 100                                                                                             
                                     
select @Xtotctr=MAX(Srno) from #p9_holdadj2                                                                                                 
set @TSqOffVal=0                                                                                       
                                                                
set @Xctr=1                                                         
        
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                               
BEGIN           
                                                                       
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj2 where srno=@xctr                     
                                                                        
if (@SqOffVal<@TSqOffVal)                                                                                                
set @TSqOffVal=@SqOffVal                                                             
                                                                
update VMSS_NonCash                                                                            
/*set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                      
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                                      
SqOffseq=@xctr                                                                                
where id=@id and Haircut < 100    
         
set @SqOffVal=@TSqOffVal                                                                                                
                                                                              
set @Xctr=@Xctr+1                                                                                                
END                                                                                                
                                                                                      
DROP TABLE #p9_holdadj2                                                                                                
                                                                      
set @ctr=@ctr+1                                                                                                
end                                                                                                
                                                                            
drop table #p9_filex2                                                                              
                                                      
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                            
(                                                                            
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                             
from VMSS_NonCash_BalAfterMargin where co_Code='NSX' and SquareOffQty > 0                                             
group by party_Code                                                            
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                            
                                                                 
                                                                
/*------ MCD ----*/                                                                            
                                                                
set @totctr  = 0                                                                                
set @ctr = 1                                                                                
set @SqOffVal = 0                                                                
set @pcode =''                                                                                
set @Xtotctr = 0                                                                                
set @Xctr = 1                                                                                  
SET @qty = 0                                                                            
set @TSqOffVal = 0                                              
set @SqQty = 0                                                                                
set @clsrate =0                                                                                
set @id = 0                              
                                      
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex3                                                                            
from                                                                            
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash as VarMarginShortFallAftJV from #p9_file2                                                                             
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash < 0) a join                                          
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='MCD' group by party_code) c                                    
on a.party_code=c.party_code                                          
                                                                   
select @totctr=MAX(srno) from #p9_filex3                                                   
                                  
While @ctr <= @totctr                                                                                                
Begin                        
                                                              
set @SqOffVal=0                                                                                                
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex3 where srno=@ctr                                                                                         
                                                                
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                            
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                            
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                            
A_Qty,VBHC,VAHC                                                                            
into #p9_holdadj3                                                                
from VMSS_NonCash_BalAfterMargin a join                                                                                                
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                                
where party_code=@pcode and Clsrate > 0 and co_code='MCD' and haircut < 100                                                                                              
                                       
select @Xtotctr=MAX(Srno) from #p9_holdadj3                             
set @TSqOffVal=0                                                                                                
                                                                
set @Xctr=1                          
                                                                   
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                               
BEGIN                                                                                                
                                                                       
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj3 where srno=@xctr                                                                                       
                                                                        
if (@SqOffVal<@TSqOffVal)                                                                                                
set @TSqOffVal=@SqOffVal             
                                                                
update VMSS_NonCash                                                                                      
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                      
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),           
SqOffseq=@xctr                                                                                   
where id=@id and Haircut < 100                                                                                        
        
set @SqOffVal=@TSqOffVal                                                                                                
                                                                              
set @Xctr=@Xctr+1                                                                       
END                                                      
                                                                                      
DROP TABLE #p9_holdadj3                                                                                                
                       
set @ctr=@ctr+1                                                                                                
end                                                                                                
                                                   
drop table #p9_filex3                                                                              
                                                                
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                                 (                                                                            
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                            
from VMSS_NonCash_BalAfterMargin where co_Code='MCD' and SquareOffQty > 0                                                                         
group by party_Code                                                          
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                            
                                                                
/*----*/                                                                            
UPDATE #p9_File2 SET NSEFO_NONCASH=0,MCD_NONCASH=0,NSX_NONCASH=0                                                                                                               
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL = 0 AND vARmARGINsHORTFALL < 0                                                                                  
                                                                
/*                                                                             
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)         
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                                                                                                              
AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                                                   
                                                                                               
UPDATE #p9_FILE2 SET MCD_NONCASH=0                                                                                                              
UPDATE #p9_FILE2 SET MCD_NONCASH=Stage                                                                                                              
UPDATE #p9_FILE2 SET Stage=0                                                           
                                           
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)                                                                                                              
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                                                                                                              
AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)*-1                                                     
                                                                                                   
UPDATE #p9_FILE2 SET NSX_NONCASH=0                                                     
UPDATE #p9_FILE2 SET NSX_NONCASH=Stage                                                                                                           
UPDATE #p9_FILE2 SET Stage=0                                                                                   
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)                                                                                                             
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                                                                                                             
AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)*-1                                                                                                              
                                                                           
UPDATE #p9_FILE2 SET NSEFO_NONCASH=0                                                                                                              
UPDATE #p9_FILE2 SET NSEFO_NONCASH=Stage                                                        
UPDATE #p9_FILE2 SET Stage=0                                                                                                              
*/                                                                            
                                
update #p9_File2  set VarMarginShortFall_AftAdjCurrDay=vARmARGINsHORTFALL+NSefo_jv+MCD_JV+NSX_JV+NSEFO_NONCASH+MCD_NONCASH+NSX_NONCASH                                                                                                              
where  vARmARGINsHORTFALL < 0                                                                                                               
      
update #p9_File2  set VarMarginShortFall_AftAdj=VarMarginShortFall_AftAdjCurrDay      
      
/*      
--- Used to compute min of last 4 days for squareoff.. not required as per PRMS id: 10391261 dt...14/08/2015...      
update #p9_File2 set VarMarginShortFall_AftAdj=(Case when #p9_File2.VarMarginShortFall_AftAdjCurrDay > q.VarMarginShortFall_AftAdjCurrDay                 
then #p9_File2.VarMarginShortFall_AftAdjCurrDay else q.VarMarginShortFall_AftAdjCurrDay end)                
from                
(                
select Party_code,MAX(VarMarginShortFall_AftAdjCurrDay) as VarMarginShortFall_AftAdjCurrDay                 
from vmss_Data x join                
(select top 3 processdate from (select distinct processdate from vmss_Data where processdate < @BSElastBillDate) a order by processdate) y                 
on x.processdate=y.processdate                             
group by party_code                
) q where #p9_File2.party_code=q.party_code                
*/        
                                    
/* Var Margin % */                                                                                
                                                                                   
truncate table vmss_holding                                                                      
insert into vmss_holding                                                                                                    
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate)                                              
        
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,                                                                                                    
SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS [SrNo],0,ISIN,ActualSqOffQty=CONVERT(int,0),0.00 from #p9_hold                                                                                                    
                                                                      
/*                                                                                                  
select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #p9_filex                                                                                                     
from #p9_file2 where VarMarginShortFall_AftAdj < 0              
                                                                              
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                                                                    
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                                                                    
                                                               
select @totctr=MAX(srno) from #p9_filex                                                                                                    
                                                                                         
While @ctr <= @totctr                                                                                                    
Begin                                                                                             
                                                                 
set @SqOffVal=0                                                            
select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdj*-1 from #p9_filex where srno=@ctr                                                                                                                    
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],* into #p9_holdadj from vmss_holding a join                                                                                                    
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                           
where party_code=@pcode and Clsrate > 0                                                                                  
                                                                              
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                    
set @TSqOffVal=0                                                                                                    
                                                                                
set @Xctr=1                                                                                        
                                                                                
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                   
BEGIN                                                                                        
                                                                            
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                           
                                                
if (@SqOffVal<@TSqOffVal)                                                            
set @TSqOffVal=@SqOffVal                                                                                                    
                                                            
update vmss_holding                                                                             
set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                                                     
SqOffseq=@xctr                                                                                       
where id=@id                                                                              
                                                                                
set @SqOffVal=@TSqOffVal                                                                                                    
                    
set @Xctr=@Xctr+1                                                                                                    
END                                                                                                    
                                                                                         
DROP TABLE #p9_holdadj                                          
                                                                                         
set @ctr=@ctr+1                                          
end                                                                                                    
                                                                                        
drop table #p9_filex                                                                                                    
                                                              
truncate table vmss_holding_hist                                                                                                     
insert into vmss_holding(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq)                                                       
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq from vmss_holding                                                                                   
  
    
      
      
      
       
                                                                                      
update #p9_file2 set SquareOffValue=b.SqVal from                                                            
(                                                                                          
select party_code,sum(SquareOffQty*Clsrate) as SqVal from vmss_holding where isnull(SquareOffQty,0) > 0                                                                                           
group by party_code                                                                                          
) b                                                                                                     
where #p9_file2.party_code=b.party_Code                                                                                                    
*/                                                                                  
                                                                                      
/*                                                                                                          
update #p9_File2 set SquareOffValue=                                                                                                              
Case when (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 < (Holding_BHC)*-1 then (Holding_BHC)*-1                                                                                                              
else (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 end                                    
where LeverageMultiplier > 0                                                                                                              
*/                                                                                                    
                                                                             
/*                                                                            
UPDATE #p9_File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                           
(                                                                                
SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                                                                         
(                                                                                   
SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                           
WHERE CONVERT(DATE,processdate) < (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data )                                                  
)                                                                                                                                        
) B WHERE #p9_File2.party_code=B.party_code                                                                                                      
                                                                                 
UPDATE #p9_File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                                          
            
*/                                                                                     
                                                                        
delete from VMSS_data where processDate=@BSElastBillDate                                                                                                              
                                                                                         
insert into VMSS_data(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,                                                                                                    
Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,                                                                                                       
NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,remarks,DP_adj,Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                                                                            
 
     
     
      
      
       
                      
SELECT processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,                                                                             
OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,                                                
VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,GETDATE(),'V','',DP_adj,0.00,VarMarginShortFall_AftAdjCurrDay                                                                                                          
FROM #p9_FILE2                                                                                                               
                                                                      
/*                                                                              
insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                       
   
    
      
      
      
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks)                                                                                   
  
    
      
      
      
select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                                            
  
    
      
      
      
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks from VMSS_data                                                                     
  
    
      
      
      
*/                                                                
                                                                      
End try                                                                                                                                   
BEGIN CATCH                                                                                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                            
  select GETDATE(),'VMSS_Calculation_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                                                                                 
                        
  DECLARE @ErrorMessage NVARCHAR(4000);                                                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                            
  RAISERROR (@ErrorMessage , 16, 1);                                    
End catch                                                                                   
                        
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Calculation_NoNRMS_30072016
-- --------------------------------------------------
Create Procedure [dbo].[VMSS_Calculation_NoNRMS_30072016]                                                                                                      
as                                                                                                                
                                                                                                                
SET XACT_ABORT ON                                                                                                                
Set nocount on                                                                                                                
BEGIN TRY                                                                                                                                        
  
 exec VMSS_upd_ASB7_Days    
                                                                                
 Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                                                                
 Declare @LowerCapNonCash as money = 500  /* NONCASH COLLATERAL MOVEMENT : always +ve */                                                                                                                
 Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                
                                                                                                          
 select                                                                                                                 
 @BSElastBillDate  as processDate,                                                                                                                
 b.Entity,                                                                                                                
 b.segment,                                                                                                                
 a.Party_code,                                                                                                                
 a.Ledger as Balance,                                                                                                                
 CONVERT(money,0)  as UnsettledCr,                                                                                                                
 CONVERT(money,0) as UnsettledDr,                                                                                                                
 a.Unrecosiled_Credit as UnrecoAmt,                                                                                                                
 CONVERT(money,0) as ShortSellValue,                                                                                                                
 a.Imargin as MarginAmt,                                                                                                                
 a.Deposit,                                                                                                                
a.Cash_Colleteral as CashColl,                                                                                                                
a.NonCash_Colleteral as NonCashColl,                                                                                                                
Holding_total,                                                                                                                
Holding_Approved,                                                                                                                
CONVERT(money,0) as OtherDebit,                                                      
CONVERT(int,0) as NonCashConsideration,          
CONVERT(money,0) as Net,   
CONVERT(money,0) as EarlyPayinValue,                    
CONVERT(money,0) as LeverageMultiplier,                            
CONVERT(money,0) as VarMarginShortFall,                                                                
CONVERT(money,0) as SquareOffValue,                                    
CONVERT(money,0) as MgnAdjNonCash,                                                       
CONVERT(money,0) as MgnAdjNonLed                                                                  
into #p9_File1                                                     
from (select * from General.dbo.RMS_DtClFi with (nolock) where 1=2) a join (select segment,entity from intranet.cms.dbo.ncms_entity with (nolock) where entity='Equity') b                                                                      
on a.Co_code=b.segment                                                                       
                                                                                                       
                                                                                                       
 /* update Holding */                                                                                                      
select EXCHANGE,sett_no,SEtt_type,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY1 ELSE SCRIP_CD END) AS scrip_cd,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,Party_code,Qty,                                                                            
CLSRATE,                                                                                                                
Total AS VBHC,                                                                              
CONVERT(MONEY,0) AS HAIRCUT,                                                                                                                
CONVERT(MONEY,0) AS VAHC,                                                                                                    
SPACE(10) AS CATEGORY,                                                                                                                
source AS SRC,                                                                        
ISIN                                                                        
INTO #p9_HOLD                                                                                                                
from vmss_rms_holding where source in ('SI','SO','H','D')                    
  
update #p9_HOLD set series=b.NseSeries from general.dbo.scrip_master b  
where #p9_HOLD.isin=b.isin and b.NseSeries='EQ'   
  
                    
SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0          
DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin          
DROP TABLE #nqty          
                                                                                                       
update #p9_HOLD set clsrate=b.rate from General.dbo.cp_bsecm b where #p9_HOLD.scrip_Cd=b.scode and #p9_HOLD.clsrate=0                                                                                                                
                    
update #p9_HOLD set clsrate=b.cls                                                                                                                 
from General.dbo.cp_nsecm b                                                                                                       
where #p9_HOLD.scrip_Cd=b.scrip and #p9_HOLD.series=b.series and #p9_HOLD.clsrate=0 and exchange='NSECM'                                                                                                              
                    
update #p9_HOLD set VBHC=clsrate*Qty                                                                                           
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                    
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                               
where #p9_HOLD.SCRIP_cD=B.BSECODE AND #p9_HOLD.EXCHANGE='BSECM'                                                                                                                
    
    
/*Added to handle scrip:idfc ltd as it has shifted from BE to Eq as suggested by Vishal Gohil on Dec 10 2015*/    
--select * from #p9_HOLD where  isin='INE092T01019' and series='EQ'    
--update #p9_HOLD set series='EQ' where isin='INE092T01019' and series='BE'    
    
/* update a set series=b.Currenteries from #p9_HOLD a inner join VMSS_Exception_NSESeries b on a.isin=b.isin and a.series=b.previousseries  */  
    
/*******************************************************************/    
    
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                  
where #p9_HOLD.SCRIP_cD=B.NSESYMBOL AND #p9_HOLD.SERIES=B.NSESERIES AND #p9_HOLD.EXCHANGE='NSECM'                                                              
    
    
    
                    
update #p9_HOLD set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #p9_HOLD set VAHC=VBHC*((100-HAIRCUT)/100.00)                                                  
                    
insert into #p9_File1(segment,party_code)                                                              
select b.co_code,party_Code from                                                                                                      
(select party_code from #p9_hold group by party_code) a,                                                                                                       
(select * from General.dbo.company where entitytype='EQ' and bo_active=1) b                                                                                                      
                                                                                                      
update #p9_file1                                                                 
set entity='EQUITY',ProcessDate=@BSElastBillDate,Balance=0,UnsettledCr=0,UnsettledDr=0,UnrecoAmt=0,ShortSellValue=0,                                                                                       
MarginAmt=0,Deposit=0,CashColl=0,NonCashColl=0,Holding_total=0,Holding_Approved=0,OtherDebit=0,NonCashConsideration=0,Net=0,                                                                                                      
EarlyPayinValue=0,LeverageMultiplier=0,VarMarginShortFall=0,SquareOffValue=0                                                                                                      
                                                                                       
update #p9_File1 set holding_total=b.VBHC,holding_approved=b.VAHC from                                                                 
(select party_code,exchange,VBHC=sum(VBHC),VAHC=sum(VAHC)                                                                                                                
from #p9_hold group by party_code,exchange) b                                                                       
where #p9_File1.party_code=b.party_code and #p9_File1.segment=b.exchange                                                                              
                                                                                                      
/* Get Last settlement Date */                                                                                                     
                                                                                      
 Declare @sdtcur as datetime,-- @ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59'                                                                                                        
 @ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'                                  
 select @sdtcur=sdtcur from General.dbo.parameter with (nolock) where sdtcur <= @ToDate and ldtcur >=@ToDate                                           
                                       
/* Fetch effective Ledger Balance - Only Bill's effective date else voucher date*/                                 
                
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
 into #p9_BSECM                                                                                                                
 from anand.account_ab.dbo.ledger a with (nolock)                                                                                       
 where vDT>=@sdtcur and vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                           
 group by cltcode                                     
                                                                                   
 select CLTCODE,                                                                                                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                           
 into #p9_NSECM                                                                                                                
from anand1.account.dbo.ledger a with (nolock)                                                                                                                       
 where vDT>=@sdtcur and  vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                                                       
 group by cltcode                                                                                                                    
                                                 
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                 
 into #p9_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                                                       
 /* where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end) */                                                                                                           
  
  
    
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                                 
 select CLTCODE,                                                                          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_NSX                         
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                                                       
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                               
select CLTCODE,                                                
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
into #p9_MCD                                                                                                    
from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)          
where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
group by cltcode                                                                                                                    
                                                                                                  
 /* Fetch Deposit */                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                 
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                    
 into #p9_dep_BSECM                                                                                                                
 from anand.account_ab.dbo.ledger a with (nolock)                                                                        
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                      
 group by cltcode                                              
                                    
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSECM from anand1.account.dbo.ledger a with (nolock)                                                           
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                      
                                                                                                                
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                       
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                     
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '40%'                                                                                                                      
 group by cltcode                                                                                       
                                                                  
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                         
 into #p9_dep_NSX                                                                                                                
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                   
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                              
 group by cltcode                                       
                                                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                   
 into #p9_dep_MCD                        
 from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                                   
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                                                
                                                                         
 update #p9_File1 set Balance=b.Vbal from #p9_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                                                      
 update #p9_File1 set Balance=b.Vbal from #p9_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                            
                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                          
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                                                                          
                                                                                                      
 update #p9_File1 set Earlypayinvalue=b.EPV from                      
 (select Exchange,party_code,SUM(total) as EPV from VMSS_EarlyPayinData group by Exchange,party_code) b          
 where #p9_File1.party_code=b.party_Code and #p9_File1.segment=b.exchange                                                                                              
                                                                                                                 
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                             
 (           
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelfo.nsefo.dbo.tbl_clientmargin with (nolock)                                                        
 where MarginDate = (select MAX(margindate) from angelfo.nsefo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                   
  ) b                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSEFO'                                                                                                      
                                                                                                      
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                            
 (                                                                                                      
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                                   
 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                         
  ) b                                                                                                       
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCD'                                                                                           
                                                                                        
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                      
 (                                                                             
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                      
 from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock)                                                                                                      
 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                          
) b                                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSX'                                                                                                      
                                                                              
 update #p9_File1 set NonCashColl=b.NonCashColl                                         
 from VMSS_Client_collateral_NonEquity_NoBrInfo b                                                
 where #p9_File1.party_code=b.party_code and #p9_file1.segment=b.co_code                                                                                 
                                                                
/* Excess Collateral adjustement with Ledger Debit */            
 update #p9_File1 set NonCashColl=NonCashColl+Balance                                                                                                     
 where NonCashColl > 0 and Balance < 0 and segment in ('NSEFO','MCD','NSX')                                                               
                                                                               
 /* GEnerate Summarised Data */                    
                                                           
delete from #p9_file1 where party_code in (select party_code from mis.sccs.dbo.Combine_legal)                                                              
delete from #p9_file1 where party_code in (select party_code from General.dbo.client_Details where (branch_cd='NRIS' or sub_broker='BH'))                          
                        
/*Remove Tday and T+1 day clients ,added by abha as suggested by vishal gohil*/                           
                        
delete from #p9_file1 where party_code in (select Party_Code         
from General.dbo.SQUAREUP_CLIENT_ALERT where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT_ALERT))           
/* -----T day------ */        
        
          
                             
delete from #p9_file1 where party_code in (select party_Code from General.dbo.SQUAREUP_CLIENT         
where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT))            
/*------T+1day --------*/        
        
          
                                                                                     
select                                                                                                                 
max(processDate) as processDate,Entity,Party_code,convert(int,1) as NoofDays,                                                                                                                
sum(Balance) as Balance,sum(MarginAmt) as MarginAmt,sum(Deposit) as Deposit,                                               
sum(CashColl) as CashColl,sum(NonCashColl) as NonCashColl,sum(Holding_total) as Holding_BHC,                                                                                                   
sum(Holding_Approved) as Holding_AHC,sum(OtherDebit) as OtherDebit,                                                
sum(EarlyPayinValue) as EarlyPayinValue,sum(LeverageMultiplier) as LeverageMultiplier,                                                                                               
sum(VarMarginShortFall) as VarMarginShortFall,                                 
Convert(money,0) as NSEFO_JV,                                                                                                                
Convert(money,0) as NSEFO_NonCash,                                                                                                                
Convert(money,0) as MCD_JV,                                                                                               
Convert(money,0) as MCD_NonCash,                                                                                                                
Convert(money,0) as NSX_JV,                                                                                                                
Convert(money,0) as NSX_NonCash,                                                              
Convert(money,0) as VarMarginShortFall_AftAdj,                                                                                               
Convert(money,0) as Stage,                                                                                                                
sum(SquareOffValue) as SquareOffValue,Sum(Case when Segment='BSECM' then BAlance else 0 end) as BSECM_Balance,                                                                                                                 
Sum(Case when Segment='NSECM' then BAlance else 0 end) as NSECM_Balance,                                                         
Convert(money,0) as DP_adj ,                
Convert(money,0) as VarMarginShortFall_AftAdjCurrDay                                                     
into #p9_file2                                                                                                                
from #p9_file1 where segment in ('BSECM','NSECM')                                                                                                                
group by Entity,Party_code                                       
                                                           
/* delete Client with Cash Credit effective Balance */                                                                                                       
                                                              
Delete from #p9_file2 where balance >= @LowerCapAmt                          
Delete from #p9_file2 where party_code in (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF'))                                                                                  
Delete from #p9_file1 where party_Code not in (select party_code from #p9_file2)                                                                              
Delete from #p9_file2 where Holding_BHC <= 0                                                       
                                  
update #p9_File2 set VarMarginShortFall=(case when Holding_AHC+Balance+Deposit+EarlypayinValue < @LowerCapAmt then Holding_AHC+Balance+Deposit+EarlypayinValue  else 0 end)                                                                                   
  
  
    
       
       
        
        
         
                                           
update #p9_File2 set LeverageMultiplier=                                                                                                                
Case when 100-(Holding_AHC/Holding_BHC)*100.00 > 100 then 100 else 100-(Holding_AHC/Holding_BHC)*100.00 end                                                                                                                
where Holding_BHC > 0                                                                                                  
                                                                          
update #p9_file1 set MgnAdjNonCash=0 where MgnAdjNonCash is null                                                                                            
update #p9_file1 set MgnAdjNonLed=0 where MgnAdjNonLed is null                                                    
                        
/* Adj.Margin with Non_Cash Scripwise */                                                                       
                                      
update vmss_NonCash set FinalAmount=Amount-(Amount*(MarginHC/100.00))                                              
update vmss_noncash set MarginSqOffQty=0                                                    
/*---- Full NonCash Getting adjusted against Margin */                                                                              
update vmss_noncash set MarginSqOffQty=Qty from                                                                              
(                                                                              
/*                                                              
select a.*,b.MarginAmt from                                                                              
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                              
(select segment,party_code,MArginAmt from #p9_file1 where MArginAmt > 0) b                        
on a.party_code=b.party_code and a.co_code=b.segment                                                                              
where b.MArginAmt >= a.VAHC                                                               
*/                                    
select a.*,b.MarginAmt from                                                    
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                            
(select segment,party_code,MArginAmt+(Case when balance < 0 then -balance else 0 end) as MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                       
on a.party_code=b.party_code and a.co_code=b.segment                                                                            
where b.MArginAmt >= a.VAHC                                                                
) x where vmss_noncash.party_code=x.party_Code and vmss_noncash.co_code=x.co_Code                                                
                                                                  
/*---- Partial NonCash Getting adjusted against Margin */                                                       
                                          
                                                         
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex from                                                                               
/* (select * from #p9_file1 where marginAmt > 0 ) a  left outer join             */                                                            
(select                       
processDate,Entity,segment,Party_code,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,                                                   
(Case when Balance < 0 then MarginAmt-Balance else MArginAmt end) as MarginAmt,                                                      
Deposit,CashColl,NonCashColl,Holding_total,Holding_Approved,OtherDebit,NonCashConsideration,                                                      
Net,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,SquareOffValue,MgnAdjNonCash,MgnAdjNonLed                                                      
from #p9_file1 where segment in ('NSEFO','MCD','NSX')) a  left outer join                                                     
(select co_code,party_code from vmss_noncash where MarginSqOffQty <> 0 group by party_code,Co_Code) b                                                                              
on a.party_code=b.party_code and a.segment=b.co_Code                                                                              
join (select co_code,party_code from vmss_noncash where MarginSqOffQty = 0 group by party_code,Co_Code) c                                                                              
on a.party_code=c.party_code and a.segment=c.co_Code                                                                              
where b.Party_Code is null                                                                              
                                                    
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                               
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0,@segment as varchar(10) = ''                                                                                
                                                
select @totctr=MAX(srno) from #p9_filex                                                                
                                                                  
While @ctr <= @totctr                                                                                                  
Begin                    
                                                                             
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=MarginAmt,@segment=segment from #p9_filex where srno=@ctr                                                                 
                     
select ROW_NUMBER() OVER (ORDER BY b.seqid,FinalAmount desc) AS [SrNo],                                                           
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,MarginHC as HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,                                                                              
clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty                                                                              
into #p9_holdadj from vmss_noncash a join                                                                                        
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                             
where party_code=@pcode and Clsrate > 0 and MarginHC < 100 and co_Code=@segment                             
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                        
set @TSqOffVal=0                                                                                  
                                                                  
set @Xctr=1                                                                                        
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                           
BEGIN                                                                     
                                                                         
select @TSqOffVal=FinalAmount,@qty=Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                
set @TSqOffVal=@SqOffVal                                                                                             
                                                                  
      
update vmss_noncash                                                                                        
set MarginSqOffQty=ceiling(Case when @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) <= @qty                                             
then @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) else @qty end)                                                                                    
where id=@id  and  MarginHC < 100                                                           
                                                                                  
set @SqOffVal=@SqOffVal-@TSqOffVal                                                                          
set @Xctr=@Xctr+1                                                                                                  
      
END                                                                                                  
                                 
DROP TABLE #p9_holdadj                                                                                                  
                                                                                        
set @ctr=@ctr+1                                
end                                                                                                  
         
drop table #p9_filex                                                                                                  
                                                                  
/* Calculation Margin Adjusted with NonCash */                                                                                                  
                                                                  
/*    
update #p9_file1 set MgnAdjNonCash=(Case when MarginAmt-(NonCashColl+CashColl) < 0 then MarginAmt else (NonCashColl+CashColl) end)                                                                          
where segment in ('NSEFO','MCD','NSX')                                                                                                  
*/                                                                              
                                                                  
update #p9_file1 set MgnAdjNonCash=B.AdjWithMargin from                                                                              
(                               
select co_Code,party_code,sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) as AdjWithMargin from vmss_noncash                                                                               
group by co_Code,party_code                                                                              
having sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) > 0                                            
) b where #p9_file1.party_code=b.party_Code and #p9_file1.segment=b.co_Code                                                        
                                                                                      
/* Calculation Margin Adjusted with Ledger Credit */                                                                                                  
update #p9_file1 set MgnAdjNonLed=(Case                                                 
when Balance > (MarginAmt-MgnAdjNonCash) and MarginAmt-MgnAdjNonCash > 0 and balance > 0 then (MarginAmt-MgnAdjNonCash)                                                                                        
when Balance <= (MarginAmt-MgnAdjNonCash) and balance > 0 then Balance                                                                                                  
else 0 end) where segment in ('NSEFO','MCD','NSX')                                                                   
                                             
                                       
                                                                                   
update  #p9_File2 set NSEFO_JV=b.AdjWithLedgerCr /*,NSEFO_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                                                              
  
  
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                   
from #p9_file1 where segment='NSEFO' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                                                     
                
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr /*,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                      
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                     
from #p9_file1 where segment='NSX' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                   
/*                                                                              
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                                
(              
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                          
from #p9_file1 where segment='NSX'                                                                                                     
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                
*/                                                                               
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                             
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                
from #p9_file1 where segment='MCD' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                    
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                   
/*                                                                                                                 
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                                
(                                                                                                    
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                     
from #p9_file1 where segment='MCD'                                                                                                     
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                           
*/                                                                                                        
                                                                  
UPDATE #p9_File2 SET NSEFO_JV=-vARmARGINsHORTFALL  WHERE NSEFO_JV > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV > 0                                        
UPDATE #p9_File2 SET mcd_jv=-vARmARGINsHORTFALL-NSEFO_jv  WHERE mcd_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv >= 0            
  
   
UPDATE #p9_File2 SET NSX_jv=-VARMARGINSHORTFALL-NSEFO_JV-mcd_jv  WHERE nsx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv >= 0                                                      
                                                                   
UPDATE #p9_File2 SET NSEFO_JV=0 where NSEFO_JV<0                                                                                        
UPDATE #p9_File2 SET mcd_jv=0 where mcd_jv<0                                                                                        
UPDATE #p9_File2 SET NSX_jv=0 where NSX_jv<0                              
                                                                                                    
/* Adjust VarMArgin Shortage with NonCash Collateral */                                                                              
                                      
update vmss_NonCash set FinalAmount=Amount*(Haircut/100.00)                                                   
                                                                  
/*----- NSEFO-----*/                                         
                                                                  
set @totctr  = 0                          
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                        
set @Xctr = 1                                                                              
SET @qty = 0                             
set @TSqOffVal = 0                                                                                  
set @SqQty = 0                                                                    
set @clsrate =0                                                                                  
set @id = 0                                                                               
                                                            
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex1                                                                              
from                                                                        
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv as VarMarginShortFallAftJV from #p9_file2 where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSEFO' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                                                                     
select @totctr=MAX(srno) from #p9_filex1                                                                                                  
                                                                    
While @ctr <= @totctr                                                        
Begin                                                                                                  
                           
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex1 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                             
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                   
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj1                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                               
where party_code=@pcode and Clsrate > 0 and co_code='NSEFO' and haircut < 100                                              
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj1                                                                                                   
set @TSqOffVal=0          
set @Xctr=1                                                             
      
      
                        
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN                                                                      
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj1 where srno=@xctr                                                              
                         
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                                                                  
                                                            
update VMSS_NonCash                                                                           
set                                         
/* SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                        
SqOffseq=@xctr                                                                                     
where id=@id  and  Haircut < 100                                                                                          
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                  
      
set @Xctr=@Xctr+1          
      
                                                                                              
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj1                                                                                        
                                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                    
                                                                                       
update #p9_file2 set NSEFO_noncash=B.AdjustedAmt FROM                                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSEFO' and SquareOffQty > 0                                                                           
group by party_Code      
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                              
                                                                 
/*------ NSX ----*/                                                                
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                        
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                      
set @SqQty = 0                                                                      
set @clsrate =0                                                           
set @id = 0                                                                               
                                                   
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex2                                                                     
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash as VarMarginShortFallAftJV from #p9_file2                     
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSX' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                              
select @totctr=MAX(srno) from #p9_filex2                                                                                                  
                                                                                        
While @ctr <= @totctr                                                                                              
Begin                                                                                                  
                                                                          
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex2 where srno=@ctr                                                                              
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj2                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='NSX'  and haircut < 100                             
                                       
select @Xtotctr=MAX(Srno) from #p9_holdadj2                                                                                                   
set @TSqOffVal=0                                                                                         
                                                                  
set @Xctr=1                                                           
          
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN             
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj2 where srno=@xctr                       
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                               
                                                                  
update VMSS_NonCash                                                                              
/*set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                                        
SqOffseq=@xctr                                                                                  
where id=@id and Haircut < 100      
           
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                                                  
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj2                                                                                                  
                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                                              
drop table #p9_filex2                                                                                
                                                        
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSX' and SquareOffQty > 0                                               
group by party_Code                                                              
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                              
                                                                   
                                                                  
/*------ MCD ----*/                                                                              
                   
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                
set @SqQty = 0                                                                                  
set @clsrate =0                                                                                  
set @id = 0                                
                                        
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex3                                                                              
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash as VarMarginShortFallAftJV from #p9_file2                                                                               
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash < 0) a join                                            
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='MCD' group by party_code) c                                      
on a.party_code=c.party_code                                            
                                                                     
select @totctr=MAX(srno) from #p9_filex3                                                     
                                    
While @ctr <= @totctr                                                                                                  
Begin                          
                                                                
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex3 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj3                                                                  
from VMSS_NonCash_BalAfterMargin a join              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='MCD' and haircut < 100                                                                                                
                                         
select @Xtotctr=MAX(Srno) from #p9_holdadj3                               
set @TSqOffVal=0                                                                                                  
                                                                  
set @Xctr=1                                                 
                                                                     
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                               
BEGIN                                                                                                  
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj3 where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal               
                                                                  
update VMSS_NonCash                                                                                        
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),             
SqOffseq=@xctr                                                                                     
where id=@id and Haircut < 100                                                                                          
          
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                         
END                                                        
                                                                                        
DROP TABLE #p9_holdadj3                                                                                                  
                         
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                     
drop table #p9_filex3                                                                                
                                                                  
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                                 (                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                              
from VMSS_NonCash_BalAfterMargin where co_Code='MCD' and SquareOffQty > 0                                                                           
group by party_Code                                                            
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE      
                                                                  
/*----*/                                                                              
UPDATE #p9_File2 SET NSEFO_NONCASH=0,MCD_NONCASH=0,NSX_NONCASH=0                                                                                                                 
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL = 0 AND vARmARGINsHORTFALL < 0                                                                                    
                                                                  
/*                                                                               
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)                                                                          
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                                                 
AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                                                     
                                                                                                 
UPDATE #p9_FILE2 SET MCD_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET MCD_NONCASH=Stage                                                                                                                
UPDATE #p9_FILE2 SET Stage=0                                                             
                                             
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)                                                                                                                
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                                                                                                                
AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)*-1                                                       
                                                                                                     
UPDATE #p9_FILE2 SET NSX_NONCASH=0                                                       
UPDATE #p9_FILE2 SET NSX_NONCASH=Stage                                                                                                             
UPDATE #p9_FILE2 SET Stage=0                                                                                     
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)                                                                                                               
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                                                                                                               
AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)*-1                                                                                                                
                                                                             
UPDATE #p9_FILE2 SET NSEFO_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET NSEFO_NONCASH=Stage                                                          
UPDATE #p9_FILE2 SET Stage=0                                                                                                                
*/                                                                              
                                  
update #p9_File2  set VarMarginShortFall_AftAdjCurrDay=vARmARGINsHORTFALL+NSefo_jv+MCD_JV+NSX_JV+NSEFO_NONCASH+MCD_NONCASH+NSX_NONCASH                                                                                         
where  vARmARGINsHORTFALL < 0                                                                                                                 
        
update #p9_File2  set VarMarginShortFall_AftAdj=VarMarginShortFall_AftAdjCurrDay        
        
/*        
--- Used to compute min of last 4 days for squareoff.. not required as per PRMS id: 10391261 dt...14/08/2015...        
update #p9_File2 set VarMarginShortFall_AftAdj=(Case when #p9_File2.VarMarginShortFall_AftAdjCurrDay > q.VarMarginShortFall_AftAdjCurrDay                   
then #p9_File2.VarMarginShortFall_AftAdjCurrDay else q.VarMarginShortFall_AftAdjCurrDay end)                  
from                  
(                  
select Party_code,MAX(VarMarginShortFall_AftAdjCurrDay) as VarMarginShortFall_AftAdjCurrDay                   
from vmss_Data x join                  
(select top 3 processdate from (select distinct processdate from vmss_Data where processdate < @BSElastBillDate) a order by processdate) y                   
on x.processdate=y.processdate                               
group by party_code                  
) q where #p9_File2.party_code=q.party_code                  
*/          
                                      
/* Var Margin % */                                                                                  
                                                                                     
truncate table vmss_holding                                                                        
insert into vmss_holding                                                                                                      
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate)                                                
          
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,                                                                                                      
SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS [SrNo],0,ISIN,ActualSqOffQty=CONVERT(int,0),0.00 from #p9_hold                                                                                                      
                                                                        
/*                                                                                                    
select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #p9_filex                                                                                                       
from #p9_file2 where VarMarginShortFall_AftAdj < 0                
                                                                                
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                                                                      
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                                                                      
                                                                 
select @totctr=MAX(srno) from #p9_filex                                                                                                      
                                                                                           
While @ctr <= @totctr                                                                                                      
Begin                                                                                               
                                                                   
set @SqOffVal=0                                                              
select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdj*-1 from #p9_filex where srno=@ctr                                                                                                                      
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],* into #p9_holdadj from vmss_holding a join                                                                                                      
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                             
where party_code=@pcode and Clsrate > 0                                                                                    
                                                                                
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                                                     
set @TSqOffVal=0                                                                                                      
                                                                
set @Xctr=1                                                                                          
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                     
BEGIN                                                                                          
                                                                              
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                             
                                                  
if (@SqOffVal<@TSqOffVal)                                                              
set @TSqOffVal=@SqOffVal                                                                                                      
                                                              
update vmss_holding                                                                               
set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                                                       
SqOffseq=@xctr                                                                                         
where id=@id                                                                                
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                      
                      
set @Xctr=@Xctr+1                                                                                                      
END                                                                                                      
                                                                                           
DROP TABLE #p9_holdadj                                            
                                                                                           
set @ctr=@ctr+1                                            
end                                                                                                      
                                                                                          
drop table #p9_filex                                                                                                      
                                                                
truncate table vmss_holding_hist                                                                                                       
insert into vmss_holding(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq)                                                         
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq from vmss_holding                                                                                   
  
  
    
      
        
        
        
         
                                                                                        
update #p9_file2 set SquareOffValue=b.SqVal from                                                              
(                                                                                            
select party_code,sum(SquareOffQty*Clsrate) as SqVal from vmss_holding where isnull(SquareOffQty,0) > 0                                                                                       
group by party_code                                                                                            
) b                
where #p9_file2.party_code=b.party_Code                                                                                                      
*/                                                                                    
                                                                                        
/*                                                                                                            
update #p9_File2 set SquareOffValue=                                                                                                                
Case when (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 < (Holding_BHC)*-1 then (Holding_BHC)*-1                                                                                                                
else (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 end                                      
where LeverageMultiplier > 0                                                                                                                
*/                                                                                                      
                                                                               
/*                                                                              
UPDATE #p9_File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                             
(                                                                                  
SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                                                                           
(                                                                                     
SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                             
WHERE CONVERT(DATE,processdate) < (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data )                                                    
)                                                                                                                                          
) B WHERE #p9_File2.party_code=B.party_code                                                                                                        
                                                                                   
UPDATE #p9_File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                                            
              
*/                                                                                       

/*  
delete a from #p9_FILE2 a left outer join VMSS_ASB7_Days b on a.party_code=b.Party_code   
WHERE b.Party_code is null  
*/
  
delete from VMSS_data where processDate=@BSElastBillDate                                                                                                                
                                                                                           
insert into VMSS_data(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,                                                                                                      
Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,                                                                                                         
NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,remarks,DP_adj,Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                                                                           
   
SELECT processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,                                                                                                                
OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,                                                  
VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,GETDATE(),'V','',DP_adj,0.00,VarMarginShortFall_AftAdjCurrDay                                                                                                            
FROM #p9_FILE2                                                                                                                 
                                                                        
/*                                                                                
insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                        
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks)                                                                                   
  
  
select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                                            
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks from VMSS_data                                                                     
  
  
*/                                                                  
                                                                        
End try                                                                                                                                     
BEGIN CATCH                                                                                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                              
  select GETDATE(),'VMSS_Calculation_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                                                                                   
                          
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                              
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                                                     
                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Calculation_NoNRMS_31072017
-- --------------------------------------------------
create Procedure [dbo].[VMSS_Calculation_NoNRMS_31072017]                                                                                                      
as                                                                                                                
                                                                                                                
SET XACT_ABORT ON                                                                                                                
Set nocount on                                                                                                                
BEGIN TRY                                                                                                                                        
  
 exec VMSS_upd_ASB7_Days    
                                                                             
 Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                                                                
 Declare @LowerCapNonCash as money = 500  /* NONCASH COLLATERAL MOVEMENT : always +ve */                                                                                                                
 Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                
                                                                                                          
 select                                                                                                                 
 @BSElastBillDate  as processDate,                                                                                                                
 b.Entity,                                                                                                                
 b.segment,                                                                                                                
 a.Party_code,                                                                                                                
 a.Ledger as Balance,                                                                                                                
 CONVERT(money,0)  as UnsettledCr,                                                                                                                
 CONVERT(money,0) as UnsettledDr,                                                                                                                
 a.Unrecosiled_Credit as UnrecoAmt,                                                                                                                
 CONVERT(money,0) as ShortSellValue,                                                                                                                
 a.Imargin as MarginAmt,                                                                                                                
 a.Deposit,                                                                                                                
a.Cash_Colleteral as CashColl,                                                                                                                
a.NonCash_Colleteral as NonCashColl,                                                                                                                
Holding_total,                                                                                                                
Holding_Approved,                                                                                                                
CONVERT(money,0) as OtherDebit,                                                      
CONVERT(int,0) as NonCashConsideration,          
CONVERT(money,0) as Net,   
CONVERT(money,0) as EarlyPayinValue,                    
CONVERT(money,0) as LeverageMultiplier,                            
CONVERT(money,0) as VarMarginShortFall,                                                                
CONVERT(money,0) as SquareOffValue,                                    
CONVERT(money,0) as MgnAdjNonCash,                                                       
CONVERT(money,0) as MgnAdjNonLed                                                                  
into #p9_File1                                                     
from (select * from General.dbo.RMS_DtClFi with (nolock) where 1=2) a join (select segment,entity from intranet.cms.dbo.ncms_entity with (nolock) where entity='Equity') b                                                                      
on a.Co_code=b.segment                                                                       
                                                                                                       
                                                                                                       
 /* update Holding */                                                                                                      
select EXCHANGE,sett_no,SEtt_type,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,Party_code,Qty,                                                                            
CLSRATE,                                                                                                                
Total AS VBHC,                                                                              
CONVERT(MONEY,0) AS HAIRCUT,                                                                                                                
CONVERT(MONEY,0) AS VAHC,                                                                                                    
SPACE(10) AS CATEGORY,                                                                                                                
source AS SRC,                                                                        
ISIN                                                                        
INTO #p9_HOLD                                                                                                                
from vmss_rms_holding where source in ('SI','SO','H','D')                    
  
update #p9_HOLD set series=b.NseSeries from general.dbo.scrip_master b  
where #p9_HOLD.isin=b.isin and b.NseSeries='EQ'   
  
                    
SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0          
DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin          
DROP TABLE #nqty          
                                                                                                       
update #p9_HOLD set clsrate=b.rate from General.dbo.cp_bsecm b where #p9_HOLD.scrip_Cd=b.scode and #p9_HOLD.clsrate=0                                                                                                                
                    
update #p9_HOLD set clsrate=b.cls                                                                                                                 
from General.dbo.cp_nsecm b                                                                                                       
where #p9_HOLD.scrip_Cd=b.scrip and #p9_HOLD.series=b.series and #p9_HOLD.clsrate=0 and exchange='NSECM'                                                                                                              
                    
update #p9_HOLD set VBHC=clsrate*Qty                                                                                           
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                    
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                               
where #p9_HOLD.SCRIP_cD=B.BSECODE AND #p9_HOLD.EXCHANGE='BSECM'                                                                                                                
    
    
/*Added to handle scrip:idfc ltd as it has shifted from BE to Eq as suggested by Vishal Gohil on Dec 10 2015*/    
--select * from #p9_HOLD where  isin='INE092T01019' and series='EQ'    
--update #p9_HOLD set series='EQ' where isin='INE092T01019' and series='BE'    
    
/* update a set series=b.Currenteries from #p9_HOLD a inner join VMSS_Exception_NSESeries b on a.isin=b.isin and a.series=b.previousseries  */  
    
/*******************************************************************/    
    
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                  
where #p9_HOLD.SCRIP_cD=B.NSESYMBOL AND #p9_HOLD.SERIES=B.NSESERIES AND #p9_HOLD.EXCHANGE='NSECM'                                                              
      
                    
update #p9_HOLD set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #p9_HOLD set VAHC=VBHC*((100-HAIRCUT)/100.00)                                                  
                    
insert into #p9_File1(segment,party_code)                                                              
select b.co_code,party_Code from                                                                                                      
/*(select party_code from #p9_hold group by party_code) a,*/ 
(select t_day,party_code from  mis.dbo.asb7_clidetails_crdet --commented on Aug 26 2016  as required by Vishal Gohil mail dated Aug 24 2016 
 where T_day>0 and  
 rms_date=(select max(rms_date)from  mis.dbo.asb7_clidetails_crdet)) a,                                                                                                      
(select * from General.dbo.company where entitytype='EQ' and bo_active=1) b                                                                                                      
                                                                                                      
update #p9_file1                                                                 
set entity='EQUITY',ProcessDate=@BSElastBillDate,Balance=0,UnsettledCr=0,UnsettledDr=0,UnrecoAmt=0,ShortSellValue=0,                                                                                       
MarginAmt=0,Deposit=0,CashColl=0,NonCashColl=0,Holding_total=0,Holding_Approved=0,OtherDebit=0,NonCashConsideration=0,Net=0,                                                                                                      
EarlyPayinValue=0,LeverageMultiplier=0,VarMarginShortFall=0,SquareOffValue=0                                                                                                      
                                                                                       
update #p9_File1 set holding_total=b.VBHC,holding_approved=b.VAHC from                                                                 
(select party_code,exchange,VBHC=sum(VBHC),VAHC=sum(VAHC)                                                                                                                
from #p9_hold group by party_code,exchange) b                                                                       
where #p9_File1.party_code=b.party_code and #p9_File1.segment=b.exchange                                                                              
                                                                                                      
/* Get Last settlement Date */                                                                                                     
                                                                                      
 Declare @sdtcur as datetime,-- @ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59'                                                                                                        
 @ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'                                  
 select @sdtcur=sdtcur from General.dbo.parameter with (nolock) where sdtcur <= @ToDate and ldtcur >=@ToDate                                           
                                       
/* Fetch effective Ledger Balance - Only Bill's effective date else voucher date*/                                 
                
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
 into #p9_BSECM                                                                                                                
 from anand.account_ab.dbo.ledger a with (nolock)                                                                                       
 where vDT>=@sdtcur and vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                           
 group by cltcode                                     
                                                                                   
 select CLTCODE,                                                                                                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                           
 into #p9_NSECM                                                                                                                
from anand1.account.dbo.ledger a with (nolock)                                                                                                                       
 where vDT>=@sdtcur and  vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                                                       
 group by cltcode                                                                                                                    
                                                 
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                 
 into #p9_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                                                       
 /* where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end) */                                                                                                           
  
  
    
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                                 
 select CLTCODE,                                                                          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_NSX                         
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                                                       
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                               
select CLTCODE,                                                
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
into #p9_MCD                                                                                                    
from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)          
where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
group by cltcode                                                                                                                    
                                                                                                  
 /* Fetch Deposit */                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                 
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                    
 into #p9_dep_BSECM                                                                                                                
 from anand.account_ab.dbo.ledger a with (nolock)                                                                        
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                      
 group by cltcode                                              
                                    
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSECM from anand1.account.dbo.ledger a with (nolock)                                                           
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                      
                                                                                                                
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                       
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                     
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '40%'                                                                                                                      
 group by cltcode                                                                                       
                                                                  
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                         
 into #p9_dep_NSX                                                                                                                
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                   
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                              
 group by cltcode                                       
                                                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                   
 into #p9_dep_MCD                        
 from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                                   
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                                                
                                                                         
 update #p9_File1 set Balance=b.Vbal from #p9_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                                                      
 update #p9_File1 set Balance=b.Vbal from #p9_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                            
                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                          
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                                                                          
                                                                                                      
 update #p9_File1 set Earlypayinvalue=b.EPV from                      
 (select Exchange,party_code,SUM(total) as EPV from VMSS_EarlyPayinData group by Exchange,party_code) b          
 where #p9_File1.party_code=b.party_Code and #p9_File1.segment=b.exchange                                                                                              
                                                                                                                 
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                             
 (           
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelfo.nsefo.dbo.tbl_clientmargin with (nolock)                                                        
 where MarginDate = (select MAX(margindate) from angelfo.nsefo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                   
  ) b                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSEFO'                                                                                                      
                                                                                                      
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                            
 (                                                                                                      
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                                   
 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                         
  ) b                                                                                                       
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCD'                                                                                           
                                                                                        
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                      
 (                                                                             
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                      
 from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock)                                                                                                      
 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                          
) b                                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSX'                                                                                                      
                                                                              
 update #p9_File1 set NonCashColl=b.NonCashColl                                         
 from VMSS_Client_collateral_NonEquity_NoBrInfo b                                                
 where #p9_File1.party_code=b.party_code and #p9_file1.segment=b.co_code                                                                                 
                                                                
/* Excess Collateral adjustement with Ledger Debit */            
 update #p9_File1 set NonCashColl=NonCashColl+Balance                                                                                                     
 where NonCashColl > 0 and Balance < 0 and segment in ('NSEFO','MCD','NSX')                                                               
                                                                               
 /* GEnerate Summarised Data */                    
                                                           
delete from #p9_file1 where party_code in (select party_code from mis.sccs.dbo.Combine_legal)                                                              
delete from #p9_file1 where party_code in (select party_code from General.dbo.client_Details where (branch_cd='NRIS' or sub_broker='BH'))                          
                        
/*Remove Tday and T+1 day clients ,added by abha as suggested by vishal gohil*/                           
                        
delete from #p9_file1 where party_code in (select Party_Code         
from General.dbo.SQUAREUP_CLIENT_ALERT where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT_ALERT))           
/* -----T day------ */        
        
          
                             
delete from #p9_file1 where party_code in (select party_Code from General.dbo.SQUAREUP_CLIENT         
where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT))            
/*------T+1day --------*/        
        
          
                                                                                     
select                                                                                                                 
max(processDate) as processDate,Entity,Party_code,convert(int,1) as NoofDays,                                                                                                                
sum(Balance) as Balance,sum(MarginAmt) as MarginAmt,sum(Deposit) as Deposit,                                               
sum(CashColl) as CashColl,sum(NonCashColl) as NonCashColl,sum(Holding_total) as Holding_BHC,                                                                                                   
sum(Holding_Approved) as Holding_AHC,sum(OtherDebit) as OtherDebit,                                                
sum(EarlyPayinValue) as EarlyPayinValue,sum(LeverageMultiplier) as LeverageMultiplier,                                                                                               
sum(VarMarginShortFall) as VarMarginShortFall,                                 
Convert(money,0) as NSEFO_JV,                                                                                                                
Convert(money,0) as NSEFO_NonCash,                                                                                                                
Convert(money,0) as MCD_JV,                                                                                               
Convert(money,0) as MCD_NonCash,                                                                                                                
Convert(money,0) as NSX_JV,                                                                                                                
Convert(money,0) as NSX_NonCash,                                                              
Convert(money,0) as VarMarginShortFall_AftAdj,                                                                                               
Convert(money,0) as Stage,                                                                                                                
sum(SquareOffValue) as SquareOffValue,Sum(Case when Segment='BSECM' then BAlance else 0 end) as BSECM_Balance,                                                                                                                 
Sum(Case when Segment='NSECM' then BAlance else 0 end) as NSECM_Balance,                                                         
Convert(money,0) as DP_adj ,                
Convert(money,0) as VarMarginShortFall_AftAdjCurrDay                                                     
into #p9_file2                                                                                                                
from #p9_file1 where segment in ('BSECM','NSECM')                                                                                                                
group by Entity,Party_code                                       
                                                           
/* delete Client with Cash Credit effective Balance */                                                                                                       
                                                              
Delete from #p9_file2 where balance >= @LowerCapAmt                          
Delete from #p9_file2 where party_code in (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF'))                                                                                  
Delete from #p9_file1 where party_Code not in (select party_code from #p9_file2)                                                                              
/*Delete from #p9_file2 where Holding_BHC <= 0 */ --commented on Aug 26 2016  as required by Vishal Gohil mail dated Aug 24 2016                                                    
                                  
update #p9_File2 set VarMarginShortFall=(case when Holding_AHC+Balance+Deposit+EarlypayinValue < @LowerCapAmt then Holding_AHC+Balance+Deposit+EarlypayinValue  else 0 end)                                                                                   
  
                                          
update #p9_File2 set LeverageMultiplier=                                                                                                                
Case when 100-(Holding_AHC/Holding_BHC)*100.00 > 100 then 100 else 100-(Holding_AHC/Holding_BHC)*100.00 end                                                                                                                
where Holding_BHC > 0                                                                                                  
                                                                          
update #p9_file1 set MgnAdjNonCash=0 where MgnAdjNonCash is null                                                                                            
update #p9_file1 set MgnAdjNonLed=0 where MgnAdjNonLed is null                                                    
                        
/* Adj.Margin with Non_Cash Scripwise */                                                                       
                                      
update vmss_NonCash set FinalAmount=Amount-(Amount*(MarginHC/100.00))                                              
update vmss_noncash set MarginSqOffQty=0                                                    
/*---- Full NonCash Getting adjusted against Margin */                                                                              
update vmss_noncash set MarginSqOffQty=Qty from                                                                              
(                                                                              
/*                                                              
select a.*,b.MarginAmt from                                                                              
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                              
(select segment,party_code,MArginAmt from #p9_file1 where MArginAmt > 0) b                        
on a.party_code=b.party_code and a.co_code=b.segment                                                                              
where b.MArginAmt >= a.VAHC                                                               
*/                                    
select a.*,b.MarginAmt from                                                    
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                            
(select segment,party_code,MArginAmt+(Case when balance < 0 then -balance else 0 end) as MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                       
on a.party_code=b.party_code and a.co_code=b.segment                                                                            
where b.MArginAmt >= a.VAHC                                                                
) x where vmss_noncash.party_code=x.party_Code and vmss_noncash.co_code=x.co_Code                                                
                                                                  
/*---- Partial NonCash Getting adjusted against Margin */                                                       
                                          
                                                         
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex from                                                                               
/* (select * from #p9_file1 where marginAmt > 0 ) a  left outer join             */                                                            
(select                       
processDate,Entity,segment,Party_code,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,                                                   
(Case when Balance < 0 then MarginAmt-Balance else MArginAmt end) as MarginAmt,                                                      
Deposit,CashColl,NonCashColl,Holding_total,Holding_Approved,OtherDebit,NonCashConsideration,                                                      
Net,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,SquareOffValue,MgnAdjNonCash,MgnAdjNonLed                                                      
from #p9_file1 where segment in ('NSEFO','MCD','NSX')) a  left outer join                                                     
(select co_code,party_code from vmss_noncash where MarginSqOffQty <> 0 group by party_code,Co_Code) b                                                                              
on a.party_code=b.party_code and a.segment=b.co_Code                                                                              
join (select co_code,party_code from vmss_noncash where MarginSqOffQty = 0 group by party_code,Co_Code) c                                                                              
on a.party_code=c.party_code and a.segment=c.co_Code                                                                              
where b.Party_Code is null                                                                              
                                                    
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                               
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0,@segment as varchar(10) = ''                                                                                
                                                
select @totctr=MAX(srno) from #p9_filex                                                                
                                                                  
While @ctr <= @totctr                                                                                                  
Begin                    
                                                                             
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=MarginAmt,@segment=segment from #p9_filex where srno=@ctr                                                                 
                     
select ROW_NUMBER() OVER (ORDER BY b.seqid,FinalAmount desc) AS [SrNo],                                                           
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,MarginHC as HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,                                                                              
clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty                                                                              
into #p9_holdadj from vmss_noncash a join                                                                                        
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                             
where party_code=@pcode and Clsrate > 0 and MarginHC < 100 and co_Code=@segment                             
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                        
set @TSqOffVal=0                                                                                  
                                                                  
set @Xctr=1                                                                                        
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                           
BEGIN                                                                     
                                                                         
select @TSqOffVal=FinalAmount,@qty=Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                
set @TSqOffVal=@SqOffVal                                                                                             
                                                                  
      
update vmss_noncash                                                                                        
set MarginSqOffQty=ceiling(Case when @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) <= @qty                                             
then @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) else @qty end)                                                                                    
where id=@id  and  MarginHC < 100                                                           
                                                                                  
set @SqOffVal=@SqOffVal-@TSqOffVal                                                                          
set @Xctr=@Xctr+1                                                                                                  
      
END                                                                                                  
                                 
DROP TABLE #p9_holdadj                                                                                                  
                                                                                        
set @ctr=@ctr+1                                
end                                                                                                  
         
drop table #p9_filex                                                                                                  
                                                                  
/* Calculation Margin Adjusted with NonCash */                                                                                                  
                                                                  
/*    
update #p9_file1 set MgnAdjNonCash=(Case when MarginAmt-(NonCashColl+CashColl) < 0 then MarginAmt else (NonCashColl+CashColl) end)                                                                          
where segment in ('NSEFO','MCD','NSX')                                                                                                  
*/                                                                              
                                                                  
update #p9_file1 set MgnAdjNonCash=B.AdjWithMargin from                                                                              
(                               
select co_Code,party_code,sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) as AdjWithMargin from vmss_noncash                                                                               
group by co_Code,party_code                                                                              
having sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) > 0                                            
) b where #p9_file1.party_code=b.party_Code and #p9_file1.segment=b.co_Code                                                        
                                                                                      
/* Calculation Margin Adjusted with Ledger Credit */                                                                                                  
update #p9_file1 set MgnAdjNonLed=(Case                                                 
when Balance > (MarginAmt-MgnAdjNonCash) and MarginAmt-MgnAdjNonCash > 0 and balance > 0 then (MarginAmt-MgnAdjNonCash)                                                                                        
when Balance <= (MarginAmt-MgnAdjNonCash) and balance > 0 then Balance                                                                                                  
else 0 end) where segment in ('NSEFO','MCD','NSX')                                                                   
                                             
                                       
                                                                                   
update  #p9_File2 set NSEFO_JV=b.AdjWithLedgerCr /*,NSEFO_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                                                              
  
  
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                   
from #p9_file1 where segment='NSEFO' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                                                     
                
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr /*,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                      
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                     
from #p9_file1 where segment='NSX' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                   
/*                                                                              
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                                
(              
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                          
from #p9_file1 where segment='NSX'                                                                                                     
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                
*/                                                                               
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                             
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                
from #p9_file1 where segment='MCD' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                    
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                   
/*                                                                                                                 
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                                
(                                                                                                    
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                     
from #p9_file1 where segment='MCD'                                                                                                     
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                           
*/                                                                                                        
                                                                  
UPDATE #p9_File2 SET NSEFO_JV=-vARmARGINsHORTFALL  WHERE NSEFO_JV > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV > 0                                        
UPDATE #p9_File2 SET mcd_jv=-vARmARGINsHORTFALL-NSEFO_jv  WHERE mcd_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv >= 0            
  
   
UPDATE #p9_File2 SET NSX_jv=-VARMARGINSHORTFALL-NSEFO_JV-mcd_jv  WHERE nsx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv >= 0                                                      
                                                                   
UPDATE #p9_File2 SET NSEFO_JV=0 where NSEFO_JV<0                                                                                        
UPDATE #p9_File2 SET mcd_jv=0 where mcd_jv<0                                                                                        
UPDATE #p9_File2 SET NSX_jv=0 where NSX_jv<0                              
                                                                                                    
/* Adjust VarMArgin Shortage with NonCash Collateral */                                                                              
                                      
update vmss_NonCash set FinalAmount=Amount*(Haircut/100.00)                                                   
                                                                  
/*----- NSEFO-----*/                                         
                                                                  
set @totctr  = 0                          
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                        
set @Xctr = 1                                                                              
SET @qty = 0                             
set @TSqOffVal = 0                                                                                  
set @SqQty = 0                                                                    
set @clsrate =0                                                                                  
set @id = 0                                                                               
                                                            
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex1                                                                              
from                                                                        
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv as VarMarginShortFallAftJV from #p9_file2 where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSEFO' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                                                                     
select @totctr=MAX(srno) from #p9_filex1                                                                                                  
                                                                    
While @ctr <= @totctr                                                        
Begin                                                                                                  
                           
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex1 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                             
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                   
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj1                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                               
where party_code=@pcode and Clsrate > 0 and co_code='NSEFO' and haircut < 100                                              
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj1                                                                                                   
set @TSqOffVal=0          
set @Xctr=1                                                             
      
      
                        
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN                                                                      
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj1 where srno=@xctr                                                              
                         
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                                                                  
                                                            
update VMSS_NonCash                                                                           
set                                         
/* SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                        
SqOffseq=@xctr                                                                                     
where id=@id  and  Haircut < 100                                                                                          
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                  
      
set @Xctr=@Xctr+1          
      
                                                                                              
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj1                                                                                        
                                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                    
                                                                                       
update #p9_file2 set NSEFO_noncash=B.AdjustedAmt FROM                                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSEFO' and SquareOffQty > 0                                                                           
group by party_Code      
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                              
                                                                 
/*------ NSX ----*/                                                                
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                        
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                      
set @SqQty = 0                                                                      
set @clsrate =0                                                           
set @id = 0                                                                               
                                                   
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex2                                                                     
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash as VarMarginShortFallAftJV from #p9_file2                     
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSX' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                              
select @totctr=MAX(srno) from #p9_filex2                                                                                                  
                                                                                        
While @ctr <= @totctr                                                                                              
Begin                                                                                                  
                                                                          
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex2 where srno=@ctr                                                                              
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj2                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='NSX'  and haircut < 100                             
                                       
select @Xtotctr=MAX(Srno) from #p9_holdadj2                                                                                                   
set @TSqOffVal=0                                                                                         
                                                                  
set @Xctr=1                                                           
          
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN             
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj2 where srno=@xctr                       
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                               
                                                                  
update VMSS_NonCash                                                                              
/*set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                                        
SqOffseq=@xctr                                                                                  
where id=@id and Haircut < 100      
           
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                                                  
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj2                                                                                                  
                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                                              
drop table #p9_filex2                                                                                
                                                        
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSX' and SquareOffQty > 0                                               
group by party_Code                                                              
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                              
                                                                   
                                                                  
/*------ MCD ----*/                                                                              
                   
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                
set @SqQty = 0                                                                                  
set @clsrate =0                                                                                  
set @id = 0                                
                                        
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex3                                                                              
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash as VarMarginShortFallAftJV from #p9_file2                                                                               
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash < 0) a join                                            
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='MCD' group by party_code) c                                      
on a.party_code=c.party_code                                            
                                                                     
select @totctr=MAX(srno) from #p9_filex3                                                     
                                    
While @ctr <= @totctr                                                                                                  
Begin                          
                                                                
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex3 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj3                                                                  
from VMSS_NonCash_BalAfterMargin a join              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='MCD' and haircut < 100                                                                                                
                                         
select @Xtotctr=MAX(Srno) from #p9_holdadj3                               
set @TSqOffVal=0                                                                                                  
                                                                  
set @Xctr=1                                                 
                                                                     
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                               
BEGIN                                                                                                  
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj3 where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal               
                                                                  
update VMSS_NonCash                                                                                        
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),             
SqOffseq=@xctr                                                                                     
where id=@id and Haircut < 100                                                                                          
          
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                         
END                                                        
                                                                                        
DROP TABLE #p9_holdadj3                                                                                                  
                         
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                     
drop table #p9_filex3                                                                                
                                                                  
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                                 (                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                              
from VMSS_NonCash_BalAfterMargin where co_Code='MCD' and SquareOffQty > 0                                                                           
group by party_Code                                                            
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE      
                                                                  
/*----*/                                                                              
UPDATE #p9_File2 SET NSEFO_NONCASH=0,MCD_NONCASH=0,NSX_NONCASH=0                                                                                                                 
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL = 0 AND vARmARGINsHORTFALL < 0                                                                                    
                                                                  
/*                                                                               
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)                                                                          
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                                                 
AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                                                     
                                                                                                 
UPDATE #p9_FILE2 SET MCD_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET MCD_NONCASH=Stage                                                                                                                
UPDATE #p9_FILE2 SET Stage=0                                                             
                                             
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)                                                                                                                
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                                                                                                                
AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)*-1                                                       
                                                                                                     
UPDATE #p9_FILE2 SET NSX_NONCASH=0                                                       
UPDATE #p9_FILE2 SET NSX_NONCASH=Stage                                                                                                             
UPDATE #p9_FILE2 SET Stage=0                                                                                     
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)                                                                                                               
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                                                                                                               
AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)*-1                                                                                                                
                                                                             
UPDATE #p9_FILE2 SET NSEFO_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET NSEFO_NONCASH=Stage                                                          
UPDATE #p9_FILE2 SET Stage=0                                                                                                                
*/                                                                              
                                  
update #p9_File2  set VarMarginShortFall_AftAdjCurrDay=vARmARGINsHORTFALL+NSefo_jv+MCD_JV+NSX_JV+NSEFO_NONCASH+MCD_NONCASH+NSX_NONCASH                                                                                         
where  vARmARGINsHORTFALL < 0                                                                                                                 
        
update #p9_File2  set VarMarginShortFall_AftAdj=VarMarginShortFall_AftAdjCurrDay        
        
/*        
--- Used to compute min of last 4 days for squareoff.. not required as per PRMS id: 10391261 dt...14/08/2015...        
update #p9_File2 set VarMarginShortFall_AftAdj=(Case when #p9_File2.VarMarginShortFall_AftAdjCurrDay > q.VarMarginShortFall_AftAdjCurrDay                   
then #p9_File2.VarMarginShortFall_AftAdjCurrDay else q.VarMarginShortFall_AftAdjCurrDay end)                  
from                  
(                  
select Party_code,MAX(VarMarginShortFall_AftAdjCurrDay) as VarMarginShortFall_AftAdjCurrDay                   
from vmss_Data x join                  
(select top 3 processdate from (select distinct processdate from vmss_Data where processdate < @BSElastBillDate) a order by processdate) y                   
on x.processdate=y.processdate                               
group by party_code                  
) q where #p9_File2.party_code=q.party_code                  
*/          
                                      
/* Var Margin % */                                                                                  
                                                                                     
truncate table vmss_holding                                                                        
insert into vmss_holding                                                                                                      
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate)                                                
          
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,                                                                                                      
SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS [SrNo],0,ISIN,ActualSqOffQty=CONVERT(int,0),0.00 from #p9_hold                                                                                                      
                                                                        
/*                                                                                                    
select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #p9_filex                                                                                                       
from #p9_file2 where VarMarginShortFall_AftAdj < 0                
                                                                                
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                                                                      
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                                                                      
                                                                 
select @totctr=MAX(srno) from #p9_filex                                                                                                      
                                                                                           
While @ctr <= @totctr                                                                                                      
Begin                                                                                               
                                                                   
set @SqOffVal=0                                                              
select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdj*-1 from #p9_filex where srno=@ctr                                                                                                                      
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],* into #p9_holdadj from vmss_holding a join                                                                                                      
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                             
where party_code=@pcode and Clsrate > 0                                                                                    
                                                                                
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                                                     
set @TSqOffVal=0                                                                                                      
                                                                
set @Xctr=1                                                                                          
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                     
BEGIN                                                                                          
                                                                              
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                             
                                                  
if (@SqOffVal<@TSqOffVal)                                                              
set @TSqOffVal=@SqOffVal                                                                                                      
                                                              
update vmss_holding                                                                               
set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                                                       
SqOffseq=@xctr                                                                                         
where id=@id                                                                                
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                      
                      
set @Xctr=@Xctr+1                                                                                                      
END                                                                                                      
                                                                                           
DROP TABLE #p9_holdadj                                            
                                                                                           
set @ctr=@ctr+1                                            
end                                                                                                      
                                                                                          
drop table #p9_filex                                                                                                      
                                                                
truncate table vmss_holding_hist                                                                                                       
insert into vmss_holding(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq)                                                         
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq from vmss_holding                                                                                   
  
  
    
      
        
        
        
         
                                                                                        
update #p9_file2 set SquareOffValue=b.SqVal from                                                              
(                                                                                            
select party_code,sum(SquareOffQty*Clsrate) as SqVal from vmss_holding where isnull(SquareOffQty,0) > 0                                                                                       
group by party_code                                                                                            
) b                
where #p9_file2.party_code=b.party_Code                                                                                                      
*/                                                                                    
                                                                                        
/*                                                                                                            
update #p9_File2 set SquareOffValue=                                                                                                                
Case when (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 < (Holding_BHC)*-1 then (Holding_BHC)*-1                                                                                                                
else (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 end                                      
where LeverageMultiplier > 0                                                                                                                
*/                                                                                                      
                                                                               
/*                                                                              
UPDATE #p9_File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                             
(                                                                                  
SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                                                                           
(                                                                                     
SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                             
WHERE CONVERT(DATE,processdate) < (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data )                                                    
)                                                                                                                                          
) B WHERE #p9_File2.party_code=B.party_code                                                                                                        
                                                                                   
UPDATE #p9_File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                                            
              
*/                                                                                       

/*  
delete a from #p9_FILE2 a left outer join VMSS_ASB7_Days b on a.party_code=b.Party_code   
WHERE b.Party_code is null  
*/
  
delete from VMSS_data where processDate=@BSElastBillDate                                                                                                                
                                                                                           
insert into VMSS_data(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,                                                                                                      
Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,                                                                                                         
NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,remarks,DP_adj,Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                                                                           
   
SELECT processDate,Entity,A.Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,                                                                                                                
OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,                                                  
VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,GETDATE(),'V','',DP_adj,0.00,VarMarginShortFall_AftAdjCurrDay                                                                                                            
FROM #p9_FILE2 A inner join mis.dbo.asb7_clidetails_crdet  B on A.Party_code=B.party_code where B.SQ_AMT> 0                                                                                                                
and B.T_day>0 and  rms_date=(select max(rms_date)from  mis.dbo.asb7_clidetails_crdet)                                                                   

/*                                                                                
insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                        
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks)                                                                                   
  
  
select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                                            
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks from VMSS_data                                                                     
  
  
*/                                                                  
                                                                        
End try                                                                                                                                     
BEGIN CATCH                                                                                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                              
  select GETDATE(),'VMSS_Calculation_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                                                                                   
                          
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                              
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                                                     
                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Calculation_NoNRMS_bkup_29052020
-- --------------------------------------------------
create Procedure [dbo].[VMSS_Calculation_NoNRMS_bkup_29052020]                                                                                                      
as                                                                                                                
                                                                                                                
SET XACT_ABORT ON                                                                                                                
Set nocount on                                                                                                                
BEGIN TRY                                                                                                                                        
  
 exec VMSS_upd_ASB7_Days    
                                                                             
 Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                                                                
 Declare @LowerCapNonCash as money = 500  /* NONCASH COLLATERAL MOVEMENT : always +ve */                                                                                                                
 Declare @BSElastBillDate datetime = (select MAX(vdt)+1 from anand1.account.dbo.ledger WITH(NOLOCK) where vtyp=15 and vdt <=convert(varchar(11),getdate()) and narration like 'SETTNO=_______NSECMNBill Posted')                                                                                                                
                                                                                                          
 select                                                                                                                 
 @BSElastBillDate  as processDate,                                                                                                                
 b.Entity,                                                                                                                
 b.segment,                                                                                                                
 a.Party_code,                                                                                                                
 a.Ledger as Balance,                                                                                                                
 CONVERT(money,0)  as UnsettledCr,                                                                                                                
 CONVERT(money,0) as UnsettledDr,                                                                                                                
 a.Unrecosiled_Credit as UnrecoAmt,                                                                                                                
 CONVERT(money,0) as ShortSellValue,                                                                                                                
 a.Imargin as MarginAmt,                                                                                                                
 a.Deposit,                                                                                                                
a.Cash_Colleteral as CashColl,                                                                                                                
a.NonCash_Colleteral as NonCashColl,                                                                                                                
Holding_total,                                                                                                                
Holding_Approved,                                                                                                                
CONVERT(money,0) as OtherDebit,                                                      
CONVERT(int,0) as NonCashConsideration,          
CONVERT(money,0) as Net,   
CONVERT(money,0) as EarlyPayinValue,                    
CONVERT(money,0) as LeverageMultiplier,                            
CONVERT(money,0) as VarMarginShortFall,                                                                
CONVERT(money,0) as SquareOffValue,                                    
CONVERT(money,0) as MgnAdjNonCash,                                                       
CONVERT(money,0) as MgnAdjNonLed                                                                  
into #p9_File1                                                     
from (select * from General.dbo.RMS_DtClFi with (nolock) where 1=2) a join (select segment,entity from intranet.cms.dbo.ncms_entity with (nolock) where entity='Equity') b                                                                      
on a.Co_code=b.segment                                                                       
                                                                                                       
                                                                                                       
 /* update Holding */                                                                                                      
select EXCHANGE,sett_no,SEtt_type,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,Party_code,Qty,                                                                            
CLSRATE,                                                                                                                
Total AS VBHC,                                                                              
CONVERT(MONEY,0) AS HAIRCUT,                                                                                                                
CONVERT(MONEY,0) AS VAHC,                                                                                                    
SPACE(10) AS CATEGORY,                                                                                                                
source AS SRC,                                                                        
ISIN                                                                        
INTO #p9_HOLD                                                                                                                
from vmss_rms_holding where source in ('SI','SO','H','D')                    
  
update #p9_HOLD set series=b.NseSeries from general.dbo.scrip_master b  
where #p9_HOLD.isin=b.isin and b.NseSeries='EQ'   
  
                    
SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0          
DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin          
DROP TABLE #nqty          
                                                                                                       
update #p9_HOLD set clsrate=b.rate from General.dbo.cp_bsecm b where #p9_HOLD.scrip_Cd=b.scode and #p9_HOLD.clsrate=0                                                                                                                
                    
update #p9_HOLD set clsrate=b.cls                                                                                                                 
from General.dbo.cp_nsecm b                                                                                                       
where #p9_HOLD.scrip_Cd=b.scrip and #p9_HOLD.series=b.series and #p9_HOLD.clsrate=0 and exchange='NSECM'                                                                                                              
                    
update #p9_HOLD set VBHC=clsrate*Qty                                                                                           
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                    
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                               
where #p9_HOLD.SCRIP_cD=B.BSECODE AND #p9_HOLD.EXCHANGE='BSECM'                                                                                                                
    
    
/*Added to handle scrip:idfc ltd as it has shifted from BE to Eq as suggested by Vishal Gohil on Dec 10 2015*/    
--select * from #p9_HOLD where  isin='INE092T01019' and series='EQ'    
--update #p9_HOLD set series='EQ' where isin='INE092T01019' and series='BE'    
    
/* update a set series=b.Currenteries from #p9_HOLD a inner join VMSS_Exception_NSESeries b on a.isin=b.isin and a.series=b.previousseries  */  
    
/*******************************************************************/    
    
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                  
where #p9_HOLD.SCRIP_cD=B.NSESYMBOL AND #p9_HOLD.SERIES=B.NSESERIES AND #p9_HOLD.EXCHANGE='NSECM'                                                              
      
                    
update #p9_HOLD set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #p9_HOLD set VAHC=VBHC*((100-HAIRCUT)/100.00)                                                  
                    
insert into #p9_File1(segment,party_code)                                                              
select b.co_code,party_Code from                                                                                                      
/*(select party_code from #p9_hold group by party_code) a,*/ 
(select t_day,party_code from  mis.dbo.asb7_clidetails_crdet --commented on Aug 26 2016  as required by Vishal Gohil mail dated Aug 24 2016 
 where T_day>0 and  
 rms_date=(select max(rms_date)from  mis.dbo.asb7_clidetails_crdet)) a,                                                                                                      
(select * from General.dbo.company where entitytype='EQ' and bo_active=1) b                                                                                                      
                                                                                                      
update #p9_file1                                                                 
set entity='EQUITY',ProcessDate=@BSElastBillDate,Balance=0,UnsettledCr=0,UnsettledDr=0,UnrecoAmt=0,ShortSellValue=0,                                                                                       
MarginAmt=0,Deposit=0,CashColl=0,NonCashColl=0,Holding_total=0,Holding_Approved=0,OtherDebit=0,NonCashConsideration=0,Net=0,                                                                                                      
EarlyPayinValue=0,LeverageMultiplier=0,VarMarginShortFall=0,SquareOffValue=0                                                                                                      
                                                                                       
update #p9_File1 set holding_total=b.VBHC,holding_approved=b.VAHC from                                                                 
(select party_code,exchange,VBHC=sum(VBHC),VAHC=sum(VAHC)                                                                                                                
from #p9_hold group by party_code,exchange) b                                                                       
where #p9_File1.party_code=b.party_code and #p9_File1.segment=b.exchange                                                                              
                                                                                                      
/* Get Last settlement Date */                                                                                                     
                                                                                      
 Declare @sdtcur as datetime,-- @ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59'                                                                                                        
 @ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'                                  
 select @sdtcur=sdtcur from General.dbo.parameter with (nolock) where sdtcur <= @ToDate and ldtcur >=@ToDate                                           
                                       
/* Fetch effective Ledger Balance - Only Bill's effective date else voucher date*/                                 
                
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
 into #p9_BSECM                                                                                                                
 from anand.account_ab.dbo.ledger a with (nolock)                                                                                       
 where ( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and  vDT>=@sdtcur and vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                           
 group by cltcode                                     
                                                                                   
 select CLTCODE,                                                                                                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                           
 into #p9_NSECM                                                                                                                
from anand1.account.dbo.ledger a with (nolock)                                                                                                                       
 where ( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and vDT>=@sdtcur and  vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                                                       
 group by cltcode                                                                                                                    
                                                 
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                 
 into #p9_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                                                       
 /* where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end) */                                                                                                           
 where ( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                                 
 select CLTCODE,                                                                          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_NSX                         
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                                                       
 where ( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS')and vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                               
select CLTCODE,                                                
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
into #p9_MCD                                                                                                    
from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)          
where ( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
group by cltcode                                                                                                                    
                                                                                                  
 /* Fetch Deposit */                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                 
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                    
 into #p9_dep_BSECM                                                                                                                
 from anand.account_ab.dbo.ledger a with (nolock)                                                                        
 where ( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                      
 group by cltcode                                              
                                    
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSECM from anand1.account.dbo.ledger a with (nolock)                                                           
 where ( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                      
                                                                                                                
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                       
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                     
 where ( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS')and vDT>=@sdtcur and vdt <= @ToDate and cltcode like '40%'                                                                                                                      
 group by cltcode                                                                                       
                                                                  
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                         
 into #p9_dep_NSX                                                                                                                
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                   
 where ( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                              
 group by cltcode                                       
                                                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                   
 into #p9_dep_MCD                        
 from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                                   
 where ( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                                                
                                                                         
 update #p9_File1 set Balance=b.Vbal from #p9_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                                                      
 update #p9_File1 set Balance=b.Vbal from #p9_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                            
                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                          
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                                                                          
                                                                                                      
 update #p9_File1 set Earlypayinvalue=b.EPV from                      
 (select Exchange,party_code,SUM(total) as EPV from VMSS_EarlyPayinData group by Exchange,party_code) b          
 where #p9_File1.party_code=b.party_Code and #p9_File1.segment=b.exchange                                                                                              
                                                                                                                 
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                             
 (           
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelfo.nsefo.dbo.tbl_clientmargin with (nolock)                                                        
 where MarginDate = (select MAX(margindate) from angelfo.nsefo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                   
  ) b                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSEFO'                                                                                                      
                                                                                                      
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                            
 (                                                                                                      
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                                   
 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                         
  ) b                                                                                                       
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCD'                                                                                           
                                                                                        
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                      
 (                                                                             
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                      
 from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock)                                                                                                      
 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                          
) b                                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSX'                                                                                                      
                                                                              
 update #p9_File1 set NonCashColl=b.NonCashColl                                         
 from VMSS_Client_collateral_NonEquity_NoBrInfo b                                                
 where #p9_File1.party_code=b.party_code and #p9_file1.segment=b.co_code                                                                                 
                                                                
/* Excess Collateral adjustement with Ledger Debit */            
 update #p9_File1 set NonCashColl=NonCashColl+Balance                                                                                                     
 where NonCashColl > 0 and Balance < 0 and segment in ('NSEFO','MCD','NSX')                                                               
                                                                               
 /* GEnerate Summarised Data */                    
                                                           
delete from #p9_file1 where party_code in (select party_code from mis.sccs.dbo.Combine_legal)                                                              
delete from #p9_file1 where party_code in (select party_code from General.dbo.client_Details where (branch_cd='NRIS' or sub_broker='BH'))                          
                        
/*Remove Tday and T+1 day clients ,added by abha as suggested by vishal gohil*/                           
                        
delete from #p9_file1 where party_code in (select Party_Code         
from General.dbo.SQUAREUP_CLIENT_ALERT where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT_ALERT))           
/* -----T day------ */        
        
          
                             
delete from #p9_file1 where party_code in (select party_Code from General.dbo.SQUAREUP_CLIENT         
where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT))            
/*------T+1day --------*/        
        
          
                                                                                     
select                                                                                                                 
max(processDate) as processDate,Entity,Party_code,convert(int,1) as NoofDays,                                                                                                                
sum(Balance) as Balance,sum(MarginAmt) as MarginAmt,sum(Deposit) as Deposit,                                               
sum(CashColl) as CashColl,sum(NonCashColl) as NonCashColl,sum(Holding_total) as Holding_BHC,                                                                                                   
sum(Holding_Approved) as Holding_AHC,sum(OtherDebit) as OtherDebit,                                                
sum(EarlyPayinValue) as EarlyPayinValue,sum(LeverageMultiplier) as LeverageMultiplier,                                                                                               
sum(VarMarginShortFall) as VarMarginShortFall,                                 
Convert(money,0) as NSEFO_JV,                                                                                                                
Convert(money,0) as NSEFO_NonCash,                                                                                                                
Convert(money,0) as MCD_JV,                                                                                               
Convert(money,0) as MCD_NonCash,                                                                                                                
Convert(money,0) as NSX_JV,                                                                                                                
Convert(money,0) as NSX_NonCash,                                                              
Convert(money,0) as VarMarginShortFall_AftAdj,                                                                                               
Convert(money,0) as Stage,                                                                                                                
sum(SquareOffValue) as SquareOffValue,Sum(Case when Segment='BSECM' then BAlance else 0 end) as BSECM_Balance,                                                                                                                 
Sum(Case when Segment='NSECM' then BAlance else 0 end) as NSECM_Balance,                                                         
Convert(money,0) as DP_adj ,                
Convert(money,0) as VarMarginShortFall_AftAdjCurrDay                                                     
into #p9_file2                                                                                                                
from #p9_file1 where segment in ('BSECM','NSECM')                                                                                                                
group by Entity,Party_code                                       
                                                           
/* delete Client with Cash Credit effective Balance */                                                                                                       
                                                              
Delete from #p9_file2 where balance >= @LowerCapAmt                          
Delete from #p9_file2 where party_code in (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF'))                                                                                  
Delete from #p9_file1 where party_Code not in (select party_code from #p9_file2)                                                                              
/*Delete from #p9_file2 where Holding_BHC <= 0 */ --commented on Aug 26 2016  as required by Vishal Gohil mail dated Aug 24 2016                                                    
                                  
update #p9_File2 set VarMarginShortFall=(case when Holding_AHC+Balance+Deposit+EarlypayinValue < @LowerCapAmt then Holding_AHC+Balance+Deposit+EarlypayinValue  else 0 end)                                                                                   
  
                                          
update #p9_File2 set LeverageMultiplier=                                                                                                                
Case when 100-(Holding_AHC/Holding_BHC)*100.00 > 100 then 100 else 100-(Holding_AHC/Holding_BHC)*100.00 end                                                                                                                
where Holding_BHC > 0                                                                                                  
                                                                          
update #p9_file1 set MgnAdjNonCash=0 where MgnAdjNonCash is null                                                                                            
update #p9_file1 set MgnAdjNonLed=0 where MgnAdjNonLed is null                                                    
                        
/* Adj.Margin with Non_Cash Scripwise */                                                                       
                                      
update vmss_NonCash set FinalAmount=Amount-(Amount*(MarginHC/100.00))                                              
update vmss_noncash set MarginSqOffQty=0                                                    
/*---- Full NonCash Getting adjusted against Margin */                                                                              
update vmss_noncash set MarginSqOffQty=Qty from                                                                              
(                                                                              
/*                                                              
select a.*,b.MarginAmt from                                                                              
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                              
(select segment,party_code,MArginAmt from #p9_file1 where MArginAmt > 0) b                        
on a.party_code=b.party_code and a.co_code=b.segment                                                                              
where b.MArginAmt >= a.VAHC                                                               
*/                                    
select a.*,b.MarginAmt from                                                    
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                            
(select segment,party_code,MArginAmt+(Case when balance < 0 then -balance else 0 end) as MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                       
on a.party_code=b.party_code and a.co_code=b.segment                                                                            
where b.MArginAmt >= a.VAHC                                                                
) x where vmss_noncash.party_code=x.party_Code and vmss_noncash.co_code=x.co_Code                                                
                                                                  
/*---- Partial NonCash Getting adjusted against Margin */                                                       
                                          
                                                         
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex from                                                                               
/* (select * from #p9_file1 where marginAmt > 0 ) a  left outer join             */                                                            
(select                       
processDate,Entity,segment,Party_code,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,                                                   
(Case when Balance < 0 then MarginAmt-Balance else MArginAmt end) as MarginAmt,                                                      
Deposit,CashColl,NonCashColl,Holding_total,Holding_Approved,OtherDebit,NonCashConsideration,                                                      
Net,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,SquareOffValue,MgnAdjNonCash,MgnAdjNonLed                                                      
from #p9_file1 where segment in ('NSEFO','MCD','NSX')) a  left outer join                                                     
(select co_code,party_code from vmss_noncash where MarginSqOffQty <> 0 group by party_code,Co_Code) b                                                                              
on a.party_code=b.party_code and a.segment=b.co_Code                                                                              
join (select co_code,party_code from vmss_noncash where MarginSqOffQty = 0 group by party_code,Co_Code) c                                                                              
on a.party_code=c.party_code and a.segment=c.co_Code                                                                              
where b.Party_Code is null                                                                              
                                                    
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                               
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0,@segment as varchar(10) = ''                                                                                
                                                
select @totctr=MAX(srno) from #p9_filex                                                                
                                                                  
While @ctr <= @totctr                                                                                                  
Begin                    
                                                                             
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=MarginAmt,@segment=segment from #p9_filex where srno=@ctr                                                                 
                     
select ROW_NUMBER() OVER (ORDER BY b.seqid,FinalAmount desc) AS [SrNo],                                                           
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,MarginHC as HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,                                                                              
clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty                                                                              
into #p9_holdadj from vmss_noncash a join                                                                                        
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                             
where party_code=@pcode and Clsrate > 0 and MarginHC < 100 and co_Code=@segment                             
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                        
set @TSqOffVal=0                                                                                  
                                                                  
set @Xctr=1                                                                                        
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                           
BEGIN                                                                     
                                                                         
select @TSqOffVal=FinalAmount,@qty=Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                
set @TSqOffVal=@SqOffVal                                                                                             
                                                                  
      
update vmss_noncash                                                                                        
set MarginSqOffQty=ceiling(Case when @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) <= @qty                                             
then @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) else @qty end)                                                                                    
where id=@id  and  MarginHC < 100                                                           
                                                                                  
set @SqOffVal=@SqOffVal-@TSqOffVal                                                                          
set @Xctr=@Xctr+1                                                                                                  
      
END                                                                                                  
                                 
DROP TABLE #p9_holdadj                                                                                                  
                                                                                        
set @ctr=@ctr+1                                
end                                                                                                  
         
drop table #p9_filex                                                                                                  
                                                                  
/* Calculation Margin Adjusted with NonCash */                                                                                                  
                                                                  
/*    
update #p9_file1 set MgnAdjNonCash=(Case when MarginAmt-(NonCashColl+CashColl) < 0 then MarginAmt else (NonCashColl+CashColl) end)                                                                          
where segment in ('NSEFO','MCD','NSX')                                                                                                  
*/                                                                              
                                                                  
update #p9_file1 set MgnAdjNonCash=B.AdjWithMargin from                                                                              
(                               
select co_Code,party_code,sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) as AdjWithMargin from vmss_noncash                                                                               
group by co_Code,party_code                                                                              
having sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) > 0                                            
) b where #p9_file1.party_code=b.party_Code and #p9_file1.segment=b.co_Code                                                        
                                                                                      
/* Calculation Margin Adjusted with Ledger Credit */                                                                                                  
update #p9_file1 set MgnAdjNonLed=(Case                                                 
when Balance > (MarginAmt-MgnAdjNonCash) and MarginAmt-MgnAdjNonCash > 0 and balance > 0 then (MarginAmt-MgnAdjNonCash)                                                                                        
when Balance <= (MarginAmt-MgnAdjNonCash) and balance > 0 then Balance                                                                                                  
else 0 end) where segment in ('NSEFO','MCD','NSX')                                                                   
                                             
                                       
                                                                                   
update  #p9_File2 set NSEFO_JV=b.AdjWithLedgerCr /*,NSEFO_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                                                              
  
  
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                   
from #p9_file1 where segment='NSEFO' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                                                     
                
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr /*,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                      
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                     
from #p9_file1 where segment='NSX' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                   
/*                                                                              
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                                
(              
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                          
from #p9_file1 where segment='NSX'                                                                                                     
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                
*/                                                                               
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                             
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                
from #p9_file1 where segment='MCD' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                    
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                   
/*                                                                                                                 
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                                
(                                                                                                    
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                     
from #p9_file1 where segment='MCD'                                                                                                     
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                           
*/                                                                                                        
                                                                  
UPDATE #p9_File2 SET NSEFO_JV=-vARmARGINsHORTFALL  WHERE NSEFO_JV > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV > 0                                        
UPDATE #p9_File2 SET mcd_jv=-vARmARGINsHORTFALL-NSEFO_jv  WHERE mcd_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv >= 0            
  
   
UPDATE #p9_File2 SET NSX_jv=-VARMARGINSHORTFALL-NSEFO_JV-mcd_jv  WHERE nsx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv >= 0                                                      
                                                                   
UPDATE #p9_File2 SET NSEFO_JV=0 where NSEFO_JV<0                                                                                        
UPDATE #p9_File2 SET mcd_jv=0 where mcd_jv<0                                                                                        
UPDATE #p9_File2 SET NSX_jv=0 where NSX_jv<0                              
                                                                                                    
/* Adjust VarMArgin Shortage with NonCash Collateral */                                                                              
                                      
update vmss_NonCash set FinalAmount=Amount*(Haircut/100.00)                                                   
                                                                  
/*----- NSEFO-----*/                                         
                                                                  
set @totctr  = 0                          
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                        
set @Xctr = 1                                                                              
SET @qty = 0                             
set @TSqOffVal = 0                                                                                  
set @SqQty = 0                                                                    
set @clsrate =0                                                                                  
set @id = 0                                                                               
                                                            
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex1                                                                              
from                                                                        
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv as VarMarginShortFallAftJV from #p9_file2 where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSEFO' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                                                                     
select @totctr=MAX(srno) from #p9_filex1                                                                                                  
                                                                    
While @ctr <= @totctr                                                        
Begin                                                                                                  
                           
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex1 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                             
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                   
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj1                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                               
where party_code=@pcode and Clsrate > 0 and co_code='NSEFO' and haircut < 100                                              
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj1                                                                                                   
set @TSqOffVal=0          
set @Xctr=1                                                             
      
      
                        
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN                                                                      
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj1 where srno=@xctr                                                              
                         
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                                                                  
                                                            
update VMSS_NonCash                                                                           
set                                         
/* SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                        
SqOffseq=@xctr                                                                                     
where id=@id  and  Haircut < 100                                                                                          
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                  
      
set @Xctr=@Xctr+1          
      
                                                                                              
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj1                                                                                        
                                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                    
                                                                                       
update #p9_file2 set NSEFO_noncash=B.AdjustedAmt FROM                                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSEFO' and SquareOffQty > 0                                                                           
group by party_Code      
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                              
                                                                 
/*------ NSX ----*/                                                                
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                        
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                      
set @SqQty = 0                                                                      
set @clsrate =0                                                           
set @id = 0                                                                               
                                                   
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex2                                                                     
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash as VarMarginShortFallAftJV from #p9_file2                     
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSX' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                              
select @totctr=MAX(srno) from #p9_filex2                                                                                                  
                                                                                        
While @ctr <= @totctr                                                                                              
Begin                                                                                                  
                                                                          
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex2 where srno=@ctr                                                                              
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj2                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='NSX'  and haircut < 100                             
                                       
select @Xtotctr=MAX(Srno) from #p9_holdadj2                                                                                                   
set @TSqOffVal=0                                                                                         
                                                                  
set @Xctr=1                                                           
          
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN             
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj2 where srno=@xctr                       
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                               
                                                                  
update VMSS_NonCash                                                                              
/*set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                                        
SqOffseq=@xctr                                                                                  
where id=@id and Haircut < 100      
           
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                                                  
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj2                                                                                                  
                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                                              
drop table #p9_filex2                                                                                
                                                        
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSX' and SquareOffQty > 0                                               
group by party_Code                                                              
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                              
                                                                   
                                                                  
/*------ MCD ----*/                                                                              
                   
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                
set @SqQty = 0                                                                                  
set @clsrate =0                                                                                  
set @id = 0                                
                                        
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex3                                                                              
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash as VarMarginShortFallAftJV from #p9_file2                                                                               
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash < 0) a join                                            
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='MCD' group by party_code) c                                      
on a.party_code=c.party_code                                            
                                                                     
select @totctr=MAX(srno) from #p9_filex3                                                     
                                    
While @ctr <= @totctr                                                                                                  
Begin                          
                                                                
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex3 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj3                                                                  
from VMSS_NonCash_BalAfterMargin a join              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='MCD' and haircut < 100                                                                                                
                                         
select @Xtotctr=MAX(Srno) from #p9_holdadj3                               
set @TSqOffVal=0                                                                                                  
                                                                  
set @Xctr=1                                                 
                                                                     
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                               
BEGIN                                                                                                  
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj3 where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal               
                                                                  
update VMSS_NonCash                                                                                        
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),             
SqOffseq=@xctr                                                                                     
where id=@id and Haircut < 100                                                                                          
          
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                         
END                                                        
                                                                                        
DROP TABLE #p9_holdadj3                                                                                                  
                         
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                     
drop table #p9_filex3                                                                                
                                                                  
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                                 (                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                              
from VMSS_NonCash_BalAfterMargin where co_Code='MCD' and SquareOffQty > 0                                                                           
group by party_Code                                                            
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE      
                                                                  
/*----*/                                                                              
UPDATE #p9_File2 SET NSEFO_NONCASH=0,MCD_NONCASH=0,NSX_NONCASH=0                                                                                                                 
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL = 0 AND vARmARGINsHORTFALL < 0                                                                                    
                                                                  
/*                                                                               
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)                                                                          
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                                                 
AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                                                     
                                                                                                 
UPDATE #p9_FILE2 SET MCD_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET MCD_NONCASH=Stage                                                                                                                
UPDATE #p9_FILE2 SET Stage=0                                                             
                                             
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)                                                                                                                
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                                                                                                                
AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)*-1                                                       
                                                                                                     
UPDATE #p9_FILE2 SET NSX_NONCASH=0                                                       
UPDATE #p9_FILE2 SET NSX_NONCASH=Stage                                                                                                             
UPDATE #p9_FILE2 SET Stage=0                                                                                     
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)                                                                                                               
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                                                                                                               
AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)*-1                                                                                                                
                                                                             
UPDATE #p9_FILE2 SET NSEFO_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET NSEFO_NONCASH=Stage                                                          
UPDATE #p9_FILE2 SET Stage=0                                                                                                                
*/                                                                              
                                  
update #p9_File2  set VarMarginShortFall_AftAdjCurrDay=vARmARGINsHORTFALL+NSefo_jv+MCD_JV+NSX_JV+NSEFO_NONCASH+MCD_NONCASH+NSX_NONCASH                                                                                         
where  vARmARGINsHORTFALL < 0                                                                                                                 
        
update #p9_File2  set VarMarginShortFall_AftAdj=VarMarginShortFall_AftAdjCurrDay        
        
/*        
--- Used to compute min of last 4 days for squareoff.. not required as per PRMS id: 10391261 dt...14/08/2015...        
update #p9_File2 set VarMarginShortFall_AftAdj=(Case when #p9_File2.VarMarginShortFall_AftAdjCurrDay > q.VarMarginShortFall_AftAdjCurrDay                   
then #p9_File2.VarMarginShortFall_AftAdjCurrDay else q.VarMarginShortFall_AftAdjCurrDay end)                  
from                  
(                  
select Party_code,MAX(VarMarginShortFall_AftAdjCurrDay) as VarMarginShortFall_AftAdjCurrDay                   
from vmss_Data x join                  
(select top 3 processdate from (select distinct processdate from vmss_Data where processdate < @BSElastBillDate) a order by processdate) y                   
on x.processdate=y.processdate                               
group by party_code                  
) q where #p9_File2.party_code=q.party_code                  
*/          
                                      
/* Var Margin % */                                                                                  
                                                                                     
truncate table vmss_holding                                                                        
insert into vmss_holding                                                                                                      
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate)                                                
          
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,                                                                                                      
SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS [SrNo],0,ISIN,ActualSqOffQty=CONVERT(int,0),0.00 from #p9_hold                                                                                                      
                                                                        
/*                                                                                                    
select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #p9_filex                                                                                                       
from #p9_file2 where VarMarginShortFall_AftAdj < 0                
                                                                                
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                                                                      
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                                                                      
                                                                 
select @totctr=MAX(srno) from #p9_filex                                                                                                      
                                                                                           
While @ctr <= @totctr                                                                                                      
Begin                                                                                               
                                                                   
set @SqOffVal=0                                                              
select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdj*-1 from #p9_filex where srno=@ctr                                                                                                                      
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],* into #p9_holdadj from vmss_holding a join                                                                                                      
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                             
where party_code=@pcode and Clsrate > 0                                                                                    
                                                                                
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                                                     
set @TSqOffVal=0                                                                                                      
                                                                
set @Xctr=1                                                                                          
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                     
BEGIN                                                                                          
                                                                              
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                             
                                                  
if (@SqOffVal<@TSqOffVal)                                                              
set @TSqOffVal=@SqOffVal                                                                                                      
                                                              
update vmss_holding                                                                               
set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                                                       
SqOffseq=@xctr                                                                                         
where id=@id                                                                                
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                      
                      
set @Xctr=@Xctr+1                                                                                                      
END                                                                                                      
                                                                                           
DROP TABLE #p9_holdadj                                            
                                                                                           
set @ctr=@ctr+1                                            
end                                                                                                      
                                                                                          
drop table #p9_filex                                                                                                      
                                                                
truncate table vmss_holding_hist                                                                                                       
insert into vmss_holding(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq)                                                         
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq from vmss_holding                                                                                   
                                                                                     
update #p9_file2 set SquareOffValue=b.SqVal from                                                              
(                                                                                            
select party_code,sum(SquareOffQty*Clsrate) as SqVal from vmss_holding where isnull(SquareOffQty,0) > 0                                                                                       
group by party_code                                                                                            
) b                
where #p9_file2.party_code=b.party_Code                                                                                                      
*/                                                                                    
                                                                                        
/*                                                                                                            
update #p9_File2 set SquareOffValue=                                                                                                                
Case when (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 < (Holding_BHC)*-1 then (Holding_BHC)*-1                                                                                                                
else (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 end                                      
where LeverageMultiplier > 0                                                                                                                
*/                                                                                                      
                                                                               
/*                                                                              
UPDATE #p9_File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                             
(                                                                                  
SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                                                                           
(                                                                                     
SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                             
WHERE CONVERT(DATE,processdate) < (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data )                                                    
)                                                                                                                                          
) B WHERE #p9_File2.party_code=B.party_code                                                                                                        
                                                                                   
UPDATE #p9_File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                                            
              
*/                                                                                       

/*  
delete a from #p9_FILE2 a left outer join VMSS_ASB7_Days b on a.party_code=b.Party_code   
WHERE b.Party_code is null  
*/
  
delete from VMSS_data where processDate=@BSElastBillDate                                                                                                                
--commented on Mar 16 2020 as required by v gohil
/*select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'*/
                                                                                         
insert into VMSS_data(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,                                                                                                      
Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,                                                                                                         
NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,remarks,DP_adj,Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                                                                           
   
SELECT processDate,Entity,A.Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,                                                                                                                
OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,                                                  
VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,GETDATE(),'V','',DP_adj,0.00,VarMarginShortFall_AftAdjCurrDay                                                                                                            
FROM #p9_FILE2 A 
/*
inner join mis.dbo.ASB7_Clidetails_CrDet_process2  B on A.Party_code=B.party_code
inner join #MTFCodes MTF on A.party_code=mtf.party_code where B.SQ_AMT> 0                                                                                                                
and B.T_day>0 and  rms_date=(select max(rms_date)from  mis.dbo.ASB7_Clidetails_CrDet_process2)  */                                                                 

/*                                                                                
insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                        
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks)                                                                                   
  
  
select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                                            
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks from VMSS_data                                                                     
  
  
*/                                                                  
                                                                        
End try                                                                                                                                     
BEGIN CATCH                                                                                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                              
  select GETDATE(),'VMSS_Calculation_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                                                                                   
                          
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                              
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                                                     
                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Calculation_NoNRMS_bkup01082017
-- --------------------------------------------------
create Procedure [dbo].[VMSS_Calculation_NoNRMS_bkup01082017]                                                                                                      
as                                                                                                                
                                                                                                                
SET XACT_ABORT ON                                                                                                                
Set nocount on                                                                                                                
BEGIN TRY                                                                                                                                        
  
 exec VMSS_upd_ASB7_Days    
                                                                             
 Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                                                                
 Declare @LowerCapNonCash as money = 500  /* NONCASH COLLATERAL MOVEMENT : always +ve */                                                                                                                
 Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                                
                                                                                                          
 select                                                                                                                 
 @BSElastBillDate  as processDate,                                                                                                                
 b.Entity,                                                                                                                
 b.segment,                                                                                                                
 a.Party_code,                                                                                                                
 a.Ledger as Balance,                                                                                                                
 CONVERT(money,0)  as UnsettledCr,                                                                                                                
 CONVERT(money,0) as UnsettledDr,                                                                                                                
 a.Unrecosiled_Credit as UnrecoAmt,                                                                                                                
 CONVERT(money,0) as ShortSellValue,                                                                                                                
 a.Imargin as MarginAmt,                                                                                                                
 a.Deposit,                                                                                                                
a.Cash_Colleteral as CashColl,                                                                                                                
a.NonCash_Colleteral as NonCashColl,                                                                                                                
Holding_total,                                                                                                                
Holding_Approved,                                                                                                                
CONVERT(money,0) as OtherDebit,                                                      
CONVERT(int,0) as NonCashConsideration,          
CONVERT(money,0) as Net,   
CONVERT(money,0) as EarlyPayinValue,                    
CONVERT(money,0) as LeverageMultiplier,                            
CONVERT(money,0) as VarMarginShortFall,                                                                
CONVERT(money,0) as SquareOffValue,                                    
CONVERT(money,0) as MgnAdjNonCash,                                                       
CONVERT(money,0) as MgnAdjNonLed                                                                  
into #p9_File1                                                     
from (select * from General.dbo.RMS_DtClFi with (nolock) where 1=2) a join (select segment,entity from intranet.cms.dbo.ncms_entity with (nolock) where entity='Equity') b                                                                      
on a.Co_code=b.segment                                                                       
                                                                                                       
                                                                                                       
 /* update Holding */                                                                                                      
select EXCHANGE,sett_no,SEtt_type,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,Party_code,Qty,                                                                            
CLSRATE,                                                                                                                
Total AS VBHC,                                                                              
CONVERT(MONEY,0) AS HAIRCUT,                                                                                                                
CONVERT(MONEY,0) AS VAHC,                                                                                                    
SPACE(10) AS CATEGORY,                                                                                                                
source AS SRC,                                                                        
ISIN                                                                        
INTO #p9_HOLD                                                                                                                
from vmss_rms_holding where source in ('SI','SO','H','D')                    
  
update #p9_HOLD set series=b.NseSeries from general.dbo.scrip_master b  
where #p9_HOLD.isin=b.isin and b.NseSeries='EQ'   
  
                    
SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0          
DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin          
DROP TABLE #nqty          
                                                                                                       
update #p9_HOLD set clsrate=b.rate from General.dbo.cp_bsecm b where #p9_HOLD.scrip_Cd=b.scode and #p9_HOLD.clsrate=0                                                                                                                
                    
update #p9_HOLD set clsrate=b.cls                                                                                                                 
from General.dbo.cp_nsecm b                                                                                                       
where #p9_HOLD.scrip_Cd=b.scrip and #p9_HOLD.series=b.series and #p9_HOLD.clsrate=0 and exchange='NSECM'                                                                                                              
                    
update #p9_HOLD set VBHC=clsrate*Qty                                                                                           
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                    
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                               
where #p9_HOLD.SCRIP_cD=B.BSECODE AND #p9_HOLD.EXCHANGE='BSECM'                                                                                                                
    
    
/*Added to handle scrip:idfc ltd as it has shifted from BE to Eq as suggested by Vishal Gohil on Dec 10 2015*/    
--select * from #p9_HOLD where  isin='INE092T01019' and series='EQ'    
--update #p9_HOLD set series='EQ' where isin='INE092T01019' and series='BE'    
    
/* update a set series=b.Currenteries from #p9_HOLD a inner join VMSS_Exception_NSESeries b on a.isin=b.isin and a.series=b.previousseries  */  
    
/*******************************************************************/    
    
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                  
where #p9_HOLD.SCRIP_cD=B.NSESYMBOL AND #p9_HOLD.SERIES=B.NSESERIES AND #p9_HOLD.EXCHANGE='NSECM'                                                              
      
                    
update #p9_HOLD set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #p9_HOLD set VAHC=VBHC*((100-HAIRCUT)/100.00)                                                  
                    
insert into #p9_File1(segment,party_code)                                                              
select b.co_code,party_Code from                                                                                                      
/*(select party_code from #p9_hold group by party_code) a,*/ 
(select t_day,party_code from  mis.dbo.asb7_clidetails_crdet --commented on Aug 26 2016  as required by Vishal Gohil mail dated Aug 24 2016 
 where T_day>0 and  
 rms_date=(select max(rms_date)from  mis.dbo.asb7_clidetails_crdet)) a,                                                                                                      
(select * from General.dbo.company where entitytype='EQ' and bo_active=1) b                                                                                                      
                                                                                                      
update #p9_file1                                                                 
set entity='EQUITY',ProcessDate=@BSElastBillDate,Balance=0,UnsettledCr=0,UnsettledDr=0,UnrecoAmt=0,ShortSellValue=0,                                                                                       
MarginAmt=0,Deposit=0,CashColl=0,NonCashColl=0,Holding_total=0,Holding_Approved=0,OtherDebit=0,NonCashConsideration=0,Net=0,                                                                                                      
EarlyPayinValue=0,LeverageMultiplier=0,VarMarginShortFall=0,SquareOffValue=0                                                                                                      
                                                                                       
update #p9_File1 set holding_total=b.VBHC,holding_approved=b.VAHC from                                                                 
(select party_code,exchange,VBHC=sum(VBHC),VAHC=sum(VAHC)                                                                                                                
from #p9_hold group by party_code,exchange) b                                                                       
where #p9_File1.party_code=b.party_code and #p9_File1.segment=b.exchange                                                                              
                                                                                                      
/* Get Last settlement Date */                                                                                                     
                                                                                      
 Declare @sdtcur as datetime,-- @ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59'                                                                                                        
 @ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'                                  
 select @sdtcur=sdtcur from General.dbo.parameter with (nolock) where sdtcur <= @ToDate and ldtcur >=@ToDate                                           
                                       
/* Fetch effective Ledger Balance - Only Bill's effective date else voucher date*/                                 
                
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
 into #p9_BSECM                                                                                                                
 from anand.account_ab.dbo.ledger a with (nolock)                                                                                       
 where vDT>=@sdtcur and vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                           
 group by cltcode                                     
                                                                                   
 select CLTCODE,                                                                                                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                           
 into #p9_NSECM                                                                                                                
from anand1.account.dbo.ledger a with (nolock)                                                                                                                       
 where vDT>=@sdtcur and  vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                                                       
 group by cltcode                                                                                                                    
                                                 
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                 
 into #p9_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                                                       
 /* where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end) */                                                                                                           
  
  
    
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                                 
 select CLTCODE,                                                                          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_NSX                         
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                                                       
 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                               
select CLTCODE,                                                
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
into #p9_MCD                                                                                                    
from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)          
where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
group by cltcode                                                                                                                    
                                                                                                  
 /* Fetch Deposit */                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                 
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                    
 into #p9_dep_BSECM                                                                                                                
 from anand.account_ab.dbo.ledger a with (nolock)                                                                        
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                      
 group by cltcode                                              
                                    
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSECM from anand1.account.dbo.ledger a with (nolock)                                                           
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                      
                                                                                                                
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                       
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                     
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '40%'                                                                                                                      
 group by cltcode                                                                                       
                                                                  
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                         
 into #p9_dep_NSX                                                                                                                
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                   
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                              
 group by cltcode                                       
                                                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                   
 into #p9_dep_MCD                        
 from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                                   
 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                                                
                                                                         
 update #p9_File1 set Balance=b.Vbal from #p9_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                                                      
 update #p9_File1 set Balance=b.Vbal from #p9_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                            
                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                          
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                                                                          
                                                                                                      
 update #p9_File1 set Earlypayinvalue=b.EPV from                      
 (select Exchange,party_code,SUM(total) as EPV from VMSS_EarlyPayinData group by Exchange,party_code) b          
 where #p9_File1.party_code=b.party_Code and #p9_File1.segment=b.exchange                                                                                              
                                                                                                                 
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                             
 (           
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelfo.nsefo.dbo.tbl_clientmargin with (nolock)                                                        
 where MarginDate = (select MAX(margindate) from angelfo.nsefo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                   
  ) b                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSEFO'                                                                                                      
                                                                                                      
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                            
 (                                                                                                      
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                                   
 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                         
  ) b                                                                                                       
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCD'                                                                                           
                                                                                        
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                      
 (                                                                             
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                      
 from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock)                                                                                                      
 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                          
) b                                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSX'                                                                                                      
                                                                              
 update #p9_File1 set NonCashColl=b.NonCashColl                                         
 from VMSS_Client_collateral_NonEquity_NoBrInfo b                                                
 where #p9_File1.party_code=b.party_code and #p9_file1.segment=b.co_code                                                                                 
                                                                
/* Excess Collateral adjustement with Ledger Debit */            
 update #p9_File1 set NonCashColl=NonCashColl+Balance                                                                                                     
 where NonCashColl > 0 and Balance < 0 and segment in ('NSEFO','MCD','NSX')                                                               
                                                                               
 /* GEnerate Summarised Data */                    
                                                           
delete from #p9_file1 where party_code in (select party_code from mis.sccs.dbo.Combine_legal)                                                              
delete from #p9_file1 where party_code in (select party_code from General.dbo.client_Details where (branch_cd='NRIS' or sub_broker='BH'))                          
                        
/*Remove Tday and T+1 day clients ,added by abha as suggested by vishal gohil*/                           
                        
delete from #p9_file1 where party_code in (select Party_Code         
from General.dbo.SQUAREUP_CLIENT_ALERT where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT_ALERT))           
/* -----T day------ */        
        
          
                             
delete from #p9_file1 where party_code in (select party_Code from General.dbo.SQUAREUP_CLIENT         
where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT))            
/*------T+1day --------*/        
        
          
                                                                                     
select                                                                                                                 
max(processDate) as processDate,Entity,Party_code,convert(int,1) as NoofDays,                                                                                                                
sum(Balance) as Balance,sum(MarginAmt) as MarginAmt,sum(Deposit) as Deposit,                                               
sum(CashColl) as CashColl,sum(NonCashColl) as NonCashColl,sum(Holding_total) as Holding_BHC,                                                                                                   
sum(Holding_Approved) as Holding_AHC,sum(OtherDebit) as OtherDebit,                                                
sum(EarlyPayinValue) as EarlyPayinValue,sum(LeverageMultiplier) as LeverageMultiplier,                                                                                               
sum(VarMarginShortFall) as VarMarginShortFall,                                 
Convert(money,0) as NSEFO_JV,                                                                                                                
Convert(money,0) as NSEFO_NonCash,                                                                                                                
Convert(money,0) as MCD_JV,                                                                                               
Convert(money,0) as MCD_NonCash,                                                                                                                
Convert(money,0) as NSX_JV,                                                                                                                
Convert(money,0) as NSX_NonCash,                                                              
Convert(money,0) as VarMarginShortFall_AftAdj,                                                                                               
Convert(money,0) as Stage,                                                                                                                
sum(SquareOffValue) as SquareOffValue,Sum(Case when Segment='BSECM' then BAlance else 0 end) as BSECM_Balance,                                                                                                                 
Sum(Case when Segment='NSECM' then BAlance else 0 end) as NSECM_Balance,                                                         
Convert(money,0) as DP_adj ,                
Convert(money,0) as VarMarginShortFall_AftAdjCurrDay                                                     
into #p9_file2                                                                                                                
from #p9_file1 where segment in ('BSECM','NSECM')                                                                                                                
group by Entity,Party_code                                       
                                                           
/* delete Client with Cash Credit effective Balance */                                                                                                       
                                                              
Delete from #p9_file2 where balance >= @LowerCapAmt                          
Delete from #p9_file2 where party_code in (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF'))                                                                                  
Delete from #p9_file1 where party_Code not in (select party_code from #p9_file2)                                                                              
/*Delete from #p9_file2 where Holding_BHC <= 0 */ --commented on Aug 26 2016  as required by Vishal Gohil mail dated Aug 24 2016                                                    
                                  
update #p9_File2 set VarMarginShortFall=(case when Holding_AHC+Balance+Deposit+EarlypayinValue < @LowerCapAmt then Holding_AHC+Balance+Deposit+EarlypayinValue  else 0 end)                                                                                   
  
                                          
update #p9_File2 set LeverageMultiplier=                                                                                                                
Case when 100-(Holding_AHC/Holding_BHC)*100.00 > 100 then 100 else 100-(Holding_AHC/Holding_BHC)*100.00 end                                                                                                                
where Holding_BHC > 0                                                                                                  
                                                                          
update #p9_file1 set MgnAdjNonCash=0 where MgnAdjNonCash is null                                                                                            
update #p9_file1 set MgnAdjNonLed=0 where MgnAdjNonLed is null                                                    
                        
/* Adj.Margin with Non_Cash Scripwise */                                                                       
                                      
update vmss_NonCash set FinalAmount=Amount-(Amount*(MarginHC/100.00))                                              
update vmss_noncash set MarginSqOffQty=0                                                    
/*---- Full NonCash Getting adjusted against Margin */                                                                              
update vmss_noncash set MarginSqOffQty=Qty from                                                                              
(                                                                              
/*                                                              
select a.*,b.MarginAmt from                                                                              
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                              
(select segment,party_code,MArginAmt from #p9_file1 where MArginAmt > 0) b                        
on a.party_code=b.party_code and a.co_code=b.segment                                                                              
where b.MArginAmt >= a.VAHC                                                               
*/                                    
select a.*,b.MarginAmt from                                                    
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                            
(select segment,party_code,MArginAmt+(Case when balance < 0 then -balance else 0 end) as MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                       
on a.party_code=b.party_code and a.co_code=b.segment                                                                            
where b.MArginAmt >= a.VAHC                                                                
) x where vmss_noncash.party_code=x.party_Code and vmss_noncash.co_code=x.co_Code                                                
                                                                  
/*---- Partial NonCash Getting adjusted against Margin */                                                       
                                          
                                                         
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex from                                                                               
/* (select * from #p9_file1 where marginAmt > 0 ) a  left outer join             */                                                            
(select                       
processDate,Entity,segment,Party_code,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,                                                   
(Case when Balance < 0 then MarginAmt-Balance else MArginAmt end) as MarginAmt,                                                      
Deposit,CashColl,NonCashColl,Holding_total,Holding_Approved,OtherDebit,NonCashConsideration,                                                      
Net,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,SquareOffValue,MgnAdjNonCash,MgnAdjNonLed                                                      
from #p9_file1 where segment in ('NSEFO','MCD','NSX')) a  left outer join                                                     
(select co_code,party_code from vmss_noncash where MarginSqOffQty <> 0 group by party_code,Co_Code) b                                                                              
on a.party_code=b.party_code and a.segment=b.co_Code                                                                              
join (select co_code,party_code from vmss_noncash where MarginSqOffQty = 0 group by party_code,Co_Code) c                                                                              
on a.party_code=c.party_code and a.segment=c.co_Code                                                                              
where b.Party_Code is null                                                                              
                                                    
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                               
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0,@segment as varchar(10) = ''                                                                                
                                                
select @totctr=MAX(srno) from #p9_filex                                                                
                                                                  
While @ctr <= @totctr                                                                                                  
Begin                    
                                                                             
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=MarginAmt,@segment=segment from #p9_filex where srno=@ctr                                                                 
                     
select ROW_NUMBER() OVER (ORDER BY b.seqid,FinalAmount desc) AS [SrNo],                                                           
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,MarginHC as HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,                                                                              
clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty                                                                              
into #p9_holdadj from vmss_noncash a join                                                                                        
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                             
where party_code=@pcode and Clsrate > 0 and MarginHC < 100 and co_Code=@segment                             
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                        
set @TSqOffVal=0                                                                                  
                                                                  
set @Xctr=1                                                                                        
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                           
BEGIN                                                                     
                                                                         
select @TSqOffVal=FinalAmount,@qty=Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                
set @TSqOffVal=@SqOffVal                                                                                             
                                                                  
      
update vmss_noncash                                                                                        
set MarginSqOffQty=ceiling(Case when @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) <= @qty                                             
then @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) else @qty end)                                                                                    
where id=@id  and  MarginHC < 100                                                           
                                                                                  
set @SqOffVal=@SqOffVal-@TSqOffVal                                                                          
set @Xctr=@Xctr+1                                                                                                  
      
END                                                                                                  
                                 
DROP TABLE #p9_holdadj                                                                                                  
                                                                                        
set @ctr=@ctr+1                                
end                                                                                                  
         
drop table #p9_filex                                                                                                  
                                                                  
/* Calculation Margin Adjusted with NonCash */                                                                                                  
                                                                  
/*    
update #p9_file1 set MgnAdjNonCash=(Case when MarginAmt-(NonCashColl+CashColl) < 0 then MarginAmt else (NonCashColl+CashColl) end)                                                                          
where segment in ('NSEFO','MCD','NSX')                                                                                                  
*/                                                                              
                                                                  
update #p9_file1 set MgnAdjNonCash=B.AdjWithMargin from                                                                              
(                               
select co_Code,party_code,sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) as AdjWithMargin from vmss_noncash                                                                               
group by co_Code,party_code                                                                              
having sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) > 0                                            
) b where #p9_file1.party_code=b.party_Code and #p9_file1.segment=b.co_Code                                                        
                                                                                      
/* Calculation Margin Adjusted with Ledger Credit */                                                                                                  
update #p9_file1 set MgnAdjNonLed=(Case                                                 
when Balance > (MarginAmt-MgnAdjNonCash) and MarginAmt-MgnAdjNonCash > 0 and balance > 0 then (MarginAmt-MgnAdjNonCash)                                                                                        
when Balance <= (MarginAmt-MgnAdjNonCash) and balance > 0 then Balance                                                                                                  
else 0 end) where segment in ('NSEFO','MCD','NSX')                                                                   
                                             
                                       
                                                                                   
update  #p9_File2 set NSEFO_JV=b.AdjWithLedgerCr /*,NSEFO_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                                                              
  
  
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                   
from #p9_file1 where segment='NSEFO' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                                                     
                
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr /*,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                      
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                     
from #p9_file1 where segment='NSX' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                   
/*                                                                              
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                                
(              
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                          
from #p9_file1 where segment='NSX'                                                                                                     
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                
*/                                                                               
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                             
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                
from #p9_file1 where segment='MCD' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                    
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                   
/*                                                                                                                 
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                                
(                                                                                                    
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                     
from #p9_file1 where segment='MCD'                                                                                                     
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                           
*/                                                                                                        
                                                                  
UPDATE #p9_File2 SET NSEFO_JV=-vARmARGINsHORTFALL  WHERE NSEFO_JV > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV > 0                                        
UPDATE #p9_File2 SET mcd_jv=-vARmARGINsHORTFALL-NSEFO_jv  WHERE mcd_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv >= 0            
  
   
UPDATE #p9_File2 SET NSX_jv=-VARMARGINSHORTFALL-NSEFO_JV-mcd_jv  WHERE nsx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv >= 0                                                      
                                                                   
UPDATE #p9_File2 SET NSEFO_JV=0 where NSEFO_JV<0                                                                                        
UPDATE #p9_File2 SET mcd_jv=0 where mcd_jv<0                                                                                        
UPDATE #p9_File2 SET NSX_jv=0 where NSX_jv<0                              
                                                                                                    
/* Adjust VarMArgin Shortage with NonCash Collateral */                                                                              
                                      
update vmss_NonCash set FinalAmount=Amount*(Haircut/100.00)                                                   
                                                                  
/*----- NSEFO-----*/                                         
                                                                  
set @totctr  = 0                          
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                        
set @Xctr = 1                                                                              
SET @qty = 0                             
set @TSqOffVal = 0                                                                                  
set @SqQty = 0                                                                    
set @clsrate =0                                                                                  
set @id = 0                                                                               
                                                            
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex1                                                                              
from                                                                        
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv as VarMarginShortFallAftJV from #p9_file2 where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSEFO' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                                                                     
select @totctr=MAX(srno) from #p9_filex1                                                                                                  
                                                                    
While @ctr <= @totctr                                                        
Begin                                                                                                  
                           
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex1 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                             
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                   
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj1                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                               
where party_code=@pcode and Clsrate > 0 and co_code='NSEFO' and haircut < 100                                              
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj1                                                                                                   
set @TSqOffVal=0          
set @Xctr=1                                                             
      
      
                        
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN                                                                      
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj1 where srno=@xctr                                                              
                         
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                                                                  
                                                            
update VMSS_NonCash                                                                           
set                                         
/* SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                        
SqOffseq=@xctr                                                                                     
where id=@id  and  Haircut < 100                                                                                          
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                  
      
set @Xctr=@Xctr+1          
      
                                                                                              
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj1                                                                                        
                                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                    
                                                                                       
update #p9_file2 set NSEFO_noncash=B.AdjustedAmt FROM                                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSEFO' and SquareOffQty > 0                                                                           
group by party_Code      
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                              
                                                                 
/*------ NSX ----*/                                                                
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                        
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                      
set @SqQty = 0                                                                      
set @clsrate =0                                                           
set @id = 0                                                                               
                                                   
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex2                                                                     
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash as VarMarginShortFallAftJV from #p9_file2                     
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSX' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                              
select @totctr=MAX(srno) from #p9_filex2                                                                                                  
                                                                                        
While @ctr <= @totctr                                                                                              
Begin                                                                                                  
                                                                          
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex2 where srno=@ctr                                                                              
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj2                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='NSX'  and haircut < 100                             
                                       
select @Xtotctr=MAX(Srno) from #p9_holdadj2                                                                                                   
set @TSqOffVal=0                                                                                         
                                                                  
set @Xctr=1                                                           
          
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN             
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj2 where srno=@xctr                       
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                               
                                                                  
update VMSS_NonCash                                                                              
/*set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                                        
SqOffseq=@xctr                                                                                  
where id=@id and Haircut < 100      
           
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                                                  
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj2                                                                                                  
                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                                              
drop table #p9_filex2                                                                                
                                                        
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSX' and SquareOffQty > 0                                               
group by party_Code                                                              
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                              
                                                                   
                                                                  
/*------ MCD ----*/                                                                              
                   
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                
set @SqQty = 0                                                                                  
set @clsrate =0                                                                                  
set @id = 0                                
                                        
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex3                                                                              
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash as VarMarginShortFallAftJV from #p9_file2                                                                               
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash < 0) a join                                            
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='MCD' group by party_code) c                                      
on a.party_code=c.party_code                                            
                                                                     
select @totctr=MAX(srno) from #p9_filex3                                                     
                                    
While @ctr <= @totctr                                                                                                  
Begin                          
                                                                
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex3 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj3                                                                  
from VMSS_NonCash_BalAfterMargin a join              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='MCD' and haircut < 100                                                                                                
                                         
select @Xtotctr=MAX(Srno) from #p9_holdadj3                               
set @TSqOffVal=0                                                                                                  
                                                                  
set @Xctr=1                                                 
                                                                     
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                               
BEGIN                                                                                                  
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj3 where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal               
                                                                  
update VMSS_NonCash                                                                                        
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),             
SqOffseq=@xctr                                                                                     
where id=@id and Haircut < 100                                                                                          
          
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                         
END                                                        
                                                                                        
DROP TABLE #p9_holdadj3                                                                                                  
                         
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                     
drop table #p9_filex3                                                                                
                                                                  
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                                 (                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                              
from VMSS_NonCash_BalAfterMargin where co_Code='MCD' and SquareOffQty > 0                                                                           
group by party_Code                                                            
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE      
                                                                  
/*----*/                                                                              
UPDATE #p9_File2 SET NSEFO_NONCASH=0,MCD_NONCASH=0,NSX_NONCASH=0                                                                                                                 
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL = 0 AND vARmARGINsHORTFALL < 0                                                                                    
                                                                  
/*                                                                               
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)                                                                          
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                                                 
AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                                                     
                                                                                                 
UPDATE #p9_FILE2 SET MCD_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET MCD_NONCASH=Stage                                                                                                                
UPDATE #p9_FILE2 SET Stage=0                                                             
                                             
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)                                                                                                                
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                                                                                                                
AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)*-1                                                       
                                                                                                     
UPDATE #p9_FILE2 SET NSX_NONCASH=0                                                       
UPDATE #p9_FILE2 SET NSX_NONCASH=Stage                                                                                                             
UPDATE #p9_FILE2 SET Stage=0                                                                                     
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)                                                                                                               
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                                                                                                               
AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)*-1                                                                                                                
                                                                             
UPDATE #p9_FILE2 SET NSEFO_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET NSEFO_NONCASH=Stage                                                          
UPDATE #p9_FILE2 SET Stage=0                                                                                                                
*/                                                                              
                                  
update #p9_File2  set VarMarginShortFall_AftAdjCurrDay=vARmARGINsHORTFALL+NSefo_jv+MCD_JV+NSX_JV+NSEFO_NONCASH+MCD_NONCASH+NSX_NONCASH                                                                                         
where  vARmARGINsHORTFALL < 0                                                                                                                 
        
update #p9_File2  set VarMarginShortFall_AftAdj=VarMarginShortFall_AftAdjCurrDay        
        
/*        
--- Used to compute min of last 4 days for squareoff.. not required as per PRMS id: 10391261 dt...14/08/2015...        
update #p9_File2 set VarMarginShortFall_AftAdj=(Case when #p9_File2.VarMarginShortFall_AftAdjCurrDay > q.VarMarginShortFall_AftAdjCurrDay                   
then #p9_File2.VarMarginShortFall_AftAdjCurrDay else q.VarMarginShortFall_AftAdjCurrDay end)                  
from                  
(                  
select Party_code,MAX(VarMarginShortFall_AftAdjCurrDay) as VarMarginShortFall_AftAdjCurrDay                   
from vmss_Data x join                  
(select top 3 processdate from (select distinct processdate from vmss_Data where processdate < @BSElastBillDate) a order by processdate) y                   
on x.processdate=y.processdate                               
group by party_code                  
) q where #p9_File2.party_code=q.party_code                  
*/          
                                      
/* Var Margin % */                                                                                  
                                                                                     
truncate table vmss_holding                                                                        
insert into vmss_holding                                                                                                      
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate)                                                
          
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,                                                                                                      
SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS [SrNo],0,ISIN,ActualSqOffQty=CONVERT(int,0),0.00 from #p9_hold                                                                                                      
                                                                        
/*                                                                                                    
select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #p9_filex                                                                                                       
from #p9_file2 where VarMarginShortFall_AftAdj < 0                
                                                                                
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                                                                      
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                                                                      
                                                                 
select @totctr=MAX(srno) from #p9_filex                                                                                                      
                                                                                           
While @ctr <= @totctr                                                                                                      
Begin                                                                                               
                                                                   
set @SqOffVal=0                                                              
select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdj*-1 from #p9_filex where srno=@ctr                                                                                                                      
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],* into #p9_holdadj from vmss_holding a join                                                                                                      
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                             
where party_code=@pcode and Clsrate > 0                                                                                    
                                                                                
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                                                     
set @TSqOffVal=0                                                                                                      
                                                                
set @Xctr=1                                                                                          
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                     
BEGIN                                                                                          
                                                                              
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                             
                                                  
if (@SqOffVal<@TSqOffVal)                                                              
set @TSqOffVal=@SqOffVal                                                                                                      
                                                              
update vmss_holding                                                                               
set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                                                       
SqOffseq=@xctr                                                                                         
where id=@id                                                                                
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                      
                      
set @Xctr=@Xctr+1                                                                                                      
END                                                                                                      
                                                                                           
DROP TABLE #p9_holdadj                                            
                                                                                           
set @ctr=@ctr+1                                            
end                                                                                                      
                                                                                          
drop table #p9_filex                                                                                                      
                                                                
truncate table vmss_holding_hist                                                                                                       
insert into vmss_holding(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq)                                                         
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq from vmss_holding                                                                                   
  
  
    
      
        
        
        
         
                                                                                        
update #p9_file2 set SquareOffValue=b.SqVal from                                                              
(                                                                                            
select party_code,sum(SquareOffQty*Clsrate) as SqVal from vmss_holding where isnull(SquareOffQty,0) > 0                                                                                       
group by party_code                                                                                            
) b                
where #p9_file2.party_code=b.party_Code                                                                                                      
*/                                                                                    
                                                                                        
/*                                                                                                            
update #p9_File2 set SquareOffValue=                                                                                                                
Case when (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 < (Holding_BHC)*-1 then (Holding_BHC)*-1                                                                                                                
else (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 end                                      
where LeverageMultiplier > 0                                                                                                                
*/                                                                                                      
                                                                               
/*                                                                              
UPDATE #p9_File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                             
(                                                                                  
SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                                                                           
(                                                                                     
SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                             
WHERE CONVERT(DATE,processdate) < (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data )                                                    
)                                                                                                                                          
) B WHERE #p9_File2.party_code=B.party_code                                                                                                        
                                                                                   
UPDATE #p9_File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                                            
              
*/                                                                                       

/*  
delete a from #p9_FILE2 a left outer join VMSS_ASB7_Days b on a.party_code=b.Party_code   
WHERE b.Party_code is null  
*/
  
delete from VMSS_data where processDate=@BSElastBillDate                                                                                                                
                                                                                           
insert into VMSS_data(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,                                                                                                      
Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,                                                                                                         
NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,remarks,DP_adj,Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                                                                           
   
SELECT processDate,Entity,A.Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,                                                                                                                
OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,                                                  
VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,GETDATE(),'V','',DP_adj,0.00,VarMarginShortFall_AftAdjCurrDay                                                                                                            
FROM #p9_FILE2 A inner join mis.dbo.asb7_clidetails_crdet  B on A.Party_code=B.party_code inner join (select distinct party_code from general.dbo.vw_ClientMargin_Campaign C with(nolock) where is_accepted='Y')C
on A.party_code=C.party_code
where B.SQ_AMT> 0                                                                                                                
and B.T_day>0 and  rms_date=(select max(rms_date)from  mis.dbo.asb7_clidetails_crdet) 


/*                                                                                
insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                        
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks)                                                                                   
  
  
select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                                            
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks from VMSS_data                                                                     
  
  
*/                                                                  
                                                                        
End try                                                                                                                                     
BEGIN CATCH                                                                                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                              
  select GETDATE(),'VMSS_Calculation_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                                                                                   
                          
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                              
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                                                     
                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Calculation_NoNRMS_btst
-- --------------------------------------------------
  

CREATE Procedure [dbo].[VMSS_Calculation_NoNRMS_btst]                                                                                                  

as                                                                                                            

                                                                                                            

SET XACT_ABORT ON                                                                                                            

Set nocount on                                                                                                            

BEGIN TRY                                                                                                                                    

                                                                          

 Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                                                            

 Declare @LowerCapNonCash as money = 500  /* NONCASH COLLATERAL MOVEMENT : always +ve */                                                                                                            

 Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                                                                                            

                                                                                                      

 select                                                                                                             

 @BSElastBillDate  as processDate,                                                                                                            

 b.Entity,                                                                                                            

 b.segment,                                                                                                            

 a.Party_code,                                                                                                            

 a.Ledger as Balance,                                                                                                            

 CONVERT(money,0)  as UnsettledCr,                                                                                                            

 CONVERT(money,0) as UnsettledDr,                                                                                                            

 a.Unrecosiled_Credit as UnrecoAmt,                                                                                                            

 CONVERT(money,0) as ShortSellValue,                                                                                                            

 a.Imargin as MarginAmt,                                                                                                            

 a.Deposit,                                                                                                            

a.Cash_Colleteral as CashColl,                                                                                                            

a.NonCash_Colleteral as NonCashColl,                                                                                                            

Holding_total,                                                                                                            

Holding_Approved,                                                                                                            

CONVERT(money,0) as OtherDebit,                                                  

CONVERT(int,0) as NonCashConsideration,                                                                                                

CONVERT(money,0) as Net,                       

CONVERT(money,0) as EarlyPayinValue,                

CONVERT(money,0) as LeverageMultiplier,                        

CONVERT(money,0) as VarMarginShortFall,                                                            

CONVERT(money,0) as SquareOffValue,                                

CONVERT(money,0) as MgnAdjNonCash,                                                   

CONVERT(money,0) as MgnAdjNonLed                                                              

into #p9_File1                                                 

from (select * from General.dbo.RMS_DtClFi with (nolock) where 1=2) a join (select segment,entity from intranet.cms.dbo.ncms_entity with (nolock) where entity='Equity') b                                                                  

on a.Co_code=b.segment                                                                   

                                                                                                   

                                                                                                   

 /* update Holding */                                                                                                  

                                                            

select EXCHANGE,sett_no,SEtt_type,                                                                                                            

(CASE WHEN EXCHANGE='NSECM' THEN DUMMY1 ELSE SCRIP_CD END) AS scrip_cd,                                                                                                            

(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,Party_code,Qty,                                                                        

CLSRATE,                                                                                                            

Total AS VBHC,                                                                          

CONVERT(MONEY,0) AS HAIRCUT,                                                                                                            

CONVERT(MONEY,0) AS VAHC,                                                                                                

SPACE(10) AS CATEGORY,                                                                                                            

source AS SRC,                                                                    

ISIN                                                                    

INTO #p9_HOLD                                                                                                            

from vmss_rms_holding where source in ('SI','SO','H','D')   --and party_code='ALWR1567'                  

/*              

SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0      

DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin      

DROP TABLE #nqty  */    

SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0      

SELECT  party_code,isin,SUM(qty) as NQty into #nqty1 from #p9_hold group by party_code,isin 

if exists (select NQty from #nqty where NQty<0)
begin
	print 'hii'
	DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin      
end
if exists(select NQty from #nqty1 where NQty>0)
begin
 print'byee'
 delete from #p9_HOLD where qty<0
 update #p9_HOLD set qty=NQty from #nqty1 T2 where  T2.party_code = #p9_HOLD.party_code AND T2.isin = #p9_HOLD.isin   
end
DROP TABLE #nqty      
                                                                                                        

update #p9_HOLD set clsrate=b.rate from General.dbo.cp_bsecm b where #p9_HOLD.scrip_Cd=b.scode and #p9_HOLD.clsrate=0                                                                                                            

                

update #p9_HOLD set clsrate=b.cls                                                                                                             

from General.dbo.cp_nsecm b                                                                                                   

where #p9_HOLD.scrip_Cd=b.scrip and #p9_HOLD.series=b.series and #p9_HOLD.clsrate=0 and exchange='NSECM'                                                                                                          

                

update #p9_HOLD set VBHC=clsrate*Qty                                                                                                            

                

update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                

(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                           

where #p9_HOLD.SCRIP_cD=B.BSECODE AND #p9_HOLD.EXCHANGE='BSECM'                                                                                                            

 /*Added to handle scrip:idfc ltd as it has shifted from BE to Eq as suggested by Vishal Gohil on Dec 10 2015*/
--select * from #p9_HOLD where  isin='INE092T01019' and series='EQ'
--update #p9_HOLD set series='EQ' where isin='INE092T01019' and series='BE'

update a set series=b.Currenteries from #p9_HOLD a inner join VMSS_Exception_NSESeries b on a.isin=b.isin and a.series=b.previousseries
               

update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                  

(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                              

where #p9_HOLD.SCRIP_cD=B.NSESYMBOL AND #p9_HOLD.SERIES=B.NSESERIES AND #p9_HOLD.EXCHANGE='NSECM'                                                          

                

update #p9_HOLD set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                            

                

update #p9_HOLD set VAHC=VBHC*((100-HAIRCUT)/100.00)                                              

                

insert into #p9_File1(segment,party_code)                                                          

select b.co_code,party_Code from                                                                                                  

(select party_code from #p9_hold group by party_code) a,                                                                                                   

(select * from General.dbo.company where entitytype='EQ' and bo_active=1) b                                                                                                  

                                                                                                  

update #p9_file1                                                             

set entity='EQUITY',ProcessDate=@BSElastBillDate,Balance=0,UnsettledCr=0,UnsettledDr=0,UnrecoAmt=0,ShortSellValue=0,                                                                                   

MarginAmt=0,Deposit=0,CashColl=0,NonCashColl=0,Holding_total=0,Holding_Approved=0,OtherDebit=0,NonCashConsideration=0,Net=0,                                                                                                  

EarlyPayinValue=0,LeverageMultiplier=0,VarMarginShortFall=0,SquareOffValue=0                                                                                                  

                                                                                   

update #p9_File1 set holding_total=b.VBHC,holding_approved=b.VAHC from                                                             

(select party_code,exchange,VBHC=sum(VBHC),VAHC=sum(VAHC)                                                                                                            

from #p9_hold group by party_code,exchange) b                                                                   

where #p9_File1.party_code=b.party_code and #p9_File1.segment=b.exchange                                                                                                            

                                                                                                  

/* Get Last settlement Date */                                                                                                 

                                                                                  

 Declare @sdtcur as datetime,-- @ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59'                                                                                                    

 @ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'                        

 select @sdtcur=sdtcur from General.dbo.parameter with (nolock) where sdtcur <= @ToDate and ldtcur >=@ToDate                                       

                                   

/* Fetch effective Ledger Balance - Only Bill's effective date else voucher date*/                             

            

 select CLTCODE,                                                                                                            

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                      

 into #p9_BSECM                                                                                                            

 from anand.account_ab.dbo.ledger a with (nolock)                                                                                   

 where vDT>=@sdtcur and vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                       

 group by cltcode                                 

                                                                               

 select CLTCODE,                                                                                              

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                       

 into #p9_NSECM                                                                                                            

from anand1.account.dbo.ledger a with (nolock)                                                                                                                   

 where vDT>=@sdtcur and  vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                                                   

 group by cltcode                                                                                                                

                                             

 select CLTCODE,                                                                                                            

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                             

 into #p9_NSEFO                                                                                                            

 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                                                   

 /* where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end) */                                                                                                           


 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate         

 group by cltcode                                                                                                                

                                                             

 select CLTCODE,                                                                                                            

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            

 into #p9_NSX                                                                                             

 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                                                   

 where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate         

 group by cltcode                                                                                                                

               

select CLTCODE,                                            

VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                      

into #p9_MCD                                                                                                

from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)      

where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate         

group by cltcode                                                                                                                

                                                                                              

 /* Fetch Deposit */                                                                        

 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                             

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                

 into #p9_dep_BSECM                                                                                                            

 from anand.account_ab.dbo.ledger a with (nolock)                                                                    

 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                  

 group by cltcode                                          

                                

 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                  

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            

 into #p9_dep_NSECM from anand1.account.dbo.ledger a with (nolock)                                                       

 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                  

 group by cltcode                                                                  

                                                                                                            

 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                   

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            

 into #p9_dep_NSEFO                                                                                                            

 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                 

 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '40%'                                                                                                                  

 group by cltcode                                                                                   

                                                                                                              

 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                  

 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                            

 into #p9_dep_NSX                                                                                                            

 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                               

 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                          

 group by cltcode                                   

                                                                                                        

 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                               

 into #p9_dep_MCD                    

 from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                               

 where vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                  

 group by cltcode                                                                                            

                                                                     

 update #p9_File1 set Balance=b.Vbal from #p9_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                                                            

 update #p9_File1 set Balance=b.Vbal from #p9_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                            

 update #p9_File1 set Balance=b.Vbal from #p9_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                                            

 update #p9_File1 set Balance=b.Vbal from #p9_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                                                  

 update #p9_File1 set Balance=b.Vbal from #p9_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                        

                                                                                                            

 update #p9_File1 set deposit=b.Vbal from #p9_dep_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                       

 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                                                            

 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                      

 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                       

 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                                                                      

                                                                                                  

 update #p9_File1 set Earlypayinvalue=b.EPV from                                                                                                       

 (select Exchange,party_code,SUM(total) as EPV from VMSS_EarlyPayinData group by Exchange,party_code) b                                                                                                            

 where #p9_File1.party_code=b.party_Code and #p9_File1.segment=b.exchange                                                                                                  

                                                                                                             

 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                         

 (       

 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                  

 from angelfo.nsefo.dbo.tbl_clientmargin with (nolock)                                                    

 where MarginDate = (select MAX(margindate) from angelfo.nsefo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                               

  ) b                                                                

  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSEFO'                                                                                                  

                                                                                                  

 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                        

 (                                                                                                  

 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                  

 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                               

 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                     

  ) b                                                                                                   

  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCD'                                                                                       

                                                                                    

 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                  

 (                                                                         

 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                  

 from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock)                                                                                                  

 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                      

) b                                                                                

  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSX'                                                                                                  

                                                                          

 update #p9_File1 set NonCashColl=b.NonCashColl                                     

 from VMSS_Client_collateral_NonEquity_NoBrInfo b                                                                                                  

 where #p9_File1.party_code=b.party_code and #p9_file1.segment=b.co_code                                                                             

                                                            

/* Excess Collateral adjustement with Ledger Debit */                                                            

 update #p9_File1 set NonCashColl=NonCashColl+Balance                                                                                                 

 where NonCashColl > 0 and Balance < 0 and segment in ('NSEFO','MCD','NSX')                                                           

                                                                           

 /* GEnerate Summarised Data */                

          

delete from #p9_file1 where party_code in (select party_code from mis.sccs.dbo.Combine_legal)                                                          

delete from #p9_file1 where party_code in (select party_code from General.dbo.client_Details where (branch_cd='NRIS' or sub_broker='BH'))                      

                    

/*Remove Tday and T+1 day clients ,added by abha as suggested by vishal gohil*/                       

                    

delete from #p9_file1 where party_code in (select Party_Code     

from General.dbo.SQUAREUP_CLIENT_ALERT where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT_ALERT))       

/* -----T day------ */    
                        

delete from #p9_file1 where party_code in (select party_Code from General.dbo.SQUAREUP_CLIENT     

where updt=(select max(updt) from General.dbo.SQUAREUP_CLIENT))        

/*------T+1day --------*/    


select                                                                                                             

max(processDate) as processDate,Entity,Party_code,convert(int,1) as NoofDays,                                                                                                            

sum(Balance) as Balance,sum(MarginAmt) as MarginAmt,sum(Deposit) as Deposit,                                           

sum(CashColl) as CashColl,sum(NonCashColl) as NonCashColl,sum(Holding_total) as Holding_BHC,                                                                                               

sum(Holding_Approved) as Holding_AHC,sum(OtherDebit) as OtherDebit,                                            

sum(EarlyPayinValue) as EarlyPayinValue,sum(LeverageMultiplier) as LeverageMultiplier,                                                                                           

sum(VarMarginShortFall) as VarMarginShortFall,                             

Convert(money,0) as NSEFO_JV,                                                                                                            

Convert(money,0) as NSEFO_NonCash,                                                                                                            

Convert(money,0) as MCD_JV,                                                                                           

Convert(money,0) as MCD_NonCash,                                                                                                            

Convert(money,0) as NSX_JV,                                                                                                            

Convert(money,0) as NSX_NonCash,                                                          

Convert(money,0) as VarMarginShortFall_AftAdj,                                                                                           

Convert(money,0) as Stage,                                                                                                            

sum(SquareOffValue) as SquareOffValue,Sum(Case when Segment='BSECM' then BAlance else 0 end) as BSECM_Balance,                                                                                                             

Sum(Case when Segment='NSECM' then BAlance else 0 end) as NSECM_Balance,                                                     

Convert(money,0) as DP_adj ,            

Convert(money,0) as VarMarginShortFall_AftAdjCurrDay                                                                              

into #p9_file2                                                                                                            

from #p9_file1 where segment in ('BSECM','NSECM')                                                                                                            

group by Entity,Party_code                                   

                                                       

/* delete Client with Cash Credit effective Balance */                                                                                                   

                                                          

Delete from #p9_file2 where balance >= @LowerCapAmt                      

Delete from #p9_file2 where party_code in (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF'))                                                                              

Delete from #p9_file1 where party_Code not in (select party_code from #p9_file2)                                                                          

Delete from #p9_file2 where Holding_BHC <= 0                                                   

                              

update #p9_File2 set VarMarginShortFall=(case when Holding_AHC+Balance+Deposit+EarlypayinValue < @LowerCapAmt then Holding_AHC+Balance+Deposit+EarlypayinValue  else 0 end)                                                                                   
                                    

update #p9_File2 set LeverageMultiplier=                                                                                                            

Case when 100-(Holding_AHC/Holding_BHC)*100.00 > 100 then 100 else 100-(Holding_AHC/Holding_BHC)*100.00 end                                                                                                            

where Holding_BHC > 0                                                                                              

                                                                      

update #p9_file1 set MgnAdjNonCash=0 where MgnAdjNonCash is null                                                                                        

update #p9_file1 set MgnAdjNonLed=0 where MgnAdjNonLed is null                                                

                    

/* Adj.Margin with Non_Cash Scripwise */                                                                   

                                  

update vmss_NonCash_BTST set FinalAmount=Amount-(Amount*(MarginHC/100.00))                                          

update vmss_NonCash_BTST set MarginSqOffQty=0                                                

/*---- Full NonCash Getting adjusted against Margin */                                                                          

update vmss_NonCash_BTST set MarginSqOffQty=Qty from                                                                          

(                                                                          

/*                                                          

select a.*,b.MarginAmt from                                                                          

(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_NonCash_BTST group by party_code,co_Code) a join                                                                          

(select segment,party_code,MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                          

on a.party_code=b.party_code and a.co_code=b.segment                                                                          

where b.MArginAmt >= a.VAHC                                                           

*/                                

select a.*,b.MarginAmt from                                                                        

(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_NonCash_BTST group by party_code,co_Code) a join                                                                        

(select segment,party_code,MArginAmt+(Case when balance < 0 then -balance else 0 end) as MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                   

on a.party_code=b.party_code and a.co_code=b.segment                                                                        

where b.MArginAmt >= a.VAHC                                                           

) x where vmss_NonCash_BTST.party_code=x.party_Code and vmss_NonCash_BTST.co_code=x.co_Code                                            

                                                              

/*---- Partial NonCash Getting adjusted against Margin */                                                   

                                      

                                                     

select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex from                                                                           

/* (select * from #p9_file1 where marginAmt > 0 ) a  left outer join             */                                                        

(select                   

processDate,Entity,segment,Party_code,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,                                               

(Case when Balance < 0 then MarginAmt-Balance else MArginAmt end) as MarginAmt,                                                  

Deposit,CashColl,NonCashColl,Holding_total,Holding_Approved,OtherDebit,NonCashConsideration,                                                  

Net,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,SquareOffValue,MgnAdjNonCash,MgnAdjNonLed                                                  

from #p9_file1 where segment in ('NSEFO','MCD','NSX')) a  left outer join                                                 

(select co_code,party_code from vmss_NonCash_BTST where MarginSqOffQty <> 0 group by party_code,Co_Code) b                                                                          

on a.party_code=b.party_code and a.segment=b.co_Code                                                                          

join (select co_code,party_code from vmss_NonCash_BTST where MarginSqOffQty = 0 group by party_code,Co_Code) c                                                                          

on a.party_code=c.party_code and a.segment=c.co_Code                                                                          

where b.Party_Code is null                                                                          

                                                

Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                           

declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0,@segment as varchar(10) = ''                                                                            

                                            

select @totctr=MAX(srno) from #p9_filex                                                            

                                                              

While @ctr <= @totctr                                                                                              

Begin                                                                                              

                                                                         

set @SqOffVal=0                                                                                              

select @pcode=party_Code,@SqOffVal=MarginAmt,@segment=segment from #p9_filex where srno=@ctr                                                             

                                                              

select ROW_NUMBER() OVER (ORDER BY b.seqid,FinalAmount desc) AS [SrNo],                                                                          

id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,MarginHC as HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,                                                                          

clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty                                                                          

into #p9_holdadj from vmss_NonCash_BTST a join                                                        

(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                         

where party_code=@pcode and Clsrate > 0 and MarginHC < 100 and co_Code=@segment                         

                                                              

select @Xtotctr=MAX(Srno) from #p9_holdadj                                                    

set @TSqOffVal=0                                                                              

                                                              

set @Xctr=1                                                                                    

                                                                              

While @Xctr <= @Xtotctr  and @SqOffVal > 0                                       

BEGIN                                                                 

                                                                     

select @TSqOffVal=FinalAmount,@qty=Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                     

                                                                      

if (@SqOffVal<@TSqOffVal)                                                                                            

set @TSqOffVal=@SqOffVal                                                                                         

                                                              

  

update vmss_NonCash_BTST                                                                                    

set MarginSqOffQty=ceiling(Case when @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) <= @qty                                         

then @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) else @qty end)                                                                                

where id=@id  and  MarginHC < 100                                                       

                                                                              

set @SqOffVal=@SqOffVal-@TSqOffVal                                                                      

set @Xctr=@Xctr+1                                                                                              

  

END                                                                                              

                             

DROP TABLE #p9_holdadj                                                                                              

                                                                                    

set @ctr=@ctr+1                            

end                                                                                              

                                                                          

drop table #p9_filex                                                                                              

                                                              

/* Calculation Margin Adjusted with NonCash */                                                                                              

                                                              

/*                                                                          

update #p9_file1 set MgnAdjNonCash=(Case when MarginAmt-(NonCashColl+CashColl) < 0 then MarginAmt else (NonCashColl+CashColl) end)                                                                      

where segment in ('NSEFO','MCD','NSX')                                                                                              

*/                                                                          

                                                              

update #p9_file1 set MgnAdjNonCash=B.AdjWithMargin from                                     

(                           

select co_Code,party_code,sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) as AdjWithMargin from vmss_NonCash_BTST                                                                           

group by co_Code,party_code                                                                          

having sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) > 0                                        

) b where #p9_file1.party_code=b.party_Code and #p9_file1.segment=b.co_Code                                                    

                                                                                  

/* Calculation Margin Adjusted with Ledger Credit */                                                                                              

update #p9_file1 set MgnAdjNonLed=(Case                                             

when Balance > (MarginAmt-MgnAdjNonCash) and MarginAmt-MgnAdjNonCash > 0 and balance > 0 then (MarginAmt-MgnAdjNonCash)                                                                                    

when Balance <= (MarginAmt-MgnAdjNonCash) and balance > 0 then Balance                                                                                              

else 0 end) where segment in ('NSEFO','MCD','NSX')                                                               

                                         

                                   

                                                                               

update  #p9_File2 set NSEFO_JV=b.AdjWithLedgerCr /*,NSEFO_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                                                            

(                                                                                                            

select party_code,                                                                          

AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                          

AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                               

from #p9_file1 where segment='NSEFO' and                                                                 

(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                          

) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             

                                                                                                 

                                                               

update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr /*,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                  

(                                                                                                            

select party_code,                                                                          

AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                          

AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                  

from #p9_file1 where segment='NSX' and                                                                 

(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                          

) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             

                                            

/*                                                                          

update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                            

(          

select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                      

from #p9_file1 where segment='NSX'                                                                                                 

) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                            

*/                                                                           

update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                         

(                                                                                                            

select party_code,                                                                          

AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                          

AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                            

from #p9_file1 where segment='MCD' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                

) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             

                                                               

/*                                                                                                             

update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                            

(                                                                                                

select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                 

from #p9_file1 where segment='MCD'                                                                                                 

) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                             

*/                                                                                                    

                                                              

UPDATE #p9_File2 SET NSEFO_JV=-vARmARGINsHORTFALL  WHERE NSEFO_JV > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV > 0                                    

UPDATE #p9_File2 SET mcd_jv=-vARmARGINsHORTFALL-NSEFO_jv  WHERE mcd_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv >= 0                                                                                                            


UPDATE #p9_File2 SET NSX_jv=-VARMARGINSHORTFALL-NSEFO_JV-mcd_jv  WHERE nsx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv >= 0                                                  

                                                               

UPDATE #p9_File2 SET NSEFO_JV=0 where NSEFO_JV<0                                                                                    

UPDATE #p9_File2 SET mcd_jv=0 where mcd_jv<0                                                   

UPDATE #p9_File2 SET NSX_jv=0 where NSX_jv<0                          

                                                                                                

/* Adjust VarMArgin Shortage with NonCash Collateral */                                                                          

                                  

update vmss_NonCash_BTST set FinalAmount=Amount*(Haircut/100.00)                                               

                                                              

/*----- NSEFO-----*/                                     

                                                              

set @totctr  = 0                      

set @ctr = 1                                                                              

set @SqOffVal = 0                                                                              

set @pcode =''                                                                              

set @Xtotctr = 0                    

set @Xctr = 1                                                                          

SET @qty = 0                         

set @TSqOffVal = 0                                                                              

set @SqQty = 0                                                                

set @clsrate =0                                                                              

set @id = 0                                                                           

                                                        

select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex1                                                                          

from                                                                    

(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv as VarMarginShortFallAftJV from #p9_file2 where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv < 0) a join                                                                          

(select party_code from vmss_NonCash_BTST where MarginSqOffQty < Qty and Co_Code='NSEFO' group by party_code) c                                                                          

on a.party_code=c.party_code                                                                          

                                                                 

select @totctr=MAX(srno) from #p9_filex1                                                                                              

                                                                

While @ctr <= @totctr                                                    

Begin                                                                                              

                       

set @SqOffVal=0                                                                                              

select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex1 where srno=@ctr                                                                                       

                                                              

select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                          

id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                          

FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                               

A_Qty,VBHC,VAHC                                                                          

into #p9_holdadj1                                                                           

from VMSS_NonCash_BalAfterMargin a join                                                                                              

(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                           

where party_code=@pcode and Clsrate > 0 and co_code='NSEFO' and haircut < 100                                          

                                                              

select @Xtotctr=MAX(Srno) from #p9_holdadj1                                                                                               

set @TSqOffVal=0      

set @Xctr=1                                                         

  

  

                    

While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                             

BEGIN                                                                  

                                                                     

select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj1 where srno=@xctr                                                          

                     

if (@SqOffVal<@TSqOffVal)                                                                                              

set @TSqOffVal=@SqOffVal                                                                                              

                                                        

update vmss_NonCash_BTST                                                                       

set                                     

/* SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                    

SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                    

SqOffseq=@xctr                                                                                 

where id=@id  and  Haircut < 100                                                                                      

                                                                              

set @SqOffVal=@TSqOffVal                                                                                              

  

set @Xctr=@Xctr+1      

  

                                                                                          

END                                                                                              

                                                                                    

DROP TABLE #p9_holdadj1                                                                                    

                                                                                    

set @ctr=@ctr+1                                                                                              

end                                                

                                                                                   

update #p9_file2 set NSEFO_noncash=B.AdjustedAmt FROM                                                                          

(                                                                          

select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                           

from VMSS_NonCash_BalAfterMargin where co_Code='NSEFO' and SquareOffQty > 0                                                                       

group by party_Code                                                          

) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                          

                                                             

/*------ NSX ----*/                                                            

set @totctr  = 0                                                                              

set @ctr = 1                                                                              

set @SqOffVal = 0                                                  

set @pcode =''                                                    

set @Xtotctr = 0                                                                              

set @Xctr = 1                                                

SET @qty = 0                                                                          

set @TSqOffVal = 0                                                  

set @SqQty = 0                                                                  

set @clsrate =0                                                       

set @id = 0                                                                           

                                               

select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex2                                                                 

from                                                                          

(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash as VarMarginShortFallAftJV from #p9_file2                 

where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash < 0) a join                                                                          

(select party_code from vmss_NonCash_BTST where MarginSqOffQty < Qty and Co_Code='NSX' group by party_code) c                                                                          

on a.party_code=c.party_code                                                                          

                          

select @totctr=MAX(srno) from #p9_filex2                                                                                              

                                                                                    

While @ctr <= @totctr                                                                                          

Begin                                                                                              

                                                                      

set @SqOffVal=0                                                                                              

select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex2 where srno=@ctr                                                                          

                                                              

select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                          

id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                          

FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                          

A_Qty,VBHC,VAHC                                                                          

into #p9_holdadj2                                                                           

from VMSS_NonCash_BalAfterMargin a join                                                                                              

(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                              

where party_code=@pcode and Clsrate > 0 and co_code='NSX'  and haircut < 100                                                                                           

                                   

select @Xtotctr=MAX(Srno) from #p9_holdadj2                                                                                               

set @TSqOffVal=0                                                                                     

                                                              

set @Xctr=1                                                       

      

While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                             

BEGIN         

                                                                     

select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj2 where srno=@xctr                   

                                                                      

if (@SqOffVal<@TSqOffVal)                                                                                              

set @TSqOffVal=@SqOffVal                                                           

                                                              

update vmss_NonCash_BTST                                                                          

/*set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                    

set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                                    

SqOffseq=@xctr                                                                              

where id=@id and Haircut < 100  

       

set @SqOffVal=@TSqOffVal                                                                                              

                                                                            

set @Xctr=@Xctr+1                                                                                              

END                                                                                              

                                                                                    

DROP TABLE #p9_holdadj2                                                                                              

                                                                    

set @ctr=@ctr+1                                                                                              

end                                                                                              

                                                                          

drop table #p9_filex2                                                                            

                                                    

update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                          

(                                                                          

select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                           

from VMSS_NonCash_BalAfterMargin where co_Code='NSX' and SquareOffQty > 0                                           

group by party_Code                                                          

) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                          

                                                               

                                                              

/*------ MCD ----*/                                                                          

                                                              

set @totctr  = 0                                                                              

set @ctr = 1                                                                              

set @SqOffVal = 0                                                              

set @pcode =''                                                                              

set @Xtotctr = 0                                                                              

set @Xctr = 1                                                                                

SET @qty = 0                                                                          

set @TSqOffVal = 0                                            

set @SqQty = 0                                                                              

set @clsrate =0                                                                              

set @id = 0                            

                                    

select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex3                                                                          

from                                                                          

(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash as VarMarginShortFallAftJV from #p9_file2                                                                           

where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash < 0) a join                                        

(select party_code from vmss_NonCash_BTST where MarginSqOffQty < Qty and Co_Code='MCD' group by party_code) c                                  

on a.party_code=c.party_code                                        

                                                                 

select @totctr=MAX(srno) from #p9_filex3                                                 

                                

While @ctr <= @totctr                                                                                              

Begin                      

                                                            

set @SqOffVal=0                                                                                              

select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex3 where srno=@ctr                                                                                       

                                                              

select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                          

id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                          

FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                          

A_Qty,VBHC,VAHC                                                                          

into #p9_holdadj3                                                              

from VMSS_NonCash_BalAfterMargin a join                                                                                              

(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                              

where party_code=@pcode and Clsrate > 0 and co_code='MCD' and haircut < 100                                                                                            

                                     

select @Xtotctr=MAX(Srno) from #p9_holdadj3                           

set @TSqOffVal=0                                                                                              

                                                              

set @Xctr=1                                                                                 

                                                                 

While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                             

BEGIN                                                                                              

                                                                     

select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj3 where srno=@xctr                                                                                     

                           

if (@SqOffVal<@TSqOffVal)                                                                                              

set @TSqOffVal=@SqOffVal           

                                                              

update vmss_NonCash_BTST                                                                                    

/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                    

set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),         

SqOffseq=@xctr                                                                                 

where id=@id and Haircut < 100                                                                                      

      

set @SqOffVal=@TSqOffVal                                                                                              

                                                                            

set @Xctr=@Xctr+1                                                                     

END                                                    

                                                                                    

DROP TABLE #p9_holdadj3                                                                                              

                     

set @ctr=@ctr+1                                                                                              

end                                                                                              

                                                 

drop table #p9_filex3                                                                            

                                                              

update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                                 (                                                                          

select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                          

from VMSS_NonCash_BalAfterMargin where co_Code='MCD' and SquareOffQty > 0                                                                       

group by party_Code                                                        

) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                          

                                                              

/*----*/                                                                          

UPDATE #p9_File2 SET NSEFO_NONCASH=0,MCD_NONCASH=0,NSX_NONCASH=0                                                                                                             

WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL = 0 AND vARmARGINsHORTFALL < 0                                                                                

                                                              

/*                                                                           

UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)                                                                      

WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                                                                                                            

AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                                                 

                                                                                             

UPDATE #p9_FILE2 SET MCD_NONCASH=0                                                                                                            

UPDATE #p9_FILE2 SET MCD_NONCASH=Stage                                                                               

UPDATE #p9_FILE2 SET Stage=0                                                         

                                         

UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)                                                                                                            

WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                                                                                                            

AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)*-1                                                   

                                                                                                 

UPDATE #p9_FILE2 SET NSX_NONCASH=0                                                   

UPDATE #p9_FILE2 SET NSX_NONCASH=Stage                                                                                                         

UPDATE #p9_FILE2 SET Stage=0                                                                                 

UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)                                                                                                           

WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                                                                                                           

AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)*-1                                                                                                            

                                                                         

UPDATE #p9_FILE2 SET NSEFO_NONCASH=0                                                                                                            

UPDATE #p9_FILE2 SET NSEFO_NONCASH=Stage                                                      

UPDATE #p9_FILE2 SET Stage=0                                                                                                            

*/                                                                          

                              

update #p9_File2  set VarMarginShortFall_AftAdjCurrDay=vARmARGINsHORTFALL+NSefo_jv+MCD_JV+NSX_JV+NSEFO_NONCASH+MCD_NONCASH+NSX_NONCASH                                                                                                            

where  vARmARGINsHORTFALL < 0                                                                                                             

    

update #p9_File2  set VarMarginShortFall_AftAdj=VarMarginShortFall_AftAdjCurrDay    

    

/*    

--- Used to compute min of last 4 days for squareoff.. not required as per PRMS id: 10391261 dt...14/08/2015...    

update #p9_File2 set VarMarginShortFall_AftAdj=(Case when #p9_File2.VarMarginShortFall_AftAdjCurrDay > q.VarMarginShortFall_AftAdjCurrDay               

then #p9_File2.VarMarginShortFall_AftAdjCurrDay else q.VarMarginShortFall_AftAdjCurrDay end)              

from              

(              

select Party_code,MAX(VarMarginShortFall_AftAdjCurrDay) as VarMarginShortFall_AftAdjCurrDay               

from VMSS_data_BTST x join              

(select top 3 processdate from (select distinct processdate from VMSS_data_BTST where processdate < @BSElastBillDate) a order by processdate) y               

on x.processdate=y.processdate                           

group by party_code              

) q where #p9_File2.party_code=q.party_code              

*/      

                                  

/* Var Margin % */                                                                              

          

truncate table vmss_holding_BTST                                                                    

insert into vmss_holding_BTST                                                                                                  

(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate)                                            

      

select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,                                                                                                  

SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS [SrNo],0,ISIN,ActualSqOffQty=CONVERT(int,0),0.00 from #p9_hold                                                                                                  

                                                                    
select distinct SRC from  vmss_holding_BTST
/*                                                                                                

select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #p9_filex                                                                                                   

from #p9_file2 where VarMarginShortFall_AftAdj < 0            

                                                                            

Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                                                                  

declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                                                                  

                                                             

select @totctr=MAX(srno) from #p9_filex                                                                                                  

                                                                                       

While @ctr <= @totctr                                                                                                  

Begin                                                                                           

                                                               

set @SqOffVal=0                                                          

select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdj*-1 from #p9_filex where srno=@ctr                                                                                                                  

select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],* into #p9_holdadj from vmss_holding_BTST a join                                                                                                  

(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                         

where party_code=@pcode and Clsrate > 0                                                                                

                                                                            

select @Xtotctr=MAX(Srno) from #p9_holdadj                                                                                                   

set @TSqOffVal=0                                                                                                  

                                                                              

set @Xctr=1                                                                                      

                                                                              

While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 

BEGIN      

                                                                          

select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                         

                                              

if (@SqOffVal<@TSqOffVal)                                                          

set @TSqOffVal=@SqOffVal                                                                                                  

                                                          

update vmss_holding_BTST                                                                           

set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                                                   

SqOffseq=@xctr                                                                                     

where id=@id                                                                            

                                                                              

set @SqOffVal=@TSqOffVal                                                                                                  

                  

set @Xctr=@Xctr+1                                                                                                  

END                                                                                                  

                                                                                       

DROP TABLE #p9_holdadj                                        

                                                                                       

set @ctr=@ctr+1                                        

end                                                                                                  

                                                                                      

drop table #p9_filex                                                                                                  

                                                            

truncate table vmss_holding_hist                                                                                                   

insert into vmss_holding_BTST(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq)                                                     

select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq from vmss_holding_BTST                                                                                   


update #p9_file2 set SquareOffValue=b.SqVal from                                                          

(                                                                                        

select party_code,sum(SquareOffQty*Clsrate) as SqVal from vmss_holding_BTST where isnull(SquareOffQty,0) > 0                                                                                         

group by party_code                                                                                        

) b                                                                                                   

where #p9_file2.party_code=b.party_Code                                                                                                  

*/                                                                                

                                                                                    

/*                                                                                                        

update #p9_File2 set SquareOffValue=                                                                                                           

Case when (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 < (Holding_BHC)*-1 then (Holding_BHC)*-1                                                                                                            

else (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 end                                  

where LeverageMultiplier > 0                                                                                                            

*/                                                                                                  

                                                                           

/*                                                                          

UPDATE #p9_File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                         

(                                                                              

SELECT party_code,NOOFDAYS FROM VMSS_data_BTST WHERE CONVERT(DATE,processdate) =                                                                                                                                       

(                                                                                 

SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data_BTST                         

WHERE CONVERT(DATE,processdate) < (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data_BTST )                                                

)                                                                                                                                      

) B WHERE #p9_File2.party_code=B.party_code                                                                                                    

                                                                               

UPDATE #p9_File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                                        

          

*/                                                                                   

                                                                      

delete from VMSS_data_BTST where processDate=@BSElastBillDate                                                                                                            

                                                                                       

insert into VMSS_data_BTST(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,                                                                                                  

Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,                                                                                                     

NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,remarks,DP_adj,Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                                                                           


SELECT processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,                                                                                                            

OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,                                              

VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,GETDATE(),'V','',DP_adj,0.00,VarMarginShortFall_AftAdjCurrDay                                                                                                        

FROM #p9_FILE2                                                                                                             

                          

/*                                                                            

insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                        
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks)                                                                                   
select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                                            
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks from VMSS_data_BTST                                                                     
*/                                                              

                                                                    

End try                                                                                                                                 

BEGIN CATCH                                                                                                                                    

  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                          

  select GETDATE(),'VMSS_Calculation_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                                                                               

                      

  DECLARE @ErrorMessage NVARCHAR(4000);                                                            

  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                          

  RAISERROR (@ErrorMessage , 16, 1);                                  

End catch                                                                                 

                      

SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Calculation_NoNRMS_vishal
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_Calculation_NoNRMS_vishal]                                                                                                      
as                                                                                                                
                                                                                                                
SET XACT_ABORT ON                                                                                                                
Set nocount on                                                                                                                
BEGIN TRY                                                                                                                                        
  
 exec VMSS_upd_ASB7_Days    
                                                                             
 Declare @LowerCapAmt as money = -1000  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                                                                
 Declare @LowerCapNonCash as money = 500  /* NONCASH COLLATERAL MOVEMENT : always +ve */                                                                                                                
 Declare @BSElastBillDate datetime = (select MAX(vdt)+1 from anand1.account.dbo.ledger WITH(NOLOCK) 
 where vtyp=15 and vdt <=convert(varchar(11),getdate()) and narration like 'SETTNO=_______NSECMNBill Posted')                                                                                                                
 print  @BSElastBillDate                                                                                                      
 
 select                                                                                                                 
 @BSElastBillDate  as processDate,                                                                                                                
 --Entity,                                                                                                                
 segment=a.Co_code,                                                                                                                
 a.Party_code,                                                                                                                
 a.Ledger as Balance,                                                                                                                
 CONVERT(money,0)  as UnsettledCr,                                                                                                                
 CONVERT(money,0) as UnsettledDr,                                                                                                                
 a.Unrecosiled_Credit as UnrecoAmt,                                                                                                                
 CONVERT(money,0) as ShortSellValue,                                                                                                                
 a.Imargin as MarginAmt,                                                                                                                
 a.Deposit,                                                                                                                
a.Cash_Colleteral as CashColl,                                                                                                                
a.NonCash_Colleteral as NonCashColl,                                                                                                                
Holding_total,                                                                                                                
Holding_Approved,                                                                                                                
CONVERT(money,0) as OtherDebit,                                                      
CONVERT(int,0) as NonCashConsideration,          
CONVERT(money,0) as Net,   
CONVERT(money,0) as EarlyPayinValue,                    
CONVERT(money,0) as LeverageMultiplier,                            
CONVERT(money,0) as VarMarginShortFall,                                                                
CONVERT(money,0) as SquareOffValue,                                    
CONVERT(money,0) as MgnAdjNonCash,                                                       
CONVERT(money,0) as MgnAdjNonLed                                                                  
into #p9_File1                                                     
from (select * from General.dbo.RMS_DtClFi with (nolock) where 1=2)a 
--a join (select segment,entity from intranet.cms.dbo.ncms_entity with (nolock) where entity='Equity') b         on a.Co_code=b.segment                                                                       
                                                                                                       
                                                                                                       
 /* update Holding */                                                                                                      
select EXCHANGE,sett_no,SEtt_type,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN Upper(DUMMY1) ELSE Upper(SCRIP_CD) END) AS scrip_cd,                                                                                                                
(CASE WHEN EXCHANGE='NSECM' THEN DUMMY2 ELSE series END) AS series,Party_code,Qty,                                                                            
CLSRATE,                                                                                                                
Total AS VBHC,                                                                              
CONVERT(MONEY,0) AS HAIRCUT,                                                                                                                
CONVERT(MONEY,0) AS VAHC,                                                                                                    
SPACE(10) AS CATEGORY,                                                                                                                
source AS SRC,                                                                        
ISIN                                                                        
INTO #p9_HOLD                                                                                                                
from vmss_rms_holding where source in ('SI','SO','H','D')                    
  
update #p9_HOLD set series=b.NseSeries from general.dbo.scrip_master b  
where #p9_HOLD.isin=b.isin and b.NseSeries='EQ'   
  
                    
SELECT  party_code,isin,SUM(qty) as NQty into #nqty from #p9_hold group by party_code,isin having SUM(qty) <=0          
DELETE T1 FROM #p9_hold T1 INNER JOIN #nqty T2 ON T2.party_code = T1.party_code AND T2.isin = T1.isin          
DROP TABLE #nqty          
                                                                                                       
update #p9_HOLD set clsrate=b.rate from General.dbo.cp_bsecm b where #p9_HOLD.scrip_Cd=b.scode and #p9_HOLD.clsrate=0                                                                                                                
                    
update #p9_HOLD set clsrate=b.cls                                                                                                                 
from General.dbo.cp_nsecm b                                                                                                       
where #p9_HOLD.scrip_Cd=b.scrip and #p9_HOLD.series=b.series and #p9_HOLD.clsrate=0 and exchange='NSECM'                                                                                                              
                    
update #p9_HOLD set VBHC=clsrate*Qty                                                                                           
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                    
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                               
where #p9_HOLD.SCRIP_cD=B.BSECODE AND #p9_HOLD.EXCHANGE='BSECM'                                                                                                                
    
    
/*Added to handle scrip:idfc ltd as it has shifted from BE to Eq as suggested by Vishal Gohil on Dec 10 2015*/    
--select * from #p9_HOLD where  isin='INE092T01019' and series='EQ'    
--update #p9_HOLD set series='EQ' where isin='INE092T01019' and series='BE'    
    
/* update a set series=b.Currenteries from #p9_HOLD a inner join VMSS_Exception_NSESeries b on a.isin=b.isin and a.series=b.previousseries  */  
    
/*******************************************************************/    
    
                    
update #p9_HOLD set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                                                                      
(select a.*,b.bsecode,b.nsesymbol,b.NSEseries from General.dbo.Scrip_ValidOnlyVar a with (nolock) join General.dbo.scrip_master b with (nolock) on a.isin=b.isin) b                                                  
where #p9_HOLD.SCRIP_cD=B.NSESYMBOL AND #p9_HOLD.SERIES=B.NSESERIES AND #p9_HOLD.EXCHANGE='NSECM'                                                              
      
                    
update #p9_HOLD set Haircut=100,CATEGORY='Poor' where Category='' and Haircut=0                                                                                                                
                    
update #p9_HOLD set VAHC=VBHC*((100-HAIRCUT)/100.00)


--select * from #p9_File1 where Balance<-1000 order by Balance asc
 
 /*T_day>0
 and  
 rms_date=(select max(rms_date)from  mis.dbo.asb7_clidetails_crdet_process2)) a,                                                                                                      
(select * from General.dbo.company where entitytype in ('EQ','COMMO') and bo_active=1) b */

--select distinct entitytype,co_code,segment from  General.dbo.company                                                                                                    
                                                                                                      
update #p9_file1                                                                 
set ProcessDate=@BSElastBillDate,Balance=0,UnsettledCr=0,UnsettledDr=0,UnrecoAmt=0,ShortSellValue=0,                                                                                       
MarginAmt=0,Deposit=0,CashColl=0,NonCashColl=0,Holding_total=0,Holding_Approved=0,OtherDebit=0,NonCashConsideration=0,Net=0,                                                                                                      
EarlyPayinValue=0,LeverageMultiplier=0,VarMarginShortFall=0,SquareOffValue=0                                                                                                      


drop table #codes
select party_code,net_ledger  into #codes from general.dbo.tbl_rms_collection_cli where exp_gross<>0.00  and net_ledger<0.0                                                
                    
insert into #p9_File1(segment,party_code,Balance)
select co_code,r.party_code,ledger from #codes c inner join general.dbo.rms_dtclfi r on c.Party_Code=r.Party_code 


--select * from #p9_File1 where Balance>-1000 order by Balance desc
                                                                                      
update #p9_File1 set  holding_total=b.VBHC,holding_approved=b.VAHC from                                                                 
(select party_code,exchange,VBHC=sum(VBHC),VAHC=sum(VAHC)                                                                                                                
from #p9_hold group by party_code,exchange) b                                                                       
where #p9_File1.party_code=b.party_code and #p9_File1.segment=b.exchange 

update  #p9_file1                                                                 
set ProcessDate=@BSElastBillDate,deposit=0.00  

select party_code,bal=sum(balance) into #test1 from #p9_file1 group by party_code 
select * from #test1 where bal<0.00--126203

            --select * from #p9_file1 where party_code='PTA5617'                                                               
                                                                                                      
/* Get Last settlement Date */                                                                                                     
/*                                                                                     
 Declare @sdtcur as datetime,-- @ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59'                                                                                                        
 @ToDate as datetime = convert(varchar(11),getdate())+' 23:59:59'                                  
 select @sdtcur=sdtcur from General.dbo.parameter with (nolock) where sdtcur <= @ToDate and ldtcur >=@ToDate                                           
                                       
/* Fetch effective Ledger Balance - Only Bill's effective date else voucher date*/                                 
                
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
 into #p9_BSECM                                                                                                                
 from anand.account_ab.dbo.ledger a with (nolock)                                                                                       
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and  
 vDT>=@sdtcur and vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                           
 group by cltcode
 
                                      
                                                                                   
 select CLTCODE,                                                                                                  
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                           
 into #p9_NSECM                                                                                                                
from anand1.account.dbo.ledger a with (nolock)                                                                                                                       
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
 vDT>=@sdtcur and  vdt<= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end)                                                                                                                       
 group by cltcode                                                                                                                    
                                                 
 select CLTCODE,                                                                                                                
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                 
 into #p9_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                                                       
 /* where vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= (Case when Vtyp=15 then @BSElastBillDate else @ToDate end) */                                                                                                           
 where-- ( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and
 vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                                 
 select CLTCODE,                                                                          
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_NSX                         
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                                                       
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS')and 
 vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
 group by cltcode                                                                                                                    
                                                               
select CLTCODE,                                                
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
into #p9_MCD                                                                                                    
from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)          
where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
group by cltcode  

 /*added on May 29 to consider commodity segment*/
select CLTCODE,                                                
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
into #p9_MCX                                                                                                   
from ANGELcommodity.ACCOUNTMCDX.DBO.LEDGER a with (nolock)          
where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
group by cltcode 


select CLTCODE,                                                
VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                          
into #p9_NCDEX                                                                                                  
from ANGELcommodity.ACCOUNTNCDX.DBO.LEDGER a with (nolock)          
where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
vDT>=@sdtcur and (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end) <= @ToDate             
group by cltcode                                                                                                                   
  
  
                                                                                                  
 /* Fetch Deposit */  
 
                                                                           
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                 
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                    
 into #p9_dep_BSECM                                                                                                                
 from anand.account_ab.dbo.ledger a with (nolock)                                                                        
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
 vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                      
 group by cltcode                                              
                                    
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSECM from anand1.account.dbo.ledger a with (nolock)                                                           
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
 vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                      
                                                                                                                
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                                                       
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                                                                
 into #p9_dep_NSEFO                                                                                                                
 from angelfo.accountfo.dbo.ledger a with (nolock)                                                                                     
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS')and 
 vDT>=@sdtcur and vdt <= @ToDate and cltcode like '40%'                                                                                                                      
 group by cltcode                                                                                       
                                                                  
 select SUBSTRING(cltcode,3,10) as CLTCODE,                                                                      
 VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                         
 into #p9_dep_NSX                                                                                                                
 from angelfo.accountcurfo.dbo.ledger a with (nolock)                                                                                   
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
 vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                              
 group by cltcode                                       
                                                                                                            
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                   
 into #p9_dep_MCD                        
 from angelcommodity.accountmcdxcds.dbo.ledger a with (nolock)                                   
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
 vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode  
  /*added on May 29 to consider commodity segment*/
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                   
 into #p9_dep_MCX                        
 from ANGELcommodity.ACCOUNTMCDX.DBO.LEDGER  a with (nolock)                                   
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
 vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode 
 
 select SUBSTRING(cltcode,3,10) as CLTCODE,VBal=sum(case when drcr='D' then -VAMT else VAMT end)                                                                   
 into #p9_dep_NCDEX                         
 from ANGELcommodity.ACCOUNTNCDX.DBO.LEDGER a with (nolock)                                   
 where --( VTYP<>35 and isnull(enteredby,'')<>'MTF PROCESS') and 
 vDT>=@sdtcur and vdt <= @ToDate and cltcode like '30%'                                                                                                                      
 group by cltcode                                                                                               
                                                                         
 update #p9_File1 set Balance=b.Vbal from #p9_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set Balance=b.Vbal from #p9_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                                                      
 update #p9_File1 set Balance=b.Vbal from #p9_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode   
 update #p9_File1 set Balance=b.Vbal from #p9_MCX b where #p9_File1.segment='MCX' and #p9_File1.party_Code=b.cltcode                                                                                                      
 update #p9_File1 set Balance=b.Vbal from #p9_NCDEX b where #p9_File1.segment='NCDEX' and #p9_File1.party_Code=b.cltcode                                            

                                          
                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_BSECM b where #p9_File1.segment='BSECM' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSECM b where #p9_File1.segment='NSECM' and #p9_File1.party_Code=b.cltcode                                                                                                                
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSEFO b where #p9_File1.segment='NSEFO' and #p9_File1.party_Code=b.cltcode                                                                                          
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NSX b where #p9_File1.segment='NSX' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCD b where #p9_File1.segment='MCD' and #p9_File1.party_Code=b.cltcode                                                                                          
 update #p9_File1 set deposit=b.Vbal from #p9_dep_MCX b where #p9_File1.segment='MCX' and #p9_File1.party_Code=b.cltcode                                                                           
 update #p9_File1 set deposit=b.Vbal from #p9_dep_NCDEX b where #p9_File1.segment='NCDEX' and #p9_File1.party_Code=b.cltcode                                                                                          
 */
                                                                                                     
 update #p9_File1 set Earlypayinvalue=isnull(b.EPV,0.00) from                      
 (select Exchange,party_code,SUM(total) as EPV from VMSS_EarlyPayinData group by Exchange,party_code) b          
 where #p9_File1.party_code=b.party_Code and #p9_File1.segment=b.exchange                                                                                              
                                                                                                                 
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                             
 (           
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelfo.nsefo.dbo.tbl_clientmargin with (nolock)                                                        
 where MarginDate = (select MAX(margindate) from angelfo.nsefo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                   
  ) b                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSEFO'                                                                                                      
                                                                                                      
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                            
 (                                                                                                      
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                                   
 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                         
  ) b                                                                                                       
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCD'                                                                                           
                                                                                        
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                      
 (                                                                             
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                      
 from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock)                                                                                                      
 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                          
) b                                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NSX' 
  
  /*added on May 29 to consider commodity segment*/
  update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                            
 (                                                                                                      
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                                                                                      
 from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock)                                                                                   
 where MarginDate = (select MAX(margindate) from angelcommodity.MCDXCDS.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                         
  ) b                                                                                                       
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='MCX'                                                                                           
                                                                                        
 update #p9_File1 set MarginAmt=B.initialmargin,CashColl=b.Cash_Coll from                                                                                                      
 (                                                                             
 select MarginDate,party_code,Cash_coll,initialmargin = isnull(initialmargin,0)+isnull(MTMmargin,0) + isnull(AddMargin,0)                                      
 from ANGELCOMMODITY.NCDX.dbo.tbl_clientmargin with (nolock)                                                                                                      
 where MarginDate = (select MAX(margindate) from angelfo.nsecurfo.dbo.tbl_clientmargin with (nolock) where margindate <= GETDATE())                                                                                          
) b                                                                                    
  where #p9_file1.party_code=b.party_code and #p9_file1.segment='NCDEX'                                                                                                      
 -------------------------------------------------------------------------------------------------------------------------------------------                                                                             
 update #p9_File1 set NonCashColl=b.NonCashColl                                         
 from VMSS_Client_collateral_NonEquity_NoBrInfo b                                                
 where #p9_File1.party_code=b.party_code and #p9_file1.segment=b.co_code                                                                                 
                                                                
/* Excess Collateral adjustement with Ledger Debit */            
 update #p9_File1 set NonCashColl=NonCashColl+Balance                                                                                                     
 where NonCashColl > 0 and Balance < 0 and segment in ('NSEFO','MCD','NSX','MCX','NCDEX')                                                               
                                                                               
 /* GEnerate Summarised Data */                    
                                                           
delete from #p9_file1 where party_code in (select party_code from mis.sccs.dbo.Combine_legal) --32                                                             
delete from #p9_file1 where party_code in (select party_code from General.dbo.client_Details where (branch_cd='NRIS' or sub_broker='BH')) --50                         
                        
/*Remove Tday and T+1 day clients ,added by abha as suggested by vishal gohil*/                           
                        
--delete from #p9_file1 where party_code in (select Party_Code         
--from General.dbo.tbl_projrisk_t1day_data where updt=(select max(updt) from General.dbo.tbl_projrisk_t1day_data))           
--/* -----T day------ */        
        
          
                             
--delete from #p9_file1 where party_code in (select party_Code from General.dbo.tbl_projrisk_t2day_data         
--where updt=(select max(updt) from General.dbo.tbl_projrisk_t2day_data))            
--/*------T+1day --------*/        
        
      select distinct segment from #p9_file1    
                                                                                     
select                                                                                                                 
max(processDate) as processDate,Party_code,convert(int,1) as NoofDays,                                                                                                                
sum(Balance) as Balance,sum(MarginAmt) as MarginAmt,sum(Deposit) as Deposit,                                               
sum(CashColl) as CashColl,sum(NonCashColl) as NonCashColl,sum(Holding_total) as Holding_BHC,                                                                                                   
sum(Holding_Approved) as Holding_AHC,sum(OtherDebit) as OtherDebit,                                                
sum(EarlyPayinValue) as EarlyPayinValue,sum(LeverageMultiplier) as LeverageMultiplier,                                                                                               
sum(VarMarginShortFall) as VarMarginShortFall,                                 
Convert(money,0) as NSEFO_JV,                                                                                                                
Convert(money,0) as NSEFO_NonCash,                                                                                                                
Convert(money,0) as MCD_JV,                                                                                               
Convert(money,0) as MCD_NonCash,                                                                                                                
Convert(money,0) as NSX_JV,                                                                                                                
Convert(money,0) as NSX_NonCash, 
Convert(money,0) as MCX_JV,                                                                                                                
Convert(money,0) as MCX_NonCash, 
Convert(money,0) as NCDEX_JV,                                                                                                                
Convert(money,0) as NCDEX_NonCash,                                                              
Convert(money,0) as VarMarginShortFall_AftAdj,                                                                                               
Convert(money,0) as Stage,                                                                                                                
sum(SquareOffValue) as SquareOffValue,Sum(Case when Segment='BSECM' then BAlance else 0 end) as BSECM_Balance,                                                                                                                 
Sum(Case when Segment='NSECM' then BAlance else 0 end) as NSECM_Balance,                                                         
Convert(money,0) as DP_adj ,                
Convert(money,0) as VarMarginShortFall_AftAdjCurrDay                                                     
into #p9_file2                                                                                                                
from #p9_file1 where segment in ('BSECM','NSECM','NSEFO','MCD','NSX','MCX','NCDEX','BSX','MTF')                                                                                                                
group by Party_code


--select count(1) from #test1 where bal>= -1000
--select count(1) from #p9_file2 where Balance>= -1000                                     
                                                           
/* delete Client with Cash Credit effective Balance */    

--select * from #p9_file2 where  balance>-1000 order by  balance desc                                                                                                
                                                              
Delete from #p9_file2 where balance >= -1000       --64013                   
Delete from #p9_file2 where party_code in (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF')) --142                                                                                 
Delete from #p9_file1 where party_Code not in (select party_code from #p9_file2)   --217401                                                                           
/*Delete from #p9_file2 where Holding_BHC <= 0 */ --commented on Aug 26 2016  as required by Vishal Gohil mail dated Aug 24 2016                                                    
                                  
update #p9_File2 set VarMarginShortFall=(case when Holding_AHC+Balance+Deposit+isnull(EarlypayinValue,0.00) < -1000 then Holding_AHC+Balance+Deposit+isnull(EarlypayinValue,0.00)  else 0 end)                                                                                   
update #p9_File2 set VarMarginShortFall=(case when Holding_AHC+Balance< -1000 then Holding_AHC+Balance+Deposit+isnull(EarlypayinValue,0.00)  else 0 end)                                                                                   

--select aa=Holding_AHC+Balance+Deposit+isnull(EarlypayinValue,0.00),bb=Holding_AHC+Balance,party_code from #p9_File2
--select * from #p9_File2 where VarMarginShortFall<0.00
                                          
update #p9_File2 set LeverageMultiplier=                                                                                                                
Case when 100-(Holding_AHC/Holding_BHC)*100.00 > 100 then 100 else 100-(Holding_AHC/Holding_BHC)*100.00 end                                                                                                                
where Holding_BHC > 0                                                                                                  
                                                                          
update #p9_file1 set MgnAdjNonCash=0 where MgnAdjNonCash is null                                                                                            
update #p9_file1 set MgnAdjNonLed=0 where MgnAdjNonLed is null                                                    
                        
/* Adj.Margin with Non_Cash Scripwise */                                                                       
                                      
update vmss_NonCash set FinalAmount=Amount-(Amount*(MarginHC/100.00))                                              
update vmss_noncash set MarginSqOffQty=0                                                    
/*---- Full NonCash Getting adjusted against Margin */                                                                              
update vmss_noncash set MarginSqOffQty=Qty from                                                                              
(                                                                              
/*                                                              
select a.*,b.MarginAmt from                                                                              
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                              
(select segment,party_code,MArginAmt from #p9_file1 where MArginAmt > 0) b                        
on a.party_code=b.party_code and a.co_code=b.segment                                                                              
where b.MArginAmt >= a.VAHC                                                               
*/                                    
select a.*,b.MarginAmt from                                                    
(select party_code,co_Code,SUM(finalAmount) as VAHC from vmss_noncash group by party_code,co_Code) a join                                                                            
(select segment,party_code,MArginAmt+(Case when balance < 0 then -balance else 0 end) as MArginAmt from #p9_file1 where MArginAmt > 0) b                                                                       
on a.party_code=b.party_code and a.co_code=b.segment                                                                            
where b.MArginAmt >= a.VAHC                                                                
) x where vmss_noncash.party_code=x.party_Code and vmss_noncash.co_code=x.co_Code                                                
                                                                  
/*---- Partial NonCash Getting adjusted against Margin */                                                       
                                          
                                                         
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex from                                                                               
/* (select * from #p9_file1 where marginAmt > 0 ) a  left outer join             */                                                            
(select                       
processDate,segment,Party_code,Balance,UnsettledCr,UnsettledDr,UnrecoAmt,ShortSellValue,                                                   
(Case when Balance < 0 then MarginAmt-Balance else MArginAmt end) as MarginAmt,                                                      
Deposit,CashColl,NonCashColl,Holding_total,Holding_Approved,OtherDebit,NonCashConsideration,                                                      
Net,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,SquareOffValue,MgnAdjNonCash,MgnAdjNonLed                                                      
from #p9_file1 where segment in ('NSEFO','MCD','NSX','MCX','NCDEX')) a  left outer join                                                     
(select co_code,party_code from vmss_noncash where MarginSqOffQty <> 0 group by party_code,Co_Code) b                                                                              
on a.party_code=b.party_code and a.segment=b.co_Code                                                                              
join (select co_code,party_code from vmss_noncash where MarginSqOffQty = 0 group by party_code,Co_Code) c                                                                              
on a.party_code=c.party_code and a.segment=c.co_Code                                                                              
where b.Party_Code is null                                                                              
                                                    
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                               
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0,@segment as varchar(10) = ''                                                                                
                                                
select @totctr=MAX(srno) from #p9_filex                                                                
                                                                  
While @ctr <= @totctr                                                                                                  
Begin                    
                                                                             
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=MarginAmt,@segment=segment from #p9_filex where srno=@ctr                                                                 
                     
select ROW_NUMBER() OVER (ORDER BY b.seqid,FinalAmount desc) AS [SrNo],                                                           
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,MarginHC as HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,                                                                              
clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty                                                                              
into #p9_holdadj from vmss_noncash a join                                                                                        
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                             
where party_code=@pcode and Clsrate > 0 and MarginHC < 100 and co_Code=@segment                             
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                        
set @TSqOffVal=0                                                                                  
                                                                  
set @Xctr=1                                                                                        
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                           
BEGIN                                                                     
                                                                         
select @TSqOffVal=FinalAmount,@qty=Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                
set @TSqOffVal=@SqOffVal                                                                                             
                                                                  
      
update vmss_noncash                                                                                        
set MarginSqOffQty=ceiling(Case when @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) <= @qty                                             
then @TSqOffVal/(@clsrate-(@clsrate*(MarginHC/100.00))) else @qty end)                                                                                    
where id=@id  and  MarginHC < 100                                                           
                                                                                  
set @SqOffVal=@SqOffVal-@TSqOffVal                                                                          
set @Xctr=@Xctr+1                                                                                                  
      
END                                                                                                  
                                 
DROP TABLE #p9_holdadj                                                                                                  
                                                                                        
set @ctr=@ctr+1                                
end                                                                                                  
         
drop table #p9_filex                                                                                                  
                                                                  
/* Calculation Margin Adjusted with NonCash */                                                                                                  
                                                                  
/*    
update #p9_file1 set MgnAdjNonCash=(Case when MarginAmt-(NonCashColl+CashColl) < 0 then MarginAmt else (NonCashColl+CashColl) end)                                                                          
where segment in ('NSEFO','MCD','NSX')                                                                                                  
*/                                                                              
                                                                  
update #p9_file1 set MgnAdjNonCash=B.AdjWithMargin from                                                                              
(                               
select co_Code,party_code,sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) as AdjWithMargin from vmss_noncash                                                                               
group by co_Code,party_code                                                                              
having sum(MArginSqOffQty*(clsrate-(clsrate*(MarginHC/100.00)))) > 0                                            
) b where #p9_file1.party_code=b.party_Code and #p9_file1.segment=b.co_Code                                                        
                                                                                      
/* Calculation Margin Adjusted with Ledger Credit */                                                                                                  
update #p9_file1 set MgnAdjNonLed=(Case                                                 
when Balance > (MarginAmt-MgnAdjNonCash) and MarginAmt-MgnAdjNonCash > 0 and balance > 0 then (MarginAmt-MgnAdjNonCash)                                                                                        
when Balance <= (MarginAmt-MgnAdjNonCash) and balance > 0 then Balance                                                                                                  
else 0 end) where segment in ('NSEFO','MCD','NSX','MCX','NCDEX')                                                                   
                                             
                                       
                                                                                   
update  #p9_File2 set NSEFO_JV=b.AdjWithLedgerCr /*,NSEFO_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                                                             
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                                                                   
from #p9_file1 where segment='NSEFO' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                                                     
                
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr /*,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                      
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                     
from #p9_file1 where segment='NSX' and                                                                     
(Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                              
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
                                                                   
/*                                                                              
update  #p9_File2 set NSX_JV=b.AdjWithLedgerCr,NSX_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) from                                                                                                                
(              
select party_code,AdjWithLedgerCr=Balance-MgnAdjNonLed,AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                          
from #p9_file1 where segment='NSX'                                                                                                     
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                
*/                                                                               
update  #p9_File2 set MCD_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                             
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                
from #p9_file1 where segment='MCD' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                    
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 

 /*added on May 29 to consider commodity segment*/                                                                   
update  #p9_File2 set MCX_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                             
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                
from #p9_file1 where segment='MCX' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                    
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 

update  #p9_File2 set NCDEX_JV=b.AdjWithLedgerCr /*,MCD_NonCash=(Case when AdjWithNonCashColl > 0 then AdjWithNonCashColl  else 0 end) */ from                                                                             
(                                                                                                                
select party_code,                                                                              
AdjWithLedgerCr=(Case when Balance > 0 then Balance-MgnAdjNonLed else 0 end),                                                                              
AdjWithNonCashColl=NonCashColl-MgnAdjNonCash                                
from #p9_file1 where segment='NCDEX' and (Balance-MgnAdjNonLed > 0 OR NonCashColl-MgnAdjNonCash > 0)                                                                    
) b where #p9_File2.party_code=b.party_code and #p9_File2.vARmARGINsHORTFALL < 0                                                                                                                 
   
                                                                                                           
                                                                  
UPDATE #p9_File2 SET NSEFO_JV=-vARmARGINsHORTFALL  WHERE NSEFO_JV > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV > 0                                        
UPDATE #p9_File2 SET mcd_jv=-vARmARGINsHORTFALL-NSEFO_jv  WHERE mcd_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv >= 0             
UPDATE #p9_File2 SET NSX_jv=-VARMARGINSHORTFALL-NSEFO_JV-mcd_jv  WHERE nsx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv >= 0                                                      

 /*added on May 29 to consider commodity segment*/     
UPDATE #p9_File2 SET mcx_jv=-vARmARGINsHORTFALL-NSEFO_JV-mcd_jv-NSX_jv  WHERE mcx_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv+mcx_jv >= 0             
UPDATE #p9_File2 SET ncdex_jv=-vARmARGINsHORTFALL-NSEFO_JV-mcd_jv-NSX_jv-mcx_jv  WHERE ncdex_jv > 0 AND vARmARGINsHORTFALL < 0 AND VARMARGINSHORTFALL+NSEFO_JV+mcd_jv+NSX_jv+mcx_jv+ncdex_jv >= 0             

                                                                  
UPDATE #p9_File2 SET NSEFO_JV=0 where NSEFO_JV<0                                                                                        
UPDATE #p9_File2 SET mcd_jv=0 where mcd_jv<0                                                                                        
UPDATE #p9_File2 SET NSX_jv=0 where NSX_jv<0                              
 /*added on May 29 to consider commodity segment*/ 
UPDATE #p9_File2 SET mcx_jv=0 where mcx_jv<0                                                                                        
UPDATE #p9_File2 SET ncdex_jv=0 where ncdex_jv<0                                                                                                     
/* Adjust VarMArgin Shortage with NonCash Collateral */                                                                              
                                      
update vmss_NonCash set FinalAmount=Amount*(Haircut/100.00)                                                   
                                                                  
/*----- NSEFO-----*/                                         
                                                                  
set @totctr  = 0                          
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                        
set @Xctr = 1                                                                              
SET @qty = 0                             
set @TSqOffVal = 0                                                                                  
set @SqQty = 0                                                                    
set @clsrate =0                                                                                  
set @id = 0                                                                               


                                                
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex1                                                                              
from                                                                        
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+mcx_jv+ncdex_jv as VarMarginShortFallAftJV from #p9_file2 where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+mcx_jv+ncdex_jv < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSEFO' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                                                                     
select @totctr=MAX(srno) from #p9_filex1                                                                                                  
                                                                    
While @ctr <= @totctr                                                        
Begin                                                                                                  
                           
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex1 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                             
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                   
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj1                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                               
where party_code=@pcode and Clsrate > 0 and co_code='NSEFO' and haircut < 100                                              
                                                                  
select @Xtotctr=MAX(Srno) from #p9_holdadj1                                                                                                   
set @TSqOffVal=0          
set @Xctr=1                                                             
      
      
                        
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN                                                                      
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj1 where srno=@xctr                                                              
                         
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                                                                  
                                                            
update VMSS_NonCash                                                                           
set                                         
/* SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                        
SqOffseq=@xctr                                                                                     
where id=@id  and  Haircut < 100                                                                                          
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                  
      
set @Xctr=@Xctr+1          
      
                                                                                              
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj1                                                                                        
                                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                    
                                                                                       
update #p9_file2 set NSEFO_noncash=B.AdjustedAmt FROM                                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSEFO' and SquareOffQty > 0                                                                           
group by party_Code      
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                              
                                                                 
/*------ NSX ----*/                                                                
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                                  
set @pcode =''                                                        
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                      
set @SqQty = 0                                                                      
set @clsrate =0                                                           
set @id = 0                                                                               
                                                   
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex2                                                                     
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+mcx_jv+ncdex_jv +NSEFO_noncash as VarMarginShortFallAftJV from #p9_file2                     
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash < 0) a join                                                                              
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NSX' group by party_code) c                                                                              
on a.party_code=c.party_code                                                                              
                              
select @totctr=MAX(srno) from #p9_filex2                                                                                                  
                                                                                        
While @ctr <= @totctr                                                                                              
Begin                                                                                                  
                                                                          
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex2 where srno=@ctr                                                                              
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj2                                                                               
from VMSS_NonCash_BalAfterMargin a join                                                                                                  
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='NSX'  and haircut < 100                             
                                       
select @Xtotctr=MAX(Srno) from #p9_holdadj2                                                                                                   
set @TSqOffVal=0                                                                                         
                                                                  
set @Xctr=1                                                           
          
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                 
BEGIN             
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj2 where srno=@xctr                       
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal                                                               
                                                                  
update VMSS_NonCash                                                                              
/*set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),                                        
SqOffseq=@xctr                                                                                  
where id=@id and Haircut < 100      
           
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                                                  
END                                                                                                  
                                                                                        
DROP TABLE #p9_holdadj2                                                                                                  
                                                                        
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                                              
drop table #p9_filex2                                                                                
                                                        
update #p9_file2 set NSX_noncash=B.AdjustedAmt FROM                                                              
(                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                               
from VMSS_NonCash_BalAfterMargin where co_Code='NSX' and SquareOffQty > 0                                               
group by party_Code                                                              
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE                                                                              
                                                                   
                                                                  
/*------ MCD ----*/                                                                              
                   
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                
set @SqQty = 0                                                                                  
set @clsrate =0                                                                                  
set @id = 0                                
                                        
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex3                                                                              
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+mcx_jv+ncdex_jv +NSEFO_noncash+MCD_noncash as VarMarginShortFallAftJV from #p9_file2                                                                               
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash < 0) a join                                            
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='MCD' group by party_code) c                                      
on a.party_code=c.party_code                                            
                                                                     
select @totctr=MAX(srno) from #p9_filex3                                                     
                                    
While @ctr <= @totctr                                                                                                  
Begin                          
                                                                
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex3 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj3                                                                  
from VMSS_NonCash_BalAfterMargin a join              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='MCD' and haircut < 100                                                                                                
                                         
select @Xtotctr=MAX(Srno) from #p9_holdadj3                               
set @TSqOffVal=0                                                                                                  
                                                                  
set @Xctr=1                                                 
                                                                     
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                               
BEGIN                                                                                                  
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj3 where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal               
                                                                  
update VMSS_NonCash                                                                                        
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),             
SqOffseq=@xctr                                                                                     
where id=@id and Haircut < 100                                                                                          
          
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                         
END                                                        
                                                                                        
DROP TABLE #p9_holdadj3                                                                                                  
                         
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                     
drop table #p9_filex3                                                                                
                                                                  
update #p9_file2 set MCD_noncash=B.AdjustedAmt FROM                                                                 (                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                              
from VMSS_NonCash_BalAfterMargin where co_Code='MCD' and SquareOffQty > 0                                                                           
group by party_Code                                                            
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE      
/*------ MCX ----*/                                                                              
                   
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                
set @SqQty = 0                                                                                  
set @clsrate =0                                                                                  
set @id = 0                                
                                        
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex4                                                                              
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+mcx_jv+ncdex_jv +NSEFO_noncash+MCD_noncash+NSX_noncash  as VarMarginShortFallAftJV from #p9_file2                                                                               
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash +NSX_noncash< 0) a join                                            
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='MCX' group by party_code) c                                      
on a.party_code=c.party_code                                            
                                                                     
select @totctr=MAX(srno) from #p9_filex4                                                     
                                    
While @ctr <= @totctr                                                                                                  
Begin                          
                                                                
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex4 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj4                                                                  
from VMSS_NonCash_BalAfterMargin a join              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='MCX' and haircut < 100                                                                                                
                                         
select @Xtotctr=MAX(Srno) from #p9_holdadj4                               
set @TSqOffVal=0                                                                                                  
                                                                  
set @Xctr=1                                                 
                                                                     
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                               
BEGIN                                                                                                  
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj4 where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal               
                                                                  
update VMSS_NonCash                                                                                        
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),             
SqOffseq=@xctr                                                                                     
where id=@id and Haircut < 100                                                                                          
          
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                         
END                                                        
                                                                                        
DROP TABLE #p9_holdadj4                                                                                                  
                         
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                     
drop table #p9_filex4                                                                                
                                                                  
update #p9_file2 set MCX_noncash=B.AdjustedAmt FROM                                                                 (                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                              
from VMSS_NonCash_BalAfterMargin where co_Code='MCX' and SquareOffQty > 0                                                                           
group by party_Code                                                            
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE      
 ------------------
/*------ NCDEX ----*/                                                                              
                   
set @totctr  = 0                                                                                  
set @ctr = 1                                                                                  
set @SqOffVal = 0                                                                  
set @pcode =''                                                                                  
set @Xtotctr = 0                                                                                  
set @Xctr = 1                                                                                    
SET @qty = 0                                                                              
set @TSqOffVal = 0                                                
set @SqQty = 0                                                                                  
set @clsrate =0                                                                                  
set @id = 0                                
                                        
select ROW_NUMBER() OVER ( ORDER BY a.party_Code) AS [SrNo],a.* into #p9_filex5                                                                              
from                                                                              
(select *,VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+mcx_jv+ncdex_jv +NSEFO_noncash+MCD_noncash+NSX_noncash+MCX_noncash  as VarMarginShortFallAftJV from #p9_file2                                                                               
where VarMarginShortFall+NSEFO_JV+mcd_jv+nsx_jv+NSEFO_noncash+MCD_noncash+NSX_noncash+MCX_noncash < 0) a join                                            
(select party_code from vmss_noncash where MarginSqOffQty < Qty and Co_Code='NCDEX' group by party_code) c                                      
on a.party_code=c.party_code                                            
                                                                     
select @totctr=MAX(srno) from #p9_filex5                                                     
                                    
While @ctr <= @totctr                                                                                                  
Begin                          
                                                                
set @SqOffVal=0                                                                                                  
select @pcode=party_Code,@SqOffVal=VarMarginShortFallAftJV*-1 from #p9_filex5 where srno=@ctr                                                                                           
                                                                  
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],                                                                              
id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,                                                                              
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,                                                                              
A_Qty,VBHC,VAHC                                                                              
into #p9_holdadj5                                                                  
from VMSS_NonCash_BalAfterMargin a join              
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                                                                                  
where party_code=@pcode and Clsrate > 0 and co_code='NCDEX' and haircut < 100                                                                                                
                                         
select @Xtotctr=MAX(Srno) from #p9_holdadj5                               
set @TSqOffVal=0                                                                                                  
                                                                  
set @Xctr=1                                                 
                                                                     
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                               
BEGIN                                                                                                  
                                                                         
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=A_Qty,@clsrate=Clsrate,@id=id  from #p9_holdadj5 where srno=@xctr                                                                                         
                                                                          
if (@SqOffVal<@TSqOffVal)                                                                                                  
set @TSqOffVal=@SqOffVal               
                                                                  
update VMSS_NonCash                                                                                        
/* set SquareOffQty=floor(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),*/                                        
set SquareOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),             
SqOffseq=@xctr                                                                                     
where id=@id and Haircut < 100                                                                                          
          
set @SqOffVal=@TSqOffVal                                                                                                  
                                                                                
set @Xctr=@Xctr+1                                                                         
END                                                        
                                                                                        
DROP TABLE #p9_holdadj5                                                                                                  
                         
set @ctr=@ctr+1                                                                                                  
end                                                                                                  
                                                     
drop table #p9_filex5                                                                                
                                                                  
update #p9_file2 set NCDEX_noncash=B.AdjustedAmt FROM                                                                 (                                                                              
select party_code,sum(AdjustedAmt) as AdjustedAmt                                                                              
from VMSS_NonCash_BalAfterMargin where co_Code='NCDEX' and SquareOffQty > 0                                                                           
group by party_Code                                                            
) B WHERE #p9_file2.PARTY_CODE=B.PARTY_cODE  
                                                                   
/*----*/ 

---------                                                                             
UPDATE #p9_File2 SET NSEFO_NONCASH=0,MCD_NONCASH=0,NSX_NONCASH=0,MCX_NONCASH=0,NCDEX_NONCASH=0                                                                                                                 
WHERE NSefo_jv+MCD_JV+NSX_JV+MCX_NONCASH+NCDEX_NONCASH+vARmARGINsHORTFALL = 0 AND vARmARGINsHORTFALL < 0                                                                                    
                                                                  
/*                                                                               
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)                                                                          
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL < 0 AND vARmARGINsHORTFALL < 0 AND MCD_NONCASH > @LowerCapNonCash                                                 
AND MCD_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL)*-1                                                     
                                                                                                 
UPDATE #p9_FILE2 SET MCD_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET MCD_NONCASH=Stage                                                                                                                
UPDATE #p9_FILE2 SET Stage=0                                                             
                                             
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)                                                                                                                
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSX_NONCASH > @LowerCapNonCash                                                                                                                
AND NSX_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+MCD_NONCASH)*-1                                                       
                                                                                                     
UPDATE #p9_FILE2 SET NSX_NONCASH=0                                                       
UPDATE #p9_FILE2 SET NSX_NONCASH=Stage                                                                                                             
UPDATE #p9_FILE2 SET Stage=0                                                                                     
UPDATE #p9_FILE2 SET Stage=-(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)                                                                                                               
WHERE NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH < 0 AND vARmARGINsHORTFALL < 0 AND NSEFO_NONCASH > @LowerCapNonCash                                                                                                               
AND NSEFO_NONCASH >=(NSefo_jv+MCD_JV+NSX_JV+vARmARGINsHORTFALL+NSX_NONCASH+MCD_NONCASH)*-1                                                                                                                
                                                                             
UPDATE #p9_FILE2 SET NSEFO_NONCASH=0                                                                                                                
UPDATE #p9_FILE2 SET NSEFO_NONCASH=Stage                                                          
UPDATE #p9_FILE2 SET Stage=0                                                                                                                
*/  

--pselect NSefo_jv+MCD_JV+NSX_JV+MCX_NONCASH+NCDEX_NONCASH+vARmARGINsHORTFALL  from  #p9_File2 where  vARmARGINsHORTFALL<0.00                                                                         
                                  
update #p9_File2  set VarMarginShortFall_AftAdjCurrDay=vARmARGINsHORTFALL+NSefo_jv+MCD_JV+NSX_JV+MCX_JV+NCDEX_JV+NSEFO_NONCASH+MCD_NONCASH+NSX_NONCASH+MCX_NONCASH+NCDEX_NONCASH                                                                                         
where  vARmARGINsHORTFALL < 0                                                                                                                 
        
update #p9_File2  set VarMarginShortFall_AftAdj=VarMarginShortFall_AftAdjCurrDay        
        
/*        
--- Used to compute min of last 4 days for squareoff.. not required as per PRMS id: 10391261 dt...14/08/2015...        
update #p9_File2 set VarMarginShortFall_AftAdj=(Case when #p9_File2.VarMarginShortFall_AftAdjCurrDay > q.VarMarginShortFall_AftAdjCurrDay                   
then #p9_File2.VarMarginShortFall_AftAdjCurrDay else q.VarMarginShortFall_AftAdjCurrDay end)                  
from                  
(                  
select Party_code,MAX(VarMarginShortFall_AftAdjCurrDay) as VarMarginShortFall_AftAdjCurrDay                   
from vmss_Data x join                  
(select top 3 processdate from (select distinct processdate from vmss_Data where processdate < @BSElastBillDate) a order by processdate) y                   
on x.processdate=y.processdate                               
group by party_code                  
) q where #p9_File2.party_code=q.party_code                  
*/          
                                      
/* Var Margin % */                                                                                  
                                                                                     
truncate table vmss_holding                                                                        
insert into vmss_holding                                                                                                      
(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,ISIN,ActualSqOffQty,AvgRate)                                                
          
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,                                                                                                      
SRC,SquareOffQty=CONVERT(int,0),ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS [SrNo],0,ISIN,ActualSqOffQty=CONVERT(int,0),0.00 from #p9_hold                                                                                                      
                                                                        
/*                                                                                                    
select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #p9_filex                                                                                                       
from #p9_file2 where VarMarginShortFall_AftAdj < 0                
                                                                                
Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                                                                      
declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                                                                      
                                                                 
select @totctr=MAX(srno) from #p9_filex                                                                                                      
                                                                                           
While @ctr <= @totctr                                                                                                      
Begin                                                                                               
                                                                   
set @SqOffVal=0                                                              
select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdj*-1 from #p9_filex where srno=@ctr                                                                                                                      
select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],* into #p9_holdadj from vmss_holding a join                                                                                                      
(select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                             
where party_code=@pcode and Clsrate > 0                                                                                    
                                                                                
select @Xtotctr=MAX(Srno) from #p9_holdadj                                                                                     
set @TSqOffVal=0                                                                                                      
                                                                
set @Xctr=1                                                                                          
                                                                                  
While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                                                                     
BEGIN                                                                                          
                                                                              
select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #p9_holdadj where srno=@xctr                                                                                             
                                                  
if (@SqOffVal<@TSqOffVal)                                                              
set @TSqOffVal=@SqOffVal                                                                                                      
                                                              
update vmss_holding                                                                               
set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                                                       
SqOffseq=@xctr                                                                                         
where id=@id                                                                                
                                                                                  
set @SqOffVal=@TSqOffVal                                                                                                      
                      
set @Xctr=@Xctr+1                                                                                                      
END                                                                                                      
                                                                                           
DROP TABLE #p9_holdadj                                            
                                                                                           
set @ctr=@ctr+1                                            
end                                                                                                      
                                                                                          
drop table #p9_filex                                                                                                      
                                                                
truncate table vmss_holding_hist                                                                                                       
insert into vmss_holding(ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq)                                                         
select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq from vmss_holding                                                                                   
                                                                                     
update #p9_file2 set SquareOffValue=b.SqVal from                                                              
(                                                                                            
select party_code,sum(SquareOffQty*Clsrate) as SqVal from vmss_holding where isnull(SquareOffQty,0) > 0                                                                                       
group by party_code                                                                                            
) b                
where #p9_file2.party_code=b.party_Code                                                                                                      
*/                                                                                    
                                                                                        
/*                                                                                                            
update #p9_File2 set SquareOffValue=                                                                                                                
Case when (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 < (Holding_BHC)*-1 then (Holding_BHC)*-1                                                                                                                
else (VarMarginShortFall_AftAdj/LeverageMultiplier)*100 end                                      
where LeverageMultiplier > 0                                                                                                                
*/                                                                                                      
                                                                               
/*                                                                              
UPDATE #p9_File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                             
(                                                                                  
SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                                                                           
(                                                                                     
SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                             
WHERE CONVERT(DATE,processdate) < (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data )                                                    
)                                                                                                                                          
) B WHERE #p9_File2.party_code=B.party_code                                                                                                        
                                                                                   
UPDATE #p9_File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                                            
              
*/                                                                                       

/*  
delete a from #p9_FILE2 a left outer join VMSS_ASB7_Days b on a.party_code=b.Party_code   
WHERE b.Party_code is null  
*/
  
delete from VMSS_data where processDate='Jun  9 2020 12:00AM'                                                                                                                
--commented on Mar 16 2020 as required by v gohil
/*select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with(nolock) where IS_Accepted='Y'*/

--alter table VMSS_data add NCDEX_JV money,NCDEX_NonCash money
                                                                                         
insert into VMSS_data(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,                                                                                                      
Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,                                                                                                         
NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,remarks,DP_adj,Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay,MCX_JV,MCX_NonCash,NCDEX_JV,NCDEX_NonCash)                                                                           
   
SELECT processDate,'',A.Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,                                                                                                                
OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,                                                  
VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,GETDATE(),'V','',DP_adj,0.00,VarMarginShortFall_AftAdjCurrDay,MCX_JV,MCX_NonCash,NCDEX_JV,NCDEX_NonCash                                                                                                            
FROM #p9_FILE2 A  --where VarMarginShortFall<0.00
/*
inner join mis.dbo.ASB7_Clidetails_CrDet_process2  B on A.Party_code=B.party_code
inner join #MTFCodes MTF on A.party_code=mtf.party_code where B.SQ_AMT> 0                                                                                                                
and B.T_day>0 and  rms_date=(select max(rms_date)from  mis.dbo.ASB7_Clidetails_CrDet_process2)  */                                                                 

/*                                                                                
insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                        
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks)                                                                                   
  
  
select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                                                            
  
  
VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks from VMSS_data                                                                     
  
  
*/                                                                  
                                                                        
End try                                                                                                                                     
BEGIN CATCH                                                                                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                              
  select GETDATE(),'VMSS_Calculation_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                                                                                   
                          
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                              
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                                                     
                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.vmss_collateralfetching
-- --------------------------------------------------

/*
Created by :: Abha
Created on :: May 18 2015
Purpose		:: To Fecth Collateral details for shortage adjustment	
*/
--exec vmss_collateralfetching 'May 16 2015'
CREATE Procedure [dbo].[vmss_collateralfetching](@MARGINDATE AS DATETIME)        
AS        
SET Nocount On        
BEGIN        
        
    SET @MARGINDATE = @MARGINDATE + ' 23:59:59'        
            
    SELECT TOP 0 PARTY_CODE,CO_CODE,SCRIP_CD,SERIES,ISIN,CONVERT(VARCHAR(30),'') AS Category,CL_RATE,QTY,HAIRCUT,AMOUNT,FINALAMOUNT,CONVERT(DATETIME,'01/01/1900') AS MARGINDATE        
        INTO #CLIENT_COLLATERALS_TMP        
    FROM general.dbo.CLIENT_COLLATERALS WITH(NOLOCK)        
            
    SELECT CO_CODE,                    
           BO_SERVER,                    
           EXCHANGE,                    
           SEGMENT,                    
           ROW_NUM = ROW_NUMBER() OVER(ORDER BY CO_CODE)                    
           INTO #ACCOUNTSERVERLIST                    
    FROM   general.dbo.COMPANY WITH(NOLOCK)        
    WHERE  BO_ACTIVE = 1                    
           AND ISNULL(EXCHANGE, '') <> '' --AND GroupName in ('Derivatives','Commodities','Currency')          
           AND GroupName in ('Derivatives','Currency')          
                                  
    /*                                  
    DECLARE @MARGINDATE AS DATETIME                                  
    SET @MARGINDATE = '08/24/2011'                                  
    SET @MARGINDATE = @MARGINDATE + ' 23:59:59'        
    PRINT @MARGINDATE                                  
    */        
    DECLARE @SEGMENT AS VARCHAR(25),                                  
            @BO_SERVER AS VARCHAR(25),                                  
            @EXCHANGE AS VARCHAR(10),                                  
            @CO_CODE AS VARCHAR(20)                                  
                                      
    DECLARE @CNT AS INT,                                  
            @CTR AS INT,                                  
            @STR AS VARCHAR(MAX)                                  
            
                                      
    SELECT @CNT = COUNT(*) FROM #ACCOUNTSERVERLIST                                  
                                  
    SET @CTR = 1                                  
                                  
    WHILE(@CTR<=@CNT)                                  
    BEGIN                                  
                                          
        SELECT  @CO_CODE=CO_CODE,                                  
                @BO_SERVER=BO_SERVER,                                  
                @EXCHANGE=EXCHANGE,                                
                @SEGMENT=SEGMENT                                  
        FROM #ACCOUNTSERVERLIST                                 
        WHERE ROW_NUM=@CTR                                  
                                          
        SET @STR=''                                  
                
        IF UPPER(@SEGMENT) = 'FUTURES'                                  
        BEGIN                                  
            SET @STR=@STR + '                                  
                          DECLARE @MGDATE DATETIME        
                                 
                          SELECT @MGDATE = '+@CO_CODE+'_MARGINDATE        
                          FROM  general.dbo.EMFM_NBFC_ABL_MARGINDATE WITH(NOLOCK)        
                          WHERE  MARGINDATE = '''+CONVERT(VARCHAR(11),@MARGINDATE)+''' + '' 23:59:59''        
                           
                          /* CHANGE ID  :: 1*/        
                          INSERT INTO #CLIENT_COLLATERALS_TMP(PARTY_CODE,CO_CODE,SCRIP_CD,SERIES,ISIN,Category,CL_RATE,QTY,HAIRCUT,AMOUNT,FINALAMOUNT,MARGINDATE)        
                          /*SELECT PARTY_CODE,CO_CODE='''+@CO_CODE+''',SCRIP_CD,SERIES,ISIN,'''',CL_RATE,QTY,HAIRCUT,AMOUNT,FINALAMOUNT,'''+CAST(@MARGINDATE AS VARCHAR)+'''*/        
                          SELECT PARTY_CODE,CO_CODE='''+@CO_CODE+''',SCRIP_CD,SERIES,ISIN,'''',CL_RATE=0,FLOOR(QTY),HAIRCUT,AMOUNT,FINALAMOUNT=0,'''+CAST(@MARGINDATE AS VARCHAR)+'''        
                          FROM '+@BO_SERVER+'.MSAJAG.DBO.COLLATERALDETAILS WITH (NOLOCK)        
                          WHERE EXCHANGE='''+@EXCHANGE+''' AND SEGMENT='''+@SEGMENT+'''        
                                AND EFFDATE = CONVERT(VARCHAR(11),@MGDATE)        
                          '        
            IF UPPER(@EXCHANGE)='NSX'        
            BEGIN        
                SET @STR=@STR+' AND COLL_TYPE = ''SEC'' '                                  
            END        
         ELSE        
            BEGIN        
                SET @STR=@STR+' AND CASH_NCASH = ''N'' '                                  
            END        
                                              
            PRINT @CO_CODE                                  
            EXEC (@STR)        
            --PRINT @STR                                  
        END                                  
                                         
        SET @CTR = @CTR + 1                                  
    END                                  
            
    CREATE NONCLUSTERED INDEX [IX_PARTY_CODE] ON #CLIENT_COLLATERALS_TMP (PARTY_CODE)        
    CREATE NONCLUSTERED INDEX [IX_ISIN]   ON #CLIENT_COLLATERALS_TMP (ISIN,SCRIP_CD) INCLUDE(CL_RATE,HAIRCUT,CATEGORY)        
            
    --DELETE H FROM #CLIENT_COLLATERALS_TMP H WHERE NOT EXISTS (SELECT PARTY_CODE FROM ##PARTY_LIST P WHERE H.PARTY_CODE = P.PARTY_CODE)        
    DELETE H FROM #CLIENT_COLLATERALS_TMP H WHERE NOT EXISTS (SELECT PARTY_CODE FROM EMFM_NBFC_ABL_PARTY_LIST P WHERE H.PARTY_CODE = P.PARTY_CODE)        
            
    /*Deleting Illiquid Scrips Start*/  
    /*CHANGE ID  :: 2*/  
    /*  
    DELETE H        
    FROM   #CLIENT_COLLATERALS_TMP H        
    WHERE  EXISTS (SELECT I.ISIN FROM EMFM_ILLIQUID_SCRIP I WHERE H.ISIN = I.ISIN AND PROCESS_FROM = 'ABL')  
    */  
    DELETE H  
    FROM   #CLIENT_COLLATERALS_TMP H  
    WHERE  EXISTS (SELECT I.ISIN FROM general.dbo.EMFM_ILLIQUID_SCRIP I WHERE H.ISIN = I.ISIN AND PROCESS_FROM = 'ABL' AND I.MARGINDATE = @MARGINDATE)  
    /*Deleting Illiquid Scrips END*/                                  
            
    UPDATE #CLIENT_COLLATERALS_TMP                                   
    SET    SCRIP_CD = A.NSESYMBOL                                  
    FROM   (                                  
               SELECT A.ISIN,                                  
                      NSESYMBOL,                                  
                      SCRIP_CD,                                  
                      SERIES                                  
               FROM   general.dbo.SCRIP_MASTER A WITH(NOLOCK)        
                      INNER JOIN (                                  
                               SELECT DISTINCT SCRIP_CD,                              
                                      SERIES,                                  
                                      ISIN                                  
                               FROM   #CLIENT_COLLATERALS_TMP                                  
                            WHERE  SERIES <> 'BSE' --AND SCRIP_CD='PUNJCOMMU'                                  
                           ) B                                  
                           ON  A.ISIN = B.ISIN                                  
               WHERE  NSESYMBOL <> SCRIP_CD                                  
                      AND A.NSESYMBOL IS NOT NULL                                  
           ) A                                  
    WHERE  #CLIENT_COLLATERALS_TMP .ISIN = A.ISIN                                   
                                  
    UPDATE #CLIENT_COLLATERALS_TMP                                   
    SET    SCRIP_CD = A.BSECODE                                  
    FROM   (                                  
               SELECT A.ISIN,                                  
                      BSECODE,                                  
                      SCRIP_CD,                                  
                      SERIES                                  
               FROM  general.dbo.SCRIP_MASTER A WITH(NOLOCK)        
                      INNER JOIN (                                  
                               SELECT DISTINCT SCRIP_CD,                                  
                                      SERIES,                                  
                                      ISIN                                  
                               FROM   #CLIENT_COLLATERALS_TMP                                  
                               WHERE  SERIES = 'BSE'                                  
                           ) B                                  
                           ON  A.ISIN = B.ISIN                                  
               WHERE  BSECODE <> SCRIP_CD                        
                      AND A.BSECODE IS NOT NULL                                  
           ) A                                  
    WHERE  #CLIENT_COLLATERALS_TMP.ISIN = A.ISIN                                   
            
    /*CLOSING PRICE UPDATE START*/        
            
    SELECT SCRIP = SYMBOL_CODE,        
           CLS = CLS_RATE,        
           SERIES        
    INTO #NSE_CP        
    FROM general.dbo.EMFM_CLS_PRICE WITH(NOLOCK)        
    WHERE CO_CODE = 'NSECM'        
            
    SELECT SCODE = SYMBOL_CODE,        
           RATE = CLS_RATE        
    INTO #BSE_CP        
    FROM general.dbo.EMFM_CLS_PRICE WITH(NOLOCK)        
    WHERE CO_CODE = 'BSECM'        
            
    CREATE CLUSTERED INDEX [IX_SCODE] ON #BSE_CP (SCODE)        
    CREATE CLUSTERED INDEX [IX_SCODE] ON #NSE_CP (SCRIP,SERIES)        
            
    --UPDATE #CLIENT_COLLATERALS_TMP SET CL_RATE = 0                         
                                  
    UPDATE #CLIENT_COLLATERALS_TMP                                  
    SET    CL_RATE = B.CLS                                  
    FROM   (                                  
            SELECT ISIN,CLS                                  
            FROM #NSE_CP A           
                LEFT OUTER JOIN general.dbo.SCRIP_MASTER B WITH(NOLOCK)        
                    ON A.SCRIP = B.NSESYMBOL AND A.SERIES = B.NSESERIES                                  
            WHERE ISNULL(ISIN,'') <> ''                                  
            ) B                                  
    WHERE  #CLIENT_COLLATERALS_TMP.ISIN = B.ISIN                                  
           AND #CLIENT_COLLATERALS_TMP.CL_RATE = 0                                   
            
    UPDATE #CLIENT_COLLATERALS_TMP                                  
    SET    CL_RATE = B.CLS                                  
    FROM   (                                  
            SELECT ISIN,RATE AS CLS                                  
            FROM #BSE_CP A           
                LEFT OUTER JOIN general.dbo.SCRIP_MASTER B WITH(NOLOCK)        
                    ON A.SCODE = B.BSECODE                                  
            ) B                                  
    WHERE  #CLIENT_COLLATERALS_TMP.ISIN = B.ISIN                                  
           AND #CLIENT_COLLATERALS_TMP.CL_RATE = 0                                   
            
    /*CLOSING PRICE UPDATE END*/        
            
    /*UPDATING EXCHANGE VaR*/        
    UPDATE A        
         SET HAIRCUT = ISNULL(CASE WHEN B.BSE_VAR>B.NSE_VAR THEN B.BSE_VAR ELSE B.NSE_VAR END,100)        
    FROM #CLIENT_COLLATERALS_TMP A         
        LEFT OUTER JOIN general.dbo.EMFM_NBFC_ABL_SCRIPVAR_MASTER B WITH(NOLOCK)         
            ON A.ISIN = B.ISIN        
            
    UPDATE C        
        SET CATEGORY = ISNULL(S.STATUS,'Poor')        
    FROM #CLIENT_COLLATERALS_TMP C WITH(NOLOCK)         
        LEFT OUTER JOIN general.dbo.SCRIP_MASTER S WITH(NOLOCK)        
            ON C.ISIN = S.ISIN        
            
    UPDATE #CLIENT_COLLATERALS_TMP        
    SET    FINALAMOUNT = (CL_RATE * (100 -HAIRCUT) / 100) * QTY        
    WHERE  CATEGORY <> 'Poor'        
            
     /* CHANGE ID  :: 1 START */          
            
     /*      
     UPDATE #CLIENT_COLLATERALS_TMP        
     SET    FINALAMOUNT = 0        
     WHERE LEFT(ISIN,3) = 'INF'      
     */        
            
     /* CHANGE ID  :: 1 END */             
          
    --DELETE FROM EMFM_NBFC_ABL_COLLATERAL WHERE MARGINDATE like CONVERT(VARCHAR(11),@MARGINDATE) + '%'  
    DELETE FROM vmss_collateral WHERE MARGINDATE = CONVERT(VARCHAR(11),@MARGINDATE) + ' 23:59'  
          
    INSERT INTO vmss_collateral(PARTY_CODE,CO_CODE,Scrip_cd,Series,isin,CATEGORY,cl_rate,Qty,HairCut,AMOUNT,FINALAMOUNT,MarginDate)          
    SELECT PARTY_CODE,CO_CODE,SCRIP_CD,SERIES,ISIN,Category,CL_RATE,QTY,HAIRCUT,AMOUNT,FINALAMOUNT,MARGINDATE        
    FROM #CLIENT_COLLATERALS_TMP        
            
    DROP TABLE #CLIENT_COLLATERALS_TMP        
        
END        
SET Nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_CollSellAdj
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_CollSellAdj]              
as                  
Set Nocount on                  
                  
Set nocount on                           
BEGIN TRY                                          
                  
  Declare @BSElastBillDate datetime = (select MAX(BillDate) from AngelBSECM.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                  
                  
  select Sett_No,Sett_type into #BSEUnsett                   
  from General.dbo.BO_Sett_Mst where co_code='BSECM' and Sec_payin > @BSElastBillDate                   
  and Sett_Type='D' and Start_date <= @BSElastBillDate                   
                  
  Declare @NSElastBillDate datetime = (select MAX(BillDate) from AngelNseCM.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())                  
  select Sett_No,Sett_type into #NSEUnsett                   
  from General.dbo.BO_Sett_Mst where co_code='NSECM' and Sec_payin > @NSElastBillDate                   
  and Sett_Type='N' and Start_date <= @NSElastBillDate                   
              
  truncate table VMSS_NSE_DelTrans              
                
  insert into VMSS_NSE_DelTrans(SNo,Sett_No,Sett_type,RefNo,TCode,TrType,Party_Code,scrip_cd,series,Qty,FromNo,            
  ToNo,CertNo,FolioNo,HolderName,Reason,DrCr,Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,SlipNo,            
  BatchNo,ISett_No,ISett_Type,ShareType,TransDate,Filler1,Filler2,Filler3,BDpType,BDpId,BCltDpId,Filler4,Filler5,            
  Exchange,Segment,UpdatedOn)              
  select a.SNo,a.Sett_No,a.Sett_type,a.RefNo,a.TCode,a.TrType,a.Party_Code,a.scrip_cd,a.series,a.Qty,a.FromNo,            
  a.ToNo,a.CertNo,a.FolioNo,a.HolderName,a.Reason,a.DrCr,a.Delivered,a.OrgQty,a.DpType,a.DpId,a.CltDpId,a.BranchCd,            
  a.PartipantCode,a.SlipNo,a.BatchNo,a.ISett_No,a.ISett_Type,a.ShareType,a.TransDate,a.Filler1,a.Filler2,a.Filler3,a.BDpType,a.BDpId,              
  a.BCltDpId,a.Filler4,a.Filler5,Exchange,Segment,UpdatedOn=GETDATE()               
  from               
  (select * from angeldemat.msajag.dbo.deltrans where delivered='G' and trtype=1000 and drcr='D' and filler2=1) a join              
  (select * from angeldemat.msajag.dbo.DELIVERYDP where accounttype='MAR' and segment='FUTURES') b               
  on a.bcltdpid=b.dpcltno               
                
  truncate table VMSS_BSE_DelTrans              
                
  insert into VMSS_BSE_DelTrans(SNo,Sett_No,Sett_type,RefNo,TCode,TrType,Party_Code,scrip_cd,series,            
  Qty,FromNo,ToNo,CertNo,FolioNo,HolderName,Reason,DrCr,Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,            
  PartipantCode,SlipNo,BatchNo,ISett_No,ISett_Type,ShareType,TransDate,Filler1,Filler2,Filler3,BDpType,            
  BDpId,BCltDpId,Filler4,Filler5,Exchange,Segment,UpdatedOn)              
  select a.SNo,a.Sett_No,a.Sett_type,a.RefNo,a.TCode,a.TrType,a.Party_Code,a.scrip_cd,a.series,a.Qty,            
  a.FromNo,a.ToNo,a.CertNo,a.FolioNo,a.HolderName,a.Reason,a.DrCr,a.Delivered,a.OrgQty,a.DpType,a.DpId,            
  a.CltDpId,a.BranchCd,a.PartipantCode,a.SlipNo,a.BatchNo,a.ISett_No,a.ISett_Type,a.ShareType,a.TransDate,            
  a.Filler1,a.Filler2,a.Filler3,a.BDpType,a.BDpId,a.BCltDpId,a.Filler4,a.Filler5,Exchange,Segment,UpdatedOn=GETDATE()               
  from               
  (select * from angeldemat.bsedb.dbo.deltrans where delivered='G' and trtype=1000 and drcr='D' and filler2=1) a join              
  (select * from angeldemat.bsedb.dbo.DELIVERYDP where accounttype='MAR' and segment='FUTURES') b               
  on a.bcltdpid=b.dpcltno    
  
  
  --select distinct segment, exchange from   VMSS_NSE_DelTrans 
  --select distinct segment, exchange from   VMSS_BSE_DelTrans    
                
  select Exchange,Segment,Party_code,CertNo as ISIN,sum(Qty) as Qty               
  INTO #CollPayin              
  from VMSS_NSE_DelTrans a join #NSEUnsett c on a.isett_no=c.sett_no and a.isett_type=c.sett_Type              
  group by Exchange,Segment,Party_code,CertNo              
                
  insert into #CollPayin              
  select Exchange,Segment,Party_code,CertNo as ISIN,sum(Qty) as Qty from              
  VMSS_NSE_DelTrans a join #BSEUnsett c on a.isett_no=c.sett_no and a.isett_type=c.sett_Type              
  group by Exchange,Segment,Party_code,CertNo              
       
                
  insert into #CollPayin              
  select Exchange,Segment,Party_code,CertNo as ISIN,sum(Qty) as Qty from              
  VMSS_BSE_DelTrans a join #NSEUnsett c on a.isett_no=c.sett_no and a.isett_type=c.sett_Type              
  group by Exchange,Segment,Party_code,CertNo              
                
  insert into #CollPayin              
  select Exchange,Segment,Party_code,CertNo as ISIN,sum(Qty) as Qty from              
  VMSS_BSE_DelTrans a join #BSEUnsett c on a.isett_no=c.sett_no and a.isett_type=c.sett_Type              
  group by Exchange,Segment,Party_code,CertNo              
                
  truncate table VMSS_CollAdj              
  insert into VMSS_CollAdj(Co_code,Party_code,ISIN,Qty,UpdatedOn)              
  select               
  (              
   Case               
   when exchange='NSE' and segment='FUTURES' then 'NSEFO'               
   when exchange='NSX' and segment='FUTURES' then 'NSX'               
   when exchange='MCD' and segment='FUTURES' then 'MCD'   
   when exchange='MCX' and segment='FUTURES' then 'MCX'               
   when exchange='NCX' and segment='FUTURES' then 'NCDEX'                       
   else '' end              
  ) as Co_code,              
  ltrim(rtrim(Party_code)) as Party_code,              
  ISIN,              
  sum(Qty) as Qty,GETDATE()              
  from #CollPayin              
  group by exchange,ISIN,segment,Party_code              
              
 truncate table vmss_NonCash                
            
 insert into vmss_NonCash(id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,MarginHC )            
 select ROW_NUMBER() OVER ( ORDER BY party_Code,scrip_cd ) AS id,co_code,EffDate,@BSElastBillDate as ProcessDate,Party_Code,Scrip_Cd,                
 Series,Isin,space(10) as Category,Qty,Amount,HairCut,FinalAmount,                
 space(16) as FromAcc,space(16) as ToAcc,convert(int,0) as Sqoffseq,Cl_Rate,convert(int,0) as SquareOffQty,'',MaxAdjAmt,0,HairCut                 
 from VMSS_Client_Collaterals where Cash_Ncash='N'             
        
 update vmss_NonCash set Category=b.status from              
 (select isin,status from General.dbo.scrip_master) b              
 where vmss_NonCash.isin=b.isin         
    
 update vmss_NonCash set HairCut=0      
       
 update vmss_NonCash set HairCut=B.AutoSharePO_var from general.dbo.Scrip_ValidOnlyVar b      
 where vmss_NonCash.isin=b.isin      
       
 update vmss_NonCash set FinalAmount=Amount-(Amount*(MarginHC/100.00))     
    
End try                                       
BEGIN CATCH                                          
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                
  select GETDATE(),'VMSS_CollSellAdj',ERROR_LINE(),ERROR_MESSAGE() 
  
  DECLARE @ErrorMessage NVARCHAR(4000);                            
SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                            
RAISERROR (@ErrorMessage , 16, 1); 

                                               
End catch                                      
                  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_DP_ADJ_SMS
-- --------------------------------------------------
-- ================================================
-- template generated from template explorer using:
-- create procedure (new menu).sql
--
-- use the specify values for template parameters 
-- command (ctrl-shift-m) to fill in the parameter 


-- =============================================
-- author:		abha jaiswal
-- create date: jul 29 2016
-- description:	vmss dp adj sms 
-- =============================================
CREATE procedure [dbo].[VMSS_DP_ADJ_SMS]

as
begin
 select a.party_code,a.adjamt,b.mobile_pager into   #send1                                          
 from       
(select party_code,adjamt=sum(adjamt) from vmss_dp_holding where tosegment is not null group by party_code) a     
 left outer join general.dbo.client_details b with (nolock)                                          
 on a.party_code = b.party_code where b.mobile_pager is not null    
                             
 insert into intranet.sms.dbo.sms                                          
 select party_code,mobile_pager,                                          
 'dear client,shares worth rs.' + convert(varchar, convert(int, adjamt)) + ' are trf from your dp a/c to broker margin a/c against net debit in your trading a/c.for queries call 022-42185454.',                                        
 convert(varchar(11), getdate(), 103),substring(convert(varchar(25), getdate()), 13, 5),'p',right(getdate(), 2),'vmss_dp_fetch;' from   #send1 

insert into tbl_vmss_dp_adj_sms_log(party_code,mobile_no,sms_content,msg_date,msg_by)
select party_code,mobile_pager,                                          
'dear client,shares worth rs.' + convert(varchar, convert(int, adjamt)) + ' are trf from your dp a/c to broker margin a/c against net debit in your trading a/c.for queries call 022-42185454.',                                        
convert(varchar(11), getdate(), 103),'system' from   #send1 
 
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_DPadj_email
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_DPadj_email]                                            
as                                            
                                                    
SET XACT_ABORT ON                                                    
Set nocount on                                                    
 BEGIN TRY                                                                            
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)     
    
                  
                        
  update VMSS_DP_Holding set Tosegment=b.DrSegment from VMSS_DrSegment b where VMSS_DP_Holding.party_code=b.party_code                                            
  and  SqOffQty > 0 -- and cast(HoldDate as date) =(select Max(cast(processdate as date)) from VMSS_data)                                            
                        
  /************************************************************************/                                            
  update VMSS_DP_Holding set toacc= case                                             
  /*              
  when tosegment= 'NSECM' then '1203320000000051'                                            
  when tosegment= 'BSECM' then '1203320000000066'                     
  */              
  when tosegment= 'NSECM' then '1203320000000028'                                            
  when tosegment= 'BSECM' then '1203320009603460'                     
  ELSE '' END                                            
  where SqOffQty > 0 --and cast(HoldDate as date) =(select Max(cast(processdate as date)) from VMSS_data)                                      
                        
  update VMSS_DP_Holding set fromacc=Cltdpid                                      
  where SqOffQty > 0-- and cast(HoldDate as date) =(select Max(cast(processdate as date)) from VMSS_data)                           
                        
  /*****************************/                                            
  --history updation                                            
                        
  delete from vmss_DP_holding_hist where cast(HoldDate as date) =(select Max(cast(processdate as date)) from VMSS_data)               
                        
  insert into vmss_DP_holding_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                                      
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                                       
  from vmss_DP_holding where SqOffQty > 0                                      
                        
  truncate table VMSS_JV_DP_file                                      
  select party_code,scrip_cd=bsecode,series='BSE',isin,qty=SqOffQty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                                   
  when len(fromacc)<16 then 'IN301549' else ''  end,                                                  
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                                   
  when len(toacc)<16 then 'IN301549' else ''  end,                                                  
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                                  
  from VMSS_DP_Holding where sqoffseq > 0                                                   
 -- and cast(HoldDate as date) =(select Max(cast(processdate as date)) from VMSS_data)                                      
  AND TOSEGMENT='BSECM'                                                  
                        
  INSERT INTO #JVDATA                                                  
  select party_code,scrip_cd=nsesymbol,series=nseseries,isin,qty=SqOffQty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                                   
  when len(fromacc)<16 then 'IN301549' else ''  end,                                    
  fromacc,                                                  
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                                   
  when len(toacc)<16 then 'IN301549' else ''  end,                                 
  toacc,type1='BTM',TOSEGMENT from VMSS_DP_Holding where sqoffseq > 0                                                 
  --and cast(HoldDate as date) =(select Max(cast(processdate as date)) from VMSS_data)                                 
  AND TOSEGMENT='NSECM'                                                  
                        
  truncate table VMSS_JVDP_file                                      
                        
  insert into VMSS_JVDP_file                                                 
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                                
  from #JVDATA                                                
                        
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                               
                        
  DECLARE @file1 AS VARCHAR(100)                                                    
  DECLARE @file2 AS VARCHAR(100)                               
  DECLARE @i AS INT                                                  
  DECLARE @str VARCHAR(8000)                                                   
  declare @segment varchar(10)                                              
                      
  DECLARE @fileCnt as int                          
  DECLARE @RowCnt int,@FileName as varchar(500)                        
                          
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                        
                          
  DECLARE @SQL VARCHAR(MAX)                                                      
  SET @SQL = ''                        
                          
  CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))                        
  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))                        
                      
   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/                        
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                         
                          
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')                         
  SET @FileName=''                        
                          
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                        
                          
  PRINT @FileName                        
                  
  TRUNCATE TABLE FileData                  
                            
  INSERT INTO FileData                      
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                         
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                        
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                                     
                          
  INSERT INTO FileData                                                  
  SELECT  '<Tp>5</Tp>'+                  
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+                  
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'                  
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                                     
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                                     
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                                    
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+           
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                                    
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                                    
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                       
  FROM   #JVDATAFILE a (nolock)                                          
  WHERE tosegment = 'BSECM'                       
                      
    /*                        
  INSERT INTO FileData_rohit_23092015                                                
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse                         
  */                        
                                                       
  SET @SQL = ''                                                      
                          
  SET @SQL = ' bcp " SELECT FileData FROM [CSOKYC-6].Squareoff.dbo.FileData '                                                 
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc ' */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '                                         
  SET @SQL = '''' + @SQL + ''''                                                      
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                      
  PRINT @SQL                               
  EXEC (@SQL)                          
                              
  /*Used For Unix formated Data*/                        
 /* exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName */  
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix 'H:\MindGate\UploadJVCollateral\',@FileName                        
                          
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                         
                          
  /*SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName */
  SET @filename1='H:\MindGate\UploadJVCollateral\'+ @FileName                        
                           
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/                            
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/                        
                            
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)                         
                          
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')                         
  SET @FileName=''                        
                          
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')                        
                          
  PRINT @FileName                        
                          
  TRUNCATE TABLE FileData                    
                            
  INSERT INTO FileData                    
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+                         
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+                        
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                                     
                            
  INSERT INTO FileData                                                
  SELECT  '<Tp>5</Tp>'+                  
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+                  
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'                  
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                                     
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                                     
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                                    
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                                    
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn>2</Rsn>'+                                    
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                                    
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                                    
  FROM   #JVDATAFILE a (nolock)                                          
  WHERE tosegment = 'NSECM'                         
                             
                          
  /*                        
  INSERT INTO FileData_rohit_23092015                                                select DATA from #VMSS_JVCEColl_tblfile_nse                         
  */                                                        
                          
  SET @SQL = ' bcp " SELECT FileData FROM [CSOKYC-6].Squareoff.dbo.FileData '                                                 
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '*/
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '                                              
  SET @SQL = '''' + @SQL + ''''                                                      
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                      
  PRINT @SQL                                                      
  EXEC (@SQL)                            
                              
  /*Used For Unix formated Data*/                        
 /* exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName*/ 
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix 'H:\MindGate\UploadJVCollateral\',@FileName                         
                          
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1                          
                           
  /*SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName */
  SET @filename2='H:\MindGate\UploadJVCollateral\'+ @FileName                  
                            
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/                          
  /*                                               
                          
  SELECT ID = ROW_NUMBER() OVER(ORDER BY LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))ASC),                                           
  DATA =LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))                                                     
  +','+LTRIM(RTRIM(scrip_cd))+','+LTRIM(RTRIM (CONVERT(VARCHAR,series)))+ ','                                                      
  +LTRIM(RTRIM(CONVERT(VARCHAR,isin)))+','+ LTRIM(RTRIM (CONVERT(VARCHAR,qty)))+ ','                                                 
  +(LTRIM(RTRIM(fromdpid)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,todpid)))+','                                                
  +LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+','+LTRIM(RTRIM(CONVERT(VARCHAR,type1)))                                                     
  INTO  #VMSS_JVCEColl_tblfile_bse                                                      
  FROM #JVDATAFILE x                                                      
  WHERE tosegment = 'BSECM'                                                      
  ORDER BY sr ASC                       
  */                        
                          
                            
                           
  --TRUNCATE TABLE #VMSS_JVCEColl_tblfile_bse                        
  /*                         
  SELECT ID = ROW_NUMBER() OVER(ORDER BY LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))ASC),                                                     
  DATA =LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))                                               
  +','+LTRIM(RTRIM(scrip_cd))+','+LTRIM(RTRIM (CONVERT(VARCHAR,series)))+ ','                                    
  +LTRIM(RTRIM(CONVERT(VARCHAR,isin)))+','+ LTRIM(RTRIM (CONVERT(VARCHAR,qty)))+ ','                                                 
  +(LTRIM(RTRIM(fromdpid)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,todpid)))+','                                                
  +LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+','+LTRIM(RTRIM(CONVERT(VARCHAR,type1)))                                                     
  INTO  #VMSS_JVCEColl_tblfile_nse                                                      
  FROM #JVDATAFILE x                                                        WHERE tosegment = 'NSECM'                                                      
  ORDER BY sr ASC                                                
                          
  SET @file2=''                                                
  SET @file2 = (SELECT 'VMSS_T4_JV_DP_GeneratedFile_'+'NSECM'+'_'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','')+ '.csv')                                                   
               
  insert into FileData_rohit_23092015                                                
  select DATA,'NSECM' from #VMSS_JVCEColl_tblfile_nse                                                
                          
  SET @SQL = ''                                                      
                          
  SET @SQL = ' bcp " SELECT flddata FROM [196.1.115.182].squareoff.dbo.FileData_rohit_23092015 WHERE SEGMENT=''''NSECM'''''                                                      
         
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @file2 + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '                                                    
  SET @SQL = '''' + @SQL + ''''                                                      
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                                      
  --PRINT @SQL                                                      
  EXEC (@SQL)                         
               
  */                                               
                          
                                                     
  /*                        
  select @filename1='d:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_DP_GeneratedFile_' + 'BSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'                                                                       
  select @filename2='d:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_DP_GeneratedFile_' + 'NSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'                        
                                                     
  print @filename1                                                
  */                        
                          
  SET @SQL =''                          
  SET @SQL = 'Dear Team,<br/><br/>'                                                      
  SET @SQL = @SQL + 'Kindly upload the attached DP JV dated (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') pertaining to var margin Square off Module.'                                                      
  SET @SQL = @SQL + '<br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                                      
                          
  DECLARE @s varchar(500)                                                                
  SET @s = @filename1 + ';' + @filename2                                                     
                          
  EXEC msdb.dbo.sp_send_dbmail                  
  @profile_name = 'Square',                                          
  @recipients= 'vishal@angelbroking.com;anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;',                                                      
  @copy_recipients= 'csorm@angelbroking.com',                        
   --@blind_copy_recipients= @BCC,                                                      
  @body= @SQL,                                                      
  @file_attachments= @s,                                                      
  @body_format= 'HTML',                                                        
  @subject='VMSS (T+3) - DP movement : Var Margin Square Off'                  
     
   --select * from INTRANET.SMS.DBO.SMS  where to_no='8108987990' and [date]='19/10/2016' and [message] like '%Dear Team count for dp file data is%'  
   /*
   Declare @DP_FILE_COUNT as varchar(20)  
   set @DP_FILE_COUNT=(select count(1) from FileData)   
  -- print  @DP_FILE_COUNT  
     
   INSERT INTO INTRANET.SMS.DBO.SMS                                   
   SELECT 9892312837,                                                         
   'Dear Team count for dp file data is '+@DP_FILE_COUNT+'.',                                         
   CONVERT(VARCHAR(11), Getdate(), 103),                                                          
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                          
   'P',RIGHT(Getdate(), 2), 'VMSS6'  
     
    INSERT INTO INTRANET.SMS.DBO.SMS                                                          
   SELECT 9820701602,                                                         
   'Dear Team count for dp file data is '+@DP_FILE_COUNT+'.',                                         
   CONVERT(VARCHAR(11), Getdate(), 103),                                                          
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                          
   'P',RIGHT(Getdate(), 2), 'VMSS6'  
     
    INSERT INTO INTRANET.SMS.DBO.SMS                                                          
   SELECT 9820731985,                                                         
   'Dear Team count for dp file data is '+@DP_FILE_COUNT+'.',                                         
   CONVERT(VARCHAR(11), Getdate(), 103),                                                          
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                          
   'P',RIGHT(Getdate(), 2), 'VMSS6'  
     
    INSERT INTO INTRANET.SMS.DBO.SMS                                                          
   SELECT 8108987990,                                                         
   'Dear Team count for dp file data is '+@DP_FILE_COUNT+'.',                                         
   CONVERT(VARCHAR(11), Getdate(), 103),                                                          
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                          
   'P',RIGHT(Getdate(), 2), 'VMSS6'  
              
         
  /* SMS PArt*/            
    declare @TradingDay datetime         
    ;with sqoffdatae as        
    (        
    select ROW_NUMBER() over(order by a.Start_Date)as srno,  isnull(a.Start_Date,'')   Start_Date                                              
    from general.dbo.bse_sett_mst a                                                                              
    where CONVERT(VARCHAR(10),a.start_Date,121) >= CONVERT(VARCHAR(10),getdate(),121)                                                       
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                                
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                              
    group by Start_Date)        
    select @TradingDay = isnull(Start_Date ,'')  from sqoffdatae where srno=1 ;              
         
   if((DATEPART(DW,GETDATE())>=2 and  DATEPART(DW,GETDATE())<7) and cast(getdate() as date)=cast(@TradingDay as date))        
   begin            
   SELECT A.party_code,A.AdjAmt ,B.MOBILE_PAGER INTO #SEND1 FROM                       
   (select Party_code,AdjAmt=sum(AdjAmt) from VMSS_DP_Holding where ToSegment is not null group by Party_code) A                     
   LEFT OUTER JOIN general.dbo.CLIENT_DETAILS B WITH (NOLOCK)                                                          
   ON A.PARTY_CODE = B.PARTY_CODE where B.Mobile_pager is not null                    
                                           
                                 
   INSERT INTO INTRANET.SMS.DBO.SMS                                                          
   SELECT MOBILE_PAGER,                                                         
   'Dear client('+ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                
    
                    
   CONVERT(VARCHAR(11), Getdate(), 103),                                                          
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                          
    'P',RIGHT(Getdate(), 2), 'New POA Debit Client' FROM   #SEND1   where AdjAmt>0.00                  
                
   /* sms log*/                    
   insert into Tbl_VMSSDPAdj_SMS_log                
   SELECT party_code,MOBILE_PAGER,                                                         
   'Dear client ('+ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                          
   
    
                     
   CONVERT(VARCHAR(11), Getdate(), 103)                                                                                         
   FROM   #SEND1    where AdjAmt>0.00                      
                                     
   INSERT INTO INTRANET.SMS.DBO.SMS                                                          
   SELECT top 1  '9820701602',                                                          
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                     
  
    
      
        
                                 
   CONVERT(VARCHAR(11), Getdate(), 103),                                                          
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                          
   'P',RIGHT(Getdate(), 2),'New POA Debit Client' FROM   #SEND1  group by  party_code                     
                                     
   INSERT INTO INTRANET.SMS.DBO.SMS                                                          
   SELECT top 1  '9820731985','Dear client (' +party_code +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',        
  
    
      
        
                                            
   CONVERT(VARCHAR(11), Getdate(), 103), Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                          
   FROM   #SEND1 group by  party_code                       
                                     
   INSERT INTO INTRANET.SMS.DBO.SMS                                                          
   SELECT top 1  '9819090240',                                                          
   'Dear client (' +ltrim(rtrim(party_code)) +'), Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                         
   CONVERT(VARCHAR(11), Getdate(), 103),Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                          
   FROM   #SEND1  group by  party_code          
                                            
  end   */                                        
End try                                                                           
BEGIN CATCH                                                                              
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                     
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                                    
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                      
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                                      
  RAISERROR (@ErrorMessage , 16, 1);                                            
End catch                                                       
                                                      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_DPadj_email_05102015
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_DPadj_email_05102015]                        
as                        
                                
SET XACT_ABORT ON                                
Set nocount on                                
 BEGIN TRY                                                        
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                      
    
  update VMSS_DP_Holding set Tosegment=b.DrSegment from VMSS_DrSegment b where VMSS_DP_Holding.party_code=b.party_code                        
  and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                        
    
  /************************************************************************/                        
  update VMSS_DP_Holding set toacc= case                         
  when tosegment= 'NSECM' then '1203320000000051'                        
  when tosegment= 'BSECM' then '1203320000000066'                        
  ELSE '' END                        
  where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                        
    
  update VMSS_DP_Holding set fromacc=Cltdpid                  
  where SqOffQty > 0 and HoldDate =(select Max(processDate) from VMSS_data)                        
    
  /*****************************/                        
  --history updation                        
    
  delete from vmss_DP_holding_hist where HoldDate =(select Max(processDate) from VMSS_data)                
    
  insert into vmss_DP_holding_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                  
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                   
  from vmss_DP_holding where SqOffQty > 0                  
    
  truncate table VMSS_JV_DP_file                  
  select party_code,scrip_cd=bsecode,series='BSE',isin,qty=SqOffQty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                               
  when len(fromacc)<16 then 'IN301549' else ''  end,                              
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                               
  when len(toacc)<16 then 'IN301549' else ''  end,                              
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                              
  from VMSS_DP_Holding where sqoffseq > 0                               
  and HoldDate =(select Max(processDate) from VMSS_data)                              
  AND TOSEGMENT='BSECM'                              
    
  INSERT INTO #JVDATA                              
  select party_code,scrip_cd=nsesymbol,series=nseseries,isin,qty=SqOffQty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                               
  when len(fromacc)<16 then 'IN301549' else ''  end,                              
  fromacc,                              
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                               
  when len(toacc)<16 then 'IN301549' else ''  end,                              
  toacc,type1='BTM',TOSEGMENT from VMSS_DP_Holding where sqoffseq > 0                               
  and HoldDate =(select Max(processDate) from VMSS_data)                              
  AND TOSEGMENT='NSECM'                              
    
  truncate table VMSS_JVDP_file                  
    
  insert into VMSS_JVDP_file                             
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                            
  from #JVDATA                            
    
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                           
    
  DECLARE @file1 AS VARCHAR(100)                                
  DECLARE @file2 AS VARCHAR(100)                               
  DECLARE @i AS INT                              
  DECLARE @str VARCHAR(8000)                               
  declare @segment varchar(10)                          
    
  SELECT ID = ROW_NUMBER() OVER(ORDER BY LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))ASC),                               
  DATA =LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))                               
  +','+LTRIM(RTRIM(scrip_cd))+','+LTRIM(RTRIM (CONVERT(VARCHAR,series)))+ ','                                
  +LTRIM(RTRIM(CONVERT(VARCHAR,isin)))+','+ LTRIM(RTRIM (CONVERT(VARCHAR,qty)))+ ','                           
  +(LTRIM(RTRIM(fromdpid)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,todpid)))+','                          
  +LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+','+LTRIM(RTRIM(CONVERT(VARCHAR,type1)))                               
  INTO  #VMSS_JVCEColl_tblfile_bse                                
  FROM #JVDATAFILE x                                
  WHERE tosegment = 'BSECM'                                
  ORDER BY sr ASC                          
    
  insert into VMSS_JV_DP_file                          
  select DATA ,'BSECM' from #VMSS_JVCEColl_tblfile_bse                          
  SET @file1 = (SELECT 'VMSS_T4_JV_DP_GeneratedFile_'+'BSECM'+'_'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','')+ '.csv')                             
    
  DECLARE @SQL VARCHAR(MAX)                                
  SET @SQL = ''                                
    
  SET @SQL = ' bcp " SELECT flddata FROM [196.1.115.182].Squareoff.dbo.VMSS_JV_DP_file WHERE SEGMENT=''''BSECM'''''                           
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @file1 + ' -c -Sintranet -Uinhouse -Pinh6014 '                                   
  SET @SQL = '''' + @SQL + ''''                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                
  PRINT @SQL                                
  EXEC (@SQL)                              
    
  SELECT ID = ROW_NUMBER() OVER(ORDER BY LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))ASC),                               
  DATA =LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))                         
  +','+LTRIM(RTRIM(scrip_cd))+','+LTRIM(RTRIM (CONVERT(VARCHAR,series)))+ ','                                
  +LTRIM(RTRIM(CONVERT(VARCHAR,isin)))+','+ LTRIM(RTRIM (CONVERT(VARCHAR,qty)))+ ','                           
  +(LTRIM(RTRIM(fromdpid)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,todpid)))+','                          
  +LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+','+LTRIM(RTRIM(CONVERT(VARCHAR,type1)))                               
  INTO  #VMSS_JVCEColl_tblfile_nse                                
  FROM #JVDATAFILE x                                
  WHERE tosegment = 'NSECM'                                
  ORDER BY sr ASC                          
    
  SET @file2=''                          
  SET @file2 = (SELECT 'VMSS_T4_JV_DP_GeneratedFile_'+'NSECM'+'_'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','')+ '.csv')                             
    
  insert into VMSS_JV_DP_file                          
  select DATA,'NSECM' from #VMSS_JVCEColl_tblfile_nse                          
    
  SET @SQL = ''                                
    
  SET @SQL = ' bcp " SELECT flddata FROM [196.1.115.182].squareoff.dbo.VMSS_JV_DP_file WHERE SEGMENT=''''NSECM'''''                                
    
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @file2 + ' -c -Sintranet -Uinhouse -Pinh6014 '                              
  SET @SQL = '''' + @SQL + ''''                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                
  --PRINT @SQL                                
  EXEC (@SQL)                          
    
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                             
    
  select @filename1='d:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_DP_GeneratedFile_' + 'BSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'   
  select @filename2='d:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_DP_GeneratedFile_' + 'NSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'                             
  print @filename1                          
    
  SET @SQL = 'Dear Team,<br/><br/>'                                
  SET @SQL = @SQL + 'Kindly upload the attached DP JV dated (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') pertaining to var margin Square off Module.'                                
  SET @SQL = @SQL + '<br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                
    
  DECLARE @s varchar(500)                                          
  SET @s = @filename1 + ';' + @filename2                               
    
  EXEC msdb.dbo.sp_send_dbmail                                
  @profile_name = 'Square',                    
  @recipients= 'csorm@angelbroking.com',                                
  @copy_recipients= 'mgs.abha@angelbroking.com;renil.pillai@angelbroking.com',                                
  --@blind_copy_recipients= @BCC,                                
  @body= @SQL,                                
  @file_attachments= @s,                                
  @body_format= 'HTML',                                
  @subject='VMSS (T+3) - DP movement : Var Margin Square Off'                           
                       
End try                                                     
BEGIN CATCH                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                               
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                              
  DECLARE @ErrorMessage NVARCHAR(4000);                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                
  RAISERROR (@ErrorMessage , 16, 1);                      
End catch                                 
                                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_DPadj_email_19012016
-- --------------------------------------------------

CREATE Procedure [dbo].[VMSS_DPadj_email_19012016]                              
as                              
                                      
SET XACT_ABORT ON                                      
Set nocount on                                      
 BEGIN TRY                                                              
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                            
          
  update VMSS_DP_Holding set Tosegment=b.DrSegment from VMSS_DrSegment b where VMSS_DP_Holding.party_code=b.party_code                              
  and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                              
          
  /************************************************************************/                              
  update VMSS_DP_Holding set toacc= case                               
  /*
  when tosegment= 'NSECM' then '1203320000000051'                              
  when tosegment= 'BSECM' then '1203320000000066'       
  */
  when tosegment= 'NSECM' then '1203320000000028'                              
  when tosegment= 'BSECM' then '1203320009603460'       
  ELSE '' END                              
  where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                              
          
  update VMSS_DP_Holding set fromacc=Cltdpid                        
  where SqOffQty > 0 and HoldDate =(select Max(processDate) from VMSS_data)                              
          
  /*****************************/                              
  --history updation                              
          
  delete from vmss_DP_holding_hist where HoldDate =(select Max(processDate) from VMSS_data)                      
          
  insert into vmss_DP_holding_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                        
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                         
  from vmss_DP_holding where SqOffQty > 0                        
          
  truncate table VMSS_JV_DP_file                        
  select party_code,scrip_cd=bsecode,series='BSE',isin,qty=SqOffQty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                     
  when len(fromacc)<16 then 'IN301549' else ''  end,                                    
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                     
  when len(toacc)<16 then 'IN301549' else ''  end,                                    
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                    
  from VMSS_DP_Holding where sqoffseq > 0                                     
  and HoldDate =(select Max(processDate) from VMSS_data)                                    
  AND TOSEGMENT='BSECM'                                    
          
  INSERT INTO #JVDATA                                    
  select party_code,scrip_cd=nsesymbol,series=nseseries,isin,qty=SqOffQty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                     
  when len(fromacc)<16 then 'IN301549' else ''  end,                                    
  fromacc,                                    
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                     
  when len(toacc)<16 then 'IN301549' else ''  end,                                    
  toacc,type1='BTM',TOSEGMENT from VMSS_DP_Holding where sqoffseq > 0                                     
  and HoldDate =(select Max(processDate) from VMSS_data)                                    
  AND TOSEGMENT='NSECM'                                    
          
  truncate table VMSS_JVDP_file                        
          
  insert into VMSS_JVDP_file                                   
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                  
  from #JVDATA                                  
          
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                 
          
  DECLARE @file1 AS VARCHAR(100)                                      
  DECLARE @file2 AS VARCHAR(100)                 
  DECLARE @i AS INT                                    
  DECLARE @str VARCHAR(8000)                                     
  declare @segment varchar(10)                                
        
  DECLARE @fileCnt as int            
  DECLARE @RowCnt int,@FileName as varchar(500)          
            
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)          
            
  DECLARE @SQL VARCHAR(MAX)                                        
  SET @SQL = ''          
            
  CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))          
  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))          
        
   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/          
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)           
            
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')           
  SET @FileName=''          
            
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 6))+ '.log')          
            
  PRINT @FileName          
    
  TRUNCATE TABLE FileData    
              
  INSERT INTO FileData        
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+           
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 6))+          
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                       
            
  INSERT INTO FileData                                    
  SELECT  '<Tp>5</Tp>'+    
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+    
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'    
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                       
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                       
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                      
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                      
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn></Rsn>'+                      
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                      
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                       
  FROM   #JVDATAFILE a (nolock)                            
  WHERE tosegment = 'BSECM'         
        
    /*          
  INSERT INTO FileData_rohit_23092015                                  
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse           
  */          
                                         
  SET @SQL = ''                                        
            
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                   
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                           
  SET @SQL = '''' + @SQL + ''''                                        
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                        
  PRINT @SQL                                        
  EXEC (@SQL)            
                
  /*Used For Unix formated Data*/          
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName          
            
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1           
            
  SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName          
             
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/              
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/          
              
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)           
            
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')           
  SET @FileName=''          
            
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 6))+ '.log')          
            
  PRINT @FileName          
            
  TRUNCATE TABLE FileData      
              
  INSERT INTO FileData      
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+           
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 6))+          
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                       
              
  INSERT INTO FileData                                  
  SELECT  '<Tp>5</Tp>'+    
  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+    
     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'    
  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                       
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                       
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                      
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                      
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn></Rsn>'+                      
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                      
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                      
  FROM   #JVDATAFILE a (nolock)                            
  WHERE tosegment = 'NSECM'           
               
            
  /*          
  INSERT INTO FileData_rohit_23092015                                  
  select DATA from #VMSS_JVCEColl_tblfile_nse           
  */                                          
            
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                   
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                           
  SET @SQL = '''' + @SQL + ''''                                        
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                        
  PRINT @SQL                                        
  EXEC (@SQL)              
                
  /*Used For Unix formated Data*/          
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName           
            
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1            
             
  SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName          
              
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/            
  /*                                 
            
  SELECT ID = ROW_NUMBER() OVER(ORDER BY LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))ASC),                                       
  DATA =LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))                                       
  +','+LTRIM(RTRIM(scrip_cd))+','+LTRIM(RTRIM (CONVERT(VARCHAR,series)))+ ','                                        
  +LTRIM(RTRIM(CONVERT(VARCHAR,isin)))+','+ LTRIM(RTRIM (CONVERT(VARCHAR,qty)))+ ','                                   
  +(LTRIM(RTRIM(fromdpid)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,todpid)))+','                                  
  +LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+','+LTRIM(RTRIM(CONVERT(VARCHAR,type1)))                                       
  INTO  #VMSS_JVCEColl_tblfile_bse                                        
  FROM #JVDATAFILE x                                        
  WHERE tosegment = 'BSECM'                                        
  ORDER BY sr ASC         
  */          
            
              
             
  --TRUNCATE TABLE #VMSS_JVCEColl_tblfile_bse          
  /*           
  SELECT ID = ROW_NUMBER() OVER(ORDER BY LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))ASC),                                       
  DATA =LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))                                 
  +','+LTRIM(RTRIM(scrip_cd))+','+LTRIM(RTRIM (CONVERT(VARCHAR,series)))+ ','                      
  +LTRIM(RTRIM(CONVERT(VARCHAR,isin)))+','+ LTRIM(RTRIM (CONVERT(VARCHAR,qty)))+ ','                                   
  +(LTRIM(RTRIM(fromdpid)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,todpid)))+','                                  
  +LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+','+LTRIM(RTRIM(CONVERT(VARCHAR,type1)))                                       
  INTO  #VMSS_JVCEColl_tblfile_nse                                        
  FROM #JVDATAFILE x                                        
  WHERE tosegment = 'NSECM'                                        
  ORDER BY sr ASC                                  
            
  SET @file2=''                                  
  SET @file2 = (SELECT 'VMSS_T4_JV_DP_GeneratedFile_'+'NSECM'+'_'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','')+ '.csv')                                     
            
  insert into FileData_rohit_23092015                                  
  select DATA,'NSECM' from #VMSS_JVCEColl_tblfile_nse                                  
            
  SET @SQL = ''                                        
            
  SET @SQL = ' bcp " SELECT flddata FROM [196.1.115.182].squareoff.dbo.FileData_rohit_23092015 WHERE SEGMENT=''''NSECM'''''                                        
            
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @file2 + ' -c -Sintranet -Uinhouse -Pinh6014 '                                      
  SET @SQL = '''' + @SQL + ''''                                        
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                        
  --PRINT @SQL                                        
  EXEC (@SQL)           
            
  */                                 
            
                                       
  /*          
  select @filename1='d:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_DP_GeneratedFile_' + 'BSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'                                                         
  select @filename2='d:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_DP_GeneratedFile_' + 'NSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'          
                                       
  print @filename1                                  
  */          
            
  SET @SQL =''            
  SET @SQL = 'Dear Team,<br/><br/>'                                        
  SET @SQL = @SQL + 'Kindly upload the attached DP JV dated (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') pertaining to var margin Square off Module.'                                        
  SET @SQL = @SQL + '<br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                        
            
  DECLARE @s varchar(500)                                                  
  SET @s = @filename1 + ';' + @filename2                                       
            
  EXEC msdb.dbo.sp_send_dbmail                                        
  @profile_name = 'Square',                            
  @recipients= 'mgs.abha@angelbroking.com;vishal@angelbroking.com;anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;',                                        
  @copy_recipients= 'renil.pillai@angelbroking.com;csorm@angelbroking.com',          
   --@blind_copy_recipients= @BCC,                                        
  @body= @SQL,                                        
  @file_attachments= @s,                                        
  @body_format= 'HTML',                                          @subject='VMSS (T+3) - DP movement : Var Margin Square Off'                                   
                               
End try                                                             
BEGIN CATCH                                                                
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                       
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                      
  DECLARE @ErrorMessage NVARCHAR(4000);                                                        
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                        
  RAISERROR (@ErrorMessage , 16, 1);                              
End catch                                         
                                        
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_DPadj_email_21012016
-- --------------------------------------------------



CREATE Procedure [dbo].[VMSS_DPadj_email_21012016]                              

as                              

                                      

SET XACT_ABORT ON                                      

Set nocount on                                      

 BEGIN TRY                                                              

  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                            

          

  update VMSS_DP_Holding set Tosegment=b.DrSegment from VMSS_DrSegment b where VMSS_DP_Holding.party_code=b.party_code                              

  and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                              

          

  /************************************************************************/                              

  update VMSS_DP_Holding set toacc= case                               

  /*

  when tosegment= 'NSECM' then '1203320000000051'                              

  when tosegment= 'BSECM' then '1203320000000066'       

  */

  when tosegment= 'NSECM' then '1203320000000028'                              

  when tosegment= 'BSECM' then '1203320009603460'       

  ELSE '' END                              

  where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                              

          

  update VMSS_DP_Holding set fromacc=Cltdpid                        

  where SqOffQty > 0 and HoldDate =(select Max(processDate) from VMSS_data)                              

          

  /*****************************/                              

  --history updation                              

          

  delete from vmss_DP_holding_hist where HoldDate =(select Max(processDate) from VMSS_data)                      

          

  insert into vmss_DP_holding_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                        

  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                         

  from vmss_DP_holding where SqOffQty > 0                        

          

  truncate table VMSS_JV_DP_file                        

  select party_code,scrip_cd=bsecode,series='BSE',isin,qty=SqOffQty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                     

  when len(fromacc)<16 then 'IN301549' else ''  end,                                    

  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                     

  when len(toacc)<16 then 'IN301549' else ''  end,                                    

  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                    

  from VMSS_DP_Holding where sqoffseq > 0                                     

  and HoldDate =(select Max(processDate) from VMSS_data)                                    

  AND TOSEGMENT='BSECM'                                    

          

  INSERT INTO #JVDATA                                    

  select party_code,scrip_cd=nsesymbol,series=nseseries,isin,qty=SqOffQty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                     

  when len(fromacc)<16 then 'IN301549' else ''  end,                                    

  fromacc,                                    

  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                     

  when len(toacc)<16 then 'IN301549' else ''  end,                                    

  toacc,type1='BTM',TOSEGMENT from VMSS_DP_Holding where sqoffseq > 0                                     

  and HoldDate =(select Max(processDate) from VMSS_data)                                    

  AND TOSEGMENT='NSECM'                                    

          

  truncate table VMSS_JVDP_file                        

          

  insert into VMSS_JVDP_file                                   

  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                                  

  from #JVDATA                                  

          

  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                                 

          

  DECLARE @file1 AS VARCHAR(100)                                      

  DECLARE @file2 AS VARCHAR(100)                 

  DECLARE @i AS INT                                    

  DECLARE @str VARCHAR(8000)                                     

  declare @segment varchar(10)                                

        

  DECLARE @fileCnt as int            

  DECLARE @RowCnt int,@FileName as varchar(500)          

            

  DECLARE @filename1 as varchar(100),@filename2 as varchar(100),@filename3 as varchar(100)         

            

  DECLARE @SQL VARCHAR(MAX)                                        

  SET @SQL = ''          

            

  CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))          

  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))          

        

   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/          

  SET @fileCnt=(select FileCnt from VMSS_FileCounter)           

            

  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')           

  SET @FileName=''          

            

  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')          

            

  PRINT @FileName          

    

  TRUNCATE TABLE FileData    

              

  INSERT INTO FileData        

  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+           

  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+          

  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                       

            

  INSERT INTO FileData                                    

  SELECT  '<Tp>5</Tp>'+    

  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+    

     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'    

  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                       

  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                       

  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                      

  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                      

  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn></Rsn>'+                      

  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                      

  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                       

  FROM   #JVDATAFILE a (nolock)                            

  WHERE tosegment = 'BSECM'         

        

    /*          

  INSERT INTO FileData_rohit_23092015                                  

  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse           

  */          

                                         

  SET @SQL = ''                                        

            

  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                   

  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                           

  SET @SQL = '''' + @SQL + ''''                                        

  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                        

  PRINT @SQL                                        

  EXEC (@SQL)            

                

  /*Used For Unix formated Data*/          

  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName          

            

  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1           

            

  SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName          

             

  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/              

  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/          

              

  SET @fileCnt=(select FileCnt from VMSS_FileCounter)           

            

  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')           

  SET @FileName=''          

            

  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+ '.log')          

            

  PRINT @FileName          

            

  TRUNCATE TABLE FileData      

              

  INSERT INTO FileData      

  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+           

  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 5))+          

  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                       

              

  INSERT INTO FileData                                  

  SELECT  '<Tp>5</Tp>'+    

  '<Usn>'+convert(varchar,DBO.FILLSTRING(ISNULL( convert(varchar(10),sr)+    

     convert(varchar(10), convert(varchar(10),@FILECNT)), ''), '0', 8, 0) ) +'</Usn>'    

  +'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                       

  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                       

  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                      

  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                      

  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn></Rsn>'+                      

  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                      

  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                      

  FROM   #JVDATAFILE a (nolock)                            

  WHERE tosegment = 'NSECM'           

               

            

  /*          

  INSERT INTO FileData_rohit_23092015                                  

  select DATA from #VMSS_JVCEColl_tblfile_nse           

  */                                          

            

  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                                   

  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                           

  SET @SQL = '''' + @SQL + ''''                                        

  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                        

  PRINT @SQL                                        

  EXEC (@SQL)              

                

  /*Used For Unix formated Data*/          

  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName           

            

  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1            

             

  SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName          

              

  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/            

  /*                                 

            

  SELECT ID = ROW_NUMBER() OVER(ORDER BY LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))ASC),                                       

  DATA =LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))                                       

  +','+LTRIM(RTRIM(scrip_cd))+','+LTRIM(RTRIM (CONVERT(VARCHAR,series)))+ ','                                        

  +LTRIM(RTRIM(CONVERT(VARCHAR,isin)))+','+ LTRIM(RTRIM (CONVERT(VARCHAR,qty)))+ ','                                   

  +(LTRIM(RTRIM(fromdpid)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,todpid)))+','                                  

  +LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+','+LTRIM(RTRIM(CONVERT(VARCHAR,type1)))                                       

  INTO  #VMSS_JVCEColl_tblfile_bse                                        

  FROM #JVDATAFILE x                                        

  WHERE tosegment = 'BSECM'                                        

  ORDER BY sr ASC         

  */          

            

              

             

  --TRUNCATE TABLE #VMSS_JVCEColl_tblfile_bse          

  /*           

  SELECT ID = ROW_NUMBER() OVER(ORDER BY LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))ASC),                                       

  DATA =LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))                                 

  +','+LTRIM(RTRIM(scrip_cd))+','+LTRIM(RTRIM (CONVERT(VARCHAR,series)))+ ','                      

  +LTRIM(RTRIM(CONVERT(VARCHAR,isin)))+','+ LTRIM(RTRIM (CONVERT(VARCHAR,qty)))+ ','                                   

  +(LTRIM(RTRIM(fromdpid)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,todpid)))+','                                  

  +LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+','+LTRIM(RTRIM(CONVERT(VARCHAR,type1)))                                       

  INTO  #VMSS_JVCEColl_tblfile_nse                                        

  FROM #JVDATAFILE x                                        

  WHERE tosegment = 'NSECM'                                        

  ORDER BY sr ASC                                  

            

  SET @file2=''                                  

  SET @file2 = (SELECT 'VMSS_T4_JV_DP_GeneratedFile_'+'NSECM'+'_'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','')+ '.csv')                                     

            

  insert into FileData_rohit_23092015                                  

  select DATA,'NSECM' from #VMSS_JVCEColl_tblfile_nse                                  

            

  SET @SQL = ''                                        

            

  SET @SQL = ' bcp " SELECT flddata FROM [196.1.115.182].squareoff.dbo.FileData_rohit_23092015 WHERE SEGMENT=''''NSECM'''''                                        

            

  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @file2 + ' -c -Sintranet -Uinhouse -Pinh6014 '                                      

  SET @SQL = '''' + @SQL + ''''                                        

  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                        

  --PRINT @SQL                                        

  EXEC (@SQL)           

            

  */                                 

            

                                       

  /*          

  select @filename1='d:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_DP_GeneratedFile_' + 'BSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'                                                         

  select @filename2='d:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_DP_GeneratedFile_' + 'NSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'          

                                       

  print @filename1                                  

  */   
		       
	/* added as requested by Vishal Gohil on Jan 21 2016*/

	/* Start: dp holding data in excel file */
	 SET @FileName=''  
		  
		set @FileName='VMSS_DP_Holding_' + replace(convert( varchar(11),getdate(),106),' ','')+'.csv'

  SET @SQL = ' bcp " select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt,FromAcc,ToAcc,ToSegment from [196.1.115.182].squareoff.dbo.VMSS_DP_Holding_Heading '
  
		SET @SQL = @SQL + ' union all select cast(HoldDate as varchar(25)),Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,cast(holding as varchar(25)),cast(Clsrate as varchar(25)),cast(VBHC as varchar(25)),Category,cast(HairCut as varchar(25)),cast(VAHC as varchar(25)),cast(SqOffQty as varchar(25)),cast(SqOffSeq as varchar(25)),cast(id as varchar(25)),cast(AdjAmt as varchar(25)),FromAcc,ToAcc,ToSegment from [196.1.115.182].squareoff.dbo.vmss_dp_holding where tosegment is not null '                                   

  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                           

  SET @SQL = '''' + @SQL + ''''                                        

  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                        

  PRINT @SQL                                        

  EXEC (@SQL)              
  
	 SET @filename3='d:\MindGate\UploadJVCollateral\'+ @FileName         
		
		/*** added as requested by Vishal Gohil on Jan 21 2016 ***/    
			/* End: dp holding data in excel file */
		    
 
  SET @SQL =''            

  SET @SQL = 'Dear Team,<br/><br/>'                                        

  SET @SQL = @SQL + 'Kindly upload the attached DP JV dated (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') pertaining to var margin Square off Module.'                                        

  SET @SQL = @SQL + '<br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                        

            

  DECLARE @s varchar(500)                                                  

  SET @s = @filename1 + ';' + @filename2 + ';' +@filename3                                      

  EXEC msdb.dbo.sp_send_dbmail    

  @profile_name = 'Square',                            

  @recipients= 'mgs.abha@angelbroking.com;vishal@angelbroking.com;anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;',                                        

  @copy_recipients= 'renil.pillai@angelbroking.com;csorm@angelbroking.com',          

   --@blind_copy_recipients= @BCC,                                        

  @body= @SQL,                                        

  @file_attachments= @s,                                        

  @body_format= 'HTML',                                          

  @subject='VMSS (T+3) - DP movement : Var Margin Square Off'                                   

                               

End try                                                             

BEGIN CATCH                                                                

  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                       

  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                      

  DECLARE @ErrorMessage NVARCHAR(4000);                                                        

  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                        

  RAISERROR (@ErrorMessage , 16, 1);                              

End catch                                         

                                        

SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_DPadj_email_bkp15Dec2015
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_DPadj_email_bkp15Dec2015]                          
as                          
                                  
SET XACT_ABORT ON                                  
Set nocount on                                  
 BEGIN TRY                                                          
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                        
      
  update VMSS_DP_Holding set Tosegment=b.DrSegment from VMSS_DrSegment b where VMSS_DP_Holding.party_code=b.party_code                          
  and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                          
      
  /************************************************************************/                          
  update VMSS_DP_Holding set toacc= case                           
  when tosegment= 'NSECM' then '1203320000000051'                          
  when tosegment= 'BSECM' then '1203320000000066'                          
  ELSE '' END                          
  where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                          
      
  update VMSS_DP_Holding set fromacc=Cltdpid                    
  where SqOffQty > 0 and HoldDate =(select Max(processDate) from VMSS_data)                          
      
  /*****************************/                          
  --history updation                          
      
  delete from vmss_DP_holding_hist where HoldDate =(select Max(processDate) from VMSS_data)                  
      
  insert into vmss_DP_holding_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                    
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                     
  from vmss_DP_holding where SqOffQty > 0                    
      
  truncate table VMSS_JV_DP_file                    
  select party_code,scrip_cd=bsecode,series='BSE',isin,qty=SqOffQty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                 
  when len(fromacc)<16 then 'IN301549' else ''  end,                                
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                                 
  when len(toacc)<16 then 'IN301549' else ''  end,                                
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                                
  from VMSS_DP_Holding where sqoffseq > 0                                 
  and HoldDate =(select Max(processDate) from VMSS_data)                                
  AND TOSEGMENT='BSECM'                                
      
  INSERT INTO #JVDATA                                
  select party_code,scrip_cd=nsesymbol,series=nseseries,isin,qty=SqOffQty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                                 
  when len(fromacc)<16 then 'IN301549' else ''  end,                                
  fromacc,                                
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                                 
  when len(toacc)<16 then 'IN301549' else ''  end,                                
  toacc,type1='BTM',TOSEGMENT from VMSS_DP_Holding where sqoffseq > 0                                 
  and HoldDate =(select Max(processDate) from VMSS_data)                                
  AND TOSEGMENT='NSECM'                                
      
  truncate table VMSS_JVDP_file                    
      
  insert into VMSS_JVDP_file                               
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                              
  from #JVDATA                              
      
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                             
      
  DECLARE @file1 AS VARCHAR(100)                                  
  DECLARE @file2 AS VARCHAR(100)             
  DECLARE @i AS INT                                
  DECLARE @str VARCHAR(8000)                                 
  declare @segment varchar(10)                            
    
  DECLARE @fileCnt as int        
  DECLARE @RowCnt int,@FileName as varchar(500)      
        
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)      
        
  DECLARE @SQL VARCHAR(MAX)                                    
  SET @SQL = ''      
        
  CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))      
  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))      
    
   /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/      
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)       
        
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')       
  SET @FileName=''      
        
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 6))+ '.log')      
        
  PRINT @FileName      
        
  INSERT INTO FileData    
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+       
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 6))+      
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                   
        
  INSERT INTO FileData                                
  SELECT  '<Tp>5</Tp>'+'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                   
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                   
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                  
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                  
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn></Rsn>'+                  
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                  
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                   
  FROM   #JVDATAFILE a (nolock)                        
  WHERE tosegment = 'BSECM'     
    
    /*      
  INSERT INTO FileData_rohit_23092015                              
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse       
  */      
                                     
  SET @SQL = ''                                    
        
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                               
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                       
  SET @SQL = '''' + @SQL + ''''                                    
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                    
  PRINT @SQL                                    
  EXEC (@SQL)        
            
  /*Used For Unix formated Data*/      
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName      
        
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1       
        
  SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName      
         
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/          
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/      
          
  SET @fileCnt=(select FileCnt from VMSS_FileCounter)       
        
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')       
  SET @FileName=''      
        
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 6))+ '.log')      
        
  PRINT @FileName      
        
  TRUNCATE TABLE FileData  
          
  INSERT INTO FileData  
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+       
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 6))+      
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')                   
          
  INSERT INTO FileData                              
  SELECT  '<Tp>5</Tp>'+'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+                   
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+                   
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+                  
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+                  
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn></Rsn>'+                  
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+                  
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'                  
  FROM   #JVDATAFILE a (nolock)                        
  WHERE tosegment = 'NSECM'       
           
        
  /*      
  INSERT INTO FileData_rohit_23092015                              
  select DATA from #VMSS_JVCEColl_tblfile_nse       
  */                                      
        
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData '                               
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                       
  SET @SQL = '''' + @SQL + ''''                                    
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                    
  PRINT @SQL                                    
  EXEC (@SQL)          
            
  /*Used For Unix formated Data*/      
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName       
        
  UPDATE VMSS_FileCounter SET FileCnt=@fileCnt + 1        
         
  SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName      
          
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/        
  /*                             
        
  SELECT ID = ROW_NUMBER() OVER(ORDER BY LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))ASC),                                   
  DATA =LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))                                   
  +','+LTRIM(RTRIM(scrip_cd))+','+LTRIM(RTRIM (CONVERT(VARCHAR,series)))+ ','                                    
  +LTRIM(RTRIM(CONVERT(VARCHAR,isin)))+','+ LTRIM(RTRIM (CONVERT(VARCHAR,qty)))+ ','                               
  +(LTRIM(RTRIM(fromdpid)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,todpid)))+','                              
  +LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+','+LTRIM(RTRIM(CONVERT(VARCHAR,type1)))                                   
  INTO  #VMSS_JVCEColl_tblfile_bse                                    
  FROM #JVDATAFILE x                                    
  WHERE tosegment = 'BSECM'                                    
  ORDER BY sr ASC                              
  */      
        
          
         
  --TRUNCATE TABLE #VMSS_JVCEColl_tblfile_bse      
  /*       
  SELECT ID = ROW_NUMBER() OVER(ORDER BY LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))ASC),                                   
  DATA =LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))                             
  +','+LTRIM(RTRIM(scrip_cd))+','+LTRIM(RTRIM (CONVERT(VARCHAR,series)))+ ','                                    
  +LTRIM(RTRIM(CONVERT(VARCHAR,isin)))+','+ LTRIM(RTRIM (CONVERT(VARCHAR,qty)))+ ','                               
  +(LTRIM(RTRIM(fromdpid)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,todpid)))+','                              
  +LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+','+LTRIM(RTRIM(CONVERT(VARCHAR,type1)))                                   
  INTO  #VMSS_JVCEColl_tblfile_nse                                    
  FROM #JVDATAFILE x                                    
  WHERE tosegment = 'NSECM'                                    
  ORDER BY sr ASC                              
        
  SET @file2=''                              
  SET @file2 = (SELECT 'VMSS_T4_JV_DP_GeneratedFile_'+'NSECM'+'_'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','')+ '.csv')                                 
        
  insert into FileData_rohit_23092015                              
  select DATA,'NSECM' from #VMSS_JVCEColl_tblfile_nse                              
        
  SET @SQL = ''                                    
        
  SET @SQL = ' bcp " SELECT flddata FROM [196.1.115.182].squareoff.dbo.FileData_rohit_23092015 WHERE SEGMENT=''''NSECM'''''                                    
        
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @file2 + ' -c -Sintranet -Uinhouse -Pinh6014 '                                  
  SET @SQL = '''' + @SQL + ''''                                    
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                    
  --PRINT @SQL                                    
  EXEC (@SQL)       
        
  */                             
        
                                   
  /*      
  select @filename1='d:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_DP_GeneratedFile_' + 'BSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'                                                     
  select @filename2='d:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_DP_GeneratedFile_' + 'NSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'      
                                   
  print @filename1                              
  */      
        
  SET @SQL =''        
  SET @SQL = 'Dear Team,<br/><br/>'                                    
  SET @SQL = @SQL + 'Kindly upload the attached DP JV dated (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') pertaining to var margin Square off Module.'                                    
  SET @SQL = @SQL + '<br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                    
        
  DECLARE @s varchar(500)                                              
  SET @s = @filename1 + ';' + @filename2                                   
        
  EXEC msdb.dbo.sp_send_dbmail                                    
  @profile_name = 'Square',                        
  @recipients= 'mgs.abha@angelbroking.com;vishal@angelbroking.com;anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com;',                                    
  @copy_recipients= 'renil.pillai@angelbroking.com;csorm@angelbroking.com',      
   --@blind_copy_recipients= @BCC,                                    
  @body= @SQL,                                    
  @file_attachments= @s,                                    
  @body_format= 'HTML',                                    
  @subject='VMSS (T+3) - DP movement : Var Margin Square Off'                               
                           
End try                                                         
BEGIN CATCH                                                            
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                   
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                                  
  DECLARE @ErrorMessage NVARCHAR(4000);                                                    
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
  RAISERROR (@ErrorMessage , 16, 1);                          
End catch                                     
                                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_DPadj_email_Rohit_4Sep2015
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_DPadj_email_Rohit_4Sep2015]                        
as                        
                                
SET XACT_ABORT ON                                
Set nocount on                                
 BEGIN TRY                                                        
  --declare @tdate datetime = (select Max(processDate) from VMSS_data)                     

  update VMSS_DP_Holding_rohit_23092015 set Tosegment=b.DrSegment from VMSS_DrSegment b where VMSS_DP_Holding_rohit_23092015.party_code=b.party_code                        
  and  SqOffQty > 0  and HoldDate =(select Max(processDate) from VMSS_data)                        
    
  /************************************************************************/                        
  update VMSS_DP_Holding_rohit_23092015 set toacc= case                         
  when tosegment= 'NSECM' then '1203320000000051'                        
  when tosegment= 'BSECM' then '1203320000000066'                        
  ELSE '' END                        
  where SqOffQty > 0 and HoldDate = (select Max(processDate) from VMSS_data)                        
    
  update VMSS_DP_Holding_rohit_23092015 set fromacc=Cltdpid                  
  where SqOffQty > 0 and HoldDate =(select Max(processDate) from VMSS_data)                        
    
  /*****************************/                        
  --history updation                        
    
  --delete from vmss_DP_holding_hist where HoldDate =(select Max(processDate) from VMSS_data)                
    
  --insert into vmss_DP_holding_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)                  
  --select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt                   
  --from VMSS_DP_Holding_rohit_23092015 where SqOffQty > 0                  
    
  truncate table FileData_rohit_23092015  
                    
  select party_code,scrip_cd=bsecode,series='BSE',isin,qty=SqOffQty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9) when len(fromacc)<16 then 'IN301549' else ''  end,                              
  fromacc, todpid=case when len(toacc)=16 then substring(toacc,0,9)                               
  when len(toacc)<16 then 'IN301549' else ''  end,                              
  toacc,type1='BTM',TOSEGMENT   
  INTO #JVDATA                              
  from VMSS_DP_Holding_rohit_23092015 where sqoffseq > 0                               
  and HoldDate =(select Max(processDate) from VMSS_data)                              
  AND TOSEGMENT='BSECM'                              
    
  INSERT INTO #JVDATA                              
  select party_code,scrip_cd=nsesymbol,series=nseseries,isin,qty=SqOffQty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)when len(fromacc)<16 then 'IN301549' else ''  end,                              
  fromacc,                              
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                               
  when len(toacc)<16 then 'IN301549' else ''  end,                              
  toacc,type1='BTM',TOSEGMENT from VMSS_DP_Holding_rohit_23092015 where sqoffseq > 0                               
  and HoldDate =(select Max(processDate) from VMSS_data)                              
  AND TOSEGMENT='NSECM'                              
   
  TRUNCATE TABLE VMSS_JVDP_file_Rohit_23092015                  
    
  insert into VMSS_JVDP_file_Rohit_23092015                             
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                            
  from #JVDATA                            
    
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,*   
  into #JVDATAFILE   
  from #JVDATA                           
    
  DECLARE @file1 AS VARCHAR(100)                                
  DECLARE @file2 AS VARCHAR(100)                               
  DECLARE @i AS INT                              
  DECLARE @str VARCHAR(8000)                               
  DECLARE @segment varchar(10)  
    
  DECLARE @fileCnt as int    
  DECLARE @RowCnt int,@FileName as varchar(500)  
    
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)  
    
  DECLARE @SQL VARCHAR(MAX)                                
  SET @SQL = ''  
    
  CREATE TABLE #VMSS_JVCEColl_tblfile_bse(DATA VARCHAR(MAX))  
  CREATE TABLE #VMSS_JVCEColl_tblfile_nse(DATA VARCHAR(MAX))  
    
  /*********************BSE********************BSE*********************BSE************************BSE*******************BSE***************/  
  SET @fileCnt=(select FileCnt from VMSS_FileCounter_rohit_23092015)   
    
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'BSECM')   
  SET @FileName=''  
    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 6))+ '.log')  
    
  PRINT @FileName  
    
  INSERT INTO FileData_rohit_23092015  
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 6))+  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')               
    
  INSERT INTO FileData_rohit_23092015                                  
  SELECT  '<Tp>5</Tp>'+'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn></Rsn>'+              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'               
  FROM   #JVDATAFILE a (nolock)                    
  WHERE tosegment = 'BSECM'   
   
  /*  
  INSERT INTO FileData_rohit_23092015                          
  SELECT DATA FROM #VMSS_JVCEColl_tblfile_bse   
  */  
                                 
  SET @SQL = ''                                
    
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData_rohit_23092015 '                           
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                   
  SET @SQL = '''' + @SQL + ''''                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                
  PRINT @SQL                                
  EXEC (@SQL)    
        
  /*Used For Unix formated Data*/  
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName  
    
  UPDATE VMSS_FileCounter_rohit_23092015 SET FileCnt=@fileCnt + 1   
    
  SET @filename1='d:\MindGate\UploadJVCollateral\'+ @FileName  
     
  /****************** END BSE ***************************** END BSE ****************************** END BSE ***********************************/      
  /*********************NSE********************NSE********************* NSE ************************NSE*******************NSE***************/  
      
  SET @fileCnt=(select FileCnt from VMSS_FileCounter_rohit_23092015)   
    
  SET @RowCnt = (SELECT COUNT(*)as a FROM   #JVDATAFILE a (nolock) WHERE tosegment = 'NSECM')   
  SET @FileName=''  
    
  SET @FileName=(SELECT  'LogPOA_'+ replace(convert( varchar(11),getdate(),106),' ','')+ CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 6))+ '.log')  
    
  PRINT @FileName  
    
  TRUNCATE TABLE FileData_rohit_23092015  
      
  INSERT INTO FileData_rohit_23092015  
  SELECT  '033200DPADM'+' '+ CONVERT(VARCHAR,right( POWER(10, 6) + @RowCnt, 6))+   
  CONVERT(VARCHAR,right( POWER(10, 6) + @fileCnt, 6))+  
  Replace(CONVERT(VARCHAR(11), (GETDATE()), 105), '-', '')               
      
  INSERT INTO FileData_rohit_23092015                                  
  SELECT  '<Tp>5</Tp>'+'<Dt>'+Replace(CONVERT(VARCHAR(11), getdate(), 105), '-', '')+'</Dt>'+               
  '<Bnfcry>'+LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+'</Bnfcry>'+               
  '<CtrPty>'+LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+'</CtrPty>'+              
  '<ISIN>'+isin+'</ISIN>'+ '<Qty>'+convert(varchar, qty)+'</Qty>'+              
  '<Flg>S</Flg>'+'<Trf>X</Trf>'+'<Rsn></Rsn>'+              
  '<Ref></Ref>'+'<Sttlm></Sttlm>'+              
  '<CntrSttlm></CntrSttlm>'+'<Arf></Arf>'              
  FROM   #JVDATAFILE a (nolock)                    
  WHERE tosegment = 'NSECM'   
       
    
  /*  
  INSERT INTO FileData_rohit_23092015                          
  select DATA from #VMSS_JVCEColl_tblfile_nse   
  */                                  
    
  SET @SQL = ' bcp " SELECT FileData FROM [196.1.115.182].Squareoff.dbo.FileData_rohit_23092015 '                           
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @FileName + ' -c -Sintranet -Uinhouse -Pinh6014 '                                   
  SET @SQL = '''' + @SQL + ''''                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                
  PRINT @SQL                                
  EXEC (@SQL)      
        
  /*Used For Unix formated Data*/  
  exec [GENERAL].dbo.USP_PledgeConvertor_Unix '\\196.1.115.182\d\MindGate\UploadJVCollateral\',@FileName   
    
  UPDATE VMSS_FileCounter_rohit_23092015 SET FileCnt=@fileCnt + 1    
     
  SET @filename2='d:\MindGate\UploadJVCollateral\'+ @FileName  
      
  /****************** END NSE ***************************** END NSE ****************************** END NSE ***********************************/    
  /*                         
    
  SELECT ID = ROW_NUMBER() OVER(ORDER BY LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))ASC),                               
  DATA =LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))                               
  +','+LTRIM(RTRIM(scrip_cd))+','+LTRIM(RTRIM (CONVERT(VARCHAR,series)))+ ','                                
  +LTRIM(RTRIM(CONVERT(VARCHAR,isin)))+','+ LTRIM(RTRIM (CONVERT(VARCHAR,qty)))+ ','                           
  +(LTRIM(RTRIM(fromdpid)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,todpid)))+','                          
  +LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+','+LTRIM(RTRIM(CONVERT(VARCHAR,type1)))                               
  INTO  #VMSS_JVCEColl_tblfile_bse                                
  FROM #JVDATAFILE x                                
  WHERE tosegment = 'BSECM'                                
  ORDER BY sr ASC                          
  */  
    
      
     
  --TRUNCATE TABLE #VMSS_JVCEColl_tblfile_bse  
  /*   
  SELECT ID = ROW_NUMBER() OVER(ORDER BY LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))ASC),                               
  DATA =LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))                         
  +','+LTRIM(RTRIM(scrip_cd))+','+LTRIM(RTRIM (CONVERT(VARCHAR,series)))+ ','                                
  +LTRIM(RTRIM(CONVERT(VARCHAR,isin)))+','+ LTRIM(RTRIM (CONVERT(VARCHAR,qty)))+ ','                           
  +(LTRIM(RTRIM(fromdpid)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,todpid)))+','                          
  +LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+','+LTRIM(RTRIM(CONVERT(VARCHAR,type1)))                               
  INTO  #VMSS_JVCEColl_tblfile_nse                                
  FROM #JVDATAFILE x                                
  WHERE tosegment = 'NSECM'                                
  ORDER BY sr ASC                          
    
  SET @file2=''                          
  SET @file2 = (SELECT 'VMSS_T4_JV_DP_GeneratedFile_'+'NSECM'+'_'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','')+ '.csv')                             
    
  insert into FileData_rohit_23092015                          
  select DATA,'NSECM' from #VMSS_JVCEColl_tblfile_nse                          
    
  SET @SQL = ''                                
    
  SET @SQL = ' bcp " SELECT flddata FROM [196.1.115.182].squareoff.dbo.FileData_rohit_23092015 WHERE SEGMENT=''''NSECM'''''                                
    
  SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @file2 + ' -c -Sintranet -Uinhouse -Pinh6014 '                              
  SET @SQL = '''' + @SQL + ''''                                
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                                
  --PRINT @SQL                                
  EXEC (@SQL)   
    
  */                         
    
                               
  /*  
  select @filename1='d:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_DP_GeneratedFile_' + 'BSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'                                                 
  select @filename2='d:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_DP_GeneratedFile_' + 'NSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'  
                               
  print @filename1                          
  */  
    
  SET @SQL =''    
  SET @SQL = 'Dear Team,<br/><br/>'                                
  SET @SQL = @SQL + 'Kindly upload the attached DP JV dated (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') pertaining to var margin Square off Module.'                                
  SET @SQL = @SQL + '<br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                                
    
  DECLARE @s varchar(500)                                          
  SET @s = @filename1 + ';' + @filename2                               
    
  EXEC msdb.dbo.sp_send_dbmail                                
  @profile_name = 'Square',                    
  @recipients= 'mgs.abha@angelbroking.com;vishal@angelbroking.com',                                
 -- @copy_recipients= 'manesh@angelbroking.com;renil.pillai@angelbroking.com;rohit.patil@angelbroking.com',  
   --@blind_copy_recipients= @BCC,                                
  @body= @SQL,                                
  @file_attachments= @s,                                
  @body_format= 'HTML',                                
  @subject='VMSS (T+3) - DP movement : Var Margin Square Off'                           
                       
End try                                                     
BEGIN CATCH                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                               
  select GETDATE(),'VMSS_DPadj_email',ERROR_LINE(),ERROR_MESSAGE()                                                              
  DECLARE @ErrorMessage NVARCHAR(4000);                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                
  RAISERROR (@ErrorMessage , 16, 1);                      
End catch                                 
                                
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_DPadj_Process
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_DPadj_Process]              
as              
SET XACT_ABORT ON                                            
Set nocount on                                            
 BEGIN TRY                
    
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))              
    
  select a.* into #file2 from  
  (select   
  processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,  
  Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,  
  MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,  
  NSECM_Balance,updatedon,flag,Remarks,DP_adj,VarMarRelSqAmt,Actual_Cash_Square_Off_Done,  
  VarMarginShortFall_AftAdjCurrDay  
  from vmss_Data with (nolock) where processdate=@tdate) a join               
  VMSS_ASB7_Days b on a.party_code=b.party_Code  
    
  update vmss_DP_holding set SqOffQty=0,SqOffSeq=0,Adjamt=0      

  select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #filex                                   
  from #file2 where VarMarginShortFall_AftAdjCurrDay < 0                       
    
  Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                  
  declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0--,@AdjAmt as money=0                                  
    
  select @totctr=MAX(srno) from #filex                                  
    
  While @ctr <= @totctr                                  
  Begin                                  
    
  set @SqOffVal=0                                  
  select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdjCurrDay*-1 from #filex where srno=@ctr                           
    
  select ROW_NUMBER() OVER ( ORDER BY b.seqid,vbhc desc) AS [SrNo],              
  HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC=(VBHC-VAHC),SqOffQty,SqOffSeq,id              
  into #holdadj from vmss_DP_holding a join                                  
  (select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                  
  where party_code=@pcode and Clsrate > 0 and haircut < 100                                  
    
  select @Xtotctr=MAX(Srno) from #holdadj                                   
  set @TSqOffVal=0                                  
    
  set @Xctr=1                        
    
  While @Xctr <= @Xtotctr  and @SqOffVal > 0                                 
  BEGIN                                  
    
  --select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=holding,@clsrate=Clsrate,@id=id  from #holdadj where srno=@xctr                         
  select @TSqOffVal=(VBHC-VAHC),@qty=holding,@clsrate=Clsrate,@id=id  from #holdadj where srno=@xctr
    
  if (@SqOffVal<@TSqOffVal)                                  
  set @TSqOffVal=@SqOffVal                                  
    
  update vmss_DP_holding                      
  set           
  /*SqOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end), */                   
  SqOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),            
  SqOffseq=@xctr                     
  where id=@id         

  --select  @AdjAmt=(7*clsrate)-(7*clsrate)*(haircut/100) from  vmss_DP_holding_all_14062016 where     id=@id  
    
  --set @SqOffVal=case when @TSqOffVal- @AdjAmt <0 then 0 else      @TSqOffVal- @AdjAmt end                       
  
	set @SqOffVal=@SqOffVal-@TSqOffVal   
    
  --set @SqOffVal=@TSqOffVal             
    
  set @Xctr=@Xctr+1                                  
  END                                  
    
  DROP TABLE #holdadj                                  
    
  set @ctr=@ctr+1                                  
  end                                  
    
  drop table #filex                                  
    
  /* update vmss_DP_holding_all_14062016 set AdjAmt=((SqOffQty*clsrate)*(Haircut/100.00)) */             
  update vmss_DP_holding set AdjAmt=SqOffQty*(clsrate-(clsrate*(haircut/100)))          
    
  /*            
  insert into vmss_DP_holding_all_14062016_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)              
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt               
  from vmss_DP_holding_all_14062016 where SqOffQty > 0              
  */            
  
  
    
  update vmss_Data set DP_adj=AdjAmt from               
  (select party_code,sum(AdjAmt) as AdjAmt from vmss_DP_holding where sqOffQty <> 0 group by party_code) b              
  where vmss_Data.party_code=b.party_code and vmss_Data.processdate=@tdate               
    
  update  vmss_Data set VarMarginShortFall_AftAdjCurrDay=VarMarginShortFall_AftAdjCurrDay+DP_adj where  DP_adj > 0 and processdate=@tdate              
  update  vmss_Data set VarMarginShortFall_AftAdjCurrDay=0 where VarMarginShortFall_AftAdjCurrDay > 0 and processdate=@tdate              
    
 End try                                                                 
 BEGIN CATCH                                                                    
  --insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                          
  --select GETDATE(),'VMSS_DPadj_Process',ERROR_LINE(),ERROR_MESSAGE()                               
  --DECLARE @ErrorMessage NVARCHAR(4000);                                                
  --SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                
  --RAISERROR (@ErrorMessage , 16, 1);                      
 End catch                                     
                                            
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_DPadj_Process_04052016
-- --------------------------------------------------
Create Procedure [dbo].[VMSS_DPadj_Process_04052016]            
as            
SET XACT_ABORT ON                                          
Set nocount on                                          
 BEGIN TRY              

    
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))            
  
  select a.* into #file2 from
  (select 
  processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,
  Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,
  MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,
  NSECM_Balance,updatedon,flag,Remarks,DP_adj,VarMarRelSqAmt,Actual_Cash_Square_Off_Done,
  VarMarginShortFall_AftAdjCurrDay
  from vmss_Data with (nolock) where processdate=@tdate) a join             
  VMSS_ASB7_Days b on a.party_code=b.party_Code
  
  update vmss_DP_holding set SqOffQty=0,SqOffSeq=0,Adjamt=0            
  
  select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #filex                                 
  from #file2 where VarMarginShortFall_AftAdjCurrDay < 0                     
  
  Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                
  declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                
  
  select @totctr=MAX(srno) from #filex                                
  
  While @ctr <= @totctr                                
  Begin                                
  
  set @SqOffVal=0                                
  select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdjCurrDay*-1 from #filex where srno=@ctr                         
  
  select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],            
  HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC=(VBHC-VAHC),SqOffQty,SqOffSeq,id            
  into #holdadj from vmss_DP_holding a join                                
  (select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                
  where party_code=@pcode and Clsrate > 0 and haircut < 100                                
  
  select @Xtotctr=MAX(Srno) from #holdadj                                 
  set @TSqOffVal=0                                
  
  set @Xctr=1                      
  
  While @Xctr <= @Xtotctr  and @SqOffVal > 0                               
  BEGIN                                
  
  select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=holding,@clsrate=Clsrate,@id=id  from #holdadj where srno=@xctr                       
  
  if (@SqOffVal<@TSqOffVal)                                
  set @TSqOffVal=@SqOffVal                                
  
  update vmss_dp_holding                      
  set         
  /*SqOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end), */                 
  SqOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),          
  SqOffseq=@xctr                   
  where id=@id                         
  
  set @SqOffVal=@TSqOffVal                                
  
  set @Xctr=@Xctr+1                                
  END                                
  
  DROP TABLE #holdadj                                
  
  set @ctr=@ctr+1                                
  end                                
  
  drop table #filex                                
  
  /* update vmss_DP_holding set AdjAmt=((SqOffQty*clsrate)*(Haircut/100.00)) */           
  update vmss_DP_holding set AdjAmt=SqOffQty*(clsrate-(clsrate*(haircut/100)))        
  
  /*          
  insert into vmss_DP_holding_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)            
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt             
  from vmss_DP_holding where SqOffQty > 0            
  */          
  
  update vmss_Data set DP_adj=AdjAmt from             
  (select party_code,sum(AdjAmt) as AdjAmt from vmss_DP_holding where sqOffQty <> 0 group by party_code) b            
  where vmss_Data.party_code=b.party_code and vmss_Data.processdate=@tdate             
  
  update  vmss_data set VarMarginShortFall_AftAdjCurrDay=VarMarginShortFall_AftAdjCurrDay+DP_adj where  DP_adj > 0 and processdate=@tdate            
  update  vmss_data set VarMarginShortFall_AftAdjCurrDay=0 where VarMarginShortFall_AftAdjCurrDay > 0 and processdate=@tdate            
  
 End try                                                               
 BEGIN CATCH                                                                  
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                        
  select GETDATE(),'VMSS_DPadj_Process',ERROR_LINE(),ERROR_MESSAGE()                             
  DECLARE @ErrorMessage NVARCHAR(4000);                                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                              
  RAISERROR (@ErrorMessage , 16, 1);                    
 End catch                                   
                                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_DPadj_Process_15062016
-- --------------------------------------------------
Create Procedure [dbo].[VMSS_DPadj_Process_15062016]            
as            
SET XACT_ABORT ON                                          
Set nocount on                                          
 BEGIN TRY              

    
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))            
  
  select a.* into #file2 from
  (select 
  processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,
  Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,
  MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,
  NSECM_Balance,updatedon,flag,Remarks,DP_adj,VarMarRelSqAmt,Actual_Cash_Square_Off_Done,
  VarMarginShortFall_AftAdjCurrDay
  from vmss_Data with (nolock) where processdate=@tdate) a join             
  VMSS_ASB7_Days b on a.party_code=b.party_Code
  
  update vmss_DP_holding set SqOffQty=0,SqOffSeq=0,Adjamt=0            
  
  select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #filex                                 
  from #file2 where VarMarginShortFall_AftAdjCurrDay < 0                     
  
  Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                
  declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                
  
  select @totctr=MAX(srno) from #filex                                
  
  While @ctr <= @totctr                                
  Begin                                
  
  set @SqOffVal=0                                
  select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdjCurrDay*-1 from #filex where srno=@ctr                         
  
  select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],            
  HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC=(VBHC-VAHC),SqOffQty,SqOffSeq,id            
  into #holdadj from vmss_DP_holding a join                                
  (select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                
  where party_code=@pcode and Clsrate > 0 and haircut < 100                                
  
  select @Xtotctr=MAX(Srno) from #holdadj                                 
  set @TSqOffVal=0                                
  
  set @Xctr=1                      
  
  While @Xctr <= @Xtotctr  and @SqOffVal > 0                               
  BEGIN                                
  
  select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=holding,@clsrate=Clsrate,@id=id  from #holdadj where srno=@xctr                       
  
  if (@SqOffVal<@TSqOffVal)                                
  set @TSqOffVal=@SqOffVal                                
  
  update vmss_dp_holding                      
  set         
  /*SqOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end), */                 
  SqOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),          
  SqOffseq=@xctr                   
  where id=@id                         
  
  set @SqOffVal=@TSqOffVal                                
  
  set @Xctr=@Xctr+1                                
  END                                
  
  DROP TABLE #holdadj                                
  
  set @ctr=@ctr+1                                
  end                                
  
  drop table #filex                                
  
  /* update vmss_DP_holding set AdjAmt=((SqOffQty*clsrate)*(Haircut/100.00)) */           
  update vmss_DP_holding set AdjAmt=SqOffQty*(clsrate-(clsrate*(haircut/100)))        
  
  /*          
  insert into vmss_DP_holding_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)            
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt             
  from vmss_DP_holding where SqOffQty > 0            
  */          
  
  update vmss_Data set DP_adj=AdjAmt from             
  (select party_code,sum(AdjAmt) as AdjAmt from vmss_DP_holding where sqOffQty <> 0 group by party_code) b            
  where vmss_Data.party_code=b.party_code and vmss_Data.processdate=@tdate             
  
  update  vmss_data set VarMarginShortFall_AftAdjCurrDay=VarMarginShortFall_AftAdjCurrDay+DP_adj where  DP_adj > 0 and processdate=@tdate            
  update  vmss_data set VarMarginShortFall_AftAdjCurrDay=0 where VarMarginShortFall_AftAdjCurrDay > 0 and processdate=@tdate            
  
 End try                                                               
 BEGIN CATCH                                                                  
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                        
  select GETDATE(),'VMSS_DPadj_Process',ERROR_LINE(),ERROR_MESSAGE()                             
  DECLARE @ErrorMessage NVARCHAR(4000);                                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                              
  RAISERROR (@ErrorMessage , 16, 1);                    
 End catch                                   
                                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_DPadj_Process_17062016
-- --------------------------------------------------
create Procedure [dbo].[VMSS_DPadj_Process_17062016]            
as            
SET XACT_ABORT ON                                          
Set nocount on                                          
 BEGIN TRY              

    
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))            
  
  select a.* into #file2 from
  (select 
  processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,
  Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,
  MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,
  NSECM_Balance,updatedon,flag,Remarks,DP_adj,VarMarRelSqAmt,Actual_Cash_Square_Off_Done,
  VarMarginShortFall_AftAdjCurrDay
  from vmss_Data with (nolock) where processdate=@tdate) a join             
  VMSS_ASB7_Days b on a.party_code=b.party_Code
  
  update vmss_DP_holding set SqOffQty=0,SqOffSeq=0,Adjamt=0            
  
  select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #filex                                 
  from #file2 where VarMarginShortFall_AftAdjCurrDay < 0                     
  
  Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                
  declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                
  
  select @totctr=MAX(srno) from #filex                                
  
  While @ctr <= @totctr                                
  Begin                                
  
  set @SqOffVal=0                                
  select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdjCurrDay*-1 from #filex where srno=@ctr                         
  
  select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],            
  HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC=(VBHC-VAHC),SqOffQty,SqOffSeq,id            
  into #holdadj from vmss_DP_holding a join                                
  (select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                
  where party_code=@pcode and Clsrate > 0 and haircut < 100                                
  
  select @Xtotctr=MAX(Srno) from #holdadj                                 
  set @TSqOffVal=0                                
  
  set @Xctr=1                      
  
  While @Xctr <= @Xtotctr  and @SqOffVal > 0                               
  BEGIN                                
  
  select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=holding,@clsrate=Clsrate,@id=id  from #holdadj where srno=@xctr                       
  
  if (@SqOffVal<@TSqOffVal)                                
  set @TSqOffVal=@SqOffVal                                
  
  update vmss_dp_holding                      
  set         
  /*SqOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end), */                 
  SqOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),          
  SqOffseq=@xctr                   
  where id=@id                         
  
  set @SqOffVal=@TSqOffVal                                
  
  set @Xctr=@Xctr+1                                
  END                                
  
  DROP TABLE #holdadj                                
  
  set @ctr=@ctr+1                                
  end                                
  
  drop table #filex                                
  
  /* update vmss_DP_holding set AdjAmt=((SqOffQty*clsrate)*(Haircut/100.00)) */           
  update vmss_DP_holding set AdjAmt=SqOffQty*(clsrate-(clsrate*(haircut/100)))        
  
  /*          
  insert into vmss_DP_holding_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)            
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt             
  from vmss_DP_holding where SqOffQty > 0            
  */          
  
  update vmss_Data set DP_adj=AdjAmt from             
  (select party_code,sum(AdjAmt) as AdjAmt from vmss_DP_holding where sqOffQty <> 0 group by party_code) b            
  where vmss_Data.party_code=b.party_code and vmss_Data.processdate=@tdate             
  
  update  vmss_data set VarMarginShortFall_AftAdjCurrDay=VarMarginShortFall_AftAdjCurrDay+DP_adj where  DP_adj > 0 and processdate=@tdate            
  update  vmss_data set VarMarginShortFall_AftAdjCurrDay=0 where VarMarginShortFall_AftAdjCurrDay > 0 and processdate=@tdate            
  
 End try                                                               
 BEGIN CATCH                                                                  
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                        
  select GETDATE(),'VMSS_DPadj_Process',ERROR_LINE(),ERROR_MESSAGE()                             
  DECLARE @ErrorMessage NVARCHAR(4000);                                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                              
  RAISERROR (@ErrorMessage , 16, 1);                    
 End catch                                   
                                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_DPadj_Process_A92196_14062016
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_DPadj_Process_A92196_14062016]            
as            
SET XACT_ABORT ON                                          
Set nocount on                                          
 BEGIN TRY              

    
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data_A92196_14062016 with (nolock))            
  
  select a.* into #file2 from
  (select 
  processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,
  Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,
  MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,
  NSECM_Balance,updatedon,flag,Remarks,DP_adj,VarMarRelSqAmt,Actual_Cash_Square_Off_Done,
  VarMarginShortFall_AftAdjCurrDay
  from vmss_Data_A92196_14062016 with (nolock) where processdate=@tdate) a join             
  VMSS_ASB7_Days b on a.party_code=b.party_Code
  
  update vmss_DP_holding_A92196_14062016 set SqOffQty=0,SqOffSeq=0,Adjamt=0    
  
  /*******************/
  update   #file2 set      VarMarginShortFall_AftAdjCurrDay= VarMarginShortFall
  
  
  select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #filex                                 
  from #file2 where VarMarginShortFall_AftAdjCurrDay < 0                     
  
  Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                
  declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0,@AdjAmt as money=0                                
  
  select @totctr=MAX(srno) from #filex                                
  
  While @ctr <= @totctr                                
  Begin                                
  
  set @SqOffVal=0                                
  select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdjCurrDay*-1 from #filex where srno=@ctr                         
  
  select ROW_NUMBER() OVER ( ORDER BY b.seqid desc,vbhc desc) AS [SrNo],            
  HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC=(VBHC-VAHC),SqOffQty,SqOffSeq,id            
  into #holdadj from vmss_DP_holding_A92196_14062016 a join                                
  (select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                
  where party_code=@pcode and Clsrate > 0 and haircut < 100                                
  
  select @Xtotctr=MAX(Srno) from #holdadj                                 
  set @TSqOffVal=0                                
  
  set @Xctr=1                      
  
  While @Xctr <= @Xtotctr  and @SqOffVal > 0                               
  BEGIN                                
  
  select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=holding,@clsrate=Clsrate,@id=id  from #holdadj where srno=@xctr                       
  
  if (@SqOffVal<@TSqOffVal)                                
  set @TSqOffVal=@SqOffVal                                
  
  update vmss_DP_holding_A92196_14062016                      
  set         
  /*SqOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end), */                 
  SqOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),          
  SqOffseq=@xctr                   
  where id=@id       
  
  
    
  select  @AdjAmt=(7*clsrate)-(7*clsrate)*(haircut/100) from  vmss_DP_holding_A92196_14062016 where     id=@id
  
  set @SqOffVal=case when @TSqOffVal- @AdjAmt <0 then 0 else      @TSqOffVal- @AdjAmt end                     
  
  --set @SqOffVal=@TSqOffVal                                
  
  set @Xctr=@Xctr+1                                
  END                                
  
  DROP TABLE #holdadj                                
  
  set @ctr=@ctr+1                                
  end                                
  
  drop table #filex                                
  
  /* update vmss_DP_holding_A92196_14062016 set AdjAmt=((SqOffQty*clsrate)*(Haircut/100.00)) */           
  update vmss_DP_holding_A92196_14062016 set AdjAmt=SqOffQty*(clsrate-(clsrate*(haircut/100)))        
  
  /*          
  insert into vmss_DP_holding_A92196_14062016_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)            
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt             
  from vmss_DP_holding_A92196_14062016 where SqOffQty > 0            
  */          
  
  update vmss_Data_A92196_14062016 set DP_adj=AdjAmt from             
  (select party_code,sum(AdjAmt) as AdjAmt from vmss_DP_holding_A92196_14062016 where sqOffQty <> 0 group by party_code) b            
  where vmss_Data_A92196_14062016.party_code=b.party_code and vmss_Data_A92196_14062016.processdate=@tdate             
  
  update  vmss_Data_A92196_14062016 set VarMarginShortFall_AftAdjCurrDay=VarMarginShortFall_AftAdjCurrDay+DP_adj where  DP_adj > 0 and processdate=@tdate            
  update  vmss_Data_A92196_14062016 set VarMarginShortFall_AftAdjCurrDay=0 where VarMarginShortFall_AftAdjCurrDay > 0 and processdate=@tdate            
  
 End try                                                               
 BEGIN CATCH                                                                  
  --insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                        
  --select GETDATE(),'VMSS_DPadj_Process',ERROR_LINE(),ERROR_MESSAGE()                             
  --DECLARE @ErrorMessage NVARCHAR(4000);                                              
  --SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                              
  --RAISERROR (@ErrorMessage , 16, 1);                    
 End catch                                   
                                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_DPadj_Process_all_14062016
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_DPadj_Process_all_14062016]              
as              
SET XACT_ABORT ON                                            
Set nocount on                                            
 BEGIN TRY                
   
 truncate table  vmss_Data_all_14062016
 
 insert into vmss_Data_all_14062016
 select * from vmss_Data where processDate between Convert(datetime,Convert(varchar(11),GETDATE()-1,103),103) 
 and Convert(datetime,Convert(varchar(11),GETDATE()-1,103)+ ' 23:59:59' ,103)
 
 truncate table vmss_DP_holding_all_14062016
 
 insert into vmss_DP_holding_all_14062016
 select * from vmss_DP_holding where holddate between Convert(datetime,Convert(varchar(11),GETDATE()-1,103),103) 
 and Convert(datetime,Convert(varchar(11),GETDATE()-1,103)+ ' 23:59:59' ,103)
  
      
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data_all_14062016 with (nolock))              
    
  select a.* into #file2 from  
  (select   
  processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,  
  Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,  
  MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,  
  NSECM_Balance,updatedon,flag,Remarks,DP_adj,VarMarRelSqAmt,Actual_Cash_Square_Off_Done,  
  VarMarginShortFall_AftAdjCurrDay  
  from vmss_Data_all_14062016 with (nolock) where processdate=@tdate) a join               
  VMSS_ASB7_Days b on a.party_code=b.party_Code  
    
  update vmss_DP_holding_all_14062016 set SqOffQty=0,SqOffSeq=0,Adjamt=0      
    
  /*******************/  
  update   #file2 set      VarMarginShortFall_AftAdjCurrDay= VarMarginShortFall_AftAdj  
    
    
    
  select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #filex                                   
  from #file2 where VarMarginShortFall_AftAdjCurrDay < 0                       
    
  Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                  
  declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0--,@AdjAmt as money=0                                  
    
  select @totctr=MAX(srno) from #filex                                  
    
  While @ctr <= @totctr                                  
  Begin                                  
    
  set @SqOffVal=0                                  
  select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdjCurrDay*-1 from #filex where srno=@ctr                           
    
  select ROW_NUMBER() OVER ( ORDER BY b.seqid,vbhc desc) AS [SrNo],              
  HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC=(VBHC-VAHC),SqOffQty,SqOffSeq,id              
  into #holdadj from vmss_DP_holding_all_14062016 a join                                  
  (select Srno as seqid,CategoryName from General.dbo.ScripCategory_master) b on a.category=b.CategoryName                                  
  where party_code=@pcode and Clsrate > 0 and haircut < 100                                  
    
  select @Xtotctr=MAX(Srno) from #holdadj                                   
  set @TSqOffVal=0                                  
    
  set @Xctr=1                        
    
  While @Xctr <= @Xtotctr  and @SqOffVal > 0                                 
  BEGIN                                  
    
  --select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=holding,@clsrate=Clsrate,@id=id  from #holdadj where srno=@xctr                         
  select @TSqOffVal=(VBHC-VAHC),@qty=holding,@clsrate=Clsrate,@id=id  from #holdadj where srno=@xctr
    
  if (@SqOffVal<@TSqOffVal)                                  
  set @TSqOffVal=@SqOffVal                                  
    
  update vmss_DP_holding_all_14062016                        
  set           
  /*SqOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end), */                   
  SqOffQty=ceiling(Case when @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) <= @qty then @SqOffVal/(@clsrate-(@clsrate*(Haircut/100.00))) else @qty end),            
  SqOffseq=@xctr                     
  where id=@id         
    
    
      
  --select  @AdjAmt=(7*clsrate)-(7*clsrate)*(haircut/100) from  vmss_DP_holding_all_14062016 where     id=@id  
    
  --set @SqOffVal=case when @TSqOffVal- @AdjAmt <0 then 0 else      @TSqOffVal- @AdjAmt end                       
  
	set @SqOffVal=@SqOffVal-@TSqOffVal   
    
  --set @SqOffVal=@TSqOffVal             
    
  set @Xctr=@Xctr+1                                  
  END                                  
    
  DROP TABLE #holdadj                                  
    
  set @ctr=@ctr+1                                  
  end                                  
    
  drop table #filex                                  
    
  /* update vmss_DP_holding_all_14062016 set AdjAmt=((SqOffQty*clsrate)*(Haircut/100.00)) */             
  update vmss_DP_holding_all_14062016 set AdjAmt=SqOffQty*(clsrate-(clsrate*(haircut/100)))          
    
  /*            
  insert into vmss_DP_holding_all_14062016_hist(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt)              
  select HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt               
  from vmss_DP_holding_all_14062016 where SqOffQty > 0              
  */            
  
  
    
  update vmss_Data_all_14062016 set DP_adj=AdjAmt from               
  (select party_code,sum(AdjAmt) as AdjAmt from vmss_DP_holding_all_14062016 where sqOffQty <> 0 group by party_code) b              
  where vmss_Data_all_14062016.party_code=b.party_code and vmss_Data_all_14062016.processdate=@tdate               
    
  update  vmss_Data_all_14062016 set VarMarginShortFall_AftAdjCurrDay=VarMarginShortFall_AftAdjCurrDay+DP_adj where  DP_adj > 0 and processdate=@tdate              
  update  vmss_Data_all_14062016 set VarMarginShortFall_AftAdjCurrDay=0 where VarMarginShortFall_AftAdjCurrDay > 0 and processdate=@tdate              
    
 End try                                                                 
 BEGIN CATCH                                                                    
  --insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                          
  --select GETDATE(),'VMSS_DPadj_Process',ERROR_LINE(),ERROR_MESSAGE()                               
  --DECLARE @ErrorMessage NVARCHAR(4000);                                                
  --SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                
  --RAISERROR (@ErrorMessage , 16, 1);                      
 End catch                                     
                                            
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_EarlyPayin
-- --------------------------------------------------

CREATE Procedure [dbo].[VMSS_EarlyPayin]    
as    
Set Nocount on    
    
Set nocount on             
BEGIN TRY                            
    
  Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())    
    
  select Sett_No,Sett_type into #BSEUnsett     
  from General.dbo.BO_Sett_Mst where co_code='BSECM' and Sec_payin > @BSElastBillDate     
  and Sett_Type='D' and Start_date <= @BSElastBillDate     
    
  Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())    
  select Sett_No,Sett_type into #NSEUnsett     
  from General.dbo.BO_Sett_Mst where co_code='NSECM' and Sec_payin > @NSElastBillDate     
  and Sett_Type='N' and Start_date <= @NSElastBillDate     
    
  select a.* into #BSEsell     
  from angeldemat.bsedb.dbo.deliveryclt a with (nolock) join #BSEUnsett b     
  on a.sett_no=b.sett_no and a.sett_Type=b.sett_Type where Inout='I'    
    
  select a.* into #NSEsell     
  from angeldemat.msajag.dbo.deliveryclt a with (nolock) join #NSEUnsett b     
  on a.sett_no=b.sett_no and a.sett_Type=b.sett_Type where Inout='I'    
    
  select a.* into #BSEShort     
  from    
  (select * from General.dbo.rms_holding where source='SI') a join #BSEUnsett b on a.sett_no=b.sett_no and a.sett_Type=b.sett_Type    
    
  select a.* into #NSEShort     
  from    
  (select * from General.dbo.rms_holding where source='SI') a join #NSEUnsett b on a.sett_no=b.sett_no and a.sett_Type=b.sett_Type    
    
  truncate table VMSS_EarlyPayinData    
  insert into VMSS_EarlyPayinData(Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,UpdatedOn,qTY,clsrate,total)    
  select 'BSECM' AS EXCHANGE,a.SETT_NO,A.SETT_TYPE,A.SCRIP_CD,A.SERIES,A.PARTY_CODE,GETDATE(),a.Qty+isnull(b.qty,0) as QTY,0,0    
  from #BSEsell a left outer join #BSEshort b on a.party_code=B.party_Code and a.sett_no=b.sett_no and a.sett_Type=b.sett_Type    
  and a.scrip_cd=b.scrip_cd    
    
  insert into VMSS_EarlyPayinData(Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,UpdatedOn,qTY,Clsrate,Total)    
  select 'NSECM' AS EXCHANGE,a.SETT_NO,A.SETT_TYPE,A.SCRIP_CD,A.SERIES,A.PARTY_CODE,GETDATE(),a.Qty+isnull(b.qty,0) as QTY,0,0  
  from #NSEsell a left outer join #NSEshort b on a.party_code=B.party_Code and a.sett_no=b.sett_no and a.sett_Type=b.sett_Type    
  and a.scrip_cd=b.scrip_cd    
    
  update VMSS_EarlyPayinData set clsrate=b.rate from general.dbo.cp_bsecm b   
  where scrip_Cd=b.scode and isnull(VMSS_EarlyPayinData.clsrate,0)=0  and exchange='BSECM'  
   
  update VMSS_EarlyPayinData set clsrate=b.cls   
  from general.dbo.cp_nsecm b where VMSS_EarlyPayinData.scrip_Cd=b.scrip and VMSS_EarlyPayinData.series=b.series and VMSS_EarlyPayinData.clsrate=0 and exchange='NSECM'  
  
 update VMSS_EarlyPayinData set Total=Qty*clsrate  
  
  insert into VMSS_EarlyPayinData_hist(Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,QTY,UpdatedOn,Clsrate,Total)    
  select Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,QTY,UpdatedOn,Clsrate,Total from VMSS_EarlyPayinData    
    
End try                         
BEGIN CATCH                            
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                  
  select GETDATE(),'VMSS_EarlyPayin',ERROR_LINE(),ERROR_MESSAGE()                                  
End catch                        
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_EarlyPayin_NoNRMS
-- --------------------------------------------------
    
CREATE Procedure [dbo].[VMSS_EarlyPayin_NoNRMS]            
as            
Set Nocount on            
            
Set nocount on                     
BEGIN TRY                                    
/*            
  Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted  with (nolock) where Sett_Type='D' and BillDate <= GETDATE())            
            
  select Sett_No,Sett_type into #BSEUnsett             
  from General.dbo.BO_Sett_Mst with (nolock) where co_code='BSECM' and Sec_payin > @BSElastBillDate             
  and Sett_Type='D' and Start_date <= @BSElastBillDate             
            
  Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted with (nolock) where Sett_Type='N' and BillDate <= GETDATE())            
  select Sett_No,Sett_type into #NSEUnsett             
  from General.dbo.BO_Sett_Mst with (nolock) where co_code='NSECM' and Sec_payin > @NSElastBillDate             
  and Sett_Type='N' and Start_date <= @NSElastBillDate             
            
  select a.* into #BSEsell             
  from angeldemat.bsedb.dbo.deliveryclt a with (nolock) join #BSEUnsett b             
  on a.sett_no=b.sett_no and a.sett_Type=b.sett_Type where Inout='I'              
            
  select a.* into #NSEsell             
  from angeldemat.msajag.dbo.deliveryclt a with (nolock) join #NSEUnsett b             
  on a.sett_no=b.sett_no and a.sett_Type=b.sett_Type where Inout='I'            
            
  select a.* into #BSEShort             
  from            
  (select * from vmss_rms_holding where source='SI') a join #BSEUnsett b on a.sett_no=b.sett_no and a.sett_Type=b.sett_Type            
            
  select a.* into #NSEShort             
  from            
  (select * from vmss_rms_holding where source='SI') a join #NSEUnsett b on a.sett_no=b.sett_no and a.sett_Type=b.sett_Type            
            
  truncate table VMSS_EarlyPayinData            
  insert into VMSS_EarlyPayinData(Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,UpdatedOn,qTY,clsrate,total)            
  select 'BSECM' AS EXCHANGE,a.SETT_NO,A.SETT_TYPE,A.SCRIP_CD,A.SERIES,A.PARTY_CODE,GETDATE(),a.Qty+isnull(b.qty,0) as QTY,0,0            
  from #BSEsell a left outer join #BSEshort b on a.party_code=B.party_Code and a.sett_no=b.sett_no and a.sett_Type=b.sett_Type            
  and a.scrip_cd=b.scrip_cd            
            
  insert into VMSS_EarlyPayinData(Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,UpdatedOn,qTY,Clsrate,Total)            
  select 'NSECM' AS EXCHANGE,a.SETT_NO,A.SETT_TYPE,A.SCRIP_CD,A.SERIES,A.PARTY_CODE,GETDATE(),a.Qty+isnull(b.qty,0) as QTY,0,0          
  from #NSEsell a left outer join #NSEshort b on a.party_code=B.party_Code and a.sett_no=b.sett_no and a.sett_Type=b.sett_Type            
  and a.scrip_cd=b.scrip_cd      
      
 /***********************/    
     
 Create table #ExClsRate    
 (    
 co_code varchar(10),    
 Party_code varchar(10),    
 sett_no varchar(10),    
 sett_type varchar(10),    
 Scrip_cd varchar(10),    
 Series varchar(10),    
 Qty int,    
 AvgClsrate money    
 )    
     
 select ROW_NUMBER() OVER ( ORDER BY exchange,sett_no,sett_type) AS [SrNo],     
 exchange,sett_no,sett_type     
 into #SettSeq    
 from VMSS_EarlyPayinData     
 group by exchange,sett_no,sett_type     
     
 declare @ctr int = 1,@totctr int = 0,@sett_no varchar(7)='',@sett_type as varchar(3)='',@exchange as varchar(10) =''    
 select @totctr=max(srno) from #SettSeq    
     
 While @Ctr <= @TotCtr    
 Begin     
 select @sett_no=sett_no,@sett_type=sett_type,@exchange=exchange from #SettSeq where srno=@ctr    
    
 if @exchange='BSECM'    
 Begin      
  insert into #ExClsRate(co_code,Party_code,sett_no,SEtt_type,Scrip_cd,Series,Qty,AvgClsrate)    
  select @exchange,Party_code,sett_no,sett_type,scrip_cd,series='BSE',sum(SQtyDEL) as Qty,(sum(SAMTDEL)/sum(SQtyDEL)) as AvgClsRate      
  from anand.bsedb_ab.dbo.CMBILLVALAN with (nolock)      
  where sett_no=@sett_no and sett_type=@Sett_type and SQtyDel > 0    
  group by Party_code,scrip_cd,sett_no,sett_type    
 End    
    
 /*     
 SAMT-----Net Rate with Brokerage & Trading Expenses    
 SAMTDEL--Net Rate with Brokerage.........applied........    
 SRATE----Market Rate    
 */    
    
 if @exchange='NSECM'    
 Begin      
  insert into #ExClsRate(co_code,Party_code,sett_no,SEtt_type,Scrip_cd,Series,Qty,AvgClsrate)    
  select @exchange,Party_code,sett_no,sett_type,scrip_cd,series,sum(SQtyDEL) as Qty,(sum(SAMTDEL)/sum(SQtyDEL)) as AvgClsRate      
  from anand1.msajag.dbo.CMBILLVALAN  with (nolock)           
  where sett_no=@sett_no and sett_type=@Sett_type and SQtyDel > 0    
  group by Party_code,scrip_cd,series,sett_no,sett_type    
 End    
     
 set @ctr=@ctr+1    
End    
    
/*---- Code for Testing----    
select *,a.qty-isnull(b.qty,0)--,((clsrate-isnull(avgClsRate,0))*100.00)/clsrate    
from VMSS_EarlyPayinData a left outer join #ExClsRate b    
on a.sett_no=b.sett_no and a.sett_type=b.sett_type and a.party_Code=b.party_code and a.exchange=b.co_Code    
and a.scrip_Cd=b.scrip_cd and a.series=b.series    
where a.qty-isnull(b.qty,0) < 0    
and abs(((clsrate-isnull(avgClsRate,0))*100.00)/clsrate) > 10    
*/     
 /*********************************/     
    
update VMSS_EarlyPayinData     
set clsrate=b.avgClsRate from #ExClsRate b    
where    
VMSS_EarlyPayinData.sett_no=b.sett_no and     
VMSS_EarlyPayinData.sett_type=b.sett_type and     
VMSS_EarlyPayinData.party_Code=b.party_code and     
VMSS_EarlyPayinData.exchange=b.co_Code and     
VMSS_EarlyPayinData.scrip_Cd=b.scrip_cd and     
VMSS_EarlyPayinData.series=b.series    
    
  /*          
  update VMSS_EarlyPayinData set clsrate=b.rate from general.dbo.cp_bsecm b           
  where scrip_Cd=b.scode and isnull(VMSS_EarlyPayinData.clsrate,0)=0  and exchange='BSECM'          
           
  update VMSS_EarlyPayinData set clsrate=b.cls           
  from general.dbo.cp_nsecm b where VMSS_EarlyPayinData.scrip_Cd=b.scrip and VMSS_EarlyPayinData.series=b.series and VMSS_EarlyPayinData.clsrate=0 and exchange='NSECM'          
  */        
     
  update VMSS_EarlyPayinData set Total=Qty*clsrate          
          
  insert into VMSS_EarlyPayinData_hist(Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,QTY,UpdatedOn,Clsrate,Total)            
  select Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,QTY,UpdatedOn,Clsrate,Total from VMSS_EarlyPayinData            
*/       
truncate table VMSS_EarlyPayinData      

End try                                 
BEGIN CATCH                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                          
  select GETDATE(),'VMSS_EarlyPayin_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                          
End catch                                
            
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_EarlyPayin_NoNRMS_new
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_EarlyPayin_NoNRMS_new]              
as              
Set Nocount on              
              
Set nocount on                       
BEGIN TRY                                      
              
  Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())              
              
  select Sett_No,Sett_type into #BSEUnsett               
  from General.dbo.BO_Sett_Mst where co_code='BSECM' and Sec_payin > @BSElastBillDate               
  and Sett_Type in ('D','C') and Start_date <= @BSElastBillDate               
              
  Declare @NSElastBillDate datetime = (select MAX(BillDate) from anand1.account.dbo.BillPosted where Sett_Type='N' and BillDate <= GETDATE())              
  select Sett_No,Sett_type into #NSEUnsett               
  from General.dbo.BO_Sett_Mst where co_code='NSECM' and Sec_payin > @NSElastBillDate               
  and Sett_Type in ('N','W') and Start_date <= @NSElastBillDate               
              
  select a.* into #BSEsell               
  from angeldemat.bsedb.dbo.deliveryclt a with (nolock) join #BSEUnsett b               
  on a.sett_no=b.sett_no and a.sett_Type=b.sett_Type where Inout='I'                
              
  select a.* into #NSEsell               
  from angeldemat.msajag.dbo.deliveryclt a with (nolock) join #NSEUnsett b               
  on a.sett_no=b.sett_no and a.sett_Type=b.sett_Type where Inout='I'              

  /* BSECM BTST */

	select a.* into #BSEsell_Buy               
	from angeldemat.bsedb.dbo.deliveryclt a with (nolock) join 
	(
	select * from #BSEUnsett 
	where sett_no = (select min(sett_no) from #BSEunsett where sett_type='D')
	)b               
	on a.sett_no=b.sett_no and a.sett_Type=b.sett_Type where Inout='O'   

	update #bsesell set qty=(case when a.qty-#bsesell.qty > 0 then 0 else -(a.qty-#bsesell.qty) end)
	from #BSEsell_Buy a 
	where a.party_code=#bsesell.party_code
	and a.scrip_cd=#bsesell.scrip_Cd
	and a.series=#bsesell.series
	/* and (case when #bsesell.qty-a.qty > 0 then 0 else -(#bsesell.qty-a.qty) end) > 0 */

	delete from #bsesell where qty=0

  /* NSECM BTST */

	select a.* into #NSEsell_Buy               
	from angeldemat.msajag.dbo.deliveryclt a with (nolock) join 
	(
	select * from #NSEUnsett 
	where sett_no = (select min(sett_no) from #NSEunsett where sett_type='N')
	)b               
	on a.sett_no=b.sett_no and a.sett_Type=b.sett_Type where Inout='O'   

	update #nsesell set qty=(case when a.qty-#nsesell.qty > 0 then 0 else -(a.qty-#nsesell.qty) end)
	from #nSEsell_Buy a 
	where a.party_code=#nsesell.party_code
	and a.scrip_cd=#nsesell.scrip_Cd
	and a.series=#nsesell.series

	delete from #nsesell where qty=0
   
   /* BTST Adj End */

  select a.* into #BSEShort               
  from              
  (select * from vmss_rms_holding where source='SI') a join #BSEUnsett b on a.sett_no=b.sett_no and a.sett_Type=b.sett_Type              
              
  select a.* into #NSEShort               
  from              
  (select * from vmss_rms_holding where source='SI') a join #NSEUnsett b on a.sett_no=b.sett_no and a.sett_Type=b.sett_Type              
              
    
  select 'BSECM' AS EXCHANGE,a.SETT_NO,A.SETT_TYPE,A.SCRIP_CD,A.SERIES,A.PARTY_CODE,GETDATE() as UpdatedOn,    
  a.Qty as SellQty,isnull(b.qty,0) as ShortQty,a.Qty+isnull(b.qty,0) as QTY           
  into #BSE_EPV    
  from #BSEsell a left outer join #BSEshort b on a.party_code=B.party_Code and a.sett_no=b.sett_no and a.sett_Type=b.sett_Type              
  and a.scrip_cd=b.scrip_cd      
    
  select 'NSECM' AS EXCHANGE,a.SETT_NO,A.SETT_TYPE,A.SCRIP_CD,A.SERIES,A.PARTY_CODE,GETDATE() as UpdatedOn,    
  a.Qty as SellQty,isnull(b.qty,0) as ShortQty,a.Qty+isnull(b.qty,0) as QTY     
  into #NSE_EPV     
  from #NSEsell a left outer join #NSEshort b on a.party_code=B.party_Code and a.sett_no=b.sett_no and a.sett_Type=b.sett_Type              
  and a.scrip_cd=b.dummy1 and a.series=b.dummy2    
                 
  select * into #VMSS_EarlyPayinData from VMSS_EarlyPayinData where 1=2    
      
  insert into #VMSS_EarlyPayinData(Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,UpdatedOn,qTY,clsrate,total)    
  select EXCHANGE,SETT_NO,SETT_TYPE,SCRIP_CD,SERIES,PARTY_CODE,UpdatedOn,QTY,0,0 from #BSE_EPV  where Qty > 0            
  /*    
  select 'BSECM' AS EXCHANGE,a.SETT_NO,A.SETT_TYPE,A.SCRIP_CD,A.SERIES,A.PARTY_CODE,GETDATE(),a.Qty+isnull(b.qty,0) as QTY,0,0              
  from #BSEsell a left outer join #BSEshort b on a.party_code=B.party_Code and a.sett_no=b.sett_no and a.sett_Type=b.sett_Type              
  and a.scrip_cd=b.scrip_cd              
  */    
      
  insert into #VMSS_EarlyPayinData(Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,UpdatedOn,qTY,Clsrate,Total)              
  select EXCHANGE,SETT_NO,SETT_TYPE,SCRIP_CD,SERIES,PARTY_CODE,UpdatedOn,QTY,0,0 from #NSE_EPV where Qty > 0    
  /*    
  select 'NSECM' AS EXCHANGE,a.SETT_NO,A.SETT_TYPE,A.SCRIP_CD,A.SERIES,A.PARTY_CODE,GETDATE(),a.Qty+isnull(b.qty,0) as QTY,0,0            
  from #NSEsell a left outer join #NSEshort b on a.party_code=B.party_Code and a.sett_no=b.sett_no and a.sett_Type=b.sett_Type              
  and a.scrip_cd=b.scrip_cd        
  */      
        
        
 /***********************/      
       
 Create table #ExClsRate      
 (      
 co_code varchar(10),      
 Party_code varchar(10),      
 sett_no varchar(10),      
 sett_type varchar(10),      
 Scrip_cd varchar(10),      
 Series varchar(10),      
 Qty int,      
 AvgClsrate money      
 )      
    
Create Table #DPEPV    
(    
EXCHANGE varchar(10),    
SETT_NO  varchar(10),    
SETT_TYPE  varchar(2),    
SCRIP_CD  varchar(10),    
SERIES  varchar(10),    
PARTY_CODE  varchar(10),    
UpdatedOn datetime,    
SellQty int,    
ShortQty int,    
QTY int,    
holding int,    
EP_Qty int    
)    
       
 select ROW_NUMBER() OVER ( ORDER BY exchange,sett_no,sett_type) AS [SrNo],       
 exchange,sett_no,sett_type       
 into #SettSeq      
 from #VMSS_EarlyPayinData       
 group by exchange,sett_no,sett_type       
   
 select * into #VMSS_DP_Holding from VMSS_DP_Holding  
       
 declare @ctr int = 1,@totctr int = 0,@sett_no varchar(7)='',@sett_type as varchar(3)='',@exchange as varchar(10) =''      
 select @totctr=max(srno) from #SettSeq      
       
 While @Ctr <= @TotCtr      
 Begin       
 select @sett_no=sett_no,@sett_type=sett_type,@exchange=exchange from #SettSeq where srno=@ctr      
      
 if @exchange='BSECM'      
 Begin        
 insert into #ExClsRate(co_code,Party_code,sett_no,SEtt_type,Scrip_cd,Series,Qty,AvgClsrate)      
 select @exchange,Party_code,sett_no,sett_type,scrip_cd,series='BSE',sum(SQtyDEL) as Qty,(sum(SAMTDEL)/sum(SQtyDEL)) as AvgClsRate        
 from anand.bsedb_ab.dbo.CMBILLVALAN        
 where sett_no=@sett_no and sett_type=@Sett_type and SQtyDel > 0      
 group by Party_code,scrip_cd,sett_no,sett_type      
    
 insert into #DPEPV(EXCHANGE,SETT_NO,SETT_TYPE,SCRIP_CD,SERIES,PARTY_CODE,UpdatedOn,SellQty,ShortQty,QTY,holding,EP_Qty)    
 select a.*,b.holding,EP_Qty=(Case when ShortQty+ISNULL(b.holding,0) >= 0 then -ShortQty else ISNULL(b.holding,0) end)     
 from     
 (select * from #BSE_EPV where ShortQty<0 and sett_no=@sett_no and sett_type=@Sett_type) a left outer join    
 (select party_code,bsecode,holding from #VMSS_DP_Holding) b    
 on a.party_code=b.party_Code and a.scrip_Cd=b.bsecode    
 where (Case when ShortQty+ISNULL(b.holding,0) >= 0 then -ShortQty else ISNULL(b.holding,0) end)  > 0    
    
 update #VMSS_DP_Holding set #VMSS_DP_Holding.holding=#VMSS_DP_Holding.holding-b.EP_qty from     
 (select * from #DPEPV where sett_no=@sett_no and sett_type=@Sett_type) b     
    where #VMSS_DP_Holding.Party_code=b.PARTY_CODE and #VMSS_DP_Holding.bsecode=b.SCRIP_CD    
        
 End      
      
 /*       
 SAMT-----Net Rate with Brokerage & Trading Expenses      
 SAMTDEL--Net Rate with Brokerage.........applied........      
 SRATE----Market Rate      
 */      
      
 if @exchange='NSECM'      
 Begin        
 insert into #ExClsRate(co_code,Party_code,sett_no,SEtt_type,Scrip_cd,Series,Qty,AvgClsrate)      
 select @exchange,Party_code,sett_no,sett_type,scrip_cd,series,sum(SQtyDEL) as Qty,(sum(SAMTDEL)/sum(SQtyDEL)) as AvgClsRate        
 from anand1.msajag.dbo.CMBILLVALAN        
 where sett_no=@sett_no and sett_type=@Sett_type and SQtyDel > 0      
 group by Party_code,scrip_cd,series,sett_no,sett_type      
    
 insert into #DPEPV(EXCHANGE,SETT_NO,SETT_TYPE,SCRIP_CD,SERIES,PARTY_CODE,UpdatedOn,SellQty,ShortQty,QTY,holding,EP_Qty)    
 select a.*,b.holding,EP_Qty=(Case when ShortQty+ISNULL(b.holding,0) >= 0 then -ShortQty else ISNULL(b.holding,0) end)     
 from     
 (select * from #NSE_EPV where ShortQty<0 and sett_no=@sett_no and sett_type=@Sett_type) a left outer join    
 (select party_code,nsesymbol,nseseries,holding from #VMSS_DP_Holding) b    
 on a.party_code=b.party_Code and a.scrip_Cd=b.nsesymbol and a.series=b.nseseries    
 where (Case when ShortQty+ISNULL(b.holding,0) >= 0 then -ShortQty else ISNULL(b.holding,0) end)  > 0    
    
 update #VMSS_DP_Holding set #VMSS_DP_Holding.holding=#VMSS_DP_Holding.holding-b.EP_qty from     
 (select * from #DPEPV where sett_no=@sett_no and sett_type=@Sett_type) b     
    where #VMSS_DP_Holding.Party_code=b.PARTY_CODE and #VMSS_DP_Holding.nsesymbol=b.SCRIP_CD and #VMSS_DP_Holding.nseseries=b.SERIES    
     
 End      
       
 set @ctr=@ctr+1      
End      
    
 /*---- Code for Testing----      
 select *,a.qty-isnull(b.qty,0)--,((clsrate-isnull(avgClsRate,0))*100.00)/clsrate      
 from VMSS_EarlyPayinData a left outer join #ExClsRate b      
 on a.sett_no=b.sett_no and a.sett_type=b.sett_type and a.party_Code=b.party_code and a.exchange=b.co_Code      
 and a.scrip_Cd=b.scrip_cd and a.series=b.series      
 where a.qty-isnull(b.qty,0) < 0      
 and abs(((clsrate-isnull(avgClsRate,0))*100.00)/clsrate) > 10      
 */       
 /*********************************/       
    
 insert into #VMSS_EarlyPayinData(Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,UpdatedOn,qTY,Clsrate,Total)              
 select EXCHANGE,SETT_NO,SETT_TYPE,SCRIP_CD,SERIES,PARTY_CODE,UpdatedOn,EP_QTY as QTY,0,0 from #DPEPV where EP_Qty > 0    
    
 select * into #VMSS_EarlyPayinData1 from #VMSS_EarlyPayinData where 1=2    
     
 insert into #VMSS_EarlyPayinData1(Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,UpdatedOn,QTY,Clsrate,Total)    
 select Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,getdate() as UpdatedOn,sum(QTY) as Qty,0.00 as Clsrate,0.00 as Total     
 from #VMSS_EarlyPayinData     
 group by Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code    
    
 update #VMSS_EarlyPayinData1       
 set clsrate=b.avgClsRate from #ExClsRate b      
 where      
 #VMSS_EarlyPayinData1.sett_no=b.sett_no and       
 #VMSS_EarlyPayinData1.sett_type=b.sett_type and       
 #VMSS_EarlyPayinData1.party_Code=b.party_code and       
 #VMSS_EarlyPayinData1.exchange=b.co_Code and       
 #VMSS_EarlyPayinData1.scrip_Cd=b.scrip_cd and       
 #VMSS_EarlyPayinData1.series=b.series      
    
 update #VMSS_EarlyPayinData1 set Total=Qty*clsrate            
   
 delete from #VMSS_DP_Holding where holding=0    
 update #VMSS_DP_Holding set VBHC=isnull(Clsrate,0)*holding      
 update #VMSS_DP_Holding set VAHC=VBHC*((100-HAIRCUT)/100.00),SqOffQty=0,SqOffSeq=0        
   
 /* ---Till here for testing ---*/  
    
 truncate table VMSS_EarlyPayinData              
 insert into VMSS_EarlyPayinData(Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,UpdatedOn,QTY,Clsrate,Total)     
 select Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,UpdatedOn,QTY,Clsrate,Total from #VMSS_EarlyPayinData1              
         
 insert into VMSS_EarlyPayinData_hist(Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,QTY,UpdatedOn,Clsrate,Total)              
 select Exchange,Sett_No,SEtt_type,Scrip_cd,series,Party_Code,QTY,UpdatedOn,Clsrate,Total from VMSS_EarlyPayinData              
    
   
 Truncate table VMSS_DP_Holding  
 insert into VMSS_DP_Holding select * from #VMSS_DP_Holding  
  
 drop table   #VMSS_EarlyPayinData1            
 drop table   #VMSS_EarlyPayinData    
 drop table   #DPEPV    
 drop table   #NSE_EPV    
 drop table   #BSE_EPV    
 drop table   #BSEUnsett    
 drop table   #NSEUnsett              
 drop table   #NSEsell    
 drop table   #BSEsell    
 drop table   #NSEshort    
 drop table   #BSEshort    
 drop table   #VMSS_DP_Holding  
              
End try                                   
BEGIN CATCH                                      
  insert into GENERAL.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                            
  select GETDATE(),'VMSS_EarlyPayin_NoNRMS',ERROR_LINE(),ERROR_MESSAGE()                                            
End catch                                  
              
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Hold_process_step1
-- --------------------------------------------------

CREATE procedure [dbo].[VMSS_Hold_process_step1]                    
as                    
                    
set transaction isolation level read UNCOMMITTED                    
set nocount on                    
begin try                    
                    
declare @dt datetime, @Maindt datetime                    
set @Maindt = GETDATE()                    
                    
/* 03:17 SEcs */                    
                    
 IF OBJECT_ID(N'Tmp_RMS_Holding') IS NOT NULL                    
 DROP TABLE Tmp_RMS_Holding                    
                    
 select isin,scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,                    
 aben,apool,nben,npool,approved,scripname,partyname,pool,total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty                    
 into Tmp_RMS_Holding from vmss_rms_holding WITH(NOLOCK) where 1=2                   
                    
 ----------------- update BO delivery file /* 00:01 Secs */                    
 insert into Tmp_RMS_Holding (sett_no,sett_type,scrip_Cd,series,party_code,accno,dpid,clid,bs,qty,aben,apool,npool,nben,exchange,clsrate,flag,source,nse_approved)                    
 SELECT sett_no,sett_type,scrip_cd,series,party_code,'Unsettled','','',(case when inout='O' then 'B' else 'S' end),                    
 (case when inout ='O' then qty else -qty end),0,0,0,0,CO_CODE,0,'','D','Poor' FROM General.dbo.BO_deliveryclt WITH(NOLOCK) WHERE INOUT='O'                    
                    
 ----------------- update BO holding file /* 00:32 Secs */                    
 insert into Tmp_RMS_Holding (sett_no,sett_type,scrip_Cd,series,party_code,accno,dpid,clid,bs,qty,aben,apool,npool,nben,exchange,clsrate,flag,source,nse_approved)                    
 SELECT sett_no,sett_type,scrip_cd,series,party_code,CltDpid,'','','B',holdqty,0,0,0,0,CO_CODE,0,'','H','Poor' FROM General.dbo.BO_holding WITH(NOLOCK) where holdqty > 0                    
 UNION ALL                    
 SELECT sett_no,sett_type,scrip_cd,series,party_code,CltDpid,'','','B',pledgeqty,0,0,0,0,CO_CODE,0,'P','H','Poor' from General.dbo.BO_holding WITH(NOLOCK) where pledgeqty > 0                    
                    
 -------------------- BO Shortage file /*  00:00 Secs */                    
 insert into Tmp_RMS_Holding (sett_no,sett_type,scrip_Cd,series,party_code,isin,accno,dpid,clid,bs,qty,aben,apool,npool,nben,exchange,clsrate,flag,source,nse_approved)                    
 SELECT sett_no,srtt_type,scrip_cd,series,party_code,isnull(ISIN,''),'','','','S',delqty-recqty-isettqty-ibenqty,0,0,0,0,co_code,0,'','SI','Poor'                    
 FROM General.dbo.BO_Shortage WITH(NOLOCK) where delqty-recqty-isettqty-ibenqty > 0                    
                    
 ------------------- Payout Shortage /*  00.00 Secs */                    
 insert into Tmp_RMS_Holding (sett_no,sett_type,scrip_Cd,series,party_code,isin,accno,dpid,clid,bs,qty,aben,apool,npool,nben,exchange,clsrate,flag,source,nse_approved)                    
 SELECT distinct sett_no,sett_type,scrip_cd,Series,party_code,'','','','','B',BuyShortage,0,0,0,0,co_code,0,'','SO','Poor'                    
 FROM General.dbo.BO_Shrt WITH(NOLOCK) where BuyShortage <> 0                    
                    
 ------------------- update CDSL POA /* 01:17 Secs */                    
 insert into Tmp_RMS_Holding (sett_no,sett_type,scrip_Cd,series,party_code,isin,accno,dpid,clid,bs,qty,aben,apool,npool,nben,exchange,clsrate,flag,source,nse_approved)                    
 select settno='CDSL-POA',sett_type='',scode=isnull(bseCode,nsesymbol),sname='',pcode=party_code,isnull(isin,''),cdsl_id=cltdpid,dpid=substring(cltdpid,1,8),                    
 substring(cltdpid,9,8),bs='B',free_holding=holding,0,0,0,0,'POA',0,poa='Y','DP','Poor'                     
 from vmss_DP_Holding WITH(NOLOCK)                     
                    
 CREATE NONCLUSTERED INDEX idx_pty on Tmp_RMS_Holding(exchange, party_Code, scrip_cd)                
                     
 /* update client collaterals ---- 00:01 secs */                    
 SELECT B.DPID AS accountid,party_Code,isin,SCRIP_CD,SERIES,qty=sum(qty)                    
 INTO #en_holdx                    
FROM General.dbo.CLIENT_COLLATERALS A WITH (NOLOCK) JOIN                    
 (SELECT DPID,CO_CODE FROM General.dbo.COLLATERAL_DP WITH (NOLOCK) WHERE ACTIVE_TILL >= GETDATE() AND ACCTYPE ='COLLATERAL_MAP') B                    
 ON A.CO_CODE=B.CO_CODE AND Qty <> 0                    
 group by B.DPID,party_Code,SCRIP_CD,SERIES,isin                    
                    
 SELECT B.DPID AS accountid,party_Code,isin,qty=sum(qty)                    
 INTO #en_hold                    
 FROM General.dbo.CLIENT_COLLATERALS A WITH (NOLOCK) JOIN                    
 (SELECT DPID,CO_CODE FROM General.dbo.COLLATERAL_DP WITH (NOLOCK) WHERE ACTIVE_TILL >= GETDATE() AND ACCTYPE ='COLLATERAL_MAP') B                    
 ON A.CO_CODE=B.CO_CODE AND Qty <> 0                    
 group by B.DPID,party_Code,isin                    
                    
 /* update power pledge ----00:07 secs  */                    
 select ACCOUNTID,DPCLCODE,SCRIP_CD,SERIES,DPSCCODE,DPREF5,QTY,co_Code into #pp_holdx from General.dbo.pp_holdx with (nolock)                    
                    
 select ACCOUNTID,DPCLCODE,DPREF5,QTY=sum(QTY)                    
 into #pp_hold from General.dbo.pp_holdx with (nolock)                    
 group by ACCOUNTID,DPCLCODE,DPREF5                    
                    
 SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED                    
 select a.ACCOUNTID,DPCLCODE,DPSCCODE=space(12),DPREF5,QTY = sum(a.qty-isnull(b.qty,0)),DPSeries=space(10)                    
 into #pp_finhold                    
 from #pp_hold a full outer join #en_hold b on a.DPCLCODE=b.party_code and a.DPREF5=b.isin                    
 and case when a.ACCOUNTID = '15464303' then '16921197' else a.ACCOUNTID end = b.ACCOUNTID                    
 where isnull(a.qty,0)-isnull(b.qty,0) > 0                    
 group by a.ACCOUNTID,DPCLCODE,DPREF5                    
                    
 update #pp_finhold set DPSCCODE = #en_holdx.SCRIP_CD, DPSeries = #en_holdx.SERIES                    
 from #en_holdx                    
 where #pp_finhold.DPREF5 = #en_holdx.isin                    
                    
 update #pp_finhold set DPSCCODE = #pp_holdx.SCRIP_CD, DPSeries = #pp_holdx.SERIES                    
 from #pp_holdx                    
 where #pp_finhold.DPREF5 = #pp_holdx.DPREF5                    
 and #pp_finhold.DPSCCODE = ''                    
                    
 delete a                    
 from Tmp_RMS_Holding a                    
 join (select dpid from General.dbo.collateral_dp with (nolock) where active_till > GETDATE()) b                    
 on a.accno = b.dpid                    
 and (a.exchange <> 'BSECM1' AND a.exchange <> 'NSECM1')                    
                    
 insert into Tmp_RMS_Holding (sett_no,sett_type,scrip_Cd,series,party_code,isin,accno,dpid,clid,bs,qty,aben,apool,npool,nben,exchange,clsrate,flag)                    
 SELECT settno='2000000',sett_type='W',scode=DPSCCODE,sname=DPSeries,pcode=DPCLCODE,DPREF5,accno=ACCOUNTID,                    
 dpid='',clid='',bs='B',QTY,0,0,0,0,                    
 segment=case                    
 when accountid='1203320004025849' then 'NSECM'                    
 when accountid='1203320000026363' then 'NSECM'                    
 when accountid='1203320004574264' then 'NSECM'                    
 when accountid='11198145' then 'NSECM'                    
 when accountid='11198647' then 'NSECM'                    
 when accountid='15464303' then 'NSECM'                    
 when accountid='16921197' then 'NSECM'                    
 when accountid='34621422' then 'MCD'                    
 when accountid='34621439' then 'NSX'                    
 else '' end,                    
 0,status=''                    
 from #pp_finhold                    
                    
 ---------------------- FINAL PROCESS /* 00:11 secs */                    
 UPDATE Tmp_RMS_Holding SET QTY = QTY*-1 WHERE BS='S'                    
                    
 update Tmp_RMS_Holding set dummy1 = scrip_cd                    
 where isnumeric(scrip_cd)<>1                    
 and exchange in (select co_code from General.dbo.company with(nolock)                    
 where segment='CAPITAL' and exchange='NSE' union all select 'BSECM1')                    
                    
 /* -- 00:06 secs */                    
 update Tmp_RMS_Holding set dummy2 = series                    
 where isnumeric(scrip_cd)<>1                    
 and exchange in (select co_code from General.dbo.company with(nolock)                    
 where segment='CAPITAL' and exchange='NSE'                    
 union all select 'BSECM1')                    
                    
 /* 00:05 secs */                    
 --update Tmp_RMS_Holding set isin = '' where isin is null                    
                    
 /* 00:00 secs */                    
 update Tmp_RMS_Holding set isin=b.isin,                    
 scrip_Cd=case when (ltrim(rtrim(b.bsecode)) <> '' and b.bsecode is not null) then b.bsecode else scrip_Cd end                    
 from General.dbo.scrip_master b WITH(NOLOCK)                    
 where Tmp_RMS_Holding.dummy1 = b.nsesymbol and isnull(Tmp_RMS_Holding.isin,'')='' and isnull(Tmp_RMS_Holding.scrip_Cd,'')=''                    
                    
 /* 00:09 secs */                    
 update Tmp_RMS_Holding set isin=b.isin from General.dbo.scrip_master b WITH(NOLOCK)                    
 where Tmp_RMS_Holding.dummy1 = b.nsesymbol and isnull(Tmp_RMS_Holding.isin,'')=''                    
 and Tmp_RMS_Holding.dummy2 = b.nseseries and Tmp_RMS_Holding.dummy2<>''                    
                    
 /* 00:14 secs */                    
 update Tmp_RMS_Holding set isin=b.isin from General.dbo.scrip_master b WITH(NOLOCK)                    
 where Tmp_RMS_Holding.scrip_Cd= b.bsecode and isnull(Tmp_RMS_Holding.isin,'')=''                    
 and isnull(Tmp_RMS_Holding.scrip_Cd,'') <> ''                    
                    
 /* 00:01 secs */                    
 update Tmp_RMS_Holding set isin=b.isin from General.dbo.scrip_master b WITH(NOLOCK)                    
 where Tmp_RMS_Holding.dummy1 = b.nsesymbol and isnull(Tmp_RMS_Holding.isin,'')=''                    
                    
 /* 00:18 secs */                    
 update Tmp_RMS_Holding                    
 set scrip_cd = b.bsecode                    
 from General.dbo.scrip_master b WITH(NOLOCK),                    
 (select co_code from General.dbo.company WITH(NOLOCK) where segment='CAPITAL' and exchange='NSE' union all select 'BSECM1') c                    
 where Tmp_RMS_Holding.exchange=c.co_code and                    
 Tmp_RMS_Holding.dummy1=b.nsesymbol                    
 and Tmp_RMS_Holding.dummy2=b.nseseries                    
 and ltrim(rtrim(isnull(b.bsecode,''))) <> '' --and b.bsecode IS NOT NULL                    
                    
 /* 00:02 secs */                    
 UPDATE Tmp_RMS_Holding                    
 SET SCRIP_CD = B.BSECODE                    
 FROM General.dbo.SCRIP_MASTER B WITH(NOLOCK)                    
 WHERE Tmp_RMS_Holding.ISIN=B.ISIN AND ISNUMERIC(SCRIP_CD)=0 AND ISNULL(DUMMY1,'') <> ''                    
 and ltrim(rtrim(isnull(b.bsecode,''))) <> '' --and b.bsecode IS NOT NULL                    
                    
 --------------- POA Adjustment completed                    
 /* 00:00 SECS */                    
 UPDATE Tmp_RMS_Holding                    
 SET approved = s.bseapproved                    
 FROM General.dbo.scrip_master s WITH(NOLOCK)                    
 WHERE Tmp_RMS_Holding.SCRIP_CD = s.bsecode                    
 and isnull(bseapproved,'')='Y'                    
                    
 /* 00:00 SECS */                    
 UPDATE Tmp_RMS_Holding                    
 SET approved = s.bseapproved                    
 FROM General.dbo.scrip_master s WITH(NOLOCK)                    
 WHERE Tmp_RMS_Holding.dummy1 = s.nsesymbol and Tmp_RMS_Holding.dummy2 = s.nseseries                    
 and isnull(nseapproved,'')='Y'                    
                    
 /* 01:04 secs */                    
 UPDATE Tmp_RMS_Holding                    
 SET scripname = s.scripname from                    
 General.dbo.scrip_master s WITH (NOLOCK)                     
 where Tmp_RMS_Holding.isin=s.isin                    
 and isnull(s.scripname,'')<>''                    
                    
 /* 00:01 secs */                    
 UPDATE Tmp_RMS_Holding SET scripname = scrip_cd where isnull(Tmp_RMS_Holding.scripname,'') = ''                    
                    
 /* 00:45 secs */                    
 UPDATE Tmp_RMS_Holding SET CLSRATE = s.RATE FROM                    
 (SELECT SCODE,RATE FROM General.dbo.cp_bsecm WITH(NOLOCK)) s                    
 WHERE Tmp_RMS_Holding.SCRIP_CD = s.SCODE                    
                    
 /***********************BEGIN********************/                    
 /*Altered By Prashant On 25 Aug 2011*/                    
 /*UPDATING DUMMY1 COLUMN WITH NSECODE IN CASE OF INTER SEGMENT ADJUSTMENT*/ /* 00:01 secs */                    
 SELECT DISTINCT ISIN                    
 INTO #I                    
 FROM Tmp_RMS_Holding                    
 WHERE REPLACE(EXCHANGE,'1','') = 'NSECM' AND DUMMY1 IS NULL                    
                    
 UPDATE Tmp_RMS_Holding                    
 SET DUMMY1 = NSESYMBOL,                    
 DUMMY2 = NSESERIES                    
 FROM                    
 (                    
  SELECT ISIN,NSESYMBOL,NSESERIES                    
  FROM General.dbo.SCRIP_MASTER WITH(NOLOCK)                    
  WHERE ISIN IN (SELECT isin FROM #I) AND NSESYMBOL IS NOT NULL                    
 ) B                    
 WHERE Tmp_RMS_Holding.ISIN = B.ISIN                     
 AND Tmp_RMS_Holding.DUMMY1 IS NULL                     
 AND REPLACE(EXCHANGE,'1','') = 'NSECM'                    
                    
 DROP TABLE #I                    
                    
 /***********************END********************/ /* 00:09 secs */                    
 UPDATE Tmp_RMS_Holding SET CLSRATE = B.CLS FROM                    
 (select distinct scrip_cd=(rTRIM(LTRIM(scrip))),series, cls from General.dbo.cp_nsecm WITH(NOLOCK)) b                    
 where Tmp_RMS_Holding.dummy1 = b.scrip_CD and                    
 case when Tmp_RMS_Holding.series = 'BE' THEN 'EQ' ELSE Tmp_RMS_Holding.series END=case when b.series = 'BE' THEN 'EQ' ELSE b.series END AND                    
 Tmp_RMS_Holding.dummy1 IS NOT NULL AND                    
 replace(exchange,'1','') in (select co_code from General.dbo.company WITH(NOLOCK) where exchange='NSE')                    
 -----------------------------------                    
 /* 01:46 secs -- check - Not required */                    
 /* UPDATE Tmp_RMS_Holding SET partyname = cl.party_name from finmast cl WITH(NOLOCK) where Tmp_RMS_Holding.party_Code=cl.party_Code */                    
                    
 /* 00:41 secs */                    
 UPDATE Tmp_RMS_Holding SET                    
 apool = (case when isnull(approved,'N')='Y' and isnull(pool,'')='P' then clsrate*qty else 0 end),                    
 npool = (case when isnull(approved,'N')<>'Y' and isnull(pool,'')='P' then clsrate*qty else 0 end),                    
 aben = (case when isnull(approved,'N')='Y' and isnull(pool,'')<>'P' then clsrate*qty else 0 end),                    
 nben = (case when isnull(approved,'N')<>'Y' and isnull(pool,'')<>'P' then clsrate*qty else 0 end),                    
 total = clsrate*qty                    
                    
 /* 01:09 secs */                
 /*                    
 select distinct * into #holding from Tmp_RMS_Holding                    
 TRUNCATE TABLE Tmp_RMS_Holding                     
 INSERT INTO Tmp_RMS_Holding SELECT * FROM #holding                    
 DROP TABLE #holding                    
 */                    
                    
 /*#######################*/                    
 --Added By Prashant On Mar 25 2011 For Performance ---- 00:15 secs */                    
                    
 IF EXISTS(SELECT name FROM sys.indexes WHERE name='IDX_PTY' AND object_id = OBJECT_ID('Tmp_RMS_Holding'))                    
 DROP INDEX IDX_PTY ON [dbo].Tmp_RMS_Holding                    
                    
 CREATE CLUSTERED INDEX [IX_Holding] ON Tmp_RMS_Holding                    
 (                    
 party_code ASC,                    
 isin ASC                    
 )WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF) ON [PRIMARY]                    
 /*#######################*/                    
                    
 ---------------------------------------------ADDED FOR CROSS SEGMENT------------------------------------------------------                    
 /* 00:01 secs */                    
 CREATE TABLE #TEMP(                    
 id int IDENTITY(1,1),                    
 [isin] [varchar](20),[scrip_cd] [varchar](15),[series] [varchar](25),[sett_no] [varchar](10),                    
 [sett_type] [varchar](5),[party_Code] [varchar](10),[bs] [varchar](1),[exchange] [varchar](10),                    
 [qty] [float],[clsrate] [money] NULL,[accno] [varchar](20),[dpid] [varchar](20),[clid] [varchar](20),                    
 [flag] [varchar](10),[aben] [money] NULL,[apool] [money] NULL,[nben] [money] NULL,[npool] [money] NULL,                    
 [approved] [varchar](10),[scripname] [varchar](50),[partyname] [varchar](100),[pool] [varchar](10),                    
 [total] [money] NULL,[DUMMY1] [varchar](50),[DUMMY2] [varchar](50),[nse_approved] [varchar](10),                    
 [source] [varchar](2),[upd_date] [datetime],[Adjqty] [float] DEFAULT 0,[Total_Available] [float] DEFAULT 0                    
 )                    
                    
 insert into #TEMP(                    
 [isin] ,[scrip_cd] ,[series] ,[sett_no] ,[sett_type] ,[party_Code] ,[bs] ,[exchange] ,[qty] ,[clsrate] ,                    
 [accno] ,[dpid] ,[clid] ,[flag] ,[aben],[apool],[nben],[npool],[approved],[scripname],[partyname] ,                    
 [pool],[total],[DUMMY1],[DUMMY2],[nse_approved],[source],[upd_date] )                    
 SELECT [isin] ,[scrip_cd] ,[series] ,[sett_no] ,[sett_type] ,[party_Code] ,[bs] ,[exchange] ,[qty] ,[clsrate] ,                    
 [accno] ,[dpid] ,[clid] ,[flag] ,[aben],[apool],[nben],[npool],[approved],[scripname],[partyname] ,                    
 [pool],[total],[DUMMY1],[DUMMY2],[nse_approved],[source],[upd_date] from Tmp_RMS_Holding where qty < 0                    
                    
 /* 00:01 secs */                    
 UPDATE #TEMP SET [Total_Available]=B.qty FROM (                    
 select isin, party_code, sum(qty) qty from Tmp_RMS_Holding                    
 where isin <> '' and qty > 0 group by isin, party_code) B                    
 WHERE B.isin=#TEMP.ISIN and B.party_code=#TEMP.party_code                    
                    
 /*####################### 01:01 secs */                    
 --Added By Prashant On Mar 25 2011 For Performance                    
 CREATE CLUSTERED INDEX [IX_id] ON #TEMP                    
 ([id] ASC)WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF) ON [PRIMARY]                    
                    
 DECLARE @ROW_COUNTS as INT, @ID as INT, @IDNO as INT                    
 DECLARE @QTY as FLOAT, @Total_Available as FLOAT,@Adjqty as FLOAT                    
 DECLARE @ISIN as VARCHAR(50), @CLIENT as VARCHAR(50)                    
                    
 select @ROW_COUNTS = COUNT(*) from #TEMP                    
 set @IDNO = 1                    
 while @ROW_COUNTS >= @IDNO                    
 begin                    
                    
  SELECT @ID = ID ,@ISIN = ISIN , @QTY = QTY, @CLIENT = [party_Code],@Total_Available=Total_Available,                    
  @Adjqty=Adjqty                    
  FROM #TEMP WHERE ID = @idno                    
                    
  IF @Total_Available > 0                    
  BEGIN                    
   CREATE TABLE #TEMPINNER                     
   (                    
    id int IDENTITY(1,1),                    
    [isin] [varchar](20),[scrip_cd] [varchar](15),[series] [varchar](25),[sett_no] [varchar](10),                    
    [sett_type] [varchar](5),[party_Code] [varchar](10),[bs] [varchar](1),[exchange] [varchar](10),                    
    [qty] [float],[clsrate] [money] NULL,[accno] [varchar](20),[dpid] [varchar](20),[clid] [varchar](20),                    
    [flag] [varchar](10),[aben] [money] NULL,[apool] [money] NULL,[nben] [money] NULL,[npool] [money] NULL,                    
    [approved] [varchar](10),[scripname] [varchar](50),[partyname] [varchar](100),[pool] [varchar](10),                    
    [total] [money] NULL,[DUMMY1] [varchar](50),[DUMMY2] [varchar](50),[nse_approved] [varchar](10),                    
    [source] [varchar](2),[upd_date] [datetime],[Adjqty] [float] DEFAULT 0                    
   )                    
                    
   insert into #TEMPINNER (                    
   [isin] ,[scrip_cd] ,[series] ,[sett_no] ,[sett_type] ,[party_Code] ,[bs] ,[exchange] ,[qty] ,[clsrate] ,                    
   [accno] ,[dpid] ,[clid] ,[flag] ,[aben],[apool],[nben],[npool],[approved],[scripname],[partyname] ,                    
   [pool],[total],[DUMMY1],[DUMMY2],[nse_approved],[source],[upd_date],adjQty)                    
   SELECT [isin] ,[scrip_cd] ,[series] ,[sett_no] ,[sett_type] ,[party_Code] ,[bs] ,[exchange] ,[qty] ,[clsrate] ,                    
   [accno] ,[dpid] ,[clid] ,[flag] ,[aben],[apool],[nben],[npool],[approved],[scripname],[partyname] ,                    
   [pool],[total],[DUMMY1],[DUMMY2],[nse_approved],[source],[upd_date], isnull(adjQty, 0) from Tmp_RMS_Holding                    
   where isin= @ISIN                     
   and party_code= @CLIENT                     
   and [exchange]<>'POA'                     
   AND qty > 0                    
               /*#######################*/         
   --Added By Prashant On Mar 25 2011 For Performance                    
   CREATE CLUSTERED INDEX [IX_id_inner] ON #TEMPINNER                    
   (                    
   [id] ASC                    
   )WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF) ON [PRIMARY]                    
   /*#######################*/                    
                    
   DECLARE @IN_ROW_COUNTS as INT, @IN_ID as INT, @IN_IDNO as INT                    
   DECLARE @IN_QTY as FLOAT, @IN_Total_Available as FLOAT,@IN_Adjqty as FLOAT                    
   DECLARE @IN_ISIN as VARCHAR(50), @IN_CLIENT as VARCHAR(50)                    
                    
   select @IN_ROW_COUNTS = COUNT(*) from #TEMPINNER                    
   set @IN_IDNO = 1                    
   while @IN_ROW_COUNTS >= @IN_IDNO                    
   begin                    
    SELECT @IN_ID = ID ,@IN_ISIN = ISIN , @IN_QTY = QTY, @IN_CLIENT = [party_Code],                    
    @IN_Adjqty=Adjqty                    
    FROM #TEMPINNER WHERE ID = @IN_idno                    
                    
    if (@IN_QTY + @IN_Adjqty > 0)                    
    begin                    
     IF (@IN_QTY + @IN_Adjqty) > ((@QTY+@Adjqty)*-1)                    
      SET @IN_Adjqty=((@QTY+@Adjqty)*-1)                    
     ELSE                    
      SET @IN_Adjqty=@IN_QTY + @IN_Adjqty                    
                    
     set @Adjqty = @Adjqty + @IN_Adjqty                    
     UPDATE #TEMP SET Adjqty=Adjqty+@IN_Adjqty where ID = @IDNO                    
     UPDATE #TEMP SET Total_Available=Total_Available-@IN_Adjqty where [party_Code]=@CLIENT and ISIN=@ISIN                    
     UPDATE #TEMPINNER SET Adjqty=Adjqty+(@IN_Adjqty*-1) where ID=@IN_IDNO                    
    end                    
                    
    SET @IN_IDNO = @IN_IDNO + 1                    
   end                    
                    
   delete from Tmp_RMS_Holding                    
   where isin= @ISIN                     
   and party_code= @CLIENT                     
   AND qty > 0                     
   and [exchange]<>'POA'                    
                    
   insert into Tmp_RMS_Holding                    
   SELECT [isin] ,[scrip_cd] ,[series] ,[sett_no] ,[sett_type] ,[party_Code] ,[bs] ,[exchange] ,[qty] ,[clsrate] ,                    
   [accno] ,[dpid] ,[clid] ,[flag] ,[aben],[apool],[nben],[npool],[approved],[scripname],[partyname] ,                    
   [pool],[total],[DUMMY1],[DUMMY2],[nse_approved],[source],[upd_date],[Adjqty]                     
   from #TEMPINNER                    
                    
   drop table #TEMPINNER                    
                    
  ENd                    
                    
  --Print @IDNO                    
  SET @IDNO = @IDNO + 1                    
 ENd                    
                    
/*#######################*/                    
/* 00:01 secs */                    
 delete from Tmp_RMS_Holding where QTY < 0                    
                    
 insert into Tmp_RMS_Holding                    
 SELECT [isin] ,[scrip_cd] ,[series] ,[sett_no] ,[sett_type] ,[party_Code] ,[bs] ,[exchange] ,[qty] ,[clsrate] ,                    
 [accno] ,[dpid] ,[clid] ,[flag] ,[aben],[apool],[nben],[npool],[approved],[scripname],[partyname] ,                    
 [pool],[total],[DUMMY1],[DUMMY2],[nse_approved],[source],[upd_date],[Adjqty] from #TEMP                    
                    
-----------------------------------------------------------------------------------------------------------------                    
/* 00:35 secs */                    
update Tmp_RMS_Holding set exchange = 'BSECM' where exchange = 'BSECM1'                    
 update Tmp_RMS_Holding set exchange = 'NSECM' where exchange = 'NSECM1'                    
 update Tmp_RMS_Holding set isin='' where isin is null                    
                    
/* 00:01 secs */                    
 UPDATE Tmp_RMS_Holding SET CLSRATE = B.CLS,total=qty*B.cls FROM                    
 (select scrip,series,cls from General.dbo.cp_nsecm WITH(NOLOCK) where SCRIP ='SBIN' and series in ('N3','N4','N5','N6')) b                    
 where b.scrip=Tmp_RMS_Holding.dummy1                    
 and b.series = Tmp_RMS_Holding.series                    
        
update Tmp_RMS_Holding           
set series=b.cpseries from          
(Select scrip,series as cpseries from General.dbo.cp_nsecm WITH(NOLOCK) where series in ('EQ','BE')) b          
where Tmp_RMS_Holding.scrip_cd=b.scrip and Tmp_RMS_Holding.series in ('EQ','BE')  and Tmp_RMS_Holding.series<>b.cpseries          
        
update Tmp_RMS_Holding           
set dummy2=b.cpseries from          
(Select scrip,series as cpseries from General.dbo.cp_nsecm WITH(NOLOCK) where series in ('EQ','BE')) b          
where Tmp_RMS_Holding.dummy1=b.scrip and Tmp_RMS_Holding.dummy2 in ('EQ','BE')  and Tmp_RMS_Holding.series<>b.cpseries          
    
 truncate table vmss_rms_holding                    
 insert into vmss_rms_holding                    
 select isin,scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,                    
 aben,apool,nben,npool,approved,scripname,partyname,pool,total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty                    
 from Tmp_RMS_Holding                    
                    
 IF OBJECT_ID(N'Tmp_RMS_Holding') IS NOT NULL                    
 DROP TABLE Tmp_RMS_Holding                    
                    
 update vmss_rms_holding set nse_approved='Poor',upd_date=getdate()                    
 update vmss_rms_holding set nse_approved=Category from General.dbo.ScripCatg b with (nolock) where vmss_rms_holding.isin=b.isin                    
                    
 DELETE a                     
 from vmss_rms_holding a                     
 join General.dbo.client_details b with (nolock)                     
 on a.party_Code=b.party_code                    
 where (a.exchange ='BSECM' or a.exchange ='NSECM')                     
 and (b.cl_type='NBF' or b.cl_type='TMF')                    
                    
end try                    
begin catch                    
 insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                    
 select GETDATE(),'VMSS_Hold_process_step1',ERROR_LINE(),ERROR_MESSAGE()                    
                     
 DECLARE @ErrorMessage NVARCHAR(4000);                    
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                    
 RAISERROR (@ErrorMessage , 16, 1);                    
end catch;                    
set nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Hold_process_step2
-- --------------------------------------------------
CREATE procedure [dbo].[VMSS_Hold_process_step2]                      
as                      
                      
set transaction isolation level read UNCOMMITTED                      
set nocount on                      
begin try                      

	truncate table vmss_rms_holding                      
	insert into vmss_rms_holding                      
	select isin,scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,                      
	aben,apool,nben,npool,approved,scripname,partyname,pool,total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty                      
	from General.dbo.RMS_Holding with (nolock)
                      
end try                      
begin catch                      
 insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                      
 select GETDATE(),'VMSS_Hold_process_step2',ERROR_LINE(),ERROR_MESSAGE()                      
                       
 DECLARE @ErrorMessage NVARCHAR(4000);                      
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                      
 RAISERROR (@ErrorMessage , 16, 1);                      
end catch;                      
set nocount OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_JVemail
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
CREATE PROC [dbo].[VMSS_JVemail]                  
AS                    
BEGIN                    
SET NOCOUNT ON                    
                    
 DECLARE @Segment VARCHAR(10),@i AS INT,@str VARCHAR(8000),@fy as varchar(5) = '',@file AS VARCHAR(50),@strAttach as varchar(5000) = ''                    
 Declare @FILE_PATH as varchar(500) = '',@Baldate as varchar(10)='',@ZIP_PROGRAM_PATH as varchar(500)='',@ZIP_PATH as varchar(2000)=''                    
 Declare @SQL as varchar(2000)='',@ZIP_FILE_NAME as  varchar(1000)='',@SOURCE_FILE_NAME as varchar(500)='',@SUB as varchar(500)=''                    
  
 /*                    
 SET @FILE_PATH = 'D:\MindGate\UploadJV\Batch\'                    
 SET @ZIP_PROGRAM_PATH = '\\196.1.115.136\upload1\CBI\PkZip\pkzip25 -add'                    
 SET @ZIP_PATH = 'D:\MINDGATE\UploadJV\Zip\' */
 
 SET @FILE_PATH = 'H:\MindGate\UploadJV\Batch\'                    
 --SET @ZIP_PROGRAM_PATH = '\\196.1.115.136\upload1\CBI\PkZip\pkzip25 -add'  
 SET @ZIP_PROGRAM_PATH = 'H:\MindGate\CBI\PkZip\pkzip25 -add' --added by sneha on 14 Feb 2019                  
 SET @ZIP_PATH = 'H:\MINDGATE\UploadJV\Zip\'                    
                    
 SELECT ROW_NUMBER() OVER(ORDER BY JV_DrCode,JV_Amt) as fld_srno,* into #jv from VMSS_JVdata where 1=2                        
 select ROW_NUMBER() OVER(ORDER BY JV_Segment) as SegSrno, JV_Segment into #jvseg from VMSS_JVdata group by JV_Segment                     
                     
 select @fy =right(convert(varchar(4),DATEPART(YEAR,sdtcur)),2)+'-'+right(convert(varchar(4),DATEPART(YEAR,ldtcur)),2) from                    
 (select top 1 Bal_Date from VMSS_JVdata) a join General.dbo.parameter b on a.bal_date >= sdtcur and bal_date <= ldtcur                    
                    
                    
 DECLARE @SEGCTR AS INT = 1                    
 WHILE @SEGCTR <= (sELECT MAX(SEGSRNO) FROM #JVSEG)                    
 BEGIN                     
                    
  SELECT @segment=JV_SEGMENT FROM #JVSEG WHERE SEGSRNO=@SEGctr                    
                    
  truncate table #jv                  
                    
  insert into #jv                    
  SELECT ROW_NUMBER() OVER(ORDER BY Cltcode) as fld_srno,* from VMSS_JVdata where JV_segment=@segment                   
                      
  TRUNCATE TABLE VMSS_JVfile                     
  INSERT INTO VMSS_JVfile (flddata)                    
  SELECT 'srno,Vdate,Edate,cltcode,Drcr,Amount,Narration,branchcode'                    
                    
  INSERT INTO VMSS_JVfile(flddata)                    
  SELECT data FROM                     
  (                    
  SELECT FLD_sRNO,                    
  DATA = LTRIM(RTRIM(CONVERT(VARCHAR,fld_srno)))+','+CONVERT(VARCHAR(10),Bal_Date,103)+','                    
   +CONVERT(VARCHAR(10),Bal_Date,103)+','+LTRIM(RTRIM(JV_DRCODE))+',D,'                    
   +LTRIM(RTRIM(CONVERT(VARCHAR,JV_AMT)))+','+narration+',ALL'                    
  FROM #jv                   
  union ALL                    
  SELECT FLD_sRNO,                    
  DATA = LTRIM(RTRIM(CONVERT(VARCHAR,fld_srno)))+','+CONVERT(VARCHAR(10),Bal_Date,103)+','                    
   +CONVERT(VARCHAR(10),Bal_Date,103)+','+LTRIM(RTRIM(JV_CRCODE))+',C,'                    
   +LTRIM(RTRIM(CONVERT(VARCHAR,JV_AMT)))+','+narration+',ALL'                    
  FROM #jv                   
  ) X ORDER BY FLD_sRNO                    
                    
  SET @file = (SELECT 'VMSS_T4_JVdata_'+@Segment+'_'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','')+ '.csv')                    
  SET @SQL = ' bcp " SELECT FldData FROM [CSOKYC-6].squareoff.dbo.VMSS_JVfile ORDER BY ID '                    
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\uploadjv\Batch\' + @file + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '  */
  SET @SQL = @SQL + ' " queryout H:\MindGate\uploadjv\Batch\' + @file + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '                       
  SET @SQL = '''' + @SQL + ''''                    
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL'+ @SQL                    
  EXEC (@SQL)                    
                    
   /* FOR ADDING FILES INTO ZIP */                    
  SET @ZIP_FILE_NAME = 'VMSS_T4_JVdata_' + @Segment + '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') + '.ZIP'                       
  SET @SQL = ''                    
  SET @SOURCE_FILE_NAME = @file                    
  SET @SQL = @ZIP_PROGRAM_PATH + ' ' + @ZIP_PATH + @ZIP_FILE_NAME + ' ' + @FILE_PATH + @SOURCE_FILE_NAME + ' '                    
  SET @SQL = '''' + @SQL + ''''                    
                
  WAITFOR DELAY '00:00:03';                    
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                    
  EXEC (@SQL)                    
                    
  SET @strAttach = @strAttach + @ZIP_PATH + @ZIP_FILE_NAME+';'                 
                    
  SET @SEGCTR = @SEGCTR+1                    
  print @strAttach                  
 END                    
                    
 SET @strAttach= SUBSTRING(@strAttach,1,LEN(@strAttach)-1)                    
 select len(@strAttach )                
                     
 select top 1 @Baldate=convert(varchar(11),Bal_Date,103) from VMSS_JVdata                    
 Set @Sub='Var Margin (T+3) Shortage SquareOff JV File - :'+@Baldate                    
                    
 SET @SQL = 'Dear Team,<br/><br/>'                    
 SET @SQL = @SQL + 'Kindly upload the enclosed JV file pertaining to Var Margin Shortage SquareOff.'                    
                     
 Declare @TO varchar(max),@CC varchar(max),@BCC varchar(max)                      
                    
 SET @TO = 'csorm@angelbroking.com'                    
 SET @CC = 'renil.pillai@angelbroking.com;mgs.abha@angelbroking.com'                    
                     
 EXEC msdb.dbo.sp_send_dbmail                    
 @profile_name = 'BIDBA',                    
 @recipients= @TO,                    
 --@copy_recipients= @CC,                    
 @body= @SQL,                    
 @file_attachments= @strAttach,                    
 @body_format= 'HTML',                    
 @subject=@Sub                    
                    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_JVFileGenerate
-- --------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--drop table #SegHoldingDtls        
--drop table #x        
--drop table #y        
--drop table #JV        
----drop table JVCE_tblfile        
--drop table #cnt        
/**********************TO TRIGGER MAIL FOR T6T7 SQUAURE UP JV**********************/  
CREATE PROC [dbo].[VMSS_JVFileGenerate]
 @COUNT INT = 0        
AS  
BEGIN  
SET NOCOUNT ON  
  
 IF @COUNT = 1  
 BEGIN  
  SELECT SRNO,F_NAME FROM ASB_FILE_COUNT  
 RETURN  
 END  
  
 --CODE ADDED ON 16 Jul 2013 TO DELETE OLD CSV FILES  
/* EXEC MASTER.DBO.XP_CMDSHELL 'Del d:\MindGate\uploadjv\Batch\ASB7_GeneratedJv_*.csv'  */
 EXEC MASTER.DBO.XP_CMDSHELL 'Del H:\MindGate\uploadjv\Batch\ASB7_GeneratedJv_*.csv'  
  
 DECLARE @SQL VARCHAR(MAX)  
 SET @SQL = ''  
  
 declare @date varchar(10)  
 select @date = convert(varchar(10),max(rms_Date),103) from mis.dbo.ASB7_Clidetails  
  
 --IF(SELECT COUNT(1) FROM general.dbo.BO_Sett_Mst  
 -- WHERE  co_code='BSECM' AND sett_type='D'  
 -- AND CONVERT(VARCHAR(10),GETDATE(),121) = CONVERT(VARCHAR(10),START_DATE,121)) = 0  
 --BEGIN  
 -- RETURN  
 --END  
  
 SELECT party_Code as fld_fromcode,FrmToAccDtl ,Balance as Fld_Markamt  
 into #SegHoldingDtls  
 FROM  
 (  
  SELECT party_Code, FO_NSE ,FO_BSE,MCD_NSE ,MCD_BSE ,NSX_NSE ,NSX_BSE  
  FROM [MIS].DBO.SegHoldingDtls WITH (NOLOCK)  
 ) p  
 UNPIVOT  
 (Balance  
  FOR FrmToAccDtl IN (FO_NSE ,FO_BSE ,MCD_NSE ,MCD_BSE ,NSX_NSE ,NSX_BSE)  
 )AS unpvt;  
  
 ALTER TABLE #SegHoldingDtls  
 ADD fld_FromSegment VARCHAR(10),  
  fld_toSegment VARCHAR(10)  
  
 DELETE FROM #SegHoldingDtls WHERE CONVERT(DECIMAL(18,2),Fld_Markamt) = 0  
  
 UPDATE a  
 SET a.fld_FromSegment = SUBSTRING(FrmToAccDtl,0,LEN(FrmToAccDtl)-3),  
  a.fld_toSegment = SUBSTRING(FrmToAccDtl,LEN(FrmToAccDtl)-2,LEN(FrmToAccDtl))  
 FROM #SegHoldingDtls a  
  
 --select * from #SegHoldingDtls  
  
 UPDATE a  
 SET a.fld_FromSegment = CASE a.fld_FromSegment WHEN 'FO' THEN 'NSEFO' WHEN 'BSE' THEN 'BSECM' WHEN 'NSE' THEN 'NSECM' ELSE a.fld_FromSegment END,  
  a.fld_toSegment = CASE a.fld_toSegment WHEN 'FO' THEN 'NSEFO' WHEN 'BSE' THEN 'BSECM' WHEN 'NSE' THEN 'NSECM' ELSE a.fld_toSegment END  
 FROM #SegHoldingDtls a  
  
 --select * from #SegHoldingDtls  
 ------------------------copied from JVCE_Generate and modified accordingly.-----------------------------  
 SELECT x.Fld_FromCode,x.Fld_Markamt,y.Fld_SrNo,y.Fld_FromSegment,y.Fld_ToSegment,y.Fld_FromControlAc  
 ,y.Fld_ToControlAc,y.Fld_FromNarration,y.Fld_ToNarration  
 INTO #x  
 FROM #SegHoldingDtls x WITH(NOLOCK)  
 inner join tbl_JVControlMaster y WITH(NOLOCK)  
 ON x.Fld_FromSegment = y.Fld_FromSegment  
 AND x.Fld_ToSegment = y.Fld_ToSegment  
  
 DELETE FROM #x WHERE CONVERT(DECIMAL(18,2),Fld_Markamt) = 0  
  
 CREATE TABLE #JV  
 (  
  Fld_SrNo INT IDENTITY(1,1),  
  sr INT,  
  Fld_FromCode VARCHAR(25),  
  Fld_ControlAc VARCHAR(25),  
  Fld_DrCr VARCHAR(2),  
  Fld_MarkAmt MONEY,  
  Fld_Narration VARCHAR(100),  
  Fld_FromSegment VARCHAR(10)  
 )  
  
 --select top 0 * into JVCE_tblfile from mis.sccs.dbo.tblFileSCCS  
  
 DECLARE @file AS VARCHAR(50)  
 DECLARE @Segment VARCHAR(10)  
 DECLARE @i AS INT  
 DECLARE @str VARCHAR(8000)  
  
 SET @Segment = ''  
 SET @i = 1  
  
 SELECT Fld_FromSegment  
 INTO #cnt  
 FROM  
 (  
  SELECT DISTINCT Fld_FromSegment  
  FROM #x  
  union  
  SELECT DISTINCT Fld_toSegment  
  FROM #x  
 ) A  
  
 ALTER TABLE #cnt  
 ADD ID INT IDENTITY  
  
 TRUNCATE TABLE ASB_FILE_COUNT  
  
 DECLARE @SOURCE_FILE_NAME VARCHAR(100)  
 DECLARE @FILE_PATH VARCHAR(100)  
 DECLARE @ZIP_FILE_NAME VARCHAR(200)  
 DECLARE @ZIP_PROGRAM_PATH VARCHAR(100)  
 DECLARE @ZIP_PATH VARCHAR(500)  
 DECLARE @RowCount INT,@j INT,@Loop INT,@LoopCount INT,@Batch INT  
 
 /* 
 SET @FILE_PATH = 'D:\MindGate\UploadJV\Batch\'  
 SET @ZIP_PROGRAM_PATH = '\\196.1.115.136\upload1\CBI\PkZip\pkzip25 -add'  
 --SET @ZIP_PROGRAM_PATH = '\\196.1.115.136\d$\upload1\CBI\PkZip\pkzip25 -add'  
 --SET @ZIP_PROGRAM_PATH = 'D:\upload1\CBI\PkZip\pkzip25 -add'  
 SET @ZIP_PATH = 'D:\MINDGATE\UploadJV\Zip\'  */
 
 SET @FILE_PATH = 'H:\MindGate\UploadJV\Batch\'  
 --SET @ZIP_PROGRAM_PATH = '\\196.1.115.136\upload1\CBI\PkZip\pkzip25 -add'  
  SET @ZIP_PROGRAM_PATH = 'H:\MindGate\CBI\PkZip\pkzip25 -add' --added by sneha on 15 Feb 2019
 --SET @ZIP_PROGRAM_PATH = '\\196.1.115.136\d$\upload1\CBI\PkZip\pkzip25 -add'  
 --SET @ZIP_PROGRAM_PATH = 'D:\upload1\CBI\PkZip\pkzip25 -add'  
 SET @ZIP_PATH = 'H:\MINDGATE\UploadJV\Zip\' 
        
 WHILE @i <= (SELECT COUNT(*) FROM #cnt)  
 BEGIN  
  
  SELECT @Segment = Fld_FromSegment  
  FROM #cnt  
  WHERE id = @i  
  
  IF(@Segment = 'BSECM' OR @Segment = 'NSECM')  
   SET @Batch = 10000  
  ELSE  
   SET @Batch = 4000  
  
  TRUNCATE TABLE #JV  
  
  INSERT INTO #JV(sr,Fld_FromCode , Fld_ControlAc,Fld_DrCr ,Fld_MarkAmt ,Fld_Narration ,Fld_FromSegment )  
  SELECT ROW_NUMBER() OVER(ORDER BY Fld_FromCode,Fld_MarkAmt) fld_srno,Fld_FromCode,  
  Fld_ControlAc,Fld_DrCr,Fld_MarkAmt,Fld_FromNarration,Fld_FromSegment  
  FROM  
  (  
   SELECT Fld_FromCode,Fld_ControlAc = fld_fromcode,Fld_DrCr = 'D',Fld_MarkAmt,Fld_FromNarration=Fld_FromNarration+' '+  
    Fld_FromCode,Fld_FromSegment  
   FROM #x  
   WHERE Fld_FromSegment = @Segment  
   UNION ALL  
   select Fld_fromCode,Fld_ControlAc = convert(varchar,Fld_ToControlAc),Fld_DrCr = 'D',Fld_MarkAmt,Fld_ToNarration=Fld_ToNarration+' '+Fld_FromCode,Fld_toSegment  
   from #x   
   WHERE Fld_toSegment = @Segment  
  ) A  
  UNION ALL  
  SELECT ROW_NUMBER() OVER(ORDER BY Fld_FromCode,Fld_MarkAmt) fld_srno,Fld_FromCode,  
  Fld_ControlAc,Fld_DrCr,Fld_MarkAmt,Fld_FromNarration,Fld_toSegment  
  FROM  
  (  
   SELECT Fld_FromCode,Fld_ControlAc = fld_fromcode,Fld_DrCr = 'C',Fld_MarkAmt,  
   Fld_FromNarration=Fld_ToNarration+' '+Fld_FromCode,Fld_toSegment  
   FROM #x  
   WHERE Fld_toSegment = @Segment  
   UNION ALL  
   SELECT Fld_fromCode,Fld_ControlAc = CONVERT(VARCHAR,Fld_FromControlAc),Fld_DrCr = 'C',Fld_MarkAmt,  
   Fld_ToNarration=Fld_FromNarration+' '+ Fld_FromCode,Fld_fromSegment  
   FROM #x  
   WHERE Fld_FromSegment = @Segment  
  )B  
  ORDER BY fld_srno,Fld_DrCr  
  
  SELECT @RowCount = MAX(sr) FROM #jv  
  
  SET @Loop=CEILING(CONVERT(DECIMAL(15,2),@RowCount*2)/@Batch)  
  
  DELETE FROM #JV  
  WHERE Fld_FromCode IN (SELECT PARTY_CODE FROM mis.dbo.asb7_block_client)  
  
  --SELECT @RowCount,@BATCH, @Loop  
  
  DECLARE @iCnt INT  
  SET @LoopCount=1  
  SET @j=@Batch  
  SET @iCnt=1  
  SET @ZIP_FILE_NAME = 'ASB7_GeneratedJv_' + @Segment + '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') + '.ZIP'  
  
  SELECT ID = ROW_NUMBER() OVER(ORDER BY sr ASC,Fld_DrCr DESC),  
   DATA = LTRIM(RTRIM(CONVERT(VARCHAR,sr)))+','+@date+','  
    +@date+','+LTRIM(RTRIM(Fld_ControlAc))+','+LTRIM(RTRIM(Fld_drcr))+','  
    +LTRIM(RTRIM(CONVERT(VARCHAR,Fld_MarkAmt)))+','+ISNULL(LTRIM(RTRIM(Fld_Narration)),'')+',ALL'  
  INTO #JVCE_tblfile  
  FROM #jv x  
  WHERE fld_fromsegment = @Segment  
  ORDER BY sr ASC,Fld_DrCr DESC  
  
  WHILE(@LoopCount<=@Loop)  
  BEGIN  
  
   --SELECT @iCnt,@j,@Loop,@LoopCount  
  
   TRUNCATE TABLE JVCE_tblfile  
  
   INSERT INTO JVCE_tblfile  
   SELECT 'srno,Vdate,Edate,cltcode,Drcr,Amount,Narration,branchcode'  
  
   INSERT INTO JVCE_tblfile  
   SELECT DATA FROM #JVCE_tblfile  
   WHERE ID BETWEEN @iCnt AND @j  
   ORDER BY ID  
  
   SET @file = (SELECT 'ASB7_GeneratedJv_'+@Segment+'_'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','')+ CONVERT(VARCHAR(10),@LoopCount) +'.csv')  
  
   --exec ('EXEC MASTER.DBO.XP_CMDSHELL ''BCP " select flddata from JVCE_tblfile " QUERYOUT F:\Saroj\' + @file + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc''')  
   -- select flddata from JVCE_tblfile  
  
   SET @SQL = ' bcp " SELECT FldData FROM general.dbo.JVCE_tblfile ORDER BY ID '  
     
   /*SET @SQL = @SQL + ' " queryout d:\MindGate\uploadjv\Batch\' + @file + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '*/
   SET @SQL = @SQL + ' " queryout H:\MindGate\uploadjv\Batch\' + @file + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '     
   SET @SQL = '''' + @SQL + ''''  
   SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL  
   --PRINT @SQL  
   EXEC (@SQL)  
  
   /* FOR ADDING FILES INTO ZIP */  
   SET @SQL = ''  
   SET @SOURCE_FILE_NAME = @file  
   SET @SQL = @ZIP_PROGRAM_PATH + ' ' + @ZIP_PATH + @ZIP_FILE_NAME + ' ' + @FILE_PATH + @SOURCE_FILE_NAME + ' '  
   SET @SQL = '''' + @SQL + ''''  
  
   WAITFOR DELAY '00:00:03';  
   SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL  
   PRINT @SQL  
   EXEC (@SQL)  
   /* FOR ADDING FILES INTO ZIP */  
  
   SET @iCnt=@iCnt+@Batch  
  
   IF((@RowCount*2-@j)>@Batch)  
    SET @j=@j+@Batch  
   ELSE  
    SET @j=@j+((@RowCount * 2) -@j)  
      
   SET @LoopCount=@LoopCount+1  
  
  END  
  
   /*START BULK FILE GENERATION*/  
  
   TRUNCATE TABLE JVCE_tblfile  
  
   INSERT INTO JVCE_tblfile  
   SELECT ' srno,Vdate,Edate,cltcode,Drcr,Amount,Narration,branchcode'  
  
   INSERT INTO JVCE_tblfile  
   SELECT DATA FROM #JVCE_tblfile  
   ORDER BY ID  
  
   SET @file = (SELECT 'ASB7_GeneratedJv_'+@Segment+'_'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','')+ '.csv')  
     
   SET @SQL = ' bcp " SELECT FldData FROM general.dbo.JVCE_tblfile WITH(NOLOCK) ORDER BY ID '  
     
   /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJV\Bulk\' + @file + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc ' */
   SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJV\Bulk\' + @file + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '     
   SET @SQL = '''' + @SQL + ''''  
   SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL  
   --PRINT @SQL  
   EXEC (@SQL)  
  
   /*END BULK FILE GENERATION*/  
  
  DROP TABLE #JVCE_tblfile  
  
  SET @i = @i+1  
 END  
  
 /*START SEND JV MAIL*/  
  
 DECLARE @strAttach VARCHAR(MAX)  
 SET @strAttach= ''  
  
 SET @i = 1  
 WHILE @i <= (SELECT COUNT(*) FROM #cnt)  
 BEGIN  
  
  SELECT @Segment = Fld_FromSegment  
  FROM #cnt  
  WHERE id = @i  
  
  SET @file = (SELECT 'ASB7_GeneratedJv_'+@Segment+'_'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','')+ '.zip')  
  /*SET @strAttach = @strAttach + 'D:\MINDGATE\UploadJV\Zip\' + @file +';'  */
  SET @strAttach = @strAttach + 'H:\MINDGATE\UploadJV\Zip\' + @file +';'
  SET @i = @i+1  
  
 END  
  
 SET @strAttach= SUBSTRING(@strAttach,1,LEN(@strAttach)-1)  
  
 PRINT @strAttach  
  
 SET @SQL = 'Dear Team,<br/><br/>'  
 SET @SQL = @SQL + 'Kindly upload the attached JV dated (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') pertaining to T+7 Square off Module.'  
 SET @SQL = @SQL + '<br/><br/>Kindly revert incase there is discrepancy related to control A/C.'  
  
 --DECLARE @Rec VARCHAR(500)  
 --SET @Rec ='sajeev@angelbroking.com;hirakp.parikh@angelbroking.com;bhavin@angelbroking.com;'  
 --SET @Rec = @Rec + 'vishal@angelbroking.com;vishal.kanani@angelbroking.com;akila.iyer@angelbroking.com;'  
 --SET @Rec = @Rec + 'mgs.saroj@angelbroking.com;manesh@angelbroking.com;pranita@angelbroking.com;'  
 --SET @Rec = @Rec + 'Amit.Shettigar@angelbroking.com'  
  
 Declare @TO varchar(max),@CC varchar(max),@BCC varchar(max)    
 SET @TO = General.dbo.FN_GETDELIMITEDMAILID('T+7 JV File Generation',1)  
 SET @CC = General.dbo.FN_GETDELIMITEDMAILID('T+7 JV File Generation',2)  
 SET @BCC = General.dbo.FN_GETDELIMITEDMAILID('T+7 JV File Generation',3)  
/*  
 SET @Rec ='vishal@angelbroking.com;vishal.kanani@angelbroking.com;akila.iyer@angelbroking.com;'  
 SET @Rec = @Rec + 'mgs.saroj@angelbroking.com;mgs.sushantn@angelbroking.com'  
 SET @Rec = @Rec + 'sajeev@angelbroking.com;hirakp.parikh@angelbroking.com;bhavin@angelbroking.com;'  
*/  
 EXEC msdb.dbo.sp_send_dbmail  
 @profile_name = 'Square',  
 @recipients= @TO,  
 @copy_recipients= @CC,  
 @blind_copy_recipients= @BCC,  
 @body= @SQL,  
 @file_attachments= @strAttach,  
 @body_format= 'HTML',  
 @subject='Auto JV Generation T+7 Square Off'  
  
 /*END SEND JV MAIL*/  
   
  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_JVprocess
-- --------------------------------------------------

CREATE Procedure [dbo].[VMSS_JVprocess]
as  
SET XACT_ABORT ON                  
Set nocount on                  
BEGIN TRY                                          
  
/**** NSEFO ****/  
  
 /* BSECM from NSEFO */  
 select * into #vmss_Data from vmss_Data where processDate = (select MAX(processdate) from vmss_Data)  
  
 select * into #NSEFO_BSECM_JV1 from VMSS_JVdata where 1=2  
 select * into #NSEFO_BSECM_JV2 from VMSS_JVdata where 1=2  
  
 insert into #NSEFO_BSECM_JV1   
 select getdate(),a.*,b.Fld_ToControlAc as JV_DrCode,party_code as JV_CrCode,Fld_ToNarration from  
 (  
 select party_code,(CASE WHEN nsefo_JV <= bseCM_BALANCE*-1 THEN nsefo_JV ELSE bseCM_BALANCE*-1 END) AS JV_AMT,  
 'BSECM' as JV_Segment from #vmss_Data where NSEFO_JV > 0 AND bsecM_BALANCE < 0   
 ) a join (select * from General.dbo.tbl_JVControlMaster where fld_fromsegment='NSEFO' and Fld_Tosegment='BSECM') b  
 on a.JV_Segment=b.Fld_Tosegment  
  

  
 insert into #NSEFO_BSECM_JV2   
 select getdate(),a.*,party_code as JV_DrCode,b.Fld_FromControlAc as JV_CrCode,Fld_FromNarration from  
 (  
 select party_code,(CASE WHEN nsefo_JV <= bseCM_BALANCE*-1 THEN nsefo_JV ELSE bseCM_BALANCE*-1 END) AS JV_AMT,  
 'NSEFO' as JV_Segment from #vmss_Data where NSEFO_JV > 0 AND bsecM_BALANCE < 0    
 ) a join (select * from General.dbo.tbl_JVControlMaster where fld_fromsegment='NSEFO' and Fld_Tosegment='BSECM') b  
 on a.JV_Segment=b.fld_fromsegment  
  
 /* NSECM fron NSEFO */  
  
 update #vmss_Data set NSEFO_JV=NSEFO_JV-isnull(b.JV_amt,0) from  
 #NSEFO_BSECM_JV2 b where #vmss_Data.party_code=b.cltcode and nsefo_jv >0  
  
 select * into #NSEFO_NSECM_JV1 from VMSS_JVdata where 1=2  
 select * into #NSEFO_NSECM_JV2 from VMSS_JVdata where 1=2  
  
 insert into #NSEFO_NSECM_JV1   
 select getdate(),a.*,b.Fld_ToControlAc as JV_DrCode,party_code as JV_CrCode,Fld_ToNarration from  
 (  
 select party_code,(CASE WHEN nsefo_JV <= nseCM_BALANCE*-1 THEN nsefo_JV ELSE nseCM_BALANCE*-1 END) AS JV_AMT,  
 'NSECM' as JV_Segment from #vmss_Data where NSEFO_JV > 0 AND nsecM_BALANCE < 0   
 ) a join (select * from General.dbo.tbl_JVControlMaster where fld_fromsegment='NSEFO' and Fld_Tosegment='NSECM') b  
 on a.JV_Segment=b.Fld_Tosegment  
  
  

 insert into #NSEFO_BSECM_JV2   
 select getdate(),a.*,party_code as JV_DrCode,b.Fld_FromControlAc as JV_CrCode,Fld_FromNarration from  
 (  
 select party_code,(CASE WHEN NSEFO_JV <= NSECM_BALANCE*-1 THEN NSEFO_JV ELSE NSECM_BALANCE*-1 END) AS JV_AMT,  
 'NSEFO' as JV_Segment from #vmss_Data where NSEFO_JV > 0 AND NSECM_BALANCE < 0    
 ) a join (select * from General.dbo.tbl_JVControlMaster where fld_fromsegment='NSEFO' and Fld_Tosegment='NSECM') b  
 on a.JV_Segment=b.fld_fromsegment  
  
  
/**** MCD ****/  
  
 /* BSECM from MCD */  
  
 select * into #MCD_BSECM_JV1 from VMSS_JVdata where 1=2  
 select * into #MCD_BSECM_JV2 from VMSS_JVdata where 1=2  
  
 insert into #MCD_BSECM_JV1   
 select getdate(),a.*,b.Fld_FromControlAc as JV_DrCode,party_code as JV_CrCode,Fld_ToNarration from  
 (  
 select party_code,(CASE WHEN MCD_JV <= bseCM_BALANCE*-1 THEN MCD_JV ELSE bseCM_BALANCE*-1 END) AS JV_AMT,  
 'BSECM' as JV_Segment from #vmss_Data where MCD_JV > 0 AND bsecM_BALANCE < 0   
 ) a join (select * from General.dbo.tbl_JVControlMaster where fld_fromsegment='MCD' and Fld_Tosegment='BSECM') b  
 on a.JV_Segment=b.Fld_Tosegment  
  
  
 insert into #MCD_BSECM_JV2   
 select getdate(),a.*,party_code as JV_DrCode,b.Fld_ToControlAc as JV_CrCode,Fld_FromNarration from  
 (  
 select party_code,(CASE WHEN MCD_JV <= bseCM_BALANCE*-1 THEN MCD_JV ELSE bseCM_BALANCE*-1 END) AS JV_AMT,  
 'MCD' as JV_Segment from #vmss_Data where MCD_JV > 0 AND bsecM_BALANCE < 0    
 ) a join (select * from General.dbo.tbl_JVControlMaster where fld_fromsegment='MCD' and Fld_Tosegment='BSECM') b  
 on a.JV_Segment=b.fld_fromsegment  
  
 /* NSECM fron MCD */  
  
 update #vmss_Data set MCD_JV=MCD_JV-isnull(b.JV_amt,0) from  
 #MCD_BSECM_JV2 b where #vmss_Data.party_code=b.cltcode and MCD_JV > 0  
  
 select * into #MCD_NSECM_JV1 from VMSS_JVdata where 1=2  
 select * into #MCD_NSECM_JV2 from VMSS_JVdata where 1=2  
  
 insert into #MCD_NSECM_JV1   
 select getdate(),a.*,b.Fld_FromControlAc as JV_DrCode,party_code as JV_CrCode,Fld_ToNarration from  
 (  
 select party_code,(CASE WHEN MCD_JV <= nseCM_BALANCE*-1 THEN MCD_JV ELSE nseCM_BALANCE*-1 END) AS JV_AMT,  
 'NSECM' as JV_Segment from #vmss_Data where MCD_JV > 0 AND nsecM_BALANCE < 0   
 ) a join (select * from General.dbo.tbl_JVControlMaster where fld_fromsegment='MCD' and Fld_Tosegment='NSECM') b  
 on a.JV_Segment=b.Fld_Tosegment  
  
  
 insert into #MCD_NSECM_JV2   
 select getdate(),a.*,party_code as JV_DrCode,b.Fld_ToControlAc as JV_CrCode,Fld_FromNarration from  
 (  
 select party_code,(CASE WHEN MCD_JV <= NSECM_BALANCE*-1 THEN MCD_JV ELSE NSECM_BALANCE*-1 END) AS JV_AMT,  
 'MCD' as JV_Segment from #vmss_Data where MCD_JV > 0 AND NSECM_BALANCE < 0    
 ) a join (select * from General.dbo.tbl_JVControlMaster where fld_fromsegment='MCD' and Fld_Tosegment='NSECM') b  
 on a.JV_Segment=b.fld_fromsegment  
  
  
/**** NSX ****/  
  
 /* BSECM from NSX */  
  
 select * into #NSX_BSECM_JV1 from VMSS_JVdata where 1=2  
 select * into #NSX_BSECM_JV2 from VMSS_JVdata where 1=2  
  
 insert into #NSX_BSECM_JV1   
 select getdate(),a.*,b.Fld_FromControlAc as JV_DrCode,party_code as JV_CrCode,Fld_ToNarration from  
 (  
 select party_code,(CASE WHEN NSX_JV <= bseCM_BALANCE*-1 THEN NSX_JV ELSE bseCM_BALANCE*-1 END) AS JV_AMT,  
 'BSECM' as JV_Segment from #vmss_Data where NSX_JV > 0 AND bsecM_BALANCE < 0   
 ) a join (select * from General.dbo.tbl_JVControlMaster where fld_fromsegment='NSX' and Fld_Tosegment='BSECM') b  
 on a.JV_Segment=b.Fld_Tosegment  
  
  
 insert into #NSX_BSECM_JV2   
 select getdate(),a.*,party_code as JV_DrCode,b.Fld_ToControlAc as JV_CrCode,Fld_FromNarration from  
 (  
 select party_code,(CASE WHEN NSX_JV <= bseCM_BALANCE*-1 THEN NSX_JV ELSE bseCM_BALANCE*-1 END) AS JV_AMT,  
 'NSX' as JV_Segment from #vmss_Data where NSX_JV > 0 AND bsecM_BALANCE < 0    
 ) a join (select * from General.dbo.tbl_JVControlMaster where fld_fromsegment='NSX' and Fld_Tosegment='BSECM') b  
 on a.JV_Segment=b.fld_fromsegment  
  
 /* NSECM fron NSX */  
  
 update #vmss_Data set NSX_JV=NSX_JV-isnull(b.JV_amt,0) from  
 #NSX_BSECM_JV2 b where #vmss_Data.party_code=b.cltcode and NSX_JV > 0  
  
 select * into #NSX_NSECM_JV1 from VMSS_JVdata where 1=2  
 select * into #NSX_NSECM_JV2 from VMSS_JVdata where 1=2  
  
 insert into #NSX_NSECM_JV1   
 select getdate(),a.*,b.Fld_FromControlAc as JV_DrCode,party_code as JV_CrCode,Fld_ToNarration from  
 (  
 select party_code,(CASE WHEN NSX_JV <= nseCM_BALANCE*-1 THEN NSX_JV ELSE nseCM_BALANCE*-1 END) AS JV_AMT,  
 'NSECM' as JV_Segment from #vmss_Data where NSX_JV > 0 AND nsecM_BALANCE < 0   
 ) a join (select * from General.dbo.tbl_JVControlMaster where fld_fromsegment='NSX' and Fld_Tosegment='NSECM') b  
 on a.JV_Segment=b.Fld_Tosegment  
  
  
 insert into #NSX_NSECM_JV2   
 select getdate(),a.*,party_code as JV_DrCode,b.Fld_ToControlAc as JV_CrCode,Fld_FromNarration from  
 (  
 select party_code,(CASE WHEN NSX_JV <= NSECM_BALANCE*-1 THEN NSX_JV ELSE NSECM_BALANCE*-1 END) AS JV_AMT,  
 'NSX' as JV_Segment from #vmss_Data where NSX_JV > 0 AND NSECM_BALANCE < 0    
 ) a join (select * from General.dbo.tbl_JVControlMaster where fld_fromsegment='NSX' and Fld_Tosegment='NSECM') b  
 on a.JV_Segment=b.fld_fromsegment  
  
 Truncate table VMSS_JVdata  
 insert into VMSS_JVdata(Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration)  
select Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration from #NSEFO_BSECM_JV1  
  
 insert into VMSS_JVdata(Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration)  
 select Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration from #NSEFO_BSECM_JV2  
  
 insert into VMSS_JVdata(Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration)  
 select Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration from #NSEFO_NSECM_JV1  
  
 insert into VMSS_JVdata(Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration)  
 select Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration from #NSEFO_NSECM_JV2  
  
  
  
 insert into VMSS_JVdata(Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration)  
 select Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration from #MCD_BSECM_JV1  
  
 insert into VMSS_JVdata(Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration)  
 select Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration from #MCD_BSECM_JV2  
  
 insert into VMSS_JVdata(Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration)  
 select Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration from #MCD_NSECM_JV1  
  
 insert into VMSS_JVdata(Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration)  
 select Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration from #MCD_NSECM_JV2  
  
  
  
 insert into VMSS_JVdata(Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration)  
 select Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration from #NSX_BSECM_JV1  
  
 insert into VMSS_JVdata(Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration)  
 select Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration from #NSX_BSECM_JV2  
  
 insert into VMSS_JVdata(Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration)  
 select Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration from #NSX_NSECM_JV1  
  
 insert into VMSS_JVdata(Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration)  
 select Bal_Date,Cltcode,JV_amt,JV_Segment,JV_DrCode,JV_CrCode,Narration from #NSX_NSECM_JV2  
  
 /* ---TESTING CODE   
 SELECT *,NSEFO_JV-JV_AMT FROM  
 (SELECT * FROM VMSS_DATA WHERE NSEFO_JV > 0)A   
 LEFT OUTER JOIN   
 (  
  SELECT CLTCODE,JV_AMT=SUM(JV_AMT) FROM  
  (  
  SELECT * FROM #NSEFO_NSECM_JV2  
  UNION ALL  
  SELECT * FROM #NSEFO_BSECM_JV2  
  ) X GROUP BY CLTCODE  
 ) B   
 ON A.PARTY_CODE=B.CLTCODE  
 */  
  
End try                                       
BEGIN CATCH                                          
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                
  select GETDATE(),'VMSS_JVprocess',ERROR_LINE(),ERROR_MESSAGE()                                                
End catch                   
                  
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Ledgerrpt
-- --------------------------------------------------
    
  --VMSS_Ledgerrpt 'bsecm','JIVO003'   
CREATE procedure [dbo].[VMSS_Ledgerrpt](@segment as varchar(10),@pcode as varchar(10))      
as      
set nocount on      
      
 Declare @noofdays int     
 set @noofdays = 60       
       
 Declare @BSElastBillDate datetime = (select MAX(BillDate) from anand.account_Ab.dbo.BillPosted where Sett_Type='D' and BillDate <= GETDATE())                                              
 Declare @sdtcur as datetime,@ToDate as datetime = convert(varchar(11),@BSElastBillDate)+' 23:59:59',@OpnBalDate as datetime                                                     
 select @sdtcur=sdtcur from general.dbo.parameter where sdtcur <= @ToDate and ldtcur >=@ToDate                                              
 /*      
 if datediff(dd,@sdtcur,@ToDate) < @noofdays      
 Begin      
 select @sdtcur=sdtcur from general.dbo.parameter       
 where sdtnxt = (select sdtcur from general.dbo.parameter where sdtcur <= @ToDate and ldtcur >=@ToDate )        
 End      
 */      
       
set @OpnBalDate = @ToDate-(@noofdays+1)      
      
if @segment='BSECM'      
Begin       
 Select * into #temp from       
 (      
 select '18' as Vtyp,      
 '000000000000' as Vno,      
 @OpnBalDate as edt,      
 1 as Lno,'' as acname,   
  (CASE WHEN sum(case when drcr='D' then -VAMT else VAMT end) > 0 THEN 'C' else 'D' end) as drcr,         
debit=sum(case when drcr='D' then vamt else 0 end),  
credit=sum(case when drcr='C' then vamt else 0 end ),  
 Amount=sum( CASE   
                  WHEN drcr = 'D' THEN -vamt   
                  ELSE vamt   
                END ),   
       Balance=sum( CASE   
                   WHEN drcr = 'D' THEN vamt   
                   ELSE 0   
                 END ) , @OpnBalDate as vdt,'000000000000' as vno1,0 as refno,0 as balamt,1 as NoDays,@OpnBalDate as Cdt,      
 cltcode,'01' as BookType,'System' as EnteredBy,@OpnBalDate as pdt,'System' as CheckedBy,0 as actnodays,'Opening Balance' as narration      
   
 --into #OpnBal                                     
 from general.dbo.bsecm_ledger a with (nolock)                                                     
 where /* vDT>=@sdtcur and  */(Case when Vtyp<>15 and Drcr='C' then vdt else eDT end)< @OpnBalDate       
 and cltcode=@pcode  
 group by cltcode      
      
 UNION      
        
 select convert(varchar(25),vtyp),vno,edt,lno,acname,drcr,debit=case when drcr='D' then vamt else 0 end,credit=case when drcr='C' then vamt else 0 end ,  
 Amount=( CASE   
                  WHEN drcr = 'D' THEN -vamt   
                  ELSE vamt   
                END ),   
       Balance=( CASE   
                   WHEN drcr = 'D' THEN vamt   
                   ELSE 0   
                 END ) ,vdt,vno1,refno,balamt,NoDays,cdt,cltcode,BookType,EnteredBy,pdt,CheckedBy,actnodays,narration      
 from general.dbo.bsecm_ledger a with (nolock)                                                     
 where vDT >= @OpnBalDate and  (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end)<= @ToDate      
 and cltcode=@pcode       
      
 ) x order by (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end)      
   
UPDATE #temp   
SET    vtyp = b.shortdesc   
FROM   general.dbo.vmast b   
WHERE  #temp.vtyp = b.vtype   
       AND b.co_code = 'bsecm'   
  
DECLARE @balance AS MONEY  
SET @balance = 0   
  
UPDATE #temp   
SET    @balance = balance = @balance + amount   
  
select cltcode,vtyp,convert(varchar(11),vdt) as vdt,convert(varchar(11),edt) as edt, Vno,narration,debit,credit ,balance from #temp order by vdt  
  
END      
      
if @segment='NSECM'      
Begin       
 Select * into #temp1 from    
 (      
 select '18' as Vtyp,      
 '000000000000' as Vno,      
 @OpnBalDate as edt,      
 1 as Lno,'' as acname,      
 (CASE WHEN sum(case when drcr='D' then -VAMT else VAMT end) > 0 THEN 'C' else 'D' end) as drcr,   
 debit=sum(case when drcr='D' then vamt else 0 end),  
credit=sum(case when drcr='C' then vamt else 0 end ),  
 Amount=sum( CASE   
                  WHEN drcr = 'D' THEN -vamt   
                  ELSE vamt   
                END ),   
       Balance=sum( CASE   
                   WHEN drcr = 'D' THEN vamt   
                   ELSE 0   
                 END ),     
 --vamt=sum(case when drcr='D' then -VAMT else VAMT end),      
 @OpnBalDate as vdt,'000000000000' as vno1,0 as refno,0 as balamt,1 as NoDays,@OpnBalDate as Cdt,      
 cltcode,'01' as BookType,'System' as EnteredBy,@OpnBalDate as pdt,'System' as CheckedBy,0 as actnodays,'Opening Balance' as narration      
 --into #OpnBal                                     
 from general.dbo.nsecm_ledger a with (nolock)                                                     
 where /* vDT>=@sdtcur and  */(Case when Vtyp<>15 and Drcr='C' then vdt else eDT end)< @OpnBalDate       
 and cltcode=@pcode      
 group by cltcode          
      
 UNION      
        
 select convert(varchar(25),vtyp),vno,edt,lno,acname,drcr,debit=case when drcr='D' then vamt else 0 end,credit=case when drcr='C' then vamt else 0 end ,  
 Amount=( CASE   
                  WHEN drcr = 'D' THEN -vamt   
                  ELSE vamt   
                END ),   
       Balance=( CASE   
                   WHEN drcr = 'D' THEN vamt   
                   ELSE 0   
                 END ) ,vdt,vno1,refno,balamt,NoDays,cdt,cltcode,BookType,EnteredBy,pdt,CheckedBy,actnodays,narration      
 from general.dbo.nsecm_ledger a with (nolock)                                                     
 where vDT >= @OpnBalDate and  (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end)<= @ToDate      
 and cltcode=@pcode      
      
 ) x order by (Case when Vtyp<>15 and Drcr='C' then vdt else eDT end)    
   
UPDATE #temp1   
SET    vtyp = b.shortdesc   
FROM   vmast b   
WHERE  #temp1.vtyp = b.vtype   
       AND b.co_code = 'nsecm'   
  
  
SET @balance = 0   
  
UPDATE #temp1   
SET    @balance = balance = @balance + amount   
  

select cltcode,vtyp,convert(varchar(11),vdt) as vdt,convert(varchar(11),edt) as edt, Vno,narration,debit,credit ,balance from #temp1 order by vdt  
     
END      
      
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Margin_Shortage_SquareOff_Exception_Process
-- --------------------------------------------------
  
  
CREATE procedure [dbo].[VMSS_Margin_Shortage_SquareOff_Exception_Process]                                              
as                           
begin                                                                 
begin try                                            
              
  declare @alertdate datetime                                              
  select  @alertdate = (select max(processdate) from vmss_data)                                     
  --select @alertdate =  dateadd(d, -((datepart(weekday, getdate()) + 1 + @@datefirst) % 7), getdate())                                               
              
IF OBJECT_ID(N'mis.dbo.vmss_margin_shortage_sqoff_client_exp') IS NOT NULL                                                                  
 drop table mis.dbo.vmss_margin_shortage_sqoff_client_exp                                        
  /*                     
  insert into mis.dbo.vmss_margin_shortage_sqoff_client_exp             
  (region,branch,sb,party_code,category,cli_type,sb_category,varmarginshortfall_aftadj,squareoffvalue,noofdays,update_date,mobile_pager,email,balance,holding_bhc,holding_ahc)                                              
  */    
  select b.region, b.branch, b.sb,c.party_code, b.category,b.cli_type ,                                               
  b.sb_category ,c.varmarginshortfall_aftadj,c.squareoffvalue,                                            
  c.noofdays,update_date=getdate(),                                            
  (rtrim(ltrim(cli.mobile_pager))) as mobile_pager,(rtrim(ltrim(cli.email)))  as email,                                
  balance,holding_bhc,holding_ahc         
  into mis.dbo.vmss_margin_shortage_sqoff_client_exp                                             
  from GENERAL.DBO.VMSS_data_combine c with (nolock)                                                 
  inner join [csokyc-6].general.dbo.vw_rms_client_vertical b with (nolock) on b.client = c.party_code                                               
  inner join [csokyc-6].general.dbo.client_details cli with (nolock) on b.client = cli.party_code                                                    
  where convert(varchar(10),c.processDate,120) = convert(varchar(10),@alertdate,120) and                                        
  --abs(c.t_value) > 500                                              
  c.noofdays> = 3 --+ @t_day                                               
  and c.squareoffvalue <> 0                                               
              
  delete from mis.dbo.vmss_margin_shortage_sqoff_client_exp where squareoffvalue = 0                                              
              
  alter table mis.dbo.vmss_margin_shortage_sqoff_client_exp add exception varchar(10),remarks varchar(50), amount numeric,source_type varchar(10),IPADDRESS varchar(20),ENTERED_BY varchar(50)                                       
              
  /*                                                   
  update a                                              
  set source_type = 's3',a.amount = b.amount,                                              
  exemption ='y',remarks ='cheque in hand'                                              
  from  vmss_margin_shortage_sqoff_client_exp a inner join                                               
  tbl_voucherentry_mis_t  b                                              
  on a.client_code  = b.[client code]                                              
  */                                      
              
              
  update mis.dbo.vmss_margin_shortage_sqoff_client_exp                                              
  set source_type = 's1',amount=0,                                              
  exception ='N'                                              
  where source_type is null                                              
              
  update mis.dbo.vmss_margin_shortage_sqoff_client_exp                                               
  set exception ='Y',remarks ='without mobile and email'                                              
  where mobile_pager =''                             
  --and email =''                               
  /*                
  declare @vmssdata int,@clientdetail int,@vw_rms_client_vertical int,@ExceptionTableCount int                        
              
  select  @vw_rms_client_vertical=COUNT(1) from [csokyc-6].general.dbo.vw_rms_client_vertical                        
  select @clientdetail=COUNT(1) from [csokyc-6].general.dbo.client_details cli                        
  select @vmssdata=COUNT(1) from VMSS_data where convert(varchar(10),updatedon,120) = convert(varchar(10),GETDATE(),120) and noofdays> = 7 --+ @t_day                                              
  and squareoffvalue <> 0                         
  select @ExceptionTableCount=COUNT(1) from vmss_margin_shortage_sqoff_client_exp                        
              
  insert into ExceptionCount(vmssdata,clientdetail,vw_rms_client_vertical,ExceptionTableCount,UpdateDate) values(@vmssdata,@clientdetail,@vw_rms_client_vertical,@ExceptionTableCount,GETDATE())                         
  */           
    
 
               
 end try                                               
 begin catch                                                                                                    
  insert into general.DBO.EODBODDetail_Error(errtime,errobject,errline,errmessage)                                                                                                          
  select getdate(),'vmss_margin_shortage_squareoff_exception_process',error_line(),error_message()                                                               
  declare @errormessage nvarchar(4000);                                                                  
  select @errormessage = error_message() + convert(varchar(10),error_line());                                                                  
  raiserror (@errormessage , 16, 1);                                                   
 end catch                           
end                                                                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Margin_Shortage_SquareOff_Exception_Process_19122016
-- --------------------------------------------------


create procedure [dbo].[VMSS_Margin_Shortage_SquareOff_Exception_Process_19122016]                                            
as                         
begin                                                               
begin try                                          
            
  declare @alertdate datetime                                            
  select  @alertdate = (select max(processdate) from vmss_data)                                   
  --select @alertdate =  dateadd(d, -((datepart(weekday, getdate()) + 1 + @@datefirst) % 7), getdate())                                             
            
IF OBJECT_ID(N'mis.dbo.vmss_margin_shortage_sqoff_client_exp') IS NOT NULL                                                                
 drop table mis.dbo.vmss_margin_shortage_sqoff_client_exp                                      
  /*                   
  insert into mis.dbo.vmss_margin_shortage_sqoff_client_exp           
  (region,branch,sb,party_code,category,cli_type,sb_category,varmarginshortfall_aftadj,squareoffvalue,noofdays,update_date,mobile_pager,email,balance,holding_bhc,holding_ahc)                                            
  */  
  select b.region, b.branch, b.sb,c.party_code, b.category,b.cli_type ,                                             
  b.sb_category ,c.varmarginshortfall_aftadj,c.squareoffvalue,                                          
  c.noofdays,update_date=getdate(),                                          
  (rtrim(ltrim(cli.mobile_pager))) as mobile_pager,(rtrim(ltrim(cli.email)))  as email,                              
  balance,holding_bhc,holding_ahc       
  into mis.dbo.vmss_margin_shortage_sqoff_client_exp                                           
  from GENERAL.DBO.VMSS_data_combine c with (nolock)                                               
  inner join [csokyc-6].general.dbo.vw_rms_client_vertical b with (nolock) on b.client = c.party_code                                             
  inner join [csokyc-6].general.dbo.client_details cli with (nolock) on b.client = cli.party_code                                                  
  where convert(varchar(10),c.processDate,120) = convert(varchar(10),@alertdate,120) and                                      
  --abs(c.t_value) > 500                                            
  c.noofdays> = 3 --+ @t_day                                             
  and c.squareoffvalue <> 0                                             
            
  delete from mis.dbo.vmss_margin_shortage_sqoff_client_exp where squareoffvalue = 0                                            
            
  alter table mis.dbo.vmss_margin_shortage_sqoff_client_exp add exception varchar(10),remarks varchar(50), amount numeric,source_type varchar(10),IPADDRESS varchar(20),ENTERED_BY varchar(50)                                     
            
  /*                                                 
  update a                                            
  set source_type = 's3',a.amount = b.amount,                                            
  exemption ='y',remarks ='cheque in hand'                                            
  from  vmss_margin_shortage_sqoff_client_exp a inner join                                             
  tbl_voucherentry_mis_t  b                                            
  on a.client_code  = b.[client code]                                            
  */                                    
            
            
  update mis.dbo.vmss_margin_shortage_sqoff_client_exp                                            
  set source_type = 's1',amount=0,                                            
  exception ='N'                                            
  where source_type is null                                            
            
  update mis.dbo.vmss_margin_shortage_sqoff_client_exp                                             
  set exception ='Y',remarks ='without mobile and email'                                            
  where mobile_pager =''                           
  --and email =''                             
  /*              
  declare @vmssdata int,@clientdetail int,@vw_rms_client_vertical int,@ExceptionTableCount int                      
            
  select  @vw_rms_client_vertical=COUNT(1) from [csokyc-6].general.dbo.vw_rms_client_vertical                      
  select @clientdetail=COUNT(1) from [csokyc-6].general.dbo.client_details cli                      
  select @vmssdata=COUNT(1) from VMSS_data where convert(varchar(10),updatedon,120) = convert(varchar(10),GETDATE(),120) and noofdays> = 7 --+ @t_day                                            
  and squareoffvalue <> 0                       
  select @ExceptionTableCount=COUNT(1) from vmss_margin_shortage_sqoff_client_exp                      
            
  insert into ExceptionCount(vmssdata,clientdetail,vw_rms_client_vertical,ExceptionTableCount,UpdateDate) values(@vmssdata,@clientdetail,@vw_rms_client_vertical,@ExceptionTableCount,GETDATE())                       
  */         
             
 end try                                             
 begin catch                                                                                                  
  insert into general.DBO.EODBODDetail_Error(errtime,errobject,errline,errmessage)                                                                                                        
  select getdate(),'vmss_margin_shortage_squareoff_exception_process',error_line(),error_message()                                                             
  declare @errormessage nvarchar(4000);                                                                
  select @errormessage = error_message() + convert(varchar(10),error_line());                                                                
  raiserror (@errormessage , 16, 1);                                                 
 end catch                         
end                                                                  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Margin_Shortage_SquareOff_Exception_Process_20122016_regionwise
-- --------------------------------------------------
create procedure [dbo].[VMSS_Margin_Shortage_SquareOff_Exception_Process_20122016_regionwise]                                              
as                           
begin                                                                 
begin try                                            
              
  declare @alertdate datetime                                              
  select  @alertdate = (select max(processdate) from vmss_data)                                     
  --select @alertdate =  dateadd(d, -((datepart(weekday, getdate()) + 1 + @@datefirst) % 7), getdate())                                               
              
IF OBJECT_ID(N'mis.dbo.vmss_margin_shortage_sqoff_client_exp') IS NOT NULL                                                                  
 drop table mis.dbo.vmss_margin_shortage_sqoff_client_exp                                        
  /*                     
  insert into mis.dbo.vmss_margin_shortage_sqoff_client_exp             
  (region,branch,sb,party_code,category,cli_type,sb_category,varmarginshortfall_aftadj,squareoffvalue,noofdays,update_date,mobile_pager,email,balance,holding_bhc,holding_ahc)                                              
  */    
  select b.region, b.branch, b.sb,c.party_code, b.category,b.cli_type ,                                               
  b.sb_category ,c.varmarginshortfall_aftadj,c.squareoffvalue,                                            
  c.noofdays,update_date=getdate(),                                            
  (rtrim(ltrim(cli.mobile_pager))) as mobile_pager,(rtrim(ltrim(cli.email)))  as email,                                
  balance,holding_bhc,holding_ahc         
  into mis.dbo.vmss_margin_shortage_sqoff_client_exp                                             
  from GENERAL.DBO.VMSS_data_combine c with (nolock)  
                                                
  inner join [csokyc-6].general.dbo.vw_rms_client_vertical b with (nolock) on b.client = c.party_code                                               
  inner join [csokyc-6].general.dbo.client_details cli with (nolock) on b.client = cli.party_code                                                    
  where convert(varchar(10),c.processDate,120) = convert(varchar(10),@alertdate,120) and                                        
  --abs(c.t_value) > 500                                              
  c.noofdays> = 3 --+ @t_day                                               
  and c.squareoffvalue <> 0                                               
              
  delete from mis.dbo.vmss_margin_shortage_sqoff_client_exp where squareoffvalue = 0 
  
 SELECT DISTINCT region ,branch  into #deleteRegion FROM   mis.dbo.[vw_regionwise_vmss_data] with(nolock)
 
 delete from mis.dbo.vmss_margin_shortage_sqoff_client_exp where region in (select distinct region from  #deleteRegion where region <> 'Mumbai' )   
 delete from mis.dbo.vmss_margin_shortage_sqoff_client_exp where BRANCH  in (select distinct branch from  #deleteRegion where region = 'Mumbai')                                               
              
 alter table mis.dbo.vmss_margin_shortage_sqoff_client_exp add exception varchar(10),remarks varchar(50), amount numeric,source_type varchar(10),IPADDRESS varchar(20),ENTERED_BY varchar(50)                                       
              
  /*                                                   
  update a                                              
  set source_type = 's3',a.amount = b.amount,                                              
  exemption ='y',remarks ='cheque in hand'                                              
  from  vmss_margin_shortage_sqoff_client_exp a inner join                                               
  tbl_voucherentry_mis_t  b                                              
  on a.client_code  = b.[client code]                                              
  */                                      
              
              
  update mis.dbo.vmss_margin_shortage_sqoff_client_exp                                              
  set source_type = 's1',amount=0,                                              
  exception ='N'                                              
  where source_type is null                                              
              
  update mis.dbo.vmss_margin_shortage_sqoff_client_exp                                               
  set exception ='Y',remarks ='without mobile and email'                                              
  where mobile_pager =''                             
  --and email =''                               
  /*                
  declare @vmssdata int,@clientdetail int,@vw_rms_client_vertical int,@ExceptionTableCount int                        
              
  select  @vw_rms_client_vertical=COUNT(1) from [csokyc-6].general.dbo.vw_rms_client_vertical                        
  select @clientdetail=COUNT(1) from [csokyc-6].general.dbo.client_details cli                        
  select @vmssdata=COUNT(1) from VMSS_data where convert(varchar(10),updatedon,120) = convert(varchar(10),GETDATE(),120) and noofdays> = 7 --+ @t_day                                              
  and squareoffvalue <> 0                         
  select @ExceptionTableCount=COUNT(1) from vmss_margin_shortage_sqoff_client_exp                        
              
  insert into ExceptionCount(vmssdata,clientdetail,vw_rms_client_vertical,ExceptionTableCount,UpdateDate) values(@vmssdata,@clientdetail,@vw_rms_client_vertical,@ExceptionTableCount,GETDATE())                         
  */           
               
 end try                                               
 begin catch                                                                                                    
  insert into general.DBO.EODBODDetail_Error(errtime,errobject,errline,errmessage)                                                                                                          
  select getdate(),'vmss_margin_shortage_squareoff_exception_process',error_line(),error_message()                                                               
  declare @errormessage nvarchar(4000);                                                                  
  select @errormessage = error_message() + convert(varchar(10),error_line());                                                                  
  raiserror (@errormessage , 16, 1);                                                   
 end catch                           
end                                                                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Migration
-- --------------------------------------------------
CREATE Procedure VMSS_Migration    
as    
set nocount on    
BEGIN TRY     
    
  select party_code into #Pcode     
  from General.dbo.client_Details a join     
  (select * from VMSS_Region_migration_date where MigrationDate<=GETDATE()) b    
  on a.region=b.region    
    
  Truncate table VMSS_DP_Holding     
  insert into VMSS_DP_Holding (HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt,FromAcc,ToAcc,ToSegment)    
  select HoldDate,a.Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,id,AdjAmt,FromAcc,ToAcc,ToSegment    
  from MIS.dbo.VMSS_DP_Holding a with (nolock) join #pcode b on a.Party_code=b.party_code    
    
  Truncate table vmss_rms_holding     
  insert into vmss_rms_holding (isin,scrip_cd,series,sett_no,sett_type,party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,partyname,pool,total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty)    
  select isin,scrip_cd,series,sett_no,sett_type,a.party_Code,bs,exchange,qty,clsrate,accno,dpid,clid,flag,aben,apool,nben,npool,approved,scripname,partyname,pool,total,DUMMY1,DUMMY2,nse_approved,source,upd_date,AdjQty    
  from MIS.dbo.vmss_rms_holding a with (nolock) join #pcode b on a.Party_code=b.party_code    
    
  Truncate table VMSS_EarlyPayinData /* Not required */    
    
  Truncate table vmss_NRMS_Client_Collaterals     
  insert into vmss_NRMS_Client_Collaterals (co_code,EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,    
  FinalAmount,PercentageCash,PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,LoginTime,Cash_Ncash,    
  Group_Code,Fd_Bg_No,Bank_Code,Fd_Type)    
  select co_code,EffDate,Exchange,Segment,a.Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,FinalAmount,PercentageCash,PerecntageNonCash,    
  Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,LoginTime,Cash_Ncash,Group_Code,Fd_Bg_No,Bank_Code,Fd_Type    
  from MIS.dbo.vmss_NRMS_Client_Collaterals a with (nolock) join #pcode b on a.Party_code=b.party_code    
    
  Truncate table vmss_NonCash     
  insert into vmss_NonCash (id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,FinalAmount,FromAcc,ToAcc,    
  Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,MarginHC)    
  select ROW_NUMBER() OVER ( ORDER BY a.party_Code,scrip_cd ) AS id,co_code,EffDate,ProcessDate,a.Party_Code,Scrip_Cd,Series,Isin,Category,Qty,     
  Amount,HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,MarginHC     
  from MIS.dbo.vmss_NonCash a with (nolock) join #pcode b on a.Party_code=b.party_code    
    
  Truncate table VMSS_CollAdj    
  insert into VMSS_CollAdj (Co_code,Party_code,ISIN,Qty,UpdatedOn)    
  select Co_code,a.Party_code,ISIN,Qty,UpdatedOn    
  from MIS.dbo.VMSS_CollAdj a with (nolock) join #pcode b on a.Party_code=b.party_code    
    
  Truncate table VMSS_BSE_DelTrans    
  insert into VMSS_BSE_DelTrans (SNo,Sett_No,Sett_type,RefNo,TCode,TrType,Party_Code,scrip_cd,series,Qty,FromNo,ToNo,CertNo,FolioNo,    
  HolderName,Reason,DrCr,Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,SlipNo,BatchNo,ISett_No,ISett_Type,ShareType,    
  TransDate,Filler1,Filler2,Filler3,BDpType,BDpId,BCltDpId,Filler4,Filler5,Exchange,Segment,UpdatedOn)    
  select SNo,Sett_No,Sett_type,RefNo,TCode,TrType,a.Party_Code,scrip_cd,series,Qty,FromNo,ToNo,CertNo,FolioNo,HolderName,Reason,DrCr,    
  Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,SlipNo,BatchNo,ISett_No,ISett_Type,ShareType,TransDate,Filler1,Filler2,    
  Filler3,BDpType,BDpId,BCltDpId,Filler4,Filler5,Exchange,Segment,UpdatedOn    
  from MIS.dbo.VMSS_BSE_DelTrans a with (nolock) join #pcode b on a.Party_code=b.party_code    
    
  Truncate table VMSS_NSE_DelTrans    
  insert into VMSS_NSE_DelTrans (SNo,Sett_No,Sett_type,RefNo,TCode,TrType,Party_Code,scrip_cd,series,Qty,FromNo,ToNo,CertNo,FolioNo,    
  HolderName,Reason,DrCr,Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,SlipNo,BatchNo,ISett_No,ISett_Type,ShareType,    
  TransDate,Filler1,Filler2,Filler3,BDpType,BDpId,BCltDpId,Filler4,Filler5,Exchange,Segment,UpdatedOn)    
  select SNo,Sett_No,Sett_type,RefNo,TCode,TrType,a.Party_Code,scrip_cd,series,Qty,FromNo,ToNo,CertNo,FolioNo,HolderName,Reason,DrCr,    
  Delivered,OrgQty,DpType,DpId,CltDpId,BranchCd,PartipantCode,SlipNo,BatchNo,ISett_No,ISett_Type,ShareType,TransDate,Filler1,Filler2,    
  Filler3,BDpType,BDpId,BCltDpId,Filler4,Filler5,Exchange,Segment,UpdatedOn    
  from MIS.dbo.VMSS_NSE_DelTrans a with (nolock) join #pcode b on a.Party_code=b.party_code    
  
  delete a from  MIS.dbo.VMSS_NSE_DelTrans a join #pcode b on a.Party_code=b.party_code    
  delete a from  MIS.dbo.VMSS_BSE_DelTrans a join #pcode b on a.Party_code=b.party_code    
  delete a from  MIS.dbo.VMSS_CollAdj a join #pcode b on a.Party_code=b.party_code    
  delete a from  MIS.dbo.vmss_NonCash a join #pcode b on a.Party_code=b.party_code    
  delete a from  MIS.dbo.vmss_NRMS_Client_Collaterals a join #pcode b on a.Party_code=b.party_code    
  delete a from  MIS.dbo.vmss_rms_holding a join #pcode b on a.Party_code=b.party_code    
  delete a from  MIS.dbo.VMSS_DP_Holding a join #pcode b on a.Party_code=b.party_code    
    
End try                                     
BEGIN CATCH                                        
  insert into GENERAL.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                          
  select GETDATE(),'VMSS_Migration',ERROR_LINE(),ERROR_MESSAGE()                                                                               
              
  DECLARE @ErrorMessage NVARCHAR(4000);                                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                            
  RAISERROR (@ErrorMessage , 16, 1);                  
    
End catch         
    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_NonCashAdj
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_NonCashAdj]          
as          
                  
SET XACT_ABORT ON                  
Set nocount on                  
BEGIN TRY                                          

		declare @tdate datetime = (select Max(processDate) from VMSS_data)        


		update vmss_NonCash set Tosegment=b.DrSegment from VMSS_DrSegment b where vmss_NonCash.party_code=b.party_code          
		and  SquareOffQty > 0  and processDate = (select Max(processDate) from VMSS_data)          

		/************************************************************************/          
		update vmss_NonCash set toacc= case           
		when tosegment= 'NSECM' then '1203320000000051'          
		when tosegment= 'BSECM' then '1203320000000066'          
		ELSE '' END          
		where SquareOffQty > 0 and processDate = (select Max(processDate) from VMSS_data)          


		update vmss_NonCash set fromacc= case           
		when co_code= 'NSX' then '1203320000026363'          
		when co_code= 'MCD' then '1203320004025849'          
		ELSE '' END          
		where SquareOffQty > 0 and processDate =(select Max(processDate) from VMSS_data)          



		SELECT     
		PARTY_CODE,ISIN=CERTNO,SCRIP_CD,     
		SERIES=(CASE WHEN LEN(SERIES) > 2 THEN 'EQ' ELSE SERIES END),                      
		SEGMENT='BSECM',BDPID,BCLTDPID,QTY=SUM(QTY)    
		into #bsesegment    
		FROM angeldemat.bsedb.dbo.deltrans    
		WHERE BDPID LIKE '%' AND BCLTDPID LIKE '%' AND DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'    
		AND PARTY_CODE <> 'BROKER'    
		AND TRTYPE <> 906 AND CERTNO NOT LIKE 'AUCTION' AND CERTNO LIKE 'IN%' and bcltdpid  in ('1203320000026363','1203320004025849')  
		GROUP BY SCRIP_CD,SERIES,CERTNO, PARTY_CODE,BDPID,BCLTDPID    
		HAVING SUM(QTY) > 0    


		SELECT     
		PARTY_CODE,ISIN=CERTNO,SCRIP_CD,     
		SERIES=(CASE WHEN LEN(SERIES) > 2 THEN 'EQ' ELSE SERIES END),                      
		SEGMENT='NSECM',BDPID,BCLTDPID,QTY=SUM(QTY)    
		into #nsesegment  
		FROM angeldemat.msajag.dbo.deltrans    
		WHERE BDPID LIKE '%' AND BCLTDPID LIKE '%' AND DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'    
		AND PARTY_CODE <> 'BROKER'    
		AND TRTYPE <> 906 AND CERTNO NOT LIKE 'AUCTION' AND CERTNO LIKE 'IN%' and bcltdpid in ('1203320000026363','1203320004025849')  
		GROUP BY SCRIP_CD,SERIES,CERTNO, PARTY_CODE,BDPID,BCLTDPID    
		HAVING SUM(QTY) > 0    

		update vmss_NonCash set ToSegment='BSECM',toacc='1203320000000066' from   
		(select * from #bsesegment)b  
		where SquareOffQty > 0 and processDate =(select Max(processDate) from VMSS_data)  
		and vmss_NonCash.party_code=b.party_code and vmss_NonCash.isin=b.isin and co_code in ('NSX','MCD')   

		update vmss_NonCash set ToSegment='NSECM',toacc='1203320000000051' from   
		(select * from #nsesegment)b  
		where SquareOffQty > 0 and processDate =(select Max(processDate) from VMSS_data)  
		and vmss_NonCash.party_code=b.party_code and vmss_NonCash.isin=b.isin and co_code in ('NSX','MCD')   

           
		/*         
		update vmss_NonCash set fromacc=b.cltdpid  from           
		( select party_code,certno,          
		cltdpid=max(case when dptype='CDSL' then bcltdpid else bcltdpid end)          
		from angeldemat.msajag.dbo.deltrans           
		group by party_code,certno,cltdpid)b          
		where vmss_NonCash.party_code=b.party_code and vmss_NonCash.isin=b.certno           
		and SquareOffQty > 0 and processDate =@tdate          
		and co_code= 'nsefo' --and tosegment= 'NSECM'           


		update vmss_NonCash set fromacc=b.cltdpid  from           
		( select party_code,certno,          
		cltdpid=max(case when dptype='CDSL' then bcltdpid else bcltdpid end)          
		from angeldemat.bsedb.dbo.deltrans           
		group by party_code,certno,cltdpid)b          
		where vmss_NonCash.party_code=b.party_code and vmss_NonCash.isin=b.certno           
		and SquareOffQty > 0 and processDate =@tdate          
		and co_code= 'nsefo' --and tosegment= 'BSECM'      

		*/    
     
		SELECT     
		PARTY_CODE,ISIN=CERTNO,SCRIP_CD,     
		SERIES=(CASE WHEN LEN(SERIES) > 2 THEN 'EQ' ELSE SERIES END),                      
		SEGMENT='BSECM',BDPID,BCLTDPID,QTY=SUM(QTY)    
		into #bsecmcollateral                     
		FROM angeldemat.bsedb.dbo.deltrans    
		WHERE BDPID LIKE '%' AND BCLTDPID LIKE '%' AND DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'    
		AND PARTY_CODE <> 'BROKER'    
		AND TRTYPE <> 906 AND CERTNO NOT LIKE 'AUCTION' AND CERTNO LIKE 'IN%' and bcltdpid in ('1203320004574264','16921197')    
		GROUP BY SCRIP_CD,SERIES,CERTNO, PARTY_CODE,BDPID,BCLTDPID    
		HAVING SUM(QTY) > 0    
		--AND PARTY_CODE='s76686' AND CERTNO LIKE 'ine175%'    

		SELECT     
		PARTY_CODE,ISIN=CERTNO,SCRIP_CD,     
		SERIES=(CASE WHEN LEN(SERIES) > 2 THEN 'EQ' ELSE SERIES END),                      
		SEGMENT='NSECM',BDPID,BCLTDPID,QTY=SUM(QTY)    
		into #nsecmcollateral                     
		FROM angeldemat.msajag.dbo.deltrans    
		WHERE BDPID LIKE '%' AND BCLTDPID LIKE '%' AND DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'    
		AND PARTY_CODE <> 'BROKER'    
		AND TRTYPE <> 906 AND CERTNO NOT LIKE 'AUCTION' AND CERTNO LIKE 'IN%' and bcltdpid in ('1203320004574264','16921197')    
		GROUP BY SCRIP_CD,SERIES,CERTNO, PARTY_CODE,BDPID,BCLTDPID    
		HAVING SUM(QTY) > 0     
		--AND PARTY_CODE='s76686' AND CERTNO LIKE 'ine175%'    

		update vmss_NonCash set fromacc=b.bcltdpid,tosegment= 'BSECM',ToAcc='1203320000000066'   from           
		( select party_code,ISIN,bcltdpid from #bsecmcollateral )b          
		where vmss_NonCash.party_code=b.party_code and vmss_NonCash.isin=b.isin           
		and SquareOffQty > 0 and processDate  = (select Max(processDate) from VMSS_data)          
		and co_code= 'nsefo' --and tosegment= 'NSECM'     

		update vmss_NonCash set fromacc=b.bcltdpid,tosegment= 'NSECM',ToAcc='1203320000000051'   from           
		( select party_code,ISIN,bcltdpid from #nsecmcollateral )b          
		where vmss_NonCash.party_code=b.party_code and vmss_NonCash.isin=b.isin           
		and SquareOffQty > 0 and processDate  = (select Max(processDate) from VMSS_data)          
		and co_code= 'nsefo' --and tosegment= 'NSECM'     
            
		insert into vmss_NonCash_hist(id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,MarginHC)            
		select id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,AdjAmt,MarginSqOffQty,MarginHC from vmss_NonCash          
          
	End try                                       
	BEGIN CATCH                                          
		insert into GENERAL.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                 
		select GETDATE(),'VMSS_NonCashAdj',ERROR_LINE(),ERROR_MESSAGE()                                                
		
		DECLARE @ErrorMessage NVARCHAR(4000);                                            
		SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                            
		RAISERROR (@ErrorMessage , 16, 1);                  

	End catch                   
                  
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_NonCashfileemail
-- --------------------------------------------------

CREATE Procedure [dbo].[VMSS_NonCashfileemail]                            
as                            
begin                        
set nocount on        
 BEGIN TRY                                                              
  
  truncate table VMSS_JV_collateral_file                
  truncate table VMSS_JVCollateral_file                
  
  select party_code,scrip_cd,series,isin,SquareOffQty as qty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                             
  when len(fromacc)<16 then 'IN301549' else ''  end,                            
  fromacc,                            
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                             
  when len(toacc)<16 then 'IN301549' else ''  end,                            
  toacc,type1='BTM',TOSEGMENT INTO #JVDATA                            
  from vmss_NonCash where SquareOffQty > 0                             
  and processDate =(select Max(processDate) from VMSS_data)                            
  AND TOSEGMENT='BSECM' and co_code in ('NSX','MCD')            
  
  
  INSERT INTO #JVDATA                            
  select party_code,scrip_cd,series,isin,SquareOffQty as qty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                             
  when len(fromacc)<16 then 'IN301549' else ''  end,                            
  fromacc,                            
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                             
  when len(toacc)<16 then 'IN301549' else ''  end,                            
  toacc,type1='BTM',TOSEGMENT from vmss_NonCash where SquareOffQty > 0                             
  and processDate =(select Max(processDate) from VMSS_data)                            
  AND TOSEGMENT='NSECM' and co_code in ('NSX','MCD')                      
  
  SELECT               
  PARTY_CODE,ISIN=CERTNO,SCRIP_CD,               
  SERIES=(CASE WHEN LEN(SERIES) > 2 THEN 'EQ' ELSE SERIES END),                                
  SEGMENT='BSECM',BDPID,BCLTDPID,QTY=SUM(QTY)              
  into #bsesegment                             
  FROM angeldemat.bsedb.dbo.deltrans              
  WHERE BDPID LIKE '%' AND BCLTDPID LIKE '%' AND DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'              
  AND PARTY_CODE <> 'BROKER'              
  AND TRTYPE <> 906 AND CERTNO NOT LIKE 'AUCTION' AND CERTNO LIKE 'IN%' and bcltdpid in ('1203320004574264','16921197')              
  GROUP BY SCRIP_CD,SERIES,CERTNO, PARTY_CODE,BDPID,BCLTDPID              
  HAVING SUM(QTY) > 0              
  
  --AND PARTY_CODE='s76686' AND CERTNO LIKE 'ine175%'              
  
  SELECT               
  PARTY_CODE,ISIN=CERTNO,SCRIP_CD,               
  SERIES=(CASE WHEN LEN(SERIES) > 2 THEN 'EQ' ELSE SERIES END),                                
  SEGMENT='NSECM',BDPID,BCLTDPID,QTY=SUM(QTY)              
  into #nsesegment                              
  FROM angeldemat.msajag.dbo.deltrans              
  WHERE BDPID LIKE '%' AND BCLTDPID LIKE '%' AND DRCR = 'D' AND FILLER2 = 1 AND DELIVERED = '0'              
  AND PARTY_CODE <> 'BROKER'              
  AND TRTYPE <> 906 AND CERTNO NOT LIKE 'AUCTION' AND CERTNO LIKE 'IN%' and bcltdpid in ('1203320004574264','16921197')              
  GROUP BY SCRIP_CD,SERIES,CERTNO, PARTY_CODE,BDPID,BCLTDPID              
  HAVING SUM(QTY) > 0               
  
  select x.*,dpqty=y.QTY,            
  balanceqty=case             
  when x.qty>=isnull(y.QTY,0) and isnull(y.QTY,0) <>0 then x.qty-y.QTY             
  when  isnull(y.QTY,0) =0 then 0 else x.qty  end,            
  BDPID,BCLTDPID            
  into #fo_nsecm            
  from             
  (select party_code,scrip_cd,series,isin,SquareOffQty as qty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                             
  when len(fromacc)<16 then 'IN301549' else ''  end,                            
  fromacc,                            
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                             
  when len(toacc)<16 then 'IN301549' else ''  end,                            
  toacc,type1='BTM',TOSEGMENT              
  from vmss_NonCash  where SquareOffQty > 0  and processDate =(select Max(processDate) from VMSS_data)             
  and co_code='nsefo' and ToSegment='NSECM')x left outer join #nsesegment y on x.party_code=y.party_code and x.isin=y.isin            

  select x.*,dpqty=y.QTY,            
  balanceqty=case             
  when x.qty>=isnull(y.QTY,0) and isnull(y.QTY,0) <>0 then x.qty-y.QTY             
  when  isnull(y.QTY,0) =0 then 0 else x.qty  end,            
  BDPID,BCLTDPID into #fo_bsecm            
  from             
  (select party_code,scrip_cd,series,isin,SquareOffQty as qty,fromdpid=case when len(fromacc)=16 then substring(fromacc,0,9)                             
  when len(fromacc)<16 then 'IN301549' else ''  end,                            
  fromacc,                            
  todpid=case when len(toacc)=16 then substring(toacc,0,9)                             
  when len(toacc)<16 then 'IN301549' else ''  end,                            
  toacc,type1='BTM',TOSEGMENT              
  from vmss_NonCash  where SquareOffQty > 0  and processDate =(select Max(processDate) from VMSS_data)             
  and co_code='nsefo' and ToSegment='BSECM')x left outer join #bsesegment y on x.party_code=y.party_code and x.isin=y.isin            
  
  select party_code,scrip_cd,series,isin,qty=max(qty),fromdpid,fromacc,todpid,toacc,type1,TOSEGMENT,dpqty=SUM(dpqty)            
  into #split            
  from #fo_nsecm  where exists            
  (select * from (select Party_Code,Isin,qty,ToSegment,cnt=count(Party_Code) from #fo_nsecm group by Party_Code,Isin,qty,ToSegment            
  having count(Party_Code)>1 )x where #fo_nsecm.Party_Code=x.Party_Code and #fo_nsecm.Isin=x.Isin and #fo_nsecm.qty=x.qty            
  and #fo_nsecm.ToSegment=x.ToSegment)            
  group by party_code,scrip_cd,series,isin,fromdpid,fromacc,todpid,toacc,type1,TOSEGMENT            
  
  delete from #fo_nsecm where exists            
  (select * from #split x             
  where qty<=dpqty and #fo_nsecm.Party_Code=x.Party_Code and #fo_nsecm.Isin=x.Isin and #fo_nsecm.qty=x.qty)            
  and bcltdpid='16921197'            
  
  select party_code,scrip_cd,series,isin,qty=max(qty),fromdpid,fromacc,todpid,toacc,type1,TOSEGMENT,dpqty=SUM(dpqty)            
  into #splitbsecm            
  from #fo_bsecm  where exists            
  (select * from (select Party_Code,Isin,qty,ToSegment,cnt=count(Party_Code) from #fo_bsecm group by Party_Code,Isin,qty,ToSegment            
  having count(Party_Code)>1 )x where #fo_bsecm.Party_Code=x.Party_Code and #fo_bsecm.Isin=x.Isin and #fo_bsecm.qty=x.qty            
  and #fo_bsecm.ToSegment=x.ToSegment)            
  group by party_code,scrip_cd,series,isin,fromdpid,fromacc,todpid,toacc,type1,TOSEGMENT            
  
  delete from #fo_bsecm where exists            
  (select * from #splitbsecm x             
  where qty<=dpqty and #fo_bsecm.Party_Code=x.Party_Code and #fo_bsecm.Isin=x.Isin and #fo_bsecm.qty=x.qty)            
  and bcltdpid='16921197'            
  
  insert into #JVDATA            
  select party_code,scrip_cd,series,isin,qty=case when qty<=dpqty then qty else dpqty end,            
  fromdpid,fromacc,todpid,toacc,type1,TOSEGMENT from #fo_nsecm --where Party_Code='bhil563'            
  
  insert into #JVDATA            
  select party_code,scrip_cd,series,isin,qty=case when qty<=dpqty then qty else dpqty end,            
  fromdpid,fromacc,todpid,toacc,type1,TOSEGMENT from #fo_bsecm             
  
  delete from #fo_nsecm where balanceqty=0            
  delete from #fo_bsecm where balanceqty=0     
  
  select x.party_code,x.scrip_cd,x.series,x.isin,
  (Case when x.qty > y.qty then y.qty else x.qty end) as Qty,
  /*x.qty, x.fromdpid,x.fromacc, */
  isnull(y.BDPID,x.fromdpid) as fromdpid, isnull(y.BCLTDPID,x.fromacc) as fromacc,
  '12033200' as todpid,toacc='1203320000000066',type1,TOSEGMENT='BSECM',            
  dpqty=y.QTY,            
  balanceqty=case             
  when x.qty>isnull(y.QTY,0) and isnull(y.QTY,0) <>0 then y.QTY             
  when  isnull(y.QTY,0) =0 then 0 else x.qty  end into #fo_nsecmpartial            
  from             
  (select party_code,scrip_cd,series,isin,qty=balanceqty,fromdpid,fromacc,todpid,toacc,type1,TOSEGMENT 
  from #fo_nsecm where balanceqty<>qty 
  )x left outer join 
  #bsesegment y on x.party_code=y.party_code and x.isin=y.isin            

  delete from #fo_nsecmpartial where balanceqty=0            
  
  update x set fromdpid=y.bdpid,fromacc=y.bcltdpid             
  from #fo_nsecmpartial x,  #bsesegment y where x.Party_Code=y.party_code and x.Isin=y.ISIN and x.dpqty=y.QTY            
  
  select x.party_code,x.scrip_cd,x.series,x.isin,/* x.qty,x.fromdpid,x.fromacc, */
  (Case when x.qty > y.qty then y.qty else x.qty end) as Qty,
  isnull(y.BDPID,x.fromdpid) as fromdpid, isnull(y.BCLTDPID,x.fromacc) as fromacc,
  '12033200' as todpid,toacc='1203320000000051',type1,TOSEGMENT='NSECM',            
  dpqty=y.QTY,            
  balanceqty=case             
  when x.qty>isnull(y.QTY,0) and isnull(y.QTY,0) <>0 then y.QTY             
  when  isnull(y.QTY,0) =0 then 0 else x.qty  end  into #fo_bsecmpartial            
  from             
  (select party_code,scrip_cd,series,isin,qty=balanceqty,fromdpid,fromacc,todpid,toacc,type1,TOSEGMENT 
  from #fo_bsecm where balanceqty<>qty            
  )x left outer join #nsesegment y on x.party_code=y.party_code and x.isin=y.isin            
  
  delete from #fo_bsecmpartial where balanceqty=0            
  
  update x set fromdpid=y.bdpid,fromacc=y.bcltdpid             
  from #fo_bsecmpartial x,  #nsesegment y where x.Party_Code=y.party_code and x.Isin=y.ISIN and x.dpqty=y.QTY            
  
  insert into #JVDATA            
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,TOSEGMENT from #fo_nsecmpartial             
  
  insert into #JVDATA            
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,TOSEGMENT from #fo_bsecmpartial             
  
  UPDATE #JVDATA SET SCRIP_CD=B.BSECODE,series='BSE' FROM                             
  (SELECT * FROM General.dbo.SCRIP_MASTER)B                            
  WHERE B.ISIN=#JVDATA.ISIN AND #JVDATA.TOSEGMENT='BSECM'                            
  
  insert into VMSS_JVCollateral_file                           
  select party_code,scrip_cd,series,isin,qty,fromdpid,fromacc,todpid,toacc,type1,tosegment                          
  from #JVDATA                          
  
  select ROW_NUMBER() OVER(ORDER BY party_code ASC)sr,* into #JVDATAFILE from #JVDATA                         
  
  DECLARE @file1 AS VARCHAR(100)                              
  DECLARE @file2 AS VARCHAR(100)                             
  DECLARE @i AS INT                              
  DECLARE @str VARCHAR(8000)                             
  declare @segment varchar(10)                        
  
  SELECT ID = ROW_NUMBER() OVER(ORDER BY LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))ASC),                             
  DATA =LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))                             
  +','+LTRIM(RTRIM(scrip_cd))+','+LTRIM(RTRIM (CONVERT(VARCHAR,series)))+ ','                              
  +LTRIM(RTRIM(CONVERT(VARCHAR,isin)))+','+ LTRIM(RTRIM (CONVERT(VARCHAR,qty)))+ ','                         
  +(LTRIM(RTRIM(fromdpid)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,todpid)))+','                        
  +LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+','+LTRIM(RTRIM(CONVERT(VARCHAR,type1)))                             
  INTO  #VMSS_JVCEColl_tblfile_bse                              
  FROM #JVDATAFILE x                              
  WHERE tosegment = 'BSECM'                              
  ORDER BY sr ASC           
  
  insert into VMSS_JV_collateral_file(FldData,SEGMENT)                        
  select DATA ,'BSECM' from #VMSS_JVCEColl_tblfile_bse                        
  SET @file1 = (SELECT 'VMSS_T4_JV_Collateral_GeneratedFile_'+'BSECM'+'_'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','')+ '.csv')                           
  
  DECLARE @SQL VARCHAR(MAX)                              
  SET @SQL = ''                              
  SET @SQL = ' bcp " SELECT flddata FROM [CSOKYC-6].squareoff.dbo.VMSS_JV_collateral_file WHERE SEGMENT=''''BSECM'''''                         
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @file1 + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc ' */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @file1 + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '          
  SET @SQL = '''' + @SQL + ''''                              
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                              
  /* PRINT @SQL */
  EXEC (@SQL)                 
  
  SELECT ID = ROW_NUMBER() OVER(ORDER BY LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))ASC),                             
  DATA =LTRIM(RTRIM(CONVERT(VARCHAR,party_code)))                       
  +','+LTRIM(RTRIM(scrip_cd))+','+LTRIM(RTRIM (CONVERT(VARCHAR,series)))+ ','                              
  +LTRIM(RTRIM(CONVERT(VARCHAR,isin)))+','+ LTRIM(RTRIM (CONVERT(VARCHAR,qty)))+ ','                         
  +(LTRIM(RTRIM(fromdpid)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,fromacc)))+ ',' +LTRIM(RTRIM(CONVERT(VARCHAR,todpid)))+','                        
  +LTRIM(RTRIM(CONVERT(VARCHAR,toacc)))+','+LTRIM(RTRIM(CONVERT(VARCHAR,type1)))                             
  INTO  #VMSS_JVCEColl_tblfile_nse                              
  FROM #JVDATAFILE x                              
  WHERE tosegment = 'NSECM'                              
  ORDER BY sr ASC                        
  
  SET @file2=''                        
  SET @file2 = (SELECT 'VMSS_T4_JV_Collateral_GeneratedFile_'+'NSECM'+'_'+REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','')+ '.csv')                           
  
  insert into VMSS_JV_collateral_file(FldData,SEGMENT)                        
  select DATA,'NSECM' from #VMSS_JVCEColl_tblfile_nse                        
  
  SET @SQL = ''                              
  SET @SQL = ' bcp " SELECT flddata FROM [CSOKYC-6].squareoff.dbo.VMSS_JV_collateral_file WHERE SEGMENT=''''NSECM'''''                              
  /*SET @SQL = @SQL + ' " queryout d:\MindGate\UploadJVCollateral\' + @file2 + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc ' */
  SET @SQL = @SQL + ' " queryout H:\MindGate\UploadJVCollateral\' + @file2 + ' -c -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '                                 
  SET @SQL = '''' + @SQL + ''''                              
  SET @SQL = 'EXEC MASTER.DBO.XP_CMDSHELL '+ @SQL                              
  
  --PRINT @SQL                              
  EXEC (@SQL)                        
  DECLARE @filename1 as varchar(100),@filename2 as varchar(100)                           
  /*
  select @filename1='d:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_Collateral_GeneratedFile_' + 'BSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'                                               
  select @filename2='d:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_Collateral_GeneratedFile_' + 'NSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'                           
  */
  
  select @filename1='H:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_Collateral_GeneratedFile_' + 'BSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'                                               
  select @filename2='H:\MindGate\UploadJVCollateral\'+'VMSS_T4_JV_Collateral_GeneratedFile_' + 'NSECM'+ '_' + REPLACE(CONVERT(VARCHAR(11),GETDATE(),103),'/','') +'.csv'                           

  print @filename1                        
  
  SET @SQL = 'Dear Team,<br/><br/>'                              
  SET @SQL = @SQL + 'Kindly upload the attached Collateral JV dated (' + CONVERT(VARCHAR(10),GETDATE(),103) + ') pertaining to var margin Square off Module.'                              
  SET @SQL = @SQL + '<br/><br/>Kindly revert incase there is discrepancy related to control A/C.'                              
  
  DECLARE @s varchar(500)                                        
  SET @s = @filename1 + ';' + @filename2                             
  
  EXEC msdb.dbo.sp_send_dbmail                              
  @profile_name = 'Square',                           
  @recipients= 'csorm@angelbroking.com;vishal@angelbroking.com;anil.wandre@angelbroking.com;darshit.kapadia@angelbroking.com',                              
  @copy_recipients= '',                              
  /* @blind_copy_recipients= @BCC, */              
  @body= @SQL,                              
  @file_attachments= @s,                              
  @body_format= 'HTML',                              
  @subject='VMSS (T+3) - Collateral movement : Var Margin Square Off'                         
 End try                                                   
 BEGIN CATCH                                                      
  insert into GENERAL.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                            
  select GETDATE(),'VMSS_NonCashfileemail',ERROR_LINE(),ERROR_MESSAGE()                                                            
  DECLARE @ErrorMessage NVARCHAR(4000);                                                    
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
  RAISERROR (@ErrorMessage , 16, 1);                          
 End catch                               
  
set nocount off        
  
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_NoOfDays_Calculation
-- --------------------------------------------------
CREATE PROC [dbo].[VMSS_NoOfDays_Calculation]                              
as                              
          
SET XACT_ABORT ON                    
Set nocount on                                                              
 BEGIN TRY                                
  
  Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                
            
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))                                
  select * into #file2 from vmss_Data with (nolock) where processdate=@tdate                               
            
  Update #File2 set NoofDays=1                              
            
  UPDATE #File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                                          
  (                                                                
  SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                           
  (                                     
  SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                                                                                           
  WHERE CONVERT(DATE,processdate) <= (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data where processdate < @tdate )                                                                 
  )                                                                                          
  ) B WHERE #File2.party_code=B.party_code                                                                                           
            
  UPDATE #File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdjCurrDay >= @LowerCapAmt                                                                
            
  UPDATE #File2 SET NOOFDAYS=0 where  party_Code not in (select party_Code from VMSS_ASB7_Days)        
      
  UPDATE #File2 SET NOOFDAYS=0 where  SquareOffValue=0     ---added for 10391296    
             
  select Processdate,Party_code,NoofDays,Day1Date,region,(                          
  Case                           
  when Day1Date=processDate and NoofDays > 1 then 1                           
  when Day1Date > processDate and NoofDays >= 1 then 0                          
  else NoofDays end) as NOD into #NOD                          
  from #file2 a join                          
  (select client,Day1Date,x.region from General.dbo.Vw_RMS_Client_Vertical x join VMSS_Region_Activation y on x.Region=y.Region) b                          
  on a.party_code=b.Client and a.NoOfDays>=1                          
            
  update #File2 set NoofDays=x.NOD from #NOD x where #File2.partY_code=x.party_Code and #File2.processdate=x.processDate                          
            
  update vmss_Data set NOOFDAYS=b.NOOFDAYS from #File2 b where vmss_Data.processdate=@tdate and vmss_Data.party_Code=b.party_code      
      
  /* Update noofdays according to ageing days with new logic as suggested by Renil sir & Vishal Gohil*/    
  declare @ageingDate varchar(20)   
  select @ageingDate=max(cast(updatedon as date)) from vmss_data  
   
  Update a set noofdays=1 from vmss_data a,(select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b    
  where a.party_code=b.party_code and b.ageing_day=5  and a.processdate=@tdate and a.squareoffvalue>0.00  
      
  Update a set noofdays=2 from vmss_data a, (select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b    
  where a.party_code=b.party_code and b.ageing_day=6  and a.processdate=@tdate and a.squareoffvalue>0.00  
      
  Update a set noofdays=3 from vmss_data a, (select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b    
 where a.party_code=b.party_code and b.ageing_day>=7  and a.processdate=@tdate and a.squareoffvalue>0.00  
 
 /* ageing data where ageing day>5*/
 select party_code,ageing_day into #ageingDay from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where ageing_day>5  
 
 /*Current day ageing data*/
 select A.party_code,noofdays,squareoffvalue,B.ageing_day into #vmssCurrDay from vmss_data A inner join #ageingDay B 
 on A.party_code=B.party_code where updatedOn=(select max(updatedon) from vmss_data) and squareoffvalue>0 
 
  /*previous day ageing data*/
  Declare @prevtdate as datetime     
  SELECT @prevtdate=CONVERT(DATE,MAX(updatedon)) FROM VMSS_data where updatedon < (select MAX(updatedon) from vmss_Data with (nolock))    
  
  select  A.party_code,noofdays,squareoffvalue  into   #vmssPreviousDay  from vmss_data A 
  where cast(updatedOn as date)=@prevtdate  and squareoffvalue=0 
  
   /*Added on Aug 26 2016 as reuired by Vishal Gohil mail dated Aug 24 2016*/
  select  A.party_code,noofdays,squareoffvalue  into  #vmssPreviousDay1  from vmss_Data A   
  where cast(updatedOn as date)=@prevtdate  and squareoffvalue>0 and noofdays>0 
 
 /* comparison between current and previos day data*/
 select A.party_code,A.Noofdays,CurrSqValue=A.squareoffvalue,PrevSqValue=B.squareoffvalue into #final from #vmssCurrDay A inner join #vmssPreviousDay B  on A.party_code=B.party_code
 
 Update vmss_data set noofdays=2 where party_code in(select party_code from #final) 
 and cast(updatedOn as date)=(select max(cast(updatedOn as date)) from vmss_data) and squareoffvalue>0 
 
 /*Added on Aug 26 2016 as reuired by Vishal Gohil mail dated Aug 24 2016*/
 select * into #FirstTimeinVMSS from vmss_data where    noofdays=3 and updatedOn=(select max(updatedon) from vmss_Data) and party_code not in(select Party_code from #vmssPreviousDay) 
 and party_code not in(select party_code from #vmssPreviousDay1)-- and party_code='M33997'
 
 Update vmss_Data set noofdays=2 where party_code in(select party_code from #FirstTimeinVMSS)   
 and cast(updatedOn as date)=(select max(cast(updatedOn as date)) from vmss_Data) and squareoffvalue>0  
 

 End try                                                                                   
 BEGIN CATCH                                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                            
  select GETDATE(),'VMSS_NoOfDays_Calculation',ERROR_LINE(),ERROR_MESSAGE()                                                 
            
  DECLARE @ErrorMessage NVARCHAR(4000);                                                    
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
  RAISERROR (@ErrorMessage , 16, 1);                          
 End catch                                                       
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_NoOfDays_Calculation_02082016
-- --------------------------------------------------
CREATE PROC [dbo].[VMSS_NoOfDays_Calculation_02082016]                            
as                            
        
SET XACT_ABORT ON                  
Set nocount on                                                            
 BEGIN TRY                              
      
    
      
  Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                              
          
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))                              
  select * into #file2 from vmss_Data with (nolock) where processdate=@tdate                             
          
  Update #File2 set NoofDays=1                            
          
  UPDATE #File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                                        
  (                                                              
  SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                         
  (                                   
  SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                                                                                         
  WHERE CONVERT(DATE,processdate) <= (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data where processdate < @tdate )                                                               
  )                                                                                        
  ) B WHERE #File2.party_code=B.party_code                                                                                         
          
  UPDATE #File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdjCurrDay >= @LowerCapAmt                                                              
          
  UPDATE #File2 SET NOOFDAYS=0 where  party_Code not in (select party_Code from VMSS_ASB7_Days)      
    
  UPDATE #File2 SET NOOFDAYS=0 where  SquareOffValue=0     ---added for 10391296  
           
  select Processdate,Party_code,NoofDays,Day1Date,region,(                        
  Case                         
  when Day1Date=processDate and NoofDays > 1 then 1                         
  when Day1Date > processDate and NoofDays >= 1 then 0                        
  else NoofDays end) as NOD into #NOD                        
  from #file2 a join                        
  (select client,Day1Date,x.region from General.dbo.Vw_RMS_Client_Vertical x join VMSS_Region_Activation y on x.Region=y.Region) b                        
  on a.party_code=b.Client and a.NoOfDays>=1                        
          
  update #File2 set NoofDays=x.NOD from #NOD x where #File2.partY_code=x.party_Code and #File2.processdate=x.processDate                        
          
  update vmss_Data set NOOFDAYS=b.NOOFDAYS from #File2 b where vmss_Data.processdate=@tdate and vmss_Data.party_Code=b.party_code    
  /*10391296*/  
  select party_code,ageing_day into #tempAgeinG  from MIS.dbo.Tbl_ASB7_Ageing_Debit_Days where ageing_day>7       
  Declare @tdate1 as date = (select MAX(updatedon-1) from vmss_Data with (nolock))      
   
  select A.party_code ,noofdays,squareoffvalue ,B.ageing_day,A.processdate,A.updatedon     
  into #PreviousDayTemp     
  from vmss_data A inner join #tempAgeinG B on A.party_code=B.party_code     
  where cast(updatedon as date)=@tdate1                          
  and squareoffvalue>0.00    
      
  select A.party_code ,noofdays,squareoffvalue ,B.ageing_day ,A.processdate,A.updatedon     
  into #CurrDayTemp     
  from vmss_data A inner join #tempAgeinG B on A.party_code=B.party_code     
  where cast(updatedon as date)=(select max(cast(updatedon as date)) from vmss_data) and (A.noofdays between 0 and 1)                           
  and squareoffvalue>0.00    
    
  select A.party_code ,A.noofdays,A.squareoffvalue ,A.ageing_day ,A.processdate,A.updatedon  into #CommonTemp    
  from #CurrDayTemp A inner join #PreviousDayTemp B on A.party_code=B.party_code      
     
  update vmss_data set noofdays= 2    
  where party_code in(select party_code from #CurrDayTemp) and party_code not in (select party_code from #CommonTemp) and cast(updatedon as date)=(select max(cast(updatedon as date))  from vmss_data)    
                              
                             
 End try                                                                                 
 BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'VMSS_NoOfDays_Calculation',ERROR_LINE(),ERROR_MESSAGE()                                               
          
  DECLARE @ErrorMessage NVARCHAR(4000);                                                  
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
 End catch                                                     
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_NoOfDays_Calculation_03082016
-- --------------------------------------------------
CREATE PROC [dbo].[VMSS_NoOfDays_Calculation_03082016]                              
as                              
          
SET XACT_ABORT ON                    
Set nocount on                                                              
 BEGIN TRY                                
  
  Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                
            
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))                                
  select * into #file2 from vmss_Data with (nolock) where processdate=@tdate                               
            
  Update #File2 set NoofDays=1                              
            
  UPDATE #File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                                          
  (                                                                
  SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                           
  (                                     
  SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                                                                                           
  WHERE CONVERT(DATE,processdate) <= (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data where processdate < @tdate )                                                                 
  )                                                                                          
  ) B WHERE #File2.party_code=B.party_code                                                                                           
            
  UPDATE #File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdjCurrDay >= @LowerCapAmt                                                                
            
  UPDATE #File2 SET NOOFDAYS=0 where  party_Code not in (select party_Code from VMSS_ASB7_Days)        
      
  UPDATE #File2 SET NOOFDAYS=0 where  SquareOffValue=0     ---added for 10391296    
             
  select Processdate,Party_code,NoofDays,Day1Date,region,(                          
  Case                           
  when Day1Date=processDate and NoofDays > 1 then 1                           
  when Day1Date > processDate and NoofDays >= 1 then 0                          
  else NoofDays end) as NOD into #NOD                          
  from #file2 a join                          
  (select client,Day1Date,x.region from General.dbo.Vw_RMS_Client_Vertical x join VMSS_Region_Activation y on x.Region=y.Region) b                          
  on a.party_code=b.Client and a.NoOfDays>=1                          
            
  update #File2 set NoofDays=x.NOD from #NOD x where #File2.partY_code=x.party_Code and #File2.processdate=x.processDate                          
            
  update vmss_Data set NOOFDAYS=b.NOOFDAYS from #File2 b where vmss_Data.processdate=@tdate and vmss_Data.party_Code=b.party_code      
      
  /* Update noofdays according to ageing days with new logic as suggested by Renil sir & Vishal Gohil*/    
  declare @ageingDate varchar(20)   
  select @ageingDate=max(cast(updatedon as date)) from vmss_data  
   
  Update a set noofdays=1 from vmss_data a,(select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b    
  where a.party_code=b.party_code and b.ageing_day=5  and a.processdate=@tdate and a.squareoffvalue>0.00  
      
  Update a set noofdays=2 from vmss_data a, (select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b    
  where a.party_code=b.party_code and b.ageing_day=6  and a.processdate=@tdate and a.squareoffvalue>0.00  
      
  Update a set noofdays=3 from vmss_data a, (select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b    
 where a.party_code=b.party_code and b.ageing_day>=7  and a.processdate=@tdate and a.squareoffvalue>0.00  
      
  /* To update noofdays as 2 for clients with ageing>8 and in var shortage 10391296*/    
  select party_code,ageing_day into #tempAgeinG  from MIS.dbo.Tbl_ASB7_Ageing_Debit_Days where ageing_day>7         
  Declare @tdate1 as date = (select MAX(updatedon-1) from vmss_Data with (nolock))        
     
  select A.party_code ,noofdays,squareoffvalue ,B.ageing_day,A.processdate,A.updatedon       
  into #PreviousDayTemp       
  from vmss_data A inner join #tempAgeinG B on A.party_code=B.party_code       
  where cast(updatedon as date)=@tdate1                            
  and squareoffvalue>0.00      
        
  select A.party_code ,noofdays,squareoffvalue ,B.ageing_day ,A.processdate,A.updatedon       
  into #CurrDayTemp       
  from vmss_data A inner join #tempAgeinG B on A.party_code=B.party_code       
  where cast(updatedon as date)=(select max(cast(updatedon as date)) from vmss_data) and (A.noofdays between 0 and 1)                             
  and squareoffvalue>0.00      
      
  select A.party_code ,A.noofdays,A.squareoffvalue ,A.ageing_day ,A.processdate,A.updatedon  into #CommonTemp      
  from #CurrDayTemp A inner join #PreviousDayTemp B on A.party_code=B.party_code        
       
  update vmss_data set noofdays= 2      
  where party_code in(select party_code from #CurrDayTemp) and party_code not in (select party_code from #CommonTemp) and cast(updatedon as date)=(select max(cast(updatedon as date))  from vmss_data)      
                                
                               
 End try                                                                                   
 BEGIN CATCH                                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                            
  select GETDATE(),'VMSS_NoOfDays_Calculation',ERROR_LINE(),ERROR_MESSAGE()                                                 
            
  DECLARE @ErrorMessage NVARCHAR(4000);                                                    
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
  RAISERROR (@ErrorMessage , 16, 1);                          
 End catch                                                       
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_NoOfDays_Calculation_03082016_live
-- --------------------------------------------------
create PROC [dbo].[VMSS_NoOfDays_Calculation_03082016_live]                            
as                            
        
SET XACT_ABORT ON                  
Set nocount on                                                            
 BEGIN TRY                              

  Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                              
          
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))                              
  select * into #file2 from vmss_Data with (nolock) where processdate=@tdate                             
          
  Update #File2 set NoofDays=1                            
          
  UPDATE #File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                                        
  (                                                              
  SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                         
  (                                   
  SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                                                                                         
  WHERE CONVERT(DATE,processdate) <= (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data where processdate < @tdate )                                                               
  )                                                                                        
  ) B WHERE #File2.party_code=B.party_code                                                                                         
          
  UPDATE #File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdjCurrDay >= @LowerCapAmt                                                              
          
  UPDATE #File2 SET NOOFDAYS=0 where  party_Code not in (select party_Code from VMSS_ASB7_Days)      
    
  UPDATE #File2 SET NOOFDAYS=0 where  SquareOffValue=0     ---added for 10391296  
           
  select Processdate,Party_code,NoofDays,Day1Date,region,(                        
  Case                         
  when Day1Date=processDate and NoofDays > 1 then 1                         
  when Day1Date > processDate and NoofDays >= 1 then 0                        
  else NoofDays end) as NOD into #NOD                        
  from #file2 a join                        
  (select client,Day1Date,x.region from General.dbo.Vw_RMS_Client_Vertical x join VMSS_Region_Activation y on x.Region=y.Region) b                        
  on a.party_code=b.Client and a.NoOfDays>=1                        
          
  update #File2 set NoofDays=x.NOD from #NOD x where #File2.partY_code=x.party_Code and #File2.processdate=x.processDate                        
          
  update vmss_Data set NOOFDAYS=b.NOOFDAYS from #File2 b where vmss_Data.processdate=@tdate and vmss_Data.party_Code=b.party_code    
    
  /* Update noofdays according to ageing days with new logic as suggested by Renil sir & Vishal Gohil*/  
  declare @ageingDate varchar(20) 
  select @ageingDate=max(cast(updatedon as date)) from vmss_data
 
  Update a set noofdays=1 from vmss_data a,(select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b  
  where a.party_code=b.party_code and b.ageing_day=5  and a.processdate=@tdate and a.squareoffvalue>0.00
    
  Update a set noofdays=2 from vmss_data a, (select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b  
  where a.party_code=b.party_code and b.ageing_day=6  and a.processdate=@tdate and a.squareoffvalue>0.00
    
  Update a set noofdays=3 from vmss_data a, (select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b  
  where a.party_code=b.party_code and b.ageing_day>=7  and a.processdate=@tdate and a.squareoffvalue>0.00
    
  /* To update noofdays as 2 for clients with ageing>8 and in var shortage 10391296*/  
  select party_code,ageing_day into #tempAgeinG  from MIS.dbo.Tbl_ASB7_Ageing_Debit_Days where ageing_day>7       
  Declare @tdate1 as date = (select MAX(updatedon-1) from vmss_Data with (nolock))      
   
  select A.party_code ,noofdays,squareoffvalue ,B.ageing_day,A.processdate,A.updatedon     
  into #PreviousDayTemp     
  from vmss_data A inner join #tempAgeinG B on A.party_code=B.party_code     
  where cast(updatedon as date)=@tdate1                          
  and squareoffvalue>0.00    
      
  select A.party_code ,noofdays,squareoffvalue ,B.ageing_day ,A.processdate,A.updatedon     
  into #CurrDayTemp     
  from vmss_data A inner join #tempAgeinG B on A.party_code=B.party_code     
  where cast(updatedon as date)=(select max(cast(updatedon as date)) from vmss_data) and (A.noofdays between 0 and 1)                           
  and squareoffvalue>0.00    
    
  select A.party_code ,A.noofdays,A.squareoffvalue ,A.ageing_day ,A.processdate,A.updatedon  into #CommonTemp    
  from #CurrDayTemp A inner join #PreviousDayTemp B on A.party_code=B.party_code      
     
  update vmss_data set noofdays= 2    
  where party_code in(select party_code from #CurrDayTemp) and party_code not in (select party_code from #CommonTemp) and cast(updatedon as date)=(select max(cast(updatedon as date))  from vmss_data)    
                              
                             
 End try                                                                                 
 BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'VMSS_NoOfDays_Calculation',ERROR_LINE(),ERROR_MESSAGE()                                               
          
  DECLARE @ErrorMessage NVARCHAR(4000);                                                  
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
 End catch                                                     
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_NoOfDays_Calculation_26082016
-- --------------------------------------------------
create PROC [dbo].[VMSS_NoOfDays_Calculation_26082016]                              
as                              
          
SET XACT_ABORT ON                    
Set nocount on                                                              
 BEGIN TRY                                
  
  Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                
            
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))                                
  select * into #file2 from vmss_Data with (nolock) where processdate=@tdate                               
            
  Update #File2 set NoofDays=1                              
            
  UPDATE #File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                                          
  (                                                                
  SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                           
  (                                     
  SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                                                                                           
  WHERE CONVERT(DATE,processdate) <= (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data where processdate < @tdate )                                                                 
  )                                                                                          
  ) B WHERE #File2.party_code=B.party_code                                                                                           
            
  UPDATE #File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdjCurrDay >= @LowerCapAmt                                                                
            
  UPDATE #File2 SET NOOFDAYS=0 where  party_Code not in (select party_Code from VMSS_ASB7_Days)        
      
  UPDATE #File2 SET NOOFDAYS=0 where  SquareOffValue=0     ---added for 10391296    
             
  select Processdate,Party_code,NoofDays,Day1Date,region,(                          
  Case                           
  when Day1Date=processDate and NoofDays > 1 then 1                           
  when Day1Date > processDate and NoofDays >= 1 then 0                          
  else NoofDays end) as NOD into #NOD                          
  from #file2 a join                          
  (select client,Day1Date,x.region from General.dbo.Vw_RMS_Client_Vertical x join VMSS_Region_Activation y on x.Region=y.Region) b                          
  on a.party_code=b.Client and a.NoOfDays>=1                          
            
  update #File2 set NoofDays=x.NOD from #NOD x where #File2.partY_code=x.party_Code and #File2.processdate=x.processDate                          
            
  update vmss_Data set NOOFDAYS=b.NOOFDAYS from #File2 b where vmss_Data.processdate=@tdate and vmss_Data.party_Code=b.party_code      
      
  /* Update noofdays according to ageing days with new logic as suggested by Renil sir & Vishal Gohil*/    
  declare @ageingDate varchar(20)   
  select @ageingDate=max(cast(updatedon as date)) from vmss_data  
   
  Update a set noofdays=1 from vmss_data a,(select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b    
  where a.party_code=b.party_code and b.ageing_day=5  and a.processdate=@tdate and a.squareoffvalue>0.00  
      
  Update a set noofdays=2 from vmss_data a, (select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b    
  where a.party_code=b.party_code and b.ageing_day=6  and a.processdate=@tdate and a.squareoffvalue>0.00  
      
  Update a set noofdays=3 from vmss_data a, (select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b    
 where a.party_code=b.party_code and b.ageing_day>=7  and a.processdate=@tdate and a.squareoffvalue>0.00  
 
 /* ageing data where ageing day>5*/
 select party_code,ageing_day into #ageingDay from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where ageing_day>5  
 
 /*Current day ageing data*/
 select A.party_code,noofdays,squareoffvalue,B.ageing_day into #vmssCurrDay from vmss_data A inner join #ageingDay B 
 on A.party_code=B.party_code where updatedOn=(select max(updatedon) from vmss_data) and squareoffvalue>0 
 
  /*previous day ageing data*/
  Declare @prevtdate as datetime     
  SELECT @prevtdate=CONVERT(DATE,MAX(updatedon)) FROM VMSS_data where updatedon < (select MAX(updatedon) from vmss_Data with (nolock))    
  
  select  A.party_code,noofdays,squareoffvalue  into  #vmssPreviousDay  from vmss_data A 
  where cast(updatedOn as date)=@prevtdate  and squareoffvalue=0 
 
 /* comparison between current and previos day data*/
 select A.party_code,A.Noofdays,CurrSqValue=A.squareoffvalue,PrevSqValue=B.squareoffvalue into #final from #vmssCurrDay A inner join #vmssPreviousDay B  on A.party_code=B.party_code
 
 Update vmss_data set noofdays=2 where party_code in(select party_code from #final) 
 and cast(updatedOn as date)=(select max(cast(updatedOn as date)) from vmss_data) and squareoffvalue>0 

 End try                                                                                   
 BEGIN CATCH                                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                            
  select GETDATE(),'VMSS_NoOfDays_Calculation',ERROR_LINE(),ERROR_MESSAGE()                                                 
            
  DECLARE @ErrorMessage NVARCHAR(4000);                                                    
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
  RAISERROR (@ErrorMessage , 16, 1);                          
 End catch                                                       
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_NoOfDays_Calculation_29072016
-- --------------------------------------------------
create PROC [dbo].[VMSS_NoOfDays_Calculation_29072016]                          
as                          
      
SET XACT_ABORT ON                
Set nocount on                                                          
 BEGIN TRY                            
    
  
    
  Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                            
        
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))                            
  select * into #file2 from vmss_Data with (nolock) where processdate=@tdate                           
        
  Update #File2 set NoofDays=1                          
        
  UPDATE #File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                                      
  (                                                            
  SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                       
  (                                 
  SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                                                                                       
  WHERE CONVERT(DATE,processdate) <= (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data where processdate < @tdate )                                                             
  )                                                                                      
  ) B WHERE #File2.party_code=B.party_code                                                                                       
        
  UPDATE #File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdjCurrDay >= @LowerCapAmt                                                            
        
  UPDATE #File2 SET NOOFDAYS=0 where  party_Code not in (select party_Code from VMSS_ASB7_Days)    
        
  select Processdate,Party_code,NoofDays,Day1Date,region,(                      
  Case                       
  when Day1Date=processDate and NoofDays > 1 then 1                       
  when Day1Date > processDate and NoofDays >= 1 then 0                      
  else NoofDays end) as NOD into #NOD                      
  from #file2 a join                      
  (select client,Day1Date,x.region from General.dbo.Vw_RMS_Client_Vertical x join VMSS_Region_Activation y on x.Region=y.Region) b                      
  on a.party_code=b.Client and a.NoOfDays>=1                      
        
  update #File2 set NoofDays=x.NOD from #NOD x where #File2.partY_code=x.party_Code and #File2.processdate=x.processDate                      
        
  update vmss_Data set NOOFDAYS=b.NOOFDAYS from #File2 b where vmss_Data.processdate=@tdate and vmss_Data.party_Code=b.party_code                          
                           
 End try                                                                               
 BEGIN CATCH                                                                                  
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                        
  select GETDATE(),'VMSS_NoOfDays_Calculation',ERROR_LINE(),ERROR_MESSAGE()                                             
        
  DECLARE @ErrorMessage NVARCHAR(4000);                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                
  RAISERROR (@ErrorMessage , 16, 1);                      
 End catch                                                   
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_NoOfDays_Calculation_abha
-- --------------------------------------------------
CREATE PROC [dbo].[VMSS_NoOfDays_Calculation_abha]                              
as                              
          
SET XACT_ABORT ON                    
Set nocount on                                                              
 BEGIN TRY                                
  
  Declare @LowerCapAmt as money = -500  /* LEDGER BALANCE & MARGINSHORTAGE : - Debit / + Credit */                                                                
            
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))                                
  select * into #file2 from vmss_Data with (nolock) where processdate=@tdate                               
            
  Update #File2 set NoofDays=1                              
            
  UPDATE #File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                                          
  (                                                                
  SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                                           
  (                                     
  SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                                                                                           
  WHERE CONVERT(DATE,processdate) <= (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data where processdate < @tdate )                                                                 
  )                                                                                          
  ) B WHERE #File2.party_code=B.party_code                                                                                           
            
  UPDATE #File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdjCurrDay >= @LowerCapAmt                                                                
            
  UPDATE #File2 SET NOOFDAYS=0 where  party_Code not in (select party_Code from VMSS_ASB7_Days)        
      
  UPDATE #File2 SET NOOFDAYS=0 where  SquareOffValue=0     ---added for 10391296    
             
  select Processdate,Party_code,NoofDays,Day1Date,region,(                          
  Case                           
  when Day1Date=processDate and NoofDays > 1 then 1                           
  when Day1Date > processDate and NoofDays >= 1 then 0                          
  else NoofDays end) as NOD into #NOD                          
  from #file2 a join                          
  (select client,Day1Date,x.region from General.dbo.Vw_RMS_Client_Vertical x join VMSS_Region_Activation y on x.Region=y.Region) b                          
  on a.party_code=b.Client and a.NoOfDays>=1                          
            
  update #File2 set NoofDays=x.NOD from #NOD x where #File2.partY_code=x.party_Code and #File2.processdate=x.processDate                          
            
  update vmss_Data set NOOFDAYS=b.NOOFDAYS from #File2 b where vmss_Data.processdate=@tdate and vmss_Data.party_Code=b.party_code      
      
  /* Update noofdays according to ageing days with new logic as suggested by Renil sir & Vishal Gohil*/    
  declare @ageingDate varchar(20)   
  select @ageingDate=max(cast(updatedon as date)) from vmss_data  
   
  Update a set noofdays=1 from vmss_data a,(select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b    
  where a.party_code=b.party_code and b.ageing_day=5  and a.processdate=@tdate and a.squareoffvalue>0.00  
      
  Update a set noofdays=2 from vmss_data a, (select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b    
  where a.party_code=b.party_code and b.ageing_day=6  and a.processdate=@tdate and a.squareoffvalue>0.00  
      
  Update a set noofdays=3 from vmss_data a, (select Party_code,ageing_day from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where cast(processdate as date)=cast(@ageingDate as date))b    
 where a.party_code=b.party_code and b.ageing_day>=7  and a.processdate=@tdate and a.squareoffvalue>0.00  
 
 /* ageing data where ageing day>5*/
 select party_code,ageing_day into #ageingDay from MIS.Dbo.Tbl_ASB7_Ageing_Debit_Days where ageing_day>5  
 
 /*Current day ageing data*/
 select A.party_code,noofdays,squareoffvalue,B.ageing_day into #vmssCurrDay from vmss_data A inner join #ageingDay B 
 on A.party_code=B.party_code where updatedOn=(select max(updatedon) from vmss_data) and squareoffvalue>0 
 
  /*previous day ageing data*/
 select  A.party_code,noofdays,squareoffvalue  into  #vmssPreviousDay  from vmss_data A 
 where cast(updatedOn as date)=(select max(cast(updatedon -1 as date)) from vmss_data) and squareoffvalue=0 
 
 select A.party_code,A.Noofdays,CurrSqValue=A.squareoffvalue,PrevSqValue=B.squareoffvalue into #final from #vmssCurrDay A inner join #vmssPreviousDay B  on A.party_code=B.party_code
 
 Update vmss_data set noofdays=2 where party_code in(select party_code from #final) 
 and cast(updatedOn as date)=(select max(cast(updatedOn as date)) from vmss_data) and squareoffvalue>0 
 


 End try                                                                                   
 BEGIN CATCH                                                                                      
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                            
  select GETDATE(),'VMSS_NoOfDays_Calculation',ERROR_LINE(),ERROR_MESSAGE()                                                 
            
  DECLARE @ErrorMessage NVARCHAR(4000);                                                    
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                    
  RAISERROR (@ErrorMessage , 16, 1);                          
 End catch                                                       
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_NoOfDays_Calculation_BD
-- --------------------------------------------------

CREATE PROC [dbo].[VMSS_NoOfDays_Calculation_BD](@mdate as varchar(11))      
as      
      
SET XACT_ABORT ON                                      
Set nocount on                                      
BEGIN TRY        
                
 Declare @LowerCapAmt as money = -500  
      
 Declare @tdate as datetime = convert(datetime,@mdate)
 select * into #file2 from vmss_Data with (nolock) where processdate=@tdate       
      
 Update #File2 set NoofDays=1      
  
 UPDATE #File2 SET NOOFDAYS=isnull(B.NOOFDAYS,0)+1 FROM                                                                  
 (                                        
  SELECT party_code,NOOFDAYS FROM VMSS_data WHERE CONVERT(DATE,processdate) =                                                                   
  (             
   SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data                                                                   
   WHERE CONVERT(DATE,processdate) <= (SELECT CONVERT(DATE,MAX(processdate)) FROM VMSS_data where processdate < @tdate )                                         
  )                                                                  
 ) B WHERE #File2.party_code=B.party_code                                                                   
  
 UPDATE #File2 SET NOOFDAYS=0 where  VarMarginShortFall_AftAdj >= @LowerCapAmt                                        
  
 select Processdate,Party_code,NoofDays,Day1Date,region,(  
 Case   
 when Day1Date=processDate and NoofDays > 1 then 1   
 when Day1Date > processDate and NoofDays >= 1 then 0  
 else NoofDays end) as NOD into #NOD  
 from #file2 a join  
 (select client,Day1Date,x.region from General.dbo.Vw_RMS_Client_Vertical x join VMSS_Region_Activation y on x.Region=y.Region) b  
 on a.party_code=b.Client and a.NoOfDays>=1  
  
 update #File2 set NoofDays=x.NOD from #NOD x where #File2.partY_code=x.party_Code and #File2.processdate=x.processDate  
   
 update vmss_Data set NOOFDAYS=b.NOOFDAYS from #File2 b where vmss_Data.processdate=@tdate and vmss_Data.party_Code=b.party_code      
      
 End try                                                           
BEGIN CATCH                                                              
  insert into GENERAL.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                    
  select GETDATE(),'VMSS_NoOfDays_Calculation',ERROR_LINE(),ERROR_MESSAGE()                         
End catch                               
                                      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_NSE_VarShortage
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[VMSS_NSE_VarShortage]                                  
AS                                  
                                         
Set nocount on                                          
 BEGIN TRY     
    select distinct Party_code into #MTFCodes from general.dbo.vw_ClientMargin_Campaign with (nolock) where IS_Accepted='Y' 

                      
  TRUNCATE TABLE upd_nse_outfile_squp_var_margin_shortage                                  
    
  INSERT INTO upd_nse_outfile_squp_var_margin_shortage                                  
  SELECT '1'                               AS [Regular_Lot],                           
  2                                 [Buy/Sell],                           
  (Case when series='BSE' then upper(d.nsesymbol) else scrip_cd end) AS Symbol,                           
  (Case when series='BSE' then upper(d.nseseries) else series end) as series,                           
  1                                 AS Instructions,                           
  ''                                AS Default_1,                           
  ''                                AS Default_2,                           
  ''                                AS Default_3,                           
  price=CONVERT(INT, clsrate - ( ( clsrate * 2 ) / 100 )),                           
  ''                                AS Default_4,                           
  SquareOffQty as                           qty,                           
  CONVERT(INT, Ceiling(SquareOffQty / 10.0)) AS [Disclosed Qty.],                           
  '12798'                           AS Member_Code,                           
  '2'                               AS Pro_Client,                           
  A.party_code                      AS [Client_Code],                           
  ''                                AS Default_5,                           
  ''                                AS Default_6,                           
  ''                                AS Default_7                           
  FROM                          
  (                  
  SELECT scrip_Cd=Upper(scrip_Cd),series,                  
  party_code, isin, sum(SquareOffQty) as SquareOffQty, clsrate,tosegment                           
  FROM vmss_holding WITH(nolock)                           
  WHERE  SquareOffQty > 0 and tosegment ='NSECM'                 
  GROUP by party_code, isin,clsrate, tosegment,scrip_Cd,series                  
  ) a                           
  INNER JOIN general.dbo.scrip_master d                           
  ON a.isin = d.isin                           
  inner join (                  
  select party_code from VMSS_data where NoofDays >=3 and                   
  processdate >= (select max(processdate) from VMSS_data)                   
  group by party_code                  
  )c                          
  on a.Party_code=c.Party_code   
  inner join #MTFCodes MTF on a.party_code=MTF.party_code                         
   
  update upd_nse_outfile_squp_var_margin_shortage               
  set series=b.cpseries from              
  (Select scrip,series as cpseries from general.dbo.cp_nsecm where series in ('EQ','BE','BZ')) b              
  where upd_nse_outfile_squp_var_margin_shortage.symbol=b.scrip               
  and upd_nse_outfile_squp_var_margin_shortage.series in ('EQ','BE','BZ')              
  and upd_nse_outfile_squp_var_margin_shortage.series<>b.cpseries  
  
               
 End try                                                               
 BEGIN CATCH                             
  insert into general.dbo.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                        
  select GETDATE(),'VMSS_NSE_VarShortage',ERROR_LINE(),ERROR_MESSAGE()                                                                        
    
  DECLARE @ErrorMessage NVARCHAR(4000);                                              
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                              
  RAISERROR (@ErrorMessage , 16, 1);                    
 End catch                                           
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_NSE_VarShortage_10_percent
-- --------------------------------------------------
create PROCEDURE [dbo].[VMSS_NSE_VarShortage_10_percent]                                    
AS                                    
                                           
Set nocount on                                            
 BEGIN TRY   
 set transaction isolation  level read uncommitted                         
  TRUNCATE TABLE upd_nse_outfile_squp_var_margin_shortage                                    
      
  INSERT INTO upd_nse_outfile_squp_var_margin_shortage                                    
  SELECT '1'                               AS [Regular_Lot],                             
  2                                 [Buy/Sell],                             
  (Case when series='BSE' then d.nsesymbol else scrip_cd end) AS Symbol,                             
  (Case when series='BSE' then d.nseseries else series end) as series,                             
  1                                 AS Instructions,                             
  ''                                AS Default_1,                             
  ''                                AS Default_2,                             
  ''                                AS Default_3,                             
  price=CONVERT(INT, clsrate - ( ( clsrate * 10 ) / 100 )),                             
  ''                                AS Default_4,                             
  SquareOffQty as                           qty,                             
  CONVERT(INT, Ceiling(SquareOffQty / 10.0)) AS [Disclosed Qty.],                             
  '12798'                           AS Member_Code,                             
  '2'                               AS Pro_Client,                             
  A.party_code                      AS [Client_Code],                             
  ''                                AS Default_5,                             
  ''                                AS Default_6,                             
  ''                                AS Default_7                             
  FROM                            
  (                    
  SELECT scrip_Cd,series,                    
  party_code, isin, sum(SquareOffQty) as SquareOffQty, clsrate,tosegment                             
  FROM vmss_holding WITH(nolock)                             
  WHERE  SquareOffQty > 0 and tosegment ='NSECM'                   
  GROUP by party_code, isin,clsrate, tosegment,scrip_Cd,series                    
  ) a                             
  INNER merge JOIN general.dbo.scrip_master d with (nolock)                            
  ON a.isin = d.isin                             
  inner merge join (                    
  select party_code from VMSS_data with (nolock) where NoofDays >=3 and                     
  processdate >= (select max(processdate) from VMSS_data with (nolock))                     
  group by party_code                    
  )c                            
  on a.Party_code=c.Party_code                              
     
  update upd_nse_outfile_squp_var_margin_shortage                 
  set series=b.cpseries from                
  (Select scrip,series as cpseries from general.dbo.cp_nsecm where series in ('EQ','BE','BZ')) b                
  where upd_nse_outfile_squp_var_margin_shortage.symbol=b.scrip                 
  and upd_nse_outfile_squp_var_margin_shortage.series in ('EQ','BE','BZ')                
  and upd_nse_outfile_squp_var_margin_shortage.series<>b.cpseries                
 End try                                                                 
 BEGIN CATCH                               
  insert into general.dbo.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                          
  select GETDATE(),'VMSS_NSE_VarShortage',ERROR_LINE(),ERROR_MESSAGE()                                                                          
      
  DECLARE @ErrorMessage NVARCHAR(4000);                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                
  RAISERROR (@ErrorMessage , 16, 1);    
 End catch                                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_NSE_VarShortage_5_percent
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[VMSS_NSE_VarShortage_5_percent]                                    
AS                                    
                                           
Set nocount on                                            
 BEGIN TRY   
 set transaction isolation  level read uncommitted                         
  TRUNCATE TABLE upd_nse_outfile_squp_var_margin_shortage                                    
      
  INSERT INTO upd_nse_outfile_squp_var_margin_shortage                                    
  SELECT '1'                               AS [Regular_Lot],                             
  2                                 [Buy/Sell],                             
  (Case when series='BSE' then d.nsesymbol else scrip_cd end) AS Symbol,                             
  (Case when series='BSE' then d.nseseries else series end) as series,                             
  1                                 AS Instructions,                             
  ''                                AS Default_1,                             
  ''                                AS Default_2,                             
  ''                                AS Default_3,                             
  price=CONVERT(INT, clsrate - ( ( clsrate * 5 ) / 100 )),                             
  ''                                AS Default_4,                             
  SquareOffQty as                           qty,                             
  CONVERT(INT, Ceiling(SquareOffQty / 10.0)) AS [Disclosed Qty.],                             
  '12798'                           AS Member_Code,                             
  '2'                               AS Pro_Client,                             
  A.party_code                      AS [Client_Code],                             
  ''                                AS Default_5,                             
  ''                                AS Default_6,                             
  ''                                AS Default_7                             
  FROM                            
  (                    
  SELECT scrip_Cd,series,                    
  party_code, isin, sum(SquareOffQty) as SquareOffQty, clsrate,tosegment                             
  FROM vmss_holding WITH(nolock)                             
  WHERE  SquareOffQty > 0 and tosegment ='NSECM'                   
  GROUP by party_code, isin,clsrate, tosegment,scrip_Cd,series                    
  ) a                             
  INNER merge JOIN general.dbo.scrip_master d with (nolock)                            
  ON a.isin = d.isin                             
  inner merge join (                    
  select party_code from VMSS_data with (nolock) where NoofDays >=3 and                     
  processdate >= (select max(processdate) from VMSS_data with (nolock))                     
  group by party_code                    
  )c                            
  on a.Party_code=c.Party_code                              
     
  update upd_nse_outfile_squp_var_margin_shortage                 
  set series=b.cpseries from                
  (Select scrip,series as cpseries from general.dbo.cp_nsecm where series in ('EQ','BE','BZ')) b                
  where upd_nse_outfile_squp_var_margin_shortage.symbol=b.scrip                 
  and upd_nse_outfile_squp_var_margin_shortage.series in ('EQ','BE','BZ')                
  and upd_nse_outfile_squp_var_margin_shortage.series<>b.cpseries                
 End try                                                                 
 BEGIN CATCH                               
  insert into general.dbo.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                          
  select GETDATE(),'VMSS_NSE_VarShortage',ERROR_LINE(),ERROR_MESSAGE()                                                                          
      
  DECLARE @ErrorMessage NVARCHAR(4000);                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                
  RAISERROR (@ErrorMessage , 16, 1);    
 End catch                                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING
-- --------------------------------------------------
              
/*                    
CREATED BY :: RENIL PILLAI                    
CREATED ON :: MAY 04 2016                    
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS                    
*/                   
                
CREATE PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING]                    
AS                    
SET NOCOUNT ON                    
BEGIN    

    exec VMSS_PURERISK_DPSHAREFETCHING_day2                
	declare @dt1 datetime

	select ROW_NUMBER() over(order by a.Start_Date)as srno,         
	isnull(a.Start_Date,'')  Start_Date                                             
	into #dd from general.dbo.bse_sett_mst a                                                                              
	where CONVERT(VARCHAR(10),a.start_Date,121)>= CONVERT(VARCHAR(10),getdate()-7,121)    and
	CONVERT(VARCHAR(10),a.start_Date,121)< CONVERT(VARCHAR(10),getdate(),121)                                                      
	and datepart(dw,a.start_Date) <> 7  --exclude saturday                                                
	and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                              
	group by Start_Date  
    
	select @dt1=max(start_Date) from #dd where srno=3

 select party_code,pure_risk,proj_risk,rms_date=cast(pdate as date),      
 risktype=case when pure_risk<-100 then 'Pure'      
 else 'Projected' end      
into #temp_Riskdata 
  from history.dbo.TBL_RMS_COLLECTION_CLI_HIST with (nolock)  where        
 cast(pdate as date)>=@dt1   
 and datepart(dw,pdate) <> 7
 and datepart(dw,pdate) <> 1   
 and (pure_risk<-100 or  proj_risk<-501) and Exp_Gross>=0.00     
       
 select party_code,risktype=min(risktype) into #final from #temp_Riskdata  group by party_code having count(party_code)>=3
 
 
                   
 SELECT A.*      
 INTO #CLI                    
 FROM (SELECT A.PARTY_CODE,                    
 NON_CASH=0.00,                    
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),                    
 FOSHRT=CONVERT(MONEY, 0) ,  risktype                 
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)                    
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI A WITH (NOLOCK)   inner join #final F on A.party_code=F.party_code                 
  LEFT JOIN (SELECT PARTY_CODE,                    
 NON_CASH=Sum(FinalAmount)                    
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)                    
 WHERE COLL_TYPE = 'SEC'                    
 GROUP BY PARTY_CODE) B                    
 ON A.PARTY_CODE = B.PARTY_CODE                    
 where (A.Pure_Risk+A.proj_risk)<0 ) A                    
 WHERE EXISTS (                    
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)                    
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)                    
                    
 /*AND A.PARTY_CODE='AND2731'*/                   
               
               
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/              
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI b with (nolock) where b.Pure_Risk>=-100             
 and b.proj_risk>-501 and b.party_code=a.party_code              
               
 --/*exclude client who have traded in 5 days*/              
 --delete from #CLI where party_code in (select party_code from #traded5days)              
                  
 UPDATE #CLI                    
 SET FOSHRT = CASE                    
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN                    
 ELSE 0                    
 END                    
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)                    
 WHERE CO_CODE = 'NSEFO'                    
 AND #CLI.PARTY_CODE = B.PARTY_CODE                    
 AND IMARGIN <> 0                    
 
 /*                           
 DELETE from #CLI where PARTY_CODE IN                    
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK)) */--commented on Feb 02 2018 as suggested by Vishal Gohil                   
                    
 SELECT X.PARTY_CODE,                                                      
                   NET_DEBIT,                                                                             
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                                      
                   NON_CASH,                                                      
                   BLUECHIP=Isnull(BLUECHIP, 0),                                                      
                   GOOD=Isnull(GOOD, 0),                                                      
                   AVERAGE=Isnull(AVERAGE, 0),                                                      
                   POOR=Isnull(POOR, 0),                                                      
                   TOTAL=Isnull(TOTAL, 0),                                          
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                                      
                   ADJ_VALUE=NET_DEBIT *-1,                                               EXCLUDE_FLAG=' ',                                                      
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                          
                   GOOD_ADJ=CONVERT(MONEY, 0),                                                      
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                                      
                   POOR_ADJ=CONVERT(MONEY, 0),                               
                   FOSHRT,risktype      
            INTO   #FILE1                                                      
            FROM   #CLI X                                                      
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                                      
                  ANGEL_BEN=Sum(CASE WHEN SOURCE <> 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  BLUECHIP=Sum(CASE WHEN NSE_APPROVED = 'BLUECHIP' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  GOOD=Sum(CASE WHEN NSE_APPROVED = 'GOOD' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  AVERAGE=Sum(CASE WHEN NSE_APPROVED = 'AVERAGE' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                                                             
                  POOR=Sum(CASE  WHEN NSE_APPROVED = 'POOR' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  TOTAL=Sum(TOTAL_WithHC)                                                      
                  FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)GROUP  BY PARTY_CODE) Y                                                      
                  ON X.PARTY_CODE = Y.PARTY_CODE                                                      
                                                      
                                                        
            DELETE FROM #FILE1                                                      
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                                      
            FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                                        
                                  WHERE  CL_TYPE = 'NRI'                                                      
                                          OR BRANCH_CD = 'NRIS')                                                        
            UPDATE #FILE1                                                      
            SET    ADJ_VALUE = 0                                                      
            WHERE  ADJ_VALUE < 0                                                      
                                                      
            CREATE TABLE #FILE2                                                      
              (                                                      
                 SRNO         INT IDENTITY(1, 1),                                                      
                 ISIN         CHAR(12),                                                      
                 SCRIP_CD     VARCHAR(10),                                                      
                 PARTY_CODE   VARCHAR(10),                                                      
                 QTY          INT,                                                      
                 ACCNO        VARCHAR(16),                                                      
                 TOTAL        MONEY,                                                      
                 NSE_APPROVED VARCHAR(25),                                                      
                 NET_DEBIT    MONEY DEFAULT 0,                                                
                 BEN_ADJUSTED MONEY DEFAULT 0,                                                      
                 TOTAL_ADJ    MONEY DEFAULT 0,                    
                 BALAFTERADJ  MONEY DEFAULT 0,                                                      
                 QTY_ADJ      INT,              
                 CLS_rate MONEY,              
                 TOTAL_VALUE_ADJ MONEY,                                                      
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                                      
                 --FO_SHRT MONEY DEFAULT 0                                                          
              )                                                      
                                                      
            SELECT A.*,                                            
                   ADJ_VALUE AS TOTAL_ADJ,                                          
       QTY_ADJ=CONVERT(INT, 0)                                                      
            INTO   #FILET                                                      
            FROM   (SELECT ISIN,                                                      
                           SCRIP_CD,                                                     
                           PARTY_CODE,                                      
                           QTY=Sum(QTY),                                                      
                           ACCNO,                                                      
                           TOTAL=Sum(TOTAL),                                                      
                           NSE_APPROVED                                                      
            FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                                      
            GROUP  BY ISIN,SCRIP_CD,PARTY_CODE,ACCNO,NSE_APPROVED HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                                      
           (SELECT PARTY_CODE,                                                      
                    ADJ_VALUE                                                      
                    FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0) B                                                      
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                                      
                                      
            delete from #FILET where isin='INE002A20018'
			                           
            --DROP TABLE #CLIENT_LISTTOADJUST                                                          
            SELECT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   /*Change Id :: 2*/                              
                   --DPID,                                                      
                   ADJ_VALUE,                                                      
                   FOSHRT * -1                            AS FOSHRT,                                                      
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM,      
                   risktype                                                      
            INTO   #CLIENT_LISTTOADJUST                                                      
            FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                                          
                              
            SELECT top 0 *                                                      
            INTO   #ILLIQUIED_SCRIPS                                                      
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP            
                                                   
                    
                    
/*                    
                    
           SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   PARTY_CODE,                                                      
                   QTY=Sum(QTY),            
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,                     
                   Sum(TOTAL) DESC) AS ROW_NUM                                                      
            INTO   #DPHOLDING_TO_MOVE                        
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                       
            WHERE  EXISTS (SELECT PARTY_CODE                                                      
                           FROM   #CLIENT_LISTTOADJUST C                                            
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                                      
                   AND NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                                                      
                      B.DUMMY1                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY PARTY_CODE,                                                      
                      ROW_NUM                                                      
*/                    
                    
                    
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED ,
				   clsrate,
				   risktype       =max(c.risktype)                                
                  
            INTO   #DPHOLDING_TO_MOVE_temp                                                   
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST ) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where        NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno,clsrate                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE 
			                                                     
   
 delete from #DPHOLDING_TO_MOVE_temp where isin='INE002A20018'                             
          
    /*Added by Vishal Gohil to exclude poor scrip from projected category on 21/07/2016 by Renil and Abha*/                        
 delete from #DPHOLDING_TO_MOVE_temp  where risktype='Projected' and nse_approved='Poor'      
       
  SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM-- ,   clsrate=max(clsrate)             
                    ,risktype       =max(c.risktype)   
                                 
            INTO   #DPHOLDING_TO_MOVE                                                   
            FROM   #DPHOLDING_TO_MOVE_temp H                                      
                                                                  
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                                      
                                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno                                                  
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE,                                                      
                      ROW_NUM           
                                    
                 /*              
                 /**************************Vishal gohil**************************************************************/              
   /****************************************************************************************/                   
                 select x.* INTO   #DPHOLDING_TO_MOVE                
                 from                        
            (SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
    NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM,   clsrate=max(clsrate)                                                 
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                     
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
--             K47437              
--K48042              
          inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED<>'Poor'                                                  
                   AND TOTAL <> 0    -- and h.party_Code='K48042'                                                                    
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                          
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            union                  
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                               
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM ,   clsrate=max(clsrate)                              
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                 
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED='Poor'                                                  
                   AND TOTAL <> 0       --and h.party_code='K48042'                                                                  
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                   
                      NSE_APPROVED,                                                      
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0  )x                                      
            ORDER  BY x.PARTY_CODE,                                                      
                      ROW_NUM                                    
                                    
                    
   update a set  row_num=b.row_num+a.row_num from #DPHOLDING_TO_MOVE a,              
   (select party_Code,row_num=MAX(row_num) from #DPHOLDING_TO_MOVE group by party_Code)b              
   where a.[party_Code]=b.party_Code and  a.nse_approved='Poor'              
                 
   /****************************************************************************************/              
   /****************************************************************************************/              
   */              
                                    
                                    
                                                      
            CREATE CLUSTERED INDEX [IX_Row_Num]                                                      
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )                       
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            CREATE CLUSTERED INDEX [IX_Party_code]                                                      
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                                    
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                  
            CREATE CLUSTERED INDEX [IX_Party_code]                                                       ON #FILE2 ( [Party_Code] ASC )                                                      
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            DECLARE @PARTY_CNT      AS INT,                                                      
                    @PARTY_CTR      AS INT,                                                      
                    @SCRIP_CNT      AS INT,                                                      
                    @SCRIP_CTR      AS INT,                                  
                    @PARTY_CODE     AS VARCHAR(20),                                                      
/*Change Id :: 2*/                              
                    --@DPID           AS VARCHAR(20),                                                      
                    @FOSHORTAGE     AS MONEY,                                                      
                    @ADJUSTMENT_AMT AS MONEY,                                                      
                    @ADJUSTED_AMT   AS MONEY,                                                      
                    @ADJ_QTY        AS INT,                                                      
                    @QTY            AS INT,                                      
                    @VALUE          AS MONEY,                                                      
                    @CLOSING_PRICE  AS MONEY,                                                      
                  @NET_DEBIT  AS MONEY                                                      
                                                      
            SET @ADJUSTED_AMT = 0                                                      
          SET @PARTY_CTR = 1                                                      
           
            SELECT @PARTY_CNT = Count(*)                                                      
            FROM   #CLIENT_LISTTOADJUST                                                      
                                                      
            --PRINT @PARTY_CNT                                                          
            WHILE( @PARTY_CTR <= @PARTY_CNT )                                             
              BEGIN                                                      
                  SET @ADJUSTMENT_AMT = 0                                                      
                  SET @FOSHORTAGE = 0                                                      
                  SET @ADJUSTED_AMT = 0                      
                                                    
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                                      
                                                          
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                                      
                         @FOSHORTAGE = FOSHRT,                                   
                         @NET_DEBIT = NET_DEBIT                                                      
                  FROM   #CLIENT_LISTTOADJUST                                                      
                  WHERE  ROW_NUM = @PARTY_CTR                          
                                                      
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                                      
                                                      
                  SET @SCRIP_CTR = 1                                                      
                                                      
                  SELECT @SCRIP_CNT = Count(*)                                            
                  FROM   #DPHOLDING_TO_MOVE                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                              
                    
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                                      
                    BEGIN                                                      
                        SELECT @QTY = QTY,                                                      
                  @VALUE = TOTAL,                                                      
                               @CLOSING_PRICE = TOTAL / QTY                                                      
                        FROM   #DPHOLDING_TO_MOVE                                                      
                        WHERE  ROW_NUM = @SCRIP_CTR                                                      
                               AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                        IF @ADJUSTMENT_AMT >= @VALUE                                              
                          BEGIN                                                      
                              SET @ADJ_QTY = @QTY                                                      
                                                      
                 INSERT INTO #FILE2                                                      
                                          (ISIN,                                           
                                           SCRIP_CD,                                                      
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                           TOTAL,                                                      
                                           NSE_APPROVED,                              
                                           NET_DEBIT,                                                      
             QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
                                     PARTY_CODE,                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                        TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                                      
                                     @ADJ_QTY,                                                      
                          CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                ELSE 'N'                                                      
                              END                                            
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                                      
                          END                                                      
                        ELSE                                           
                          BEGIN                                                      
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                                      
                                                      
                              INSERT INTO #FILE2                                                      
                              (ISIN,                                                      
                                           SCRIP_CD,                                  
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                  TOTAL,                                                      
                                           NSE_APPROVED,                                                      
                                           NET_DEBIT,                                            
                                           QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
               Ltrim(Rtrim(PARTY_CODE)),                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                                     TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                      
                                     @ADJ_QTY,                                                      
                                     CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                   ELSE 'N'                                                      
                                     END                                                      
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                            
                                                      
                              BREAK                                                      
                          END                                               
                                                      
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                                      
                    END                                                      
                                         
                  UPDATE #FILE2                                             
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                                      
                         TOTAL_ADJ = @ADJUSTED_AMT                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                                                      
                               
                  SET @PARTY_CTR = @PARTY_CTR + 1                                  
              END                                                      
                                                      
                                
            UPDATE #FILE2                                                      
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                                      
                                
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                                      
            FROM   #FILE1 B                                                      
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                                      
                                            
                                            
            UPDATE #FILE2                                
                SET FO_APPROVED = 'N'                                
            WHERE UPPER(NSE_APPROVED) = 'POOR'                    
                          
                           
              UPDATE #FILE2 SET cls_rate=A.clsrate from              
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B              
              GROUP  BY B.ISIN,                                                      
                      B.SCRIP_CD,                                                      
                      B.PARTY_CODE,                                                      
                      B.ACCNO, B.clsrate,                                                     
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED              
                                 
                
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate              
                            
                            
           /*select * from #FILE2 x inner join #cli y on x.party_code=y.party_code*/      
                                
            DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()                                                      
             
           
               
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                                      
            SELECT DISTINCT *                 
            FROM   VMSS_PURERISK_DPHOLDING                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                              
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                                      
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                               
                                             
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)                   
                  
            /*      
              DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()       
            */                                                     
            
			
                                  
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                                      
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDING                                                     
            SELECT DISTINCT x.*,                                                      
                   @DT AS PROCESS_DATE,'','','',y.risktype                                                      
            FROM   #FILE2 x  inner join #cli y on x.party_code=y.party_code                                                   
            WHERE  x.QTY_ADJ > 0    
			
			 /*delete from VMSS_PURERISK_DPHOLDING where party_code in (select party_code from tbl_sharefetch_excluCodes )   */                                               
                                                   
            /*use general                                                                        
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            use history                                                
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            */                                                      
                  
            delete from  VMSS_PURERISK_DPHOLDING where party_code in (select party_code from general.dbo.client_details where NBFC_Cli='Y' )                   
            --delete from VMSS_PURERISK_DPHOLDING where isin like '%INF%'     
            
			
			     
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                                      
            SELECT DISTINCT *                                               
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST       
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                               
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                
                              
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                              
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                                      
            SELECT DISTINCT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   ANGEL_BEN,                                                      
                   @DT AS PROCESS_DATE,                                                      
                   NON_CASH,                                                      
                   FOSHRT                     
            FROM   #FILE1      
			
			/*delete from VMSS_PURERISK_DPHOLDINGBEN where party_code in (select party_code from tbl_sharefetch_excluCodes )    */                                            
                                     
           exec Pure_Risk_DP_Adj_file_mail             
  /*                          
    --SMS Part      
    SELECT A.party_code,A.AdjAmt ,B.MOBILE_PAGER INTO #SEND1 FROM             
   (select Party_code,AdjAmt=sum(Total_Adj_Value) from VMSS_PURERISK_DPHOLDING where ToSegment is not null group by Party_code) A           
   LEFT OUTER JOIN general.dbo.CLIENT_DETAILS B WITH (NOLOCK)                                                
   ON A.PARTY_CODE = B.PARTY_CODE where B.Mobile_pager is not null          
                                   

   declare @TradingDay datetime   
    ;with sqoffdatae as  
    (  
    select ROW_NUMBER() over(order by a.Start_Date)as srno,  isnull(a.Start_Date,'')   Start_Date                                        
    from general.dbo.bse_sett_mst a                                                                        
    where CONVERT(VARCHAR(10),a.start_Date,121) >= CONVERT(VARCHAR(10),getdate(),121)                                                 
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                          
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                        
    group by Start_Date)  
    select @TradingDay = isnull(Start_Date ,'')  from sqoffdatae where srno=1 ;        
   
   if((DATEPART(DW,GETDATE())>=2 and  DATEPART(DW,GETDATE())<7) and cast(getdate() as date)=cast(@TradingDay as date))  
   begin      
                     
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                         
                  
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
    'P',RIGHT(Getdate(), 2), 'New POA Debit Client' FROM   #SEND1      
          
   /* sms log*/                           
   insert into Tbl_PureRiskAdj_SMS_log      
   SELECT party_code,MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                      
   CONVERT(VARCHAR(11), Getdate(), 103)                                                                               
   FROM   #SEND1          
                            
   INSERT INTO INTRANET.SMS.DBO.SMS SELECT top 1  '9820701602',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                      
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
   'P',RIGHT(Getdate(), 2),'New POA Debit Client' FROM   #SEND1 group by  party_code        
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9820731985','Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                            
   CONVERT(VARCHAR(11), Getdate(), 103), Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1 group by  party_code              
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9819090240',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                     
   CONVERT(VARCHAR(11), Getdate(), 103),Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1  group by  party_code  
   end   
   */
                    
              END                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_01082016
-- --------------------------------------------------
      
/*            
CREATED BY :: RENIL PILLAI            
CREATED ON :: MAY 04 2016            
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS            
*/           
        
create PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_01082016]            
AS            
SET NOCOUNT ON            
BEGIN            
        
            
--Declare @tdate as datetime = (select MAX(holddate) from VMSS_JVDP_file with (nolock))                        
/*      
declare @startdate datetime,@enddate datetime      
      
set @startdate=(Select TOP 1 sauda_date       
    from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC)       
    a ORDER BY sauda_date ASC )      
      
set @enddate=Convert(varchar(11),(Select TOP 1 sauda_date       
    from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC)       
    a ORDER BY sauda_date ASC ),121)+' 23:59:59'      
          
      
      
select * into #TBL_RMS_COLLECTION_CLI_ABL_HIST from       
TBL_RMS_COLLECTION_CLI_ABL_HIST with (nolock) where rms_date between @startdate and @enddate      
*/      
      
      
/*Added to consider clients who have not traded in last 5 days */      
select party_code,lastbilldate=max(lastbilldate) into #lastbilldate from       
 GENERAL.DBO.RMS_DtclFi with (nolock) where co_code in ('BSECM','NSECM','NSEFO','MCD','NSX')       
 group by party_code      
       
  select * into #traded5days from #lastbilldate where lastbilldate >      
 (Select TOP 1 sauda_date       
from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC)       
a ORDER BY sauda_date ASC       
 )       
       
       
       
            
 SELECT A.*            
 INTO #CLI            
 FROM (SELECT A.PARTY_CODE,            
 NON_CASH=0.00,            
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),            
 FOSHRT=CONVERT(MONEY, 0)            
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)            
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL A WITH (NOLOCK)            
  LEFT JOIN (SELECT PARTY_CODE,            
 NON_CASH=Sum(FinalAmount)            
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)            
 WHERE COLL_TYPE = 'SEC'            
 GROUP BY PARTY_CODE) B            
 ON A.PARTY_CODE = B.PARTY_CODE            
 where (A.Pure_Risk+A.proj_risk)<0 ) A            
 WHERE EXISTS (            
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)            
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)            
            
 /*AND A.PARTY_CODE='AND2731'*/           
       
       
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/      
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL b with (nolock) where b.Pure_Risk>=-25     
 and b.proj_risk>-501 and b.party_code=a.party_code      
       
 /*exclude client who have traded in 5 days*/      
 delete from #CLI where party_code in (select party_code from #traded5days)      
       
            
            
 UPDATE #CLI            
 SET FOSHRT = CASE            
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN            
 ELSE 0            
 END            
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)            
 WHERE CO_CODE = 'NSEFO'            
 AND #CLI.PARTY_CODE = B.PARTY_CODE            
 AND IMARGIN <> 0            
            
    /*            
 /*Client not active in NSE segment */            
 --Added for BSE by Renil on Feb 2 2016 as instructed by Vishal Gohil and Anil Wandhre            
 delete B from #CLI B where not exists            
 (select distinct cl_code from anand1.msajag.dbo.client_brok_Details A with (nolock)            
 where a.Exchange in ('BSE','NSE') and a.Segment='CAPITAL'            
 and a.cl_code=b.Party_code)            
    */            
            
           
 DELETE from #CLI where PARTY_CODE IN            
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK))            
            
             
             
             
             SELECT X.PARTY_CODE,                                              
                   NET_DEBIT,                      
         /*Change Id :: 2*/                      
                   --DPID,                                              
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                              
             NON_CASH,                                              
                   BLUECHIP=Isnull(BLUECHIP, 0),                                              
                   GOOD=Isnull(GOOD, 0),                                              
                   AVERAGE=Isnull(AVERAGE, 0),                                              
                   POOR=Isnull(POOR, 0),                                              
                   TOTAL=Isnull(TOTAL, 0),                                  
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                              
                   ADJ_VALUE=NET_DEBIT *-1,                      
                   EXCLUDE_FLAG=' ',                                              
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                              
                   GOOD_ADJ=CONVERT(MONEY, 0),                                              
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                              
                   POOR_ADJ=CONVERT(MONEY, 0),                       
                   FOSHRT                                              
            INTO   #FILE1                                              
            FROM   #CLI X                                              
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                              
                  ANGEL_BEN=Sum(CASE                                              
                                                           WHEN SOURCE <> 'DP' THEN TOTAL_WithHC                                              
                                                    ELSE 0                                              
                                                         END),                                              
        BLUECHIP=Sum(CASE                                              
                                                          WHEN NSE_APPROVED = 'BLUECHIP'                            
                                                               AND SOURCE = 'DP' THEN TOTAL_WithHC                                              
                    ELSE 0                                              
                                                        END),                                              
                                            GOOD=Sum(CASE                                              
                                                      WHEN NSE_APPROVED = 'GOOD'                                              
                                                           AND SOURCE = 'DP' THEN TOTAL_WithHC                                              
                                                      ELSE 0                                              
                                                    END),                                              
                                           AVERAGE=Sum(CASE                                              
                                                         WHEN NSE_APPROVED = 'AVERAGE'                                              
                                                              AND SOURCE = 'DP' THEN TOTAL_WithHC                                      
                                                         ELSE 0                                              
                                                       END),                                                                                     
                   POOR=Sum(CASE                                              
                                                      WHEN NSE_APPROVED = 'POOR'                                              
                                                           AND SOURCE = 'DP' THEN TOTAL_WithHC                                              
                                                      ELSE 0                                              
                                                    END),                                              
      TOTAL=Sum(TOTAL_WithHC)                                              
                                    FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)                                              
                                    GROUP  BY PARTY_CODE) Y                                              
                     ON X.PARTY_CODE = Y.PARTY_CODE                                              
                                              
                                                
            DELETE FROM #FILE1                                              
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                              
      FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                                
                                  WHERE  CL_TYPE = 'NRI'                                              
                                          OR BRANCH_CD = 'NRIS')                                              
                      
            
            UPDATE #FILE1                                              
            SET    ADJ_VALUE = 0                                              
            WHERE  ADJ_VALUE < 0                                              
                                              
            CREATE TABLE #FILE2                                              
              (                                              
                 SRNO         INT IDENTITY(1, 1),                                              
                 ISIN         CHAR(12),                                              
                 SCRIP_CD     VARCHAR(10),                                              
                 PARTY_CODE   VARCHAR(10),                                              
                 QTY          INT,                                              
                 ACCNO        VARCHAR(16),                                              
            TOTAL        MONEY,                                              
                 NSE_APPROVED VARCHAR(25),                                              
                 NET_DEBIT    MONEY DEFAULT 0,                                              
                 BEN_ADJUSTED MONEY DEFAULT 0,                                              
                 TOTAL_ADJ    MONEY DEFAULT 0,                                              
                 BALAFTERADJ  MONEY DEFAULT 0,                                              
                 QTY_ADJ      INT,      
                 CLS_rate MONEY,      
                 TOTAL_VALUE_ADJ MONEY,                                              
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                              
                 --FO_SHRT MONEY DEFAULT 0                                                  
              )                                              
                                              
            SELECT A.*,                                    
                   ADJ_VALUE AS TOTAL_ADJ,                                  
                   QTY_ADJ=CONVERT(INT, 0)                                              
            INTO   #FILET                                              
            FROM   (SELECT ISIN,                                              
                           SCRIP_CD,                                             
                           PARTY_CODE,                              
                           QTY=Sum(QTY),                                              
                           ACCNO,                                              
                           TOTAL=Sum(TOTAL),                                              
                           NSE_APPROVED                                              
   FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                              
                    GROUP  BY ISIN,                                              
                              SCRIP_CD,                                              
                              PARTY_CODE,                                              
                              ACCNO,                                              
                              NSE_APPROVED                                
                    HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                              
           (SELECT PARTY_CODE,                                              
                                        
                           ADJ_VALUE                                              
                    FROM   #FILE1                                              
                              
      WHERE  ADJ_VALUE > 0) B                                              
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                              
                              
            --DROP TABLE #CLIENT_LISTTOADJUST                                                  
            SELECT PARTY_CODE,                                              
                   NET_DEBIT,                                              
                   /*Change Id :: 2*/                      
                   --DPID,                                              
                   ADJ_VALUE,                                              
                   FOSHRT * -1                            AS FOSHRT,                                              
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM                                              
            INTO   #CLIENT_LISTTOADJUST                                              
            FROM   #FILE1                                              
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                                  
                      
            SELECT top 0 *                                              
            INTO   #ILLIQUIED_SCRIPS                                              
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP                                      
                                              
            
            
/*            
            
            SELECT ISIN,                                              
                   SCRIP_CD,                            
                   PARTY_CODE,                                              
                   QTY=Sum(QTY),                                              
                   ACCNO,                                              
                   TOTAL=Sum(TOTAL),                                              
                   NSE_APPROVED,                        
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,             
                   Sum(TOTAL) DESC) AS ROW_NUM                                              
            INTO   #DPHOLDING_TO_MOVE                                             
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                              
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                              
                     ON H.NSE_APPROVED = B.CATEGORYNAME               
            WHERE  EXISTS (SELECT PARTY_CODE                                              
                           FROM   #CLIENT_LISTTOADJUST C                                    
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                              
                   AND NOT EXISTS(SELECT *                                              
                                  FROM   #ILLIQUIED_SCRIPS I                                              
                                  WHERE  H.ISIN = I.ISIN)                                              
                   AND [SOURCE] = 'DP'                                              
                   AND TOTAL <> 0                                                                 
            GROUP  BY ISIN,                                              
                      SCRIP_CD,                                              
                      PARTY_CODE,                                              
                      ACCNO,                                              
                      NSE_APPROVED,                                              
                      B.DUMMY1                                              
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                
            ORDER  BY PARTY_CODE,                                              
                      ROW_NUM                                              
*/            
            
            
            SELECT ISIN,                                              
                   SCRIP_CD,                            
                   H.PARTY_CODE,                                              
                   QTY=Sum(QTY),                                              
                   ACCNO,                                              
                   TOTAL=Sum(TOTAL),                                              
                   NSE_APPROVED,                        
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,             
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)      
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)      
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))      
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                         
     b.srno ) AS ROW_NUM-- ,   clsrate=max(clsrate)                                         
                         
                         
            INTO   #DPHOLDING_TO_MOVE                                           
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                              
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                              
                     ON H.NSE_APPROVED = B.CATEGORYNAME                             
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                              
                           FROM   #CLIENT_LISTTOADJUST) C                                    
                           on C.PARTY_CODE = H.PARTY_CODE                                               
                   where NOT EXISTS(SELECT *                                              
                                  FROM   #ILLIQUIED_SCRIPS I                                              
                                  WHERE  H.ISIN = I.ISIN)                                              
                   AND [SOURCE] = 'DP'                                              
                   AND TOTAL <> 0                                                                 
            GROUP  BY ISIN,                                              
                      SCRIP_CD,                                              
                      H.PARTY_CODE,                                              
                      ACCNO,                  
                      NSE_APPROVED,                                              
                      B.srno                                              
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                
            ORDER  BY H.PARTY_CODE,                                              
                      ROW_NUM      
                            
                 /*      
                 /**************************Vishal gohil**************************************************************/      
   /****************************************************************************************/           
                 select x.* INTO   #DPHOLDING_TO_MOVE        
                 from                
            (SELECT ISIN,                                              
                   SCRIP_CD,                            
                   H.PARTY_CODE,                                              
                   QTY=Sum(QTY),                                              
                   ACCNO,                                              
                   TOTAL=Sum(TOTAL),                                              
    NSE_APPROVED,                        
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,             
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)      
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)      
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))      
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                         
     b.srno ) AS ROW_NUM,   clsrate=max(clsrate)                                         
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                              
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                              
                     ON H.NSE_APPROVED = B.CATEGORYNAME                             
--             K47437      
--K48042      
          inner join (SELECT PARTY_CODE,ADJ_VALUE                                              
                           FROM   #CLIENT_LISTTOADJUST) C                                    
                           on C.PARTY_CODE = H.PARTY_CODE                                               
                   where NOT EXISTS(SELECT *                                              
                                  FROM   #ILLIQUIED_SCRIPS I                                              
                                  WHERE  H.ISIN = I.ISIN)                                              
                   AND [SOURCE] = 'DP' and     NSE_APPROVED<>'Poor'                                          
                   AND TOTAL <> 0    -- and h.party_Code='K48042'                                                            
            GROUP  BY ISIN,                                              
                      SCRIP_CD,                                              
                      H.PARTY_CODE,                                              
                      ACCNO,                                              
                      NSE_APPROVED,                                              
                      B.srno                                              
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                
            union          
            SELECT ISIN,                                              
                   SCRIP_CD,                            
                   H.PARTY_CODE,                                              
                   QTY=Sum(QTY),                                              
                   ACCNO,                                              
                   TOTAL=Sum(TOTAL),                       
                   NSE_APPROVED,                        
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,             
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)      
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)      
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))      
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                         
     b.srno ) AS ROW_NUM ,   clsrate=max(clsrate)                      
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                              
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                              
                     ON H.NSE_APPROVED = B.CATEGORYNAME                             
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                              
                           FROM   #CLIENT_LISTTOADJUST) C                                    
                           on C.PARTY_CODE = H.PARTY_CODE                                               
                   where NOT EXISTS(SELECT *                                         
                                  FROM   #ILLIQUIED_SCRIPS I                                              
                                  WHERE  H.ISIN = I.ISIN)                                              
                   AND [SOURCE] = 'DP' and     NSE_APPROVED='Poor'                                          
                   AND TOTAL <> 0       --and h.party_code='K48042'                                                          
            GROUP  BY ISIN,                                              
                      SCRIP_CD,                                              
                      H.PARTY_CODE,                                              
                      ACCNO,                                              
                      NSE_APPROVED,                                              
                      B.srno                                              
            HAVING CONVERT(INT,Sum(QTY)) <> 0  )x                              
            ORDER  BY x.PARTY_CODE,                                              
                      ROW_NUM                            
                            
            
   update a set  row_num=b.row_num+a.row_num from #DPHOLDING_TO_MOVE a,      
   (select party_Code,row_num=MAX(row_num) from #DPHOLDING_TO_MOVE group by party_Code)b      
   where a.[party_Code]=b.party_Code and  a.nse_approved='Poor'      
         
   /****************************************************************************************/      
   /****************************************************************************************/      
   */      
                            
                            
                                              
            CREATE CLUSTERED INDEX [IX_Row_Num]                                              
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )               
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                              
                                              
            CREATE CLUSTERED INDEX [IX_Party_code]                                              
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                            
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                              
                                          
            CREATE CLUSTERED INDEX [IX_Party_code]                                                       ON #FILE2 ( [Party_Code] ASC )                                              
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                              
                                              
            DECLARE @PARTY_CNT      AS INT,                                              
                    @PARTY_CTR      AS INT,                                              
                    @SCRIP_CNT      AS INT,                                              
                    @SCRIP_CTR      AS INT,                          
                    @PARTY_CODE     AS VARCHAR(20),                                              
/*Change Id :: 2*/                      
                    --@DPID           AS VARCHAR(20),                                              
                    @FOSHORTAGE     AS MONEY,                                              
                    @ADJUSTMENT_AMT AS MONEY,                                              
                    @ADJUSTED_AMT   AS MONEY,                                              
                    @ADJ_QTY        AS INT,                                              
                    @QTY            AS INT,                                              
                    @VALUE          AS MONEY,                                              
                    @CLOSING_PRICE  AS MONEY,                                              
                  @NET_DEBIT  AS MONEY                                              
                                              
            SET @ADJUSTED_AMT = 0                                              
          SET @PARTY_CTR = 1                                              
                                              
            SELECT @PARTY_CNT = Count(*)                                              
            FROM   #CLIENT_LISTTOADJUST                                              
                                              
            --PRINT @PARTY_CNT                                                  
            WHILE( @PARTY_CTR <= @PARTY_CNT )                                     
              BEGIN                                              
                  SET @ADJUSTMENT_AMT = 0                                              
                  SET @FOSHORTAGE = 0                                              
                  SET @ADJUSTED_AMT = 0               
                                            
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                              
                                                  
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                              
                         @FOSHORTAGE = FOSHRT,                           
                         @NET_DEBIT = NET_DEBIT                                              
                  FROM   #CLIENT_LISTTOADJUST                                              
                  WHERE  ROW_NUM = @PARTY_CTR                  
                                              
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                              
                                              
                  SET @SCRIP_CTR = 1                                              
                                              
                  SELECT @SCRIP_CNT = Count(*)                                    
                  FROM   #DPHOLDING_TO_MOVE                                              
                  WHERE  PARTY_CODE = @PARTY_CODE                      
            
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                              
                    BEGIN                                              
                        SELECT @QTY = QTY,                                              
                  @VALUE = TOTAL,                                              
                               @CLOSING_PRICE = TOTAL / QTY                                              
                        FROM   #DPHOLDING_TO_MOVE                                              
                        WHERE  ROW_NUM = @SCRIP_CTR                                              
                               AND PARTY_CODE = @PARTY_CODE                                              
                                              
                        IF @ADJUSTMENT_AMT >= @VALUE                                      
                          BEGIN                                              
                              SET @ADJ_QTY = @QTY                                              
                                              
                 INSERT INTO #FILE2                                              
                                          (ISIN,                                              
                                           SCRIP_CD,                                              
                                           PARTY_CODE,                                              
                                           QTY,                                              
                                           ACCNO,                                              
                                           TOTAL,                                              
                                         NSE_APPROVED,                                              
                                           NET_DEBIT,                                              
 QTY_ADJ,                                              
                                           FO_APPROVED)                                              
                              SELECT ISIN,                                              
                                     SCRIP_CD,                                              
                                     PARTY_CODE,                                              
                                     QTY,                                              
                                     ACCNO,                                              
                                     TOTAL,                                              
                                     NSE_APPROVED,                                              
                                     @NET_DEBIT,                                              
                                     @ADJ_QTY,                                              
                          CASE                                              
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                              
                                ELSE 'N'                                              
                              END                                    
                              FROM   #DPHOLDING_TO_MOVE                                              
                              WHERE  ROW_NUM = @SCRIP_CTR                                              
                                     AND PARTY_CODE = @PARTY_CODE                                              
                                              
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                              
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                              
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                              
                          END                                              
                        ELSE                                   
                          BEGIN                                              
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                              
                                              
                              INSERT INTO #FILE2                                              
                              (ISIN,                                              
                                           SCRIP_CD,                          
                                           PARTY_CODE,                                              
                                           QTY,                                              
                                           ACCNO,                                              
                                           TOTAL,                                              
                                           NSE_APPROVED,                                              
                                           NET_DEBIT,                                    
                                           QTY_ADJ,                                              
                                           FO_APPROVED)                                              
                              SELECT ISIN,                                              
                                     SCRIP_CD,                                              
                                     Ltrim(Rtrim(PARTY_CODE)),                                              
                                     QTY,                                              
                                     ACCNO,                                              
                                     TOTAL,                                              
                                     NSE_APPROVED,                                              
                                     @NET_DEBIT,                              
                                     @ADJ_QTY,                                              
                                     CASE                                              
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                              
                                       ELSE 'N'                                              
                                     END                                              
                              FROM   #DPHOLDING_TO_MOVE                                              
                              WHERE  ROW_NUM = @SCRIP_CTR                                              
                                     AND PARTY_CODE = @PARTY_CODE                                              
                                              
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                              
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                              
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                    
                                              
                              BREAK                                              
                          END                                       
                                              
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                              
                    END                                              
                                 
                  UPDATE #FILE2                                     
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                              
                         TOTAL_ADJ = @ADJUSTED_AMT                                              
                  WHERE  PARTY_CODE = @PARTY_CODE                                              
                       
                  SET @PARTY_CTR = @PARTY_CTR + 1                          
              END                                              
                                              
                        
            UPDATE #FILE2                                              
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                              
                        
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                              
            FROM   #FILE1 B                                              
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                              
                                    
                                    
            UPDATE #FILE2                        
                SET FO_APPROVED = 'N'                        
            WHERE UPPER(NSE_APPROVED) = 'POOR'            
                  
                   
              UPDATE #FILE2 SET cls_rate=A.clsrate from      
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B      
              GROUP  BY B.ISIN,                                              
                      B.SCRIP_CD,                                              
                      B.PARTY_CODE,                                              
                      B.ACCNO, B.clsrate,                                             
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED      
                         
        
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate      
                    
                    
         
                        
            DECLARE @DT AS DATETIME                                              
                                              
            SET @DT=Getdate()                                              
                                        
           
               
   INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                              
            SELECT DISTINCT *         
            FROM   VMSS_PURERISK_DPHOLDING                                              
                                              
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                      
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                              
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                              
                                     
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)           
                      
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                              
                                              
            INSERT INTO VMSS_PURERISK_DPHOLDING                                             
            SELECT DISTINCT *,                                              
                   @DT AS PROCESS_DATE,'','',''                                              
            FROM   #FILE2                                              
            WHERE  QTY_ADJ > 0                                              
                                           
            /*use general                                                                
            alter table POA_DP_Adj_Ben add FOShrt money                                                                
            use history                                                                
            alter table POA_DP_Adj_Ben add FOShrt money                                                                
            */                                              
                        
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                              
            SELECT DISTINCT *                                       
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                              
                                              
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                              
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                       
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                              
                      
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                      
                                              
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                              
            SELECT DISTINCT PARTY_CODE,                                              
                   NET_DEBIT,                                              
                   ANGEL_BEN,                                              
                   @DT AS PROCESS_DATE,                                              
                   NON_CASH,                                              
                   FOSHRT             
            FROM   #FILE1                                              
                                        
                                       
     /*
         SELECT A.party_code,A.AdjAmt ,                                      
                   B.MOBILE_PAGER                                        
            INTO   #SEND1                                        
            FROM     
            (select Party_code,AdjAmt=sum(Total_Adj_Value) from VMSS_PURERISK_DPHOLDING where ToSegment is not null group by Party_code) A   
            LEFT OUTER JOIN general.dbo.CLIENT_DETAILS B WITH (NOLOCK)                                        
            ON A.PARTY_CODE = B.PARTY_CODE where B.Mobile_pager is not null  
                           
               
                    INSERT INTO INTRANET.SMS.DBO.SMS                                        
                    SELECT party_code,MOBILE_PAGER,                                        
      
                    'Dear client,Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 1860 500 5006.',                                      
                     CONVERT(VARCHAR(11), Getdate(), 103),                                        
                     Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                        
                     'P',                                        
                     RIGHT(Getdate(), 2),                                        
                     'New POA Debit Client'                                        
                     FROM   #SEND1       
          
           
      */      
            
END            
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_02082017
-- --------------------------------------------------
              
/*                    
CREATED BY :: RENIL PILLAI                    
CREATED ON :: MAY 04 2016                    
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS                    
*/                   
                
create PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_02082017]                    
AS                    
SET NOCOUNT ON                    
BEGIN                    
      
       
 select party_code,pure_risk,proj_risk,rms_date=cast(rms_date as date),      
 risktype=case when pure_risk<-100 then 'Pure'      
 else 'Projected' end      
  into #temp_Riskdata from history.dbo.TBL_RMS_COLLECTION_CLI_ABL_HIST with (nolock)  where        
 cast(rms_date as date)>cast((getdate()-6) as date)       
 and (pure_risk<-100 or  proj_risk<-501)      
       
 select party_code,risktype=min(risktype) into #final from #temp_Riskdata  group by party_code having count(party_code)>=5      
                   
 SELECT A.*      
 INTO #CLI                    
 FROM (SELECT A.PARTY_CODE,                    
 NON_CASH=0.00,                    
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),                    
 FOSHRT=CONVERT(MONEY, 0) ,  risktype                 
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)                    
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL A WITH (NOLOCK)   inner join #final F on A.party_code=F.party_code                 
  LEFT JOIN (SELECT PARTY_CODE,                    
 NON_CASH=Sum(FinalAmount)                    
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)                    
 WHERE COLL_TYPE = 'SEC'                    
 GROUP BY PARTY_CODE) B                    
 ON A.PARTY_CODE = B.PARTY_CODE                    
 where (A.Pure_Risk+A.proj_risk)<0 ) A                    
 WHERE EXISTS (                    
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)                    
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)                    
                    
 /*AND A.PARTY_CODE='AND2731'*/                   
               
               
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/              
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL b with (nolock) where b.Pure_Risk>=-100             
 and b.proj_risk>-501 and b.party_code=a.party_code              
               
 --/*exclude client who have traded in 5 days*/              
 --delete from #CLI where party_code in (select party_code from #traded5days)              
                  
 UPDATE #CLI                    
 SET FOSHRT = CASE                    
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN                    
 ELSE 0                    
 END                    
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)                    
 WHERE CO_CODE = 'NSEFO'                    
 AND #CLI.PARTY_CODE = B.PARTY_CODE                    
 AND IMARGIN <> 0                    
                            
 DELETE from #CLI where PARTY_CODE IN                    
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK))                    
                    
 SELECT X.PARTY_CODE,                                                      
                   NET_DEBIT,                                                                             
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                                      
                   NON_CASH,                                                      
                   BLUECHIP=Isnull(BLUECHIP, 0),                                                      
                   GOOD=Isnull(GOOD, 0),                                                      
                   AVERAGE=Isnull(AVERAGE, 0),                                                      
                   POOR=Isnull(POOR, 0),                                                      
                   TOTAL=Isnull(TOTAL, 0),                                          
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                                      
                   ADJ_VALUE=NET_DEBIT *-1,                                               EXCLUDE_FLAG=' ',                                                      
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                          
                   GOOD_ADJ=CONVERT(MONEY, 0),                                                      
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                                      
                   POOR_ADJ=CONVERT(MONEY, 0),                               
                   FOSHRT,risktype      
            INTO   #FILE1                                                      
            FROM   #CLI X                                                      
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                                      
                  ANGEL_BEN=Sum(CASE WHEN SOURCE <> 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  BLUECHIP=Sum(CASE WHEN NSE_APPROVED = 'BLUECHIP' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  GOOD=Sum(CASE WHEN NSE_APPROVED = 'GOOD' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  AVERAGE=Sum(CASE WHEN NSE_APPROVED = 'AVERAGE' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                                                             
                  POOR=Sum(CASE  WHEN NSE_APPROVED = 'POOR' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  TOTAL=Sum(TOTAL_WithHC)                                                      
                  FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)GROUP  BY PARTY_CODE) Y                                                      
                  ON X.PARTY_CODE = Y.PARTY_CODE                                                      
                                                      
                                                        
            DELETE FROM #FILE1                                                      
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                                      
            FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                                        
                                  WHERE  CL_TYPE = 'NRI'                                                      
                                          OR BRANCH_CD = 'NRIS')                                                        
            UPDATE #FILE1                                                      
            SET    ADJ_VALUE = 0                                                      
            WHERE  ADJ_VALUE < 0                                                      
                                                      
            CREATE TABLE #FILE2                                                      
              (                                                      
                 SRNO         INT IDENTITY(1, 1),                                                      
                 ISIN         CHAR(12),                                                      
                 SCRIP_CD     VARCHAR(10),                                                      
                 PARTY_CODE   VARCHAR(10),                                                      
                 QTY          INT,                                                      
                 ACCNO        VARCHAR(16),                                                      
                 TOTAL        MONEY,                                                      
                 NSE_APPROVED VARCHAR(25),                                                      
                 NET_DEBIT    MONEY DEFAULT 0,                                                
                 BEN_ADJUSTED MONEY DEFAULT 0,                                                      
                 TOTAL_ADJ    MONEY DEFAULT 0,                    
                 BALAFTERADJ  MONEY DEFAULT 0,                                                      
                 QTY_ADJ      INT,              
                 CLS_rate MONEY,              
                 TOTAL_VALUE_ADJ MONEY,                                                      
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                                      
                 --FO_SHRT MONEY DEFAULT 0                                                          
              )                                                      
                                                      
            SELECT A.*,                                            
                   ADJ_VALUE AS TOTAL_ADJ,                                          
       QTY_ADJ=CONVERT(INT, 0)                                                      
            INTO   #FILET                                                      
            FROM   (SELECT ISIN,                                                      
                           SCRIP_CD,                                                     
                           PARTY_CODE,                                      
                           QTY=Sum(QTY),                                                      
                           ACCNO,                                                      
                           TOTAL=Sum(TOTAL),                                                      
                           NSE_APPROVED                                                      
            FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                                      
            GROUP  BY ISIN,SCRIP_CD,PARTY_CODE,ACCNO,NSE_APPROVED HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                                      
           (SELECT PARTY_CODE,                                                      
                    ADJ_VALUE                                                      
                    FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0) B                                                      
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                                      
                                      
                                      
            --DROP TABLE #CLIENT_LISTTOADJUST                                                          
            SELECT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   /*Change Id :: 2*/                              
                   --DPID,                                                      
                   ADJ_VALUE,                                                      
                   FOSHRT * -1                            AS FOSHRT,                                                      
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM,      
                   risktype                                                      
            INTO   #CLIENT_LISTTOADJUST                                                      
            FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                                          
                              
            SELECT top 0 *                                                      
            INTO   #ILLIQUIED_SCRIPS                                                      
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP            
                                                   
                    
                    
/*                    
                    
           SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   PARTY_CODE,                                                      
                   QTY=Sum(QTY),            
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,                     
                   Sum(TOTAL) DESC) AS ROW_NUM                                                      
            INTO   #DPHOLDING_TO_MOVE                        
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                       
            WHERE  EXISTS (SELECT PARTY_CODE                                                      
                           FROM   #CLIENT_LISTTOADJUST C                                            
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                                      
                   AND NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                                                      
                      B.DUMMY1                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY PARTY_CODE,                                                      
                      ROW_NUM                                                      
*/                    
                    
                    
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM-- ,   clsrate=max(clsrate)             
                    ,risktype       =max(c.risktype)      
                                 
            INTO   #DPHOLDING_TO_MOVE                                                   
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE,                                                      
                      ROW_NUM            
          
    /*Added by Vishal Gohil to exclude poor scrip from projected category on 21/07/2016 by Renil and Abha*/                        
 delete from #DPHOLDING_TO_MOVE  where risktype='Projected' and nse_approved='Poor'      
       
       
                                    
                 /*              
                 /**************************Vishal gohil**************************************************************/              
   /****************************************************************************************/                   
                 select x.* INTO   #DPHOLDING_TO_MOVE                
                 from                        
            (SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
    NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM,   clsrate=max(clsrate)                                                 
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                     
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
--             K47437              
--K48042              
          inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED<>'Poor'                                                  
                   AND TOTAL <> 0    -- and h.party_Code='K48042'                                                                    
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                          
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            union                  
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                               
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM ,   clsrate=max(clsrate)                              
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                 
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED='Poor'                                                  
                   AND TOTAL <> 0       --and h.party_code='K48042'                                                                  
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                   
                      NSE_APPROVED,                                                      
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0  )x                                      
            ORDER  BY x.PARTY_CODE,                                                      
                      ROW_NUM                                    
                                    
                    
   update a set  row_num=b.row_num+a.row_num from #DPHOLDING_TO_MOVE a,              
   (select party_Code,row_num=MAX(row_num) from #DPHOLDING_TO_MOVE group by party_Code)b              
   where a.[party_Code]=b.party_Code and  a.nse_approved='Poor'              
                 
   /****************************************************************************************/              
   /****************************************************************************************/              
   */              
                                    
                                    
                                                      
            CREATE CLUSTERED INDEX [IX_Row_Num]                                                      
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )                       
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            CREATE CLUSTERED INDEX [IX_Party_code]                                                      
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                                    
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                  
            CREATE CLUSTERED INDEX [IX_Party_code]                                                       ON #FILE2 ( [Party_Code] ASC )                                                      
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            DECLARE @PARTY_CNT      AS INT,                                                      
                    @PARTY_CTR      AS INT,                                                      
                    @SCRIP_CNT      AS INT,                                                      
                    @SCRIP_CTR      AS INT,                                  
                    @PARTY_CODE     AS VARCHAR(20),                                                      
/*Change Id :: 2*/                              
                    --@DPID           AS VARCHAR(20),                                                      
                    @FOSHORTAGE     AS MONEY,                                                      
                    @ADJUSTMENT_AMT AS MONEY,                                                      
                    @ADJUSTED_AMT   AS MONEY,                                                      
                    @ADJ_QTY        AS INT,                                                      
                    @QTY            AS INT,                                      
                    @VALUE          AS MONEY,                                                      
                    @CLOSING_PRICE  AS MONEY,                                                      
                  @NET_DEBIT  AS MONEY                                                      
                                                      
            SET @ADJUSTED_AMT = 0                                                      
          SET @PARTY_CTR = 1                                                      
           
            SELECT @PARTY_CNT = Count(*)                                                      
            FROM   #CLIENT_LISTTOADJUST                                                      
                                                      
            --PRINT @PARTY_CNT                                                          
            WHILE( @PARTY_CTR <= @PARTY_CNT )                                             
              BEGIN                                                      
                  SET @ADJUSTMENT_AMT = 0                                                      
                  SET @FOSHORTAGE = 0                                                      
                  SET @ADJUSTED_AMT = 0                      
                                                    
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                                      
                                                          
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                                      
                         @FOSHORTAGE = FOSHRT,                                   
                         @NET_DEBIT = NET_DEBIT                                                      
                  FROM   #CLIENT_LISTTOADJUST                                                      
                  WHERE  ROW_NUM = @PARTY_CTR                          
                                                      
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                                      
                                                      
                  SET @SCRIP_CTR = 1                                                      
                                                      
                  SELECT @SCRIP_CNT = Count(*)                                            
                  FROM   #DPHOLDING_TO_MOVE                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                              
                    
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                                      
                    BEGIN                                                      
                        SELECT @QTY = QTY,                                                      
                  @VALUE = TOTAL,                                                      
                               @CLOSING_PRICE = TOTAL / QTY                                                      
                        FROM   #DPHOLDING_TO_MOVE                                                      
                        WHERE  ROW_NUM = @SCRIP_CTR                                                      
                               AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                        IF @ADJUSTMENT_AMT >= @VALUE                                              
                          BEGIN                                                      
                              SET @ADJ_QTY = @QTY                                                      
                                                      
                 INSERT INTO #FILE2                                                      
                                          (ISIN,                                           
                                           SCRIP_CD,                                                      
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                           TOTAL,                                                      
                                           NSE_APPROVED,                              
                                           NET_DEBIT,                                                      
             QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
                                     PARTY_CODE,                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                        TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                                      
                                     @ADJ_QTY,                                                      
                          CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                ELSE 'N'                                                      
                              END                                            
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                                      
                          END                                                      
                        ELSE                                           
                          BEGIN                                                      
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                                      
                                                      
                              INSERT INTO #FILE2                                                      
                              (ISIN,                                                      
                                           SCRIP_CD,                                  
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                  TOTAL,                                                      
                                           NSE_APPROVED,                                                      
                                           NET_DEBIT,                                            
                                           QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
               Ltrim(Rtrim(PARTY_CODE)),                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                                     TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                      
                                     @ADJ_QTY,                                                      
                                     CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                   ELSE 'N'                                                      
                                     END                                                      
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                            
                                                      
                              BREAK                                                      
                          END                                               
                                                      
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                                      
                    END                                                      
                                         
                  UPDATE #FILE2                                             
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                                      
                         TOTAL_ADJ = @ADJUSTED_AMT                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                                                      
                               
                  SET @PARTY_CTR = @PARTY_CTR + 1                                  
              END                                                      
                                                      
                                
            UPDATE #FILE2                                                      
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                                      
                                
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                                      
            FROM   #FILE1 B                                                      
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                                      
                                            
                                            
            UPDATE #FILE2                                
                SET FO_APPROVED = 'N'                                
            WHERE UPPER(NSE_APPROVED) = 'POOR'                    
                          
                           
              UPDATE #FILE2 SET cls_rate=A.clsrate from              
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B              
              GROUP  BY B.ISIN,                                                      
                      B.SCRIP_CD,                                                      
                      B.PARTY_CODE,                                                      
                      B.ACCNO, B.clsrate,                                                     
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED              
                                 
                
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate              
                            
                            
           /*select * from #FILE2 x inner join #cli y on x.party_code=y.party_code*/      
                                
            DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()                                                      
             
                 
                       
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                                      
            SELECT DISTINCT *                 
            FROM   VMSS_PURERISK_DPHOLDING                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                              
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                                      
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                      
                                             
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)                   
                  
            /*      
              DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()       
            */                                                     
                                                  
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                                      
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDING                                                     
            SELECT DISTINCT x.*,                                                      
                   @DT AS PROCESS_DATE,'','','',y.risktype                                                      
            FROM   #FILE2 x  inner join #cli y on x.party_code=y.party_code                                                   
            WHERE  x.QTY_ADJ > 0                                                      
                                                   
            /*use general                                                                        
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            use history                                                
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            */                                                      
                  
            delete from  VMSS_PURERISK_DPHOLDING where party_code in (select party_code from general.dbo.client_details where NBFC_Cli='Y' )                   
            delete from VMSS_PURERISK_DPHOLDING where isin like '%INF%'     
                  
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                                      
            SELECT DISTINCT *                                               
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST       
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                               
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                      
                              
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                              
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                                      
            SELECT DISTINCT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   ANGEL_BEN,                                                      
                   @DT AS PROCESS_DATE,                                                      
                   NON_CASH,                                                      
                   FOSHRT                     
            FROM   #FILE1                                                      
                                     
           exec Pure_Risk_DP_Adj_file_mail             
                               
    --SMS Part      
    SELECT A.party_code,A.AdjAmt ,B.MOBILE_PAGER INTO #SEND1 FROM             
   (select Party_code,AdjAmt=sum(Total_Adj_Value) from VMSS_PURERISK_DPHOLDING where ToSegment is not null group by Party_code) A           
   LEFT OUTER JOIN general.dbo.CLIENT_DETAILS B WITH (NOLOCK)                                                
   ON A.PARTY_CODE = B.PARTY_CODE where B.Mobile_pager is not null          
                                   

   declare @TradingDay datetime   
    ;with sqoffdatae as  
    (  
    select ROW_NUMBER() over(order by a.Start_Date)as srno,  isnull(a.Start_Date,'')   Start_Date                                        
    from general.dbo.bse_sett_mst a                                                                        
    where CONVERT(VARCHAR(10),a.start_Date,121) >= CONVERT(VARCHAR(10),getdate(),121)                                                 
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                          
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                        
    group by Start_Date)  
    select @TradingDay = isnull(Start_Date ,'')  from sqoffdatae where srno=1 ;        
   
   if((DATEPART(DW,GETDATE())>=2 and  DATEPART(DW,GETDATE())<7) and cast(getdate() as date)=cast(@TradingDay as date))  
   begin      
                       
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                         
                  
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
    'P',RIGHT(Getdate(), 2), 'New POA Debit Client' FROM   #SEND1      
          
   /* sms log*/                           
   insert into Tbl_PureRiskAdj_SMS_log      
   SELECT party_code,MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                          
                 
   CONVERT(VARCHAR(11), Getdate(), 103)                                                                               
   FROM   #SEND1          
                            
   INSERT INTO INTRANET.SMS.DBO.SMS SELECT top 1  '9820701602',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                     
                       
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
   'P',RIGHT(Getdate(), 2),'New POA Debit Client' FROM   #SEND1 group by  party_code        
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9820731985','Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                            
   CONVERT(VARCHAR(11), Getdate(), 103), Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1 group by  party_code              
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9819090240',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                     
                       
   CONVERT(VARCHAR(11), Getdate(), 103),Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1  group by  party_code  
   end       
                    
              END                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_07092018
-- --------------------------------------------------
              
/*                    
CREATED BY :: RENIL PILLAI                    
CREATED ON :: MAY 04 2016                    
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS                    
*/                   
                
create PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_07092018]                    
AS                    
SET NOCOUNT ON                    
BEGIN                    
      
       
 select party_code,pure_risk,proj_risk,rms_date=cast(rms_date as date),      
 risktype=case when pure_risk<-100 then 'Pure'      
 else 'Projected' end      
  into #temp_Riskdata from history.dbo.TBL_RMS_COLLECTION_CLI_ABL_HIST with (nolock)  where        
 cast(rms_date as date)>cast((getdate()-6) as date)       
 and (pure_risk<-100 or  proj_risk<-501)      
       
 select party_code,risktype=min(risktype) into #final from #temp_Riskdata  group by party_code having count(party_code)>=5      
                   
 SELECT A.*      
 INTO #CLI                    
 FROM (SELECT A.PARTY_CODE,                    
 NON_CASH=0.00,                    
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),                    
 FOSHRT=CONVERT(MONEY, 0) ,  risktype                 
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)                    
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL A WITH (NOLOCK)   inner join #final F on A.party_code=F.party_code                 
  LEFT JOIN (SELECT PARTY_CODE,                    
 NON_CASH=Sum(FinalAmount)                    
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)                    
 WHERE COLL_TYPE = 'SEC'                    
 GROUP BY PARTY_CODE) B                    
 ON A.PARTY_CODE = B.PARTY_CODE                    
 where (A.Pure_Risk+A.proj_risk)<0 ) A                    
 WHERE EXISTS (                    
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)                    
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)                    
                    
 /*AND A.PARTY_CODE='AND2731'*/                   
               
               
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/              
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL b with (nolock) where b.Pure_Risk>=-100             
 and b.proj_risk>-501 and b.party_code=a.party_code              
               
 --/*exclude client who have traded in 5 days*/              
 --delete from #CLI where party_code in (select party_code from #traded5days)              
                  
 UPDATE #CLI                    
 SET FOSHRT = CASE                    
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN                    
 ELSE 0                    
 END                    
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)                    
 WHERE CO_CODE = 'NSEFO'                    
 AND #CLI.PARTY_CODE = B.PARTY_CODE                    
 AND IMARGIN <> 0                    
 
 /*                           
 DELETE from #CLI where PARTY_CODE IN                    
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK)) */--commented on Feb 02 2018 as suggested by Vishal Gohil                   
                    
 SELECT X.PARTY_CODE,                                                      
                   NET_DEBIT,                                                                             
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                                      
                   NON_CASH,                                                      
                   BLUECHIP=Isnull(BLUECHIP, 0),                                                      
                   GOOD=Isnull(GOOD, 0),                                                      
                   AVERAGE=Isnull(AVERAGE, 0),                                                      
                   POOR=Isnull(POOR, 0),                                                      
                   TOTAL=Isnull(TOTAL, 0),                                          
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                                      
                   ADJ_VALUE=NET_DEBIT *-1,                                               EXCLUDE_FLAG=' ',                                                      
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                          
                   GOOD_ADJ=CONVERT(MONEY, 0),                                                      
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                                      
                   POOR_ADJ=CONVERT(MONEY, 0),                               
                   FOSHRT,risktype      
            INTO   #FILE1                                                      
            FROM   #CLI X                                                      
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                                      
                  ANGEL_BEN=Sum(CASE WHEN SOURCE <> 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  BLUECHIP=Sum(CASE WHEN NSE_APPROVED = 'BLUECHIP' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  GOOD=Sum(CASE WHEN NSE_APPROVED = 'GOOD' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  AVERAGE=Sum(CASE WHEN NSE_APPROVED = 'AVERAGE' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                                                             
                  POOR=Sum(CASE  WHEN NSE_APPROVED = 'POOR' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  TOTAL=Sum(TOTAL_WithHC)                                                      
                  FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)GROUP  BY PARTY_CODE) Y                                                      
                  ON X.PARTY_CODE = Y.PARTY_CODE                                                      
                                                      
                                                        
            DELETE FROM #FILE1                                                      
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                                      
            FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                                        
                                  WHERE  CL_TYPE = 'NRI'                                                      
                                          OR BRANCH_CD = 'NRIS')                                                        
            UPDATE #FILE1                                                      
            SET    ADJ_VALUE = 0                                                      
            WHERE  ADJ_VALUE < 0                                                      
                                                      
            CREATE TABLE #FILE2                                                      
              (                                                      
                 SRNO         INT IDENTITY(1, 1),                                                      
                 ISIN         CHAR(12),                                                      
                 SCRIP_CD     VARCHAR(10),                                                      
                 PARTY_CODE   VARCHAR(10),                                                      
                 QTY          INT,                                                      
                 ACCNO        VARCHAR(16),                                                      
                 TOTAL        MONEY,                                                      
                 NSE_APPROVED VARCHAR(25),                                                      
                 NET_DEBIT    MONEY DEFAULT 0,                                                
                 BEN_ADJUSTED MONEY DEFAULT 0,                                                      
                 TOTAL_ADJ    MONEY DEFAULT 0,                    
                 BALAFTERADJ  MONEY DEFAULT 0,                                                      
                 QTY_ADJ      INT,              
                 CLS_rate MONEY,              
                 TOTAL_VALUE_ADJ MONEY,                                                      
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                                      
                 --FO_SHRT MONEY DEFAULT 0                                                          
              )                                                      
                                                      
            SELECT A.*,                                            
                   ADJ_VALUE AS TOTAL_ADJ,                                          
       QTY_ADJ=CONVERT(INT, 0)                                                      
            INTO   #FILET                                                      
            FROM   (SELECT ISIN,                                                      
                           SCRIP_CD,                                                     
                           PARTY_CODE,                                      
                           QTY=Sum(QTY),                                                      
                           ACCNO,                                                      
                           TOTAL=Sum(TOTAL),                                                      
                           NSE_APPROVED                                                      
            FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                                      
            GROUP  BY ISIN,SCRIP_CD,PARTY_CODE,ACCNO,NSE_APPROVED HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                                      
           (SELECT PARTY_CODE,                                                      
                    ADJ_VALUE                                                      
                    FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0) B                                                      
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                                      
                                      
                                      
            --DROP TABLE #CLIENT_LISTTOADJUST                                                          
            SELECT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   /*Change Id :: 2*/                              
                   --DPID,                                                      
                   ADJ_VALUE,                                                      
                   FOSHRT * -1                            AS FOSHRT,                                                      
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM,      
                   risktype                                                      
            INTO   #CLIENT_LISTTOADJUST                                                      
            FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                                          
                              
            SELECT top 0 *                                                      
            INTO   #ILLIQUIED_SCRIPS                                                      
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP            
                                                   
                    
                    
/*                    
                    
           SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   PARTY_CODE,                                                      
                   QTY=Sum(QTY),            
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,                     
                   Sum(TOTAL) DESC) AS ROW_NUM                                                      
            INTO   #DPHOLDING_TO_MOVE                        
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                       
            WHERE  EXISTS (SELECT PARTY_CODE                                                      
                           FROM   #CLIENT_LISTTOADJUST C                                            
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                                      
                   AND NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                                                      
                      B.DUMMY1                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY PARTY_CODE,                                                      
                      ROW_NUM                                                      
*/                    
                    
                    
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM-- ,   clsrate=max(clsrate)             
                    ,risktype       =max(c.risktype)      
                                 
            INTO   #DPHOLDING_TO_MOVE                                                   
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE,                                                      
                      ROW_NUM            
          
    /*Added by Vishal Gohil to exclude poor scrip from projected category on 21/07/2016 by Renil and Abha*/                        
 delete from #DPHOLDING_TO_MOVE  where risktype='Projected' and nse_approved='Poor'      
       
       
                                    
                 /*              
                 /**************************Vishal gohil**************************************************************/              
   /****************************************************************************************/                   
                 select x.* INTO   #DPHOLDING_TO_MOVE                
                 from                        
            (SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
    NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM,   clsrate=max(clsrate)                                                 
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                     
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
--             K47437              
--K48042              
          inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED<>'Poor'                                                  
                   AND TOTAL <> 0    -- and h.party_Code='K48042'                                                                    
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                          
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            union                  
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                               
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM ,   clsrate=max(clsrate)                              
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                 
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED='Poor'                                                  
                   AND TOTAL <> 0       --and h.party_code='K48042'                                                                  
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                   
                      NSE_APPROVED,                                                      
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0  )x                                      
            ORDER  BY x.PARTY_CODE,                                                      
                      ROW_NUM                                    
                                    
                    
   update a set  row_num=b.row_num+a.row_num from #DPHOLDING_TO_MOVE a,              
   (select party_Code,row_num=MAX(row_num) from #DPHOLDING_TO_MOVE group by party_Code)b              
   where a.[party_Code]=b.party_Code and  a.nse_approved='Poor'              
                 
   /****************************************************************************************/              
   /****************************************************************************************/              
   */              
                                    
                                    
                                                      
            CREATE CLUSTERED INDEX [IX_Row_Num]                                                      
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )                       
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            CREATE CLUSTERED INDEX [IX_Party_code]                                                      
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                                    
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                  
            CREATE CLUSTERED INDEX [IX_Party_code]                                                       ON #FILE2 ( [Party_Code] ASC )                                                      
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            DECLARE @PARTY_CNT      AS INT,                                                      
                    @PARTY_CTR      AS INT,                                                      
                    @SCRIP_CNT      AS INT,                                                      
                    @SCRIP_CTR      AS INT,                                  
                    @PARTY_CODE     AS VARCHAR(20),                                                      
/*Change Id :: 2*/                              
                    --@DPID           AS VARCHAR(20),                                                      
                    @FOSHORTAGE     AS MONEY,                                                      
                    @ADJUSTMENT_AMT AS MONEY,                                                      
                    @ADJUSTED_AMT   AS MONEY,                                                      
                    @ADJ_QTY        AS INT,                                                      
                    @QTY            AS INT,                                      
                    @VALUE          AS MONEY,                                                      
                    @CLOSING_PRICE  AS MONEY,                                                      
                  @NET_DEBIT  AS MONEY                                                      
                                                      
            SET @ADJUSTED_AMT = 0                                                      
          SET @PARTY_CTR = 1                                                      
           
            SELECT @PARTY_CNT = Count(*)                                                      
            FROM   #CLIENT_LISTTOADJUST                                                      
                                                      
            --PRINT @PARTY_CNT                                                          
            WHILE( @PARTY_CTR <= @PARTY_CNT )                                             
              BEGIN                                                      
                  SET @ADJUSTMENT_AMT = 0                                                      
                  SET @FOSHORTAGE = 0                                                      
                  SET @ADJUSTED_AMT = 0                      
                                                    
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                                      
                                                          
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                                      
                         @FOSHORTAGE = FOSHRT,                                   
                         @NET_DEBIT = NET_DEBIT                                                      
                  FROM   #CLIENT_LISTTOADJUST                                                      
                  WHERE  ROW_NUM = @PARTY_CTR                          
                                                      
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                                      
                                                      
                  SET @SCRIP_CTR = 1                                                      
                                                      
                  SELECT @SCRIP_CNT = Count(*)                                            
                  FROM   #DPHOLDING_TO_MOVE                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                              
                    
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                                      
                    BEGIN                                                      
                        SELECT @QTY = QTY,                                                      
                  @VALUE = TOTAL,                                                      
                               @CLOSING_PRICE = TOTAL / QTY                                                      
                        FROM   #DPHOLDING_TO_MOVE                                                      
                        WHERE  ROW_NUM = @SCRIP_CTR                                                      
                               AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                        IF @ADJUSTMENT_AMT >= @VALUE                                              
                          BEGIN                                                      
                              SET @ADJ_QTY = @QTY                                                      
                                                      
                 INSERT INTO #FILE2                                                      
                                          (ISIN,                                           
                                           SCRIP_CD,                                                      
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                           TOTAL,                                                      
                                           NSE_APPROVED,                              
                                           NET_DEBIT,                                                      
             QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
                                     PARTY_CODE,                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                        TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                                      
                                     @ADJ_QTY,                                                      
                          CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                ELSE 'N'                                                      
                              END                                            
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                                      
                          END                                                      
                        ELSE                                           
                          BEGIN                                                      
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                                      
                                                      
                              INSERT INTO #FILE2                                                      
                              (ISIN,                                                      
                                           SCRIP_CD,                                  
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                  TOTAL,                                                      
                                           NSE_APPROVED,                                                      
                                           NET_DEBIT,                                            
                                           QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
               Ltrim(Rtrim(PARTY_CODE)),                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                                     TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                      
                                     @ADJ_QTY,                                                      
                                     CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                   ELSE 'N'                                                      
                                     END                                                      
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                            
                                                      
                              BREAK                                                      
                          END                                               
                                                      
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                                      
                    END                                                      
                                         
                  UPDATE #FILE2                                             
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                                      
                         TOTAL_ADJ = @ADJUSTED_AMT                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                                                      
                               
                  SET @PARTY_CTR = @PARTY_CTR + 1                                  
              END                                                      
                                                      
                                
            UPDATE #FILE2                                                      
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                                      
                                
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                                      
            FROM   #FILE1 B                                                      
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                                      
                                            
                                            
            UPDATE #FILE2                                
                SET FO_APPROVED = 'N'                                
            WHERE UPPER(NSE_APPROVED) = 'POOR'                    
                          
                           
              UPDATE #FILE2 SET cls_rate=A.clsrate from              
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B              
              GROUP  BY B.ISIN,                                                      
                      B.SCRIP_CD,                                                      
                      B.PARTY_CODE,                                                      
                      B.ACCNO, B.clsrate,                                                     
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED              
                                 
                
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate              
                            
                            
           /*select * from #FILE2 x inner join #cli y on x.party_code=y.party_code*/      
                                
            DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()                                                      
             
                 
                       
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                                      
            SELECT DISTINCT *                 
            FROM   VMSS_PURERISK_DPHOLDING                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                              
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                                      
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                      
                                             
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)                   
                  
            /*      
              DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()       
            */                                                     
                                                  
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                                      
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDING                                                     
            SELECT DISTINCT x.*,                                                      
                   @DT AS PROCESS_DATE,'','','',y.risktype                                                      
            FROM   #FILE2 x  inner join #cli y on x.party_code=y.party_code                                                   
            WHERE  x.QTY_ADJ > 0                                                      
                                                   
            /*use general                                                                        
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            use history                                                
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            */                                                      
                  
            delete from  VMSS_PURERISK_DPHOLDING where party_code in (select party_code from general.dbo.client_details where NBFC_Cli='Y' )                   
            delete from VMSS_PURERISK_DPHOLDING where isin like '%INF%'     
                  
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                                      
            SELECT DISTINCT *                                               
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST       
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                               
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                      
                              
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                              
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                                      
            SELECT DISTINCT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   ANGEL_BEN,                                                      
                   @DT AS PROCESS_DATE,                                                      
                   NON_CASH,                                                      
                   FOSHRT                     
            FROM   #FILE1                                                      
                                     
           exec Pure_Risk_DP_Adj_file_mail             
   /*                         
    --SMS Part      
    SELECT A.party_code,A.AdjAmt ,B.MOBILE_PAGER INTO #SEND1 FROM             
   (select Party_code,AdjAmt=sum(Total_Adj_Value) from VMSS_PURERISK_DPHOLDING where ToSegment is not null group by Party_code) A           
   LEFT OUTER JOIN general.dbo.CLIENT_DETAILS B WITH (NOLOCK)                                                
   ON A.PARTY_CODE = B.PARTY_CODE where B.Mobile_pager is not null          
                                   

   declare @TradingDay datetime   
    ;with sqoffdatae as  
    (  
    select ROW_NUMBER() over(order by a.Start_Date)as srno,  isnull(a.Start_Date,'')   Start_Date                                        
    from general.dbo.bse_sett_mst a                                                                        
    where CONVERT(VARCHAR(10),a.start_Date,121) >= CONVERT(VARCHAR(10),getdate(),121)                                                 
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                          
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                        
    group by Start_Date)  
    select @TradingDay = isnull(Start_Date ,'')  from sqoffdatae where srno=1 ;        
   
   if((DATEPART(DW,GETDATE())>=2 and  DATEPART(DW,GETDATE())<7) and cast(getdate() as date)=cast(@TradingDay as date))  
   begin      
                       
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                         
                  
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
    'P',RIGHT(Getdate(), 2), 'New POA Debit Client' FROM   #SEND1      
          
   /* sms log*/                           
   insert into Tbl_PureRiskAdj_SMS_log      
   SELECT party_code,MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                          
                 
   CONVERT(VARCHAR(11), Getdate(), 103)                                                                               
   FROM   #SEND1          
                            
   INSERT INTO INTRANET.SMS.DBO.SMS SELECT top 1  '9820701602',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                     
                       
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
   'P',RIGHT(Getdate(), 2),'New POA Debit Client' FROM   #SEND1 group by  party_code        
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9820731985','Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                            
   CONVERT(VARCHAR(11), Getdate(), 103), Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1 group by  party_code              
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9819090240',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                     
                       
   CONVERT(VARCHAR(11), Getdate(), 103),Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1  group by  party_code  
   end   
   */    
                    
              END                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_09062016
-- --------------------------------------------------

/*      
CREATED BY :: RENIL PILLAI      
CREATED ON :: MAY 04 2016      
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS      
*/     
  
Create PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_09062016]      
AS      
SET NOCOUNT ON      
BEGIN      
  
      
--Declare @tdate as datetime = (select MAX(holddate) from VMSS_JVDP_file with (nolock))                  
/*
declare @startdate datetime,@enddate datetime

set @startdate=(Select TOP 1 sauda_date 
				from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC) 
				a ORDER BY sauda_date ASC )

set @enddate=Convert(varchar(11),(Select TOP 1 sauda_date 
				from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC) 
				a ORDER BY sauda_date ASC ),121)+' 23:59:59'
				


select * into #TBL_RMS_COLLECTION_CLI_ABL_HIST from 
TBL_RMS_COLLECTION_CLI_ABL_HIST with (nolock) where rms_date between @startdate and @enddate
*/


/*Added to consider clients who have not traded in last 5 days */
select party_code,lastbilldate=max(lastbilldate) into #lastbilldate from 
 GENERAL.DBO.RMS_DtclFi with (nolock) where co_code in ('BSECM','NSECM','NSEFO','MCD','NSX') 
 group by party_code
 
  select * into #traded5days from #lastbilldate where lastbilldate >
 (Select TOP 1 sauda_date 
from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC) 
a ORDER BY sauda_date ASC 
 ) 
 
 
 
      
 SELECT A.*      
 INTO #CLI      
 FROM (SELECT A.PARTY_CODE,      
 NON_CASH=0.00,      
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),      
 FOSHRT=CONVERT(MONEY, 0)      
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)      
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL A WITH (NOLOCK)      
  LEFT JOIN (SELECT PARTY_CODE,      
 NON_CASH=Sum(FinalAmount)      
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)      
 WHERE COLL_TYPE = 'SEC'      
 GROUP BY PARTY_CODE) B      
 ON A.PARTY_CODE = B.PARTY_CODE      
 where (A.Pure_Risk+A.proj_risk)<0 ) A      
 WHERE EXISTS (      
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)      
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)      
      
 /*AND A.PARTY_CODE='AND2731'*/     
 
 
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL b with (nolock) where b.Pure_Risk>=0
 and b.proj_risk>-501 and b.party_code=a.party_code
 
 /*exclude client who have traded in 5 days*/
 delete from #CLI where party_code in (select party_code from #traded5days)
 
      
      
 UPDATE #CLI      
 SET FOSHRT = CASE      
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN      
 ELSE 0      
 END      
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)      
 WHERE CO_CODE = 'NSEFO'      
 AND #CLI.PARTY_CODE = B.PARTY_CODE      
 AND IMARGIN <> 0      
      
    /*      
 /*Client not active in NSE segment */      
 --Added for BSE by Renil on Feb 2 2016 as instructed by Vishal Gohil and Anil Wandhre      
 delete B from #CLI B where not exists      
 (select distinct cl_code from anand1.msajag.dbo.client_brok_Details A with (nolock)      
 where a.Exchange in ('BSE','NSE') and a.Segment='CAPITAL'      
 and a.cl_code=b.Party_code)      
    */      
      
     
 DELETE from #CLI where PARTY_CODE IN      
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK))      
      
       
       
       
             SELECT X.PARTY_CODE,                                        
                   NET_DEBIT,                
                   /*Change Id :: 2*/                
                   --DPID,                                        
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                        
                   NON_CASH,                                        
                   BLUECHIP=Isnull(BLUECHIP, 0),                                        
                   GOOD=Isnull(GOOD, 0),                                        
                   AVERAGE=Isnull(AVERAGE, 0),                                        
                   POOR=Isnull(POOR, 0),                                        
                   TOTAL=Isnull(TOTAL, 0),                            
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                        
                   ADJ_VALUE=NET_DEBIT *-1,                
                   EXCLUDE_FLAG=' ',                                        
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                        
                   GOOD_ADJ=CONVERT(MONEY, 0),                                        
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                        
                   POOR_ADJ=CONVERT(MONEY, 0),                 
                   FOSHRT                                        
            INTO   #FILE1                                        
            FROM   #CLI X                                        
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                        
                  ANGEL_BEN=Sum(CASE                                        
                                                           WHEN SOURCE <> 'DP' THEN TOTAL_WithHC                                        
                                                    ELSE 0                                        
                                                         END),                                        
        BLUECHIP=Sum(CASE                                        
                                                          WHEN NSE_APPROVED = 'BLUECHIP'                      
                                                               AND SOURCE = 'DP' THEN TOTAL_WithHC                                        
                    ELSE 0                                        
                                                        END),                                        
                                            GOOD=Sum(CASE                                        
                                                      WHEN NSE_APPROVED = 'GOOD'                                        
                                                           AND SOURCE = 'DP' THEN TOTAL_WithHC                                        
                                                      ELSE 0                                        
                                                    END),                                        
                                           AVERAGE=Sum(CASE                                        
                                                         WHEN NSE_APPROVED = 'AVERAGE'                                        
                                                              AND SOURCE = 'DP' THEN TOTAL_WithHC                                
                                                         ELSE 0                                        
                                                       END),                                                                               
                                           POOR=Sum(CASE                                        
                                                      WHEN NSE_APPROVED = 'POOR'                                        
                                                           AND SOURCE = 'DP' THEN TOTAL_WithHC                                        
                                                      ELSE 0                                        
                                                    END),                                        
                                  TOTAL=Sum(TOTAL_WithHC)                                        
                                    FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)                                        
                                    GROUP  BY PARTY_CODE) Y                                        
                     ON X.PARTY_CODE = Y.PARTY_CODE                                        
                                        
                                          
            DELETE FROM #FILE1                                        
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                        
      FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                          
                                  WHERE  CL_TYPE = 'NRI'                                        
                                          OR BRANCH_CD = 'NRIS')                                        
                
      
            UPDATE #FILE1                                        
            SET    ADJ_VALUE = 0                                        
            WHERE  ADJ_VALUE < 0                                        
                                        
            CREATE TABLE #FILE2                                        
              (                                        
                 SRNO         INT IDENTITY(1, 1),                                        
                 ISIN         CHAR(12),                                        
                 SCRIP_CD     VARCHAR(10),                                        
                 PARTY_CODE   VARCHAR(10),                                        
                 QTY          INT,                                        
                 ACCNO        VARCHAR(16),                                        
            TOTAL        MONEY,                                        
                 NSE_APPROVED VARCHAR(25),                                        
                 NET_DEBIT    MONEY DEFAULT 0,                                        
                 BEN_ADJUSTED MONEY DEFAULT 0,                                        
                 TOTAL_ADJ    MONEY DEFAULT 0,                                        
                 BALAFTERADJ  MONEY DEFAULT 0,                                        
                 QTY_ADJ      INT,
                 CLS_rate MONEY,
                 TOTAL_VALUE_ADJ MONEY,                                        
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                        
                 --FO_SHRT MONEY DEFAULT 0                                            
              )                                        
                                        
            SELECT A.*,                              
                   ADJ_VALUE AS TOTAL_ADJ,                            
                   QTY_ADJ=CONVERT(INT, 0)                                        
            INTO   #FILET                                        
            FROM   (SELECT ISIN,                                        
                           SCRIP_CD,                                       
                           PARTY_CODE,                                        
                           QTY=Sum(QTY),                                        
                           ACCNO,                                        
                           TOTAL=Sum(TOTAL),                                        
                           NSE_APPROVED                                        
                    FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                        
                    GROUP  BY ISIN,                                        
                              SCRIP_CD,                                        
                              PARTY_CODE,                                        
                              ACCNO,                                        
                              NSE_APPROVED                          
                    HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                        
           (SELECT PARTY_CODE,                                        
                                  
                           ADJ_VALUE                                        
                    FROM   #FILE1                                        
                        
      WHERE  ADJ_VALUE > 0) B                                        
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                        
                        
            --DROP TABLE #CLIENT_LISTTOADJUST                                            
            SELECT PARTY_CODE,                                        
                   NET_DEBIT,                                        
                   /*Change Id :: 2*/                
                   --DPID,                                        
                   ADJ_VALUE,                                        
                   FOSHRT * -1                            AS FOSHRT,                                        
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM                                        
            INTO   #CLIENT_LISTTOADJUST                                        
            FROM   #FILE1                                        
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                            
                
            SELECT top 0 *                                        
            INTO   #ILLIQUIED_SCRIPS                                        
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP                                
                                        
      
      
/*      
      
            SELECT ISIN,                                        
                   SCRIP_CD,                      
                   PARTY_CODE,                                        
                   QTY=Sum(QTY),                                        
                   ACCNO,                                        
                   TOTAL=Sum(TOTAL),                                        
                   NSE_APPROVED,                  
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,       
                   Sum(TOTAL) DESC) AS ROW_NUM                                        
            INTO   #DPHOLDING_TO_MOVE                                       
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                        
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                        
                     ON H.NSE_APPROVED = B.CATEGORYNAME         
            WHERE  EXISTS (SELECT PARTY_CODE                                        
                           FROM   #CLIENT_LISTTOADJUST C                              
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                        
                   AND NOT EXISTS(SELECT *                                        
                                  FROM   #ILLIQUIED_SCRIPS I                                        
                                  WHERE  H.ISIN = I.ISIN)                                        
                   AND [SOURCE] = 'DP'                                        
                   AND TOTAL <> 0                                                           
            GROUP  BY ISIN,                                        
                      SCRIP_CD,                                        
                      PARTY_CODE,                                        
                      ACCNO,                                        
                      NSE_APPROVED,                                        
                      B.DUMMY1                                        
            HAVING CONVERT(INT,Sum(QTY)) <> 0                          
            ORDER  BY PARTY_CODE,                                        
                      ROW_NUM                                        
*/      
      
      
            SELECT ISIN,                                        
                   SCRIP_CD,                      
                   H.PARTY_CODE,                                        
                   QTY=Sum(QTY),                                        
                   ACCNO,                                        
                   TOTAL=Sum(TOTAL),                                        
                   NSE_APPROVED,                  
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,       
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                   
					b.srno	) AS ROW_NUM-- ,   clsrate=max(clsrate)                                   
                   
                   
            INTO   #DPHOLDING_TO_MOVE                                     
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                        
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                        
                     ON H.NSE_APPROVED = B.CATEGORYNAME                       
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                        
                           FROM   #CLIENT_LISTTOADJUST) C                              
                           on C.PARTY_CODE = H.PARTY_CODE                                         
                   where NOT EXISTS(SELECT *                                        
                                  FROM   #ILLIQUIED_SCRIPS I                                        
                                  WHERE  H.ISIN = I.ISIN)                                        
                   AND [SOURCE] = 'DP'                                        
                   AND TOTAL <> 0                                                           
            GROUP  BY ISIN,                                        
                      SCRIP_CD,                                        
                      H.PARTY_CODE,                                        
                      ACCNO,                                        
                      NSE_APPROVED,                                        
                      B.srno                                        
            HAVING CONVERT(INT,Sum(QTY)) <> 0                          
            ORDER  BY H.PARTY_CODE,                                        
                      ROW_NUM
                      
                      
        
                      
                      
                                        
            CREATE CLUSTERED INDEX [IX_Row_Num]                                        
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )         
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                        
                                        
            CREATE CLUSTERED INDEX [IX_Party_code]                                        
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                      
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                        
                                    
            CREATE CLUSTERED INDEX [IX_Party_code]                                   
              ON #FILE2 ( [Party_Code] ASC )                                        
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                        
                                        
            DECLARE @PARTY_CNT      AS INT,                                        
                    @PARTY_CTR      AS INT,                                        
                    @SCRIP_CNT      AS INT,                                        
                    @SCRIP_CTR      AS INT,                    
                    @PARTY_CODE     AS VARCHAR(20),                                        
                    /*Change Id :: 2*/                
                    --@DPID           AS VARCHAR(20),                                        
                    @FOSHORTAGE     AS MONEY,                                        
                    @ADJUSTMENT_AMT AS MONEY,                                        
                    @ADJUSTED_AMT   AS MONEY,                                        
                    @ADJ_QTY        AS INT,                                        
                    @QTY            AS INT,                                        
                    @VALUE          AS MONEY,                                        
                    @CLOSING_PRICE  AS MONEY,                                        
                  @NET_DEBIT  AS MONEY                                        
                                        
            SET @ADJUSTED_AMT = 0                                        
          SET @PARTY_CTR = 1                                        
                                        
            SELECT @PARTY_CNT = Count(*)                                        
            FROM   #CLIENT_LISTTOADJUST                                        
                                        
            --PRINT @PARTY_CNT                                            
            WHILE( @PARTY_CTR <= @PARTY_CNT )                               
              BEGIN                                        
                  SET @ADJUSTMENT_AMT = 0                                        
                  SET @FOSHORTAGE = 0                                        
                  SET @ADJUSTED_AMT = 0         
                                      
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                        
                                            
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                        
                         @FOSHORTAGE = FOSHRT,                     
                         @NET_DEBIT = NET_DEBIT                                        
                  FROM   #CLIENT_LISTTOADJUST                                        
                  WHERE  ROW_NUM = @PARTY_CTR            
                                        
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                        
                                        
                  SET @SCRIP_CTR = 1                                        
                                        
                  SELECT @SCRIP_CNT = Count(*)                              
                  FROM   #DPHOLDING_TO_MOVE                                        
                  WHERE  PARTY_CODE = @PARTY_CODE                
      
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                        
                    BEGIN                                        
                        SELECT @QTY = QTY,                                        
                               @VALUE = TOTAL,                                        
                               @CLOSING_PRICE = TOTAL / QTY                                        
                        FROM   #DPHOLDING_TO_MOVE                                        
                        WHERE  ROW_NUM = @SCRIP_CTR                                        
                               AND PARTY_CODE = @PARTY_CODE                                        
                                        
                        IF @ADJUSTMENT_AMT >= @VALUE                                
                          BEGIN                                        
                              SET @ADJ_QTY = @QTY                                        
                                        
                              INSERT INTO #FILE2                                        
                                          (ISIN,                                        
                                           SCRIP_CD,                                        
                                           PARTY_CODE,                                        
                                           QTY,                                        
                                           ACCNO,                                        
                                           TOTAL,                                        
                                         NSE_APPROVED,                                        
                                           NET_DEBIT,                                        
                                           QTY_ADJ,                                        
                                           FO_APPROVED)                                        
                              SELECT ISIN,                                        
                                     SCRIP_CD,                                        
                                     PARTY_CODE,                                        
                                     QTY,                                        
                                     ACCNO,                                        
                                     TOTAL,                                        
                                     NSE_APPROVED,                                        
                                     @NET_DEBIT,                                        
                                     @ADJ_QTY,                                        
                          CASE                                        
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                        
                                ELSE 'N'                                        
                              END                              
                              FROM   #DPHOLDING_TO_MOVE                                        
                              WHERE  ROW_NUM = @SCRIP_CTR                                        
                                     AND PARTY_CODE = @PARTY_CODE                                        
                                        
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                        
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                        
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                        
                          END                                        
                        ELSE                             
                          BEGIN                                        
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                        
                                        
                              INSERT INTO #FILE2                                        
                              (ISIN,                                        
                                           SCRIP_CD,                    
                                           PARTY_CODE,                                        
                                           QTY,                                        
                                           ACCNO,                                        
                                           TOTAL,                                        
                                           NSE_APPROVED,                                        
                                           NET_DEBIT,                                        
                                           QTY_ADJ,                                        
                                           FO_APPROVED)                                        
                              SELECT ISIN,                                        
                                     SCRIP_CD,                                        
                                     Ltrim(Rtrim(PARTY_CODE)),                                        
                                     QTY,                                        
                                     ACCNO,                                        
                                     TOTAL,                                        
                                     NSE_APPROVED,                                        
                                     @NET_DEBIT,                                        
                                     @ADJ_QTY,                                        
                                     CASE                                        
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                        
                                       ELSE 'N'                                        
                                     END                                        
                              FROM   #DPHOLDING_TO_MOVE                                        
                              WHERE  ROW_NUM = @SCRIP_CTR                                        
                                     AND PARTY_CODE = @PARTY_CODE                                        
                                        
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                        
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                        
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )              
                                        
                              BREAK                                        
                          END                                 
                                        
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                        
                    END                                        
                           
                  UPDATE #FILE2                               
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                        
                         TOTAL_ADJ = @ADJUSTED_AMT                                        
                  WHERE  PARTY_CODE = @PARTY_CODE                                        
                 
                  SET @PARTY_CTR = @PARTY_CTR + 1                                        
              END                                        
                                        
                  
            UPDATE #FILE2                                        
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                        
                  
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                        
            FROM   #FILE1 B                                        
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                        
                              
                              
            UPDATE #FILE2                  
                SET FO_APPROVED = 'N'                  
            WHERE UPPER(NSE_APPROVED) = 'POOR'      
            
             
              UPDATE #FILE2 SET cls_rate=A.clsrate from
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B
              GROUP  BY B.ISIN,                                        
                      B.SCRIP_CD,                                        
                      B.PARTY_CODE,                                        
                      B.ACCNO, B.clsrate,                                       
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED
                   
  
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate
   
                  
            DECLARE @DT AS DATETIME                                        
                                        
            SET @DT=Getdate()                                        
                                  
     
         
			INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                        
            SELECT DISTINCT *                                        
            FROM   VMSS_PURERISK_DPHOLDING                                        
                                        
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                        
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                        
                               
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)     
                
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                        
                                        
            INSERT INTO VMSS_PURERISK_DPHOLDING                                       
            SELECT DISTINCT *,                                        
                   @DT AS PROCESS_DATE,'','',''                                        
            FROM   #FILE2                                        
            WHERE  QTY_ADJ > 0                                        
                                     
            /*use general                                                          
            alter table POA_DP_Adj_Ben add FOShrt money                                                          
            use history                                                          
            alter table POA_DP_Adj_Ben add FOShrt money                                                          
            */                                        
                  
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                        
            SELECT DISTINCT *                                 
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                        
                                        
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                        
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                 
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                        
                
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                
                                        
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                        
            SELECT DISTINCT PARTY_CODE,                                        
                   NET_DEBIT,                                        
                   ANGEL_BEN,                                        
                   @DT AS PROCESS_DATE,                                        
                   NON_CASH,                                        
                   FOSHRT                                        
            FROM   #FILE1                                        
                                  
                                   
/*
         SELECT A.*,                                  
                   MOBILE_PAGER                                  
            INTO   #SEND1                                  
            FROM   (select Party_code,AdjAmt=sum(SqOffQty*Clsrate) from VMSS_PURERISK_DPHOLDING where ToSegment is not null
            and SqOffQty>0
	
					group by Party_code) A                                  
                   LEFT OUTER JOIN CLIENT_DETAILS B WITH (NOLOCK)                                  
                     ON A.PARTY_CODE = B.PARTY_CODE and a.party_code not in 
                      (select Party_code from #CLIENT    )                     
                     
         
                    INSERT INTO INTRANET.SMS.DBO.SMS                                  
				SELECT MOBILE_PAGER,                                  

                  'Dear Customer,Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c with us to broker margin A/c as per the POA given by you.Pl contact branch for queries.',                                
                  CONVERT(VARCHAR(11), Getdate(), 103),                                  
                   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                  
                   'P',                                  
                   RIGHT(Getdate(), 2),                                  
                   'New POA Debit Client'                                  
            FROM   #SEND1 
    
      
      */
      
END      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_20072017
-- --------------------------------------------------
              
/*                    
CREATED BY :: RENIL PILLAI                    
CREATED ON :: MAY 04 2016                    
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS                    
*/                   
                
Create PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_20072017]                    
AS                    
SET NOCOUNT ON                    
BEGIN                    
      
       
 select party_code,pure_risk,proj_risk,rms_date=cast(rms_date as date),      
 risktype=case when pure_risk<-100 then 'Pure'      
 else 'Projected' end      
  into #temp_Riskdata from history.dbo.TBL_RMS_COLLECTION_CLI_ABL_HIST with (nolock)  where        
 cast(rms_date as date)>cast((getdate()-6) as date)       
 and (pure_risk<-100 or  proj_risk<-501)      
       
 select party_code,risktype=min(risktype) into #final from #temp_Riskdata  group by party_code having count(party_code)>=5      
                   
 SELECT A.*      
 INTO #CLI                    
 FROM (SELECT A.PARTY_CODE,                    
 NON_CASH=0.00,                    
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),                    
 FOSHRT=CONVERT(MONEY, 0) ,  risktype                 
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)                    
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL A WITH (NOLOCK)   inner join #final F on A.party_code=F.party_code                 
  LEFT JOIN (SELECT PARTY_CODE,                    
 NON_CASH=Sum(FinalAmount)                    
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)                    
 WHERE COLL_TYPE = 'SEC'                    
 GROUP BY PARTY_CODE) B                    
 ON A.PARTY_CODE = B.PARTY_CODE                    
 where (A.Pure_Risk+A.proj_risk)<0 ) A                    
 WHERE EXISTS (                    
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)                    
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)                    
                    
 /*AND A.PARTY_CODE='AND2731'*/                   
               
               
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/              
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL b with (nolock) where b.Pure_Risk>=-100             
 and b.proj_risk>-501 and b.party_code=a.party_code              
               
 --/*exclude client who have traded in 5 days*/              
 --delete from #CLI where party_code in (select party_code from #traded5days)              
                  
 UPDATE #CLI                    
 SET FOSHRT = CASE                    
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN                    
 ELSE 0                    
 END                    
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)                    
 WHERE CO_CODE = 'NSEFO'                    
 AND #CLI.PARTY_CODE = B.PARTY_CODE                    
 AND IMARGIN <> 0                    
                            
 DELETE from #CLI where PARTY_CODE IN                    
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK))                    
                    
 SELECT X.PARTY_CODE,                                                      
                   NET_DEBIT,                                                                             
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                                      
                   NON_CASH,                                                      
                   BLUECHIP=Isnull(BLUECHIP, 0),                                                      
                   GOOD=Isnull(GOOD, 0),                                                      
                   AVERAGE=Isnull(AVERAGE, 0),                                                      
                   POOR=Isnull(POOR, 0),                                                      
                   TOTAL=Isnull(TOTAL, 0),                                          
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                                      
                   ADJ_VALUE=NET_DEBIT *-1,                                               EXCLUDE_FLAG=' ',                                                      
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                          
                   GOOD_ADJ=CONVERT(MONEY, 0),                                                      
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                                      
                   POOR_ADJ=CONVERT(MONEY, 0),                               
                   FOSHRT,risktype      
            INTO   #FILE1                                                      
            FROM   #CLI X                                                      
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                                      
                  ANGEL_BEN=Sum(CASE WHEN SOURCE <> 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  BLUECHIP=Sum(CASE WHEN NSE_APPROVED = 'BLUECHIP' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  GOOD=Sum(CASE WHEN NSE_APPROVED = 'GOOD' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  AVERAGE=Sum(CASE WHEN NSE_APPROVED = 'AVERAGE' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                                                             
                  POOR=Sum(CASE  WHEN NSE_APPROVED = 'POOR' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  TOTAL=Sum(TOTAL_WithHC)                                                      
                  FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)GROUP  BY PARTY_CODE) Y                                                      
                  ON X.PARTY_CODE = Y.PARTY_CODE                                                      
                                                      
                                                        
            DELETE FROM #FILE1                                                      
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                                      
            FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                                        
                                  WHERE  CL_TYPE = 'NRI'                                                      
                                          OR BRANCH_CD = 'NRIS')                                                        
            UPDATE #FILE1                                                      
            SET    ADJ_VALUE = 0                                                      
            WHERE  ADJ_VALUE < 0                                                      
                                                      
            CREATE TABLE #FILE2                                                      
              (                                                      
                 SRNO         INT IDENTITY(1, 1),                                                      
                 ISIN         CHAR(12),                                                      
                 SCRIP_CD     VARCHAR(10),                                                      
                 PARTY_CODE   VARCHAR(10),                                                      
                 QTY          INT,                                                      
                 ACCNO        VARCHAR(16),                                                      
                 TOTAL        MONEY,                                                      
                 NSE_APPROVED VARCHAR(25),                                                      
                 NET_DEBIT    MONEY DEFAULT 0,                                                
                 BEN_ADJUSTED MONEY DEFAULT 0,                                                      
                 TOTAL_ADJ    MONEY DEFAULT 0,                    
                 BALAFTERADJ  MONEY DEFAULT 0,                                                      
                 QTY_ADJ      INT,              
                 CLS_rate MONEY,              
                 TOTAL_VALUE_ADJ MONEY,                                                      
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                                      
                 --FO_SHRT MONEY DEFAULT 0                                                          
              )                                                      
                                                      
            SELECT A.*,                                            
                   ADJ_VALUE AS TOTAL_ADJ,                                          
       QTY_ADJ=CONVERT(INT, 0)                                                      
            INTO   #FILET                                                      
            FROM   (SELECT ISIN,                                                      
                           SCRIP_CD,                                                     
                           PARTY_CODE,                                      
                           QTY=Sum(QTY),                                                      
                           ACCNO,                                                      
                           TOTAL=Sum(TOTAL),                                                      
                           NSE_APPROVED                                                      
            FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                                      
            GROUP  BY ISIN,SCRIP_CD,PARTY_CODE,ACCNO,NSE_APPROVED HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                                      
           (SELECT PARTY_CODE,                                                      
                    ADJ_VALUE                                                      
                    FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0) B                                                      
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                                      
                                      
                                      
            --DROP TABLE #CLIENT_LISTTOADJUST                                                          
            SELECT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   /*Change Id :: 2*/                              
                   --DPID,                                                      
                   ADJ_VALUE,                                                      
                   FOSHRT * -1                            AS FOSHRT,                                                      
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM,      
                   risktype                                                      
            INTO   #CLIENT_LISTTOADJUST                                                      
            FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                                          
                              
            SELECT top 0 *                                                      
            INTO   #ILLIQUIED_SCRIPS                                                      
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP            
                                                   
                    
                    
/*                    
                    
           SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   PARTY_CODE,                                                      
                   QTY=Sum(QTY),            
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,                     
                   Sum(TOTAL) DESC) AS ROW_NUM                                                      
            INTO   #DPHOLDING_TO_MOVE                        
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                       
            WHERE  EXISTS (SELECT PARTY_CODE                                                      
                           FROM   #CLIENT_LISTTOADJUST C                                            
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                                      
                   AND NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                                                      
                      B.DUMMY1                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY PARTY_CODE,                                                      
                      ROW_NUM                                                      
*/                    
                    
                    
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM-- ,   clsrate=max(clsrate)             
                    ,risktype       =max(c.risktype)      
                                 
            INTO   #DPHOLDING_TO_MOVE                                                   
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE,                                                      
                      ROW_NUM            
          
    /*Added by Vishal Gohil to exclude poor scrip from projected category on 21/07/2016 by Renil and Abha*/                        
 delete from #DPHOLDING_TO_MOVE  where risktype='Projected' and nse_approved='Poor'      
       
       
                                    
                 /*              
                 /**************************Vishal gohil**************************************************************/              
   /****************************************************************************************/                   
                 select x.* INTO   #DPHOLDING_TO_MOVE                
                 from                        
            (SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
    NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM,   clsrate=max(clsrate)                                                 
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                     
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
--             K47437              
--K48042              
          inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED<>'Poor'                                                  
                   AND TOTAL <> 0    -- and h.party_Code='K48042'                                                                    
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                          
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            union                  
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                               
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM ,   clsrate=max(clsrate)                              
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                 
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED='Poor'                                                  
                   AND TOTAL <> 0       --and h.party_code='K48042'                                                                  
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                   
                      NSE_APPROVED,                                                      
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0  )x                                      
            ORDER  BY x.PARTY_CODE,                                                      
                      ROW_NUM                                    
                                    
                    
   update a set  row_num=b.row_num+a.row_num from #DPHOLDING_TO_MOVE a,              
   (select party_Code,row_num=MAX(row_num) from #DPHOLDING_TO_MOVE group by party_Code)b              
   where a.[party_Code]=b.party_Code and  a.nse_approved='Poor'              
                 
   /****************************************************************************************/              
   /****************************************************************************************/              
   */              
                                    
                                    
                                                      
            CREATE CLUSTERED INDEX [IX_Row_Num]                                                      
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )                       
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            CREATE CLUSTERED INDEX [IX_Party_code]                                                      
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                                    
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                  
            CREATE CLUSTERED INDEX [IX_Party_code]                                                       ON #FILE2 ( [Party_Code] ASC )                                                      
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            DECLARE @PARTY_CNT      AS INT,                                                      
                    @PARTY_CTR      AS INT,                                                      
                    @SCRIP_CNT      AS INT,                                                      
                    @SCRIP_CTR      AS INT,                                  
                    @PARTY_CODE     AS VARCHAR(20),                                                      
/*Change Id :: 2*/                              
                    --@DPID           AS VARCHAR(20),                                                      
                    @FOSHORTAGE     AS MONEY,                                                      
                    @ADJUSTMENT_AMT AS MONEY,                                                      
                    @ADJUSTED_AMT   AS MONEY,                                                      
                    @ADJ_QTY        AS INT,                                                      
                    @QTY            AS INT,                                      
                    @VALUE          AS MONEY,                                                      
                    @CLOSING_PRICE  AS MONEY,                                                      
                  @NET_DEBIT  AS MONEY                                                      
                                                      
            SET @ADJUSTED_AMT = 0                                                      
          SET @PARTY_CTR = 1                                                      
           
            SELECT @PARTY_CNT = Count(*)                                                      
            FROM   #CLIENT_LISTTOADJUST                                                      
                                                      
            --PRINT @PARTY_CNT                                                          
            WHILE( @PARTY_CTR <= @PARTY_CNT )                                             
              BEGIN                                                      
                  SET @ADJUSTMENT_AMT = 0                                                      
                  SET @FOSHORTAGE = 0                                                      
                  SET @ADJUSTED_AMT = 0                      
                                                    
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                                      
                                                          
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                                      
                         @FOSHORTAGE = FOSHRT,                                   
                         @NET_DEBIT = NET_DEBIT                                                      
                  FROM   #CLIENT_LISTTOADJUST                                                      
                  WHERE  ROW_NUM = @PARTY_CTR                          
                                                      
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                                      
                                                      
                  SET @SCRIP_CTR = 1                                                      
                                                      
                  SELECT @SCRIP_CNT = Count(*)                                            
                  FROM   #DPHOLDING_TO_MOVE                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                              
                    
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                                      
                    BEGIN                                                      
                        SELECT @QTY = QTY,                                                      
                  @VALUE = TOTAL,                                                      
                               @CLOSING_PRICE = TOTAL / QTY                                                      
                        FROM   #DPHOLDING_TO_MOVE                                                      
                        WHERE  ROW_NUM = @SCRIP_CTR                                                      
                               AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                        IF @ADJUSTMENT_AMT >= @VALUE                                              
                          BEGIN                                                      
                              SET @ADJ_QTY = @QTY                                                      
                                                      
                 INSERT INTO #FILE2                                                      
                                          (ISIN,                                           
                                           SCRIP_CD,                                                      
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                           TOTAL,                                                      
                                           NSE_APPROVED,                              
                                           NET_DEBIT,                                                      
             QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
                                     PARTY_CODE,                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                        TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                                      
                                     @ADJ_QTY,                                                      
                          CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                ELSE 'N'                                                      
                              END                                            
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                                      
                          END                                                      
                        ELSE                                           
                          BEGIN                                                      
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                                      
                                                      
                              INSERT INTO #FILE2                                                      
                              (ISIN,                                                      
                                           SCRIP_CD,                                  
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                  TOTAL,                                                      
                                           NSE_APPROVED,                                                      
                                           NET_DEBIT,                                            
                                           QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
               Ltrim(Rtrim(PARTY_CODE)),                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                                     TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                      
                                     @ADJ_QTY,                                                      
                                     CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                   ELSE 'N'                                                      
                                     END                                                      
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                            
                                                      
                              BREAK                                                      
                          END                                               
                                                      
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                                      
                    END                                                      
                                         
                  UPDATE #FILE2                                             
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                                      
                         TOTAL_ADJ = @ADJUSTED_AMT                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                                                      
                               
                  SET @PARTY_CTR = @PARTY_CTR + 1                                  
              END                                                      
                                                      
                                
            UPDATE #FILE2                                                      
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                                      
                                
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                                      
            FROM   #FILE1 B                                                      
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                                      
                                            
                                            
            UPDATE #FILE2                                
                SET FO_APPROVED = 'N'                                
            WHERE UPPER(NSE_APPROVED) = 'POOR'                    
                          
                           
              UPDATE #FILE2 SET cls_rate=A.clsrate from              
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B              
              GROUP  BY B.ISIN,                                                      
                      B.SCRIP_CD,                                                      
                      B.PARTY_CODE,                                                      
                      B.ACCNO, B.clsrate,                                                     
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED              
                                 
                
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate              
                            
                            
           /*select * from #FILE2 x inner join #cli y on x.party_code=y.party_code*/      
                                
            DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()                                                      
             
                 
                       
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                                      
            SELECT DISTINCT *                 
            FROM   VMSS_PURERISK_DPHOLDING                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                              
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                                      
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                      
                                             
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)                   
                  
            /*      
              DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()       
            */                                                     
                                                  
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                                      
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDING                                                     
            SELECT DISTINCT x.*,                                                      
                   @DT AS PROCESS_DATE,'','','',y.risktype                                                      
            FROM   #FILE2 x  inner join #cli y on x.party_code=y.party_code                                                   
            WHERE  x.QTY_ADJ > 0                                                      
                                                   
            /*use general                                                                        
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            use history                                                
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            */                                                      
                  
            delete from  VMSS_PURERISK_DPHOLDING where party_code in (select party_code from general.dbo.client_details where NBFC_Cli='Y' )                   
            delete from VMSS_PURERISK_DPHOLDING where isin like '%INF%'     
                  
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                                      
            SELECT DISTINCT *                                               
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST       
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                               
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                      
                              
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                              
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                                      
            SELECT DISTINCT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   ANGEL_BEN,                                                      
                   @DT AS PROCESS_DATE,                                                      
                   NON_CASH,                                                      
                   FOSHRT                     
            FROM   #FILE1                                                      
                                     
           exec Pure_Risk_DP_Adj_file_mail             
                               
    --SMS Part      
    SELECT A.party_code,A.AdjAmt ,B.MOBILE_PAGER INTO #SEND1 FROM             
   (select Party_code,AdjAmt=sum(Total_Adj_Value) from VMSS_PURERISK_DPHOLDING where ToSegment is not null group by Party_code) A           
   LEFT OUTER JOIN general.dbo.CLIENT_DETAILS B WITH (NOLOCK)                                                
   ON A.PARTY_CODE = B.PARTY_CODE where B.Mobile_pager is not null          
                                   

   declare @TradingDay datetime   
    ;with sqoffdatae as  
    (  
    select ROW_NUMBER() over(order by a.Start_Date)as srno,  isnull(a.Start_Date,'')   Start_Date                                        
    from general.dbo.bse_sett_mst a                                                                        
    where CONVERT(VARCHAR(10),a.start_Date,121) >= CONVERT(VARCHAR(10),getdate(),121)                                                 
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                          
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                        
    group by Start_Date)  
    select @TradingDay = isnull(Start_Date ,'')  from sqoffdatae where srno=1 ;        
   
   if((DATEPART(DW,GETDATE())>=2 and  DATEPART(DW,GETDATE())<7) and cast(getdate() as date)=cast(@TradingDay as date))  
   begin      
                       
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                         
                  
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
    'P',RIGHT(Getdate(), 2), 'New POA Debit Client' FROM   #SEND1      
          
   /* sms log*/                           
   insert into Tbl_PureRiskAdj_SMS_log      
   SELECT party_code,MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                          
                 
   CONVERT(VARCHAR(11), Getdate(), 103)                                                                               
   FROM   #SEND1          
                            
   INSERT INTO INTRANET.SMS.DBO.SMS SELECT top 1  '9820701602',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                     
                       
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
   'P',RIGHT(Getdate(), 2),'New POA Debit Client' FROM   #SEND1 group by  party_code        
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9820731985','Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                            
   CONVERT(VARCHAR(11), Getdate(), 103), Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1 group by  party_code              
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9819090240',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                     
                       
   CONVERT(VARCHAR(11), Getdate(), 103),Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1  group by  party_code  
   end       
                    
              END                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_27052016
-- --------------------------------------------------

/*      
CREATED BY :: RENIL PILLAI      
CREATED ON :: MAY 04 2016      
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS      
*/     
  
CREATE PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_27052016]      
AS      
SET NOCOUNT ON      
BEGIN      
  
      
--Declare @tdate as datetime = (select MAX(holddate) from VMSS_JVDP_file with (nolock))                  
/*
declare @startdate datetime,@enddate datetime

set @startdate=(Select TOP 1 sauda_date 
				from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC) 
				a ORDER BY sauda_date ASC )

set @enddate=Convert(varchar(11),(Select TOP 1 sauda_date 
				from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC) 
				a ORDER BY sauda_date ASC ),121)+' 23:59:59'
				


select * into #TBL_RMS_COLLECTION_CLI_ABL_HIST from 
TBL_RMS_COLLECTION_CLI_ABL_HIST with (nolock) where rms_date between @startdate and @enddate
*/


/*Added to consider clients who have not traded in last 5 days */
select party_code,lastbilldate=max(lastbilldate) into #lastbilldate from 
 GENERAL.DBO.RMS_DtclFi with (nolock) where co_code in ('BSECM','NSECM','NSEFO','MCD','NSX') 
 group by party_code
 
  select * into #traded5days from #lastbilldate where lastbilldate >
 (Select TOP 1 sauda_date 
from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC) 
a ORDER BY sauda_date ASC 
 ) 
 
 
 
      
 SELECT A.*      
 INTO #CLI      
 FROM (SELECT A.PARTY_CODE,      
 NON_CASH=0.00,      
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),      
 FOSHRT=CONVERT(MONEY, 0)      
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)      
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL A WITH (NOLOCK)      
  LEFT JOIN (SELECT PARTY_CODE,      
 NON_CASH=Sum(FinalAmount)      
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)      
 WHERE COLL_TYPE = 'SEC'      
 GROUP BY PARTY_CODE) B      
 ON A.PARTY_CODE = B.PARTY_CODE      
 where (A.Pure_Risk+A.proj_risk)<0 ) A      
 WHERE EXISTS (      
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)      
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)      
      
 /*AND A.PARTY_CODE='AND2731'*/     
 
 
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL b with (nolock) where b.Pure_Risk>=0
 and b.proj_risk>-501 and b.party_code=a.party_code
 
 /*exclude client who have traded in 5 days*/
 delete from #CLI where party_code in (select party_code from #traded5days)
 
      
      
 UPDATE #CLI      
 SET FOSHRT = CASE      
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN      
 ELSE 0      
 END      
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)      
 WHERE CO_CODE = 'NSEFO'      
 AND #CLI.PARTY_CODE = B.PARTY_CODE      
 AND IMARGIN <> 0      
      
    /*      
 /*Client not active in NSE segment */      
 --Added for BSE by Renil on Feb 2 2016 as instructed by Vishal Gohil and Anil Wandhre      
 delete B from #CLI B where not exists      
 (select distinct cl_code from anand1.msajag.dbo.client_brok_Details A with (nolock)      
 where a.Exchange in ('BSE','NSE') and a.Segment='CAPITAL'      
 and a.cl_code=b.Party_code)      
    */      
      
     
 DELETE from #CLI where PARTY_CODE IN      
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK))      
      
       
       
       
             SELECT X.PARTY_CODE,                                        
                   NET_DEBIT,                
                   /*Change Id :: 2*/                
                   --DPID,                                        
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                        
                   NON_CASH,                                        
                   BLUECHIP=Isnull(BLUECHIP, 0),                                        
                   GOOD=Isnull(GOOD, 0),                                        
                   AVERAGE=Isnull(AVERAGE, 0),                                        
                   POOR=Isnull(POOR, 0),                                        
                   TOTAL=Isnull(TOTAL, 0),                            
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                        
                   ADJ_VALUE=NET_DEBIT *-1,                
                   EXCLUDE_FLAG=' ',                                        
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                        
                   GOOD_ADJ=CONVERT(MONEY, 0),                                        
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                        
                   POOR_ADJ=CONVERT(MONEY, 0),                 
                   FOSHRT                                        
            INTO   #FILE1                                        
            FROM   #CLI X                                        
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                        
                  ANGEL_BEN=Sum(CASE                                        
                                                           WHEN SOURCE <> 'DP' THEN TOTAL_WithHC                                        
                                                    ELSE 0                                        
                                                         END),                                        
        BLUECHIP=Sum(CASE                                        
                                                          WHEN NSE_APPROVED = 'BLUECHIP'                      
                                                               AND SOURCE = 'DP' THEN TOTAL_WithHC                                        
                    ELSE 0                                        
                                                        END),                                        
                                            GOOD=Sum(CASE                                        
                                                      WHEN NSE_APPROVED = 'GOOD'                                        
                                                           AND SOURCE = 'DP' THEN TOTAL_WithHC                                        
                                                      ELSE 0                                        
                                                    END),                                        
                                           AVERAGE=Sum(CASE                                        
                                                         WHEN NSE_APPROVED = 'AVERAGE'                                        
                                                              AND SOURCE = 'DP' THEN TOTAL_WithHC                                
                                                         ELSE 0                                        
                                                       END),                                                                               
                                           POOR=Sum(CASE                                        
                                                      WHEN NSE_APPROVED = 'POOR'                                        
                                                           AND SOURCE = 'DP' THEN TOTAL_WithHC                                        
                                                      ELSE 0                                        
                                                    END),                                        
                                  TOTAL=Sum(TOTAL_WithHC)                                        
                                    FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)                                        
                                    GROUP  BY PARTY_CODE) Y                                        
                     ON X.PARTY_CODE = Y.PARTY_CODE                                        
                                        
                                          
            DELETE FROM #FILE1                                        
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                        
      FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                          
                                  WHERE  CL_TYPE = 'NRI'                                        
                                          OR BRANCH_CD = 'NRIS')                                        
                
      
            UPDATE #FILE1                                        
            SET    ADJ_VALUE = 0                                        
            WHERE  ADJ_VALUE < 0                                        
                                        
            CREATE TABLE #FILE2                                        
              (                                        
                 SRNO         INT IDENTITY(1, 1),                                        
                 ISIN         CHAR(12),                                        
                 SCRIP_CD     VARCHAR(10),                                        
                 PARTY_CODE   VARCHAR(10),                                        
                 QTY          INT,                                        
                 ACCNO        VARCHAR(16),                                        
            TOTAL        MONEY,                                        
                 NSE_APPROVED VARCHAR(25),                                        
                 NET_DEBIT    MONEY DEFAULT 0,                                        
                 BEN_ADJUSTED MONEY DEFAULT 0,                                        
                 TOTAL_ADJ    MONEY DEFAULT 0,                                        
                 BALAFTERADJ  MONEY DEFAULT 0,                                        
                 QTY_ADJ      INT,  
                 CLS_rate MONEY,
                 TOTAL_VALUE_ADJ MONEY,                                      
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                        
                 --FO_SHRT MONEY DEFAULT 0                                            
              )                                        
                                        
            SELECT A.*,                              
                   ADJ_VALUE AS TOTAL_ADJ,                            
                   QTY_ADJ=CONVERT(INT, 0)                                        
            INTO   #FILET                                        
            FROM   (SELECT ISIN,                                        
                           SCRIP_CD,                                       
                           PARTY_CODE,                                        
                           QTY=Sum(QTY),                                        
                           ACCNO,                                        
                           TOTAL=Sum(TOTAL),                                        
                           NSE_APPROVED                                        
                    FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                        
                    GROUP  BY ISIN,                                        
                              SCRIP_CD,                                        
                              PARTY_CODE,                                        
                              ACCNO,                                        
                              NSE_APPROVED                          
                    HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                        
           (SELECT PARTY_CODE,                                        
                                  
                           ADJ_VALUE                                        
                    FROM   #FILE1                                        
                        
      WHERE  ADJ_VALUE > 0) B                                        
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                        
                        
            --DROP TABLE #CLIENT_LISTTOADJUST                                            
            SELECT PARTY_CODE,                                        
                   NET_DEBIT,                                        
                   /*Change Id :: 2*/                
                   --DPID,                                        
                   ADJ_VALUE,                                        
                   FOSHRT * -1                            AS FOSHRT,                                        
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM                                        
            INTO   #CLIENT_LISTTOADJUST                                        
            FROM   #FILE1                                        
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                            
                
            SELECT top 0 *                                        
            INTO   #ILLIQUIED_SCRIPS                                        
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP                                
                                        
      
      
/*      
      
            SELECT ISIN,                                        
                   SCRIP_CD,                      
                   PARTY_CODE,                                        
                   QTY=Sum(QTY),                                        
                   ACCNO,                                        
                   TOTAL=Sum(TOTAL),                                        
                   NSE_APPROVED,                  
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,       
                   Sum(TOTAL) DESC) AS ROW_NUM                                        
            INTO   #DPHOLDING_TO_MOVE                                       
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                        
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                        
                     ON H.NSE_APPROVED = B.CATEGORYNAME         
            WHERE  EXISTS (SELECT PARTY_CODE                                        
                           FROM   #CLIENT_LISTTOADJUST C                              
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                        
                   AND NOT EXISTS(SELECT *                                        
                                  FROM   #ILLIQUIED_SCRIPS I                                        
                                  WHERE  H.ISIN = I.ISIN)                                        
                   AND [SOURCE] = 'DP'                                        
                   AND TOTAL <> 0                                                           
            GROUP  BY ISIN,                                        
                      SCRIP_CD,                                        
                      PARTY_CODE,                                        
                      ACCNO,                                        
                      NSE_APPROVED,                                        
                      B.DUMMY1                                        
            HAVING CONVERT(INT,Sum(QTY)) <> 0                          
            ORDER  BY PARTY_CODE,                                        
                      ROW_NUM                                        
*/      
      
      
            SELECT ISIN,                                        
                   SCRIP_CD,                      
                   H.PARTY_CODE,                                        
                   QTY=Sum(QTY),                                        
                   ACCNO,                                        
                   TOTAL=Sum(TOTAL),                                        
                   NSE_APPROVED,                  
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,       
                   case when (Sum(TOTAL)-max(ADJ_VALUE))>0 then b.srno      
                   else (Sum(TOTAL)-max(ADJ_VALUE))*-1 end) AS ROW_NUM                                        
            INTO   #DPHOLDING_TO_MOVE                                       
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                        
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                        
                     ON H.NSE_APPROVED = B.CATEGORYNAME                       
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                        
                           FROM   #CLIENT_LISTTOADJUST) C                              
                           on C.PARTY_CODE = H.PARTY_CODE                                         
                   where NOT EXISTS(SELECT *                                        
                                  FROM   #ILLIQUIED_SCRIPS I                                        
                                  WHERE  H.ISIN = I.ISIN)                                        
                   AND [SOURCE] = 'DP'                                        
                   AND TOTAL <> 0                                                           
            GROUP  BY ISIN,                                        
                      SCRIP_CD,                                        
                      H.PARTY_CODE,                                        
                      ACCNO,                                        
                      NSE_APPROVED,                                        
                      B.srno                                        
            HAVING CONVERT(INT,Sum(QTY)) <> 0                          
            ORDER  BY H.PARTY_CODE,                                        
                      ROW_NUM                                        
                                        
            CREATE CLUSTERED INDEX [IX_Row_Num]                                        
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )         
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                        
                                        
            CREATE CLUSTERED INDEX [IX_Party_code]                                        
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                      
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                        
                                    
            CREATE CLUSTERED INDEX [IX_Party_code]                                   
              ON #FILE2 ( [Party_Code] ASC )                                        
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                        
                                        
            DECLARE @PARTY_CNT      AS INT,                                        
                    @PARTY_CTR      AS INT,                                        
                    @SCRIP_CNT      AS INT,                                        
                    @SCRIP_CTR      AS INT,                    
                    @PARTY_CODE     AS VARCHAR(20),                                        
                    /*Change Id :: 2*/                
                    --@DPID           AS VARCHAR(20),                                        
                    @FOSHORTAGE     AS MONEY,                                        
                    @ADJUSTMENT_AMT AS MONEY,                                        
                    @ADJUSTED_AMT   AS MONEY,                                        
                    @ADJ_QTY        AS INT,                                        
                    @QTY            AS INT,                                        
                    @VALUE          AS MONEY,                                        
                    @CLOSING_PRICE  AS MONEY,                                        
                  @NET_DEBIT  AS MONEY                                        
                                        
            SET @ADJUSTED_AMT = 0                                        
          SET @PARTY_CTR = 1                                        
                                        
            SELECT @PARTY_CNT = Count(*)                                        
            FROM   #CLIENT_LISTTOADJUST                                        
                                        
            --PRINT @PARTY_CNT                                            
            WHILE( @PARTY_CTR <= @PARTY_CNT )                               
              BEGIN                                        
                  SET @ADJUSTMENT_AMT = 0                                        
                  SET @FOSHORTAGE = 0                                        
                  SET @ADJUSTED_AMT = 0         
                                      
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                        
                                            
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                        
                         @FOSHORTAGE = FOSHRT,                     
                         @NET_DEBIT = NET_DEBIT                                        
                  FROM   #CLIENT_LISTTOADJUST                                        
                  WHERE  ROW_NUM = @PARTY_CTR            
                                        
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                        
                                        
                  SET @SCRIP_CTR = 1                                        
                                        
                  SELECT @SCRIP_CNT = Count(*)                              
                  FROM   #DPHOLDING_TO_MOVE                                        
                  WHERE  PARTY_CODE = @PARTY_CODE                
      
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                        
                    BEGIN                                        
                        SELECT @QTY = QTY,                                        
                               @VALUE = TOTAL,                                        
                               @CLOSING_PRICE = TOTAL / QTY                                        
                        FROM   #DPHOLDING_TO_MOVE                                        
                        WHERE  ROW_NUM = @SCRIP_CTR                                        
                               AND PARTY_CODE = @PARTY_CODE                                        
                                        
                        IF @ADJUSTMENT_AMT >= @VALUE                                
                          BEGIN                                        
                              SET @ADJ_QTY = @QTY                                        
                                        
                              INSERT INTO #FILE2                                        
                                          (ISIN,                                        
                                           SCRIP_CD,                                        
                                           PARTY_CODE,                                        
                                           QTY,                                        
                                           ACCNO,                                        
                                           TOTAL,                                        
                                         NSE_APPROVED,                                        
                                           NET_DEBIT,                                        
                                           QTY_ADJ,                                        
                                           FO_APPROVED)                                        
                              SELECT ISIN,                                        
                                     SCRIP_CD,                                        
                                     PARTY_CODE,                                        
                                     QTY,                                        
                                     ACCNO,                                        
                                     TOTAL,                                        
                                     NSE_APPROVED,                                        
         @NET_DEBIT,                                        
                                     @ADJ_QTY,                                        
                          CASE                                        
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                        
                                ELSE 'N'                                        
      END                              
                              FROM   #DPHOLDING_TO_MOVE                                        
                              WHERE  ROW_NUM = @SCRIP_CTR                                        
                                     AND PARTY_CODE = @PARTY_CODE                                        
                                        
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                        
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                        
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                        
                          END                                        
                        ELSE                             
                          BEGIN                                        
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                        
                                        
                              INSERT INTO #FILE2                                        
                              (ISIN,                                        
                                           SCRIP_CD,                    
                                           PARTY_CODE,                                        
                                           QTY,                                        
                                           ACCNO,                                        
                                           TOTAL,                                        
                                           NSE_APPROVED,                                        
                                           NET_DEBIT,                                        
                                           QTY_ADJ,                                        
                                           FO_APPROVED)                                        
                              SELECT ISIN,                                        
                                     SCRIP_CD,                                        
         Ltrim(Rtrim(PARTY_CODE)),                                        
                                     QTY,                                        
                                     ACCNO,                                        
                                     TOTAL,                                        
                                     NSE_APPROVED,                                        
                                     @NET_DEBIT,                                        
                                     @ADJ_QTY,                                        
                                     CASE                                        
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                        
                                       ELSE 'N'                                        
                                     END                                        
      FROM   #DPHOLDING_TO_MOVE                                        
                              WHERE  ROW_NUM = @SCRIP_CTR                                        
                                     AND PARTY_CODE = @PARTY_CODE                                        
                                        
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                        
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                        
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )              
                                        
                              BREAK                                        
                          END                                 
                                        
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                        
                    END                                        
                           
          UPDATE #FILE2                               
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                        
                         TOTAL_ADJ = @ADJUSTED_AMT                                        
                  WHERE  PARTY_CODE = @PARTY_CODE                                        
                 
                  SET @PARTY_CTR = @PARTY_CTR + 1                                        
              END                                        
                                        
                  
            UPDATE #FILE2                                        
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                        
                  
       BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                        
            FROM   #FILE1 B                                        
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                        
                              
                              
            UPDATE #FILE2                  
                SET FO_APPROVED = 'N'                  
            WHERE UPPER(NSE_APPROVED) = 'POOR'       
            
             UPDATE #FILE2 SET cls_rate=A.clsrate from
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B
              GROUP  BY B.ISIN,                                        
                      B.SCRIP_CD,                                        
                      B.PARTY_CODE,                                        
                      B.ACCNO, B.clsrate,                                       
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED
                   
  
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate     
                  
                DECLARE @DT AS DATETIME                                        
                                        
            SET @DT=Getdate()                                        
                                  
     
         
   INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                        
            SELECT DISTINCT *                                        
            FROM   VMSS_PURERISK_DPHOLDING                                        
                                        
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                        
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                        
                               
             Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)     
                
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                        
                                        
            INSERT INTO VMSS_PURERISK_DPHOLDING                                       
            SELECT DISTINCT *,                                        
                   @DT AS PROCESS_DATE,'','',''                                        
            FROM   #FILE2                                        
            WHERE  QTY_ADJ > 0                                        
                                     
            /*use general                                                          
            alter table POA_DP_Adj_Ben add FOShrt money                                                          
            use history                                                          
            alter table POA_DP_Adj_Ben add FOShrt money                                                          
            */                                        
                  
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                        
            SELECT DISTINCT *                                 
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                        
                                        
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                        
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                 
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                        
                
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                
                                        
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                        
            SELECT DISTINCT PARTY_CODE,                                        
                   NET_DEBIT,                                        
                   ANGEL_BEN,                                        
                   @DT AS PROCESS_DATE,                                        
               NON_CASH,                                        
                   FOSHRT                                        
            FROM   #FILE1                                        
                                  
                                   
/*
         SELECT A.*,                                  
                   MOBILE_PAGER                                  
            INTO   #SEND1                                  
            FROM   (select Party_code,AdjAmt=sum(SqOffQty*Clsrate) from VMSS_PURERISK_DPHOLDING where ToSegment is not null
            and SqOffQty>0
	
					group by Party_code) A                                  
                   LEFT OUTER JOIN CLIENT_DETAILS B WITH (NOLOCK)                                  
                     ON A.PARTY_CODE = B.PARTY_CODE and a.party_code not in 
                      (select Party_code from #CLIENT    )                     
                     
         
                    INSERT INTO INTRANET.SMS.DBO.SMS                                  
				SELECT MOBILE_PAGER,                                  

                  'Dear Customer,Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c with us to broker margin A/c as per the POA given by you.Pl contact branch for queries.',                                
                  CONVERT(VARCHAR(11), Getdate(), 103),                                  
                   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                  
                   'P',                                  
                   RIGHT(Getdate(), 2),                                  
                   'New POA Debit Client'                                  
            FROM   #SEND1 
    
      
      */
      
END      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_bkup_23072019
-- --------------------------------------------------
              
/*                    
CREATED BY :: RENIL PILLAI                    
CREATED ON :: MAY 04 2016                    
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS                    
*/                   
                
create PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_bkup_23072019]                    
AS                    
SET NOCOUNT ON                    
BEGIN                    
      
       
 select party_code,pure_risk,proj_risk,rms_date=cast(pdate as date),      
 risktype=case when pure_risk<-100 then 'Pure'      
 else 'Projected' end      
  into #temp_Riskdata from history.dbo.TBL_RMS_COLLECTION_CLI_HIST with (nolock)  where        
 cast(pdate as date)>cast((getdate()-6) as date)       
 and (pure_risk<-100 or  proj_risk<-501)      
       
 select party_code,risktype=min(risktype) into #final from #temp_Riskdata  group by party_code having count(party_code)>=5
 
 
                   
 SELECT A.*      
 INTO #CLI                    
 FROM (SELECT A.PARTY_CODE,                    
 NON_CASH=0.00,                    
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),                    
 FOSHRT=CONVERT(MONEY, 0) ,  risktype                 
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)                    
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI A WITH (NOLOCK)   inner join #final F on A.party_code=F.party_code                 
  LEFT JOIN (SELECT PARTY_CODE,                    
 NON_CASH=Sum(FinalAmount)                    
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)                    
 WHERE COLL_TYPE = 'SEC'                    
 GROUP BY PARTY_CODE) B                    
 ON A.PARTY_CODE = B.PARTY_CODE                    
 where (A.Pure_Risk+A.proj_risk)<0 ) A                    
 WHERE EXISTS (                    
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)                    
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)                    
                    
 /*AND A.PARTY_CODE='AND2731'*/                   
               
               
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/              
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI b with (nolock) where b.Pure_Risk>=-100             
 and b.proj_risk>-501 and b.party_code=a.party_code              
               
 --/*exclude client who have traded in 5 days*/              
 --delete from #CLI where party_code in (select party_code from #traded5days)              
                  
 UPDATE #CLI                    
 SET FOSHRT = CASE                    
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN                    
 ELSE 0                    
 END                    
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)                    
 WHERE CO_CODE = 'NSEFO'                    
 AND #CLI.PARTY_CODE = B.PARTY_CODE                    
 AND IMARGIN <> 0                    
 
 /*                           
 DELETE from #CLI where PARTY_CODE IN                    
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK)) */--commented on Feb 02 2018 as suggested by Vishal Gohil                   
                    
 SELECT X.PARTY_CODE,                                                      
                   NET_DEBIT,                                                                             
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                                      
                   NON_CASH,                                                      
                   BLUECHIP=Isnull(BLUECHIP, 0),                                                      
                   GOOD=Isnull(GOOD, 0),                                                      
                   AVERAGE=Isnull(AVERAGE, 0),                                                      
                   POOR=Isnull(POOR, 0),                                                      
                   TOTAL=Isnull(TOTAL, 0),                                          
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                                      
                   ADJ_VALUE=NET_DEBIT *-1,                                               EXCLUDE_FLAG=' ',                                                      
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                          
                   GOOD_ADJ=CONVERT(MONEY, 0),                                                      
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                                      
                   POOR_ADJ=CONVERT(MONEY, 0),                               
                   FOSHRT,risktype      
            INTO   #FILE1                                                      
            FROM   #CLI X                                                      
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                                      
                  ANGEL_BEN=Sum(CASE WHEN SOURCE <> 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  BLUECHIP=Sum(CASE WHEN NSE_APPROVED = 'BLUECHIP' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  GOOD=Sum(CASE WHEN NSE_APPROVED = 'GOOD' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  AVERAGE=Sum(CASE WHEN NSE_APPROVED = 'AVERAGE' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                                                             
                  POOR=Sum(CASE  WHEN NSE_APPROVED = 'POOR' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  TOTAL=Sum(TOTAL_WithHC)                                                      
                  FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)GROUP  BY PARTY_CODE) Y                                                      
                  ON X.PARTY_CODE = Y.PARTY_CODE                                                      
                                                      
                                                        
            DELETE FROM #FILE1                                                      
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                                      
            FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                                        
                                  WHERE  CL_TYPE = 'NRI'                                                      
                                          OR BRANCH_CD = 'NRIS')                                                        
            UPDATE #FILE1                                                      
            SET    ADJ_VALUE = 0                                                      
            WHERE  ADJ_VALUE < 0                                                      
                                                      
            CREATE TABLE #FILE2                                                      
              (                                                      
                 SRNO         INT IDENTITY(1, 1),                                                      
                 ISIN         CHAR(12),                                                      
                 SCRIP_CD     VARCHAR(10),                                                      
                 PARTY_CODE   VARCHAR(10),                                                      
                 QTY          INT,                                                      
                 ACCNO        VARCHAR(16),                                                      
                 TOTAL        MONEY,                                                      
                 NSE_APPROVED VARCHAR(25),                                                      
                 NET_DEBIT    MONEY DEFAULT 0,                                                
                 BEN_ADJUSTED MONEY DEFAULT 0,                                                      
                 TOTAL_ADJ    MONEY DEFAULT 0,                    
                 BALAFTERADJ  MONEY DEFAULT 0,                                                      
                 QTY_ADJ      INT,              
                 CLS_rate MONEY,              
                 TOTAL_VALUE_ADJ MONEY,                                                      
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                                      
                 --FO_SHRT MONEY DEFAULT 0                                                          
              )                                                      
                                                      
            SELECT A.*,                                            
                   ADJ_VALUE AS TOTAL_ADJ,                                          
       QTY_ADJ=CONVERT(INT, 0)                                                      
            INTO   #FILET                                                      
            FROM   (SELECT ISIN,                                                      
                           SCRIP_CD,                                                     
                           PARTY_CODE,                                      
                           QTY=Sum(QTY),                                                      
                           ACCNO,                                                      
                           TOTAL=Sum(TOTAL),                                                      
                           NSE_APPROVED                                                      
            FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                                      
            GROUP  BY ISIN,SCRIP_CD,PARTY_CODE,ACCNO,NSE_APPROVED HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                                      
           (SELECT PARTY_CODE,                                                      
                    ADJ_VALUE                                                      
                    FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0) B                                                      
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                                      
                                      
                                      
            --DROP TABLE #CLIENT_LISTTOADJUST                                                          
            SELECT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   /*Change Id :: 2*/                              
                   --DPID,                                                      
                   ADJ_VALUE,                                                      
                   FOSHRT * -1                            AS FOSHRT,                                                      
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM,      
                   risktype                                                      
            INTO   #CLIENT_LISTTOADJUST                                                      
            FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                                          
                              
            SELECT top 0 *                                                      
            INTO   #ILLIQUIED_SCRIPS                                                      
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP            
                                                   
                    
                    
/*                    
                    
           SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   PARTY_CODE,                                                      
                   QTY=Sum(QTY),            
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,                     
                   Sum(TOTAL) DESC) AS ROW_NUM                                                      
            INTO   #DPHOLDING_TO_MOVE                        
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                       
            WHERE  EXISTS (SELECT PARTY_CODE                                                      
                           FROM   #CLIENT_LISTTOADJUST C                                            
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                                      
                   AND NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                                                      
                      B.DUMMY1                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY PARTY_CODE,                                                      
                      ROW_NUM                                                      
*/                    
                    
                    
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM-- ,   clsrate=max(clsrate)             
                    ,risktype       =max(c.risktype)      
                                 
            INTO   #DPHOLDING_TO_MOVE                                                   
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE,                                                      
                      ROW_NUM            
          
    /*Added by Vishal Gohil to exclude poor scrip from projected category on 21/07/2016 by Renil and Abha*/                        
 delete from #DPHOLDING_TO_MOVE  where risktype='Projected' and nse_approved='Poor'      
       
       
                                    
                 /*              
                 /**************************Vishal gohil**************************************************************/              
   /****************************************************************************************/                   
                 select x.* INTO   #DPHOLDING_TO_MOVE                
                 from                        
            (SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
    NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM,   clsrate=max(clsrate)                                                 
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                     
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
--             K47437              
--K48042              
          inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED<>'Poor'                                                  
                   AND TOTAL <> 0    -- and h.party_Code='K48042'                                                                    
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                          
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            union                  
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                               
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM ,   clsrate=max(clsrate)                              
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                 
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED='Poor'                                                  
                   AND TOTAL <> 0       --and h.party_code='K48042'                                                                  
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                   
                      NSE_APPROVED,                                                      
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0  )x                                      
            ORDER  BY x.PARTY_CODE,                                                      
                      ROW_NUM                                    
                                    
                    
   update a set  row_num=b.row_num+a.row_num from #DPHOLDING_TO_MOVE a,              
   (select party_Code,row_num=MAX(row_num) from #DPHOLDING_TO_MOVE group by party_Code)b              
   where a.[party_Code]=b.party_Code and  a.nse_approved='Poor'              
                 
   /****************************************************************************************/              
   /****************************************************************************************/              
   */              
                                    
                                    
                                                      
            CREATE CLUSTERED INDEX [IX_Row_Num]                                                      
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )                       
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            CREATE CLUSTERED INDEX [IX_Party_code]                                                      
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                                    
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                  
            CREATE CLUSTERED INDEX [IX_Party_code]                                                       ON #FILE2 ( [Party_Code] ASC )                                                      
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            DECLARE @PARTY_CNT      AS INT,                                                      
                    @PARTY_CTR      AS INT,                                                      
                    @SCRIP_CNT      AS INT,                                                      
                    @SCRIP_CTR      AS INT,                                  
                    @PARTY_CODE     AS VARCHAR(20),                                                      
/*Change Id :: 2*/                              
                    --@DPID           AS VARCHAR(20),                                                      
                    @FOSHORTAGE     AS MONEY,                                                      
                    @ADJUSTMENT_AMT AS MONEY,                                                      
                    @ADJUSTED_AMT   AS MONEY,                                                      
                    @ADJ_QTY        AS INT,                                                      
                    @QTY            AS INT,                                      
                    @VALUE          AS MONEY,                                                      
                    @CLOSING_PRICE  AS MONEY,                                                      
                  @NET_DEBIT  AS MONEY                                                      
                                                      
            SET @ADJUSTED_AMT = 0                                                      
          SET @PARTY_CTR = 1                                                      
           
            SELECT @PARTY_CNT = Count(*)                                                      
            FROM   #CLIENT_LISTTOADJUST                                                      
                                                      
            --PRINT @PARTY_CNT                                                          
            WHILE( @PARTY_CTR <= @PARTY_CNT )                                             
              BEGIN                                                      
                  SET @ADJUSTMENT_AMT = 0                                                      
                  SET @FOSHORTAGE = 0                                                      
                  SET @ADJUSTED_AMT = 0                      
                                                    
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                                      
                                                          
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                                      
                         @FOSHORTAGE = FOSHRT,                                   
                         @NET_DEBIT = NET_DEBIT                                                      
                  FROM   #CLIENT_LISTTOADJUST                                                      
                  WHERE  ROW_NUM = @PARTY_CTR                          
                                                      
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                                      
                                                      
                  SET @SCRIP_CTR = 1                                                      
                                                      
                  SELECT @SCRIP_CNT = Count(*)                                            
                  FROM   #DPHOLDING_TO_MOVE                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                              
                    
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                                      
                    BEGIN                                                      
                        SELECT @QTY = QTY,                                                      
                  @VALUE = TOTAL,                                                      
                               @CLOSING_PRICE = TOTAL / QTY                                                      
                        FROM   #DPHOLDING_TO_MOVE                                                      
                        WHERE  ROW_NUM = @SCRIP_CTR                                                      
                               AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                        IF @ADJUSTMENT_AMT >= @VALUE                                              
                          BEGIN                                                      
                              SET @ADJ_QTY = @QTY                                                      
                                                      
                 INSERT INTO #FILE2                                                      
                                          (ISIN,                                           
                                           SCRIP_CD,                                                      
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                           TOTAL,                                                      
                                           NSE_APPROVED,                              
                                           NET_DEBIT,                                                      
             QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
                                     PARTY_CODE,                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                        TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                                      
                                     @ADJ_QTY,                                                      
                          CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                ELSE 'N'                                                      
                              END                                            
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                                      
                          END                                                      
                        ELSE                                           
                          BEGIN                                                      
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                                      
                                                      
                              INSERT INTO #FILE2                                                      
                              (ISIN,                                                      
                                           SCRIP_CD,                                  
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                  TOTAL,                                                      
                                           NSE_APPROVED,                                                      
                                           NET_DEBIT,                                            
                                           QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
               Ltrim(Rtrim(PARTY_CODE)),                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                                     TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                      
                                     @ADJ_QTY,                                                      
                                     CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                   ELSE 'N'                                                      
                                     END                                                      
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                            
                                                      
                              BREAK                                                      
                          END                                               
                                                      
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                                      
                    END                                                      
                                         
                  UPDATE #FILE2                                             
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                                      
                         TOTAL_ADJ = @ADJUSTED_AMT                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                                                      
                               
                  SET @PARTY_CTR = @PARTY_CTR + 1                                  
              END                                                      
                                                      
                                
            UPDATE #FILE2                                                      
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                                      
                                
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                                      
            FROM   #FILE1 B                                                      
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                                      
                                            
                                            
            UPDATE #FILE2                                
                SET FO_APPROVED = 'N'                                
            WHERE UPPER(NSE_APPROVED) = 'POOR'                    
                          
                           
              UPDATE #FILE2 SET cls_rate=A.clsrate from              
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B              
              GROUP  BY B.ISIN,                                                      
                      B.SCRIP_CD,                                                      
                      B.PARTY_CODE,                                                      
                      B.ACCNO, B.clsrate,                                                     
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED              
                                 
                
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate              
                            
                            
           /*select * from #FILE2 x inner join #cli y on x.party_code=y.party_code*/      
                                
            DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()                                                      
             
                 
                       
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                                      
            SELECT DISTINCT *                 
            FROM   VMSS_PURERISK_DPHOLDING                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                              
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                                      
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                      
                                             
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)                   
                  
            /*      
              DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()       
            */                                                     
                                                  
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                                      
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDING                                                     
            SELECT DISTINCT x.*,                                                      
                   @DT AS PROCESS_DATE,'','','',y.risktype                                                      
            FROM   #FILE2 x  inner join #cli y on x.party_code=y.party_code                                                   
            WHERE  x.QTY_ADJ > 0                                                      
                                                   
            /*use general                                                                        
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            use history                                                
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            */                                                      
                  
            delete from  VMSS_PURERISK_DPHOLDING where party_code in (select party_code from general.dbo.client_details where NBFC_Cli='Y' )                   
            delete from VMSS_PURERISK_DPHOLDING where isin like '%INF%'     
                  
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                                      
            SELECT DISTINCT *                                               
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST       
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                               
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                      
                              
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                              
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                                      
            SELECT DISTINCT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   ANGEL_BEN,                                                      
                   @DT AS PROCESS_DATE,                                                      
                   NON_CASH,                                                      
                   FOSHRT                     
            FROM   #FILE1                                                      
                                     
           exec Pure_Risk_DP_Adj_file_mail             
   /*                         
    --SMS Part      
    SELECT A.party_code,A.AdjAmt ,B.MOBILE_PAGER INTO #SEND1 FROM             
   (select Party_code,AdjAmt=sum(Total_Adj_Value) from VMSS_PURERISK_DPHOLDING where ToSegment is not null group by Party_code) A           
   LEFT OUTER JOIN general.dbo.CLIENT_DETAILS B WITH (NOLOCK)                                                
   ON A.PARTY_CODE = B.PARTY_CODE where B.Mobile_pager is not null          
                                   

   declare @TradingDay datetime   
    ;with sqoffdatae as  
    (  
    select ROW_NUMBER() over(order by a.Start_Date)as srno,  isnull(a.Start_Date,'')   Start_Date                                        
    from general.dbo.bse_sett_mst a                                                                        
    where CONVERT(VARCHAR(10),a.start_Date,121) >= CONVERT(VARCHAR(10),getdate(),121)                                                 
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                          
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                        
    group by Start_Date)  
    select @TradingDay = isnull(Start_Date ,'')  from sqoffdatae where srno=1 ;        
   
   if((DATEPART(DW,GETDATE())>=2 and  DATEPART(DW,GETDATE())<7) and cast(getdate() as date)=cast(@TradingDay as date))  
   begin      
                       
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                         
                  
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
    'P',RIGHT(Getdate(), 2), 'New POA Debit Client' FROM   #SEND1      
          
   /* sms log*/                           
   insert into Tbl_PureRiskAdj_SMS_log      
   SELECT party_code,MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                          
                 
   CONVERT(VARCHAR(11), Getdate(), 103)                                                                               
   FROM   #SEND1          
                            
   INSERT INTO INTRANET.SMS.DBO.SMS SELECT top 1  '9820701602',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                     
                       
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
   'P',RIGHT(Getdate(), 2),'New POA Debit Client' FROM   #SEND1 group by  party_code        
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9820731985','Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                            
   CONVERT(VARCHAR(11), Getdate(), 103), Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1 group by  party_code              
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9819090240',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                     
                       
   CONVERT(VARCHAR(11), Getdate(), 103),Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1  group by  party_code  
   end   
   */    
                    
              END                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_bkup_26112019
-- --------------------------------------------------
              
/*                    
CREATED BY :: RENIL PILLAI                    
CREATED ON :: MAY 04 2016                    
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS                    
*/                   
                
create PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_bkup_26112019]                    
AS                    
SET NOCOUNT ON                    
BEGIN                    
      
       
 select party_code,pure_risk,proj_risk,rms_date=cast(pdate as date),      
 risktype=case when pure_risk<-100 then 'Pure'      
 else 'Projected' end      
  into #temp_Riskdata from history.dbo.TBL_RMS_COLLECTION_CLI_HIST with (nolock)  where        
 cast(pdate as date)>cast((getdate()-3) as date)       
 and (pure_risk<-100 or  proj_risk<-501)      
       
 select party_code,risktype=min(risktype) into #final from #temp_Riskdata  group by party_code having count(party_code)>=3
 
 
                   
 SELECT A.*      
 INTO #CLI                    
 FROM (SELECT A.PARTY_CODE,                    
 NON_CASH=0.00,                    
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),                    
 FOSHRT=CONVERT(MONEY, 0) ,  risktype                 
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)                    
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI A WITH (NOLOCK)   inner join #final F on A.party_code=F.party_code                 
  LEFT JOIN (SELECT PARTY_CODE,                    
 NON_CASH=Sum(FinalAmount)                    
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)                    
 WHERE COLL_TYPE = 'SEC'                    
 GROUP BY PARTY_CODE) B                    
 ON A.PARTY_CODE = B.PARTY_CODE                    
 where (A.Pure_Risk+A.proj_risk)<0 ) A                    
 WHERE EXISTS (                    
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)                    
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)                    
                    
 /*AND A.PARTY_CODE='AND2731'*/                   
               
               
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/              
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI b with (nolock) where b.Pure_Risk>=-100             
 and b.proj_risk>-501 and b.party_code=a.party_code              
               
 --/*exclude client who have traded in 5 days*/              
 --delete from #CLI where party_code in (select party_code from #traded5days)              
                  
 UPDATE #CLI                    
 SET FOSHRT = CASE                    
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN                    
 ELSE 0                    
 END                    
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)                    
 WHERE CO_CODE = 'NSEFO'                    
 AND #CLI.PARTY_CODE = B.PARTY_CODE                    
 AND IMARGIN <> 0                    
 
 /*                           
 DELETE from #CLI where PARTY_CODE IN                    
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK)) */--commented on Feb 02 2018 as suggested by Vishal Gohil                   
                    
 SELECT X.PARTY_CODE,                                                      
                   NET_DEBIT,                                                                             
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                                      
                   NON_CASH,                                                      
                   BLUECHIP=Isnull(BLUECHIP, 0),                                                      
                   GOOD=Isnull(GOOD, 0),                                                      
                   AVERAGE=Isnull(AVERAGE, 0),                                                      
                   POOR=Isnull(POOR, 0),                                                      
                   TOTAL=Isnull(TOTAL, 0),                                          
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                                      
                   ADJ_VALUE=NET_DEBIT *-1,                                               EXCLUDE_FLAG=' ',                                                      
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                          
                   GOOD_ADJ=CONVERT(MONEY, 0),                                                      
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                                      
                   POOR_ADJ=CONVERT(MONEY, 0),                               
                   FOSHRT,risktype      
            INTO   #FILE1                                                      
            FROM   #CLI X                                                      
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                                      
                  ANGEL_BEN=Sum(CASE WHEN SOURCE <> 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  BLUECHIP=Sum(CASE WHEN NSE_APPROVED = 'BLUECHIP' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  GOOD=Sum(CASE WHEN NSE_APPROVED = 'GOOD' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  AVERAGE=Sum(CASE WHEN NSE_APPROVED = 'AVERAGE' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                                                             
                  POOR=Sum(CASE  WHEN NSE_APPROVED = 'POOR' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  TOTAL=Sum(TOTAL_WithHC)                                                      
                  FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)GROUP  BY PARTY_CODE) Y                                                      
                  ON X.PARTY_CODE = Y.PARTY_CODE                                                      
                                                      
                                                        
            DELETE FROM #FILE1                                                      
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                                      
            FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                                        
                                  WHERE  CL_TYPE = 'NRI'                                                      
                                          OR BRANCH_CD = 'NRIS')                                                        
            UPDATE #FILE1                                                      
            SET    ADJ_VALUE = 0                                                      
            WHERE  ADJ_VALUE < 0                                                      
                                                      
            CREATE TABLE #FILE2                                                      
              (                                                      
                 SRNO         INT IDENTITY(1, 1),                                                      
                 ISIN         CHAR(12),                                                      
                 SCRIP_CD     VARCHAR(10),                                                      
                 PARTY_CODE   VARCHAR(10),                                                      
                 QTY          INT,                                                      
                 ACCNO        VARCHAR(16),                                                      
                 TOTAL        MONEY,                                                      
                 NSE_APPROVED VARCHAR(25),                                                      
                 NET_DEBIT    MONEY DEFAULT 0,                                                
                 BEN_ADJUSTED MONEY DEFAULT 0,                                                      
                 TOTAL_ADJ    MONEY DEFAULT 0,                    
                 BALAFTERADJ  MONEY DEFAULT 0,                                                      
                 QTY_ADJ      INT,              
                 CLS_rate MONEY,              
                 TOTAL_VALUE_ADJ MONEY,                                                      
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                                      
                 --FO_SHRT MONEY DEFAULT 0                                                          
              )                                                      
                                                      
            SELECT A.*,                                            
                   ADJ_VALUE AS TOTAL_ADJ,                                          
       QTY_ADJ=CONVERT(INT, 0)                                                      
            INTO   #FILET                                                      
            FROM   (SELECT ISIN,                                                      
                           SCRIP_CD,                                                     
                           PARTY_CODE,                                      
                           QTY=Sum(QTY),                                                      
                           ACCNO,                                                      
                           TOTAL=Sum(TOTAL),                                                      
                           NSE_APPROVED                                                      
            FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                                      
            GROUP  BY ISIN,SCRIP_CD,PARTY_CODE,ACCNO,NSE_APPROVED HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                                      
           (SELECT PARTY_CODE,                                                      
                    ADJ_VALUE                                                      
                    FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0) B                                                      
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                                      
                                      
                                      
            --DROP TABLE #CLIENT_LISTTOADJUST                                                          
            SELECT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   /*Change Id :: 2*/                              
                   --DPID,                                                      
                   ADJ_VALUE,                                                      
                   FOSHRT * -1                            AS FOSHRT,                                                      
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM,      
                   risktype                                                      
            INTO   #CLIENT_LISTTOADJUST                                                      
            FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                                          
                              
            SELECT top 0 *                                                      
            INTO   #ILLIQUIED_SCRIPS                                                      
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP            
                                                   
                    
                    
/*                    
                    
           SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   PARTY_CODE,                                                      
                   QTY=Sum(QTY),            
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,                     
                   Sum(TOTAL) DESC) AS ROW_NUM                                                      
            INTO   #DPHOLDING_TO_MOVE                        
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                       
            WHERE  EXISTS (SELECT PARTY_CODE                                                      
                           FROM   #CLIENT_LISTTOADJUST C                                            
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                                      
                   AND NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                                                      
                      B.DUMMY1                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY PARTY_CODE,                                                      
                      ROW_NUM                                                      
*/                    
                    
                    
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED ,
				   clsrate,
				   risktype       =max(c.risktype)                                
                  
            INTO   #DPHOLDING_TO_MOVE_temp                                                   
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST ) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where        NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno,clsrate                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE                                                      
                              
          
    /*Added by Vishal Gohil to exclude poor scrip from projected category on 21/07/2016 by Renil and Abha*/                        
 delete from #DPHOLDING_TO_MOVE_temp  where risktype='Projected' and nse_approved='Poor'      
       
  SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM-- ,   clsrate=max(clsrate)             
                    ,risktype       =max(c.risktype)   
                                 
            INTO   #DPHOLDING_TO_MOVE                                                   
            FROM   #DPHOLDING_TO_MOVE_temp H                                      
                                                                  
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                                      
                                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno                                                  
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE,                                                      
                      ROW_NUM           
                                    
                 /*              
                 /**************************Vishal gohil**************************************************************/              
   /****************************************************************************************/                   
                 select x.* INTO   #DPHOLDING_TO_MOVE                
                 from                        
            (SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
    NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM,   clsrate=max(clsrate)                                                 
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                     
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
--             K47437              
--K48042              
          inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED<>'Poor'                                                  
                   AND TOTAL <> 0    -- and h.party_Code='K48042'                                                                    
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                          
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            union                  
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                               
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM ,   clsrate=max(clsrate)                              
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                 
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED='Poor'                                                  
                   AND TOTAL <> 0       --and h.party_code='K48042'                                                                  
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                   
                      NSE_APPROVED,                                                      
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0  )x                                      
            ORDER  BY x.PARTY_CODE,                                                      
                      ROW_NUM                                    
                                    
                    
   update a set  row_num=b.row_num+a.row_num from #DPHOLDING_TO_MOVE a,              
   (select party_Code,row_num=MAX(row_num) from #DPHOLDING_TO_MOVE group by party_Code)b              
   where a.[party_Code]=b.party_Code and  a.nse_approved='Poor'              
                 
   /****************************************************************************************/              
   /****************************************************************************************/              
   */              
                                    
                                    
                                                      
            CREATE CLUSTERED INDEX [IX_Row_Num]                                                      
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )                       
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            CREATE CLUSTERED INDEX [IX_Party_code]                                                      
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                                    
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                  
            CREATE CLUSTERED INDEX [IX_Party_code]                                                       ON #FILE2 ( [Party_Code] ASC )                                                      
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            DECLARE @PARTY_CNT      AS INT,                                                      
                    @PARTY_CTR      AS INT,                                                      
                    @SCRIP_CNT      AS INT,                                                      
                    @SCRIP_CTR      AS INT,                                  
                    @PARTY_CODE     AS VARCHAR(20),                                                      
/*Change Id :: 2*/                              
                    --@DPID           AS VARCHAR(20),                                                      
                    @FOSHORTAGE     AS MONEY,                                                      
                    @ADJUSTMENT_AMT AS MONEY,                                                      
                    @ADJUSTED_AMT   AS MONEY,                                                      
                    @ADJ_QTY        AS INT,                                                      
                    @QTY            AS INT,                                      
                    @VALUE          AS MONEY,                                                      
                    @CLOSING_PRICE  AS MONEY,                                                      
                  @NET_DEBIT  AS MONEY                                                      
                                                      
            SET @ADJUSTED_AMT = 0                                                      
          SET @PARTY_CTR = 1                                                      
           
            SELECT @PARTY_CNT = Count(*)                                                      
            FROM   #CLIENT_LISTTOADJUST                                                      
                                                      
            --PRINT @PARTY_CNT                                                          
            WHILE( @PARTY_CTR <= @PARTY_CNT )                                             
              BEGIN                                                      
                  SET @ADJUSTMENT_AMT = 0                                                      
                  SET @FOSHORTAGE = 0                                                      
                  SET @ADJUSTED_AMT = 0                      
                                                    
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                                      
                                                          
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                                      
                         @FOSHORTAGE = FOSHRT,                                   
                         @NET_DEBIT = NET_DEBIT                                                      
                  FROM   #CLIENT_LISTTOADJUST                                                      
                  WHERE  ROW_NUM = @PARTY_CTR                          
                                                      
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                                      
                                                      
                  SET @SCRIP_CTR = 1                                                      
                                                      
                  SELECT @SCRIP_CNT = Count(*)                                            
                  FROM   #DPHOLDING_TO_MOVE                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                              
                    
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                                      
                    BEGIN                                                      
                        SELECT @QTY = QTY,                                                      
                  @VALUE = TOTAL,                                                      
                               @CLOSING_PRICE = TOTAL / QTY                                                      
                        FROM   #DPHOLDING_TO_MOVE                                                      
                        WHERE  ROW_NUM = @SCRIP_CTR                                                      
                               AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                        IF @ADJUSTMENT_AMT >= @VALUE                                              
                          BEGIN                                                      
                              SET @ADJ_QTY = @QTY                                                      
                                                      
                 INSERT INTO #FILE2                                                      
                                          (ISIN,                                           
                                           SCRIP_CD,                                                      
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                           TOTAL,                                                      
                                           NSE_APPROVED,                              
                                           NET_DEBIT,                                                      
             QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
                                     PARTY_CODE,                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                        TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                                      
                                     @ADJ_QTY,                                                      
                          CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                ELSE 'N'                                                      
                              END                                            
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                                      
                          END                                                      
                        ELSE                                           
                          BEGIN                                                      
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                                      
                                                      
                              INSERT INTO #FILE2                                                      
                              (ISIN,                                                      
                                           SCRIP_CD,                                  
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                  TOTAL,                                                      
                                           NSE_APPROVED,                                                      
                                           NET_DEBIT,                                            
                                           QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
               Ltrim(Rtrim(PARTY_CODE)),                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                                     TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                      
                                     @ADJ_QTY,                                                      
                                     CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                   ELSE 'N'                                                      
                                     END                                                      
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                            
                                                      
                              BREAK                                                      
                          END                                               
                                                      
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                                      
                    END                                                      
                                         
                  UPDATE #FILE2                                             
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                                      
                         TOTAL_ADJ = @ADJUSTED_AMT                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                                                      
                               
                  SET @PARTY_CTR = @PARTY_CTR + 1                                  
              END                                                      
                                                      
                                
            UPDATE #FILE2                                                      
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                                      
                                
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                                      
            FROM   #FILE1 B                                                      
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                                      
                                            
                                            
            UPDATE #FILE2                                
                SET FO_APPROVED = 'N'                                
            WHERE UPPER(NSE_APPROVED) = 'POOR'                    
                          
                           
              UPDATE #FILE2 SET cls_rate=A.clsrate from              
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B              
              GROUP  BY B.ISIN,                                                      
                      B.SCRIP_CD,                                                      
                      B.PARTY_CODE,                                                      
                      B.ACCNO, B.clsrate,                                                     
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED              
                                 
                
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate              
                            
                            
           /*select * from #FILE2 x inner join #cli y on x.party_code=y.party_code*/      
                                
            DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()                                                      
             
           
               
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                                      
            SELECT DISTINCT *                 
            FROM   VMSS_PURERISK_DPHOLDING                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                              
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                                      
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                               
                                             
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)                   
                  
            /*      
              DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()       
            */                                                     
                                                  
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                                      
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDING                                                     
            SELECT DISTINCT x.*,                                                      
                   @DT AS PROCESS_DATE,'','','',y.risktype                                                      
            FROM   #FILE2 x  inner join #cli y on x.party_code=y.party_code                                                   
            WHERE  x.QTY_ADJ > 0    
			
			 /*delete from VMSS_PURERISK_DPHOLDING where party_code in (select party_code from tbl_sharefetch_excluCodes )   */                                               
                                                   
            /*use general                                                                        
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            use history                                                
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            */                                                      
                  
            delete from  VMSS_PURERISK_DPHOLDING where party_code in (select party_code from general.dbo.client_details where NBFC_Cli='Y' )                   
            --delete from VMSS_PURERISK_DPHOLDING where isin like '%INF%'     
            
			
			     
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                                      
            SELECT DISTINCT *                                               
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST       
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                               
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                
                              
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                              
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                                      
            SELECT DISTINCT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   ANGEL_BEN,                                                      
                   @DT AS PROCESS_DATE,                                                      
                   NON_CASH,                                                      
                   FOSHRT                     
            FROM   #FILE1      
			
			/*delete from VMSS_PURERISK_DPHOLDINGBEN where party_code in (select party_code from tbl_sharefetch_excluCodes )    */                                            
                                     
           exec Pure_Risk_DP_Adj_file_mail             
   /*                         
    --SMS Part      
    SELECT A.party_code,A.AdjAmt ,B.MOBILE_PAGER INTO #SEND1 FROM             
   (select Party_code,AdjAmt=sum(Total_Adj_Value) from VMSS_PURERISK_DPHOLDING where ToSegment is not null group by Party_code) A           
   LEFT OUTER JOIN general.dbo.CLIENT_DETAILS B WITH (NOLOCK)                                                
   ON A.PARTY_CODE = B.PARTY_CODE where B.Mobile_pager is not null          
                                   

   declare @TradingDay datetime   
    ;with sqoffdatae as  
    (  
    select ROW_NUMBER() over(order by a.Start_Date)as srno,  isnull(a.Start_Date,'')   Start_Date                                        
    from general.dbo.bse_sett_mst a                                                                        
    where CONVERT(VARCHAR(10),a.start_Date,121) >= CONVERT(VARCHAR(10),getdate(),121)                                                 
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                          
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                        
    group by Start_Date)  
    select @TradingDay = isnull(Start_Date ,'')  from sqoffdatae where srno=1 ;        
   
   if((DATEPART(DW,GETDATE())>=2 and  DATEPART(DW,GETDATE())<7) and cast(getdate() as date)=cast(@TradingDay as date))  
   begin      
                       
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                         
                  
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
    'P',RIGHT(Getdate(), 2), 'New POA Debit Client' FROM   #SEND1      
          
   /* sms log*/                           
   insert into Tbl_PureRiskAdj_SMS_log      
   SELECT party_code,MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                          
                 
   CONVERT(VARCHAR(11), Getdate(), 103)                                                                               
   FROM   #SEND1          
                            
   INSERT INTO INTRANET.SMS.DBO.SMS SELECT top 1  '9820701602',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                     
                       
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
   'P',RIGHT(Getdate(), 2),'New POA Debit Client' FROM   #SEND1 group by  party_code        
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9820731985','Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                            
   CONVERT(VARCHAR(11), Getdate(), 103), Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1 group by  party_code              
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9819090240',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                     
                       
   CONVERT(VARCHAR(11), Getdate(), 103),Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1  group by  party_code  
   end   
   */    
                    
              END                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_bkup_27112019
-- --------------------------------------------------
              
/*                    
CREATED BY :: RENIL PILLAI                    
CREATED ON :: MAY 04 2016                    
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS                    
*/                   
                
create PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_bkup_27112019]                    
AS                    
SET NOCOUNT ON                    
BEGIN                    
 declare @mdate as varchar(11)   
 select @mdate=max(vdt)-3 from anand1.account.dbo.ledger WITH(NOLOCK) where vtyp=15 and vdt <=convert(varchar(11),getdate()) and narration like 'SETTNO=_______NSECMNBill Posted'          
 print @mdate
 --print cast((getdate()-3) as date) 

 select party_code,pure_risk,proj_risk,rms_date=cast(pdate as date),      
 risktype=case when pure_risk<-100 then 'Pure'      
 else 'Projected' end      
into #temp_Riskdata 
  from history.dbo.TBL_RMS_COLLECTION_CLI_HIST with (nolock)  where        
 cast(pdate as date)>@mdate      
 and (pure_risk<-100 or  proj_risk<-501) and Exp_Gross>=0.00     
       
 select party_code,risktype=min(risktype) into #final from #temp_Riskdata  group by party_code having count(party_code)>=3
 
 
                   
 SELECT A.*      
 INTO #CLI                    
 FROM (SELECT A.PARTY_CODE,                    
 NON_CASH=0.00,                    
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),                    
 FOSHRT=CONVERT(MONEY, 0) ,  risktype                 
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)                    
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI A WITH (NOLOCK)   inner join #final F on A.party_code=F.party_code                 
  LEFT JOIN (SELECT PARTY_CODE,                    
 NON_CASH=Sum(FinalAmount)                    
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)                    
 WHERE COLL_TYPE = 'SEC'                    
 GROUP BY PARTY_CODE) B                    
 ON A.PARTY_CODE = B.PARTY_CODE                    
 where (A.Pure_Risk+A.proj_risk)<0 ) A                    
 WHERE EXISTS (                    
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)                    
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)                    
                    
 /*AND A.PARTY_CODE='AND2731'*/                   
               
               
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/              
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI b with (nolock) where b.Pure_Risk>=-100             
 and b.proj_risk>-501 and b.party_code=a.party_code              
               
 --/*exclude client who have traded in 5 days*/              
 --delete from #CLI where party_code in (select party_code from #traded5days)              
                  
 UPDATE #CLI                    
 SET FOSHRT = CASE                    
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN                    
 ELSE 0                    
 END                    
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)                    
 WHERE CO_CODE = 'NSEFO'                    
 AND #CLI.PARTY_CODE = B.PARTY_CODE                    
 AND IMARGIN <> 0                    
 
 /*                           
 DELETE from #CLI where PARTY_CODE IN                    
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK)) */--commented on Feb 02 2018 as suggested by Vishal Gohil                   
                    
 SELECT X.PARTY_CODE,                                                      
                   NET_DEBIT,                                                                             
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                                      
                   NON_CASH,                                                      
                   BLUECHIP=Isnull(BLUECHIP, 0),                                                      
                   GOOD=Isnull(GOOD, 0),                                                      
                   AVERAGE=Isnull(AVERAGE, 0),                                                      
                   POOR=Isnull(POOR, 0),                                                      
                   TOTAL=Isnull(TOTAL, 0),                                          
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                                      
                   ADJ_VALUE=NET_DEBIT *-1,                                               EXCLUDE_FLAG=' ',                                                      
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                          
                   GOOD_ADJ=CONVERT(MONEY, 0),                                                      
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                                      
                   POOR_ADJ=CONVERT(MONEY, 0),                               
                   FOSHRT,risktype      
            INTO   #FILE1                                                      
            FROM   #CLI X                                                      
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                                      
                  ANGEL_BEN=Sum(CASE WHEN SOURCE <> 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  BLUECHIP=Sum(CASE WHEN NSE_APPROVED = 'BLUECHIP' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  GOOD=Sum(CASE WHEN NSE_APPROVED = 'GOOD' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  AVERAGE=Sum(CASE WHEN NSE_APPROVED = 'AVERAGE' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                                                             
                  POOR=Sum(CASE  WHEN NSE_APPROVED = 'POOR' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  TOTAL=Sum(TOTAL_WithHC)                                                      
                  FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)GROUP  BY PARTY_CODE) Y                                                      
                  ON X.PARTY_CODE = Y.PARTY_CODE                                                      
                                                      
                                                        
            DELETE FROM #FILE1                                                      
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                                      
            FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                                        
                                  WHERE  CL_TYPE = 'NRI'                                                      
                                          OR BRANCH_CD = 'NRIS')                                                        
            UPDATE #FILE1                                                      
            SET    ADJ_VALUE = 0                                                      
            WHERE  ADJ_VALUE < 0                                                      
                                                      
            CREATE TABLE #FILE2                                                      
              (                                                      
                 SRNO         INT IDENTITY(1, 1),                                                      
                 ISIN         CHAR(12),                                                      
                 SCRIP_CD     VARCHAR(10),                                                      
                 PARTY_CODE   VARCHAR(10),                                                      
                 QTY          INT,                                                      
                 ACCNO        VARCHAR(16),                                                      
                 TOTAL        MONEY,                                                      
                 NSE_APPROVED VARCHAR(25),                                                      
                 NET_DEBIT    MONEY DEFAULT 0,                                                
                 BEN_ADJUSTED MONEY DEFAULT 0,                                                      
                 TOTAL_ADJ    MONEY DEFAULT 0,                    
                 BALAFTERADJ  MONEY DEFAULT 0,                                                      
                 QTY_ADJ      INT,              
                 CLS_rate MONEY,              
                 TOTAL_VALUE_ADJ MONEY,                                                      
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                                      
                 --FO_SHRT MONEY DEFAULT 0                                                          
              )                                                      
                                                      
            SELECT A.*,                                            
                   ADJ_VALUE AS TOTAL_ADJ,                                          
       QTY_ADJ=CONVERT(INT, 0)                                                      
            INTO   #FILET                                                      
            FROM   (SELECT ISIN,                                                      
                           SCRIP_CD,                                                     
                           PARTY_CODE,                                      
                           QTY=Sum(QTY),                                                      
                           ACCNO,                                                      
                           TOTAL=Sum(TOTAL),                                                      
                           NSE_APPROVED                                                      
            FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                                      
            GROUP  BY ISIN,SCRIP_CD,PARTY_CODE,ACCNO,NSE_APPROVED HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                                      
           (SELECT PARTY_CODE,                                                      
                    ADJ_VALUE                                                      
                    FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0) B                                                      
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                                      
                                      
                                      
            --DROP TABLE #CLIENT_LISTTOADJUST                                                          
            SELECT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   /*Change Id :: 2*/                              
                   --DPID,                                                      
                   ADJ_VALUE,                                                      
                   FOSHRT * -1                            AS FOSHRT,                                                      
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM,      
                   risktype                                                      
            INTO   #CLIENT_LISTTOADJUST                                                      
            FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                                          
                              
            SELECT top 0 *                                                      
            INTO   #ILLIQUIED_SCRIPS                                                      
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP            
                                                   
                    
                    
/*                    
                    
           SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   PARTY_CODE,                                                      
                   QTY=Sum(QTY),            
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,                     
                   Sum(TOTAL) DESC) AS ROW_NUM                                                      
            INTO   #DPHOLDING_TO_MOVE                        
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                       
            WHERE  EXISTS (SELECT PARTY_CODE                                                      
                           FROM   #CLIENT_LISTTOADJUST C                                            
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                                      
                   AND NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                                                      
                      B.DUMMY1                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY PARTY_CODE,                                                      
                      ROW_NUM                                                      
*/                    
                    
                    
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED ,
				   clsrate,
				   risktype       =max(c.risktype)                                
                  
            INTO   #DPHOLDING_TO_MOVE_temp                                                   
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST ) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where        NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno,clsrate                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE                                                      
                              
          
    /*Added by Vishal Gohil to exclude poor scrip from projected category on 21/07/2016 by Renil and Abha*/                        
 delete from #DPHOLDING_TO_MOVE_temp  where risktype='Projected' and nse_approved='Poor'      
       
  SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM-- ,   clsrate=max(clsrate)             
                    ,risktype       =max(c.risktype)   
                                 
            INTO   #DPHOLDING_TO_MOVE                                                   
            FROM   #DPHOLDING_TO_MOVE_temp H                                      
                                                                  
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                                      
                                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno                                                  
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE,                                                      
                      ROW_NUM           
                                    
                 /*              
                 /**************************Vishal gohil**************************************************************/              
   /****************************************************************************************/                   
                 select x.* INTO   #DPHOLDING_TO_MOVE                
                 from                        
            (SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
    NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM,   clsrate=max(clsrate)                                                 
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                     
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
--             K47437              
--K48042              
          inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED<>'Poor'                                                  
                   AND TOTAL <> 0    -- and h.party_Code='K48042'                                                                    
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                          
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            union                  
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                               
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM ,   clsrate=max(clsrate)                              
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                 
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED='Poor'                                                  
                   AND TOTAL <> 0       --and h.party_code='K48042'                                                                  
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                   
                      NSE_APPROVED,                                                      
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0  )x                                      
            ORDER  BY x.PARTY_CODE,                                                      
                      ROW_NUM                                    
                                    
                    
   update a set  row_num=b.row_num+a.row_num from #DPHOLDING_TO_MOVE a,              
   (select party_Code,row_num=MAX(row_num) from #DPHOLDING_TO_MOVE group by party_Code)b              
   where a.[party_Code]=b.party_Code and  a.nse_approved='Poor'              
                 
   /****************************************************************************************/              
   /****************************************************************************************/              
   */              
                                    
                                    
                                                      
            CREATE CLUSTERED INDEX [IX_Row_Num]                                                      
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )                       
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            CREATE CLUSTERED INDEX [IX_Party_code]                                                      
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                                    
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                  
            CREATE CLUSTERED INDEX [IX_Party_code]                                                       ON #FILE2 ( [Party_Code] ASC )                                                      
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            DECLARE @PARTY_CNT      AS INT,                                                      
                    @PARTY_CTR      AS INT,                                                      
                    @SCRIP_CNT      AS INT,                                                      
                    @SCRIP_CTR      AS INT,                                  
                    @PARTY_CODE     AS VARCHAR(20),                                                      
/*Change Id :: 2*/                              
                    --@DPID           AS VARCHAR(20),                                                      
                    @FOSHORTAGE     AS MONEY,                                                      
                    @ADJUSTMENT_AMT AS MONEY,                                                      
                    @ADJUSTED_AMT   AS MONEY,                                                      
                    @ADJ_QTY        AS INT,                                                      
                    @QTY            AS INT,                                      
                    @VALUE          AS MONEY,                                                      
                    @CLOSING_PRICE  AS MONEY,                                                      
                  @NET_DEBIT  AS MONEY                                                      
                                                      
            SET @ADJUSTED_AMT = 0                                                      
          SET @PARTY_CTR = 1                                                      
           
            SELECT @PARTY_CNT = Count(*)                                                      
            FROM   #CLIENT_LISTTOADJUST                                                      
                                                      
            --PRINT @PARTY_CNT                                                          
            WHILE( @PARTY_CTR <= @PARTY_CNT )                                             
              BEGIN                                                      
                  SET @ADJUSTMENT_AMT = 0                                                      
                  SET @FOSHORTAGE = 0                                                      
                  SET @ADJUSTED_AMT = 0                      
                                                    
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                                      
                                                          
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                                      
                         @FOSHORTAGE = FOSHRT,                                   
                         @NET_DEBIT = NET_DEBIT                                                      
                  FROM   #CLIENT_LISTTOADJUST                                                      
                  WHERE  ROW_NUM = @PARTY_CTR                          
                                                      
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                                      
                                                      
                  SET @SCRIP_CTR = 1                                                      
                                                      
                  SELECT @SCRIP_CNT = Count(*)                                            
                  FROM   #DPHOLDING_TO_MOVE                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                              
                    
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                                      
                    BEGIN                                                      
                        SELECT @QTY = QTY,                                                      
                  @VALUE = TOTAL,                                                      
                               @CLOSING_PRICE = TOTAL / QTY                                                      
                        FROM   #DPHOLDING_TO_MOVE                                                      
                        WHERE  ROW_NUM = @SCRIP_CTR                                                      
                               AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                        IF @ADJUSTMENT_AMT >= @VALUE                                              
                          BEGIN                                                      
                              SET @ADJ_QTY = @QTY                                                      
                                                      
                 INSERT INTO #FILE2                                                      
                                          (ISIN,                                           
                                           SCRIP_CD,                                                      
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                           TOTAL,                                                      
                                           NSE_APPROVED,                              
                                           NET_DEBIT,                                                      
             QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
                                     PARTY_CODE,                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                        TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                                      
                                     @ADJ_QTY,                                                      
                          CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                ELSE 'N'                                                      
                              END                                            
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                                      
                          END                                                      
                        ELSE                                           
                          BEGIN                                                      
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                                      
                                                      
                              INSERT INTO #FILE2                                                      
                              (ISIN,                                                      
                                           SCRIP_CD,                                  
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                  TOTAL,                                                      
                                           NSE_APPROVED,                                                      
                                           NET_DEBIT,                                            
                                           QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
               Ltrim(Rtrim(PARTY_CODE)),                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                                     TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                      
                                     @ADJ_QTY,                                                      
                                     CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                   ELSE 'N'                                                      
                                     END                                                      
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                            
                                                      
                              BREAK                                                      
                          END                                               
                                                      
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                                      
                    END                                                      
                                         
                  UPDATE #FILE2                                             
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                                      
                         TOTAL_ADJ = @ADJUSTED_AMT                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                                                      
                               
                  SET @PARTY_CTR = @PARTY_CTR + 1                                  
              END                                                      
                                                      
                                
            UPDATE #FILE2                                                      
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                                      
                                
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                                      
            FROM   #FILE1 B                                                      
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                                      
                                            
                                            
            UPDATE #FILE2                                
                SET FO_APPROVED = 'N'                                
            WHERE UPPER(NSE_APPROVED) = 'POOR'                    
                          
                           
              UPDATE #FILE2 SET cls_rate=A.clsrate from              
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B              
              GROUP  BY B.ISIN,                                                      
                      B.SCRIP_CD,                                                      
                      B.PARTY_CODE,                                                      
                      B.ACCNO, B.clsrate,                                                     
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED              
                                 
                
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate              
                            
                            
           /*select * from #FILE2 x inner join #cli y on x.party_code=y.party_code*/      
                                
            DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()                                                      
             
           
               
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                                      
            SELECT DISTINCT *                 
            FROM   VMSS_PURERISK_DPHOLDING                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                              
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                                      
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                               
                                             
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)                   
                  
            /*      
              DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()       
            */                                                     
                                                  
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                                      
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDING                                                     
            SELECT DISTINCT x.*,                                                      
                   @DT AS PROCESS_DATE,'','','',y.risktype                                                      
            FROM   #FILE2 x  inner join #cli y on x.party_code=y.party_code                                                   
            WHERE  x.QTY_ADJ > 0    
			
			 /*delete from VMSS_PURERISK_DPHOLDING where party_code in (select party_code from tbl_sharefetch_excluCodes )   */                                               
                                                   
            /*use general                                                                        
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            use history                                                
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            */                                                      
                  
            delete from  VMSS_PURERISK_DPHOLDING where party_code in (select party_code from general.dbo.client_details where NBFC_Cli='Y' )                   
            --delete from VMSS_PURERISK_DPHOLDING where isin like '%INF%'     
            
			
			     
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                                      
            SELECT DISTINCT *                                               
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST       
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                               
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                
                              
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                              
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                                      
            SELECT DISTINCT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   ANGEL_BEN,                                                      
                   @DT AS PROCESS_DATE,                                                      
                   NON_CASH,                                                      
                   FOSHRT                     
            FROM   #FILE1      
			
			/*delete from VMSS_PURERISK_DPHOLDINGBEN where party_code in (select party_code from tbl_sharefetch_excluCodes )    */                                            
                                     
           exec Pure_Risk_DP_Adj_file_mail             
  /*                          
    --SMS Part      
    SELECT A.party_code,A.AdjAmt ,B.MOBILE_PAGER INTO #SEND1 FROM             
   (select Party_code,AdjAmt=sum(Total_Adj_Value) from VMSS_PURERISK_DPHOLDING where ToSegment is not null group by Party_code) A           
   LEFT OUTER JOIN general.dbo.CLIENT_DETAILS B WITH (NOLOCK)                                                
   ON A.PARTY_CODE = B.PARTY_CODE where B.Mobile_pager is not null          
                                   

   declare @TradingDay datetime   
    ;with sqoffdatae as  
    (  
    select ROW_NUMBER() over(order by a.Start_Date)as srno,  isnull(a.Start_Date,'')   Start_Date                                        
    from general.dbo.bse_sett_mst a                                                                        
    where CONVERT(VARCHAR(10),a.start_Date,121) >= CONVERT(VARCHAR(10),getdate(),121)                                                 
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                          
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                        
    group by Start_Date)  
    select @TradingDay = isnull(Start_Date ,'')  from sqoffdatae where srno=1 ;        
   
   if((DATEPART(DW,GETDATE())>=2 and  DATEPART(DW,GETDATE())<7) and cast(getdate() as date)=cast(@TradingDay as date))  
   begin      
                     
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                         
                  
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
    'P',RIGHT(Getdate(), 2), 'New POA Debit Client' FROM   #SEND1      
          
   /* sms log*/                           
   insert into Tbl_PureRiskAdj_SMS_log      
   SELECT party_code,MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                      
   CONVERT(VARCHAR(11), Getdate(), 103)                                                                               
   FROM   #SEND1          
                            
   INSERT INTO INTRANET.SMS.DBO.SMS SELECT top 1  '9820701602',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                      
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
   'P',RIGHT(Getdate(), 2),'New POA Debit Client' FROM   #SEND1 group by  party_code        
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9820731985','Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                            
   CONVERT(VARCHAR(11), Getdate(), 103), Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1 group by  party_code              
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9819090240',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                     
   CONVERT(VARCHAR(11), Getdate(), 103),Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1  group by  party_code  
   end   
   */
                    
              END                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_bkup_28052020
-- --------------------------------------------------
              
/*                    
CREATED BY :: RENIL PILLAI                    
CREATED ON :: MAY 04 2016                    
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS                    
*/                   
                
create PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_bkup_28052020]                    
AS                    
SET NOCOUNT ON                    
BEGIN    

    exec VMSS_PURERISK_DPSHAREFETCHING_day2                
	declare @dt1 datetime

	select ROW_NUMBER() over(order by a.Start_Date)as srno,         
	isnull(a.Start_Date,'')  Start_Date                                             
	into #dd from general.dbo.bse_sett_mst a                                                                              
	where CONVERT(VARCHAR(10),a.start_Date,121)>= CONVERT(VARCHAR(10),getdate()-7,121)    and
	CONVERT(VARCHAR(10),a.start_Date,121)< CONVERT(VARCHAR(10),getdate(),121)                                                      
	and datepart(dw,a.start_Date) <> 7  --exclude saturday                                                
	and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                              
	group by Start_Date  
    
	select @dt1=max(start_Date) from #dd where srno=3

 select party_code,pure_risk,proj_risk,rms_date=cast(pdate as date),      
 risktype=case when pure_risk<-100 then 'Pure'      
 else 'Projected' end      
into #temp_Riskdata 
  from history.dbo.TBL_RMS_COLLECTION_CLI_HIST with (nolock)  where        
 cast(pdate as date)>=@dt1   
 and datepart(dw,pdate) <> 7
 and datepart(dw,pdate) <> 1   
 and (pure_risk<-100 or  proj_risk<-501) and Exp_Gross>=0.00     
       
 select party_code,risktype=min(risktype) into #final from #temp_Riskdata  group by party_code having count(party_code)>=3
 
 
                   
 SELECT A.*      
 INTO #CLI                    
 FROM (SELECT A.PARTY_CODE,                    
 NON_CASH=0.00,                    
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),                    
 FOSHRT=CONVERT(MONEY, 0) ,  risktype                 
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)                    
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI A WITH (NOLOCK)   inner join #final F on A.party_code=F.party_code                 
  LEFT JOIN (SELECT PARTY_CODE,                    
 NON_CASH=Sum(FinalAmount)                    
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)                    
 WHERE COLL_TYPE = 'SEC'                    
 GROUP BY PARTY_CODE) B                    
 ON A.PARTY_CODE = B.PARTY_CODE                    
 where (A.Pure_Risk+A.proj_risk)<0 ) A                    
 WHERE EXISTS (                    
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)                    
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)                    
                    
 /*AND A.PARTY_CODE='AND2731'*/                   
               
               
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/              
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI b with (nolock) where b.Pure_Risk>=-100             
 and b.proj_risk>-501 and b.party_code=a.party_code              
               
 --/*exclude client who have traded in 5 days*/              
 --delete from #CLI where party_code in (select party_code from #traded5days)              
                  
 UPDATE #CLI                    
 SET FOSHRT = CASE                    
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN                    
 ELSE 0                    
 END                    
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)                    
 WHERE CO_CODE = 'NSEFO'                    
 AND #CLI.PARTY_CODE = B.PARTY_CODE                    
 AND IMARGIN <> 0                    
 
 /*                           
 DELETE from #CLI where PARTY_CODE IN                    
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK)) */--commented on Feb 02 2018 as suggested by Vishal Gohil                   
                    
 SELECT X.PARTY_CODE,                                                      
                   NET_DEBIT,                                                                             
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                                      
                   NON_CASH,                                                      
                   BLUECHIP=Isnull(BLUECHIP, 0),                                                      
                   GOOD=Isnull(GOOD, 0),                                                      
                   AVERAGE=Isnull(AVERAGE, 0),                                                      
                   POOR=Isnull(POOR, 0),                                                      
                   TOTAL=Isnull(TOTAL, 0),                                          
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                                      
                   ADJ_VALUE=NET_DEBIT *-1,                                               EXCLUDE_FLAG=' ',                                                      
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                          
                   GOOD_ADJ=CONVERT(MONEY, 0),                                                      
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                                      
                   POOR_ADJ=CONVERT(MONEY, 0),                               
                   FOSHRT,risktype      
            INTO   #FILE1                                                      
            FROM   #CLI X                                                      
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                                      
                  ANGEL_BEN=Sum(CASE WHEN SOURCE <> 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  BLUECHIP=Sum(CASE WHEN NSE_APPROVED = 'BLUECHIP' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  GOOD=Sum(CASE WHEN NSE_APPROVED = 'GOOD' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  AVERAGE=Sum(CASE WHEN NSE_APPROVED = 'AVERAGE' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                                                             
                  POOR=Sum(CASE  WHEN NSE_APPROVED = 'POOR' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  TOTAL=Sum(TOTAL_WithHC)                                                      
                  FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)GROUP  BY PARTY_CODE) Y                                                      
                  ON X.PARTY_CODE = Y.PARTY_CODE                                                      
                                                      
                                                        
            DELETE FROM #FILE1                                                      
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                                      
            FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                                        
                                  WHERE  CL_TYPE = 'NRI'                                                      
                                          OR BRANCH_CD = 'NRIS')                                                        
            UPDATE #FILE1                                                      
            SET    ADJ_VALUE = 0                                                      
            WHERE  ADJ_VALUE < 0                                                      
                                                      
            CREATE TABLE #FILE2                                                      
              (                                                      
                 SRNO         INT IDENTITY(1, 1),                                                      
                 ISIN         CHAR(12),                                                      
                 SCRIP_CD     VARCHAR(10),                                                      
                 PARTY_CODE   VARCHAR(10),                                                      
                 QTY          INT,                                                      
                 ACCNO        VARCHAR(16),                                                      
                 TOTAL        MONEY,                                                      
                 NSE_APPROVED VARCHAR(25),                                                      
                 NET_DEBIT    MONEY DEFAULT 0,                                                
                 BEN_ADJUSTED MONEY DEFAULT 0,                                                      
                 TOTAL_ADJ    MONEY DEFAULT 0,                    
                 BALAFTERADJ  MONEY DEFAULT 0,                                                      
                 QTY_ADJ      INT,              
                 CLS_rate MONEY,              
                 TOTAL_VALUE_ADJ MONEY,                                                      
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                                      
                 --FO_SHRT MONEY DEFAULT 0                                                          
              )                                                      
                                                      
            SELECT A.*,                                            
                   ADJ_VALUE AS TOTAL_ADJ,                                          
       QTY_ADJ=CONVERT(INT, 0)                                                      
            INTO   #FILET                                                      
            FROM   (SELECT ISIN,                                                      
                           SCRIP_CD,                                                     
                           PARTY_CODE,                                      
                           QTY=Sum(QTY),                                                      
                           ACCNO,                                                      
                           TOTAL=Sum(TOTAL),                                                      
                           NSE_APPROVED                                                      
            FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                                      
            GROUP  BY ISIN,SCRIP_CD,PARTY_CODE,ACCNO,NSE_APPROVED HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                                      
           (SELECT PARTY_CODE,                                                      
                    ADJ_VALUE                                                      
                    FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0) B                                                      
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                                      
                                      
                                      
            --DROP TABLE #CLIENT_LISTTOADJUST                                                          
            SELECT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   /*Change Id :: 2*/                              
                   --DPID,                                                      
                   ADJ_VALUE,                                                      
                   FOSHRT * -1                            AS FOSHRT,                                                      
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM,      
                   risktype                                                      
            INTO   #CLIENT_LISTTOADJUST                                                      
            FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                                          
                              
            SELECT top 0 *                                                      
            INTO   #ILLIQUIED_SCRIPS                                                      
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP            
                                                   
                    
                    
/*                    
                    
           SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   PARTY_CODE,                                                      
                   QTY=Sum(QTY),            
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,                     
                   Sum(TOTAL) DESC) AS ROW_NUM                                                      
            INTO   #DPHOLDING_TO_MOVE                        
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                       
            WHERE  EXISTS (SELECT PARTY_CODE                                                      
                           FROM   #CLIENT_LISTTOADJUST C                                            
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                                      
                   AND NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                                                      
                      B.DUMMY1                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY PARTY_CODE,                                                      
                      ROW_NUM                                                      
*/                    
                    
                    
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED ,
				   clsrate,
				   risktype       =max(c.risktype)                                
                  
            INTO   #DPHOLDING_TO_MOVE_temp                                                   
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST ) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where        NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno,clsrate                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE                                                      
                              
          
    /*Added by Vishal Gohil to exclude poor scrip from projected category on 21/07/2016 by Renil and Abha*/                        
 delete from #DPHOLDING_TO_MOVE_temp  where risktype='Projected' and nse_approved='Poor'      
       
  SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM-- ,   clsrate=max(clsrate)             
                    ,risktype       =max(c.risktype)   
                                 
            INTO   #DPHOLDING_TO_MOVE                                                   
            FROM   #DPHOLDING_TO_MOVE_temp H                                      
                                                                  
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                                      
                                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno                                                  
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE,                                                      
                      ROW_NUM           
                                    
                 /*              
                 /**************************Vishal gohil**************************************************************/              
   /****************************************************************************************/                   
                 select x.* INTO   #DPHOLDING_TO_MOVE                
                 from                        
            (SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
    NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM,   clsrate=max(clsrate)                                                 
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                     
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
--             K47437              
--K48042              
          inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED<>'Poor'                                                  
                   AND TOTAL <> 0    -- and h.party_Code='K48042'                                                                    
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                          
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            union                  
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                               
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM ,   clsrate=max(clsrate)                              
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                 
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED='Poor'                                                  
                   AND TOTAL <> 0       --and h.party_code='K48042'                                                                  
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                   
                      NSE_APPROVED,                                                      
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0  )x                                      
            ORDER  BY x.PARTY_CODE,                                                      
                      ROW_NUM                                    
                                    
                    
   update a set  row_num=b.row_num+a.row_num from #DPHOLDING_TO_MOVE a,              
   (select party_Code,row_num=MAX(row_num) from #DPHOLDING_TO_MOVE group by party_Code)b              
   where a.[party_Code]=b.party_Code and  a.nse_approved='Poor'              
                 
   /****************************************************************************************/              
   /****************************************************************************************/              
   */              
                                    
                                    
                                                      
            CREATE CLUSTERED INDEX [IX_Row_Num]                                                      
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )                       
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            CREATE CLUSTERED INDEX [IX_Party_code]                                                      
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                                    
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                  
            CREATE CLUSTERED INDEX [IX_Party_code]                                                       ON #FILE2 ( [Party_Code] ASC )                                                      
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            DECLARE @PARTY_CNT      AS INT,                                                      
                    @PARTY_CTR      AS INT,                                                      
                    @SCRIP_CNT      AS INT,                                                      
                    @SCRIP_CTR      AS INT,                                  
                    @PARTY_CODE     AS VARCHAR(20),                                                      
/*Change Id :: 2*/                              
                    --@DPID           AS VARCHAR(20),                                                      
                    @FOSHORTAGE     AS MONEY,                                                      
                    @ADJUSTMENT_AMT AS MONEY,                                                      
                    @ADJUSTED_AMT   AS MONEY,                                                      
                    @ADJ_QTY        AS INT,                                                      
                    @QTY            AS INT,                                      
                    @VALUE          AS MONEY,                                                      
                    @CLOSING_PRICE  AS MONEY,                                                      
                  @NET_DEBIT  AS MONEY                                                      
                                                      
            SET @ADJUSTED_AMT = 0                                                      
          SET @PARTY_CTR = 1                                                      
           
            SELECT @PARTY_CNT = Count(*)                                                      
            FROM   #CLIENT_LISTTOADJUST                                                      
                                                      
            --PRINT @PARTY_CNT                                                          
            WHILE( @PARTY_CTR <= @PARTY_CNT )                                             
              BEGIN                                                      
                  SET @ADJUSTMENT_AMT = 0                                                      
                  SET @FOSHORTAGE = 0                                                      
                  SET @ADJUSTED_AMT = 0                      
                                                    
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                                      
                                                          
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                                      
                         @FOSHORTAGE = FOSHRT,                                   
                         @NET_DEBIT = NET_DEBIT                                                      
                  FROM   #CLIENT_LISTTOADJUST                                                      
                  WHERE  ROW_NUM = @PARTY_CTR                          
                                                      
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                                      
                                                      
                  SET @SCRIP_CTR = 1                                                      
                                                      
                  SELECT @SCRIP_CNT = Count(*)                                            
                  FROM   #DPHOLDING_TO_MOVE                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                              
                    
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                                      
                    BEGIN                                                      
                        SELECT @QTY = QTY,                                                      
                  @VALUE = TOTAL,                                                      
                               @CLOSING_PRICE = TOTAL / QTY                                                      
                        FROM   #DPHOLDING_TO_MOVE                                                      
                        WHERE  ROW_NUM = @SCRIP_CTR                                                      
                               AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                        IF @ADJUSTMENT_AMT >= @VALUE                                              
                          BEGIN                                                      
                              SET @ADJ_QTY = @QTY                                                      
                                                      
                 INSERT INTO #FILE2                                                      
                                          (ISIN,                                           
                                           SCRIP_CD,                                                      
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                           TOTAL,                                                      
                                           NSE_APPROVED,                              
                                           NET_DEBIT,                                                      
             QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
                                     PARTY_CODE,                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                        TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                                      
                                     @ADJ_QTY,                                                      
                          CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                ELSE 'N'                                                      
                              END                                            
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                                      
                          END                                                      
                        ELSE                                           
                          BEGIN                                                      
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                                      
                                                      
                              INSERT INTO #FILE2                                                      
                              (ISIN,                                                      
                                           SCRIP_CD,                                  
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                  TOTAL,                                                      
                                           NSE_APPROVED,                                                      
                                           NET_DEBIT,                                            
                                           QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
               Ltrim(Rtrim(PARTY_CODE)),                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                                     TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                      
                                     @ADJ_QTY,                                                      
                                     CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                   ELSE 'N'                                                      
                                     END                                                      
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                            
                                                      
                              BREAK                                                      
                          END                                               
                                                      
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                                      
                    END                                                      
                                         
                  UPDATE #FILE2                                             
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                                      
                         TOTAL_ADJ = @ADJUSTED_AMT                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                                                      
                               
                  SET @PARTY_CTR = @PARTY_CTR + 1                                  
              END                                                      
                                                      
                                
            UPDATE #FILE2                                                      
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                                      
                                
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                                      
            FROM   #FILE1 B                                                      
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                                      
                                            
                                            
            UPDATE #FILE2                                
                SET FO_APPROVED = 'N'                                
            WHERE UPPER(NSE_APPROVED) = 'POOR'                    
                          
                           
              UPDATE #FILE2 SET cls_rate=A.clsrate from              
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B              
              GROUP  BY B.ISIN,                                                      
                      B.SCRIP_CD,                                                      
                      B.PARTY_CODE,                                                      
                      B.ACCNO, B.clsrate,                                                     
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED              
                                 
                
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate              
                            
                            
           /*select * from #FILE2 x inner join #cli y on x.party_code=y.party_code*/      
                                
            DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()                                                      
             
           
               
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                                      
            SELECT DISTINCT *                 
            FROM   VMSS_PURERISK_DPHOLDING                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                              
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                                      
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                               
                                             
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)                   
                  
            /*      
              DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()       
            */                                                     
                                                  
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                                      
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDING                                                     
            SELECT DISTINCT x.*,                                                      
                   @DT AS PROCESS_DATE,'','','',y.risktype                                                      
            FROM   #FILE2 x  inner join #cli y on x.party_code=y.party_code                                                   
            WHERE  x.QTY_ADJ > 0    
			
			 /*delete from VMSS_PURERISK_DPHOLDING where party_code in (select party_code from tbl_sharefetch_excluCodes )   */                                               
                                                   
            /*use general                                                                        
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            use history                                                
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            */                                                      
                  
            delete from  VMSS_PURERISK_DPHOLDING where party_code in (select party_code from general.dbo.client_details where NBFC_Cli='Y' )                   
            --delete from VMSS_PURERISK_DPHOLDING where isin like '%INF%'     
            
			
			     
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                                      
            SELECT DISTINCT *                                               
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST       
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                               
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                
                              
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                              
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                                      
            SELECT DISTINCT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   ANGEL_BEN,                                                      
                   @DT AS PROCESS_DATE,                                                      
                   NON_CASH,                                                      
                   FOSHRT                     
            FROM   #FILE1      
			
			/*delete from VMSS_PURERISK_DPHOLDINGBEN where party_code in (select party_code from tbl_sharefetch_excluCodes )    */                                            
                                     
           exec Pure_Risk_DP_Adj_file_mail             
  /*                          
    --SMS Part      
    SELECT A.party_code,A.AdjAmt ,B.MOBILE_PAGER INTO #SEND1 FROM             
   (select Party_code,AdjAmt=sum(Total_Adj_Value) from VMSS_PURERISK_DPHOLDING where ToSegment is not null group by Party_code) A           
   LEFT OUTER JOIN general.dbo.CLIENT_DETAILS B WITH (NOLOCK)                                                
   ON A.PARTY_CODE = B.PARTY_CODE where B.Mobile_pager is not null          
                                   

   declare @TradingDay datetime   
    ;with sqoffdatae as  
    (  
    select ROW_NUMBER() over(order by a.Start_Date)as srno,  isnull(a.Start_Date,'')   Start_Date                                        
    from general.dbo.bse_sett_mst a                                                                        
    where CONVERT(VARCHAR(10),a.start_Date,121) >= CONVERT(VARCHAR(10),getdate(),121)                                                 
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                          
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                        
    group by Start_Date)  
    select @TradingDay = isnull(Start_Date ,'')  from sqoffdatae where srno=1 ;        
   
   if((DATEPART(DW,GETDATE())>=2 and  DATEPART(DW,GETDATE())<7) and cast(getdate() as date)=cast(@TradingDay as date))  
   begin      
                     
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                         
                  
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
    'P',RIGHT(Getdate(), 2), 'New POA Debit Client' FROM   #SEND1      
          
   /* sms log*/                           
   insert into Tbl_PureRiskAdj_SMS_log      
   SELECT party_code,MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                      
   CONVERT(VARCHAR(11), Getdate(), 103)                                                                               
   FROM   #SEND1          
                            
   INSERT INTO INTRANET.SMS.DBO.SMS SELECT top 1  '9820701602',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                      
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
   'P',RIGHT(Getdate(), 2),'New POA Debit Client' FROM   #SEND1 group by  party_code        
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9820731985','Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                            
   CONVERT(VARCHAR(11), Getdate(), 103), Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1 group by  party_code              
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9819090240',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                     
   CONVERT(VARCHAR(11), Getdate(), 103),Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1  group by  party_code  
   end   
   */
                    
              END                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_bkup-28052020
-- --------------------------------------------------
              
/*                    
CREATED BY :: RENIL PILLAI                    
CREATED ON :: MAY 04 2016                    
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS                    
*/                   
                
create PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_bkup-28052020]                    
AS                    
SET NOCOUNT ON                    
BEGIN    

    exec VMSS_PURERISK_DPSHAREFETCHING_day2                
	declare @dt1 datetime

	select ROW_NUMBER() over(order by a.Start_Date)as srno,         
	isnull(a.Start_Date,'')  Start_Date                                             
	into #dd from general.dbo.bse_sett_mst a                                                                              
	where CONVERT(VARCHAR(10),a.start_Date,121)>= CONVERT(VARCHAR(10),getdate()-7,121)    and
	CONVERT(VARCHAR(10),a.start_Date,121)< CONVERT(VARCHAR(10),getdate(),121)                                                      
	and datepart(dw,a.start_Date) <> 7  --exclude saturday                                                
	and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                              
	group by Start_Date  
    
	select @dt1=max(start_Date) from #dd where srno=3

 select party_code,pure_risk,proj_risk,rms_date=cast(pdate as date),      
 risktype=case when pure_risk<-100 then 'Pure'      
 else 'Projected' end      
into #temp_Riskdata 
  from history.dbo.TBL_RMS_COLLECTION_CLI_HIST with (nolock)  where        
 cast(pdate as date)>=@dt1   
 and datepart(dw,pdate) <> 7
 and datepart(dw,pdate) <> 1   
 and (pure_risk<-100 or  proj_risk<-501) and Exp_Gross>=0.00     
       
 select party_code,risktype=min(risktype) into #final from #temp_Riskdata  group by party_code having count(party_code)>=3
 
 
                   
 SELECT A.*      
 INTO #CLI                    
 FROM (SELECT A.PARTY_CODE,                    
 NON_CASH=0.00,                    
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),                    
 FOSHRT=CONVERT(MONEY, 0) ,  risktype                 
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)                    
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI A WITH (NOLOCK)   inner join #final F on A.party_code=F.party_code                 
  LEFT JOIN (SELECT PARTY_CODE,                    
 NON_CASH=Sum(FinalAmount)                    
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)                    
 WHERE COLL_TYPE = 'SEC'                    
 GROUP BY PARTY_CODE) B                    
 ON A.PARTY_CODE = B.PARTY_CODE                    
 where (A.Pure_Risk+A.proj_risk)<0 ) A                    
 WHERE EXISTS (                    
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)                    
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)                    
                    
 /*AND A.PARTY_CODE='AND2731'*/                   
               
               
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/              
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI b with (nolock) where b.Pure_Risk>=-100             
 and b.proj_risk>-501 and b.party_code=a.party_code              
               
 --/*exclude client who have traded in 5 days*/              
 --delete from #CLI where party_code in (select party_code from #traded5days)              
                  
 UPDATE #CLI                    
 SET FOSHRT = CASE                    
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN                    
 ELSE 0                    
 END                    
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)                    
 WHERE CO_CODE = 'NSEFO'                    
 AND #CLI.PARTY_CODE = B.PARTY_CODE                    
 AND IMARGIN <> 0                    
 
 /*                           
 DELETE from #CLI where PARTY_CODE IN                    
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK)) */--commented on Feb 02 2018 as suggested by Vishal Gohil                   
                    
 SELECT X.PARTY_CODE,                                                      
                   NET_DEBIT,                                                                             
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                                      
                   NON_CASH,                                                      
                   BLUECHIP=Isnull(BLUECHIP, 0),                                                      
                   GOOD=Isnull(GOOD, 0),                                                      
                   AVERAGE=Isnull(AVERAGE, 0),                                                      
                   POOR=Isnull(POOR, 0),                                                      
                   TOTAL=Isnull(TOTAL, 0),                                          
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                                      
                   ADJ_VALUE=NET_DEBIT *-1,                                               EXCLUDE_FLAG=' ',                                                      
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                          
                   GOOD_ADJ=CONVERT(MONEY, 0),                                                      
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                                      
                   POOR_ADJ=CONVERT(MONEY, 0),                               
                   FOSHRT,risktype      
            INTO   #FILE1                                                      
            FROM   #CLI X                                                      
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                                      
                  ANGEL_BEN=Sum(CASE WHEN SOURCE <> 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  BLUECHIP=Sum(CASE WHEN NSE_APPROVED = 'BLUECHIP' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  GOOD=Sum(CASE WHEN NSE_APPROVED = 'GOOD' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  AVERAGE=Sum(CASE WHEN NSE_APPROVED = 'AVERAGE' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                                                             
                  POOR=Sum(CASE  WHEN NSE_APPROVED = 'POOR' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  TOTAL=Sum(TOTAL_WithHC)                                                      
                  FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)GROUP  BY PARTY_CODE) Y                                                      
                  ON X.PARTY_CODE = Y.PARTY_CODE                                                      
                                                      
                                                        
            DELETE FROM #FILE1                                                      
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                                      
            FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                                        
                                  WHERE  CL_TYPE = 'NRI'                                                      
                                          OR BRANCH_CD = 'NRIS')                                                        
            UPDATE #FILE1                                                      
            SET    ADJ_VALUE = 0                                                      
            WHERE  ADJ_VALUE < 0                                                      
                                                      
            CREATE TABLE #FILE2                                                      
              (                                                      
                 SRNO         INT IDENTITY(1, 1),                                                      
                 ISIN         CHAR(12),                                                      
                 SCRIP_CD     VARCHAR(10),                                                      
                 PARTY_CODE   VARCHAR(10),                                                      
                 QTY          INT,                                                      
                 ACCNO        VARCHAR(16),                                                      
                 TOTAL        MONEY,                                                      
                 NSE_APPROVED VARCHAR(25),                                                      
                 NET_DEBIT    MONEY DEFAULT 0,                                                
                 BEN_ADJUSTED MONEY DEFAULT 0,                                                      
                 TOTAL_ADJ    MONEY DEFAULT 0,                    
                 BALAFTERADJ  MONEY DEFAULT 0,                                                      
                 QTY_ADJ      INT,              
                 CLS_rate MONEY,              
                 TOTAL_VALUE_ADJ MONEY,                                                      
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                                      
                 --FO_SHRT MONEY DEFAULT 0                                                          
              )                                                      
                                                      
            SELECT A.*,                                            
                   ADJ_VALUE AS TOTAL_ADJ,                                          
       QTY_ADJ=CONVERT(INT, 0)                                                      
            INTO   #FILET                                                      
            FROM   (SELECT ISIN,                                                      
                           SCRIP_CD,                                                     
                           PARTY_CODE,                                      
                           QTY=Sum(QTY),                                                      
                           ACCNO,                                                      
                           TOTAL=Sum(TOTAL),                                                      
                           NSE_APPROVED                                                      
            FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                                      
            GROUP  BY ISIN,SCRIP_CD,PARTY_CODE,ACCNO,NSE_APPROVED HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                                      
           (SELECT PARTY_CODE,                                                      
                    ADJ_VALUE                                                      
                    FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0) B                                                      
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                                      
                                      
                                      
            --DROP TABLE #CLIENT_LISTTOADJUST                                                          
            SELECT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   /*Change Id :: 2*/                              
                   --DPID,                                                      
                   ADJ_VALUE,                                                      
                   FOSHRT * -1                            AS FOSHRT,                                                      
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM,      
                   risktype                                                      
            INTO   #CLIENT_LISTTOADJUST                                                      
            FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                                          
                              
            SELECT top 0 *                                                      
            INTO   #ILLIQUIED_SCRIPS                                                      
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP            
                                                   
                    
                    
/*                    
                    
           SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   PARTY_CODE,                                                      
                   QTY=Sum(QTY),            
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,                     
                   Sum(TOTAL) DESC) AS ROW_NUM                                                      
            INTO   #DPHOLDING_TO_MOVE                        
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                       
            WHERE  EXISTS (SELECT PARTY_CODE                                                      
                           FROM   #CLIENT_LISTTOADJUST C                                            
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                                      
                   AND NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                                                      
                      B.DUMMY1                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY PARTY_CODE,                                                      
                      ROW_NUM                                                      
*/                    
                    
                    
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED ,
				   clsrate,
				   risktype       =max(c.risktype)                                
                  
            INTO   #DPHOLDING_TO_MOVE_temp                                                   
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST ) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where        NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno,clsrate                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE                                                      
                              
          
    /*Added by Vishal Gohil to exclude poor scrip from projected category on 21/07/2016 by Renil and Abha*/                        
 delete from #DPHOLDING_TO_MOVE_temp  where risktype='Projected' and nse_approved='Poor'      
       
  SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM-- ,   clsrate=max(clsrate)             
                    ,risktype       =max(c.risktype)   
                                 
            INTO   #DPHOLDING_TO_MOVE                                                   
            FROM   #DPHOLDING_TO_MOVE_temp H                                      
                                                                  
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                                      
                                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno                                                  
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE,                                                      
                      ROW_NUM           
                                    
                 /*              
                 /**************************Vishal gohil**************************************************************/              
   /****************************************************************************************/                   
                 select x.* INTO   #DPHOLDING_TO_MOVE                
                 from                        
            (SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
    NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM,   clsrate=max(clsrate)                                                 
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                     
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
--             K47437              
--K48042              
          inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED<>'Poor'                                                  
                   AND TOTAL <> 0    -- and h.party_Code='K48042'                                                                    
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                          
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            union                  
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                               
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM ,   clsrate=max(clsrate)                              
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                 
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED='Poor'                                                  
                   AND TOTAL <> 0       --and h.party_code='K48042'                                                                  
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                   
                      NSE_APPROVED,                                                      
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0  )x                                      
            ORDER  BY x.PARTY_CODE,                                                      
                      ROW_NUM                                    
                                    
                    
   update a set  row_num=b.row_num+a.row_num from #DPHOLDING_TO_MOVE a,              
   (select party_Code,row_num=MAX(row_num) from #DPHOLDING_TO_MOVE group by party_Code)b              
   where a.[party_Code]=b.party_Code and  a.nse_approved='Poor'              
                 
   /****************************************************************************************/              
   /****************************************************************************************/              
   */              
                                    
                                    
                                                      
            CREATE CLUSTERED INDEX [IX_Row_Num]                                                      
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )                       
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            CREATE CLUSTERED INDEX [IX_Party_code]                                                      
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                                    
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                  
            CREATE CLUSTERED INDEX [IX_Party_code]                                                       ON #FILE2 ( [Party_Code] ASC )                                                      
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            DECLARE @PARTY_CNT      AS INT,                                                      
                    @PARTY_CTR      AS INT,                                                      
                    @SCRIP_CNT      AS INT,                                                      
                    @SCRIP_CTR      AS INT,                                  
                    @PARTY_CODE     AS VARCHAR(20),                                                      
/*Change Id :: 2*/                              
                    --@DPID           AS VARCHAR(20),                                                      
                    @FOSHORTAGE     AS MONEY,                                                      
                    @ADJUSTMENT_AMT AS MONEY,                                                      
                    @ADJUSTED_AMT   AS MONEY,                                                      
                    @ADJ_QTY        AS INT,                                                      
                    @QTY            AS INT,                                      
                    @VALUE          AS MONEY,                                                      
                    @CLOSING_PRICE  AS MONEY,                                                      
                  @NET_DEBIT  AS MONEY                                                      
                                                      
            SET @ADJUSTED_AMT = 0                                                      
          SET @PARTY_CTR = 1                                                      
           
            SELECT @PARTY_CNT = Count(*)                                                      
            FROM   #CLIENT_LISTTOADJUST                                                      
                                                      
            --PRINT @PARTY_CNT                                                          
            WHILE( @PARTY_CTR <= @PARTY_CNT )                                             
              BEGIN                                                      
                  SET @ADJUSTMENT_AMT = 0                                                      
                  SET @FOSHORTAGE = 0                                                      
                  SET @ADJUSTED_AMT = 0                      
                                                    
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                                      
                                                          
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                                      
                         @FOSHORTAGE = FOSHRT,                                   
                         @NET_DEBIT = NET_DEBIT                                                      
                  FROM   #CLIENT_LISTTOADJUST                                                      
                  WHERE  ROW_NUM = @PARTY_CTR                          
                                                      
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                                      
                                                      
                  SET @SCRIP_CTR = 1                                                      
                                                      
                  SELECT @SCRIP_CNT = Count(*)                                            
                  FROM   #DPHOLDING_TO_MOVE                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                              
                    
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                                      
                    BEGIN                                                      
                        SELECT @QTY = QTY,                                                      
                  @VALUE = TOTAL,                                                      
                               @CLOSING_PRICE = TOTAL / QTY                                                      
                        FROM   #DPHOLDING_TO_MOVE                                                      
                        WHERE  ROW_NUM = @SCRIP_CTR                                                      
                               AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                        IF @ADJUSTMENT_AMT >= @VALUE                                              
                          BEGIN                                                      
                              SET @ADJ_QTY = @QTY                                                      
                                                      
                 INSERT INTO #FILE2                                                      
                                          (ISIN,                                           
                                           SCRIP_CD,                                                      
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                           TOTAL,                                                      
                                           NSE_APPROVED,                              
                                           NET_DEBIT,                                                      
             QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
                                     PARTY_CODE,                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                        TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                                      
                                     @ADJ_QTY,                                                      
                          CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                ELSE 'N'                                                      
                              END                                            
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                                      
                          END                                                      
                        ELSE                                           
                          BEGIN                                                      
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                                      
                                                      
                              INSERT INTO #FILE2                                                      
                              (ISIN,                                                      
                                           SCRIP_CD,                                  
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                  TOTAL,                                                      
                                           NSE_APPROVED,                                                      
                                           NET_DEBIT,                                            
                                           QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
               Ltrim(Rtrim(PARTY_CODE)),                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                                     TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                      
                                     @ADJ_QTY,                                                      
                                     CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                   ELSE 'N'                                                      
                                     END                                                      
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                            
                                                      
                              BREAK                                                      
                          END                                               
                                                      
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                                      
                    END                                                      
                                         
                  UPDATE #FILE2                                             
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                                      
                         TOTAL_ADJ = @ADJUSTED_AMT                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                                                      
                               
                  SET @PARTY_CTR = @PARTY_CTR + 1                                  
              END                                                      
                                                      
                                
            UPDATE #FILE2                                                      
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                                      
                                
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                                      
            FROM   #FILE1 B                                                      
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                                      
                                            
                                            
            UPDATE #FILE2                                
                SET FO_APPROVED = 'N'                                
            WHERE UPPER(NSE_APPROVED) = 'POOR'                    
                          
                           
              UPDATE #FILE2 SET cls_rate=A.clsrate from              
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B              
              GROUP  BY B.ISIN,                                                      
                      B.SCRIP_CD,                                                      
                      B.PARTY_CODE,                                                      
                      B.ACCNO, B.clsrate,                                                     
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED              
                                 
                
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate              
                            
                            
           /*select * from #FILE2 x inner join #cli y on x.party_code=y.party_code*/      
                                
            DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()                                                      
             
           
               
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                                      
            SELECT DISTINCT *                 
            FROM   VMSS_PURERISK_DPHOLDING                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                              
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                                      
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                               
                                             
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)                   
                  
            /*      
              DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()       
            */                                                     
                                                  
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                                      
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDING                                                     
            SELECT DISTINCT x.*,                                                      
                   @DT AS PROCESS_DATE,'','','',y.risktype                                                      
            FROM   #FILE2 x  inner join #cli y on x.party_code=y.party_code                                                   
            WHERE  x.QTY_ADJ > 0    
			
			 /*delete from VMSS_PURERISK_DPHOLDING where party_code in (select party_code from tbl_sharefetch_excluCodes )   */                                               
                                                   
            /*use general                                                                        
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            use history                                                
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            */                                                      
                  
            delete from  VMSS_PURERISK_DPHOLDING where party_code in (select party_code from general.dbo.client_details where NBFC_Cli='Y' )                   
            --delete from VMSS_PURERISK_DPHOLDING where isin like '%INF%'     
            
			
			     
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                                      
            SELECT DISTINCT *                                               
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST       
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                               
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                
                              
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                              
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                                      
            SELECT DISTINCT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   ANGEL_BEN,                                                      
                   @DT AS PROCESS_DATE,                                                      
                   NON_CASH,                                                      
                   FOSHRT                     
            FROM   #FILE1      
			
			/*delete from VMSS_PURERISK_DPHOLDINGBEN where party_code in (select party_code from tbl_sharefetch_excluCodes )    */                                            
                                     
           exec Pure_Risk_DP_Adj_file_mail             
  /*                          
    --SMS Part      
    SELECT A.party_code,A.AdjAmt ,B.MOBILE_PAGER INTO #SEND1 FROM             
   (select Party_code,AdjAmt=sum(Total_Adj_Value) from VMSS_PURERISK_DPHOLDING where ToSegment is not null group by Party_code) A           
   LEFT OUTER JOIN general.dbo.CLIENT_DETAILS B WITH (NOLOCK)                                                
   ON A.PARTY_CODE = B.PARTY_CODE where B.Mobile_pager is not null          
                                   

   declare @TradingDay datetime   
    ;with sqoffdatae as  
    (  
    select ROW_NUMBER() over(order by a.Start_Date)as srno,  isnull(a.Start_Date,'')   Start_Date                                        
    from general.dbo.bse_sett_mst a                                                                        
    where CONVERT(VARCHAR(10),a.start_Date,121) >= CONVERT(VARCHAR(10),getdate(),121)                                                 
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                          
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                        
    group by Start_Date)  
    select @TradingDay = isnull(Start_Date ,'')  from sqoffdatae where srno=1 ;        
   
   if((DATEPART(DW,GETDATE())>=2 and  DATEPART(DW,GETDATE())<7) and cast(getdate() as date)=cast(@TradingDay as date))  
   begin      
                     
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                         
                  
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
    'P',RIGHT(Getdate(), 2), 'New POA Debit Client' FROM   #SEND1      
          
   /* sms log*/                           
   insert into Tbl_PureRiskAdj_SMS_log      
   SELECT party_code,MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                      
   CONVERT(VARCHAR(11), Getdate(), 103)                                                                               
   FROM   #SEND1          
                            
   INSERT INTO INTRANET.SMS.DBO.SMS SELECT top 1  '9820701602',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                      
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
   'P',RIGHT(Getdate(), 2),'New POA Debit Client' FROM   #SEND1 group by  party_code        
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9820731985','Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                            
   CONVERT(VARCHAR(11), Getdate(), 103), Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1 group by  party_code              
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9819090240',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                     
   CONVERT(VARCHAR(11), Getdate(), 103),Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1  group by  party_code  
   end   
   */
                    
              END                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_day2
-- --------------------------------------------------
              
/*                    
CREATED BY :: RENIL PILLAI                    
CREATED ON :: MAY 04 2016                    
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS                    
*/                   
                
CREATE PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_day2]                    
AS                    
SET NOCOUNT ON                    
BEGIN                    
	declare @dt1 datetime

	select ROW_NUMBER() over(order by a.Start_Date)as srno,         
	isnull(a.Start_Date,'')  Start_Date                                             
	into #dd from general.dbo.bse_sett_mst a                                                                              
	where CONVERT(VARCHAR(10),a.start_Date,121)>= CONVERT(VARCHAR(10),getdate()-7,121)    and
	CONVERT(VARCHAR(10),a.start_Date,121)< CONVERT(VARCHAR(10),getdate(),121)                                                      
	and datepart(dw,a.start_Date) <> 7  --exclude saturday                                                
	and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                              
	group by Start_Date  
    
	select @dt1=max(start_Date) from #dd where srno=4
 --print cast((getdate()-3) as date) 

 select party_code,pure_risk,proj_risk,rms_date=cast(pdate as date),      
 risktype=case when pure_risk<-100 then 'Pure'      
 else 'Projected' end      
 into #temp_Riskdata 
 from history.dbo.TBL_RMS_COLLECTION_CLI_HIST with (nolock)  where        
 cast(pdate as date)>=@dt1      
 and (pure_risk<-100 or  proj_risk<-501) and Exp_Gross>=0.00     
       
 select party_code,risktype=min(risktype) into #final from #temp_Riskdata  group by party_code having count(party_code)>=2
                   
 SELECT A.*      
 INTO #CLI                    
 FROM (SELECT A.PARTY_CODE,                    
 NON_CASH=0.00,                    
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),                    
 FOSHRT=CONVERT(MONEY, 0) ,  risktype                 
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)                    
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI A WITH (NOLOCK)   inner join #final F on A.party_code=F.party_code                 
  LEFT JOIN (SELECT PARTY_CODE,                    
 NON_CASH=Sum(FinalAmount)                    
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)                    
 WHERE COLL_TYPE = 'SEC'                    
 GROUP BY PARTY_CODE) B                    
 ON A.PARTY_CODE = B.PARTY_CODE                    
 where (A.Pure_Risk+A.proj_risk)<0 ) A                    
 WHERE EXISTS (                    
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)                    
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)                    
                    
 /*AND A.PARTY_CODE='AND2731'*/                   
               
               
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/              
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI b with (nolock) where b.Pure_Risk>=-100             
 and b.proj_risk>-501 and b.party_code=a.party_code              
               
 --/*exclude client who have traded in 5 days*/              
 --delete from #CLI where party_code in (select party_code from #traded5days)              
                  
 UPDATE #CLI                    
 SET FOSHRT = CASE                    
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN                    
 ELSE 0                    
 END                    
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)                    
 WHERE CO_CODE = 'NSEFO'                    
 AND #CLI.PARTY_CODE = B.PARTY_CODE                    
 AND IMARGIN <> 0                    
 
 /*                           
 DELETE from #CLI where PARTY_CODE IN                    
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK)) */--commented on Feb 02 2018 as suggested by Vishal Gohil                   
                    
 SELECT X.PARTY_CODE,                                                      
                   NET_DEBIT,                                                                             
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                                      
                   NON_CASH,                                                      
                   BLUECHIP=Isnull(BLUECHIP, 0),                                                      
                   GOOD=Isnull(GOOD, 0),                                                      
                   AVERAGE=Isnull(AVERAGE, 0),                                                      
                   POOR=Isnull(POOR, 0),                                                      
                   TOTAL=Isnull(TOTAL, 0),                                          
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                                      
                   ADJ_VALUE=NET_DEBIT *-1,                                               EXCLUDE_FLAG=' ',                                                      
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                          
                   GOOD_ADJ=CONVERT(MONEY, 0),                                                      
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                                      
                   POOR_ADJ=CONVERT(MONEY, 0),                               
                   FOSHRT,risktype      
            INTO   #FILE1                                                      
            FROM   #CLI X                                                      
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                                      
                  ANGEL_BEN=Sum(CASE WHEN SOURCE <> 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  BLUECHIP=Sum(CASE WHEN NSE_APPROVED = 'BLUECHIP' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  GOOD=Sum(CASE WHEN NSE_APPROVED = 'GOOD' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  AVERAGE=Sum(CASE WHEN NSE_APPROVED = 'AVERAGE' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                                                             
                  POOR=Sum(CASE  WHEN NSE_APPROVED = 'POOR' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  TOTAL=Sum(TOTAL_WithHC)                                                      
                  FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)GROUP  BY PARTY_CODE) Y                                                      
                  ON X.PARTY_CODE = Y.PARTY_CODE                                                      
                                                      
                                                        
            DELETE FROM #FILE1                                                      
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                                      
            FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                                        
                                  WHERE  CL_TYPE = 'NRI'                                                      
                                          OR BRANCH_CD = 'NRIS')                                                        
            UPDATE #FILE1                                                      
            SET    ADJ_VALUE = 0                                                      
            WHERE  ADJ_VALUE < 0                                                      
                                                      
            CREATE TABLE #FILE2                                                      
              (                                                      
                 SRNO         INT IDENTITY(1, 1),                                                      
                 ISIN         CHAR(12),                                                      
                 SCRIP_CD     VARCHAR(10),                                                      
                 PARTY_CODE   VARCHAR(10),                                                      
                 QTY          INT,                                                      
                 ACCNO        VARCHAR(16),                                                      
                 TOTAL        MONEY,                                                      
                 NSE_APPROVED VARCHAR(25),                                                      
                 NET_DEBIT    MONEY DEFAULT 0,                                                
                 BEN_ADJUSTED MONEY DEFAULT 0,                                                      
                 TOTAL_ADJ    MONEY DEFAULT 0,                    
                 BALAFTERADJ  MONEY DEFAULT 0,                                                      
                 QTY_ADJ      INT,              
                 CLS_rate MONEY,              
                 TOTAL_VALUE_ADJ MONEY,                                                      
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                                      
                 --FO_SHRT MONEY DEFAULT 0                                                          
              )                                                      
                                                      
            SELECT A.*,                                            
                   ADJ_VALUE AS TOTAL_ADJ,                                          
       QTY_ADJ=CONVERT(INT, 0)                                                      
            INTO   #FILET                                                      
            FROM   (SELECT ISIN,                                                      
                           SCRIP_CD,                                                     
                           PARTY_CODE,                                      
                           QTY=Sum(QTY),                                                      
                           ACCNO,                                                      
                           TOTAL=Sum(TOTAL),                                                      
                           NSE_APPROVED                                                      
            FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                                      
            GROUP  BY ISIN,SCRIP_CD,PARTY_CODE,ACCNO,NSE_APPROVED HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                                      
           (SELECT PARTY_CODE,                                                      
                    ADJ_VALUE                                                      
                    FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0) B                                                      
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                                      
                                      
                                      
            --DROP TABLE #CLIENT_LISTTOADJUST                                                          
            SELECT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   /*Change Id :: 2*/                              
                   --DPID,                                                      
                   ADJ_VALUE,                                                      
                   FOSHRT * -1                            AS FOSHRT,                                                      
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM,      
                   risktype                                                      
            INTO   #CLIENT_LISTTOADJUST                                                      
            FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                                          
                              
            SELECT top 0 *                                                      
            INTO   #ILLIQUIED_SCRIPS                                                      
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP            
                                                              
                    
    SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED ,
				   clsrate,
				   risktype       =max(c.risktype)                                
                  
            INTO   #DPHOLDING_TO_MOVE_temp                                                   
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST ) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where        NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno,clsrate                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE                                                      
                              
          
    /*Added by Vishal Gohil to exclude poor scrip from projected category on 21/07/2016 by Renil and Abha*/                        
 delete from #DPHOLDING_TO_MOVE_temp  where risktype='Projected' and nse_approved='Poor'      
       
  SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM-- ,   clsrate=max(clsrate)             
                    ,risktype       =max(c.risktype)   
                                 
            INTO   #DPHOLDING_TO_MOVE                                                   
            FROM   #DPHOLDING_TO_MOVE_temp H                                      
                                                                  
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                                      
                                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno                                                  
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE,                                                      
                      ROW_NUM           
                                           
            CREATE CLUSTERED INDEX [IX_Row_Num]                                                      
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )                       
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            CREATE CLUSTERED INDEX [IX_Party_code]                                                      
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                                    
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                  
            CREATE CLUSTERED INDEX [IX_Party_code]                                                       ON #FILE2 ( [Party_Code] ASC )                                                      
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            DECLARE @PARTY_CNT      AS INT,                                                      
                    @PARTY_CTR      AS INT,                                                      
                    @SCRIP_CNT      AS INT,                                                      
                    @SCRIP_CTR      AS INT,                                  
                    @PARTY_CODE     AS VARCHAR(20),                                                      
/*Change Id :: 2*/                              
                    --@DPID           AS VARCHAR(20),                                                      
                    @FOSHORTAGE     AS MONEY,                                                      
                    @ADJUSTMENT_AMT AS MONEY,                                                      
                    @ADJUSTED_AMT   AS MONEY,                                                      
                    @ADJ_QTY        AS INT,                                                      
                    @QTY            AS INT,                                      
                    @VALUE          AS MONEY,                                                      
                    @CLOSING_PRICE  AS MONEY,                                                      
                  @NET_DEBIT  AS MONEY                                                      
                                                      
            SET @ADJUSTED_AMT = 0                                                      
          SET @PARTY_CTR = 1                                                      
           
            SELECT @PARTY_CNT = Count(*)                                                      
            FROM   #CLIENT_LISTTOADJUST                                                      
                                                      
            --PRINT @PARTY_CNT                                                          
            WHILE( @PARTY_CTR <= @PARTY_CNT )                                             
              BEGIN                                                      
                  SET @ADJUSTMENT_AMT = 0                                                      
                  SET @FOSHORTAGE = 0                                                      
                  SET @ADJUSTED_AMT = 0                      
                                                    
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                                      
                                                          
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                                      
                         @FOSHORTAGE = FOSHRT,                                   
                         @NET_DEBIT = NET_DEBIT                                                      
                  FROM   #CLIENT_LISTTOADJUST                                                      
                  WHERE  ROW_NUM = @PARTY_CTR                          
                                                      
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                                      
                                                      
                  SET @SCRIP_CTR = 1                                                      
                                                      
                  SELECT @SCRIP_CNT = Count(*)                                            
                  FROM   #DPHOLDING_TO_MOVE                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                              
                    
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                                      
                    BEGIN                                                      
                        SELECT @QTY = QTY,                                                      
                  @VALUE = TOTAL,                                                      
                               @CLOSING_PRICE = TOTAL / QTY                                                      
                        FROM   #DPHOLDING_TO_MOVE                                                      
                        WHERE  ROW_NUM = @SCRIP_CTR                                                      
                               AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                        IF @ADJUSTMENT_AMT >= @VALUE                                              
                          BEGIN                                                      
                              SET @ADJ_QTY = @QTY                                                      
                                                      
                 INSERT INTO #FILE2                                                      
                                          (ISIN,                                           
                                           SCRIP_CD,                                                      
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                           TOTAL,                                                      
                                           NSE_APPROVED,                              
                                           NET_DEBIT,                                                      
             QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
                                     PARTY_CODE,                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                        TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                                      
                                     @ADJ_QTY,                                                      
                          CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                ELSE 'N'                                                      
                              END                                            
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                                      
                          END                                                      
                        ELSE                                           
                          BEGIN                                                      
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                                      
                                                      
                              INSERT INTO #FILE2                                                      
                              (ISIN,                                                      
                                           SCRIP_CD,                                  
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                  TOTAL,                                                      
                                           NSE_APPROVED,                                                      
                                           NET_DEBIT,                                            
                                           QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
               Ltrim(Rtrim(PARTY_CODE)),                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                                     TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                      
                                     @ADJ_QTY,                                                      
                                     CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                   ELSE 'N'                                                      
                                     END                                                      
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                            
                                                      
                              BREAK                                                      
                          END                                               
                                                      
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                                      
                    END                                                      
                                         
                  UPDATE #FILE2                                             
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                                      
                         TOTAL_ADJ = @ADJUSTED_AMT                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                                                      
                               
                  SET @PARTY_CTR = @PARTY_CTR + 1                                  
              END                                                      
                                                      
                                
            UPDATE #FILE2                                                      
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                                      
                                
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                                      
            FROM   #FILE1 B                                                      
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                                      
                                            
                                            
            UPDATE #FILE2                                
                SET FO_APPROVED = 'N'                                
            WHERE UPPER(NSE_APPROVED) = 'POOR'                    
                          
                           
              UPDATE #FILE2 SET cls_rate=A.clsrate from              
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B              
              GROUP  BY B.ISIN,                                                      
                      B.SCRIP_CD,                                                      
                      B.PARTY_CODE,                                                      
                      B.ACCNO, B.clsrate,                                                     
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED              
                                 
                
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate              
                            
                            
           /*select * from #FILE2 x inner join #cli y on x.party_code=y.party_code*/      
                                
            DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()                                                      
             
           
               
            --INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                                      
            --SELECT DISTINCT *                 
            --FROM   VMSS_PURERISK_DPHOLDING                                                      
                                                      
            --DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                              
            --WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                                      
            --       AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                               
                                             
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)                   
                  
            /*      
              DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()       
            */                                                     
            --select * into VMSS_PURERISK_DPHOLDING_SMSDay2 from VMSS_PURERISK_DPHOLDING where 1=2     
            delete from  VMSS_PURERISK_DPHOLDING_SMSDay2 where party_code in (select party_code from general.dbo.client_details where NBFC_Cli='Y' )                   
			     
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_SMSDay2                                                      
            SELECT DISTINCT *                                               
            FROM   VMSS_PURERISK_DPHOLDING_SMSDay2                                                      
            
			
			TRUNCATE TABLE VMSS_PURERISK_DPHOLDING_SMSDay2                                                      
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDING_SMSDay2                                                     
            SELECT DISTINCT x.*,                                                      
                   getdate() AS PROCESS_DATE,'','','',y.risktype                                                      
            FROM   #FILE2 x  inner join #cli y on x.party_code=y.party_code                                                   
            WHERE  x.QTY_ADJ > 0    
                                          
            --DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST       
            --WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                               
            --       AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                
                              
            --TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                              
                                                      
            --INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                                      
            --SELECT DISTINCT PARTY_CODE,                                                      
            --       NET_DEBIT,                                                      
            --       ANGEL_BEN,                                                      
            --       @DT AS PROCESS_DATE,                                                      
            --       NON_CASH,                                                      
            --       FOSHRT                     
            --FROM   #FILE1      
			
		                                   
                   
 
                    
              END                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_liveon29nov
-- --------------------------------------------------
              
/*                    
CREATED BY :: RENIL PILLAI                    
CREATED ON :: MAY 04 2016                    
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS                    
*/                   
                
create PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_liveon29nov]                    
AS                    
SET NOCOUNT ON                    
BEGIN                    
	declare @dt1 datetime

	select ROW_NUMBER() over(order by a.Start_Date)as srno,         
	isnull(a.Start_Date,'')  Start_Date                                             
	into #dd from general.dbo.bse_sett_mst a                                                                              
	where CONVERT(VARCHAR(10),a.start_Date,121)>= CONVERT(VARCHAR(10),getdate()-7,121)    and
	CONVERT(VARCHAR(10),a.start_Date,121)< CONVERT(VARCHAR(10),getdate(),121)                                                      
	and datepart(dw,a.start_Date) <> 7  --exclude saturday                                                
	and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                              
	group by Start_Date  
    
	select @dt1=max(start_Date) from #dd where srno=3

 select party_code,pure_risk,proj_risk,rms_date=cast(pdate as date),      
 risktype=case when pure_risk<-100 then 'Pure'      
 else 'Projected' end      
into #temp_Riskdata 
  from history.dbo.TBL_RMS_COLLECTION_CLI_HIST with (nolock)  where        
 cast(pdate as date)>=@dt1      
 and (pure_risk<-100 or  proj_risk<-501) and Exp_Gross>=0.00     and party_code in (select distinct party_code from VMSS_PURERISK_DPHOLDING_SMSDay2 )
       
 select party_code,risktype=min(risktype) into #final from #temp_Riskdata  group by party_code having count(party_code)>=3
 
 
                   
 SELECT A.*      
 INTO #CLI                    
 FROM (SELECT A.PARTY_CODE,                    
 NON_CASH=0.00,                    
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),                    
 FOSHRT=CONVERT(MONEY, 0) ,  risktype                 
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)                    
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI A WITH (NOLOCK)   inner join #final F on A.party_code=F.party_code                 
  LEFT JOIN (SELECT PARTY_CODE,                    
 NON_CASH=Sum(FinalAmount)                    
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)                    
 WHERE COLL_TYPE = 'SEC'                    
 GROUP BY PARTY_CODE) B                    
 ON A.PARTY_CODE = B.PARTY_CODE                    
 where (A.Pure_Risk+A.proj_risk)<0 ) A                    
 WHERE EXISTS (                    
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)                    
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)                    
                    
 /*AND A.PARTY_CODE='AND2731'*/                   
               
               
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/              
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI b with (nolock) where b.Pure_Risk>=-100             
 and b.proj_risk>-501 and b.party_code=a.party_code              
               
 --/*exclude client who have traded in 5 days*/              
 --delete from #CLI where party_code in (select party_code from #traded5days)              
                  
 UPDATE #CLI                    
 SET FOSHRT = CASE                    
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN                    
 ELSE 0                    
 END                    
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)                    
 WHERE CO_CODE = 'NSEFO'                    
 AND #CLI.PARTY_CODE = B.PARTY_CODE                    
 AND IMARGIN <> 0                    
 
 /*                           
 DELETE from #CLI where PARTY_CODE IN                    
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK)) */--commented on Feb 02 2018 as suggested by Vishal Gohil                   
                    
 SELECT X.PARTY_CODE,                                                      
                   NET_DEBIT,                                                                             
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                                      
                   NON_CASH,                                                      
                   BLUECHIP=Isnull(BLUECHIP, 0),                                                      
                   GOOD=Isnull(GOOD, 0),                                                      
                   AVERAGE=Isnull(AVERAGE, 0),                                                      
                   POOR=Isnull(POOR, 0),                                                      
                   TOTAL=Isnull(TOTAL, 0),                                          
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                                      
                   ADJ_VALUE=NET_DEBIT *-1,                                               EXCLUDE_FLAG=' ',                                                      
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                          
                   GOOD_ADJ=CONVERT(MONEY, 0),                                                      
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                                      
                   POOR_ADJ=CONVERT(MONEY, 0),                               
                   FOSHRT,risktype      
            INTO   #FILE1                                                      
            FROM   #CLI X                                                      
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                                      
                  ANGEL_BEN=Sum(CASE WHEN SOURCE <> 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  BLUECHIP=Sum(CASE WHEN NSE_APPROVED = 'BLUECHIP' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  GOOD=Sum(CASE WHEN NSE_APPROVED = 'GOOD' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  AVERAGE=Sum(CASE WHEN NSE_APPROVED = 'AVERAGE' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                                                             
                  POOR=Sum(CASE  WHEN NSE_APPROVED = 'POOR' AND SOURCE = 'DP' THEN TOTAL_WithHC ELSE 0 END),                                                      
                  TOTAL=Sum(TOTAL_WithHC)                                                      
                  FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)GROUP  BY PARTY_CODE) Y                                                      
                  ON X.PARTY_CODE = Y.PARTY_CODE                                                      
                                                      
                                                        
            DELETE FROM #FILE1                                                      
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                                      
            FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                                        
                                  WHERE  CL_TYPE = 'NRI'                                                      
                                          OR BRANCH_CD = 'NRIS')                                                        
            UPDATE #FILE1                                                      
            SET    ADJ_VALUE = 0                                                      
            WHERE  ADJ_VALUE < 0                                                      
                                                      
            CREATE TABLE #FILE2                                                      
              (                                                      
                 SRNO         INT IDENTITY(1, 1),                                                      
                 ISIN         CHAR(12),                                                      
                 SCRIP_CD     VARCHAR(10),                                                      
                 PARTY_CODE   VARCHAR(10),                                                      
                 QTY          INT,                                                      
                 ACCNO        VARCHAR(16),                                                      
                 TOTAL        MONEY,                                                      
                 NSE_APPROVED VARCHAR(25),                                                      
                 NET_DEBIT    MONEY DEFAULT 0,                                                
                 BEN_ADJUSTED MONEY DEFAULT 0,                                                      
                 TOTAL_ADJ    MONEY DEFAULT 0,                    
                 BALAFTERADJ  MONEY DEFAULT 0,                                                      
                 QTY_ADJ      INT,              
                 CLS_rate MONEY,              
                 TOTAL_VALUE_ADJ MONEY,                                                      
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                                      
                 --FO_SHRT MONEY DEFAULT 0                                                          
              )                                                      
                                                      
            SELECT A.*,                                            
                   ADJ_VALUE AS TOTAL_ADJ,                                          
       QTY_ADJ=CONVERT(INT, 0)                                                      
            INTO   #FILET                                                      
            FROM   (SELECT ISIN,                                                      
                           SCRIP_CD,                                                     
                           PARTY_CODE,                                      
                           QTY=Sum(QTY),                                                      
                           ACCNO,                                                      
                           TOTAL=Sum(TOTAL),                                                      
                           NSE_APPROVED                                                      
            FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                                      
            GROUP  BY ISIN,SCRIP_CD,PARTY_CODE,ACCNO,NSE_APPROVED HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                                      
           (SELECT PARTY_CODE,                                                      
                    ADJ_VALUE                                                      
                    FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0) B                                                      
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                                      
                                      
                                      
            --DROP TABLE #CLIENT_LISTTOADJUST                                                          
            SELECT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   /*Change Id :: 2*/                              
                   --DPID,                                                      
                   ADJ_VALUE,                                                      
                   FOSHRT * -1                            AS FOSHRT,                                                      
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM,      
                   risktype                                                      
            INTO   #CLIENT_LISTTOADJUST                                                      
            FROM   #FILE1                                                      
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                                          
                              
            SELECT top 0 *                                                      
            INTO   #ILLIQUIED_SCRIPS                                                      
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP            
                                                   
                    
                    
/*                    
                    
           SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   PARTY_CODE,                                                      
                   QTY=Sum(QTY),            
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,                     
                   Sum(TOTAL) DESC) AS ROW_NUM                                                      
            INTO   #DPHOLDING_TO_MOVE                        
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                       
            WHERE  EXISTS (SELECT PARTY_CODE                                                      
                           FROM   #CLIENT_LISTTOADJUST C                                            
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                                      
                   AND NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                                                      
                      B.DUMMY1                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY PARTY_CODE,                                                      
                      ROW_NUM                                                      
*/                    
                    
                    
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED ,
				   clsrate,
				   risktype       =max(c.risktype)                                
                  
            INTO   #DPHOLDING_TO_MOVE_temp                                                   
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST ) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where        NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                      
                   AND [SOURCE] = 'DP'                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno,clsrate                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE                                                      
                              
          
    /*Added by Vishal Gohil to exclude poor scrip from projected category on 21/07/2016 by Renil and Abha*/                        
 delete from #DPHOLDING_TO_MOVE_temp  where risktype='Projected' and nse_approved='Poor'      
       
  SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM-- ,   clsrate=max(clsrate)             
                    ,risktype       =max(c.risktype)   
                                 
            INTO   #DPHOLDING_TO_MOVE                                                   
            FROM   #DPHOLDING_TO_MOVE_temp H                                      
                                                                  
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
 WHERE  H.ISIN = I.ISIN)                                                      
                                                                      
                   AND TOTAL <> 0                                                                         
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                          
                      NSE_APPROVED,                                                      
                      B.srno                                                  
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            ORDER  BY H.PARTY_CODE,                                                      
                      ROW_NUM           
                                    
                 /*              
                 /**************************Vishal gohil**************************************************************/              
   /****************************************************************************************/                   
                 select x.* INTO   #DPHOLDING_TO_MOVE                
                 from                        
            (SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                                                      
    NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM,   clsrate=max(clsrate)                                                 
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                     
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
--             K47437              
--K48042              
          inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                      
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED<>'Poor'                                                  
                   AND TOTAL <> 0    -- and h.party_Code='K48042'                                                                    
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                                                      
                      NSE_APPROVED,                          
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                        
            union                  
            SELECT ISIN,                                                      
                   SCRIP_CD,                                    
                   H.PARTY_CODE,                                                      
                   QTY=Sum(QTY),                                                      
                   ACCNO,                                                      
                   TOTAL=Sum(TOTAL),                               
                   NSE_APPROVED,                                
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,                     
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)              
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))              
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                                 
     b.srno ) AS ROW_NUM ,   clsrate=max(clsrate)                              
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                      
                     ON H.NSE_APPROVED = B.CATEGORYNAME                                     
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                                      
                           FROM   #CLIENT_LISTTOADJUST) C                                            
                           on C.PARTY_CODE = H.PARTY_CODE                                                       
                   where NOT EXISTS(SELECT *                                                 
                                  FROM   #ILLIQUIED_SCRIPS I                                                      
                                  WHERE  H.ISIN = I.ISIN)                                                      
                   AND [SOURCE] = 'DP' and     NSE_APPROVED='Poor'                                                  
                   AND TOTAL <> 0       --and h.party_code='K48042'                                                                  
            GROUP  BY ISIN,                                                      
                      SCRIP_CD,                                                      
                      H.PARTY_CODE,                                                      
                      ACCNO,                   
                      NSE_APPROVED,                                                      
                      B.srno                                                      
            HAVING CONVERT(INT,Sum(QTY)) <> 0  )x                                      
            ORDER  BY x.PARTY_CODE,                                                      
                      ROW_NUM                                    
                                    
                    
   update a set  row_num=b.row_num+a.row_num from #DPHOLDING_TO_MOVE a,              
   (select party_Code,row_num=MAX(row_num) from #DPHOLDING_TO_MOVE group by party_Code)b              
   where a.[party_Code]=b.party_Code and  a.nse_approved='Poor'              
                 
   /****************************************************************************************/              
   /****************************************************************************************/              
   */              
                                    
                                    
                                                      
            CREATE CLUSTERED INDEX [IX_Row_Num]                                                      
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )                       
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            CREATE CLUSTERED INDEX [IX_Party_code]                                                      
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                                    
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                  
            CREATE CLUSTERED INDEX [IX_Party_code]                                                       ON #FILE2 ( [Party_Code] ASC )                                                      
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                      
                                                      
            DECLARE @PARTY_CNT      AS INT,                                                      
                    @PARTY_CTR      AS INT,                                                      
                    @SCRIP_CNT      AS INT,                                                      
                    @SCRIP_CTR      AS INT,                                  
                    @PARTY_CODE     AS VARCHAR(20),                                                      
/*Change Id :: 2*/                              
                    --@DPID           AS VARCHAR(20),                                                      
                    @FOSHORTAGE     AS MONEY,                                                      
                    @ADJUSTMENT_AMT AS MONEY,                                                      
                    @ADJUSTED_AMT   AS MONEY,                                                      
                    @ADJ_QTY        AS INT,                                                      
                    @QTY            AS INT,                                      
                    @VALUE          AS MONEY,                                                      
                    @CLOSING_PRICE  AS MONEY,                                                      
                  @NET_DEBIT  AS MONEY                                                      
                                                      
            SET @ADJUSTED_AMT = 0                                                      
          SET @PARTY_CTR = 1                                                      
           
            SELECT @PARTY_CNT = Count(*)                                                      
            FROM   #CLIENT_LISTTOADJUST                                                      
                                                      
            --PRINT @PARTY_CNT                                                          
            WHILE( @PARTY_CTR <= @PARTY_CNT )                                             
              BEGIN                                                      
                  SET @ADJUSTMENT_AMT = 0                                                      
                  SET @FOSHORTAGE = 0                                                      
                  SET @ADJUSTED_AMT = 0                      
                                                    
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                                      
                                                          
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                                      
                         @FOSHORTAGE = FOSHRT,                                   
                         @NET_DEBIT = NET_DEBIT                                                      
                  FROM   #CLIENT_LISTTOADJUST                                                      
                  WHERE  ROW_NUM = @PARTY_CTR                          
                                                      
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                                      
                                                      
                  SET @SCRIP_CTR = 1                                                      
                                                      
                  SELECT @SCRIP_CNT = Count(*)                                            
                  FROM   #DPHOLDING_TO_MOVE                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                              
                    
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                                      
                    BEGIN                                                      
                        SELECT @QTY = QTY,                                                      
                  @VALUE = TOTAL,                                                      
                               @CLOSING_PRICE = TOTAL / QTY                                                      
                        FROM   #DPHOLDING_TO_MOVE                                                      
                        WHERE  ROW_NUM = @SCRIP_CTR                                                      
                               AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                        IF @ADJUSTMENT_AMT >= @VALUE                                              
                          BEGIN                                                      
                              SET @ADJ_QTY = @QTY                                                      
                                                      
                 INSERT INTO #FILE2                                                      
                                          (ISIN,                                           
                                           SCRIP_CD,                                                      
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                           TOTAL,                                                      
                                           NSE_APPROVED,                              
                                           NET_DEBIT,                                                      
             QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
                                     PARTY_CODE,                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                        TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                                      
                                     @ADJ_QTY,                                                      
                          CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                ELSE 'N'                                                      
                              END                                            
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                                      
                          END                                                      
                        ELSE                                           
                          BEGIN                                                      
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                                      
                                                      
                              INSERT INTO #FILE2                                                      
                              (ISIN,                                                      
                                           SCRIP_CD,                                  
                                           PARTY_CODE,                                                      
                                           QTY,                                                      
                                           ACCNO,                                                      
                                  TOTAL,                                                      
                                           NSE_APPROVED,                                                      
                                           NET_DEBIT,                                            
                                           QTY_ADJ,                                                      
                                           FO_APPROVED)                                                      
                              SELECT ISIN,                                                      
                                     SCRIP_CD,                                                      
               Ltrim(Rtrim(PARTY_CODE)),                                                      
                                     QTY,                                                      
                                     ACCNO,                                                      
                                     TOTAL,                                                      
                                     NSE_APPROVED,                                                      
                                     @NET_DEBIT,                                      
                                     @ADJ_QTY,                                                      
                                     CASE                                                      
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                      
                                   ELSE 'N'                                                      
                                     END                                                      
                              FROM   #DPHOLDING_TO_MOVE                                                      
                              WHERE  ROW_NUM = @SCRIP_CTR                                                      
                                     AND PARTY_CODE = @PARTY_CODE                                                      
                                                      
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                                      
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                            
                                                      
                              BREAK                                                      
                          END                                               
                                                      
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                                      
                    END                                                      
                                         
                  UPDATE #FILE2                                             
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                                      
                         TOTAL_ADJ = @ADJUSTED_AMT                                                      
                  WHERE  PARTY_CODE = @PARTY_CODE                                                      
                               
                  SET @PARTY_CTR = @PARTY_CTR + 1                                  
              END                                                      
                                                      
                                
            UPDATE #FILE2                                                      
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                                      
                                
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                                      
            FROM   #FILE1 B                                                      
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                                      
                                            
                                            
            UPDATE #FILE2                                
                SET FO_APPROVED = 'N'                                
            WHERE UPPER(NSE_APPROVED) = 'POOR'                    
                          
                           
              UPDATE #FILE2 SET cls_rate=A.clsrate from              
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B              
              GROUP  BY B.ISIN,                                                      
                      B.SCRIP_CD,                                                      
                      B.PARTY_CODE,                                                      
                      B.ACCNO, B.clsrate,                                                     
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED              
                                 
                
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate              
                            
                            
           /*select * from #FILE2 x inner join #cli y on x.party_code=y.party_code*/      
                                
            DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()                                                      
             
           
               
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                                      
            SELECT DISTINCT *                 
            FROM   VMSS_PURERISK_DPHOLDING                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                              
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                                      
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                               
                                             
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)                   
                  
            /*      
              DECLARE @DT AS DATETIME                                                      
                                                      
            SET @DT=Getdate()       
            */                                                     
                                                  
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                                      
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDING                                                     
            SELECT DISTINCT x.*,                                                      
                   @DT AS PROCESS_DATE,'','','',y.risktype                                                      
            FROM   #FILE2 x  inner join #cli y on x.party_code=y.party_code                                                   
            WHERE  x.QTY_ADJ > 0    
			
			 /*delete from VMSS_PURERISK_DPHOLDING where party_code in (select party_code from tbl_sharefetch_excluCodes )   */                                               
                                                   
            /*use general                                                                        
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            use history                                                
            alter table POA_DP_Adj_Ben add FOShrt money                                                                        
            */                                                      
                  
            delete from  VMSS_PURERISK_DPHOLDING where party_code in (select party_code from general.dbo.client_details where NBFC_Cli='Y' )                   
            --delete from VMSS_PURERISK_DPHOLDING where isin like '%INF%'     
            
			
			     
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                                      
            SELECT DISTINCT *                                               
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                                      
                                                      
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST       
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                               
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                
                              
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                              
                                                      
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                                      
            SELECT DISTINCT PARTY_CODE,                                                      
                   NET_DEBIT,                                                      
                   ANGEL_BEN,                                                      
                   @DT AS PROCESS_DATE,                                                      
                   NON_CASH,                                                      
                   FOSHRT                     
            FROM   #FILE1      
			
			/*delete from VMSS_PURERISK_DPHOLDINGBEN where party_code in (select party_code from tbl_sharefetch_excluCodes )    */                                            
                                     
           exec Pure_Risk_DP_Adj_file_mail             
  /*                          
    --SMS Part      
    SELECT A.party_code,A.AdjAmt ,B.MOBILE_PAGER INTO #SEND1 FROM             
   (select Party_code,AdjAmt=sum(Total_Adj_Value) from VMSS_PURERISK_DPHOLDING where ToSegment is not null group by Party_code) A           
   LEFT OUTER JOIN general.dbo.CLIENT_DETAILS B WITH (NOLOCK)                                                
   ON A.PARTY_CODE = B.PARTY_CODE where B.Mobile_pager is not null          
                                   

   declare @TradingDay datetime   
    ;with sqoffdatae as  
    (  
    select ROW_NUMBER() over(order by a.Start_Date)as srno,  isnull(a.Start_Date,'')   Start_Date                                        
    from general.dbo.bse_sett_mst a                                                                        
    where CONVERT(VARCHAR(10),a.start_Date,121) >= CONVERT(VARCHAR(10),getdate(),121)                                                 
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                          
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                                                        
    group by Start_Date)  
    select @TradingDay = isnull(Start_Date ,'')  from sqoffdatae where srno=1 ;        
   
   if((DATEPART(DW,GETDATE())>=2 and  DATEPART(DW,GETDATE())<7) and cast(getdate() as date)=cast(@TradingDay as date))  
   begin      
                     
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                         
                  
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
    'P',RIGHT(Getdate(), 2), 'New POA Debit Client' FROM   #SEND1      
          
   /* sms log*/                           
   insert into Tbl_PureRiskAdj_SMS_log      
   SELECT party_code,MOBILE_PAGER,                                               
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                      
   CONVERT(VARCHAR(11), Getdate(), 103)                                                                               
   FROM   #SEND1          
                            
   INSERT INTO INTRANET.SMS.DBO.SMS SELECT top 1  '9820701602',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                      
   CONVERT(VARCHAR(11), Getdate(), 103),                                                
   Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                                
   'P',RIGHT(Getdate(), 2),'New POA Debit Client' FROM   #SEND1 group by  party_code        
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9820731985','Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                            
   CONVERT(VARCHAR(11), Getdate(), 103), Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1 group by  party_code              
                           
   INSERT INTO INTRANET.SMS.DBO.SMS                                                
   SELECT top 1  '9819090240',                                                
   'Dear client (' +ltrim(rtrim(party_code)) +'),Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, max(AdjAmt))) + ' are transferred from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 022-42185454.',                                     
   CONVERT(VARCHAR(11), Getdate(), 103),Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),'P',RIGHT(Getdate(), 2),'New POA Debit Client'                                                
   FROM   #SEND1  group by  party_code  
   end   
   */
                    
              END                    
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_new
-- --------------------------------------------------

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
/*              
CREATED BY :: RENIL PILLAI              
CREATED ON :: MAY 04 2016              
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS              
*/             
          
CREATE PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_new]              
AS              
SET NOCOUNT ON              
BEGIN              
          
              
--Declare @tdate as datetime = (select MAX(holddate) from VMSS_JVDP_file with (nolock))                          
/*        
declare @startdate datetime,@enddate datetime        
        
set @startdate=(Select TOP 1 sauda_date         
    from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC)         
    a ORDER BY sauda_date ASC )        
        
set @enddate=Convert(varchar(11),(Select TOP 1 sauda_date         
    from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC)         
    a ORDER BY sauda_date ASC ),121)+' 23:59:59'        
            
        
        
select * into #TBL_RMS_COLLECTION_CLI_ABL_HIST from         
TBL_RMS_COLLECTION_CLI_ABL_HIST with (nolock) where rms_date between @startdate and @enddate        
*/        
        
        
--/*Added to consider clients who have not traded in last 5 days */        
--select party_code,lastbilldate=max(lastbilldate) into #lastbilldate from         
--GENERAL.DBO.RMS_DtclFi with (nolock) where co_code in ('BSECM','NSECM','NSEFO','MCD','NSX')         
--group by party_code        
         
--  select * into #traded5days from #lastbilldate where lastbilldate >        
-- (Select TOP 1 sauda_date         
--from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC)         
--a ORDER BY sauda_date ASC         
-- )  
 
 select party_code,pure_risk,proj_risk,rms_date=cast(rms_date as date),
 risktype=case when pure_risk<-100 then 'Pure'
 else 'Projected' end
  into #temp_Riskdata from history.dbo.TBL_RMS_COLLECTION_CLI_ABL_HIST with (nolock)  
  where  
 cast(rms_date as date)>cast((getdate()-5) as date) and
  (pure_risk<-100 or  proj_risk<-501)
 
 select party_code,risktype=min(risktype) into #final from #temp_Riskdata  group by party_code having count(party_code)>=5
 

 
               
 SELECT A.*
 INTO #CLI              
 FROM (SELECT A.PARTY_CODE,              
 NON_CASH=0.00,              
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),              
 FOSHRT=CONVERT(MONEY, 0) ,  risktype           
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)              
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL A WITH (NOLOCK)   inner join #final F on A.party_code=F.party_code           
  LEFT JOIN (SELECT PARTY_CODE,              
 NON_CASH=Sum(FinalAmount)              
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)              
 WHERE COLL_TYPE = 'SEC'              
 GROUP BY PARTY_CODE) B              
 ON A.PARTY_CODE = B.PARTY_CODE              
 where (A.Pure_Risk+A.proj_risk)<0 ) A              
 WHERE EXISTS (              
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)              
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)              
              
 /*AND A.PARTY_CODE='AND2731'*/             
         
         
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/        
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL b with (nolock) where b.Pure_Risk>=-100       
 and b.proj_risk>-501 and b.party_code=a.party_code        
         
 --/*exclude client who have traded in 5 days*/      
 --delete from #CLI where party_code in (select party_code from #traded5days)        
         
              
              
 UPDATE #CLI              
 SET FOSHRT = CASE              
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN              
 ELSE 0              
 END              
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)              
 WHERE CO_CODE = 'NSEFO'              
 AND #CLI.PARTY_CODE = B.PARTY_CODE              
 AND IMARGIN <> 0              
              
    /*              
 /*Client not active in NSE segment */              
 --Added for BSE by Renil on Feb 2 2016 as instructed by Vishal Gohil and Anil Wandhre              
 delete B from #CLI B where not exists              
 (select distinct cl_code from anand1.msajag.dbo.client_brok_Details A with (nolock)              
 where a.Exchange in ('BSE','NSE') and a.Segment='CAPITAL'          
 and a.cl_code=b.Party_code)              
    */              
              
             
 DELETE from #CLI where PARTY_CODE IN              
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK))              
              
               
      
             SELECT X.PARTY_CODE,                                                
                   NET_DEBIT,                        
         /*Change Id :: 2*/                        
                   --DPID,                                                
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                                
             NON_CASH,                                                
                   BLUECHIP=Isnull(BLUECHIP, 0),                                                
                   GOOD=Isnull(GOOD, 0),                                                
                   AVERAGE=Isnull(AVERAGE, 0),                                                
                   POOR=Isnull(POOR, 0),                                                
                   TOTAL=Isnull(TOTAL, 0),                                    
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                                
                   ADJ_VALUE=NET_DEBIT *-1,                        
                   EXCLUDE_FLAG=' ',                                                
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                                
                   GOOD_ADJ=CONVERT(MONEY, 0),                                                
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                                
                   POOR_ADJ=CONVERT(MONEY, 0),                         
                   FOSHRT,risktype
            INTO   #FILE1                                                
            FROM   #CLI X                                                
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                                
                  ANGEL_BEN=Sum(CASE                                                
                                                           WHEN SOURCE <> 'DP' THEN TOTAL_WithHC                                                
                                                    ELSE 0                                                
                                                         END),                                                
        BLUECHIP=Sum(CASE                                                
                                                          WHEN NSE_APPROVED = 'BLUECHIP'                              
                                                               AND SOURCE = 'DP' THEN TOTAL_WithHC                                                
                    ELSE 0                                                
                                                        END),                                                
                                           GOOD=Sum(CASE                                                
                                                      WHEN NSE_APPROVED = 'GOOD'                                                
AND SOURCE = 'DP' THEN TOTAL_WithHC                                                
                                                      ELSE 0                                                
                                                    END),                                                
                                           AVERAGE=Sum(CASE                                                
                                                         WHEN NSE_APPROVED = 'AVERAGE'                                                
                                                              AND SOURCE = 'DP' THEN TOTAL_WithHC       
                                                         ELSE 0                                                
                                                       END),                                                                                       
                   POOR=Sum(CASE                                                
                                                      WHEN NSE_APPROVED = 'POOR'                                                
                                                           AND SOURCE = 'DP' THEN TOTAL_WithHC                                                
                                                      ELSE 0                                                
                                                    END),                                                
      TOTAL=Sum(TOTAL_WithHC)                                                
                                    FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)                                                
                                    GROUP  BY PARTY_CODE) Y                                                
                     ON X.PARTY_CODE = Y.PARTY_CODE                                                
                                                
                                                  
            DELETE FROM #FILE1                                                
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                                
      FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                                  
                                  WHERE  CL_TYPE = 'NRI'                                                
                                          OR BRANCH_CD = 'NRIS')                                                
    
                        
              
            UPDATE #FILE1                                                
            SET    ADJ_VALUE = 0                                                
            WHERE  ADJ_VALUE < 0                                                
                                                
            CREATE TABLE #FILE2                                                
              (                                                
                 SRNO         INT IDENTITY(1, 1),                                                
                 ISIN         CHAR(12),                                                
                 SCRIP_CD     VARCHAR(10),                                                
                 PARTY_CODE   VARCHAR(10),                                                
                 QTY          INT,                                                
                 ACCNO        VARCHAR(16),                                                
            TOTAL        MONEY,                                                
                 NSE_APPROVED VARCHAR(25),                                                
                 NET_DEBIT    MONEY DEFAULT 0,                                            
                 BEN_ADJUSTED MONEY DEFAULT 0,                                                
                 TOTAL_ADJ    MONEY DEFAULT 0,                
                 BALAFTERADJ  MONEY DEFAULT 0,            
                 QTY_ADJ      INT,        
                 CLS_rate MONEY,        
                 TOTAL_VALUE_ADJ MONEY,                                                
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                                
                 --FO_SHRT MONEY DEFAULT 0                                                    
              )                                                
                                                
            SELECT A.*,                                      
                   ADJ_VALUE AS TOTAL_ADJ,                                    
				   QTY_ADJ=CONVERT(INT, 0)                                                
            INTO   #FILET                                                
            FROM   (SELECT ISIN,                                                
                           SCRIP_CD,                                               
                           PARTY_CODE,                                
                           QTY=Sum(QTY),                                                
                           ACCNO,                                                
                           TOTAL=Sum(TOTAL),                                                
                           NSE_APPROVED                                                
   FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                                
                    GROUP  BY ISIN,                                                
                              SCRIP_CD,                                                
                              PARTY_CODE,                                                
                              ACCNO,                                                
                              NSE_APPROVED                                  
                    HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                                
           (SELECT PARTY_CODE,                                                
                                          
                           ADJ_VALUE                                                
                    FROM   #FILE1                                                
                                
      WHERE  ADJ_VALUE > 0) B                                                
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                                
                                
                                
            --DROP TABLE #CLIENT_LISTTOADJUST                                                    
            SELECT PARTY_CODE,                                                
                   NET_DEBIT,                                                
                   /*Change Id :: 2*/                        
                   --DPID,                                                
                   ADJ_VALUE,                                                
                   FOSHRT * -1                            AS FOSHRT,                                                
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM,
                   risktype                                                
            INTO   #CLIENT_LISTTOADJUST                                                
            FROM   #FILE1                                                
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                                    
                        
            SELECT top 0 *                                                
         INTO   #ILLIQUIED_SCRIPS                                                
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP      
    
    
                    
                             
              
              
/*             
              
     SELECT ISIN,                                        
                   SCRIP_CD,                              
                   PARTY_CODE,                                                
                   QTY=Sum(QTY),                                                
                   ACCNO,                                                
                   TOTAL=Sum(TOTAL),                                                
                   NSE_APPROVED,                          
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,               
                   Sum(TOTAL) DESC) AS ROW_NUM                                                
            INTO   #DPHOLDING_TO_MOVE                  
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                
                     ON H.NSE_APPROVED = B.CATEGORYNAME                 
            WHERE  EXISTS (SELECT PARTY_CODE                                                
                           FROM   #CLIENT_LISTTOADJUST C                                      
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                                
                   AND NOT EXISTS(SELECT *                                                
                                  FROM   #ILLIQUIED_SCRIPS I                                                
                                  WHERE  H.ISIN = I.ISIN)                                                
                   AND [SOURCE] = 'DP'                                                
                   AND TOTAL <> 0                                                                   
            GROUP  BY ISIN,                                                
                      SCRIP_CD,                                                
                      PARTY_CODE,                                                
                      ACCNO,                                                
                      NSE_APPROVED,                                                
                      B.DUMMY1                                                
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                  
            ORDER  BY PARTY_CODE,                                                
                      ROW_NUM                                                
*/              
              
              
            SELECT ISIN,                                                
                   SCRIP_CD,                              
                   H.PARTY_CODE,                                                
                   QTY=Sum(QTY),                                                
                   ACCNO,                                                
                   TOTAL=Sum(TOTAL),                                                
                   NSE_APPROVED,                          
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,               
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)        
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)        
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))        
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                           
				 b.srno ) AS ROW_NUM-- ,   clsrate=max(clsrate)        
                    ,risktype       =max(c.risktype)
              
            INTO   #DPHOLDING_TO_MOVE                   
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                      
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                
                     ON H.NSE_APPROVED = B.CATEGORYNAME                               
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                
                           FROM   #CLIENT_LISTTOADJUST) C                                      
                           on C.PARTY_CODE = H.PARTY_CODE                                                 
                   where NOT EXISTS(SELECT *                                                
                                  FROM   #ILLIQUIED_SCRIPS I                                                
 WHERE  H.ISIN = I.ISIN)                                                
                   AND [SOURCE] = 'DP'                                                
                   AND TOTAL <> 0                                                                   
            GROUP  BY ISIN,                                                
                      SCRIP_CD,                                                
                      H.PARTY_CODE,                                                
                      ACCNO,                    
                      NSE_APPROVED,                                                
                      B.srno                                                
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                  
            ORDER  BY H.PARTY_CODE,                                                
                      ROW_NUM      
    
    /*Added by Vishal Gohil to exclude poor scrip from projected category on 21/07/2016 by Renil and Abha*/                  
	delete from #DPHOLDING_TO_MOVE  where risktype='Projected' and nse_approved='Poor'
	
	
                              
                 /*        
                 /**************************Vishal gohil**************************************************************/        
   /****************************************************************************************/             
                 select x.* INTO   #DPHOLDING_TO_MOVE          
                 from                  
            (SELECT ISIN,                                                
                   SCRIP_CD,                              
                   H.PARTY_CODE,                                                
                   QTY=Sum(QTY),                                                
                   ACCNO,                                                
                   TOTAL=Sum(TOTAL),                                                
    NSE_APPROVED,                          
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,               
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)        
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)        
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))        
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                           
     b.srno ) AS ROW_NUM,   clsrate=max(clsrate)                                           
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                     
                     ON H.NSE_APPROVED = B.CATEGORYNAME                               
--             K47437        
--K48042        
          inner join (SELECT PARTY_CODE,ADJ_VALUE                                                
                           FROM   #CLIENT_LISTTOADJUST) C                             
                           on C.PARTY_CODE = H.PARTY_CODE                                                 
                   where NOT EXISTS(SELECT *                                                
                                  FROM   #ILLIQUIED_SCRIPS I                                                
                                  WHERE  H.ISIN = I.ISIN)                                                
                   AND [SOURCE] = 'DP' and     NSE_APPROVED<>'Poor'                                            
                   AND TOTAL <> 0    -- and h.party_Code='K48042'                                                              
            GROUP  BY ISIN,                                                
                      SCRIP_CD,                                                
                      H.PARTY_CODE,                                                
                      ACCNO,                                                
                      NSE_APPROVED,                    
                      B.srno                                                
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                  
            union            
            SELECT ISIN,                                                
                   SCRIP_CD,                              
                   H.PARTY_CODE,                                                
                   QTY=Sum(QTY),                                                
                   ACCNO,                                                
                   TOTAL=Sum(TOTAL),                         
                   NSE_APPROVED,                          
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,               
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)        
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)        
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))        
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                           
     b.srno ) AS ROW_NUM ,   clsrate=max(clsrate)                        
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                
                     ON H.NSE_APPROVED = B.CATEGORYNAME                               
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                                
                           FROM   #CLIENT_LISTTOADJUST) C                                      
                           on C.PARTY_CODE = H.PARTY_CODE                                                 
                   where NOT EXISTS(SELECT *                                           
                                  FROM   #ILLIQUIED_SCRIPS I                                                
                                  WHERE  H.ISIN = I.ISIN)                                                
                   AND [SOURCE] = 'DP' and     NSE_APPROVED='Poor'                                            
                   AND TOTAL <> 0       --and h.party_code='K48042'                                                            
            GROUP  BY ISIN,                                                
                      SCRIP_CD, 
                      H.PARTY_CODE,                                                
                      ACCNO,                                         
                      NSE_APPROVED,                                       
                      B.srno                  
            HAVING CONVERT(INT,Sum(QTY)) <> 0  )x                                
            ORDER  BY x.PARTY_CODE,                                                
                      ROW_NUM                              
                              
              
   update a set  row_num=b.row_num+a.row_num from #DPHOLDING_TO_MOVE a,        
   (select party_Code,row_num=MAX(row_num) from #DPHOLDING_TO_MOVE group by party_Code)b        
   where a.[party_Code]=b.party_Code and  a.nse_approved='Poor'        
           
   /****************************************************************************************/        
   /****************************************************************************************/        
   */        
                              
                              
                                                
            CREATE CLUSTERED INDEX [IX_Row_Num]                                                
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )                 
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                
                                                
            CREATE CLUSTERED INDEX [IX_Party_code]                                                
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                              
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                
                                            
            CREATE CLUSTERED INDEX [IX_Party_code]                                                       ON #FILE2 ( [Party_Code] ASC )                                                
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                
                                                
            DECLARE @PARTY_CNT      AS INT,                                                
                    @PARTY_CTR      AS INT,                                                
                    @SCRIP_CNT      AS INT,                                                
                    @SCRIP_CTR      AS INT,                            
                    @PARTY_CODE     AS VARCHAR(20),                                                
/*Change Id :: 2*/                        
                    --@DPID           AS VARCHAR(20),                                                
                    @FOSHORTAGE     AS MONEY,                                                
                    @ADJUSTMENT_AMT AS MONEY,                                                
                    @ADJUSTED_AMT   AS MONEY,                                                
                    @ADJ_QTY        AS INT,                                                
                    @QTY            AS INT,                                                
                    @VALUE          AS MONEY,                                                
                    @CLOSING_PRICE  AS MONEY,                                                
                  @NET_DEBIT  AS MONEY                                                
                                                
            SET @ADJUSTED_AMT = 0                                                
          SET @PARTY_CTR = 1             
                 
            SELECT @PARTY_CNT = Count(*)                                                
        FROM   #CLIENT_LISTTOADJUST                                                
                                          
            --PRINT @PARTY_CNT                                                    
    WHILE( @PARTY_CTR <= @PARTY_CNT )             
              BEGIN                                                
                  SET @ADJUSTMENT_AMT = 0                                                
                  SET @FOSHORTAGE = 0                                                
                  SET @ADJUSTED_AMT = 0                 
                                              
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                                
                                                    
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                                
                         @FOSHORTAGE = FOSHRT,                             
                         @NET_DEBIT = NET_DEBIT                                                
                  FROM   #CLIENT_LISTTOADJUST                                                
                  WHERE  ROW_NUM = @PARTY_CTR                    
                                                
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                                
                                                
                  SET @SCRIP_CTR = 1                                                
                                                
                  SELECT @SCRIP_CNT = Count(*)                                      
                  FROM   #DPHOLDING_TO_MOVE                                                
                  WHERE  PARTY_CODE = @PARTY_CODE                        
              
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                                
                    BEGIN                                                
                        SELECT @QTY = QTY,                                                
                  @VALUE = TOTAL,                                                
                               @CLOSING_PRICE = TOTAL / QTY                                                
                        FROM   #DPHOLDING_TO_MOVE                                                
                        WHERE  ROW_NUM = @SCRIP_CTR                                                
                               AND PARTY_CODE = @PARTY_CODE                                                
                                                
                        IF @ADJUSTMENT_AMT >= @VALUE                                        
                          BEGIN                                                
                              SET @ADJ_QTY = @QTY                                                
                                                
                 INSERT INTO #FILE2                                                
                                          (ISIN,                                                
                                           SCRIP_CD,                                                
                                           PARTY_CODE,                                                
                                           QTY,                                                
                                           ACCNO,                                                
                                           TOTAL,                                                
                                         NSE_APPROVED,                                                
                              NET_DEBIT,                     
 QTY_ADJ,                                                
                     FO_APPROVED)                                                
SELECT ISIN,                                                
                                     SCRIP_CD,                                                
  PARTY_CODE,                                                
 QTY,                                                
                                     ACCNO,                                                
                                     TOTAL,                                                
                                     NSE_APPROVED,                                                
                                     @NET_DEBIT,                                                
                                     @ADJ_QTY,                                                
                          CASE                                                
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                
                                ELSE 'N'                                                
                              END                                      
                              FROM   #DPHOLDING_TO_MOVE                                                
 WHERE  ROW_NUM = @SCRIP_CTR                                                
                                     AND PARTY_CODE = @PARTY_CODE                                                
                                                
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                                
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                                
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                                
                          END                                                
                        ELSE                                     
                          BEGIN                                                
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                                
                                                
                              INSERT INTO #FILE2                                                
                              (ISIN,                                                
                                           SCRIP_CD,                            
                                           PARTY_CODE,                                                
                                           QTY,                                                
                                           ACCNO,                                                
                                           TOTAL,                                                
                                           NSE_APPROVED,                                                
                                           NET_DEBIT,                                      
                                           QTY_ADJ,                                                
                                           FO_APPROVED)                                                
                              SELECT ISIN,                                                
                                     SCRIP_CD,                                                
                                     Ltrim(Rtrim(PARTY_CODE)),                                                
      QTY,                                                
                                     ACCNO, 
                                     TOTAL,                                           
                                     NSE_APPROVED,                         
                                     @NET_DEBIT,                                
                                     @ADJ_QTY,                                                
                                     CASE                               
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                 
                                       ELSE 'N'                                                
                                     END                                                
                              FROM   #DPHOLDING_TO_MOVE                                                
                              WHERE  ROW_NUM = @SCRIP_CTR                                                
                                     AND PARTY_CODE = @PARTY_CODE                                                
                                                
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                                
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                                
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                      
                                                
                              BREAK                                                
                          END                                         
                                                
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                                
                    END                                                
                                   
                  UPDATE #FILE2                                       
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                                
                         TOTAL_ADJ = @ADJUSTED_AMT                                                
                  WHERE  PARTY_CODE = @PARTY_CODE                                                
                         
                  SET @PARTY_CTR = @PARTY_CTR + 1                            
              END                                                
                                                
                          
            UPDATE #FILE2                                                
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                                
                          
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                                
            FROM   #FILE1 B                                                
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                                
                                      
                                      
            UPDATE #FILE2                          
                SET FO_APPROVED = 'N'                          
            WHERE UPPER(NSE_APPROVED) = 'POOR'              
                    
                     
              UPDATE #FILE2 SET cls_rate=A.clsrate from        
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B        
              GROUP  BY B.ISIN,                                                
                      B.SCRIP_CD,                                                
                      B.PARTY_CODE,   
                      B.ACCNO, B.clsrate,                                               
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED        
            
 
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate        
                      
                      
           /*select * from #FILE2 x inner join #cli y on x.party_code=y.party_code*/
                          
            DECLARE @DT AS DATETIME                                                
                                                
            SET @DT=Getdate()                                                
                                          
            
         
   INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                                
            SELECT DISTINCT *           
            FROM   VMSS_PURERISK_DPHOLDING                                                
                                                
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                        
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                                
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                
                                       
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)             
            
            /*
              DECLARE @DT AS DATETIME                                                
                                                
            SET @DT=Getdate() 
            */                                               
                                            
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                                
                                                
            INSERT INTO VMSS_PURERISK_DPHOLDING                                               
            SELECT DISTINCT x.*,                                                
                   @DT AS PROCESS_DATE,'','','',y.risktype                                                
            FROM   #FILE2 x  inner join #cli y on x.party_code=y.party_code                                             
            WHERE  x.QTY_ADJ > 0                                                
             
			 
			--TRUNCATE TABLE general.dbo.tmp_VMSS_PURERISK_DPHOLDING                                                
                                                
            --INSERT INTO general.dbo.tmp_VMSS_PURERISK_DPHOLDING                                                 
            --SELECT DISTINCT x.*,                                                
            --       @DT AS PROCESS_DATE,'' FromAcc ,'' ToAcc,'' ToSegment,y.risktype                                                
            --FROM   #FILE2 x  inner join #cli y on x.party_code=y.party_code                                             
            --WHERE  x.QTY_ADJ > 0    
			
			                                
            /*use general                                                                  
            alter table POA_DP_Adj_Ben add FOShrt money                                                                  
            use history                                                                  
            alter table POA_DP_Adj_Ben add FOShrt money                                                                  
            */                                                
                          
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                                
            SELECT DISTINCT *                                         
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                                
                                                
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                                
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                         
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                
                        
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                        
                                                
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN          
            SELECT DISTINCT PARTY_CODE,                                                
                   NET_DEBIT,                                                
                   ANGEL_BEN,  
        @DT AS PROCESS_DATE,                                                
                   NON_CASH,                 
                   FOSHRT               
            FROM   #FILE1                                                
                                          
          exec Pure_Risk_DP_Adj_file_mail                              
  /* --SMS Part
         SELECT A.party_code,A.AdjAmt ,                                        
                   B.MOBILE_PAGER                                          
            INTO   #SEND1                                          
            FROM       
            (select Party_code,AdjAmt=sum(Total_Adj_Value) from VMSS_PURERISK_DPHOLDING where ToSegment is not null group by Party_code) A     
            LEFT OUTER JOIN general.dbo.CLIENT_DETAILS B WITH (NOLOCK)                                          
            ON A.PARTY_CODE = B.PARTY_CODE where B.Mobile_pager is not null    
                             
                 
                    INSERT INTO INTRANET.SMS.DBO.SMS                                          
                    SELECT party_code,MOBILE_PAGER,                                          
        
                    'Dear client,Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 1860 500 5006.',                                        







                     CONVERT(VARCHAR(11), Getdate(), 103),                                          
                     Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                          
                     'P',                                          
                     RIGHT(Getdate(), 2),                                          
                     'New POA Debit Client'                                          
                     FROM   #SEND1    
                     
                      
                    INSERT INTO INTRANET.SMS.DBO.SMS                                          
                    SELECT top 1  party_code,'9820701602',                                          
        
                    'Dear client,Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 1860 500 5006.',                                        
                     CONVERT(VARCHAR(11), Getdate(), 103),                                          
                     Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                          
                     'P',                                          
                     RIGHT(Getdate(), 2),                                          
                     'New POA Debit Client'                                          
                     FROM   #SEND1    
                     
                    INSERT INTO INTRANET.SMS.DBO.SMS                                          
                    SELECT top 1  party_code,'9820731985',                                          
                    'Dear client,Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 1860 500 5006.',                                        
                     CONVERT(VARCHAR(11), Getdate(), 103),                                          
                     Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                          
   'P',                                          
                     RIGHT(Getdate(), 2),                               
                     'New POA Debit Client'                                          
         FROM   #SEND1     
                     
                INSERT INTO INTRANET.SMS.DBO.SMS                                          
                    SELECT top 1  party_code,'9819090240',                                          
                    'Dear client,Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 1860 500 5006.',                                        





                     CONVERT(VARCHAR(11), Getdate(), 103),                                          
                     Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                          
                     'P',                                          
                     RIGHT(Getdate(), 2),                                          
                     'New POA Debit Client'                                          
                     FROM   #SEND1   
                      */
              END              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_new_Bkp14Jan2019
-- --------------------------------------------------
       
/*              
CREATED BY :: RENIL PILLAI              
CREATED ON :: MAY 04 2016              
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS              
*/             
          
CREATE PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_new_Bkp14Jan2019]              
AS              
SET NOCOUNT ON              
BEGIN              
          
              
--Declare @tdate as datetime = (select MAX(holddate) from VMSS_JVDP_file with (nolock))                          
/*        
declare @startdate datetime,@enddate datetime        
        
set @startdate=(Select TOP 1 sauda_date         
    from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC)         
    a ORDER BY sauda_date ASC )        
        
set @enddate=Convert(varchar(11),(Select TOP 1 sauda_date         
    from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC)         
    a ORDER BY sauda_date ASC ),121)+' 23:59:59'        
            
        
        
select * into #TBL_RMS_COLLECTION_CLI_ABL_HIST from         
TBL_RMS_COLLECTION_CLI_ABL_HIST with (nolock) where rms_date between @startdate and @enddate        
*/        
        
        
--/*Added to consider clients who have not traded in last 5 days */        
--select party_code,lastbilldate=max(lastbilldate) into #lastbilldate from         
--GENERAL.DBO.RMS_DtclFi with (nolock) where co_code in ('BSECM','NSECM','NSEFO','MCD','NSX')         
--group by party_code        
         
--  select * into #traded5days from #lastbilldate where lastbilldate >        
-- (Select TOP 1 sauda_date         
--from (SELECT DISTINCT TOP 5 sauda_date from mis.remisior.dbo.comb_cli with (nolock) ORDER BY sauda_date DESC)         
--a ORDER BY sauda_date ASC         
-- )  
 
 select party_code,pure_risk,proj_risk,rms_date=cast(rms_date as date),
 risktype=case when pure_risk<-100 then 'Pure'
 else 'Projected' end
  into #temp_Riskdata from history.dbo.TBL_RMS_COLLECTION_CLI_ABL_HIST with (nolock)  where  
 cast(rms_date as date)>cast((getdate()-5) as date) 
 and (pure_risk<-100 or  proj_risk<-501)
 
 select party_code,risktype=min(risktype) into #final from #temp_Riskdata  group by party_code having count(party_code)>=5
 

 
               
 SELECT A.*
 INTO #CLI              
 FROM (SELECT A.PARTY_CODE,              
 NON_CASH=0.00,              
 NET_DEBIT=(A.Pure_Risk+A.proj_risk),              
 FOSHRT=CONVERT(MONEY, 0) ,  risktype           
 --FROM GENERAL.DBO.TBL_RMS_COLLECTION_cli A WITH (NOLOCK)              
 FROM GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL A WITH (NOLOCK)   inner join #final F on A.party_code=F.party_code           
  LEFT JOIN (SELECT PARTY_CODE,              
 NON_CASH=Sum(FinalAmount)              
 FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)              
 WHERE COLL_TYPE = 'SEC'              
 GROUP BY PARTY_CODE) B              
 ON A.PARTY_CODE = B.PARTY_CODE              
 where (A.Pure_Risk+A.proj_risk)<0 ) A              
 WHERE EXISTS (              
 SELECT B.PARTY_CODE FROM GENERAL.DBO.tbl_NewPoa B WITH (NOLOCK)              
 WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)              
              
 /*AND A.PARTY_CODE='AND2731'*/             
         
         
 /*Added in order to remove projected risk client less than 500 cap instructed by Vishal gohil on 26th may 2016*/        
 delete a from #CLI a, GENERAL.DBO.TBL_RMS_COLLECTION_CLI_ABL b with (nolock) where b.Pure_Risk>=-100       
 and b.proj_risk>-501 and b.party_code=a.party_code        
         
 --/*exclude client who have traded in 5 days*/        
 --delete from #CLI where party_code in (select party_code from #traded5days)        
         
              
              
 UPDATE #CLI              
 SET FOSHRT = CASE              
 WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN              
 ELSE 0              
 END              
 FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)              
 WHERE CO_CODE = 'NSEFO'              
 AND #CLI.PARTY_CODE = B.PARTY_CODE              
 AND IMARGIN <> 0              
              
    /*              
 /*Client not active in NSE segment */              
 --Added for BSE by Renil on Feb 2 2016 as instructed by Vishal Gohil and Anil Wandhre              
 delete B from #CLI B where not exists              
 (select distinct cl_code from anand1.msajag.dbo.client_brok_Details A with (nolock)              
 where a.Exchange in ('BSE','NSE') and a.Segment='CAPITAL'          
 and a.cl_code=b.Party_code)              
    */              
              
             
 DELETE from #CLI where PARTY_CODE IN              
 (SELECT clientcode FROM VMSS_JVDP_file WITH (NOLOCK))              
              
               
      
             SELECT X.PARTY_CODE,                                                
                   NET_DEBIT,                        
         /*Change Id :: 2*/                        
                   --DPID,                                                
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                                
             NON_CASH,                                                
                   BLUECHIP=Isnull(BLUECHIP, 0),                                                
                   GOOD=Isnull(GOOD, 0),                                                
                   AVERAGE=Isnull(AVERAGE, 0),                                                
                   POOR=Isnull(POOR, 0),                                                
                   TOTAL=Isnull(TOTAL, 0),                                    
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                                
                   ADJ_VALUE=NET_DEBIT *-1,                        
                   EXCLUDE_FLAG=' ',                                                
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                                
                   GOOD_ADJ=CONVERT(MONEY, 0),                                                
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                                
                   POOR_ADJ=CONVERT(MONEY, 0),                         
                   FOSHRT,risktype
            INTO   #FILE1                                                
            FROM   #CLI X                                                
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                                
                  ANGEL_BEN=Sum(CASE                                                
                                                           WHEN SOURCE <> 'DP' THEN TOTAL_WithHC                                                
                                                    ELSE 0                                                
                                                         END),                                                
        BLUECHIP=Sum(CASE                                                
                                                          WHEN NSE_APPROVED = 'BLUECHIP'                              
                                                               AND SOURCE = 'DP' THEN TOTAL_WithHC                                                
                    ELSE 0                                                
                                                        END),                                                
                                            GOOD=Sum(CASE                                                
                                                      WHEN NSE_APPROVED = 'GOOD'                                                
                                     AND SOURCE = 'DP' THEN TOTAL_WithHC                                                
                                                      ELSE 0                                                
                                                    END),                                                
                                           AVERAGE=Sum(CASE                                                
                                                         WHEN NSE_APPROVED = 'AVERAGE'                                                
                                                              AND SOURCE = 'DP' THEN TOTAL_WithHC       
                                                         ELSE 0                                                
                                                       END),                                                                                       
                   POOR=Sum(CASE                                                
                                                      WHEN NSE_APPROVED = 'POOR'                                                
                                                           AND SOURCE = 'DP' THEN TOTAL_WithHC                                                
                                                      ELSE 0                                                
                                                    END),                                                
      TOTAL=Sum(TOTAL_WithHC)                                                
                                    FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)                                                
                                    GROUP  BY PARTY_CODE) Y                                                
                     ON X.PARTY_CODE = Y.PARTY_CODE                                                
                                                
                                                  
            DELETE FROM #FILE1                                                
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                                
      FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                                  
                                  WHERE  CL_TYPE = 'NRI'                                                
                                          OR BRANCH_CD = 'NRIS')                                                
    
                        
              
            UPDATE #FILE1                                                
            SET    ADJ_VALUE = 0                                                
            WHERE  ADJ_VALUE < 0                                                
                                                
            CREATE TABLE #FILE2                                                
              (                                                
                 SRNO         INT IDENTITY(1, 1),                                                
                 ISIN         CHAR(12),                                                
                 SCRIP_CD     VARCHAR(10),                                                
                 PARTY_CODE   VARCHAR(10),                                                
                 QTY          INT,                                                
                 ACCNO        VARCHAR(16),                                                
            TOTAL        MONEY,                                                
                 NSE_APPROVED VARCHAR(25),                                                
                 NET_DEBIT    MONEY DEFAULT 0,                                                
                 BEN_ADJUSTED MONEY DEFAULT 0,                                                
                 TOTAL_ADJ    MONEY DEFAULT 0,                                     
                 BALAFTERADJ  MONEY DEFAULT 0,                                                
                 QTY_ADJ      INT,        
                 CLS_rate MONEY,        
                 TOTAL_VALUE_ADJ MONEY,                                                
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                                
                 --FO_SHRT MONEY DEFAULT 0                                                    
              )                                                
                                                
            SELECT A.*,                                      
                   ADJ_VALUE AS TOTAL_ADJ,                                    
				   QTY_ADJ=CONVERT(INT, 0)                                                
            INTO   #FILET                                                
            FROM   (SELECT ISIN,                                                
                           SCRIP_CD,                                               
                           PARTY_CODE,                                
                           QTY=Sum(QTY),                                                
                           ACCNO,                                                
                           TOTAL=Sum(TOTAL),                                                
                           NSE_APPROVED                                                
   FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                                
                    GROUP  BY ISIN,                                                
                              SCRIP_CD,                                                
                              PARTY_CODE,                                                
                              ACCNO,                                                
                              NSE_APPROVED                                  
                    HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                                
           (SELECT PARTY_CODE,                                                
                                          
                           ADJ_VALUE                                                
                    FROM   #FILE1                                                
                                
      WHERE  ADJ_VALUE > 0) B                                                
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                                
                                
                                
            --DROP TABLE #CLIENT_LISTTOADJUST                                                    
            SELECT PARTY_CODE,                                                
                   NET_DEBIT,                                                
                   /*Change Id :: 2*/                        
                   --DPID,                                                
                   ADJ_VALUE,                                                
                   FOSHRT * -1                            AS FOSHRT,                                                
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM,
                   risktype                                                
            INTO   #CLIENT_LISTTOADJUST                                                
            FROM   #FILE1                                                
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                                    
                        
            SELECT top 0 *                                                
            INTO   #ILLIQUIED_SCRIPS                                                
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP      
    
    
                    
                                                
              
              
/*              
              
            SELECT ISIN,                                                
                   SCRIP_CD,                              
                   PARTY_CODE,                                                
                   QTY=Sum(QTY),                                                
                   ACCNO,                                                
                   TOTAL=Sum(TOTAL),                                                
                   NSE_APPROVED,                          
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1,               
                   Sum(TOTAL) DESC) AS ROW_NUM                                                
            INTO   #DPHOLDING_TO_MOVE                  
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                
                     ON H.NSE_APPROVED = B.CATEGORYNAME                 
            WHERE  EXISTS (SELECT PARTY_CODE                                                
                           FROM   #CLIENT_LISTTOADJUST C                                      
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                                
                   AND NOT EXISTS(SELECT *                                                
                                  FROM   #ILLIQUIED_SCRIPS I                                                
                                  WHERE  H.ISIN = I.ISIN)                                                
                   AND [SOURCE] = 'DP'                                                
                   AND TOTAL <> 0                                                                   
            GROUP  BY ISIN,                                                
                      SCRIP_CD,                                                
                      PARTY_CODE,                                                
                      ACCNO,                                                
                      NSE_APPROVED,                                                
                      B.DUMMY1                                                
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                  
            ORDER  BY PARTY_CODE,                                                
                      ROW_NUM                                                
*/              
              
              
            SELECT ISIN,                                                
                   SCRIP_CD,                              
                   H.PARTY_CODE,                                                
                   QTY=Sum(QTY),                                                
                   ACCNO,                                                
                   TOTAL=Sum(TOTAL),                                                
                   NSE_APPROVED,                          
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,               
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)        
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)        
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))        
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                           
				 b.srno ) AS ROW_NUM-- ,   clsrate=max(clsrate)        
                    ,risktype       =max(c.risktype)
                           
            INTO   #DPHOLDING_TO_MOVE                                             
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                
                     ON H.NSE_APPROVED = B.CATEGORYNAME                               
                       inner join (SELECT PARTY_CODE,ADJ_VALUE,risktype                                                
                           FROM   #CLIENT_LISTTOADJUST) C                                      
                           on C.PARTY_CODE = H.PARTY_CODE                                                 
                   where NOT EXISTS(SELECT *                                                
                                  FROM   #ILLIQUIED_SCRIPS I                                                
 WHERE  H.ISIN = I.ISIN)                                                
                   AND [SOURCE] = 'DP'                                                
                   AND TOTAL <> 0                                                                   
            GROUP  BY ISIN,                                                
                      SCRIP_CD,                                                
                      H.PARTY_CODE,                                                
                      ACCNO,                    
                      NSE_APPROVED,                                                
                      B.srno                                                
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                  
            ORDER  BY H.PARTY_CODE,                                                
                      ROW_NUM      
    
    /*Added by Vishal Gohil to exclude poor scrip from projected category on 21/07/2016 by Renil and Abha*/                  
	delete from #DPHOLDING_TO_MOVE  where risktype='Projected' and nse_approved='Poor'
	
	
                              
                 /*        
                 /**************************Vishal gohil**************************************************************/        
   /****************************************************************************************/             
                 select x.* INTO   #DPHOLDING_TO_MOVE          
                 from                  
            (SELECT ISIN,                                                
                   SCRIP_CD,                              
                   H.PARTY_CODE,                                                
                   QTY=Sum(QTY),                                                
                   ACCNO,                                                
                   TOTAL=Sum(TOTAL),                                                
    NSE_APPROVED,                          
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,               
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)        
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)        
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))        
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                           
     b.srno ) AS ROW_NUM,   clsrate=max(clsrate)                                           
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                
                     ON H.NSE_APPROVED = B.CATEGORYNAME                               
--             K47437        
--K48042        
          inner join (SELECT PARTY_CODE,ADJ_VALUE                                                
                           FROM   #CLIENT_LISTTOADJUST) C                                      
                           on C.PARTY_CODE = H.PARTY_CODE                                                 
                   where NOT EXISTS(SELECT *                                                
                                  FROM   #ILLIQUIED_SCRIPS I                                                
                                  WHERE  H.ISIN = I.ISIN)                                                
                   AND [SOURCE] = 'DP' and     NSE_APPROVED<>'Poor'                                            
                   AND TOTAL <> 0    -- and h.party_Code='K48042'                                                              
            GROUP  BY ISIN,                                                
                      SCRIP_CD,                                                
                      H.PARTY_CODE,                                                
                      ACCNO,                                                
                      NSE_APPROVED,                    
                      B.srno                                                
            HAVING CONVERT(INT,Sum(QTY)) <> 0                                  
            union            
            SELECT ISIN,                                                
                   SCRIP_CD,                              
                   H.PARTY_CODE,                                                
                   QTY=Sum(QTY),                                                
                   ACCNO,                                                
                   TOTAL=Sum(TOTAL),                         
                   NSE_APPROVED,                          
                   Row_number() OVER(PARTITION BY H.PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,               
                   case when (Sum(TOTAL)-max(ADJ_VALUE))<0 then 999999999+((Sum(TOTAL)-max(ADJ_VALUE))*-1)        
                   when (max(ADJ_VALUE)-max(clsrate))<0 then 999999999+((Sum(TOTAL)-max(clsrate))*-1)        
                   when (max(ADJ_VALUE)-max(clsrate))>=0 then (max(ADJ_VALUE)-max(clsrate))        
                    else (Sum(TOTAL)-max(ADJ_VALUE))end asc,                           
     b.srno ) AS ROW_NUM ,   clsrate=max(clsrate)                        
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                                
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                                
                     ON H.NSE_APPROVED = B.CATEGORYNAME                               
                       inner join (SELECT PARTY_CODE,ADJ_VALUE                                                
                           FROM   #CLIENT_LISTTOADJUST) C                                      
                           on C.PARTY_CODE = H.PARTY_CODE                                                 
                   where NOT EXISTS(SELECT *                                           
                                  FROM   #ILLIQUIED_SCRIPS I                                                
                                  WHERE  H.ISIN = I.ISIN)                                                
                   AND [SOURCE] = 'DP' and     NSE_APPROVED='Poor'                                            
                   AND TOTAL <> 0       --and h.party_code='K48042'                                                            
            GROUP  BY ISIN,                                                
                      SCRIP_CD, 
                      H.PARTY_CODE,                                                
                      ACCNO,                                                
                      NSE_APPROVED,                                                
                      B.srno                                                
            HAVING CONVERT(INT,Sum(QTY)) <> 0  )x                                
            ORDER  BY x.PARTY_CODE,                                                
                      ROW_NUM                              
                              
              
   update a set  row_num=b.row_num+a.row_num from #DPHOLDING_TO_MOVE a,        
   (select party_Code,row_num=MAX(row_num) from #DPHOLDING_TO_MOVE group by party_Code)b        
   where a.[party_Code]=b.party_Code and  a.nse_approved='Poor'        
           
   /****************************************************************************************/        
   /****************************************************************************************/        
   */        
                              
                              
                                                
            CREATE CLUSTERED INDEX [IX_Row_Num]                                                
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )                 
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                
                                                
            CREATE CLUSTERED INDEX [IX_Party_code]                                                
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                              
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                
                                            
            CREATE CLUSTERED INDEX [IX_Party_code]                                                       ON #FILE2 ( [Party_Code] ASC )                                                
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                                
                                                
            DECLARE @PARTY_CNT      AS INT,                                                
                    @PARTY_CTR      AS INT,                                                
                    @SCRIP_CNT      AS INT,                                                
                    @SCRIP_CTR      AS INT,                            
                    @PARTY_CODE     AS VARCHAR(20),                                                
/*Change Id :: 2*/                        
                    --@DPID           AS VARCHAR(20),                                                
                    @FOSHORTAGE     AS MONEY,                                                
                    @ADJUSTMENT_AMT AS MONEY,                                                
                    @ADJUSTED_AMT   AS MONEY,                                                
                    @ADJ_QTY        AS INT,                                                
                    @QTY            AS INT,                                                
                    @VALUE          AS MONEY,                                                
                    @CLOSING_PRICE  AS MONEY,                                                
                  @NET_DEBIT  AS MONEY                                                
                                                
            SET @ADJUSTED_AMT = 0                                                
          SET @PARTY_CTR = 1             
                                                
            SELECT @PARTY_CNT = Count(*)                                                
            FROM   #CLIENT_LISTTOADJUST                                                
                                                
            --PRINT @PARTY_CNT                                                    
            WHILE( @PARTY_CTR <= @PARTY_CNT )                                       
              BEGIN                                                
                  SET @ADJUSTMENT_AMT = 0                                                
                  SET @FOSHORTAGE = 0                                                
                  SET @ADJUSTED_AMT = 0                 
                                              
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                                
                                                    
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                                
                         @FOSHORTAGE = FOSHRT,                             
                         @NET_DEBIT = NET_DEBIT                                                
                  FROM   #CLIENT_LISTTOADJUST                                                
                  WHERE  ROW_NUM = @PARTY_CTR                    
                                                
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                                
                                                
                  SET @SCRIP_CTR = 1                                                
                                                
                  SELECT @SCRIP_CNT = Count(*)                                      
                  FROM   #DPHOLDING_TO_MOVE                                                
                  WHERE  PARTY_CODE = @PARTY_CODE                        
              
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                                
                    BEGIN                                                
                        SELECT @QTY = QTY,                                                
                  @VALUE = TOTAL,                                                
                               @CLOSING_PRICE = TOTAL / QTY                                                
                        FROM   #DPHOLDING_TO_MOVE                                                
                        WHERE  ROW_NUM = @SCRIP_CTR                                                
                               AND PARTY_CODE = @PARTY_CODE                                                
                                                
                        IF @ADJUSTMENT_AMT >= @VALUE                                        
                          BEGIN                                                
                              SET @ADJ_QTY = @QTY                                                
                                                
                 INSERT INTO #FILE2                                                
                                          (ISIN,                                                
                                           SCRIP_CD,                                                
                                           PARTY_CODE,                                                
                                           QTY,                                                
                                           ACCNO,                                                
                                           TOTAL,                                                
                                         NSE_APPROVED,                                                
                              NET_DEBIT,                                                
 QTY_ADJ,                                                
                                           FO_APPROVED)                                                
                              SELECT ISIN,                                                
                                     SCRIP_CD,                                                
                                     PARTY_CODE,                                                
                                     QTY,                                                
                                     ACCNO,                                                
                                     TOTAL,                                                
                                     NSE_APPROVED,                                                
                                     @NET_DEBIT,                                                
                                     @ADJ_QTY,                                                
                          CASE                                                
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                
                                ELSE 'N'                                                
                              END                                      
                              FROM   #DPHOLDING_TO_MOVE                                                
 WHERE  ROW_NUM = @SCRIP_CTR                                                
                                     AND PARTY_CODE = @PARTY_CODE                                                
                                                
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                                
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                                
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                                
                          END                                                
                        ELSE                                     
                          BEGIN                                                
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                                
                                                
                              INSERT INTO #FILE2                                                
                              (ISIN,                                                
                                           SCRIP_CD,                            
                                           PARTY_CODE,                                                
                                           QTY,                                                
                                           ACCNO,                                                
                                           TOTAL,                                                
                                           NSE_APPROVED,                                                
                                           NET_DEBIT,                                      
                                           QTY_ADJ,                                                
                                           FO_APPROVED)                                                
                              SELECT ISIN,                                                
                                     SCRIP_CD,                                                
                                     Ltrim(Rtrim(PARTY_CODE)),                                                
      QTY,                                                
                                     ACCNO,                                                
                                     TOTAL,                                                
                                     NSE_APPROVED,                                                
                                     @NET_DEBIT,                                
                                     @ADJ_QTY,                                                
                                     CASE                                                
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                                
                                       ELSE 'N'                                                
                                     END                                                
                              FROM   #DPHOLDING_TO_MOVE                                                
                              WHERE  ROW_NUM = @SCRIP_CTR                                                
                                     AND PARTY_CODE = @PARTY_CODE                                                
                                                
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                                
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                                
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                      
                                                
                              BREAK                                                
                          END                                         
                                                
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                                
                    END                                                
                                   
                  UPDATE #FILE2                                       
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                                
                         TOTAL_ADJ = @ADJUSTED_AMT                                                
                  WHERE  PARTY_CODE = @PARTY_CODE                                                
                         
                  SET @PARTY_CTR = @PARTY_CTR + 1                            
              END                                                
                                                
                          
            UPDATE #FILE2                                                
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                                
                          
            BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                                
            FROM   #FILE1 B                                                
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                                
                                      
                                      
            UPDATE #FILE2                          
                SET FO_APPROVED = 'N'                          
            WHERE UPPER(NSE_APPROVED) = 'POOR'              
                    
                     
              UPDATE #FILE2 SET cls_rate=A.clsrate from        
             (select party_code,clsrate,isin,NSE_APPROVED from general.dbo.rms_holding B        
              GROUP  BY B.ISIN,                                                
                      B.SCRIP_CD,                                                
                      B.PARTY_CODE,   
                      B.ACCNO, B.clsrate,                                               
                      B.NSE_APPROVED)  A where  #FILE2.isin=A.isin and #FILE2.NSE_APPROVED=A.NSE_APPROVED        
                           
          
              UPDATE #FILE2 SET TOTAL_VALUE_ADJ=QTY_ADJ * CLS_rate        
                      
                      
           /*select * from #FILE2 x inner join #cli y on x.party_code=y.party_code*/
                          
            DECLARE @DT AS DATETIME                                                
                                                
            SET @DT=Getdate()                                                
                                          
            
                 
   INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                                
            SELECT DISTINCT *           
            FROM   VMSS_PURERISK_DPHOLDING                                                
                                                
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                        
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                                
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                
                                       
            Delete from #FILE2 where party_code in (select party_code from general.dbo.LEGALBLKCLIENTS)             
            
            /*
              DECLARE @DT AS DATETIME                                                
                                                
            SET @DT=Getdate() 
            */                                               
                                            
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                                
                                                
            INSERT INTO VMSS_PURERISK_DPHOLDING                                               
            SELECT DISTINCT x.*,                                                
                   @DT AS PROCESS_DATE,'','','',y.risktype                                                
            FROM   #FILE2 x  inner join #cli y on x.party_code=y.party_code                                             
            WHERE  x.QTY_ADJ > 0                                                
                                             
            /*use general                                                                  
            alter table POA_DP_Adj_Ben add FOShrt money                                                                  
            use history                                                                  
            alter table POA_DP_Adj_Ben add FOShrt money                                                                  
            */                                                
                          
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                                
            SELECT DISTINCT *                                         
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                                
                                                
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                                
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                         
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                                
                        
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN                        
                                                
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                  
            SELECT DISTINCT PARTY_CODE,                                                
                   NET_DEBIT,                                                
                   ANGEL_BEN,                                                
                   @DT AS PROCESS_DATE,                                                
                   NON_CASH,                                                
                   FOSHRT               
            FROM   #FILE1                                                
                                          
           exec Pure_Risk_DP_Adj_file_mail                              
  /* --SMS Part
         SELECT A.party_code,A.AdjAmt ,                                        
                   B.MOBILE_PAGER                                          
            INTO   #SEND1                                          
            FROM       
            (select Party_code,AdjAmt=sum(Total_Adj_Value) from VMSS_PURERISK_DPHOLDING where ToSegment is not null group by Party_code) A     
            LEFT OUTER JOIN general.dbo.CLIENT_DETAILS B WITH (NOLOCK)                                          
            ON A.PARTY_CODE = B.PARTY_CODE where B.Mobile_pager is not null    
                             
                 
                    INSERT INTO INTRANET.SMS.DBO.SMS                                          
                    SELECT party_code,MOBILE_PAGER,                                          
        
                    'Dear client,Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 1860 500 5006.',                                        


                     CONVERT(VARCHAR(11), Getdate(), 103),                                          
                     Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                          
                     'P',                                          
                     RIGHT(Getdate(), 2),                                          
                     'New POA Debit Client'                                          
                     FROM   #SEND1    
                     
                      
                    INSERT INTO INTRANET.SMS.DBO.SMS                                          
                    SELECT top 1  party_code,'9820701602',                                          
        
                    'Dear client,Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 1860 500 5006.',                                        
                     CONVERT(VARCHAR(11), Getdate(), 103),                                          
                     Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                          
                     'P',                                          
                     RIGHT(Getdate(), 2),                                          
                     'New POA Debit Client'                                          
                     FROM   #SEND1    
                     
                    INSERT INTO INTRANET.SMS.DBO.SMS                                          
                    SELECT top 1  party_code,'9820731985',                                          
                    'Dear client,Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 1860 500 5006.',                                        
                     CONVERT(VARCHAR(11), Getdate(), 103),                                          
                     Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                          
   'P',                                          
                     RIGHT(Getdate(), 2),                                          
                     'New POA Debit Client'                                          
                     FROM   #SEND1     
                     
                    INSERT INTO INTRANET.SMS.DBO.SMS                                          
                    SELECT top 1  party_code,'9819090240',                                          
                    'Dear client,Shares worth Rs.' + CONVERT(VARCHAR, CONVERT(INT, AdjAmt)) + ' are trf from your DP A/c to broker margin A/c against net debit in your trading a/c.For queries call 1860 500 5006.',                                        
                     CONVERT(VARCHAR(11), Getdate(), 103),                                          
                     Substring(CONVERT(VARCHAR(25), Getdate()), 13, 5),                                          
                     'P',                                          
                     RIGHT(Getdate(), 2),                                          
                     'New POA Debit Client'                                          
                     FROM   #SEND1   
                      */
              END              
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_PURERISK_DPSHAREFETCHING_renil_04052016
-- --------------------------------------------------
/*
CREATED BY :: RENIL PILLAI
CREATED ON :: MAY 04 2016
DESCRIPTION :: TO FETCH SHARES OF PURE RISK CLIENTS IN VMSS PROCESS
*/
create PROCEDURE [dbo].[VMSS_PURERISK_DPSHAREFETCHING_renil_04052016]
AS
SET NOCOUNT ON
BEGIN

Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))            

	SELECT A.*
	INTO #CLI
	FROM (SELECT A.PARTY_CODE,
	NON_CASH=Isnull(NON_CASH, 0),
	NET_DEBIT=PureRisk,
	FOSHRT=CONVERT(MONEY, 0)
	FROM GENERAL.DBO.RMS_DTCLFI_SUMM_ABL A WITH (NOLOCK)

	LEFT JOIN (SELECT PARTY_CODE,
	NON_CASH=Sum(FinalAmount)
	FROM GENERAL.DBO.CLIENT_COLLATERALS WITH (NOLOCK)
	WHERE COLL_TYPE = 'SEC'
	GROUP BY PARTY_CODE) B
	ON A.PARTY_CODE = B.PARTY_CODE
	where PureRisk<0 ) A
	WHERE EXISTS (
	SELECT B.PARTY_CODE FROM INTRANET.RISK.DBO.NEWPOA_CLIENT_ALL B WITH (NOLOCK)
	WHERE A.PARTY_CODE = B.PARTY_CODE/*B.CLIENT_CODE*/)

	/*AND A.PARTY_CODE='AND2731'*/



	UPDATE #CLI
	SET FOSHRT = CASE
	WHEN LEDGER + NONCASH_COLLETERAL - IMARGIN < 0 THEN LEDGER + NONCASH_COLLETERAL - IMARGIN
	ELSE 0
	END
	FROM GENERAL.DBO.RMS_DTCLFI B  WITH (NOLOCK)
	WHERE CO_CODE = 'NSEFO'
	AND #CLI.PARTY_CODE = B.PARTY_CODE
	AND IMARGIN <> 0


	/*Client not active in NSE segment */
	--Added for BSE by Renil on Feb 2 2016 as instructed by Vishal Gohil and Anil Wandhre
	delete B from #CLI B where not exists
	(select distinct cl_code from anand1.msajag.dbo.client_brok_Details A with (nolock)
	where a.Exchange in ('BSE','NSE') and a.Segment='CAPITAL'
	and a.cl_code=b.Party_code)




	DELETE from #CLI where PARTY_CODE IN
	(SELECT PARTY_CODE FROM SQUAREOFF.DBO.vmss_data WITH (NOLOCK) WHERE processdate=@tdate )

	
	
	
	            SELECT X.PARTY_CODE,                                  
                   NET_DEBIT,          
                   /*Change Id :: 2*/          
                   --DPID,                                  
                   ANGEL_BEN=Isnull(ANGEL_BEN, 0),                                  
                   NON_CASH,                                  
                   BLUECHIP=Isnull(BLUECHIP, 0),                                  
                   GOOD=Isnull(GOOD, 0),                                  
                   AVERAGE=Isnull(AVERAGE, 0),                                  
                   POOR=Isnull(POOR, 0),                                  
                   TOTAL=Isnull(TOTAL, 0),                      
                   /* ADJ_VALUE=NET_DEBIT * -2,*/                                  
					ADJ_VALUE=NET_DEBIT *-1,          
                   EXCLUDE_FLAG=' ',                                  
                   BLUECHIP_ADJ=CONVERT(MONEY, 0),                                  
                   GOOD_ADJ=CONVERT(MONEY, 0),                                  
                   AVERAGE_ADJ=CONVERT(MONEY, 0),                                  
                   POOR_ADJ=CONVERT(MONEY, 0),           
                   FOSHRT                                  
            INTO   #FILE1                                  
            FROM   #CLI X                                  
                   LEFT OUTER JOIN (SELECT PARTY_CODE,                                  
              ANGEL_BEN=Sum(CASE                                  
                                                           WHEN SOURCE <> 'DP' THEN TOTAL_WithHC                                  
                                                    ELSE 0                                  
                                                         END),                                  
                                           BLUECHIP=Sum(CASE                                  
                                                          WHEN NSE_APPROVED = 'BLUECHIP'                                  
                                                               AND SOURCE = 'DP' THEN TOTAL_WithHC                                  
                                                          ELSE 0                                  
                                                        END),                                  
                                            GOOD=Sum(CASE                                  
                                                      WHEN NSE_APPROVED = 'GOOD'                                  
                                                           AND SOURCE = 'DP' THEN TOTAL_WithHC                                  
                                                      ELSE 0                                  
                                                    END),                                  
                                           AVERAGE=Sum(CASE                                  
                                                         WHEN NSE_APPROVED = 'AVERAGE'                                  
                                                              AND SOURCE = 'DP' THEN TOTAL_WithHC                          
                                                         ELSE 0                                  
                                                       END),                                                                         
                                           POOR=Sum(CASE                                  
                                                      WHEN NSE_APPROVED = 'POOR'                                  
                                                           AND SOURCE = 'DP' THEN TOTAL_WithHC                                  
                                                      ELSE 0                                  
                                                    END),                                  
                                  TOTAL=Sum(TOTAL_WithHC)                                  
                                    FROM   GENERAL.DBO.Vw_Rms_Holding_WithPOA WITH (NOLOCK)                                  
                                    GROUP  BY PARTY_CODE) Y                                  
                     ON X.PARTY_CODE = Y.PARTY_CODE                                  
                                  
                                    
            DELETE FROM #FILE1                                  
            WHERE  PARTY_CODE IN (SELECT PARTY_CODE                                  
      FROM   GENERAL.DBO.CLIENT_DETAILS WITH(NOLOCK)                    
                                  WHERE  CL_TYPE = 'NRI'                                  
                                          OR BRANCH_CD = 'NRIS')                                  
          

            UPDATE #FILE1                                  
            SET    ADJ_VALUE = 0                                  
            WHERE  ADJ_VALUE < 0                                  
                                  
            CREATE TABLE #FILE2                                  
              (                                  
                 SRNO         INT IDENTITY(1, 1),                                  
                 ISIN         CHAR(12),                                  
     SCRIP_CD     VARCHAR(10),                                  
                 PARTY_CODE   VARCHAR(10),                                  
                 QTY          INT,                                  
                 ACCNO        VARCHAR(16),                                  
                 TOTAL        MONEY,                                  
                 NSE_APPROVED VARCHAR(25),                                  
                 NET_DEBIT    MONEY DEFAULT 0,                                  
                 BEN_ADJUSTED MONEY DEFAULT 0,                                  
                 TOTAL_ADJ    MONEY DEFAULT 0,                                  
                 BALAFTERADJ  MONEY DEFAULT 0,                                  
                 QTY_ADJ      INT,                                  
                 FO_APPROVED  VARCHAR(1) DEFAULT 'N'                                  
                 --FO_SHRT MONEY DEFAULT 0                                      
              )                                  
                                  
            SELECT A.*,                        
                   ADJ_VALUE AS TOTAL_ADJ,                      
                   QTY_ADJ=CONVERT(INT, 0)                                  
            INTO   #FILET                                  
            FROM   (SELECT ISIN,                                  
                           SCRIP_CD,                                 
                           PARTY_CODE,                                  
                           QTY=Sum(QTY),                                  
                           ACCNO,                                  
                           TOTAL=Sum(TOTAL),                                  
                           NSE_APPROVED                                  
                    FROM   GENERAL.DBO.RMS_HOLDING WITH (NOLOCK)                                  
                    GROUP  BY ISIN,                                  
                              SCRIP_CD,                                  
                              PARTY_CODE,                                  
                              ACCNO,                                  
                              NSE_APPROVED                    
                    HAVING CONVERT(INT,Sum(QTY)) <> 0) A,                                  
           (SELECT PARTY_CODE,                                  
                            
                           ADJ_VALUE                                  
                    FROM   #FILE1                                  
                  
      WHERE  ADJ_VALUE > 0) B                                  
            WHERE  A.PARTY_CODE = B.PARTY_CODE                                  
                  
            --DROP TABLE #CLIENT_LISTTOADJUST                                      
            SELECT PARTY_CODE,                                  
                   NET_DEBIT,                                  
                   /*Change Id :: 2*/          
                   --DPID,                                  
                   ADJ_VALUE,                                  
                   FOSHRT * -1                            AS FOSHRT,                                  
                   Row_number() OVER(ORDER BY PARTY_CODE) AS ROW_NUM                                  
            INTO   #CLIENT_LISTTOADJUST                                  
            FROM   #FILE1                                  
            WHERE  ADJ_VALUE > 0 --AND FOSHRT <> 0                                      
          
            SELECT top 0 *                                  
            INTO   #ILLIQUIED_SCRIPS                                  
    FROM   GENERAL.DBO.VW_BLK_RESTRICT_SCRIP                          
                                  




            SELECT ISIN,                                  
                   SCRIP_CD,                
                   PARTY_CODE,                                  
                   QTY=Sum(QTY),                                  
                   ACCNO,                                  
                   TOTAL=Sum(TOTAL),                                  
                   NSE_APPROVED,            
                   Row_number() OVER(PARTITION BY PARTY_CODE ORDER BY CASE WHEN ISIN='INE075A01022' THEN 1 ELSE 0 END,B.DUMMY1, 
                   Sum(TOTAL) DESC) AS ROW_NUM                                  
            INTO   #DPHOLDING_TO_MOVE                                 
            FROM   GENERAL.DBO.RMS_HOLDING H WITH (NOLOCK)                                  
                   INNER JOIN GENERAL.DBO.SCRIPCATEGORY_MASTER B WITH (NOLOCK)                                  
                     ON H.NSE_APPROVED = B.CATEGORYNAME   
            WHERE  EXISTS (SELECT PARTY_CODE                                  
                           FROM   #CLIENT_LISTTOADJUST C                        
                           WHERE  C.PARTY_CODE = H.PARTY_CODE)                                  
                   AND NOT EXISTS(SELECT *                                  
                                  FROM   #ILLIQUIED_SCRIPS I                                  
                                  WHERE  H.ISIN = I.ISIN)                                  
                   AND [SOURCE] = 'DP'                                  
                   AND TOTAL <> 0                                                     
            GROUP  BY ISIN,                                  
                      SCRIP_CD,                                  
                      PARTY_CODE,                                  
                      ACCNO,                                  
                      NSE_APPROVED,                                  
                      B.DUMMY1                                  
            HAVING CONVERT(INT,Sum(QTY)) <> 0                    
            ORDER  BY PARTY_CODE,                                  
                      ROW_NUM                                  

                                  
            CREATE CLUSTERED INDEX [IX_Row_Num]                                  
              ON #CLIENT_LISTTOADJUST ( [Row_Num] ASC )                                  
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                  
                                  
            CREATE CLUSTERED INDEX [IX_Party_code]                                  
              ON #DPHOLDING_TO_MOVE ( [Party_Code] ASC, [Row_Num] ASC )                                
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                  
                              
            CREATE CLUSTERED INDEX [IX_Party_code]                             
              ON #FILE2 ( [Party_Code] ASC )                                  
              WITH (SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, FILLFACTOR=50) ON [PRIMARY]                                  
                                  
            DECLARE @PARTY_CNT      AS INT,                                  
                    @PARTY_CTR      AS INT,                                  
                    @SCRIP_CNT      AS INT,                                  
                    @SCRIP_CTR      AS INT,              
                    @PARTY_CODE     AS VARCHAR(20),                                  
                    /*Change Id :: 2*/          
                    --@DPID           AS VARCHAR(20),                                  
                    @FOSHORTAGE     AS MONEY,                                  
                    @ADJUSTMENT_AMT AS MONEY,                                  
                    @ADJUSTED_AMT   AS MONEY,                                  
                    @ADJ_QTY        AS INT,                                  
                    @QTY            AS INT,                                  
                    @VALUE          AS MONEY,                                  
                    @CLOSING_PRICE  AS MONEY,                                  
                  @NET_DEBIT  AS MONEY                                  
                                  
            SET @ADJUSTED_AMT = 0                                  
          SET @PARTY_CTR = 1                                  
                                  
            SELECT @PARTY_CNT = Count(*)                                  
            FROM   #CLIENT_LISTTOADJUST                                  
                                  
            --PRINT @PARTY_CNT                                      
            WHILE( @PARTY_CTR <= @PARTY_CNT )                         
              BEGIN                                  
                  SET @ADJUSTMENT_AMT = 0                                  
                  SET @FOSHORTAGE = 0                                  
                  SET @ADJUSTED_AMT = 0   
                                  
                  SELECT @PARTY_CODE = Ltrim(Rtrim(PARTY_CODE)),                                  
                                      
                         @ADJUSTMENT_AMT = ADJ_VALUE,                                  
                         @FOSHORTAGE = FOSHRT,               
                         @NET_DEBIT = NET_DEBIT                                  
                  FROM   #CLIENT_LISTTOADJUST                                  
                  WHERE  ROW_NUM = @PARTY_CTR                                  
                                  
                  --PRINT CONVERT(VARCHAR, @PARTY_CTR) + ' :: ' + @PARTY_CODE                                  
                                  
                  SET @SCRIP_CTR = 1                                  
                                  
                  SELECT @SCRIP_CNT = Count(*)                        
                  FROM   #DPHOLDING_TO_MOVE                                  
                  WHERE  PARTY_CODE = @PARTY_CODE          
                                  
                  WHILE( @SCRIP_CTR <= @SCRIP_CNT )                                  
                    BEGIN                                  
                        SELECT @QTY = QTY,                                  
                               @VALUE = TOTAL,                                  
                               @CLOSING_PRICE = TOTAL / QTY                                  
                        FROM   #DPHOLDING_TO_MOVE                                  
                        WHERE  ROW_NUM = @SCRIP_CTR                                  
                               AND PARTY_CODE = @PARTY_CODE                                  
                                  
                        IF @ADJUSTMENT_AMT >= @VALUE                          
                          BEGIN                                  
                              SET @ADJ_QTY = @QTY                                  
                                  
                              INSERT INTO #FILE2                                  
                                          (ISIN,                                  
                                           SCRIP_CD,                                  
                                           PARTY_CODE,                                  
                                           QTY,                                  
                                           ACCNO,                                  
                                           TOTAL,                                  
                                         NSE_APPROVED,                                  
                                           NET_DEBIT,                                  
                                           QTY_ADJ,                                  
                                           FO_APPROVED)                                  
                              SELECT ISIN,                                  
                                     SCRIP_CD,                                  
                                     PARTY_CODE,                                  
                                     QTY,                                  
                                     ACCNO,                                  
                                     TOTAL,                                  
                                     NSE_APPROVED,                                  
									@NET_DEBIT,                                  
                                     @ADJ_QTY,                                  
                          CASE                                  
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                  
                                ELSE 'N'                                  
      END                        
                              FROM   #DPHOLDING_TO_MOVE                                  
                              WHERE  ROW_NUM = @SCRIP_CTR                                  
                                     AND PARTY_CODE = @PARTY_CODE                                  
                                  
                              SET @FOSHORTAGE = @FOSHORTAGE - @VALUE                                  
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - @VALUE                                  
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + @VALUE                                  
                          END                                  
                        ELSE                       
                          BEGIN                                  
                              SET @ADJ_QTY = Ceiling(@ADJUSTMENT_AMT / @CLOSING_PRICE)                                  
                                  
                              INSERT INTO #FILE2                                  
                                          (ISIN,                                  
                                           SCRIP_CD,              
                                           PARTY_CODE,                                  
                                           QTY,                                  
                                           ACCNO,                                  
                                           TOTAL,                                  
                                           NSE_APPROVED,                                  
                                           NET_DEBIT,                                  
                                           QTY_ADJ,                                  
                                           FO_APPROVED)                                  
                              SELECT ISIN,                                  
                                     SCRIP_CD,                                  
									Ltrim(Rtrim(PARTY_CODE)),                                  
                                     QTY,                                  
                                     ACCNO,                                  
                                     TOTAL,                                  
                                     NSE_APPROVED,                                  
                                     @NET_DEBIT,                                  
                                     @ADJ_QTY,                                  
                                     CASE                                  
                                       WHEN @FOSHORTAGE > 0 THEN 'Y'                                  
                                       ELSE 'N'                                  
                                     END                                  
						FROM   #DPHOLDING_TO_MOVE                                  
                              WHERE  ROW_NUM = @SCRIP_CTR                                  
                                     AND PARTY_CODE = @PARTY_CODE                                  
                                  
                              SET @FOSHORTAGE = @FOSHORTAGE - ( @ADJ_QTY * @CLOSING_PRICE )                                  
                              SET @ADJUSTMENT_AMT = @ADJUSTMENT_AMT - ( @ADJ_QTY * @CLOSING_PRICE )                                  
                              SET @ADJUSTED_AMT = @ADJUSTED_AMT + ( @ADJ_QTY * @CLOSING_PRICE )                                  
                                  
                              BREAK                                  
                          END                           
                                  
                        SET @SCRIP_CTR = @SCRIP_CTR + 1                                  
                    END                                  
                     
          UPDATE #FILE2                         
                  SET    BALAFTERADJ = @ADJUSTMENT_AMT,                                  
                         TOTAL_ADJ = @ADJUSTED_AMT                                  
                  WHERE  PARTY_CODE = @PARTY_CODE                                  
                                  
                  SET @PARTY_CTR = @PARTY_CTR + 1                                  
              END                                  
                                  
            
            UPDATE #FILE2                                  
            SET    #FILE2.NET_DEBIT = B.NET_DEBIT,                                  
            
       BEN_ADJUSTED = B.NET_DEBIT  - ADJ_VALUE                                  
            FROM   #FILE1 B                                  
            WHERE  #FILE2.PARTY_CODE = B.PARTY_CODE                                  
                        
                        
            UPDATE #FILE2            
                SET FO_APPROVED = 'N'            
            WHERE UPPER(NSE_APPROVED) = 'POOR' 
            
            
                DECLARE @DT AS DATETIME                                  
                                  
            SET @DT=Getdate()                                  
                            

			
			INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                                  
            SELECT DISTINCT *                                  
            FROM   VMSS_PURERISK_DPHOLDING                                  
                                  
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDING_HIST                          
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                  
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                  
                         
          
          
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDING                                  
                                  
            INSERT INTO VMSS_PURERISK_DPHOLDING                                 
            SELECT DISTINCT *,                                  
                   @DT AS PROCESS_DATE                                  
            FROM   #FILE2                                  
            WHERE  QTY_ADJ > 0                                  
                               
            /*use general                                                    
            alter table POA_DP_Adj_Ben add FOShrt money                                                    
            use history                                                    
            alter table POA_DP_Adj_Ben add FOShrt money                                                    
            */                                  
            
            INSERT INTO HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                  
            SELECT DISTINCT *                           
            FROM   VMSS_PURERISK_DPHOLDINGBEN                                  
                                  
            DELETE FROM HISTORY.DBO.VMSS_PURERISK_DPHOLDINGBEN_HIST                                  
            WHERE  PROCESS_DATE >= CONVERT(VARCHAR(11), @DT)                                  
                   AND PROCESS_DATE <= CONVERT(VARCHAR(11), @DT) + ' 23:59'                                  
          
            TRUNCATE TABLE VMSS_PURERISK_DPHOLDINGBEN          
                                  
            INSERT INTO VMSS_PURERISK_DPHOLDINGBEN                                  
            SELECT DISTINCT PARTY_CODE,                                  
                   NET_DEBIT,                                  
                   ANGEL_BEN,                                  
                   @DT AS PROCESS_DATE,                                  
               NON_CASH,                                  
                   FOSHRT                                  
            FROM   #FILE1                                  
                            
                             
                    


END
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Reco
-- --------------------------------------------------
CREATE procedure [dbo].[VMSS_Reco]                    
as                    
set nocount on                    
                    
 declare @ScripBlock as int=0, @NSEsqfile as int=0,@BSEsqFile as int=0                    
                    
 select @ScripBlock=count(1) from                    
 (                    
  select a.* from                    
  (select * from VMSS_ScripBlock  where segment='BSECM') a full outer join                    
  (select client_code,scrip_cd,series='BSE',Qty from upd_bse_outfile_squp_var_margin_shortage) b                    
  on a.party_code=b.client_code and a.scrip_Cd=b.scrip_Cd                     
  where (b.client_code is null or a.party_code is null)                    
   union all                    
  select a.* from                    
  (select * from VMSS_ScripBlock  where segment='NSECM') a full outer join                    
  (select client_code,Symbol,series,qty from upd_nse_outfile_squp_var_margin_shortage) b                    
  on a.party_code=b.client_code and a.scrip_Cd=b.Symbol  and a.series=b.series                    
  where (b.client_code is null or a.party_code is null)                    
 ) x                     
                    
 select @BSEsqFile=count(1) from                   
 (                    
  select segment,a.party_code,scrip_cd,series,qty from                     
  (                    
  select Tosegment as Segment,party_Code,scrip_cd,series,sum(squareoffqty) as Qty                    
  from vmss_holding where squareoffqty  > 0 and (tosegment ='BSECM' )                    
  group by Tosegment,party_Code,scrip_cd,series                    
  ) a join                     
  (                    
  select party_code from vmss_Data where noofdays >=3 and processdate = (select max(processdate) from vmss_Data )                    
  group by party_code                    
  ) b                    
  on a.party_code=b.party_Code                    
 ) x full outer join                   
  (                  
 select client_code,scrip_cd,qty=sum(qty)                   
 from upd_bse_outfile_squp_var_margin_shortage                  
 group by client_code,scrip_cd                  
) y                  
 on x.party_code=y.client_code and x.scrip_cd=y.scrip_cd and x.qty=y.qty                    
 where   (isnull(x.qty,0)-isnull(y.qty,0)) <> 0                    
                       
 select @NSEsqfile=count(1) from                    
 (                    
  select segment,a.party_code,scrip_cd,series,qty from                     
  (                    
  select Tosegment as Segment,party_Code,scrip_cd,series,sum(squareoffqty) as Qty                    
  from vmss_holding where squareoffqty  > 0 and (tosegment ='NSECM' )                     
  group by Tosegment,party_Code,scrip_cd,series                    
  ) a join                     
  (                    
  select party_code from vmss_Data where noofdays >=3 and processdate = (select max(processdate) from vmss_Data )                    
  group by party_code                    
  ) b                    
  on a.party_code=b.party_Code                    
 ) x full outer join                   
 (                  
 select client_code,symbol,series,qty=sum(qty)                   
 from upd_nse_outfile_squp_var_margin_shortage                  
 group by client_code,symbol,series                  
) y                  
 on x.party_code=y.client_code and x.scrip_cd=y.symbol and x.series=y.series and x.qty=y.qty                    
 where   (isnull(x.qty,0)-isnull(y.qty,0)) <> 0                    
                    
 declare @str as varchar(500)                     
                       
 if (@BSEsqFile>0 OR @ScripBlock >0 OR  @NSEsqfile >0)                    
 Begin                    
                    
                           
  set @str='VMSS (T+4) Mismatches- ScripBlock:'+convert(varchar(10),@ScripBlock)+', BSE Sq.Off file :'+CONVERT(VARCHAR(10),@BSEsqFile)                    
  +', NSE Sq.Off file :'+CONVERT(VARCHAR(10),@NSEsqfile)               
                    
  EXEC MSDB.DBO.SP_SEND_DBMAIL                          
  @RECIPIENTS = 'vishal@angelbroking.com;csorm@angelbroking.com;csosurveillance@angelbroking.com;tushar.jorigal@angelbroking.com;vishal.kanani@angelbroking.com',                          
  @PROFILE_NAME = 'angelbroking',                          
  @BODY_FORMAT ='HTML',                          
  @SUBJECT = 'VMSS (T+3) Mismatches',                          
  @BODY = @str                          
                    
 End             
 else                    
 Begin                    
  set @str='VMSS Process completed successfully'                    
                    
 End                    
                
 create table #MobNo                       
 (                          
 mobno numeric(10,0)                          
 )                          
                           
 insert into #MobNo                          
 select 9867776935                 
 --union all                    
-- select 9820202050 /*Bhavin Parekh*/                          
 union all                          
 select 9820701602 /*VISHAL GOHIL*/                          
 union all                                                   
 select 9820731985 /*VISHAL KANANI*/     
 union all                          
 select 9892312837 /*TUSHAR J*/                          
 union all                          
 select 9860579556 /*SANDEEP NEGI*/    
 union all                          
 select 9819164199 /*NAVNEET SHAH*/    
                    
                    
 insert into intranet.sms.dbo.sms                          
 select a.mobno,@str,convert(varchar(10), getdate(), 103),                          
 ltrim(rtrim(str(datepart(hh, dateadd(minute, 1, getdate()))))) +':' +                          
 ltrim(rtrim(str(datepart(minute, dateadd(minute, 2, getdate()))))),                          
 'P', case when (datepart(hh, dateadd(minute, 1, getdate()))) >= 12                          
 then 'PM' else 'AM' end,'RMS UPDATION'                          
 from #MobNo a                         
                    
                    
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.vmss_Rpt_DPHold_Drill
-- --------------------------------------------------

  -- vmss_Rpt_DPHold_Drill 'H13815','May 05 2016'   
create PROCEDURE [dbo].[vmss_Rpt_DPHold_Drill]              
@client as varchar(10),
@ALERTDATE DATETIME            
--@party_name as varchar(100),              
--@co_Code as varchar(10),              
--@userid as varchar(15),              
--@access_To as varchar(10),              
--@access_Code as varchar(10)              
as              
begin              
set nocount on         

if (cast(@ALERTDATE as date)=cast(getdate() AS DATE))   
begin
 select Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,AdjAmt,FromAcc,ToAcc,ToSegment
 from vmss_dp_holding where party_code=@client and cast(Holddate as date)=cast(@ALERTDATE as date)
end       
else
begin
 select Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Clsrate,VBHC,Category,HairCut,VAHC,SqOffQty,SqOffSeq,AdjAmt,FromAcc,ToAcc,ToSegment
 from vmss_DP_holding_hist where party_code=@client and cast(Holddate as date)=cast(@ALERTDATE as date)
end       
Set nocount off      
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Rpt_Exception_Marking_Data
-- --------------------------------------------------
        

-- VMSS_Rpt_Exception_Marking_Data 'client','D47172','broker','cso'                    

-- VMSS_Rpt_Exception_Marking_Data 'REGION','%','broker','cso'               

CREATE PROCEDURE [dbo].[VMSS_Rpt_Exception_Marking_Data] -- 'region','southguj','all','7','sep 6 2012','broker','cso','%'                        

@ACCESSLEVEL VARCHAR(20),                        

@ACCESSCODE VARCHAR(20),                                          

@ACCESS_TO VARCHAR(20),                        

@ACCESS_CODE VARCHAR(20)                     

                       

AS                        

BEGIN                        

                        

 IF @ACCESSCODE ='ALL'                      

 SET @ACCESSCODE =@ACCESS_CODE                        

                       

                      

 DECLARE @MAIN VARCHAR(MAX)                        

 DECLARE @B_DATE VARCHAR(1000)                        

 SET @B_DATE = ''                        

                        

 SET @MAIN =''                        

                        

 SET @MAIN = @MAIN + ' SELECT REGION, BRANCH, SB, CATEGORY,CLI_TYPE, '                        

 SET @MAIN = @MAIN + ' SB_CATEGORY AS SBCAT,Party_code, '                                           

 SET @MAIN = @MAIN + ' VarMarginShortFall_AftAdj, '                             

 SET @MAIN = @MAIN + ' noofdays ,convert(varchar(11),update_date,103) as update_date,'                        

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2),SquareOffValue) as SquareOffValue,Exception,Remarks'                                        

 SET @MAIN = @MAIN + ' INTO #FINAL '                        

 SET @MAIN = @MAIN + ' FROM VMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP WITH (NOLOCK)'                      

                

 SET @MAIN = @MAIN + ' WHERE convert(varchar(11),update_date) = ''Dec 14 2015 '''    

 SET @MAIN = @MAIN + ' and noofdays>=4'              

                        

                        

                        

 IF @ACCESSLEVEL ='REGION' AND @ACCESSCODE <> '%'                        

 SET @MAIN = @MAIN + ' AND REGION LIKE ''' + @ACCESSCODE +''''                        

 ELSE IF @ACCESSLEVEL = 'BRANCH' AND @ACCESSCODE <> '%'                        

 SET @MAIN = @MAIN + ' AND BRANCH LIKE ''' + @ACCESSCODE +''''                        

                        

 ELSE IF @ACCESSLEVEL = 'SB'                        

 SET @MAIN = @MAIN + ' AND SB LIKE ''' + @ACCESSCODE +''''                        

                        

 ELSE IF @ACCESSLEVEL = 'CLIENT'                        

 SET @MAIN = @MAIN + ' AND PARTY_CODE LIKE ''' + @ACCESSCODE +''''                        

                        

 IF @ACCESS_TO = 'REGIONMAST'                        

 SET @MAIN = @MAIN + ' AND REGION IN (SELECT ACCESSCODE FROM general.dbo.TBL_RMS_GROUPMASTER WITH(NOLOCK) WHERE GROUPCODE= '''+@ACCESS_CODE+''') '                        

                        

 ELSE IF @ACCESS_TO = 'BRMAST'                        

 SET @MAIN = @MAIN + ' AND BRANCH IN (SELECT ACCESSCODE FROM general.dbo.TBL_RMS_GROUPMASTER WITH(NOLOCK) WHERE GROUPCODE= '''+@ACCESS_CODE+''') '                        

                        

 ELSE IF @access_to ='SBMAST'                        

 SET @Main = @Main + ' AND SB IN ( SELECT DISTINCT SUB_BROKER FROM general.dbo.SB_MASTER WITH(NOLOCK) WHERE SBMAST_CD='''+@access_code+''')'                        

                        

 ELSE IF @ACCESS_TO = 'BROKER'                        

 SET @MAIN = @MAIN + ' '                        

 ELSE IF @ACCESS_TO = 'BROKER'                                

 SET @MAIN = @MAIN + ' '                                

 ELSE                                

 SET @MAIN = @MAIN + ' AND '+@ACCESS_TO+' LIKE '''+@ACCESS_CODE+''' '                                

                      

 SET @MAIN = @MAIN + 'delete from #FINAL where SquareOffValue= 0'                        

                            

 SET @MAIN = @MAIN + ' update #FINAL set  noofdays=4 where noofdays>=4 '         

          

 SET @MAIN = @MAIN + ' SELECT REGION, BRANCH, SB, PARTY_CODE, CATEGORY, CLI_TYPE, '                        

 SET @MAIN = @MAIN + ' VarMarginShortFall_AftAdj, '                        

 SET @MAIN = @MAIN + ' SquareOffValue,update_date,noofdays,Exception,Remarks'                          

 SET @MAIN = @MAIN + ' FROM #FINAL ORDER BY SquareOffValue desc'                        

 PRINT (@MAIN)                        

 EXEC (@MAIN)                        

                        

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_RPT_LOWER_SHORTAGE_DRILL
-- --------------------------------------------------
         
-- VMSS_RPT_LOWER_SHORTAGE_DRILL 'v905'                                                
CREATE PROCEDURE [dbo].[VMSS_RPT_LOWER_SHORTAGE_DRILL] -- 'region','southguj','all','7','sep 6 2012','broker','cso','%'                            
                           
@Party_Code VARCHAR(20)                           
--@ALERTDATE DATETIME,                            
AS                            
BEGIN     
    
declare @fromdate varchar(11),@todate varchar(11)    
set @todate= (select MAX(processdate) FROM VMSS_DATA)    
print @todate    
    
set @fromdate= (select MAX(processdate)-5 FROM VMSS_DATA)    
print @fromdate    
    
SELECT PARTY_CODE,CONVERT(DECIMAL(15,2),Balance) as Balance,CONVERT(DECIMAL(15,2),Holding_BHC) as Actual_holding_value,CONVERT(DECIMAL(15,2),Holding_AHC) as Holding_after_haircut,    
CONVERT(DECIMAL(15,2),(NSEFO_JV+NSEFO_NonCash+MCD_JV+MCD_NonCash+NSX_JV+NSX_NonCash+DP_adj)) as Other_Adj,CONVERT(DECIMAL(15,2),VarMarginShortFall_AftAdjCurrDay) as VarMarginShortFall_AftAdjCurrDay, 
NoofDays as [day],convert(varchar(11),processDate,105) as processDate   
FROM VMSS_DATA WHERE  Party_code=@Party_Code and processDate>=@fromdate and     
processDate<=@todate order by processDate desc    
    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Rpt_MnthCliLedgerDetail_Drilldown
-- --------------------------------------------------

--VMSS_Rpt_MnthCliLedgerDetail_Drilldown 'nsecm','A62478','e00229','broker','cso'
CREATE procedure [dbo].[VMSS_Rpt_MnthCliLedgerDetail_Drilldown]  
@co_code as varchar(10),  
@client as varchar(10),  
@userid as varchar(15),  
@access_to as varchar(10),  
@access_code as varchar(10)  
as  
SET NOCOUNT ON  
  
  
declare @str as varchar(5000)  
  
set @str= ''  
set @str=@str + ' set nocount on'  
set @str=@str + ' DECLARE @srno as int,@amt as money,@bal as money '  
  
if @co_code = 'NBFC'  
begin  
set @str=@str + ' select @bal=isnull(sum(case when drcr=''D'' then vamt*-1 else vamt*-1 end),0) from '+@co_code+'_ledger with (nolock) '  
set @str=@str + ' where cltcode='''+@client+''' and vdt < (select min(vdt) from ' + 'general.dbo.' + @co_code+'_ledger with (nolock) '  
set @str=@str + ' where vdt<=GETDATE()and vdt>=GETDATE()-30 and cltcode='''+@client+''') '  
end  
ELSE  
begin  
set @str=@str + ' select @bal=isnull(sum(case when drcr=''D'' then -vamt else vamt end),0) from '+@co_code+'_ledger with (nolock) '  
set @str=@str + ' where cltcode='''+@client+''' and vdt < (select min(vdt) from ' + 'general.dbo.' +@co_code+'_ledger with (nolock) '  
set @str=@str + ' where vdt<=GETDATE()and vdt>=GETDATE()-30 and cltcode='''+@client+''') '  
end  
  
set @str=@str + ' select srno= IDENTITY(int,1,1),[Vouc.Date],Effective_Date,Vouc_Type,Vouc_No,narration,debit,credit,amount,balance into #cliLedger from ( '  
set @str=@str + ' select convert(varchar(10),vdt,103) as [Vouc.Date],'  
set @str=@str + ' convert(varchar(10),Edt,103) as Effective_Date, '  
  
IF @co_code <> 'NBFC'  
set @str=@str + ' Vouc_Type = b.shortdesc, '  
else  
set @str=@str + ' Vouc_Type= '''', '  
set @str=@str + ' Vouc_No=a.vno,a.narration, '  
  
if @co_code = 'NBFC'  
begin  
set @str=@str + ' Debit=(case when drcr=''D'' then vamt else 0 end), '  
set @str=@str + ' Credit=(case when drcr=''C'' then vamt*-1 else 0 end), '  
set @str=@str + ' Amount=(case when drcr=''D'' then vamt*-1 else vamt*-1 end), '  
set @str=@str + ' Balance=(case when drcr=''D'' then vamt*-1 else vamt*-1 end) '  
end  
ELSE  
begin  
set @str=@str + ' Debit=(case when drcr=''D'' then vamt else 0 end), '  
set @str=@str + ' Credit=(case when drcr=''C'' then vamt else 0 end), '  
set @str=@str + ' Amount=(case when drcr=''D'' then -vamt else vamt end), '  
set @str=@str + ' Balance=(case when drcr=''D'' then vamt else 0 end) '  
end  
  
set @str=@str + ' from (select acname,actnodays,balamt,BookType,cdt,CheckedBy,cltcode,drcr,edt'  
set @str=@str + ' ,EnteredBy,lno,narration,NoDays,pdt,refno,vamt,vdt,vno,vno1,vtyp'  
set @str=@str + ' from ' + 'general.dbo.' +@co_code+'_ledger with (nolock) where  vdt<=GETDATE()and vdt>=GETDATE()-30 and cltcode='''+@client+''') a '  
if @co_code <> 'NBFC'  
begin  
set @str=@str + ' ,(Select co_code,Vtype,Vdesc,Shortdesc,Dispflag,Narration from general.dbo.vmast with (nolock) where co_Code='''+@co_code+''') b '  
set @str=@str + ' where a.vtyp=convert(varchar,b.vtype) '  
END  
set @str=@str + ' ) x order by [Vouc.Date],Vouc_No'  
  
set @str=@str + ' DECLARE @balance AS MONEY'  
set @str=@str + ' SET @balance = 0'  
set @str=@str + ' UPDATE #cliledger SET @balance = balance = @balance + amount '  
  

set @str=@str + ' if (select count(1) from #cliLedger where Vouc_Type=''OPENEN'') > 0 '  
set @str=@str + ' begin '  
set @str=@str + ' delete from #cliLedger where Vouc_Type=''OPNBAL'''  
set @str=@str + ' end '  
  
IF @co_code <> 'NBFC'  
set @str=@str + ' select srno,[Vouc.Date],Effective_Date,Vouc_Type,Vouc_No,Narration,'  
else  
set @str=@str + ' select srno,[Vouc.Date],Vouc_Type,Vouc_No,Narration,'  
  
  
--set @str=@str + ' select srno,[Vouc.Date],[Created Date],[Effective Date],[Vouc.Type],[Vouc.No.],Narration,'  
--set @str=@str + ' Debit=''<span style="color=red;width=80px;text-align=right">''+convert(varchar(15),convert(decimal(12,2),Debit))+''</span>'','  
--set @str=@str + ' Credit=''<span style="color=blue;width=80px;text-align=right">''+convert(varchar(15),convert(decimal(12,2),Credit))+''</span>'','  
set @str=@str + ' debit=convert(decimal(12,2),debit*-1),Credit=convert(decimal(12,2),credit), '  
set @str=@str + ' Amount,Balance=convert(decimal(12,2),balance) from #cliLedger order by [Vouc.Date] desc '  
set @str=@str + ' select tdate='''''  
set @str=@str + ' select tdate='''''  
set @str = @str +' select top 1 tdate=''Last updated on : '' +convert(varchar,batchendtime,106)+'' ''+ convert(varchar,batchendtime,8) from general.dbo.rms_batchjob_log where batchid=30 order by batchdate desc Set Nocount off'  
set @str=@str + ' set nocount off'  
print @str  
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Rpt_MnthCliLedgerDetail_EffBalDrillDown
-- --------------------------------------------------
--VMSS_Rpt_MnthCliLedgerDetail_EffBalDrillDown 'bsecm','M77537','e00229','broker','cso'
--Rpt_MnthCliLedgerDetail 'nsecm','','','A62478','','4','2015','','e00229','broker','cso'
CREATE procedure [dbo].[VMSS_Rpt_MnthCliLedgerDetail_EffBalDrillDown]  
@co_code as varchar(10),  
@client as varchar(10),  
--@mnth as varchar(2)=null,  
--@year as varchar(4)=null,  
@userid as varchar(15),  
@access_to as varchar(10),  
@access_code as varchar(10)  
as  
SET NOCOUNT ON  

 
  
declare @str as varchar(5000)  
declare @frommnth as varchar(2)=null,@tomnth as varchar(2)=null,@year as varchar(4)=null 
set @frommnth=datepart(mm,GETDATE()-30)
set @tomnth=datepart(mm,GETDATE())
set @year =datepart(yyyy,GETDATE())

print @frommnth
print @tomnth
set @str= ''  
set @str=@str + ' set nocount on'  
set @str=@str + ' DECLARE @srno as int,@amt as money,@bal as money '  
  
if @co_code = 'NBFC'  
begin  
set @str=@str + ' select @bal=isnull(sum(case when drcr=''D'' then vamt*-1 else vamt*-1 end),0) from '+@co_code+'_ledger with (nolock) '  
set @str=@str + ' where cltcode='''+@client+''' and vdt < (select min(vdt) from ' + 'general.dbo.' +@co_code+'_ledger with (nolock) '  
set @str=@str + ' where datepart(mm,vdt)>='+@frommnth+' and datepart(mm,vdt)<='+@tomnth+'and datepart(yyyy,vdt)='+@year+' and cltcode='''+@client+''') '  
end  
ELSE  
begin  
set @str=@str + ' select @bal=isnull(sum(case when drcr=''D'' then -vamt else vamt end),0) from '+@co_code+'_ledger (nolock) '  
set @str=@str + ' where cltcode='''+@client+''' and vdt < (select min(vdt) from ' +'general.dbo.' +@co_code+'_ledger with (nolock) '  
set @str=@str + ' where datepart(mm,vdt)>='+@frommnth+' and datepart(mm,vdt)<='+@tomnth+' and datepart(yyyy,vdt)='+@year+' and cltcode='''+@client+''') '  
end  
  
set @str=@str + ' select srno= IDENTITY(int,1,1),Vouc_Date,Created_Date,Effective_Date,Vouc_Type,Vouc_No,narration,debit,credit,amount,balance into #cliLedger from '  
set @str=@str + ' ( select Vouc_Date=convert(varchar(10),convert(datetime,convert(varchar(2),'+@frommnth+')+''/01/''+convert(varchar(4),'+@year+')),103),'  
set @str=@str + '  Created_Date=convert(varchar(10),convert(datetime,convert(varchar(2),'+@frommnth+')+''/01/''+convert(varchar(4),'+@year+')),103),'  
set @str=@str + '  Effective_Date=convert(varchar(10),convert(datetime,convert(varchar(2),'+@frommnth+')+''/01/''+convert(varchar(4),'+@year+')),103),'  
set @str=@str + '  Vouc_Type = ''OPNBAL'','  
set @str=@str + ' Vouc_No=convert(varchar(4),'+@year+')+(Case when len('+@frommnth+')=1 then ''0''+convert(varchar(2),'+@frommnth+') else convert(varchar(2),'+@frommnth+') end)+''010000'','  
set @str=@str + ' narration=''Opening Balance'','  
set @str=@str + ' debit=(case when @bal < 0 then abs(@bal) else 0 end), '  
set @str=@str + ' credit=(case when @bal >= 0 then abs(@bal) else 0 end), '  
set @str=@str + ' amount=@bal, balance=@bal union all '  
set @str=@str + ' select convert(varchar(10),vdt,103) as Vouc_Date,'  
set @str=@str + ' Created_Date=''<div title="Entered By : '' + EnteredBy +''">'' + convert(varchar(20),cdt,103)+SUBSTRING(CONVERT(varchar,cdt,22),9,12)+''</div>'','  
set @str=@str + ' convert(varchar(10),Edt,103) as [Effective Date], '  
  
IF @co_code <> 'NBFC'  
set @str=@str + ' Vouc_Type = b.shortdesc, '  
else  
set @str=@str + ' Vouc_Type = '''', '  
set @str=@str + ' Vouc_No=a.vno,a.narration, '  
  
if @co_code = 'NBFC'  
begin  
set @str=@str + ' Debit=(case when drcr=''D'' then vamt else 0 end), '  
set @str=@str + ' Credit=(case when drcr=''C'' then vamt*-1 else 0 end), '  
set @str=@str + ' Amount=(case when drcr=''D'' then vamt*-1 else vamt*-1 end), '  
set @str=@str + ' Balance=(case when drcr=''D'' then vamt*-1 else vamt*-1 end) '  
end  
ELSE  
begin  
set @str=@str + ' Debit=(case when drcr=''D'' then vamt else 0 end), '  
set @str=@str + ' Credit=(case when drcr=''C'' then vamt else 0 end), '  
set @str=@str + ' Amount=(case when drcr=''D'' then -vamt else vamt end), '  
set @str=@str + ' Balance=(case when drcr=''D'' then vamt else 0 end) '  
end  
  
set @str=@str + ' from (select acname,actnodays,balamt,BookType,cdt,CheckedBy,cltcode,drcr,edt'  
set @str=@str + ' ,EnteredBy,lno,narration,NoDays,pdt,refno,vamt,vdt,vno,vno1,vtyp'  
set @str=@str + ' from '+ 'general.dbo.' +@co_code+'_ledger with (nolock) where datepart(mm,vdt)>='+@frommnth+' and datepart(mm,vdt)<='+@tomnth+' and datepart(yyyy,vdt)='+@year+' and cltcode='''+@client+''') a '  
if @co_code <> 'NBFC'  
begin  
set @str=@str + ' ,(Select co_code,Vtype,Vdesc,Shortdesc,Dispflag,Narration from general.dbo.vmast with (nolock) where co_Code='''+@co_code+''') b '  
set @str=@str + ' where a.vtyp=convert(varchar,b.vtype) '  
END  
set @str=@str + ' ) x order by Vouc_Date,Vouc_No '  
  
set @str=@str + ' DECLARE @balance AS MONEY'  
set @str=@str + ' SET @balance = 0'  
set @str=@str + ' UPDATE #cliledger SET @balance = balance = @balance + amount '  
  


set @str=@str + ' if (select count(1) from #cliLedger where Vouc_Type=''OPENEN'') > 0 '  
set @str=@str + ' begin '  
set @str=@str + ' delete from #cliLedger where [Vouc.Type]=''OPNBAL'''  
set @str=@str + ' end '  
  
IF @co_code <> 'NBFC'  
set @str=@str + ' select srno,Vouc_Date,Effective_Date,Vouc_Type,Vouc_No,Narration,'  
else  
set @str=@str + ' select srno,Vouc_Date,Effective_Date,Vouc_Type,Vouc_No,Narration,'  
    
set @str=@str + ' debit=convert(decimal(12,2),debit*-1),Credit=convert(decimal(12,2),credit), '  
set @str=@str + ' Amount,Balance=convert(decimal(12,2),balance) from #cliLedger order by convert(date,Vouc_Date,105) '  
set @str=@str + ' select tdate='''''  
set @str=@str + ' select tdate='''''  
set @str = @str +' select top 1 tdate=''Last updated on : '' +convert(varchar,batchendtime,106)+'' ''+ convert(varchar,batchendtime,8) from general.dbo.rms_batchjob_log where batchid=30 order by batchdate desc Set Nocount off'  
set @str=@str + ' set nocount off'  
print @str  
exec(@str)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Rpt_OtherSegAdjDrill
-- --------------------------------------------------
--VMSS_Rpt_OtherSegAdjDrill 'V905 ','01/08/2015'                   
CREATE PROCEDURE [dbo].[VMSS_Rpt_OtherSegAdjDrill]            
@Client as Varchar(25) ,                  
--@Entity as Varchar(25) = NULL,                    
@AlertDate VARCHAR(11) = NULL                   
AS                    
BEGIN                    
DECLARE @MAIN VARCHAR(MAX),@DATABASE VARCHAR(10)                  
begin          
                
 SET @MAIN =''                    
                     
 SET @MAIN = @MAIN + ' select A.party_code,CONVERT(DECIMAL(15,2),A.NSEFO_JV) AS NSEFO_JV,CONVERT(DECIMAL(15,2), A.NSEFO_NonCash) AS NSEFO_NonCash,'
 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2),A.MCD_JV) AS MCD_JV,CONVERT(DECIMAL(15,2),A.MCD_NonCash) AS MCD_NonCash,CONVERT(DECIMAL(15,2),A.NSX_JV) AS NSX_JV,'
 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2),A.NSX_NonCash) AS NSX_NonCash,CONVERT(DECIMAL(15,2),A.DP_adj) AS DP_adj'                   
 SET @MAIN = @MAIN + ' into #temp '                    
 SET @MAIN = @MAIN + ' FROM vmss_data A '                                       
 SET @MAIN = @MAIN + ' WHERE A.Party_Code='''+@Client+''''                    
 SET @MAIN = @MAIN + ' AND CONVERT(VARCHAR(11),A.Updatedon,103)=''' + CONVERT(VARCHAR(11),@AlertDate,103)+''''                    
 --SET @MAIN = @MAIN + ' group by A.party_code,B.isin,A.exchange,A.scrip_cd,C.scripname,A.series,A.category,A.src,A.clsrate,A.processdate,A.actualsqoffqty,A.avgrate'                  
         
 SET @MAIN = @MAIN + '  Select  Party_code,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,DP_adj from #temp'          
                 
end      
      
  
      
                
PRINT @MAIN                    
EXEC(@MAIN)                    
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.vmss_Rpt_RMS_New_Holding
-- --------------------------------------------------
  -- vmss_Rpt_RMS_New_Holding 'V905'  
CREATE PROCEDURE [dbo].[vmss_Rpt_RMS_New_Holding]            
@client as varchar(10)           
--@party_name as varchar(100),            
--@co_Code as varchar(10),            
--@userid as varchar(15),            
--@access_To as varchar(10),            
--@access_Code as varchar(10)            
as            
begin            
set nocount on       
 select isnull(VRH.scripname,VRH.scrip_cd) as scripname,VRH.scrip_cd as scrip_cd,vrh.isin as isin,VRH.nse_approved as category,vrh.src as src,vrh.series as series,sum(VRH.qty) as [Quantity],  convert(decimal(15,2),VRH.clsrate) as Closing_Rate,     
 BlueChip=convert(decimal(15,2),Case when VRH.nse_approved='BlueChip' then sum(VBHC) else 0 end),  Good=convert(decimal(15,2),    
 Case when VRH.nse_approved='Good' then sum(VBHC) else 0 end),  Average=convert(decimal(15,2),    
 Case when VRH.nse_approved='Average' then sum(VBHC) else 0 end), Poor=convert(decimal(15,2),    
 Case when VRH.nse_approved='Poor' then sum(VBHC) else 0 end), Total_HOLD=convert(decimal(15,2),0),     
 [Exchange Var %]= Case  when '%'='bsecm' then isnull(convert(decimal(15,2),VRH.Bse_var),0.00)     
 else isnull(convert(decimal(15,2),VRH.nse_var),0.00) end,  [Angel Var %]= convert(decimal(15,2),isnull(angel_var,0)),     
 [Final Var %]=VRH.haircut,   
 --[Haircut %]=Case when '%'='bsecm' then isnull(convert(decimal(15,2),VRH.BSE_proj_VaR),0.00) else isnull(convert(decimal(15,2),VRH.NSE_proj_VaR),0.00) end,     
 [Hold with HC]= convert(decimal(15,2),sum(isnull(VRH.VAHC,0))),      
 [BSE Var %]= convert(decimal(15,2),isnull(VRH.BSE_VaR_Display,0)),     
 [NSE Var %]= convert(decimal(15,2),isnull(VRH.NSE_VaR_Display,0))    
 into #file1     
 from vMSS_Vw_Rms_holding VRH     
 where   
 party_code=@client  
 group by VRH.scripname, VRH.scrip_cd, VRH.nse_approved, VRH.clsrate, isnull(angel_var,0),BSE_VAR,      
 Bse_final_var, BSE_proj_VaR, NSE_proj_VaR, nse_var, BSE_proj_VaR, vrh.haircut,    
 isnull(BSE_VaR_Display,0), isnull(NSE_VaR_Display,0),vrh.isin,vrh.src,vrh.series    
    
 update #file1 SET Total_HOLD = Convert(decimal(15,2),(BlueChip + Good + Average + Poor))      
       
 select isin,scrip_cd,scripname,series,category,src,convert(int,[Quantity]) as [Quantity],Closing_Rate,BlueChip,Good,Average,Poor,Total_HOLD,     
 isnull([BSE Var %],0) BSE_Var_Per, isnull([NSE Var %],0) NSE_Var_Per,  isnull([Final Var %],0.00) as Valid_Var_Per,    
  isnull([Hold with HC],0.00) as Hold_with_HC from #file1     
 order by scripname      
 
 
   
 select '<A TARGET="_BLANK;TOOLBAR=NO;LOCATION=NO;DIRECTORIES=NO;" HREF="FrmPrintCLIDET.ASPX?CLIENT=pz77"><B>PRINT</B></A>','TOTAL',    
 '&nbsp;','&nbsp;',BlueChip=sum(BlueChip),Good=sum(Good),Average=sum(Average),Poor=sum(Poor),Total_Hold=sum(Total_HOLD), '&nbsp;','&nbsp;','&nbsp;','&nbsp;',    
 Hold_with_HC=sum(isnull([Hold with HC],0.00)) from #file1     
    
 select top 1 tdate='Last updated on : ' +convert(varchar,UPD_DATE,106)+' '+ convert(varchar,UPD_DATE,8) from vMSS_RMS_HOLDING WITH (NOLOCK)             
    
Set nocount off    
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Rpt_SquareOffDrilldown
-- --------------------------------------------------

--VMSS_Rpt_SquareOffDrilldown 'A19304','19/08/2015','C'                      
CREATE PROCEDURE [dbo].[VMSS_Rpt_SquareOffDrilldown]              
@Client as Varchar(25) ,                    
--@Entity as Varchar(25) = NULL,                      
@AlertDate VARCHAR(11) = NULL   ,        
@SqOffType char(1)                   
AS                      
BEGIN                      
DECLARE @MAIN VARCHAR(MAX),@DATABASE VARCHAR(10)                    
                      
--Case added to handle Weekends                      
/*                    
SELECT @TDATE = CASE WHEN DATEPART(DW,GETDATE()) = 7 THEN GETDATE() - 1                      
     WHEN DATEPART(DW,GETDATE()) = 1 THEN GETDATE() - 2                      
     ELSE GETDATE() END                      
                      
SELECT @AlertDate = CONVERT(DATETIME,CASE WHEN @HistDate IS NULL THEN CONVERT(VARCHAR(11),@TDATE,103) ELSE @HistDate END,103)                      
SELECT @DATABASE = CASE WHEN @HistDate = CONVERT(VARCHAR(11),@TDATE,103) THEN 'GENERAL' ELSE 'HISTORY' END                      
PRINT @HistDate                      
PRINT @AlertDate                      
PRINT CONVERT(VARCHAR(11),@TDATE,103)                      
 */        
         
if(@SqOffType='C')        
begin            
                  
 SET @MAIN =''                      
                       
 SET @MAIN = @MAIN + ' select A.party_code, B.isin,A.sett_no, A.exchange, A.scrip_cd, C.scripname, A.series, A.category, A.src, A.qty, A.clsrate, A.processdate, '                      
 SET @MAIN = @MAIN + ' A.squareoffqty ,SquareOffRate=A.avgrate, A.actualsqoffqty,SQ_VALUE = CONVERT(DECIMAL(15, 2), CONVERT(MONEY,(squareoffqty * clsrate ))),Actual_SQ_VALUE = CONVERT(DECIMAL(15, 2),CONVERT(MONEY, ( A.actualsqoffqty * a.avgrate )), 1) '  

      
 SET @MAIN = @MAIN + ' into #temp '                      
 SET @MAIN = @MAIN + ' FROM vMSS_holding A left outer join  general.dbo.scriponlyvar_master B on A.ISIN=B.isin '                      
 SET @MAIN = @MAIN + ' inner join  general.dbo.scrip_master C on  B.isin = C.isin '                      
 SET @MAIN = @MAIN + ' WHERE A.Party_Code='''+@Client+''''                      
 SET @MAIN = @MAIN + ' AND CONVERT(VARCHAR(11),A.ProcessDate,103)=''' + CONVERT(VARCHAR(11),@AlertDate,103)+''''                      
 --SET @MAIN = @MAIN + ' group by A.party_code,B.isin,A.exchange,A.scrip_cd,C.scripname,A.series,A.category,A.src,A.clsrate,A.processdate,A.actualsqoffqty,A.avgrate'                    
           
 SET @MAIN = @MAIN + '  Select party_code, isin,sett_no,exchange, scrip_cd, scripname, series,  category, src, qty, clsrate, processdate, squareoffqty, SQ_VALUE , squareoffrate,actualsqoffqty, actual_sq_value from #temp where SQ_VALUE>0 order by sett_no d
esc'            
 --SET @MAIN = @MAIN + '  group by party_code,isin,exchange,scrip_cd,scripname,series,category,src,qty,squareoffqty,clsrate,processdate,squareoffrate,actualsqoffqty,Actual_SQ_VALUE'           
                  
 SET @MAIN = @MAIN + '  select  party_code,Qty=SUM(qty),SQ_QTY=SUM(SquareOffQty),SQ_VALUE = CONVERT(DECIMAL(15, 2),Sum(SQ_VALUE))'                      
 SET @MAIN = @MAIN + '  FROM  #temp '                      
 SET @MAIN = @MAIN + '  GROUP BY Party_Code'                      
end        
        
else if(@SqOffType='A')        
begin        
   SET @MAIN =''                        
                        
 SET @MAIN = @MAIN + ' SELECT A.party_Code,B.isin,A.sett_no,A.exchange,A.scrip_cd,C.scripname,A.Series,A.CATEGORY,A.SRC,sum(A.qty)qty,A.clsrate,A.ProcessDate,Sum(A.squareoffqty) squareoffqty,'                        
 SET @MAIN = @MAIN + ' SquareOffRate=A.AvgRate,A.ActualSqOffQty,Actual_SQ_VALUE = CONVERT(DECIMAL(15, 2), CONVERT(MONEY, ( A.ActualSqOffQty * a.AvgRate)), 1)'                      
               
 SET @MAIN = @MAIN + ' into #temp '                        
 SET @MAIN = @MAIN + ' FROM vMSS_holding A left outer join  general.dbo.scriponlyvar_master B on A.ISIN=B.isin '                        
 SET @MAIN = @MAIN + ' inner join  general.dbo.scrip_master C on  B.isin = C.isin '                        
 SET @MAIN = @MAIN + ' WHERE A.Party_Code='''+@Client+''''                        
 SET @MAIN = @MAIN + ' AND CONVERT(VARCHAR(11),A.ProcessDate,103)=''' + CONVERT(VARCHAR(11),@AlertDate,103)+''''                        
 SET @MAIN = @MAIN + ' group by A.party_code,B.isin,A.sett_no,A.exchange,A.scrip_cd,C.scripname,A.series,A.category,A.src,A.clsrate,A.processdate,A.actualsqoffqty,A.avgrate'                      
             
 SET @MAIN = @MAIN + '  Select party_code,isin,sett_no,exchange,scrip_cd,scripname,series,category,src,qty,clsrate,processdate,squareoffqty, SQ_VALUE = CONVERT(DECIMAL(15, 2), CONVERT(MONEY,(squareoffqty * clsrate ))),SquareOffRate,actualsqoffqty,Actual_S
Q_VALUE from #temp where Actual_SQ_VALUE<>0'              
 SET @MAIN = @MAIN + '  group by party_code,isin,sett_no,exchange,scrip_cd,scripname,series,category,src,qty,squareoffqty,clsrate,processdate,squareoffrate,actualsqoffqty,Actual_SQ_VALUE order by sett_no desc'             
                    
 SET @MAIN = @MAIN + '  select  party_code,Qty=SUM(qty),SQ_QTY=SUM(SquareOffQty),SQ_VALUE = CONVERT(DECIMAL(15, 2),Sum(Actual_SQ_VALUE))'                        
 SET @MAIN = @MAIN + '  FROM  #temp '                        
 SET @MAIN = @MAIN + '  GROUP BY Party_Code'          
end          
else        
print 'Client does not exist'         
        
                  
PRINT @MAIN                      
EXEC(@MAIN)                      
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Rpt_SquareOffDrilldown_actual
-- --------------------------------------------------
--VMSS_Rpt_SquareOffDrilldown 'A50876','08/07/2015'              
CREATE PROCEDURE [dbo].[VMSS_Rpt_SquareOffDrilldown_actual]            
@Client as Varchar(25) ,            
--@Entity as Varchar(25) = NULL,              
@AlertDate VARCHAR(11) = NULL              
AS              
BEGIN              
DECLARE @MAIN VARCHAR(MAX),@DATABASE VARCHAR(10)            
              
--Case added to handle Weekends              
/*            
SELECT @TDATE = CASE WHEN DATEPART(DW,GETDATE()) = 7 THEN GETDATE() - 1              
     WHEN DATEPART(DW,GETDATE()) = 1 THEN GETDATE() - 2              
     ELSE GETDATE() END              
              
SELECT @AlertDate = CONVERT(DATETIME,CASE WHEN @HistDate IS NULL THEN CONVERT(VARCHAR(11),@TDATE,103) ELSE @HistDate END,103)              
SELECT @DATABASE = CASE WHEN @HistDate = CONVERT(VARCHAR(11),@TDATE,103) THEN 'GENERAL' ELSE 'HISTORY' END              
PRINT @HistDate              
PRINT @AlertDate              
PRINT CONVERT(VARCHAR(11),@TDATE,103)              
 */             
SET @MAIN =''              
              
SET @MAIN = @MAIN + ' SELECT A.party_Code,B.isin,A.exchange,A.scrip_cd,C.scripname,A.Series,A.CATEGORY,A.SRC,sum(A.qty)qty,A.clsrate,A.ProcessDate,Sum(A.squareoffqty) squareoffqty,'              
SET @MAIN = @MAIN + ' SquareOffRate=A.AvgRate,A.ActualSqOffQty,Actual_SQ_VALUE = CONVERT(DECIMAL(15, 2), CONVERT(MONEY, ( A.ActualSqOffQty * a.AvgRate)), 1)'            
    
SET @MAIN = @MAIN + ' into #temp '              
SET @MAIN = @MAIN + ' FROM vMSS_holding A left outer join general.dbo.scriponlyvar_master B on A.ISIN=B.isin '              
SET @MAIN = @MAIN + ' inner join  general.dbo.scrip_master C on  B.isin = C.isin '              
SET @MAIN = @MAIN + ' WHERE A.Party_Code='''+@Client+''''              
SET @MAIN = @MAIN + ' AND CONVERT(VARCHAR(11),A.ProcessDate,103)=''' + CONVERT(VARCHAR(11),@AlertDate,103)+''''              
SET @MAIN = @MAIN + ' group by A.party_code,B.isin,A.exchange,A.scrip_cd,C.scripname,A.series,A.category,A.src,A.clsrate,A.processdate,A.actualsqoffqty,A.avgrate'            
  
SET @MAIN = @MAIN + '  Select party_code,isin,exchange,scrip_cd,scripname,series,category,src,qty,clsrate,processdate,squareoffqty, SQ_VALUE = CONVERT(DECIMAL(15, 2), CONVERT(MONEY,(squareoffqty * clsrate ) )),SquareOffRate,actualsqoffqty,Actual_SQ_VALUE 
from #temp where Actual_SQ_VALUE>0 '    
SET @MAIN = @MAIN + '  group by party_code,isin,exchange,scrip_cd,scripname,series,category,src,qty,squareoffqty,clsrate,processdate,squareoffrate,actualsqoffqty,Actual_SQ_VALUE'   
         
SET @MAIN = @MAIN + '  select  party_code,Qty=SUM(qty),SQ_QTY=SUM(SquareOffQty),SQ_VALUE = CONVERT(DECIMAL(15, 2),Sum(Actual_SQ_VALUE))'              
SET @MAIN = @MAIN + '  FROM  #temp '              
SET @MAIN = @MAIN + '  GROUP BY Party_Code'              
              
PRINT @MAIN              
EXEC(@MAIN)              
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_RPT_VarMarginSqOff
-- --------------------------------------------------
-- VMSS_RPT_VarMarginSqOff 'CLIENT','G22552','ALL','7','jun 23 2015','broker','cso','%'                          



-- VMSS_RPT_VarMarginSqOff '%','%','%','7','Aug 17 2015','REGION','%','%'                          



-- VMSS_RPT_VarMarginSqOff 'REGION','%','ALL','All','12/4/2015 12:00:00 AM','broker','cso','all'                          

-- VMSS_RPT_VarMarginSqOff 'REGION','%','ALL','All','12/3/2015 12:00:00 AM','broker','cso','all'    

CREATE PROCEDURE [dbo].[VMSS_RPT_VarMarginSqOff] --'CLIENT','H690','all','3','dec 2 2015','broker','cso','%'                          



@ACCESSLEVEL VARCHAR(20),                          



@ACCESSCODE VARCHAR(20),                          



@MOB VARCHAR(20),                          



@T_DAY VARCHAR(10),                          



@ALERTDATE datetime,                          



@ACCESS_TO VARCHAR(20),                          



@ACCESS_CODE VARCHAR(20),                          



@SQ_OFF_TYPE VARCHAR(20)                          



AS                          



BEGIN                          



                          



 IF @ACCESSCODE ='ALL'                        



 SET @ACCESSCODE =@ACCESS_CODE                          



                          



 IF @SQ_OFF_TYPE ='ALL'                          



 SET @SQ_OFF_TYPE ='%'                          



                          



 IF @T_Day ='ALL'                          



 SET @T_Day ='%'                          



                        



 DECLARE @MAIN VARCHAR(MAX)                          



 DECLARE @B_DATE VARCHAR(1000)                          



 SET @B_DATE = ''                          



                          



 SET @MAIN =''                          



                          



 SET @MAIN = @MAIN + ' SELECT B.REGION, B.BRANCH, B.SB, B.CATEGORY,CLI_TYPE, '                          



 SET @MAIN = @MAIN + ' B.SB_CATEGORY AS SBCAT,C.Party_code, '                          



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2), C.Balance) AS Effective_Balance, CONVERT(DECIMAL(15,2),C.Holding_BHC) AS Actual_holding_value, '                          



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2), C.Holding_AHC) AS Holding_after_haircut, CONVERT(DECIMAL(15,2), C.VarMarginShortFall_AftAdj) AS VarMarginShortFall_AftAdj, '      



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.VarMarginShortFall_AftAdjCurrDay) AS  VarMarginShortFall_AftAdjCurrDay,'                        



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSEFO_JV) AS  NSEFO_JV,'    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSEFO_NonCash) AS  NSEFO_NonCash, '    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.MCD_JV) AS  MCD_JV, '    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.MCD_NonCash) AS  MCD_NonCash, '    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSX_JV) AS  NSX_JV, '    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSX_NonCash) AS  NSX_NonCash, '          



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.DP_adj) AS  DP_adj, '            



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2),C.LeverageMultiplier) AS Var_Shortage_Per, '                          



 SET @MAIN = @MAIN + ' C.noofdays as Square_off_Action,convert(varchar(11),C.updatedon,103) as updatedon,'                          



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2),C.SquareOffValue) as SquareOffValue, '                          



 SET @MAIN = @MAIN + ' Actual_Cash_Square_Off_Done'                          



 SET @MAIN = @MAIN + ' INTO #FINAL '                          



 SET @MAIN = @MAIN + ' FROM vmss_data C WITH (NOLOCK) inner join general.dbo.VW_RMS_CLIENT_VERTICAL B WITH (NOLOCK) on  C.PARTY_CODE=B.CLIENT '                          



 SET @MAIN = @MAIN + ' INNER JOIN general.dbo.CLIENT_DETAILS CLI WITH (NOLOCK) ON B.CLIENT = CLI.PARTY_CODE '                          



                      



 if(cast(@ALERTDATE as date))=convert(varchar(11),GETDATE())                   



 begin                    



 SET @MAIN = @MAIN + ' WHERE convert(varchar(11),c.updatedon) = (select convert(VARCHAR(11),max(updatedon)) from vmss_data)'                    

	print 'current'

 end                     

 else                 



 begin        

	print 'history'

 SET @MAIN = @MAIN + ' WHERE convert(varchar(11),cast(c.updatedon as date)) = ''' +CONVERT(VARCHAR(11),cast(@ALERTDATE as date))+ ''''                             



 end                   



                   



 IF @SQ_OFF_TYPE <> '%'                          



 BEGIN                   



 print 'byee'                           



 SET @MAIN = @MAIN + ' AND B.CLI_TYPE = ''' + @SQ_OFF_TYPE + ''' '                          



 END                 
 --SET @MAIN = @MAIN + ' AND ABS(C.T_VALUE) > 100 and (holding+fo_Excoll+Curr_ExColl) > 100 and (FO_NET+Curr_NEt+T_Value) < 0 '                          
 if @T_Day <> '%'                          
begin                
	  if(@T_Day='4')              
   begin              
     SET @MAIN = @MAIN + ' AND C.NoofDays >= ' + @T_DAY   
					           
   end                         
end   

 if (@T_Day = '%' or @T_Day<>'4')                                         
   begin 
	    set @T_Day=1               
     SET @MAIN = @MAIN + ' AND C.NoofDays >= ' + @T_DAY
			end             

 IF UPPER(@MOB) ='YES'                          

 SET @MAIN = @MAIN + ' AND LEN(RTRIM(LTRIM(CLI.MOBILE_PAGER))) <>0 '                     

 IF UPPER(@MOB) ='NO'                          

 SET @MAIN = @MAIN + ' AND LEN(RTRIM(LTRIM(CLI.MOBILE_PAGER))) =0 '                          

 IF UPPER(@MOB) ='ALL'                          

 SET @MAIN = @MAIN + ' '                          

	
 IF @ACCESSLEVEL ='REGION' AND @ACCESSCODE <> '%'                          



 SET @MAIN = @MAIN + ' AND B.REGION LIKE ''' + @ACCESSCODE + ''''                          



 ELSE IF @ACCESSLEVEL = 'BRANCH' AND @ACCESSCODE <> '%'                          



 SET @MAIN = @MAIN + ' AND B.BRANCH LIKE ''' + @ACCESSCODE +''''                          


 ELSE IF @ACCESSLEVEL = 'SB'                          


 SET @MAIN = @MAIN + ' AND B.SB LIKE ''' + @ACCESSCODE +''''                          


 ELSE IF @ACCESSLEVEL = 'CLIENT'                          



 SET @MAIN = @MAIN + ' AND B.CLIENT LIKE ''' + @ACCESSCODE +''''                          

 IF @ACCESS_TO = 'REGIONMAST'                          



 SET @MAIN = @MAIN + ' AND B.REGION IN (SELECT ACCESSCODE FROM general.dbo.TBL_RMS_GROUPMASTER WITH(NOLOCK) WHERE GROUPCODE= '''+@ACCESS_CODE+''') '                          



                          



 ELSE IF @ACCESS_TO = 'BRMAST'                          



 SET @MAIN = @MAIN + ' AND B.BRANCH IN (SELECT ACCESSCODE FROM general.dbo.TBL_RMS_GROUPMASTER WITH(NOLOCK) WHERE GROUPCODE= '''+@ACCESS_CODE+''') '                          



                          



 ELSE IF @access_to ='SBMAST'                          



 SET @Main = @Main + ' AND B.SB IN ( SELECT DISTINCT SUB_BROKER FROM general.dbo.SB_MASTER WITH(NOLOCK) WHERE SBMAST_CD='''+@access_code+''')'                          



                          



 ELSE IF @ACCESS_TO = 'BROKER'                          



 SET @MAIN = @MAIN + ' '                          



 ELSE IF @ACCESS_TO = 'BROKER'                                  



 SET @MAIN = @MAIN + ' '                                  



 ELSE                                  



 SET @MAIN = @MAIN + ' AND B.'+@ACCESS_TO+' LIKE '''+@ACCESS_CODE+''' '                                  


 -- SET @MAIN = @MAIN + 'update #FINAL set [Actual Cash Square Off Done]=null  where [Actual Cash Square Off Done]= 0'                



if( @T_DAY='4' or @T_DAY='%')              




	
	SET @MAIN = @MAIN + 'delete from #FINAL where SquareOffValue= 0 '          
	SET @MAIN = @MAIN + ' update #FINAL set  Square_off_Action=4 where Square_off_Action>=4'  
 SET @MAIN = @MAIN + 'SELECT REGION, BRANCH, SB, PARTY_CODE, CATEGORY, CLI_TYPE, SBCAT, Effective_Balance,Actual_holding_value, '                   



 SET @MAIN = @MAIN + ' Holding_after_haircut,(NSEFO_JV+NSEFO_NonCash+MCD_JV+MCD_NonCash+NSX_JV+NSX_NonCash+DP_adj) as Other_Adj,VarMarginShortFall_AftAdjCurrDay,VarMarginShortFall_AftAdj, '                          



 SET @MAIN = @MAIN + ' Var_Shortage_Per,SquareOffValue,updatedon,Actual_Cash_Square_Off_Done,Square_off_Action'                            



 SET @MAIN = @MAIN + ' FROM #FINAL ORDER BY SquareOffValue desc'                          

	


 PRINT (@MAIN)                          



 EXEC (@MAIN)                          



                          



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_RPT_VarMarginSqOff_03122015
-- --------------------------------------------------
-- VMSS_RPT_VarMarginSqOff 'CLIENT','VRMA007','ALL','1','jun 23 2015','broker','cso','%'                          

-- VMSS_RPT_VarMarginSqOff '%','%','%','7','Aug 17 2015','REGION','%','%'                          

-- VMSS_RPT_VarMarginSqOff 'REGION','%','ALL','1','Aug 17 2015 ','broker','cso','all'                          

create PROCEDURE [dbo].[VMSS_RPT_VarMarginSqOff_03122015] -- 'region','southguj','all','7','Aug 17 2015','broker','cso','%'                          

@ACCESSLEVEL VARCHAR(20),                          

@ACCESSCODE VARCHAR(20),                          

@MOB VARCHAR(20),                          

@T_DAY VARCHAR(10),                          

@ALERTDATE DATETIME,                          

@ACCESS_TO VARCHAR(20),                          

@ACCESS_CODE VARCHAR(20),                          

@SQ_OFF_TYPE VARCHAR(20)                          

AS                          

BEGIN                          

                          

 IF @ACCESSCODE ='ALL'                        

 SET @ACCESSCODE =@ACCESS_CODE                          

                          

 IF @SQ_OFF_TYPE ='ALL'                          

 SET @SQ_OFF_TYPE ='%'                          

                          

 IF @T_Day ='ALL'                          

 SET @T_Day ='%'                          

                        

 DECLARE @MAIN VARCHAR(MAX)                          

 DECLARE @B_DATE VARCHAR(1000)                          

 SET @B_DATE = ''                          

                          

 SET @MAIN =''                          

                          

 SET @MAIN = @MAIN + ' SELECT B.REGION, B.BRANCH, B.SB, B.CATEGORY,CLI_TYPE, '                          

 SET @MAIN = @MAIN + ' B.SB_CATEGORY AS SBCAT,C.Party_code, '                          

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2), C.Balance) AS Effective_Balance, CONVERT(DECIMAL(15,2),C.Holding_BHC) AS Actual_holding_value, '                          

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2), C.Holding_AHC) AS Holding_after_haircut, CONVERT(DECIMAL(15,2), C.VarMarginShortFall_AftAdj) AS VarMarginShortFall_AftAdj, '      

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.VarMarginShortFall_AftAdjCurrDay) AS  VarMarginShortFall_AftAdjCurrDay,'                        

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSEFO_JV) AS  NSEFO_JV,'    

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSEFO_NonCash) AS  NSEFO_NonCash, '    

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.MCD_JV) AS  MCD_JV, '    

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.MCD_NonCash) AS  MCD_NonCash, '    

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSX_JV) AS  NSX_JV, '    

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSX_NonCash) AS  NSX_NonCash, '          

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.DP_adj) AS  DP_adj, '            

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2),C.LeverageMultiplier) AS Var_Shortage_Per, '                          

 SET @MAIN = @MAIN + ' C.noofdays as Square_off_Action,convert(varchar(11),C.updatedon,103) as updatedon,'                          

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2),C.SquareOffValue) as SquareOffValue, '                          

 SET @MAIN = @MAIN + ' Actual_Cash_Square_Off_Done'                          

 SET @MAIN = @MAIN + ' INTO #FINAL '                          

 SET @MAIN = @MAIN + ' FROM vmss_data C WITH (NOLOCK) inner join general.dbo.VW_RMS_CLIENT_VERTICAL B WITH (NOLOCK) on  C.PARTY_CODE=B.CLIENT '                          

 SET @MAIN = @MAIN + ' INNER JOIN general.dbo.CLIENT_DETAILS CLI WITH (NOLOCK) ON B.CLIENT = CLI.PARTY_CODE '                          

                      

 if(CONVERT(VARCHAR(11),@ALERTDATE)=convert(varchar(11),GETDATE()))                    

 begin                    

 SET @MAIN = @MAIN + ' WHERE convert(varchar(11),c.processDate) = (select convert(VARCHAR(11),max(processDate)) from vmss_data)'                    

 end                     
 else                 

 begin        

 SET @MAIN = @MAIN + ' WHERE convert(varchar(11),c.processDate) = ''' +CONVERT(VARCHAR(11),@ALERTDATE)+ ''''                             

 end                   

                   

 IF @SQ_OFF_TYPE <> '%'                          

 BEGIN                   

 print 'byee'                           

 SET @MAIN = @MAIN + ' AND B.CLI_TYPE = ''' + @SQ_OFF_TYPE + ''' '                          

 END                 

                 

                

 --SET @MAIN = @MAIN + ' AND ABS(C.T_VALUE) > 100 and (holding+fo_Excoll+Curr_ExColl) > 100 and (FO_NET+Curr_NEt+T_Value) < 0 '                          

                           

 if @T_Day <> '%'                          

 begin                

 /* print 'hii'      */            

 if(@T_Day='4')              

 begin              

  SET @MAIN = @MAIN + ' AND C.NoofDays >= ' + @T_DAY              

 end              

 else               

 begin                

  SET @MAIN = @MAIN + ' AND C.NoofDays = ' + @T_DAY                           

end             

           

             

end                         

                          

 IF UPPER(@MOB) ='YES'                          

 SET @MAIN = @MAIN + ' AND LEN(RTRIM(LTRIM(CLI.MOBILE_PAGER))) <>0 '                     

                          

 IF UPPER(@MOB) ='NO'                          

 SET @MAIN = @MAIN + ' AND LEN(RTRIM(LTRIM(CLI.MOBILE_PAGER))) =0 '                          

                          

 IF UPPER(@MOB) ='ALL'                          

 SET @MAIN = @MAIN + ' '                          

                          

                          

 IF @ACCESSLEVEL ='REGION' AND @ACCESSCODE <> '%'                          

 SET @MAIN = @MAIN + ' AND B.REGION LIKE ''' + @ACCESSCODE +''''                          

 ELSE IF @ACCESSLEVEL = 'BRANCH' AND @ACCESSCODE <> '%'                          

 SET @MAIN = @MAIN + ' AND B.BRANCH LIKE ''' + @ACCESSCODE +''''                          

                          

 ELSE IF @ACCESSLEVEL = 'SB'                          

 SET @MAIN = @MAIN + ' AND B.SB LIKE ''' + @ACCESSCODE +''''                          

                          

 ELSE IF @ACCESSLEVEL = 'CLIENT'                          

 SET @MAIN = @MAIN + ' AND B.CLIENT LIKE ''' + @ACCESSCODE +''''                          

                          

 IF @ACCESS_TO = 'REGIONMAST'                          

 SET @MAIN = @MAIN + ' AND B.REGION IN (SELECT ACCESSCODE FROM general.dbo.TBL_RMS_GROUPMASTER WITH(NOLOCK) WHERE GROUPCODE= '''+@ACCESS_CODE+''') '                          

                          

 ELSE IF @ACCESS_TO = 'BRMAST'                          

 SET @MAIN = @MAIN + ' AND B.BRANCH IN (SELECT ACCESSCODE FROM general.dbo.TBL_RMS_GROUPMASTER WITH(NOLOCK) WHERE GROUPCODE= '''+@ACCESS_CODE+''') '                          

                          

 ELSE IF @access_to ='SBMAST'                          

 SET @Main = @Main + ' AND B.SB IN ( SELECT DISTINCT SUB_BROKER FROM general.dbo.SB_MASTER WITH(NOLOCK) WHERE SBMAST_CD='''+@access_code+''')'                          

                          

 ELSE IF @ACCESS_TO = 'BROKER'                          

 SET @MAIN = @MAIN + ' '                          

 ELSE IF @ACCESS_TO = 'BROKER'                                  

 SET @MAIN = @MAIN + ' '                                  

 ELSE                                  

 SET @MAIN = @MAIN + ' AND B.'+@ACCESS_TO+' LIKE '''+@ACCESS_CODE+''' '                                  

                        

 SET @MAIN = @MAIN + 'delete from #FINAL where SquareOffValue= 0'                          

                         

 -- SET @MAIN = @MAIN + 'update #FINAL set [Actual Cash Square Off Done]=null  where [Actual Cash Square Off Done]= 0'                

if( @T_DAY='4' or @T_DAY='%')              

 SET @MAIN = @MAIN + 'update #FINAL set  Square_off_Action=4 where Square_off_Action>=4'           

            

 SET @MAIN = @MAIN + ' SELECT REGION, BRANCH, SB, PARTY_CODE, CATEGORY, CLI_TYPE, SBCAT, Effective_Balance,Actual_holding_value, '                   

 SET @MAIN = @MAIN + ' Holding_after_haircut,(NSEFO_JV+NSEFO_NonCash+MCD_JV+MCD_NonCash+NSX_JV+NSX_NonCash+DP_adj) as Other_Adj,VarMarginShortFall_AftAdjCurrDay,VarMarginShortFall_AftAdj, '                          

 SET @MAIN = @MAIN + ' Var_Shortage_Per,SquareOffValue,updatedon,Actual_Cash_Square_Off_Done,Square_off_Action'                            

 SET @MAIN = @MAIN + ' FROM #FINAL ORDER BY SquareOffValue desc'                          

 PRINT (@MAIN)                          

 EXEC (@MAIN)                          

                          

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_RPT_VarMarginSqOff_04122015
-- --------------------------------------------------
-- VMSS_RPT_VarMarginSqOff 'CLIENT','VRMA007','ALL','1','jun 23 2015','broker','cso','%'                          

-- VMSS_RPT_VarMarginSqOff '%','%','%','7','Aug 17 2015','REGION','%','%'                          

-- VMSS_RPT_VarMarginSqOff 'REGION','%','ALL','1','Aug 17 2015 ','broker','cso','all'                          

create PROCEDURE [dbo].[VMSS_RPT_VarMarginSqOff_04122015] -- 'region','southguj','all','7','Aug 17 2015','broker','cso','%'                          

@ACCESSLEVEL VARCHAR(20),                          

@ACCESSCODE VARCHAR(20),                          

@MOB VARCHAR(20),                          

@T_DAY VARCHAR(10),                          

@ALERTDATE DATETIME,                          

@ACCESS_TO VARCHAR(20),                          

@ACCESS_CODE VARCHAR(20),                          

@SQ_OFF_TYPE VARCHAR(20)                          

AS                          

BEGIN                          

                          

 IF @ACCESSCODE ='ALL'                        

 SET @ACCESSCODE =@ACCESS_CODE                          

                          

 IF @SQ_OFF_TYPE ='ALL'                          

 SET @SQ_OFF_TYPE ='%'                          

                          

 IF @T_Day ='ALL'                          

 SET @T_Day ='%'                          

                        

 DECLARE @MAIN VARCHAR(MAX)                          

 DECLARE @B_DATE VARCHAR(1000)                          

 SET @B_DATE = ''                          

                          

 SET @MAIN =''                          

                          

 SET @MAIN = @MAIN + ' SELECT B.REGION, B.BRANCH, B.SB, B.CATEGORY,CLI_TYPE, '                          

 SET @MAIN = @MAIN + ' B.SB_CATEGORY AS SBCAT,C.Party_code, '                          

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2), C.Balance) AS Effective_Balance, CONVERT(DECIMAL(15,2),C.Holding_BHC) AS Actual_holding_value, '                          

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2), C.Holding_AHC) AS Holding_after_haircut, CONVERT(DECIMAL(15,2), C.VarMarginShortFall_AftAdj) AS VarMarginShortFall_AftAdj, '      

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.VarMarginShortFall_AftAdjCurrDay) AS  VarMarginShortFall_AftAdjCurrDay,'                        

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSEFO_JV) AS  NSEFO_JV,'    

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSEFO_NonCash) AS  NSEFO_NonCash, '    

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.MCD_JV) AS  MCD_JV, '    

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.MCD_NonCash) AS  MCD_NonCash, '    

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSX_JV) AS  NSX_JV, '    

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSX_NonCash) AS  NSX_NonCash, '          

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.DP_adj) AS  DP_adj, '            

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2),C.LeverageMultiplier) AS Var_Shortage_Per, '                          

 SET @MAIN = @MAIN + ' C.noofdays as Square_off_Action,convert(varchar(11),C.updatedon,103) as updatedon,'                          

 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2),C.SquareOffValue) as SquareOffValue, '                          

 SET @MAIN = @MAIN + ' Actual_Cash_Square_Off_Done'                          

 SET @MAIN = @MAIN + ' INTO #FINAL '                          

 SET @MAIN = @MAIN + ' FROM vmss_data C WITH (NOLOCK) inner join general.dbo.VW_RMS_CLIENT_VERTICAL B WITH (NOLOCK) on  C.PARTY_CODE=B.CLIENT '                          

 SET @MAIN = @MAIN + ' INNER JOIN general.dbo.CLIENT_DETAILS CLI WITH (NOLOCK) ON B.CLIENT = CLI.PARTY_CODE '                          

                      

 if(CONVERT(VARCHAR(11),@ALERTDATE)=convert(varchar(11),GETDATE()))                    

 begin                    

 SET @MAIN = @MAIN + ' WHERE convert(varchar(11),c.processDate) = (select convert(VARCHAR(11),max(processDate)) from vmss_data)'                    

 end                     
 else                 

 begin        

 SET @MAIN = @MAIN + ' WHERE convert(varchar(11),c.processDate) = ''' +CONVERT(VARCHAR(11),@ALERTDATE)+ ''''                             

 end                   

                   

 IF @SQ_OFF_TYPE <> '%'                          

 BEGIN                   

 print 'byee'                           

 SET @MAIN = @MAIN + ' AND B.CLI_TYPE = ''' + @SQ_OFF_TYPE + ''' '                          

 END                 

                 

                

 --SET @MAIN = @MAIN + ' AND ABS(C.T_VALUE) > 100 and (holding+fo_Excoll+Curr_ExColl) > 100 and (FO_NET+Curr_NEt+T_Value) < 0 '                          

                           

 if @T_Day <> '%'                          

 begin                

 /* print 'hii'      */            

 if(@T_Day='4')              

 begin              

  SET @MAIN = @MAIN + ' AND C.NoofDays >= ' + @T_DAY              

 end              

 else               

 begin                

  SET @MAIN = @MAIN + ' AND C.NoofDays = ' + @T_DAY                           

end             

           

             

end                         

                          

 IF UPPER(@MOB) ='YES'                          

 SET @MAIN = @MAIN + ' AND LEN(RTRIM(LTRIM(CLI.MOBILE_PAGER))) <>0 '                     

                          

 IF UPPER(@MOB) ='NO'                          

 SET @MAIN = @MAIN + ' AND LEN(RTRIM(LTRIM(CLI.MOBILE_PAGER))) =0 '                          

                          

 IF UPPER(@MOB) ='ALL'                          

 SET @MAIN = @MAIN + ' '                          

                          

                          

 IF @ACCESSLEVEL ='REGION' AND @ACCESSCODE <> '%'                          

 SET @MAIN = @MAIN + ' AND B.REGION LIKE ''' + @ACCESSCODE +''''                          

 ELSE IF @ACCESSLEVEL = 'BRANCH' AND @ACCESSCODE <> '%'                          

 SET @MAIN = @MAIN + ' AND B.BRANCH LIKE ''' + @ACCESSCODE +''''                          

                          

 ELSE IF @ACCESSLEVEL = 'SB'                          

 SET @MAIN = @MAIN + ' AND B.SB LIKE ''' + @ACCESSCODE +''''                          

                          

 ELSE IF @ACCESSLEVEL = 'CLIENT'                          

 SET @MAIN = @MAIN + ' AND B.CLIENT LIKE ''' + @ACCESSCODE +''''                          

                          

 IF @ACCESS_TO = 'REGIONMAST'                          

 SET @MAIN = @MAIN + ' AND B.REGION IN (SELECT ACCESSCODE FROM general.dbo.TBL_RMS_GROUPMASTER WITH(NOLOCK) WHERE GROUPCODE= '''+@ACCESS_CODE+''') '                          

                          

 ELSE IF @ACCESS_TO = 'BRMAST'                          

 SET @MAIN = @MAIN + ' AND B.BRANCH IN (SELECT ACCESSCODE FROM general.dbo.TBL_RMS_GROUPMASTER WITH(NOLOCK) WHERE GROUPCODE= '''+@ACCESS_CODE+''') '                          

                          

 ELSE IF @access_to ='SBMAST'                          

 SET @Main = @Main + ' AND B.SB IN ( SELECT DISTINCT SUB_BROKER FROM general.dbo.SB_MASTER WITH(NOLOCK) WHERE SBMAST_CD='''+@access_code+''')'                          

                          

 ELSE IF @ACCESS_TO = 'BROKER'                          

 SET @MAIN = @MAIN + ' '                          

 ELSE IF @ACCESS_TO = 'BROKER'                                  

 SET @MAIN = @MAIN + ' '                                  

 ELSE                                  

 SET @MAIN = @MAIN + ' AND B.'+@ACCESS_TO+' LIKE '''+@ACCESS_CODE+''' '                                  

                        

 SET @MAIN = @MAIN + 'delete from #FINAL where SquareOffValue= 0'                          

                         

 -- SET @MAIN = @MAIN + 'update #FINAL set [Actual Cash Square Off Done]=null  where [Actual Cash Square Off Done]= 0'                

if( @T_DAY='4' or @T_DAY='%')              

 SET @MAIN = @MAIN + 'update #FINAL set  Square_off_Action=4 where Square_off_Action>=4'           

            

 SET @MAIN = @MAIN + ' SELECT REGION, BRANCH, SB, PARTY_CODE, CATEGORY, CLI_TYPE, SBCAT, Effective_Balance,Actual_holding_value, '                   

 SET @MAIN = @MAIN + ' Holding_after_haircut,(NSEFO_JV+NSEFO_NonCash+MCD_JV+MCD_NonCash+NSX_JV+NSX_NonCash+DP_adj) as Other_Adj,VarMarginShortFall_AftAdjCurrDay,VarMarginShortFall_AftAdj, '                          

 SET @MAIN = @MAIN + ' Var_Shortage_Per,SquareOffValue,updatedon,Actual_Cash_Square_Off_Done,Square_off_Action'                            

 SET @MAIN = @MAIN + ' FROM #FINAL ORDER BY SquareOffValue desc'                          

 PRINT (@MAIN)                          

 EXEC (@MAIN)                          

                          

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_RPT_VarMarginSqOff_hist
-- --------------------------------------------------
-- VMSS_RPT_VarMarginSqOff 'CLIENT','G22552','ALL','7','jun 23 2015','broker','cso','%'                          



-- VMSS_RPT_VarMarginSqOff '%','%','%','7','Aug 17 2015','REGION','%','%'                          



-- VMSS_RPT_VarMarginSqOff 'REGION','%','ALL','1','Aug 17 2015 ','broker','cso','all'                          



CREATE PROCEDURE [dbo].[VMSS_RPT_VarMarginSqOff_hist] -- 'region','southguj','all','7','Aug 17 2015','broker','cso','%'                          



@ACCESSLEVEL VARCHAR(20),                          



@ACCESSCODE VARCHAR(20),                          



@MOB VARCHAR(20),                          



@T_DAY VARCHAR(10),                          



@ALERTDATE DATETIME,                          



@ACCESS_TO VARCHAR(20),                          



@ACCESS_CODE VARCHAR(20),                          



@SQ_OFF_TYPE VARCHAR(20)                          



AS                          



BEGIN                          



                          



 IF @ACCESSCODE ='ALL'                        



 SET @ACCESSCODE =@ACCESS_CODE                          



                          



 IF @SQ_OFF_TYPE ='ALL'                          



 SET @SQ_OFF_TYPE ='%'                          



                          



 IF @T_Day ='ALL'                          



 SET @T_Day ='%'                          



                        



 DECLARE @MAIN VARCHAR(MAX)                          



 DECLARE @B_DATE VARCHAR(1000)                          



 SET @B_DATE = ''                          



                          



 SET @MAIN =''                          



                          



 SET @MAIN = @MAIN + ' SELECT B.REGION, B.BRANCH, B.SB, B.CATEGORY,CLI_TYPE, '                          



 SET @MAIN = @MAIN + ' B.SB_CATEGORY AS SBCAT,C.Party_code, '                          



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2), C.Balance) AS Effective_Balance, CONVERT(DECIMAL(15,2),C.Holding_BHC) AS Actual_holding_value, '                          



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2), C.Holding_AHC) AS Holding_after_haircut, CONVERT(DECIMAL(15,2), C.VarMarginShortFall_AftAdj) AS VarMarginShortFall_AftAdj, '      



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.VarMarginShortFall_AftAdjCurrDay) AS  VarMarginShortFall_AftAdjCurrDay,'                        



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSEFO_JV) AS  NSEFO_JV,'    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSEFO_NonCash) AS  NSEFO_NonCash, '    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.MCD_JV) AS  MCD_JV, '    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.MCD_NonCash) AS  MCD_NonCash, '    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSX_JV) AS  NSX_JV, '    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSX_NonCash) AS  NSX_NonCash, '          



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.DP_adj) AS  DP_adj, '            



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2),C.LeverageMultiplier) AS Var_Shortage_Per, '                          



 SET @MAIN = @MAIN + ' C.noofdays as Square_off_Action,convert(varchar(11),C.updatedon,103) as updatedon,'                          



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2),C.SquareOffValue) as SquareOffValue, '                          



 SET @MAIN = @MAIN + ' Actual_Cash_Square_Off_Done'                          



 SET @MAIN = @MAIN + ' INTO #FINAL '                          



 SET @MAIN = @MAIN + ' FROM vmss_data C WITH (NOLOCK) inner join general.dbo.VW_RMS_CLIENT_VERTICAL B WITH (NOLOCK) on  C.PARTY_CODE=B.CLIENT '                          



 SET @MAIN = @MAIN + ' INNER JOIN general.dbo.CLIENT_DETAILS CLI WITH (NOLOCK) ON B.CLIENT = CLI.PARTY_CODE '                          



                      



 if(CONVERT(VARCHAR(11),@ALERTDATE)=convert(varchar(11),GETDATE()))                    



 begin                    



 SET @MAIN = @MAIN + ' WHERE convert(varchar(11),c.processDate) = (select convert(VARCHAR(11),max(processDate)) from vmss_data)'                    



 end                     

 else                 



 begin        



 SET @MAIN = @MAIN + ' WHERE convert(varchar(11),c.processDate) = ''' +CONVERT(VARCHAR(11),@ALERTDATE)+ ''''                             



 end                   



                   



 IF @SQ_OFF_TYPE <> '%'                          



 BEGIN                   



 print 'byee'                           



 SET @MAIN = @MAIN + ' AND B.CLI_TYPE = ''' + @SQ_OFF_TYPE + ''' '                          



 END                 
 --SET @MAIN = @MAIN + ' AND ABS(C.T_VALUE) > 100 and (holding+fo_Excoll+Curr_ExColl) > 100 and (FO_NET+Curr_NEt+T_Value) < 0 '                          
 if @T_Day <> '%'                          
begin                
	  if(@T_Day='4')              
   begin              
     SET @MAIN = @MAIN + ' AND C.NoofDays >= ' + @T_DAY              
   end                         
end   

 if (@T_Day = '%' or @T_Day<>'4')                                         
   begin                
     SET @MAIN = @MAIN + ' AND C.NoofDays = ' + @T_DAY                           
   end             

 IF UPPER(@MOB) ='YES'                          



 SET @MAIN = @MAIN + ' AND LEN(RTRIM(LTRIM(CLI.MOBILE_PAGER))) <>0 '                     



                          



 IF UPPER(@MOB) ='NO'                          



 SET @MAIN = @MAIN + ' AND LEN(RTRIM(LTRIM(CLI.MOBILE_PAGER))) =0 '                          



                          



 IF UPPER(@MOB) ='ALL'                          



 SET @MAIN = @MAIN + ' '                          



                          



                          



 IF @ACCESSLEVEL ='REGION' AND @ACCESSCODE <> '%'                          



 SET @MAIN = @MAIN + ' AND B.REGION LIKE ''' + @ACCESSCODE +''''                          



 ELSE IF @ACCESSLEVEL = 'BRANCH' AND @ACCESSCODE <> '%'                          



 SET @MAIN = @MAIN + ' AND B.BRANCH LIKE ''' + @ACCESSCODE +''''                          



                          



 ELSE IF @ACCESSLEVEL = 'SB'                          



 SET @MAIN = @MAIN + ' AND B.SB LIKE ''' + @ACCESSCODE +''''                          



                          



 ELSE IF @ACCESSLEVEL = 'CLIENT'                          



 SET @MAIN = @MAIN + ' AND B.CLIENT LIKE ''' + @ACCESSCODE +''''                          



                          



 IF @ACCESS_TO = 'REGIONMAST'                          



 SET @MAIN = @MAIN + ' AND B.REGION IN (SELECT ACCESSCODE FROM general.dbo.TBL_RMS_GROUPMASTER WITH(NOLOCK) WHERE GROUPCODE= '''+@ACCESS_CODE+''') '                          



                          



 ELSE IF @ACCESS_TO = 'BRMAST'                          



 SET @MAIN = @MAIN + ' AND B.BRANCH IN (SELECT ACCESSCODE FROM general.dbo.TBL_RMS_GROUPMASTER WITH(NOLOCK) WHERE GROUPCODE= '''+@ACCESS_CODE+''') '                          



                          



 ELSE IF @access_to ='SBMAST'                          



 SET @Main = @Main + ' AND B.SB IN ( SELECT DISTINCT SUB_BROKER FROM general.dbo.SB_MASTER WITH(NOLOCK) WHERE SBMAST_CD='''+@access_code+''')'                          



                          



 ELSE IF @ACCESS_TO = 'BROKER'                          



 SET @MAIN = @MAIN + ' '                          



 ELSE IF @ACCESS_TO = 'BROKER'                                  



 SET @MAIN = @MAIN + ' '                                  



 ELSE                                  



 SET @MAIN = @MAIN + ' AND B.'+@ACCESS_TO+' LIKE '''+@ACCESS_CODE+''' '                                  



                        



 SET @MAIN = @MAIN + 'delete from #FINAL where SquareOffValue= 0'                          



                         



 -- SET @MAIN = @MAIN + 'update #FINAL set [Actual Cash Square Off Done]=null  where [Actual Cash Square Off Done]= 0'                



if( @T_DAY='4' or @T_DAY='%')              



 SET @MAIN = @MAIN + 'update #FINAL set  Square_off_Action=4 where Square_off_Action>=4'           



            



 SET @MAIN = @MAIN + ' SELECT REGION, BRANCH, SB, PARTY_CODE, CATEGORY, CLI_TYPE, SBCAT, Effective_Balance,Actual_holding_value, '                   



 SET @MAIN = @MAIN + ' Holding_after_haircut,(NSEFO_JV+NSEFO_NonCash+MCD_JV+MCD_NonCash+NSX_JV+NSX_NonCash+DP_adj) as Other_Adj,VarMarginShortFall_AftAdjCurrDay,VarMarginShortFall_AftAdj, '                          



 SET @MAIN = @MAIN + ' Var_Shortage_Per,SquareOffValue,updatedon,Actual_Cash_Square_Off_Done,Square_off_Action'                            



 SET @MAIN = @MAIN + ' FROM #FINAL ORDER BY SquareOffValue desc'                          



 PRINT (@MAIN)                          



 EXEC (@MAIN)                          



                          



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_RPT_VarMarginSqOff_hist_Dec03 2015
-- --------------------------------------------------
-- VMSS_RPT_VarMarginSqOff 'CLIENT','G22552','ALL','7','jun 23 2015','broker','cso','%'                          



-- VMSS_RPT_VarMarginSqOff '%','%','%','7','Aug 17 2015','REGION','%','%'                          



-- VMSS_RPT_VarMarginSqOff 'REGION','%','ALL','All','12/2/2015 12:00:00 AM','broker','cso','all'                          

-- VMSS_RPT_VarMarginSqOff 'REGION','%','ALL','All','12/3/2015 12:00:00 AM','broker','cso','all'    

create PROCEDURE [dbo].[VMSS_RPT_VarMarginSqOff_hist_Dec03 2015] --'CLIENT','H690','all','3','dec 2 2015','broker','cso','%'                          



@ACCESSLEVEL VARCHAR(20),                          



@ACCESSCODE VARCHAR(20),                          



@MOB VARCHAR(20),                          



@T_DAY VARCHAR(10),                          



@ALERTDATE datetime,                          



@ACCESS_TO VARCHAR(20),                          



@ACCESS_CODE VARCHAR(20),                          



@SQ_OFF_TYPE VARCHAR(20)                          



AS                          



BEGIN                          



                          



 IF @ACCESSCODE ='ALL'                        



 SET @ACCESSCODE =@ACCESS_CODE                          



                          



 IF @SQ_OFF_TYPE ='ALL'                          



 SET @SQ_OFF_TYPE ='%'                          



                          



 IF @T_Day ='ALL'                          



 SET @T_Day ='%'                          



                        



 DECLARE @MAIN VARCHAR(MAX)                          



 DECLARE @B_DATE VARCHAR(1000)                          



 SET @B_DATE = ''                          



                          



 SET @MAIN =''                          



                          



 SET @MAIN = @MAIN + ' SELECT B.REGION, B.BRANCH, B.SB, B.CATEGORY,CLI_TYPE, '                          



 SET @MAIN = @MAIN + ' B.SB_CATEGORY AS SBCAT,C.Party_code, '                          



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2), C.Balance) AS Effective_Balance, CONVERT(DECIMAL(15,2),C.Holding_BHC) AS Actual_holding_value, '                          



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2), C.Holding_AHC) AS Holding_after_haircut, CONVERT(DECIMAL(15,2), C.VarMarginShortFall_AftAdj) AS VarMarginShortFall_AftAdj, '      



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.VarMarginShortFall_AftAdjCurrDay) AS  VarMarginShortFall_AftAdjCurrDay,'                        



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSEFO_JV) AS  NSEFO_JV,'    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSEFO_NonCash) AS  NSEFO_NonCash, '    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.MCD_JV) AS  MCD_JV, '    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.MCD_NonCash) AS  MCD_NonCash, '    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSX_JV) AS  NSX_JV, '    



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.NSX_NonCash) AS  NSX_NonCash, '          



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15, 2), C.DP_adj) AS  DP_adj, '            



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2),C.LeverageMultiplier) AS Var_Shortage_Per, '                          



 SET @MAIN = @MAIN + ' C.noofdays as Square_off_Action,convert(varchar(11),C.updatedon,103) as updatedon,'                          



 SET @MAIN = @MAIN + ' CONVERT(DECIMAL(15,2),C.SquareOffValue) as SquareOffValue, '                          



 SET @MAIN = @MAIN + ' Actual_Cash_Square_Off_Done'                          



 SET @MAIN = @MAIN + ' INTO #FINAL '                          



 SET @MAIN = @MAIN + ' FROM vmss_data C WITH (NOLOCK) inner join general.dbo.VW_RMS_CLIENT_VERTICAL B WITH (NOLOCK) on  C.PARTY_CODE=B.CLIENT '                          



 SET @MAIN = @MAIN + ' INNER JOIN general.dbo.CLIENT_DETAILS CLI WITH (NOLOCK) ON B.CLIENT = CLI.PARTY_CODE '                          



                      



 if(cast(@ALERTDATE as date))=convert(varchar(11),GETDATE())                   



 begin                    



 SET @MAIN = @MAIN + ' WHERE convert(varchar(11),c.updatedon) = (select convert(VARCHAR(11),max(updatedon)) from vmss_data)'                    

	print 'current'

 end                     

 else                 



 begin        

	print 'history'

 SET @MAIN = @MAIN + ' WHERE convert(varchar(11),cast(c.updatedon as date)) = ''' +CONVERT(VARCHAR(11),cast(@ALERTDATE as date))+ ''''                             



 end                   



                   



 IF @SQ_OFF_TYPE <> '%'                          



 BEGIN                   



 print 'byee'                           



 SET @MAIN = @MAIN + ' AND B.CLI_TYPE = ''' + @SQ_OFF_TYPE + ''' '                          



 END                 
 --SET @MAIN = @MAIN + ' AND ABS(C.T_VALUE) > 100 and (holding+fo_Excoll+Curr_ExColl) > 100 and (FO_NET+Curr_NEt+T_Value) < 0 '                          
 if @T_Day <> '%'                          
begin                
	  if(@T_Day='4')              
   begin              
     SET @MAIN = @MAIN + ' AND C.NoofDays >= ' + @T_DAY   
					           
   end                         
end   

 if (@T_Day = '%' or @T_Day<>'4')                                         
   begin 
	    set @T_Day=1               
     SET @MAIN = @MAIN + ' AND C.NoofDays >= ' + @T_DAY
			end             

 IF UPPER(@MOB) ='YES'                          

 SET @MAIN = @MAIN + ' AND LEN(RTRIM(LTRIM(CLI.MOBILE_PAGER))) <>0 '                     

 IF UPPER(@MOB) ='NO'                          

 SET @MAIN = @MAIN + ' AND LEN(RTRIM(LTRIM(CLI.MOBILE_PAGER))) =0 '                          

 IF UPPER(@MOB) ='ALL'                          

 SET @MAIN = @MAIN + ' '                          

	
 IF @ACCESSLEVEL ='REGION' AND @ACCESSCODE <> '%'                          



 SET @MAIN = @MAIN + ' AND B.REGION LIKE ''' + @ACCESSCODE + ''''                          



 ELSE IF @ACCESSLEVEL = 'BRANCH' AND @ACCESSCODE <> '%'                          



 SET @MAIN = @MAIN + ' AND B.BRANCH LIKE ''' + @ACCESSCODE +''''                          


 ELSE IF @ACCESSLEVEL = 'SB'                          


 SET @MAIN = @MAIN + ' AND B.SB LIKE ''' + @ACCESSCODE +''''                          


 ELSE IF @ACCESSLEVEL = 'CLIENT'                          



 SET @MAIN = @MAIN + ' AND B.CLIENT LIKE ''' + @ACCESSCODE +''''                          

 IF @ACCESS_TO = 'REGIONMAST'                          



 SET @MAIN = @MAIN + ' AND B.REGION IN (SELECT ACCESSCODE FROM general.dbo.TBL_RMS_GROUPMASTER WITH(NOLOCK) WHERE GROUPCODE= '''+@ACCESS_CODE+''') '                          



                          



 ELSE IF @ACCESS_TO = 'BRMAST'                          



 SET @MAIN = @MAIN + ' AND B.BRANCH IN (SELECT ACCESSCODE FROM general.dbo.TBL_RMS_GROUPMASTER WITH(NOLOCK) WHERE GROUPCODE= '''+@ACCESS_CODE+''') '                          



                          



 ELSE IF @access_to ='SBMAST'                          



 SET @Main = @Main + ' AND B.SB IN ( SELECT DISTINCT SUB_BROKER FROM general.dbo.SB_MASTER WITH(NOLOCK) WHERE SBMAST_CD='''+@access_code+''')'                          



                          



 ELSE IF @ACCESS_TO = 'BROKER'                          



 SET @MAIN = @MAIN + ' '                          



 ELSE IF @ACCESS_TO = 'BROKER'                                  



 SET @MAIN = @MAIN + ' '                                  



 ELSE                                  



 SET @MAIN = @MAIN + ' AND B.'+@ACCESS_TO+' LIKE '''+@ACCESS_CODE+''' '                                  


 -- SET @MAIN = @MAIN + 'update #FINAL set [Actual Cash Square Off Done]=null  where [Actual Cash Square Off Done]= 0'                



if( @T_DAY='4' or @T_DAY='%')              




	
	SET @MAIN = @MAIN + 'delete from #FINAL where SquareOffValue= 0 '          
	SET @MAIN = @MAIN + ' update #FINAL set  Square_off_Action=4 where Square_off_Action>=4'  
 SET @MAIN = @MAIN + 'SELECT REGION, BRANCH, SB, PARTY_CODE, CATEGORY, CLI_TYPE, SBCAT, Effective_Balance,Actual_holding_value, '                   



 SET @MAIN = @MAIN + ' Holding_after_haircut,(NSEFO_JV+NSEFO_NonCash+MCD_JV+MCD_NonCash+NSX_JV+NSX_NonCash+DP_adj) as Other_Adj,VarMarginShortFall_AftAdjCurrDay,VarMarginShortFall_AftAdj, '                          



 SET @MAIN = @MAIN + ' Var_Shortage_Per,SquareOffValue,updatedon,Actual_Cash_Square_Off_Done,Square_off_Action'                            



 SET @MAIN = @MAIN + ' FROM #FINAL ORDER BY SquareOffValue desc'                          

	


 PRINT (@MAIN)                          



 EXEC (@MAIN)                          



                          



END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_RPT_VarMarginSqOff_MIMANSA
-- --------------------------------------------------

-- exec VMSS_RPT_VarMarginSqOff 'CLIENT','AJMR2933','ALL','All','06/29/2016 12:00:00 AM','broker','cso','all'  
-- exec [VMSS_RPT_VarMarginSqOff_MIMANSA] 'AJMR2933','All'
 
CREATE PROCEDURE [dbo].[VMSS_RPT_VarMarginSqOff_MIMANSA]                                   
@ACCESSCODE VARCHAR(20),                                                   
@T_DAY VARCHAR(10)                                                                                                                      
AS                          
BEGIN                          
                                           
	IF @T_Day ='ALL'  
	Begin                                
		SET @T_Day=1   
	End               

	SELECT B.REGION, B.BRANCH, B.SB, B.CATEGORY,CLI_TYPE,
	B.SB_CATEGORY AS SBCAT,C.Party_code,                 
	CONVERT(DECIMAL(15,2), C.Balance) AS Effective_Balance, CONVERT(DECIMAL(15,2),C.Holding_BHC) AS Actual_holding_value,
	CONVERT(DECIMAL(15,2), C.Holding_AHC) AS Holding_after_haircut, CONVERT(DECIMAL(15,2), C.VarMarginShortFall_AftAdj) AS VarMarginShortFall_AftAdj,     
	CONVERT(DECIMAL(15, 2), C.VarMarginShortFall_AftAdjCurrDay) AS  VarMarginShortFall_AftAdjCurrDay,
	CONVERT(DECIMAL(15, 2), C.NSEFO_JV) AS  NSEFO_JV,
	CONVERT(DECIMAL(15, 2), C.NSEFO_NonCash) AS  NSEFO_NonCash,
	CONVERT(DECIMAL(15, 2), C.MCD_JV) AS  MCD_JV,
	CONVERT(DECIMAL(15, 2), C.MCD_NonCash) AS  MCD_NonCash,
	CONVERT(DECIMAL(15, 2), C.NSX_JV) AS  NSX_JV,
	CONVERT(DECIMAL(15, 2), C.NSX_NonCash) AS  NSX_NonCash,              
	CONVERT(DECIMAL(15, 2), C.DP_adj) AS  DP_adj,
	CONVERT(DECIMAL(15,2),C.LeverageMultiplier) AS Var_Shortage_Per,
	C.noofdays as Square_off_Action,convert(varchar(11),C.updatedon,103) as updatedon,
	CONVERT(DECIMAL(15,2),C.SquareOffValue) as SquareOffValue,
	Actual_Cash_Square_Off_Done
	INTO #FINAL
	FROM vmss_data C WITH (NOLOCK) inner join general.dbo.VW_RMS_CLIENT_VERTICAL B WITH (NOLOCK) on  C.PARTY_CODE=B.CLIENT
	INNER JOIN general.dbo.CLIENT_DETAILS CLI WITH (NOLOCK) ON B.CLIENT = CLI.PARTY_CODE
	where B.CLIENT LIKE @ACCESSCODE       
	and convert(varchar(11),c.updatedon) = (select convert(VARCHAR(11),max(updatedon)) from vmss_data)   
	AND C.NoofDays >= @T_DAY                  
  
	update #FINAL set  Square_off_Action=4 where Square_off_Action>=4                            

	SELECT REGION, BRANCH, SB, PARTY_CODE, CATEGORY, CLI_TYPE, SBCAT, Effective_Balance,Actual_holding_value, 
	Holding_after_haircut,(NSEFO_JV+NSEFO_NonCash+MCD_JV+MCD_NonCash+NSX_JV+NSX_NonCash+DP_adj) as Other_Adj,
	VarMarginShortFall_AftAdjCurrDay,VarMarginShortFall_AftAdj,
	Var_Shortage_Per,SquareOffValue,updatedon,Actual_Cash_Square_Off_Done,Square_off_Action
	FROM #FINAL ORDER BY SquareOffValue desc

                         

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_SqoFF_SMS
-- --------------------------------------------------
          
--VMSS_SqoFF_SMS 0             
                       
CREATE proc [dbo].[VMSS_SqoFF_SMS]                                            
@Day int,                                            
@system varchar(50) = 'System'                                            
as                                            
begin                                            
begin try                                            
                                            
 --drop table #AlertClientList                                            
 --declare @Day int                                            
 --set @day = 5                                            
                                                   
 declare @dt varchar(10) --for sq off SMS in date.            
             
 if (@Day=0)            
 begin            
  SELECT NS.Party_code,                                            
  /*PRMS 10391125 : Change in amount in SMS for ageing square off*/                                            
  /*abs(sq_amt) as sq_amt,*/                                            
  ABS(NS.SquareOffValue) as sq_amt,                                         
  ABS(NS.VarMarginShortFall_AftAdj) as Margin_Shortage,                                        
  COALESCE(cd.Mobile_pager, cd.res_phone1,cd.res_phone2) as Mobile_pager                                            
  into #AlertClientDailySMS                                            
  FROM VMSS_DATA NS WITH (NOLOCK)                                            
  inner JOIN general.dbo.CLIENT_DETAILS CD WITH (NOLOCK) ON NS.Party_code=CD.PARTY_CODE                                                               
  where CONVERT(VARCHAR(10),NS.updatedon, 120) = CONVERT(VARCHAR(10), GETDATE(), 120)                                                           
  --AND abs(ASB.t_value) > 500                 
  and ISNULL(NS.SquareOffValue,0) <> 0              
  and ISNULL(NS.VarMarginShortFall_AftAdj,0) <> 0                                           
  AND general.dbo.validate_mobile(COALESCE(cd.Mobile_pager,cd.res_phone1,cd.res_phone2)) = 'VALID'            
              
  select smscount=COUNT(*) from #AlertClientDailySMS            
 end            
                                             
 else if( @Day in (5,6))                
 begin                                          
  SELECT NS.Party_code,                                            
  /*PRMS 10391125 : Change in amount in SMS for ageing square off*/                                            
  /*abs(sq_amt) as sq_amt,*/                                            
  ABS(NS.SquareOffValue) as sq_amt,                                         
  ABS(NS.VarMarginShortFall_AftAdj) as Margin_Shortage,                                        
  COALESCE(cd.Mobile_pager, cd.res_phone1,cd.res_phone2) as Mobile_pager                                            
  into #AlertClientList                                            
  FROM VMSS_DATA NS WITH (NOLOCK)                                            
  inner JOIN general.dbo.CLIENT_DETAILS CD WITH (NOLOCK) ON NS.Party_code=CD.PARTY_CODE                                                               
  where CONVERT(VARCHAR(10),NS.updatedon, 120) = CONVERT(VARCHAR(10), GETDATE(), 120)                                            
  AND NS.NoofDays=@Day                                    
  --AND abs(ASB.t_value) > 500                 
  and ISNULL(NS.SquareOffValue,0) <> 0                                            
  AND general.dbo.validate_mobile(COALESCE(cd.Mobile_pager,cd.res_phone1,cd.res_phone2)) = 'VALID'                 
 end                
                 
 else                
 begin                
     SELECT NS.Party_code,                                            
  /*PRMS 10391125 : Change in amount in SMS for ageing square off*/                              
  /*abs(sq_amt) as sq_amt,*/                                            
  ABS(NS.SquareOffValue) as sq_amt,                    
  ABS(NS.VarMarginShortFall_AftAdj) as Margin_Shortage,                                        
  COALESCE(cd.Mobile_pager, cd.res_phone1,cd.res_phone2) as Mobile_pager                                            
  into #AlertClientList1                                            
  FROM VMSS_DATA NS WITH (NOLOCK)                                            
 inner JOIN general.dbo.CLIENT_DETAILS CD WITH (NOLOCK) ON NS.Party_code=CD.PARTY_CODE                      
  where CONVERT(VARCHAR(10),NS.updatedon, 120) = CONVERT(VARCHAR(10), GETDATE(), 120)               
  AND NS.NoofDays>=@Day                                  
  --AND abs(ASB.t_value) > 500                 
  and ISNULL(NS.SquareOffValue,0) <> 0                                            
  AND general.dbo.validate_mobile(COALESCE(cd.Mobile_pager,cd.res_phone1,cd.res_phone2)) = 'VALID'                 
 end                
                                            
                                             
 /*END Changes for optimization*/                                            
 --fetch sq off date according to @day            
 if(@Day=0)            
 begin            
   select NS.Party_code,'Dear Customer, kindly clear Var Margin shortage of  Rs. '+cast(NS.Margin_Shortage as varchar)+ ' in your A/C ' +LTRIM(RTRIM(NS.Party_code))                                                                         
   +'  for '+ cast(convert(varchar,GETDATE(),105)as varchar) + ' .Please ignore if already paid.' as txt                                            
   into #DailySMS                                            
   from #AlertClientDailySMS NS                                            
                                             
   INSERT into general.dbo.SqqOff_Margin_Shortage_MsgLog (Party_Code, Msg_Type, Msg_For, SMS_Content, MobileNo, Msg_By, Msg_Date,SQ_OFF_TYPE)                                        
   select NS.Party_code, 'S', 'VMSSDaily T'+convert(varchar,@day), b.txt,Mobile_pager,@system, getdate(), 'VMSSDaily'                                            
   from #AlertClientDailySMS NS                                            
   join #DailySMS b                                            
   on NS.Party_code = b.Party_code                                 /*----ADD NEW LINE FOR PRMS ID:10391204*/                                            
   WHERE ns.Party_code NOT IN (SELECT DISTINCT Party_code FROM  vMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP WHERE EXCEPTION ='Y')                                            
                                               
                                             
   insert into intranet.sms.dbo.sms                                            
   select Mobile_pager, b.txt, convert(varchar(10), getdate(), 103),                                            
   ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':' + ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))),                                            
   'P', case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end, 'Daily_VMSS'                                     
   from #AlertClientDailySMS NS                                             
   join #DailySMS b                                            
   on NS.Party_code =b.Party_code                                            
    /*----ADD NEW LINE FOR PRMS ID:10391204*/                                            
                                          
                                          
   union all                                            
                                             
   SELECT A.MOBILE, b.*                                            
   FROM (                                
   select TOP 1 b1.txt,                                            
   convert(varchar(10), getdate(), 103) DT,ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':' +                                            
   ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))) DT1,'P' [STATUS],                                            
   case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end [TIME],'Daily_VMSS' AS FLG                                  
   from #AlertClientDailySMS NS                                            
   join #DailySMS b1                                            
   on NS.Party_code = b1.Party_code                       
    /*----ADD NEW LINE FOR PRMS ID:10391204*/                                                                      
   ) B , (SELECT DISTINCT MOBILE FROM TBL_USEREMAILID WHERE MODULE IN ('T7') AND SENDSMS=1) A                                            
  end                                        
                                       
 else if @Day in (5,6)                                            
 begin                                                
  if @Day = 6                                            
  begin                                   
   select top 1 @dt = isnull(convert(varchar(10), a.Start_Date , 103),'')              
   from general.dbo.bse_sett_mst a                                            
   where CONVERT(VARCHAR(10),a.start_Date,121) > CONVERT(VARCHAR(10),getdate(),121)                                            
   and datepart(dw,a.start_Date) <> 7  --exclude saturday                                            
   and datepart(dw,a.start_Date) <> 1 --exclude sunday                                            
   group by Start_Date                                            
   ORDER BY a.start_Date                                            
                                           
                                           
   select NS.Party_code, 'Dear Customer, kindly clear VaR margin shortage(for 6th consecutive time) in your A/C '+LTRIM(RTRIM(NS.Party_code))                
   +' to avoid liquidation on. '+ isnull(@dt, '') +  ' Please ignore if already paid.' as SMS                                            
   into #T6SMS                                            
   from #AlertClientList NS                                            
                                           
                                        
   INSERT into general.dbo.SqqOff_Margin_Shortage_MsgLog                                             
  (Party_Code, Msg_Type, Msg_For, SMS_Content, MobileNo, Msg_By, Msg_Date,SQ_OFF_TYPE)                                            
   select b.Party_code, 'S', 'VMSS T'+convert(varchar,@day), b.SMS ,Mobile_pager, @system, getdate(),'VMSS6'                                            
   from #AlertClientList NS                                            
   join #T6SMS b                                            
   on NS.Party_code=b.Party_code                                           
                                            
   insert into intranet.sms.dbo.sms                                            
   select Mobile_pager, b.SMS, convert(varchar(10), getdate(), 103),                                            
   ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':' + ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))),                                            
   'P', case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end, 'VMSS_6'                                            
   from #AlertClientList NS                                            
   join #T6SMS b                                            
   on NS.Party_code = b.Party_code                           
                         
   union all                                            
   --for triggering SMS to users                                            
   --SELECT top 1 '9820701602' as MOBILE, b.*                                            
   SELECT a.MOBILE, b.*                                            
   FROM (                                            
   select TOP 1 b1.SMS, convert(varchar(10), getdate(), 103) DT,ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':' +                                            
   ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))) DT1,'P' [STATUS],                                            
   case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end [TIME], 'VMSS_6' AS FLG                                            
   from #AlertClientList NS                                            
   join #T6SMS b1                                            
   on NS.Party_code = b1.Party_code                                           
   ) B , (SELECT DISTINCT MOBILE FROM TBL_USEREMAILID WHERE MODULE IN('T6') AND SENDSMS=1) A                                            
                                               
  end                                            
  else if @day = 5                                            
  begin                                      
    if((DATEPART(DW,GETDATE())= 6))        
   begin                                
    select top 1 @dt = isnull(convert(varchar(10), b.Start_Date , 103),'')                                               
    from                                               
    (                                              
  select top 2 a.Start_Date from general.dbo.bse_sett_mst a                                              
  where CONVERT(VARCHAR(10),a.start_Date,121) > CONVERT(VARCHAR(10),getdate()+1,121)                                               
  and datepart(dw,a.start_Date) <> 7  --exclude saturday                                              
  and datepart(dw,a.start_Date) <> 1 --exclude sunday                                
  group by Start_Date                                               
  ORDER BY a.start_Date                                               
    ) b                                              
       order by Start_Date desc                                              
   end           
                                              
   else                                       
   begin                                              
    select top 1 @dt = isnull(convert(varchar(10), a.Start_Date , 103),'')                                              
    from general.dbo.bse_sett_mst a                                              
    where CONVERT(VARCHAR(10),a.start_Date,121) > CONVERT(VARCHAR(10),getdate()+1,121)                                              
    and datepart(dw,a.start_Date) <> 7  --exclude saturday                                              
    and datepart(dw,a.start_Date) <> 1 --exclude sunday                                              
    group by Start_Date                                              
    ORDER BY a.start_Date                                              
   end                                            
                       
                                           
     --Dear Client, there is a margin shortage in your A/c (XXXX) consecutively for 6th time. Pls clear shortage to avoid liquidation on 19/03/2015. Ignore if paid                                         
   select NS.Party_code, 'Dear Customer, kindly clear VaR margin shortage (for 5th consecutive time) in your A/C '+LTRIM(RTRIM(NS.Party_code))+' to avoid liquidation on' + ' '+                                           
   isnull(@dt, '') + ' '+ 'Please ignore if already paid.' as SMS                                            
  into #T5SMS                                            
   from #AlertClientList NS                                            
                                               
   INSERT into general.dbo.SqqOff_Margin_Shortage_MsgLog                                             
   (Party_Code, Msg_Type, Msg_For, SMS_Content, MobileNo, Msg_By, Msg_Date,SQ_OFF_TYPE)                                            
   select NS.Party_code, 'S', 'VMSS T'+convert(varchar,@day), b.SMS ,Mobile_pager, @system, getdate(),'VMSS5'                                            
   from #AlertClientList NS                                            
   join #T5SMS b                                            
   on NS.Party_code =b.Party_code                                            
                                           
   insert into intranet.sms.dbo.sms                                            
   select Mobile_pager, b.SMS, convert(varchar(10), getdate(), 103),                                            
   ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':' + ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))),                                            
   'P', case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end, 'VMSS_5'                                      
   from #AlertClientList NS                                            
   join #T5SMS b                                            
   on NS.Party_code =b.Party_code                                             
   union all                                            
   --for triggering SMS to users                                            
   SELECT A.MOBILE, b.*                                       
   --SELECT top 1 '9820701602' as MOBILE, b.*                                            
   FROM (                                            
   select TOP 1 b1.SMS, convert(varchar(10), getdate(), 103) DT,ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':' +                                            
   ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))) DT1,'P' [STATUS],                                            
   case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end [TIME], 'VMSS_5' AS FLG                                            
   from #AlertClientList NS                                            
   join #T5SMS b1                                            
   on NS.Party_code =b1.Party_code                                               
   ) B , (SELECT DISTINCT MOBILE FROM general.dbo.TBL_USEREMAILID with(nolock) WHERE MODULE IN('T5') AND SENDSMS=1) A                                            
  end                                            
 end                                            
 else if @Day = 7                                            
 begin                                            
                                            
  select NS.Party_code,'Dear Customer, VaR margin shortage for A/C '+LTRIM(RTRIM(NS.Party_code))                                            
  +',  margin shortage Rs' +cast(NS.Margin_Shortage as varchar)+                                            
  +'  as on  ' + cast(convert(varchar,GETDATE(),105)as varchar) +' overdue. Your shares worth Rs.'+cast(NS.sq_amt as varchar)+' will be sold today.' as txt                                            
  into #T7SMS                                            
  from #AlertClientList1 NS                                            
                                            
  INSERT into general.dbo.SqqOff_Margin_Shortage_MsgLog(Party_Code, Msg_Type, Msg_For, SMS_Content, MobileNo, Msg_By, Msg_Date,SQ_OFF_TYPE)                                        
  select NS.Party_code, 'S', 'VMSS T '+convert(varchar,@day), b.txt,Mobile_pager,@system, getdate(), 'VMSS7'                                            
  from #AlertClientList1 NS                                            
  join #T7SMS b                                            
  on NS.Party_code = b.Party_code                                 /*----ADD NEW LINE FOR PRMS ID:10391204*/                                            
  WHERE ns.Party_code NOT IN (SELECT DISTINCT Party_code FROM  vMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP WHERE EXCEPTION ='Y')                                            
                                              
                                            
  insert into intranet.sms.dbo.sms                                            
  select Mobile_pager, b.txt, convert(varchar(10), getdate(), 103),                                            
  ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':' + ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))),                                            
  'P', case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end,'VMSS_7'         
  from #AlertClientList1 NS                                             
  join #T7SMS b                                            
  on NS.Party_code =b.Party_code                                            
   /*----ADD NEW LINE FOR PRMS ID:10391204*/                                            
  WHERE ns.Party_code NOT IN (SELECT DISTINCT Party_code FROM  vMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP WHERE EXCEPTION ='Y')                                            
             
  union all                                            
                                            
  SELECT A.MOBILE, b.*                                            
  FROM (                                            
  select TOP 1 b1.txt,                                            
  convert(varchar(10), getdate(), 103) DT,ltrim(rtrim(str(datepart(hh, dateadd(minute, 15, getdate()))))) +':' +                                            
  ltrim(rtrim(str(datepart(minute, dateadd(minute, 15, getdate()))))) DT1,'P' [STATUS],                                            
  case when (datepart(hh, dateadd(minute, 15, getdate()))) >= 12 then 'PM' else 'AM' end [TIME],'VMSS_7' AS FLG                                            
  from #AlertClientList1 NS                                            
  join #T7SMS b1                                            
  on NS.Party_code = b1.Party_code                                            
   /*----ADD NEW LINE FOR PRMS ID:10391204*/                                            
  WHERE NS.Party_code NOT IN (SELECT DISTINCT Party_code FROM  vMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP WHERE EXCEPTION ='Y')                                            
  ) B , (SELECT DISTINCT MOBILE FROM general.dbo.TBL_USEREMAILID with (nolock) WHERE MODULE IN ('T7') AND SENDSMS=1) A                                            
 end                                            
 /* FOR T+6 MAIL*/                                            
 --EXEC general.dbo.USP_SQUP_MAILALERT_NBFC_Shortage @Day                                            
end try                                            
begin catch                                            
 insert into EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                            
 select GETDATE(),'VMSS_SMS',ERROR_LINE(),ERROR_MESSAGE()                                            
                                            
 DECLARE @ErrorMessage NVARCHAR(4000);                                            
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                            
 RAISERROR (@ErrorMessage , 16, 1);                                  
 end catch;                                            
end

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_SqOffAmtCalculation
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_SqOffAmtCalculation]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY                                                                                    
  update VMSS_HOLDING set isin=b.isin from General.dbo.scrip_master b where VMSS_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update VMSS_HOLDING set isin=b.isin from General.dbo.scrip_master b where VMSS_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))                                  
  select * into #SQC_file2 from vmss_Data where processdate = @tdate                                                
  update VMSS_data set SquareOffValue=0 where processdate = @tdate                                   
    
  select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #SQC_filex from #SQC_file2 
  where VarMarginShortFall_AftAdjCurrDay < 0 /*and NoofDays > 0*/--commented to calculate square off for all clients as required in PRMS 10391296                                       
  
  select * into #vmss_holding from VMSS_holding_SQOFF_format where 1=2  
  
  Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                  
  declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                  
  select @totctr=MAX(srno) from #SQC_filex                                                  
  
 While @ctr <= @totctr                                                  
 Begin                                                  
     set @SqOffVal=0                                                  
     select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdjCurrDay*-1 from #SQC_filex where srno=@ctr      
                                            
     /* Adjust -ve Holding - START : added on 29-12-2015 */  
  
     truncate table #vmss_holding  
      
     insert into #vmss_holding   
     select ROW_NUMBER() OVER ( ORDER BY scrip_cd,Qty ,sett_no) AS [SrNo],  
     (Case when SRC in ('D','SI') then 1 else 0 end) as UnsettCode,party_code,VAHC,              
     ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Qty,CLSRATE,VBHC,HAIRCUT,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt                
     from vmss_holding where party_code=@pcode and Clsrate > 0   
      
     update #vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0   
     declare @a_tctr as int = 0,@a_ctr as int = 1,@nhold as int =0,@scode as varchar(10)='',@adjQty as int = 0  
     select @a_tctr=MAX(srno) from #vmss_holding   
  
	 IF (SELECT COUNT(1) FROM #VMSS_HOLDING WHERE QTY<0) > 0
	 BEGIN
	  		  While @a_ctr <= @a_tctr  
			  Begin  

				set @adjQty=0  
				if (select qty from #vmss_holding where srno=@a_ctr) < 0  
				Begin  
				  select @nhold=@nhold+qty,@scode=Scrip_cd from #vmss_holding where srno=@a_ctr  
				End   
				Else  
				Begin  
				   if (@nhold < 0) and (select COUNT(1) from #vmss_holding where srno=@a_ctr and Scrip_Cd=@scode) > 0  
				   Begin  
					 select @adjQty=(Case when Qty+@nhold >= 0 then @nhold*-1 else Qty end) from #vmss_holding where srno=@a_ctr  
					 update #vmss_holding set SquareoffQty=Qty-@adjQty where srno=@a_ctr  
					 set @nhold=(case when @nhold+@adjQty < 0 then @nhold+@adjQty else 0 end)  
				   End  
				   ELSE  
				   Begin  
					update #vmss_holding set SquareoffQty=Qty  where srno=@a_ctr  
					set @nhold=0  
				   End   
				 End  
				set @a_ctr=@a_ctr+1  
			  End  
		  
		   update #vmss_holding set Qty=SquareoffQty  
	  END
   
   update #vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0   
 /* Adjust -ve Holding - FINISH : added on 29-12-2015 */  
  
   select ROW_NUMBER() OVER ( ORDER BY a.party_code,UnsettCode,c.start_date desc,              
   (CAse when UnsettCode = 0 then 10-b.seqid else b.seqid end) ,vbhc desc) AS [SrNo],                                  
   ProcessDate,a.EXCHANGE,a.sett_no,a.SEtt_type,scrip_cd,a.series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC=(VBHC-VAHC),                                  
   CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt                                  
   into #SQC_holdadj                         
   from               
   (              
   select (Case when SRC='D' then 1 else 0 end) as UnsettCode,party_code,VAHC,              
   ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Qty,CLSRATE,VBHC,HAIRCUT,              
   CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt                
   /* from vmss_holding where party_code=@pcode and Clsrate > 0*/  
   from #vmss_holding where Qty > 0             
   ) a join                                                  
   (              
   select Srno as seqid,CategoryName from General.dbo.ScripCategory_master              
   ) b on a.category=b.CategoryName                                                  
   join General.dbo.BO_Sett_Mst c with (nolock) on a.sett_no=c.Sett_No and a.sett_type=c.Sett_Type and a.exchange=c.co_code                        
  

   select @Xtotctr=MAX(Srno) from #SQC_holdadj                                                   
   set @TSqOffVal=0                                                  
   set @Xctr=1                                        
  
   While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                 
   BEGIN                                                  
     select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #SQC_holdadj where srno=@xctr                                             
     if (@SqOffVal<@TSqOffVal)                                                      
      set @TSqOffVal=@SqOffVal  
                                                           
     update vmss_holding set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),SqOffseq=@xctr                                         
     where id=@id                   
     set @SqOffVal=@TSqOffVal                                                  
     set @Xctr=@Xctr+1                                                  
   END                                                  
   
    DROP TABLE #SQC_holdadj                                               
    set @ctr=@ctr+1                                                  
 end                                                  

 DROP TABLE #vmss_holding    
 drop table #SQC_filex                                                  
 
 update VMSS_HOLDING set AdjAmt=((SquareOffQty*clsrate)*(Haircut/100.00)) 
	                                 
 /*truncate table vmss_holding_hist  commented on Jan 15 2016 to maintain history data   */  
	                                
 insert into vmss_holding_hist                            
 (ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,ActualSqOffQty,AvgRate)                                                   
 select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,ActualSqOffQty,AvgRate                                  
 from vmss_holding                                     
  
 update #SQC_file2 set SquareOffValue=b.SqVal,VarMarRelSqAmt=b.AdjAmt from                                                  
 (                                        
 select party_code,sum(SquareOffQty*Clsrate) as SqVal,sum(AdjAmt) as AdjAmt from vmss_holding                           
 where isnull(SquareOffQty,0) > 0                               
 group by party_code                                        
 ) b                            
 where #SQC_file2.party_code=b.party_Code                                                  
  
 update #SQC_file2 set SquareOffValue=0 where VarMarginShortFall_AftAdjCurrDay >= 0      
 /*update #SQC_file2 set SquareOffValue=0 where NoofDays=0 */--10391296     
 update VMSS_data set SquareOffValue=b.SquareOffValue,VarMarRelSqAmt=b.VarMarRelSqAmt from #SQC_file2 b                                    
 where VMSS_data.processdate = @tdate and VMSS_data.party_code=b.party_code                                     
  
 insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                        
 VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks,VarMarRelSqAmt,            
 Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                  
  
 select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                           
 VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks,VarMarRelSqAmt,            
 Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay                   
 from VMSS_data where processdate=@tdate                                   
  
/* exec [dbo].[VMSS_Margin_Shortage_SquareOff_Exception_Process]  */         
 drop table #SQC_file2  
  
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'VMSS_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_SqOffAmtCalculation_26082016
-- --------------------------------------------------
create Procedure [dbo].[VMSS_SqOffAmtCalculation_26082016]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY                                                                                    
  update VMSS_HOLDING set isin=b.isin from General.dbo.scrip_master b where VMSS_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update VMSS_HOLDING set isin=b.isin from General.dbo.scrip_master b where VMSS_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))                                  
  select * into #SQC_file2 from vmss_Data where processdate = @tdate                                                
  update VMSS_data set SquareOffValue=0 where processdate = @tdate                                   
    
  select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #SQC_filex from #SQC_file2 
  where VarMarginShortFall_AftAdjCurrDay < 0 /*and NoofDays > 0*/--commented to calculate square off for all clients as required in PRMS 10391296                                       
  
  select * into #vmss_holding from VMSS_holding_SQOFF_format where 1=2  
  
  Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                  
  declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                  
  select @totctr=MAX(srno) from #SQC_filex                                                  
  
 While @ctr <= @totctr                                                  
 Begin                                                  
     set @SqOffVal=0                                                  
     select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdjCurrDay*-1 from #SQC_filex where srno=@ctr      
                                            
     /* Adjust -ve Holding - START : added on 29-12-2015 */  
  
     truncate table #vmss_holding  
      
     insert into #vmss_holding   
     select ROW_NUMBER() OVER ( ORDER BY scrip_cd,Qty ,sett_no) AS [SrNo],  
     (Case when SRC in ('D','SI') then 1 else 0 end) as UnsettCode,party_code,VAHC,              
     ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Qty,CLSRATE,VBHC,HAIRCUT,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt                
     from vmss_holding where party_code=@pcode and Clsrate > 0   
      
     update #vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0   
     declare @a_tctr as int = 0,@a_ctr as int = 1,@nhold as int =0,@scode as varchar(10)='',@adjQty as int = 0  
     select @a_tctr=MAX(srno) from #vmss_holding   
  
	 IF (SELECT COUNT(1) FROM #VMSS_HOLDING WHERE QTY<0) > 0
	 BEGIN
	  		  While @a_ctr <= @a_tctr  
			  Begin  

				set @adjQty=0  
				if (select qty from #vmss_holding where srno=@a_ctr) < 0  
				Begin  
				  select @nhold=@nhold+qty,@scode=Scrip_cd from #vmss_holding where srno=@a_ctr  
				End   
				Else  
				Begin  
				   if (@nhold < 0) and (select COUNT(1) from #vmss_holding where srno=@a_ctr and Scrip_Cd=@scode) > 0  
				   Begin  
					 select @adjQty=(Case when Qty+@nhold >= 0 then @nhold*-1 else Qty end) from #vmss_holding where srno=@a_ctr  
					 update #vmss_holding set SquareoffQty=Qty-@adjQty where srno=@a_ctr  
					 set @nhold=(case when @nhold+@adjQty < 0 then @nhold+@adjQty else 0 end)  
				   End  
				   ELSE  
				   Begin  
					update #vmss_holding set SquareoffQty=Qty  where srno=@a_ctr  
					set @nhold=0  
				   End   
				 End  
				set @a_ctr=@a_ctr+1  
			  End  
		  
		   update #vmss_holding set Qty=SquareoffQty  
	  END
   
   update #vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0   
 /* Adjust -ve Holding - FINISH : added on 29-12-2015 */  
  
   select ROW_NUMBER() OVER ( ORDER BY a.party_code,UnsettCode,c.start_date desc,              
   (CAse when UnsettCode = 0 then 10-b.seqid else b.seqid end) ,vbhc desc) AS [SrNo],                                  
   ProcessDate,a.EXCHANGE,a.sett_no,a.SEtt_type,scrip_cd,a.series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC=(VBHC-VAHC),                                  
   CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt                                  
   into #SQC_holdadj                         
   from               
   (              
   select (Case when SRC='D' then 1 else 0 end) as UnsettCode,party_code,VAHC,              
   ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Qty,CLSRATE,VBHC,HAIRCUT,              
   CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt                
   /* from vmss_holding where party_code=@pcode and Clsrate > 0*/  
   from #vmss_holding where Qty > 0             
   ) a join                                                  
   (              
   select Srno as seqid,CategoryName from General.dbo.ScripCategory_master              
   ) b on a.category=b.CategoryName                                                  
   join General.dbo.BO_Sett_Mst c with (nolock) on a.sett_no=c.Sett_No and a.sett_type=c.Sett_Type and a.exchange=c.co_code                        
  

   select @Xtotctr=MAX(Srno) from #SQC_holdadj                                                   
   set @TSqOffVal=0                                                  
   set @Xctr=1                                        
  
   While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                 
   BEGIN                                                  
     select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #SQC_holdadj where srno=@xctr                                             
     if (@SqOffVal<@TSqOffVal)                                                      
      set @TSqOffVal=@SqOffVal  
                                                           
     update vmss_holding set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),SqOffseq=@xctr                                         
     where id=@id                   
     set @SqOffVal=@TSqOffVal                                                  
     set @Xctr=@Xctr+1                                                  
   END                                                  
   
    DROP TABLE #SQC_holdadj                                               
    set @ctr=@ctr+1                                                  
 end                                                  

 DROP TABLE #vmss_holding    
 drop table #SQC_filex                                                  
 
 update VMSS_HOLDING set AdjAmt=((SquareOffQty*clsrate)*(Haircut/100.00)) 
	                                 
 /*truncate table vmss_holding_hist  commented on Jan 15 2016 to maintain history data   */  
	                                
 insert into vmss_holding_hist                            
 (ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,ActualSqOffQty,AvgRate)                                                   
 select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,ActualSqOffQty,AvgRate                                  
 from vmss_holding                                     
  
 update #SQC_file2 set SquareOffValue=b.SqVal,VarMarRelSqAmt=b.AdjAmt from                                                  
 (                                        
 select party_code,sum(SquareOffQty*Clsrate) as SqVal,sum(AdjAmt) as AdjAmt from vmss_holding                           
 where isnull(SquareOffQty,0) > 0                               
 group by party_code                                        
 ) b                            
 where #SQC_file2.party_code=b.party_Code                                                  
  
 update #SQC_file2 set SquareOffValue=0 where VarMarginShortFall_AftAdjCurrDay >= 0      
 /*update #SQC_file2 set SquareOffValue=0 where NoofDays=0 */--10391296     
 update VMSS_data set SquareOffValue=b.SquareOffValue,VarMarRelSqAmt=b.VarMarRelSqAmt from #SQC_file2 b                                    
 where VMSS_data.processdate = @tdate and VMSS_data.party_code=b.party_code                                     
  
 insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                        
 VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks,VarMarRelSqAmt,            
 Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                  
  
 select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                           
 VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks,VarMarRelSqAmt,            
 Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay                   
 from VMSS_data where processdate=@tdate                                   
  
/* exec [dbo].[VMSS_Margin_Shortage_SquareOff_Exception_Process]  */         
 drop table #SQC_file2  
  
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'VMSS_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_SqOffAmtCalculation_29072016
-- --------------------------------------------------
create Procedure [dbo].[VMSS_SqOffAmtCalculation_29072016]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY                                                                                    
  update VMSS_HOLDING set isin=b.isin from General.dbo.scrip_master b where VMSS_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update VMSS_HOLDING set isin=b.isin from General.dbo.scrip_master b where VMSS_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))                                  
  select * into #SQC_file2 from vmss_Data where processdate = @tdate                                                
  update VMSS_data set SquareOffValue=0 where processdate = @tdate                                   
    
  select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #SQC_filex from #SQC_file2 
  where VarMarginShortFall_AftAdjCurrDay < 0 and NoofDays > 0                                       
  
  select * into #vmss_holding from VMSS_holding_SQOFF_format where 1=2  
  
  Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                  
  declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                  
  select @totctr=MAX(srno) from #SQC_filex                                                  
  
 While @ctr <= @totctr                                                  
 Begin                                                  
     set @SqOffVal=0                                                  
     select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdjCurrDay*-1 from #SQC_filex where srno=@ctr      
                                            
     /* Adjust -ve Holding - START : added on 29-12-2015 */  
  
     truncate table #vmss_holding  
      
     insert into #vmss_holding   
     select ROW_NUMBER() OVER ( ORDER BY scrip_cd,Qty ,sett_no) AS [SrNo],  
     (Case when SRC in ('D','SI') then 1 else 0 end) as UnsettCode,party_code,VAHC,              
     ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Qty,CLSRATE,VBHC,HAIRCUT,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt                
     from vmss_holding where party_code=@pcode and Clsrate > 0   
      
     update #vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0   
     declare @a_tctr as int = 0,@a_ctr as int = 1,@nhold as int =0,@scode as varchar(10)='',@adjQty as int = 0  
     select @a_tctr=MAX(srno) from #vmss_holding   
  
	 IF (SELECT COUNT(1) FROM #VMSS_HOLDING WHERE QTY<0) > 0
	 BEGIN
	  		  While @a_ctr <= @a_tctr  
			  Begin  

				set @adjQty=0  
				if (select qty from #vmss_holding where srno=@a_ctr) < 0  
				Begin  
				  select @nhold=@nhold+qty,@scode=Scrip_cd from #vmss_holding where srno=@a_ctr  
				End   
				Else  
				Begin  
				   if (@nhold < 0) and (select COUNT(1) from #vmss_holding where srno=@a_ctr and Scrip_Cd=@scode) > 0  
				   Begin  
					 select @adjQty=(Case when Qty+@nhold >= 0 then @nhold*-1 else Qty end) from #vmss_holding where srno=@a_ctr  
					 update #vmss_holding set SquareoffQty=Qty-@adjQty where srno=@a_ctr  
					 set @nhold=(case when @nhold+@adjQty < 0 then @nhold+@adjQty else 0 end)  
				   End  
				   ELSE  
				   Begin  
					update #vmss_holding set SquareoffQty=Qty  where srno=@a_ctr  
					set @nhold=0  
				   End   
				 End  
				set @a_ctr=@a_ctr+1  
			  End  
		  
		   update #vmss_holding set Qty=SquareoffQty  
	  END
   
   update #vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0   
 /* Adjust -ve Holding - FINISH : added on 29-12-2015 */  
  
   select ROW_NUMBER() OVER ( ORDER BY a.party_code,UnsettCode,c.start_date desc,              
   (CAse when UnsettCode = 0 then 10-b.seqid else b.seqid end) ,vbhc desc) AS [SrNo],                                  
   ProcessDate,a.EXCHANGE,a.sett_no,a.SEtt_type,scrip_cd,a.series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC=(VBHC-VAHC),                                  
   CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt                                  
   into #SQC_holdadj                         
   from               
   (              
   select (Case when SRC='D' then 1 else 0 end) as UnsettCode,party_code,VAHC,              
   ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Qty,CLSRATE,VBHC,HAIRCUT,              
   CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt                
   /* from vmss_holding where party_code=@pcode and Clsrate > 0*/  
   from #vmss_holding where Qty > 0             
   ) a join                                                  
   (              
   select Srno as seqid,CategoryName from General.dbo.ScripCategory_master              
   ) b on a.category=b.CategoryName                                                  
   join General.dbo.BO_Sett_Mst c with (nolock) on a.sett_no=c.Sett_No and a.sett_type=c.Sett_Type and a.exchange=c.co_code                        
  

   select @Xtotctr=MAX(Srno) from #SQC_holdadj                                                   
   set @TSqOffVal=0                                                  
   set @Xctr=1                                        
  
   While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                 
   BEGIN                                                  
     select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #SQC_holdadj where srno=@xctr                                             
     if (@SqOffVal<@TSqOffVal)                                                      
      set @TSqOffVal=@SqOffVal  
                                                           
     update vmss_holding set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),SqOffseq=@xctr                                         
     where id=@id                   
     set @SqOffVal=@TSqOffVal                                                  
     set @Xctr=@Xctr+1                                                  
   END                                                  
   
    DROP TABLE #SQC_holdadj                                               
    set @ctr=@ctr+1                                                  
 end                                                  

 DROP TABLE #vmss_holding    
 drop table #SQC_filex                                                  
 
 update VMSS_HOLDING set AdjAmt=((SquareOffQty*clsrate)*(Haircut/100.00)) 
	                                 
 /*truncate table vmss_holding_hist  commented on Jan 15 2016 to maintain history data   */  
	                                
 insert into vmss_holding_hist                            
 (ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,ActualSqOffQty,AvgRate)                                                   
 select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,ActualSqOffQty,AvgRate                                  
 from vmss_holding                                     
  
 update #SQC_file2 set SquareOffValue=b.SqVal,VarMarRelSqAmt=b.AdjAmt from                                                  
 (                                        
 select party_code,sum(SquareOffQty*Clsrate) as SqVal,sum(AdjAmt) as AdjAmt from vmss_holding                           
 where isnull(SquareOffQty,0) > 0                               
 group by party_code                                        
 ) b                            
 where #SQC_file2.party_code=b.party_Code                                                  
  
 update #SQC_file2 set SquareOffValue=0 where VarMarginShortFall_AftAdjCurrDay >= 0      
 update #SQC_file2 set SquareOffValue=0 where NoofDays=0      
 update VMSS_data set SquareOffValue=b.SquareOffValue,VarMarRelSqAmt=b.VarMarRelSqAmt from #SQC_file2 b                                    
 where VMSS_data.processdate = @tdate and VMSS_data.party_code=b.party_code                                     
  
 insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                        
 VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks,VarMarRelSqAmt,            
 Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                  
  
 select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                           
 VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks,VarMarRelSqAmt,            
 Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay                   
 from VMSS_data where processdate=@tdate                                   
  
/* exec [dbo].[VMSS_Margin_Shortage_SquareOff_Exception_Process]  */         
 drop table #SQC_file2  
  
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'VMSS_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_SqOffAmtCalculation_29122014
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_SqOffAmtCalculation_29122014]                                    
as                                                            
SET XACT_ABORT ON                                                                  
Set nocount on                                                            
BEGIN TRY                                                                                    
  update VMSS_HOLDING set isin=b.isin from General.dbo.scrip_master b where VMSS_HOLDING.isin is null and scrip_cd=b.NseSymbol                              
  update VMSS_HOLDING set isin=b.isin from General.dbo.scrip_master b where VMSS_HOLDING.isin is null and scrip_cd=b.bsecode                              
  update vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                  
  
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))                                  
  select * into #SQC_file2 from vmss_Data where processdate = @tdate                                                
  update VMSS_data set SquareOffValue=0 where processdate = @tdate                                   
    
  select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #SQC_filex from #SQC_file2 
  where VarMarginShortFall_AftAdjCurrDay < 0 and NoofDays > 0                                       
  
  select * into #vmss_holding from VMSS_holding_SQOFF_format where 1=2  
  
  Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                  
  declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                  
  select @totctr=MAX(srno) from #SQC_filex                                                  
  
 While @ctr <= @totctr                                                  
 Begin                                                  
     set @SqOffVal=0                                                  
     select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdjCurrDay*-1 from #SQC_filex where srno=@ctr      
                                            
     /* Adjust -ve Holding - START : added on 29-12-2015 */  
  
     truncate table #vmss_holding  
      
     insert into #vmss_holding   
     select ROW_NUMBER() OVER ( ORDER BY scrip_cd,Qty ,sett_no) AS [SrNo],  
     (Case when SRC in ('D','SI') then 1 else 0 end) as UnsettCode,party_code,VAHC,              
     ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Qty,CLSRATE,VBHC,HAIRCUT,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt                
     from vmss_holding where party_code=@pcode and Clsrate > 0   
      
     update #vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0   
     declare @a_tctr as int = 0,@a_ctr as int = 1,@nhold as int =0,@scode as varchar(10)='',@adjQty as int = 0  
     select @a_tctr=MAX(srno) from #vmss_holding   
  
	 IF (SELECT COUNT(1) FROM #VMSS_HOLDING WHERE QTY<0) > 0
	 BEGIN
	  		  While @a_ctr <= @a_tctr  
			  Begin  

				set @adjQty=0  
				if (select qty from #vmss_holding where srno=@a_ctr) < 0  
				Begin  
				  select @nhold=@nhold+qty,@scode=Scrip_cd from #vmss_holding where srno=@a_ctr  
				End   
				Else  
				Begin  
				   if (@nhold < 0) and (select COUNT(1) from #vmss_holding where srno=@a_ctr and Scrip_Cd=@scode) > 0  
				   Begin  
					 select @adjQty=(Case when Qty+@nhold >= 0 then @nhold*-1 else Qty end) from #vmss_holding where srno=@a_ctr  
					 update #vmss_holding set SquareoffQty=Qty-@adjQty where srno=@a_ctr  
					 set @nhold=(case when @nhold+@adjQty < 0 then @nhold+@adjQty else 0 end)  
				   End  
				   ELSE  
				   Begin  
					update #vmss_holding set SquareoffQty=Qty  where srno=@a_ctr  
					set @nhold=0  
				   End   
				 End  
				set @a_ctr=@a_ctr+1  
			  End  
		  
		   update #vmss_holding set Qty=SquareoffQty  
	  END
   
   update #vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0   
 /* Adjust -ve Holding - FINISH : added on 29-12-2015 */  
  
   select ROW_NUMBER() OVER ( ORDER BY a.party_code,UnsettCode,c.start_date desc,              
   (CAse when UnsettCode = 0 then 10-b.seqid else b.seqid end) ,vbhc desc) AS [SrNo],                                  
   ProcessDate,a.EXCHANGE,a.sett_no,a.SEtt_type,scrip_cd,a.series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC=(VBHC-VAHC),                                  
   CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt                                  
   into #SQC_holdadj                         
   from               
   (              
   select (Case when SRC='D' then 1 else 0 end) as UnsettCode,party_code,VAHC,              
   ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Qty,CLSRATE,VBHC,HAIRCUT,              
   CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt                
   /* from vmss_holding where party_code=@pcode and Clsrate > 0*/  
   from #vmss_holding where Qty > 0             
   ) a join                                                  
   (              
   select Srno as seqid,CategoryName from General.dbo.ScripCategory_master              
   ) b on a.category=b.CategoryName                                                  
   join General.dbo.BO_Sett_Mst c with (nolock) on a.sett_no=c.Sett_No and a.sett_type=c.Sett_Type and a.exchange=c.co_code                        
  

   select @Xtotctr=MAX(Srno) from #SQC_holdadj                                                   
   set @TSqOffVal=0                                                  
   set @Xctr=1                                        
  
   While @Xctr <= @Xtotctr  and @SqOffVal > 0                                                 
   BEGIN                                                  
     select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #SQC_holdadj where srno=@xctr                                             
     if (@SqOffVal<@TSqOffVal)                                                      
      set @TSqOffVal=@SqOffVal  
                                                           
     update vmss_holding set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),SqOffseq=@xctr                                         
     where id=@id                   
     set @SqOffVal=@TSqOffVal                                                  
     set @Xctr=@Xctr+1                                                  
   END                                                  
   
    DROP TABLE #SQC_holdadj                                               
    set @ctr=@ctr+1                                                  
 end                                                  

 DROP TABLE #vmss_holding    
 drop table #SQC_filex                                                  
 
 update VMSS_HOLDING set AdjAmt=((SquareOffQty*clsrate)*(Haircut/100.00))                                  
 truncate table vmss_holding_hist                                       
 insert into vmss_holding_hist                            
 (ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,ActualSqOffQty,AvgRate)                                                   
 select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,ActualSqOffQty,AvgRate                                  
 from vmss_holding                                     
  
 update #SQC_file2 set SquareOffValue=b.SqVal,VarMarRelSqAmt=b.AdjAmt from                                                  
 (                                        
 select party_code,sum(SquareOffQty*Clsrate) as SqVal,sum(AdjAmt) as AdjAmt from vmss_holding                           
 where isnull(SquareOffQty,0) > 0                               
 group by party_code                                        
 ) b                            
 where #SQC_file2.party_code=b.party_Code                                                  
  
 update #SQC_file2 set SquareOffValue=0 where VarMarginShortFall_AftAdjCurrDay >= 0      
 update #SQC_file2 set SquareOffValue=0 where NoofDays=0      
 update VMSS_data set SquareOffValue=b.SquareOffValue,VarMarRelSqAmt=b.VarMarRelSqAmt from #SQC_file2 b                                    
 where VMSS_data.processdate = @tdate and VMSS_data.party_code=b.party_code                                     
  
 insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                        
 VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks,VarMarRelSqAmt,            
 Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                  
  
 select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                           
 VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks,VarMarRelSqAmt,            
 Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay                   
 from VMSS_data where processdate=@tdate                                   
  
/* exec [dbo].[VMSS_Margin_Shortage_SquareOff_Exception_Process]  */         
 drop table #SQC_file2  
  
End try                                                                                 
  
BEGIN CATCH                                                                                    
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                          
  select GETDATE(),'VMSS_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                          
  DECLARE @ErrorMessage NVARCHAR(4000);                            
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                  
  RAISERROR (@ErrorMessage , 16, 1);                        
End catch                             
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_SqOffAmtCalculation_29122014_abha
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_SqOffAmtCalculation_29122014_abha]                                  



as                                                          



          



SET XACT_ABORT ON                                                                



Set nocount on                                                          



BEGIN TRY                                                                                  



          



  update VMSS_HOLDING set isin=b.isin from General.dbo.scrip_master b where VMSS_HOLDING.isin is null and scrip_cd=b.NseSymbol                            



  update VMSS_HOLDING set isin=b.isin from General.dbo.scrip_master b where VMSS_HOLDING.isin is null and scrip_cd=b.bsecode                            



          



  update vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0                                



        



  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))                                



  select * into #SQC_file2 from vmss_Data where processdate = @tdate                                              



          



  update VMSS_data set SquareOffValue=0 where processdate = @tdate                                 



          



  select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #SQC_filex                                  



  from #SQC_file2 where VarMarginShortFall_AftAdjCurrDay < 0 and NoofDays > 0                                     







  select * into #vmss_holding from VMSS_holding_SQOFF_format where 1=2



          



  Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                                



  declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                



          



  select @totctr=MAX(srno) from #SQC_filex                                                



          



  While @ctr <= @totctr                                                



  Begin                                                



          



   set @SqOffVal=0                                                



   select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdjCurrDay*-1 from #SQC_filex where srno=@ctr                                         







   /* Adjust -ve Holding - START : added on 29-12-2015 */



    truncate table #vmss_holding 



    



	insert into #vmss_holding 



	select 



	ROW_NUMBER() OVER ( ORDER BY scrip_cd,Qty ,sett_no) AS [SrNo],



	(Case when SRC in ('D','SI') then 1 else 0 end) as UnsettCode,party_code,VAHC,            



	ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Qty,CLSRATE,VBHC,HAIRCUT,            



	CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt              



	from vmss_holding             



	where party_code=@pcode and Clsrate > 0 







	update #vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0 







	declare @a_tctr as int = 0,@a_ctr as int = 1,@nhold as int =0,@scode as varchar(10)='',@adjQty as int = 0



	select @a_tctr=MAX(srno) from #vmss_holding 







	While @a_ctr <= @a_tctr



	Begin



		set @adjQty=0







		if (select qty from #vmss_holding where srno=@a_ctr) < 0



		Begin



			select @nhold=@nhold+qty,@scode=Scrip_cd from #vmss_holding where srno=@a_ctr







		End 



		Else



		Begin







			if (@nhold < 0) and (select COUNT(1) from #vmss_holding where srno=@a_ctr and Scrip_Cd=@scode) > 0



			Begin



			



					select @adjQty=(Case when Qty+@nhold >= 0 then @nhold*-1 else Qty end) from #vmss_holding where srno=@a_ctr



					update #vmss_holding set SquareoffQty=Qty-@adjQty where srno=@a_ctr



					set @nhold=(case when @nhold+@adjQty < 0 then @nhold+@adjQty else 0 end)



			End



			ELSE



			Begin



				update #vmss_holding set SquareoffQty=Qty  where srno=@a_ctr



				set @nhold=0



			End	



		End



		set @a_ctr=@a_ctr+1



	End







   update #vmss_holding set Qty=SquareoffQty



   update #vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0 







	/* Adjust -ve Holding - FINISH : added on 29-12-2015 */



          



   select ROW_NUMBER() OVER ( ORDER BY a.party_code,UnsettCode,c.start_date desc,            



   (CAse when UnsettCode = 0 then 10-b.seqid else b.seqid end) ,vbhc desc) AS [SrNo],                                



   ProcessDate,a.EXCHANGE,a.sett_no,a.SEtt_type,scrip_cd,a.series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC=(VBHC-VAHC),                                



   CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt                                



   into #SQC_holdadj                       



   from             



   (            



   select (Case when SRC='D' then 1 else 0 end) as UnsettCode,party_code,VAHC,            



   ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Qty,CLSRATE,VBHC,HAIRCUT,            



   CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt              



   /* from vmss_holding where party_code=@pcode and Clsrate > 0*/



   from #vmss_holding where Qty > 0           



   ) a join                                                



   (            



   select Srno as seqid,CategoryName from General.dbo.ScripCategory_master            



   ) b on a.category=b.CategoryName                                                



   join                      



   General.dbo.BO_Sett_Mst c with (nolock) on a.sett_no=c.Sett_No and a.sett_type=c.Sett_Type and a.exchange=c.co_code                      



          



   DROP TABLE #vmss_holding



   



   select @Xtotctr=MAX(Srno) from #SQC_holdadj                                                 



   set @TSqOffVal=0                                                



          



   set @Xctr=1                                      



          



   While @Xctr <= @Xtotctr  and @SqOffVal > 0                                               



   BEGIN                                                



          



    select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #SQC_holdadj where srno=@xctr                                           



          



    if (@SqOffVal<@TSqOffVal)                                                    



   set @TSqOffVal=@SqOffVal                                                    



          



    update vmss_holding             



    set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                      



    SqOffseq=@xctr                                       



    where id=@id                 



          



    set @SqOffVal=@TSqOffVal                                                



          



    set @Xctr=@Xctr+1                                                



   END                                                



          



   DROP TABLE #SQC_holdadj                                             



   set @ctr=@ctr+1                                                



  end                                                



          



  drop table #SQC_filex                                                



          



  update VMSS_HOLDING set AdjAmt=((SquareOffQty*clsrate)*(Haircut/100.00))                                



          



  truncate table vmss_holding_hist                                     



  insert into vmss_holding_hist                          



  (ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,ActualSqOffQty,AvgRate)                                                 



  select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,ActualSqOffQty,AvgRate        



  from vmss_holding                                   



          



  update #SQC_file2 set SquareOffValue=b.SqVal,VarMarRelSqAmt=b.AdjAmt from                                                



  (                                      



  select party_code,sum(SquareOffQty*Clsrate) as SqVal,sum(AdjAmt) as AdjAmt from vmss_holding                         



  where isnull(SquareOffQty,0) > 0                             



  group by party_code                                      



  ) b                                                 



  where #SQC_file2.party_code=b.party_Code                                                



    



  update #SQC_file2 set SquareOffValue=0 where VarMarginShortFall_AftAdjCurrDay >= 0    



  update #SQC_file2 set SquareOffValue=0 where NoofDays=0    



          



  update VMSS_data set SquareOffValue=b.SquareOffValue,VarMarRelSqAmt=b.VarMarRelSqAmt from #SQC_file2 b                                  



  where VMSS_data.processdate = @tdate                                 



  and VMSS_data.party_code=b.party_code                                   



          



  insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                      



  VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks,VarMarRelSqAmt,          



  Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)                



  select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                         



  VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks,VarMarRelSqAmt,          



  Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay                 



  from VMSS_data                                   



  where processdate=@tdate                                 



          



  /* exec [dbo].[VMSS_Margin_Shortage_SquareOff_Exception_Process]  */       







  drop table #SQC_file2



                            



End try                                                                               



BEGIN CATCH                                                                                  



  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                        



  select GETDATE(),'VMSS_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                        



          



  DECLARE @ErrorMessage NVARCHAR(4000);                          



  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                                



  RAISERROR (@ErrorMessage , 16, 1);                      



                    



End catch                           



                                                          



SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_SqOffAmtCalculation_30122015
-- --------------------------------------------------
Create Procedure [dbo].[VMSS_SqOffAmtCalculation_30122015]                                 
as                                                         
          
SET XACT_ABORT ON                                                                
Set nocount on                                                         
BEGIN TRY                                                                                 
          
  update VMSS_HOLDING set isin=b.isin from General.dbo.scrip_master b where VMSS_HOLDING.isin is null and scrip_cd=b.NseSymbol                           
  update VMSS_HOLDING set isin=b.isin from General.dbo.scrip_master b where VMSS_HOLDING.isin is null and scrip_cd=b.bsecode                            
          
  update vmss_holding set SquareOffQty=0,SqOffSeq=0,Adjamt=0                               
        
  Declare @tdate as datetime = (select MAX(processdate) from vmss_Data with (nolock))                               
  select * into #SQC_file2 from vmss_Data where processdate = @tdate                                             
          
  update VMSS_data set SquareOffValue=0 where processdate = @tdate                                
          
  select ROW_NUMBER() OVER ( ORDER BY party_Code) AS [SrNo],* into #SQC_filex                                 
  from #SQC_file2 where VarMarginShortFall_AftAdjCurrDay < 0 and NoofDays > 0                                    
          
  Declare @totctr as int = 0,@ctr as int = 1,@SqOffVal as money = 0,@pcode as varchar(10)='',@Xtotctr as int = 0,@Xctr as int = 1,@qty as int =0                                               
  declare @TSqOffVal as money = 0,@SqQty as int = 0,@clsrate as money=0,@id as int = 0                                                
          
  select @totctr=MAX(srno) from #SQC_filex                                               
          
  While @ctr <= @totctr                                               
  Begin                                               
          
   set @SqOffVal=0                                               
   select @pcode=party_Code,@SqOffVal=VarMarginShortFall_AftAdjCurrDay*-1 from #SQC_filex where srno=@ctr                                         
          
   select ROW_NUMBER() OVER ( ORDER BY a.party_code,UnsettCode,c.start_date desc,           
   (CAse when UnsettCode = 0 then 10-b.seqid else b.seqid end) ,vbhc desc) AS [SrNo],                               
   ProcessDate,a.EXCHANGE,a.sett_no,a.SEtt_type,scrip_cd,a.series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC=(VBHC-VAHC),                               
   CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt                               
   into #SQC_holdadj                       
   from            
   (           
   select (Case when SRC='D' then 1 else 0 end) as UnsettCode,party_code,VAHC,           
   ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Qty,CLSRATE,VBHC,HAIRCUT,           
   CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt             
   from vmss_holding            
   where party_code=@pcode and Clsrate > 0           
   ) a join                                               
   (           
   select Srno as seqid,CategoryName from General.dbo.ScripCategory_master           
   ) b on a.category=b.CategoryName                                               
   join                     
   General.dbo.BO_Sett_Mst c with (nolock) on a.sett_no=c.Sett_No and a.sett_type=c.Sett_Type and a.exchange=c.co_code                     
          
          
   select @Xtotctr=MAX(Srno) from #SQC_holdadj                                                
   set @TSqOffVal=0                                               
          
   set @Xctr=1                                     
          
   While @Xctr <= @Xtotctr  and @SqOffVal > 0                                              
   BEGIN                                               
          
    select @TSqOffVal=@SqOffVal-(VBHC*(Haircut/100.00)),@qty=qty,@clsrate=Clsrate,@id=id  from #SQC_holdadj where srno=@xctr                                          
          
    if (@SqOffVal<@TSqOffVal)                                                   
   set @TSqOffVal=@SqOffVal                                                   
          
    update vmss_holding            
    set SquareOffQty=ceiling(Case when ((@SqOffVal/Haircut)*100.00)/@clsrate <= @qty then ((@SqOffVal/Haircut)*100.00)/@clsrate else @qty end),                                      
    SqOffseq=@xctr                                      
    where id=@id                
          
    set @SqOffVal=@TSqOffVal                                               
          
    set @Xctr=@Xctr+1                                                
   END                                               
          
   DROP TABLE #SQC_holdadj                                            
   set @ctr=@ctr+1                                               
  end                                                
          
  drop table #SQC_filex                                               
          
  update VMSS_HOLDING set AdjAmt=((SquareOffQty*clsrate)*(Haircut/100.00))                               
          
  truncate table vmss_holding_hist                                    
  insert into vmss_holding_hist                         
  (ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,ActualSqOffQty,AvgRate)                                                
  select GETDATE() as ProcessDate,EXCHANGE,sett_no,SEtt_type,scrip_cd,series,Party_code,Qty,CLSRATE,VBHC,HAIRCUT,VAHC,CATEGORY,SRC,SquareOffQty,id,SqOffseq,AdjAmt,ISIN,ActualSqOffQty,AvgRate                               
  from vmss_holding                                  
          
  update #SQC_file2 set SquareOffValue=b.SqVal,VarMarRelSqAmt=b.AdjAmt from                                               
  (                                     
  select party_code,sum(SquareOffQty*Clsrate) as SqVal,sum(AdjAmt) as AdjAmt from vmss_holding                        
  where isnull(SquareOffQty,0) > 0                            
  group by party_code                                      
  ) b                                                
  where #SQC_file2.party_code=b.party_Code                                               
    
  update #SQC_file2 set SquareOffValue=0 where VarMarginShortFall_AftAdjCurrDay >= 0   
  update #SQC_file2 set SquareOffValue=0 where NoofDays=0   
          
  update VMSS_data set SquareOffValue=b.SquareOffValue,VarMarRelSqAmt=b.VarMarRelSqAmt from #SQC_file2 b                                 
  where VMSS_data.processdate = @tdate                                
  and VMSS_data.party_code=b.party_code                                  
          
  insert into VMSS_data_hist(processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                                     
  VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks,VarMarRelSqAmt,         
  Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay)               
  select processDate,Entity,Party_code,NoofDays,Balance,MarginAmt,Deposit,CashColl,NonCashColl,Holding_BHC,Holding_AHC,OtherDebit,EarlyPayinValue,LeverageMultiplier,                                        
  VarMarginShortFall,NSEFO_JV,NSEFO_NonCash,MCD_JV,MCD_NonCash,NSX_JV,NSX_NonCash,VarMarginShortFall_AftAdj,SquareOffValue,BSECM_Balance,NSECM_Balance,updatedon,flag,Remarks,VarMarRelSqAmt,         
  Actual_Cash_Square_Off_Done,VarMarginShortFall_AftAdjCurrDay                
  from VMSS_data                                  
  where processdate=@tdate                                
          
  /* exec [dbo].[VMSS_Margin_Shortage_SquareOff_Exception_Process]  */      
                            
End try                                                                              
BEGIN CATCH                                                                                  
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                       
  select GETDATE(),'VMSS_SqOffAmtCalculation',ERROR_LINE(),ERROR_MESSAGE()                                                                                       
          
  DECLARE @ErrorMessage NVARCHAR(4000);                         
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                               
  RAISERROR (@ErrorMessage , 16, 1);                     
                    
End catch                          
                                                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_SqOffSeg
-- --------------------------------------------------
CREATE procedure [dbo].[VMSS_SqOffSeg]      
as      
set nocount on      
      
 update vmss_holding set toSegment=''      
       
 update vmss_holding set toSegment='BSECM' from      
 (select party_code,bsecm,nsecm from General.dbo.client_Details where bsecm='Y') b       
 where vmss_holding.party_code=b.party_code and squareoffQty > 0 and Exchange='BSECM'      
      
 update vmss_holding set toSegment='NSECM' from      
 (select party_code,bsecm,nsecm from General.dbo.client_Details where nsecm='Y') b       
 where vmss_holding.party_code=b.party_code and squareoffQty > 0 and Exchange='NSECM'      
 and isnull(toSegment,'')=''      
      
 update vmss_holding set toSegment='BSECM' from      
 (select party_code,bsecm,nsecm from General.dbo.client_Details where Bsecm='Y') b       
 where vmss_holding.party_code=b.party_code and squareoffQty > 0 and Exchange='NSECM'      
 and isnull(toSegment,'')=''      
 
 /*Added on Dec 05 2016 as suggested by Vishal Gohil to handle client active and inactive cases*/
 
 update vmss_holding set toSegment='NSECM' from 
 (select party_code,bsecm,nsecm from General.dbo.client_Details where nsecm='Y' and Bsecm='N') b         
 where vmss_holding.party_code=b.party_code and squareoffQty > 0 and Exchange='BSECM'        
 and isnull(toSegment,'')=''  
      
 update vmss_holding set toSegment='N.A.' from      
 (select party_code,bsecm,nsecm from General.dbo.client_Details where Bsecm='N' and Nsecm='N') b       
 where vmss_holding.party_code=b.party_code and squareoffQty > 0       
 and isnull(toSegment,'')=''      
    
update vmss_holding set scrip_cd=b.bsecode from  general.dbo.scrip_master  b
where vmss_holding.scrip_Cd=b.nsesymbol and vmss_holding.series=b.nseseries
and EXCHANGE='NSECM' and ToSegment='BSECM'
     
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_SqOffSeg_05122016
-- --------------------------------------------------
create procedure [dbo].[VMSS_SqOffSeg_05122016]      
as      
set nocount on      
      
 update vmss_holding set toSegment=''      
       
 update vmss_holding set toSegment='BSECM' from      
 (select party_code,bsecm,nsecm from General.dbo.client_Details where bsecm='Y') b       
 where vmss_holding.party_code=b.party_code and squareoffQty > 0 and Exchange='BSECM'      
      
 update vmss_holding set toSegment='NSECM' from      
 (select party_code,bsecm,nsecm from General.dbo.client_Details where nsecm='Y') b       
 where vmss_holding.party_code=b.party_code and squareoffQty > 0 and Exchange='NSECM'      
 and isnull(toSegment,'')=''      
      
 update vmss_holding set toSegment='BSECM' from      
 (select party_code,bsecm,nsecm from General.dbo.client_Details where Bsecm='Y') b       
 where vmss_holding.party_code=b.party_code and squareoffQty > 0 and Exchange='NSECM'      
 and isnull(toSegment,'')=''      
      
 update vmss_holding set toSegment='N.A.' from      
 (select party_code,bsecm,nsecm from General.dbo.client_Details where Bsecm='N' and Nsecm='N') b       
 where vmss_holding.party_code=b.party_code and squareoffQty > 0       
 and isnull(toSegment,'')=''      
    
update vmss_holding set scrip_cd=b.bsecode from  general.dbo.scrip_master  b
where vmss_holding.scrip_Cd=b.nsesymbol and vmss_holding.series=b.nseseries
and EXCHANGE='NSECM' and ToSegment='BSECM'
     
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_SqOffStock_email
-- --------------------------------------------------
CREATE procedure [dbo].[VMSS_SqOffStock_email]                
as                
SET XACT_ABORT ON                    
begin                
begin try                
 exec VMSS_SqOffSeg              
 exec VMSS_BSE_VarShortage                
 exec VMSS_NSE_VarShortage                
 exec VMSS_Reco   
end try                
begin catch                 
 insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                      
 select GETDATE(),'VMSS_SqOffStock_email',ERROR_LINE(),ERROR_MESSAGE()                   
 DECLARE @ErrorMessage NVARCHAR(4000);                                          
 SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                          
 RAISERROR (@ErrorMessage , 16, 1);                
End catch                                         
End

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_SQUP_GENERATE_SQUAREUP_FILE
-- --------------------------------------------------

--VMSS_SQUP_GENERATE_SQUAREUP_FILE 'REGION','%','Nse'            
CREATE Proc [dbo].[VMSS_SQUP_GENERATE_SQUAREUP_FILE]      
@ACCESS_TO AS VARCHAR(25),            
@ACCESS_CODE AS VARCHAR(25),            
@SEGMENT AS VARCHAR(25)            
AS   
SET XACT_ABORT ON                      
Set nocount on                      
BEGIN TRY                                              
           
BEGIN            
IF @ACCESS_CODE='ALL'            
SET @ACCESS_CODE='%'            
IF @SEGMENT = 'BSE'            
--BSE OUTPUT FILE INTO PARTS            
BEGIN            
declare @query varchar(500),@Source VARCHAR(MAX)            
declare @RowCount int,@i int,@j int,@Tot int,@Loop int,@LoopCount int            
            
         
declare @BSEQUERY varchar(MAX)            
set @BSEQUERY = ' bcp " SELECT S,Qty,Qty1,Scrip_Cd,clsrate,CLIENT_CODE,EOSESS,CLIENT,L '            
set @BSEQUERY = @BSEQUERY + ' FROM General.dbo.upd_bse_outfile_squp_var_margin_shortage ORDER BY CLIENT_CODE " '            
set @BSEQUERY = @BSEQUERY + ' queryout H:\MindGate\VMSS_OUTPUT_BSE_'+replace(convert(varchar,getdate(),103),'/','')+'.dot -c -t"|" -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '            
set @BSEQUERY = '''' + @BSEQUERY + ''''            
set @BSEQUERY = 'EXEC MASTER.DBO.XP_CMDSHELL'+ @BSEQUERY            
            
print @BSEQUERY            
exec (@BSEQUERY)            
            
/*END   */         
END            
            
IF @SEGMENT = 'NSE'            
BEGIN            
--NSE OUTPUT FILE            
declare @NSEQUERY varchar(max)            
set @NSEQUERY = ' bcp " select Convert(char(13),ID) as ID,Convert(char(2),Regular_Lot) as Regular_Lot , '            
set @NSEQUERY = @NSEQUERY + ' Convert(char(2),Buy_Sell) as Buy_Sell , Convert(char(10),Symbol) as Symbol , Convert(char(2),Series) as Series , '            
set @NSEQUERY = @NSEQUERY + ' Convert(char(2),Instructions) as Instructions, Convert(char(11),Default_1) as Default_1, '            
set @NSEQUERY = @NSEQUERY + ' Convert(char(2),Default_2) as Default_2 ,Convert(char(9),Default_3) as Default_3 , Convert(char(9),price) as price, '            
set @NSEQUERY = @NSEQUERY + ' Convert(char(9),Default_4) as Default_4 ,Convert(char(9),qty) as qty , Convert(char(9), Disclosed_Qty) as Disclosed_Qty, '            
set @NSEQUERY = @NSEQUERY + ' Convert(char(12),Member_Code) as Member_Code ,Convert(char(2),Pro_Client) as Pro_Client, Convert(char(10),Client_Code) as Client_Code, '            
set @NSEQUERY = @NSEQUERY + ' Convert(char(25),Default_5) as Default_5,Convert(char(16),Default_6) as Default_6, Convert(char(10),Default_7) as Default_7 '            
set @NSEQUERY = @NSEQUERY + ' from  General.dbo.upd_nse_outfile_squp_var_margin_shortage ORDER BY Client_CODE " queryout "H:\MindGate\VMSS_OUTPUT_NSE_'+replace(convert(varchar,getdate(),103),'/','')+'.csv" -c -t"," -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'         
set @NSEQUERY = '''' + @NSEQUERY + ''''            
set @NSEQUERY = 'EXEC MASTER.DBO.XP_CMDSHELL'+ @NSEQUERY            
--print @NSEQUERY            
            
exec (@NSEQUERY)            
            
END            
            
END   
  
End try                                           
BEGIN CATCH                                              
  insert into EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                    
  select GETDATE(),'VMSS_SQUP_GENERATE_SQUAREUP_FILE',ERROR_LINE(),ERROR_MESSAGE()                                                    
End catch                       
                      
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_SQUP_GENERATE_SQUAREUP_FILE_ZIP
-- --------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
--VMSS_SQUP_GENERATE_SQUAREUP_FILE_ZIP 'nse'                            
CREATE Proc [dbo].[VMSS_SQUP_GENERATE_SQUAREUP_FILE_ZIP]                      
                           
@segment as varchar(25)                            
as               
BEGIN  
 set nocount on                 
  
 declare @bsequery varchar(max),@source varchar(max)                
 declare @nsequery varchar(max)                  
 declare @sql varchar(4000)                
 declare @source_file_name varchar(100)                
 declare @file_path varchar(100)                
 declare @zip_file_name varchar(200)                
 declare @zip_program_path varchar(100)                
 declare @zip_path varchar(500)                
 declare @rowcount int,@i int,@j int,@tot int,@loop int,@loopcount int                
  
  /*
 set @file_path = 'd:\mindgate\vmsssqofffile\'                
 set @zip_program_path = '\\196.1.115.136\upload1\cbi\pkzip\pkzip25 -add'                  
 set @zip_path = 'd:\mindgate\vmsssqofffile\zip\'        
 */
 
 
 set @file_path = 'H:\mindgate\vmsssqofffile\'                
 --set @zip_program_path = '\\196.1.115.136\upload1\cbi\pkzip\pkzip25 -add'  
  SET @zip_program_path = 'H:\mindgate\CBI\PkZip\pkzip25 -add' --added by sneha on 15 Feb 2019                
 set @zip_path = 'H:\mindgate\vmsssqofffile\zip\'         
  
 create table #file                
 (                
 srno int,                
 source_file_name varchar(100)                
 )                
  
 BEGIN TRY  
   
 IF @segment = 'BSE'                            
 BEGIN  
  /*exec VMSS_BSE_VarShortage */              
  set @zip_file_name = 'vmss_output_bse' + convert(varchar,getdate(),112) + '.zip'                
  select @rowcount=COUNT(1) from  general.dbo.upd_bse_outfile_squp_var_margin_shortage_COMBINE  
  /* general.dbo.upd_bse_outfile_squp_var_margin_shortage */ 
  WHERE Client_code NOT IN (SELECT DISTINCT party_code FROM  MIS.dbo.VMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP WHERE EXCEPTION = 'Y')    
  
  if(@rowcount>500)                
  begin                
  
   set @loop=ceiling(convert(decimal(15,2),@rowcount)/500)                
   set @loopcount=1                
   set @i=1                
   set @j=500                
  
   while(@loopcount<=@loop)                
   BEGIN  
  
    set @bsequery = 'bcp " select s,qty,qty1,scrip_cd,clsrate,client_code,eosess,client,l '                
    set @bsequery = @bsequery + ' from [csokyc-6].general.dbo.upd_bse_outfile_squp_var_margin_shortage_COMBINE '  
    set @bsequery = @bsequery + ' WHERE Client_code NOT IN (SELECT DISTINCT party_code FROM  [CSOKYC-6].MIS.dbo.VMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP '  
    set @bsequery = @bsequery + ' WHERE EXCEPTION =''''Y'''')'           
    /*set @bsequery = @bsequery + ' " queryout d:\mindgate\vmsssqofffile\vmss_output_bse_'+replace(convert(varchar,getdate(),103),'/','')+   */
    set @bsequery = @bsequery + ' " queryout H:\mindgate\vmsssqofffile\vmss_output_bse_'+replace(convert(varchar,getdate(),103),'/','')+               
    + convert(varchar,@LoopCount)+'.dot -c -t"|" -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc -F'                
    + convert(varchar,@i) + ' -L' + convert(varchar,@j) + ' /'                
  
    --exec master.dbo.xp_cmdshell @query                
    set @bsequery = '''' + @bsequery + ''''                
    set @bsequery = 'exec master.dbo.xp_cmdshell ' + @bsequery                
  
    insert into #file                
    select @loopcount, 'vmss_output_bse_'+replace(convert(varchar,getdate(),103),'/','')+ convert(varchar,@loopcount)+'.dot'               
    WAITFOR DELAY '00:00:03';                
    exec (@bsequery)                
    --print @bsequery              
    set @i=@i+500                
  
    if((@rowcount-@j)>500)                
     set @j=@j+500                
    else                
     set @j=@j+(@rowcount-@j)                
       
    set @loopcount=@loopcount+1                
   END               
  
   /* for adding files into zip */                
   --select * from #file                
   set @loopcount = 1                
  
   while @loopcount <= (select count(*) from #file)                
   BEGIN  
    print @loopcount                
    set @sql = ''                
    select @source_file_name = source_file_name from #file where srno = @loopcount                
    set @sql = @zip_program_path + ' ' + @zip_path + @zip_file_name + ' ' + @file_path + @source_file_name + ' '                
    print @sql     
    exec master.dbo.xp_cmdshell @sql                
  
    set @loopcount = @loopcount + 1                
   END              
   select 'BSE file generated successfully'                
   /* for adding files into zip */                
  END          
  ELSE  
  BEGIN                    
   set @bsequery = ' bcp " select s,qty,qty1,scrip_cd,clsrate,client_code,eosess,client,l '          
   set @bsequery = @bsequery + ' from [csokyc-6].general.dbo.upd_bse_outfile_squp_var_margin_shortage_COMBINE '  
   set @bsequery = @bsequery + ' WHERE Client_code NOT IN (SELECT DISTINCT party_code FROM  [CSOKYC-6].MIS.dbo.VMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP WHERE EXCEPTION =''''Y'''')'            
   /*set @bsequery = @bsequery + '" queryout d:\mindgate\vmsssqofffile\vmss_output_bse_'+replace(convert(varchar,getdate(),103),'/','') + '.dot -c -t"|" -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc' */                            
   set @bsequery = @bsequery + '" queryout H:\mindgate\vmsssqofffile\vmss_output_bse_'+replace(convert(varchar,getdate(),103),'/','') + '.dot -c -t"|" -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc'                             

   set @bsequery = '''' + @bsequery + ''''                
   set @bsequery = 'exec master.dbo.xp_cmdshell'+ @bsequery                
   exec (@bsequery)                
     
   set @sql = ''                
   set @source_file_name = ''                
   set @source_file_name = 'vmss_output_bse_'+replace(convert(varchar,getdate(),103),'/','')+'.dot'                
   set @sql = @zip_program_path + ' ' + @zip_path + @zip_file_name + ' ' + @file_path + @source_file_name + ' '                
  
   waitfor delay '00:00:03';                
     
   exec master.dbo.xp_cmdshell @sql         
   select 'BSE file generated successfully'            
  END  
   
 END                     
  IF @segment = 'NSE'                            
  BEGIN  
   /*exec VMSS_NSE_VarShortage*/              
   set @zip_file_name = 'vmss_output_nse' + convert(varchar,getdate(),112) + '.zip'                
   /* select @rowcount =max(id) from [csokyc-6].general.dbo.upd_nse_outfile_squp_var_margin_shortage     */       
   select @rowcount=COUNT(1) from general.dbo.upd_nse_outfile_squp_var_margin_shortage_COMBINE                   
   WHERE Client_code NOT IN (SELECT DISTINCT party_code FROM  MIS.dbo.VMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP WHERE EXCEPTION = 'Y')    
  
  
   if(@rowcount>900)                
   begin                
    print @rowcount              
    set @loop=ceiling(convert(decimal(15,2),@rowcount)/900)                
  
    set @loopcount=1                
  
    set @i=1                
    set @j=900                
    while(@loopcount<=@loop)                
    begin                
   
     set @nsequery = ' bcp " select convert(char(13),id) as id,convert(char(2),regular_lot) as regular_lot , '                            
     set @nsequery = @nsequery + ' convert(char(2),buy_sell) as buy_sell , convert(char(10),symbol) as symbol , convert(char(2),series) as series , '                            
     set @nsequery = @nsequery + ' convert(char(2),instructions) as instructions, convert(char(11),default_1) as default_1, '                            
     set @nsequery = @nsequery + ' convert(char(2),default_2) as default_2 ,convert(char(9),default_3) as default_3 , convert(char(9),price) as price, '                            
     set @nsequery = @nsequery + ' convert(char(9),default_4) as default_4 ,convert(char(9),qty) as qty , convert(char(9), disclosed_qty) as disclosed_qty, '                            
     set @nsequery = @nsequery + ' convert(char(12),member_code) as member_code ,convert(char(2),pro_client) as pro_client, convert(char(10),client_code) as client_code, '                            
     set @nsequery = @nsequery + ' convert(char(25),default_5) as default_5,convert(char(16),default_6) as default_6, convert(char(10),default_7) as default_7 '                            
     set @nsequery = @nsequery + ' from [csokyc-6].general.dbo.upd_nse_outfile_squp_var_margin_shortage_COMBINE WHERE Client_code NOT IN (SELECT DISTINCT party_code '  
     set @nsequery = @nsequery + ' FROM  [CSOKYC-6].MIS.dbo.VMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP WHERE EXCEPTION =''''Y'''')" queryout '  
     /*set @nsequery = @nsequery + ' d:\mindgate\vmsssqofffile\vmss_output_nse_'+replace(convert(varchar,getdate(),103),'/','')+convert(varchar,@LoopCount)+'.csv -c -t"|" -Sintranet '  */
     set @nsequery = @nsequery + ' H:\mindgate\vmsssqofffile\vmss_output_nse_'+replace(convert(varchar,getdate(),103),'/','')+convert(varchar,@LoopCount)+'.csv -c -t"|" -Sintranet '  

     set @nsequery = @nsequery + ' -Uaolinhouse -Pe$$gnfDTVs2455GZAcc -F' + convert(varchar,@i) + ' -L' + convert(varchar,@j) + ' /'                
     set @nsequery = '''' + @nsequery + ''''                
     set @nsequery = 'exec master.dbo.xp_cmdshell'+ @nsequery                
  
     insert into #file                
     select @loopcount, 'vmss_output_nse_'+replace(convert(varchar,getdate(),103),'/','')+ convert(varchar,@loopcount)+'.csv'                
  
     exec (@nsequery)                
  
     WAITFOR DELAY '00:00:01';                
     set @i=@i+900                
     if((@rowcount-@j)>900)                
      set @j=@j+900                
     else                
      set @j=@j+(@rowcount-@j)  
                      
      set @loopcount=@loopcount+1                
    end                
    /* for adding files into zip */                
    set @loopcount = 1     
                 
    while @loopcount <= (select count(*) from #file)                
    begin                
     set @sql = ''                
     select @source_file_name = source_file_name from #file where srno = @loopcount                
     set @sql = @zip_program_path + ' ' + @zip_path + @zip_file_name + ' ' + @file_path + @source_file_name + ' '                
     exec master.dbo.xp_cmdshell @sql                 
     set @loopcount = @loopcount + 1                
     print @sql              
    end                
   /* for adding files into zip */                
   end              
   else               
   begin                
  
    set @nsequery = ' bcp " select convert(char(13),id) as id,convert(char(2),regular_lot) as regular_lot , '                            
    set @nsequery = @nsequery + ' convert(char(2),buy_sell) as buy_sell , convert(char(10),symbol) as symbol , convert(char(2),series) as series , '                            
    set @nsequery = @nsequery + ' convert(char(2),instructions) as instructions, convert(char(11),default_1) as default_1, '                            
    set @nsequery = @nsequery + ' convert(char(2),default_2) as default_2 ,convert(char(9),default_3) as default_3 , convert(char(9),price) as price, '                            
    set @nsequery = @nsequery + ' convert(char(9),default_4) as default_4 ,convert(char(9),qty) as qty , convert(char(9), disclosed_qty) as disclosed_qty, '                            
    set @nsequery = @nsequery + ' convert(char(12),member_code) as member_code ,convert(char(2),pro_client) as pro_client, convert(char(10),client_code) as client_code, '                            
    set @nsequery = @nsequery + ' convert(char(25),default_5) as default_5,convert(char(16),default_6) as default_6, convert(char(10),default_7) as default_7 '                            
    set @nsequery = @nsequery + ' from [csokyc-6].general.dbo.upd_nse_outfile_squp_var_margin_shortage_COMBINE WHERE Client_code NOT IN (SELECT DISTINCT party_code FROM  '    
    set @nsequery = @nsequery + ' [CSOKYC-6].MIS.dbo.VMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP WHERE EXCEPTION =''''Y'''')" queryout '  
    /*set @nsequery = @nsequery + ' d:\mindgate\vmsssqofffile\vmss_output_nse_'+replace(convert(varchar,getdate(),103),'/','')+'.csv -c -t"," -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '                         */
    set @nsequery = @nsequery + ' H:\mindgate\vmsssqofffile\vmss_output_nse_'+replace(convert(varchar,getdate(),103),'/','')+'.csv -c -t"," -Sintranet -Uaolinhouse -Pe$$gnfDTVs2455GZAcc '                         

    set @nsequery = '''' + @nsequery + ''''                            
    set @nsequery = 'exec master.dbo.xp_cmdshell'+ @nsequery                            
    --print @nsequery                            
  
    exec (@nsequery)                
  
    set @sql = ''                
    set @source_file_name = ''                
    set @source_file_name = 'vmss_output_nse_'+replace(convert(varchar,getdate(),103),'/','')+'.csv'                
    set @sql = @zip_program_path + ' ' + @zip_path + @zip_file_name + ' ' + @file_path + @source_file_name + ' '           
    print @sql                
  
    waitfor delay '00:00:03';                
    exec master.dbo.xp_cmdshell @sql                
    select 'NSE file generated successfully'                
   end                
 END  
  
  
 end try                                                           
 begin catch                                                              
 insert into general.dbo.eodboddetail_error(errtime,errobject,errline,errmessage)                                                                    
 select getdate(),'vmss_squp_generate_squareup_file',error_line(),error_message()                                                                    
 end catch                                       
END  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Upd_ASB7_Days
-- --------------------------------------------------
CREATE Procedure [dbo].[VMSS_Upd_ASB7_Days]    
as    
Set nocount on                                                                                                                
BEGIN TRY                                                                                                                                        
  
select rms_Date,party_code,T_day into #asb7day  
from mis.dbo.ASB7_Clidetails_CrDet_process2 where T_day >= 5  and rms_Date =  (select MAX(rms_Date) from mis.dbo.ASB7_Clidetails_CrDet_process2)   
and ISNULL(Sq_Amt,0) > 0
  
declare @rmsdate as datetime = 'Jan  1 1900'  
select @rmsdate=MAX(RMS_date) from mis.dbo.ASB7_Clidetails_CrDet_process2 where rms_Date < (select MAX(rms_Date) from mis.dbo.ASB7_Clidetails_CrDet_process2)   
  
update #asb7day set t_day=6 from   
(select party_code from mis.dbo.ASB7_Clidetails_CrDet_process2 where T_day >= 5  and rms_Date =  @rmsdate) a   
where #asb7day.party_code=a.party_Code   
  
select @rmsdate=MAX(RMS_date) from mis.dbo.ASB7_Clidetails_CrDet_process2 where rms_Date < @rmsdate  
  
update #asb7day set t_day=7 from   
(select party_code from mis.dbo.ASB7_Clidetails_CrDet_process2 where T_day >= 5  and rms_Date =  @rmsdate) a   
where #asb7day.party_code=a.party_Code  
  
delete from #asb7day where t_day <= 4   
    
 truncate table VMSS_ASB7_Days    
 insert into VMSS_ASB7_Days(rms_Date,Party_Code,t_Day)    
 select rms_Date,party_code,T_day from #asb7day   
 /* mis.dbo.ASB7_Clidetails_crdet where T_day >= 7  and rms_Date =    
 (select MAX(rms_Date) from mis.dbo.ASB7_Clidetails_crdet) */    
    
 drop table #asb7day   
 delete from VMSS_ASB7_Days_Hist where rms_Date = (select MAX(rms_Date) from VMSS_ASB7_Days)    
 insert into VMSS_ASB7_Days_Hist select rms_Date,Party_Code,t_Day from VMSS_ASB7_Days    
End try                                                                                                                                     
BEGIN CATCH                                                                                                                                        
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                              
  select GETDATE(),'VMSS_Upd_ASB7_Days',ERROR_LINE(),ERROR_MESSAGE()                                                                                                   
                          
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                              
  RAISERROR (@ErrorMessage , 16, 1);                                      
End catch                                                                                     
                          
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Upd_ASB7_Days_28072016
-- --------------------------------------------------
CREATE Procedure VMSS_Upd_ASB7_Days_28072016      
as      
Set nocount on                                                                                                                  
BEGIN TRY                                                                                                                                          
    
select rms_Date,party_code,T_day into #asb7day    
from mis.dbo.ASB7_Clidetails_crdet where T_day >= 5  and rms_Date =  (select MAX(rms_Date) from mis.dbo.ASB7_Clidetails_crdet)     
and ISNULL(Sq_Amt,0) > 0  
    
declare @rmsdate as datetime = 'Jan  1 1900'    
select @rmsdate=MAX(RMS_date) from mis.dbo.ASB7_Clidetails_crdet where rms_Date < (select MAX(rms_Date) from mis.dbo.ASB7_Clidetails_crdet)     
    
update #asb7day set t_day=8 from     
(select party_code from mis.dbo.ASB7_Clidetails_crdet where T_day >= 7  and rms_Date =  @rmsdate) a     
where #asb7day.party_code=a.party_Code     
    
select @rmsdate=MAX(RMS_date) from mis.dbo.ASB7_Clidetails_crdet where rms_Date < @rmsdate    
    
update #asb7day set t_day=9 from     
(select party_code from mis.dbo.ASB7_Clidetails_crdet where T_day >= 7  and rms_Date =  @rmsdate) a     
where #asb7day.party_code=a.party_Code    
    
delete from #asb7day where t_day <= 6     
      
 truncate table VMSS_ASB7_Days      
 insert into VMSS_ASB7_Days(rms_Date,Party_Code,t_Day)      
 select rms_Date,party_code,T_day from #asb7day     
 /* mis.dbo.ASB7_Clidetails_crdet where T_day >= 7  and rms_Date =      
 (select MAX(rms_Date) from mis.dbo.ASB7_Clidetails_crdet) */      
      
 drop table #asb7day     
 delete from VMSS_ASB7_Days_Hist where rms_Date = (select MAX(rms_Date) from VMSS_ASB7_Days)      
 insert into VMSS_ASB7_Days_Hist select rms_Date,Party_Code,t_Day from VMSS_ASB7_Days      
End try                                                                                                                                       
BEGIN CATCH                                                                                                                                          
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                                                                                                                
  select GETDATE(),'VMSS_Upd_ASB7_Days',ERROR_LINE(),ERROR_MESSAGE()                                                                                                     
                            
  DECLARE @ErrorMessage NVARCHAR(4000);                                                                  
  SELECT @ErrorMessage = ERROR_MESSAGE() + convert(varchar(10),error_line());                                
  RAISERROR (@ErrorMessage , 16, 1);                                        
End catch                                                                                       
                            
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Upd_Client_Collaterals
-- --------------------------------------------------

CREATE Procedure [dbo].[VMSS_Upd_Client_Collaterals]     
as    
    
Set nocount on                        
BEGIN TRY      
    
 truncate table vmss_NRMS_Client_Collaterals     
    
 insert into vmss_NRMS_Client_Collaterals(co_code,EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,    
 FinalAmount,PercentageCash,PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,LoginTime,Cash_Ncash,    
 Group_Code,Fd_Bg_No,Bank_Code,Fd_Type)     
 select co_code='NSEFO',EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,FinalAmount,PercentageCash,      
 PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,GETDATE(),Cash_Ncash,Group_Code,Fd_Bg_No,Bank_Code,Fd_Type      
 from ANGELFO.msajag.dbo.CollateralDetails WITH (NOLOCK) where exchange='NSE' and segment='FUTURES'     
 and effdate = (select max(effdate) from ANGELFO.msajag.dbo.CollateralDetails WITH (NOLOCK)      
 where effDate <= getdate() and exchange='NSE' and segment='FUTURES')      
    
 insert into vmss_NRMS_Client_Collaterals(co_code,EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,    
 FinalAmount,PercentageCash,PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,LoginTime,Cash_Ncash,    
 Group_Code,Fd_Bg_No,Bank_Code,Fd_Type)     
 select co_code='MCD',EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,FinalAmount,PercentageCash,      
 PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,GETDATE(),Cash_Ncash,Group_Code,Fd_Bg_No,Bank_Code,Fd_Type      
 from ANGELCOMMODITY.msajag.dbo.CollateralDetails WITH (NOLOCK)     
 where exchange='MCD' and segment='FUTURES' and effdate = (select max(effdate) from ANGELCOMMODITY.msajag.dbo.CollateralDetails WITH (NOLOCK)      
 where effDate <= getdate() and exchange='MCD' and segment='FUTURES')      
    
 insert into vmss_NRMS_Client_Collaterals(co_code,EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,    
 FinalAmount,PercentageCash,PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,LoginTime,Cash_Ncash,    
 Group_Code,Fd_Bg_No,Bank_Code,Fd_Type)     
 select co_code='NSX',EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,FinalAmount,PercentageCash,      
 PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,GETDATE(),Cash_Ncash,Group_Code,Fd_Bg_No,Bank_Code,Fd_Type      
 from ANGELFO.msajag.dbo.CollateralDetails WITH (NOLOCK)     
 where exchange='NSX' and segment='FUTURES' and effdate = (select max(effdate) from ANGELFO.msajag.dbo.CollateralDetails WITH (NOLOCK)      
 where effDate <= getdate() and exchange='NSX' and segment='FUTURES')  
 
 insert into vmss_NRMS_Client_Collaterals(co_code,EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,    
 FinalAmount,PercentageCash,PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,LoginTime,Cash_Ncash,    
 Group_Code,Fd_Bg_No,Bank_Code,Fd_Type)     
 select co_code='MCX',EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,FinalAmount,PercentageCash,      
 PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,GETDATE(),Cash_Ncash,Group_Code,Fd_Bg_No,Bank_Code,Fd_Type      
 from ANGELCOMMODITY.msajag.dbo.CollateralDetails WITH (NOLOCK)     
 where exchange='MCX' and segment='FUTURES' and effdate = (select max(effdate) from ANGELFO.msajag.dbo.CollateralDetails WITH (NOLOCK)      
 where effDate <= getdate() and exchange='MCX' and segment='FUTURES')  
 
 insert into vmss_NRMS_Client_Collaterals(co_code,EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,    
 FinalAmount,PercentageCash,PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,LoginTime,Cash_Ncash,    
 Group_Code,Fd_Bg_No,Bank_Code,Fd_Type)     
 select co_code='NCDEX',EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,FinalAmount,PercentageCash,      
 PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,GETDATE(),Cash_Ncash,Group_Code,Fd_Bg_No,Bank_Code,Fd_Type      
 from ANGELCOMMODITY.msajag.dbo.CollateralDetails WITH (NOLOCK)      
 where exchange='NCDEX' and segment='FUTURES' and effdate = (select max(effdate) from ANGELFO.msajag.dbo.CollateralDetails WITH (NOLOCK)      
 where effDate <= getdate() and exchange='NCDEX' and segment='FUTURES')     
    
 update vmss_NRMS_Client_Collaterals set cash_ncash='C' where scrip_cd='' and cash_ncash=''    
    
End try                                             
BEGIN CATCH                                                
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                      
  select GETDATE(),'VMSS_Upd_Client_Collaterals',ERROR_LINE(),ERROR_MESSAGE()                                                      
End catch                         
                        
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Upd_Client_Collaterals_bkup_29052020
-- --------------------------------------------------

create Procedure [dbo].[VMSS_Upd_Client_Collaterals_bkup_29052020]     
as    
    
Set nocount on                        
BEGIN TRY      
    
 truncate table vmss_NRMS_Client_Collaterals     
    
 insert into vmss_NRMS_Client_Collaterals(co_code,EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,    
 FinalAmount,PercentageCash,PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,LoginTime,Cash_Ncash,    
 Group_Code,Fd_Bg_No,Bank_Code,Fd_Type)     
 select co_code='NSEFO',EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,FinalAmount,PercentageCash,      
 PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,GETDATE(),Cash_Ncash,Group_Code,Fd_Bg_No,Bank_Code,Fd_Type      
 from ANGELFO.msajag.dbo.CollateralDetails WITH (NOLOCK) where exchange='NSE' and segment='FUTURES'     
 and effdate = (select max(effdate) from ANGELFO.msajag.dbo.CollateralDetails WITH (NOLOCK)      
 where effDate <= getdate() and exchange='NSE' and segment='FUTURES')      
    
 insert into vmss_NRMS_Client_Collaterals(co_code,EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,    
 FinalAmount,PercentageCash,PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,LoginTime,Cash_Ncash,    
 Group_Code,Fd_Bg_No,Bank_Code,Fd_Type)     
 select co_code='MCD',EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,FinalAmount,PercentageCash,      
 PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,GETDATE(),Cash_Ncash,Group_Code,Fd_Bg_No,Bank_Code,Fd_Type      
 from ANGELCOMMODITY.msajag.dbo.CollateralDetails WITH (NOLOCK)     
 where exchange='MCD' and segment='FUTURES' and effdate = (select max(effdate) from ANGELCOMMODITY.msajag.dbo.CollateralDetails WITH (NOLOCK)      
 where effDate <= getdate() and exchange='MCD' and segment='FUTURES')      
    
 insert into vmss_NRMS_Client_Collaterals(co_code,EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,    
 FinalAmount,PercentageCash,PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,LoginTime,Cash_Ncash,    
 Group_Code,Fd_Bg_No,Bank_Code,Fd_Type)     
 select co_code='NSX',EffDate,Exchange,Segment,Party_Code,Scrip_Cd,Series,Isin,Cl_Rate,Amount,Qty,HairCut,FinalAmount,PercentageCash,      
 PerecntageNonCash,Receive_Date,Maturity_Date,Coll_Type,ClientType,Remarks,LoginName,GETDATE(),Cash_Ncash,Group_Code,Fd_Bg_No,Bank_Code,Fd_Type      
 from ANGELFO.msajag.dbo.CollateralDetails WITH (NOLOCK)     
 where exchange='NSX' and segment='FUTURES' and effdate = (select max(effdate) from ANGELFO.msajag.dbo.CollateralDetails WITH (NOLOCK)      
 where effDate <= getdate() and exchange='NSX' and segment='FUTURES')     
    
 update vmss_NRMS_Client_Collaterals set cash_ncash='C' where scrip_cd='' and cash_ncash=''    
    
End try                                             
BEGIN CATCH                                                
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                      
  select GETDATE(),'VMSS_Upd_Client_Collaterals',ERROR_LINE(),ERROR_MESSAGE()                                                      
End catch                         
                        
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Upd_DP_Holding
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[VMSS_Upd_DP_Holding]      
AS      
      
SET XACT_ABORT ON                  
Set nocount on                  
BEGIN TRY       
    
    
  CREATE TABLE #db      
  (      
  hld_hold_date DATETIME,      
  hld_ac_Code VARCHAR(16),      
  hld_isin_code VARCHAR(14),      
  hld_ac_pos INT      
  )      
  CREATE CLUSTERED INDEX IDXDP ON #db (hld_isin_code)      
    
  INSERT INTO #db      
  SELECT hld_hold_date,hld_ac_Code,hld_isin_code,hld_ac_pos      
  FROM [AGMUBODPL3].Inhouse.dbo.holding WITH (NOLOCK)      
  WHERE hld_ac_type = '11'      
  AND hld_ac_pos > 0      
    
  /*----COMMENT FOR PRMS ID 10391191-----      
  SELECT cm_blsavingcd AS Client,cm_cd AS CLTDPID      
  INTO #NBFC_CLTDPID      
  FROM [196.1.115.199].synergy.dbo.client_master x WITH(NOLOCK)      
  INNER JOIN CLIENT_DETAILS Y WITH(NOLOCK)       
  ON x.cm_blsavingcd=y.party_code      
  WHERE Y.cl_type in ('NBF','TMF')      
  AND cm_brboffcode='MGR'      
  */      
    
  -----START---NEW LINE FOR PRMS ID 10391191------      
    
  select       
  X.party_code,      
  X.dpid,      
  X.cltdpid      
  into #temp from      
  (select A.party_code,A.bankid as dpid,A.cltdpid from       
  angeldemat.bsedb.dbo.client4 A with (nolock) INNER JOIN      
  ANGELDEMAT.BSEDB.DBO.MULTICLTID B WITH (NOLOCK)           
  ON  A.party_code = B.party_code       
  AND  A.bankid = B.DPID       
  AND  A.cltdpid = B.CLTDPNO      
  where A.defdp = 1 and left(A.party_code,2) <> '98' and A.bankid = '12033200'            
  group by A.party_code,A.bankid ,A.cltdpid       
    
  Union       
    
  select A.party_code,A.bankid as dpid,A.cltdpid       
  from angeldemat.msajag.dbo.client4 A with (nolock) INNER JOIN      
  ANGELDEMAT.MSAJAG.DBO.MULTICLTID B WITH (NOLOCK)      
  ON  A.party_code = B.party_code       
  AND  A.bankid = B.DPID       
  AND  A.cltdpid = B.CLTDPNO      
  where A.defdp = 1 and left(A.party_code,2) <> '98' and A.bankid = '12033200'            
  group by A.party_code,A.bankid ,A.cltdpid ) X      
    
    
  SELECT X.party_code AS Client,X.CLTDPID INTO  #NBFC_CLTDPID      
  FROM #temp x WITH (NOLOCK) JOIN      
  (SELECT party_code FROM General.dbo.client_details WHERE cl_type IN ('NBF','TMF')) y      
  ON x.party_code=y.party_code --AND cm_brboffcode='MGR'      
    
  -------END-------------      
    
  --START- ADD NEW LINE FOR PRMS ID 10391191       
  IF OBJECT_ID(N'NBFC_DPID') IS NOT NULL      
  DROP TABLE NBFC_DPID      
    
  select  a.* into  NBFC_DPID   
  FROM VMSS_DP_Holding a  JOIN #NBFC_CLTDPID b --INSERT NBFC CLIENT       
  ON a.Party_code = b.Client AND a.Cltdpid <> b.Cltdpid      
    
  --END---      
    
  TRUNCATE TABLE VMSS_DP_Holding      
    
  INSERT INTO VMSS_DP_Holding(HoldDate,Party_code,Cltdpid,isin,bsecode,nsesymbol,nseseries,holding,Category,id)      
  SELECT HoldDate=hld_hold_date,party_code,Cltdpid=hld_ac_code,isin=hld_isin_code,bsecode,      
  nsesymbol,nseseries,holding=hld_ac_pos,[Status],ROW_NUMBER() OVER ( ORDER BY party_code desc,isin desc) AS [id]  
  FROM #db a      
  INNER JOIN      
  (SELECT ID,isin,BseCode,NseSymbol,NseSeries,[Status]       
  FROM      
  (      
  SELECT ID=ROW_NUMBER() OVER(PARTITION BY ISIN ORDER BY ISIN,BseCode,NseSymbol),isin,BseCode,NseSymbol,NseSeries,status      
  FROM  General.dbo.scrip_master WITH(NOLOCK)      
  ) T      
  WHERE ID = 1      
  ) B      
  ON a.hld_isin_code = b.isin      
  INNER JOIN General.dbo.bo_dppoa c WITH(NOLOCK)       
  ON a.hld_ac_code = c.cltdpid      
  
  DELETE a FROM VMSS_DP_Holding a      
  INNER JOIN #NBFC_CLTDPID b       
  ON a.Party_code = b.Client       
  AND a.Cltdpid = b.Cltdpid      
      
  
  ------END------------------------------      
    
  /*ONLY ON SUNDAY*/      
  --IF (DATEPART(DW,GETDATE()) = 1)      
  /*Added by Abha on May 04 2015 to consider sebi payout hldng in DP */      
  
/*  
  IF (DATEPART(DW,GETDATE()) = 1) or (DATEPART(DW,GETDATE()) = 7)      
  begin      
   /*ADD QTY IN DP HOLDING*/      
   UPDATE X SET holding = holding + [payout qty]      
   FROM VMSS_DP_Holding X      
   INNER JOIN      
   (      
   SELECT a.party_code,ISIN,CLTPDPID=Bankid+Cltdpid,[payout qty]=SUM([payout qty])        
   FROM MIS.SCCS.dbo.Vw_SCCS_SharePODetails a WITH(NOLOCK)      
   INNER JOIN GENERAL.dbo.COLLATERAL_ACCOUNT_MASTER b WITH(NOLOCK)      
   ON a.fcltid = b.CLTPDPID      
   WHERE [payout qty] > 0      
   AND a.bankid = '12033200'      
   GROUP BY party_code,ISIN,Bankid+Cltdpid      
   ) Y      
   ON X.Party_Code = Y.Party_CODE AND X.Isin = Y.isin AND X.Cltdpid = Y.CLTPDPID      
   INNER JOIN GENERAL.dbo.Client_Details Z WITH(NOLOCK)      
   ON X.Party_code = Z.party_code      
   WHERE Z.Last_inactive_date > GETDATE()      
     
   DECLARE @DATE DATETIME      
   SELECT TOP 1 @DATE = HOLDDATE FROM VMSS_DP_Holding ORDER BY HOLDDATE DESC      
     
   INSERT INTO VMSS_DP_Holding(holddate,party_code,cltdpid,isin,bsecode,nsesymbol,nseseries,holding)      
   SELECT @DATE,X.Party_code,CONVERT(VARCHAR(25),X.CLTPDPID),x.isin,Scrip_Cd,Symbol,series,[payout qty]      
   FROM(      
   SELECT a.party_code,ISIN,CLTPDPID=Bankid+Cltdpid,[payout qty]=SUM([payout qty]),Scrip_Cd,Symbol,series      
   FROM MIS.SCCS.dbo.Vw_SCCS_SharePODetails a WITH(NOLOCK)      
   INNER JOIN GENERAL.dbo.COLLATERAL_ACCOUNT_MASTER b WITH(NOLOCK)      
   ON a.fcltid = b.CLTPDPID      
   WHERE [payout qty] > 0      
   AND a.bankid = '12033200'      
   GROUP BY party_code,ISIN,Bankid+Cltdpid,Scrip_Cd,Symbol,series      
   ) X      
   LEFT JOIN VMSS_DP_Holding Y      
   ON X.Party_Code = Y.Party_CODE AND X.Isin = Y.isin  AND X.CLTPDPID = Y.CLTDPID      
   INNER JOIN GENERAL.dbo.Client_Details Z WITH(NOLOCK)      
   ON X.Party_code = Z.party_code      
   WHERE Z.Last_inactive_date > GETDATE()      
   AND Y.PARTY_CODE IS NULL      
     
  /*POOL ACCOUNT UPDATION*/      
    
   SELECT * INTO #PoolAccMast FROM      
   (      
   SELECT DpType,DpID,DpCltNo,AccountType,Exchange,Segment      
   FROM ANGELDEMAT.BSEDB.Dbo.DeliveryDp WHERE Accounttype = 'BEN' AND SEGMENT = 'CAPITAL'      
   UNION      
   SELECT DpType,DpID,DpCltNo,AccountType,Exchange,Segment      
   FROM ANGELDEMAT.MSAJAG.Dbo.DeliveryDp WHERE Accounttype = 'BEN' AND SEGMENT = 'CAPITAL'      
   ) Temp      
     
   UPDATE X SET holding = holding + [payout qty]      
   FROM VMSS_DP_Holding X      
   INNER JOIN      
   (      
   SELECT a.party_code,ISIN,CLTPDPID=Bankid+Cltdpid,[payout qty]=SUM([payout qty])      
   FROM MIS.SCCS.dbo.Vw_SCCS_SharePODetails a WITH(NOLOCK)      
   INNER JOIN #PoolAccMast b WITH(NOLOCK)      
   ON a.fcltid = b.DPCLTNO      
   WHERE [payout qty] > 0      
   AND a.bankid = '12033200'      
   GROUP BY party_code,ISIN,Bankid+Cltdpid      
   ) Y      
   ON X.Party_Code = Y.Party_CODE AND X.Isin = Y.isin AND X.Cltdpid = Y.CLTPDPID      
   INNER JOIN GENERAL.dbo.Client_Details Z WITH(NOLOCK)      
   ON X.Party_code = Z.party_code      
   WHERE Z.Last_inactive_date > GETDATE()      
     
   INSERT INTO VMSS_DP_Holding(holddate,party_code,cltdpid,isin,bsecode,nsesymbol,nseseries,holding)      
   SELECT @DATE,X.Party_code,Cltdpid= CONVERT(VARCHAR(30),X.CLTPDPID),X.ISIN,Scrip_Cd,Symbol,series,[payout qty]      
   FROM(      
   SELECT a.party_code,ISIN,CLTPDPID=Bankid+Cltdpid,[payout qty]=SUM([payout qty]),Scrip_Cd,Symbol,series--,CO_CODE,CLTPDPID      
   FROM MIS.SCCS.dbo.Vw_SCCS_SharePODetails a WITH(NOLOCK)      
   INNER JOIN #PoolAccMast b WITH(NOLOCK)      
   ON a.fcltid = b.DPCLTNO      
   WHERE [payout qty] > 0      
   AND a.bankid = '12033200'      
   GROUP BY party_code,ISIN,Bankid+Cltdpid,Scrip_Cd,Symbol,series      
   ) X      
   LEFT JOIN VMSS_DP_Holding Y      
   ON X.Party_Code = Y.Party_CODE AND X.Isin = Y.isin  AND X.CLTPDPID = Y.CLTDPID      
   INNER JOIN GENERAL.dbo.Client_Details Z WITH(NOLOCK)      
   ON X.Party_code = Z.party_code      
   WHERE Z.Last_inactive_date > GETDATE()      
   AND Y.PARTY_CODE IS NULL      
     
   /* DELETE NON POA OR PArtial POA Client's Holding */    
     
  end      
*/  
     
   DELETE X     
   from VMSS_DP_Holding X     
   left outer join    
   (    
   SELECT Client_Code FROM MIS.KYC.DBO.tbl_POA_details WITH(nolock)    
   WHERE Created_By IS NOT NULL    
   GRoup by Client_Code    
   ) Y on  x.party_code=Y.client_Code where Y.client_code is null    
  
   delete from VMSS_DP_Holding where isnull(Category,'Poor')='Poor'  
  
   update VMSS_DP_Holding set Clsrate=b.cls   
   from General.dbo.CP_NSECM b where VMSS_DP_Holding.nsesymbol=b.scrip and VMSS_DP_Holding.nseseries=b.series  
  
   update VMSS_DP_Holding set Clsrate=b.rate  
   from General.dbo.CP_BSECM b where VMSS_DP_Holding.bsecode=b.scode and isnull(clsrate,0)=0  
     
  update VMSS_DP_Holding set Haircut=b.AutoSharePO_Var,CATEGORY=SCRIP_CATEGORY from                               
  General.dbo.Scrip_ValidOnlyVar b                               
  where VMSS_DP_Holding.isin=B.isin   
    
    update VMSS_DP_Holding set VBHC=isnull(Clsrate,0)*holding
    update VMSS_DP_Holding set VAHC=VBHC*((100-HAIRCUT)/100.00),SqOffQty=0,SqOffSeq=0  
  
End try                                       
BEGIN CATCH                                          
  insert into general.DBO.EODBODDetail_Error(ErrTime,ErrObject,ErrLine,ErrMessage)                                                
  select GETDATE(),'VMSS_Upd_DP_Holding',ERROR_LINE(),ERROR_MESSAGE()                                                
End catch                   
  
                  
SET NOCOUNT OFF

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_Update_Var_Margin_ExceptionRemark
-- --------------------------------------------------
      
/******************************************************************************          
  CREATED BY:       
  DATE  : 24 FEB 2014      
  PURPOSE : TO MAINTAIN HISTORY OF SQUAREUP CLIENT T7 EXCEPTION      
*****************************************************************************/          
          
          
CREATE PROC [dbo].[VMSS_Update_Var_Margin_ExceptionRemark]       
(            
 @Exception AS CHAR(1),            
 @REMARKS AS VARCHAR(250),            
 @PARTY_CODE AS VARCHAR(25),          
 @IPaddress as varchar(25),          
 @Enteredby as varchar(15)            
)            
AS            
BEGIN            
     
     
  
      INSERT INTO VMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP_HIST       
      SELECT     
      REGION,BRANCH,SB,party_code,CATEGORY,cli_type,SB_CATEGORY,VarMarginShortFall_AftAdj,SquareOffValue,Noofdays,  
      update_date=GETDATE(),Mobile_pager,    
      Email,Exception=@Exception,Remarks=@REMARKS,    
      AMOUNT,SOURCE_TYPE,    
      IPADDRESS=@IPADDRESS,       
      ENTERED_BY=@ENTEREDBY     
      FROM vMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP      
      WHERE party_code =@PARTY_CODE       
            
   UPDATE vMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP SET Exception=@Exception,REMARKS=@REMARKS WHERE party_code=@PARTY_CODE            
        
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_UPDstatus
-- --------------------------------------------------

CREATE procedure [dbo].[VMSS_UPDstatus](@flag as int)  
as  
set nocount on  
update VMSS_processStatus  set UpdStatus = @flag,UpdDate=GETDATE()  
set nocount off

GO

-- --------------------------------------------------
-- PROCEDURE dbo.VMSS_VarPer_Haircut
-- --------------------------------------------------
-- =============================================  
-- Author:  abha jaiswal  
-- Create date: May 02 2016  
-- Description: Daily process to store var % and haircut of vmss process   
-- =============================================  
CREATE PROCEDURE [dbo].[VMSS_VarPer_Haircut]   
AS  
BEGIN  
select x.ProcessDate,x.EXCHANGE,x.sett_no,x.SEtt_type,x.scrip_cd,x.series,x.Party_code,x.Qty,x.CLSRATE,x.VBHC,x.HAIRCUT,      
x.VAHC,x.CATEGORY,x.SRC,x.SquareOffQty,x.id,x.SqOffseq,x.AdjAmt,x.ISIN,x.FromAcc,x.ToAcc,x.ToSegment,x.SHRT_HC,x.total_WithHC,      
x.nse_approved,x.BSE_Var_Display,x.NSE_Var_Display,x.NSE_proj_VaR,x.Bse_var,x.Bse_final_var,x.BSE_proj_VaR,x.nse_final_var,x.angel_var,  
x.NSE_var,c.scripname into #temp from        
(        
 SELECT                       
 A.*,vahc AS total_WithHC,nse_approved=Category,BSE_Var_Display,NSE_Var_Display,NSE_proj_VaR,Bse_var,        
 Bse_final_var,BSE_proj_VaR,nse_final_var,angel_var,NSE_var        
 FROM                         
 (            
  SELECT P.*,Q.SHRT_HC             
  FROM squareoff.dbo.VMSS_HOLDING P(NOLOCK) INNER JOIN GENERAL.dbo.COMPANY Q (NOLOCK)            
  ON P.EXCHANGE=Q.CO_CODE            
 ) A             
 LEFT OUTER JOIN             
 GENERAL.DBO.Scrip_ValidOnlyVar B (NOLOCK)              
 ON A.ISIN=B.ISIN               
         
 )x         
 left outer join (select scripname,isin,nse_approved,scrip_cd from squareoff.dbo.vmss_rms_holding   
 group by scripname,isin,nse_approved,scrip_cd ) c        
 on x.isin=c.isin  and x.scrip_cd=c.scrip_cd  
  
 --select * into VMSS_holding_Var from #temp where 1=2  
  
 insert into VMSS_holding_Var   
 select * from #temp  
   
 drop table #temp  
   
END

GO

-- --------------------------------------------------
-- TABLE dbo.day_defination_change
-- --------------------------------------------------
CREATE TABLE [dbo].[day_defination_change]
(
    [object_name] NVARCHAR(128) NOT NULL,
    [schema_name] NVARCHAR(128) NULL,
    [type_desc] NVARCHAR(60) NULL,
    [create_date] DATETIME NOT NULL,
    [modify_date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FileData
-- --------------------------------------------------
CREATE TABLE [dbo].[FileData]
(
    [FileData] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FileData_BKUP_21072017
-- --------------------------------------------------
CREATE TABLE [dbo].[FileData_BKUP_21072017]
(
    [FileData] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FileData_rohit_23092015
-- --------------------------------------------------
CREATE TABLE [dbo].[FileData_rohit_23092015]
(
    [FileData] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.FileData_Temp
-- --------------------------------------------------
CREATE TABLE [dbo].[FileData_Temp]
(
    [FileData] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.LAS_S
-- --------------------------------------------------
CREATE TABLE [dbo].[LAS_S]
(
    [From Id] VARCHAR(50) NULL,
    [New Account] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [Quantity] VARCHAR(50) NULL,
    [EXCHNAGE] VARCHAR(11) NULL,
    [SR_NO] BIGINT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.las_shift
-- --------------------------------------------------
CREATE TABLE [dbo].[las_shift]
(
    [From Id] VARCHAR(50) NULL,
    [New Account] VARCHAR(50) NULL,
    [ISIN] VARCHAR(50) NULL,
    [Quantity] VARCHAR(50) NULL,
    [EXCHNAGE] VARCHAR(11) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_Batch_Process
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_Batch_Process]
(
    [Srno] INT NOT NULL,
    [ProcedureName] VARCHAR(200) NULL,
    [Active_Status] INT NULL,
    [StartDate] DATETIME NULL,
    [EndDate] DATETIME NULL,
    [Flag] INT NULL,
    [spdesc] VARCHAR(200) NULL,
    [Errflag] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_data
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_data]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_data_04092017
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_data_04092017]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_data_13102017
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_data_13102017]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_data_17082017
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_data_17082017]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_data_18072017
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_data_18072017]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_data_18102017
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_data_18102017]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_data_22092017
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_data_22092017]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_data_24082017
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_data_24082017]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_data_28082017
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_data_28082017]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_data_Bkp24Jan2019
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_data_Bkp24Jan2019]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_data_highestSeq
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_data_highestSeq]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_data_live_imp_backup_22092020
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_data_live_imp_backup_22092020]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_data_new
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_data_new]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_data_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_data_testing]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_data_tt
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_data_tt]
(
    [Processdate] DATETIME NULL,
    [Entity] VARCHAR(70) NULL,
    [party_code] VARCHAR(50) NULL,
    [NoofDays] INT NULL,
    [Shortage] MONEY NULL,
    [HoldingBHC] MONEY NULL,
    [HoldingAhC] MONEY NULL,
    [SquareoffValue] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_DP_Holding
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_DP_Holding]
(
    [HoldDate] DATETIME NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Cltdpid] VARCHAR(25) NULL,
    [isin] VARCHAR(25) NULL,
    [bsecode] VARCHAR(15) NULL,
    [nsesymbol] VARCHAR(15) NULL,
    [nseseries] VARCHAR(15) NULL,
    [holding] MONEY NULL,
    [Clsrate] MONEY NULL,
    [VBHC] MONEY NULL,
    [Category] VARCHAR(10) NULL,
    [HairCut] MONEY NULL,
    [VAHC] MONEY NULL,
    [SqOffQty] INT NULL,
    [SqOffSeq] INT NULL,
    [id] INT NULL,
    [AdjAmt] MONEY NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_holding
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_holding]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL,
    [accno] VARCHAR(150) NULL,
    [ShortageReduction] MONEY NULL,
    [shortage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_HOLDING_04092017
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_HOLDING_04092017]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL,
    [accno] VARCHAR(150) NULL,
    [ShortageReduction] MONEY NULL,
    [shortage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_holding_highest
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_holding_highest]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL,
    [accno] VARCHAR(150) NULL,
    [ShortageReduction] MONEY NULL,
    [shortage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_holding_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_holding_hist]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL,
    [accno] VARCHAR(150) NULL,
    [ShortageReduction] MONEY NULL,
    [shortage] MONEY NULL,
    [histdate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_holding_test
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_holding_test]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL,
    [accno] VARCHAR(150) NULL,
    [ShortageReduction] MONEY NULL,
    [shortage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_holding_tt
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_holding_tt]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL,
    [accno] VARCHAR(150) NULL,
    [ShortageReduction] MONEY NULL,
    [shortage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_holding_vishal28082017
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_holding_vishal28082017]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL,
    [accno] VARCHAR(150) NULL,
    [ShortageReduction] MONEY NULL,
    [shortage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_processStatus
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_processStatus]
(
    [UpdStatus] INT NULL,
    [UpdDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtf_rms_holding
-- --------------------------------------------------
CREATE TABLE [dbo].[mtf_rms_holding]
(
    [isin] VARCHAR(20) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(25) NULL,
    [sett_no] VARCHAR(10) NULL,
    [sett_type] VARCHAR(5) NULL,
    [party_Code] VARCHAR(10) NULL,
    [bs] VARCHAR(1) NULL,
    [exchange] VARCHAR(10) NULL,
    [qty] FLOAT NULL,
    [clsrate] MONEY NULL,
    [accno] VARCHAR(20) NULL,
    [dpid] VARCHAR(20) NULL,
    [clid] VARCHAR(20) NULL,
    [flag] VARCHAR(10) NULL,
    [aben] MONEY NULL,
    [apool] MONEY NULL,
    [nben] MONEY NULL,
    [npool] MONEY NULL,
    [approved] VARCHAR(10) NULL,
    [scripname] VARCHAR(50) NULL,
    [partyname] VARCHAR(100) NULL,
    [pool] VARCHAR(10) NULL,
    [total] MONEY NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] VARCHAR(50) NULL,
    [nse_approved] VARCHAR(10) NULL,
    [source] VARCHAR(2) NULL,
    [upd_date] DATETIME NULL,
    [AdjQty] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_ScripMaster
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_ScripMaster]
(
    [Entereddate] VARCHAR(25) NULL,
    [Isin] VARCHAR(75) NULL,
    [Scrip_CodeNSE] VARCHAR(75) NULL,
    [Scrip_CodeBSE] VARCHAR(75) NULL,
    [ScripName] VARCHAR(75) NULL,
    [FromDate] VARCHAR(25) NULL,
    [Todate] VARCHAR(25) NULL,
    [SpecialRemarks] VARCHAR(5000) NULL,
    [Secvar] MONEY NULL,
    [Splvar] MONEY NULL,
    [Folisted] VARCHAR(20) NULL,
    [Multiplier] INT NULL,
    [FinalHaircut] MONEY NULL,
    [srno] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_ScripMaster_BO
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_ScripMaster_BO]
(
    [Srno] INT NULL,
    [Entereddate] VARCHAR(25) NULL,
    [Isin] VARCHAR(75) NULL,
    [Scrip_CodeNSE] VARCHAR(75) NULL,
    [Scrip_CodeBSE] VARCHAR(75) NULL,
    [ScripName] VARCHAR(75) NULL,
    [FromDate] VARCHAR(25) NULL,
    [Todate] VARCHAR(25) NULL,
    [SpecialRemarks] VARCHAR(5000) NULL,
    [Secvar] MONEY NULL,
    [Splvar] MONEY NULL,
    [Folisted] VARCHAR(20) NULL,
    [Multiplier] INT NULL,
    [FinalHaircut] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_ScripMaster_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_ScripMaster_hist]
(
    [Srno] INT NULL,
    [Entereddate] VARCHAR(25) NULL,
    [Isin] VARCHAR(75) NULL,
    [Scrip_CodeNSE] VARCHAR(75) NULL,
    [Scrip_CodeBSE] VARCHAR(75) NULL,
    [ScripName] VARCHAR(75) NULL,
    [FromDate] VARCHAR(25) NULL,
    [Todate] VARCHAR(25) NULL,
    [SpecialRemarks] VARCHAR(5000) NULL,
    [Secvar] MONEY NULL,
    [Splvar] MONEY NULL,
    [Folisted] VARCHAR(20) NULL,
    [Multiplier] INT NULL,
    [FinalHaircut] MONEY NULL,
    [historydate] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_ScripMaster_test_01102019
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_ScripMaster_test_01102019]
(
    [Srno] INT NULL,
    [Entereddate] VARCHAR(25) NULL,
    [Isin] VARCHAR(75) NULL,
    [Scrip_CodeNSE] VARCHAR(75) NULL,
    [Scrip_CodeBSE] VARCHAR(75) NULL,
    [ScripName] VARCHAR(75) NULL,
    [FromDate] VARCHAR(25) NULL,
    [Todate] VARCHAR(25) NULL,
    [SpecialRemarks] VARCHAR(5000) NULL,
    [Secvar] MONEY NULL,
    [Splvar] MONEY NULL,
    [Folisted] VARCHAR(20) NULL,
    [Multiplier] INT NULL,
    [FinalHaircut] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_sqoff_client_exp
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_sqoff_client_exp]
(
    [region] VARCHAR(20) NULL,
    [branch] VARCHAR(100) NULL,
    [sb] VARCHAR(10) NULL,
    [party_code] VARCHAR(50) NULL,
    [category] VARCHAR(10) NULL,
    [cli_type] VARCHAR(10) NULL,
    [sb_category] VARCHAR(25) NULL,
    [Shortage] MONEY NULL,
    [squareoffvalue] MONEY NULL,
    [noofdays] INT NULL,
    [update_date] DATETIME NOT NULL,
    [mobile_pager] VARCHAR(40) NULL,
    [email] VARCHAR(50) NULL,
    [balance] VARCHAR(1) NOT NULL,
    [holdingbhc] MONEY NULL,
    [holdingahc] MONEY NULL,
    [exception] VARCHAR(10) NULL,
    [remarks] VARCHAR(50) NULL,
    [amount] NUMERIC(18, 0) NULL,
    [source_type] VARCHAR(10) NULL,
    [IPADDRESS] VARCHAR(20) NULL,
    [ENTERED_BY] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_sqoff_client_exp_04092017
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_sqoff_client_exp_04092017]
(
    [region] VARCHAR(20) NULL,
    [branch] VARCHAR(100) NULL,
    [sb] VARCHAR(10) NULL,
    [party_code] VARCHAR(50) NULL,
    [category] VARCHAR(10) NULL,
    [cli_type] VARCHAR(10) NULL,
    [sb_category] VARCHAR(10) NULL,
    [Shortage] MONEY NULL,
    [squareoffvalue] MONEY NULL,
    [noofdays] INT NULL,
    [update_date] DATETIME NOT NULL,
    [mobile_pager] VARCHAR(40) NULL,
    [email] VARCHAR(50) NULL,
    [balance] VARCHAR(1) NOT NULL,
    [holdingbhc] MONEY NULL,
    [holdingahc] MONEY NULL,
    [exception] VARCHAR(10) NULL,
    [remarks] VARCHAR(50) NULL,
    [amount] NUMERIC(18, 0) NULL,
    [source_type] VARCHAR(10) NULL,
    [IPADDRESS] VARCHAR(20) NULL,
    [ENTERED_BY] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_sqoff_client_exp_22092017
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_sqoff_client_exp_22092017]
(
    [region] VARCHAR(20) NULL,
    [branch] VARCHAR(100) NULL,
    [sb] VARCHAR(10) NULL,
    [party_code] VARCHAR(50) NULL,
    [category] VARCHAR(10) NULL,
    [cli_type] VARCHAR(10) NULL,
    [sb_category] VARCHAR(10) NULL,
    [Shortage] MONEY NULL,
    [squareoffvalue] MONEY NULL,
    [noofdays] INT NULL,
    [update_date] DATETIME NOT NULL,
    [mobile_pager] VARCHAR(40) NULL,
    [email] VARCHAR(50) NULL,
    [balance] VARCHAR(1) NOT NULL,
    [holdingbhc] MONEY NULL,
    [holdingahc] MONEY NULL,
    [exception] VARCHAR(10) NULL,
    [remarks] VARCHAR(50) NULL,
    [amount] NUMERIC(18, 0) NULL,
    [source_type] VARCHAR(10) NULL,
    [IPADDRESS] VARCHAR(20) NULL,
    [ENTERED_BY] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_sqoff_client_exp_Bkp24Jan2019
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_sqoff_client_exp_Bkp24Jan2019]
(
    [region] VARCHAR(20) NULL,
    [branch] VARCHAR(100) NULL,
    [sb] VARCHAR(10) NULL,
    [party_code] VARCHAR(50) NULL,
    [category] VARCHAR(10) NULL,
    [cli_type] VARCHAR(10) NULL,
    [sb_category] VARCHAR(10) NULL,
    [Shortage] MONEY NULL,
    [squareoffvalue] MONEY NULL,
    [noofdays] INT NULL,
    [update_date] DATETIME NOT NULL,
    [mobile_pager] VARCHAR(40) NULL,
    [email] VARCHAR(50) NULL,
    [balance] VARCHAR(1) NOT NULL,
    [holdingbhc] MONEY NULL,
    [holdingahc] MONEY NULL,
    [exception] VARCHAR(10) NULL,
    [remarks] VARCHAR(50) NULL,
    [amount] NUMERIC(18, 0) NULL,
    [source_type] VARCHAR(10) NULL,
    [IPADDRESS] VARCHAR(20) NULL,
    [ENTERED_BY] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_sqoff_client_exp_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_sqoff_client_exp_hist]
(
    [region] VARCHAR(20) NULL,
    [branch] VARCHAR(100) NULL,
    [sb] VARCHAR(10) NULL,
    [party_code] VARCHAR(50) NULL,
    [category] VARCHAR(10) NULL,
    [cli_type] VARCHAR(10) NULL,
    [sb_category] VARCHAR(25) NULL,
    [Shortage] MONEY NULL,
    [squareoffvalue] MONEY NULL,
    [noofdays] INT NULL,
    [update_date] DATETIME NOT NULL,
    [mobile_pager] VARCHAR(40) NULL,
    [email] VARCHAR(50) NULL,
    [balance] VARCHAR(1) NOT NULL,
    [holdingbhc] MONEY NULL,
    [holdingahc] MONEY NULL,
    [exception] VARCHAR(10) NULL,
    [remarks] VARCHAR(50) NULL,
    [amount] NUMERIC(18, 0) NULL,
    [source_type] VARCHAR(10) NULL,
    [IPADDRESS] VARCHAR(20) NULL,
    [ENTERED_BY] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.MTF_WORKING
-- --------------------------------------------------
CREATE TABLE [dbo].[MTF_WORKING]
(
    [sr_no] VARCHAR(50) NULL,
    [Party_Code] VARCHAR(50) NULL,
    [Isin] VARCHAR(50) NULL,
    [Total] VARCHAR(50) NULL,
    [From Account] VARCHAR(50) NULL,
    [To Account] VARCHAR(50) NULL,
    [batch_no] INT NULL,
    [segment] VARCHAR(10) NULL,
    [rowno] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.mtfhold
-- --------------------------------------------------
CREATE TABLE [dbo].[mtfhold]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL,
    [accno] VARCHAR(150) NULL,
    [ShortageReduction] MONEY NULL,
    [shortage] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.NBFC_DPID
-- --------------------------------------------------
CREATE TABLE [dbo].[NBFC_DPID]
(
    [HoldDate] DATETIME NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Cltdpid] VARCHAR(25) NULL,
    [isin] VARCHAR(25) NULL,
    [bsecode] VARCHAR(15) NULL,
    [nsesymbol] VARCHAR(15) NULL,
    [nseseries] VARCHAR(15) NULL,
    [holding] MONEY NULL,
    [Clsrate] MONEY NULL,
    [VBHC] MONEY NULL,
    [Category] VARCHAR(10) NULL,
    [HairCut] MONEY NULL,
    [VAHC] MONEY NULL,
    [SqOffQty] INT NULL,
    [SqOffSeq] INT NULL,
    [id] INT NULL,
    [AdjAmt] MONEY NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PURE_RISK_JV_DP_file
-- --------------------------------------------------
CREATE TABLE [dbo].[PURE_RISK_JV_DP_file]
(
    [ClientCode] VARCHAR(20) NULL,
    [ScripCode] VARCHAR(20) NULL,
    [Series] VARCHAR(10) NULL,
    [ISIN] VARCHAR(25) NULL,
    [Quantity] INT NULL,
    [FromDP] VARCHAR(25) NULL,
    [FromID] VARCHAR(25) NULL,
    [TargetDp] VARCHAR(25) NULL,
    [TargetId] VARCHAR(25) NULL,
    [Type1] VARCHAR(20) NULL,
    [segment] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PURE_RISK_JV_DP_file_BKUP_21072017
-- --------------------------------------------------
CREATE TABLE [dbo].[PURE_RISK_JV_DP_file_BKUP_21072017]
(
    [ClientCode] VARCHAR(20) NULL,
    [ScripCode] VARCHAR(20) NULL,
    [Series] VARCHAR(10) NULL,
    [ISIN] VARCHAR(25) NULL,
    [Quantity] INT NULL,
    [FromDP] VARCHAR(25) NULL,
    [FromID] VARCHAR(25) NULL,
    [TargetDp] VARCHAR(25) NULL,
    [TargetId] VARCHAR(25) NULL,
    [Type1] VARCHAR(20) NULL,
    [segment] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_asb7_ageing_debit_days_08082016
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_asb7_ageing_debit_days_08082016]
(
    [party_code] VARCHAR(10) NOT NULL,
    [t_day] INT NOT NULL,
    [Ageing_day] INT NOT NULL,
    [rms_date] DATETIME NOT NULL,
    [Processdate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MTF_FinalShortage
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MTF_FinalShortage]
(
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [NET_MTF_REQ_Old] NUMERIC(38, 4) NULL,
    [NET_MTF_REQ] NUMERIC(38, 4) NULL,
    [SAUDA_DATE] VARCHAR(10) NULL,
    [net_ledger] MONEY NULL,
    [recipent_val] MONEY NULL,
    [upd_date] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_mtf_poa_holding
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_mtf_poa_holding]
(
    [party_code] VARCHAR(10) NOT NULL,
    [value_after_hc] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MTF_Region_Activation
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MTF_Region_Activation]
(
    [Region] VARCHAR(100) NULL,
    [Branch] VARCHAR(50) NULL,
    [Migration_Date] DATETIME NULL,
    [VMSS_Close_date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_MTF_share_movement
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_MTF_share_movement]
(
    [ClientCode] VARCHAR(20) NULL,
    [ScripCode] VARCHAR(20) NULL,
    [Series] VARCHAR(10) NULL,
    [ISIN] VARCHAR(25) NULL,
    [Quantity] INT NULL,
    [FromDP] VARCHAR(25) NULL,
    [FromID] VARCHAR(25) NULL,
    [TargetDp] VARCHAR(25) NULL,
    [TargetId] VARCHAR(25) NULL,
    [Type1] VARCHAR(20) NULL,
    [segment] VARCHAR(50) NULL,
    [symbol] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_PureRisk_DP_ADJ_SMS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_PureRisk_DP_ADJ_SMS_LOG]
(
    [party_code] VARCHAR(20) NULL,
    [Mobile_No] VARCHAR(20) NULL,
    [SMS_Content] VARCHAR(1000) NULL,
    [Msg_Date] VARCHAR(20) NULL,
    [Msg_By] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_purerisk_fetch_18062019
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_purerisk_fetch_18062019]
(
    [clientcode] NVARCHAR(255) NULL,
    [projected] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_PureRiskAdj_SMS_log
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_PureRiskAdj_SMS_log]
(
    [party_code] VARCHAR(20) NULL,
    [Mobile_Pager] VARCHAR(20) NULL,
    [SMS_Content] VARCHAR(MAX) NULL,
    [Msg_date] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_share_fetching_17012020
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_share_fetching_17012020]
(
    [Party Code] NVARCHAR(255) NULL,
    [Isin] NVARCHAR(255) NULL,
    [DPID] NVARCHAR(255) NULL,
    [Qty] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tbl_sharefetch_excluCodes
-- --------------------------------------------------
CREATE TABLE [dbo].[tbl_sharefetch_excluCodes]
(
    [Party_Code] NVARCHAR(255) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_VMSS_DP_ADJ_SMS_LOG
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_VMSS_DP_ADJ_SMS_LOG]
(
    [party_code] VARCHAR(20) NULL,
    [Mobile_No] VARCHAR(20) NULL,
    [SMS_Content] VARCHAR(1000) NULL,
    [Msg_Date] VARCHAR(20) NULL,
    [Msg_By] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tbl_VMSSDPAdj_SMS_log
-- --------------------------------------------------
CREATE TABLE [dbo].[Tbl_VMSSDPAdj_SMS_log]
(
    [party_code] VARCHAR(20) NULL,
    [Mobile_Pager] VARCHAR(20) NULL,
    [SMS_Content] VARCHAR(MAX) NULL,
    [Msg_date] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmp_FileData
-- --------------------------------------------------
CREATE TABLE [dbo].[tmp_FileData]
(
    [FileData] VARCHAR(MAX) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.tmp_PURE_RISK_JV_DP_file
-- --------------------------------------------------
CREATE TABLE [dbo].[tmp_PURE_RISK_JV_DP_file]
(
    [ClientCode] VARCHAR(20) NULL,
    [ScripCode] VARCHAR(20) NULL,
    [Series] VARCHAR(10) NULL,
    [ISIN] VARCHAR(25) NULL,
    [Quantity] INT NULL,
    [FromDP] VARCHAR(25) NULL,
    [FromID] VARCHAR(25) NULL,
    [TargetDp] VARCHAR(25) NULL,
    [TargetId] VARCHAR(25) NULL,
    [Type1] VARCHAR(20) NULL,
    [segment] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Tmp_RMS_Holding
-- --------------------------------------------------
CREATE TABLE [dbo].[Tmp_RMS_Holding]
(
    [isin] VARCHAR(20) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(25) NULL,
    [sett_no] VARCHAR(10) NULL,
    [sett_type] VARCHAR(5) NULL,
    [party_Code] VARCHAR(10) NULL,
    [bs] VARCHAR(1) NULL,
    [exchange] VARCHAR(10) NULL,
    [qty] FLOAT NULL,
    [clsrate] MONEY NULL,
    [accno] VARCHAR(20) NULL,
    [dpid] VARCHAR(20) NULL,
    [clid] VARCHAR(20) NULL,
    [flag] VARCHAR(10) NULL,
    [aben] MONEY NULL,
    [apool] MONEY NULL,
    [nben] MONEY NULL,
    [npool] MONEY NULL,
    [approved] VARCHAR(10) NULL,
    [scripname] VARCHAR(50) NULL,
    [partyname] VARCHAR(100) NULL,
    [pool] VARCHAR(10) NULL,
    [total] MONEY NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] VARCHAR(50) NULL,
    [nse_approved] VARCHAR(10) NULL,
    [source] VARCHAR(2) NULL,
    [upd_date] DATETIME NULL,
    [AdjQty] FLOAT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.upd_bse_outfile_squp_MTF_shortage
-- --------------------------------------------------
CREATE TABLE [dbo].[upd_bse_outfile_squp_MTF_shortage]
(
    [S] VARCHAR(1) NOT NULL,
    [Qty] INT NULL,
    [Qty1] INT NULL,
    [Scrip_Cd] VARCHAR(15) NULL,
    [clsrate] INT NULL,
    [Client_Code] VARCHAR(100) NULL,
    [EOSESS] VARCHAR(6) NOT NULL,
    [CLIENT] VARCHAR(6) NOT NULL,
    [L] VARCHAR(1) NOT NULL,
    [Srno] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.upd_bse_outfile_squp_MTF_shortage_Bkp24Jan2019
-- --------------------------------------------------
CREATE TABLE [dbo].[upd_bse_outfile_squp_MTF_shortage_Bkp24Jan2019]
(
    [S] VARCHAR(1) NOT NULL,
    [Qty] INT NULL,
    [Qty1] INT NULL,
    [Scrip_Cd] VARCHAR(15) NULL,
    [clsrate] INT NULL,
    [Client_Code] VARCHAR(100) NULL,
    [EOSESS] VARCHAR(6) NOT NULL,
    [CLIENT] VARCHAR(6) NOT NULL,
    [L] VARCHAR(1) NOT NULL,
    [Srno] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.upd_bse_outfile_squp_var_margin_shortage
-- --------------------------------------------------
CREATE TABLE [dbo].[upd_bse_outfile_squp_var_margin_shortage]
(
    [S] VARCHAR(1) NOT NULL,
    [Qty] INT NULL,
    [Qty1] INT NULL,
    [Scrip_Cd] VARCHAR(15) NULL,
    [clsrate] INT NULL,
    [Client_Code] VARCHAR(100) NULL,
    [EOSESS] VARCHAR(6) NOT NULL,
    [CLIENT] VARCHAR(6) NOT NULL,
    [L] VARCHAR(1) NOT NULL,
    [Srno] INT IDENTITY(1,1) NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.upd_nse_outfile_squp_MTF_shortage
-- --------------------------------------------------
CREATE TABLE [dbo].[upd_nse_outfile_squp_MTF_shortage]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [Regular_Lot] VARCHAR(1) NULL,
    [Buy_Sell] INT NULL,
    [Symbol] VARCHAR(15) NULL,
    [Series] VARCHAR(25) NULL,
    [Instructions] INT NULL,
    [Default_1] VARCHAR(1) NULL,
    [Default_2] VARCHAR(1) NULL,
    [Default_3] VARCHAR(1) NULL,
    [price] INT NULL,
    [Default_4] VARCHAR(1) NULL,
    [qty] FLOAT NULL,
    [Disclosed_Qty] INT NULL,
    [Member_Code] VARCHAR(5) NULL,
    [Pro_Client] VARCHAR(1) NULL,
    [Client_Code] VARCHAR(10) NULL,
    [Default_5] VARCHAR(1) NULL,
    [Default_6] VARCHAR(1) NULL,
    [Default_7] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.upd_nse_outfile_squp_MTF_shortage_Bkp24Jan2019
-- --------------------------------------------------
CREATE TABLE [dbo].[upd_nse_outfile_squp_MTF_shortage_Bkp24Jan2019]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [Regular_Lot] VARCHAR(1) NULL,
    [Buy_Sell] INT NULL,
    [Symbol] VARCHAR(15) NULL,
    [Series] VARCHAR(25) NULL,
    [Instructions] INT NULL,
    [Default_1] VARCHAR(1) NULL,
    [Default_2] VARCHAR(1) NULL,
    [Default_3] VARCHAR(1) NULL,
    [price] INT NULL,
    [Default_4] VARCHAR(1) NULL,
    [qty] FLOAT NULL,
    [Disclosed_Qty] INT NULL,
    [Member_Code] VARCHAR(5) NULL,
    [Pro_Client] VARCHAR(1) NULL,
    [Client_Code] VARCHAR(10) NULL,
    [Default_5] VARCHAR(1) NULL,
    [Default_6] VARCHAR(1) NULL,
    [Default_7] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.upd_nse_outfile_squp_var_margin_shortage
-- --------------------------------------------------
CREATE TABLE [dbo].[upd_nse_outfile_squp_var_margin_shortage]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [Regular_Lot] VARCHAR(1) NULL,
    [Buy_Sell] INT NULL,
    [Symbol] VARCHAR(15) NULL,
    [Series] VARCHAR(25) NULL,
    [Instructions] INT NULL,
    [Default_1] VARCHAR(1) NULL,
    [Default_2] VARCHAR(1) NULL,
    [Default_3] VARCHAR(1) NULL,
    [price] INT NULL,
    [Default_4] VARCHAR(1) NULL,
    [qty] FLOAT NULL,
    [Disclosed_Qty] INT NULL,
    [Member_Code] VARCHAR(5) NULL,
    [Pro_Client] VARCHAR(1) NULL,
    [Client_Code] VARCHAR(10) NULL,
    [Default_5] VARCHAR(1) NULL,
    [Default_6] VARCHAR(1) NULL,
    [Default_7] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_ASB7_Days
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_ASB7_Days]
(
    [Rms_date] DATETIME NULL,
    [Party_code] VARCHAR(10) NULL,
    [T_day] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_ASB7_Days_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_ASB7_Days_hist]
(
    [Rms_date] DATETIME NULL,
    [Party_code] VARCHAR(10) NULL,
    [T_day] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_Batch_process
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_Batch_process]
(
    [Srno] INT NOT NULL,
    [ProcedureName] VARCHAR(200) NULL,
    [Active_Status] INT NULL,
    [StartDate] DATETIME NULL,
    [EndDate] DATETIME NULL,
    [Flag] INT NULL,
    [spdesc] VARCHAR(200) NULL,
    [Errflag] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_Batch_process_29072016
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_Batch_process_29072016]
(
    [Srno] INT NOT NULL,
    [ProcedureName] VARCHAR(200) NULL,
    [Active_Status] INT NULL,
    [StartDate] DATETIME NULL,
    [EndDate] DATETIME NULL,
    [Flag] INT NULL,
    [spdesc] VARCHAR(200) NULL,
    [Errflag] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_Batch_process_log
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_Batch_process_log]
(
    [Srno] INT NULL,
    [ProcedureName] VARCHAR(200) NULL,
    [Active_Status] INT NULL,
    [StartDate] DATETIME NULL,
    [EndDate] DATETIME NULL,
    [Flag] INT NULL,
    [spdesc] VARCHAR(200) NULL,
    [Errflag] VARCHAR(100) NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_BSE_DelTrans
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_BSE_DelTrans]
(
    [SNo] NUMERIC(18, 0) NOT NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sett_type] VARCHAR(2) NULL,
    [RefNo] INT NOT NULL,
    [TCode] NUMERIC(18, 0) NOT NULL,
    [TrType] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [series] VARCHAR(3) NULL,
    [Qty] NUMERIC(18, 0) NOT NULL,
    [FromNo] VARCHAR(16) NULL,
    [ToNo] VARCHAR(16) NULL,
    [CertNo] VARCHAR(16) NULL,
    [FolioNo] VARCHAR(16) NULL,
    [HolderName] VARCHAR(100) NULL,
    [Reason] VARCHAR(100) NULL,
    [DrCr] CHAR(1) NULL,
    [Delivered] CHAR(1) NULL,
    [OrgQty] NUMERIC(18, 0) NULL,
    [DpType] VARCHAR(10) NULL,
    [DpId] VARCHAR(16) NULL,
    [CltDpId] VARCHAR(16) NULL,
    [BranchCd] VARCHAR(10) NULL,
    [PartipantCode] VARCHAR(10) NULL,
    [SlipNo] NUMERIC(18, 0) NULL,
    [BatchNo] VARCHAR(10) NULL,
    [ISett_No] VARCHAR(7) NULL,
    [ISett_Type] VARCHAR(2) NULL,
    [ShareType] VARCHAR(8) NULL,
    [TransDate] DATETIME NOT NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [BDpType] VARCHAR(10) NULL,
    [BDpId] VARCHAR(16) NULL,
    [BCltDpId] VARCHAR(16) NULL,
    [Filler4] DATETIME NULL,
    [Filler5] INT NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(7) NULL,
    [UpdatedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_BSE_DelTrans_08092015
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_BSE_DelTrans_08092015]
(
    [SNo] NUMERIC(18, 0) NOT NULL,
    [Sett_No] VARCHAR(7) NULL,
    [Sett_type] VARCHAR(2) NULL,
    [RefNo] INT NOT NULL,
    [TCode] NUMERIC(18, 0) NOT NULL,
    [TrType] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [series] VARCHAR(3) NULL,
    [Qty] NUMERIC(18, 0) NOT NULL,
    [FromNo] VARCHAR(16) NULL,
    [ToNo] VARCHAR(16) NULL,
    [CertNo] VARCHAR(16) NULL,
    [FolioNo] VARCHAR(16) NULL,
    [HolderName] VARCHAR(100) NULL,
    [Reason] VARCHAR(100) NULL,
    [DrCr] CHAR(1) NULL,
    [Delivered] CHAR(1) NULL,
    [OrgQty] NUMERIC(18, 0) NULL,
    [DpType] VARCHAR(10) NULL,
    [DpId] VARCHAR(16) NULL,
    [CltDpId] VARCHAR(16) NULL,
    [BranchCd] VARCHAR(10) NULL,
    [PartipantCode] VARCHAR(10) NULL,
    [SlipNo] NUMERIC(18, 0) NULL,
    [BatchNo] VARCHAR(10) NULL,
    [ISett_No] VARCHAR(7) NULL,
    [ISett_Type] VARCHAR(2) NULL,
    [ShareType] VARCHAR(8) NULL,
    [TransDate] DATETIME NOT NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [BDpType] VARCHAR(10) NULL,
    [BDpId] VARCHAR(16) NULL,
    [BCltDpId] VARCHAR(16) NULL,
    [Filler4] DATETIME NULL,
    [Filler5] INT NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(7) NULL,
    [UpdatedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_CollAdj
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_CollAdj]
(
    [Co_code] VARCHAR(5) NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [ISIN] VARCHAR(16) NULL,
    [Qty] NUMERIC(38, 0) NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_CollAdj_08092015
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_CollAdj_08092015]
(
    [Co_code] VARCHAR(5) NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [ISIN] VARCHAR(16) NULL,
    [Qty] NUMERIC(38, 0) NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_CollAdj_14122015
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_CollAdj_14122015]
(
    [Co_code] VARCHAR(5) NOT NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [ISIN] VARCHAR(16) NULL,
    [Qty] NUMERIC(38, 0) NULL,
    [UpdatedOn] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_data
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_data]
(
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [NoofDays] INT NULL,
    [Balance] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [Holding_BHC] MONEY NULL,
    [Holding_AHC] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [EarlyPayinValue] MONEY NULL,
    [LeverageMultiplier] MONEY NULL,
    [VarMarginShortFall] MONEY NULL,
    [NSEFO_JV] MONEY NULL,
    [NSEFO_NonCash] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [MCD_NonCash] MONEY NULL,
    [NSX_JV] MONEY NULL,
    [NSX_NonCash] MONEY NULL,
    [VarMarginShortFall_AftAdj] MONEY NULL,
    [SquareOffValue] MONEY NULL,
    [BSECM_Balance] MONEY NULL,
    [NSECM_Balance] MONEY NULL,
    [updatedon] DATETIME NULL,
    [flag] CHAR(1) NULL,
    [Remarks] VARCHAR(50) NULL,
    [DP_adj] MONEY NULL,
    [VarMarRelSqAmt] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL,
    [VarMarginShortFall_AftAdjCurrDay] MONEY NULL,
    [MCX_JV] MONEY NULL,
    [MCX_NonCash] MONEY NULL,
    [NCDEX_JV] MONEY NULL,
    [NCDEX_NonCash] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_data_08082016
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_data_08082016]
(
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [NoofDays] INT NULL,
    [Balance] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [Holding_BHC] MONEY NULL,
    [Holding_AHC] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [EarlyPayinValue] MONEY NULL,
    [LeverageMultiplier] MONEY NULL,
    [VarMarginShortFall] MONEY NULL,
    [NSEFO_JV] MONEY NULL,
    [NSEFO_NonCash] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [MCD_NonCash] MONEY NULL,
    [NSX_JV] MONEY NULL,
    [NSX_NonCash] MONEY NULL,
    [VarMarginShortFall_AftAdj] MONEY NULL,
    [SquareOffValue] MONEY NULL,
    [BSECM_Balance] MONEY NULL,
    [NSECM_Balance] MONEY NULL,
    [updatedon] DATETIME NULL,
    [flag] CHAR(1) NULL,
    [Remarks] VARCHAR(50) NULL,
    [DP_adj] MONEY NULL,
    [VarMarRelSqAmt] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL,
    [VarMarginShortFall_AftAdjCurrDay] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_Data_08092015
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_Data_08092015]
(
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [NoofDays] INT NULL,
    [Balance] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [Holding_BHC] MONEY NULL,
    [Holding_AHC] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [EarlyPayinValue] MONEY NULL,
    [LeverageMultiplier] MONEY NULL,
    [VarMarginShortFall] MONEY NULL,
    [NSEFO_JV] MONEY NULL,
    [NSEFO_NonCash] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [MCD_NonCash] MONEY NULL,
    [NSX_JV] MONEY NULL,
    [NSX_NonCash] MONEY NULL,
    [VarMarginShortFall_AftAdj] MONEY NULL,
    [SquareOffValue] MONEY NULL,
    [BSECM_Balance] MONEY NULL,
    [NSECM_Balance] MONEY NULL,
    [updatedon] DATETIME NULL,
    [flag] CHAR(1) NULL,
    [Remarks] VARCHAR(50) NULL,
    [DP_adj] MONEY NULL,
    [VarMarRelSqAmt] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL,
    [VarMarginShortFall_AftAdjCurrDay] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_data_11122015T
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_data_11122015T]
(
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [NoofDays] INT NULL,
    [Balance] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [Holding_BHC] MONEY NULL,
    [Holding_AHC] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [EarlyPayinValue] MONEY NULL,
    [LeverageMultiplier] MONEY NULL,
    [VarMarginShortFall] MONEY NULL,
    [NSEFO_JV] MONEY NULL,
    [NSEFO_NonCash] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [MCD_NonCash] MONEY NULL,
    [NSX_JV] MONEY NULL,
    [NSX_NonCash] MONEY NULL,
    [VarMarginShortFall_AftAdj] MONEY NULL,
    [SquareOffValue] MONEY NULL,
    [BSECM_Balance] MONEY NULL,
    [NSECM_Balance] MONEY NULL,
    [updatedon] DATETIME NULL,
    [flag] CHAR(1) NULL,
    [Remarks] VARCHAR(50) NULL,
    [DP_adj] MONEY NULL,
    [VarMarRelSqAmt] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL,
    [VarMarginShortFall_AftAdjCurrDay] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_data_29072016
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_data_29072016]
(
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [NoofDays] INT NULL,
    [Balance] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [Holding_BHC] MONEY NULL,
    [Holding_AHC] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [EarlyPayinValue] MONEY NULL,
    [LeverageMultiplier] MONEY NULL,
    [VarMarginShortFall] MONEY NULL,
    [NSEFO_JV] MONEY NULL,
    [NSEFO_NonCash] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [MCD_NonCash] MONEY NULL,
    [NSX_JV] MONEY NULL,
    [NSX_NonCash] MONEY NULL,
    [VarMarginShortFall_AftAdj] MONEY NULL,
    [SquareOffValue] MONEY NULL,
    [BSECM_Balance] MONEY NULL,
    [NSECM_Balance] MONEY NULL,
    [updatedon] DATETIME NULL,
    [flag] CHAR(1) NULL,
    [Remarks] VARCHAR(50) NULL,
    [DP_adj] MONEY NULL,
    [VarMarRelSqAmt] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL,
    [VarMarginShortFall_AftAdjCurrDay] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_Data_A92196_14062016
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_Data_A92196_14062016]
(
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [NoofDays] INT NULL,
    [Balance] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [Holding_BHC] MONEY NULL,
    [Holding_AHC] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [EarlyPayinValue] MONEY NULL,
    [LeverageMultiplier] MONEY NULL,
    [VarMarginShortFall] MONEY NULL,
    [NSEFO_JV] MONEY NULL,
    [NSEFO_NonCash] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [MCD_NonCash] MONEY NULL,
    [NSX_JV] MONEY NULL,
    [NSX_NonCash] MONEY NULL,
    [VarMarginShortFall_AftAdj] MONEY NULL,
    [SquareOffValue] MONEY NULL,
    [BSECM_Balance] MONEY NULL,
    [NSECM_Balance] MONEY NULL,
    [updatedon] DATETIME NULL,
    [flag] CHAR(1) NULL,
    [Remarks] VARCHAR(50) NULL,
    [DP_adj] MONEY NULL,
    [VarMarRelSqAmt] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL,
    [VarMarginShortFall_AftAdjCurrDay] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_data_abha
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_data_abha]
(
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [NoofDays] INT NULL,
    [Balance] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [Holding_BHC] MONEY NULL,
    [Holding_AHC] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [EarlyPayinValue] MONEY NULL,
    [LeverageMultiplier] MONEY NULL,
    [VarMarginShortFall] MONEY NULL,
    [NSEFO_JV] MONEY NULL,
    [NSEFO_NonCash] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [MCD_NonCash] MONEY NULL,
    [NSX_JV] MONEY NULL,
    [NSX_NonCash] MONEY NULL,
    [VarMarginShortFall_AftAdj] MONEY NULL,
    [SquareOffValue] MONEY NULL,
    [BSECM_Balance] MONEY NULL,
    [NSECM_Balance] MONEY NULL,
    [updatedon] DATETIME NULL,
    [flag] CHAR(1) NULL,
    [Remarks] VARCHAR(50) NULL,
    [DP_adj] MONEY NULL,
    [VarMarRelSqAmt] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL,
    [VarMarginShortFall_AftAdjCurrDay] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_Data_all_14062016
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_Data_all_14062016]
(
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [NoofDays] INT NULL,
    [Balance] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [Holding_BHC] MONEY NULL,
    [Holding_AHC] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [EarlyPayinValue] MONEY NULL,
    [LeverageMultiplier] MONEY NULL,
    [VarMarginShortFall] MONEY NULL,
    [NSEFO_JV] MONEY NULL,
    [NSEFO_NonCash] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [MCD_NonCash] MONEY NULL,
    [NSX_JV] MONEY NULL,
    [NSX_NonCash] MONEY NULL,
    [VarMarginShortFall_AftAdj] MONEY NULL,
    [SquareOffValue] MONEY NULL,
    [BSECM_Balance] MONEY NULL,
    [NSECM_Balance] MONEY NULL,
    [updatedon] DATETIME NULL,
    [flag] CHAR(1) NULL,
    [Remarks] VARCHAR(50) NULL,
    [DP_adj] MONEY NULL,
    [VarMarRelSqAmt] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL,
    [VarMarginShortFall_AftAdjCurrDay] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_Data_all_14062016_all_14062016
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_Data_all_14062016_all_14062016]
(
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [NoofDays] INT NULL,
    [Balance] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [Holding_BHC] MONEY NULL,
    [Holding_AHC] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [EarlyPayinValue] MONEY NULL,
    [LeverageMultiplier] MONEY NULL,
    [VarMarginShortFall] MONEY NULL,
    [NSEFO_JV] MONEY NULL,
    [NSEFO_NonCash] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [MCD_NonCash] MONEY NULL,
    [NSX_JV] MONEY NULL,
    [NSX_NonCash] MONEY NULL,
    [VarMarginShortFall_AftAdj] MONEY NULL,
    [SquareOffValue] MONEY NULL,
    [BSECM_Balance] MONEY NULL,
    [NSECM_Balance] MONEY NULL,
    [updatedon] DATETIME NULL,
    [flag] CHAR(1) NULL,
    [Remarks] VARCHAR(50) NULL,
    [DP_adj] MONEY NULL,
    [VarMarRelSqAmt] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL,
    [VarMarginShortFall_AftAdjCurrDay] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_data_BTST
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_data_BTST]
(
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [NoofDays] INT NULL,
    [Balance] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [Holding_BHC] MONEY NULL,
    [Holding_AHC] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [EarlyPayinValue] MONEY NULL,
    [LeverageMultiplier] MONEY NULL,
    [VarMarginShortFall] MONEY NULL,
    [NSEFO_JV] MONEY NULL,
    [NSEFO_NonCash] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [MCD_NonCash] MONEY NULL,
    [NSX_JV] MONEY NULL,
    [NSX_NonCash] MONEY NULL,
    [VarMarginShortFall_AftAdj] MONEY NULL,
    [SquareOffValue] MONEY NULL,
    [BSECM_Balance] MONEY NULL,
    [NSECM_Balance] MONEY NULL,
    [updatedon] DATETIME NULL,
    [flag] CHAR(1) NULL,
    [Remarks] VARCHAR(50) NULL,
    [DP_adj] MONEY NULL,
    [VarMarRelSqAmt] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL,
    [VarMarginShortFall_AftAdjCurrDay] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_data_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_data_hist]
(
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [NoofDays] INT NULL,
    [Balance] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [Holding_BHC] MONEY NULL,
    [Holding_AHC] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [EarlyPayinValue] MONEY NULL,
    [LeverageMultiplier] MONEY NULL,
    [VarMarginShortFall] MONEY NULL,
    [NSEFO_JV] MONEY NULL,
    [NSEFO_NonCash] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [MCD_NonCash] MONEY NULL,
    [NSX_JV] MONEY NULL,
    [NSX_NonCash] MONEY NULL,
    [VarMarginShortFall_AftAdj] MONEY NULL,
    [SquareOffValue] MONEY NULL,
    [BSECM_Balance] MONEY NULL,
    [NSECM_Balance] MONEY NULL,
    [updatedon] DATETIME NULL,
    [flag] CHAR(1) NULL,
    [Remarks] VARCHAR(50) NULL,
    [DP_adj] MONEY NULL,
    [VarMarRelSqAmt] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL,
    [VarMarginShortFall_AftAdjCurrDay] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_data_hist_29072016
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_data_hist_29072016]
(
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [NoofDays] INT NULL,
    [Balance] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [Holding_BHC] MONEY NULL,
    [Holding_AHC] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [EarlyPayinValue] MONEY NULL,
    [LeverageMultiplier] MONEY NULL,
    [VarMarginShortFall] MONEY NULL,
    [NSEFO_JV] MONEY NULL,
    [NSEFO_NonCash] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [MCD_NonCash] MONEY NULL,
    [NSX_JV] MONEY NULL,
    [NSX_NonCash] MONEY NULL,
    [VarMarginShortFall_AftAdj] MONEY NULL,
    [SquareOffValue] MONEY NULL,
    [BSECM_Balance] MONEY NULL,
    [NSECM_Balance] MONEY NULL,
    [updatedon] DATETIME NULL,
    [flag] CHAR(1) NULL,
    [Remarks] VARCHAR(50) NULL,
    [DP_adj] MONEY NULL,
    [VarMarRelSqAmt] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL,
    [VarMarginShortFall_AftAdjCurrDay] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_Data_todays_Aug032016
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_Data_todays_Aug032016]
(
    [processDate] DATETIME NULL,
    [Entity] VARCHAR(10) NULL,
    [Party_code] VARCHAR(10) NULL,
    [NoofDays] INT NULL,
    [Balance] MONEY NULL,
    [MarginAmt] MONEY NULL,
    [Deposit] MONEY NULL,
    [CashColl] MONEY NULL,
    [NonCashColl] MONEY NULL,
    [Holding_BHC] MONEY NULL,
    [Holding_AHC] MONEY NULL,
    [OtherDebit] MONEY NULL,
    [EarlyPayinValue] MONEY NULL,
    [LeverageMultiplier] MONEY NULL,
    [VarMarginShortFall] MONEY NULL,
    [NSEFO_JV] MONEY NULL,
    [NSEFO_NonCash] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [MCD_NonCash] MONEY NULL,
    [NSX_JV] MONEY NULL,
    [NSX_NonCash] MONEY NULL,
    [VarMarginShortFall_AftAdj] MONEY NULL,
    [SquareOffValue] MONEY NULL,
    [BSECM_Balance] MONEY NULL,
    [NSECM_Balance] MONEY NULL,
    [updatedon] DATETIME NULL,
    [flag] CHAR(1) NULL,
    [Remarks] VARCHAR(50) NULL,
    [DP_adj] MONEY NULL,
    [VarMarRelSqAmt] MONEY NULL,
    [Actual_Cash_Square_Off_Done] MONEY NULL,
    [VarMarginShortFall_AftAdjCurrDay] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_DP_Holding
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_DP_Holding]
(
    [HoldDate] DATETIME NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Cltdpid] VARCHAR(25) NULL,
    [isin] VARCHAR(25) NULL,
    [bsecode] VARCHAR(15) NULL,
    [nsesymbol] VARCHAR(15) NULL,
    [nseseries] VARCHAR(15) NULL,
    [holding] MONEY NULL,
    [Clsrate] MONEY NULL,
    [VBHC] MONEY NULL,
    [Category] VARCHAR(10) NULL,
    [HairCut] MONEY NULL,
    [VAHC] MONEY NULL,
    [SqOffQty] INT NULL,
    [SqOffSeq] INT NULL,
    [id] INT NULL,
    [AdjAmt] MONEY NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_DP_Holding_08092015
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_DP_Holding_08092015]
(
    [HoldDate] DATETIME NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Cltdpid] VARCHAR(25) NULL,
    [isin] VARCHAR(25) NULL,
    [bsecode] VARCHAR(15) NULL,
    [nsesymbol] VARCHAR(15) NULL,
    [nseseries] VARCHAR(15) NULL,
    [holding] MONEY NULL,
    [Clsrate] MONEY NULL,
    [VBHC] MONEY NULL,
    [Category] VARCHAR(10) NULL,
    [HairCut] MONEY NULL,
    [VAHC] MONEY NULL,
    [SqOffQty] INT NULL,
    [SqOffSeq] INT NULL,
    [id] INT NULL,
    [AdjAmt] MONEY NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_DP_holding_A92196_14062016
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_DP_holding_A92196_14062016]
(
    [HoldDate] DATETIME NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Cltdpid] VARCHAR(25) NULL,
    [isin] VARCHAR(25) NULL,
    [bsecode] VARCHAR(15) NULL,
    [nsesymbol] VARCHAR(15) NULL,
    [nseseries] VARCHAR(15) NULL,
    [holding] MONEY NULL,
    [Clsrate] MONEY NULL,
    [VBHC] MONEY NULL,
    [Category] VARCHAR(10) NULL,
    [HairCut] MONEY NULL,
    [VAHC] MONEY NULL,
    [SqOffQty] INT NULL,
    [SqOffSeq] INT NULL,
    [id] INT NULL,
    [AdjAmt] MONEY NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_DP_Holding_Heading
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_DP_Holding_Heading]
(
    [HoldDate] VARCHAR(25) NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Cltdpid] VARCHAR(25) NULL,
    [isin] VARCHAR(25) NULL,
    [bsecode] VARCHAR(15) NULL,
    [nsesymbol] VARCHAR(15) NULL,
    [nseseries] VARCHAR(15) NULL,
    [holding] VARCHAR(25) NULL,
    [Clsrate] VARCHAR(25) NULL,
    [VBHC] VARCHAR(25) NULL,
    [Category] VARCHAR(10) NULL,
    [HairCut] VARCHAR(25) NULL,
    [VAHC] VARCHAR(25) NULL,
    [SqOffQty] VARCHAR(25) NULL,
    [SqOffSeq] VARCHAR(25) NULL,
    [id] VARCHAR(25) NULL,
    [AdjAmt] VARCHAR(25) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_DP_holding_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_DP_holding_hist]
(
    [HoldDate] DATETIME NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Cltdpid] VARCHAR(25) NULL,
    [isin] VARCHAR(25) NULL,
    [bsecode] VARCHAR(15) NULL,
    [nsesymbol] VARCHAR(15) NULL,
    [nseseries] VARCHAR(15) NULL,
    [holding] MONEY NULL,
    [Clsrate] MONEY NULL,
    [VBHC] MONEY NULL,
    [Category] VARCHAR(10) NULL,
    [HairCut] MONEY NULL,
    [VAHC] MONEY NULL,
    [SqOffQty] INT NULL,
    [SqOffSeq] INT NULL,
    [id] INT NULL,
    [AdjAmt] MONEY NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_DP_holding_hist_29072016
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_DP_holding_hist_29072016]
(
    [HoldDate] DATETIME NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Cltdpid] VARCHAR(25) NULL,
    [isin] VARCHAR(25) NULL,
    [bsecode] VARCHAR(15) NULL,
    [nsesymbol] VARCHAR(15) NULL,
    [nseseries] VARCHAR(15) NULL,
    [holding] MONEY NULL,
    [Clsrate] MONEY NULL,
    [VBHC] MONEY NULL,
    [Category] VARCHAR(10) NULL,
    [HairCut] MONEY NULL,
    [VAHC] MONEY NULL,
    [SqOffQty] INT NULL,
    [SqOffSeq] INT NULL,
    [id] INT NULL,
    [AdjAmt] MONEY NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_DP_Holding_rohit_23092015
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_DP_Holding_rohit_23092015]
(
    [HoldDate] DATETIME NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Cltdpid] VARCHAR(25) NULL,
    [isin] VARCHAR(25) NULL,
    [bsecode] VARCHAR(15) NULL,
    [nsesymbol] VARCHAR(15) NULL,
    [nseseries] VARCHAR(15) NULL,
    [holding] MONEY NULL,
    [Clsrate] MONEY NULL,
    [VBHC] MONEY NULL,
    [Category] VARCHAR(10) NULL,
    [HairCut] MONEY NULL,
    [VAHC] MONEY NULL,
    [SqOffQty] INT NULL,
    [SqOffSeq] INT NULL,
    [id] INT NULL,
    [AdjAmt] MONEY NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_DP_holding_testing
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_DP_holding_testing]
(
    [HoldDate] DATETIME NULL,
    [Party_code] VARCHAR(10) NOT NULL,
    [Cltdpid] VARCHAR(25) NULL,
    [isin] VARCHAR(25) NULL,
    [bsecode] VARCHAR(15) NULL,
    [nsesymbol] VARCHAR(15) NULL,
    [nseseries] VARCHAR(15) NULL,
    [holding] MONEY NULL,
    [Clsrate] MONEY NULL,
    [VBHC] MONEY NULL,
    [Category] VARCHAR(10) NULL,
    [HairCut] MONEY NULL,
    [VAHC] MONEY NULL,
    [SqOffQty] INT NULL,
    [SqOffSeq] INT NULL,
    [id] INT NULL,
    [AdjAmt] MONEY NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_EarlyPayinData
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_EarlyPayinData]
(
    [Exchange] VARCHAR(10) NULL,
    [Sett_No] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(2) NULL,
    [Scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(5) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [UpdatedOn] DATETIME NULL,
    [QTY] INT NULL,
    [Clsrate] MONEY NULL,
    [Total] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_EarlyPayinData_08092015
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_EarlyPayinData_08092015]
(
    [Exchange] VARCHAR(10) NULL,
    [Sett_No] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(2) NULL,
    [Scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(5) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [UpdatedOn] DATETIME NULL,
    [QTY] INT NULL,
    [Clsrate] MONEY NULL,
    [Total] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_EarlyPayinData_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_EarlyPayinData_bse]
(
    [Exchange] VARCHAR(10) NULL,
    [Sett_No] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(2) NULL,
    [Scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(5) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [UpdatedOn] DATETIME NULL,
    [QTY] INT NULL,
    [Clsrate] MONEY NULL,
    [Total] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_EarlyPayinData_Hist
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_EarlyPayinData_Hist]
(
    [Exchange] VARCHAR(10) NULL,
    [Sett_No] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(2) NULL,
    [Scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(5) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [UpdatedOn] DATETIME NULL,
    [QTY] INT NULL,
    [Clsrate] MONEY NULL,
    [Total] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_Exception_NSESeries
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_Exception_NSESeries]
(
    [isin] VARCHAR(50) NULL,
    [previousseries] VARCHAR(10) NULL,
    [Currenteries] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_FILE_COUNT
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_FILE_COUNT]
(
    [SRNO] INT NULL,
    [F_NAME] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_FileCounter
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_FileCounter]
(
    [FileCnt] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_FileCounter_rohit_23092015
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_FileCounter_rohit_23092015]
(
    [FileCnt] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_Holding
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_Holding]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_holding_05102015
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_holding_05102015]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_holding_10122015
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_holding_10122015]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_holding_11122015
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_holding_11122015]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_holding_12122015
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_holding_12122015]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_holding_14122015
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_holding_14122015]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_holding_abha
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_holding_abha]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_holding_BTST
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_holding_BTST]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_holding_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_holding_hist]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [id] INT NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [ActualSqOffQty] INT NULL,
    [AvgRate] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_holding_SQOFF_format
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_holding_SQOFF_format]
(
    [SrNo] BIGINT NULL,
    [UnsettCode] INT NOT NULL,
    [party_code] VARCHAR(10) NULL,
    [VAHC] MONEY NULL,
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_holding_Var
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_holding_Var]
(
    [ProcessDate] DATETIME NOT NULL,
    [EXCHANGE] VARCHAR(10) NULL,
    [sett_no] VARCHAR(10) NULL,
    [SEtt_type] VARCHAR(5) NULL,
    [scrip_cd] VARCHAR(50) NULL,
    [series] VARCHAR(50) NULL,
    [Party_code] VARCHAR(10) NULL,
    [Qty] FLOAT NULL,
    [CLSRATE] MONEY NULL,
    [VBHC] MONEY NULL,
    [HAIRCUT] MONEY NULL,
    [VAHC] MONEY NULL,
    [CATEGORY] VARCHAR(10) NULL,
    [SRC] VARCHAR(2) NULL,
    [SquareOffQty] INT NULL,
    [id] INT NULL,
    [SqOffseq] INT NULL,
    [AdjAmt] MONEY NULL,
    [ISIN] VARCHAR(20) NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(10) NULL,
    [SHRT_HC] MONEY NULL,
    [total_WithHC] MONEY NULL,
    [nse_approved] VARCHAR(10) NULL,
    [BSE_Var_Display] NUMERIC(10, 2) NULL,
    [NSE_Var_Display] NUMERIC(10, 2) NULL,
    [NSE_proj_VaR] NUMERIC(10, 2) NULL,
    [Bse_var] NUMERIC(10, 2) NULL,
    [Bse_final_var] NUMERIC(10, 2) NULL,
    [BSE_proj_VaR] NUMERIC(10, 2) NULL,
    [nse_final_var] NUMERIC(10, 2) NULL,
    [angel_var] NUMERIC(10, 2) NULL,
    [NSE_var] NUMERIC(10, 2) NULL,
    [scripname] VARCHAR(50) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_JV_Adj_Segmentwise
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_JV_Adj_Segmentwise]
(
    [party_code] VARCHAR(50) NULL,
    [bsecm] MONEY NULL,
    [nsecm] MONEY NULL,
    [nsx] MONEY NULL,
    [mcd] MONEY NULL,
    [Ledger] MONEY NULL,
    [FO_JV] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [net] MONEY NULL,
    [FO_NSE] MONEY NULL,
    [FO_BSE] MONEY NULL,
    [MCD_NSE] MONEY NULL,
    [MCD_BSE] MONEY NULL,
    [NSX_NSE] MONEY NULL,
    [NSX_BSE] MONEY NULL,
    [RMS_DATE] VARCHAR(11) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_JV_collateral_file
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_JV_collateral_file]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [FldData] VARCHAR(500) NULL,
    [SEGMENT] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_JV_DP_file
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_JV_DP_file]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [FldData] VARCHAR(500) NULL,
    [SEGMENT] VARCHAR(15) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_JV_Movement_details
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_JV_Movement_details]
(
    [PARTY_CODE] VARCHAR(10) NULL,
    [BALANCE] MONEY NULL,
    [BSECM_BALANCE] MONEY NULL,
    [NSECM_BALANCE] MONEY NULL,
    [nsefO_JV] MONEY NULL,
    [MCD_JV] MONEY NULL,
    [NSX_JV] MONEY NULL,
    [UPDATEDON] DATETIME NULL,
    [FO_NSE] MONEY NULL,
    [FO_BSE] MONEY NULL,
    [MCD_NSE] MONEY NULL,
    [MCD_BSE] MONEY NULL,
    [NSX_NSE] MONEY NULL,
    [NSX_BSE] MONEY NULL,
    [aCTUALBALANCE] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_JVCE_tblfile
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_JVCE_tblfile]
(
    [ID] INT NOT NULL,
    [FldData] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_JVCollateral_file
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_JVCollateral_file]
(
    [ClientCode] VARCHAR(20) NULL,
    [ScripCode] VARCHAR(20) NULL,
    [Series] VARCHAR(10) NULL,
    [ISIN] VARCHAR(25) NULL,
    [Quantity] INT NULL,
    [FromDP] VARCHAR(25) NULL,
    [FromID] VARCHAR(25) NULL,
    [TargetDp] VARCHAR(25) NULL,
    [TargetId] VARCHAR(25) NULL,
    [Type1] VARCHAR(20) NULL,
    [segment] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_JVCollateral_tblfile
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_JVCollateral_tblfile]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [series] VARCHAR(3) NULL,
    [isin] VARCHAR(20) NULL,
    [qty] NUMERIC(18, 0) NULL,
    [fromdpid] VARCHAR(9) NULL,
    [fromacc] VARCHAR(16) NULL,
    [todpid] VARCHAR(9) NULL,
    [toacc] VARCHAR(16) NULL,
    [type1] VARCHAR(3) NOT NULL,
    [TOSEGMENT] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_JVCollateral_tblfile_bse
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_JVCollateral_tblfile_bse]
(
    [party_code] VARCHAR(10) NULL,
    [scrip_cd] VARCHAR(12) NULL,
    [series] VARCHAR(3) NULL,
    [isin] VARCHAR(20) NULL,
    [qty] NUMERIC(18, 0) NULL,
    [fromdpid] VARCHAR(9) NULL,
    [fromacc] VARCHAR(16) NULL,
    [todpid] VARCHAR(9) NULL,
    [toacc] VARCHAR(16) NULL,
    [type1] VARCHAR(3) NOT NULL,
    [TOSEGMENT] VARCHAR(10) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_JVdata
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_JVdata]
(
    [Bal_Date] DATETIME NULL,
    [Cltcode] VARCHAR(15) NULL,
    [JV_amt] MONEY NULL,
    [JV_Segment] VARCHAR(10) NULL,
    [JV_DrCode] VARCHAR(15) NULL,
    [JV_CrCode] VARCHAR(15) NULL,
    [Narration] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_JVDP_file
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_JVDP_file]
(
    [ClientCode] VARCHAR(20) NULL,
    [ScripCode] VARCHAR(20) NULL,
    [Series] VARCHAR(10) NULL,
    [ISIN] VARCHAR(25) NULL,
    [Quantity] INT NULL,
    [FromDP] VARCHAR(25) NULL,
    [FromID] VARCHAR(25) NULL,
    [TargetDp] VARCHAR(25) NULL,
    [TargetId] VARCHAR(25) NULL,
    [Type1] VARCHAR(20) NULL,
    [segment] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_JVDP_file_Rohit_23092015
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_JVDP_file_Rohit_23092015]
(
    [ClientCode] VARCHAR(20) NULL,
    [ScripCode] VARCHAR(20) NULL,
    [Series] VARCHAR(10) NULL,
    [ISIN] VARCHAR(25) NULL,
    [Quantity] INT NULL,
    [FromDP] VARCHAR(25) NULL,
    [FromID] VARCHAR(25) NULL,
    [TargetDp] VARCHAR(25) NULL,
    [TargetId] VARCHAR(25) NULL,
    [Type1] VARCHAR(20) NULL,
    [segment] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_JVfile
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_JVfile]
(
    [ID] INT IDENTITY(1,1) NOT NULL,
    [FldData] VARCHAR(500) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_NonCash
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_NonCash]
(
    [id] BIGINT NULL,
    [co_code] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL,
    [ProcessDate] DATETIME NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Category] VARCHAR(10) NULL,
    [Qty] NUMERIC(18, 0) NULL,
    [Amount] MONEY NULL,
    [HairCut] MONEY NULL,
    [FinalAmount] MONEY NULL,
    [FromAcc] VARCHAR(16) NULL,
    [ToAcc] VARCHAR(16) NULL,
    [Sqoffseq] INT NULL,
    [clsrate] MONEY NULL,
    [SquareOffQty] INT NULL,
    [ToSegment] VARCHAR(10) NULL,
    [AdjAmt] MONEY NULL,
    [MarginSqOffQty] INT NULL,
    [MarginHC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_NonCash_08092015
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_NonCash_08092015]
(
    [id] BIGINT NULL,
    [co_code] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL,
    [ProcessDate] DATETIME NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Category] VARCHAR(10) NULL,
    [Qty] NUMERIC(18, 0) NULL,
    [Amount] MONEY NULL,
    [HairCut] MONEY NULL,
    [FinalAmount] MONEY NULL,
    [FromAcc] VARCHAR(16) NULL,
    [ToAcc] VARCHAR(16) NULL,
    [Sqoffseq] INT NULL,
    [clsrate] MONEY NULL,
    [SquareOffQty] INT NULL,
    [ToSegment] VARCHAR(10) NULL,
    [AdjAmt] MONEY NULL,
    [MarginSqOffQty] INT NULL,
    [MarginHC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_NonCash_11122015
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_NonCash_11122015]
(
    [id] BIGINT NULL,
    [co_code] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL,
    [ProcessDate] DATETIME NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Category] VARCHAR(10) NULL,
    [Qty] NUMERIC(18, 0) NULL,
    [Amount] MONEY NULL,
    [HairCut] MONEY NULL,
    [FinalAmount] MONEY NULL,
    [FromAcc] VARCHAR(16) NULL,
    [ToAcc] VARCHAR(16) NULL,
    [Sqoffseq] INT NULL,
    [clsrate] MONEY NULL,
    [SquareOffQty] INT NULL,
    [ToSegment] VARCHAR(10) NULL,
    [AdjAmt] MONEY NULL,
    [MarginSqOffQty] INT NULL,
    [MarginHC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_noncash_12122015
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_noncash_12122015]
(
    [id] BIGINT NULL,
    [co_code] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL,
    [ProcessDate] DATETIME NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Category] VARCHAR(10) NULL,
    [Qty] NUMERIC(18, 0) NULL,
    [Amount] MONEY NULL,
    [HairCut] MONEY NULL,
    [FinalAmount] MONEY NULL,
    [FromAcc] VARCHAR(16) NULL,
    [ToAcc] VARCHAR(16) NULL,
    [Sqoffseq] INT NULL,
    [clsrate] MONEY NULL,
    [SquareOffQty] INT NULL,
    [ToSegment] VARCHAR(10) NULL,
    [AdjAmt] MONEY NULL,
    [MarginSqOffQty] INT NULL,
    [MarginHC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_noncash_14122015
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_noncash_14122015]
(
    [id] BIGINT NULL,
    [co_code] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL,
    [ProcessDate] DATETIME NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Category] VARCHAR(10) NULL,
    [Qty] NUMERIC(18, 0) NULL,
    [Amount] MONEY NULL,
    [HairCut] MONEY NULL,
    [FinalAmount] MONEY NULL,
    [FromAcc] VARCHAR(16) NULL,
    [ToAcc] VARCHAR(16) NULL,
    [Sqoffseq] INT NULL,
    [clsrate] MONEY NULL,
    [SquareOffQty] INT NULL,
    [ToSegment] VARCHAR(10) NULL,
    [AdjAmt] MONEY NULL,
    [MarginSqOffQty] INT NULL,
    [MarginHC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_NonCash_24082016
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_NonCash_24082016]
(
    [id] BIGINT NULL,
    [co_code] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL,
    [ProcessDate] DATETIME NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Category] VARCHAR(10) NULL,
    [Qty] NUMERIC(18, 0) NULL,
    [Amount] MONEY NULL,
    [HairCut] MONEY NULL,
    [FinalAmount] MONEY NULL,
    [FromAcc] VARCHAR(16) NULL,
    [ToAcc] VARCHAR(16) NULL,
    [Sqoffseq] INT NULL,
    [clsrate] MONEY NULL,
    [SquareOffQty] INT NULL,
    [ToSegment] VARCHAR(10) NULL,
    [AdjAmt] MONEY NULL,
    [MarginSqOffQty] INT NULL,
    [MarginHC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_noncash_30082016
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_noncash_30082016]
(
    [id] BIGINT NULL,
    [co_code] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL,
    [ProcessDate] DATETIME NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Category] VARCHAR(10) NULL,
    [Qty] NUMERIC(18, 0) NULL,
    [Amount] MONEY NULL,
    [HairCut] MONEY NULL,
    [FinalAmount] MONEY NULL,
    [FromAcc] VARCHAR(16) NULL,
    [ToAcc] VARCHAR(16) NULL,
    [Sqoffseq] INT NULL,
    [clsrate] MONEY NULL,
    [SquareOffQty] INT NULL,
    [ToSegment] VARCHAR(10) NULL,
    [AdjAmt] MONEY NULL,
    [MarginSqOffQty] INT NULL,
    [MarginHC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_NonCash_abha
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_NonCash_abha]
(
    [id] BIGINT NULL,
    [co_code] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL,
    [ProcessDate] DATETIME NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Category] VARCHAR(10) NULL,
    [Qty] NUMERIC(18, 0) NULL,
    [Amount] MONEY NULL,
    [HairCut] MONEY NULL,
    [FinalAmount] MONEY NULL,
    [FromAcc] VARCHAR(16) NULL,
    [ToAcc] VARCHAR(16) NULL,
    [Sqoffseq] INT NULL,
    [clsrate] MONEY NULL,
    [SquareOffQty] INT NULL,
    [ToSegment] VARCHAR(10) NULL,
    [AdjAmt] MONEY NULL,
    [MarginSqOffQty] INT NULL,
    [MarginHC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_NonCash_BTST
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_NonCash_BTST]
(
    [id] BIGINT NULL,
    [co_code] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL,
    [ProcessDate] DATETIME NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Category] VARCHAR(10) NULL,
    [Qty] NUMERIC(18, 0) NULL,
    [Amount] MONEY NULL,
    [HairCut] MONEY NULL,
    [FinalAmount] MONEY NULL,
    [FromAcc] VARCHAR(16) NULL,
    [ToAcc] VARCHAR(16) NULL,
    [Sqoffseq] INT NULL,
    [clsrate] MONEY NULL,
    [SquareOffQty] INT NULL,
    [ToSegment] VARCHAR(10) NULL,
    [AdjAmt] MONEY NULL,
    [MarginSqOffQty] INT NULL,
    [MarginHC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_NonCash_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_NonCash_hist]
(
    [id] BIGINT NULL,
    [co_code] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL,
    [ProcessDate] DATETIME NOT NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Category] VARCHAR(10) NULL,
    [Qty] NUMERIC(18, 0) NULL,
    [Amount] MONEY NULL,
    [HairCut] MONEY NULL,
    [FinalAmount] MONEY NULL,
    [FromAcc] VARCHAR(16) NULL,
    [ToAcc] VARCHAR(16) NULL,
    [Sqoffseq] INT NULL,
    [clsrate] MONEY NULL,
    [SquareOffQty] INT NULL,
    [ToSegment] VARCHAR(10) NULL,
    [AdjAmt] MONEY NULL,
    [MarginSqOffQty] INT NULL,
    [MarginHC] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_NRMS_Client_Collaterals
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_NRMS_Client_Collaterals]
(
    [co_code] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Cl_Rate] MONEY NULL,
    [Amount] MONEY NULL,
    [Qty] NUMERIC(18, 0) NULL,
    [HairCut] MONEY NULL,
    [FinalAmount] MONEY NULL,
    [PercentageCash] NUMERIC(18, 2) NULL,
    [PerecntageNonCash] NUMERIC(18, 2) NULL,
    [Receive_Date] DATETIME NULL,
    [Maturity_Date] DATETIME NULL,
    [Coll_Type] VARCHAR(6) NULL,
    [ClientType] VARCHAR(3) NULL,
    [Remarks] VARCHAR(50) NULL,
    [LoginName] VARCHAR(20) NULL,
    [LoginTime] DATETIME NULL,
    [Cash_Ncash] VARCHAR(2) NULL,
    [Group_Code] VARCHAR(15) NULL,
    [Fd_Bg_No] VARCHAR(20) NULL,
    [Bank_Code] VARCHAR(15) NULL,
    [Fd_Type] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_NRMS_Client_Collaterals_08092015
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_NRMS_Client_Collaterals_08092015]
(
    [co_code] VARCHAR(10) NULL,
    [EffDate] DATETIME NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(20) NULL,
    [Party_Code] VARCHAR(10) NULL,
    [Scrip_Cd] VARCHAR(12) NULL,
    [Series] VARCHAR(3) NULL,
    [Isin] VARCHAR(20) NULL,
    [Cl_Rate] MONEY NULL,
    [Amount] MONEY NULL,
    [Qty] NUMERIC(18, 0) NULL,
    [HairCut] MONEY NULL,
    [FinalAmount] MONEY NULL,
    [PercentageCash] NUMERIC(18, 2) NULL,
    [PerecntageNonCash] NUMERIC(18, 2) NULL,
    [Receive_Date] DATETIME NULL,
    [Maturity_Date] DATETIME NULL,
    [Coll_Type] VARCHAR(6) NULL,
    [ClientType] VARCHAR(3) NULL,
    [Remarks] VARCHAR(50) NULL,
    [LoginName] VARCHAR(20) NULL,
    [LoginTime] DATETIME NULL,
    [Cash_Ncash] VARCHAR(2) NULL,
    [Group_Code] VARCHAR(15) NULL,
    [Fd_Bg_No] VARCHAR(20) NULL,
    [Bank_Code] VARCHAR(15) NULL,
    [Fd_Type] VARCHAR(1) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_NSE_DelTrans
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_NSE_DelTrans]
(
    [SNo] NUMERIC(18, 0) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_type] VARCHAR(2) NOT NULL,
    [RefNo] INT NOT NULL,
    [TCode] NUMERIC(18, 0) NOT NULL,
    [TrType] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [scrip_cd] VARCHAR(12) NOT NULL,
    [series] VARCHAR(3) NOT NULL,
    [Qty] NUMERIC(18, 0) NOT NULL,
    [FromNo] VARCHAR(16) NULL,
    [ToNo] VARCHAR(16) NULL,
    [CertNo] VARCHAR(16) NULL,
    [FolioNo] VARCHAR(16) NULL,
    [HolderName] VARCHAR(100) NULL,
    [Reason] VARCHAR(100) NULL,
    [DrCr] CHAR(1) NOT NULL,
    [Delivered] CHAR(1) NOT NULL,
    [OrgQty] NUMERIC(18, 0) NULL,
    [DpType] VARCHAR(10) NULL,
    [DpId] VARCHAR(16) NULL,
    [CltDpId] VARCHAR(16) NULL,
    [BranchCd] VARCHAR(10) NOT NULL,
    [PartipantCode] VARCHAR(10) NOT NULL,
    [SlipNo] NUMERIC(18, 0) NULL,
    [BatchNo] VARCHAR(10) NULL,
    [ISett_No] VARCHAR(7) NULL,
    [ISett_Type] VARCHAR(2) NULL,
    [ShareType] VARCHAR(8) NULL,
    [TransDate] DATETIME NOT NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [BDpType] VARCHAR(10) NULL,
    [BDpId] VARCHAR(16) NULL,
    [BCltDpId] VARCHAR(16) NULL,
    [Filler4] DATETIME NULL,
    [Filler5] INT NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(7) NULL,
    [UpdatedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_NSE_DelTrans_08092015
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_NSE_DelTrans_08092015]
(
    [SNo] NUMERIC(18, 0) NOT NULL,
    [Sett_No] VARCHAR(7) NOT NULL,
    [Sett_type] VARCHAR(2) NOT NULL,
    [RefNo] INT NOT NULL,
    [TCode] NUMERIC(18, 0) NOT NULL,
    [TrType] NUMERIC(18, 0) NOT NULL,
    [Party_Code] VARCHAR(10) NOT NULL,
    [scrip_cd] VARCHAR(12) NOT NULL,
    [series] VARCHAR(3) NOT NULL,
    [Qty] NUMERIC(18, 0) NOT NULL,
    [FromNo] VARCHAR(16) NULL,
    [ToNo] VARCHAR(16) NULL,
    [CertNo] VARCHAR(16) NULL,
    [FolioNo] VARCHAR(16) NULL,
    [HolderName] VARCHAR(100) NULL,
    [Reason] VARCHAR(100) NULL,
    [DrCr] CHAR(1) NOT NULL,
    [Delivered] CHAR(1) NOT NULL,
    [OrgQty] NUMERIC(18, 0) NULL,
    [DpType] VARCHAR(10) NULL,
    [DpId] VARCHAR(16) NULL,
    [CltDpId] VARCHAR(16) NULL,
    [BranchCd] VARCHAR(10) NOT NULL,
    [PartipantCode] VARCHAR(10) NOT NULL,
    [SlipNo] NUMERIC(18, 0) NULL,
    [BatchNo] VARCHAR(10) NULL,
    [ISett_No] VARCHAR(7) NULL,
    [ISett_Type] VARCHAR(2) NULL,
    [ShareType] VARCHAR(8) NULL,
    [TransDate] DATETIME NOT NULL,
    [Filler1] VARCHAR(100) NULL,
    [Filler2] INT NULL,
    [Filler3] INT NULL,
    [BDpType] VARCHAR(10) NULL,
    [BDpId] VARCHAR(16) NULL,
    [BCltDpId] VARCHAR(16) NULL,
    [Filler4] DATETIME NULL,
    [Filler5] INT NULL,
    [Exchange] VARCHAR(3) NULL,
    [Segment] VARCHAR(7) NULL,
    [UpdatedOn] DATETIME NOT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_processStatus
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_processStatus]
(
    [UpdStatus] INT NULL,
    [UpdDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_PURERISK_DPHOLDING
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_PURERISK_DPHOLDING]
(
    [srno] INT NOT NULL,
    [isin] CHAR(12) NULL,
    [scrip_Cd] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [qty] INT NULL,
    [accno] VARCHAR(16) NULL,
    [total] MONEY NULL,
    [nse_approved] VARCHAR(25) NULL,
    [Net_debit] MONEY NULL,
    [Ben_Adjusted] MONEY NULL,
    [total_adj] MONEY NULL,
    [BalAfterAdj] MONEY NULL,
    [Qty_adj] INT NULL,
    [clsrate] MONEY NULL,
    [Total_Adj_Value] MONEY NULL,
    [fo_approved] VARCHAR(1) NULL,
    [Process_date] DATETIME NOT NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(20) NULL,
    [risktype] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_PURERISK_DPHOLDING_hist
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_PURERISK_DPHOLDING_hist]
(
    [srno] INT NOT NULL,
    [isin] CHAR(12) NULL,
    [scrip_Cd] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [qty] INT NULL,
    [accno] VARCHAR(16) NULL,
    [total] MONEY NULL,
    [nse_approved] VARCHAR(25) NULL,
    [Net_debit] MONEY NULL,
    [Ben_Adjusted] MONEY NULL,
    [total_adj] MONEY NULL,
    [BalAfterAdj] MONEY NULL,
    [Qty_adj] INT NULL,
    [fo_approved] VARCHAR(1) NULL,
    [Process_date] DATETIME NOT NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_PURERISK_DPHOLDING_SMSDay2
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_PURERISK_DPHOLDING_SMSDay2]
(
    [srno] INT NOT NULL,
    [isin] CHAR(12) NULL,
    [scrip_Cd] VARCHAR(10) NULL,
    [party_code] VARCHAR(10) NULL,
    [qty] INT NULL,
    [accno] VARCHAR(16) NULL,
    [total] MONEY NULL,
    [nse_approved] VARCHAR(25) NULL,
    [Net_debit] MONEY NULL,
    [Ben_Adjusted] MONEY NULL,
    [total_adj] MONEY NULL,
    [BalAfterAdj] MONEY NULL,
    [Qty_adj] INT NULL,
    [clsrate] MONEY NULL,
    [Total_Adj_Value] MONEY NULL,
    [fo_approved] VARCHAR(1) NULL,
    [Process_date] DATETIME NOT NULL,
    [FromAcc] VARCHAR(20) NULL,
    [ToAcc] VARCHAR(20) NULL,
    [ToSegment] VARCHAR(20) NULL,
    [risktype] VARCHAR(20) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_PURERISK_DPHOLDINGBEN
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_PURERISK_DPHOLDINGBEN]
(
    [party_code] VARCHAR(10) NOT NULL,
    [net_debit] MONEY NULL,
    [angel_ben] MONEY NOT NULL,
    [Process_date] DATETIME NULL,
    [non_cash] MONEY NULL,
    [FOShrt] MONEY NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_Region_Activation
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_Region_Activation]
(
    [Region] VARCHAR(10) NULL,
    [Day1Date] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.VMSS_Region_migration_date
-- --------------------------------------------------
CREATE TABLE [dbo].[VMSS_Region_migration_date]
(
    [Region] VARCHAR(25) NULL,
    [MigrationDate] DATETIME NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.vmss_rms_holding
-- --------------------------------------------------
CREATE TABLE [dbo].[vmss_rms_holding]
(
    [isin] VARCHAR(20) NULL,
    [scrip_cd] VARCHAR(15) NULL,
    [series] VARCHAR(25) NULL,
    [sett_no] VARCHAR(10) NULL,
    [sett_type] VARCHAR(5) NULL,
    [party_Code] VARCHAR(10) NULL,
    [bs] VARCHAR(1) NULL,
    [exchange] VARCHAR(10) NULL,
    [qty] FLOAT NULL,
    [clsrate] MONEY NULL,
    [accno] VARCHAR(20) NULL,
    [dpid] VARCHAR(20) NULL,
    [clid] VARCHAR(20) NULL,
    [flag] VARCHAR(10) NULL,
    [aben] MONEY NULL,
    [apool] MONEY NULL,
    [nben] MONEY NULL,
    [npool] MONEY NULL,
    [approved] VARCHAR(10) NULL,
    [scripname] VARCHAR(50) NULL,
    [partyname] VARCHAR(100) NULL,
    [pool] VARCHAR(10) NULL,
    [total] MONEY NULL,
    [DUMMY1] VARCHAR(50) NULL,
    [DUMMY2] VARCHAR(50) NULL,
    [nse_approved] VARCHAR(10) NULL,
    [source] VARCHAR(2) NULL,
    [upd_date] DATETIME NULL,
    [AdjQty] FLOAT NULL
);

GO

-- --------------------------------------------------
-- VIEW dbo.Pure_RiskClients_ActiveSeg_Details
-- --------------------------------------------------
 CREATE View Pure_RiskClients_ActiveSeg_Details    
 as    
 select x.Party_code,segment= Case         
 when y.bsecm='Y' or y.nsecm='N' then 'BSECM'         
 when  y.bsecm='N' or y.nsecm='Y'  then 'NSECM' 
 when  y.bsecm='N' or y.nsecm='N'  then 'BSECM' end      
 from    
 (    
 select Party_code from  VMSS_PURERISK_DPHOLDING A WITH (nolock)      
 ) x join    
 (select party_code,bsecm,nsecm from General.dbo.client_details with (nolock) --where (bsecm='Y' or nsecm='Y')    
 ) y    
 on x.party_Code=y.party_Code

GO

-- --------------------------------------------------
-- VIEW dbo.Pure_RiskClients_ActiveSeg_Details_23082016
-- --------------------------------------------------
 CREATE View Pure_RiskClients_ActiveSeg_Details_23082016    
 as      
 select x.Party_code,segment= Case           
 when y.bsecm='Y' or y.nsecm='N' then 'BSECM'           
 when  y.bsecm='N' or y.nsecm='Y'  then 'NSECM'   
 when  y.bsecm='N' or y.nsecm='N'  then 'BSECM' end        
 from      
 (      
 select Party_code from  VMSS_PURERISK_DPHOLDING A WITH (nolock)        
 ) x join      
 (select party_code,bsecm,nsecm from General.dbo.client_details with (nolock) --where (bsecm='Y' or nsecm='Y')      
 ) y      
 on x.party_Code=y.party_Code

GO

-- --------------------------------------------------
-- VIEW dbo.VMSS_Client_collateral_NonEquity_NoBrInfo
-- --------------------------------------------------
      
CREATE View VMSS_Client_collateral_NonEquity_NoBrInfo      
as      
select co_Code,party_Code,          
CashColl=sum(Case when Cash_NCash='C' then FinalAmount else 0 end),          
NonCashColl=sum(Case when Cash_NCash='N' then FinalAmount else 0 end),  
MAxAdjAmt=sum(Case when Cash_NCash='N' then MAxAdjAmt else 0 end)           
from VMSS_Client_Collaterals (nolock)           
group by co_Code,party_code

GO

-- --------------------------------------------------
-- VIEW dbo.VMSS_Client_Collaterals
-- --------------------------------------------------
CREATE View VMSS_Client_Collaterals        
as        
select         
a.co_code,a.EffDate,a.Exchange,a.Segment,a.Party_Code,a.Scrip_Cd,a.Series,a.Isin,a.Cl_Rate,        
(a.Qty-isnull(b.Qty,0))*a.Cl_Rate as Amount,        
(a.Qty-isnull(b.Qty,0)) as Qty,        
a.HairCut,        
((a.Qty-isnull(b.Qty,0))*a.Cl_Rate)*((100.00-HairCut)/100) as FinalAmount,        
a.PercentageCash,a.PerecntageNonCash,a.Receive_Date,a.Maturity_Date,a.Coll_Type,a.ClientType,    
a.Remarks,a.LoginName,a.LoginTime,a.Cash_Ncash,a.Group_Code,a.Fd_Bg_No,a.Bank_Code,a.Fd_Type,    
MaxAdjAmt=((a.Qty-isnull(b.Qty,0))*a.Cl_Rate)-(((a.Qty-isnull(b.Qty,0))*a.Cl_Rate)*((100.00-HairCut)/100))    
from vmss_NRMS_Client_Collaterals a left outer join VMSS_CollAdj b         
on a.party_code=b.party_Code and a.co_code=b.co_code and a.isin=b.isin         
where a.qty <> isnull(b.Qty,0) --and isnull(b.Qty,0) > 0

GO

-- --------------------------------------------------
-- VIEW dbo.vmss_data_ActiveSeg
-- --------------------------------------------------
 CREATE View vmss_data_ActiveSeg
 as
 select x.Party_code,x.BSECM_Balance,x.NSECM_Balance,y.BSECM,y.nsecm,x.VarMArginShortFall
 from
 (
 select Party_code,BSECM_Balance,NSECM_Balance,VarMArginShortFall from vmss_data with (nolock)    
 where VarMArginShortFall < 0 and processDate = (select Max(processDate) from VMSS_data)    
 ) x join
 (select party_code,bsecm,nsecm from General.dbo.client_details with (nolock) where (bsecm='Y' or nsecm='Y')
 ) y
 on x.party_Code=y.party_Code

GO

-- --------------------------------------------------
-- VIEW dbo.VMSS_DrSegment
-- --------------------------------------------------
CREATE view VMSS_DrSegment    
 as    
 select party_Code,    
 Case     
 when BSECM_balance < NSECM_Balance and bsecm='Y' then 'BSECM'     
 when BSECM_balance < NSECM_Balance and bsecm='N' then 'NSECM'     
 when NSECM_balance < BSECM_Balance and nsecm='Y' then 'NSECM'    
 when NSECM_balance < BSECM_Balance and nsecm='N' then 'BSECM'    
 when NSECM_balance = BSECM_Balance and nsecm='Y' then 'NSECM'    
 when NSECM_balance = BSECM_Balance and nsecm='N' then 'BSECM'    
 else '' end as DrSegment    
 from vmss_data_ActiveSeg
 where VarMArginShortFall < 0

GO

-- --------------------------------------------------
-- VIEW dbo.VMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP
-- --------------------------------------------------
CREATE VIEW VMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP
AS
SELECT 
region,branch,sb,party_code,category,cli_type,sb_category,varmarginshortfall_aftadj,squareoffvalue,noofdays,update_date,
mobile_pager,email,balance,holding_bhc,holding_ahc,exception,remarks,amount,source_type
FROM MIS.DBO.VMSS_MARGIN_SHORTAGE_SQOFF_CLIENT_EXP

GO

-- --------------------------------------------------
-- VIEW dbo.VMSS_NonCash_BalAfterMargin
-- --------------------------------------------------
CREATE View VMSS_NonCash_BalAfterMargin    
as    
select id,co_code,EffDate,ProcessDate,Party_Code,Scrip_Cd,Series,Isin,Category,Qty,Amount,HairCut,    
FinalAmount,FromAcc,ToAcc,Sqoffseq,clsrate,SquareOffQty,ToSegment,  
(SquareOffQty*Clsrate)-(SquareOffQty*(clsrate*(Haircut/100.00))) as AdjustedAmt,AdjAmt,MarginSqOffQty,    
A_Qty=(Qty-MarginSqOffQty),    
(Qty-MarginSqOffQty)*Clsrate as VBHC,    
((Qty-MarginSqOffQty)*Clsrate)*HairCut/100.00 as VAHC    
from vmss_noncash with (nolock)    
where (Qty-MarginSqOffQty) > 0

GO

-- --------------------------------------------------
-- VIEW dbo.vmss_Process_log
-- --------------------------------------------------
CREATE View vmss_Process_log      
as        
select Srno,spdesc,      
(Case when Active_status=1 then 'Active' else 'Deactivated' end) as Active_status,      
StartDate,EndDate,       
Case       
when Flag=1 then 'Completed'      
when Flag=0 and StartDate > EndDate then 'Processing'      
when Flag=0 and StartDate <= EndDate then 'Pending'      
else 'Unknown' end as ProcessStatus,    
ErrFlag      
from vmss_batch_process with (nolock)

GO

-- --------------------------------------------------
-- VIEW dbo.VMSS_ScripBlock
-- --------------------------------------------------
CREATE View VMSS_ScripBlock    
as    
select * from mis.dbo.VMSS_ScripBlock
/*
select segment,a.party_code,scrip_cd,series,expirydate from     
(    
select Tosegment as Segment,party_Code,scrip_cd,series,expirydate='1900-01-01 00:00:00.000'     
from vmss_holding where squareoffqty  > 0 and (tosegment ='BSECM' or Tosegment='NSECM')    
group by Tosegment,party_Code,scrip_cd,series    
) a join     
(    
select party_code from vmss_Data where noofdays >=7 and processdate = (select max(processdate) from vmss_Data )    
group by party_code    
) b    
on a.party_code=b.party_Code 
*/

GO

-- --------------------------------------------------
-- VIEW dbo.vMSS_Vw_Rms_holding
-- --------------------------------------------------
create View vMSS_Vw_Rms_holding        
as                      
    
select x.ProcessDate,x.EXCHANGE,x.sett_no,x.SEtt_type,x.scrip_cd,x.series,x.Party_code,x.Qty,x.CLSRATE,x.VBHC,x.HAIRCUT,  
x.VAHC,x.CATEGORY,x.SRC,x.SquareOffQty,x.id,x.SqOffseq,x.AdjAmt,x.ISIN,x.FromAcc,x.ToAcc,x.ToSegment,x.SHRT_HC,x.total_WithHC,  
x.nse_approved,x.BSE_Var_Display,x.NSE_Var_Display,x.NSE_proj_VaR,x.Bse_var,x.Bse_final_var,x.BSE_proj_VaR,x.nse_final_var,x.angel_var,x.NSE_var,c.scripname from    
(    
 SELECT                   
 A.*,vahc AS total_WithHC,nse_approved=Category,BSE_Var_Display,NSE_Var_Display,NSE_proj_VaR,Bse_var,    
 Bse_final_var,BSE_proj_VaR,nse_final_var,angel_var,NSE_var    
 FROM                     
 (        
  SELECT P.*,Q.SHRT_HC         
  FROM VMSS_HOLDING (NOLOCK) P INNER JOIN GENERAL.DBO.COMPANY (NOLOCK) Q         
  ON P.EXCHANGE=Q.CO_CODE        
 ) A         
 LEFT OUTER JOIN         
 geNERAL.DBO.Scrip_ValidOnlyVar (NOLOCK) B         
 ON A.ISIN=B.ISIN           
     
)x     
left outer join (select scripname,isin,nse_approved,scrip_cd from vmss_rms_holding group by scripname,isin,nse_approved,scrip_cd ) c    
on x.isin=c.isin  and x.scrip_cd=c.scrip_cd

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_MTF_Data_mimansa
-- --------------------------------------------------
  
create View [dbo].[Vw_MTF_Data_mimansa]                       
as                    
select Processdate,Entity,party_code,NoofDays,Shortage,SquareoffValue
from squareoff.dbo.mtf_data with (nolock) where Processdate=(select max(processdate) from squareoff.dbo.mtf_data with (nolock))
and NoofDays>=1 and SquareoffValue<>0

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_MTF_ScripBlock
-- --------------------------------------------------

CREATE View [dbo].[Vw_MTF_ScripBlock]             
as                
          
select segment,a.party_code,scrip_cd,series,expirydate from                 
(                
select Tosegment as Segment,party_Code,scrip_cd,series,expirydate='1900-01-01 00:00:00.000'                 
from SQUAREOFF.DBO.MTF_Holding where squareoffqty  > 0 and AdjAmt>0 and  (tosegment ='BSECM' or Tosegment='NSECM')                
group by Tosegment,party_Code,scrip_cd,series                
) a inner merge join                  
(                
select party_code from SQUAREOFF.DBO.mtf_Data with (nolock) where     
noofdays >=5 and SquareoffValue>0.00 and processdate = (select max(processdate) from SQUAREOFF.DBO.mtf_Data with (nolock))  
and shortage >='650'                
group by party_code                
) b               
on a.party_code=b.party_Code

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_MTF_ScripBlock_26082017
-- --------------------------------------------------
CREATE View Vw_MTF_ScripBlock_26082017              
as              
        
select segment,a.party_code,scrip_cd,series,expirydate from               
(              
select Tosegment as Segment,party_Code,scrip_cd,series,expirydate='1900-01-01 00:00:00.000'               
from SQUAREOFF.DBO.MTF_Holding where squareoffqty  > 0 and AdjAmt>0 and  (tosegment ='BSECM' or Tosegment='NSECM')              
group by Tosegment,party_Code,scrip_cd,series              
) a inner merge join                
(              
select party_code from SQUAREOFF.DBO.mtf_Data with (nolock) where   
noofdays >=5 and SquareoffValue>0.00 and processdate = (select max(processdate) from SQUAREOFF.DBO.mtf_Data with (nolock))              
group by party_code              
) b             
on a.party_code=b.party_Code   
inner merge join  (select region,branch,client from general.dbo.Vw_RMS_Client_Vertical  with(nolock))c on A.party_code=C.client                        
where                                 
c.region in (select region from tbl_MTF_Region_Activation with(nolock) where cast(Migration_date as date)<=cast(GETDATE() as date))

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_RegionWise_MTF_Data
-- --------------------------------------------------
CREATE View [dbo].[Vw_RegionWise_MTF_Data]                     
as                  
select B.branch,B.region,A.* from (select * from squareoff.dbo.mtf_data  with(nolock)   
where processdate= (select max(processdate) from squareoff.dbo.mtf_data with (nolock)) and isnull(noofdays,0)>0 and isnull(squareoffvalue,0)>0 )A                   
inner merge join  (select region,branch,client from general.dbo.Vw_RMS_Client_Vertical  with(nolock))B on A.party_code=B.client                    
where                             
b.region in (select region from tbl_MTF_Region_Activation with(nolock) where cast(Migration_date as date)<=cast(GETDATE() as date))

GO

