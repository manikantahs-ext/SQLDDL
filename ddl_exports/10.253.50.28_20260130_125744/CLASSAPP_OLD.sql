-- DDL Export
-- Server: 10.253.50.28
-- Database: CLASSAPP_OLD
-- Exported: 2026-01-30T12:57:49.498498

USE CLASSAPP_OLD;
GO

-- --------------------------------------------------
-- FUNCTION dbo.CLASS_PWDENCRY
-- --------------------------------------------------
CREATE Function [dbo].[CLASS_PWDENCRY](@PWD Varchar(20)) Returns Varchar(20) as
Begin
	DECLARE @retVal int
	DECLARE @retstr varchar(1000)
	DECLARE @comHandle INT
	DECLARE @errorSource VARCHAR(8000)
	DECLARE @errorDescription VARCHAR(8000)
	
	EXEC @retVal = master..sp_OACreate 'PradnyaPWDDllPrj.PradnyaPwdDll', @comHandle OUTPUT
	if @retVal <> 0 
	begin 
		EXEC master..sp_OAGetErrorInfo @comHandle, @errorSource OUTPUT, @errorDescription OUTPUT
		Return RTrim(LTrim(@errorDescription))
	end
	
	EXEC @retVal = master..sp_OAMethod @comHandle, 'Encrypt',@retstr output, @PWD
		OUTPUT
	
	exec master..sp_OADestroy @comHandle
	
	Return @retstr 
End

GO

-- --------------------------------------------------
-- FUNCTION dbo.PIECE
-- --------------------------------------------------
CREATE FUNCTION [dbo].[PIECE] ( @CHARACTEREXPRESSION VARCHAR(8000), @DELIMITER CHAR(1), @POSITION INTEGER)
RETURNS VARCHAR(8000)
AS
BEGIN
	IF @POSITION<1 RETURN NULL
	IF LEN(@DELIMITER)<>1 RETURN NULL
	DECLARE @START INTEGER
	SET @START=1
	WHILE @POSITION>1
		BEGIN
			SET @START=ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
			IF @START=0 RETURN NULL
			SET @POSITION= @POSITION-1
			SET @START=@START+1
		END
	DECLARE @END INTEGER
	SET @END= ISNULL(CHARINDEX(@DELIMITER, @CHARACTEREXPRESSION, @START),0)
	IF @END=0 SET @END=LEN(@CHARACTEREXPRESSION)+1
	RETURN SUBSTRING(@CHARACTEREXPRESSION, @START, @END-@START)
END

GO

-- --------------------------------------------------
-- INDEX dbo.PASSPORT_LOGIN_MAP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [PASSPORT_IDX_CLS] ON [dbo].[PASSPORT_LOGIN_MAP] ([CLASS_LOGIN], [APP_CODE])

GO

-- --------------------------------------------------
-- INDEX dbo.PASSPORT_LOGIN_MAP
-- --------------------------------------------------
CREATE NONCLUSTERED INDEX [PASSPORT_IDX_MAP] ON [dbo].[PASSPORT_LOGIN_MAP] ([MAPPED_LOGIN], [APP_CODE])

GO

-- --------------------------------------------------
-- PROCEDURE dbo.AGREEMENT_INCOME_DETAILS
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[AGREEMENT_INCOME_DETAILS]
AS
SELECT DISTINCT	(CONVERT(VARCHAR,MINAMOUNT) + '-' +  CONVERT(VARCHAR,MAXAMOUNT)) AS INCOME_RANGE,MINAMOUNT
FROM MSAJAG.DBO.TBL_INCOME_DETAIL WHERE RECTYPE = 'INCOME' ORDER BY MINAMOUNT,INCOME_RANGE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CBO_GETSQLCONTROLDATA
-- --------------------------------------------------
CREATE PROC [dbo].[CBO_GETSQLCONTROLDATA]
AS
SELECT
	SQL_KEY,
	SQL_SUPPLEMENT
FROM
	CBO_SQLCONTROL
ORDER BY
	SNO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_EXCHANGE_MENU
-- --------------------------------------------------


CREATE  PROC [dbo].[CLASS_EXCHANGE_MENU]
(
	@SHAREDB VARCHAR(25),
	@UCAT VARCHAR(100),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(20),
	@NETMENU VARCHAR(1) = 'N'
)
AS
/*
exec CLASS_EXCHANGE_MENU @SHAREDB='Msajag',@UCAT='388',@EXCHANGE='NSE',@SEGMENT='CAPITAL'
	EXEC CLASS_EXCHANGE_MENU 'MSAJAG1', '3881', 'NSE', 'CAPITAL'
*/

DECLARE @SHARESERVER VARCHAR(100)
DECLARE @STRSQL VARCHAR(2000)


CREATE TABLE #EXCHANGEMENU
(
	SRNO INT IDENTITY(1,1),
	MENUSTRING VARCHAR(500),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(20)
)
CREATE TABLE #LINKINFO
(
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(20),
	REPORTCODE INT,
	REPORTPATH VARCHAR(200)
)

SELECT @SHARESERVER = SHARESERVER, @SHAREDB= SHAREDB FROM MULTICOMPANY (NOLOCK)
WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND PRIMARYSERVER = 1


EXEC CLASS_MENUSTRING_MASTER @SHAREDB, @UCAT, @EXCHANGE, @SEGMENT, '', @NETMENU
UPDATE #EXCHANGEMENU SET EXCHANGE = @EXCHANGE, SEGMENT = @SEGMENT WHERE EXCHANGE IS NULL AND SEGMENT IS NULL
UPDATE #LINKINFO SET EXCHANGE = @EXCHANGE, SEGMENT = @SEGMENT WHERE EXCHANGE IS NULL AND SEGMENT IS NULL

SELECT * FROM #EXCHANGEMENU
SELECT * FROM #LINKINFO 

SET @STRSQL = 'SELECT  REPORTCODE=R.FLDREPORTCODE,REPORTNAME=R.FLDREPORTNAME,'
SET @STRSQL = @STRSQL + ' REPORTPATH=CONVERT(VARCHAR,R.FLDREPORTCODE) + ''-''+CASE WHEN FLDTARGET=''FRATOPIC'' THEN ''1'' ELSE ''0'' END,REPORTGROUP=G.FLDGRPNAME,REPORTMENU=M.FLDMENUNAME,'
SET @STRSQL = @STRSQL + ' FLDMENUGRPDESC = CASE WHEN R.FLDMENUGRP < 4 THEN ''Share Accounting'' '
SET @STRSQL = @STRSQL +'			WHEN R.FLDMENUGRP > 3 AND R.FLDMENUGRP  < 7 THEN ''Finance Accounting'' '
SET @STRSQL = @STRSQL +'			ELSE ''Utilities'' END,REPORTMENUORD=R.FLDMENUGRP,EXCHANGE='
SET @STRSQL = @STRSQL + '''' + @EXCHANGE + ''',SEGMENT = ''' + @SEGMENT + ''''
SET @STRSQL = @STRSQL + ' FROM /*' + @SHARESERVER + '.*/'+ @SHAREDB + '.dbo.TBLREPORTS R, /*' +  @SHARESERVER +'.*/'+ @SHAREDB +'.dbo.TBLREPORTGRP G,'
SET @STRSQL = @STRSQL + @SHAREDB + '.dbo.TBLMENUHEAD M,' + @SHAREDB +'.dbo.TBLCATMENU C'  
SET @STRSQL = @STRSQL + ' WHERE R.FLDREPORTGRP =G.FLDREPORTGRP  AND R.FLDMENUGRP = M.FLDMENUCODE  AND R.FLDREPORTCODE = C.FLDREPORTCODE'  
SET @STRSQL = @STRSQL + ' AND C.FLDCATEGORYCODE LIKE ''%,'+ @UCAT +',%'' '
IF @NETMENU = 'Y'
	BEGIN
		SET @STRSQL = @STRSQL + 'AND LEFT(R.FLDPATH, 1) = ''~'' '
	END
SET @STRSQL = @STRSQL + ' ORDER BY R.FLDMENUGRP,G.FLDGRPNAME,R.FLDORDER ,R.FLDREPORTNAME'
print(@STRSQL)
EXEC (@STRSQL)

SET @STRSQL = 'SELECT OWNER_NAME = COMPANY, OWNER_ADDR1 = ISNULL(ADDR1,''''), OWNER_ADDR2 = ISNULL(ADDR2,''''), '
SET @STRSQL = @STRSQL + ' OWNER_PHONE = ISNULL(PHONE,''''), OWNER_ZIP = ISNULL(ZIP,''''), OWNER_CITY = ISNULL(CITY,''''),'
SET @STRSQL = @STRSQL + ' OWNER_STATE = ISNULL([STATE],''''),OWNER_EMAIL = EMAIL,MEMBERCODE,SMTP_SRV_NAME,EXCHANGE='
SET @STRSQL = @STRSQL + '''' + @EXCHANGE + ''',SEGMENT = ''' + @SEGMENT + ''''
SET @STRSQL = @STRSQL + ' FROM /*' +  @SHARESERVER +'.*/'+ @SHAREDB +'.dbo.OWNER'

EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_EXCHANGE_MENU_mar282013
-- --------------------------------------------------


CREATE  PROC [dbo].[CLASS_EXCHANGE_MENU_mar282013]
(
	@SHAREDB VARCHAR(25),
	@UCAT VARCHAR(100),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(20)
)
AS
/*
exec CLASS_EXCHANGE_MENU @SHAREDB='Msajag',@UCAT='388',@EXCHANGE='NSE',@SEGMENT='CAPITAL'
	EXEC CLASS_EXCHANGE_MENU 'MSAJAG1', '3881', 'NSE', 'CAPITAL'
*/

DECLARE @SHARESERVER VARCHAR(100)
DECLARE @STRSQL VARCHAR(2000)


CREATE TABLE #EXCHANGEMENU
(
	SRNO INT IDENTITY(1,1),
	MENUSTRING VARCHAR(500),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(20)
)
CREATE TABLE #LINKINFO
(
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(20),
	REPORTCODE INT,
	REPORTPATH VARCHAR(200)
)

SELECT @SHARESERVER = SHARESERVER, @SHAREDB= SHAREDB FROM MULTICOMPANY (NOLOCK)
WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND PRIMARYSERVER = 1


EXEC CLASS_MENUSTRING_MASTER @SHAREDB, @UCAT, @EXCHANGE, @SEGMENT, ''
UPDATE #EXCHANGEMENU SET EXCHANGE = @EXCHANGE, SEGMENT = @SEGMENT WHERE EXCHANGE IS NULL AND SEGMENT IS NULL
UPDATE #LINKINFO SET EXCHANGE = @EXCHANGE, SEGMENT = @SEGMENT WHERE EXCHANGE IS NULL AND SEGMENT IS NULL

SELECT * FROM #EXCHANGEMENU
SELECT * FROM #LINKINFO 

SET @STRSQL = 'SELECT  REPORTCODE=R.FLDREPORTCODE,REPORTNAME=R.FLDREPORTNAME,'
SET @STRSQL = @STRSQL + ' REPORTPATH=CONVERT(VARCHAR,R.FLDREPORTCODE) + ''-''+CASE WHEN FLDTARGET=''FRATOPIC'' THEN ''1'' ELSE ''0'' END,REPORTGROUP=G.FLDGRPNAME,REPORTMENU=M.FLDMENUNAME,'
SET @STRSQL = @STRSQL + ' FLDMENUGRPDESC = CASE WHEN R.FLDMENUGRP < 4 THEN ''Share Accounting'' '
SET @STRSQL = @STRSQL +'			WHEN R.FLDMENUGRP > 3 AND R.FLDMENUGRP  < 7 THEN ''Finance Accounting'' '
SET @STRSQL = @STRSQL +'			ELSE ''Utilities'' END,REPORTMENUORD=R.FLDMENUGRP,EXCHANGE='
SET @STRSQL = @STRSQL + '''' + @EXCHANGE + ''',SEGMENT = ''' + @SEGMENT + ''''
SET @STRSQL = @STRSQL + ' FROM ' + @SHARESERVER + '.'+ @SHAREDB + '.DBO.TBLREPORTS R, ' +  @SHARESERVER +'.'+ @SHAREDB +'.DBO.TBLREPORTGRP G,'
SET @STRSQL = @STRSQL + @SHAREDB + '.DBO.TBLMENUHEAD M,' + @SHAREDB +'.DBO.TBLCATMENU C'  
SET @STRSQL = @STRSQL + ' WHERE R.FLDREPORTGRP =G.FLDREPORTGRP  AND R.FLDMENUGRP = M.FLDMENUCODE  AND R.FLDREPORTCODE = C.FLDREPORTCODE'  
SET @STRSQL = @STRSQL + ' AND C.FLDCATEGORYCODE LIKE ''%,'+ @UCAT +',%''  ORDER BY R.FLDMENUGRP,G.FLDGRPNAME,R.FLDORDER ,R.FLDREPORTNAME'
print(@STRSQL)
EXEC (@STRSQL)

SET @STRSQL = 'SELECT OWNER_NAME = COMPANY, OWNER_ADDR1 = ISNULL(ADDR1,''''), OWNER_ADDR2 = ISNULL(ADDR2,''''), '
SET @STRSQL = @STRSQL + ' OWNER_PHONE = ISNULL(PHONE,''''), OWNER_ZIP = ISNULL(ZIP,''''), OWNER_CITY = ISNULL(CITY,''''),'
SET @STRSQL = @STRSQL + ' OWNER_STATE = ISNULL([STATE],''''),OWNER_EMAIL = EMAIL,MEMBERCODE,SMTP_SRV_NAME,EXCHANGE='
SET @STRSQL = @STRSQL + '''' + @EXCHANGE + ''',SEGMENT = ''' + @SEGMENT + ''''
SET @STRSQL = @STRSQL + ' FROM ' +  @SHARESERVER +'.'+ @SHAREDB +'.DBO.OWNER'

EXEC (@STRSQL)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_LOGIN_EXCHANGE
-- --------------------------------------------------


CREATE PROCEDURE [dbo].[CLASS_LOGIN_EXCHANGE]
	@USER_NAME VARCHAR(25),
	@PASSWORD VARCHAR(100),
	@REMOTEIP VARCHAR(20),
	@EXCHANGE VARCHAR(5),
	@SEGMENT VARCHAR(20),
	@FORLOGIN VARCHAR(1),
	@DIRSEARCH VARCHAR(1) = 'N'
AS
/*
	EXEC CLASS_LOGIN_EXCHANGE 'YATIN', '2CA07326A266C50D', '', 'NSE', 'CAPITAL', 'Y'
	EXEC CLASS_LOGIN_EXCHANGE 'YATIN', '2CA07326A266C50D', '', 'BSE', 'CAPITAL', 'N'
	EXEC CLASS_LOGIN_EXCHANGE 'YATIN', '2CA07326A266C50D', '', 'NSE', 'FUTURES', 'N'
*/
	SET NOCOUNT ON
	DECLARE
		@SHAREDB VARCHAR(50),
		@SHARESERVER VARCHAR(50),
		@SHAREIP VARCHAR(50),
		@ACCOUNTDB VARCHAR(50),
		@ACCOUNTSERVER VARCHAR(50),
		@ACCOUNTIP VARCHAR(50),
		@LOGINID VARCHAR(20),
		@LOGINPASSWORD VARCHAR(100),
		@PRADNYASERVER VARCHAR(50),
		@SQL VARCHAR(MAX),
		@AFFROWS INT,
		@SEGMENTDESC VARCHAR(100)
	
	CREATE TABLE #CLASSLOGIN
	(
		FLDSTATUS VARCHAR(25),
		USERNAME VARCHAR(51),
		FLDSTNAME VARCHAR(50),
		USER_LOGIN VARCHAR(50),
		PWD_EXPIRY INT,
		FLDCATEGORY VARCHAR(10),
		USERAUTOID VARCHAR(25),
		FLDPWDMINLENGTH SMALLINT,
		FLDPWDMAXLENGTH SMALLINT,
		FLDSPCLCHAR CHAR(1),
		FLDPWDALPHANUMONLY INT,
		FLDENCRYPTION CHAR(1),
		FLDBLOCKPWD VARCHAR(255),
		FLDAUTO BIGINT,
		FLDUSERID INT,
		FLDPWDEXPIRY INT,
		FLDMAXATTEMPT SMALLINT,
		FLDATTEMPTCNT SMALLINT,
		MFLDSTATUS SMALLINT,
		FLDLOGINFLAG SMALLINT,
		FLDACCESSLVL CHAR(1),
		FLDIPADD VARCHAR(2000),
		FLDTIMEOUT SMALLINT,
		FLDFIRSTLOGIN CHAR(1),
		FLDFORCELOGOUT SMALLINT,
		SHAREDB VARCHAR(50),
		SHARESERVER VARCHAR(50),
		SHAREIP VARCHAR(50),
		ACCOUNTDB VARCHAR(50),
		ACCOUNTSERVER VARCHAR(50),
		ACCOUNTIP VARCHAR(50),
		LOGINID VARCHAR(25),
		LOGINPASSWORD VARCHAR(25),
		PRADNYASERVER VARCHAR(256),
		EXCHANGE VARCHAR(25),
		SEGMENT VARCHAR(25),
		LOG_REASON VARCHAR(200),
		LOGINIP VARCHAR(20),
		SEGMENTDESC VARCHAR(100)
	)
	INSERT INTO #CLASSLOGIN (FLDSTATUS, USERNAME, FLDSTNAME, USER_LOGIN, PWD_EXPIRY, FLDCATEGORY, USERAUTOID,
							FLDPWDMINLENGTH, FLDPWDMAXLENGTH, FLDSPCLCHAR,FLDPWDALPHANUMONLY, FLDENCRYPTION, FLDBLOCKPWD, FLDAUTO,
							FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, MFLDSTATUS, FLDLOGINFLAG,
							FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT, SHAREDB,
							SHARESERVER, SHAREIP, ACCOUNTDB, ACCOUNTSERVER, ACCOUNTIP, LOGINID, LOGINPASSWORD,
							PRADNYASERVER, EXCHANGE, SEGMENT, LOG_REASON, LOGINIP, SEGMENTDESC)
	VALUES
		('', '', '', '', 0, '', @USER_NAME,
		0, 0, '','', '', '', 0,
		0, 0, 0, 0, 0, 0,
		'', '', 0, '', 0, '',
		'', '', '', '', '', '', '',
		'', @EXCHANGE, @SEGMENT, '', @REMOTEIP,'')

	/*CREATE TABLE #SERVERINFO
	(
		SHAREDB VARCHAR(20),
		SHARESERVER VARCHAR(15),
		SHAREIP VARCHAR(15),
		ACCOUNTDB VARCHAR(20),
		ACCOUNTSERVER VARCHAR(15),
		ACCOUNTIP VARCHAR(15),
		LOGINID VARCHAR(25),
		LOGINPASSWORD VARCHAR(25),
		PRADNYASERVER VARCHAR(256)
	)*/
	UPDATE #CLASSLOGIN
	SET
		SHAREDB = M.SHAREDB,
		SHARESERVER = M.SHARESERVER,
		SHAREIP = M.SHAREIP,
		ACCOUNTDB = M.ACCOUNTDB,
		ACCOUNTSERVER = M.ACCOUNTSERVER,
		ACCOUNTIP = M.ACCOUNTIP,
		LOGINID = M.DBUSERNAME,
		LOGINPASSWORD = M.DBPASSWORD,
		PRADNYASERVER = @@SERVERNAME,
		SEGMENTDESC = SEGMENT_DESCRIPTION
	FROM
		MULTICOMPANY M
	WHERE
		M.EXCHANGE = @EXCHANGE
		AND M.SEGMENT = @SEGMENT
		AND M.PRIMARYSERVER = 1

	/*INSERT INTO #SERVERINFO (SHAREDB, SHARESERVER, SHAREIP, ACCOUNTDB, ACCOUNTSERVER, ACCOUNTIP, LOGINID, LOGINPASSWORD, PRADNYASERVER)
	SELECT
		SHAREDB,
		ISNULL(SHARESERVER, ''),
		ISNULL(SHAREIP, ''),
		ISNULL(ACCOUNTDB, ''),
		ISNULL(ACCOUNTSERVER, ''),
		ISNULL(ACCOUNTIP, ''),
		ISNULL(DBUSERNAME, ''),
		ISNULL(DBPASSWORD, ''),
		@@SERVERNAME
	FROM
		MULTICOMPANY
	WHERE
		EXCHANGE = @EXCHANGE
		AND SEGMENT = @SEGMENT
		AND PRIMARYSERVER = 1*/

	SELECT
		@SHAREDB = SHAREDB,
		@SHARESERVER = SHARESERVER,
		@SHAREIP = SHAREIP,
		@ACCOUNTDB = ACCOUNTDB,
		@ACCOUNTSERVER = ACCOUNTSERVER,
		@ACCOUNTIP = ACCOUNTIP,
		@LOGINID = LOGINID,
		@LOGINPASSWORD = LOGINPASSWORD,
		@PRADNYASERVER = PRADNYASERVER,
		@SEGMENTDESC = SEGMENTDESC
	FROM
		#CLASSLOGIN
	
	/*SELECT
		SHAREDB = @SHAREDB,
		SHARESERVER = @SHARESERVER,
		SHAREIP = @SHAREIP,
		ACCOUNTDB = @ACCOUNTDB,
		ACCOUNTSERVER = @ACCOUNTSERVER,
		ACCOUNTIP = @ACCOUNTIP,
		DBUSERNAME = @LOGINID,
		DBPASSWORD = @LOGINPASSWORD,
		SERVERNAME = @PRADNYASERVER*/
	SET @SQL = "UPDATE #CLASSLOGIN "
	SET @SQL = @SQL + "SET"
	SET @SQL = @SQL + "	FLDPWDMINLENGTH = P.FLDPWDMINLENGTH,"
	SET @SQL = @SQL + "	FLDPWDMAXLENGTH = P.FLDPWDMAXLENGTH,"
	SET @SQL = @SQL + "	FLDENCRYPTION = P.FLDENCRYPTION,"
	SET @SQL = @SQL + "	FLDSPCLCHAR = P.FLDSPCLCHAR,"
    SET @SQL = @SQL + "	FLDPWDALPHANUMONLY = P.FLDPWDALPHANUMONLY,"
	SET @SQL = @SQL + "	FLDBLOCKPWD = P.FLDBLOCKPWD "
	SET @SQL = @SQL + "FROM "
	SET @SQL = @SQL + @SHAREDB + "..TBLGLOBALPARAMS P"
	EXEC (@SQL)
	/*CREATE TABLE #TBLGLOBALPARAMS
	(
		FLDPWDMINLENGTH SMALLINT,
		FLDPWDMAXLENGTH SMALLINT,
		FLDSPCLCHAR CHAR(1),
		FLDENCRYPTION CHAR(1),
		FLDBLOCKPWD VARCHAR(255)
	)
	SET @SQL = "INSERT INTO #TBLGLOBALPARAMS (FLDPWDMINLENGTH, FLDPWDMAXLENGTH, FLDSPCLCHAR, FLDENCRYPTION, FLDBLOCKPWD) "
	SET @SQL = @SQL + "SELECT FLDPWDMINLENGTH, FLDPWDMAXLENGTH, FLDENCRYPTION, FLDSPCLCHAR, FLDBLOCKPWD FROM "
	SET @SQL = @SQL + @SHAREDB + "..TBLGLOBALPARAMS"
	EXEC(@SQL)
	*/
	--SELECT * FROM #TBLGLOBALPARAMS
	SET @SQL = "UPDATE #CLASSLOGIN "
	SET @SQL = @SQL + "SET"
	SET @SQL = @SQL + "	FLDAUTO = M.FLDAUTO,"
	SET @SQL = @SQL + "	FLDUSERID = M.FLDUSERID,"
	SET @SQL = @SQL + "	FLDPWDEXPIRY = M.FLDPWDEXPIRY,"
	SET @SQL = @SQL + "	FLDMAXATTEMPT = M.FLDMAXATTEMPT,"
	SET @SQL = @SQL + "	FLDATTEMPTCNT = M.FLDATTEMPTCNT,"
	SET @SQL = @SQL + "	MFLDSTATUS = M.FLDSTATUS,"
	SET @SQL = @SQL + "	FLDLOGINFLAG = M.FLDLOGINFLAG,"
	SET @SQL = @SQL + "	FLDACCESSLVL = M.FLDACCESSLVL,"
	SET @SQL = @SQL + "	FLDIPADD = M.FLDIPADD,"
	SET @SQL = @SQL + "	FLDTIMEOUT = M.FLDTIMEOUT,"
	SET @SQL = @SQL + "	FLDFIRSTLOGIN = M.FLDFIRSTLOGIN,"
	SET @SQL = @SQL + "	FLDFORCELOGOUT = M.FLDFORCELOGOUT "
	SET @SQL = @SQL + "FROM"
	SET @SQL = @SQL + "	("
	SET @SQL = @SQL + "		SELECT"
	SET @SQL = @SQL + "			B.FLDAUTO,"
	SET @SQL = @SQL + "			B.FLDUSERID,"
	SET @SQL = @SQL + "			B.FLDPWDEXPIRY,"
	SET @SQL = @SQL + "			B.FLDMAXATTEMPT,"
	SET @SQL = @SQL + "			B.FLDATTEMPTCNT,"
	SET @SQL = @SQL + "			B.FLDSTATUS,"
	SET @SQL = @SQL + "			B.FLDLOGINFLAG,"
	SET @SQL = @SQL + "			B.FLDACCESSLVL,"
	SET @SQL = @SQL + "			B.FLDIPADD,"
	SET @SQL = @SQL + "			B.FLDTIMEOUT,"
	SET @SQL = @SQL + "			B.FLDFIRSTLOGIN,"
	SET @SQL = @SQL + "			B.FLDFORCELOGOUT"
	SET @SQL = @SQL + "		FROM"
	SET @SQL = @SQL + "			" + @SHAREDB + "..TBLPRADNYAUSERS A"
	SET @SQL = @SQL + "				LEFT OUTER JOIN"
	SET @SQL = @SQL + "				" + @SHAREDB + "..TBLUSERCONTROLMASTER B ON (A.FLDAUTO = B.FLDUSERID) WHERE A.FLDUSERNAME = '" + @USER_NAME + "'"
	SET @SQL = @SQL + "	) M"
	EXEC (@SQL)
	IF @@ROWCOUNT <= 0
		BEGIN
			UPDATE #CLASSLOGIN SET LOG_REASON = 'NO SUCH USER EXISTS.'
			SELECT * FROM #CLASSLOGIN
			RETURN
		END
	
	/*CREATE TABLE #TBLUSERCONTROLMASTER
	(
		FLDAUTO BIGINT,
		FLDUSERID INT,
		FLDPWDEXPIRY INT,
		FLDMAXATTEMPT SMALLINT,
		FLDATTEMPTCNT SMALLINT,
		FLDSTATUS SMALLINT,
		FLDLOGINFLAG SMALLINT,
		FLDACCESSLVL CHAR(1),
		FLDIPADD VARCHAR(2000),
		FLDTIMEOUT SMALLINT,
		FLDFIRSTLOGIN CHAR(1),
		FLDFORCELOGOUT SMALLINT
	)
	
	SET @SQL = "INSERT INTO #TBLUSERCONTROLMASTER (FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, FLDSTATUS, FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT) "
	SET @SQL = @SQL + "SELECT B.FLDAUTO, B.FLDUSERID, B.FLDPWDEXPIRY, B.FLDMAXATTEMPT, B.FLDATTEMPTCNT, B.FLDSTATUS, B.FLDLOGINFLAG, B.FLDACCESSLVL, B.FLDIPADD, B.FLDTIMEOUT, B.FLDFIRSTLOGIN, B.FLDFORCELOGOUT "
	SET @SQL = @SQL + "FROM " + @SHAREDB + "..TBLPRADNYAUSERS A LEFT OUTER JOIN " + @SHAREDB + "..TBLUSERCONTROLMASTER B ON (A.FLDAUTO = B.FLDUSERID) WHERE A.FLDUSERNAME = '" + @USER_NAME + "'"
	EXEC(@SQL)*/
	--SELECT * FROM #TBLUSERCONTROLMASTER
	
	/*IF (SELECT COUNT(1) FROM #TBLUSERCONTROLMASTER) <> 1
		BEGIN
			RAISERROR('No Such User Exists', 16, 1)
		END*/
	DECLARE
		@FLDAUTO BIGINT,
		@FLDUSERID INT,
		@FLDPWDEXPIRY INT,
		@FLDMAXATTEMPT SMALLINT,
		@FLDATTEMPTCNT SMALLINT,
		@FLDSTATUS SMALLINT,
		@FLDLOGINFLAG SMALLINT,
		@FLDACCESSLVL CHAR(1),
		@FLDIPADD VARCHAR(2000),
		@FLDTIMEOUT SMALLINT,
		@FLDFIRSTLOGIN CHAR(1),
		@FLDFORCELOGOUT SMALLINT,
		@LOOPI INT,
		@SPLITIP VARCHAR(20),
		@IPLOGIN BIT
	SELECT
		@FLDAUTO = ISNULL(FLDAUTO, 0),
		@FLDUSERID = ISNULL(FLDUSERID, 0),
		@FLDPWDEXPIRY = ISNULL(FLDPWDEXPIRY, ''),
		@FLDMAXATTEMPT = ISNULL(FLDMAXATTEMPT, 0),
		@FLDATTEMPTCNT = ISNULL(FLDATTEMPTCNT, 0),
		@FLDSTATUS = ISNULL(MFLDSTATUS, 0),
		@FLDLOGINFLAG = ISNULL(FLDLOGINFLAG, 0),
		@FLDACCESSLVL = ISNULL(FLDACCESSLVL, 'F'),
		@FLDIPADD = ISNULL(FLDIPADD, ''),
		@FLDTIMEOUT = ISNULL(FLDTIMEOUT, 0),
		@FLDFIRSTLOGIN = ISNULL(FLDFIRSTLOGIN, 'N'),
		@FLDFORCELOGOUT = ISNULL(FLDFORCELOGOUT, 0)
	FROM
		#CLASSLOGIN
		--#TBLUSERCONTROLMASTER
		
	IF @FLDFORCELOGOUT <> 0
		BEGIN
			SET @SQL = "UPDATE " + @SHAREDB + "..TBLUSERCONTROLMASTER SET FLDSTATUS = CASE WHEN " 
			SET @SQL = @SQL + CONVERT(VARCHAR, @FLDATTEMPTCNT) + " >= " + CONVERT(VARCHAR, @FLDMAXATTEMPT) 
			SET @SQL = @SQL + " THEN 1 ELSE FLDSTATUS END, FLDATTEMPTCNT = FLDATTEMPTCNT + 1 WHERE FLDAUTO = " + CONVERT(VARCHAR, @FLDAUTO)
			EXEC(@SQL)
			UPDATE #CLASSLOGIN SET LOG_REASON = 'Access has been TEMPORARILY RESTRICTED due to Database Maintainance at CSO Kindly bear with us for some time Sorry for the inconvenience.'
			SELECT * FROM #CLASSLOGIN
			RETURN
			--RAISERROR('Access has been TEMPORARILY RESTRICTED due to Database Maintainance at CSO Kindly bear with us for some time Sorry for the inconvenience.', 16, 1)
		END
	IF @FLDSTATUS <> 0
		BEGIN
			SET @SQL = "UPDATE " + @SHAREDB + "..TBLUSERCONTROLMASTER SET FLDSTATUS = CASE WHEN " + CONVERT(VARCHAR, @FLDATTEMPTCNT) + " >= " 
			SET @SQL = @SQL + CONVERT(VARCHAR, @FLDMAXATTEMPT) 
			SET @SQL = @SQL + " THEN 1 ELSE FLDSTATUS END, FLDATTEMPTCNT = FLDATTEMPTCNT + 1 WHERE FLDAUTO = " + CONVERT(VARCHAR, @FLDAUTO)
			EXEC (@SQL)
			UPDATE #CLASSLOGIN SET LOG_REASON = 'The User id  is DISABLED.  Kindly contact Administrator.'
			SELECT * FROM #CLASSLOGIN
			RETURN
			--RAISERROR('The User id  is DISABLED.  Kindly contact Administrator.', 16, 1)
		END
	IF @FLDATTEMPTCNT > @FLDMAXATTEMPT AND @DIRSEARCH = 'N'
		BEGIN
			SET @SQL = "UPDATE " + @SHAREDB + "..TBLUSERCONTROLMASTER SET FLDSTATUS = CASE WHEN " 
			SET @SQL = @SQL  + CONVERT(VARCHAR, @FLDATTEMPTCNT) + " >= " + CONVERT(VARCHAR, @FLDMAXATTEMPT) 
			SET @SQL = @SQL  + " THEN 1 ELSE FLDSTATUS END, FLDATTEMPTCNT = FLDATTEMPTCNT + 1 WHERE FLDAUTO = " + CONVERT(VARCHAR, @FLDAUTO)
			EXEC (@SQL)
			UPDATE #CLASSLOGIN SET LOG_REASON = 'You have exceeded the Maximum Number of Attempts for Login.'
			SELECT * FROM #CLASSLOGIN
			RETURN
			--RAISERROR('You have exceeded the Maximum Number of Attempts for Login.', 16, 1)
		END
	IF @FLDACCESSLVL <> 'F'
		BEGIN
			SET @IPLOGIN = 0
			IF LEN(@FLDIPADD) > 0
				BEGIN
					SET @LOOPI = 1
					WHILE 1 = 1
						BEGIN
							SET @SPLITIP = .dbo.PIECE(@FLDIPADD, '|', @LOOPI)
							IF @SPLITIP IS NULL OR @SPLITIP = ''
								BEGIN
									BREAK
								END
							IF LEFT(LTRIM(RTRIM(@REMOTEIP)), LEN(LTRIM(RTRIM(@SPLITIP)))) = LTRIM(RTRIM(@SPLITIP))
								BEGIN
									SET @IPLOGIN = 1
									BREAK
								END
							SET @LOOPI = @LOOPI + 1
						END
				END
			IF @IPLOGIN = 0
				BEGIN
					UPDATE #CLASSLOGIN SET LOG_REASON = 'Your IP Address is not registered in the System. Kindly contact System Administrator...'
					SELECT * FROM #CLASSLOGIN
					RETURN
					--RAISERROR('Your IP Address is not registered in the System. Kindly contact System Administrator...', 16, 1)
				END
		END
	SET @SQL = "UPDATE #CLASSLOGIN "
	SET @SQL = @SQL + "SET"
	SET @SQL = @SQL + "	FLDSTATUS = U.FLDSTATUS,"
	SET @SQL = @SQL + "	USERNAME = U.USERNAME,"
	SET @SQL = @SQL + "	FLDSTNAME = U.FLDSTNAME,"
	SET @SQL = @SQL + "	USER_LOGIN = U.USER_LOGIN,"
	SET @SQL = @SQL + "	PWD_EXPIRY = U.PWD_EXPIRY,"
	SET @SQL = @SQL + "	FLDCATEGORY = U.FLDCATEGORY,"
	SET @SQL = @SQL + "	USERAUTOID = U.USERAUTOID "
	SET @SQL = @SQL + "FROM"
	SET @SQL = @SQL + "	("
	SET @SQL = @SQL + "		SELECT"
	SET @SQL = @SQL + "			A.FLDSTATUS,"
	SET @SQL = @SQL + "			USERNAME = T.FLDFIRSTNAME + ' ' + T.FLDLASTNAME,"
	SET @SQL = @SQL + "			T.FLDSTNAME,"
	SET @SQL = @SQL + "			USER_LOGIN = T.FLDSTNAME,"
	SET @SQL = @SQL + "			PWD_EXPIRY = CASE WHEN '" + @DIRSEARCH + "' = 'Y' THEN 999 ELSE CAST(T.PWD_EXPIRY_DATE - GETDATE() AS INT) END,"
	SET @SQL = @SQL + "			T.FLDCATEGORY,"
	SET @SQL = @SQL + "			USERAUTOID = '" + @USER_NAME + "'"
	SET @SQL = @SQL + "		FROM"
	SET @SQL = @SQL + "			" + @SHAREDB + "..TBLPRADNYAUSERS T,"
	SET @SQL = @SQL + "			" + @SHAREDB + "..TBLADMIN A,"
	SET @SQL = @SQL + "			" + @SHAREDB + "..TBLUSERCONTROLMASTER C"
	SET @SQL = @SQL + "		WHERE"
	SET @SQL = @SQL + "			T.FLDADMINAUTO = A.FLDAUTO_ADMIN"
	SET @SQL = @SQL + "			AND C.FLDUSERID = T.FLDAUTO"
	SET @SQL = @SQL + "			AND T.FLDUSERNAME = '" + @USER_NAME + "'"
	IF @FORLOGIN = 'Y'
		BEGIN
			IF @DIRSEARCH = 'N'
				BEGIN
					SET @SQL = @SQL + "			AND T.FLDPASSWORD = '" + @PASSWORD + "'"
				END
		END
	SET @SQL = @SQL + "	) U"
	EXEC(@SQL)
	SET @AFFROWS = @@ROWCOUNT
	IF @FORLOGIN = 'Y' AND @AFFROWS <= 0
		BEGIN
			UPDATE #CLASSLOGIN SET LOG_REASON = 'INVALID PASSWORD...'
			SELECT * FROM #CLASSLOGIN
			RETURN
		END
	ELSE IF @FORLOGIN <> 'Y' AND @AFFROWS <= 0
		BEGIN
			UPDATE #CLASSLOGIN SET LOG_REASON = 'NO SUCH USER EXISTS.'
			SELECT * FROM #CLASSLOGIN
			RETURN
		END
	/*CREATE TABLE #TBLPRADNYAUSERS
	(
		FLDSTATUS VARCHAR(25),
		USERNAME VARCHAR(51),
		FLDSTNAME VARCHAR(50),
		USER_LOGIN VARCHAR(50),
		PWD_EXPIRY INT,
		FLDCATEGORY VARCHAR(10),
		USERAUTOID VARCHAR(25)
	)
	
	SET @SQL = "INSERT INTO #TBLPRADNYAUSERS (FLDSTATUS, USERNAME, FLDSTNAME, USER_LOGIN, PWD_EXPIRY, FLDCATEGORY, USERAUTOID) "
	SET @SQL = @SQL + "SELECT A.FLDSTATUS, T.FLDFIRSTNAME + ' ' + T.FLDLASTNAME, T.FLDSTNAME, T.FLDSTNAME, CAST(T.PWD_EXPIRY_DATE - GETDATE() AS INT), T.FLDCATEGORY, '" + @USER_NAME + "' "
	SET @SQL = @SQL + "FROM " + @SHAREDB + "..TBLPRADNYAUSERS T, " + @SHAREDB + "..TBLADMIN A, " + @SHAREDB + "..TBLUSERCONTROLMASTER C WHERE "
	SET @SQL = @SQL + "T.FLDADMINAUTO = A.FLDAUTO_ADMIN AND C.FLDUSERID = T.FLDAUTO AND T.FLDUSERNAME = '" + @USER_NAME + "' "
	IF @FORLOGIN = 'Y'
		BEGIN
			SET @SQL = @SQL + "AND T.FLDPASSWORD = '" + @PASSWORD + "'"
		END
	
	EXEC (@SQL)
	--SELECT * FROM #TBLPRADNYAUSERS
	IF @FORLOGIN = 'Y'
		BEGIN
			IF (SELECT COUNT(1) FROM #TBLPRADNYAUSERS) = 0
				BEGIN
					SET @SQL = "UPDATE " + @SHAREDB + "..TBLUSERCONTROLMASTER SET FLDSTATUS = CASE WHEN " + CONVERT(VARCHAR, @FLDATTEMPTCNT) + " >= " + CONVERT(VARCHAR, @FLDMAXATTEMPT) + " THEN 1 ELSE FLDSTATUS END, FLDATTEMPTCNT = FLDATTEMPTCNT + 1 WHERE FLDAUTO = "

 + CONVERT(VARCHAR, @FLDAUTO)
					EXEC (@SQL)
					RAISERROR('Incorrect Password...', 16, 1)
				END
		END*/
	IF (SELECT PWD_EXPIRY FROM #CLASSLOGIN /*#TBLPRADNYAUSERS*/) <= 0
		BEGIN
			UPDATE #CLASSLOGIN SET LOG_REASON = 'Your Password is expired...'
			SELECT * FROM #CLASSLOGIN
			RETURN
			--RAISERROR('Your Password is expired...', 16, 1)
		END
	/*SELECT * INTO TMP_TBLPRADNYAUSERS FROM #TBLPRADNYAUSERS, #TBLGLOBALPARAMS, #TBLUSERCONTROLMASTER, #SERVERINFO*/

	SELECT * FROM #CLASSLOGIN
	RETURN
	/*SELECT
		U.FLDSTATUS, U.USERNAME, U.FLDSTNAME, U.USER_LOGIN, U.PWD_EXPIRY, U.FLDCATEGORY, U.USERAUTOID,
		P.FLDPWDMINLENGTH, P.FLDPWDMAXLENGTH, P.FLDSPCLCHAR, P.FLDENCRYPTION, P.FLDBLOCKPWD,
		M.FLDAUTO, M.FLDUSERID, M.FLDPWDEXPIRY, M.FLDMAXATTEMPT, M.FLDATTEMPTCNT, MFLDSTATUS = M.FLDSTATUS, M.FLDLOGINFLAG,
		M.FLDACCESSLVL, M.FLDIPADD, M.FLDTIMEOUT, M.FLDFIRSTLOGIN, M.FLDFORCELOGOUT,
		S.SHAREDB, S.SHARESERVER, S.SHAREIP, S.ACCOUNTDB, S.ACCOUNTSERVER, S.ACCOUNTIP, S.LOGINID,
		S.LOGINPASSWORD, S.PRADNYASERVER
	INTO
		TMP_TBLPRADNYAUSERS
	FROM
		#TBLPRADNYAUSERS U, #TBLGLOBALPARAMS P, #TBLUSERCONTROLMASTER M, #SERVERINFO S*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_LOGIN_EXCHANGE_mar282013
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[CLASS_LOGIN_EXCHANGE_mar282013]  
 @USER_NAME VARCHAR(25),  
 @PASSWORD VARCHAR(100),  
 @REMOTEIP VARCHAR(20),  
 @EXCHANGE VARCHAR(5),  
 @SEGMENT VARCHAR(20),  
 @FORLOGIN VARCHAR(1)  
AS  
/*  
 EXEC CLASS_LOGIN_EXCHANGE 'YATIN', '2CA07326A266C50D', '', 'NSE', 'CAPITAL', 'Y'  
 EXEC CLASS_LOGIN_EXCHANGE 'YATIN', '2CA07326A266C50D', '', 'BSE', 'CAPITAL', 'N'  
 EXEC CLASS_LOGIN_EXCHANGE 'YATIN', '2CA07326A266C50D', '', 'NSE', 'FUTURES', 'N'  
*/  
 SET NOCOUNT ON  
 DECLARE  
  @SHAREDB VARCHAR(50),  
  @SHARESERVER VARCHAR(50),  
  @SHAREIP VARCHAR(50),  
  @ACCOUNTDB VARCHAR(50),  
  @ACCOUNTSERVER VARCHAR(50),  
  @ACCOUNTIP VARCHAR(50),  
  @LOGINID VARCHAR(20),  
  @LOGINPASSWORD VARCHAR(100),  
  @PRADNYASERVER VARCHAR(50),  
  @SQL VARCHAR(MAX),  
  @AFFROWS INT,  
  @SEGMENTDESC VARCHAR(100)  
   
 CREATE TABLE #CLASSLOGIN  
 (  
  FLDSTATUS VARCHAR(25),  
  USERNAME VARCHAR(51),  
  FLDSTNAME VARCHAR(50),  
  USER_LOGIN VARCHAR(50),  
  PWD_EXPIRY INT,  
  FLDCATEGORY VARCHAR(10),  
  USERAUTOID VARCHAR(25),  
  FLDPWDMINLENGTH SMALLINT,  
  FLDPWDMAXLENGTH SMALLINT,  
  FLDSPCLCHAR CHAR(1),  
  FLDPWDALPHANUMONLY INT,  
  FLDENCRYPTION CHAR(1),  
  FLDBLOCKPWD VARCHAR(255),  
  FLDAUTO BIGINT,  
  FLDUSERID INT,  
  FLDPWDEXPIRY INT,  
  FLDMAXATTEMPT SMALLINT,  
  FLDATTEMPTCNT SMALLINT,  
  MFLDSTATUS SMALLINT,  
  FLDLOGINFLAG SMALLINT,  
  FLDACCESSLVL CHAR(1),  
  FLDIPADD VARCHAR(2000),  
  FLDTIMEOUT SMALLINT,  
  FLDFIRSTLOGIN CHAR(1),  
  FLDFORCELOGOUT SMALLINT,  
  SHAREDB VARCHAR(50),  
  SHARESERVER VARCHAR(50),  
  SHAREIP VARCHAR(50),  
  ACCOUNTDB VARCHAR(50),  
  ACCOUNTSERVER VARCHAR(50),  
  ACCOUNTIP VARCHAR(50),  
  LOGINID VARCHAR(25),  
  LOGINPASSWORD VARCHAR(25),  
  PRADNYASERVER VARCHAR(256),  
  EXCHANGE VARCHAR(25),  
  SEGMENT VARCHAR(25),  
  LOG_REASON VARCHAR(200),  
  LOGINIP VARCHAR(20),  
  SEGMENTDESC VARCHAR(100)  
 )  
 INSERT INTO #CLASSLOGIN (FLDSTATUS, USERNAME, FLDSTNAME, USER_LOGIN, PWD_EXPIRY, FLDCATEGORY, USERAUTOID,  
       FLDPWDMINLENGTH, FLDPWDMAXLENGTH, FLDSPCLCHAR,FLDPWDALPHANUMONLY, FLDENCRYPTION, FLDBLOCKPWD, FLDAUTO,  
       FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, MFLDSTATUS, FLDLOGINFLAG,  
       FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT, SHAREDB,  
       SHARESERVER, SHAREIP, ACCOUNTDB, ACCOUNTSERVER, ACCOUNTIP, LOGINID, LOGINPASSWORD,  
       PRADNYASERVER, EXCHANGE, SEGMENT, LOG_REASON, LOGINIP, SEGMENTDESC)  
 VALUES  
  ('', '', '', '', 0, '', @USER_NAME,  
  0, 0, '','', '', '', 0,  
  0, 0, 0, 0, 0, 0,  
  '', '', 0, '', 0, '',  
  '', '', '', '', '', '', '',  
  '', @EXCHANGE, @SEGMENT, '', @REMOTEIP,'')  
  
 /*CREATE TABLE #SERVERINFO  
 (  
  SHAREDB VARCHAR(20),  
  SHARESERVER VARCHAR(15),  
  SHAREIP VARCHAR(15),  
  ACCOUNTDB VARCHAR(20),  
  ACCOUNTSERVER VARCHAR(15),  
  ACCOUNTIP VARCHAR(15),  
  LOGINID VARCHAR(25),  
  LOGINPASSWORD VARCHAR(25),  
  PRADNYASERVER VARCHAR(256)  
 )*/  
 UPDATE #CLASSLOGIN  
 SET  
  SHAREDB = M.SHAREDB,  
  SHARESERVER = M.SHARESERVER,  
  SHAREIP = M.SHAREIP,  
  ACCOUNTDB = M.ACCOUNTDB,  
  ACCOUNTSERVER = M.ACCOUNTSERVER,  
  ACCOUNTIP = M.ACCOUNTIP,  
  LOGINID = M.DBUSERNAME,  
  LOGINPASSWORD = M.DBPASSWORD,  
  PRADNYASERVER = @@SERVERNAME,  
  SEGMENTDESC = SEGMENT_DESCRIPTION  
 FROM  
  MULTICOMPANY M  
 WHERE  
  M.EXCHANGE = @EXCHANGE  
  AND M.SEGMENT = @SEGMENT  
  AND M.PRIMARYSERVER = 1  
  
 /*INSERT INTO #SERVERINFO (SHAREDB, SHARESERVER, SHAREIP, ACCOUNTDB, ACCOUNTSERVER, ACCOUNTIP, LOGINID, LOGINPASSWORD, PRADNYASERVER)  
 SELECT  
  SHAREDB,  
  ISNULL(SHARESERVER, ''),  
  ISNULL(SHAREIP, ''),  
  ISNULL(ACCOUNTDB, ''),  
  ISNULL(ACCOUNTSERVER, ''),  
  ISNULL(ACCOUNTIP, ''),  
  ISNULL(DBUSERNAME, ''),  
  ISNULL(DBPASSWORD, ''),  
  @@SERVERNAME  
 FROM  
  MULTICOMPANY  
 WHERE  
  EXCHANGE = @EXCHANGE  
  AND SEGMENT = @SEGMENT  
  AND PRIMARYSERVER = 1*/  
  
 SELECT  
  @SHAREDB = SHAREDB,  
  @SHARESERVER = SHARESERVER,  
  @SHAREIP = SHAREIP,  
  @ACCOUNTDB = ACCOUNTDB,  
  @ACCOUNTSERVER = ACCOUNTSERVER,  
  @ACCOUNTIP = ACCOUNTIP,  
  @LOGINID = LOGINID,  
  @LOGINPASSWORD = LOGINPASSWORD,  
  @PRADNYASERVER = PRADNYASERVER,  
  @SEGMENTDESC = SEGMENTDESC  
 FROM  
  #CLASSLOGIN  
   
 /*SELECT  
  SHAREDB = @SHAREDB,  
  SHARESERVER = @SHARESERVER,  
  SHAREIP = @SHAREIP,  
  ACCOUNTDB = @ACCOUNTDB,  
  ACCOUNTSERVER = @ACCOUNTSERVER,  
  ACCOUNTIP = @ACCOUNTIP,  
  DBUSERNAME = @LOGINID,  
  DBPASSWORD = @LOGINPASSWORD,  
  SERVERNAME = @PRADNYASERVER*/  
 SET @SQL = "UPDATE #CLASSLOGIN "  
 SET @SQL = @SQL + "SET"  
 SET @SQL = @SQL + " FLDPWDMINLENGTH = P.FLDPWDMINLENGTH,"  
 SET @SQL = @SQL + " FLDPWDMAXLENGTH = P.FLDPWDMAXLENGTH,"  
 SET @SQL = @SQL + " FLDENCRYPTION = P.FLDENCRYPTION,"  
 SET @SQL = @SQL + " FLDSPCLCHAR = P.FLDSPCLCHAR,"  
    SET @SQL = @SQL + " FLDPWDALPHANUMONLY = P.FLDPWDALPHANUMONLY,"  
 SET @SQL = @SQL + " FLDBLOCKPWD = P.FLDBLOCKPWD "  
 SET @SQL = @SQL + "FROM "  
 SET @SQL = @SQL + @SHAREDB + ".dbo.TBLGLOBALPARAMS P"  
 EXEC (@SQL)  
 /*CREATE TABLE #TBLGLOBALPARAMS  
 (  
  FLDPWDMINLENGTH SMALLINT,  
  FLDPWDMAXLENGTH SMALLINT,  
  FLDSPCLCHAR CHAR(1),  
  FLDENCRYPTION CHAR(1),  
  FLDBLOCKPWD VARCHAR(255)  
 )  
 SET @SQL = "INSERT INTO #TBLGLOBALPARAMS (FLDPWDMINLENGTH, FLDPWDMAXLENGTH, FLDSPCLCHAR, FLDENCRYPTION, FLDBLOCKPWD) "  
 SET @SQL = @SQL + "SELECT FLDPWDMINLENGTH, FLDPWDMAXLENGTH, FLDENCRYPTION, FLDSPCLCHAR, FLDBLOCKPWD FROM "  
 SET @SQL = @SQL + @SHAREDB + ".dbo.TBLGLOBALPARAMS"  
 EXEC(@SQL)  
 */  
 --SELECT * FROM #TBLGLOBALPARAMS  
 SET @SQL = "UPDATE #CLASSLOGIN "  
 SET @SQL = @SQL + "SET"  
 SET @SQL = @SQL + " FLDAUTO = M.FLDAUTO,"  
 SET @SQL = @SQL + " FLDUSERID = M.FLDUSERID,"  
 SET @SQL = @SQL + " FLDPWDEXPIRY = M.FLDPWDEXPIRY,"  
 SET @SQL = @SQL + " FLDMAXATTEMPT = M.FLDMAXATTEMPT,"  
 SET @SQL = @SQL + " FLDATTEMPTCNT = M.FLDATTEMPTCNT,"  
 SET @SQL = @SQL + " MFLDSTATUS = M.FLDSTATUS,"  
 SET @SQL = @SQL + " FLDLOGINFLAG = M.FLDLOGINFLAG,"  
 SET @SQL = @SQL + " FLDACCESSLVL = M.FLDACCESSLVL,"  
 SET @SQL = @SQL + " FLDIPADD = M.FLDIPADD,"  
 SET @SQL = @SQL + " FLDTIMEOUT = M.FLDTIMEOUT,"  
 SET @SQL = @SQL + " FLDFIRSTLOGIN = M.FLDFIRSTLOGIN,"  
 SET @SQL = @SQL + " FLDFORCELOGOUT = M.FLDFORCELOGOUT "  
 SET @SQL = @SQL + "FROM"  
 SET @SQL = @SQL + " ("  
 SET @SQL = @SQL + "  SELECT"  
 SET @SQL = @SQL + "   B.FLDAUTO,"  
 SET @SQL = @SQL + "   B.FLDUSERID,"  
 SET @SQL = @SQL + "   B.FLDPWDEXPIRY,"  
 SET @SQL = @SQL + "   B.FLDMAXATTEMPT,"  
 SET @SQL = @SQL + "   B.FLDATTEMPTCNT,"  
 SET @SQL = @SQL + "   B.FLDSTATUS,"  
 SET @SQL = @SQL + "   B.FLDLOGINFLAG,"  
 SET @SQL = @SQL + "   B.FLDACCESSLVL,"  
 SET @SQL = @SQL + "   B.FLDIPADD,"  
 SET @SQL = @SQL + "   B.FLDTIMEOUT,"  
 SET @SQL = @SQL + "   B.FLDFIRSTLOGIN,"  
 SET @SQL = @SQL + "   B.FLDFORCELOGOUT"  
 SET @SQL = @SQL + "  FROM"  
 SET @SQL = @SQL + "   " + @SHAREDB + ".dbo.TBLPRADNYAUSERS A"  
 SET @SQL = @SQL + "    LEFT OUTER JOIN"  
 SET @SQL = @SQL + "    " + @SHAREDB + ".dbo.TBLUSERCONTROLMASTER B ON (A.FLDAUTO = B.FLDUSERID) WHERE A.FLDUSERNAME = '" + @USER_NAME + "'"  
 SET @SQL = @SQL + " ) M"  
 EXEC (@SQL)  
 IF @@ROWCOUNT <= 0  
  BEGIN  
   UPDATE #CLASSLOGIN SET LOG_REASON = 'NO SUCH USER EXISTS.'  
   SELECT * FROM #CLASSLOGIN  
   RETURN  
  END  
 /*CREATE TABLE #TBLUSERCONTROLMASTER  
 (  
  FLDAUTO BIGINT,  
  FLDUSERID INT,  
  FLDPWDEXPIRY INT,  
  FLDMAXATTEMPT SMALLINT,  
  FLDATTEMPTCNT SMALLINT,  
  FLDSTATUS SMALLINT,  
  FLDLOGINFLAG SMALLINT,  
  FLDACCESSLVL CHAR(1),  
  FLDIPADD VARCHAR(2000),  
  FLDTIMEOUT SMALLINT,  
  FLDFIRSTLOGIN CHAR(1),  
  FLDFORCELOGOUT SMALLINT  
 )  
   
 SET @SQL = "INSERT INTO #TBLUSERCONTROLMASTER (FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, FLDSTATUS, FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT) "  
 SET @SQL = @SQL + "SELECT B.FLDAUTO, B.FLDUSERID, B.FLDPWDEXPIRY, B.FLDMAXATTEMPT, B.FLDATTEMPTCNT, B.FLDSTATUS, B.FLDLOGINFLAG, B.FLDACCESSLVL, B.FLDIPADD, B.FLDTIMEOUT, B.FLDFIRSTLOGIN, B.FLDFORCELOGOUT "  
 SET @SQL = @SQL + "FROM " + @SHAREDB + ".dbo.TBLPRADNYAUSERS A LEFT OUTER JOIN " + @SHAREDB + ".dbo.TBLUSERCONTROLMASTER B ON (A.FLDAUTO = B.FLDUSERID) WHERE A.FLDUSERNAME = '" + @USER_NAME + "'"  
 EXEC(@SQL)*/  
 --SELECT * FROM #TBLUSERCONTROLMASTER  
   
 /*IF (SELECT COUNT(1) FROM #TBLUSERCONTROLMASTER) <> 1  
  BEGIN  
   RAISERROR('No Such User Exists', 16, 1)  
  END*/  
 DECLARE  
  @FLDAUTO BIGINT,  
  @FLDUSERID INT,  
  @FLDPWDEXPIRY INT,  
  @FLDMAXATTEMPT SMALLINT,  
  @FLDATTEMPTCNT SMALLINT,  
  @FLDSTATUS SMALLINT,  
  @FLDLOGINFLAG SMALLINT,  
  @FLDACCESSLVL CHAR(1),  
  @FLDIPADD VARCHAR(2000),  
  @FLDTIMEOUT SMALLINT,  
  @FLDFIRSTLOGIN CHAR(1),  
  @FLDFORCELOGOUT SMALLINT,  
  @LOOPI INT,  
  @SPLITIP VARCHAR(20),  
  @IPLOGIN BIT  
 SELECT  
  @FLDAUTO = ISNULL(FLDAUTO, 0),  
  @FLDUSERID = ISNULL(FLDUSERID, 0),  
  @FLDPWDEXPIRY = ISNULL(FLDPWDEXPIRY, ''),  
  @FLDMAXATTEMPT = ISNULL(FLDMAXATTEMPT, 0),  
  @FLDATTEMPTCNT = ISNULL(FLDATTEMPTCNT, 0),  
  @FLDSTATUS = ISNULL(MFLDSTATUS, 0),  
  @FLDLOGINFLAG = ISNULL(FLDLOGINFLAG, 0),  
  @FLDACCESSLVL = ISNULL(FLDACCESSLVL, 'F'),  
  @FLDIPADD = ISNULL(FLDIPADD, ''),  
  @FLDTIMEOUT = ISNULL(FLDTIMEOUT, 0),  
  @FLDFIRSTLOGIN = ISNULL(FLDFIRSTLOGIN, 'N'),  
  @FLDFORCELOGOUT = ISNULL(FLDFORCELOGOUT, 0)  
 FROM  
  #CLASSLOGIN  
  --#TBLUSERCONTROLMASTER  
    
 IF @FLDFORCELOGOUT <> 0  
  BEGIN  
   SET @SQL = "UPDATE " + @SHAREDB + ".dbo.TBLUSERCONTROLMASTER SET FLDSTATUS = CASE WHEN "   
   SET @SQL = @SQL + CONVERT(VARCHAR, @FLDATTEMPTCNT) + " >= " + CONVERT(VARCHAR, @FLDMAXATTEMPT)   
   SET @SQL = @SQL + " THEN 1 ELSE FLDSTATUS END, FLDATTEMPTCNT = FLDATTEMPTCNT + 1 WHERE FLDAUTO = " + CONVERT(VARCHAR, @FLDAUTO)  
   EXEC(@SQL)  
   UPDATE #CLASSLOGIN SET LOG_REASON = 'Access has been TEMPORARILY RESTRICTED due to Database Maintainance at CSO Kindly bear with us for some time Sorry for the inconvenience.'  
   SELECT * FROM #CLASSLOGIN  
   RETURN  
   --RAISERROR('Access has been TEMPORARILY RESTRICTED due to Database Maintainance at CSO Kindly bear with us for some time Sorry for the inconvenience.', 16, 1)  
  END  
 IF @FLDSTATUS <> 0  
  BEGIN  
   SET @SQL = "UPDATE " + @SHAREDB + ".dbo.TBLUSERCONTROLMASTER SET FLDSTATUS = CASE WHEN " + CONVERT(VARCHAR, @FLDATTEMPTCNT) + " >= "   
   SET @SQL = @SQL + CONVERT(VARCHAR, @FLDMAXATTEMPT)   
   SET @SQL = @SQL + " THEN 1 ELSE FLDSTATUS END, FLDATTEMPTCNT = FLDATTEMPTCNT + 1 WHERE FLDAUTO = " + CONVERT(VARCHAR, @FLDAUTO)  
   EXEC (@SQL)  
   UPDATE #CLASSLOGIN SET LOG_REASON = 'The User id  is DISABLED.  Kindly contact Administrator.'  
   SELECT * FROM #CLASSLOGIN  
   RETURN  
   --RAISERROR('The User id  is DISABLED.  Kindly contact Administrator.', 16, 1)  
  END  
 IF @FLDATTEMPTCNT > @FLDMAXATTEMPT  
  BEGIN  
   SET @SQL = "UPDATE " + @SHAREDB + ".dbo.TBLUSERCONTROLMASTER SET FLDSTATUS = CASE WHEN "   
   SET @SQL = @SQL  + CONVERT(VARCHAR, @FLDATTEMPTCNT) + " >= " + CONVERT(VARCHAR, @FLDMAXATTEMPT)   
   SET @SQL = @SQL  + " THEN 1 ELSE FLDSTATUS END, FLDATTEMPTCNT = FLDATTEMPTCNT + 1 WHERE FLDAUTO = " + CONVERT(VARCHAR, @FLDAUTO)  
   EXEC (@SQL)  
   UPDATE #CLASSLOGIN SET LOG_REASON = 'You have exceeded the Maximum Number of Attempts for Login.'  
   SELECT * FROM #CLASSLOGIN  
   RETURN  
   --RAISERROR('You have exceeded the Maximum Number of Attempts for Login.', 16, 1)  
  END  
 IF @FLDACCESSLVL <> 'F'  
  BEGIN  
   SET @IPLOGIN = 0  
   IF LEN(@FLDIPADD) > 0  
    BEGIN  
     SET @LOOPI = 1  
     WHILE 1 = 1  
      BEGIN  
       SET @SPLITIP = .dbo.PIECE(@FLDIPADD, '|', @LOOPI)  
       IF @SPLITIP IS NULL OR @SPLITIP = ''  
        BEGIN  
         BREAK  
        END  
       IF LEFT(LTRIM(RTRIM(@REMOTEIP)), LEN(LTRIM(RTRIM(@SPLITIP)))) = LTRIM(RTRIM(@SPLITIP))  
        BEGIN  
         SET @IPLOGIN = 1  
         BREAK  
        END  
       SET @LOOPI = @LOOPI + 1  
      END  
    END  
   IF @IPLOGIN = 0  
    BEGIN  
     UPDATE #CLASSLOGIN SET LOG_REASON = 'Your IP Address is not registered in the System. Kindly contact System Administrator...'  
     SELECT * FROM #CLASSLOGIN  
     RETURN  
     --RAISERROR('Your IP Address is not registered in the System. Kindly contact System Administrator...', 16, 1)  
    END  
  END  
 SET @SQL = "UPDATE #CLASSLOGIN "  
 SET @SQL = @SQL + "SET"  
 SET @SQL = @SQL + " FLDSTATUS = U.FLDSTATUS,"  
 SET @SQL = @SQL + " USERNAME = U.USERNAME,"  
 SET @SQL = @SQL + " FLDSTNAME = U.FLDSTNAME,"  
 SET @SQL = @SQL + " USER_LOGIN = U.USER_LOGIN,"  
 SET @SQL = @SQL + " PWD_EXPIRY = U.PWD_EXPIRY,"  
 SET @SQL = @SQL + " FLDCATEGORY = U.FLDCATEGORY,"  
 SET @SQL = @SQL + " USERAUTOID = U.USERAUTOID "  
 SET @SQL = @SQL + "FROM"  
 SET @SQL = @SQL + " ("  
 SET @SQL = @SQL + "  SELECT"  
 SET @SQL = @SQL + "   A.FLDSTATUS,"  
 SET @SQL = @SQL + "   USERNAME = T.FLDFIRSTNAME + ' ' + T.FLDLASTNAME,"  
 SET @SQL = @SQL + "   T.FLDSTNAME,"  
 SET @SQL = @SQL + "   USER_LOGIN = T.FLDSTNAME,"  
 SET @SQL = @SQL + "   PWD_EXPIRY = CAST(T.PWD_EXPIRY_DATE - GETDATE() AS INT),"  
 SET @SQL = @SQL + "   T.FLDCATEGORY,"  
 SET @SQL = @SQL + "   USERAUTOID = '" + @USER_NAME + "'"  
 SET @SQL = @SQL + "  FROM"  
 SET @SQL = @SQL + "   " + @SHAREDB + ".dbo.TBLPRADNYAUSERS T,"  
 SET @SQL = @SQL + "   " + @SHAREDB + ".dbo.TBLADMIN A,"  
 SET @SQL = @SQL + "   " + @SHAREDB + ".dbo.TBLUSERCONTROLMASTER C"  
 SET @SQL = @SQL + "  WHERE"  
 SET @SQL = @SQL + "   T.FLDADMINAUTO = A.FLDAUTO_ADMIN"  
 SET @SQL = @SQL + "   AND C.FLDUSERID = T.FLDAUTO"  
 SET @SQL = @SQL + "   AND T.FLDUSERNAME = '" + @USER_NAME + "'"  
 IF @FORLOGIN = 'Y'  
  BEGIN  
   SET @SQL = @SQL + "   AND T.FLDPASSWORD = '" + @PASSWORD + "'"  
  END  
 SET @SQL = @SQL + " ) U"  
 EXEC(@SQL)  
 SET @AFFROWS = @@ROWCOUNT  
 IF @FORLOGIN = 'Y' AND @AFFROWS <= 0  
  BEGIN  
   UPDATE #CLASSLOGIN SET LOG_REASON = 'INVALID PASSWORD...'  
   SELECT * FROM #CLASSLOGIN  
   RETURN  
  END  
 ELSE IF @FORLOGIN <> 'Y' AND @AFFROWS <= 0  
  BEGIN  
   UPDATE #CLASSLOGIN SET LOG_REASON = 'NO SUCH USER EXISTS.'  
   SELECT * FROM #CLASSLOGIN  
   RETURN  
  END  
 /*CREATE TABLE #TBLPRADNYAUSERS  
 (  
  FLDSTATUS VARCHAR(25),  
  USERNAME VARCHAR(51),  
  FLDSTNAME VARCHAR(50),  
  USER_LOGIN VARCHAR(50),  
  PWD_EXPIRY INT,  
  FLDCATEGORY VARCHAR(10),  
  USERAUTOID VARCHAR(25)  
 )  
   
 SET @SQL = "INSERT INTO #TBLPRADNYAUSERS (FLDSTATUS, USERNAME, FLDSTNAME, USER_LOGIN, PWD_EXPIRY, FLDCATEGORY, USERAUTOID) "  
 SET @SQL = @SQL + "SELECT A.FLDSTATUS, T.FLDFIRSTNAME + ' ' + T.FLDLASTNAME, T.FLDSTNAME, T.FLDSTNAME, CAST(T.PWD_EXPIRY_DATE - GETDATE() AS INT), T.FLDCATEGORY, '" + @USER_NAME + "' "  
 SET @SQL = @SQL + "FROM " + @SHAREDB + ".dbo.TBLPRADNYAUSERS T, " + @SHAREDB + ".dbo.TBLADMIN A, " + @SHAREDB + ".dbo.TBLUSERCONTROLMASTER C WHERE "  
 SET @SQL = @SQL + "T.FLDADMINAUTO = A.FLDAUTO_ADMIN AND C.FLDUSERID = T.FLDAUTO AND T.FLDUSERNAME = '" + @USER_NAME + "' "  
 IF @FORLOGIN = 'Y'  
  BEGIN  
   SET @SQL = @SQL + "AND T.FLDPASSWORD = '" + @PASSWORD + "'"  
  END  
   
 EXEC (@SQL)  
 --SELECT * FROM #TBLPRADNYAUSERS  
 IF @FORLOGIN = 'Y'  
  BEGIN  
   IF (SELECT COUNT(1) FROM #TBLPRADNYAUSERS) = 0  
    BEGIN  
     SET @SQL = "UPDATE " + @SHAREDB + ".dbo.TBLUSERCONTROLMASTER SET FLDSTATUS = CASE WHEN " + CONVERT(VARCHAR, @FLDATTEMPTCNT) + " >= " + CONVERT(VARCHAR, @FLDMAXATTEMPT) + " THEN 1 ELSE FLDSTATUS END, FLDATTEMPTCNT = FLDATTEMPTCNT + 1 WHERE FLDAUTO = "
  
  
 + CONVERT(VARCHAR, @FLDAUTO)  
     EXEC (@SQL)  
     RAISERROR('Incorrect Password...', 16, 1)  
    END  
  END*/  
 IF (SELECT PWD_EXPIRY FROM #CLASSLOGIN /*#TBLPRADNYAUSERS*/) <= 0  
  BEGIN  
   UPDATE #CLASSLOGIN SET LOG_REASON = 'Your Password is expired...'  
   SELECT * FROM #CLASSLOGIN  
   RETURN  
   --RAISERROR('Your Password is expired...', 16, 1)  
  END  
 /*SELECT * INTO TMP_TBLPRADNYAUSERS FROM #TBLPRADNYAUSERS, #TBLGLOBALPARAMS, #TBLUSERCONTROLMASTER, #SERVERINFO*/  
  
 SELECT * FROM #CLASSLOGIN  
 RETURN  
 /*SELECT  
  U.FLDSTATUS, U.USERNAME, U.FLDSTNAME, U.USER_LOGIN, U.PWD_EXPIRY, U.FLDCATEGORY, U.USERAUTOID,  
  P.FLDPWDMINLENGTH, P.FLDPWDMAXLENGTH, P.FLDSPCLCHAR, P.FLDENCRYPTION, P.FLDBLOCKPWD,  
  M.FLDAUTO, M.FLDUSERID, M.FLDPWDEXPIRY, M.FLDMAXATTEMPT, M.FLDATTEMPTCNT, MFLDSTATUS = M.FLDSTATUS, M.FLDLOGINFLAG,  
  M.FLDACCESSLVL, M.FLDIPADD, M.FLDTIMEOUT, M.FLDFIRSTLOGIN, M.FLDFORCELOGOUT,  
  S.SHAREDB, S.SHARESERVER, S.SHAREIP, S.ACCOUNTDB, S.ACCOUNTSERVER, S.ACCOUNTIP, S.LOGINID,  
  S.LOGINPASSWORD, S.PRADNYASERVER  
 INTO  
  TMP_TBLPRADNYAUSERS  
 FROM  
  #TBLPRADNYAUSERS U, #TBLGLOBALPARAMS P, #TBLUSERCONTROLMASTER M, #SERVERINFO S*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_MENUSTRING
-- --------------------------------------------------
CREATE PROC [dbo].[CLASS_MENUSTRING]
/*(
	@SHAREDB VARCHAR(25),
	@UCAT VARCHAR(100)
)*/
AS
/*
	EXEC CLASS_MENUSTRING 'BSEDB', '370'
*/
SET NOCOUNT ON
/*CREATE TABLE #MENU
(
	SRNO INT IDENTITY(1,1),
	FLDREPORTCODE INT,
	FLDREPORTNAME VARCHAR(35),
	FLDPATH VARCHAR(500),
	FLDTARGET VARCHAR(25),
	FLDGRPNAME VARCHAR(35),
	FLDMENUNAME VARCHAR(20),
	FLDMENUGRP VARCHAR(3),
	MAINGRP VARCHAR(30)
)*/
DECLARE
	@SQL VARCHAR(2000),
	@MENUSTRING VARCHAR(2000),
	@MENUCUR CURSOR,
	@LFLDMENUGRP VARCHAR(3),
	@LFLDGRPNAME VARCHAR(35),
	@LMAINGRP VARCHAR(30),
	
	@MAINGRP VARCHAR(30),
	@FLDREPORTCODE INT,
	@FLDREPORTNAME VARCHAR(35),
	@FLDPATH VARCHAR(500),
	@FLDTARGET VARCHAR(25),
	@FLDGRPNAME VARCHAR(35),
	@FLDMENUNAME VARCHAR(20),
	@FLDMENUGRP VARCHAR(3)
	
/*	SET @SQL = 'INSERT INTO #MENU (FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP)'
	SET @SQL = @SQL + 'SELECT'
	SET @SQL = @SQL + '	R.FLDREPORTCODE,'
	SET @SQL = @SQL + '	R.FLDREPORTNAME,'
	SET @SQL = @SQL + '	R.FLDPATH,'
	SET @SQL = @SQL + '	R.FLDTARGET,'
	SET @SQL = @SQL + '	G.FLDGRPNAME,'
	SET @SQL = @SQL + '	M.FLDMENUNAME,'
	SET @SQL = @SQL + '	R.FLDMENUGRP,'
	SET @SQL = @SQL + '	MAINGRP = CASE WHEN G.FLDMENUGRP BETWEEN 0 AND 3 THEN ''Share Accounting'' ELSE CASE WHEN G.FLDMENUGRP BETWEEN 4 AND 6 THEN ''Finance Accounting'' ELSE ''Utilities'' END END '
	SET @SQL = @SQL + 'FROM'
	SET @SQL = @SQL + '	' + @SHAREDB + '.dbo.TBLREPORTS R,'
	SET @SQL = @SQL + '	' + @SHAREDB + '.dbo.TBLREPORTGRP G,'
	SET @SQL = @SQL + '	' + @SHAREDB + '.dbo.TBLMENUHEAD M '
	SET @SQL = @SQL + 'WHERE'
	SET @SQL = @SQL + '	R.FLDREPORTGRP =G.FLDREPORTGRP'
	SET @SQL = @SQL + '	AND R.FLDMENUGRP = M.FLDMENUCODE'
	SET @SQL = @SQL + '	AND EXISTS (SELECT FLDREPORTCODE FROM ' + @SHAREDB + '.dbo.TBLCATMENU C WHERE CHARINDEX('',' + @UCAT + ','', C.FLDCATEGORYCODE) > 0 AND R.FLDREPORTCODE = C.FLDREPORTCODE) '
	SET @SQL = @SQL + 'ORDER BY R.FLDMENUGRP,G.FLDGRPNAME,R.FLDORDER ,R.FLDREPORTNAME'
	EXEC(@SQL)*/
	IF (SELECT COUNT(1) FROM #MENU) > 0
		BEGIN
			/*UPDATE #MENU SET MAINGRP = CASE WHEN FLDMENUGRP BETWEEN 0 AND 3 THEN 1 ELSE CASE WHEN FLDMENUGRP BETWEEN 4 AND 6 THEN 2 ELSE 3 END END WHERE SRNO IN
			(SELECT SRNO = MIN(SRNO) FROM #MENU GROUP BY CASE WHEN FLDMENUGRP BETWEEN 0 AND 3 THEN 1 ELSE CASE WHEN FLDMENUGRP BETWEEN 4 AND 6 THEN 2 ELSE 3 END END)*/

			SET @MENUCUR = CURSOR FOR
			SELECT FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP--, MAINGRP
			FROM #MENU ORDER BY SRNO
			SET @LFLDMENUGRP = ''
			SET @LFLDGRPNAME = ''
			--SET @LMAINGRP = ''
			OPEN @MENUCUR
			FETCH NEXT FROM @MENUCUR INTO @FLDREPORTCODE, @FLDREPORTNAME, @FLDPATH, @FLDTARGET, @FLDGRPNAME, @FLDMENUNAME, @FLDMENUGRP--, @MAINGRP
			WHILE @@FETCH_STATUS = 0
				BEGIN
					/*IF @MAINGRP <> @LMAINGRP
						BEGIN
							IF @LMAINGRP <> ''
								BEGIN
									PRINT '						</ul>'
									PRINT '					</li>'
									PRINT '				</ul>'
									PRINT '			</li>'
									PRINT '		</ul>'
									PRINT '	</li>'
								END
							PRINT '	<li><a class="qmparent" href="javascript:void(0);">' + @MAINGRP + '</a>'
							PRINT '		<ul>'
							SET @LMAINGRP = @MAINGRP
						END*/
					IF @LFLDMENUGRP <> @FLDMENUGRP
						BEGIN
							IF @LFLDMENUGRP <> ''
								BEGIN
									INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('						</ul>')
									INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('					</li>')
									INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('				</ul>')
									INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('			</li>')
								END
							INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('			<li><a class="qmparent" href="javascript:void(0);">' + @FLDMENUNAME + '</a>')
							INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('				<ul>')
							SET @LFLDMENUGRP = @FLDMENUGRP
							IF @LFLDGRPNAME <> @FLDGRPNAME
								BEGIN
									--IF @LFLDGRPNAME <> ''
									--	BEGIN
									--		PRINT '</ul></li>'
									--	END
									INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('					<li><a class="qmparent" href="javascript:void(0);">' + @FLDGRPNAME + '</a>')
									INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('						<ul>')
									SET @LFLDGRPNAME = @FLDGRPNAME
								END
						END
						IF @LFLDGRPNAME <> @FLDGRPNAME
							BEGIN
								IF @LFLDGRPNAME <> ''
									BEGIN
										INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('						</ul>')
										INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('					</li>')
									END
								INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('					<li><a class="qmparent" href="javascript:void(0);">' + @FLDGRPNAME + '</a>')
								INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('						<ul>')
								SET @LFLDGRPNAME = @FLDGRPNAME
							END
					INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('							<li><a href="javascript:Display(''' + CONVERT(VARCHAR, @FLDREPORTCODE) + ''');">' + @FLDREPORTNAME + '</a></li>')
					FETCH NEXT FROM @MENUCUR INTO @FLDREPORTCODE, @FLDREPORTNAME, @FLDPATH, @FLDTARGET, @FLDGRPNAME, @FLDMENUNAME, @FLDMENUGRP--, @MAINGRP
				END
		END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_MENUSTRING_MASTER
-- --------------------------------------------------

CREATE PROC [dbo].[CLASS_MENUSTRING_MASTER]
(
	@SHAREDB VARCHAR(25),
	@UCAT VARCHAR(100),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(20),
	@OPENPOS VARCHAR(1),
	@NETMENU VARCHAR(1) = 'N'
)
AS
/*
	EXEC CLASS_MENUSTRING_MASTER 'MSAJAG', '388', 'NSE', 'CAPITAL', 
*/
SET NOCOUNT ON
CREATE TABLE #MASTERMENU
(
	SRNO INT IDENTITY(1,1),
	FLDREPORTCODE INT,
	FLDREPORTNAME VARCHAR(35),
	FLDPATH VARCHAR(500),
	FLDTARGET VARCHAR(25),
	FLDGRPNAME VARCHAR(35),
	FLDMENUNAME VARCHAR(20),
	FLDMENUGRP VARCHAR(3),
	MAINGRP VARCHAR(30)
)
DECLARE
	@SQL VARCHAR(2000)
	SET @SQL = 'INSERT INTO #MASTERMENU (FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP)'
	SET @SQL = @SQL + 'SELECT'
	SET @SQL = @SQL + '	R.FLDREPORTCODE,'
	SET @SQL = @SQL + '	R.FLDREPORTNAME,'
	SET @SQL = @SQL + '	R.FLDPATH,'
	SET @SQL = @SQL + '	R.FLDTARGET,'
	SET @SQL = @SQL + '	G.FLDGRPNAME,'
	SET @SQL = @SQL + '	M.FLDMENUNAME,'
	SET @SQL = @SQL + '	R.FLDMENUGRP,'
	SET @SQL = @SQL + '	MAINGRP = CASE WHEN G.FLDMENUGRP BETWEEN 0 AND 3 THEN ''Share Accounting'' ELSE CASE WHEN G.FLDMENUGRP BETWEEN 4 AND 6 THEN ''Finance Accounting'' ELSE ''Utilities'' END END '
	SET @SQL = @SQL + 'FROM'
	SET @SQL = @SQL + '	' + @SHAREDB + '..TBLREPORTS R,'
	SET @SQL = @SQL + '	' + @SHAREDB + '..TBLREPORTGRP G,'
	SET @SQL = @SQL + '	' + @SHAREDB + '..TBLMENUHEAD M '
	SET @SQL = @SQL + 'WHERE'
	SET @SQL = @SQL + '	R.FLDREPORTGRP =G.FLDREPORTGRP'
	SET @SQL = @SQL + '	AND R.FLDMENUGRP = M.FLDMENUCODE'
	IF @NETMENU = 'Y'
		SET @SQL = @SQL + '	AND LEFT(R.FLDPATH, 1) = ''~'''
	SET @SQL = @SQL + '	AND EXISTS (SELECT FLDREPORTCODE FROM ' + @SHAREDB + '..TBLCATMENU C WHERE CHARINDEX('',' + @UCAT + ','', C.FLDCATEGORYCODE) > 0 AND R.FLDREPORTCODE = C.FLDREPORTCODE) '
	SET @SQL = @SQL + 'ORDER BY R.FLDMENUGRP,G.FLDGRPNAME,R.FLDORDER ,R.FLDREPORTNAME'
	EXEC(@SQL)

CREATE TABLE #MENU
(
	SRNO INT,
	FLDREPORTCODE INT,
	FLDREPORTNAME VARCHAR(35),
	FLDPATH VARCHAR(500),
	FLDTARGET VARCHAR(25),
	FLDGRPNAME VARCHAR(35),
	FLDMENUNAME VARCHAR(20),
	FLDMENUGRP VARCHAR(3),
	MAINGRP VARCHAR(30)
)
INSERT INTO #LINKINFO (REPORTCODE, REPORTPATH) SELECT FLDREPORTCODE, FLDPATH FROM #MASTERMENU
/*------------------OPEN IN CASE OF MULTI SEGMENT MENU------------------------------------
IF @OPENPOS = 'S'
	BEGIN
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('<ul id="qm0" class="qmmc">')
	END

INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	<li><a class="qmparent" href="javascript:void(0);">' + UPPER(@EXCHANGE) + '-' + UPPER(@SEGMENT) + '</a>')
INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		<ul>')
*/
INSERT INTO #MENU (FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP)
SELECT FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP
FROM #MASTERMENU WHERE MAINGRP = 'Share Accounting'

IF @@ROWCOUNT > 0
	BEGIN
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('<ul id="qm0" class="qmmc">')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	<li><a class="qmparent" href="javascript:void(0);">Share Accounting</a>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		<ul>')
	END
EXEC CLASS_MENUSTRING
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('						</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('					</li>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('				</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('			</li>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</li>')
TRUNCATE TABLE #MENU

INSERT INTO #MENU (FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP)
SELECT FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP
FROM #MASTERMENU WHERE MAINGRP = 'Finance Accounting'
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	<li><a class="qmparent" href="javascript:void(0);">Finance Accounting</a>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		<ul>')
EXEC CLASS_MENUSTRING
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('						</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('					</li>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('				</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('			</li>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</li>')
TRUNCATE TABLE #MENU

INSERT INTO #MENU (FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP)
SELECT FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP
FROM #MASTERMENU WHERE MAINGRP = 'Utilities'
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	<li><a class="qmparent" href="javascript:void(0);">Utilities</a>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		<ul>')
EXEC CLASS_MENUSTRING
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('						</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('					</li>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('				</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('			</li>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</li>')
TRUNCATE TABLE #MENU

--INSERT INTO #MENU (FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP)
--SELECT FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP
--FROM #MASTERMENU WHERE MAINGRP = 'Logout'
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	<li><a class="qmparent" href="javascript:ChangePwd();">Change Password</a>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		<ul>')
--EXEC CLASS_MENUSTRING
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('						</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</li>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</ul>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('			</li>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		</ul>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</li>')
--TRUNCATE TABLE #MENU

--INSERT INTO #MENU (FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP)
--SELECT FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP
--FROM #MASTERMENU WHERE MAINGRP = 'Change Password'
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	<li><a class="qmparent" href="javascript:Logout();">Logout</a>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		<ul>')
--EXEC CLASS_MENUSTRING
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('						</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('					</li>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('				</ul>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('			</li>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		</ul>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</li>')
--TRUNCATE TABLE #MENU


/*------------OPEN IN CASE OF MULTISEGMENT MENU-----------------
INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		</ul>')
INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</li>')
IF @OPENPOS = 'E'
	BEGIN*/
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('</ul>')
--	END

--PRINT '						</ul>'
--PRINT '					</li>'
--PRINT '				</ul>'
--PRINT '			</li>'
--PRINT '		</ul>'
--RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_MENUSTRING_MASTER_mar282013
-- --------------------------------------------------
CREATE PROC [dbo].[CLASS_MENUSTRING_MASTER_mar282013]
(
	@SHAREDB VARCHAR(25),
	@UCAT VARCHAR(100),
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(20),
	@OPENPOS VARCHAR(1)
)
AS
/*
	EXEC CLASS_MENUSTRING_MASTER 'MSAJAG', '388', 'NSE', 'CAPITAL', 
*/
SET NOCOUNT ON
CREATE TABLE #MASTERMENU
(
	SRNO INT IDENTITY(1,1),
	FLDREPORTCODE INT,
	FLDREPORTNAME VARCHAR(35),
	FLDPATH VARCHAR(500),
	FLDTARGET VARCHAR(25),
	FLDGRPNAME VARCHAR(35),
	FLDMENUNAME VARCHAR(20),
	FLDMENUGRP VARCHAR(3),
	MAINGRP VARCHAR(30)
)
DECLARE
	@SQL VARCHAR(2000)
	SET @SQL = 'INSERT INTO #MASTERMENU (FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP)'
	SET @SQL = @SQL + 'SELECT'
	SET @SQL = @SQL + '	R.FLDREPORTCODE,'
	SET @SQL = @SQL + '	R.FLDREPORTNAME,'
	SET @SQL = @SQL + '	R.FLDPATH,'
	SET @SQL = @SQL + '	R.FLDTARGET,'
	SET @SQL = @SQL + '	G.FLDGRPNAME,'
	SET @SQL = @SQL + '	M.FLDMENUNAME,'
	SET @SQL = @SQL + '	R.FLDMENUGRP,'
	SET @SQL = @SQL + '	MAINGRP = CASE WHEN G.FLDMENUGRP BETWEEN 0 AND 3 THEN ''Share Accounting'' ELSE CASE WHEN G.FLDMENUGRP BETWEEN 4 AND 6 THEN ''Finance Accounting'' ELSE ''Utilities'' END END '
	SET @SQL = @SQL + 'FROM'
	SET @SQL = @SQL + '	' + @SHAREDB + '.dbo.TBLREPORTS R,'
	SET @SQL = @SQL + '	' + @SHAREDB + '.dbo.TBLREPORTGRP G,'
	SET @SQL = @SQL + '	' + @SHAREDB + '.dbo.TBLMENUHEAD M '
	SET @SQL = @SQL + 'WHERE'
	SET @SQL = @SQL + '	R.FLDREPORTGRP =G.FLDREPORTGRP'
	SET @SQL = @SQL + '	AND R.FLDMENUGRP = M.FLDMENUCODE'
	SET @SQL = @SQL + '	AND EXISTS (SELECT FLDREPORTCODE FROM ' + @SHAREDB + '.dbo.TBLCATMENU C WHERE CHARINDEX('',' + @UCAT + ','', C.FLDCATEGORYCODE) > 0 AND R.FLDREPORTCODE = C.FLDREPORTCODE) '
	SET @SQL = @SQL + 'ORDER BY R.FLDMENUGRP,G.FLDGRPNAME,R.FLDORDER ,R.FLDREPORTNAME'
	EXEC(@SQL)

CREATE TABLE #MENU
(
	SRNO INT,
	FLDREPORTCODE INT,
	FLDREPORTNAME VARCHAR(35),
	FLDPATH VARCHAR(500),
	FLDTARGET VARCHAR(25),
	FLDGRPNAME VARCHAR(35),
	FLDMENUNAME VARCHAR(20),
	FLDMENUGRP VARCHAR(3),
	MAINGRP VARCHAR(30)
)
INSERT INTO #LINKINFO (REPORTCODE, REPORTPATH) SELECT FLDREPORTCODE, FLDPATH FROM #MASTERMENU
/*------------------OPEN IN CASE OF MULTI SEGMENT MENU------------------------------------
IF @OPENPOS = 'S'
	BEGIN
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('<ul id="qm0" class="qmmc">')
	END

INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	<li><a class="qmparent" href="javascript:void(0);">' + UPPER(@EXCHANGE) + '-' + UPPER(@SEGMENT) + '</a>')
INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		<ul>')
*/
INSERT INTO #MENU (FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP)
SELECT FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP
FROM #MASTERMENU WHERE MAINGRP = 'Share Accounting'

IF @@ROWCOUNT > 0
	BEGIN
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('<ul id="qm0" class="qmmc">')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	<li><a class="qmparent" href="javascript:void(0);">Share Accounting</a>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		<ul>')
	END
EXEC CLASS_MENUSTRING
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('						</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('					</li>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('				</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('			</li>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</li>')
TRUNCATE TABLE #MENU

INSERT INTO #MENU (FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP)
SELECT FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP
FROM #MASTERMENU WHERE MAINGRP = 'Finance Accounting'
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	<li><a class="qmparent" href="javascript:void(0);">Finance Accounting</a>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		<ul>')
EXEC CLASS_MENUSTRING
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('						</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('					</li>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('				</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('			</li>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</li>')
TRUNCATE TABLE #MENU

INSERT INTO #MENU (FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP)
SELECT FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP
FROM #MASTERMENU WHERE MAINGRP = 'Utilities'
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	<li><a class="qmparent" href="javascript:void(0);">Utilities</a>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		<ul>')
EXEC CLASS_MENUSTRING
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('						</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('					</li>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('				</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('			</li>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</li>')
TRUNCATE TABLE #MENU

--INSERT INTO #MENU (FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP)
--SELECT FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP
--FROM #MASTERMENU WHERE MAINGRP = 'Logout'
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	<li><a class="qmparent" href="javascript:ChangePwd();">Change Password</a>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		<ul>')
--EXEC CLASS_MENUSTRING
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('						</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</li>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</ul>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('			</li>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		</ul>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</li>')
--TRUNCATE TABLE #MENU

--INSERT INTO #MENU (FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP)
--SELECT FLDREPORTCODE, FLDREPORTNAME, FLDPATH, FLDTARGET, FLDGRPNAME, FLDMENUNAME, FLDMENUGRP, MAINGRP
--FROM #MASTERMENU WHERE MAINGRP = 'Change Password'
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	<li><a class="qmparent" href="javascript:Logout();">Logout</a>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		<ul>')
--EXEC CLASS_MENUSTRING
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('						</ul>')
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('					</li>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('				</ul>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('			</li>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		</ul>')
		--INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</li>')
--TRUNCATE TABLE #MENU


/*------------OPEN IN CASE OF MULTISEGMENT MENU-----------------
INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('		</ul>')
INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('	</li>')
IF @OPENPOS = 'E'
	BEGIN*/
		INSERT INTO #EXCHANGEMENU (MENUSTRING) VALUES ('</ul>')
--	END

--PRINT '						</ul>'
--PRINT '					</li>'
--PRINT '				</ul>'
--PRINT '			</li>'
--PRINT '		</ul>'
--RETURN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_MULTILOGIN
-- --------------------------------------------------


CREATE PROC [dbo].[CLASS_MULTILOGIN]
(
	@USER_NAME VARCHAR(25),
	@PASSWORD VARCHAR(100),
	@REMOTEIP VARCHAR(20),
	@EXCHANGE VARCHAR(5),
	@SEGMENT VARCHAR(20),
	@DIRSEARCH VARCHAR(1) = 'N'
)
AS
/*
	EXEC CLASS_MULTILOGIN 'piyush', 'AC87C1306B704EBE', '10.11.12.56', 'NSE', 'CAPITAL'
	EXEC CLASS_MULTILOGIN 'DEMO', '5A8400101271B15D2F404ED40116FB97', '10.11.12.56', 'NSE', 'CAPITAL'
	EXEC CLASS_MULTILOGIN 'YATIN', '7A357BA1389C10C5', '10.11.12.56', 'NSE', 'CAPITAL'
	EXEC CLASS_MULTILOGIN '0A141', 'E774E83F142DD239', '10.228.50.215', 'NSE', 'CAPITAL'
	SELECT * FROM MSAJAG.dbo.TBLPRADNYAUSERS WHERE FLDUSERNAME = '0A141'
	exec CLASS_MULTILOGIN @USER_NAME='yatin.desai',@PASSWORD='',@REMOTEIP='::1',@EXCHANGE='NSE',@SEGMENT='MFSS',@DIRSEARCH='Y'
*/
SET NOCOUNT ON
CREATE TABLE #MULTILOGIN
	(
		FLDSTATUS VARCHAR(25),
		USERNAME VARCHAR(51),
		FLDSTNAME VARCHAR(50),
		USER_LOGIN VARCHAR(50),
		PWD_EXPIRY INT,
		FLDCATEGORY VARCHAR(10),
		USERAUTOID VARCHAR(25),
		FLDPWDMINLENGTH SMALLINT,
		FLDPWDMAXLENGTH SMALLINT,
		FLDSPCLCHAR CHAR(1),
        FLDPWDALPHANUMONLY INT,
		FLDENCRYPTION CHAR(1),
		FLDBLOCKPWD VARCHAR(255),
		FLDAUTO BIGINT,
		FLDUSERID INT,
		FLDPWDEXPIRY INT,
		FLDMAXATTEMPT SMALLINT,
		FLDATTEMPTCNT SMALLINT,
		MFLDSTATUS SMALLINT,
		FLDLOGINFLAG SMALLINT,
		FLDACCESSLVL CHAR(1),
		FLDIPADD VARCHAR(2000),
		FLDTIMEOUT SMALLINT,
		FLDFIRSTLOGIN CHAR(1),
		FLDFORCELOGOUT SMALLINT,
		SHAREDB VARCHAR(20),
		SHARESERVER VARCHAR(50),
		SHAREIP VARCHAR(50),
		ACCOUNTDB VARCHAR(20),
		ACCOUNTSERVER VARCHAR(50),
		ACCOUNTIP VARCHAR(50),
		LOGINID VARCHAR(25),
		LOGINPASSWORD VARCHAR(25),
		PRADNYASERVER VARCHAR(256),
		EXCHANGE VARCHAR(25),
		SEGMENT VARCHAR(25),
		LOG_REASON VARCHAR(200),
		LOGINIP VARCHAR(25),
		SEGMENTDESC VARCHAR(100),
		AGREE_FLAG TINYINT DEFAULT(0),
		EXCH_FLAG TINYINT DEFAULT(0),
		INCOME_FLAG TINYINT DEFAULT(0)
	)
/*CREATE TABLE #EXCHANGEMENU
(
	SRNO INT IDENTITY(1,1),
	MENUSTRING VARCHAR(500),
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(20)
)
CREATE TABLE #LINKINFO
(
	EXCHANGE VARCHAR(10),
	SEGMENT VARCHAR(20),
	REPORTCODE INT,
	REPORTPATH VARCHAR(200)
)*/
DECLARE
	@CUR CURSOR,
	@EX VARCHAR(5),
	@SG VARCHAR(10),
	@SH VARCHAR(256),
	@UCAT VARCHAR(10),
	@FORLOGIN VARCHAR(1)

SET @CUR = CURSOR FOR
	SELECT DISTINCT EXCHANGE, SEGMENT FROM MULTICOMPANY WHERE PRIMARYSERVER = 1
OPEN @CUR
FETCH NEXT FROM @CUR INTO @EX, @SG
WHILE @@FETCH_STATUS = 0
	BEGIN
		IF @EX = @EXCHANGE AND @SG = @SEGMENT
			BEGIN
				SET @FORLOGIN = 'Y'
			END
		ELSE
			BEGIN
				SET @FORLOGIN = 'N'
			END

		INSERT INTO #MULTILOGIN (FLDSTATUS, USERNAME, FLDSTNAME, USER_LOGIN, PWD_EXPIRY, FLDCATEGORY,USERAUTOID,
								FLDPWDMINLENGTH, FLDPWDMAXLENGTH, FLDSPCLCHAR,FLDPWDALPHANUMONLY, FLDENCRYPTION, FLDBLOCKPWD,
								FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, MFLDSTATUS,
								FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT,
								SHAREDB, SHARESERVER, SHAREIP, ACCOUNTDB, ACCOUNTSERVER, ACCOUNTIP, LOGINID,
								LOGINPASSWORD, PRADNYASERVER, EXCHANGE, SEGMENT, LOG_REASON, LOGINIP, SEGMENTDESC)
		EXEC CLASS_LOGIN_EXCHANGE @USER_NAME, @PASSWORD, @REMOTEIP, @EX, @SG, @FORLOGIN, @DIRSEARCH
		FETCH NEXT FROM @CUR INTO @EX, @SG
	END
DELETE FROM #MULTILOGIN WHERE LOG_REASON = 'NO SUCH USER EXISTS.'
/*DECLARE @ROWPOS SMALLINT, @LROWPOS SMALLINT, @OPENPOS VARCHAR(1)
SET @LROWPOS = 0
SET @OPENPOS = ''
CLOSE @CUR
SET @CUR = CURSOR STATIC READ_ONLY FOR
	SELECT DISTINCT EXCHANGE, SEGMENT, SHAREDB, FLDCATEGORY FROM #MULTILOGIN WHERE LOG_REASON = '' AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT
OPEN @CUR
SET @ROWPOS = @@CURSOR_ROWS
FETCH NEXT FROM @CUR INTO @EX, @SG, @SH, @UCAT
WHILE @@FETCH_STATUS = 0
	BEGIN
		--SET @LROWPOS = @LROWPOS + 1
		--SET @OPENPOS = CASE WHEN @LROWPOS = 1 THEN 'S' ELSE CASE WHEN @LROWPOS = @ROWPOS THEN 'E' ELSE '' END END
		EXEC CLASS_MENUSTRING_MASTER @SH, @UCAT, @EX, @SG, @OPENPOS
		UPDATE #EXCHANGEMENU SET EXCHANGE = @EX, SEGMENT = @SG WHERE EXCHANGE IS NULL AND SEGMENT IS NULL
		UPDATE #LINKINFO SET EXCHANGE = @EX, SEGMENT = @SG WHERE EXCHANGE IS NULL AND SEGMENT IS NULL
		FETCH NEXT FROM @CUR INTO @EX, @SG, @SH, @UCAT
	END
*/
DECLARE @LOGTYPE VARCHAR(1)
SELECT TOP 1 @LOGTYPE = CASE WHEN FLDSTATUS = 'CLIENT' THEN 'C' ELSE '' END FROM #MULTILOGIN

IF @LOGTYPE = 'C'
	BEGIN
		UPDATE #MULTILOGIN
			SET AGREE_FLAG = 1
		FROM Client_Agreement_Data C
		WHERE #MULTILOGIN.USERAUTOID = C.CL_CODE
			AND C.AGREE_FLAG = 1
		
		UPDATE #MULTILOGIN
			SET EXCH_FLAG = 1
		FROM Client_Agreement_Data C
		WHERE #MULTILOGIN.USERAUTOID = C.CL_CODE
			AND C.AGREED_EXCH_SEGMENTS <> ''

		UPDATE #MULTILOGIN
			SET INCOME_FLAG = 1
		FROM Client_Agreement_Data C
		WHERE #MULTILOGIN.USERAUTOID = C.CL_CODE
			AND C.INCOME_SLAB <> ''
	END
ELSE
	BEGIN
		UPDATE #MULTILOGIN SET AGREE_FLAG = 1, EXCH_FLAG = 1, INCOME_FLAG =1
	END

SELECT 
		FLDSTATUS, USERNAME, FLDSTNAME, USER_LOGIN, PWD_EXPIRY, FLDCATEGORY,USERAUTOID,
		FLDPWDMINLENGTH, FLDPWDMAXLENGTH, FLDSPCLCHAR,FLDPWDALPHANUMONLY, FLDENCRYPTION, FLDBLOCKPWD,
		FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, MFLDSTATUS,
		FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT,
		SHAREDB, SHARESERVER, SHAREIP, ACCOUNTDB, ACCOUNTSERVER, ACCOUNTIP, LOGINID,
		LOGINPASSWORD, PRADNYASERVER, EXCHANGE, SEGMENT, LOG_REASON, LOGINIP,
		EXCHANGE + '-' + SEGMENT AS EXCH_SEG, SEGMENTDESC, DPSWITCH = CASE WHEN ISNULL(PASSPORT_LOGIN_MAP.CLASS_LOGIN, '') = '' THEN 'N' ELSE 'Y' END,
		AGREE_FLAG, EXCH_FLAG, INCOME_FLAG
FROM #MULTILOGIN LEFT JOIN PASSPORT_LOGIN_MAP ON #MULTILOGIN.USERAUTOID = PASSPORT_LOGIN_MAP.CLASS_LOGIN
AND PASSPORT_LOGIN_MAP.APP_CODE = 'CD'
--SELECT * FROM PASSPORT_LOGIN_MAP
--SELECT * FROM #EXCHANGEMENU
--SELECT * FROM #LINKINFO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_MULTILOGIN_Mar282013
-- --------------------------------------------------
  
CREATE PROC [dbo].[CLASS_MULTILOGIN_Mar282013]  
(  
 @USER_NAME VARCHAR(25),  
 @PASSWORD VARCHAR(100),  
 @REMOTEIP VARCHAR(20),  
 @EXCHANGE VARCHAR(5),  
 @SEGMENT VARCHAR(20)  
)  
AS  
/*  
 EXEC CLASS_MULTILOGIN 'piyush', 'AC87C1306B704EBE', '10.11.12.56', 'NSE', 'CAPITAL'  
 EXEC CLASS_MULTILOGIN 'DEMO', '5A8400101271B15D2F404ED40116FB97', '10.11.12.56', 'NSE', 'CAPITAL'  
 EXEC CLASS_MULTILOGIN 'YATIN', '7A357BA1389C10C5', '10.11.12.56', 'NSE', 'CAPITAL'  
 EXEC CLASS_MULTILOGIN '0A141', 'E774E83F142DD239', '10.228.50.215', 'NSE', 'CAPITAL'  
 SELECT * FROM MSAJAG.dbo.TBLPRADNYAUSERS WHERE FLDUSERNAME = '0A141'  
  
*/  
SET NOCOUNT ON  
CREATE TABLE #MULTILOGIN  
 (  
  FLDSTATUS VARCHAR(25),  
  USERNAME VARCHAR(51),  
  FLDSTNAME VARCHAR(50),  
  USER_LOGIN VARCHAR(50),  
  PWD_EXPIRY INT,  
  FLDCATEGORY VARCHAR(10),  
  USERAUTOID VARCHAR(25),  
  FLDPWDMINLENGTH SMALLINT,  
  FLDPWDMAXLENGTH SMALLINT,  
  FLDSPCLCHAR CHAR(1),  
        FLDPWDALPHANUMONLY INT,  
  FLDENCRYPTION CHAR(1),  
  FLDBLOCKPWD VARCHAR(255),  
  FLDAUTO BIGINT,  
  FLDUSERID INT,  
  FLDPWDEXPIRY INT,  
  FLDMAXATTEMPT SMALLINT,  
  FLDATTEMPTCNT SMALLINT,  
  MFLDSTATUS SMALLINT,  
  FLDLOGINFLAG SMALLINT,  
  FLDACCESSLVL CHAR(1),  
  FLDIPADD VARCHAR(2000),  
  FLDTIMEOUT SMALLINT,  
  FLDFIRSTLOGIN CHAR(1),  
  FLDFORCELOGOUT SMALLINT,  
  SHAREDB VARCHAR(20),  
  SHARESERVER VARCHAR(50),  
  SHAREIP VARCHAR(50),  
  ACCOUNTDB VARCHAR(20),  
  ACCOUNTSERVER VARCHAR(50),  
  ACCOUNTIP VARCHAR(50),  
  LOGINID VARCHAR(25),  
  LOGINPASSWORD VARCHAR(25),  
  PRADNYASERVER VARCHAR(256),  
  EXCHANGE VARCHAR(25),  
  SEGMENT VARCHAR(25),  
  LOG_REASON VARCHAR(200),  
  LOGINIP VARCHAR(25),  
  SEGMENTDESC VARCHAR(100),  
  AGREE_FLAG TINYINT DEFAULT(0),  
  EXCH_FLAG TINYINT DEFAULT(0),  
  INCOME_FLAG TINYINT DEFAULT(0)  
 )  
/*CREATE TABLE #EXCHANGEMENU  
(  
 SRNO INT IDENTITY(1,1),  
 MENUSTRING VARCHAR(500),  
 EXCHANGE VARCHAR(10),  
 SEGMENT VARCHAR(20)  
)  
CREATE TABLE #LINKINFO  
(  
 EXCHANGE VARCHAR(10),  
 SEGMENT VARCHAR(20),  
 REPORTCODE INT,  
 REPORTPATH VARCHAR(200)  
)*/  
DECLARE  
 @CUR CURSOR,  
 @EX VARCHAR(5),  
 @SG VARCHAR(10),  
 @SH VARCHAR(256),  
 @UCAT VARCHAR(10),  
 @FORLOGIN VARCHAR(1)  
  
SET @CUR = CURSOR FOR  
 SELECT DISTINCT EXCHANGE, SEGMENT FROM MULTICOMPANY WHERE PRIMARYSERVER = 1  
OPEN @CUR  
FETCH NEXT FROM @CUR INTO @EX, @SG  
WHILE @@FETCH_STATUS = 0  
 BEGIN  
  IF @EX = @EXCHANGE AND @SG = @SEGMENT  
   BEGIN  
    SET @FORLOGIN = 'Y'  
   END  
  ELSE  
   BEGIN  
    SET @FORLOGIN = 'N'  
   END  
  
  INSERT INTO #MULTILOGIN (FLDSTATUS, USERNAME, FLDSTNAME, USER_LOGIN, PWD_EXPIRY, FLDCATEGORY,USERAUTOID,  
        FLDPWDMINLENGTH, FLDPWDMAXLENGTH, FLDSPCLCHAR,FLDPWDALPHANUMONLY, FLDENCRYPTION, FLDBLOCKPWD,  
        FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, MFLDSTATUS,  
        FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT,  
        SHAREDB, SHARESERVER, SHAREIP, ACCOUNTDB, ACCOUNTSERVER, ACCOUNTIP, LOGINID,  
        LOGINPASSWORD, PRADNYASERVER, EXCHANGE, SEGMENT, LOG_REASON, LOGINIP, SEGMENTDESC)  
  EXEC CLASS_LOGIN_EXCHANGE @USER_NAME, @PASSWORD, @REMOTEIP, @EX, @SG, @FORLOGIN  
  FETCH NEXT FROM @CUR INTO @EX, @SG  
 END  
DELETE FROM #MULTILOGIN WHERE LOG_REASON = 'NO SUCH USER EXISTS.'  
/*DECLARE @ROWPOS SMALLINT, @LROWPOS SMALLINT, @OPENPOS VARCHAR(1)  
SET @LROWPOS = 0  
SET @OPENPOS = ''  
CLOSE @CUR  
SET @CUR = CURSOR STATIC READ_ONLY FOR  
 SELECT DISTINCT EXCHANGE, SEGMENT, SHAREDB, FLDCATEGORY FROM #MULTILOGIN WHERE LOG_REASON = '' AND EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT  
OPEN @CUR  
SET @ROWPOS = @@CURSOR_ROWS  
FETCH NEXT FROM @CUR INTO @EX, @SG, @SH, @UCAT  
WHILE @@FETCH_STATUS = 0  
 BEGIN  
  --SET @LROWPOS = @LROWPOS + 1  
  --SET @OPENPOS = CASE WHEN @LROWPOS = 1 THEN 'S' ELSE CASE WHEN @LROWPOS = @ROWPOS THEN 'E' ELSE '' END END  
  EXEC CLASS_MENUSTRING_MASTER @SH, @UCAT, @EX, @SG, @OPENPOS  
  UPDATE #EXCHANGEMENU SET EXCHANGE = @EX, SEGMENT = @SG WHERE EXCHANGE IS NULL AND SEGMENT IS NULL  
  UPDATE #LINKINFO SET EXCHANGE = @EX, SEGMENT = @SG WHERE EXCHANGE IS NULL AND SEGMENT IS NULL  
  FETCH NEXT FROM @CUR INTO @EX, @SG, @SH, @UCAT  
 END  
*/  
DECLARE @LOGTYPE VARCHAR(1)  
SELECT TOP 1 @LOGTYPE = CASE WHEN FLDSTATUS = 'CLIENT' THEN 'C' ELSE '' END FROM #MULTILOGIN  
  
IF @LOGTYPE = 'C'  
 BEGIN  
  UPDATE #MULTILOGIN  
   SET AGREE_FLAG = 1  
  FROM Client_Agreement_Data C  
  WHERE #MULTILOGIN.USERAUTOID = C.CL_CODE  
   AND C.AGREE_FLAG = 1  
    
  UPDATE #MULTILOGIN  
   SET EXCH_FLAG = 1  
  FROM Client_Agreement_Data C  
  WHERE #MULTILOGIN.USERAUTOID = C.CL_CODE  
   AND C.AGREED_EXCH_SEGMENTS <> ''  
  
  UPDATE #MULTILOGIN  
   SET INCOME_FLAG = 1  
  FROM Client_Agreement_Data C  
  WHERE #MULTILOGIN.USERAUTOID = C.CL_CODE  
   AND C.INCOME_SLAB <> ''  
 END  
ELSE  
 BEGIN  
  UPDATE #MULTILOGIN SET AGREE_FLAG = 1, EXCH_FLAG = 1, INCOME_FLAG =1  
 END  
  
SELECT   
  FLDSTATUS, USERNAME, FLDSTNAME, USER_LOGIN, PWD_EXPIRY, FLDCATEGORY,USERAUTOID,  
  FLDPWDMINLENGTH, FLDPWDMAXLENGTH, FLDSPCLCHAR,FLDPWDALPHANUMONLY, FLDENCRYPTION, FLDBLOCKPWD,  
  FLDAUTO, FLDUSERID, FLDPWDEXPIRY, FLDMAXATTEMPT, FLDATTEMPTCNT, MFLDSTATUS,  
  FLDLOGINFLAG, FLDACCESSLVL, FLDIPADD, FLDTIMEOUT, FLDFIRSTLOGIN, FLDFORCELOGOUT,  
  SHAREDB, SHARESERVER, SHAREIP, ACCOUNTDB, ACCOUNTSERVER, ACCOUNTIP, LOGINID,  
  LOGINPASSWORD, PRADNYASERVER, EXCHANGE, SEGMENT, LOG_REASON, LOGINIP,  
  EXCHANGE + '-' + SEGMENT AS EXCH_SEG, SEGMENTDESC, DPSWITCH = CASE WHEN ISNULL(PASSPORT_LOGIN_MAP.CLASS_LOGIN, '') = '' THEN 'N' ELSE 'Y' END,  
  AGREE_FLAG, EXCH_FLAG, INCOME_FLAG  
FROM #MULTILOGIN LEFT JOIN PASSPORT_LOGIN_MAP ON #MULTILOGIN.USERAUTOID = PASSPORT_LOGIN_MAP.CLASS_LOGIN  
AND PASSPORT_LOGIN_MAP.APP_CODE = 'CD'  
--SELECT * FROM PASSPORT_LOGIN_MAP  
--SELECT * FROM #EXCHANGEMENU  
--SELECT * FROM #LINKINFO

GO

-- --------------------------------------------------
-- PROCEDURE dbo.CLASS_USER_RESETPWD
-- --------------------------------------------------
CREATE  PROCEDURE [dbo].[CLASS_USER_RESETPWD]
(
	@USERID VARCHAR(25),
	@EMAILID VARCHAR(100),
	@EXCHANGE VARCHAR(3),
	@SEGMENT VARCHAR(7),
	@NEWPWD VARCHAR(20),
	@NMODE CHAR(1)
)
AS

/*
PROC FOR 
	1. VALIDATING USER PRIOR TO RESET PASSWORD
	2. UPDATING USER PASSWORD
	
	@NMODE = 
			1 - USER VALIDATION 
			2 - UPDATE NEW PASSWORD
			3 - EMAIL SUCCESSFULL LOG
			4 - EMAIL UNSUCCESSFULL LOG
*/

DECLARE @SHARESERVER VARCHAR(50)
DECLARE @SHAREDB VARCHAR(20)
DECLARE @STRSQL VARCHAR(2000)
DECLARE @INTSTATUS INT
DECLARE @STRSTATUS VARCHAR(100)

SET NOCOUNT ON
SET @INTSTATUS = 0
SET @STRSTATUS = ''

SELECT @SHARESERVER = SHARESERVER, @SHAREDB= SHAREDB FROM MULTICOMPANY (NOLOCK)
WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND PRIMARYSERVER = 1

IF @NMODE = '1'
BEGIN

	SET @STRSQL = 'SELECT FLDSTATUS FROM ' + @SHARESERVER + '.' + @SHAREDB + '.DBO.TBLPRADNYAUSERS ,' 
	SET @STRSQL = @STRSQL + @SHARESERVER + '.' + @SHAREDB + '.DBO.TBLADMIN '
	SET @STRSQL = @STRSQL +' WHERE TBLPRADNYAUSERS.FLDADMINAUTO=TBLADMIN.FLDAUTO_ADMIN AND FLDUSERNAME = ''' +  @USERID +''''

	CREATE TABLE #OUTPUT
	(REC_VALUE VARCHAR(25))

	INSERT INTO #OUTPUT EXEC(@STRSQL)

	IF (SELECT COUNT(1) FROM #OUTPUT) = 0
	BEGIN
		SET @INTSTATUS = 0
		SET @STRSTATUS = 'USER DETAILS NOT FOUND' 
	END
	ELSE
	BEGIN
		IF (SELECT UPPER(REC_VALUE) FROM #OUTPUT) = 'CLIENT'
		BEGIN
			SET @STRSQL = 'SELECT FLDUSERNAME FROM ' + @SHARESERVER + '.' + @SHAREDB + '.DBO.TBLPRADNYAUSERS ,' 
			SET @STRSQL = @STRSQL + @SHARESERVER + '.' + @SHAREDB + '.DBO.CLIENT1 '
			SET @STRSQL = @STRSQL + ' WHERE TBLPRADNYAUSERS.FLDSTANME=CLIENT1.CL_CODE AND FLDUSERNAME = ''' +  @USERID +''''
			SET @STRSQL = @STRSQL + ' AND CLIENT1.EMAIL = ''' + @EMAILID + ''''

			TRUNCATE TABLE #OUTPUT
			INSERT INTO #OUTPUT EXEC(@STRSQL)

			IF (SELECT COUNT(1) FROM #OUTPUT) = 0
			BEGIN
				SET @INTSTATUS = 0
				SET @STRSTATUS = 'INVALID EMAIL ID' 
			END
			ELSE
			BEGIN
				SET @INTSTATUS = 1
				SET @STRSTATUS = 'SUCCESS' 
			END
		END
		ELSE
		BEGIN
			SET @STRSQL = 'SELECT FLDUSERNAME FROM ' + @SHARESERVER + '.' + @SHAREDB + '.DBO.TBLPRADNYAUSERS' 
			SET @STRSQL = @STRSQL + ' WHERE FLDUSERNAME = ''' +  @USERID +''''
			SET @STRSQL = @STRSQL + ' AND (FLDADDRESS1 = ''' + @EMAILID + ''' OR FLDADDRESS2 = ''' + @EMAILID + ''')'

			TRUNCATE TABLE #OUTPUT
			INSERT INTO #OUTPUT EXEC(@STRSQL)

			IF (SELECT COUNT(1) FROM #OUTPUT) = 0
			BEGIN
				SET @INTSTATUS = 0
				SET @STRSTATUS = 'INVALID EMAIL ID' 
			END
			ELSE
			BEGIN
				SET @INTSTATUS = 1
				SET @STRSTATUS = 'SUCCESS' 
			END
		END
	END

	SELECT VALIDSTATUS = CONVERT(VARCHAR,@INTSTATUS) + '|' +  @STRSTATUS

END

IF @NMODE = '2'
BEGIN

	SET @STRSQL = 'UPDATE ' + @SHARESERVER + '.' + @SHAREDB + '.DBO.TBLPRADNYAUSERS'
	SET @STRSQL = @STRSQL + ' SET FLDPASSWORD =''' + @NEWPWD + ''''
	SET @STRSQL = @STRSQL + ' WHERE FLDUSERNAME = ''' +  @USERID +''''
	EXEC(@STRSQL)

	SET @STRSQL = 'UPDATE A SET  FLDFIRSTLOGIN = ''Y'', FLDFORCELOGOUT = 0,FLDSTATUS=0 '
	SET @STRSQL = @STRSQL + ' FROM ' + @SHARESERVER + '.' + @SHAREDB + '.DBO.TBLUSERCONTROLMASTER A,'
	SET @STRSQL = @STRSQL + @SHARESERVER + '.' + @SHAREDB + '.DBO.TBLPRADNYAUSERS B'
	SET @STRSQL = @STRSQL + ' WHERE A.FLDUSERID = B.FLDAUTO AND B.FLDUSERNAME = ''' +  @USERID +''''
	EXEC(@STRSQL)
	
	SET @INTSTATUS = 1
	SET @STRSTATUS = 'PASSWORD CHANGED SUCCESSFULLY.' 	
	
	SELECT VALIDSTATUS = CONVERT(VARCHAR,@INTSTATUS) + '|' +  @STRSTATUS
			
END

IF @NMODE = '3' OR @NMODE = '4'
BEGIN
	SET @STRSQL = 'INSERT INTO ' + @SHARESERVER + '.' + @SHAREDB + '.DBO.LOG_PWDMAILS'
	SET @STRSQL = @STRSQL + ' SELECT FLDAUTO,FLDSTNAME,FLDUSERNAME,'''','''','''+ @EMAILID +''','''','''','
	IF @NMODE = '3'
	BEGIN
		SET @STRSQL = @STRSQL + ''''',GETDATE(),1'
	END
	ELSE
	BEGIN
		SET @STRSQL = @STRSQL + '''EMAIL SERVER ERR'',GETDATE(),0'
	END
	SET @STRSQL = @STRSQL + ' FROM ' + @SHARESERVER + '.' + @SHAREDB + '.DBO.TBLPRADNYAUSERS'
	SET @STRSQL = @STRSQL + ' WHERE FLDUSERNAME = ''' +  @USERID +''''
	EXEC (@STRSQL)	
END
/*----------------------------------  END OF PROC ------------------------------*/

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClassApp_PayoutToClientSum
-- --------------------------------------------------

--exec ClassApp_PayoutToClientSum '2009301','U','0','z','broker','broker','NSEMFSS'
--Created By Piyush

CREATE PROCEDURE [dbo].[ClassApp_PayoutToClientSum]
(
	 @SETT_NO VARCHAR(7), 
	 @SETT_TYPE VARCHAR(2),
	 @FROMPARTY VARCHAR(10),
	 @TOPARTY VARCHAR(10),
	 @STATUSID VARCHAR(25),
	 @STATUSNAME VARCHAR(25),
     @SHAREDB VARCHAR(20)
   --  @SourceDB VARCHAR(20) ='classapp' 
    
)
AS
BEGIN
DECLARE @SQL VARCHAR(MAX),
        @SQL1 VARCHAR(MAX),
        @SQL2 VARCHAR(MAX),
        @SQL3 VARCHAR(MAX)

CREATE TABLE #PayoutToClientSum
(
	BRANCH_CODE VARCHAR(20),
	SCRIP_CD VARCHAR(50),
	SERIES VARCHAR(10),
	SCHEME_NAME VARCHAR(250),
	PARTY_CODE VARCHAR(15),
	LONG_NAME VARCHAR(100),
	TRTYPE NUMERIC(18,0),
	CLTDPID VARCHAR(16),
	DPID VARCHAR(16),
	CERTNO VARCHAR(16),
	QTY NUMERIC(18,3),
	DELIVERED CHAR(1),
	BDPTYPE VARCHAR(10),
	BDPID VARCHAR(16),
	BCLTDPID VARCHAR(16),
	AMOUNT NUMERIC(18,4),
	ISETT_NO  VARCHAR(7),
	ISETT_TYPE VARCHAR(3),
	DESCRIPTION VARCHAR(150),
	REASON VARCHAR(150),
	TRANSDATE VARCHAR(11),
	Remarks VARCHAR(150),
	STATUS VARCHAR(100),
    PAYIN VARCHAR(11),
	PAYOUT VARCHAR(11)
)

SET @SQL = "INSERT INTO #PAYOUTTOCLIENTSUM(BRANCH_CODE,SCRIP_CD,SERIES,SCHEME_NAME,PARTY_CODE,"
SET @SQL = @SQL + " LONG_NAME,TRTYPE,CLTDPID,DPID,CERTNO,QTY,DELIVERED,BDPTYPE,BDPID,BCLTDPID,AMOUNT,ISETT_NO,"
SET @SQL = @SQL + " ISETT_TYPE,DESCRIPTION,REASON,TRANSDATE,Remarks,STATUS)"
SET	@SQL = @SQL + " SELECT LTRIM(RTRIM(BRANCH_CD)) AS BRANCH_CODE, D.SCRIP_CD,D.SERIES,"
if @SHAREDB = 'NSEMFSS'
SET	@SQL = @SQL + " SCHEME_NAME = SEC_NAME"
if @SHAREDB = 'BSEMFSS'
SET	@SQL = @SQL + " SCHEME_NAME = SCHEME_NAME" 
SET	@SQL = @SQL + " , D.PARTY_CODE,C1.LONG_NAME,TRTYPE,"
SET	@SQL = @SQL + " CLTDPID = (CASE WHEN LEN(CLTDPID) <= 8 THEN D.DPID + CLTDPID ELSE CLTDPID END),D.DPID,CERTNO,QTY=SUM(QTY),"
SET	@SQL = @SQL + " DELIVERED,BDPTYPE,BDPID,BCLTDPID = (CASE WHEN LEN(BCLTDPID) <= 8 THEN BDPID + BCLTDPID ELSE BCLTDPID END),"
SET	@SQL = @SQL + " AMOUNT = 0,ISETT_NO,ISETT_TYPE,DESCRIPTION,"
SET @SQL = @SQL + " REASON=(CASE WHEN REASON LIKE 'EXCESS RECEIVED%' THEN '1'"
SET @SQL = @SQL + " WHEN REASON LIKE 'AUCTION PAYOUT%' THEN REASON ELSE '0' END),"
SET @SQL = @SQL + " TRANSDATE=LEFT(CONVERT(VARCHAR,TRANSDATE,109),11),Remarks = (case when TRType ='907' then '-' else 'Debit Balance' end),"
SET @SQL = @SQL + " STATUS = (CASE WHEN DELIVERED= 'D' THEN 'Del' WHEN DELIVERED= 'G' THEN 'Gen' ELSE 'Pen' END)"
SET @SQL = @SQL + " FROM " + @SHAREDB + ".DBO.DELTRANS D," + @SHAREDB + ".DBO.CLIENT1 C1," + @SHAREDB + ".DBO.CLIENT2 C2," 
SET @SQL = @SQL + " " + @SHAREDB + ".DBO.DELIVERYDP DP," + @SHAREDB +".DBO.MFSS_SCRIP_MASTER M"
SET @SQL = @SQL + " WHERE SETT_NO = '" + @SETT_NO + "' AND SETT_TYPE = '" + @SETT_TYPE + "'"
SET @SQL = @SQL + " AND DRCR = 'D' AND TRTYPE <> 906 AND D.PARTY_CODE = C2.PARTY_CODE "
SET @SQL = @SQL + " AND C1.CL_CODE = C2.CL_CODE AND FILLER2= 1  AND D.PARTY_CODE >= '" + @FROMPARTY + "'"
SET @SQL = @SQL + " AND D.PARTY_CODE <= '" + @TOPARTY + "' AND DP.DPTYPE = D.BDPTYPE"
SET @SQL = @SQL + "	AND DP.DPCLTNO = D.BCLTDPID AND DP.DPID = D.BDPID"  
SET @SQL = @SQL + " AND BRANCH_CD LIKE (CASE WHEN LEN('') > 0 THEN '' ELSE '%' END)"
SET @SQL = @SQL + " AND REGION LIKE (CASE WHEN '" + @STATUSID + "' = 'REGION' THEN '" + @STATUSNAME + "' ELSE '%' END)"
SET @SQL = @SQL + " AND BRANCH_CD LIKE (CASE WHEN '" + @STATUSID + "' = 'BRANCH' THEN '" + @STATUSNAME + "' ELSE '%' END)" 
SET @SQL = @SQL + " AND SUB_BROKER LIKE (CASE WHEN '" + @STATUSID + "' = 'SUBBROKER' THEN '" + @STATUSNAME + "'  ELSE '%' END)"
SET @SQL = @SQL + " AND TRADER LIKE (CASE WHEN '" + @STATUSID + "' = 'TRADER' THEN '" + @STATUSNAME + "'  ELSE '%' END)" 
SET @SQL = @SQL + " AND FAMILY LIKE (CASE WHEN '" + @STATUSID + "' = 'FAMILY' THEN '" + @STATUSNAME + "'  ELSE '%' END)"
SET @SQL = @SQL + " AND D.PARTY_CODE LIKE (CASE WHEN '" + @STATUSID + "' = 'CLIENT' THEN '" + @STATUSNAME + "'  ELSE '%' END)"
SET @SQL = @SQL + "	AND D.SCRIP_CD = M.SCRIP_CD  GROUP BY BRANCH_CD, D.SCRIP_CD,D.SERIES,"
if @SHAREDB = 'NSEMFSS'
SET	@SQL = @SQL + " SEC_NAME"
if @SHAREDB = 'BSEMFSS'
SET	@SQL = @SQL + " SCHEME_NAME" 
SET @SQL = @SQL + " , D.PARTY_CODE,C1.LONG_NAME,TRTYPE,CLTDPID,D.DPID,  CERTNO, DELIVERED, BDPTYPE,BDPID,BCLTDPID,ISETT_NO,ISETT_TYPE,DESCRIPTION,"
SET @SQL = @SQL + "	(CASE WHEN REASON LIKE 'EXCESS RECEIVED%' THEN '1' WHEN REASON LIKE 'AUCTION PAYOUT%' "
SET @SQL = @SQL + " THEN REASON ELSE '0' END),LEFT(CONVERT(VARCHAR,TRANSDATE,109),11) ORDER BY D.PARTY_CODE,D.SCRIP_CD"
print @SQL
EXEC(@SQL) 

SET @SQL1 = "UPDATE #PAYOUTTOCLIENTSUM SET PAYIN = (SELECT LEFT(CONVERT(VARCHAR,SEC_PAYIN,109),11)" 
SET @SQL1 = @SQL1 + " FROM " + @SHAREDB + ".DBO.SETT_MST WHERE  SETT_NO = '" + @SETT_NO + "' AND SETT_TYPE = '" + @SETT_TYPE + "')"
EXEC(@SQL1)

SET @SQL2 = "UPDATE #PAYOUTTOCLIENTSUM SET PAYOUT = (SELECT LEFT(CONVERT(VARCHAR,SEC_PAYOUT,109),11)" 
SET @SQL2 = @SQL2+ " FROM " + @SHAREDB + ".DBO.SETT_MST WHERE  SETT_NO = '" + @SETT_NO + "' AND SETT_TYPE = '" + @SETT_TYPE + "')"
EXEC(@SQL2)

SET @SQL3 = "SELECT BRANCH_CODE,SCRIP_CD,SERIES,SCHEME_NAME,PARTY_CODE,LONG_NAME,TRTYPE,CLTDPID,DPID,CERTNO,"
SET @SQL3 = @SQL3 + " QTY,DELIVERED,BDPTYPE,BDPID,BCLTDPID,AMOUNT,ISETT_NO,ISETT_TYPE,	DESCRIPTION,REASON,TRANSDATE,"
SET @SQL3 = @SQL3 + " Remarks,STATUS,PAYIN,PAYOUT,DISPLAYTEXT = (CASE WHEN TRType ='907' THEN 'INT SETT To' + ISETT_NO +  '-' +" 
SET @SQL3 = @SQL3 + " ISETT_TYPE WHEN TRType ='908' THEN 'POA INT SETT To' + ISETT_NO +  '-' + ISETT_TYPE"
SET @SQL3 = @SQL3 + " WHEN TRType ='1000' THEN 'INT Ben To' + ISETT_NO +  '-' + ISETT_TYPE WHEN DESCRIPTION NOT LIKE '%POOL%'" 
SET @SQL3 = @SQL3 + " THEN 'Held For Debit' WHEN REASON = '1' THEN 'Excess Received Transfer' WHEN REASON LIKE '%Auction Pay%' THEN REASON ELSE 'PAY-OUT' END),"
SET @SQL3 = @SQL3 + " BANKNAME = (SELECT BANKNAME FROM " + @SHAREDB + ".DBO.BANK WHERE BANKID = DPID)"
SET @SQL3 = @SQL3 + " FROM #PAYOUTTOCLIENTSUM ORDER BY PARTY_CODE, SCHEME_NAME"
EXEC(@SQL3)

DROP TABLE #PAYOUTTOCLIENTSUM

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.ClassApp_RptDirectPayin
-- --------------------------------------------------
--EXEC ClassApp_RptDirectPayin '2006030','n'  
CREATE PROCEDURE [dbo].[ClassApp_RptDirectPayin]  
(  
 @SETT_NO VARCHAR(7),  
 @SETT_TYPE VARCHAR(3)  
)  
AS  
BEGIN  
 SELECT   
	D.PARTY_CODE,
	PARTYNAME=LONG_NAME,
	D.SCRIP_CD,
	SCRIPNAME=S2.SCRIP_CD,
	D.ISIN,
	QTY=SELLQTY,
	DPID,
	CLTDPID,
	TRANSNO,
	SERIAL = '0000'   
 FROM   
	MSAJAG.DBO.DELBSEDIRECTPI D, 
	MSAJAG.DBO.CLIENT2 C2 , 
	MSAJAG.DBO.CLIENT1 C1, 
	MSAJAG.DBO.SCRIP2 S2   
 WHERE   
	SETT_NO LIKE @SETT_NO 
	AND SETT_TYPE LIKE @SETT_TYPE   
	AND C2.CL_CODE = C1.CL_CODE 
	AND C2.PARTY_CODE = D.PARTY_CODE   
	AND S2.SCRIP_CD = D.SCRIP_CD 
	AND S2.SERIES = D.SERIES   
 ORDER BY   
	LONG_NAME,
	S2.SCRIP_CD   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.DBA_TABLE_ACTIVITY
-- --------------------------------------------------
CREATE PROCEDURE DBA_TABLE_ACTIVITY
AS
BEGIN

	WITH LastActivity (ObjectID, LastAction) 
	AS 
	( 
	SELECT object_id AS TableName, Last_User_Seek as LastAction
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_scan as LastAction 
	FROM sys.dm_db_index_usage_stats u 
	WHERE database_id = db_id(db_name()) 
	UNION 
	SELECT object_id AS TableName,last_user_lookup as LastAction 
	FROM sys.dm_db_index_usage_stats u  
	WHERE database_id = db_id(db_name()) 
	) 

	SELECT OBJECT_NAME(so.object_id)AS TableName, so.Create_Date "Creation Date",so.Modify_date "Last Modified",
	MAX(la.LastAction)as "Last Accessed" 
	FROM 
	sys.objects so 
	LEFT JOIN LastActivity la 
	ON so.object_id = la.ObjectID 
	WHERE so.type = 'U' 
	AND so.object_id > 100   --returns only the user tables.Tables with objectid < 100 are systables. 
	GROUP BY OBJECT_NAME(so.object_id),so.Create_Date,so.Modify_date
	ORDER BY OBJECT_NAME(so.object_id)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.EXECUTEF2
-- --------------------------------------------------
CREATE PROC [dbo].[EXECUTEF2]
(
	@F2CODE VARCHAR(10),
	@F2PARAMS VARCHAR(500),
	@F2WHFLDS VARCHAR(1000) = '',
	@F2WHVALS VARCHAR(1000) = '',
	@F2WHOPR VARCHAR(100) = '',
	@USEXML BIT = 1,
	@EXCHANGE VARCHAR(10),
	@SEGMENT VARCHAR(10),
	@WINDOWTITLE VARCHAR(100) = '' OUTPUT,
	@TABLEHEADER VARCHAR(200) = '' OUTPUT,
	@STATUSID VARCHAR(25) = 'BROKER',
	@STATUSNAME VARCHAR(25) = 'BROKER'
)
AS
/*
	SELECT @@SERVERNAME = 'MTSRVR06\DEL'
	EXEC EXECUTEF2 'F000000002', 'APR  1 2009|MAR 31 2010|APR  1 2009|MAR 31 2010|0|ZZZZ|BROKER|BROKER||VDT|VDT|CODE||||||', '', '', '', 0, 'NSE', 'CAPITAL', '', '', 'BROKER', 'BROKER'
	account.dbo.Acc_Reports @sdate='APR  1 2009',@edate='MAR 31 2010',@fdate='APR  1 2009',@tdate='MAR 31 2010',@fcode='0',@tcode='ZZZZ',@statusId='BROKER',@statusname='BROKER',@branch='',@selectionby='VDT',@GroupBy='VDT',@Sortby='CODE',@reportname='PartyLedger',@reportopt='',@fld1='',@fld2='',@fld3=''
	exec EXECUTEF2 @F2CODE='FP00000038',@F2PARAMS='||MS',@F2WHFLDS='',@F2WHVALS='',@F2WHOPR='',@USEXML=0
	EXEC EXECUTEF2 'FP00000016', '', '', '', '', 0
	SELECT NAME FROM WMS_ACCOUNTS.dbo.SYSCOLUMNS WHERE ID = (SELECT ID FROM WMS_ACCOUNTS.dbo.SYSOBJECTS WHERE NAME = 'TESTBTYPELIST' AND XTYPE = 'P')
	EXEC USPWMS_EXECUTEF2 'FP00000002', 'P|ZZZZZZ||'
*/
SET NOCOUNT ON
DECLARE
	@OBJID INT,
	@OBJNAME VARCHAR(256),
	@OBJTYPE VARCHAR(1),
	@DATABASENAME VARCHAR(256),
	@PARAMFIELDS VARCHAR(500),
	@OBJECTOUT VARCHAR(500),
	@PARAMCUR CURSOR,
	@PARAMPOS TINYINT,
	@PARAMNAME VARCHAR(30),
	@PARAMVAL VARCHAR(500),
	@PARAMOPR VARCHAR(5),
	@PARAMOPRLIST VARCHAR(100),
	@ORDERLIST VARCHAR(100),
	@CONNECTIONDB VARCHAR(1),
	@SQL NVARCHAR(MAX),
	@DBNAME VARCHAR(256),
	@MULTISERVER VARCHAR(256)
	SET @DBNAME = ''
	SET @MULTISERVER = ''
BEGIN TRY
	SELECT
		@OBJNAME = F2OBJECT,
		@OBJTYPE = F2OBJECTTYPE,
		@OBJECTOUT = ISNULL(F2OUTPUT, ''),
		@PARAMFIELDS = ISNULL(F2PARAMFIELDS, ''),
		@PARAMOPRLIST = ISNULL(F2OPRLIST, ''),
		@ORDERLIST = ISNULL(F2ORDERLIST, ''),
		@DATABASENAME = ISNULL(DATABASENAME, ''),
		@WINDOWTITLE = ISNULL(WINDOWTITLE, 'HELP LIST'),
		@TABLEHEADER = ISNULL(TABLEHEADER, ''),
		@CONNECTIONDB = ISNULL(CONNECTIONDB, 'A')
	FROM
		F2CONFIG
	WHERE
		F2CODE = @F2CODE
	IF @CONNECTIONDB = ''
		BEGIN
			SET @CONNECTIONDB = 'A'
		END
	IF @OBJNAME = '' OR @OBJNAME IS NULL
		BEGIN
			RAISERROR('F2 Reference Code not found...', 16, 1)
		END


			IF @CONNECTIONDB = 'A' OR @CONNECTIONDB = 'S'
				BEGIN
					SELECT
						@DBNAME = CASE WHEN @CONNECTIONDB = 'A' THEN ACCOUNTDB ELSE SHAREDB END,
						@MULTISERVER = CASE WHEN @CONNECTIONDB = 'A' THEN ACCOUNTSERVER ELSE SHARESERVER END
					FROM
						MULTICOMPANY_ALL
					WHERE
						PRIMARYSERVER = 1
						AND EXCHANGE = @EXCHANGE
						AND SEGMENT = @SEGMENT
				END
			ELSE IF @CONNECTIONDB = 'D'
				BEGIN
					SELECT
						@DBNAME = SHAREDB,
						@MULTISERVER = CASE WHEN @CONNECTIONDB = 'A' THEN ACCOUNTSERVER ELSE SHARESERVER END
					FROM
						MULTICOMPANY_ALL
					WHERE
						PRIMARYSERVER <> 1
						AND EXCHANGE = @EXCHANGE
						AND SEGMENT = @SEGMENT
					IF @@ROWCOUNT <= 0
						BEGIN
							SELECT
								@DBNAME = SHAREDB,
								@MULTISERVER = CASE WHEN @CONNECTIONDB = 'A' THEN ACCOUNTSERVER ELSE SHARESERVER END
							FROM
								MULTICOMPANY_ALL
							WHERE
								PRIMARYSERVER = 1
								AND EXCHANGE = @EXCHANGE
								AND SEGMENT = @SEGMENT
						END
				END
			IF @@SERVERNAME = REPLACE(REPLACE(@MULTISERVER, '[', ''), ']', '')
				BEGIN
					SET @MULTISERVER = '' + @DBNAME + '.dbo.'
				END
			ELSE
				BEGIN
					SET @MULTISERVER = @MULTISERVER + '.' + @DBNAME + '.dbo.'
				END



	IF @OBJTYPE = 'T' OR @OBJTYPE = 'V'
		BEGIN
			SET @OBJNAME = @MULTISERVER + @OBJNAME
			SET @SQL = "SELECT " + @OBJECTOUT + " FROM " + @OBJNAME + " WHERE 1 = 1 "
			IF LEN(@PARAMFIELDS) > 0
				BEGIN
					SET @PARAMPOS = 1
					WHILE 1 = 1
						BEGIN
							SET @PARAMNAME = .dbo.PIECE(@PARAMFIELDS, ',', @PARAMPOS)
							IF @PARAMNAME = '' OR @PARAMNAME IS NULL
								BEGIN
									BREAK
								END
							SET @PARAMVAL = .dbo.PIECE(@F2PARAMS, '|', @PARAMPOS)
							SET @PARAMOPR = .dbo.PIECE(@PARAMOPRLIST, ',', @PARAMPOS)
							SET @SQL = @SQL + " AND " + @PARAMNAME + " " + (CASE WHEN @PARAMOPR = '' OR @PARAMOPR IS NULL THEN '=' ELSE @PARAMOPR END) + " '" + (CASE WHEN @PARAMVAL = '' OR @PARAMVAL IS NULL THEN CASE WHEN @PARAMOPR = 'LIKE' THEN '' ELSE '0' END ELSE @PARAMVAL END) + "' + '" + (CASE WHEN @PARAMOPR = 'LIKE' THEN '%' ELSE '' END) + "' "
							SET @PARAMPOS = @PARAMPOS + 1
						END
				END
			IF LEN(@F2WHFLDS) > 0
				BEGIN
					SET @PARAMPOS = 1
					WHILE 1 = 1
						BEGIN
							SET @PARAMNAME = .dbo.PIECE(@F2WHFLDS, ',', @PARAMPOS)
							IF @PARAMNAME IS NULL
								BEGIN
									BREAK
								END
							SET @PARAMVAL = .dbo.PIECE(@F2WHVALS, ',', @PARAMPOS)
							SET @PARAMOPR = .dbo.PIECE(@F2WHOPR, ',', @PARAMPOS)
							SET @SQL = @SQL + " AND " + @PARAMNAME + " " + (CASE WHEN @PARAMOPR = '' OR @PARAMOPR IS NULL THEN '=' ELSE @PARAMOPR END) + " '" + (CASE WHEN @PARAMVAL = '' OR @PARAMVAL IS NULL THEN CASE WHEN @PARAMOPR = 'LIKE' THEN '' ELSE '0' END ELSE @PARAMVAL END) + "' + '" + (CASE WHEN @PARAMOPR = 'LIKE' THEN '%' ELSE '' END) + "' "
							SET @PARAMPOS = @PARAMPOS + 1
						END
				END
			IF LEN(@ORDERLIST) > 0
				BEGIN
					SET @SQL = @SQL + " ORDER BY " + @ORDERLIST
				END
			ELSE
				BEGIN
					SET @SQL = @SQL + " ORDER BY 1 "
				END
			IF @USEXML = 1
				BEGIN
					SET @SQL = @SQL + " FOR XML AUTO "
				END
			--PRINT @SQL
			EXEC(@SQL)
		END
	ELSE IF @OBJTYPE = 'P'
		BEGIN
			CREATE TABLE #PARANAMES (PARANAME VARCHAR(256))
			IF @DATABASENAME <> ''
				BEGIN
					SET @SQL = "INSERT INTO #PARANAMES (PARANAME) SELECT NAME FROM " + @DATABASENAME + "SYSCOLUMNS WHERE ID = (SELECT ID FROM " + @DATABASENAME + "SYSOBJECTS WHERE NAME = '" + @OBJNAME + "' AND XTYPE = 'P')"
					EXEC (@SQL)
					SET @PARAMCUR = CURSOR FOR SELECT PARANAME FROM #PARANAMES
				END
			ELSE
				IF @MULTISERVER <> ''
					BEGIN
						SET @DATABASENAME = @MULTISERVER
						SET @SQL = "INSERT INTO #PARANAMES (PARANAME) SELECT NAME FROM " + @MULTISERVER + "SYSCOLUMNS WHERE ID = (SELECT ID FROM " + @MULTISERVER + "SYSOBJECTS WHERE NAME = '" + @OBJNAME + "' AND XTYPE = 'P')"
						EXEC (@SQL)
						SET @PARAMCUR = CURSOR FOR SELECT PARANAME FROM #PARANAMES
					END
				ELSE
					BEGIN
						SET @PARAMCUR = CURSOR FOR SELECT NAME FROM SYSCOLUMNS WHERE ID = (SELECT ID FROM SYSOBJECTS WHERE NAME = @OBJNAME AND XTYPE = 'P')
					END
			OPEN @PARAMCUR
			FETCH NEXT FROM @PARAMCUR INTO @PARAMFIELDS
			SET @SQL = ''
			SET @PARAMPOS = 1
			WHILE @@FETCH_STATUS = 0
				BEGIN
					SET @PARAMVAL = .dbo.PIECE(@F2PARAMS, '|', @PARAMPOS)
					IF @PARAMVAL IS NULL
						BEGIN
							SET @SQL = @SQL + @PARAMFIELDS + "=NULL,"
						END
					ELSE
						BEGIN
							SET @SQL = @SQL + @PARAMFIELDS + "='" + @PARAMVAL + "',"
						END
					SET @PARAMPOS = @PARAMPOS + 1
					FETCH NEXT FROM @PARAMCUR INTO @PARAMFIELDS
				END
			IF LEN(@SQL) > 0
				BEGIN
					SET @SQL = @DATABASENAME + @OBJNAME + ' ' + SUBSTRING(@SQL, 1, LEN(@SQL)-1)
				END
			ELSE
				BEGIN
					SET @SQL = @DATABASENAME + @OBJNAME
				END
			--PRINT @SQL
			EXEC SP_EXECUTESQL @SQL
			--EXEC @SQL
		END
END TRY
BEGIN CATCH
	DECLARE @ERRMSG VARCHAR(1000)
	SET @ERRMSG = ERROR_MESSAGE()
	RAISERROR(@ERRMSG, 16, 1)
END CATCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_BDPID_BCLTDPID
-- --------------------------------------------------
--GET_BDPID_BCLTDPID 'bsemfss'
CREATE  PROC [dbo].[GET_BDPID_BCLTDPID] 
(
	@SHAREDB VARCHAR(20) 
)
AS
BEGIN
	DECLARE @SQL VARCHAR(MAX),
			@SQL1 VARCHAR(MAX)
	--SET @SQL = 	@SHAREDB + '..DELTRANS'
   

	SET @SQL = 'SELECT DISTINCT BDPID FROM ' + @SHAREDB + '..DELTRANS' + ' ORDER BY BDPID ' 
exec(@SQL)
	SET @SQL1 = 'SELECT DISTINCT BCLTDPID FROM ' + @SHAREDB + '..DELTRANS' + ' ORDER BY BCLTDPID'
exec(@SQL1) 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_BRANCH_CD
-- --------------------------------------------------
CREATE PROC [dbo].[GET_BRANCH_CD]
AS
BEGIN
	SELECT DISTINCT BRANCH_CD FROM MSAJAG.DBO.CLIENT1 ORDER BY BRANCH_CD
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_DPID_DPCLTNO
-- --------------------------------------------------
--exec GET_DPID_DPCLTNO 'bsmfss'
CREATE PROC [dbo].[GET_DPID_DPCLTNO]
(
	@SHAREDB VARCHAR(20) 
)
AS
BEGIN
	DECLARE @SQL VARCHAR(MAX),
			@SQL1 VARCHAR(MAX)

	SET @SQL ='SELECT DISTINCT DPID FROM ' + @SHAREDB + '..DELIVERYDP ORDER BY DPID'
	exec(@SQL)

	SET @SQL1 ='SELECT DISTINCT DPCLTNO FROM ' + @SHAREDB + '..DELIVERYDP ORDER BY DPCLTNO'
	exec(@SQL1)
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_EXCH_SEGMENT
-- --------------------------------------------------
--EXEC GET_EXCH_SEGMENT '0A141'
CREATE PROCEDURE [dbo].[GET_EXCH_SEGMENT] 
	@CL_CODE VARCHAR(10)
AS
BEGIN
	SELECT EXCHANGE,SEGMENT FROM MSAJAG.DBO.CLIENT_BROK_DETAILS 
	WHERE CL_CODE=@CL_CODE AND INACTIVE_FROM > GETDATE()
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_MULICOMPANY_INFO
-- --------------------------------------------------
CREATE PROC  [dbo].[GET_MULICOMPANY_INFO]
AS
SELECT	EXCHANGE + '-' + SEGMENT AS EXCH_SEG,BROKERID,COMPANYNAME,SEGMENT_DESCRIPTION,EXCHANGE,SEGMENT,
		MEMBERTYPE,MEMBERCODE,SHAREDB,SHARESERVER,SHAREIP,ACCOUNTDB,ACCOUNTSERVER,ACCOUNTIP,
		DEFAULTDB,DEFAULTDBSERVER,DEFAULTDBIP,DEFAULTCLIENT,PANGIR_NO,PRIMARYSERVER,
		FILLER2,DBUSERNAME,DBPASSWORD,LICENSE,APPSHARE_ROOTFLDR_NAME,
		SEGMENTDESC = SEGMENT_DESCRIPTION
FROM 
		MULTICOMPANY (NOLOCK)
WHERE	
		PRIMARYSERVER = 1
ORDER BY 1

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_MULICOMPANY_INFO_DEL
-- --------------------------------------------------

CREATE PROC  [dbo].[GET_MULICOMPANY_INFO_DEL]
AS



SELECT	EXCHANGE + '-' + SEGMENT AS EXCH_SEG,BROKERID,COMPANYNAME,SEGMENT_DESCRIPTION,EXCHANGE,SEGMENT,
		MEMBERTYPE,MEMBERCODE,SHAREDB,SHARESERVER,SHAREIP,ACCOUNTDB,ACCOUNTSERVER,ACCOUNTIP,
		DEFAULTDB,DEFAULTDBSERVER,DEFAULTDBIP,DEFAULTCLIENT,PANGIR_NO,PRIMARYSERVER,
		FILLER2,DBUSERNAME,DBPASSWORD,LICENSE,APPSHARE_ROOTFLDR_NAME,
		SEGMENTDESC = SEGMENT_DESCRIPTION
INTO	#MULTICOMPANY
FROM 
		MULTICOMPANY (NOLOCK)
WHERE	
		PRIMARYSERVER = 0
ORDER BY 1


INSERT INTO #MULTICOMPANY (EXCH_SEG, BROKERID, COMPANYNAME, SEGMENT_DESCRIPTION, EXCHANGE, SEGMENT, MEMBERTYPE, MEMBERCODE,
							SHAREDB, SHARESERVER, SHAREIP, ACCOUNTDB, ACCOUNTSERVER, ACCOUNTIP, DEFAULTDB, DEFAULTDBSERVER,
							DEFAULTDBIP, DEFAULTCLIENT, PANGIR_NO, PRIMARYSERVER, FILLER2, DBUSERNAME, DBPASSWORD, LICENSE,
							APPSHARE_ROOTFLDR_NAME,SEGMENTDESC)
SELECT	EXCH_SEG = EXCHANGE + '-' + SEGMENT, BROKERID, COMPANYNAME, SEGMENT_DESCRIPTION, EXCHANGE, SEGMENT, MEMBERTYPE, MEMBERCODE, SHAREDB, SHARESERVER, SHAREIP,
		ACCOUNTDB, ACCOUNTSERVER, ACCOUNTIP, DEFAULTDB, DEFAULTDBSERVER, DEFAULTDBIP, DEFAULTCLIENT, PANGIR_NO, PRIMARYSERVER, FILLER2,
		DBUSERNAME, DBPASSWORD, LICENSE, APPSHARE_ROOTFLDR_NAME,SEGMENTDESC = SEGMENT_DESCRIPTION
FROM	MULTICOMPANY O (NOLOCK) WHERE PRIMARYSERVER = 1
		AND NOT EXISTS (SELECT EXCHANGE, SEGMENT FROM #MULTICOMPANY I WHERE O.EXCHANGE = I.EXCHANGE AND O.SEGMENT = I.SEGMENT)
		
SELECT * FROM #MULTICOMPANY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_SETT_TYPE_NO
-- --------------------------------------------------
CREATE PROC [dbo].[GET_SETT_TYPE_NO]  
( 
	@FLAG VARCHAR(2),
	@SHAREDB VARCHAR(20) 
)  
AS  
/*  
EXEC CLASSAPP.DBO.GET_SETT_TYPE_NO '1'  
*/  
BEGIN 
 DECLARE @SQL VARCHAR(MAX) 
 IF @FLAG='1'  
  BEGIN  
   SET @SQL='SELECT DISTINCT SETT_TYPE FROM ' + @SHAREDB + '.DBO.DELIVERYCLT ORDER BY SETT_TYPE' 
   exec(@SQL) 
  END  
 ELSE  
  BEGIN  
   SET @SQL= 'SELECT DISTINCT SETT_NO FROM ' + @SHAREDB + '.DBO.DELIVERYCLT ORDER BY SETT_NO DESC' 
   exec(@SQL)	  
  END  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_SETTYPE_SETTNO
-- --------------------------------------------------
-- exec GET_SETTYPE_SETTNO '2','bsemfss'
CREATE PROC [dbo].[GET_SETTYPE_SETTNO]
(
	@FLAG VARCHAR(2),
	@SHAREDB VARCHAR(20) 
)
AS
BEGIN  
  DECLARE @SQL VARCHAR(MAX),
		  @SQL1 VARCHAR(MAX)
  IF @FLAG='1'
	BEGIN
		SET @SQL='SELECT DISTINCT SETT_TYPE FROM ' + @SHAREDB + '.DBO.DELIVERYCLT WHERE SETT_TYPE IN (''A'',''X'')'
		EXEC(@SQL)
		SET @SQL1='SELECT DISTINCT SETT_NO  FROM ' + @SHAREDB + '.DBO.DELIVERYCLT WHERE SETT_TYPE IN (''A'',''X'') ORDER BY SETT_NO DESC'
		EXEC(@SQL1)
	END
  ELSE
	BEGIN
		SET @SQL='SELECT DISTINCT SETT_NO FROM ' + @SHAREDB + '.DBO.DELIVERYCLT ORDER BY SETT_NO DESC'
		EXEC(@SQL)
		SET @SQL1='SELECT DISTINCT SETT_TYPE FROM ' + @SHAREDB + '.DBO.DELIVERYCLT ORDER BY SETT_TYPE DESC'
		EXEC(@SQL1)
	END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GET_TEXT_CLT_AGREEMENT
-- --------------------------------------------------
--EXEC GET_TEXT_CLT_AGREEMENT 'T1','NSE','CAPITAL'
CREATE PROCEDURE [dbo].[GET_TEXT_CLT_AGREEMENT] 
	@TAB VARCHAR(3),
	@EXCH VARCHAR(3),
	@SEG VARCHAR(7)
AS
SET NOCOUNT ON
CREATE TABLE #CLIENTAGREEMENT
(
	COMPANY VARCHAR(50),
	ADDR1 VARCHAR(70),
	ADDR2 VARCHAR(70),
	TEXT_VALUE VARCHAR(2000)
)
BEGIN
	INSERT INTO #CLIENTAGREEMENT(TEXT_VALUE)
	SELECT TEXT_VALUE FROM CLIENT_AGREEMENT_TEXT WHERE TEXT_TYPE1= @TAB
	UPDATE #CLIENTAGREEMENT SET COMPANY=M.COMPANYNAME
	FROM MSAJAG.dbo.MULTICOMPANY M WHERE EXCHANGE=@EXCH and SEGMENT=@SEG
	UPDATE #CLIENTAGREEMENT SET ADDR1=W.ADDR1, ADDR2=W.ADDR2
	FROM MSAJAG.dbo.OWNER W
	SELECT * FROM #CLIENTAGREEMENT
END
DROP TABLE #CLIENTAGREEMENT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETBRANCHDATA
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[GETBRANCHDATA]  
AS  
SELECT DISTINCT BRANCH_CODE FROM MSAJAG.DBO.BRANCH

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETCAPTCHAFLAG
-- --------------------------------------------------

CREATE PROC [dbo].[GETCAPTCHAFLAG]
(
	@EXCHANGE VARCHAR(25),
	@SEGMENT VARCHAR(25)
)
/*
	EXEC GETCAPTCHAFLAG 'NSE', 'CAPITAL'
*/
AS
DECLARE
	@SHAREDB VARCHAR(20),
	@SQL VARCHAR(1000)
SELECT @SHAREDB = SHAREDB FROM MULTICOMPANY (NOLOCK) WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND PRIMARYSERVER = 1
IF @@ROWCOUNT > 0
	BEGIN
		SET @SQL = 'SELECT FLDCAPTCHA FROM ' + @SHAREDB + '..TBLGLOBALPARAMS'
		EXEC(@SQL)
	END
ELSE
	BEGIN
		RAISERROR('Invalid Exchange and Segment provided...', 16, 1)
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETENCRYPTIONTYPE
-- --------------------------------------------------
CREATE PROC [dbo].[GETENCRYPTIONTYPE]
(
	@EXCHANGE VARCHAR(25),
	@SEGMENT VARCHAR(25)
)
/*
	EXEC GETENCRYPTIONTYPE 'NSE', 'CAPITAL'
*/
AS
DECLARE
	@SHAREDB VARCHAR(20),
	@SQL VARCHAR(1000)
SELECT @SHAREDB = SHAREDB FROM MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT AND PRIMARYSERVER = 1
IF @@ROWCOUNT > 0
	BEGIN
		SET @SQL = 'SELECT FLDENCRYPTION FROM ' + @SHAREDB + '.dbo.TBLGLOBALPARAMS'
		EXEC(@SQL)
	END
ELSE
	BEGIN
		RAISERROR('Invalid Exchange and Segment provided...', 16, 1)
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.GETSETTYPE
-- --------------------------------------------------
CREATE PROCEDURE [dbo].[GETSETTYPE]   
   
 @SETT_TYPE VARCHAR(2),  
 @SETT_NO VARCHAR(10),  
 @PA_FLG VARCHAR(2),  
    @PA_PARTY VARCHAR(10),  
 @SHAREDB VARCHAR(20) = 'NSEMFSS'  
  
AS  
/*  
  EXEC GETSETTYPE '','',''  
  EXEC GETSETTYPE 'A','',''  
  EXEC GETSETTYPE '','','', '','BSEMFSS'
*/  
BEGIN  
 DECLARE @SQL VARCHAR(MAX)  
 SET @SQL = ''  
 IF @SHAREDB = ''  
  SET @SHAREDB = 'NSEMFSS'  
 IF @SETT_TYPE='' AND @SETT_NO=''  
  BEGIN  
   SET @SQL = 'SELECT DISTINCT SETT_TYPE FROM ' + @SHAREDB + '..DEMATTRANS ORDER BY SETT_TYPE'  
  END  
 ELSE IF @SETT_TYPE <>'' AND @SETT_NO=''  
  BEGIN  
   SET @SQL = 'SELECT DISTINCT SETT_NO FROM ' + @SHAREDB + '..DEMATTRANS WHERE SETT_TYPE= ''' + @SETT_TYPE + ''' ORDER BY SETT_NO DESC'  
  END  
 ELSE IF @SETT_TYPE <>'' AND @SETT_NO<>''  
  BEGIN  
     IF @PA_FLG = '1'   
   BEGIN  
               IF @PA_PARTY = 'missing'  
    BEGIN    
     SET @SQL = 'SELECT DISTINCT PARTY_CODE '  
     SET @SQL = @SQL + 'FROM ' + @SHAREDB + '..DEMATTRANS '  
     SET @SQL = @SQL + 'WHERE SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' And PARTY_CODE = ''PARTY'' ORDER BY PARTY_CODE'  
    END  
               ELSE  
    BEGIN    
     SET @SQL = 'SELECT DISTINCT PARTY_CODE '  
     SET @SQL = @SQL + 'FROM ' + @SHAREDB + '..DEMATTRANS '  
     SET @SQL = @SQL + 'WHERE SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' And PARTY_CODE != ''PARTY'' ORDER BY PARTY_CODE'  
    END  
            END      
               
   --END  
   if @PA_FLG = '2'  
   BEGIN  
                IF @PA_PARTY = 'missing'  
      BEGIN   
     SET @SQL = 'SELECT DISTINCT SCRIP_CD '  
     SET @SQL = @SQL + 'FROM ' + @SHAREDB + '..DEMATTRANS '  
     SET @SQL = @SQL + 'WHERE SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' And PARTY_CODE = ''PARTY'' ORDER BY SCRIP_CD'  
      END   
    ELSE   
      BEGIN   
     SET @SQL = 'SELECT DISTINCT SCRIP_CD '  
     SET @SQL = @SQL + 'FROM ' + @SHAREDB + '..DEMATTRANS '  
     SET @SQL = @SQL + 'WHERE SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' And PARTY_CODE != ''PARTY'' ORDER BY SCRIP_CD'  
      END   
   END  
   IF @PA_FLG = '3'  
   BEGIN  
    IF @PA_PARTY = 'missing'  
      BEGIN   
     SET @SQL = 'SELECT DISTINCT Left(Convert(Varchar,Trdate,109),11) as TDate '  
     SET @SQL = @SQL + 'FROM ' + @SHAREDB + '..DEMATTRANS '  
     SET @SQL = @SQL + 'WHERE SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' And PARTY_CODE = ''PARTY'' ORDER BY TDate'  
      END  
    ELSE   
      BEGIN  
     SET @SQL = 'SELECT DISTINCT Left(Convert(Varchar,Trdate,109),11) as TDate '  
     SET @SQL = @SQL + 'FROM ' + @SHAREDB + '..DEMATTRANS '  
     SET @SQL = @SQL + 'WHERE SETT_NO = ''' + @SETT_NO + ''' AND SETT_TYPE = ''' + @SETT_TYPE + ''' And PARTY_CODE != ''PARTY'' ORDER BY TDate'  
      END   
     END  
        END  
END  
print @sql  
exec(@sql)

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PAYOUTTOCLIENTBEN
-- --------------------------------------------------

CREATE PROC [dbo].[PAYOUTTOCLIENTBEN]  
(  
 @FPartyCode VARCHAR(10),  
 @TPartyCode VARCHAR(10),
 @SHAREDB VARCHAR(20) ='MSAJAG'   
)  
AS
/*  
 EXEC [PAYOUTTOCLIENTBEN] '0a141', '0a141','BSEMFSS'
Created By Piyush 
*/  
DECLARE @SQL VARCHAR(MAX)
SET @SQL = 	@SHAREDB + '.DBO.InsDelAccDebit'

EXEC BSEMFSS.dbo.INSDELACCCHECK

insert into bsemfss.dbo.DELACCBALANCE
select distinct party_code, 0, 0 from bsemfss.dbo.DELIVERYCLT
where party_code not in (select cltcode from bsemfss.dbo.DELACCBALANCE)
  

CREATE TABLE #DELACCBALANCE  
(  
 SRNO INT IDENTITY(1,1),  
 SCRIP_CD VARCHAR(12),  
 SERIES VARCHAR(3),  
 SCHEME_NAME VARCHAR(200),
 PARTY_CODE VARCHAR(10),  
 LONG_NAME VARCHAR(100),  
 TRTYPE NUMERIC(18,0),  
 CLTDPID VARCHAR(16),  
 DPID VARCHAR(16),  
 CERTNO VARCHAR(16),  
 QTY NUMERIC(18,3),  
 DELIVERED CHAR(1),  
 BDPTYPE VARCHAR(10),  
 BDPID VARCHAR(16),  
 BCLTDPID VARCHAR(16),  
 AMOUNT NUMERIC(18,2),  
 ISETT_NO VARCHAR(7),  
 ISETT_TYPE VARCHAR(2),  
 CL_RATE MONEY,  
 EXCH VARCHAR(20),  
 DISPLAYTEXT VARCHAR(50),  
 VALUATION NUMERIC(18,2),  
 REMARK VARCHAR(50),  
 RELVALUE NUMERIC(18,2),  
 PENDVALUE NUMERIC(18,2),  
 RELVALUESUM NUMERIC(18,2),  
 PENDVALUESUM NUMERIC(18,2),  
 RELSUM NUMERIC(18,2),  
 PENDSUM NUMERIC(18,2)  
)  
CREATE CLUSTERED INDEX IDX_DELACCBALANCE  
ON #DELACCBALANCE (SRNO, PARTY_CODE, SCRIP_CD)  
INSERT INTO #DELACCBALANCE  
(  
 SCRIP_CD,  
 SERIES,  
 SCHEME_NAME,
 PARTY_CODE,  
 LONG_NAME,  
 TRTYPE,  
 CLTDPID,  
 DPID,  
 CERTNO,  
 QTY,  
 DELIVERED,  
 BDPTYPE,  
 BDPID,  
 BCLTDPID,  
 AMOUNT,  
 ISETT_NO,  
 ISETT_TYPE,  
 CL_RATE,  
 EXCH   
)  
EXEC @SQL @FPartyCode,@TPartyCode  
  
UPDATE  
 #DELACCBALANCE  
SET  
 DISPLAYTEXT = CASE WHEN TRTYPE = 907 THEN 'INTERSETTLEMENT TO ' + ISETT_NO + '-' + ISETT_TYPE ELSE 'PAY-OUT' END,  
 VALUATION = (CL_RATE * QTY),  
 REMARK = CASE WHEN DELIVERED = 'D' THEN 'Given' ELSE CASE WHEN DELIVERED = 'G' THEN 'Generated' ELSE CASE WHEN TRTYPE = 907 THEN '-' ELSE CASE WHEN AMOUNT > 0 THEN '-' ELSE 'Debit Balance' END END END END,  
 RELVALUE = CASE WHEN DELIVERED = 'D' OR DELIVERED = 'G' OR TRTYPE = 907 THEN (CL_RATE * QTY) ELSE 0 END,  
 PENDVALUE = CASE WHEN (DELIVERED <> 'D' AND DELIVERED <> 'G' AND TRTYPE <> 907) THEN (CL_RATE * QTY) ELSE 0 END  
   
UPDATE  
 #DELACCBALANCE  
SET  
 RELVALUESUM = (SELECT SUM(RELVALUE) FROM #DELACCBALANCE I WHERE #DELACCBALANCE.PARTY_CODE = I.PARTY_CODE AND #DELACCBALANCE.SCRIP_CD = I.SCRIP_CD AND I.SRNO <= #DELACCBALANCE.SRNO),  
 PENDVALUESUM = (SELECT SUM(PENDVALUE) FROM #DELACCBALANCE I WHERE #DELACCBALANCE.PARTY_CODE = I.PARTY_CODE AND #DELACCBALANCE.SCRIP_CD = I.SCRIP_CD AND I.SRNO <= #DELACCBALANCE.SRNO),  
 RELSUM = (SELECT SUM(RELVALUE) FROM #DELACCBALANCE I WHERE #DELACCBALANCE.PARTY_CODE = I.PARTY_CODE AND I.SRNO <= #DELACCBALANCE.SRNO),  
 PENDSUM = (SELECT SUM(PENDVALUE) FROM #DELACCBALANCE I WHERE #DELACCBALANCE.PARTY_CODE = I.PARTY_CODE AND I.SRNO <= #DELACCBALANCE.SRNO)  
  
SELECT *,LONG_NAME + '  (' + LTRIM(RTRIM(PARTY_CODE)) + ')' as PARTY_NAME FROM #DELACCBALANCE  
DROP TABLE #DELACCBALANCE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PAYOUTTOCLIENTDET
-- --------------------------------------------------

CREATE PROC [dbo].[PAYOUTTOCLIENTDET]  
(  
 @SETT_NO VARCHAR(7),  
 @SETT_TYPE VARCHAR(2),
 @SHAREDB VARCHAR(20)  
)  
AS
/*  
 EXEC PAYOUTTOCLIENTDET '1011186', 't3','nSEMFSS'
Created By Piyush  
*/  
DECLARE @SQL VARCHAR(MAX),
        @SQL1 VARCHAR(MAX),
        @SQL2 VARCHAR(MAX),
        @SQL3 VARCHAR(MAX)

SET @SQL3 = "EXEC " + @SHAREDB + ".dbo.INSDELACCCHECK"
EXEC(@SQL3)

SET @SQL = "insert into " + @SHAREDB + ".dbo.DELACCBALANCE"
SET @SQL = @SQL + " select distinct party_code, 0, 0 from " + @SHAREDB + ".dbo.mfss_settlement"
SET @SQL = @SQL + " where sett_no = '" + @sett_no + "' and sett_Type = '" + @sett_Type + "'"
SET @SQL = @SQL + " and party_code not in (select cltcode from " + @SHAREDB + ".dbo.DELACCBALANCE)"
EXEC (@SQL)
  
CREATE TABLE #DELACCBALANCE  
(  
 SRNO INT IDENTITY(1,1),  
 SCRIP_CD VARCHAR(12),  
 SERIES VARCHAR(3),
 SCHEME_NAME VARCHAR(200),  
 PARTY_CODE VARCHAR(10),  
 LONG_NAME VARCHAR(100),  
 TRTYPE NUMERIC(18,0),  
 CLTDPID VARCHAR(16),  
 DPID VARCHAR(16),  
 CERTNO VARCHAR(16),  
 QTY NUMERIC(38,3),  
 DELIVERED CHAR(1),  
 BDPTYPE VARCHAR(10),  
 BDPID VARCHAR(16),  
 BCLTDPID VARCHAR(16),  
 AMOUNT NUMERIC(18,2),  
 ISETT_NO VARCHAR(7),  
 ISETT_TYPE VARCHAR(2),  
 CL_RATE MONEY,  
 DISPLAYTEXT VARCHAR(50),  
 VALUATION MONEY,  
 REMARK VARCHAR(50),  
 RELVALUE NUMERIC(18,3),  
 PENDVALUE NUMERIC(18,3),  
 RELVALUESUM NUMERIC(18,3),  
 PENDVALUESUM NUMERIC(18,3),  
 RELSUM NUMERIC(18,3),  
 PENDSUM NUMERIC(18,3)  
)  
CREATE CLUSTERED INDEX IDX_DELACCBALANCE  
ON #DELACCBALANCE (SRNO, PARTY_CODE, SCRIP_CD) 
 
SET @SQL1 = "INSERT INTO #DELACCBALANCE(SCRIP_CD,SERIES,SCHEME_NAME,PARTY_CODE,LONG_NAME,TRTYPE,CLTDPID,DPID,CERTNO,QTY,DELIVERED,"  
SET @SQL1 =  @SQL1 + " BDPTYPE,BDPID,BCLTDPID,AMOUNT,ISETT_NO,ISETT_TYPE,CL_RATE,DISPLAYTEXT,VALUATION,REMARK,RELVALUE,PENDVALUE,"  
SET @SQL1 =  @SQL1 + " RELVALUESUM,PENDVALUESUM,RELSUM,PENDSUM) SELECT  D.SCRIP_CD,D.SERIES,"
if @SHAREDB = 'NSEMFSS'
SET	@SQL1 = @SQL1 + " SCHEME_NAME = SEC_NAME"
if @SHAREDB = 'BSEMFSS'
SET	@SQL1 = @SQL1 + " SCHEME_NAME = SCHEME_NAME"  
SET @SQL1 =  @SQL1 + " ,D.PARTY_CODE,C1.LONG_NAME,TRTYPE,CLTDPID,DPID,CERTNO,QTY=SUM(QTY),DELIVERED,BDPTYPE,BDPID,BCLTDPID,AMOUNT,ISETT_NO,ISETT_TYPE,"  
SET @SQL1 =  @SQL1 + " CL_RATE=0,DISPLAYTEXT = '',VALUATION = 0,REMARK = '',RELVALUE = 0,PENDVALUE = 0,RELVALUESUM = 0,"
SET @SQL1 =  @SQL1 + " PENDVALUESUM = 0,RELSUM = 0,PENDSUM = 0"  
SET @SQL1 =  @SQL1 + " FROM  " + @SHAREDB + ".dbo.CLIENT1 C1," + @SHAREDB + ".dbo.CLIENT2 C2," + @SHAREDB + ".dbo.DELACCBALANCE A," + @SHAREDB + ".dbo.DELTRANS D," + @SHAREDB + ".DBO.MFSS_SCRIP_MASTER M" 
SET @SQL1 =  @SQL1 + " WHERE  SETT_NO = '" + @SETT_NO + "' AND SETT_TYPE = '" + @SETT_TYPE + "' AND DRCR = 'D'  AND TRTYPE <> 906  AND D.PARTY_CODE = C2.PARTY_CODE"  
SET @SQL1 =  @SQL1 + " AND C1.CL_CODE = C2.CL_CODE  AND FILLER2= 1 AND A.CLTCODE = D.PARTY_CODE AND D.SCRIP_CD = M.SCRIP_CD"  
SET @SQL1 =  @SQL1 + " GROUP BY  D.SCRIP_CD,D.SERIES,D.PARTY_CODE,C1.LONG_NAME,TRTYPE,CLTDPID,DPID,CERTNO,"
if @SHAREDB = 'NSEMFSS'
SET	@SQL1 = @SQL1 + " SEC_NAME"
if @SHAREDB = 'BSEMFSS'
SET	@SQL1 = @SQL1 + " SCHEME_NAME" 
SET @SQL1 =  @SQL1 + " ,DELIVERED,BDPTYPE,BDPID,BCLTDPID,AMOUNT,ISETT_NO,ISETT_TYPE,DELIVERED ORDER BY AMOUNT,C1.LONG_NAME,D.SCRIP_CD"  
EXEC(@SQL1)

SET @SQL2 = "UPDATE #DELACCBALANCE SET CL_RATE = NAV_VALUE FROM " + @SHAREDB + ".DBO.MFSS_NAV M"
SET @SQL2 =  @SQL2 + " WHERE NAV_DATE = (SELECT MAX(NAV_DATE) FROM " + @SHAREDB + ".DBO.MFSS_NAV M1 WHERE M1.SCRIP_CD = M.SCRIP_CD)"
SET @SQL2 =  @SQL2 + "AND #DELACCBALANCE.SCRIP_CD = M.SCRIP_CD"
EXEC(@SQL2)
				   

   
UPDATE  
 #DELACCBALANCE  
SET  
 DISPLAYTEXT = CASE WHEN TRTYPE = 907 THEN 'INTERSETTLEMENT TO ' + ISETT_NO + '-' + ISETT_TYPE ELSE 'PAY-OUT' END,  
 VALUATION = (CL_RATE * QTY),  
 REMARK = CASE WHEN DELIVERED = 'D' THEN 'Given' ELSE CASE WHEN DELIVERED = 'G' THEN 'Generated' ELSE CASE WHEN TRTYPE = 907 THEN '-' ELSE CASE WHEN AMOUNT > 0 THEN '-' ELSE 'Debit Balance' END END END END,  
 RELVALUE = CASE WHEN DELIVERED = 'D' OR DELIVERED = 'G' OR TRTYPE = 907 THEN (CL_RATE * QTY) ELSE 0 END,  
 PENDVALUE = CASE WHEN (DELIVERED <> 'D' AND DELIVERED <> 'G' AND TRTYPE <> 907) THEN (CL_RATE * QTY) ELSE 0 END  
   
UPDATE  
 #DELACCBALANCE  
SET  
 RELVALUESUM = (SELECT SUM(RELVALUE) FROM #DELACCBALANCE I WHERE #DELACCBALANCE.PARTY_CODE = I.PARTY_CODE AND #DELACCBALANCE.SCRIP_CD = I.SCRIP_CD AND I.SRNO <= #DELACCBALANCE.SRNO),  
 PENDVALUESUM = (SELECT SUM(PENDVALUE) FROM #DELACCBALANCE I WHERE #DELACCBALANCE.PARTY_CODE = I.PARTY_CODE AND #DELACCBALANCE.SCRIP_CD = I.SCRIP_CD AND I.SRNO <= #DELACCBALANCE.SRNO),  
 RELSUM = (SELECT SUM(RELVALUE) FROM #DELACCBALANCE I WHERE #DELACCBALANCE.PARTY_CODE = I.PARTY_CODE AND I.SRNO <= #DELACCBALANCE.SRNO),  
 PENDSUM = (SELECT SUM(PENDVALUE) FROM #DELACCBALANCE I WHERE #DELACCBALANCE.PARTY_CODE = I.PARTY_CODE AND I.SRNO <= #DELACCBALANCE.SRNO)  
  
SELECT *,LONG_NAME + '  (' + PARTY_CODE + ')' as PARTY_NAME FROM #DELACCBALANCE  
DROP TABLE #DELACCBALANCE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PDFCOMPANYINFO
-- --------------------------------------------------

  
CREATE PROC [dbo].[PDFCOMPANYINFO]  
(  
 @EXCHANGE VARCHAR(10),  
 @SEGMENT VARCHAR(10)  
)  
AS  
/*  
 EXEC PDFCOMPANYINFO 'NSE', 'CAPITAL'  
*/  
SET NOCOUNT ON  
CREATE TABLE #OWNERINFORMATION  
(  
 COMPANY VARCHAR(60),  
 ADDR1 VARCHAR(70),  
 ADDR2 VARCHAR(70),  
 PHONE VARCHAR(25),  
 FAX VARCHAR(25),  
 ZIP VARCHAR(6),  
 CITY VARCHAR(20),  
 MEMBERCODE VARCHAR(15),  
 BROKERSEBIREGNO VARCHAR(15),  
 DPID VARCHAR(16),  
 DPCLTID VARCHAR(16),  
 CMBPID VARCHAR(8),  
 COMPPAN VARCHAR(50),  
 COMPMAIL VARCHAR(100),  
    STATE VARCHAR(100)  
)  
IF @EXCHANGE = '' OR @EXCHANGE = 'ALL'  
 BEGIN  
  SET @EXCHANGE = 'NSE'  
 END  
  
IF @SEGMENT = '' OR @SEGMENT = 'ALL'  
 BEGIN  
  SET @SEGMENT = 'CAPITAL'  
 END  
  
DECLARE  
 @SHAREDB VARCHAR(255),  
 @OWNERTBL VARCHAR(255),  
 @SQL VARCHAR(8000)  
SELECT @SHAREDB = SHAREDB FROM MULTICOMPANY WHERE EXCHANGE = @EXCHANGE AND SEGMENT = @SEGMENT  
IF @@ROWCOUNT = 0  
 BEGIN  
  INSERT INTO #OWNERINFORMATION (COMPANY, ADDR1, ADDR2, PHONE, FAX, ZIP, CITY, MEMBERCODE, BROKERSEBIREGNO, DPID, DPCLTID, CMBPID, COMPPAN, COMPMAIL,STATE)  
  SELECT COMPANY, ADDR1, ADDR2, PHONE, FAX, ZIP, CITY, MEMBERCODE, BROKERSEBIREGNO, DPID = '', DPCLTID = '', CMBPID = '', PANNO, EMAIL,STATE FROM MSAJAG.dbo.OWNER  
  UPDATE #OWNERINFORMATION SET DPID = D.DPID, DPCLTID = D.DPCLTNO  
  FROM MSAJAG.dbo.DELIVERYDP D WHERE D.DPTYPE = 'NSDL' AND D.DESCRIPTION LIKE '%POOL%'  
  UPDATE #OWNERINFORMATION SET CMBPID = D.NSECMBPID  
  FROM MSAJAG.dbo.DELSEGMENT  
  SELECT COMPANY, ADDR1, ADDR2, PHONE, FAX, ZIP, CITY, MEMBERCODE, BROKERSEBIREGNO, DPID, DPCLTID, CMBPID, COMPPAN, COMPMAIL,STATE FROM #OWNERINFORMATION  
  RETURN  
 END  
IF (@EXCHANGE = 'NSE' OR @EXCHANGE = 'BSE') AND (@SEGMENT = 'CAPITAL' OR @SEGMENT = 'MFSS')  
 BEGIN  
  SET @OWNERTBL = 'OWNER'  
 END  
ELSE  
 BEGIN  
  SET @OWNERTBL = 'FOOWNER' 
 END  
SET @SQL = "INSERT INTO #OWNERINFORMATION (COMPANY, ADDR1, ADDR2, PHONE, FAX, ZIP, CITY, MEMBERCODE, BROKERSEBIREGNO, DPID, DPCLTID, CMBPID, COMPPAN, COMPMAIL,STATE) "  
SET @SQL = @SQL + "SELECT COMPANY, ADDR1, ADDR2, PHONE, " + CASE WHEN @OWNERTBL = 'FOOWNER' THEN 'FAX='''', ' ELSE 'FAX, ' END + "ZIP, CITY, MEMBERCODE, BROKERSEBIREGNO, DPID = '', DPCLTID = '', CMBPID = '', PANNO, EMAIL,STATE FROM " + @SHAREDB + ".dbo." + @OWNERTBL  
PRINT @SQL  
EXEC(@SQL)  
  
SET @SQL = "UPDATE #OWNERINFORMATION SET DPID = D.DPID, DPCLTID = D.DPCLTNO "  
SET @SQL = @SQL + "FROM " + @SHAREDB + ".dbo.DELIVERYDP D WHERE D.DPTYPE = 'NSDL' AND D.DESCRIPTION LIKE '%POOL%'"  
  
EXEC(@SQL)  
  
IF (@EXCHANGE = 'NSE' OR @EXCHANGE = 'BSE') AND @SEGMENT = 'CAPITAL'  
 BEGIN  
  SET @SQL = "UPDATE #OWNERINFORMATION SET CMBPID = D." + @EXCHANGE + "CMBPID "  
  SET @SQL = @SQL + "FROM " + @SHAREDB + ".dbo.DELSEGMENT D"  
  EXEC(@SQL)  
 END  
SELECT COMPANY, ADDR1, ADDR2, PHONE, FAX, ZIP, CITY, MEMBERCODE, BROKERSEBIREGNO, DPID, DPCLTID, CMBPID, COMPPAN, COMPMAIL,STATE FROM #OWNERINFORMATION  
DROP TABLE #OWNERINFORMATION

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_GETAGREEMENTDATA
-- --------------------------------------------------
--EXEC PROC_GETAGREEMENTDATA 'MUBARIK'
CREATE PROCEDURE [dbo].[PROC_GETAGREEMENTDATA]
	@CL_CODE VARCHAR(10)
AS
BEGIN
	DECLARE @@TODATE DATETIME
	
	IF(MONTH(GETDATE()) < 3)
       SET @@TODATE=CONVERT(DATETIME,('31 MAR'+ CONVERT(VARCHAR(11),(YEAR(GETDATE())))))
	ELSE
	   SET @@TODATE=CONVERT(DATETIME,('31 MAR'+ CONVERT(VARCHAR(11),CONVERT(INT, YEAR(GETDATE()))+1)))

	SELECT CL_CODE,AGREE_FLAG,AGREED_DATE,INCOME_SLAB,INCOME_SLAB_ENTERED_DATE,
		   AGREED_EXCH_SEGMENTS,EXCH_SEGMENTS_ENTERED_DATE,AGREEMENT_FROM,AGREEMENT_TO
	FROM CLIENT_AGREEMENT_DATA 
	WHERE CL_CODE=@CL_CODE AND AGREEMENT_TO=@@TODATE
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.PROC_INSERTUPDATE
-- --------------------------------------------------
--exec PROC_INSERTUPDATE @TAB='T1',@CL_CODE='0a141',@AGREE_FLAG=1,@INCOME_SLAB='',@AGREED_EXCH_SEGMENTS='',@AGREEMENT_COMPLETION_FLAG=0
CREATE PROCEDURE [dbo].[PROC_INSERTUPDATE]
	@TAB VARCHAR(3),
	@CL_CODE VARCHAR(10),
	@AGREE_FLAG VARCHAR(1),
	@INCOME_SLAB VARCHAR(50),
	@AGREED_EXCH_SEGMENTS VARCHAR(300),
	@AGREEMENT_COMPLETION_FLAG VARCHAR(1)
AS
BEGIN
	DECLARE @@TODATE DATETIME
	
	IF(MONTH(GETDATE()) < 3)
       SET @@TODATE=CONVERT(DATETIME,('31 MAR'+ CONVERT(VARCHAR(11),(YEAR(GETDATE())))))
	ELSE
	   SET @@TODATE=CONVERT(DATETIME,('31 MAR'+ CONVERT(VARCHAR(11),CONVERT(INT, YEAR(GETDATE()))+1)))
		

	IF NOT EXISTS(SELECT CL_CODE FROM CLIENT_AGREEMENT_DATA WHERE CL_CODE=@CL_CODE AND AGREEMENT_TO=@@TODATE )
      BEGIN
		IF @TAB='T1'
			INSERT INTO CLIENT_AGREEMENT_DATA (CL_CODE,AGREE_FLAG,AGREED_DATE,AGREEMENT_FROM,AGREEMENT_TO) VALUES(@CL_CODE,@AGREE_FLAG,GETDATE(),GETDATE(),@@TODATE)
		ELSE IF @TAB='T2'
			INSERT INTO CLIENT_AGREEMENT_DATA (CL_CODE,INCOME_SLAB,INCOME_SLAB_ENTERED_DATE,AGREEMENT_FROM,AGREEMENT_TO) VALUES(@CL_CODE,@INCOME_SLAB,GETDATE(),GETDATE(),@@TODATE)
		ELSE
			INSERT INTO CLIENT_AGREEMENT_DATA (CL_CODE,AGREED_EXCH_SEGMENTS,EXCH_SEGMENTS_ENTERED_DATE,AGREEMENT_FROM,AGREEMENT_TO) VALUES(@CL_CODE,@AGREED_EXCH_SEGMENTS,GETDATE(),GETDATE(),@@TODATE)
		
      END
	ELSE
	  BEGIN
		IF @TAB='T1'
		BEGIN
			UPDATE CLIENT_AGREEMENT_DATA SET AGREE_FLAG=@AGREE_FLAG,AGREED_DATE=GETDATE(),AGREEMENT_FROM=GETDATE() WHERE CL_CODE=@CL_CODE AND AGREEMENT_TO=@@TODATE
		END
		ELSE IF @TAB='T2'
		BEGIN
			UPDATE CLIENT_AGREEMENT_DATA SET INCOME_SLAB=@INCOME_SLAB,INCOME_SLAB_ENTERED_DATE=GETDATE(),AGREEMENT_FROM=GETDATE() WHERE CL_CODE=@CL_CODE AND AGREEMENT_TO=@@TODATE
		END
		ELSE
		BEGIN
			UPDATE CLIENT_AGREEMENT_DATA SET AGREED_EXCH_SEGMENTS=@AGREED_EXCH_SEGMENTS,EXCH_SEGMENTS_ENTERED_DATE=GETDATE(),AGREEMENT_FROM=GETDATE() WHERE CL_CODE=@CL_CODE AND AGREEMENT_TO=@@TODATE
		END
		
			UPDATE CLIENT_AGREEMENT_DATA SET AGREEMENT_COMPLETION_FLAG	= 1 WHERE CL_CODE=@CL_CODE AND AGREE_FLAG <> 0 AND ISNULL(INCOME_SLAB,'') <> '' AND ISNULL(AGREED_EXCH_SEGMENTS,'') <> ''
		
	  END
	
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_ClientListDetails
-- --------------------------------------------------

--EXEC Rpt_ClientListDetails '',''
--Created By Piyush
CREATE PROCEDURE [dbo].[Rpt_ClientListDetails]
(
   @CLTDPID varchar(16),
   @DPID varchar(16)
)
AS
SELECT 
		SETT_TYPE,
		SETT_NO,
		PARTY_CODE,
		SCRIP_CD,
		ISIN,
		QTY,
		DPTYPE,
		DPID,
        TRANSNO,
		TRANSDATE=CONVERT(VARCHAR,TRANSDATE,103) 
FROM 
		MSAJAG.DBO.DELTHIRDPARTYCLTID 
WHERE 
		CLTDPID= @CLTDPID  
		AND  DPID = @DPID

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSEDELHOLDPARTY_DETAIL
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_NSEDELHOLDPARTY_DETAIL]
	@SCRIP_CD VARCHAR(20),  
	@SERIES VARCHAR(3),
	@SETT_NO VARCHAR(7),  
	@SETT_TYPE VARCHAR(2),
	@PARTY_CODE VARCHAR(10),  
	@BDPID VARCHAR(8),
	@BCLTDPID VARCHAR(16)
	
AS
/*
EXEC RPT_NSEDELHOLDPARTY_DETAIL @SCRIP_CD='AARTIIND',@series= 'EQ',@sett_no = '2004046',@sett_type = 'N',@Party_Code ='001A000001',@BDpId = '12010900',@BCltDpId = '1201090000011183'
*/
BEGIN
	SELECT 
		SETT_NO, 
		SETT_TYPE, 
		TCODE, 
		PARTY_CODE, 
		D.SCRIP_CD, 
		D.SERIES, 
		SCHEME_NAME,
		QTY,
		TRANSNO = FOLIONO, 
		DRCR, 
		CONVERT(VARCHAR(11),TRANSDATE,106) AS TRANSDATE,
		REASON,
		CLTDPID,
		DPID  
	FROM 
		BSEMFSS.DBO.DELTRANS D, BSEMFSS.DBO.MFSS_SCRIP_MASTER M
	WHERE 
		D.SCRIP_CD = @SCRIP_CD 
		AND D.SERIES= @SERIES 
		AND SETT_NO = @SETT_NO 
		AND SETT_TYPE = @SETT_TYPE  
		AND DRCR = 'D' 
		AND PARTY_CODE =@PARTY_CODE 
		AND BDPID = @BDPID 
		AND BCLTDPID = @BCLTDPID  
		AND FILLER2 = 1 
        AND DELIVERED = '0' 
		AND TRTYPE <> 907 
		AND D.SCRIP_CD = M.SCRIP_CD
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_NSEDELINTERSETTDATE
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_NSEDELINTERSETTDATE]
(	
	@FROMDATE VARCHAR(11),
	@TODATE VARCHAR(11)
)
AS
/*
EXEC CLASSAPP.DBO.RPT_NSEDELINTERSETTDATE @FROMDATE='Mar 24 2005', @TODATE='Jul 24 2009'
*/
SET DATEFORMAT DMY
BEGIN  
	SELECT 
		TRDATE=CONVERT(VARCHAR,TRANSDATE,106),
		TRANSDATE,
		(SETT_NO + ' - ' + SETT_TYPE) AS SETT_NO,
		(ISETT_NO + ' - ' + ISETT_TYPE) AS ISETT_NO,
		D.SCRIP_CD,
		CERTNO,QTY=SUM(QTY),
		D.PARTY_CODE,
		C1.LONG_NAME 
	FROM 
		MSAJAG.DBO.DELTRANS D, 
		MSAJAG.DBO.DELIVERYDP DP, 
		MSAJAG.DBO.CLIENT2 C2, 
		MSAJAG.DBO.CLIENT1 C1  
	WHERE 
		TRTYPE = 907 
		AND FILLER2 = 1 
		AND DRCR = 'D' 
		AND C1.CL_CODE = C2.CL_CODE 
		AND C2.PARTY_CODE = D.PARTY_CODE 
		AND D.BDPID = DP.DPID 
		AND D.BCLTDPID = DP.DPCLTNO 
		AND DESCRIPTION LIKE '%POOL%' 
		AND DP.DPTYPE = 'NSDL'  
		AND TRANSDATE >= @FROMDATE 
		AND TRANSDATE <= @TODATE 
	GROUP BY 
		TRANSDATE,
		SETT_NO,
		SETT_TYPE,
		ISETT_NO,
		ISETT_TYPE,
		D.SCRIP_CD,
		CERTNO,
		D.PARTY_CODE,
		C1.LONG_NAME  
	ORDER BY 
		TRANSDATE,
		SETT_NO,
		SETT_TYPE,
		ISETT_NO,
		ISETT_TYPE,
		D.SCRIP_CD,
		CERTNO,
		D.PARTY_CODE 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Rpt_ProbableShortage
-- --------------------------------------------------

--EXEC Rpt_ProbableShortage '0A141','0A141','BROKER','BROKER'
--Created By Piyush
CREATE PROCEDURE [dbo].[Rpt_ProbableShortage]
(
	@FROMPARTY VARCHAR(10),
	@TOPARTY VARCHAR(10),
	@STATUSID VARCHAR(25),
	@STATUSNAME  VARCHAR(25)
)
AS
BEGIN
	EXEC BSEMFSS.DBO.INSDELACCCHECKVDT @FROMPARTY,@TOPARTY
	CREATE TABLE #PROBABLESHORTAGE
	(
		SRNO INT IDENTITY(1,1),
		SETT_NO VARCHAR(7),
		SETT_TYPE VARCHAR(50),
		PARTY_CODE VARCHAR(10),
		LONG_NAME VARCHAR(100),
		SCRIPNAME VARCHAR(12),
		SCRIP_CD VARCHAR(12),
		SERIES VARCHAR(3),
		QTY NUMERIC(18,0),
		ISIN VARCHAR(20),
		EXCHG VARCHAR(3),
		SCRIPCODE VARCHAR(12),
		SHORTQTY NUMERIC(18,2),
		DPID VARCHAR(8),
		CLTDPID VARCHAR(16),
		POAFLAG NUMERIC(10,0),
		YY VARCHAR(4),
		MM VARCHAR(4),
		STATUS VARCHAR(10),
		AMOUNT NUMERIC(18,2),
		BRANCH_CD VARCHAR(15),
		COMPANYNAME VARCHAR(50),
        TDATE VARCHAR(11),
		AMTLABLE VARCHAR(100)
	)
	INSERT INTO #PROBABLESHORTAGE
	(
		SETT_NO,
		SETT_TYPE,
		PARTY_CODE,
		LONG_NAME,
		SCRIPNAME,
		SCRIP_CD,
		SERIES,	
		QTY,
		ISIN,
		EXCHG,
		SCRIPCODE,
		SHORTQTY,
		DPID,
		CLTDPID,
		POAFLAG,
		YY,
		MM,
		STATUS,
		AMOUNT,
		BRANCH_CD
	)
	SELECT 
		SETT_NO,
		SETT_TYPE,
		D.PARTY_CODE,
		C1.LONG_NAME,
		SCRIPNAME,
		SCRIP_CD,		
		SERIES,
		QTY,
		ISIN,
		EXCHG,	
		SCRIPCODE,
		SHORTQTY=TORECQTY-BALANCE,
		DPID,
		CLTDPID,
		POAFLAG,
		YY=YEAR(START_DATE),
		MM=MONTH(START_DATE),
		STATUS, 
		AMOUNT= ISNULL(AMOUNT,0),
		C1.BRANCH_CD 
	FROM	
		BSEMFSS.DBO.CLIENT1 C1, 
		BSEMFSS.DBO.CLIENT2 C2, 
		BSEMFSS.DBO.DELPOASHORTAGE D 
				LEFT OUTER JOIN BSEMFSS.DBO.DELACCBALANCE A  
		ON (CLTCODE = D.PARTY_CODE )  
	WHERE	
		C1.CL_CODE = C2.CL_CODE 
		AND C2.PARTY_CODE = D.PARTY_CODE  
		AND D.PARTY_CODE >= @FROMPARTY 
		AND D.PARTY_CODE <= @TOPARTY 
		AND TORECQTY > BALANCE 
		AND C1.BRANCH_CD LIKE '%' 
		AND D.SETT_TYPE NOT IN ('AD','AC','A','X') 
		AND @STATUSNAME =(CASE WHEN @STATUSID = 'BRANCH' THEN C1.BRANCH_CD	
							WHEN @STATUSID = 'SUBBROKER' THEN C1.SUB_BROKER 
							WHEN @STATUSID = 'TRADER' THEN C1.TRADER     
							WHEN @STATUSID = 'FAMILY' THEN C1.FAMILY                         
							WHEN @STATUSID = 'CLIENT' THEN C2.PARTY_CODE ELSE 'BROKER' END) 
	ORDER BY 
		D.PARTY_CODE,
		EXCHG DESC,
		SETT_NO,
		SETT_TYPE,
		SCRIPNAME

UPDATE 
	#PROBABLESHORTAGE 
SET 
	CLTDPID	  =  CASE WHEN EXCHG = 'BSE' AND POAFLAG = 0 THEN (SELECT BSECMBPID FROM MSAJAG.DBO.DELSEGMENT) 
				ELSE CASE WHEN EXCHG = 'NSE' THEN (SELECT NSECMBPID FROM MSAJAG.DBO.DELSEGMENT)  END END,
    SETT_TYPE =	CASE WHEN POAFLAG = 1 AND EXCHG = 'BSE' AND SETT_TYPE = 'N' THEN 'NR' 
				     WHEN POAFLAG = 1 AND EXCHG = 'BSE' AND SETT_TYPE = 'A' THEN 'NA' 
					 WHEN POAFLAG = 1 AND EXCHG = 'BSE' AND SETT_TYPE = 'D' THEN 'RM' 
					 WHEN POAFLAG = 1 AND EXCHG = 'BSE' AND SETT_TYPE = 'C' THEN 'TT' 
					 WHEN POAFLAG = 1 AND EXCHG = 'BSE' AND SETT_TYPE = 'AD' THEN 'RA'  
				ELSE CASE WHEN SETT_TYPE = 'N' THEN 'Normal'
					 WHEN SETT_TYPE = 'A' THEN 'Auction Normal' 	
					 WHEN SETT_TYPE = 'X' THEN 'Auction Rolling MKT LOT'
					 WHEN SETT_TYPE = 'D' THEN 'Rolling MKT LOT' 
				     WHEN SETT_TYPE = 'C' THEN 'T 2 T'
			         WHEN SETT_TYPE = 'AD' THEN 'Auction Rolling MKT LOT'  END END,
    COMPANYNAME = (SELECT UPPER(LTRIM(RTRIM(COMPANY))) FROM MSAJAG.DBO.OWNER),
	TDATE = (SELECT CONVERT(VARCHAR(11),GETDATE(),103)),
	SETT_NO = CASE WHEN POAFLAG = 0 AND EXCHG = 'BSE' THEN SETT_NO
			  ELSE CASE WHEN MM < 4 THEN '0' + (LEN(RIGHT(YY,2))-1) + RIGHT(YY,2) + RIGHT(SETT_NO,3)
						WHEN MM > 4 THEN RIGHT(YY,2) + '0' + (LEN(RIGHT(YY,2))+1) + RIGHT(SETT_NO,3)
			  ELSE CASE WHEN POAFLAG = 1 AND EXCHG = 'BSE' THEN SETT_NO
			  ELSE CASE WHEN SETT_NO >= '2003001' AND MM < 4 THEN 	'0' + (LEN(RIGHT(YY,2))-1) + RIGHT(YY,2) + RIGHT(SETT_NO,3)			
					    WHEN SETT_NO < '2003001' AND MM > 4 THEN  RIGHT(YY,2) + '0' + (LEN(RIGHT(YY,2))+1) + RIGHT(SETT_NO,3)
			   END END END END,
	AMTLABLE=CASE WHEN AMOUNT > 0 THEN ' Ledger Credit Balance as on Date = ' ELSE ' Ledger Debit Balance as on Date = ' END

SELECT * FROM #PROBABLESHORTAGE
DROP TABLE #PROBABLESHORTAGE
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.RPT_SETTYPE_DELCLT
-- --------------------------------------------------

CREATE PROC [dbo].[RPT_SETTYPE_DELCLT] 

	@SETT_TYPE VARCHAR(2)
AS
/*
	EXEC RPT_SETTYPE_DELCLT ''
	EXEC RPT_SETTYPE_DELCLT 'W'
*/
BEGIN
	IF @SETT_TYPE='' 
		BEGIN
			SELECT DISTINCT 
				SETT_TYPE 
			FROM 
				BSEMFSS..DELIVERYCLT 
			ORDER BY 
				SETT_TYPE
		END
	ELSE IF @SETT_TYPE <>'' 
		BEGIN
			SELECT DISTINCT 
				SETT_NO  
			FROM 
				BSEMFSS..DELIVERYCLT 
			WHERE 
				SETT_TYPE=@SETT_TYPE 
			ORDER BY 
				SETT_NO DESC
		END
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Sp_Update_delBranchMark
-- --------------------------------------------------
--CREATED BY PIYUSH
CREATE PROCEDURE [dbo].[Sp_Update_delBranchMark]
(
	@SETT_NO VARCHAR(7),
	@SETT_TYPE VARCHAR(3),
	@PARTY_CODE VARCHAR(10),
	@SCRIP_CD VARCHAR(30),
	@SERIES VARCHAR(3),
	@CERTNO VARCHAR(20),
	@DPTYPE VARCHAR(20),
	@DPID VARCHAR(20),
	@CLTDPID VARCHAR(25),
	@UNAME VARCHAR(100),
	@DELQTY NUMERIC(18,0),
	@PAYOUTQTY NUMERIC(18,0),
	@APROVED INT
)
AS
IF(@APROVED > 0)
	BEGIN
		UPDATE 
				MSAJAG.DBO.DELBRANCHMARK 
		SET 
				APROVED = 1,APROVEDDATE=GETDATE(),APROVEDBY=@UNAME
		WHERE 
				SETT_NO = @SETT_NO
				AND SETT_TYPE = @SETT_TYPE 
				AND PARTY_CODE = @PARTY_CODE
				AND SCRIP_CD = @SCRIP_CD 
				AND CERTNO = @CERTNO
				AND DPTYPE = @DPTYPE 
				AND DPID = @DPID
				AND CLTDPID = @CLTDPID 
				AND APROVED = 0 

		EXEC MSAJAG.DBO.RPT_NSEDELBRANCHMARK @SETT_NO,@SETT_TYPE,@PARTY_CODE
	END

ELSE IF @DELQTY > 0 AND @DELQTY <= @PAYOUTQTY
BEGIN
	SELECT * FROM 
			MSAJAG.DBO.DELBRANCHMARK 
	WHERE 
			SETT_NO = @SETT_NO
			AND SETT_TYPE = @SETT_TYPE AND PARTY_CODE = @PARTY_CODE
			AND SCRIP_CD = @SCRIP_CD AND CERTNO = @CERTNO
			AND DPTYPE = @DPTYPE AND DPID = @DPID
			AND CLTDPID = @CLTDPID AND APROVED = 0

	IF(@@ROWCOUNT > 0)
		BEGIN
			UPDATE 
				MSAJAG.DBO.DELBRANCHMARK 
			SET 
				DELMARKQTY = '' 
			WHERE 
				SETT_NO = @SETT_NO
				AND SETT_TYPE = @SETT_TYPE AND PARTY_CODE = @PARTY_CODE
				AND SCRIP_CD = @SCRIP_CD AND CERTNO = @CERTNO
				AND DPTYPE = @DPTYPE AND DPID = @DPID
				AND CLTDPID = @CLTDPID AND APROVED = 0
		END
	ELSE
		BEGIN
			INSERT INTO 
					MSAJAG.DBO.DELBRANCHMARK 
			VALUES
					(@SETT_NO,@SETT_TYPE,@PARTY_CODE,@SCRIP_CD,
					 @SERIES,@CERTNO,@DPTYPE,@DPID,@CLTDPID,@PAYOUTQTY,@DELQTY,'0','0',
					 GETDATE(),@UNAME,'','')
		END
END

ELSE IF @DELQTY = 0
	BEGIN
			SELECT * FROM 
				MSAJAG.DBO.DELBRANCHMARK 
			WHERE 
				SETT_NO = @SETT_NO
				AND SETT_TYPE = @SETT_TYPE AND PARTY_CODE = @PARTY_CODE
				AND SCRIP_CD = @SCRIP_CD AND CERTNO = @CERTNO
				AND DPTYPE = @DPTYPE AND DPID = @DPID
				AND CLTDPID = @CLTDPID AND APROVED = 0 

    IF(@@ROWCOUNT > 0)
		BEGIN
			DELETE FROM 
				MSAJAG.DBO.DELBRANCHMARK 
			WHERE 
				SETT_NO = SETT_NO
				AND SETT_TYPE = @SETT_TYPE AND PARTY_CODE = @PARTY_CODE
				AND SCRIP_CD = @SCRIP_CD AND CERTNO = @CERTNO
				AND DPTYPE = @DPTYPE AND DPID = @DPID
				AND CLTDPID = @CLTDPID AND APROVED = 0 
		END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.TEST
-- --------------------------------------------------
CREATE PROCEDURE TEST
(
	@SETT_NO VARCHAR(7),
	@SETT_TYPE VARCHAR(3),
	@PARTY_CODE VARCHAR(10),
	@SCRIP_CD VARCHAR(16),
	@SERIES VARCHAR(3),
	@CERTNO VARCHAR(16),
	@DPTYPE VARCHAR(16),
	@DPID VARCHAR(16),
	@CLTDPID VARCHAR(16),
	@UNAME VARCHAR(100),
	@DELQTY NUMERIC(18,0),
	@PAYOUTQTY NUMERIC(18,0),
	@APROVED INT
)
AS
IF(@APROVED > 0)
	BEGIN
		UPDATE 
				MSAJAG.DBO.DELBRANCHMARK 
		SET 
				APROVED = 1,APROVEDDATE=GETDATE(),APROVEDBY=@UNAME
		WHERE 
				SETT_NO = @SETT_NO
				AND SETT_TYPE = @SETT_TYPE 
				AND PARTY_CODE = @PARTY_CODE
				AND SCRIP_CD = @SCRIP_CD 
				AND CERTNO = @CERTNO
				AND DPTYPE = @DPTYPE 
				AND DPID = @DPID
				AND CLTDPID = @CLTDPID 
				AND APROVED = 0 

		EXEC MSAJAG.DBO.RPT_NSEDELBRANCHMARK @SETT_NO,@SETT_TYPE,@PARTY_CODE
	END

ELSE IF @DELQTY > 0 AND @DELQTY <= @PAYOUTQTY
BEGIN
	SELECT * FROM 
			MSAJAG.DBO.DELBRANCHMARK 
	WHERE 
			SETT_NO = @SETT_NO
			AND SETT_TYPE = @SETT_TYPE AND PARTY_CODE = @PARTY_CODE
			AND SCRIP_CD = @SCRIP_CD AND CERTNO = @CERTNO
			AND DPTYPE = @DPTYPE AND DPID = @DPID
			AND CLTDPID = @CLTDPID AND APROVED = 0

	IF(@@ROWCOUNT != 0)
		BEGIN
			UPDATE 
				MSAJAG.DBO.DELBRANCHMARK 
			SET 
				DELMARKQTY = '' 
			WHERE 
				SETT_NO = @SETT_NO
				AND SETT_TYPE = @SETT_TYPE AND PARTY_CODE = @PARTY_CODE
				AND SCRIP_CD = @SCRIP_CD AND CERTNO = @CERTNO
				AND DPTYPE = @DPTYPE AND DPID = @DPID
				AND CLTDPID = @CLTDPID AND APROVED = 0
		END
	ELSE
		BEGIN
			INSERT INTO 
					MSAJAG.DBO.DELBRANCHMARK 
			VALUES
					(@SETT_NO,@SETT_TYPE,@PARTY_CODE,@SCRIP_CD,
					 @SERIES,@CERTNO,@DPTYPE,@DPID,@CLTDPID,@PAYOUTQTY,@DELQTY,'0','0',
					GETDATE(),@UNAME,'','')
		END
END

ELSE IF @DELQTY = 0
	BEGIN
			SELECT * FROM 
				MSAJAG.DBO.DELBRANCHMARK 
			WHERE 
				SETT_NO = @SETT_NO
				AND SETT_TYPE = @SETT_TYPE AND PARTY_CODE = @PARTY_CODE
				AND SCRIP_CD = @SCRIP_CD AND CERTNO = @CERTNO
				AND DPTYPE = @DPTYPE AND DPID = @DPID
				AND CLTDPID = @CLTDPID AND APROVED = 0 

    IF(@@ROWCOUNT != 0)
		BEGIN
			DELETE FROM 
				MSAJAG.DBO.DELBRANCHMARK 
			WHERE 
					SETT_NO = SETT_NO
					AND SETT_TYPE = @SETT_TYPE AND PARTY_CODE = @PARTY_CODE
					AND SCRIP_CD = @SCRIP_CD AND CERTNO = @CERTNO
					AND DPTYPE = @DPTYPE AND DPID = @DPID
					AND CLTDPID = @CLTDPID AND APROVED = 0 
		END
	END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.USP_GETREPORTSET
-- --------------------------------------------------
CREATE PROC [dbo].[USP_GETREPORTSET]
(
	@REPORTCODE VARCHAR(10),
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25)
)
AS
/*  select * from REPORTLINKS_NEW
	exec [USP_GETREPORTSET] 'R000000001', 'BROKER', 'BROKER'
	CBO_GETREPORTSET 'A00004', 'BROKER', 'BROKER'
	CBO_GETREPORTSET '', 'BROKER', 'BROKER'
	CBO_SAUDAREPORT_WITHOUTCLIENT
	select * from REPORTFORMULATION_NEW where RF_REPORT_CODE = 'D00002' AND RF_FORMULA_FIELD = 'PVALUE'
	select * from REPORTFORMULATION_NEW where RF_REPORT_CODE = 'D00002' AND RF_FORMULA_FIELD = 'OPENPOSTIONQTY'
	EXEC Proc_Newbasicreport 

*/
SET NOCOUNT ON
DECLARE
	@CHARTCODE VARCHAR(10)
SELECT
	RM_SR_NO = ISNULL(RM_SR_NO, 0),
	RM_REPORT_CODE = ISNULL(RM_REPORT_CODE, ''),
	RM_REPORT_DESCRIPTION = ISNULL(RM_REPORT_DESCRIPTION, ''),
	RM_PAGE_LENGTH = ISNULL(RM_PAGE_LENGTH, 60),
	RM_PAGE_WIDTH = ISNULL(RM_PAGE_WIDTH, 80),
	RM_HAS_HEADER = ISNULL(RM_HAS_HEADER, 0),
	RM_HAS_FOOTER = ISNULL(RM_HAS_FOOTER, 0),
	RM_ISPLAIN = ISNULL(RM_ISPLAIN, 0),
	RM_ISGROUPING = ISNULL(RM_ISGROUPING, 0),
	RM_MAINTBLSTYLE = ISNULL(RM_MAINTBLSTYLE, ''),
	RM_PROCNAME = ISNULL(RM_PROCNAME, ''),
	RM_PARAMS = ISNULL(RM_PARAMS, ''),
	RM_PARATYPE = ISNULL(RM_PARATYPE, ''),
	RM_PARAMSIZE = ISNULL(RM_PARAMSIZE, ''),
	RM_PARAMDIRECT = ISNULL(RM_PARAMDIRECT, ''),
	RM_ISPAGINATED = ISNULL(RM_ISPAGINATED, 0),
	RM_PAGE_PROCNAME = ISNULL(RM_PAGE_PROCNAME, ''),
	RM_PAGE_PARAMS = ISNULL(RM_PAGE_PARAMS, ''),
	RM_PAGE_PARATYPE = ISNULL(RM_PAGE_PARATYPE, ''),
	RM_PAGE_PARAMSIZE = ISNULL(RM_PAGE_PARAMSIZE, ''),
	RM_PAGE_PARAMDIRECT = ISNULL(RM_PAGE_PARAMDIRECT, ''),
	RM_PAGE_PARAMPOSITION = ISNULL(RM_PAGE_PARAMPOSITION, ''),
	RM_PAGE_PARAMLOCATION = ISNULL(RM_PAGE_PARAMLOCATION, ''),
	RM_PRINTCOMPANYNAME = ISNULL(RM_PRINTCOMPANYNAME, 0),
	RM_PRINTCOMPANYADDRESS = ISNULL(RM_PRINTCOMPANYADDRESS, 0),
	RM_ISINTERNAL = ISNULL(RM_ISINTERNAL, 0),
	RM_REPEATPAGEHEADER = ISNULL(RM_REPEATPAGEHEADER, 0),
	RM_CHARTCODE = ISNULL(RM_CHARTCODE, '')
FROM
	REPORTMASTER_NEW
WHERE
	RM_REPORT_CODE = CASE WHEN (@REPORTCODE = '%' OR @REPORTCODE = '' OR @REPORTCODE = 'ALL') THEN RM_REPORT_CODE ELSE @REPORTCODE END
	AND RM_ISINTERNAL = CASE WHEN (@REPORTCODE = '%' OR @REPORTCODE = '' OR @REPORTCODE = 'ALL') THEN 0 ELSE RM_ISINTERNAL END
ORDER BY
	RM_REPORT_DESCRIPTION
IF (@REPORTCODE = '%' OR @REPORTCODE = '' OR @REPORTCODE = 'ALL')
	RETURN
SELECT
	RD_SR_NO = ISNULL(RD_SR_NO, 0),
	RD_REPORT_CODE = ISNULL(RD_REPORT_CODE, ''),
	RD_REPORT_FLD = ISNULL(RD_REPORT_FLD, ''),
	RD_MAPPED_FLD = ISNULL(RD_MAPPED_FLD, ''),
	RD_FIELD_LABEL = ISNULL(RD_FIELD_LABEL, ''),
	RD_FIELD_DESCRIPTION = ISNULL(RD_FIELD_DESCRIPTION, ''),
	RD_FIELD_XPOSITION = ISNULL(RD_FIELD_XPOSITION, 1),
	RD_FIELD_YPOSITION = ISNULL(RD_FIELD_YPOSITION, 1),
	RD_FIELD_WIDTH = ISNULL(RD_FIELD_WIDTH, 10),
	RD_WRAPTEXT = ISNULL(RD_WRAPTEXT, 0),
	RD_WRAPLINES = ISNULL(RD_WRAPLINES, 0),
	RD_FIELD_ALLIGN = ISNULL(RD_FIELD_ALLIGN, 'L'),
	RD_ISDISPLAYED = ISNULL(RD_ISDISPLAYED, 1),
	RD_ISPRINTABLE = ISNULL(RD_ISPRINTABLE, 1),
	RD_ISEXPORTABLE = ISNULL(RD_ISEXPORTABLE, 1),
	RD_FIELD_ROUNDING = ISNULL(RD_FIELD_ROUNDING, 0),
	RD_ROUNDING_STYLE = ISNULL(RD_ROUNDING_STYLE, 0),
	RD_REPORT_SECTION = ISNULL(RD_REPORT_SECTION, 'D'),
	RD_ISCOMPULSORY = ISNULL(RD_ISCOMPULSORY, 1),
	RD_FORECOLOR = ISNULL(RD_FORECOLOR, ''),
	RD_BLACKCOLOR = ISNULL(RD_BLACKCOLOR, ''),
	RD_BOLD = ISNULL(RD_BOLD, 0),
	RD_UNDERLINE = ISNULL(RD_UNDERLINE, 0),
	RD_ISFORMULAFIELD = ISNULL(RD_ISFORMULAFIELD, 0),
	RD_LABLE_COLUMNSPAN = ISNULL(RD_LABLE_COLUMNSPAN, 1),
	RD_VALUE_COLUMNSPAN = ISNULL(RD_VALUE_COLUMNSPAN, 1),
	RD_CSSCLASS = ISNULL(RD_CSSCLASS, ''),
	RD_STYLEELEMENT = ISNULL(RD_STYLEELEMENT, ''),
	RD_HEADER_CSSCLASS = ISNULL(RD_HEADER_CSSCLASS, ''),
	RD_HEADER_STYLEELEMENT = ISNULL(RD_HEADER_STYLEELEMENT, ''),
	RD_ISAGGREGATE = ISNULL(RD_ISAGGREGATE, 0),
	RD_ISDRILLDOWN = ISNULL(RD_ISDRILLDOWN, 0),
	RD_ISNOHEADER = ISNULL(RD_ISNOHEADER, 0),
	RD_SPLFIELD = ISNULL(RD_SPLFIELD, ''),
	RD_FIELDID = ISNULL(RD_FIELDID, ''),
	RD_LABLEID = ISNULL(RD_LABLEID, '')
FROM
	REPORTDETAILS_NEW
WHERE
	RD_REPORT_CODE = @REPORTCODE
	AND RD_REPORT_SECTION = 'D'
ORDER BY
	RD_REPORT_SECTION,
	RD_FIELD_YPOSITION,
	RD_FIELD_XPOSITION

SELECT
	RD_SR_NO = ISNULL(RD_SR_NO, 0),
	RD_REPORT_CODE = ISNULL(RD_REPORT_CODE, ''),
	RD_REPORT_FLD = ISNULL(RD_REPORT_FLD, ''),
	RD_MAPPED_FLD = ISNULL(RD_MAPPED_FLD, ''),
	RD_FIELD_LABEL = ISNULL(RD_FIELD_LABEL, ''),
	RD_FIELD_DESCRIPTION = ISNULL(RD_FIELD_DESCRIPTION, ''),
	RD_FIELD_XPOSITION = ISNULL(RD_FIELD_XPOSITION, 1),
	RD_FIELD_YPOSITION = ISNULL(RD_FIELD_YPOSITION, 1),
	RD_FIELD_WIDTH = ISNULL(RD_FIELD_WIDTH, 10),
	RD_WRAPTEXT = ISNULL(RD_WRAPTEXT, 0),
	RD_WRAPLINES = ISNULL(RD_WRAPLINES, 0),
	RD_FIELD_ALLIGN = ISNULL(RD_FIELD_ALLIGN, 'L'),
	RD_ISDISPLAYED = ISNULL(RD_ISDISPLAYED, 1),
	RD_ISPRINTABLE = ISNULL(RD_ISPRINTABLE, 1),
	RD_ISEXPORTABLE = ISNULL(RD_ISEXPORTABLE, 1),
	RD_FIELD_ROUNDING = ISNULL(RD_FIELD_ROUNDING, 0),
	RD_ROUNDING_STYLE = ISNULL(RD_ROUNDING_STYLE, 0),
	RD_REPORT_SECTION = ISNULL(RD_REPORT_SECTION, 'D'),
	RD_ISCOMPULSORY = ISNULL(RD_ISCOMPULSORY, 1),
	RD_FORECOLOR = ISNULL(RD_FORECOLOR, ''),
	RD_BLACKCOLOR = ISNULL(RD_BLACKCOLOR, ''),
	RD_BOLD = ISNULL(RD_BOLD, 0),
	RD_UNDERLINE = ISNULL(RD_UNDERLINE, 0),
	RD_ISFORMULAFIELD = ISNULL(RD_ISFORMULAFIELD, 0),
	RD_LABLE_COLUMNSPAN = ISNULL(RD_LABLE_COLUMNSPAN, 1),
	RD_VALUE_COLUMNSPAN = ISNULL(RD_VALUE_COLUMNSPAN, 1),
	RD_CSSCLASS = ISNULL(RD_CSSCLASS, ''),
	RD_STYLEELEMENT = ISNULL(RD_STYLEELEMENT, ''),
	RD_HEADER_CSSCLASS = ISNULL(RD_HEADER_CSSCLASS, ''),
	RD_HEADER_STYLEELEMENT = ISNULL(RD_HEADER_STYLEELEMENT, ''),
	RD_ISAGGREGATE = ISNULL(RD_ISAGGREGATE, 0),
	RD_ISDRILLDOWN = ISNULL(RD_ISDRILLDOWN, 0),
	RD_SPLFIELD = ISNULL(RD_SPLFIELD, ''),
	RD_FIELDID = ISNULL(RD_FIELDID, ''),
	RD_LABLEID = ISNULL(RD_LABLEID, '')
FROM
	REPORTDETAILS_NEW
WHERE
	RD_REPORT_CODE = @REPORTCODE
	AND RD_REPORT_SECTION <> 'D'
	AND RD_REPORT_SECTION <> 'PH'
ORDER BY
	RD_REPORT_SECTION,
	RD_FIELD_YPOSITION,
	RD_FIELD_XPOSITION


SELECT
	RG_SRNO = ISNULL(RG_SRNO, 0),
	RG_REPORT_CODE = ISNULL(RG_REPORT_CODE, ''),
	RG_GROUP_FIELD = ISNULL(RG_GROUP_FIELD, ''),
	RG_GROUP_ORDER = ISNULL(RG_GROUP_ORDER, 0),
	RG_MAPPED_HEADER_SECTION = ISNULL(RG_MAPPED_HEADER_SECTION, ''),
	RG_MAPPED_FOOTER_SECTION = ISNULL(RG_MAPPED_FOOTER_SECTION, ''),
	RG_REPORT_HEADER = ISNULL(RG_REPORT_HEADER, 1),
	RG_REPPORT_FOOTER = ISNULL(RG_REPPORT_FOOTER, 1),
	RG_PAGEBREAK = ISNULL(RG_PAGEBREAK, 0)
FROM
	REPORT_GROUPING_NEW
WHERE
	RG_REPORT_CODE = @REPORTCODE
ORDER BY
	RG_GROUP_ORDER


SELECT
	RF_SR_NO,
	RF_REPORT_CODE = ISNULL(RF_REPORT_CODE, ''),
	RF_FORMULA_FIELD = ISNULL(RF_FORMULA_FIELD, ''),
	RF_FIELD_FORMULA = ISNULL(RF_FIELD_FORMULA, ''),
	RF_DIVISION = ISNULL(RF_DIVISION, '')
FROM
	REPORTFORMULATION_NEW
WHERE
	RF_REPORT_CODE = @REPORTCODE


SELECT
	RS_SRNO,
	RS_REPORT_CODE = ISNULL(RS_REPORT_CODE, ''),
	RS_REPORT_FLD = ISNULL(RS_REPORT_FLD, ''),
	RS_EXPRESSION = ISNULL(RS_EXPRESSION, ''),
	RS_OPERATION = ISNULL(RS_OPERATION, ''),
	RS_CONDITION = ISNULL(RS_CONDITION, '')
FROM
	REPORTSUMMATION_NEW
WHERE
	RS_REPORT_CODE = @REPORTCODE

SELECT
	RL_SRNO,
	RL_REPORT_CODE,
	RL_MAPPED_FLD,
	RL_ORDERNO,
	RL_ISDIVIDER = ISNULL(RL_ISDIVIDER, 0),
	RL_INNERCSS = ISNULL(RL_INNERCSS, ''),
	RL_INNERSTYLE = ISNULL(RL_INNERSTYLE, ''),
	RL_POPCSS = ISNULL(RL_POPCSS, ''),
	RL_POPSTYLE = ISNULL(RL_POPSTYLE, ''),
	RL_PAGEADDRESS = ISNULL(RL_PAGEADDRESS, ''),
	RL_QRYSTRPARAMS = ISNULL(RL_QRYSTRPARAMS, ''),
	RL_QRYVALFLDS = ISNULL(RL_QRYVALFLDS, ''),
	RL_DISPLAYTEXT = ISNULL(RL_DISPLAYTEXT, ''),
	RL_REQPARAMS = ISNULL(RL_REQPARAMS, ''),
	RL_REQVAL = ISNULL(RL_REQVAL, ''),
	RL_LITERALNAME = ISNULL(RL_LITERALNAME, ''),
	RL_LITERALVALUE = ISNULL(RL_LITERALVALUE, ''),
	RL_PARAMLIST = ISNULL(RL_PARAMLIST, ''),
	RL_NOLINK = ISNULL(RL_NOLINK, '') 
FROM
	REPORTLINKS_NEW
WHERE
	RL_REPORT_CODE = @REPORTCODE
ORDER BY
	RL_ORDERNO

SELECT
	RD_SR_NO = ISNULL(RD_SR_NO, 0),
	RD_REPORT_CODE = ISNULL(RD_REPORT_CODE, ''),
	RD_REPORT_FLD = ISNULL(RD_REPORT_FLD, ''),
	RD_MAPPED_FLD = ISNULL(RD_MAPPED_FLD, ''),
	RD_FIELD_LABEL = ISNULL(RD_FIELD_LABEL, ''),
	RD_FIELD_DESCRIPTION = ISNULL(RD_FIELD_DESCRIPTION, ''),
	RD_FIELD_XPOSITION = ISNULL(RD_FIELD_XPOSITION, 1),
	RD_FIELD_YPOSITION = ISNULL(RD_FIELD_YPOSITION, 1),
	RD_FIELD_WIDTH = ISNULL(RD_FIELD_WIDTH, 10),
	RD_WRAPTEXT = ISNULL(RD_WRAPTEXT, 0),
	RD_WRAPLINES = ISNULL(RD_WRAPLINES, 0),
	RD_FIELD_ALLIGN = ISNULL(RD_FIELD_ALLIGN, 'L'),
	RD_ISDISPLAYED = ISNULL(RD_ISDISPLAYED, 1),
	RD_ISPRINTABLE = ISNULL(RD_ISPRINTABLE, 1),
	RD_ISEXPORTABLE = ISNULL(RD_ISEXPORTABLE, 1),
	RD_FIELD_ROUNDING = ISNULL(RD_FIELD_ROUNDING, 0),
	RD_ROUNDING_STYLE = ISNULL(RD_ROUNDING_STYLE, 0),
	RD_REPORT_SECTION = ISNULL(RD_REPORT_SECTION, 'D'),
	RD_ISCOMPULSORY = ISNULL(RD_ISCOMPULSORY, 1),
	RD_FORECOLOR = ISNULL(RD_FORECOLOR, ''),
	RD_BLACKCOLOR = ISNULL(RD_BLACKCOLOR, ''),
	RD_BOLD = ISNULL(RD_BOLD, 0),
	RD_UNDERLINE = ISNULL(RD_UNDERLINE, 0),
	RD_ISFORMULAFIELD = ISNULL(RD_ISFORMULAFIELD, 0),
	RD_LABLE_COLUMNSPAN = ISNULL(RD_LABLE_COLUMNSPAN, 1),
	RD_VALUE_COLUMNSPAN = ISNULL(RD_VALUE_COLUMNSPAN, 1),
	RD_CSSCLASS = ISNULL(RD_CSSCLASS, ''),
	RD_STYLEELEMENT = ISNULL(RD_STYLEELEMENT, ''),
	RD_HEADER_CSSCLASS = ISNULL(RD_HEADER_CSSCLASS, ''),
	RD_HEADER_STYLEELEMENT = ISNULL(RD_HEADER_STYLEELEMENT, ''),
	RD_ISAGGREGATE = ISNULL(RD_ISAGGREGATE, 0),
	RD_ISDRILLDOWN = ISNULL(RD_ISDRILLDOWN, 0),
	RD_SPLFIELD = ISNULL(RD_SPLFIELD, ''),
	RD_FIELDID = ISNULL(RD_FIELDID, ''),
	RD_LABLEID = ISNULL(RD_LABLEID, '')
FROM
	REPORTDETAILS_NEW
WHERE
	RD_REPORT_CODE = @REPORTCODE
	AND RD_REPORT_SECTION = 'PH'
ORDER BY
	RD_REPORT_SECTION,
	RD_FIELD_YPOSITION,
	RD_FIELD_XPOSITION

SELECT
	RD_SR_NO = ISNULL(RD_SR_NO, 0),
	RD_REPORT_CODE = ISNULL(RD_REPORT_CODE, ''),
	RD_REPORT_FLD = ISNULL(RD_REPORT_FLD, ''),
	RD_MAPPED_FLD = ISNULL(RD_MAPPED_FLD, ''),
	RD_FIELD_LABEL = ISNULL(RD_FIELD_LABEL, ''),
	RD_FIELD_DESCRIPTION = ISNULL(RD_FIELD_DESCRIPTION, ''),
	RD_FIELD_XPOSITION = ISNULL(RD_FIELD_XPOSITION, 1),
	RD_FIELD_YPOSITION = ISNULL(RD_FIELD_YPOSITION, 1),
	RD_FIELD_WIDTH = ISNULL(RD_FIELD_WIDTH, 10),
	RD_WRAPTEXT = ISNULL(RD_WRAPTEXT, 0),
	RD_WRAPLINES = ISNULL(RD_WRAPLINES, 0),
	RD_FIELD_ALLIGN = ISNULL(RD_FIELD_ALLIGN, 'L'),
	RD_ISDISPLAYED = ISNULL(RD_ISDISPLAYED, 1),
	RD_ISPRINTABLE = ISNULL(RD_ISPRINTABLE, 1),
	RD_ISEXPORTABLE = ISNULL(RD_ISEXPORTABLE, 1),
	RD_FIELD_ROUNDING = ISNULL(RD_FIELD_ROUNDING, 0),
	RD_ROUNDING_STYLE = ISNULL(RD_ROUNDING_STYLE, 0),
	RD_REPORT_SECTION = ISNULL(RD_REPORT_SECTION, 'D'),
	RD_ISCOMPULSORY = ISNULL(RD_ISCOMPULSORY, 1),
	RD_FORECOLOR = ISNULL(RD_FORECOLOR, ''),
	RD_BLACKCOLOR = ISNULL(RD_BLACKCOLOR, ''),
	RD_BOLD = ISNULL(RD_BOLD, 0),
	RD_UNDERLINE = ISNULL(RD_UNDERLINE, 0),
	RD_ISFORMULAFIELD = ISNULL(RD_ISFORMULAFIELD, 0),
	RD_LABLE_COLUMNSPAN = ISNULL(RD_LABLE_COLUMNSPAN, 1),
	RD_VALUE_COLUMNSPAN = ISNULL(RD_VALUE_COLUMNSPAN, 1),
	RD_CSSCLASS = ISNULL(RD_CSSCLASS, ''),
	RD_STYLEELEMENT = ISNULL(RD_STYLEELEMENT, ''),
	RD_HEADER_CSSCLASS = ISNULL(RD_HEADER_CSSCLASS, ''),
	RD_ISAGGREGATE = ISNULL(RD_ISAGGREGATE, 0),
	RD_ISDRILLDOWN = ISNULL(RD_ISDRILLDOWN, 0),
	RD_SPLFIELD = ISNULL(RD_SPLFIELD, ''),
	RD_FIELDID = ISNULL(RD_FIELDID, ''),
	RD_LABLEID = ISNULL(RD_LABLEID, '')
FROM
	REPORTDETAILS_NEW
WHERE
	RD_REPORT_CODE = @REPORTCODE
	AND RD_REPORT_SECTION = 'PF'
ORDER BY
	RD_REPORT_SECTION,
	RD_FIELD_YPOSITION,
	RD_FIELD_XPOSITION
/*
SELECT TOP 1
	RD_DISPLAYCONDITION = ISNULL(RD_DISPLAYCONDITION, ''),
	RD_MULTIOPERATOR = ISNULL(RD_MULTIOPERATOR, '')
FROM
	REPORTDETAILS_NEW
WHERE
	RD_REPORT_CODE = @REPORTCODE
	AND RD_REPORT_SECTION = 'D'
	AND ISNULL(RD_DISPLAYCONDITION, '') <> ''
*/

SELECT
	RR_SR_NO,
	RR_REPORT_CODE = ISNULL(RR_REPORT_CODE, ''),
	RR_UPDATE_FIELDS = ISNULL(RR_UPDATE_FIELDS, ''),
	RR_UPDATE_VALUES = ISNULL(RR_UPDATE_VALUES, ''),
	RR_WHERE_FIELDS = ISNULL(RR_WHERE_FIELDS, ''),
	RR_WHERE_VALUES = ISNULL(RR_WHERE_VALUES, ''),
	RR_CONDITION_CODE = ISNULL(RR_CONDITION_CODE, ''),
	RR_ISSTRUCTURE = ISNULL(RR_ISSTRUCTURE, 0)
FROM
	REPORT_RUNTIME_HANDLE
WHERE
	RR_REPORT_CODE = @REPORTCODE

SELECT
	RD_SR_NO = ISNULL(RD_SR_NO, 0),
	RD_REPORT_CODE = ISNULL(RD_REPORT_CODE, ''),
	RD_REPORT_FLD = ISNULL(RD_REPORT_FLD, ''),
	RD_MAPPED_FLD = ISNULL(RD_MAPPED_FLD, ''),
	RD_FIELD_LABEL = ISNULL(RD_FIELD_LABEL, ''),
	RD_FIELD_DESCRIPTION = ISNULL(RD_FIELD_DESCRIPTION, ''),
	RD_FIELD_XPOSITION = ISNULL(RD_FIELD_XPOSITION, 1),
	RD_FIELD_YPOSITION = ISNULL(RD_FIELD_YPOSITION, 1),
	RD_FIELD_WIDTH = ISNULL(RD_FIELD_WIDTH, 10),
	RD_WRAPTEXT = ISNULL(RD_WRAPTEXT, 0),
	RD_WRAPLINES = ISNULL(RD_WRAPLINES, 0),
	RD_FIELD_ALLIGN = ISNULL(RD_FIELD_ALLIGN, 'L'),
	RD_ISDISPLAYED = ISNULL(RD_ISDISPLAYED, 1),
	RD_ISPRINTABLE = ISNULL(RD_ISPRINTABLE, 1),
	RD_ISEXPORTABLE = ISNULL(RD_ISEXPORTABLE, 1),
	RD_FIELD_ROUNDING = ISNULL(RD_FIELD_ROUNDING, 0),
	RD_ROUNDING_STYLE = ISNULL(RD_ROUNDING_STYLE, 0),
	RD_REPORT_SECTION = ISNULL(RD_REPORT_SECTION, 'D'),
	RD_ISCOMPULSORY = ISNULL(RD_ISCOMPULSORY, 1),
	RD_FORECOLOR = ISNULL(RD_FORECOLOR, ''),
	RD_BLACKCOLOR = ISNULL(RD_BLACKCOLOR, ''),
	RD_BOLD = ISNULL(RD_BOLD, 0),
	RD_UNDERLINE = ISNULL(RD_UNDERLINE, 0),
	RD_ISFORMULAFIELD = ISNULL(RD_ISFORMULAFIELD, 0),
	RD_LABLE_COLUMNSPAN = ISNULL(RD_LABLE_COLUMNSPAN, 1),
	RD_VALUE_COLUMNSPAN = ISNULL(RD_VALUE_COLUMNSPAN, 1),
	RD_CSSCLASS = ISNULL(RD_CSSCLASS, ''),
	RD_STYLEELEMENT = ISNULL(RD_STYLEELEMENT, ''),
	RD_HEADER_CSSCLASS = ISNULL(RD_HEADER_CSSCLASS, ''),
	RD_ISAGGREGATE = ISNULL(RD_ISAGGREGATE, 0),
	RD_ISDRILLDOWN = ISNULL(RD_ISDRILLDOWN, 0),
	RD_ISNOHEADER = ISNULL(RD_ISNOHEADER, 0),
	RD_SPLFIELD = ISNULL(RD_SPLFIELD, ''),
	RD_FIELDID = ISNULL(RD_FIELDID, ''),
	RD_LABLEID = ISNULL(RD_LABLEID, '')
FROM
	REPORTDETAILS_NEW
WHERE
	RD_REPORT_CODE = @REPORTCODE
	AND RD_REPORT_SECTION = 'IH'
ORDER BY
	RD_SR_NO

SELECT
	CHARTCODE,
	CHARTDESCRIPTION = ISNULL(CHARTDESCRIPTION, ''),
	DEFAULTTYPE = ISNULL(DEFAULTTYPE, ''),
	HEADING_PREFIX = ISNULL(HEADING_PREFIX, ''),
	HEADING_FIELD = ISNULL(HEADING_FIELD, ''),
	HEADING_SUFFIX = ISNULL(HEADING_SUFFIX, ''),
	SUBHEAD_PREFIX = ISNULL(SUBHEAD_PREFIX, ''),
	SUBHEAD_FIELD = ISNULL(SUBHEAD_FIELD, ''),
	SUBHEAD_SUFFIX = ISNULL(SUBHEAD_SUFFIX, ''),
	DECIMALS = ISNULL(DECIMALS, 0),
	SHOWLABELS = CONVERT(BIT, ISNULL(SHOWLABELS, 1)),
	SHOWVALUES = CONVERT(BIT, ISNULL(SHOWVALUES, '')),
	NUMBERPREFIX = ISNULL(NUMBERPREFIX, ''),
	NUMBERSUFFIX = ISNULL(NUMBERSUFFIX, ''),
	SHOWHOVERVALUES = CONVERT(BIT, ISNULL(SHOWHOVERVALUES, '')),
	XAXISLABEL = ISNULL(XAXISLABEL, ''),
	YAXISLABEL = ISNULL(YAXISLABEL, ''),
	DATAGROUPON = ISNULL(DATAGROUPON, ''),
	DATALABEL_PREFIX = ISNULL(DATALABEL_PREFIX, ''),
	DATALABLE_FIELD = ISNULL(DATALABLE_FIELD, ''),
	DATALABEL_SUFFIX = ISNULL(DATALABEL_SUFFIX, ''),
	DATAVALUE = ISNULL(DATAVALUE, ''),
	DATACOLOR = ISNULL(DATACOLOR, ''),
	VALUEOPERATION = ISNULL(VALUEOPERATION, ''),
	REPORTGROUP = REPORTGROUP
FROM
	CHARTSPECS
WHERE
	REPORTCODE = @REPORTCODE

GO

-- --------------------------------------------------
-- PROCEDURE dbo.V2_EXECUTEF2
-- --------------------------------------------------
CREATE PROC [dbo].[V2_EXECUTEF2]
(
	@F2CODE VARCHAR(10),
	@F2DESCRIPTION	VARCHAR(50) = ''  OUTPUT,
	@F2OBJECT	VARCHAR(100) = ''  OUTPUT,
	@F2OBJECTTYPE VARCHAR(1) = ''  OUTPUT,
	@F2PARAMFIELDS	VARCHAR(500) = ''  OUTPUT,
	@F2OUTPUT	VARCHAR(500) = ''  OUTPUT,
	@F2OPRLIST	VARCHAR(100) = ''  OUTPUT,
	@F2ORDERLIST	VARCHAR(100) = ''  OUTPUT,
	@DATABASENAME	VARCHAR(256) = ''  OUTPUT,
	@WINDOWTITLE	VARCHAR(100) = ''  OUTPUT,
	@TABLEHEADER	VARCHAR(200) = ''  OUTPUT,
	@CONNECTIONDB  VARCHAR(1) = ''  OUTPUT
)
AS
	SELECT 
		@F2DESCRIPTION	= UPPER(F2DESCRIPTION),
		@F2OBJECT = UPPER(F2OBJECT),
		@F2OBJECTTYPE = UPPER(F2OBJECTTYPE),
		@F2PARAMFIELDS = UPPER(F2PARAMFIELDS),
		@F2OUTPUT = UPPER(F2OUTPUT),
		@F2OPRLIST = UPPER(F2OPRLIST),
		@F2ORDERLIST = UPPER(F2ORDERLIST),
		@DATABASENAME = UPPER(DATABASENAME),
		@WINDOWTITLE = UPPER(WINDOWTITLE),
		@TABLEHEADER = UPPER(TABLEHEADER),
		@CONNECTIONDB = UPPER(CONNECTIONDB)
	FROM 
		F2CONFIG 
	WHERE 
		F2CODE = @F2CODE
		AND F2OBJECTTYPE = 'T'
		
--SELECT * FROM F2CONFIG

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_rpt_branchDelGet
-- --------------------------------------------------

--exec [Wrapper_rpt_branchDelGet] '3','2006030','n','%'
--CREATED BY PIYUSH

CREATE PROCEDURE [dbo].[Wrapper_rpt_branchDelGet]
(    
	@DEMATID VARCHAR(2),    
	@SETTNO VARCHAR(7),    
	@SETTYPE VARCHAR(3),    
	@BRANCH VARCHAR(15),
    @SHAREDB VARCHAR(20) ='MSAJAG'        
)
AS
BEGIN
DECLARE @SQL VARCHAR(MAX)
CREATE TABLE #DELGET 
(  
 SRNO INT IDENTITY(1,1),  
 SETT_NO VARCHAR(7),  
 SETT_TYPE VARCHAR(2),   
 SCRIP_CD VARCHAR(20),  
 SERIES VARCHAR(3),  
 GETFROMNSE NUMERIC(10),
 GIVENNSE NUMERIC(10),
 RECIEVEDNSE NUMERIC(10),
 BRANCH VARCHAR(10),
 TGETFROMNSE VARCHAR(10),
 TRECIEVEDNSE VARCHAR(10),
 SHORTAGE VARCHAR(10)
)  
SET @SQL = 	@SHAREDB + '.DBO.rpt_branchDelGet' 
 
INSERT INTO #DELGET(SETT_NO,SETT_TYPE,SCRIP_CD,SERIES,GETFROMNSE,GIVENNSE,RECIEVEDNSE,BRANCH)  
EXEC @SQL @DEMATID, @SETTNO, @SETTYPE, @BRANCH 

UPDATE 
	#DELGET 
SET 
	TGETFROMNSE = (SELECT CONVERT(VARCHAR(10), SUM(GETFROMNSE)) FROM #DELGET I WHERE I.SCRIP_CD = #DELGET.SCRIP_CD  
    AND I.SERIES = #DELGET.SERIES AND I.SRNO <= #DELGET.SRNO)

UPDATE 
	#DELGET 
SET 
	TRECIEVEDNSE = (SELECT CONVERT(VARCHAR(10), SUM(RECIEVEDNSE)) FROM #DELGET I WHERE I.SCRIP_CD = #DELGET.SCRIP_CD  
    AND I.SERIES = #DELGET.SERIES AND I.SRNO <= #DELGET.SRNO) 

UPDATE 
	#DELGET 
SET 
	SHORTAGE = (SELECT CONVERT(VARCHAR(10), SUM(GETFROMNSE) - SUM(RECIEVEDNSE)) FROM #DELGET I WHERE I.SCRIP_CD = #DELGET.SCRIP_CD  
    AND I.SERIES = #DELGET.SERIES AND I.SRNO <= #DELGET.SRNO) 

SELECT  
 MSRNO = MAX(SRNO),  
 NSRNO = MIN(SRNO),  
 SCRIP_CD,  
 SERIES  
INTO  
 #GROUPED  
FROM  
 #DELGET  
GROUP BY  
 SCRIP_CD,  
 SERIES 

UPDATE  
 #DELGET  
SET  
 TGETFROMNSE = '',TRECIEVEDNSE = ''
FROM  
 #GROUPED G  
WHERE  
 #DELGET.SCRIP_CD = G.SCRIP_CD  
 AND #DELGET.SERIES = G.SERIES  
 AND #DELGET.SRNO < G.MSRNO 

--UPDATE  
-- #DELGET  
--SET  
-- SCRIP_CD = '',  
-- SERIES = ''  
-- --CERTNO = ''  
--FROM  
-- #GROUPED G  
--WHERE  
-- #DELGET.SCRIP_CD = G.SCRIP_CD  
-- AND #DELGET.SERIES = G.SERIES  
-- AND #DELGET.SRNO > G.NSRNO  

SELECT   
SETT_NO,
 SETT_TYPE,
 SCRIP_CD,  
 SERIES,  
GETFROMNSE,
GIVENNSE,
RECIEVEDNSE,
BRANCH,
TGETFROMNSE,
TRECIEVEDNSE,
SHORTAGE
 
FROM  
 #DELGET
WHERE 
TGETFROMNSE <> '' and TRECIEVEDNSE <> ''
ORDER BY  
 SRNO  
   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_rpt_branchDelGive
-- --------------------------------------------------

--exec [Wrapper_rpt_branchDelGive] '3','2006030','n','%'
--CREATED BY PIYUSH

CREATE PROCEDURE [dbo].[Wrapper_rpt_branchDelGive]
(    
	@DEMATID VARCHAR(2),    
	@SETTNO VARCHAR(7),    
	@SETTYPE VARCHAR(3),    
	@BRANCH VARCHAR(15),
    @SHAREDB VARCHAR(20) ='MSAJAG'    
)
AS
BEGIN
DECLARE @SQL VARCHAR(MAX)
CREATE TABLE #DELGIVE  
(  
 SRNO INT IDENTITY(1,1),  
 SETT_NO VARCHAR(7),  
 SETT_TYPE VARCHAR(2),   
 SCRIP_CD VARCHAR(20),  
 SERIES VARCHAR(3),  
 GIVENSE NUMERIC(10),
 GIVENNSE NUMERIC(10),
 RECIEVEDNSE NUMERIC(10),
 SCRIPNAME VARCHAR(3),
 BRANCH VARCHAR(10),
 TGIVENSE VARCHAR(10),
 TGIVENNSE VARCHAR(10),
 SHORTAGE VARCHAR(10)
)  
  SET @SQL = 	@SHAREDB + '.DBO.RPT_BRANCHDELGIVE'
INSERT INTO #DELGIVE(SETT_NO,SETT_TYPE,SCRIP_CD,SERIES,GIVENSE,GIVENNSE,RECIEVEDNSE,SCRIPNAME,BRANCH)  
EXEC @SQL @DEMATID = @DEMATID, @SETTNO = @SETTNO, @SETTYPE = @SETTYPE , @BRANCH = @BRANCH

UPDATE 
	#DELGIVE 
SET 
	TGIVENSE = (SELECT CONVERT(VARCHAR(10), SUM(GIVENSE)) FROM #DELGIVE I WHERE I.SCRIP_CD = #DELGIVE.SCRIP_CD  
	AND I.SERIES = #DELGIVE.SERIES AND I.SRNO <= #DELGIVE.SRNO)

UPDATE 
	#DELGIVE 
SET 
	TGIVENNSE = (SELECT CONVERT(VARCHAR(10), SUM(GIVENNSE)) FROM #DELGIVE I WHERE I.SCRIP_CD = #DELGIVE.SCRIP_CD  
    AND I.SERIES = #DELGIVE.SERIES AND I.SRNO <= #DELGIVE.SRNO) 

UPDATE 
	#DELGIVE 
SET 
	SHORTAGE = (SELECT CONVERT(VARCHAR(10), SUM(GIVENSE) - SUM(GIVENNSE)) FROM #DELGIVE I WHERE I.SCRIP_CD = #DELGIVE.SCRIP_CD  
    AND I.SERIES = #DELGIVE.SERIES AND I.SRNO <= #DELGIVE.SRNO) 

SELECT  
 MSRNO = MAX(SRNO),  
 NSRNO = MIN(SRNO),  
 SCRIP_CD,  
 SERIES  
INTO  
 #GROUPED  
FROM  
 #DELGIVE  
GROUP BY  
 SCRIP_CD,  
 SERIES 

UPDATE  
 #DELGIVE  
SET  
 TGIVENSE = '',TGIVENNSE = ''
FROM  
 #GROUPED G  
WHERE  
 #DELGIVE.SCRIP_CD = G.SCRIP_CD  
 AND #DELGIVE.SERIES = G.SERIES  
 AND #DELGIVE.SRNO < G.MSRNO 

UPDATE  
 #DELGIVE  
SET  
 SCRIP_CD = '',  
 SERIES = ''  
 --CERTNO = ''  
FROM  
 #GROUPED G  
WHERE  
 #DELGIVE.SCRIP_CD = G.SCRIP_CD  
 AND #DELGIVE.SERIES = G.SERIES  
 AND #DELGIVE.SRNO > G.NSRNO  

SELECT   
SETT_NO,
 SETT_TYPE,
 SCRIP_CD,  
 SERIES,  
GIVENSE,
GIVENNSE,
RECIEVEDNSE,
SCRIPNAME,
BRANCH,
TGIVENSE,
TGIVENNSE,
SHORTAGE
 
FROM  
 #DELGIVE  
ORDER BY  
 SRNO  
   
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_rpt_branchDelScripClients
-- --------------------------------------------------
--EXEC [Wrapper_rpt_branchDelScripClients] 3,'2006030','N','%','%','%'
--Created By Piyush
CREATE PROCEDURE [dbo].[Wrapper_rpt_branchDelScripClients]  
(  
	@DEMATID VARCHAR(2),    
	@SETTNO VARCHAR(7),    
	@SETTYPE VARCHAR(3),    
	@SCRIPCD VARCHAR(20),    
	@SERIES VARCHAR(3),    
	@BRANCH VARCHAR(15)   
) 
    
AS
BEGIN
CREATE TABLE #TEMP_BRANCHDELSCRIPCLIENTS
(
	SETT_NO		VARCHAR(7),
	SETT_TYPE	VARCHAR(2),
	PARTY_CODE	VARCHAR(12),
	SHORT_NAME	VARCHAR(30),
	SCRIP_CD	VARCHAR(30),
	SERIES		VARCHAR(3),
	INOUT	VARCHAR(2),
	QTY	NUMERIC(18, 0),
	SCRIPNAME VARCHAR(3),
	RECQTY NUMERIC(18, 0),
	GIVENQTY NUMERIC(18, 0),
	BRANCH VARCHAR(10),
	SRNO INT IDENTITY(1,1)
)
	INSERT INTO #TEMP_BRANCHDELSCRIPCLIENTS
	EXEC MSAJAG.DBO.RPT_BRANCHDELSCRIPCLIENTS @DEMATID=@DEMATID,@SETTNO=@SETTNO,@SETTYPE = @SETTYPE,@SCRIPCD=@SCRIPCD,@SERIES=@SERIES,@BRANCH=@BRANCH
	
	SELECT 
		SRNO,
		SETT_NO,	
		SETT_TYPE,
		PARTY_CODE,
		SHORT_NAME,
		SCRIP_CD,
		SERIES,
		INOUT,
		CASE WHEN LTRIM(RTRIM(INOUT)) = 'I' THEN (CONVERT(NUMERIC(18,0),-QTY)) ELSE CONVERT(NUMERIC(18,0),QTY) END AS QTY,
		RECQTY,
		GIVENQTY,
		CASE WHEN LTRIM(RTRIM(INOUT)) = 'I' THEN (CONVERT(NUMERIC(18,0),-QTY + RECQTY - GIVENQTY )) ELSE CONVERT(NUMERIC(18,0),QTY + RECQTY -GIVENQTY) END AS SHORTAGE,
		NETQTY = (SELECT ABS(SUM(QTY)) FROM #TEMP_BRANCHDELSCRIPCLIENTS I WHERE I.SRNO <= #TEMP_BRANCHDELSCRIPCLIENTS.SRNO)
	FROM 
		#TEMP_BRANCHDELSCRIPCLIENTS

DROP TABLE #TEMP_BRANCHDELSCRIPCLIENTS
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_Rpt_DelAucReport
-- --------------------------------------------------

--Exec  msajag.dbo.Rpt_DelAucReport 'broker','broker','2007096','A'
--Exec  Wrapper_Rpt_DelAucReport 'broker','broker','2007096','A'
--CREATED BY PIYUSH
CREATE PROC [dbo].[Wrapper_Rpt_DelAucReport]
(
	@STATUSID	VARCHAR(15),
	@STATUSNAME	VARCHAR(25),
	@SETT_NO	VARCHAR(7),
	@SETT_TYPE	VARCHAR(2)
) AS
BEGIN

CREATE TABLE #TEMP_DELAUCREPORT
(
	SRNO INT IDENTITY(1,1),
	PARTY_CODE	VARCHAR(10),
	LONG_NAME	VARCHAR(100),
	SCRIP_CD	VARCHAR(10),
	SERIES		VARCHAR(5),
	SCRIP_NAME	VARCHAR(100),
	QTY			INT,
	RATE		MONEY,
	AMT			MONEY,
	SETT_NO		VARCHAR(7),
	SETT_TYPE	VARCHAR(2),
	REMARK		VARCHAR(50),
)
CREATE CLUSTERED INDEX IDX_DELAUCREPORT
ON #TEMP_DELAUCREPORT(SRNO, PARTY_CODE, SCRIP_CD)

INSERT INTO #TEMP_DELAUCREPORT
EXEC  MSAJAG.DBO.RPT_DELAUCREPORT @STATUSID=@STATUSID,@STATUSNAME=@STATUSNAME,@SETT_NO=@SETT_NO,@SETT_TYPE=@SETT_TYPE
	
SELECT 
	PARTY_CODE,
	LONG_NAME,
	SCRIP_CD,
	SERIES,
	SCRIP_NAME,
	QTY,
	RATE,
	AMT,
	SETT_NO,
	SETT_TYPE,
	REMARK
FROM	
	#TEMP_DELAUCREPORT

DROP TABLE #TEMP_DELAUCREPORT

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_Rpt_DelAuctionFinal
-- --------------------------------------------------

-- Exec msajag.dbo.Rpt_DelAuctionFinal 'broker','broker','2007096','A','','zzzzz'  
-- Exec Wrapper_Rpt_DelAuctionFinal 'broker','broker','2007096','A','','zzzzz'  
--CREATED BY PIYUSH
CREATE PROC [dbo].[Wrapper_Rpt_DelAuctionFinal]  
(  
 @Statusid varchar(15),  
 @Statusname varchar(25),  
 @Sett_No varchar(7),  
 @Sett_Type varchar(2),  
 @FromParty varchar(10),  
 @ToParty varchar(10)  
) AS
BEGIN  
CREATE TABLE #TEMP_DelAuctionFinal  
(  
 SRNO INT IDENTITY(1,1),  
 Sett_No  varchar(7),  
 Sett_Type varchar(3),  
 PayIn  varchar(10),  
 SaudaDate varchar(10),  
 PayOut  varchar(10),  
 Party_Code varchar(10),  
 Long_Name varchar(100),  
 L_Address1 varchar(100),  
 L_Address2 varchar(100),  
 L_Address3 varchar(100),  
 L_City  varchar(40),  
 L_State  varchar(50),  
 L_Zip  varchar(15),  
 BillNo  varchar(10),  
 ScripName varchar(10),  
 Qty   int,  
 Amount  NUMERIC(18,2),  
 MarketRate NUMERIC(18,2),  
 Sell_buy int,  
 Service_Tax NUMERIC(18,2),  
 Ins_Chrg NUMERIC(18,2),  
 Turn_Tax NUMERIC(18,2),  
 Other_Chrg NUMERIC(18,2),  
 Sabi_Tax NUMERIC(18,2),  
 Broker_Chrg NUMERIC(18,2),  
 Remark  varchar(50),  
 Penalty  decimal,  
 AuctionPart varchar(2),  
 PenaltyPer varchar(10)  
  
)  
CREATE CLUSTERED INDEX IDX_DelAuctionFinal  
ON #TEMP_DelAuctionFinal(SRNO, PARTY_CODE, SCRIPNAME)  
  
INSERT INTO #TEMP_DelAuctionFinal  
exec msajag.dbo.Rpt_DelAuctionFinal  
  @STATUSID=@Statusid,  
  @STATUSNAME=@Statusname,  
  @SETT_NO=@Sett_No,  
  @SETT_TYPE=@Sett_Type,  
  @FROMPARTY=@FromParty,  
  @TOPARTY=@ToParty  
   
SELECT  SRNO,  
  Sett_No,  
  Sett_Type,  
  PayIn,  
  SaudaDate,  
  PayOut,  
  Party_Code,  
  Long_Name,  
  L_Address1,  
  L_Address2,  
  L_Address3,  
  L_City,  
  L_State,  
  L_Zip,  
  BillNo,  
  ScripName,  
  Qty,  
  Amount,  
  MarketRate,  
  Sell_buy,  
  Service_Tax,  
  Ins_Chrg,  
  Turn_Tax,  
  Other_Chrg,  
  Sabi_Tax,  
  Broker_Chrg,  
  DebitAmt= CONVERT(numeric,0.00),  
  CreditAmt=CONVERT(numeric,0.00),  
  DebitAmtSUM=CONVERT(numeric,0.00),  
  CreditAmtSUM=CONVERT(numeric,0.00),  
  Service_TaxSUM=CONVERT(numeric,0.00),  
  Ins_ChrgSUM=CONVERT(numeric,0.00),  
  Turn_TaxSUM=CONVERT(numeric,0.00),  
  Other_ChrgSUM=CONVERT(numeric,0.00),  
  Sabi_TaxSUM=CONVERT(numeric,0.00),  
  Broker_ChrgSUM=CONVERT(numeric,0.00),  
  TotalAmount=CONVERT(numeric,0.00)  
INTO #tempDelprovAuctionFinalGroup  
FROM #TEMP_DelAuctionFinal  
GROUP BY  
  SRNO,  
  sett_No,  
  Sett_Type,  
  PayIn,  
  SaudaDate,  
  PayOut,  
  Party_Code,  
  Long_Name,  
  L_Address1,  
  L_Address2,  
  L_Address3,  
  L_City,  
  L_State,  
  L_Zip,  
  BillNo,  
  ScripName,  
  Qty,  
  Amount,  
  MarketRate,  
  Sell_buy,  
  Service_Tax,  
  Ins_Chrg,  
  Turn_Tax,  
  Other_Chrg,  
  Sabi_Tax,  
  Broker_Chrg  
    
UPDATE #tempDelprovAuctionFinalGroup  
  SET   
  DebitAmt= case when sell_buy=1 then CONVERT(MONEY,amount) else 0.00 end,  
  CreditAmt =case when sell_buy=2 then CONVERT(MONEY,amount) else 0.00 end   
  
UPDATE  
 #tempDelprovAuctionFinalGroup  
SET  
 DebitAmtSUM = (SELECT ROUND(SUM(DebitAmt),2) FROM #tempDelprovAuctionFinalGroup I   
 WHERE #tempDelprovAuctionFinalGroup.PARTY_CODE = I.PARTY_CODE   
 AND #tempDelprovAuctionFinalGroup.ScripName = I.ScripName   
 AND I.SRNO <= #tempDelprovAuctionFinalGroup.SRNO),  
 CreditAmtSUM = (SELECT ROUND(SUM(CreditAmt),2) FROM #tempDelprovAuctionFinalGroup I   
 WHERE #tempDelprovAuctionFinalGroup.PARTY_CODE = I.PARTY_CODE   
 AND #tempDelprovAuctionFinalGroup.ScripName = I.ScripName   
 AND I.SRNO <= #tempDelprovAuctionFinalGroup.SRNO),  
 Service_TaxSUM = (SELECT ROUND(SUM(Service_Tax),2) FROM #tempDelprovAuctionFinalGroup I   
 WHERE #tempDelprovAuctionFinalGroup.PARTY_CODE = I.PARTY_CODE   
 AND #tempDelprovAuctionFinalGroup.ScripName = I.ScripName   
 AND I.SRNO <= #tempDelprovAuctionFinalGroup.SRNO),  
 Ins_ChrgSUM = (SELECT ROUND(SUM(Ins_Chrg),2) FROM #tempDelprovAuctionFinalGroup I   
 WHERE #tempDelprovAuctionFinalGroup.PARTY_CODE = I.PARTY_CODE   
 AND #tempDelprovAuctionFinalGroup.ScripName = I.ScripName   
 AND I.SRNO <= #tempDelprovAuctionFinalGroup.SRNO),  
 Turn_TaxSUM = (SELECT ROUND(SUM(Turn_Tax),2) FROM #tempDelprovAuctionFinalGroup I   
 WHERE #tempDelprovAuctionFinalGroup.PARTY_CODE = I.PARTY_CODE   
 AND #tempDelprovAuctionFinalGroup.ScripName = I.ScripName   
 AND I.SRNO <= #tempDelprovAuctionFinalGroup.SRNO),  
 Other_ChrgSUM = (SELECT ROUND(SUM(Other_Chrg),2) FROM #tempDelprovAuctionFinalGroup I   
 WHERE #tempDelprovAuctionFinalGroup.PARTY_CODE = I.PARTY_CODE   
 AND #tempDelprovAuctionFinalGroup.ScripName = I.ScripName   
 AND I.SRNO <= #tempDelprovAuctionFinalGroup.SRNO),  
 Sabi_TaxSUM = (SELECT ROUND(SUM(Sabi_Tax),2) FROM #tempDelprovAuctionFinalGroup I   
 WHERE #tempDelprovAuctionFinalGroup.PARTY_CODE = I.PARTY_CODE   
 AND #tempDelprovAuctionFinalGroup.ScripName = I.ScripName   
 AND I.SRNO <= #tempDelprovAuctionFinalGroup.SRNO),  
 Broker_ChrgSUM = (SELECT ROUND(SUM(Broker_Chrg),2) FROM #tempDelprovAuctionFinalGroup I   
 WHERE #tempDelprovAuctionFinalGroup.PARTY_CODE = I.PARTY_CODE   
 AND #tempDelprovAuctionFinalGroup.ScripName = I.ScripName   
 AND I.SRNO <= #tempDelprovAuctionFinalGroup.SRNO)  
   
UPDATE #tempDelprovAuctionFinalGroup  
  SET   
  TotalAmount =ROUND((DebitAmtSUM-CreditAmtSUM)+(Service_TaxSUM+Ins_ChrgSUM+Turn_TaxSUM+Other_ChrgSUM+Sabi_TaxSUM+Broker_ChrgSUM),2)  
  
  
--Duetolabel=(Case when TotAmount < 0 then 'AMOUNT DUE TO YOU:'else 'AMOUNT DUE TO US:' end),  
 --DuetoYouAmt= (Case when TotAmount < 0 then abs(TotAmount) else 0.00 end),  
 --DuetoUsAmt= (Case when TotAmount > 0 then abs(TotAmount) else  0.00 end)  
  
   
SELECT *,  
 Duetolabel=(Case when TotalAmount < 0 then 'AMOUNT DUE TO YOU:'else 'AMOUNT DUE TO US:' end),  
 DuetoYouAmt= (Case when TotalAmount < 0 then ROUND(abs(TotalAmount),2) else 0.00 end),  
 DuetoUsAmt= (Case when TotalAmount > 0 then ROUND(abs(TotalAmount),2) else  0.00 end)  
 from #tempDelprovAuctionFinalGroup  
   
DROP TABLE #TEMP_DelAuctionFinal  
DROP TABLE #tempDelprovAuctionFinalGroup  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WRAPPER_RPT_DELMISMATCH
-- --------------------------------------------------

--EXEC WRAPPER_RPT_DELMISMATCH '2006030','N'
--CREATED BY PIYUSH
CREATE PROCEDURE [dbo].[WRAPPER_RPT_DELMISMATCH]
(
  @SETT_NO VARCHAR(10),
  @SETT_TYPE VARCHAR(3)
)
AS
SELECT 
	SETT_NO,
	SETT_TYPE,
	PARTY_CODE,
	SCRIP_CD,
	SERIES,
	ISIN,
	QTY,
	FOLIONO,
	TRTYPE,
	REASON,
	CONVERT(VARCHAR(11),TRANSDATE,103) AS TRANSDATE,
	CLTDPID,
	DPID,
	DRCR,
	STATUS,
	SCRIPNAME,
	CASE WHEN TRTYPE = '907' AND (REASON = '' OR REASON = 'DEMAT') THEN 'INST FROM ' +  CLTDPID
		 WHEN TRTYPE = '907' THEN REASON ELSE REASON END AS DISPALYTEXT
FROM
	MSAJAG.DBO.RPT_DELMISMATCH 
WHERE 
	SETT_NO = @SETT_NO AND SETT_TYPE = @SETT_TYPE 
ORDER BY 
	SCRIP_CD

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_Rpt_DelProvAuction
-- --------------------------------------------------

--Exec msajag.dbo.Rpt_DelProvAuction 'broker','broker','2007096','A','0A141','zzzzzz'  
--Exec Wrapper_Rpt_DelProvAuction 'broker','broker','2007096','A','0','z'  
 --CREATED BY PIYUSH 
  
CREATE PROC [dbo].[Wrapper_Rpt_DelProvAuction]  
(  
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),  
 @SETT_NO VARCHAR(7),  
 @SETT_TYPE VARCHAR(2),  
 @FROMPARTY VARCHAR(10),  
 @TOPARTY VARCHAR(10)  
) AS
BEGIN  
  
CREATE TABLE #TEMP_DELPROVAUCTION  
(  
 SRNO INT IDENTITY(1,1),  
 SETT_NO  VARCHAR(7),  
 SETT_TYPE VARCHAR(3),  
 PAYIN  VARCHAR(10),  
 SAUDADATE VARCHAR(10),  
 PAYOUT  VARCHAR(10),  
 PARTY_CODE VARCHAR(10),  
 LONG_NAME VARCHAR(100),  
 L_ADDRESS1 VARCHAR(100),  
 L_ADDRESS2 VARCHAR(100),  
 L_ADDRESS3 VARCHAR(100),  
 L_CITY  VARCHAR(40),  
 L_STATE  VARCHAR(50),  
 L_ZIP  VARCHAR(15),  
 BILLNO  VARCHAR(10),  
 SCRIPNAME VARCHAR(10),  
 QTY   INT,  
 AMOUNT  NUMERIC(18,2),  
 MARKETRATE NUMERIC(18,2),  
 SELL_BUY INT,  
 SERVICE_TAX NUMERIC(18,2),  
 INS_CHRG NUMERIC(18,2),  
 TURN_TAX NUMERIC(18,2),  
 OTHER_CHRG NUMERIC(18,2),  
 SABI_TAX NUMERIC(18,2),  
 BROKER_CHRG NUMERIC(18,2)  
)  
CREATE CLUSTERED INDEX IDX_DELPROVAUCTION  
ON #TEMP_DELPROVAUCTION(SRNO, PARTY_CODE, SCRIPNAME)  
  
  
 INSERT INTO #TEMP_DELPROVAUCTION  
 EXEC  MSAJAG.DBO.RPT_DELPROVAUCTION @STATUSID=@STATUSID,@STATUSNAME=@STATUSNAME,@SETT_NO=@SETT_NO,@SETT_TYPE=@SETT_TYPE,@FROMPARTY=@FROMPARTY,@TOPARTY=@TOPARTY  
   
  
SELECT  
 SRNO,  
 SETT_NO,  
 SETT_TYPE,  
 PAYIN,  
 SAUDADATE,  
 PAYOUT,  
 PARTY_CODE,  
 LONG_NAME,  
 L_ADDRESS1,  
 L_ADDRESS2,  
 L_ADDRESS3,  
 L_CITY,  
 L_STATE,  
 L_ZIP,  
 BILLNO,  
 SCRIPNAME,  
 QTY,  
 AMOUNT,  
 MARKETRATE,  
 SELL_BUY,  
 SERVICE_TAX,  
 INS_CHRG,  
 TURN_TAX,  
 OTHER_CHRG,  
 SABI_TAX,  
 BROKER_CHRG,  
 DEBITAMT= CONVERT(NUMERIC,0.00),  
 CREDITAMT=CONVERT(NUMERIC,0.00),  
 DEBITAMTSUM=CONVERT(NUMERIC,0.00),  
 CREDITAMTSUM=CONVERT(NUMERIC,0.00),  
 SERVICE_TAXSUM=CONVERT(NUMERIC,0.00),  
 INS_CHRGSUM=CONVERT(NUMERIC,0.00),  
 TURN_TAXSUM=CONVERT(NUMERIC,0.00),  
 OTHER_CHRGSUM=CONVERT(NUMERIC,0.00),  
 SABI_TAXSUM=CONVERT(NUMERIC,0.00),  
 BROKER_CHRGSUM=CONVERT(NUMERIC,0.00),  
 TOTALAMOUNT=CONVERT(NUMERIC,0.00)  
INTO #TEMPDELPROVAUCTIONGROUP  
FROM #TEMP_DELPROVAUCTION  
GROUP BY  
  SRNO,  
  SETT_NO,  
  SETT_TYPE,  
  PAYIN,  
  SAUDADATE,  
  PAYOUT,  
  PARTY_CODE,  
  LONG_NAME,  
  L_ADDRESS1,  
  L_ADDRESS2,  
  L_ADDRESS3,  
  L_CITY,  
  L_STATE,  
  L_ZIP,  
  BILLNO,  
  SCRIPNAME,  
  QTY,  
  AMOUNT,  
  MARKETRATE,  
  SELL_BUY,  
  SERVICE_TAX,  
  INS_CHRG,  
  TURN_TAX,  
  OTHER_CHRG,  
  SABI_TAX,  
  BROKER_CHRG  
  
 UPDATE #TEMPDELPROVAUCTIONGROUP  
  SET   
  DEBITAMT= CASE WHEN SELL_BUY=1 THEN CONVERT(MONEY,AMOUNT) ELSE 0.00 END,  
  CREDITAMT =CASE WHEN SELL_BUY=2 THEN CONVERT(MONEY,AMOUNT) ELSE 0.00 END   
  
UPDATE  
 #TEMPDELPROVAUCTIONGROUP  
SET  
 DEBITAMTSUM = (SELECT ROUND(SUM(DEBITAMT),2) FROM #TEMPDELPROVAUCTIONGROUP I   
				WHERE #TEMPDELPROVAUCTIONGROUP.PARTY_CODE = I.PARTY_CODE   
				AND #TEMPDELPROVAUCTIONGROUP.SCRIPNAME = I.SCRIPNAME   
				AND I.SRNO <= #TEMPDELPROVAUCTIONGROUP.SRNO),  
 CREDITAMTSUM = (SELECT ROUND(SUM(CREDITAMT),2) FROM #TEMPDELPROVAUCTIONGROUP I   
				WHERE #TEMPDELPROVAUCTIONGROUP.PARTY_CODE = I.PARTY_CODE   
				AND #TEMPDELPROVAUCTIONGROUP.SCRIPNAME = I.SCRIPNAME   
				AND I.SRNO <= #TEMPDELPROVAUCTIONGROUP.SRNO),  
 SERVICE_TAXSUM = (SELECT ROUND(SUM(SERVICE_TAX),2) FROM #TEMPDELPROVAUCTIONGROUP I   
					WHERE #TEMPDELPROVAUCTIONGROUP.PARTY_CODE = I.PARTY_CODE   
					AND #TEMPDELPROVAUCTIONGROUP.SCRIPNAME = I.SCRIPNAME   
				    AND I.SRNO <= #TEMPDELPROVAUCTIONGROUP.SRNO),  
 INS_CHRGSUM = (SELECT ROUND(SUM(INS_CHRG),2) FROM #TEMPDELPROVAUCTIONGROUP I   
				WHERE #TEMPDELPROVAUCTIONGROUP.PARTY_CODE = I.PARTY_CODE   
				AND #TEMPDELPROVAUCTIONGROUP.SCRIPNAME = I.SCRIPNAME   
				AND I.SRNO <= #TEMPDELPROVAUCTIONGROUP.SRNO),  
 TURN_TAXSUM = (SELECT ROUND(SUM(TURN_TAX),2) FROM #TEMPDELPROVAUCTIONGROUP I   
				WHERE #TEMPDELPROVAUCTIONGROUP.PARTY_CODE = I.PARTY_CODE   
				AND #TEMPDELPROVAUCTIONGROUP.SCRIPNAME = I.SCRIPNAME   
				AND I.SRNO <= #TEMPDELPROVAUCTIONGROUP.SRNO),  
 OTHER_CHRGSUM = (SELECT ROUND(SUM(OTHER_CHRG),2) FROM #TEMPDELPROVAUCTIONGROUP I   
				  WHERE #TEMPDELPROVAUCTIONGROUP.PARTY_CODE = I.PARTY_CODE   
				  AND #TEMPDELPROVAUCTIONGROUP.SCRIPNAME = I.SCRIPNAME   
				  AND I.SRNO <= #TEMPDELPROVAUCTIONGROUP.SRNO),  
 SABI_TAXSUM = (SELECT ROUND(SUM(SABI_TAX),2) FROM #TEMPDELPROVAUCTIONGROUP I   
				WHERE #TEMPDELPROVAUCTIONGROUP.PARTY_CODE = I.PARTY_CODE   
				AND #TEMPDELPROVAUCTIONGROUP.SCRIPNAME = I.SCRIPNAME   
				AND I.SRNO <= #TEMPDELPROVAUCTIONGROUP.SRNO),  
 BROKER_CHRGSUM = (SELECT ROUND(SUM(BROKER_CHRG),2) FROM #TEMPDELPROVAUCTIONGROUP I   
				   WHERE #TEMPDELPROVAUCTIONGROUP.PARTY_CODE = I.PARTY_CODE   
				  AND #TEMPDELPROVAUCTIONGROUP.SCRIPNAME = I.SCRIPNAME   
				  AND I.SRNO <= #TEMPDELPROVAUCTIONGROUP.SRNO)  
  
UPDATE #TEMPDELPROVAUCTIONGROUP  
  SET   
  TOTALAMOUNT =ROUND((DEBITAMTSUM-CREDITAMTSUM)+(SERVICE_TAXSUM+INS_CHRGSUM+TURN_TAXSUM+OTHER_CHRGSUM+SABI_TAXSUM+BROKER_CHRGSUM),2)  
  
   
SELECT *,  
 DUETOLABEL=(CASE WHEN TOTALAMOUNT < 0 THEN 'AMOUNT DUE TO YOU:'ELSE 'AMOUNT DUE TO US:' END),  
 DUETOYOUAMT= (CASE WHEN TOTALAMOUNT < 0 THEN ROUND(ABS(TOTALAMOUNT),2) ELSE 0.00 END),  
 DUETOUSAMT= (CASE WHEN TOTALAMOUNT > 0 THEN ROUND(ABS(TOTALAMOUNT),2) ELSE  0.00 END)  
 FROM #TEMPDELPROVAUCTIONGROUP  
  
DROP TABLE #TEMP_DELPROVAUCTION  
DROP TABLE #TEMPDELPROVAUCTIONGROUP  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WRAPPER_RPT_INSDELPAYIN
-- --------------------------------------------------

CREATE PROC [dbo].[WRAPPER_RPT_INSDELPAYIN]  
(  
	@STATUSID VARCHAR(25),
	@STATUSNAME VARCHAR(25),
	@SETT_NO VARCHAR(11),        
	@SETT_TYPE VARCHAR(11),
	@FPARTY_CD VARCHAR(10),      
	@TPARTY_CD VARCHAR(10),
	@SHAREDB VARCHAR(20)
)  
AS
set dateformat dmy
/*
EXEC WRAPPER_RPT_INSDELPAYIN @STATUSID='BROKER',@STATUSNAME='BROKER',@SETT_NO='1011186',@SETT_TYPE='T3',@FPARTY_CD='0',@TPARTY_CD='zz',@SHAREDB='BSEMFSS'
Exec BSEMFSS.DBO.InsDelPayIn 'broker','broker','1011186','T3','0','zz'
CREATED BY PIYUSH
*/
 CREATE TABLE #HOLDPAYIN 
(
 SETT_NO VARCHAR(7),  
 SETT_TYPE VARCHAR(2),
 PARTY_CODE VARCHAR(10),
 LONG_NAME VARCHAR(100),
 ISIN VARCHAR(16),  
 SCRIP_CD VARCHAR(16),
 SCHEME_NAME VARCHAR(200),
 QTY NUMERIC(18,3),
 CLTDPID VARCHAR(20),
 DPID VARCHAR(20), 
 ISETT_NO VARCHAR(12),
 ISETT_TYPE VARCHAR(2),
 TRANSDATE VARCHAR(11),
 EXCH VARCHAR(10),
 REMARK VARCHAR(50),
 COMPANYNAME VARCHAR(50)
 )
DECLARE @SQL VARCHAR(MAX)
SET @SQL= @SHAREDB + '.DBO.INSDELPAYIN'

INSERT INTO #HOLDPAYIN
(
	SETT_NO, 
	SETT_TYPE, 
	PARTY_CODE, 
	LONG_NAME, 
	ISIN, 
	SCRIP_CD,
	SCHEME_NAME, 
	QTY, 
	CLTDPID, 
	DPID, 
	ISETT_NO, 
	ISETT_TYPE, 
	TRANSDATE, 
	EXCH, 
	REMARK
)  
EXEC @SQL @STATUSID, @STATUSNAME, @SETT_NO, @SETT_TYPE, @FPARTY_CD, @TPARTY_CD

UPDATE 
	#HOLDPAYIN 
SET 
	COMPANYNAME = (SELECT LTRIM(RTRIM(COMPANY)) FROM BSEMFSS.DBO.OWNER)

SELECT 
	SETT_NO, 
	SETT_TYPE, 
	PARTY_CODE, 
	LONG_NAME, 
	ISIN, 
	SCRIP_CD, 
	SCHEME_NAME,
	QTY, 
	CLTDPID, 
	DPID, 
	ISETT_NO, 
	ISETT_TYPE, 
	TRANSDATE, 
	EXCH, 
	REMARK, 
	COMPANYNAME,
	(SETT_NO +'-'+ SETT_TYPE) AS SETTLEMENT_NO
FROM 
	#HOLDPAYIN

DROP TABLE #HOLDPAYIN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WRAPPER_RPT_INSDELPAYOUT
-- --------------------------------------------------

CREATE PROC [dbo].[WRAPPER_RPT_INSDELPAYOUT]  
(  
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@FROMTRDATE VARCHAR(11),        
	@TOTRDATE VARCHAR(11),
	@FPARTY_CD VARCHAR(10),      
	@TPARTY_CD VARCHAR(10),
	@BRANCH VARCHAR(10),
	@SHAREDB VARCHAR(20)
)  
AS
set dateformat dmy
/*
EXEC WRAPPER_RPT_INSDELPAYOUT @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMTRDATE='Sep  3 2009',@TOTRDATE='Sep 23 2010',@FPARTY_CD='0A141',@TPARTY_CD='0A149', @BRANCH='%',@SHAREDB='MSAJAG'
Exec MSAJAG.DBO.INSDELPAYOUT 'broker','broker','Sep  3 2009','Sep 23 2010','0A141','0A149', '%'
*/
 CREATE TABLE #HOLDPAYOUT  
(
 SETT_NO VARCHAR(7),  
 SETT_TYPE VARCHAR(2),
 PARTY_CODE VARCHAR(10),
 LONG_NAME VARCHAR(100),
 L_ADDRESS1 VARCHAR(100),
 L_ADDRESS2 VARCHAR(100),
 L_ADDRESS3 VARCHAR(100),
 L_CITY VARCHAR(100),
 L_STATE VARCHAR(100),
 L_ZIP VARCHAR(100),
 ISIN VARCHAR(16),  
 SCRIP_CD VARCHAR(16),
 SCHEME_NAME VARCHAR(250),
 QTY NUMERIC(18,3),
 CLTDPID VARCHAR(20),
 DPID VARCHAR(20), 
 ISETT_NO VARCHAR(12),
 ISETT_TYPE VARCHAR(2),
 TRANSDATE VARCHAR(11),
 EXCH VARCHAR(10),
 REMARK VARCHAR(100),
 COMPANYNAME VARCHAR(150),
 FROMDATE VARCHAR(11),
 TODATE VARCHAR(11)		
)
DECLARE @SQL VARCHAR(MAX)
SET @SQL= @SHAREDB + '.DBO.INSDELPAYOUT'

INSERT INTO #HOLDPAYOUT
(
	SETT_NO, 
	SETT_TYPE, 
	PARTY_CODE, 
	LONG_NAME, 
	L_ADDRESS1, 
	L_ADDRESS2, 
	L_ADDRESS3, 
	L_CITY, 
	L_STATE,
	L_ZIP, 
	ISIN, 
	SCRIP_CD,
	SCHEME_NAME,
	QTY, 
	CLTDPID, 
	DPID, 
	ISETT_NO, 
	ISETT_TYPE, 
	TRANSDATE, 
	EXCH, 
	REMARK
)  
EXEC @SQL @STATUSID, @STATUSNAME, @FROMTRDATE, @TOTRDATE, @FPARTY_CD, @TPARTY_CD, @BRANCH

UPDATE 
	#HOLDPAYOUT 
SET 
	COMPANYNAME = (SELECT LTRIM(RTRIM(COMPANY)) FROM MSAJAG.DBO.OWNER)

UPDATE 
	#HOLDPAYOUT 
SET 
	FROMDATE = CONVERT(VARCHAR(11),@FROMTRDATE,109),
	TODATE = CONVERT(VARCHAR(11),@TOTRDATE,109)

SELECT 
	PARTY_CODE, 
	LONG_NAME, 
	L_ADDRESS1, 
	L_ADDRESS2, 
	L_ADDRESS3, 
	L_CITY, 
	L_STATE,
	L_ZIP,
	(EXCH +'/'+ SETT_NO +'-' + SETT_TYPE) AS PAYOUTSETT,
	SCRIP_CD,
	SCHEME_NAME, 
	ISIN, 
	TRANSDATE, 
	QTY, 
	CLTDPID, 
	DPID, 
	REMARK,
	COMPANYNAME,
	(FROMDATE+' to '+TODATE) AS DATE
FROM 
	#HOLDPAYOUT

DROP TABLE #HOLDPAYOUT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_Rpt_NseDelAucRep
-- --------------------------------------------------

-- Exec  msajag.dbo.Rpt_NseDelAucRep '2007096','A';Select * From msajag.dbo.DelAucReport Where AuctionPart Like 'F%' Order By Scrip_Cd,Buyer,Seller
--exec Wrapper_Rpt_NseDelAucRep '2007096','A','FL'
--CREATED BY PIYUSH
CREATE PROC [dbo].[Wrapper_Rpt_NseDelAucRep]
(
	@SETT_NO	VARCHAR(7),
	@SETT_TYPE	VARCHAR(2),
	@OPTION		VARCHAR(3)
) AS
BEGIN


CREATE TABLE #TEMP_NSEDELAUCREP
(
	BUYER		VARCHAR(10),
	BNAME		VARCHAR(21),
	SCRIP_CD	VARCHAR(10),
	SERIES		CHAR(3),
	AUCTIONPART	VARCHAR(2),
	QTY			INT,
	SELLER		VARCHAR(10),
	SNAME		VARCHAR(21),
	SETTNO		VARCHAR(7),
	SETTTYPE	VARCHAR(2)
)
EXEC  MSAJAG.DBO.RPT_NSEDELAUCREP @SETT_NO=@SETT_NO,@SETT_TYPE=@SETT_TYPE
INSERT INTO #TEMP_NSEDELAUCREP (BUYER,BNAME,SCRIP_CD,SERIES,AUCTIONPART,QTY,SELLER,SNAME,SETTNO,SETTTYPE)
	
SELECT 
	BUYER,
	BNAME,
	SCRIP_CD,
	SERIES,
	AUCTIONPART,
	QTY,
	SELLER,
	SNAME,
	SETTNO,
	SETTTYPE
FROM   
	MSAJAG.DBO.DELAUCREPORT
WHERE 
	AUCTIONPART LIKE @OPTION+'%' 
ORDER BY 
	SCRIP_CD,BUYER,SELLER

SELECT 
	*,
	REMARK = CASE WHEN AUCTIONPART='FS' THEN 'Market Shortage' 
				 WHEN AUCTIONPART='FP'THEN 'Market Purchase' 
				 WHEN AUCTIONPART='FC'THEN 'CloseOut' 
				 WHEN AUCTIONPART='FL'THEN 'Late PayIn' 
			END
 FROM
	#TEMP_NSEDELAUCREP
  DROP TABLE #TEMP_NSEDELAUCREP
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_rpt_NSEDelCertinfo
-- --------------------------------------------------

--exec msajag.dbo.WRAPPER_RPT_NSEDELCERTINFO @TARGETID='1',@SETTNO='2006030',@SETTYPE='N',@PARTYCODE='0A146',@SCRIPCD='ALEMBICLTD',@SERIES ='EQ'
--exec WRAPPER_RPT_NSEDELCERTINFO '1','2006030','n','IDBI','EQ','0A146'  
  --CREATED BY PIYUSH

CREATE PROCEDURE [dbo].[Wrapper_rpt_NSEDelCertinfo] 
(     
	@TARGETID VARCHAR(2),      
	@SETTNO VARCHAR(7),
	@SETTYPE VARCHAR(3), 
	@PARTYCODE VARCHAR(20),     
	@SCRIPCD VARCHAR(50),      
	@SERIES VARCHAR(3),
    @SHAREDB VARCHAR(20) ='MSAJAG'      
) 
      
AS
BEGIN  
 DECLARE @SQL VARCHAR(MAX)

CREATE TABLE #TEMP_NSEDELCERTINFO  
(  
 SETT_NO  VARCHAR(7),  
 SETT_TYPE VARCHAR(2),  
 PARTY_CODE VARCHAR(12),  
 SCRIP_CD VARCHAR(30),  
 SERIES  VARCHAR(3),
 scheme_name varchar(200), 
 QTY NUMERIC(18, 3),  
 TRANSDATE DATETIME,  
 CERTNO VARCHAR(16),  
 HOLDERNAME VARCHAR(100),  
 FOLIONO VARCHAR(16),  
 TRTYPE NUMERIC(9, 0),  
 REASON VARCHAR(100),  
 CLTDPID VARCHAR(16),  
 DPID VARCHAR(16),  
 DPTYPE VARCHAR(10),  
 BCLTDPID VARCHAR(16),  
 BDPID VARCHAR(16),  
 BDPTYPE VARCHAR(10),  
 DELIVERED CHAR(1),  
 ISETT_NO VARCHAR(7),  
 ISETT_TYPE VARCHAR(3)  
)  

SET @SQL = 	@SHAREDB + '.DBO.RPT_NSEDELCERTINFO'
 INSERT INTO #TEMP_NSEDELCERTINFO  
 EXEC @SQL @TARGETID=@TARGETID,@SETTNO=@SETTNO,@SETTYPE=@SETTYPE,@SCRIPCD=@SCRIPCD,@SERIES=@SERIES,@PARTYCODE=@PARTYCODE  
  
SELECT 
	SETT_NO,
	SETT_TYPE,
	PARTY_CODE,
	SCRIP_CD,
	SERIES,
    scheme_name,
	QTY,
	CONVERT(VARCHAR(11),TRANSDATE,103) as DATE1,   
	CERTNO,
	HOLDERNAME,
	FOLIONO,
	TRTYPE,
	REASON,
	CLTDPID,
	DPID,
	DPTYPE,
	BCLTDPID,  
	BDPID,
	BDPTYPE,
	DELIVERED,
	ISETT_NO,
	ISETT_TYPE,
	CASE WHEN LTRIM(RTRIM(@TARGETID)) = 1 THEN 'C' ELSE 'D' END AS DRCR,  
	CASE WHEN LTRIM(RTRIM(TRTYPE)) = '907' and LTRIM(RTRIM(@TARGETID)) = 1 THEN  'INST from '  + ISETT_NO  + '-' + ISETT_TYPE     
		 WHEN LTRIM(RTRIM(TRTYPE)) = '907' and LTRIM(RTRIM(@TARGETID)) = 2 THEN  'INST To '  + ISETT_NO  + '-' + ISETT_TYPE  
		 WHEN LTRIM(RTRIM(TRTYPE)) = '908' THEN  'INST POA from'  + ISETT_NO  + '-' + ISETT_TYPE  
		 WHEN LTRIM(RTRIM(TRTYPE)) = '1000' THEN  'INST BEN For'  + ISETT_NO  + '-' + ISETT_TYPE  
		 ELSE  
			REASON  
		 END  
		 AS REASON1,  
	CASE WHEN LTRIM(RTRIM(DELIVERED)) = 'D' THEN 'Delivered'   
		 WHEN  LTRIM(RTRIM(DELIVERED)) = 'G' THEN 'Generated'   
		 WHEN  LTRIM(RTRIM(@TARGETID)) = 1 THEN 'Received' ELSE 'Pending' END  
		 AS STATUS  
        
FROM #TEMP_NSEDELCERTINFO  
 
DROP TABLE  #TEMP_NSEDELCERTINFO
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_rpt_NSEDelClientScrips
-- --------------------------------------------------
  
--exec [Wrapper_rpt_NSEDelClientScrips] @STATUSID='BROKER',@STATUSNAME='BROKER',@DEMATID='3',@SETTNO='2006030',@SETTYPE='N',@PARTYCODE='0A146',@SHAREDB = 'BSEMFSS'  
--exec MSAJAG.dbo.Wrapper_rpt_NSEDelClientScrips @STATUSID='BROKER',@STATUSNAME='BROKER',@DEMATID='3',@SETTNO='2006030',@SETTYPE='N',@PARTYCODE='0A146'  
CREATE PROCEDURE [dbo].[Wrapper_rpt_NSEDelClientScrips]   
(       
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),        
 @DEMATID VARCHAR(2),        
 @SETTNO VARCHAR(7),        
 @SETTYPE VARCHAR(3),        
 @partycode varchar(20),  
    @SHAREDB VARCHAR(20) 
)       
AS  
BEGIN  
DECLARE @SQL VARCHAR(MAX)  
CREATE TABLE #TEMP_NSEDelClientScrips  
(  
 SETT_NO  VARCHAR(7),  
 SETT_TYPE VARCHAR(2),  
 PARTY_CODE VARCHAR(12),  
 SHORT_NAME VARCHAR(30),  
 SCRIP_CD VARCHAR(30),  
 SERIES  VARCHAR(3),  
    SCHEME_NAME VARCHAR(200),  
 INOUT VARCHAR(2),  
 QTY NUMERIC(18, 3),  
 RECQTY NUMERIC(18, 3),  
 GIVENQTY NUMERIC(18, 3)  
)  
SET @SQL =  @SHAREDB + '.DBO.rpt_NSEDelClientScrips'  
 INSERT INTO #TEMP_NSEDelClientScrips  
 EXEC  @SQL @STATUSID=@STATUSID,@STATUSNAME=@STATUSNAME,@DEMATID=@DEMATID,@SETTNO=@SETTNO,@SETTYPE=@SETTYPE,@partycode=@partycode  
   
SELECT   
 SETT_NO,  
 SETT_TYPE,  
 PARTY_CODE,  
 SHORT_NAME,  
 SCRIP_CD,  
 SERIES,  
    SCHEME_NAME,  
 INOUT,  
 CASE WHEN LTRIM(RTRIM(INOUT)) = 'I' THEN (CONVERT(NUMERIC(18,3),-QTY)) ELSE CONVERT(NUMERIC(18,3),+QTY) END AS QTY,  
 RECQTY,  
 GIVENQTY,  
 CASE WHEN LTRIM(RTRIM(INOUT)) = 'I' THEN (CONVERT(NUMERIC(18,3),-QTY + RECQTY - GIVENQTY)) ELSE CONVERT(NUMERIC(18,3),QTY + RECQTY -GIVENQTY) END AS SHORTAGE  
   
FROM   
 #TEMP_NSEDelClientScrips  
  
DROP TABLE #TEMP_NSEDelClientScrips  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_rpt_NSEDelClientSettScrip_new
-- --------------------------------------------------

--exec MSAJAG.DBO.rpt_NSEDelClientSettScrip_NEW 'idbi','EQ','0a146'
-- Exec Wrapper_rpt_NSEDelClientSettScrip_NEW 'idbi','EQ','0a146'
--CREATED By Piyush
CREATE PROCEDURE [dbo].[Wrapper_rpt_NSEDelClientSettScrip_new]
(        
	@SCRIPCD VARCHAR(20),
	@SERIES VARCHAR(3),
	@PARTYCODE VARCHAR(10),
    @SHAREDB VARCHAR(20) ='MSAJAG'    
)
AS
BEGIN   
DECLARE @SQL VARCHAR(MAX) 
	CREATE TABLE #TEMP_NSEDELCLIENTSETTSCRIP_NEW    
	(
		 SETT_NO VARCHAR(7),    
		 SETT_TYPE VARCHAR(2),
		 PARTY_CODE VARCHAR(10),
		 SHORT_NAME VARCHAR(21),     
		 SCRIP_CD VARCHAR(20),    
		 SERIES  VARCHAR(3),
		 SCHEME_NAME VARCHAR(200),
		 BUYQTY NUMERIC(18, 3),        
		 SELLQTY NUMERIC(18, 3),    
		 RECQTY NUMERIC(18, 3),    
		 GIVENQTY NUMERIC(18, 3),
		 DEMAT_DATE VARCHAR(12),
		 BUYSHORTAGE NUMERIC(18,3),
		 SELLSHORTAGE NUMERIC(18,3)
	 ) 
   SET @SQL = 	@SHAREDB + '.DBO.RPT_NSEDELCLIENTSETTSCRIP_NEW'

	 INSERT INTO #TEMP_NSEDELCLIENTSETTSCRIP_NEW  
	 (
		SETT_NO,
		SETT_TYPE,
		PARTY_CODE,
		SHORT_NAME,
		SCRIP_CD,
		SERIES,
		SCHEME_NAME,
		BUYQTY,	
		SELLQTY,
		RECQTY,
		GIVENQTY,
		DEMAT_DATE
	 )
	 EXEC @SQL @SCRIPCD=@SCRIPCD,@SERIES=@SERIES,@PARTYCODE=@PARTYCODE
	 
	UPDATE
		#TEMP_NSEDELCLIENTSETTSCRIP_NEW
	SET
		BUYSHORTAGE = (BUYQTY- GIVENQTY),
		SELLSHORTAGE = (SELLQTY-RECQTY)
		
	UPDATE
		#TEMP_NSEDELCLIENTSETTSCRIP_NEW
	SET
		BUYSHORTAGE = 0,
		SELLSHORTAGE = SELLSHORTAGE - BUYSHORTAGE
	WHERE
		BUYSHORTAGE < 0
	UPDATE
		#TEMP_NSEDELCLIENTSETTSCRIP_NEW
	SET
		SELLSHORTAGE = 0,
		BUYSHORTAGE = BUYSHORTAGE - SELLSHORTAGE
	WHERE
		SELLSHORTAGE < 0

	SELECT 
			SETT_NO,
			SETT_TYPE,
			PARTY_CODE,
			SHORT_NAME,
			SCRIP_CD,
			SERIES,
			SCHEME_NAME,
			BUYQTY,
			SELLQTY = -SELLQTY,
			RECQTY,
			GIVENQTY,
			SELLSHORTAGE = -SELLSHORTAGE,
			BUYSHORTAGE
	FROM 
			#TEMP_NSEDELCLIENTSETTSCRIP_NEW

	DROP TABLE #TEMP_NSEDELCLIENTSETTSCRIP_NEW  

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_Rpt_NseDelExeReport
-- --------------------------------------------------

--EXEC Wrapper_Rpt_NseDelExeReport '29/09/2010','','','0','z','0','z','MSAJAG'
--CREATED BY PIYUSH
CREATE PROC [dbo].[Wrapper_Rpt_NseDelExeReport]     
(
	 @TDATE VARCHAR(11),    
	 @BDPID VARCHAR(8),    
	 @BCLTDPID VARCHAR(16),    
	 @FPARTY VARCHAR(10),    
	 @TPARTY VARCHAR(10),    
	 @FSCRIP VARCHAR(12),    
	 @TSCRIP VARCHAR(12),
	 @SHAREDB VARCHAR(20)    
) 
AS
BEGIN
CREATE TABLE #NSEDELEXEREPORT
(
	SETT_NO VARCHAR(7),
	SETT_TYPE VARCHAR(3),
	PARTY_CODE VARCHAR(10),
	SHORT_NAME VARCHAR(100),
	SCRIP_CD VARCHAR(16),
	SERIES VARCHAR(3),
	SCHEME_NAME VARCHAR(200),
	QTY NUMERIC(18,3),
	CERTNO VARCHAR(16),
	FROMNO VARCHAR(16),
	DPTYPE VARCHAR(10),
	DPID VARCHAR(16),
	CLTDPID VARCHAR(16),
	ISETT_NO VARCHAR(7),
	ISETT_TYPE VARCHAR(3),
	REMARK VARCHAR(100)
)
DECLARE @SQL VARCHAR(MAX)
SET @SQL= @SHAREDB + '.DBO.RPT_NSEDELEXEREPORT'
INSERT INTO #NSEDELEXEREPORT
 EXEC @SQL @TDATE,@BDPID,@BCLTDPID,@FPARTY,@TPARTY,@FSCRIP,@TSCRIP

SELECT	
		SETT_NO,
		SETT_TYPE,
		PARTY_CODE,
		SHORT_NAME,
		SCRIP_CD,
		SERIES,
		SCHEME_NAME,
		QTY,
		CERTNO,
		FROMNO,
		DPTYPE = CASE WHEN ISETT_NO <> '' THEN '' ELSE DPTYPE END,
		DPID = CASE WHEN ISETT_NO <> '' THEN '' ELSE DPID END ,
		CLTDPID = CASE WHEN ISETT_NO <> '' THEN '' ELSE CLTDPID END,
		ISETT_NO,
		ISETT_TYPE,
		REMARK,
		EXEDATE = CONVERT(VARCHAR(11),@TDATE,109)
FROM 
	#NSEDELEXEREPORT

DROP TABLE #NSEDELEXEREPORT
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_RPT_NSEDELGET
-- --------------------------------------------------

--exec RPT_NSEDELGIVE '3','1011186','T3'
--exec Wrapper_RPT_NSEDELGET '3','1011186','T3','BSEMFSS'
--Created By Piyush
CREATE PROCEDURE [dbo].[Wrapper_RPT_NSEDELGET] 
(         
	@DEMATID VARCHAR(2),          
	@SETT_NO VARCHAR(7),          
	@SETT_TYPE VARCHAR(3),
    @SHAREDB VARCHAR(20) ='MSAJAG' 
)       
AS
BEGIN
DECLARE @SQL VARCHAR(MAX)

CREATE TABLE #TEMP_NSEDELGET
(
	SETT_NO		VARCHAR(7),
	SETT_TYPE	VARCHAR(2),
	SCRIP_CD	VARCHAR(30),
    SERIES VARCHAR(200),
    SERIES_TEST VARCHAR(3),
	GIVENSE	NUMERIC(18, 3),
	RECEIVENSE	NUMERIC(18, 3),
	GIVENNSE NUMERIC(18, 3),
	RECEIVEDNSE	NUMERIC(18, 3),
	CL_RATE NUMERIC(18, 2),
)

SET @SQL = 	@SHAREDB + '.DBO.RPT_NSEDELGIVE'
INSERT INTO #TEMP_NSEDELGET
EXEC @SQL @DEMATID=@DEMATID,@SETT_NO=@SETT_NO,@SETT_TYPE=@SETT_TYPE

ALTER TABLE #TEMP_NSEDELGET ADD SHORTAGE NUMERIC

UPDATE 
	#TEMP_NSEDELGET 
SET 
	SHORTAGE = GIVENSE - GIVENNSE  FROM #TEMP_NSEDELGET 


SELECT 
	SETT_NO,
	SETT_TYPE,
	SCRIP_CD,	
    SERIES,
    SERIES_TEST,
	GIVENSE,
	RECEIVENSE,
	GIVENNSE,
	RECEIVEDNSE
	,SHORTAGE = CASE WHEN (RECEIVEDNSE - RECEIVENSE) > 0  THEN (SHORTAGE + RECEIVEDNSE - RECEIVENSE) ELSE SHORTAGE END
FROM 
	#TEMP_NSEDELGET
WHERE 
	GIVENSE > 0  
ORDER BY 
	SETT_NO,SETT_TYPE,SCRIP_CD,SERIES
	
DROP TABLE #TEMP_NSEDELGET

END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_RPT_NSEDELGIVE
-- --------------------------------------------------

--exec RPT_NSEDELGIVE '3','2006030','n'
--exec Wrapper_RPT_NSEDELGIVE '3','2006030','n','MSAJAG'
--Created By Piyush
CREATE PROCEDURE [dbo].[Wrapper_RPT_NSEDELGIVE]
(
	@DEMATID VARCHAR(2),
	@SETT_NO VARCHAR(7),
	@SETT_TYPE VARCHAR(3),
	@SHAREDB VARCHAR(20) ='MSAJAG'
)
AS
BEGIN
DECLARE @SQL VARCHAR(MAX)
CREATE TABLE #TEMP_NSEDELGIVE
(
	SETT_NO		VARCHAR(7),
	SETT_TYPE	VARCHAR(2),
	SCRIP_CD	VARCHAR(30),
	SERIES		VARCHAR(200),
    SERIES_TEST VARCHAR(3),
	GIVENSE	NUMERIC(18, 3),
	RECEIVENSE	NUMERIC(18, 3),
	GIVENNSE NUMERIC(18, 3),
	RECEIVEDNSE	NUMERIC(18, 3),
	CL_RATE NUMERIC(18, 4)
)
SET @SQL = 	@SHAREDB + '.DBO.RPT_NSEDELGIVE'

	INSERT INTO #TEMP_NSEDELGIVE
	EXEC @SQL @DEMATID=@DEMATID,@SETT_NO=@SETT_NO,@SETT_TYPE=@SETT_TYPE
	SELECT
		SETT_NO,
		SETT_TYPE,
		SCRIP_CD,
		SERIES,
        SERIES_TEST,
		GIVENSE,
		RECEIVENSE,
		GIVENNSE,
		RECEIVEDNSE,
		SHORTAGE = (RECEIVENSE - RECEIVEDNSE) + CASE WHEN (GIVENNSE - GIVENSE) > 0 THEN (GIVENNSE - GIVENSE) ELSE 0 END
	FROM
		#TEMP_NSEDELGIVE
	WHERE
		RECEIVENSE > 0
	ORDER BY
		SETT_NO,
		SETT_TYPE,
		SCRIP_CD,
		SERIES
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WRAPPER_RPT_NSEDELHOLDPARTY
-- --------------------------------------------------

CREATE PROC [dbo].[WRAPPER_RPT_NSEDELHOLDPARTY]  
(  
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@FROMPARTY VARCHAR(10),        
	@TOPARTY VARCHAR(10),
	@FROMSCRIP VARCHAR(12),      
	@TOSCRIP VARCHAR(12),
	@BDPID VARCHAR(8),      
	@BCLTDPID VARCHAR(16),
	@BRANCH VARCHAR(10),
	@SHAREDB VARCHAR(20)
)  
AS
/*
EXEC WRAPPER_RPT_NSEDELHOLDPARTY @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMPARTY='001A000001',@TOPARTY='0A149',@FROMSCRIP='AARTIIND',@TOSCRIP='ABB',@BDPID='',@BCLTDPID='',@BRANCH='%','MSAJAG'
Created By Piyush
*/
 CREATE TABLE #HOLDPARTY  
(
 SCRIP_CD VARCHAR(20),  
 SERIES VARCHAR(3),
 SCHEME_NAME VARCHAR(200),
 PARTY_CODE VARCHAR(10),  
 SETT_NO VARCHAR(7),  
 SETT_TYPE VARCHAR(2),
 QTY NUMERIC(18,3),
 CERTNO VARCHAR(16),
 BDPID VARCHAR(8),
 BCLTDPID VARCHAR(16),
 HOLDQTY NUMERIC(18,3),
 PLEDGEQTY NUMERIC(18,3),
 PARTY_NAME VARCHAR(100),
 LONG_NAME VARCHAR(100)
)
DECLARE @SQL VARCHAR(MAX)
SET @SQL= @SHAREDB + '.DBO.RPT_NSEDELHOLDPARTY'
INSERT INTO #HOLDPARTY
(
	SCRIP_CD, 
	SERIES, 
	SCHEME_NAME,
	PARTY_CODE, 
	SETT_NO, 
	SETT_TYPE, 
	QTY, 
	CERTNO, 
	BDPID, 
	BCLTDPID, 
	HOLDQTY, 
	PLEDGEQTY, 
	PARTY_NAME, 
	LONG_NAME
)  
EXEC @SQL @STATUSID, @STATUSNAME, @FROMPARTY, @TOPARTY, @FROMSCRIP, @TOSCRIP, @BDPID, @BCLTDPID, @BRANCH

SELECT 
	SCRIP_CD, 
	SERIES, 
	SCHEME_NAME,
	PARTY_CODE, 
	CERTNO, 
	BDPID, 
	BCLTDPID,
	SETT_TYPE,
	SETT_NO,
	(LTRIM(RTRIM(SETT_TYPE)) + '-' + LTRIM(RTRIM(SETT_NO))) AS SETTLEMENT_NO, 
	HOLDQTY, 
	PLEDGEQTY, 
	QTY, 
	PARTY_NAME, 
	LONG_NAME,
	(LTRIM(RTRIM(SCRIP_CD)) + '-' + LTRIM(RTRIM(SERIES))) AS SCRIP_SERIES 
FROM 
	#HOLDPARTY
	ORDER BY PARTY_CODE, SCHEME_NAME, SETT_NO, SETT_TYPE

DROP TABLE #HOLDPARTY

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WRAPPER_RPT_NSEDELHOLDSCRIP
-- --------------------------------------------------

CREATE PROC [dbo].[WRAPPER_RPT_NSEDELHOLDSCRIP]  
(  
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@FROMPARTY VARCHAR(10),        
	@TOPARTY VARCHAR(10),
	@FROMSCRIP VARCHAR(12),      
	@TOSCRIP VARCHAR(12),
	@BDPID VARCHAR(8),      
	@BCLTDPID VARCHAR(16),
	@BRANCH VARCHAR(10),
	@SHAREDB VARCHAR(20)
)  
AS
/*
EXEC WRAPPER_RPT_NSEDELHOLDSCRIP @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMPARTY='0A141',@TOPARTY='0A141',@FROMSCRIP='0',@TOSCRIP='ZZ',@BDPID='',@BCLTDPID='',@BRANCH='%',@SHAREDB='MSAJAG'
Created By Piyush
*/
 CREATE TABLE #HOLDSCRIP  
(
 SCRIP_CD VARCHAR(20),  
 SERIES VARCHAR(3),
 SCHEME_NAME VARCHAR(200),
 PARTY_CODE VARCHAR(10),
 LONG_NAME VARCHAR(100),
 SETT_NO VARCHAR(7),  
 SETT_TYPE VARCHAR(2),
 QTY NUMERIC(18,3),
 CERTNO VARCHAR(16),
 BDPID VARCHAR(8),
 BCLTDPID VARCHAR(16),
 HOLDQTY NUMERIC(18,3),
 PLEDGEQTY NUMERIC(18,3) 
)
DECLARE @SQL VARCHAR(MAX)
SET @SQL= @SHAREDB + '.DBO.RPT_NSEDELHOLDSCRIP'
INSERT INTO #HOLDSCRIP
(
	SCRIP_CD, 
	SERIES, 
	SCHEME_NAME,
	PARTY_CODE, 
	LONG_NAME, 
	SETT_NO, 
	SETT_TYPE, 
	QTY, 
	CERTNO,		
	BDPID, 
	BCLTDPID, 
	HOLDQTY, 
	PLEDGEQTY 
)  
EXEC @SQL @STATUSID, @STATUSNAME, @FROMPARTY, @TOPARTY, @FROMSCRIP, @TOSCRIP, @BDPID, @BCLTDPID, @BRANCH

SELECT 
	(LTRIM(RTRIM(PARTY_CODE)) + ' ' + LTRIM(RTRIM(LONG_NAME))) AS PARTY_CD, 
	BDPID, 
	BCLTDPID, 
	SETT_TYPE,
	SETT_NO,
	(SETT_TYPE + '-' + SETT_NO) AS SETTLEMENT_NO, 
	HOLDQTY, 
	PLEDGEQTY, 
	QTY ,
	(SCHEME_NAME+' ('+ CERTNO +') ') AS SCRIP_CODE,
	SCRIP_CD,
	SERIES,
	SCHEME_NAME,
	PARTY_CODE
FROM 
	#HOLDSCRIP 
ORDER BY 
	SCHEME_NAME,PARTY_CODE

DROP TABLE #HOLDSCRIP

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WRAPPER_RPT_NSEDELHOLDSUM
-- --------------------------------------------------

CREATE PROC [dbo].[WRAPPER_RPT_NSEDELHOLDSUM]
(
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@HOLDDATE VARCHAR(11),
	@BDPID VARCHAR(8),
	@BCLTDPID VARCHAR(16),
	@SHAREDB VARCHAR(20)
)
AS
/*
    CREATED BY PIYUSH
	EXEC WRAPPER_RPT_NSEDELHOLDSUM 'BROKER', 'BROKER', 'SEP 23 2010', 'IN302201', '10000087','MSAJAG'
	Created By Piyush
*/
IF LEN(@HOLDDATE) = 10 AND CHARINDEX('/', @HOLDDATE) > 0
	BEGIN
		SET @HOLDDATE = CONVERT(VARCHAR(11), CONVERT(DATETIME, @HOLDDATE, 103), 109)
	END
CREATE TABLE #HOLDSUM
(
	SRNO INT IDENTITY(1,1),
	SCRIP_CD VARCHAR(20),
	SERIES VARCHAR(3),
	SCHEME_NAME VARCHAR(200),
	CERTNO VARCHAR(16),
	SETT_NO VARCHAR(7),
	SETT_TYPE VARCHAR(2),
	QTY NUMERIC(18,3),
	TQTY VARCHAR(18)
)
DECLARE  @SQL VARCHAR(MAX)
SET @SQL= @SHAREDB +'.dbo.RPT_NSEDELHOLDSUM'
INSERT INTO #HOLDSUM(SCRIP_CD, SERIES, SCHEME_NAME, CERTNO, SETT_NO, SETT_TYPE, QTY)
EXEC @SQL @STATUSID, @STATUSNAME, @HOLDDATE, @BDPID, @BCLTDPID

UPDATE 
	#HOLDSUM 
SET 
	TQTY = (SELECT CONVERT(VARCHAR(18), SUM(QTY)) FROM #HOLDSUM I WHERE I.SCRIP_CD = #HOLDSUM.SCRIP_CD
							AND I.SERIES = #HOLDSUM.SERIES AND I.SRNO <= #HOLDSUM.SRNO)

SELECT
	MSRNO = MAX(SRNO),
	NSRNO = MIN(SRNO),
	SCRIP_CD,
	SERIES
INTO
	#GROUPED
FROM
	#HOLDSUM
GROUP BY
	SCRIP_CD,
	SERIES
	
UPDATE
	#HOLDSUM
SET
	TQTY = ''
FROM
	#GROUPED G
WHERE
	#HOLDSUM.SCRIP_CD = G.SCRIP_CD
	AND #HOLDSUM.SERIES = G.SERIES
	AND #HOLDSUM.SRNO < G.MSRNO
UPDATE
	#HOLDSUM
SET
	SCRIP_CD = '',
	SERIES = '',
	CERTNO = ''
FROM
	#GROUPED G
WHERE
	#HOLDSUM.SCRIP_CD = G.SCRIP_CD
	AND #HOLDSUM.SERIES = G.SERIES
	AND #HOLDSUM.SRNO > G.NSRNO
SELECT 
	SCRIP_CD,
	SERIES,
	SCHEME_NAME,
	CERTNO,
	SETT_NO,
	SETT_TYPE,
	QTY,
	TQTY,
	SETT_DESC = SETT_TYPE + '-' + SETT_NO
FROM
	#HOLDSUM
ORDER BY
	SRNO
--SELECT * FROM #GROUPED ORDER BY SRNO
--Exec Rpt_NseDelHoldSum 'broker','broker','Sep 23 2010','IN302201','10000087'

--SELECT * FROM MSAJAG.dbo.DELTRANS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WRAPPER_RPT_NSEDELINTERBEN_NEW
-- --------------------------------------------------

CREATE PROC [dbo].[WRAPPER_RPT_NSEDELINTERBEN_NEW]  
(  
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@SETTNO VARCHAR(7),        
	@SETT_TYPE VARCHAR(2),
	@ISETTNO VARCHAR(7),      
	@FLAG NUMERIC,
	@STATUS NUMERIC,
	@SHAREDB VARCHAR(20)
)  
AS
set dateformat dmy
/*
EXEC WRAPPER_RPT_NSEDELINTERBEN_NEW @STATUSID='BROKER',@STATUSNAME='BROKER',@SETTNO='%',@SETT_TYPE='N',@ISETTNO='2007098',@FLAG=1, @STATUS=1
Exec MSAJAG.DBO.Rpt_NseDelInterBen_new 'broker','broker','%','N','2007098',1,1
CREATED BY PIYUSH
*/
 CREATE TABLE #HOLDINTERBEN  
(
 ISIN VARCHAR(16),  
 PARTY_CODE VARCHAR(10),
 SHORT_NAME VARCHAR(100),
 SETT_NO VARCHAR(7),  
 SETT_TYPE VARCHAR(2),
 SCRIP_CD VARCHAR(16),
 SLIPNO VARCHAR(10),
 QTY NUMERIC,
 DELIVERED VARCHAR(10),
 ISETT_NO VARCHAR(12),
 ISETT_TYPE VARCHAR(2),
 CLTDPID VARCHAR(20),
 HOLDERNAME VARCHAR(20) 
)
DECLARE @SQL VARCHAR(MAX)
SET @SQL= @SHAREDB + '.DBO.RPT_NSEDELINTERBEN_NEW'

INSERT INTO #HOLDINTERBEN
(
	ISIN, 
	PARTY_CODE, 
	SHORT_NAME, 
	SETT_NO, 
	SETT_TYPE, 
	SCRIP_CD, 
	SLIPNO, 
	QTY, 
	DELIVERED, 
	ISETT_NO, 
	ISETT_TYPE, 
	CLTDPID, 
	HOLDERNAME
)  
EXEC @SQL @STATUSID, @STATUSNAME, @SETTNO, @SETT_TYPE, @ISETTNO, @FLAG, @STATUS

SELECT 
	ISIN, 
	PARTY_CODE, 
	SHORT_NAME, 
	(SETT_TYPE + ' - ' + SETT_NO) AS SETT_NO, 
	SCRIP_CD, 
	QTY, 
	(ISETT_TYPE + ' - ' + ISETT_NO) AS ISETT_NO, 
	SLIPNO, 
	DELIVERED, 
	CLTDPID
FROM 
	#HOLDINTERBEN

DROP TABLE #HOLDINTERBEN

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WRAPPER_RPT_NSEDELINTERSETT
-- --------------------------------------------------

CREATE PROC [dbo].[WRAPPER_RPT_NSEDELINTERSETT]  
(  
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@SETTNO VARCHAR(7),        
	@SETT_TYPE VARCHAR(2),
	@ISETTNO VARCHAR(7),      
	@FLAG VARCHAR(1),
	@SHAREDB VARCHAR(20)
)  
AS
SET DATEFORMAT dmy
/*
EXEC WRAPPER_RPT_NSEDELINTERSETT @STATUSID='BROKER',@STATUSNAME='BROKER',@SETTNO='2006040',@SETT_TYPE='N',@ISETTNO='2006063',@FLAG='S',@SHAREDB='MSAJAG'
Created By Piyush
*/
 CREATE TABLE #HOLDINTERSETT  
(
 ISIN VARCHAR(16),  
 PARTY_CODE VARCHAR(10),
 SHORT_NAME VARCHAR(100),
 SETT_NO VARCHAR(7),  
 SETT_TYPE VARCHAR(2),
 SCRIP_CD VARCHAR(16),
 SLIPNO VARCHAR(10),
 QTY NUMERIC,
 DELIVERED VARCHAR(10),
 ISETT_NO VARCHAR(12),
 ISETT_TYPE VARCHAR(2),
 BDPID VARCHAR(10),
 BCLTDPID VARCHAR(20),
 TRANSDATE VARCHAR(11) 
)
DECLARE @SQL VARCHAR(MAX)
SET @SQL= @SHAREDB + '.DBO.RPT_NSEDELINTERSETT'

INSERT INTO #HOLDINTERSETT
(
	ISIN, 
	PARTY_CODE, 
	SHORT_NAME, 
	SETT_NO, 
	SETT_TYPE, 
	SCRIP_CD, 
	SLIPNO, 
	QTY, 
	DELIVERED, 
	ISETT_NO, 
	ISETT_TYPE, 
	BDPID, 
	BCLTDPID, 
	TRANSDATE
)  
EXEC @SQL @STATUSID, @STATUSNAME, @SETTNO, @SETT_TYPE, @ISETTNO, @FLAG

SELECT 
	ISIN, 
	PARTY_CODE, 
	SHORT_NAME, 
	(SETT_TYPE + ' - ' + SETT_NO) AS SETT_NO_TYPE, 
	SCRIP_CD, 
	SLIPNO, 
	QTY,
	(ISETT_TYPE + ' - ' + ISETT_NO) AS ISETT_NO,
	CONVERT(VARCHAR(11),TRANSDATE,106) AS TRANSDATE, 
	(CASE WHEN DELIVERED = '0' THEN 'Pending' WHEN DELIVERED = 'G' THEN 'Generated' ELSE  'Delivered' END) AS STATUS,
	BDPID,
	BCLTDPID
FROM 
	#HOLDINTERSETT

DROP TABLE #HOLDINTERSETT

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_rpt_NSEDelScripClients
-- --------------------------------------------------

--EXEC WRAPPER_RPT_NSEDELSCRIPCLIENTS 'BROKER','BROKER','3','2006030','A','ABANLOYD','eq'
--Created By Piyush
CREATE PROCEDURE [dbo].[Wrapper_rpt_NSEDelScripClients] 
(     
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),      
	@DEMATID VARCHAR(2),      
	@SETTNO VARCHAR(7),      
	@SETTYPE VARCHAR(3),      
	@SCRIPCD VARCHAR(20),      
	@SERIES VARCHAR(3) 
)     
AS
BEGIN

CREATE TABLE #TEMP_NSEDELSCRIPCLIENTS
(
	SETT_NO		VARCHAR(7),
	SETT_TYPE	VARCHAR(2),
	PARTY_CODE	VARCHAR(12),
	SHORT_NAME	VARCHAR(30),
	SCRIP_CD	VARCHAR(30),
	SERIES		VARCHAR(3),
	INOUT	VARCHAR(2),
	QTY	NUMERIC(18, 0),
	RECQTY NUMERIC(18, 0),
	GIVENQTY NUMERIC(18, 0),
	SRNO INT IDENTITY(1,1)
)
	INSERT INTO #TEMP_NSEDELSCRIPCLIENTS
	EXEC MSAJAG.DBO.RPT_NSEDELSCRIPCLIENTS @STATUSID=@STATUSID,@STATUSNAME=@STATUSNAME,@DEMATID=@DEMATID,@SETTNO=@SETTNO,@SETTYPE=@SETTYPE,@SCRIPCD=@SCRIPCD,@SERIES = @SERIES
	
SELECT 
	SRNO,
	SETT_NO,
	SETT_TYPE,
	PARTY_CODE,
	SHORT_NAME,
	SCRIP_CD,
	SERIES,
	INOUT,
	CASE WHEN LTRIM(RTRIM(INOUT)) = 'I' THEN (CONVERT(NUMERIC(18,0),-QTY)) ELSE CONVERT(NUMERIC(18,0),QTY) END AS QTY,
	RECQTY,
	GIVENQTY,
	CASE WHEN LTRIM(RTRIM(INOUT)) = 'I' THEN (CONVERT(NUMERIC(18,0),-QTY + RECQTY - GIVENQTY )) ELSE CONVERT(NUMERIC(18,0),QTY + RECQTY -GIVENQTY) END AS SHORTAGE,
	NETQTY = (SELECT ABS(SUM(QTY)) FROM #TEMP_NSEDELSCRIPCLIENTS I WHERE I.SRNO <= #TEMP_NSEDELSCRIPCLIENTS.SRNO)
	
FROM 
	#TEMP_NSEDELSCRIPCLIENTS

DROP TABLE #TEMP_NSEDELSCRIPCLIENTS
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WRAPPER_RPT_NSEDELSCRIPLIST
-- --------------------------------------------------

CREATE PROC [dbo].[WRAPPER_RPT_NSEDELSCRIPLIST]  
(  
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@SETTNO VARCHAR(7),        
	@SETT_TYPE VARCHAR(2),
	@SCRIP_CD VARCHAR(12),
	@SERIES VARCHAR(3),
    @SHAREDB VARCHAR(20) ='MSAJAG'
)  
AS
DECLARE @SQL VARCHAR(MAX)
--set dateformat dmy
/*
EXEC WRAPPER_RPT_NSEDELSCRIPLIST @STATUSID='BROKER',@STATUSNAME='BROKER',@SETTNO='2006030',@SETT_TYPE='N',@SCRIP_CD='%',@SERIES='%',@SHAREDB = 'BSEMFSS'
Exec MSAJAG.DBO.Rpt_NseDelScripList 'broker','broker','2006030','n','%%','%%'
Created By Piyush
*/
 CREATE TABLE #DELSCRIPLIST
(
 SCRIP_CD VARCHAR(40),  
 SERIES VARCHAR(2),
 SCHEME_NAME VARCHAR(200),
 QTY NUMERIC(18,3)
)
SET @SQL = 	@SHAREDB + '.DBO.RPT_NSEDELSCRIPLIST'

INSERT INTO #DELSCRIPLIST(SCRIP_CD,SERIES,SCHEME_NAME, QTY)  
EXEC @SQL @STATUSID, @STATUSNAME, @SETTNO, @SETT_TYPE, @SCRIP_CD, @SERIES

SELECT 
	SCRIP_CD, 
	SERIES, 
	SCHEME_NAME,
	(CASE WHEN QTY>0 THEN QTY ELSE (CASE WHEN QTY=0 THEN 0 END) END) AS INWARD,
	-(CASE WHEN QTY<0 THEN QTY ELSE (CASE WHEN QTY=0 THEN 0 END) END) AS OUTWARD
FROM 
	#DELSCRIPLIST

DROP TABLE #DELSCRIPLIST

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_Rpt_NseDelScripWise_New
-- --------------------------------------------------

CREATE PROCEDURE [dbo].[Wrapper_Rpt_NseDelScripWise_New]
(
@STATUSID VARCHAR(15), @STATUSNAME VARCHAR(25),@SETT_NO VARCHAR(7), @SETT_TYPE VARCHAR(2),@PARTY_CODE VARCHAR(10),    
@SCRIP_CD VARCHAR(12), @SERIES VARCHAR(3),@SHAREDB VARCHAR(20)
)

AS
BEGIN
DECLARE @SQL VARCHAR(MAX)

SET @SQL = 	@SHAREDB + '.DBO.Rpt_NseDelScripWise_New'

CREATE TABLE #TEMP
(
    SETT_NO VARCHAR(7),
	SETT_TYPE VARCHAR(3),
	PARTY_CODE VARCHAR(10),
	SHORT_NAME VARCHAR(100),
	SCRIP_CD VARCHAR(25),
	SERIES VARCHAR(3),
	SCHEME_NAME VARCHAR(200),
	BUYTRADEQTY NUMERIC(18, 3),
	BUYRECQTY NUMERIC(18, 3),
	SELLTRADEQTY NUMERIC(18, 3),
	SELLRECQTY NUMERIC(18, 3),
	BUYSHORTAGE NUMERIC(18, 3),
	SELLSHORTAGE NUMERIC(18, 3)
)
INSERT INTO #TEMP
exec  @SQL @STATUSID,@STATUSNAME,@SETT_NO,@SETT_TYPE,@PARTY_CODE,@SCRIP_CD,@SERIES

SELECT * FROM #TEMP
DROP TABLE #TEMP
END


--exec CLASSAPP.DBO.Wrapper_Rpt_NseDelScripWise_New @STATUSID='',@STATUSNAME='',@SETT_NO='2009301',@SETT_TYPE='U',@PARTY_CODE='%',@SCRIP_CD='B931D',@SERIES='DP',@SHAREDB='NSEMFSS'

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WRAPPER_RPT_NSEDELTRANSACTION
-- --------------------------------------------------

CREATE PROC [dbo].[WRAPPER_RPT_NSEDELTRANSACTION]    
(    
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),  
 @FROMDATE VARCHAR(12),          
 @TODATE VARCHAR(12),  
 @PARTY_CODE VARCHAR(10),        
 @SCRIP_CD VARCHAR(12),
 @SHAREDB VARCHAR(20)  
)    
AS
set dateformat dmy  
/*  
EXEC WRAPPER_RPT_NSEDELTRANSACTION @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMDATE='Sep 23 2009',@TODATE='Sep 23 2010',@PARTY_CODE='%',@SCRIP_CD='%'  
EXEC MSAJAG.DBO.RPT_NSEDELTRANSACTION 'BROKER','BROKER','Sep 23 2009','Sep 23 2010','%','%'
CREATED BY  PIYUSH
*/  
CREATE TABLE #HOLDTRANS    
(  
 SCRIP_CD VARCHAR(30),    
 SERIES VARCHAR(3),  
 SCHEME_NAME VARCHAR(200),
 PARTY_CODE VARCHAR(10),  
 SHORT_NAME VARCHAR(100),  
 SETT_NO VARCHAR(7),    
 SETT_TYPE VARCHAR(3),  
 TCODE varchar(16),  
 QTY NUMERIC(18,3),  
 TRANSNO VARCHAR(20),  
 DRCR VARCHAR(2),  
 TRANSDATE VARCHAR(11),  
 REASON VARCHAR(100),  
 CERTNO VARCHAR(16),  
 SLIPNO VARCHAR(20),  
 DPTYPE VARCHAR(16),  
 CLTDPNO VARCHAR(25),  
 DPID VARCHAR(16)   
)  
DECLARE @SQL VARCHAR(MAX)
SET @SQL= @SHAREDB + '.DBO.RPT_NSEDELTRANSACTION' 
INSERT INTO #HOLDTRANS
(	
	PARTY_CODE, 
	SHORT_NAME, 
	SCRIP_CD, 
	SERIES, 
	SCHEME_NAME,
	SETT_NO, 
	SETT_TYPE, 
	TCODE, 
	QTY, 
	TRANSNO, 
	DRCR, 
	TRANSDATE, 
	REASON, 
	CERTNO, 
	SLIPNO, 
	DPTYPE, 
	CLTDPNO, 
	DPID
)    
EXEC @SQL @STATUSID, @STATUSNAME, @FROMDATE, @TODATE, @PARTY_CODE, @SCRIP_CD  

SELECT 
	PARTY_CODE, 
	SHORT_NAME, 
	CERTNO, 
	SCRIP_CD, 
	SERIES,
	SCHEME_NAME, 
	(SETT_NO + ' / ' + SETT_TYPE) as SETT_NO, 
	SLIPNO,   
	(CASE WHEN DRCR='D' THEN QTY END) AS DEBIT,  
	(CASE WHEN DRCR='C' THEN QTY END) AS CREDIT,  
	CONVERT(VARCHAR(11),TRANSDATE,106) AS TRANSDATE,  
	DPTYPE,	
	DPID,
	CLTDPNO,
	REASON  
FROM 
	#HOLDTRANS 
	ORDER BY PARTY_CODE, SCHEME_NAME 

DROP TABLE #HOLDTRANS

GO

-- --------------------------------------------------
-- PROCEDURE dbo.WRAPPER_RPT_NSEDELTRANSFER
-- --------------------------------------------------

CREATE PROC [dbo].[WRAPPER_RPT_NSEDELTRANSFER]  
(  
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@FROMPARTY VARCHAR(10),        
	@TOPARTY VARCHAR(10),
	@FROMSCRIP VARCHAR(12),      
	@TOSCRIP VARCHAR(12),
	@FROMDATE VARCHAR(11),
    @TODATE VARCHAR(11),
	@SHAREDB VARCHAR(20)
)
AS
set dateformat dmy
/*
EXEC WRAPPER_RPT_NSEDELTRANSFER @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMPARTY='0a141',@TOPARTY='0a149',@FROMSCRIP='0',@TOSCRIP='ZZ', @FROMDATE='Apr 23 2005',@TODATE='Sep 23 2010',@SHAREDB='MSAJAG'
Exec MSAJAG.DBO.Rpt_NseDelTransfer 'broker','broker','0a141','0a149','0','ZZ','Apr 23 2005','Sep 23 2010'
Created By Piyush
*/
 CREATE TABLE #HOLDTRANSFER  
(
 SETT_NO VARCHAR(7),  
 SETT_TYPE VARCHAR(2),
 PARTY_CODE VARCHAR(10),
 LONG_NAME VARCHAR(100),
 SCRIP_CD VARCHAR(16),
 SERIES VARCHAR(3),
 SCHEME_NAME VARCHAR(200),
 QTY NUMERIC(18,3),
 DPID VARCHAR(20), 
 CLTDPID VARCHAR(20),
 TRANSDATE VARCHAR(11),
 BDPID VARCHAR(20), 
 BCLTDPID VARCHAR(20),
 TRTYPE VARCHAR(10), 
 ISETT_NO VARCHAR(12),
 ISETT_TYPE VARCHAR(2)
)
DECLARE @SQL VARCHAR(MAX)
SET @SQL= @SHAREDB + '.DBO.RPT_NSEDELTRANSFER'

INSERT INTO #HOLDTRANSFER
	(
		SETT_NO, 
		SETT_TYPE, 
		PARTY_CODE, 
		LONG_NAME, 
		SCRIP_CD, 
		SERIES, 
		SCHEME_NAME,
		QTY, 
		DPID, 
		CLTDPID, 
		TRANSDATE, 
		BDPID, 
		BCLTDPID, 
		TRTYPE, 
		ISETT_NO, 
		ISETT_TYPE
	)  
EXEC @SQL @STATUSID, @STATUSNAME, @FROMPARTY, @TOPARTY, @FROMSCRIP, @TOSCRIP, @FROMDATE, @TODATE

SELECT 
	PARTY_CODE, 
	LONG_NAME,
	(CASE WHEN TRTYPE='907' THEN ('Inter Sett ' + ISETT_NO + ' - ' +ISETT_TYPE)
       WHEN TRTYPE='1000' THEN ('Inter Ben ' + ISETT_NO + ' - ' +ISETT_TYPE)
       ELSE '' END) AS PAYIN,
	(CASE WHEN TRTYPE='907' THEN ''
       WHEN TRTYPE='1000' THEN ''
       ELSE DPID END) AS DPID,
	(CASE WHEN TRTYPE='907' THEN ''
       WHEN TRTYPE='1000' THEN ''
       ELSE CLTDPID END) AS CLTDPID,
	SCRIP_CD, 
	SERIES, 
	SCHEME_NAME,
	(SETT_NO +' - '+ SETT_TYPE) AS SETTLEMENT, 
	QTY, 
	TRANSDATE, 
	BDPID, 
	BCLTDPID
FROM 
	#HOLDTRANSFER

DROP TABLE #HOLDTRANSFER

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_Rpt_NseNetPosition
-- --------------------------------------------------

--exec Wrapper_Rpt_NseNetPosition @SETT_NO='2006030',@SETT_TYPE='A'
--Created By Piyush

CREATE PROC [dbo].[Wrapper_Rpt_NseNetPosition] 
(
	@SETT_NO VARCHAR(7), 
	@SETT_TYPE VARCHAR(2),
	@SHAREDB VARCHAR(20) ='MSAJAG'
)  
AS
BEGIN
CREATE TABLE #TEMP_NseNetPosition  
(  
	 SCRIP_CD VARCHAR(30),  
	 SERIES  VARCHAR(3),  
	 BUYQTY NUMERIC(18, 0),  
	 BUYAMT NUMERIC(18, 0),  
	 SELLQTY NUMERIC(18, 0),  
	 SELLAMT NUMERIC(18, 2)
)  
DECLARE @SQL VARCHAR(MAX)
SET @SQL = 	@SHAREDB + '.DBO.RPT_NSENETPOSITION'
INSERT INTO #TEMP_NSENETPOSITION
EXEC @SQL @SETT_NO=@SETT_NO,@SETT_TYPE=@SETT_TYPE

SELECT 
	SCRIP_CD,
	SERIES,
	BUYQTY,
	BUYAMT,
	SELLQTY,
	SELLAMT,
	ABS(BUYQTY - SELLQTY) AS NETQTY,
	ISNULL((SELLAMT - BUYAMT),0) AS NETAMT,
    ISNULL(CASE WHEN (SELLAMT - BUYAMT) > 0 THEN (SELLAMT - BUYAMT) ELSE 0 END,0) AS NETSELL,
    ISNULL(CASE WHEN (SELLAMT - BUYAMT) <= 0 THEN (SELLAMT - BUYAMT) ELSE 0 END,0) AS NETBUY
FROM 
	#TEMP_NSENETPOSITION
ORDER BY 
	SCRIP_CD,
	SERIES
DROP TABLE #TEMP_NSENETPOSITION
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_Rpt_PayoutMismatch
-- --------------------------------------------------

--EXEC Wrapper_Rpt_PayoutMismatch '2006030','N'
--Created By Piyush
CREATE PROCEDURE [dbo].[Wrapper_Rpt_PayoutMismatch]  
(  
  @SETT_NO varchar(10),  
  @SETT_TYPE varchar(3)  
 )  
AS
BEGIN  
 SELECT   
	SETT_NO,
	PARTY_CODE,
	D.SCRIP_CD,
	D.SERIES,
	ISIN=CERTNO,
	DPID,
	QTY,   
	CLTACCNO=CLTDPID,	
	TRANSNO=FOLIONO,	
	TRDATE=TRANSDATE,
	BRANCHCD,  
	PARTIPANTCODE,
	DRCR ,
	SCRIPNAME=S2.SCRIP_CD,
	CASE WHEN DRCR = 'C' THEN 'Recieved' ELSE 'Delivered' END AS REASON   
 FROM   
	MSAJAG.DBO.DELTRANS D,
	MSAJAG.DBO.SCRIP1 S1,
	MSAJAG.DBO.SCRIP2 S2    
 WHERE   
	SETT_NO = @SETT_NO 
	AND SETT_TYPE=@SETT_TYPE 
	AND PARTY_CODE = 'PARTY' 
	AND FILLER2 = 1   
	AND  S1.CO_CODE = S2.CO_CODE  
	AND S1.SERIES = S2.SERIES 
	AND S2.BSECODE = D.SCRIP_CD   
 ORDER BY   
	DRCR,
	S2.SCRIP_CD,
	D.SERIES,
	PARTY_CODE,
	CLTACCNO ASC,
	TRANSDATE DESC  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_Rpt_ShortagePayin
-- --------------------------------------------------

--EXEC RPT_SHORTAGEPAYIN @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMSETT_NO='2006030',@TOSETT_NO='2007093',@SETT_TYPE='N',@FLAG=-1    
--EXEC WRAPPER_RPT_SHORTAGEPAYIN @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMSETT_NO='2006030',@TOSETT_NO='2007093',@SETT_TYPE='N',@FLAG=-1    
--EXEC WRAPPER_RPT_SHORTAGEPAYIN @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMSETT_NO='2006030',@TOSETT_NO='2006031',@SETT_TYPE='N',@FLAG=-1    
-- CREATED BY SANTOSH    
CREATE PROC [dbo].[Wrapper_Rpt_ShortagePayin]    
(    
 @STATUSID VARCHAR(15),    
 @STATUSNAME VARCHAR(25),    
 @FROMSETT_NO VARCHAR(7),    
 @TOSETT_NO VARCHAR(7),    
 @SETT_TYPE VARCHAR(2),    
 @FLAG INT,
 @SHAREDB VARCHAR(20) ='MSAJAG'    
) 
AS
BEGIN    
DECLARE @SQL VARCHAR(MAX)
CREATE TABLE #TEMP_SHORTPAYIN    
(    
	 SETT_NO  VARCHAR(7),    
	 SETT_TYPE VARCHAR(2),    
	 PARTY_CODE VARCHAR(12),    
	 SHORT_NAME VARCHAR(30),    
	 SCRIP_CD VARCHAR(30),    
	 SERIES  VARCHAR(3),    
	 BUYTRADEQTY NUMERIC(18, 3),    
	 BUYRECQTY NUMERIC(18, 3),    
	 SELLTRADEQTY NUMERIC(18, 3),    
	 SELLRECQTY NUMERIC(18, 3),    
	 BUYSHORTAGE NUMERIC(18, 3),    
	 SELLSHORTAGE NUMERIC(18, 3),    
	 CL_RATE  NUMERIC(18, 2),    
	 FLAG  VARCHAR(10),    
	 ISIN  VARCHAR(12)    
)    
SET @SQL = 	@SHAREDB + '.DBO.RPT_SHORTAGEPAYIN'
 INSERT INTO #TEMP_SHORTPAYIN    
 EXEC @SQL @STATUSID=@STATUSID,@STATUSNAME=@STATUSNAME,@FROMSETT_NO=@FROMSETT_NO,@TOSETT_NO=@TOSETT_NO,@SETT_TYPE=@SETT_TYPE,@FLAG=@FLAG    
        
 SELECT 
		SETT_NO,
		SETT_TYPE,
		PARTY_CODE,
		SHORT_NAME,
		SCRIP_CD,
		SERIES,
		BUYTRADEQTY,
		BUYRECQTY,
		SELLTRADEQTY,
		SELLRECQTY,    
		BUYSHORTAGE,
		SELLSHORTAGE,	
		CL_RATE,    
		FLAG= CASE WHEN FLAG='1' THEN 'POA A/C' ELSE 'NO POA A/C' END,
		ISIN=ISNULL(CASE WHEN ISIN='' THEN  '(NOT IN MASTER)' ELSE '(' + ISIN + ')' END,'(NOT IN MASTER)'),
		CASE WHEN LTRIM(RTRIM(@SETT_TYPE)) = 'W' THEN (CONVERT(NUMERIC(18,4),SELLSHORTAGE * CL_RATE)) ELSE CONVERT(NUMERIC(18,4),((SELLSHORTAGE -BUYSHORTAGE) * CL_RATE)) END AS AMOUNT,    
		SERIES_ISIN = SERIES + ' ' + ISNULL(CASE WHEN ISIN='' THEN  '(NOT IN MASTER)' ELSE '(' + ISIN + ')' END,'(NOT IN MASTER)'),    
		CASE WHEN LTRIM(RTRIM(@SETT_TYPE)) = 'W' THEN SELLSHORTAGE ELSE SELLSHORTAGE - BUYSHORTAGE END AS SHORTAGE ,  
		GROUP_FIELD =  'Partycode :' + SPACE(5) +  LTRIM(RTRIM(PARTY_CODE)) + SPACE(10) + 'Partyname :' +SPACE(5)+ SHORT_NAME  +SPACE(10)+ 'Settno :' + SETT_NO + '('+ SETT_TYPE + ')'  
 FROM 
	#TEMP_SHORTPAYIN  
 
DROP TABLE 
	 #TEMP_SHORTPAYIN
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_Rpt_ShortagePayinScrip
-- --------------------------------------------------

--EXEC RPT_SHORTAGEPAYIN @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMSETT_NO='2006030',@TOSETT_NO='2007093',@SETT_TYPE='N',@FLAG=-1
--EXEC WRAPPER_RPT_SHORTAGEPAYIN @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMSETT_NO='2006030',@TOSETT_NO='2007093',@SETT_TYPE='N',@FLAG=-1
--EXEC WRAPPER_RPT_SHORTAGEPAYINSCRIP @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMSETT_NO='1011186',@TOSETT_NO='1011186',@SETT_TYPE='T3',@FLAG=0,@SHAREDB='BSEMFSS'
-- CREATED BY PIYUSH
CREATE PROC [dbo].[Wrapper_Rpt_ShortagePayinScrip]
(
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@FROMSETT_NO VARCHAR(7),
	@TOSETT_NO VARCHAR(7),
	@SETT_TYPE VARCHAR(2),
	@FLAG INT,
	@SHAREDB VARCHAR(20)
) AS
BEGIN

CREATE TABLE #TEMP_SHORTPAYINSCRIP
(
	SETT_NO		VARCHAR(7),
	SETT_TYPE	VARCHAR(2),
	PARTY_CODE	VARCHAR(12),
	SHORT_NAME	VARCHAR(30),
	SCRIP_CD	VARCHAR(30),
	SERIES		VARCHAR(3),
	BUYTRADEQTY	NUMERIC(18, 3),
	BUYRECQTY	NUMERIC(18, 3),
	SELLTRADEQTY NUMERIC(18, 3),
	SELLRECQTY	NUMERIC(18, 3),
	BUYSHORTAGE NUMERIC(18, 3),
	SELLSHORTAGE NUMERIC(18, 3),
	CL_RATE		NUMERIC(18, 2),
	POA_FLAG	VARCHAR(50),
	ISIN		VARCHAR(12)
)
DECLARE @SQL VARCHAR(MAX)
SET @SQL= @SHAREDB + '.DBO.RPT_SHORTAGEPAYINSCRIP'

INSERT INTO #TEMP_SHORTPAYINSCRIP
EXEC @SQL @STATUSID=@STATUSID,@STATUSNAME=@STATUSNAME,@FROMSETT_NO=@FROMSETT_NO,@TOSETT_NO=@TOSETT_NO,@SETT_TYPE=@SETT_TYPE,@FLAG=@FLAG

SELECT 
	SETT_NO,
	SETT_TYPE,
	PARTY_CODE,
	SHORT_NAME,
	SCRIP_CD,
	SERIES,
	BUYTRADEQTY,
	BUYRECQTY,
	SELLTRADEQTY,
	SELLRECQTY,
	BUYSHORTAGE,
	SELLSHORTAGE,
	CL_RATE,
	POA_FLAG= CASE WHEN POA_FLAG='1' THEN 'POA A/C' ELSE 'NO POA A/C' END,
	ISIN=ISNULL(CASE WHEN ISIN='' THEN  '(NOT IN MASTER)' ELSE '(' + ISIN + ')' END,'(NOT IN MASTER)'),
	CASE WHEN LTRIM(RTRIM(@SETT_TYPE)) = 'W' THEN (CONVERT(NUMERIC(18,4),SELLSHORTAGE * CL_RATE)) ELSE CONVERT(NUMERIC(18,4),((SELLSHORTAGE -BUYSHORTAGE) * CL_RATE)) END AS AMOUNT,
	SERIES_ISIN = SERIES + ' ' + ISNULL(CASE WHEN ISIN='' THEN  '(NOT IN MASTER)' ELSE '(' + ISIN + ')' END,'(NOT IN MASTER)'),
	SCRIP_SERIES = SCRIP_CD + ' (' + SERIES + ')',
	SETTNO_TYPE = SETT_NO + ' (' + SETT_TYPE + ')',
	CASE WHEN LTRIM(RTRIM(@SETT_TYPE)) = 'W' THEN SELLSHORTAGE ELSE SELLSHORTAGE - BUYSHORTAGE END AS SHORTAGE
FROM 
	#TEMP_SHORTPAYINSCRIP

DROP TABLE 
	#TEMP_SHORTPAYINSCRIP
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_Rpt_ShortagePayOut
-- --------------------------------------------------

--exec Rpt_ShortagePayin @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMSETT_NO='2006030',@TOSETT_NO='2007093',@SETT_TYPE='N',@FLAG=-1  
--exec [Wrapper_Rpt_ShortagePayOut] @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMSETT_NO='2006030',@TOSETT_NO='2007093',@SETT_TYPE='N',@FLAG=-1  
--exec Wrapper_Rpt_ShortagePayin @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMSETT_NO='2006030',@TOSETT_NO='2006031',@SETT_TYPE='N',@FLAG=-1  
-- Created by PIYUSH  
CREATE PROC [dbo].[Wrapper_Rpt_ShortagePayOut]  
(  
 @STATUSID VARCHAR(15),  
 @STATUSNAME VARCHAR(25),  
 @FROMSETT_NO VARCHAR(7),  
 @TOSETT_NO VARCHAR(7),  
 @SETT_TYPE VARCHAR(2),  
 @FLAG INT,
 @SHAREDB VARCHAR(20) ='MSAJAG'
) 
AS
BEGIN  
DECLARE @SQL VARCHAR(MAX)
CREATE TABLE #TEMP_SHORTPAYOUT  
(  
 SETT_NO  VARCHAR(7),  
 SETT_TYPE VARCHAR(2),  
 PARTY_CODE VARCHAR(12),  
 SHORT_NAME VARCHAR(30),  
 SCRIP_CD VARCHAR(30),  
 SERIES  VARCHAR(3),  
 BUYTRADEQTY NUMERIC(18, 3),  
 BUYRECQTY NUMERIC(18, 3),  
 SELLTRADEQTY NUMERIC(18, 3),  
 SELLRECQTY NUMERIC(18, 3),  
 BUYSHORTAGE NUMERIC(18, 3),  
 SELLSHORTAGE NUMERIC(18, 3),  
 CL_RATE  NUMERIC(18, 6),  
 FLAG  VARCHAR(10),  
 ISIN  VARCHAR(12)  
)  
SET @SQL = 	@SHAREDB + '.DBO.RPT_SHORTAGEPAYOUT'
 INSERT INTO #TEMP_SHORTPAYOUT  
 EXEC  @SQL @STATUSID=@STATUSID,@STATUSNAME=@STATUSNAME,@FROMSETT_NO=@FROMSETT_NO,@TOSETT_NO=@TOSETT_NO,@SETT_TYPE=@SETT_TYPE,@FLAG=@FLAG  
      
 SELECT 
	SETT_NO,
	SETT_TYPE,
	PARTY_CODE,
	SHORT_NAME,
	SCRIP_CD,
	SERIES,
	BUYTRADEQTY,
	BUYRECQTY,
	SELLTRADEQTY,
	SELLRECQTY,  
	BUYSHORTAGE,
	SELLSHORTAGE,
	CL_RATE,  
	FLAG= CASE WHEN FLAG='1' THEN 'POA A/C' ELSE 'No POA A/C' END ,
	ISIN=ISNULL(CASE WHEN ISIN='' THEN  'Not In Master' ELSE ISIN END,'Not In Master'),
	CASE WHEN LTRIM(RTRIM(@SETT_TYPE)) = 'W' THEN (CONVERT(NUMERIC(18,2),BUYSHORTAGE * CL_RATE)) ELSE CONVERT(NUMERIC(18,2),((BUYSHORTAGE - SELLSHORTAGE) * CL_RATE)) END AS AMOUNT,  
	SERIES_ISIN = SERIES + ' (' + ISNULL(CASE WHEN ISIN='' THEN  'Not In Master' ELSE ISIN END,'Not In Master') + ')',  
	CASE WHEN LTRIM(RTRIM(@SETT_TYPE)) = 'W' THEN BUYSHORTAGE ELSE BUYSHORTAGE - SELLSHORTAGE END AS SHORTAGE,
	GROUP_FIELD =  'Partycode :' + SPACE(5) +  LTRIM(RTRIM(PARTY_CODE)) + SPACE(10) + 'Partyname :' +SPACE(5)+ SHORT_NAME  +SPACE(10)+ 'Settno :' + SETT_NO + '('+ SETT_TYPE + ')'     
 FROM 
	#TEMP_SHORTPAYOUT 

DROP TABLE 
	#TEMP_SHORTPAYOUT 
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_Rpt_ShortagePayoutScrip
-- --------------------------------------------------

--EXEC RPT_SHORTAGEPAYIN @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMSETT_NO='2006030',@TOSETT_NO='2007093',@SETT_TYPE='N',@FLAG=-1
--EXEC WRAPPER_RPT_SHORTAGEPAYIN @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMSETT_NO='2006030',@TOSETT_NO='2007093',@SETT_TYPE='N',@FLAG=-1
--EXEC [Wrapper_Rpt_ShortagePayoutScrip] @STATUSID='BROKER',@STATUSNAME='BROKER',@FROMSETT_NO='2006030',@TOSETT_NO='2006031',@SETT_TYPE='N',@FLAG=-1
-- CREATED BY PIYUSH
CREATE PROC [dbo].[Wrapper_Rpt_ShortagePayoutScrip]
(
	@STATUSID VARCHAR(15),
	@STATUSNAME VARCHAR(25),
	@FROMSETT_NO VARCHAR(7),
	@TOSETT_NO VARCHAR(7),
	@SETT_TYPE VARCHAR(2),
	@FLAG INT,
	@SHAREDB VARCHAR(20)
) AS
BEGIN

CREATE TABLE #TEMP_SHORTPAYOUTSCRIP
(
	SETT_NO		VARCHAR(7),
	SETT_TYPE	VARCHAR(2),
	PARTY_CODE	VARCHAR(12),
	SHORT_NAME	VARCHAR(30),
	SCRIP_CD	VARCHAR(30),
	SERIES		VARCHAR(3),
	BUYTRADEQTY	NUMERIC(18, 3),
	BUYRECQTY	NUMERIC(18, 3),
	SELLTRADEQTY NUMERIC(18, 3),
	SELLRECQTY	NUMERIC(18, 3),
	BUYSHORTAGE NUMERIC(18, 3),
	SELLSHORTAGE NUMERIC(18, 3),
	CL_RATE		NUMERIC(18, 2),
	POA_FLAG		VARCHAR(50),
	ISIN		VARCHAR(12)
)
DECLARE @SQL VARCHAR(MAX)
SET @SQL= @SHAREDB + '.DBO.RPT_SHORTAGEPAYOUT'
INSERT INTO #TEMP_SHORTPAYOUTSCRIP
EXEC @SQL @STATUSID=@STATUSID,@STATUSNAME=@STATUSNAME,@FROMSETT_NO=@FROMSETT_NO,@TOSETT_NO=@TOSETT_NO,@SETT_TYPE=@SETT_TYPE,@FLAG=@FLAG

SELECT 
	SETT_NO,
	SETT_TYPE,
	PARTY_CODE,
	SHORT_NAME,
	SCRIP_CD,
	SERIES,
	BUYTRADEQTY,
	BUYRECQTY,
	SELLTRADEQTY,
	SELLRECQTY,
	BUYSHORTAGE,
	SELLSHORTAGE,
	CL_RATE,
	POA_FLAG= CASE WHEN POA_FLAG='1' THEN 'POA A/C' ELSE 'NO POA A/C' END,
	ISIN=ISNULL(CASE WHEN ISIN='' THEN  '(NOT IN MASTER)' ELSE '(' + ISIN + ')' END,'(NOT IN MASTER)'),
	CASE WHEN LTRIM(RTRIM(@SETT_TYPE)) = 'W' THEN (CONVERT(NUMERIC(18,4),BUYSHORTAGE * CL_RATE)) ELSE CONVERT(NUMERIC(18,4),
	((BUYSHORTAGE - SELLSHORTAGE) * CL_RATE)) END AS AMOUNT,
	SERIES_ISIN = SERIES + ' ' + ISNULL(CASE WHEN ISIN='' THEN  '(NOT IN MASTER)' ELSE '(' + ISIN + ')' END,'(NOT IN MASTER)'),
	SCRIP_SERIES = SCRIP_CD + ' (' + SERIES + ')',
	SETTNO_TYPE = SETT_NO + ' (' + SETT_TYPE + ')',
	CASE WHEN LTRIM(RTRIM(@SETT_TYPE)) = 'W' THEN SELLSHORTAGE ELSE BUYSHORTAGE - SELLSHORTAGE  END AS SHORTAGE
FROM 
	#TEMP_SHORTPAYOUTSCRIP

DROP TABLE 
	#TEMP_SHORTPAYOUTSCRIP
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_Shrt_RPT_NSEDELGET
-- --------------------------------------------------

--exec RPT_NSEDELGET '3','2006030','n'  
--exec [Wrapper_Shrt_RPT_NSEDELGet] '3','2006030','n'  
--CREATED BY PIYUSH
CREATE PROCEDURE [dbo].[Wrapper_Shrt_RPT_NSEDELGET]  
(  
 @DEMATID VARCHAR(2),  
 @SETT_NO VARCHAR(7),  
 @SETT_TYPE VARCHAR(3),
 @SHAREDB VARCHAR(20) ='MSAJAG'  
)  
AS
BEGIN  
DECLARE @SQL VARCHAR(MAX)
CREATE TABLE #TEMP_NSEDELGET  
(  
	 SETT_NO  VARCHAR(7),  
	 SETT_TYPE VARCHAR(2),  
	 SCRIP_CD VARCHAR(30),  
	 SERIES  VARCHAR(200),
	 SERIES_TEST VARCHAR(3),  
	 GIVENSE NUMERIC(18, 3),  
	 RECEIVENSE NUMERIC(18, 3),  
	 GIVENNSE NUMERIC(18, 3),
	 RECEIVEDNSE NUMERIC(18, 3),
	 CL_RATE NUMERIC(18, 2),
	 SHORTAGE NUMERIC(18,3)
)  
SET @SQL = 	@SHAREDB + '.DBO.RPT_NSEDELGIVE'

 INSERT INTO #TEMP_NSEDELGET (SETT_NO,SETT_TYPE,SCRIP_CD,SERIES,SERIES_TEST,GIVENSE,RECEIVENSE,GIVENNSE,RECEIVEDNSE,CL_RATE)
 EXEC @SQL @DEMATID=@DEMATID,@SETT_NO=@SETT_NO,@SETT_TYPE=@SETT_TYPE 

UPDATE  
	#TEMP_NSEDELGET 
SET 
    SHORTAGE = (RECEIVENSE - RECEIVEDNSE)

UPDATE  
	#TEMP_NSEDELGET 
SET 
    SHORTAGE = SHORTAGE + GIVENNSE - GIVENSE
WHERE 
	(GIVENNSE - GIVENSE) > 0

 SELECT  
	SETT_NO,
	SETT_TYPE,
	SCRIP_CD,
	SERIES,
	SERIES_TEST,
	GIVENSE,
	RECEIVENSE,
	GIVENNSE,
	RECEIVEDNSE,
	CL_RATE,
	SHORTAGE
 FROM  
	#TEMP_NSEDELGET  
 WHERE  
	SHORTAGE > 0  
 ORDER BY  
	SETT_NO,  
	SETT_TYPE,  
	SCRIP_CD,  
	SERIES  
DROP TABLE #TEMP_NSEDELGET  
END

GO

-- --------------------------------------------------
-- PROCEDURE dbo.Wrapper_Shrt_RPT_NSEDELGIVE
-- --------------------------------------------------

--exec bsemfss.dbo.RPT_NSEDELGIVE '3','1011186','T3'
--exec Wrapper_Shrt_RPT_NSEDELGIVE '3','1011186','T3','BSEMFSS'
--CREATED BY PIYUSH
CREATE PROCEDURE [dbo].[Wrapper_Shrt_RPT_NSEDELGIVE]
(
	@DEMATID VARCHAR(2),
	@SETT_NO VARCHAR(7),
	@SETT_TYPE VARCHAR(3),
    @SHAREDB VARCHAR(20) ='MSAJAG'
)
AS
BEGIN
DECLARE @SQL VARCHAR(MAX)
CREATE TABLE #TEMP_NSEDELGIVE
(
	SETT_NO		VARCHAR(7),
	SETT_TYPE	VARCHAR(2),
	SCRIP_CD	VARCHAR(30),
	SERIES		VARCHAR(200),
	SERIES_TEST VARCHAR(3),
	GIVENSE	NUMERIC(18, 3),
	RECEIVENSE	NUMERIC(18, 3),
	GIVENNSE NUMERIC(18, 3),
	RECEIVEDNSE	NUMERIC(18, 3),
	CL_RATE NUMERIC(18, 4),
    SHORTAGE NUMERIC(18, 3),
    SHORTVAL NUMERIC(18, 2)
)
SET @SQL = 	@SHAREDB + '.DBO.RPT_NSEDELGIVE'
	INSERT INTO #TEMP_NSEDELGIVE(SETT_NO,SETT_TYPE,SCRIP_CD,SERIES,SERIES_TEST,GIVENSE,RECEIVENSE,GIVENNSE,RECEIVEDNSE,CL_RATE)
	EXEC @SQL @DEMATID=@DEMATID,@SETT_NO=@SETT_NO,@SETT_TYPE=@SETT_TYPE

    UPDATE 
		#TEMP_NSEDELGIVE
	SET 
		SHORTAGE = (GIVENSE - GIVENNSE)

   
    UPDATE 
		#TEMP_NSEDELGIVE
	SET 
		SHORTAGE = SHORTAGE + RECEIVEDNSE - RECEIVENSE
	WHERE
		(RECEIVEDNSE - RECEIVENSE) > 0 

    UPDATE 
		#TEMP_NSEDELGIVE
	SET 
		SHORTVAL = SHORTAGE * CL_RATE


	SELECT
		SETT_NO,
		SETT_TYPE,
		SCRIP_CD,
		SERIES,
		SERIES_TEST,
		GIVENSE,
		RECEIVENSE,
		GIVENNSE,
		RECEIVEDNSE,
		SHORTAGE,
		SHORTVAL
	FROM
		#TEMP_NSEDELGIVE
	WHERE
		SHORTAGE > 0
	ORDER BY
		SETT_NO,
		SETT_TYPE,
		SCRIP_CD,
		SERIES,
		SERIES_TEST
END

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT_AGREEMENT_DATA
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT_AGREEMENT_DATA]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [CL_CODE] VARCHAR(10) NULL,
    [AGREE_FLAG] INT NULL,
    [AGREED_DATE] DATETIME NULL,
    [INCOME_SLAB] VARCHAR(50) NULL,
    [INCOME_SLAB_ENTERED_DATE] DATETIME NULL,
    [AGREED_EXCH_SEGMENTS] VARCHAR(300) NULL,
    [EXCH_SEGMENTS_ENTERED_DATE] DATETIME NULL,
    [AGREEMENT_FROM] DATETIME NULL,
    [AGREEMENT_TO] DATETIME NULL,
    [AGREEMENT_COMPLETION_FLAG] INT NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.CLIENT_AGREEMENT_TEXT
-- --------------------------------------------------
CREATE TABLE [dbo].[CLIENT_AGREEMENT_TEXT]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [TEXT_TYPE1] VARCHAR(3) NULL,
    [TEXT_TYPE2] VARCHAR(3) NULL,
    [TEXT_VALUE] VARCHAR(2000) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.PASSPORT_LOGIN_MAP
-- --------------------------------------------------
CREATE TABLE [dbo].[PASSPORT_LOGIN_MAP]
(
    [SRNO] INT IDENTITY(1,1) NOT NULL,
    [CLASS_LOGIN] VARCHAR(25) NULL,
    [MAPPED_LOGIN] VARCHAR(25) NULL,
    [LOGINTYPE] VARCHAR(10) NULL,
    [APP_CODE] VARCHAR(10) NULL,
    [VERIFICATION_KEY] VARCHAR(100) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.Temp_NSEDELGET
-- --------------------------------------------------
CREATE TABLE [dbo].[Temp_NSEDELGET]
(
    [Sett_no] VARCHAR(7) NULL,
    [Sett_Type] VARCHAR(2) NULL,
    [Scrip_Cd] VARCHAR(30) NULL,
    [Series] VARCHAR(3) NULL,
    [GIVENSE] NUMERIC(18, 0) NULL,
    [RECEIVENSE] NUMERIC(18, 0) NULL,
    [GIVENNSE] NUMERIC(18, 0) NULL,
    [RECEIVEDNSE] NUMERIC(18, 0) NULL,
    [CL_RATE] NUMERIC(18, 2) NULL
);

GO

-- --------------------------------------------------
-- TABLE dbo.TMP_DELACCBALANCE
-- --------------------------------------------------
CREATE TABLE [dbo].[TMP_DELACCBALANCE]
(
    [SCRIP_CD] VARCHAR(12) NOT NULL,
    [SERIES] VARCHAR(3) NOT NULL,
    [PARTY_CODE] VARCHAR(10) NOT NULL,
    [LONG_NAME] VARCHAR(100) NULL,
    [TRTYPE] NUMERIC(18, 0) NOT NULL,
    [CLTDPID] VARCHAR(16) NULL,
    [DPID] VARCHAR(16) NULL,
    [CERTNO] VARCHAR(16) NULL,
    [QTY] NUMERIC(38, 0) NULL,
    [DELIVERED] CHAR(1) NOT NULL,
    [BDPTYPE] VARCHAR(10) NULL,
    [BDPID] VARCHAR(16) NULL,
    [BCLTDPID] VARCHAR(16) NULL,
    [AMOUNT] MONEY NULL,
    [ISETT_NO] VARCHAR(7) NULL,
    [ISETT_TYPE] VARCHAR(2) NULL,
    [CL_RATE] MONEY NOT NULL
);

GO

-- --------------------------------------------------
-- VIEW dbo.CBO_SQLCONTROL
-- --------------------------------------------------
CREATE VIEW [dbo].[CBO_SQLCONTROL]
AS
SELECT * FROM PRADNYA.DBO.CBO_SQLCONTROL

GO

-- --------------------------------------------------
-- VIEW dbo.CHARTSPECS
-- --------------------------------------------------
CREATE VIEW [dbo].[CHARTSPECS]
AS
SELECT * FROM PRADNYA.DBO.CHARTSPECS

GO

-- --------------------------------------------------
-- VIEW dbo.F2CONFIG
-- --------------------------------------------------
CREATE VIEW [dbo].[F2CONFIG]
AS
SELECT     SRNO, F2CODE, F2DESCRIPTION, F2OBJECT, F2OBJECTTYPE, F2PARAMFIELDS, F2OUTPUT, F2OPRLIST, F2ORDERLIST, DATABASENAME, 
                      WINDOWTITLE, TABLEHEADER, CONNECTIONDB
FROM         Pradnya.dbo.F2CONFIG

GO

-- --------------------------------------------------
-- VIEW dbo.MULTICOMPANY
-- --------------------------------------------------
CREATE VIEW [dbo].[MULTICOMPANY]  
AS  
SELECT     BrokerId, CompanyName, Segment_Description, Exchange, Segment, MemberType, MemberCode, ShareDb, ShareServer, ShareIP, AccountDb,   
                      AccountServer, AccountIP, DefaultDb, DefaultDbServer, DefaultDbIP, DefaultClient, PANGIR_No, primaryServer, Filler2, dbusername, dbpassword,   
                      License, AppShare_RootFldr_Name  
FROM         Pradnya.dbo.multicompany AS multicompany_1  
UNION ALL  
SELECT     BrokerId, CompanyName, Segment_Description, Exchange, Segment, MemberType, MemberCode, ShareDb, ShareServer, ShareIP, AccountDb,   
                      AccountServer, AccountIP, DefaultDb, DefaultDbServer, DefaultDbIP, DefaultClient, PANGIR_No, primaryServer, Filler2, dbusername, dbpassword,   
                      License, AppShare_RootFldr_Name  
FROM         Pradnya.dbo.MultiCompany_Additional

GO

-- --------------------------------------------------
-- VIEW dbo.MULTICOMPANY_28042011
-- --------------------------------------------------
CREATE VIEW [dbo].[MULTICOMPANY_28042011]
AS
SELECT     BrokerId, CompanyName, Segment_Description, Exchange, Segment, MemberType, MemberCode, ShareDb, ShareServer, ShareIP, AccountDb, 
                      AccountServer, AccountIP, DefaultDb, DefaultDbServer, DefaultDbIP, DefaultClient, PANGIR_No, primaryServer, Filler2, dbusername, dbpassword, 
                      License, AppShare_RootFldr_Name
FROM         Pradnya.dbo.multicompany AS multicompany_1
UNION ALL
SELECT     BrokerId, CompanyName, Segment_Description, Exchange, Segment, MemberType, MemberCode, ShareDb, ShareServer, ShareIP, AccountDb, 
                      AccountServer, AccountIP, DefaultDb, DefaultDbServer, DefaultDbIP, DefaultClient, PANGIR_No, primaryServer, Filler2, dbusername, dbpassword, 
                      License, AppShare_RootFldr_Name
FROM         Pradnya.dbo.MultiCompany_Additional

GO

-- --------------------------------------------------
-- VIEW dbo.MULTICOMPANY_ALL
-- --------------------------------------------------
CREATE VIEW [dbo].[MULTICOMPANY_ALL]
AS
SELECT * FROM PRADNYA.DBO.MULTICOMPANY_ALL

GO

-- --------------------------------------------------
-- VIEW dbo.MULTICOMPANY_ALL_28042011
-- --------------------------------------------------
CREATE VIEW [dbo].[MULTICOMPANY_ALL_28042011]  
AS  
SELECT * FROM PRADNYA.DBO.MULTICOMPANY_ALL

GO

-- --------------------------------------------------
-- VIEW dbo.PDFMASTER
-- --------------------------------------------------
CREATE VIEW [dbo].[PDFMASTER]
AS
SELECT * FROM PRADNYA.DBO.PDFMASTER

GO

-- --------------------------------------------------
-- VIEW dbo.REPORT_GROUPING_NEW
-- --------------------------------------------------
CREATE VIEW [dbo].[REPORT_GROUPING_NEW]
AS
SELECT * FROM PRADNYA.DBO.REPORT_GROUPING_NEW

GO

-- --------------------------------------------------
-- VIEW dbo.REPORT_RUNTIME_HANDLE
-- --------------------------------------------------
CREATE VIEW [dbo].[REPORT_RUNTIME_HANDLE]
AS
SELECT * FROM PRADNYA.DBO.REPORT_RUNTIME_HANDLE

GO

-- --------------------------------------------------
-- VIEW dbo.REPORTDETAILS_NEW
-- --------------------------------------------------
CREATE VIEW [dbo].[REPORTDETAILS_NEW]
AS
SELECT * FROM PRADNYA.DBO.REPORTDETAILS_NEW

GO

-- --------------------------------------------------
-- VIEW dbo.REPORTFORMULATION_NEW
-- --------------------------------------------------
CREATE VIEW [dbo].[REPORTFORMULATION_NEW]
AS
SELECT * FROM PRADNYA.DBO.REPORTFORMULATION_NEW

GO

-- --------------------------------------------------
-- VIEW dbo.REPORTLINKS_NEW
-- --------------------------------------------------
CREATE VIEW [dbo].[REPORTLINKS_NEW]
AS
SELECT * FROM PRADNYA.DBO.REPORTLINKS_NEW

GO

-- --------------------------------------------------
-- VIEW dbo.REPORTMASTER_NEW
-- --------------------------------------------------
CREATE VIEW [dbo].[REPORTMASTER_NEW]
AS
SELECT * FROM PRADNYA.DBO.REPORTMASTER_NEW

GO

-- --------------------------------------------------
-- VIEW dbo.REPORTSUMMATION_NEW
-- --------------------------------------------------
CREATE VIEW [dbo].[REPORTSUMMATION_NEW]
AS
SELECT * FROM PRADNYA.DBO.REPORTSUMMATION_NEW

GO

-- --------------------------------------------------
-- VIEW dbo.Vw_TogetClassBBO
-- --------------------------------------------------
create view Vw_TogetClassBBO as
(
SELECT * FROM PASSPORT_LOGIN_MAP --WHERE CLASS_LOGIN=@PA_LOGIN AND LOGINTYPE='CLIENT'
)

GO

